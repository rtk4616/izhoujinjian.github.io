<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title>
  
  <subtitle>à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://zhoujinjian.cc/"/>
  <updated>2018-07-09T12:47:10.886Z</updated>
  <id>http://zhoujinjian.cc/</id>
  
  <author>
    <name>à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘</title>
    <link href="http://zhoujinjian.cc/2088/08/08/zhoujinjian.cc-Android%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90%E6%96%87%E6%A1%A3%E3%80%90%F0%9F%8C%80%E7%BD%AE%E9%A1%B6%F0%9F%8C%80%E3%80%91/"/>
    <id>http://zhoujinjian.cc/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/</id>
    <published>2088-08-08T00:08:08.080Z</published>
    <updated>2018-07-09T12:47:10.886Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Android-Multimedia-Systemï¼š"><a href="#Android-Multimedia-Systemï¼š" class="headerlink" title="Android Multimedia Systemï¼š"></a>Android Multimedia Systemï¼š</h4><p><a href="http://zhoujinjian.cc/2018/09/12/Android%20Video%20System%EF%BC%885%EF%BC%89%EF%BC%9AAndroid%20Multimedia%20-%20NuPlayer%E9%9F%B3%E8%A7%86%E9%A2%91%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/">Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/09/06/Android%20Video%20System%EF%BC%884%EF%BC%89%EF%BC%9AAndroid%20Multimedia%20-%20OpenMax%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/06/18/Android%20Video%20System%EF%BC%883%EF%BC%89%EF%BC%9A%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BD%95%E5%88%B6Recorder%E3%80%81%E7%BC%96%E7%A0%81Encoder%E3%80%81%E6%B7%B7%E5%90%88MediaMuxer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android Video Systemï¼ˆ3ï¼‰ï¼šéŸ³è§†é¢‘å½•åˆ¶Recorderã€ç¼–ç Encoderã€æ··åˆMediaMuxeræºç åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/06/06/Android%20Video%20System%EF%BC%882%EF%BC%89%EF%BC%9A%E9%9F%B3%E8%A7%86%E9%A2%91%E5%88%86%E7%A6%BBMediaExtractor%E3%80%81%E8%A7%A3%E7%A0%81Decoder%E3%80%81%E6%B8%B2%E6%9F%93Renderer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/06/01/Android%20Video%20System%EF%BC%881%EF%BC%89%EF%BC%9AVideo%20System[%E8%A7%86%E9%A2%91%E7%B3%BB%E7%BB%9F]%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/">Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ</a></p><h4 id="Android-Camera-Systemï¼š"><a href="#Android-Camera-Systemï¼š" class="headerlink" title="Android Camera Systemï¼š"></a>Android Camera Systemï¼š</h4><p><a href="http://zhoujinjian.cc/2018/07/10/Android%20Camera%20System%EF%BC%882%EF%BC%89%EF%BC%9ACamera%20System[Camera%20%E7%B3%BB%E7%BB%9F]startPreview%E3%80%81takePicture%E3%80%81Recorder%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/07/10/Android%20Camera%20System%EF%BC%882%EF%BC%89%EF%BC%9ACamera%20System[Camera%20%E7%B3%BB%E7%BB%9F]startPreview%E3%80%81takePicture%E3%80%81Recorder%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ</a></p><h4 id="Android-Display-Systemï¼š"><a href="#Android-Display-Systemï¼š" class="headerlink" title="Android Display Systemï¼š"></a>Android Display Systemï¼š</h4><p><a href="http://zhoujinjian.cc/2018/08/30/Android%20Display%20System%EF%BC%885%EF%BC%89%EF%BC%9AAndroid%20Display%20System%20%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B9%8BDisplay%20Driver%20Architecture/">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</a><br><a href="http://zhoujinjian.cc/2018/08/16/Android%20Display%20System%EF%BC%884%EF%BC%89%EF%BC%9AAndroid%20Display%20System%20%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B9%8BGralloc%20&amp;&amp;%20HWComposer%E6%A8%A1%E5%9D%97%E5%88%86%E6%9E%90/">Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc &amp;&amp; HWComposeræ¨¡å—åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/08/01/Android%20Display%20System%EF%BC%883%EF%BC%89%EF%BC%9AAndroid%20Display%20System%20%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B9%8BHardwareRenderer.draw%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/07/20/Android%20Display%20System%EF%BC%882%EF%BC%89%EF%BC%9AAndroid%20Display%20System%20%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B9%8BAndroid%20EGL%20&amp;&amp;%20OpenGL/">Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL &amp;&amp; OpenGL</a><br><a href="http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/">Android Display Systemï¼ˆ1ï¼‰ï¼šAndroid 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ</a></p><h4 id="Android-Audio-Systemï¼š"><a href="#Android-Audio-Systemï¼š" class="headerlink" title="Android Audio Systemï¼š"></a>Android Audio Systemï¼š</h4><p><a href="http://zhoujinjian.cc/2018/05/25/Audio%20System%EF%BC%883%EF%BC%89%EF%BC%9AAndroid%20audio%20system[%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F]%E5%88%86%E6%9E%90/">Android Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/05/15/Audio%20System%EF%BC%882%EF%BC%89%EF%BC%9ALinux%20ALSA%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/">Android Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/05/01/Audio%20System%EF%BC%881%EF%BC%89%EF%BC%9ALinux%20&amp;&amp;%20Android%20Audio%20%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/">Android Audio Systemï¼ˆ1ï¼‰ï¼šLinux &amp;&amp; Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ</a></p><h4 id="Android-Input-Systemï¼š"><a href="#Android-Input-Systemï¼š" class="headerlink" title="Android Input Systemï¼š"></a>Android Input Systemï¼š</h4><p><a href="http://zhoujinjian.cc/2017/12/01/Android-7-1-2-Android-N-Android-%E8%BE%93%E5%85%A5%E5%AD%90%E7%B3%BB%E7%BB%9F-Input-System/">Android Input Systemï¼ˆ2ï¼‰ï¼šAndroid 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ - Input System åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/04/01/Linux%E5%86%85%E6%A0%B8%EF%BC%88Kernel-3-18%EF%BC%89-Input-%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90-i-wonder/">Android Input Systemï¼ˆ1ï¼‰ï¼šLinuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿ åˆ†æ </a></p><h4 id="Android-åŸºç¡€ï¼ˆAMS-amp-WMSï¼‰"><a href="#Android-åŸºç¡€ï¼ˆAMS-amp-WMSï¼‰" class="headerlink" title="Android åŸºç¡€ï¼ˆAMS &amp; WMSï¼‰"></a>Android åŸºç¡€ï¼ˆAMS &amp; WMSï¼‰</h4><p><a href="http://zhoujinjian.cc/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-%E7%AA%97%E5%8F%A3%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%88%86%E6%9E%90-i-wonder/">AndroidåŸºç¡€ ï¼ˆ6ï¼‰ï¼šAndroid 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ</a><br><a href="http://zhoujinjian.cc/2017/11/01/Android-7-1-2-Android-N-Activity-Window%E5%8A%A0%E8%BD%BD%E6%98%BE%E7%A4%BA%E6%B5%81%E7%A8%8B/">AndroidåŸºç¡€ ï¼ˆ5ï¼‰ï¼šAndroid 7.1.2 (Android N) Activity - Window åŠ è½½æ˜¾ç¤ºæµç¨‹ åˆ†æ</a><br><a href="http://zhoujinjian.cc/2017/10/01/Android-7-1-2-Android-N-Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">AndroidåŸºç¡€ ï¼ˆ4ï¼‰ï¼šAndroid 7.1.2 (Android N) Activity å¯åŠ¨æµç¨‹ ï¼ˆAMSï¼‰åˆ†æ</a><br><a href="http://zhoujinjian.cc/2017/09/01/Android-7-1-2-Android-N-Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">AndroidåŸºç¡€ ï¼ˆ3ï¼‰ï¼šAndroid 7.1.2 (Android N) Android ç³»ç»Ÿå¯åŠ¨æµç¨‹ åˆ†æ</a><br><a href="http://zhoujinjian.cc/2018/01/01/Android-7-1-2-Android-N-Android-Binder%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/">AndroidåŸºç¡€ ï¼ˆ2ï¼‰ï¼šAndroid 7.1.2 (Android N) Android Binder ç³»ç»Ÿåˆ†æ</a><br><a href="http://zhoujinjian.cc/2017/08/01/Android-7-1-2-Android-N-Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E2%80%93Handler%E3%80%81Looper%E3%80%81Message/">AndroidåŸºç¡€ ï¼ˆ1ï¼‰ï¼šAndroid 7.1.2 (Android N) Androidæ¶ˆæ¯æœºåˆ¶â€“Handlerã€Looperã€Message åˆ†æ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;Android-Multimedia-Systemï¼š&quot;&gt;&lt;a href=&quot;#Android-Multimedia-Systemï¼š&quot; class=&quot;headerlink&quot; title=&quot;Android Multimedia Systemï¼š&quot;&gt;&lt;/a&gt;Android 
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/09/12/Android%20Video%20System%EF%BC%885%EF%BC%89%EF%BC%9AAndroid%20Multimedia%20-%20NuPlayer%E9%9F%B3%E8%A7%86%E9%A2%91%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/09/12/Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ/</id>
    <published>2018-09-11T16:00:00.000Z</published>
    <updated>2018-07-09T12:33:48.621Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/video.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Android MediaCodec ACodecã€‘</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  android ACodec MediaCodec NuPlayer flowã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><h4 id="ï¼ˆä¸€ï¼‰ã€éŸ³è§†é¢‘åŒæ­¥æ—¶å¦‚ä½•å®ç°çš„ï¼Ÿ"><a href="#ï¼ˆä¸€ï¼‰ã€éŸ³è§†é¢‘åŒæ­¥æ—¶å¦‚ä½•å®ç°çš„ï¼Ÿ" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€éŸ³è§†é¢‘åŒæ­¥æ—¶å¦‚ä½•å®ç°çš„ï¼Ÿ"></a>ï¼ˆä¸€ï¼‰ã€éŸ³è§†é¢‘åŒæ­¥æ—¶å¦‚ä½•å®ç°çš„ï¼Ÿ</h4><p>ä»Rendereræ¥å£å±‚æ¥çœ‹ï¼Œæ²¡æœ‰ä»»ä½•å…³äºåŒæ­¥å¤„ç†çš„æ¥å£ï¼Œä»…æœ‰æœ‰é™çš„å‡ ä¸ªæ§åˆ¶æ¥å£flush/pause/resumeï¼Œä»¥åŠqueueBuffer/queueEOSæ¥å£ã€‚åŒæ­¥é—®é¢˜çš„æ ¸å¿ƒå°±åœ¨äºALooper-AHandleræœºåˆ¶ã€‚å…¶å®çœŸæ­£çš„åŒæ­¥éƒ½æ˜¯åœ¨æ¶ˆæ¯å¾ªç¯çš„å“åº”å‡½æ•°é‡Œå®ç°çš„ã€‚å…ˆçœ‹éŸ³é¢‘ã€‚</p><h5 id="1-1ã€Rendererä¸­çš„éŸ³é¢‘åŒæ­¥æœºåˆ¶"><a href="#1-1ã€Rendererä¸­çš„éŸ³é¢‘åŒæ­¥æœºåˆ¶" class="headerlink" title="1.1ã€Rendererä¸­çš„éŸ³é¢‘åŒæ­¥æœºåˆ¶"></a>1.1ã€Rendererä¸­çš„éŸ³é¢‘åŒæ­¥æœºåˆ¶</h5><p>èµ·å§‹ä½ç½®ä»éŸ³é¢‘PCMæ•°æ®è¿›å…¥å¼€å§‹ï¼Œå¤„ç†åœ¨Renderer::queueBuffer()ä¸­ï¼Œæœ€ç»ˆå‘é€äº†kWhatQueueBufferæ¶ˆæ¯ã€‚è¿™ä¸ªæ¶ˆæ¯çš„å®é™…å¤„ç†å‡½æ•°æ˜¯Renderer::onQueueBuffer()ã€‚å®é™…ä»£ç åœ¨â€œéŸ³è§†é¢‘åŸå§‹æ•°æ®è¾“å…¥â€”â€”queueBufferâ€ä¸­æœ‰ï¼Œè¿™é‡Œä»…é’ˆå¯¹éŸ³é¢‘æµç¨‹è§£é‡Šä¸‹ã€‚ åŸºæœ¬é€»è¾‘å¾ˆç®€å•ï¼Œä¿å­˜ä¼ å…¥çš„bufferå‚æ•°ï¼Œå¹¶é€šçŸ¥è¾“å‡ºä¸‹AudioQueueã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Renderer::onQueueBuffer(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">......</span><br><span class="line">    QueueEntry entry;</span><br><span class="line">    entry.mBuffer = buffer;</span><br><span class="line">    entry.mNotifyConsumed = notifyConsumed;</span><br><span class="line">    entry.mOffset = <span class="number">0</span>;</span><br><span class="line">    entry.mFinalResult = OK;</span><br><span class="line">    entry.mBufferOrdinal = ++mTotalBuffersQueued;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (audio) &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        mAudioQueue.push_back(entry);</span><br><span class="line">        postDrainAudioQueue_l();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mVideoQueue.push_back(entry);</span><br><span class="line">        postDrainVideoQueue();</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹çœ‹postDrainAudioQueue_lçš„å®ç°ï¼Œå†…éƒ¨å®ç°é€»è¾‘åŸºæœ¬ä¸Šå°±æ˜¯è¾¹ç•Œåˆ¤æ–­åŠ ä¸Šå‘é€kWhatDrainAudioQueueæ¶ˆæ¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Renderer::postDrainAudioQueue_l(<span class="keyword">int64_t</span> delayUs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mAudioQueue.empty()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    mDrainAudioQueuePending = <span class="literal">true</span>;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatDrainAudioQueue, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"drainGeneration"</span>, mAudioDrainGeneration);</span><br><span class="line">    msg-&gt;post(delayUs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£å°±ç»§ç»­æŸ¥çœ‹ä¸‹è¿™ä¸ªæ¶ˆæ¯å¦‚ä½•å¤„ç†çš„ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line">        <span class="keyword">case</span> kWhatDrainAudioQueue:</span><br><span class="line">        &#123;</span><br><span class="line">            mDrainAudioQueuePending = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (onDrainAudioQueue()) &#123;</span><br><span class="line">                <span class="keyword">uint32_t</span> numFramesPlayed;</span><br><span class="line">                <span class="keyword">uint32_t</span> numFramesPendingPlayout = mNumFramesWritten - numFramesPlayed;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è¿™é‡Œæ˜¯audio sinkä¸­ç¼“å­˜äº†å¤šé•¿çš„å¯ç”¨äºæ’­æ”¾çš„æ•°æ®</span></span><br><span class="line">                <span class="keyword">int64_t</span> delayUs = mAudioSink-&gt;msecsPerFrame() * numFramesPendingPlayout * <span class="number">1000l</span>l;</span><br><span class="line">                <span class="keyword">if</span> (mPlaybackRate &gt; <span class="number">1.0f</span>) &#123;</span><br><span class="line">                    delayUs /= mPlaybackRate;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆ©ç”¨ä¸€åŠçš„å»¶æ—¶æ¥ä¿è¯ä¸‹æ¬¡åˆ·æ–°æ—¶é—´ï¼ˆæ³¨æ„æ—¶é—´ä¸Šæœ‰é‡å ï¼‰</span></span><br><span class="line">                delayUs /= <span class="number">2</span>;</span><br><span class="line">                <span class="comment">// å‚è€ƒbufferå¤§å°æ¥ä¼°è®¡æœ€å¤§çš„å»¶æ—¶æ—¶é—´</span></span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">int64_t</span> maxDrainDelayUs = <span class="built_in">std</span>::max(</span><br><span class="line">                        mAudioSink-&gt;getBufferDurationInUs(), (<span class="keyword">int64_t</span>)<span class="number">500000</span> <span class="comment">/* half second */</span>);</span><br><span class="line">                ALOGD_IF(delayUs &gt; maxDrainDelayUs, <span class="string">"postDrainAudioQueue long delay: %lld &gt; %lld"</span>,</span><br><span class="line">                        (<span class="keyword">long</span> <span class="keyword">long</span>)delayUs, (<span class="keyword">long</span> <span class="keyword">long</span>)maxDrainDelayUs);</span><br><span class="line">                Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">                postDrainAudioQueue_l(delayUs); <span class="comment">// è¿™é‡ŒåŒä¸€ä¸ªæ¶ˆæ¯é‡å‘äº†</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œè²Œä¼¼è¿˜æ˜¯æ²¡æœ‰åŒæ­¥çš„æœºåˆ¶ï¼Œä¸è¿‡æˆ‘ä»¬å·²ç»çŸ¥é“è¿™ä¸ªéŸ³é¢‘æ’­æ”¾æ¶ˆæ¯çš„è§¦å‘æœºåˆ¶äº†ï¼Œåœ¨queueBufferå’Œæ¶ˆæ¯å¤„ç†å‡½æ•°ä¸­éƒ½ä¼šè§¦å‘ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å®šæ—¶å™¨ã€‚è¿˜æœ‰æœ€åä¸€ä¸ªå‡½æ•°onDrainAudioQueue()ã€‚ä¸‹é¢æ˜¯ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line"><span class="keyword">bool</span> NuPlayer::Renderer::onDrainAudioQueue() &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> numFramesPlayed;</span><br><span class="line">    <span class="keyword">if</span> (mAudioSink-&gt;getPosition(&amp;numFramesPlayed) != OK) &#123;      </span><br><span class="line">        drainAudioQueueUntilLastEOS();</span><br><span class="line">        ALOGW(<span class="string">"onDrainAudioQueue(): audio sink is not ready"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> prevFramesWritten = mNumFramesWritten;</span><br><span class="line">    <span class="keyword">while</span> (!mAudioQueue.empty()) &#123;</span><br><span class="line">        QueueEntry *entry = &amp;*mAudioQueue.begin();</span><br><span class="line"></span><br><span class="line">        mLastAudioBufferDrained = entry-&gt;mBufferOrdinal;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;mBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆ é™¤é’ˆå¯¹EOSçš„å¤„ç†ä»£ç             </span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ignore 0-sized buffer which could be EOS marker with no data</span></span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;mOffset == <span class="number">0</span> &amp;&amp; entry-&gt;mBuffer-&gt;size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int64_t</span> mediaTimeUs;</span><br><span class="line">            CHECK(entry-&gt;mBuffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;mediaTimeUs));</span><br><span class="line">            ALOGV(<span class="string">"onDrainAudioQueue: rendering audio at media time %.2f secs"</span>,</span><br><span class="line">                    mediaTimeUs / <span class="number">1E6</span>);</span><br><span class="line">            onNewAudioMediaTime(mediaTimeUs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">size_t</span> copy = entry-&gt;mBuffer-&gt;size() - entry-&gt;mOffset;</span><br><span class="line">        <span class="keyword">ssize_t</span> written = mAudioSink-&gt;write(entry-&gt;mBuffer-&gt;data() + entry-&gt;mOffset,</span><br><span class="line">                                            copy, <span class="literal">false</span> <span class="comment">/* blocking */</span>);</span><br><span class="line">        <span class="keyword">if</span> (written &lt; <span class="number">0</span>) &#123;<span class="comment">/* ...å¿½ç•¥å¼‚å¸¸å¤„ç†éƒ¨åˆ†ä»£ç  */</span>&#125;</span><br><span class="line"></span><br><span class="line">        entry-&gt;mOffset += written;</span><br><span class="line">        <span class="keyword">size_t</span> remainder = entry-&gt;mBuffer-&gt;size() - entry-&gt;mOffset;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">ssize_t</span>)remainder &lt; mAudioSink-&gt;frameSize()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (remainder &gt; <span class="number">0</span>) &#123;<span class="comment">// è¿™æ˜¯ç›´æ¥å‡‘æˆå®Œæ•´çš„ä¸€å¸§éŸ³é¢‘</span></span><br><span class="line">                ALOGW(<span class="string">"Corrupted audio buffer has fractional frames, discarding %zu bytes."</span>, remainder);</span><br><span class="line">                entry-&gt;mOffset += remainder;</span><br><span class="line">                copy -= remainder;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            entry-&gt;mNotifyConsumed-&gt;post();</span><br><span class="line">            mAudioQueue.erase(mAudioQueue.begin());</span><br><span class="line">            entry = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">size_t</span> copiedFrames = written / mAudioSink-&gt;frameSize();</span><br><span class="line">        mNumFramesWritten += copiedFrames;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">            <span class="keyword">int64_t</span> maxTimeMedia;</span><br><span class="line">            maxTimeMedia = mAnchorTimeMediaUs +</span><br><span class="line">                        (<span class="keyword">int64_t</span>)(max((<span class="keyword">long</span> <span class="keyword">long</span>)mNumFramesWritten - mAnchorNumFramesWritten, <span class="number">0L</span>L)</span><br><span class="line">                                * <span class="number">1000L</span>L * mAudioSink-&gt;msecsPerFrame());</span><br><span class="line">            mMediaClock-&gt;updateMaxTimeMedia(maxTimeMedia);</span><br><span class="line"></span><br><span class="line">            notifyIfMediaRenderingStarted_l();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (written != (<span class="keyword">ssize_t</span>)copy) &#123;</span><br><span class="line">            <span class="comment">// A short count was received from AudioSink::write()</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// AudioSink write is called in non-blocking mode.</span></span><br><span class="line">            <span class="comment">// It may return with a short count when:</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// 1) Size to be copied is not a multiple of the frame size. Fractional frames are</span></span><br><span class="line">            <span class="comment">//    discarded.</span></span><br><span class="line">            <span class="comment">// 2) The data to be copied exceeds the available buffer in AudioSink.</span></span><br><span class="line">            <span class="comment">// 3) An error occurs and data has been partially copied to the buffer in AudioSink.</span></span><br><span class="line">            <span class="comment">// 4) AudioSink is an AudioCache for data retrieval, and the AudioCache is exceeded.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// (Case 1)</span></span><br><span class="line">            <span class="comment">// Must be a multiple of the frame size.  If it is not a multiple of a frame size, it</span></span><br><span class="line">            <span class="comment">// needs to fail, as we should not carry over fractional frames between calls.</span></span><br><span class="line">            CHECK_EQ(copy % mAudioSink-&gt;frameSize(), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// (Case 2, 3, 4)</span></span><br><span class="line">            <span class="comment">// Return early to the caller.</span></span><br><span class="line">            <span class="comment">// Beware of calling immediately again as this may busy-loop if you are not careful.</span></span><br><span class="line">            ALOGV(<span class="string">"AudioSink write short frame count %zd &lt; %zu"</span>, written, copy);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate whether we need to reschedule another write.</span></span><br><span class="line">    <span class="keyword">bool</span> reschedule = !mAudioQueue.empty()</span><br><span class="line">            &amp;&amp; (!mPaused</span><br><span class="line">                || prevFramesWritten != mNumFramesWritten); <span class="comment">// permit pause to fill buffers</span></span><br><span class="line">    <span class="comment">//ALOGD("reschedule:%d  empty:%d  mPaused:%d  prevFramesWritten:%u  mNumFramesWritten:%u",</span></span><br><span class="line">    <span class="comment">//        reschedule, mAudioQueue.empty(), mPaused, prevFramesWritten, mNumFramesWritten);</span></span><br><span class="line">    <span class="keyword">return</span> reschedule;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢æ¯”è¾ƒä¸»è¦çš„æ›´æ–°æ˜¯onNewAudioMediaTimeå’ŒmNumFramesWrittenå­—æ®µã€‚<br>å‰©ä¸‹çš„ä¸€éƒ¨åˆ†ä»£ç æ˜¯å…³äºå¼‚å¸¸è¾¹ç•Œæƒ…å†µä¸‹çš„éŸ³è§†é¢‘å¤„ç†é€»è¾‘ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line">sp&lt;ABuffer&gt; firstAudioBuffer = (*mAudioQueue.begin()).mBuffer;</span><br><span class="line">    sp&lt;ABuffer&gt; firstVideoBuffer = (*mVideoQueue.begin()).mBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (firstAudioBuffer == <span class="literal">NULL</span> || firstVideoBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// å¯¹äºä¸€ä¸ªé˜Ÿåˆ—ä¸ºç©ºçš„æƒ…å†µï¼Œé€šçŸ¥å¦ä¸ªä¸€é˜Ÿåˆ—EOS</span></span><br><span class="line">        syncQueuesDone_l();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> firstAudioTimeUs;</span><br><span class="line">    <span class="keyword">int64_t</span> firstVideoTimeUs;</span><br><span class="line">    CHECK(firstAudioBuffer-&gt;meta()</span><br><span class="line">            -&gt;findInt64(<span class="string">"timeUs"</span>, &amp;firstAudioTimeUs));</span><br><span class="line">    CHECK(firstVideoBuffer-&gt;meta()</span><br><span class="line">            -&gt;findInt64(<span class="string">"timeUs"</span>, &amp;firstVideoTimeUs));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> diff = firstVideoTimeUs - firstAudioTimeUs;</span><br><span class="line">    <span class="keyword">if</span> (diff &gt; <span class="number">100000l</span>l) &#123;</span><br><span class="line">        <span class="comment">// éŸ³é¢‘æ•°æ®æ—¶é—´æˆ³æ¯”è§†é¢‘æ•°æ®æ—©0.1sï¼Œ</span></span><br><span class="line"></span><br><span class="line">        (*mAudioQueue.begin()).mNotifyConsumed-&gt;post();</span><br><span class="line">        mAudioQueue.erase(mAudioQueue.begin());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    syncQueuesDone_l();</span><br></pre></td></tr></table></figure><h5 id="1-2ã€Rendererä¸­çš„è§†é¢‘åŒæ­¥éƒ¨åˆ†"><a href="#1-2ã€Rendererä¸­çš„è§†é¢‘åŒæ­¥éƒ¨åˆ†" class="headerlink" title="1.2ã€Rendererä¸­çš„è§†é¢‘åŒæ­¥éƒ¨åˆ†"></a>1.2ã€Rendererä¸­çš„è§†é¢‘åŒæ­¥éƒ¨åˆ†</h5><p>å’ŒéŸ³é¢‘åŒæ­¥ç±»ä¼¼ï¼Œå…¥å£åœ¨åœ¨Renderer::queueBuffer()ï¼Œä¸»è¦åŒºåˆ†åœ¨Renderer::onQueueBuffer()ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæ˜¯è§†é¢‘ï¼Œåˆ™å°†æ•°æ®å­˜æ”¾åˆ°è§†é¢‘é˜Ÿåˆ—ï¼Œç„¶åå®‰æ’åˆ·æ–°</span></span><br><span class="line">mVideoQueue.push_back(entry);</span><br><span class="line">postDrainVideoQueue();</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æŒ‰ç…§ä¹‹å‰çš„æ€è·¯ç»§ç»­åˆ†æï¼Œæ¥ä¸‹æ¥æ˜¯postDrainVideoQueueå®ç°ï¼Œä¸»è¦éŸ³è§†é¢‘åŒæ­¥é€»è¾‘ä½äºè¿™é‡Œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Renderer::postDrainVideoQueue() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mVideoQueue.empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    QueueEntry &amp;entry = *mVideoQueue.begin();</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatDrainVideoQueue, <span class="keyword">this</span>); <span class="comment">//è¿™æ˜¯å®é™…å¤„ç†è§†é¢‘ç¼“å†²åŒºå’Œæ˜¾ç¤ºçš„æ¶ˆæ¯</span></span><br><span class="line">    msg-&gt;setInt32(<span class="string">"drainGeneration"</span>, getDrainGeneration(<span class="literal">false</span> <span class="comment">/* audio */</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (entry.mBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// EOS doesn't carry a timestamp.</span></span><br><span class="line">        msg-&gt;post();</span><br><span class="line">        mDrainVideoQueuePending = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> needRepostDrainVideoQueue = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> delayUs;</span><br><span class="line">    <span class="keyword">int64_t</span> nowUs = ALooper::GetNowUs();</span><br><span class="line">    <span class="keyword">int64_t</span> realTimeUs;</span><br><span class="line">    <span class="keyword">int64_t</span> mediaTimeUs;</span><br><span class="line">    CHECK(entry.mBuffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;mediaTimeUs));</span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; FLAG_REAL_TIME) &#123;        </span><br><span class="line">        realTimeUs = mediaTimeUs;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            Mutex::Autolock autoLock(mLock);</span><br><span class="line">            <span class="keyword">if</span> (mAnchorTimeMediaUs &lt; <span class="number">0</span>) &#123; <span class="comment">// åŒæ­¥åŸºå‡†æœªè®¾ç½®çš„æƒ…å†µä¸‹ï¼Œç›´æ¥æ˜¾ç¤º</span></span><br><span class="line">                mMediaClock-&gt;updateAnchor(mediaTimeUs, nowUs, mediaTimeUs);</span><br><span class="line">                mAnchorTimeMediaUs = mediaTimeUs;</span><br><span class="line">                realTimeUs = nowUs;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mVideoSampleReceived) &#123; <span class="comment">// ç¬¬ä¸€å¸§æœªæ˜¾ç¤ºå‰ï¼Œç›´æ¥æ˜¾ç¤º</span></span><br><span class="line">                <span class="comment">// Always render the first video frame.</span></span><br><span class="line">                realTimeUs = nowUs;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mAudioFirstAnchorTimeMediaUs &lt; <span class="number">0</span> <span class="comment">// éŸ³é¢‘æœªæ’­æ”¾ä¹‹å‰ï¼Œä»¥è§†é¢‘ä¸ºå‡†</span></span><br><span class="line">                || mMediaClock-&gt;getRealTimeFor(mediaTimeUs, &amp;realTimeUs) == OK) &#123;</span><br><span class="line">                realTimeUs = getRealTimeUs(mediaTimeUs, nowUs);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mediaTimeUs - mAudioFirstAnchorTimeMediaUs &gt;= <span class="number">0</span>) &#123; <span class="comment">// è§†é¢‘è¶…å‰çš„æƒ…å†µä¸‹ï¼Œç­‰å¾…</span></span><br><span class="line">                needRepostDrainVideoQueue = <span class="literal">true</span>; </span><br><span class="line">                realTimeUs = nowUs;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                realTimeUs = nowUs;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Heuristics to handle situation when media time changed without a</span></span><br><span class="line">        <span class="comment">// discontinuity. If we have not drained an audio buffer that was</span></span><br><span class="line">        <span class="comment">// received after this buffer, repost in 10 msec. Otherwise repost</span></span><br><span class="line">        <span class="comment">// in 500 msec.</span></span><br><span class="line">        delayUs = realTimeUs - nowUs;</span><br><span class="line">        <span class="keyword">int64_t</span> postDelayUs = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (delayUs &gt; <span class="number">500000</span>) &#123;</span><br><span class="line">            postDelayUs = <span class="number">500000</span>;</span><br><span class="line">            <span class="keyword">if</span> (mHasAudio &amp;&amp; (mLastAudioBufferDrained - entry.mBufferOrdinal) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                postDelayUs = <span class="number">10000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (needRepostDrainVideoQueue) &#123;</span><br><span class="line">            <span class="comment">// CHECK(mPlaybackRate &gt; 0);</span></span><br><span class="line">            <span class="comment">// CHECK(mAudioFirstAnchorTimeMediaUs &gt;= 0);</span></span><br><span class="line">            <span class="comment">// CHECK(mediaTimeUs - mAudioFirstAnchorTimeMediaUs &gt;= 0);</span></span><br><span class="line">            postDelayUs = mediaTimeUs - mAudioFirstAnchorTimeMediaUs;</span><br><span class="line">            postDelayUs /= mPlaybackRate;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (postDelayUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            msg-&gt;setWhat(kWhatPostDrainVideoQueue);</span><br><span class="line">            msg-&gt;post(postDelayUs);</span><br><span class="line">            mVideoScheduler-&gt;restart();</span><br><span class="line">            ALOGI(<span class="string">"possible video time jump of %dms or uninitialized media clock, retrying in %dms"</span>,</span><br><span class="line">                    (<span class="keyword">int</span>)(delayUs / <span class="number">1000</span>), (<span class="keyword">int</span>)(postDelayUs / <span class="number">1000</span>));</span><br><span class="line">            mDrainVideoQueuePending = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    realTimeUs = mVideoScheduler-&gt;schedule(realTimeUs * <span class="number">1000</span>) / <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> twoVsyncsUs = <span class="number">2</span> * (mVideoScheduler-&gt;getVsyncPeriod() / <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    delayUs = realTimeUs - nowUs;</span><br><span class="line">    <span class="comment">// ä¸Šé¢ä»£ç çš„ä¸»è¦ç›®çš„æ˜¯è®¡ç®—è¿™ä¸ªå»¶æ—¶</span></span><br><span class="line">    ALOGW_IF(delayUs &gt; <span class="number">500000</span>, <span class="string">"unusually high delayUs: %"</span> PRId64, delayUs);</span><br><span class="line">    <span class="comment">// post 2 display refreshes before rendering is due</span></span><br><span class="line">    msg-&gt;post(delayUs &gt; twoVsyncsUs ? delayUs - twoVsyncsUs : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mDrainVideoQueuePending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦çš„æ˜¯å‘é€äº†ä¸€ä¸ªå»¶æ—¶æ¶ˆæ¯kWhatDrainVideoQueueï¼Œä¸‹é¢æ˜¯å¦‚ä½•å¤„ç†çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line"><span class="keyword">case</span> kWhatDrainVideoQueue:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> generation;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"drainGeneration"</span>, &amp;generation));</span><br><span class="line">    <span class="keyword">if</span> (generation != getDrainGeneration(<span class="literal">false</span> <span class="comment">/* audio */</span>)) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDrainVideoQueuePending = <span class="literal">false</span>;</span><br><span class="line">    onDrainVideoQueue();</span><br><span class="line">    postDrainVideoQueue(); <span class="comment">// æ³¨æ„è¿™é‡Œç›¸å½“äºå®šæ—¶å™¨çš„å®ç°äº†</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨onDrainVideoQueueå‡½æ•°ï¼Œçœ‹çœ‹å¦‚ä½•å®ç°çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Renderer::onDrainVideoQueue() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mVideoQueue.empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    QueueEntry *entry = &amp;*mVideoQueue.begin();</span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;mBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// ...çœç•¥é’ˆå¯¹EOS å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> nowUs = ALooper::GetNowUs();</span><br><span class="line">    <span class="keyword">int64_t</span> realTimeUs;</span><br><span class="line">    <span class="keyword">int64_t</span> mediaTimeUs = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; FLAG_REAL_TIME) &#123;</span><br><span class="line">        CHECK(entry-&gt;mBuffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;realTimeUs));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CHECK(entry-&gt;mBuffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;mediaTimeUs));</span><br><span class="line">        realTimeUs = getRealTimeUs(mediaTimeUs, nowUs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> tooLate = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mPaused) &#123;</span><br><span class="line">        setVideoLateByUs(nowUs - realTimeUs);</span><br><span class="line">        tooLate = (mVideoLateByUs &gt; <span class="number">40000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tooLate) &#123;</span><br><span class="line">            ALOGV(<span class="string">"video late by %lld us (%.2f secs)"</span>,</span><br><span class="line">                 (<span class="keyword">long</span> <span class="keyword">long</span>)mVideoLateByUs, mVideoLateByUs / <span class="number">1E6</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int64_t</span> mediaUs = <span class="number">0</span>;</span><br><span class="line">            mMediaClock-&gt;getMediaTime(realTimeUs, &amp;mediaUs);</span><br><span class="line">            ALOGV(<span class="string">"rendering video at media time %.2f secs"</span>,</span><br><span class="line">                    (mFlags &amp; FLAG_REAL_TIME ? realTimeUs :</span><br><span class="line">                    mediaUs) / <span class="number">1E6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(mFlags &amp; FLAG_REAL_TIME)</span><br><span class="line">                    &amp;&amp; mLastAudioMediaTimeUs != <span class="number">-1</span></span><br><span class="line">                    &amp;&amp; mediaTimeUs &gt; mLastAudioMediaTimeUs) &#123;</span><br><span class="line">                <span class="comment">// If audio ends before video, video continues to drive media clock.</span></span><br><span class="line">                <span class="comment">// Also smooth out videos &gt;= 10fps.</span></span><br><span class="line">                mMediaClock-&gt;updateMaxTimeMedia(mediaTimeUs + <span class="number">100000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setVideoLateByUs(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mVideoSampleReceived &amp;&amp; !mHasAudio) &#123;</span><br><span class="line">            <span class="comment">// This will ensure that the first frame after a flush won't be used as anchor</span></span><br><span class="line">            <span class="comment">// when renderer is in paused state, because resume can happen any time after seek.</span></span><br><span class="line">            Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">            clearAnchorTime_l();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Always render the first video frame while keeping stats on A/V sync.</span></span><br><span class="line">    <span class="keyword">if</span> (!mVideoSampleReceived) &#123;</span><br><span class="line">        realTimeUs = nowUs;</span><br><span class="line">        tooLate = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;setInt64(<span class="string">"timestampNs"</span>, realTimeUs * <span class="number">1000l</span>l); <span class="comment">// ä¸Šé¢æ‰€æœ‰è®¡ç®—çš„å‚æ•°åœ¨è¿™é‡Œä½¿ç”¨äº†</span></span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;setInt32(<span class="string">"render"</span>, !tooLate);</span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;post(); <span class="comment">// æ³¨æ„è¿™é‡Œï¼Œå®é™…æ˜¯å‘è§£ç å™¨å‘é€æ¶ˆæ¯ï¼Œç”¨äºæ˜¾ç¤º</span></span><br><span class="line">    mVideoQueue.erase(mVideoQueue.begin());</span><br><span class="line">    entry = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    mVideoSampleReceived = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mPaused) &#123; <span class="comment">// è¿™é‡Œæ˜¯é€šçŸ¥NuPlayerå±‚æ¸²æŸ“å¼€å§‹</span></span><br><span class="line">        <span class="keyword">if</span> (!mVideoRenderingStarted) &#123;</span><br><span class="line">            mVideoRenderingStarted = <span class="literal">true</span>;</span><br><span class="line">            notifyVideoRenderingStart();</span><br><span class="line">        &#125;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        notifyIfMediaRenderingStarted_l();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œå°ç»“ä¸‹ï¼Œè¯»å®Œè¿™éƒ¨åˆ†ä»£ç å‘ç°ï¼ŒNuPlayer::Rendererä½¿ç”¨çš„ä»¥è§†é¢‘ä¸ºåŸºå‡†çš„åŒæ­¥æœºåˆ¶ï¼ŒéŸ³é¢‘æ™šäº†ç›´æ¥ä¸¢åŒ…ï¼Œè§†é¢‘éœ€è¦æ˜¾ç¤ºã€‚åŒæ­¥ä¸»è¦ä½äºè§†é¢‘ç¼“å†²åŒºå¤„ç†éƒ¨åˆ†onDrainVideoQueueå’ŒéŸ³é¢‘ç¼“å†²åŒºå¤„ç†éƒ¨åˆ†onDrainVideoQueueä¸­ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-05-02-avsync.jpg" alt="Alt text | center"></p><h4 id="ï¼ˆäºŒï¼‰ã€éŸ³è§†é¢‘åŒæ­¥æ—¶åºå›¾"><a href="#ï¼ˆäºŒï¼‰ã€éŸ³è§†é¢‘åŒæ­¥æ—¶åºå›¾" class="headerlink" title="ï¼ˆäºŒï¼‰ã€éŸ³è§†é¢‘åŒæ­¥æ—¶åºå›¾"></a>ï¼ˆäºŒï¼‰ã€éŸ³è§†é¢‘åŒæ­¥æ—¶åºå›¾</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-05-01-AudioVideoSync.png" alt="Alt text | center"></p><p>1ï¼šOMX component é›†æˆåœ¨ACodecä¸­ï¼ŒACodecï¼ˆA/Vï¼‰è§£å®Œæ•°æ®åï¼Œé€šçŸ¥Nulayerï¼›<br>2ï¼šNuPlayeré€šçŸ¥Renderï¼ŒRenderéœ€è¦A/Vçš„æ—¶é—´åŒæ­¥ï¼ˆå¦ï¼Œå¦‚æœæ˜¯JPEGçš„è¯å°±ä¸éœ€è¦è¿™ä¸ªåŒæ­¥ï¼Œç›´æ¥renderå³å¯ï¼‰ï¼›<br>3ï¼šå¯¹äºAudioï¼Œç›´æ¥é€šè¿‡AudioSinkæ’­æ”¾ï¼›<br>4ï¼šå¯¹äºVideoï¼Œé€šè¿‡é€šçŸ¥ACodecï¼Œè®©ACodecé€šè¿‡(NativeWindow/Render)å‘é€åˆ°ç•Œé¢</p><p>Step1:<br>1.1 omx_message::FILL_BUFFER_DONE ===&gt;&gt;&gt;ACodec::onOMXFillBufferDone()<br>  OMX component send msg FILL_BUFFER_DONE<br>  ACodec call onOMXFillBufferDone to handle<br>1.2 ACodec::onOMXFillBufferDone()::ACodec::kWhatDrainThisBuffer setMessage ===&gt;&gt;&gt; NuPlayer::onMessageReceived()<br>Step2:<br>2.1 NuPlayer::renderBuffer()<br>2.2 NuPlayer::Renderer::queueBuffer() ===&gt;&gt;&gt; send msg kWhatQueueBuffer<br>2.3 NuPlayer::Renderer::onMessageReceived() ===&gt;&gt;&gt; onQueueBuffer()<br>2.4 postDrainAudioQueue() or postDrainVideoQueue() ===&gt;&gt;&gt; send msg kWhatDrainVideoQueue<br>2.5 onMessageReceived() ===&gt;&gt;&gt; onDrainVideoQueue(); postDrainVideoQueue();<br>onDrainVideoQueue():A/Vçš„æ—¶é—´åŒæ­¥,å¦‚æœæ…¢0.4s,æ ‡è®°too_late<br>postDrainVideoQueue():A/Vçš„æ—¶é—´åŒæ­¥,å¦‚æœè§£ç æ—¶é—´å¿«ï¼Œå†³å®šç­‰å¾…çš„æ—¶é—´ï¼Œå¹¶æŠŠæ¶ˆæ¯ç»™render<br>Step3ï¼š<br>3.1 postDrainAudioQueue()===&gt;&gt;&gt;onDrainAudioQueue()===&gt;&gt;&gt;mAudioSink-&gt;write()<br>Step4:<br>4.1 Renderer::onDrainVideoQueue(): entry-&gt;mNotifyConsumed-&gt;setInt32(â€œrenderâ€, !tooLate);<br>4.2 Renderer::postDrainVideoQueue()===&gt;&gt;&gt; send msg kWhatDrainVideoQueue<br>4.2 ACodec::BaseState::onMessageReceived() ===&gt;&gt;&gt; onOutputBufferDrained(msg);</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Log:</span><br><span class="line">...</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.675</span>   <span class="number">741</span>  <span class="number">5075</span> V NuPlayerRenderer: rendering video at media time <span class="number">0.36</span> secs</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.676</span>   <span class="number">725</span>  <span class="number">1139</span> V AudioFlinger: releaseWakeLock_l() AudioOut_25</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.676</span>   <span class="number">725</span>  <span class="number">1139</span> V AudioFlinger: thread <span class="number">0xef883380</span> type <span class="number">0</span> TID <span class="number">1139</span> going to sleep</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.679</span>   <span class="number">725</span>  <span class="number">1131</span> V AudioFlinger: releaseWakeLock_l() AudioOut_D</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.682</span>   <span class="number">741</span>  <span class="number">5075</span> V NuPlayerRenderer: onDrainAudioQueue: rendering audio at media time <span class="number">0.70</span> secs</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.683</span>   <span class="number">741</span>  <span class="number">5075</span> V AudioTrack: frame adjustment:<span class="number">2400</span>  timestamp:BOOTTIME offset <span class="number">0</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.683</span>   <span class="number">741</span>  <span class="number">5075</span> V AudioTrack: ExtendedTimestamp[<span class="number">0</span>]  position: <span class="number">0</span>  time: <span class="number">-1</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.683</span>   <span class="number">741</span>  <span class="number">5075</span> V AudioTrack: ExtendedTimestamp[<span class="number">1</span>]  position: <span class="number">17280</span>  time: <span class="number">96476185950</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.683</span>   <span class="number">741</span>  <span class="number">5075</span> V AudioTrack: ExtendedTimestamp[<span class="number">2</span>]  position: <span class="number">0</span>  time: <span class="number">-1</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.683</span>   <span class="number">741</span>  <span class="number">5075</span> V AudioTrack: ExtendedTimestamp[<span class="number">3</span>]  position: <span class="number">0</span>  time: <span class="number">-1</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.683</span>   <span class="number">741</span>  <span class="number">5075</span> V AudioTrack: ExtendedTimestamp[<span class="number">4</span>]  position: <span class="number">0</span>  time: <span class="number">-1</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.683</span>   <span class="number">741</span>  <span class="number">5075</span> V AudioSink: getPlayedOutDurationUs(<span class="number">370130</span>) nowUs(<span class="number">96536315</span>) frames(<span class="number">14880</span>) framesAt(<span class="number">96476185</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.684</span>   <span class="number">741</span>  <span class="number">5075</span> V NuPlayerRenderer: onDrainAudioQueue: rendering audio at media time <span class="number">0.73</span> secs</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.694</span>   <span class="number">725</span>  <span class="number">1131</span> V AudioFlinger: thread <span class="number">0xf0208880</span> type <span class="number">0</span> TID <span class="number">1131</span> going to sleep</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.701</span>   <span class="number">741</span>  <span class="number">5075</span> V NuPlayerRenderer: onDrainAudioQueue: rendering audio at media time <span class="number">0.75</span> secs</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.717</span>   <span class="number">741</span>  <span class="number">5075</span> V NuPlayerRenderer: rendering video at media time <span class="number">0.41</span> secs</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">58.733</span>   <span class="number">741</span>  <span class="number">5075</span> V NuPlayerRenderer: onDrainAudioQueue: rendering audio at media time <span class="number">0.77</span> secs</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆä¸‰ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¸‰ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¸‰ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="http://windrunnerlihuan.com/2016/12/15/Android%E5%A4%9A%E5%AA%92%E4%BD%93%E5%BC%80%E5%8F%91-%E4%BA%94-OpenMax%E7%AE%80%E4%BB%8B/" target="_blank" rel="noopener">â‘£NuPlayeræ’­æ”¾æ¡†æ¶ä¹‹Rendereræºç åˆ†æï¼šéŸ³è§†é¢‘åŒæ­¥æ—¶å¦‚ä½•å®ç°çš„ï¼Ÿ</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">android ACodec MediaCodec NuPlayer flow - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">android MediaCodec ACodec - CSDNåšå®¢</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/09/06/Android%20Video%20System%EF%BC%884%EF%BC%89%EF%BC%9AAndroid%20Multimedia%20-%20OpenMax%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/</id>
    <published>2018-09-05T16:00:00.000Z</published>
    <updated>2018-07-06T12:27:52.098Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/video.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="http://windrunnerlihuan.com/categories/Android%E6%8A%80%E6%9C%AF%E7%82%B9/page/2/" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Copy Windrunnerlihuanï¼ˆOpenMaxåˆ†æï¼‰ã€‘</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Android MediaCodec ACodecã€‘</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  android ACodec MediaCodec NuPlayer flowã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>â˜¯ \hardware\qcom\media\msm8996\libstagefrighthw</p><ul><li>QComOMXPlugin.cpp</li><li>QComOMXMetadata.h</li><li>QComOMXPlugin.h</li></ul><p>â˜¯  \hardware\qcom\media\msm8996\mm-video-v4l2\vidc</p><p>â˜¯ \hardware\qcom\media\msm8996\mm-core</p><hr><h4 id="ï¼ˆä¸€ï¼‰ã€OpenMaxç®€ä»‹"><a href="#ï¼ˆä¸€ï¼‰ã€OpenMaxç®€ä»‹" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€OpenMaxç®€ä»‹"></a>ï¼ˆä¸€ï¼‰ã€OpenMaxç®€ä»‹</h4><p>  androidä¸­çš„ NuPlayerå°±æ˜¯ç”¨OpenMaxæ¥åš(codec)ç¼–è§£ç çš„ï¼Œæœ¬èŠ‚å°±ä¸»è¦ç§‘æ™®ä¸€ä¸‹OpenMaxå’Œå®ƒåœ¨Androidç³»ç»Ÿä¸­æ‰®æ¼”çš„è§’è‰²ã€‚</p><h5 id="1-1ã€-OpenMaxç³»ç»Ÿçš„ç»“æ„"><a href="#1-1ã€-OpenMaxç³»ç»Ÿçš„ç»“æ„" class="headerlink" title="1.1ã€ OpenMaxç³»ç»Ÿçš„ç»“æ„"></a>1.1ã€ OpenMaxç³»ç»Ÿçš„ç»“æ„</h5><h6 id="1-1-1ã€OpenMaxæ€»ä½“å±‚æ¬¡ç»“æ„"><a href="#1-1-1ã€OpenMaxæ€»ä½“å±‚æ¬¡ç»“æ„" class="headerlink" title="1.1.1ã€OpenMaxæ€»ä½“å±‚æ¬¡ç»“æ„"></a>1.1.1ã€OpenMaxæ€»ä½“å±‚æ¬¡ç»“æ„</h6><p> OpenMaxæ˜¯ä¸€ä¸ªå¤šåª’ä½“åº”ç”¨ç¨‹åºçš„æ¡†æ¶æ ‡å‡†ï¼Œç”±NVIDIAå…¬å¸å’ŒKhronosåœ¨2006å¹´æ¨å‡ºã€‚</p><p> OpenMaxæ˜¯æ— æˆæƒè´¹çš„ï¼Œè·¨å¹³å°çš„åº”ç”¨ç¨‹åºæ¥å£APIï¼Œé€šè¿‡ä½¿åª’ä½“åŠ é€Ÿç»„ä»¶èƒ½å¤Ÿåœ¨å¼€å‘ã€é›†æˆå’Œç¼–ç¨‹ç¯èŠ‚ä¸­å®ç°è·¨å¤šæ“ä½œç³»ç»Ÿå’Œå¤„ç†å™¨ç¡¬ä»¶å¹³å°ï¼Œæä¾›å…¨é¢çš„æµåª’ä½“ç¼–è§£ç å™¨å’Œåº”ç”¨ç¨‹åºä¾¿æºåŒ–ã€‚</p><p>OpenMaxçš„å®˜æ–¹ç½‘ç«™å¦‚ä¸‹æ‰€ç¤ºï¼š<br>       <a href="http://www.khronos.org/openmax/" target="_blank" rel="noopener">http://www.khronos.org/openmax/</a><br>OpenMaxå®é™…ä¸Šåˆ†æˆä¸‰ä¸ªå±‚æ¬¡ï¼Œè‡ªä¸Šè€Œä¸‹åˆ†åˆ«æ˜¯ï¼ŒOpenMax DLï¼ˆå¼€å‘å±‚ï¼‰ï¼ŒOpenMax ILï¼ˆé›†æˆå±‚ï¼‰å’ŒOpenMax ALï¼ˆåº”ç”¨å±‚ï¼‰ã€‚ä¸‰ä¸ªå±‚æ¬¡çš„å†…å®¹åˆ†åˆ«å¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p>ç¬¬ä¸€å±‚ï¼šOpenMax DLï¼ˆDevelopment Layerï¼Œå¼€å‘å±‚ï¼‰<br>        OpenMax DLå®šä¹‰äº†ä¸€ä¸ªAPIï¼Œå®ƒæ˜¯éŸ³é¢‘ã€è§†é¢‘å’Œå›¾åƒåŠŸèƒ½çš„é›†åˆã€‚ä¾›åº”å•†èƒ½å¤Ÿåœ¨ä¸€ä¸ªæ–°çš„å¤„ç†å™¨ä¸Šå®ç°å¹¶ä¼˜åŒ–ï¼Œç„¶åç¼–è§£ç ä¾›åº”å•†ä½¿ç”¨å®ƒæ¥ç¼–å†™æ›´å¹¿æ³›çš„ç¼–è§£ç å™¨åŠŸèƒ½ã€‚å®ƒåŒ…æ‹¬éŸ³é¢‘ä¿¡å·çš„å¤„ç†åŠŸèƒ½ï¼Œå¦‚FFTå’Œfilterï¼Œå›¾åƒåŸå§‹å¤„ç†ï¼Œå¦‚é¢œè‰²ç©ºé—´è½¬æ¢ã€è§†é¢‘åŸå§‹å¤„ç†ï¼Œä»¥å®ç°ä¾‹å¦‚MPEG-4ã€H.264ã€MP3ã€AACå’ŒJPEGç­‰ç¼–è§£ç å™¨çš„ä¼˜åŒ–ã€‚</p><p>ç¬¬äºŒå±‚ï¼šOpenMax ILï¼ˆIntegration Layerï¼Œé›†æˆå±‚ï¼‰<br>       OpenMax ILä½œä¸ºéŸ³é¢‘ã€è§†é¢‘å’Œå›¾åƒç¼–è§£ç å™¨èƒ½ä¸å¤šåª’ä½“ç¼–è§£ç å™¨äº¤äº’ï¼Œå¹¶ä»¥ç»Ÿä¸€çš„è¡Œä¸ºæ”¯æŒç»„ä»¶ï¼ˆä¾‹å¦‚ï¼Œèµ„æºå’Œçš®è‚¤ï¼‰ã€‚è¿™äº›ç¼–è§£ç å™¨æˆ–è®¸æ˜¯è½¯ç¡¬ä»¶çš„æ··åˆä½“ï¼Œå¯¹ç”¨æˆ·æ˜¯é€æ˜çš„åº•å±‚æ¥å£åº”ç”¨äºåµŒå…¥å¼ã€ç§»åŠ¨è®¾å¤‡ã€‚å®ƒæä¾›äº†åº”ç”¨ç¨‹åºå’Œåª’ä½“æ¡†æ¶ï¼Œé€æ˜çš„ã€‚ç¼–è§£ç å™¨ä¾›åº”å•†å¿…é¡»å†™ç§æœ‰çš„æˆ–è€…å°é—­çš„æ¥å£ï¼Œé›†æˆè¿›ç§»åŠ¨è®¾å¤‡ã€‚ILçš„ä¸»è¦ç›®çš„æ˜¯ä½¿ç”¨ç‰¹å¾é›†åˆä¸ºç¼–è§£ç å™¨æä¾›ä¸€ä¸ªç³»ç»ŸæŠ½è±¡ï¼Œä¸ºè§£å†³å¤šä¸ªä¸åŒåª’ä½“ç³»ç»Ÿä¹‹é—´è½»ä¾¿æ€§çš„é—®é¢˜ã€‚</p><p>ç¬¬ä¸‰å±‚ï¼šOpenMax ALï¼ˆAppliction Layerï¼Œåº”ç”¨å±‚ï¼‰<br>       OpenMax AL APIåœ¨åº”ç”¨ç¨‹åºå’Œå¤šåª’ä½“ä¸­é—´ä»¶ä¹‹é—´æä¾›äº†ä¸€ä¸ªæ ‡å‡†åŒ–æ¥å£ï¼Œå¤šåª’ä½“ä¸­é—´ä»¶æä¾›æœåŠ¡ä»¥å®ç°è¢«æœŸå¾…çš„APIåŠŸèƒ½ã€‚</p></blockquote><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-01-openmaxsystem.png" alt="Alt text | center"></p><p>OpenMax APIå°†ä¼šä¸å¤„ç†å™¨ä¸€åŒæä¾›ï¼Œä»¥<strong>ä½¿åº“å’Œç¼–è§£ç å™¨å¼€å‘è€…èƒ½å¤Ÿé«˜é€Ÿæœ‰æ•ˆåœ°åˆ©ç”¨æ–°å™¨ä»¶çš„å®Œæ•´åŠ é€Ÿæ½œèƒ½ï¼Œæ— é¡»æ‹…å¿ƒå…¶åº•å±‚çš„ç¡¬ä»¶ç»“æ„ã€‚</strong>è¯¥æ ‡å‡†æ˜¯é’ˆå¯¹åµŒå…¥å¼è®¾å¤‡å’Œç§»åŠ¨è®¾å¤‡çš„å¤šåª’ä½“è½¯ä»¶æ¶æ„ã€‚åœ¨æ¶æ„åº•å±‚ä¸Šä¸ºå¤šåª’ä½“çš„ç¼–è§£ç å’Œæ•°æ®å¤„ç†å®šä¹‰äº†ä¸€å¥—ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ï¼Œå¯¹å¤šåª’ä½“æ•°æ®çš„å¤„ç†åŠŸèƒ½è¿›è¡Œç³»ç»Ÿçº§æŠ½è±¡ï¼Œä¸ºç”¨æˆ·å±è”½äº†åº•å±‚çš„ç»†èŠ‚ã€‚å› æ­¤ï¼Œ<strong>å¤šåª’ä½“åº”ç”¨ç¨‹åºå’Œå¤šåª’ä½“æ¡†æ¶é€šè¿‡OpenMax ILå¯ä»¥ä»¥ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼æ¥ä½¿ç”¨ç¼–è§£ç å’Œå…¶ä»–å¤šåª’ä½“æ•°æ®å¤„ç†åŠŸèƒ½ï¼Œå…·æœ‰äº†è·¨è¶Šè½¯ç¡¬ä»¶å¹³å°çš„ç§»æ¤æ€§ã€‚</strong></p><p>æ³¨ï¼šåœ¨å®é™…çš„åº”ç”¨ä¸­ï¼ŒOpenMaxçš„ä¸‰ä¸ªå±‚æ¬¡ä¸­ä½¿ç”¨è¾ƒå¤šçš„æ˜¯OpenMax ILé›†æˆå±‚ï¼Œç”±äºæ“ä½œç³»ç»Ÿåˆ°ç¡¬ä»¶çš„å·®å¼‚å’Œå¤šåª’ä½“åº”ç”¨çš„å·®å¼‚ï¼ŒOpenMaxçš„DLå’ŒALå±‚ä½¿ç”¨ç›¸å¯¹è¾ƒå°‘ã€‚</p><h6 id="1-1-2ã€OpenMax-ILç®€ä»‹"><a href="#1-1-2ã€OpenMax-ILç®€ä»‹" class="headerlink" title="1.1.2ã€OpenMax ILç®€ä»‹"></a>1.1.2ã€OpenMax ILç®€ä»‹</h6><p>OpenMax IL å¤„åœ¨ä¸­é—´å±‚çš„ä½ç½®ï¼ŒOpenMAX IL ä½œä¸ºéŸ³é¢‘ï¼Œè§†é¢‘å’Œå›¾åƒç¼–è§£ç å™¨ èƒ½ä¸å¤šåª’ä½“ç¼–è§£ç å™¨äº¤äº’ï¼Œå¹¶ä»¥ç»Ÿä¸€çš„è¡Œä¸ºæ”¯æŒç»„ä»¶ï¼ˆä¾‹å¦‚èµ„æºå’Œçš®è‚¤ï¼‰ã€‚è¿™äº›ç¼–è§£ç å™¨æˆ–è®¸æ˜¯è½¯ç¡¬ä»¶çš„æ··åˆä½“ï¼Œå¯¹ç”¨æˆ·æ˜¯ çš„åº•å±‚æ¥å£åº”ç”¨äºåµŒå…¥å¼æˆ– / å’Œç§»åŠ¨è®¾å¤‡ã€‚å®ƒæä¾›äº†åº”ç”¨ç¨‹åºå’Œåª’ä½“æ¡†æ¶ï¼Œ é€æ˜çš„ã€‚æœ¬è´¨ä¸Šä¸å­˜åœ¨è¿™ç§æ ‡å‡†åŒ–çš„æ¥å£ï¼Œç¼–è§£ç å™¨ä¾› åº”å•†å¿…é¡»å†™ç§æœ‰çš„æˆ–è€…å°é—­çš„æ¥å£ï¼Œé›†æˆè¿›ç§»åŠ¨è®¾å¤‡ã€‚ IL çš„ä¸»è¦ç›®çš„ æ˜¯ä½¿ç”¨ç‰¹å¾é›†åˆä¸ºç¼–è§£ç å™¨æä¾›ä¸€ä¸ªç³»ç»ŸæŠ½è±¡ï¼Œä¸ºè§£å†³å¤šä¸ªä¸åŒåª’ä½“ç³»ç»Ÿä¹‹é—´è½»ä¾¿æ€§çš„é—®é¢˜ã€‚<br>       OpenMax IL çš„ç›®çš„å°±æ˜¯ä¸ºç¡¬ä»¶å¹³å°çš„å›¾å½¢åŠéŸ³è§†é¢‘æä¾›ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå¯ä»¥ä¸ºä¸Šå±‚çš„åº”ç”¨æä¾›ä¸€ä¸ªå¯è·¨å¹³å°çš„æ”¯æ’‘ã€‚è¿™ä¸€ç‚¹å¯¹äºè·¨å¹³å°çš„åª’ä½“åº”ç”¨æ¥è¯´ååˆ†é‡è¦ã€‚æœ¬äººä¹Ÿæ¥è§¦è¿‡å‡ å®¶é«˜æ¸…è§£ç èŠ¯ç‰‡ï¼Œè¿™äº›èŠ¯ç‰‡åº•å±‚çš„éŸ³è§†é¢‘æ¥å£è™½ç„¶åŠŸèƒ½ä¸Šå¤§è‡´ç›¸åŒï¼Œä½†æ˜¯æ¥å£è®¾è®¡åŠç”¨æ³•ä¸Šå„æœ‰ä¸åŒï¼Œè€Œä¸”ç›¸å·®å¾ˆå¤šã€‚ä½ è¦æƒ³è®©è‡ªå·±å¼€å‘çš„åª’ä½“åº”ç”¨å®Œç¾çš„è¿è¡Œåœ¨ä¸åŒçš„ç¡¬ä»¶å‚å•†å¹³å°ä¸Šï¼Œå°±å¾—é€‚åº”ä¸åŒèŠ¯ç‰‡çš„åº•å±‚è§£ç æ¥å£ã€‚è¿™ä¸ªå¯¹äºåº”ç”¨å¼€å‘æ¥è¯´ååˆ†ç¹çã€‚æ‰€ä»¥å°±éœ€è¦ç±»ä¼¼äºOpenMax IL è¿™ç§æ¥å£è§„èŒƒã€‚åº”ç”¨å‡å¦‚æ¶‰åŠåˆ°éŸ³è§†é¢‘ç›¸å…³åŠŸèƒ½æ—¶ï¼Œåªéœ€è°ƒç”¨è¿™äº›æ ‡å‡†çš„æ¥å£ï¼Œè€Œä¸éœ€è¦å…³å¿ƒæ¥å£ä¸‹æ–¹ç¡¬ä»¶ç›¸å…³çš„å®ç°ã€‚å‡å¦‚æ¢äº†ç¡¬ä»¶å¹³å°æ—¶ï¼Œåªéœ€è¦æŠŠæ¥å£å±‚ä¸ç¡¬ä»¶é€‚é…å¥½äº†å°±è¡Œäº†ã€‚ä¸Šå±‚åº”ç”¨ä¸éœ€è¦é¢‘ç¹æ”¹åŠ¨ã€‚<br>       ä½ å¯ä»¥æŠŠOpenMax IL çœ‹ä½œæ˜¯ä¸­é—´ä»¶ä¸­çš„portingå±‚æ¥å£ï¼Œä½†æ˜¯ç°åœ¨ä¸­é—´ä»¶å¤§éƒ¨åˆ†éƒ½æ˜¯è‡ªå®¶å®šä¹‰è‡ªå·±çš„ã€‚</p><p>OpenMax æƒ³åšçš„å°±æ˜¯å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„è¡Œä¸šæ ‡å‡†ï¼Œè¿™æ ·åª’ä½“åº”ç”¨ã€ç¡¬ä»¶å‚å•†éƒ½éµå¾ªè¿™ç§æ ‡å‡†ã€‚ç¡¬ä»¶å‚å•†å°†OpenMax ä¸å¤„ç†å™¨ä¸€å¹¶æä¾›ï¼Œä¸Šå±‚çš„å¤šåª’ä½“æ¡†æ¶æƒ³è¦ç”¨åˆ°ç¡¬ä»¶éŸ³è§†é¢‘åŠ é€ŸåŠŸèƒ½æ—¶ï¼Œåªéœ€éµå¾ªopenmaxçš„æ¥å£å°±å¯ä»¥æ‰©å¹³å°è¿è¡Œã€‚<br>       å¯å–œçš„ï¼Œç°åœ¨è¶Šæ¥è¶Šå¤šçš„å¤šåª’ä½“æ¡†æ¶åŠå¤šåª’ä½“åº”ç”¨æ­£åœ¨éµå¾ªopenmaxæ ‡å‡†ï¼ŒåŒ…æ‹¬å„ç§çŸ¥åçš„åª’ä½“å¼€æºè½¯ä»¶ã€‚è¶Šæ¥è¶Šå¤šçš„èŠ¯ç‰‡å‚å•†ä¹Ÿåœ¨éµå¾ªopenmaxçš„æ ‡å‡†ã€‚å¯¹äºç°åœ¨çš„éŸ³è§†é¢‘ç¼–è§£ç æ¥è¯´ï¼Œåˆ†è¾¨ç‡è¶Šæ¥è¶Šé«˜ï¼Œéœ€è¦èŠ¯ç‰‡æä¾›ç¡¬ä»¶åŠ é€ŸåŠŸèƒ½æ˜¯ä¸ªå¤§çš„è¶‹åŠ¿ã€‚æˆ‘ç›¸ä¿¡ æ¥å£çš„æ ‡å‡†åŒ–æ˜¯ä¸€å®šè¦èµ°çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ openmax ILåœ¨å¤šåª’ä½“æ¡†æ¶ä¸­çš„åº”ç”¨ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-02-openmaxuse.png" alt="Alt text | center"></p><p><strong>OpenMax ILç›®å‰å·²ç»æˆä¸ºäº†äº‹å®ä¸Šçš„å¤šåª’ä½“æ¡†æ¶æ ‡å‡†ã€‚</strong>åµŒå…¥å¼å¤„ç†å™¨æˆ–è€…å¤šåª’ä½“ç¼–è§£ç æ¨¡å—çš„ç¡¬ä»¶ç”Ÿäº§è€…ï¼Œé€šå¸¸æä¾›æ ‡å‡†çš„OpenMax ILå±‚çš„è½¯ä»¶æ¥å£ï¼Œè¿™æ ·è½¯ä»¶çš„å¼€å‘è€…å°±å¯ä»¥åŸºäºè¿™ä¸ªå±‚æ¬¡çš„æ ‡å‡†åŒ–æ¥å£è¿›è¡Œå¤šåª’ä½“ç¨‹åºçš„å¼€å‘ã€‚</p><p> OpenMax ILçš„æ¥å£å±‚æ¬¡ç»“æ„é€‚ä¸­ï¼Œæ—¢ä¸æ˜¯ç¡¬ä»¶ç¼–è§£ç çš„æ¥å£ï¼Œä¹Ÿä¸æ˜¯åº”ç”¨ç¨‹åºå±‚çš„æ¥å£ï¼Œå› æ­¤æ¯”è¾ƒå®¹æ˜“å®ç°æ ‡å‡†åŒ–ã€‚OpenMax ILçš„å±‚æ¬¡ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-03-openmaxIL.png" alt="Alt text | center"></p><p>å›¾ä¸­çš„è™šçº¿ä¸­çš„å†…å®¹æ˜¯OpenMax ILå±‚çš„å†…å®¹ï¼Œå…¶ä¸»è¦å®ç°äº†OpenMax ILä¸­çš„å„ä¸ªç»„ä»¶ï¼ˆComponentï¼‰ã€‚<strong>å¯¹ä¸‹å±‚ï¼ŒOpenMax ILå¯ä»¥è°ƒç”¨OpenMax DLå±‚çš„æ¥å£ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨å„ç§Codecå®ç°ã€‚å¯¹ä¸Šå±‚ï¼ŒOpenMax ILå¯ä»¥ç»™OpenMax AL å±‚ç­‰æ¡†æ¶å±‚ï¼ˆMiddlewareï¼‰è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥ç»™åº”ç”¨ç¨‹åºç›´æ¥è°ƒç”¨ã€‚</strong></p><h6 id="1-1-3ã€OpenMax-ILç»“æ„"><a href="#1-1-3ã€OpenMax-ILç»“æ„" class="headerlink" title="1.1.3ã€OpenMax ILç»“æ„"></a>1.1.3ã€OpenMax ILç»“æ„</h6><p>OpenMax ILä¸»è¦å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>â˜¯ å®¢æˆ·ç«¯ï¼ˆClientï¼‰ï¼šOpenMax ILçš„è°ƒç”¨è€…<br>â˜¯ ç»„ä»¶ï¼ˆComponentï¼‰ï¼šOpenMax ILçš„å•å…ƒï¼Œæ¯ä¸€ä¸ªç»„ä»¶å®ç°ä¸€ç§åŠŸèƒ½<br>â˜¯ ç«¯å£ï¼ˆPortï¼‰ï¼šç»„ä»¶çš„è¾“å…¥è¾“å‡ºæ¥å£<br>â˜¯ éš§é“åŒ–ï¼ˆTunneledï¼‰ï¼šè®©ä¸¤ä¸ªç»„ä»¶ç›´æ¥è¿æ¥çš„æ–¹å¼<br>       OpenMax ILçš„åŸºæœ¬è¿ä½œè¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-04-openmaxilbase.png" alt="Alt text | center"></p><p>OpenMAL ILçš„å®¢æˆ·ç«¯ï¼Œé€šè¿‡è°ƒç”¨å››ä¸ªOpenMAL ILç»„ä»¶ï¼Œå®ç°äº†ä¸€ä¸ªåŠŸèƒ½ã€‚å››ä¸ªç»„ä»¶åˆ†åˆ«æ˜¯Sourceç»„ä»¶ã€Hostç»„ä»¶ã€Acceleratorç»„ä»¶å’ŒSinkç»„ä»¶ã€‚Sourceç»„ä»¶åªæœ‰ä¸€ä¸ªè¾“å‡ºç«¯å£ï¼›è€ŒHostç»„ä»¶æœ‰ä¸€ä¸ªè¾“å…¥ç«¯å£å’Œä¸€ä¸ªè¾“å‡ºç«¯å£ï¼›Acceleratorç»„ä»¶å…·æœ‰ä¸€ä¸ªè¾“å…¥ç«¯å£ï¼Œè°ƒç”¨äº†ç¡¬ä»¶çš„ç¼–è§£ç å™¨ï¼ŒåŠ é€Ÿä¸»è¦ä½“ç°åœ¨è¿™ä¸ªç¯èŠ‚ä¸Šã€‚Acceleratorç»„ä»¶å’ŒSinkç»„ä»¶é€šè¿‡ç§æœ‰é€šè®¯æ–¹å¼åœ¨å†…éƒ¨è¿›è¡Œè¿æ¥ï¼Œæ²¡æœ‰ç»è¿‡æ˜ç¡®çš„ç»„ä»¶ç«¯å£ã€‚<br>       OpenMAL ILåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå…¶æ•°æ®æµä¹Ÿæœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼šæ—¢å¯ä»¥ç»ç”±å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥ä¸ç»ç”±å®¢æˆ·ç«¯ã€‚å›¾ä¸­Sourceç»„ä»¶åˆ°Hostç»„ä»¶çš„æ•°æ®æµå°±æ˜¯ç»è¿‡å®¢æˆ·ç«¯çš„ï¼›è€ŒHostç»„ä»¶åˆ°Acceleratorç»„ä»¶çš„æ•°æ®æµå°±æ²¡æœ‰ç»è¿‡å®¢æˆ·ç«¯ï¼Œä½¿ç”¨äº†éš§é“åŒ–çš„æ–¹å¼ï¼›Acceleratorç»„ä»¶å’ŒSinkç»„ä»¶ç”šè‡³å¯ä»¥ä½¿ç”¨ç§æœ‰çš„é€šè®¯æ–¹å¼ã€‚</p><p>   OpenMax Coreæ˜¯è¾…åŠ©å„ä¸ªç»„ä»¶è¿è¡Œçš„éƒ¨åˆ†ï¼Œå®ƒé€šå¸¸éœ€è¦å®Œæˆå„ä¸ªç»„ä»¶çš„åˆå§‹åŒ–ç­‰å·¥ä½œï¼Œåœ¨çœŸæ­£è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œé‡ç‚¹æ˜¯å„ä¸ªOpenMax ILçš„ç»„ä»¶ï¼ŒOpenMax Coreä¸æ˜¯é‡ç‚¹ï¼Œä¹Ÿä¸æ˜¯æ ‡å‡†ã€‚</p><p> OpenMAL ILçš„ç»„ä»¶æ˜¯OpenMax ILå®ç°çš„æ ¸å¿ƒå†…å®¹ï¼Œä¸€ä¸ªç»„ä»¶ä»¥è¾“å…¥ã€è¾“å‡ºç«¯å£ä¸ºæ¥å£ï¼Œç«¯å£å¯ä»¥è¢«è¿æ¥åˆ°å¦ä¸€ä¸ªç»„ä»¶ä¸Šã€‚å¤–éƒ¨å¯¹ç»„ä»¶å¯ä»¥å‘é€å‘½ä»¤ï¼Œè¿˜è¿›è¡Œè®¾ç½®/è·å–å‚æ•°ã€é…ç½®ç­‰å†…å®¹ã€‚ç»„ä»¶çš„ç«¯å£å¯ä»¥åŒ…å«ç¼“å†²åŒºï¼ˆBufferï¼‰çš„é˜Ÿåˆ—ã€‚</p><p>ç»„ä»¶çš„å¤„ç†çš„æ ¸å¿ƒå†…å®¹æ˜¯ï¼šé€šè¿‡è¾“å…¥ç«¯å£æ¶ˆè€—Bufferï¼Œé€šè¿‡è¾“å‡ºç«¯å£å¡«å……Bufferï¼Œç”±æ­¤å¤šç»„ä»¶ç›¸è”æ¥å¯ä»¥æ„æˆæµå¼çš„å¤„ç†ã€‚OpenMAL ILä¸­ä¸€ä¸ªç»„ä»¶çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-05-openilinternal.jpg" alt="Alt text | center"></p><pre><code>ç»„ä»¶çš„åŠŸèƒ½å’Œå…¶å®šä¹‰çš„ç«¯å£ç±»å‹å¯†åˆ‡ç›¸å…³ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼šåªæœ‰ä¸€ä¸ªè¾“å‡ºç«¯å£çš„ï¼Œä¸ºSourceç»„ä»¶ï¼›åªæœ‰ä¸€ä¸ªè¾“å…¥ç«¯å£çš„ï¼Œä¸ºSinkç»„ä»¶ï¼›æœ‰å¤šä¸ªè¾“å…¥ç«¯å£ï¼Œä¸€ä¸ªè¾“å‡ºç«¯å£çš„ä¸ºMuxç»„ä»¶ï¼›æœ‰ä¸€ä¸ªè¾“å…¥ç«¯å£ï¼Œå¤šä¸ªè¾“å‡ºç«¯å£çš„ä¸ºDeMuxç»„ä»¶ï¼›è¾“å…¥è¾“å‡ºç«¯å£å„ä¸€ä¸ªç»„ä»¶çš„ä¸ºä¸­é—´å¤„ç†ç¯èŠ‚ï¼Œè¿™æ˜¯æœ€å¸¸è§çš„ç»„ä»¶ã€‚</code></pre><p>  ç«¯å£å…·ä½“æ”¯æŒçš„æ•°æ®ä¹Ÿæœ‰ä¸åŒçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªè¾“å…¥ã€è¾“å‡ºç«¯å£å„ä¸€ä¸ªç»„ä»¶ï¼Œå…¶è¾“å…¥ç«¯å£ä½¿ç”¨MP3æ ¼å¼çš„æ•°æ®ï¼Œè¾“å‡ºç«¯å£ä½¿ç”¨PCMæ ¼å¼çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªç»„ä»¶å°±æ˜¯ä¸€ä¸ªMP3è§£ç ç»„ä»¶ã€‚</p><p>  éš§é“åŒ–ï¼ˆTunneledï¼‰æ˜¯ä¸€ä¸ªå…³äºç»„ä»¶è¿æ¥æ–¹å¼çš„æ¦‚å¿µã€‚é€šè¿‡éš§é“åŒ–å¯ä»¥å°†ä¸åŒçš„ç»„ä»¶çš„ä¸€ä¸ªè¾“å…¥ç«¯å£å’Œä¸€ä¸ªè¾“å‡ºç«¯å£è¿æ¥åˆ°ä¸€èµ·ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªç»„ä»¶çš„å¤„ç†è¿‡ç¨‹åˆå¹¶ï¼Œå…±åŒå¤„ç†ã€‚å°¤å…¶å¯¹äºå•è¾“å…¥å’Œå•è¾“å‡ºçš„ç»„ä»¶ï¼Œä¸¤ä¸ªç»„ä»¶å°†ä½œä¸ºç±»ä¼¼ä¸€ä¸ªä½¿ç”¨ã€‚</p><h5 id="1-2ã€Androidä¸­çš„OpenMax"><a href="#1-2ã€Androidä¸­çš„OpenMax" class="headerlink" title="1.2ã€Androidä¸­çš„OpenMax"></a>1.2ã€Androidä¸­çš„OpenMax</h5><h6 id="1-2-1ã€OpenMaxåœ¨Androidä¸­çš„ä½¿ç”¨æƒ…å†µ"><a href="#1-2-1ã€OpenMaxåœ¨Androidä¸­çš„ä½¿ç”¨æƒ…å†µ" class="headerlink" title="1.2.1ã€OpenMaxåœ¨Androidä¸­çš„ä½¿ç”¨æƒ…å†µ"></a>1.2.1ã€OpenMaxåœ¨Androidä¸­çš„ä½¿ç”¨æƒ…å†µ</h6><p>  åœ¨Androidä¸­ï¼ŒOpenMax ILå±‚ï¼Œ<strong>é€šå¸¸å¯ä»¥ç”¨äºå¤šåª’ä½“å¼•æ“çš„æ’ä»¶</strong>ï¼ŒAndroidçš„å¤šåª’ä½“å¼•æ“OpenCoreå’ŒStageFrightéƒ½å¯ä»¥ä½¿ç”¨OpenMaxä½œä¸ºæ’ä»¶ï¼Œä¸»è¦ç”¨äº<strong>ç¼–è§£ç ï¼ˆCodecï¼‰</strong>å¤„ç†ã€‚<br>  åœ¨Androidçš„æ¡†æ¶å±‚ï¼Œä¹Ÿå®šä¹‰äº†ç”±Androidå°è£…çš„OpenMaxæ¥å£ï¼Œå’Œæ ‡å‡†çš„æ¥å£æ¦‚å¿µåŸºæœ¬ç›¸åŒï¼Œä½†æ˜¯ä½¿ç”¨C++ç±»å‹çš„æ¥å£ï¼Œå¹¶ä¸”ä½¿ç”¨äº†Androidçš„Binder IPCæœºåˆ¶ã€‚Androidå°è£…OpenMaxçš„æ¥å£è¢«StageFrightä½¿ç”¨ï¼ŒOpenCoreæ²¡æœ‰ä½¿ç”¨è¿™ä¸ªæ¥å£ï¼Œè€Œæ˜¯ä½¿ç”¨å…¶ä»–å½¢å¼å¯¹OpenMax ILå±‚æ¥å£è¿›è¡Œå°è£…ã€‚Android OpenMaxçš„åŸºæœ¬å±‚æ¬¡ç»“æ„å¦‚å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-06-openmaxinandroid.jpg" alt="Alt text | center"></p><p>Androidç³»ç»Ÿçš„ä¸€äº›éƒ¨åˆ†å¯¹OpenMax ILå±‚è¿›è¡Œä½¿ç”¨ï¼ŒåŸºæœ¬ä½¿ç”¨çš„æ˜¯æ ‡å‡†OpenMax ILå±‚çš„æ¥å£ï¼Œåªæ˜¯è¿›è¡Œäº†ç®€å•çš„å°è£…ã€‚æ ‡å‡†çš„OpenMax ILå®ç°å¾ˆå®¹æ˜“ä»¥æ’ä»¶çš„å½¢å¼åŠ å…¥åˆ°Androidç³»ç»Ÿä¸­ã€‚</p><p>Androidçš„å¤šåª’ä½“å¼•æ“OpenCoreå’ŒStageFrightéƒ½å¯ä»¥ä½¿ç”¨OpenMaxä½œä¸ºå¤šåª’ä½“ç¼–è§£ç çš„æ’ä»¶ï¼Œåªæ˜¯æ²¡æœ‰ç›´æ¥ä½¿ç”¨OpenMax ILå±‚æä¾›çš„çº¯Cæ¥å£ï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡Œäº†ä¸€å®šçš„å°è£…(C++å°è£…)ã€‚</p><p>åœ¨Android2.xç‰ˆæœ¬ä¹‹åï¼ŒAndroidçš„æ¡†æ¶å±‚ä¹Ÿå¯¹OpenMax ILå±‚çš„æ¥å£è¿›è¡Œäº†å°è£…å®šä¹‰ï¼Œç”šè‡³ä½¿ç”¨Androidä¸­çš„Binder IPCæœºåˆ¶ã€‚Stagefrightä½¿ç”¨äº†è¿™ä¸ªå±‚æ¬¡çš„æ¥å£ï¼ŒOpenCoreæ²¡æœ‰ä½¿ç”¨ã€‚</p><p>æ³¨ï¼šOpenCoreä½¿ç”¨OpenMax ILå±‚ä½œä¸ºç¼–è§£ç æ’ä»¶åœ¨å‰ï¼ŒAndroidæ¡†æ¶å±‚å°è£…OpenMaxæ¥å£åœ¨åé¢çš„ç‰ˆæœ¬ä¸­æ‰å¼•å…¥ã€‚</p><h6 id="1-2-2ã€Android-OpenMaxå®ç°çš„å†…å®¹"><a href="#1-2-2ã€Android-OpenMaxå®ç°çš„å†…å®¹" class="headerlink" title="1.2.2ã€Android OpenMaxå®ç°çš„å†…å®¹"></a>1.2.2ã€Android OpenMaxå®ç°çš„å†…å®¹</h6><p>   androidä¸­çš„ AwesomePlayerå°±æ˜¯ç”¨openmaxæ¥åš(Codec)ç¼–è§£ç ,å…¶å®åœ¨openmaxæ¥å£è®¾è®¡ä¸­ï¼Œä»–ä¸å…‰èƒ½ç”¨æ¥å½“ç¼–è§£ç ã€‚é€šè¿‡ä»–çš„ç»„ä»¶å¯ä»¥ç»„æˆä¸€ä¸ªå®Œæ•´çš„æ’­æ”¾å™¨ï¼ŒåŒ…æ‹¬sourcã€demuxã€decodeã€outputã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆandroidåªç”¨ä»–æ¥åšcodeå‘¢ï¼Ÿåº”è¯¥æœ‰å¦‚ä¸‹æ–¹é¢ï¼š</p><p>â˜¯    1.åœ¨æ•´ä¸ªæ’­æ”¾å™¨ä¸­ï¼Œè§£ç å™¨ä¸å¾—ä¸è¯´æ˜¯æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸”ä¹Ÿæ˜¯æœ€è€—èµ„æºçš„ä¸€å—ã€‚å¦‚æœå…¨é è½¯è§£ï¼Œç›´æ¥é€šè¿‡cpuæ¥è¿ç®—ï¼Œç‰¹åˆ«æ˜¯é«˜æ¸…è§†é¢‘ã€‚åˆ«çš„äº‹ä½ å°±å¯ä»¥å•¥éƒ½ä¸å¹²äº†ã€‚æ‰€ä»¥è§£ç å™¨æ˜¯æœ€éœ€è¦ç¡¬ä»¶æä¾›åŠ é€Ÿçš„éƒ¨åˆ†ã€‚ç°åœ¨çš„é«˜æ¸…è§£ç èŠ¯ç‰‡éƒ½æ˜¯ä¸»èŠ¯ç‰‡+DSPç»“æ„ï¼Œè§£ç çš„å·¥ä½œéƒ½æ˜¯é€šè¿‡DSPæ¥åšï¼Œä¸ä¼šåœ¨è¿‡å¤šçš„å ç”¨ä¸»èŠ¯ç‰‡ã€‚æ‰€æœ‰å°†èŠ¯ç‰‡ä¸­DSPç¡¬ä»¶ç¼–è§£ç çš„èƒ½åŠ›é€šè¿‡openmaxæ ‡å‡†æ¥å£å‘ˆç°å‡ºæ¥ï¼Œæä¾›ä¸Šå±‚æ’­æ”¾å™¨æ¥ç”¨ã€‚æˆ‘è®¤ä¸ºè¿™å—æ˜¯openmaxæœ€é‡è¦çš„æ„ä¹‰ã€‚<br>â˜¯    2.source ä¸»è¦æ˜¯å’Œåè®®æ‰“äº¤é“ï¼Œdemux åˆ†è§£å®¹å™¨éƒ¨åˆ†ï¼Œå¤§å¤šæ•°çš„å®¹å™¨æ ¼å¼çš„åˆ†è§£æ˜¯ä¸éœ€è¦é€šè¿‡ç¡¬ä»¶æ¥æ”¯æŒã€‚åªæ˜¯tsæµè¿™ç§æ ¼å¼æœ€å¯èƒ½ç”¨åˆ°ç¡¬ä»¶çš„æ”¯æŒã€‚å› ä¸ºtsæ ¼å¼æ¯”è¾ƒç‰¹æ®Šï¼Œå•åŒ…çš„å¤§å°å¤ªå°äº†ï¼Œåªæœ‰188å­—èŠ‚ã€‚æ‰€ä»¥ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç°åœ¨å¸¸è§çš„è§£ç èŠ¯ç‰‡éƒ½ä¼šæä¾›ç¡¬ä»¶ts demux çš„æ”¯æŒã€‚<br>â˜¯   3.éŸ³è§†é¢‘è¾“å‡ºéƒ¨åˆ†video\audio output è¿™å—å’Œæ“ä½œç³»ç»Ÿå…³ç³»ååˆ†ç´§å¯†ã€‚å¯ä»¥çœ‹çœ‹è‘—åå¼€æºæ’­æ”¾å™¨vlcã€‚vlc åœ¨macã€linuxã€Windowséƒ½æœ‰ï¼ŒåŠŸèƒ½ä¸Šå·®åˆ«ä¹Ÿä¸å¤§ã€‚æ‰€ä»¥è¯´ä»–æ˜¯è·¨å¹³å°çš„ï¼Œä»–è·¨å¹³å°è·¨åœ¨å“ªï¼Ÿä¸»è¦çš„å·¥ä½œé‡è¿˜æ˜¯åœ¨éŸ³è§†é¢‘è§£ç å®Œä¹‹åçš„è¾“å‡ºæ¨¡å—ã€‚å› ä¸ºå„ä¸ªç³»ç»Ÿçš„å›¾åƒæ¸²æŸ“å’ŒéŸ³é¢‘è¾“å‡ºå®ç°æ–¹æ³•ä¸åŒï¼Œæ‰€ä»¥vlcéœ€è¦é’ˆå¯¹æ¯ä¸ªå¹³å°å®ç°ä¸åŒçš„outputã€‚è¿™éƒ¨åˆ†å†…å®¹æ”¾åœ¨openmaxæ¥æ˜¾ç„¶ä¸åˆé€‚ã€‚<br>       Androidä¸­ä½¿ç”¨çš„ä¸»è¦æ˜¯OpenMaxçš„ç¼–è§£ç åŠŸèƒ½ã€‚è™½ç„¶OpenMaxä¹Ÿå¯ä»¥ç”Ÿæˆè¾“å…¥ã€è¾“å‡ºã€æ–‡ä»¶è§£æ-æ„å»ºç­‰ç»„ä»¶ï¼Œä½†æ˜¯åœ¨å„ä¸ªç³»ç»Ÿï¼ˆä¸ä»…æ˜¯Androidï¼‰ä¸­ä½¿ç”¨çš„æœ€å¤šçš„è¿˜æ˜¯ç¼–è§£ç ç»„ä»¶ã€‚åª’ä½“çš„è¾“å…¥ã€è¾“å‡ºç¯èŠ‚å’Œç³»ç»Ÿçš„å…³ç³»å¾ˆå¤§ï¼Œå¼•å…¥OpenMaxæ ‡å‡†æ¯”è¾ƒéº»çƒ¦ï¼›æ–‡ä»¶è§£æ-æ„å»ºç¯èŠ‚ä¸€èˆ¬ä¸éœ€è¦ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿã€‚ç¼–è§£ç ç»„ä»¶ä¹Ÿæ˜¯æœ€èƒ½ä½“ç°ç¡¬ä»¶åŠ é€Ÿçš„ç¯èŠ‚ï¼Œå› æ­¤æœ€å¸¸ä½¿ç”¨ã€‚</p><h5 id="1-3ã€åˆçª¥é€‚é…å±‚æ¥å£"><a href="#1-3ã€åˆçª¥é€‚é…å±‚æ¥å£" class="headerlink" title="1.3ã€åˆçª¥é€‚é…å±‚æ¥å£"></a>1.3ã€åˆçª¥é€‚é…å±‚æ¥å£</h5><p>åœ¨Androidä¸­å®ç°OpenMax ILå±‚å’Œæ ‡å‡†çš„OpenMax ILå±‚çš„æ–¹å¼åŸºæœ¬ï¼Œä¸€èˆ¬éœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªç¯èŠ‚ï¼š</p><p>â˜¯    ç¼–è§£ç é©±åŠ¨ç¨‹åºï¼šä½äºLinuxå†…æ ¸ç©ºé—´ï¼Œéœ€è¦é€šè¿‡Linuxå†…æ ¸è°ƒç”¨é©±åŠ¨ç¨‹åºï¼Œé€šå¸¸ä½¿ç”¨éæ ‡å‡†çš„é©±åŠ¨ç¨‹åºã€‚<br>â˜¯   OpenMax ILå±‚ï¼šæ ¹æ®OpenMax ILå±‚çš„æ ‡å‡†å¤´æ–‡ä»¶å®ç°ä¸åŒåŠŸèƒ½çš„ç»„ä»¶ã€‚<br> <strong>Androidä¸­è¿˜æä¾›äº†OpenMaxçš„é€‚é…å±‚æ¥å£ï¼ˆå¯¹OpenMax ILçš„æ ‡å‡†ç»„ä»¶è¿›è¡Œå°è£…é€‚é…ï¼‰</strong>ï¼Œå®ƒä½œä¸ºAndroidæœ¬åœ°å±‚çš„æ¥å£ï¼Œå¯ä»¥è¢«Androidçš„å¤šåª’ä½“å¼•æ“è°ƒç”¨ã€‚ä¸Šä¸€ç¯‡æ–‡ç« æœ«å°¾ï¼Œåˆå§‹åŒ–è§£ç å™¨æ ¸å¿ƒè°ƒç”¨çš„ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯é€‚é…å±‚çš„æ¥å£ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-07-openmaxsult.jpg" alt="Alt text | center"></p><p>â˜¯    1.ä¸Šé¢å·²ç»è¯´è¿‡äº†ï¼Œandroidç³»ç»Ÿä¸­åªç”¨openmaxæ¥åšCodecï¼Œæ‰€ä»¥androidå‘ä¸ŠæŠ½è±¡äº†ä¸€å±‚OMXCodecï¼Œæä¾›ç»™ä¸Šå±‚æ’­æ”¾å™¨ç”¨ã€‚æ’­æ”¾å™¨ä¸­éŸ³è§†é¢‘è§£ç å™¨mVideosourceã€mAudiosourceéƒ½æ˜¯OMXCodecçš„å®ä¾‹ã€‚<br>â˜¯    2.OMXCodecé€šè¿‡IOMX ä¾èµ–binderæœºåˆ¶ è·å¾— OMXæœåŠ¡ï¼ŒOMXæœåŠ¡ æ‰æ˜¯openmax åœ¨androidä¸­ å®ç°ã€‚<br>â˜¯    3.OMXæŠŠè½¯ç¼–è§£ç å’Œç¡¬ä»¶ç¼–è§£ç ç»Ÿä¸€çœ‹ä½œæ’ä»¶çš„å½¢å¼ç®¡ç†èµ·æ¥ã€‚</p><h4 id="ï¼ˆäºŒï¼‰ã€Androidä¸­OpenMaxçš„å®ç°-preview"><a href="#ï¼ˆäºŒï¼‰ã€Androidä¸­OpenMaxçš„å®ç°-preview" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Androidä¸­OpenMaxçš„å®ç°(preview)"></a>ï¼ˆäºŒï¼‰ã€Androidä¸­OpenMaxçš„å®ç°(preview)</h4><h5 id="2-1ã€OpenMaxçš„æ¥å£ä¸å®ç°"><a href="#2-1ã€OpenMaxçš„æ¥å£ä¸å®ç°" class="headerlink" title="2.1ã€OpenMaxçš„æ¥å£ä¸å®ç°"></a>2.1ã€OpenMaxçš„æ¥å£ä¸å®ç°</h5><p>åœ¨Androidä¸­å®ç°OpenMax ILå±‚å’Œæ ‡å‡†çš„OpenMax ILå±‚çš„æ–¹å¼åŸºæœ¬ï¼Œä¸€èˆ¬éœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªç¯èŠ‚ã€‚</p><p>ç¼–è§£ç é©±åŠ¨ç¨‹åºï¼šä½äºLinuxå†…æ ¸ç©ºé—´ï¼Œéœ€è¦é€šè¿‡Linuxå†…æ ¸è°ƒç”¨é©±åŠ¨ç¨‹åºï¼Œé€šå¸¸ä½¿ç”¨éæ ‡å‡†çš„é©±åŠ¨ç¨‹åºã€‚<br>OpenMax ILå±‚ï¼šæ ¹æ®OpenMax ILå±‚çš„æ ‡å‡†å¤´æ–‡ä»¶å®ç°ä¸åŒåŠŸèƒ½çš„ç»„ä»¶ã€‚<br>       Androidä¸­è¿˜æä¾›äº†OpenMaxçš„é€‚é…å±‚æ¥å£ï¼ˆå¯¹OpenMax ILçš„æ ‡å‡†ç»„ä»¶è¿›è¡Œå°è£…é€‚é…ï¼‰ï¼Œå®ƒä½œä¸ºAndroidæœ¬åœ°å±‚çš„æ¥å£ï¼Œå¯ä»¥è¢«Androidçš„å¤šåª’ä½“å¼•æ“è°ƒç”¨ã€‚</p><p>OpenMax ILå±‚æ¥å£<br>       OpenMax ILå±‚çš„æ¥å£å®šä¹‰ç”±è‹¥å¹²ä¸ªå¤´æ–‡ä»¶ç»„æˆï¼Œè¿™ä¹Ÿæ˜¯å®ç°å®ƒéœ€è¦å®ç°çš„å†…å®¹ï¼Œä½äºframeworks/native/include/media/openmaxä¸‹ï¼Œå®ƒä»¬çš„åŸºæœ¬æè¿°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p>OMX_Types.hï¼šOpenMax Ilçš„æ•°æ®ç±»å‹å®šä¹‰<br>OMX_Core.hï¼šOpenMax ILæ ¸å¿ƒçš„API<br>OMX_Component.hï¼šOpenMax IL ç»„ä»¶ç›¸å…³çš„ API<br>OMX_Audio.hï¼šéŸ³é¢‘ç›¸å…³çš„å¸¸é‡å’Œæ•°æ®ç»“æ„<br>OMX_IVCommon.hï¼šå›¾åƒå’Œè§†é¢‘å…¬å…±çš„å¸¸é‡å’Œæ•°æ®ç»“æ„<br>OMX_Image.hï¼šå›¾åƒç›¸å…³çš„å¸¸é‡å’Œæ•°æ®ç»“æ„<br>OMX_Video.hï¼šè§†é¢‘ç›¸å…³çš„å¸¸é‡å’Œæ•°æ®ç»“æ„<br>OMX_Other.hï¼šå…¶ä»–æ•°æ®ç»“æ„ï¼ˆåŒ…æ‹¬A/V åŒæ­¥ï¼‰<br>OMX_Index.hï¼šOpenMax ILå®šä¹‰çš„æ•°æ®ç»“æ„ç´¢å¼•<br>OMX_ContentPipe.hï¼šå†…å®¹çš„ç®¡é“å®šä¹‰</p></blockquote><p>   <strong>æç¤ºï¼šOpenMaxæ ‡å‡†åªæœ‰å¤´æ–‡ä»¶ï¼Œæ²¡æœ‰æ ‡å‡†çš„åº“ï¼Œè®¾ç½®æ²¡æœ‰å®šä¹‰å‡½æ•°æ¥å£ã€‚å¯¹äºå®ç°è€…ï¼Œéœ€è¦å®ç°çš„ä¸»è¦æ˜¯åŒ…å«å‡½æ•°æŒ‡é’ˆçš„ç»“æ„ä½“ã€‚</strong></p><p>å…¶ä¸­ï¼ŒOMX_Component.hä¸­å®šä¹‰çš„OMX_COMPONENTTYPEç»“æ„ä½“æ˜¯OpenMax ILå±‚çš„æ ¸å¿ƒå†…å®¹ï¼Œè¡¨ç¤ºä¸€ä¸ªç»„ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/include/media/openmax/OMX_Component.h]</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">OMX_COMPONENTTYPE</span>    </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">    OMX_U32 nSize;                          <span class="comment">/* è¿™ä¸ªç»“æ„ä½“çš„å¤§å° */</span>    </span><br><span class="line">    OMX_VERSIONTYPE nVersion;           <span class="comment">/* ç‰ˆæœ¬å· */</span>    </span><br><span class="line">    OMX_PTR pComponentPrivate;          <span class="comment">/* è¿™ä¸ªç»„ä»¶çš„ç§æœ‰æ•°æ®æŒ‡é’ˆ. */</span>    </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* è°ƒç”¨è€…ï¼ˆIL clientï¼‰è®¾ç½®çš„æŒ‡é’ˆï¼Œç”¨äºä¿å­˜å®ƒçš„ç§æœ‰æ•°æ®ï¼Œä¼ å›ç»™æ‰€æœ‰çš„å›è°ƒå‡½æ•° */</span>    </span><br><span class="line">    OMX_PTR pApplicationPrivate;    </span><br><span class="line">    <span class="comment">/* ä»¥ä¸‹çš„å‡½æ•°æŒ‡é’ˆè¿”å›OMX_core.hä¸­çš„å¯¹åº”å†…å®¹ */</span>    </span><br><span class="line">    OMX_ERRORTYPE (*GetComponentVersion)(<span class="comment">/* è·å¾—ç»„ä»¶çš„ç‰ˆæœ¬*/</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_OUT OMX_STRING pComponentName,    </span><br><span class="line">        OMX_OUT OMX_VERSIONTYPE* pComponentVersion,    </span><br><span class="line">        OMX_OUT OMX_VERSIONTYPE* pSpecVersion,    </span><br><span class="line">        OMX_OUT OMX_UUIDTYPE* pComponentUUID);    </span><br><span class="line">    OMX_ERRORTYPE (*SendCommand)(<span class="comment">/* å‘é€å‘½ä»¤ */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_COMMANDTYPE Cmd,    </span><br><span class="line">        OMX_IN  OMX_U32 nParam1,    </span><br><span class="line">        OMX_IN  OMX_PTR pCmdData);    </span><br><span class="line">    OMX_ERRORTYPE (*GetParameter)(<span class="comment">/* è·å¾—å‚æ•° */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_INDEXTYPE nParamIndex,    </span><br><span class="line">        OMX_INOUT OMX_PTR pComponentParameterStructure);    </span><br><span class="line">    OMX_ERRORTYPE (*SetParameter)(<span class="comment">/* è®¾ç½®å‚æ•° */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_INDEXTYPE nIndex,    </span><br><span class="line">        OMX_IN  OMX_PTR pComponentParameterStructure);    </span><br><span class="line">    OMX_ERRORTYPE (*GetConfig)(<span class="comment">/* è·å¾—é…ç½® */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_INDEXTYPE nIndex,    </span><br><span class="line">        OMX_INOUT OMX_PTR pComponentConfigStructure);    </span><br><span class="line">    OMX_ERRORTYPE (*SetConfig)(<span class="comment">/* è®¾ç½®é…ç½® */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_INDEXTYPE nIndex,    </span><br><span class="line">        OMX_IN  OMX_PTR pComponentConfigStructure);    </span><br><span class="line">    OMX_ERRORTYPE (*GetExtensionIndex)(<span class="comment">/* è½¬æ¢æˆOMXç»“æ„çš„ç´¢å¼• */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_STRING cParameterName,    </span><br><span class="line">        OMX_OUT OMX_INDEXTYPE* pIndexType);    </span><br><span class="line">    OMX_ERRORTYPE (*GetState)(<span class="comment">/* è·å¾—ç»„ä»¶å½“å‰çš„çŠ¶æ€ */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_OUT OMX_STATETYPE* pState);    </span><br><span class="line">    OMX_ERRORTYPE (*ComponentTunnelRequest)(<span class="comment">/* ç”¨äºè¿æ¥åˆ°å¦ä¸€ä¸ªç»„ä»¶*/</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComp,    </span><br><span class="line">        OMX_IN  OMX_U32 nPort,    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hTunneledComp,    </span><br><span class="line">        OMX_IN  OMX_U32 nTunneledPort,    </span><br><span class="line">        OMX_INOUT  OMX_TUNNELSETUPTYPE* pTunnelSetup);    </span><br><span class="line">    OMX_ERRORTYPE (*UseBuffer)(<span class="comment">/* ä¸ºæŸä¸ªç«¯å£ä½¿ç”¨Buffer */</span>    </span><br><span class="line">        OMX_IN OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_INOUT OMX_BUFFERHEADERTYPE** ppBufferHdr,    </span><br><span class="line">        OMX_IN OMX_U32 nPortIndex,    </span><br><span class="line">        OMX_IN OMX_PTR pAppPrivate,    </span><br><span class="line">        OMX_IN OMX_U32 nSizeBytes,    </span><br><span class="line">        OMX_IN OMX_U8* pBuffer);    </span><br><span class="line">    OMX_ERRORTYPE (*AllocateBuffer)(<span class="comment">/* åœ¨æŸä¸ªç«¯å£åˆ†é…Buffer */</span>    </span><br><span class="line">        OMX_IN OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_INOUT OMX_BUFFERHEADERTYPE** ppBuffer,    </span><br><span class="line">        OMX_IN OMX_U32 nPortIndex,    </span><br><span class="line">        OMX_IN OMX_PTR pAppPrivate,    </span><br><span class="line">        OMX_IN OMX_U32 nSizeBytes);    </span><br><span class="line">    OMX_ERRORTYPE (*FreeBuffer)(<span class="comment">/*å°†æŸä¸ªç«¯å£Bufferé‡Šæ”¾*/</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_U32 nPortIndex,    </span><br><span class="line">        OMX_IN  OMX_BUFFERHEADERTYPE* pBuffer);    </span><br><span class="line">    OMX_ERRORTYPE (*EmptyThisBuffer)(<span class="comment">/* è®©ç»„ä»¶æ¶ˆè€—è¿™ä¸ªBuffer */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_BUFFERHEADERTYPE* pBuffer);    </span><br><span class="line">    OMX_ERRORTYPE (*FillThisBuffer)(<span class="comment">/* è®©ç»„ä»¶å¡«å……è¿™ä¸ªBuffer */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_BUFFERHEADERTYPE* pBuffer);    </span><br><span class="line">    OMX_ERRORTYPE (*SetCallbacks)(<span class="comment">/* è®¾ç½®å›è°ƒå‡½æ•° */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_IN  OMX_CALLBACKTYPE* pCallbacks,    </span><br><span class="line">        OMX_IN  OMX_PTR pAppData);    </span><br><span class="line">    OMX_ERRORTYPE (*ComponentDeInit)(<span class="comment">/* ååˆå§‹åŒ–ç»„ä»¶ */</span>    </span><br><span class="line">        OMX_IN  OMX_HANDLETYPE hComponent);    </span><br><span class="line">    OMX_ERRORTYPE (*UseEGLImage)(    </span><br><span class="line">        OMX_IN OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_INOUT OMX_BUFFERHEADERTYPE** ppBufferHdr,    </span><br><span class="line">        OMX_IN OMX_U32 nPortIndex,    </span><br><span class="line">        OMX_IN OMX_PTR pAppPrivate,    </span><br><span class="line">        OMX_IN <span class="keyword">void</span>* eglImage);    </span><br><span class="line">    OMX_ERRORTYPE (*ComponentRoleEnum)(    </span><br><span class="line">        OMX_IN OMX_HANDLETYPE hComponent,    </span><br><span class="line">        OMX_OUT OMX_U8 *cRole,    </span><br><span class="line">        OMX_IN OMX_U32 nIndex);    </span><br><span class="line">&#125; OMX_COMPONENTTYPE;</span><br></pre></td></tr></table></figure><p>â˜¯    1ï¼‰EmptyThisBufferå’ŒFillThisBufferæ˜¯é©±åŠ¨ç»„ä»¶è¿è¡Œçš„åŸºæœ¬çš„æœºåˆ¶ï¼Œå‰è€…è¡¨ç¤ºè®©ç»„ä»¶æ¶ˆè€—ç¼“å†²åŒºï¼Œè¡¨ç¤ºå¯¹åº”ç»„ä»¶è¾“å…¥çš„å†…å®¹ï¼›åè€…è¡¨ç¤ºè®©ç»„ä»¶å¡«å……ç¼“å†²åŒºï¼Œè¡¨ç¤ºå¯¹åº”ç»„ä»¶è¾“å‡ºçš„å†…å®¹ã€‚<br>â˜¯    2ï¼‰UseBufferï¼ŒAllocateBufferï¼ŒFreeBufferä¸ºå’Œç«¯å£ç›¸å…³çš„ç¼“å†²åŒºç®¡ç†å‡½æ•°ï¼Œå¯¹äºç»„ä»¶çš„ç«¯å£æœ‰äº›å¯ä»¥è‡ªå·±åˆ†é…ç¼“å†²åŒºï¼Œæœ‰äº›å¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ç¼“å†²åŒºï¼Œå› æ­¤æœ‰ä¸åŒçš„æ¥å£å¯¹å…¶è¿›è¡Œæ“ä½œã€‚<br>â˜¯    3ï¼‰SendCommandè¡¨ç¤ºå‘ç»„ä»¶å‘é€æ§åˆ¶ç±»çš„å‘½ä»¤ã€‚GetParameterï¼ŒSetParameterï¼ŒGetConfigï¼ŒSetConfigå‡ ä¸ªæ¥å£ç”¨äºè¾…åŠ©çš„å‚æ•°å’Œé…ç½®çš„è®¾ç½®å’Œè·å–ã€‚<br>â˜¯     4ï¼‰ComponentTunnelRequestç”¨äºç»„ä»¶ä¹‹é—´çš„éš§é“åŒ–è¿æ¥ï¼Œå…¶ä¸­éœ€è¦åˆ¶å®šä¸¤ä¸ªç»„ä»¶åŠå…¶ç›¸è¿çš„ç«¯å£ã€‚<br>â˜¯     5ï¼‰ComponentDeInitç”¨äºç»„ä»¶çš„ååˆå§‹åŒ–ã€‚</p><p>OMX_COMPONENTTYPEç»“æ„ä½“å®ç°åï¼Œå…¶ä¸­çš„å„ä¸ªå‡½æ•°æŒ‡é’ˆå°±æ˜¯è°ƒç”¨è€…å¯ä»¥ä½¿ç”¨çš„å†…å®¹ã€‚å„ä¸ªå‡½æ•°æŒ‡é’ˆå’ŒOMX_core.hä¸­å®šä¹‰çš„å†…å®¹ç›¸å¯¹åº”ã€‚</p><p>æç¤ºï¼šOpenMaxå‡½æ•°çš„å‚æ•°ä¸­ï¼Œç»å¸¸åŒ…å«OMX_INå’ŒOMX_OUTç­‰å®ï¼Œå®ƒä»¬çš„å®é™…å†…å®¹ä¸ºç©ºï¼Œåªæ˜¯ä¸ºäº†æ ‡è®°å‚æ•°çš„æ–¹å‘æ˜¯è¾“å…¥è¿˜æ˜¯è¾“å‡ºã€‚</p><p>OMX_Component.hä¸­ç«¯å£ç±»å‹çš„å®šä¹‰ä¸ºOMX_PORTDOMAINTYPEæšä¸¾ç±»å‹ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> OMX_PORTDOMAINTYPE &#123;   </span><br><span class="line">    OMX_PortDomainAudio,        <span class="comment">/* éŸ³é¢‘ç±»å‹ç«¯å£ */</span>   </span><br><span class="line">    OMX_PortDomainVideo,        <span class="comment">/* è§†é¢‘ç±»å‹ç«¯å£ */</span>   </span><br><span class="line">    OMX_PortDomainImage,        <span class="comment">/* å›¾åƒç±»å‹ç«¯å£ */</span>   </span><br><span class="line">    OMX_PortDomainOther,        <span class="comment">/* å…¶ä»–ç±»å‹ç«¯å£ */</span>   </span><br><span class="line">    OMX_PortDomainKhronosExtensions = <span class="number">0x6F000000</span>,   <span class="comment">//ä¸ºKhronosæ ‡å‡†é¢„ç•™å®½å±•</span></span><br><span class="line">    OMX_PortDomainVendorStartUnused = <span class="number">0x7F000000</span>    <span class="comment">//ä¸ºå‚å•†é¢„ç•™æ‰©å±•</span></span><br><span class="line">    OMX_PortDomainMax = <span class="number">0x7ffffff</span>  </span><br><span class="line">&#125; OMX_PORTDOMAINTY</span><br></pre></td></tr></table></figure><p>éŸ³é¢‘ç±»å‹ï¼Œè§†é¢‘ç±»å‹ï¼Œå›¾åƒç±»å‹ï¼Œå…¶ä»–ç±»å‹æ˜¯OpenMax ILå±‚æ­¤æ‰€å®šä¹‰çš„å››ç§ç«¯å£çš„ç±»å‹ã€‚</p><p>ç«¯å£å…·ä½“å†…å®¹çš„å®šä¹‰ä½¿ç”¨OMX_PARAM_PORTDEFINITIONTYPEç±»ï¼ˆä¹Ÿåœ¨OMX_Component.hä¸­å®šä¹‰ï¼‰æ¥è¡¨ç¤ºï¼Œå…¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">OMX_PARAM_PORTDEFINITIONTYPE</span> &#123;</span>   </span><br><span class="line">    OMX_U32 nSize;                      <span class="comment">/* ç»“æ„ä½“å¤§å° */</span>   </span><br><span class="line">    OMX_VERSIONTYPE nVersion;           <span class="comment">/* ç‰ˆæœ¬*/</span>   </span><br><span class="line">    OMX_U32 nPortIndex;             <span class="comment">/* ç«¯å£å· */</span>   </span><br><span class="line">    OMX_DIRTYPE eDir;                   <span class="comment">/* ç«¯å£çš„æ–¹å‘ */</span>   </span><br><span class="line">    OMX_U32 nBufferCountActual;         <span class="comment">/* ä¸ºè¿™ä¸ªç«¯å£å®é™…åˆ†é…çš„Bufferçš„æ•°ç›® */</span>   </span><br><span class="line">    OMX_U32 nBufferCountMin;            <span class="comment">/* è¿™ä¸ªç«¯å£æœ€å°Bufferçš„æ•°ç›®*/</span>   </span><br><span class="line">    OMX_U32 nBufferSize;                <span class="comment">/* ç¼“å†²åŒºçš„å­—èŠ‚æ•° */</span>   </span><br><span class="line">    OMX_BOOL bEnabled;                  <span class="comment">/* æ˜¯å¦ä½¿èƒ½ */</span>   </span><br><span class="line">    OMX_BOOL bPopulated;                <span class="comment">/* æ˜¯å¦åœ¨å¡«å…… */</span>   </span><br><span class="line">    OMX_PORTDOMAINTYPE eDomain;         <span class="comment">/* ç«¯å£çš„ç±»å‹ */</span>   </span><br><span class="line">    <span class="keyword">union</span> &#123;                         <span class="comment">/* ç«¯å£å®é™…çš„å†…å®¹ï¼Œç”±ç±»å‹ç¡®å®šå…·ä½“ç»“æ„ */</span>   </span><br><span class="line">        OMX_AUDIO_PORTDEFINITIONTYPE audio;   </span><br><span class="line">        OMX_VIDEO_PORTDEFINITIONTYPE video;   </span><br><span class="line">        OMX_IMAGE_PORTDEFINITIONTYPE image;   </span><br><span class="line">        OMX_OTHER_PORTDEFINITIONTYPE other;   </span><br><span class="line">    &#125; format;   </span><br><span class="line">    OMX_BOOL bBuffersContiguous;   </span><br><span class="line">    OMX_U32 nBufferAlignment;   </span><br><span class="line">&#125; OMX_PARAM_PORTDEFINITIONTYPE;</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸€ä¸ªç«¯å£ï¼Œå…¶é‡ç‚¹çš„å†…å®¹å¦‚ä¸‹:</p><p>â˜¯    ç«¯å£çš„æ–¹å‘ï¼ˆOMX_DIRTYPEï¼‰ï¼šåŒ…å«OMX_DirInputï¼ˆè¾“å…¥ï¼‰å’ŒOMX_DirOutputï¼ˆè¾“å‡ºï¼‰ä¸¤ç§<br>â˜¯    ç«¯å£åˆ†é…çš„ç¼“å†²åŒºæ•°ç›®å’Œæœ€å°ç¼“å†²åŒºæ•°ç›®<br>â˜¯    ç«¯å£çš„ç±»å‹ï¼ˆOMX_PORTDOMAINTYPEï¼‰ï¼šå¯ä»¥æ˜¯å››ç§ç±»å‹<br>â˜¯    ç«¯å£æ ¼å¼çš„æ•°æ®ç»“æ„ï¼šä½¿ç”¨formatè”åˆä½“æ¥è¡¨ç¤ºï¼Œå…·ä½“ç”±å››ç§ä¸åŒç±»å‹æ¥è¡¨ç¤ºï¼Œä¸ç«¯å£çš„ç±»å‹ç›¸å¯¹åº”<br>â˜¯    OMX_AUDIO_PORTDEFINITIONTYPEï¼ŒOMX_VIDEO_PORTDEFINITIONTYPEï¼ŒOMX_IMAGE_PORTDEFINITIONTYPEå’ŒOMX_OTHER_PORTDEFINITIONTYPEç­‰å‡ ä¸ªå…·ä½“çš„æ ¼å¼ç±»å‹ï¼Œåˆ†åˆ«åœ¨OMX_Audio.hï¼ŒOMX_Video.hï¼ŒOMX_Image.hå’ŒOMX_Other.hè¿™å››ä¸ªå¤´æ–‡ä»¶ä¸­å®šä¹‰ã€‚<br>       OMX_Core.hä¸­å®šä¹‰çš„æšä¸¾ç±»å‹OMX_STATETYPEå‘½ä»¤è¡¨ç¤ºOpenMaxçš„çŠ¶æ€æœºï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> OMX_STATETYPE   </span><br><span class="line">&#123;   </span><br><span class="line">    OMX_StateInvalid,                   <span class="comment">/* ç»„ä»¶ç›‘æµ‹åˆ°å†…éƒ¨çš„æ•°æ®ç»“æ„è¢«ç ´å */</span>   </span><br><span class="line">    OMX_StateLoaded,                    <span class="comment">/* ç»„ä»¶è¢«åŠ è½½ä½†æ˜¯æ²¡æœ‰å®Œæˆåˆå§‹åŒ– */</span>   </span><br><span class="line">    OMX_StateIdle,                      <span class="comment">/* ç»„ä»¶åˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡å¼€å§‹ */</span>   </span><br><span class="line">    OMX_StateExecuting,             <span class="comment">/* ç»„ä»¶æ¥å—äº†å¼€å§‹å‘½ä»¤ï¼Œæ­£åœ¨æ ‘ç«‹æ•°æ® */</span>   </span><br><span class="line">    OMX_StatePause,                     <span class="comment">/* ç»„ä»¶æ¥å—æš‚åœå‘½ä»¤*/</span>   </span><br><span class="line">    OMX_StateWaitForResources,      <span class="comment">/* ç»„ä»¶æ­£åœ¨ç­‰å¾…èµ„æº */</span>   </span><br><span class="line">    OMX_StateKhronosExtensions = <span class="number">0x6F000000</span>, <span class="comment">/* ä¿ç•™for Khronos */</span>   </span><br><span class="line">    OMX_StateVendorStartUnused = <span class="number">0x7F000000</span>, <span class="comment">/* ä¿ç•™forå‚å•† */</span>   </span><br><span class="line">    OMX_StateMax = <span class="number">0X7FFFFFFF</span>  </span><br><span class="line">&#125; OMX_STATETYPE;</span><br></pre></td></tr></table></figure><p>OpenMaxç»„ä»¶çš„çŠ¶æ€æœºå¯ä»¥ç”±å¤–éƒ¨çš„å‘½ä»¤æ”¹å˜ï¼Œä¹Ÿå¯ä»¥ç”±å†…éƒ¨å‘ç”Ÿçš„æƒ…å†µæ”¹å˜ã€‚OpenMax ILç»„ä»¶çš„çŠ¶æ€æœºçš„è¿ç§»å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-08-OMXstate.png" alt="Alt text | center"></p><p> OMX_Core.hä¸­å®šä¹‰çš„æšä¸¾ç±»å‹OMX_COMMANDTYPEè¡¨ç¤ºå¯¹ç»„ä»¶çš„å‘½ä»¤ç±»å‹ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> OMX_COMMANDTYPE   </span><br><span class="line">&#123;   </span><br><span class="line">    OMX_CommandStateSet,                <span class="comment">/* æ”¹å˜çŠ¶æ€æœºå™¨ */</span>   </span><br><span class="line">    OMX_CommandFlush,                   <span class="comment">/* åˆ·æ–°æ•°æ®é˜Ÿåˆ— */</span>   </span><br><span class="line">    OMX_CommandPortDisable,             <span class="comment">/* ç¦æ­¢ç«¯å£ */</span>   </span><br><span class="line">    OMX_CommandPortEnable,              <span class="comment">/* ä½¿èƒ½ç«¯å£ */</span>   </span><br><span class="line">    OMX_CommandMarkBuffer,              <span class="comment">/* æ ‡è®°ç»„ä»¶æˆ–Bufferç”¨äºè§‚å¯Ÿ */</span>   </span><br><span class="line">    OMX_CommandKhronosExtensions = <span class="number">0x6F000000</span>, <span class="comment">/* ä¿ç•™for Khronos */</span>   </span><br><span class="line">    OMX_CommandVendorStartUnused = <span class="number">0x7F000000</span>, <span class="comment">/* ä¿ç•™forå‚å•† */</span>   </span><br><span class="line">    OMX_CommandMax = <span class="number">0X7FFFFFFF</span>  </span><br><span class="line">&#125; OMX_COMMANDTYPE;</span><br></pre></td></tr></table></figure><p>OMX_COMMANDTYPEç±»å‹åœ¨SendCommandè°ƒç”¨ä¸­ä½œä¸ºå‚æ•°è¢«ä½¿ç”¨ï¼Œå…¶ä¸­OMX_CommandStateSetå°±æ˜¯æ”¹å˜çŠ¶æ€æœºçš„å‘½ä»¤ã€‚</p><h6 id="2-1-2ã€OpenMax-ILå®ç°çš„å†…å®¹"><a href="#2-1-2ã€OpenMax-ILå®ç°çš„å†…å®¹" class="headerlink" title="2.1.2ã€OpenMax ILå®ç°çš„å†…å®¹"></a>2.1.2ã€OpenMax ILå®ç°çš„å†…å®¹</h6><p>  å¯¹äºOpenMax ILå±‚çš„å®ç°ï¼Œä¸€èˆ¬çš„æ–¹å¼å¹¶ä¸è°ƒç”¨OpenMax DLå±‚ã€‚å…·ä½“å®ç°çš„å†…å®¹å°±æ˜¯å„ä¸ªä¸åŒçš„ç»„ä»¶ã€‚<br>       OpenMax ILç»„ä»¶çš„å®ç°åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p><p>â˜¯    ç»„ä»¶çš„åˆå§‹åŒ–å‡½æ•°ï¼šç¡¬ä»¶å’ŒOpenMaxæ•°æ®ç»“æ„çš„åˆå§‹åŒ–ï¼Œä¸€èˆ¬åˆ†æˆå‡½æ•°æŒ‡é’ˆåˆå§‹åŒ–ã€ç§æœ‰æ•°æ®ç»“æ„çš„åˆå§‹åŒ–ã€ç«¯å£çš„åˆå§‹åŒ–ç­‰å‡ ä¸ªæ­¥éª¤ï¼Œä½¿ç”¨OMX_Component.hå…¶ä¸­çš„pComponentPrivateæˆå‘˜ä¿ç•™æœ¬ç»„ä»¶çš„ç§æœ‰æ•°æ®ä¸ºä¸Šä¸‹æ–‡ï¼Œæœ€åè·å¾—å¡«å……å®ŒæˆOMX_COMPONENTTYPEç±»å‹çš„ç»“æ„ä½“ã€‚<br>â˜¯    OMX_COMPONENTTYPEç±»å‹ç»“æ„ä½“çš„å„ä¸ªæŒ‡é’ˆï¼šå®ç°å…¶ä¸­çš„å„ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œéœ€è¦ä½¿ç”¨ç§æœ‰æ•°æ®çš„æ—¶å€™ï¼Œä»å…¶ä¸­çš„pComponentPrivateå¾—åˆ°æŒ‡é’ˆï¼Œè½¬åŒ–æˆå®é™…çš„æ•°æ®ç»“æ„ä½¿ç”¨ã€‚</p><p>ç«¯å£çš„å®šä¹‰æ˜¯OpenMax ILç»„ä»¶å¯¹å¤–éƒ¨çš„æ¥å£ã€‚OpenMax ILå¸¸ç”¨çš„ç»„ä»¶å¤§éƒ½æ˜¯è¾“å…¥å’Œè¾“å‡ºç«¯å£å„ä¸€ä¸ªã€‚å¯¹äºæœ€å¸¸ç”¨çš„ç¼–è§£ç ï¼ˆCodecï¼‰ç»„ä»¶ï¼Œé€šå¸¸éœ€è¦åœ¨æ¯ä¸ªç»„ä»¶çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ç¡¬ä»¶çš„ç¼–è§£ç æ¥å£æ¥å®ç°ã€‚åœ¨ç»„ä»¶çš„å†…éƒ¨å¤„ç†ä¸­ï¼Œå¯ä»¥å»ºç«‹çº¿ç¨‹æ¥å¤„ç†ã€‚OpenMaxçš„ç»„ä»¶çš„ç«¯å£æœ‰é»˜è®¤å‚æ•°ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶è®¾ç½®ï¼Œå› æ­¤ä¸€ä¸ªç«¯å£ä¹Ÿå¯ä»¥æ”¯æŒä¸åŒçš„ç¼–ç æ ¼å¼ã€‚éŸ³é¢‘ç¼–ç ç»„ä»¶çš„è¾“å‡ºå’ŒéŸ³é¢‘ç¼–ç ç»„ä»¶çš„è¾“å…¥é€šå¸¸æ˜¯åŸå§‹æ•°æ®æ ¼å¼ï¼ˆPCMæ ¼å¼ï¼‰ï¼Œè§†é¢‘ç¼–ç ç»„ä»¶çš„è¾“å‡ºå’Œè§†é¢‘ç¼–ç ç»„ä»¶çš„è¾“å…¥é€šå¸¸æ˜¯åŸå§‹æ•°æ®æ ¼å¼ï¼ˆYUVæ ¼å¼ï¼‰ã€‚<br>       æç¤ºï¼šåœ¨ä¸€ç§ç‰¹å®šçš„ç¡¬ä»¶å®ç°ä¸­ï¼Œç¼–è§£ç éƒ¨åˆ†å…·æœ‰ç›¸ä¼¼æ€§ï¼Œå› æ­¤é€šå¸¸å¯ä»¥æ„å»ºä¸€ä¸ªOpenMaxç»„ä»¶çš„â€åŸºç±»â€æˆ–è€…å…¬å…±å‡½æ•°ï¼Œæ¥å®Œæˆå…¬å…±æ€§çš„æ“ä½œã€‚</p><h5 id="2-2ã€Androidä¸­OpenMaxçš„é€‚é…å±‚"><a href="#2-2ã€Androidä¸­OpenMaxçš„é€‚é…å±‚" class="headerlink" title="2.2ã€Androidä¸­OpenMaxçš„é€‚é…å±‚"></a>2.2ã€Androidä¸­OpenMaxçš„é€‚é…å±‚</h5><p>  Androidä¸­çš„OpenMaxé€‚é…å±‚çš„æ¥å£åœ¨frameworks/av/include/media/IOMX.hæ–‡ä»¶å®šä¹‰ï¼Œå…¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IOMX</span> :</span> <span class="keyword">public</span> IInterface &#123;    </span><br><span class="line"><span class="keyword">public</span>:    </span><br><span class="line">    DECLARE_META_INTERFACE(OMX);    </span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">void</span> *buffer_id;    </span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">void</span> *node_id;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">livesLocally</span><span class="params">(<span class="keyword">pid_t</span> pid)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ComponentInfo</span> &#123;</span><span class="comment">// ç»„ä»¶çš„ä¿¡æ¯    </span></span><br><span class="line">        String8 mName;    </span><br><span class="line">        List&lt;String8&gt; mRoles;    </span><br><span class="line">    &#125;;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">listNodes</span><span class="params">(List&lt;ComponentInfo&gt; *<span class="built_in">list</span>)</span> </span>= <span class="number">0</span>;  <span class="comment">// èŠ‚ç‚¹åˆ—è¡¨    </span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">allocateNode</span><span class="params">(    </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> sp&lt;IOMXObserver&gt; &amp;observer,  <span class="comment">// åˆ†é…èŠ‚ç‚¹    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id *node)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">freeNode</span><span class="params">(node_id node)</span> </span>= <span class="number">0</span>; <span class="comment">// æ‰¾åˆ°èŠ‚ç‚¹    </span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">sendCommand</span><span class="params">(<span class="comment">// å‘é€å‘½ä»¤    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_COMMANDTYPE cmd, OMX_S32 param)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">getParameter</span><span class="params">(<span class="comment">// è·å¾—å‚æ•°    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_INDEXTYPE index,    </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">void</span> *params, <span class="keyword">size_t</span> size)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">setParameter</span><span class="params">(<span class="comment">// è®¾ç½®å‚æ•°    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_INDEXTYPE index,    </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">void</span> *params, <span class="keyword">size_t</span> size)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">getConfig</span><span class="params">(<span class="comment">// è·å¾—é…ç½®    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_INDEXTYPE index,    </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">void</span> *params, <span class="keyword">size_t</span> size)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">setConfig</span><span class="params">(<span class="comment">// è®¾ç½®é…ç½®    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_INDEXTYPE index,    </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">void</span> *params, <span class="keyword">size_t</span> size)</span> </span>= <span class="number">0</span>;   </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">useBuffer</span><span class="params">(<span class="comment">// ä½¿ç”¨ç¼“å†²åŒº    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_U32 port_index, <span class="keyword">const</span> sp&lt;IMemory&gt; Â¶ms,    </span></span></span><br><span class="line"><span class="function"><span class="params">        buffer_id *buffer)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">allocateBuffer</span><span class="params">(<span class="comment">// åˆ†é…ç¼“å†²åŒº    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_U32 port_index, <span class="keyword">size_t</span> size,    </span></span></span><br><span class="line"><span class="function"><span class="params">        buffer_id *buffer, <span class="keyword">void</span> **buffer_data)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">allocateBufferWithBackup</span><span class="params">(<span class="comment">// åˆ†é…å¸¦åå¤‡ç¼“å†²åŒº    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_U32 port_index, <span class="keyword">const</span> sp&lt;IMemory&gt; Â¶ms,    </span></span></span><br><span class="line"><span class="function"><span class="params">        buffer_id *buffer)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">freeBuffer</span><span class="params">(<span class="comment">// é‡Šæ”¾ç¼“å†²åŒº    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node, OMX_U32 port_index, buffer_id buffer)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">fillBuffer</span><span class="params">(node_id node, buffer_id buffer)</span> </span>= <span class="number">0</span>; <span class="comment">// å¡«å……ç¼“å†²åŒº    </span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">emptyBuffer</span><span class="params">(<span class="comment">// æ¶ˆè€—ç¼“å†²åŒº    </span></span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node,    </span></span></span><br><span class="line"><span class="function"><span class="params">        buffer_id buffer,    </span></span></span><br><span class="line"><span class="function"><span class="params">        OMX_U32 range_offset, OMX_U32 range_length,    </span></span></span><br><span class="line"><span class="function"><span class="params">        OMX_U32 flags, OMX_TICKS timestamp)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">getExtensionIndex</span><span class="params">(    </span></span></span><br><span class="line"><span class="function"><span class="params">        node_id node,    </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">char</span> *parameter_name,    </span></span></span><br><span class="line"><span class="function"><span class="params">        OMX_INDEXTYPE *index)</span> </span>= <span class="number">0</span>;    </span><br><span class="line">    <span class="keyword">virtual</span> sp&lt;IOMXRenderer&gt; createRenderer(<span class="comment">// åˆ›å»ºæ¸²æŸ“å™¨ï¼ˆä»ISurfaceï¼‰    </span></span><br><span class="line">        <span class="keyword">const</span> sp&lt;ISurface&gt; &amp;surface,    </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *componentName,    </span><br><span class="line">        OMX_COLOR_FORMATTYPE colorFormat,    </span><br><span class="line">        <span class="keyword">size_t</span> encodedWidth, <span class="keyword">size_t</span> encodedHeight,    </span><br><span class="line">        <span class="keyword">size_t</span> displayWidth, <span class="keyword">size_t</span> displayHeight) = <span class="number">0</span>;    </span><br><span class="line">    </span><br><span class="line">    ......   </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p> IOMXè¡¨ç¤ºçš„æ˜¯OpenMaxçš„ä¸€ä¸ªç»„ä»¶ï¼Œæ ¹æ®Androidçš„Binder IPCæœºåˆ¶ï¼ŒBnOMXç»§æ‰¿IOMXï¼Œå®ç°è€…éœ€è¦ç»§æ‰¿å®ç°BnOMXã€‚IOMXç±»ä¸­ï¼Œæœ‰æ ‡å‡†çš„OpenMaxçš„GetParameterï¼ŒSetParameterï¼ŒGetConfigï¼ŒSetConfigï¼ŒSendCommandï¼ŒUseBufferï¼ŒAllocateBufferï¼ŒFreeBufferï¼ŒFillThisBufferå’ŒEmptyThisBufferç­‰æ¥å£ã€‚<br>       åœ¨IOMX.hæ–‡ä»¶ä¸­ï¼Œå¦æœ‰è¡¨ç¤ºè§‚å¯Ÿå™¨ç±»çš„IOMXObserverï¼Œè¿™ä¸ªç±»è¡¨ç¤ºOpenMaxçš„è§‚å¯Ÿè€…ï¼Œå…¶ä¸­åªåŒ…å«ä¸€ä¸ªonMessage()å‡½æ•°ï¼Œå…¶å‚æ•°ä¸ºomx_messageæ¥å£ä½“ï¼Œå…¶ä¸­åŒ…å«Eventäº‹ä»¶ç±»å‹ã€FillThisBufferå®Œæˆå’ŒEmptyThisBufferå®Œæˆå‡ ç§ç±»å‹ã€‚<br>       æç¤ºï¼šAndroidä¸­OpenMaxçš„é€‚é…å±‚æ˜¯OpenMAX ILå±‚è‡³ä¸Šçš„å°è£…å±‚ï¼Œåœ¨Androidç³»ç»Ÿä¸­è¢«StageFrightè°ƒç”¨ï¼Œä¹Ÿå¯ä»¥è¢«å…¶ä»–éƒ¨åˆ†è°ƒç”¨ã€‚</p><h4 id="2-3ã€TI-Texas-Instruments-å¾·å·ä»ªå™¨-OpenMax-ILçš„ç¡¬ä»¶å®ç°"><a href="#2-3ã€TI-Texas-Instruments-å¾·å·ä»ªå™¨-OpenMax-ILçš„ç¡¬ä»¶å®ç°" class="headerlink" title="2.3ã€TI(Texas Instruments å¾·å·ä»ªå™¨) OpenMax ILçš„ç¡¬ä»¶å®ç°"></a>2.3ã€TI(Texas Instruments å¾·å·ä»ªå™¨) OpenMax ILçš„ç¡¬ä»¶å®ç°</h4><h5 id="2-3-1ã€TI-OpenMax-ILå®ç°çš„ç»“æ„å’Œæœºåˆ¶"><a href="#2-3-1ã€TI-OpenMax-ILå®ç°çš„ç»“æ„å’Œæœºåˆ¶" class="headerlink" title="2.3.1ã€TI OpenMax ILå®ç°çš„ç»“æ„å’Œæœºåˆ¶"></a>2.3.1ã€TI OpenMax ILå®ç°çš„ç»“æ„å’Œæœºåˆ¶</h5><p> Androidçš„å¼€æºä»£ç ä¸­ï¼Œå·²ç»åŒ…å«äº†TIçš„OpenMax ILå±‚çš„å®ç°ä»£ç ï¼Œå…¶è·¯å¾„å¦‚hardware/ti/omap3/omxä¸‹ã€‚å…¶ä¸­åŒ…å«çš„ä¸»è¦ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>â˜¯    systemï¼šOpenMaxæ ¸å¿ƒå’Œå…¬å…±éƒ¨åˆ†<br>â˜¯    audioï¼šéŸ³é¢‘å¤„ç†éƒ¨åˆ†çš„OpenMax ILç»„ä»¶<br>â˜¯    videoï¼šè§†é¢‘å¤„ç†éƒ¨åˆ†OpenMax ILç»„ä»¶<br>â˜¯    imageï¼šå›¾åƒå¤„ç†éƒ¨åˆ†OpenMax ILç»„ä»¶<br>       TI OpenMax ILå®ç°çš„ç»“æ„å¦‚å›¾æ‰€ç¤º:</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-09-tiopenmaxil.png" alt="Alt text | center"></p><p> åœ¨TI OpenMax ILå®ç°ä¸­ï¼Œæœ€ä¸Šé¢çš„å†…å®¹æ˜¯OpenMaxçš„ç®¡ç†è€…ç”¨äºç®¡ç†å’Œåˆå§‹åŒ–ï¼Œä¸­é—´å±‚æ˜¯å„ä¸ªç¼–è§£ç å•å…ƒçš„OpenMax ILæ ‡å‡†ç»„ä»¶ï¼Œä¸‹å±‚æ˜¯LCMLå±‚ï¼Œä¾›å„ä¸ªOpenMax ILæ ‡å‡†ç»„ä»¶æ‰€è°ƒç”¨ã€‚<br>       ï¼ˆ1ï¼‰TI OpenMax ILå®ç°çš„å…¬å…±éƒ¨åˆ†åœ¨system/src/openmax_il/ç›®å½•ä¸­ï¼Œä¸»è¦çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>â˜¯ omx_core/srcï¼šOpenMax ILçš„æ ¸å¿ƒï¼Œç”ŸæˆåŠ¨æ€åº“libOMX_Core.so<br>â˜¯ lcml/ï¼šLCMLçš„å·¥å…·åº“ï¼Œç”ŸæˆåŠ¨æ€åº“libLCML.so<br>       ï¼ˆ2ï¼‰I OpenMax ILçš„è§†é¢‘ï¼ˆVideoï¼‰ç›¸å…³çš„ç»„ä»¶åœ¨video/src/openmax_il/ç›®å½•ä¸­ï¼Œä¸»è¦çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>â˜¯ prepost_processorï¼šVideoæ•°æ®çš„å‰å¤„ç†å’Œåå¤„ç†ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.VPP.so<br>â˜¯ video_decodeï¼šVideoè§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.Video.Decoder.so<br>â˜¯ video_encodeï¼šVideoç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.Video.encoder.so<br>       ï¼ˆ3ï¼‰TI OpenMax ILçš„éŸ³é¢‘ï¼ˆAudioï¼‰ç›¸å…³çš„ç»„ä»¶åœ¨audio/src/openmax_il/ç›®å½•ä¸­ï¼Œä¸»è¦çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>â˜¯ g711_decï¼šG711è§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.G711.decode.so<br>â˜¯ g711_encï¼šG711ç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.G711.encode.so<br>â˜¯ g722_decï¼šG722è§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.G722.decode.so<br>â˜¯ g722_encï¼šG722ç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.G722.encode.so<br>â˜¯ g726_decï¼šG726è§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.G726.decode.so<br>â˜¯ g726_encï¼šG726ç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.G726.encode.so<br>â˜¯ g729_decï¼šG729è§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.G729.decode.so<br>â˜¯ g729_encï¼šG720ç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.G729.encode.so<br>â˜¯ nbamr_decï¼šAMRçª„å¸¦è§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.AMR.decode.so<br>â˜¯ nbamr_encï¼šAMRçª„å¸¦ç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.AMR.encode.so<br>â˜¯ wbamr_decï¼šAMRå®½å¸¦è§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.WBAMR.decode.so<br>â˜¯ wbamr_encï¼šAMRå®½å¸¦ç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.WBAMR.encode.so<br>â˜¯ mp3_decï¼šMP3è§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.MP3.decode.so<br>â˜¯ aac_decï¼šAACè§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.AAC.decode.so<br>â˜¯ aac_encï¼šAACç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.AAC.encode.so<br>â˜¯ wma_decï¼šWMAè§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.WMA.decode.so<br>       ï¼ˆ4ï¼‰TI OpenMax ILçš„å›¾åƒï¼ˆImageï¼‰ç›¸å…³çš„ç»„ä»¶åœ¨image/src/openmax_il/ç›®å½•ä¸­ï¼Œä¸»è¦çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>â˜¯ jpeg_encï¼šJPEGç¼–ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.JPEG.Encoder.so<br>â˜¯ jpeg_decï¼šJPEGè§£ç å™¨ï¼Œç”ŸæˆåŠ¨æ€åº“libOMX.TI.JPEG.decoder.so</p><h5 id="2-3-2ã€TI-OpenMax-ILçš„æ ¸å¿ƒå’Œå…¬å…±å†…å®¹"><a href="#2-3-2ã€TI-OpenMax-ILçš„æ ¸å¿ƒå’Œå…¬å…±å†…å®¹" class="headerlink" title="2.3.2ã€TI OpenMax ILçš„æ ¸å¿ƒå’Œå…¬å…±å†…å®¹"></a>2.3.2ã€TI OpenMax ILçš„æ ¸å¿ƒå’Œå…¬å…±å†…å®¹</h5><p> LCMLçš„å…¨ç§°æ˜¯â€Linux Common Multimedia Layerâ€œï¼Œæ˜¯TIçš„Linuxå…¬å…±å¤šåª’ä½“å±‚ã€‚åœ¨OpenMax ILçš„å®ç°ä¸­ï¼Œè¿™ä¸ªå†…å®¹åœ¨system/src/openmax_il/lcml/ç›®å½•ä¸­ï¼Œä¸»è¦æ–‡ä»¶æ˜¯å­ç›®å½•srcä¸­çš„LCML_DspCodec.cæ–‡ä»¶ã€‚é€šè¿‡è°ƒç”¨DSPBridgeçš„å†…å®¹ï¼Œ è®©ARMå’ŒDSPè¿›è¡Œé€šä¿¡ï¼Œç„¶DSPè¿›è¡Œç¼–è§£ç æ–¹é¢çš„å¤„ç†ã€‚DSPçš„è¿è¡Œè¿˜éœ€è¦å›ºä»¶çš„æ”¯æŒã€‚</p><p> TI OpenMax ILçš„æ ¸å¿ƒå®ç°åœ¨system/src/openmax_il/omx_core/ç›®å½•ä¸­ï¼Œç”ŸæˆTI OpenMax ILçš„æ ¸å¿ƒåº“libOMX_Core.soã€‚</p><p>å…¶ä¸­å­ç›®å½•srcä¸­çš„OMX_Core.cä¸ºä¸»è¦æ–‡ä»¶ï¼Œå…¶ä¸­å®šä¹‰äº†ç¼–è§£ç å™¨çš„åç§°ç­‰ï¼Œå…¶ç‰‡æ–­å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *tComponentName[MAXCOMP][<span class="number">2</span>] = &#123;    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.JPEG.decoder"</span>, <span class="string">"image_decoder.jpeg"</span>&#125;,<span class="comment">/* å›¾åƒå’Œè§†é¢‘ç¼–è§£ç å™¨ */</span>    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.JPEG.Encoder"</span>, <span class="string">"image_encoder.jpeg"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.Video.Decoder"</span>, <span class="string">"video_decoder.avc"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.Video.Decoder"</span>, <span class="string">"video_decoder.mpeg4"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.Video.Decoder"</span>, <span class="string">"video_decoder.wmv"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.Video.encoder"</span>, <span class="string">"video_encoder.mpeg4"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.Video.encoder"</span>, <span class="string">"video_encoder.h263"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.Video.encoder"</span>, <span class="string">"video_encoder.avc"</span>&#125;,    </span><br><span class="line">     <span class="comment">/* ......çœç•¥ ï¼Œè¯­éŸ³ç›¸å…³ç»„ä»¶*/</span>    </span><br><span class="line">#ifdef BUILD_WITH_TI_AUDIO <span class="comment">/* éŸ³é¢‘ç¼–è§£ç å™¨ */</span>    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.MP3.decode"</span>, <span class="string">"audio_decoder.mp3"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.AAC.encode"</span>, <span class="string">"audio_encoder.aac"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.AAC.decode"</span>, <span class="string">"audio_decoder.aac"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.WMA.decode"</span>, <span class="string">"audio_decoder.wma"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.WBAMR.decode"</span>, <span class="string">"audio_decoder.amrwb"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.AMR.decode"</span>, <span class="string">"audio_decoder.amrnb"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.AMR.encode"</span>, <span class="string">"audio_encoder.amrnb"</span>&#125;,    </span><br><span class="line">    &#123;<span class="string">"OMX.TI.WBAMR.encode"</span>, <span class="string">"audio_encoder.amrwb"</span>&#125;,    </span><br><span class="line">#endif    </span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;,    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>  tComponentNameæ•°ç»„çš„å„ä¸ªé¡¹ä¸­ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤º<strong>ç¼–è§£ç åº“å†…å®¹</strong>ï¼Œç¬¬äºŒä¸ªè¡¨ç¤º<strong>åº“æ‰€å®ç°çš„åŠŸèƒ½</strong>ã€‚<br>       å…¶ä¸­ï¼ŒTIOMX_GetHandle()å‡½æ•°ç”¨äºè·å¾—å„ä¸ªç»„ä»¶çš„å¥æŸ„ï¼Œå…¶å®ç°çš„ä¸»è¦ç‰‡æ–­å¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">OMX_ERRORTYPE <span class="title">TIOMX_GetHandle</span><span class="params">( OMX_HANDLETYPE* pHandle, OMX_STRING cComponentName,    </span></span></span><br><span class="line"><span class="function"><span class="params">    OMX_PTR pAppData, OMX_CALLBACKTYPE* pCallBacks)</span>   </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> prefix[] = <span class="string">"lib"</span>;    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> postfix[] = <span class="string">".so"</span>;    </span><br><span class="line">    OMX_ERRORTYPE (*pComponentInit)(OMX_HANDLETYPE*);    </span><br><span class="line">    OMX_ERRORTYPE err = OMX_ErrorNone;    </span><br><span class="line">    OMX_COMPONENTTYPE *componentType;    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* pErr = dlerror();    </span><br><span class="line">    <span class="comment">// ...... çœç•¥é”™è¯¯å¤„ç†å†…å®¹    </span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;    </span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt; COUNTOF(pModules); i++) &#123;       <span class="comment">// å¾ªç¯æŸ¥æ‰¾    </span></span><br><span class="line">        <span class="keyword">if</span>(pModules[i] == <span class="literal">NULL</span>) <span class="keyword">break</span>;    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">// ...... çœç•¥é”™è¯¯å¤„ç†å†…å®¹    </span></span><br><span class="line">    <span class="keyword">int</span> refIndex = <span class="number">0</span>;    </span><br><span class="line">    <span class="keyword">for</span> (refIndex=<span class="number">0</span>; refIndex &lt; MAX_TABLE_SIZE; refIndex++) &#123;    </span><br><span class="line">    <span class="comment">// å¾ªç¯æŸ¥æ‰¾ç»„ä»¶åˆ—è¡¨    </span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(componentTable[refIndex].name, cComponentName) == <span class="number">0</span>) &#123;    </span><br><span class="line">            <span class="keyword">if</span> (componentTable[refIndex].refCount&gt;= MAX_CONCURRENT_INSTANCES) &#123;    </span><br><span class="line">            <span class="comment">// ...... çœç•¥é”™è¯¯å¤„ç†å†…å®¹    </span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;    </span><br><span class="line">                <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(prefix) + MAXNAMESIZE+ <span class="keyword">sizeof</span>(postfix)];    </span><br><span class="line">                <span class="built_in">strcpy</span>(buf, prefix);    </span><br><span class="line">                <span class="built_in">strcat</span>(buf, cComponentName);    </span><br><span class="line">                <span class="built_in">strcat</span>(buf, postfix);    </span><br><span class="line">                pModules[i] = dlopen(buf, RTLD_LAZY | RTLD_GLOBAL);    </span><br><span class="line">                <span class="comment">// ...... çœç•¥é”™è¯¯å¤„ç†å†…å®¹    </span></span><br><span class="line">                <span class="comment">// åŠ¨æ€å–å‡ºåˆå§‹åŒ–çš„ç¬¦å·    </span></span><br><span class="line">                pComponentInit = dlsym(pModules[i], <span class="string">"OMX_ComponentInit"</span>);    </span><br><span class="line">                pErr = dlerror();    </span><br><span class="line">                <span class="comment">// ...... çœç•¥é”™è¯¯å¤„ç†å†…å®¹    </span></span><br><span class="line">                *pHandle = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OMX_COMPONENTTYPE));    </span><br><span class="line">                <span class="comment">// ...... çœç•¥é”™è¯¯å¤„ç†å†…å®¹    </span></span><br><span class="line">                pComponents[i] = *pHandle;    </span><br><span class="line">                componentType = (OMX_COMPONENTTYPE*) *pHandle;    </span><br><span class="line">                componentType-&gt;nSize = <span class="keyword">sizeof</span>(OMX_COMPONENTTYPE);    </span><br><span class="line">                err = (*pComponentInit)(*pHandle);   <span class="comment">// æ‰§è¡Œåˆå§‹åŒ–å·¥ä½œ    </span></span><br><span class="line">                <span class="comment">// ...... çœç•¥éƒ¨åˆ†å†…å®¹    </span></span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;    </span><br><span class="line">    err = OMX_ErrorComponentNotFound;    </span><br><span class="line">    <span class="keyword">goto</span> UNLOCK_MUTEX;    </span><br><span class="line">    <span class="comment">// ...... çœç•¥éƒ¨åˆ†å†…å®¹    </span></span><br><span class="line">     <span class="keyword">return</span> (err);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p> åœ¨TIOMX_GetHandle()å‡½æ•°ä¸­ï¼Œæ ¹æ®tComponentNameæ•°ç»„ä¸­åŠ¨æ€åº“çš„åç§°ï¼ŒåŠ¨æ€æ‰“å¼€å„ä¸ªç¼–è§£ç å®ç°çš„åŠ¨æ€åº“ï¼Œå–å‡ºå…¶ä¸­çš„<strong>OMX_ComponentInit</strong>ç¬¦å·æ¥æ‰§è¡Œå„ä¸ªç»„ä»¶çš„åˆå§‹åŒ–ã€‚</p><h5 id="2-3-3ã€ä¸€ä¸ªTI-OpenMax-ILç»„ä»¶çš„å®ç°"><a href="#2-3-3ã€ä¸€ä¸ªTI-OpenMax-ILç»„ä»¶çš„å®ç°" class="headerlink" title="2.3.3ã€ä¸€ä¸ªTI OpenMax ILç»„ä»¶çš„å®ç°"></a>2.3.3ã€ä¸€ä¸ªTI OpenMax ILç»„ä»¶çš„å®ç°</h5><p>  TI OpenMax ILä¸­å„ä¸ªç»„ä»¶éƒ½æ˜¯é€šè¿‡è°ƒç”¨LCMLæ¥å®ç°çš„ï¼Œå®ç°çš„æ–¹å¼åŸºæœ¬ç±»ä¼¼ã€‚ä¸»è¦éƒ½æ˜¯å®ç°äº†åç§°ä¸ºOMX_ComponentInitçš„åˆå§‹åŒ–å‡½æ•°ï¼Œå®ç°OMX_COMPONENTTYPEç±»å‹çš„ç»“æ„ä½“ä¸­çš„å„ä¸ªæˆå‘˜ã€‚å„ä¸ªç»„ä»¶å…¶ç›®å½•ç»“æ„å’Œæ–‡ä»¶ç»“æ„ä¹Ÿç±»ä¼¼ã€‚</p><p>ä»¥MP3è§£ç å™¨çš„å®ç°ä¸ºä¾‹ï¼Œåœ¨audio/src/openmax_il/mp3_dec/srcç›®å½•ä¸­ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š</p><p>â˜¯ OMX_Mp3Decoder.cï¼šMP3è§£ç å™¨ç»„ä»¶å®ç°<br>â˜¯ OMX_Mp3Dec_CompThread.cï¼šMP3è§£ç å™¨ç»„ä»¶çš„çº¿ç¨‹å¾ªç¯<br>â˜¯ OMX_Mp3Dec_Utils.cï¼šMP3è§£ç å™¨çš„ç›¸å…³å·¥å…·ï¼Œè°ƒç”¨LCMLå®ç°çœŸæ­£çš„MP3è§£ç çš„åŠŸèƒ½<br>       OMX_Mp3Decoder.cä¸­çš„OMX_ComponentInit()å‡½æ•°è´Ÿè´£ç»„ä»¶çš„åˆå§‹åŒ–ï¼Œè¿”å›çš„å†…å®¹å†ä»å‚æ•°ä¸­å¾—åˆ°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä¸»è¦ç‰‡æ–­å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">OMX_ERRORTYPE <span class="title">OMX_ComponentInit</span> <span class="params">(OMX_HANDLETYPE hComp)</span>    </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    OMX_ERRORTYPE eError = OMX_ErrorNone;    </span><br><span class="line">    OMX_COMPONENTTYPE *pHandle = (OMX_COMPONENTTYPE*) hComp;    </span><br><span class="line">    OMX_PARAM_PORTDEFINITIONTYPE *pPortDef_ip = <span class="literal">NULL</span>, *pPortDef_op = <span class="literal">NULL</span>;    </span><br><span class="line">    OMX_AUDIO_PARAM_PORTFORMATTYPE *pPortFormat = <span class="literal">NULL</span>;    </span><br><span class="line">    OMX_AUDIO_PARAM_MP3TYPE *mp3_ip = <span class="literal">NULL</span>;    </span><br><span class="line">    OMX_AUDIO_PARAM_PCMMODETYPE *mp3_op = <span class="literal">NULL</span>;    </span><br><span class="line">    MP3DEC_COMPONENT_PRIVATE *pComponentPrivate = <span class="literal">NULL</span>;    </span><br><span class="line">    MP3D_AUDIODEC_PORT_TYPE *pCompPort = <span class="literal">NULL</span>;    </span><br><span class="line">    MP3D_BUFFERLIST *pTemp = <span class="literal">NULL</span>;    </span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;    </span><br><span class="line">  </span><br><span class="line">    MP3D_OMX_CONF_CHECK_CMD(pHandle,<span class="number">1</span>,<span class="number">1</span>);    </span><br><span class="line">    <span class="comment">/* ......çœç•¥ï¼Œåˆå§‹åŒ–OMX_COMPONENTTYPEç±»å‹çš„æŒ‡é’ˆpHandle */</span>    </span><br><span class="line">    OMX_MALLOC_GENERIC(pHandle-&gt;pComponentPrivate, MP3DEC_COMPONENT_PRIVATE);    </span><br><span class="line">    pComponentPrivate = pHandle-&gt;pComponentPrivate; <span class="comment">/* ç§æœ‰æŒ‡é’ˆäº’ç›¸æŒ‡å‘ */</span>    </span><br><span class="line">    pComponentPrivate-&gt;pHandlepHandle = pHandle;    </span><br><span class="line">    <span class="comment">/* ......ç•¥ï¼Œåˆå§‹åŒ–ä¼¼æœ‰æ•°æ®æŒ‡é’ˆpComponentPrivate */</span>    </span><br><span class="line">    <span class="comment">/* è®¾ç½®è¾“å…¥ç«¯å£ï¼ˆOMX_PARAM_PORTDEFINITIONTYPEç±»å‹ï¼‰çš„é»˜è®¤å€¼ */</span>    </span><br><span class="line">    pPortDef_ip-&gt;nSize                   = <span class="keyword">sizeof</span>(OMX_PARAM_PORTDEFINITIONTYPE);    </span><br><span class="line">    pPortDef_ip-&gt;nPortIndex             = MP3D_INPUT_PORT;    </span><br><span class="line">    pPortDef_ip-&gt;eDir                    = OMX_DirInput;    </span><br><span class="line">    pPortDef_ip-&gt;nBufferCountActual    = MP3D_NUM_INPUT_BUFFERS;    </span><br><span class="line">    pPortDef_ip-&gt;nBufferCountMin        = MP3D_NUM_INPUT_BUFFERS;    </span><br><span class="line">    pPortDef_ip-&gt;nBufferSize             = MP3D_INPUT_BUFFER_SIZE;    </span><br><span class="line">    pPortDef_ip-&gt;nBufferAlignment       = DSP_CACHE_ALIGNMENT;    </span><br><span class="line">    pPortDef_ip-&gt;bEnabled                 = OMX_TRUE;    </span><br><span class="line">    pPortDef_ip-&gt;bPopulated               = OMX_FALSE;    </span><br><span class="line">    pPortDef_ip-&gt;eDomain                   = OMX_PortDomainAudio;    </span><br><span class="line">    pPortDef_ip-&gt;format.audio.eEncoding = OMX_AUDIO_CodingMP3;    </span><br><span class="line">    pPortDef_ip-&gt;format.audio.cMIMEType = <span class="literal">NULL</span>;    </span><br><span class="line">    pPortDef_ip-&gt;format.audio.pNativeRender           = <span class="literal">NULL</span>;    </span><br><span class="line">    pPortDef_ip-&gt;format.audio.bFlagErrorConcealment = OMX_FALSE;    </span><br><span class="line">    <span class="comment">/* è®¾ç½®è¾“å‡ºç«¯å£ï¼ˆOMX_PARAM_PORTDEFINITIONTYPEç±»å‹ï¼‰çš„é»˜è®¤å€¼ */</span>    </span><br><span class="line">    pPortDef_op-&gt;nSize                 = <span class="keyword">sizeof</span>(OMX_PARAM_PORTDEFINITIONTYPE);    </span><br><span class="line">    pPortDef_op-&gt;nPortIndex           = MP3D_OUTPUT_PORT;    </span><br><span class="line">    pPortDef_op-&gt;eDir                  = OMX_DirOutput;    </span><br><span class="line">    pPortDef_op-&gt;nBufferCountMin     = MP3D_NUM_OUTPUT_BUFFERS;    </span><br><span class="line">    pPortDef_op-&gt;nBufferCountActual  = MP3D_NUM_OUTPUT_BUFFERS;    </span><br><span class="line">    pPortDef_op-&gt;nBufferSize          = MP3D_OUTPUT_BUFFER_SIZE;    </span><br><span class="line">    pPortDef_op-&gt;nBufferAlignment    = DSP_CACHE_ALIGNMENT;    </span><br><span class="line">    pPortDef_op-&gt;bEnabled              = OMX_TRUE;    </span><br><span class="line">    pPortDef_op-&gt;bPopulated            = OMX_FALSE;    </span><br><span class="line">    pPortDef_op-&gt;eDomain               = OMX_PortDomainAudio;    </span><br><span class="line">    pPortDef_op-&gt;format.audio.eEncoding      = OMX_AUDIO_CodingPCM;    </span><br><span class="line">    pPortDef_op-&gt;format.audio.cMIMEType      = <span class="literal">NULL</span>;    </span><br><span class="line">    pPortDef_op-&gt;format.audio.pNativeRender = <span class="literal">NULL</span>;    </span><br><span class="line">    pPortDef_op-&gt;format.audio.bFlagErrorConcealment = OMX_FALSE;    </span><br><span class="line">    <span class="comment">/* ......çœç•¥ï¼Œåˆ†é…ç«¯å£ */</span>    </span><br><span class="line">    <span class="comment">/* è®¾ç½®è¾“å…¥ç«¯å£çš„é»˜è®¤æ ¼å¼ */</span>    </span><br><span class="line">    pPortFormat = pComponentPrivate-&gt;pCompPort[MP3D_INPUT_PORT]-&gt;pPortFormat;    </span><br><span class="line">    OMX_CONF_INIT_STRUCT(pPortFormat, OMX_AUDIO_PARAM_PORTFORMATTYPE);    </span><br><span class="line">    pPortFormat-&gt;nPortIndex         = MP3D_INPUT_PORT;    </span><br><span class="line">    pPortFormat-&gt;nIndex             = OMX_IndexParamAudioMp3;    </span><br><span class="line">    pPortFormat-&gt;eEncoding          = OMX_AUDIO_CodingMP3;    </span><br><span class="line">    <span class="comment">/* è®¾ç½®è¾“å‡ºç«¯å£çš„é»˜è®¤æ ¼å¼ */</span>    </span><br><span class="line">    pPortFormat = pComponentPrivate-&gt;pCompPort[MP3D_OUTPUT_PORT]-&gt;pPortFormat;    </span><br><span class="line">    OMX_CONF_INIT_STRUCT(pPortFormat, OMX_AUDIO_PARAM_PORTFORMATTYPE);    </span><br><span class="line">        pPortFormat-&gt;nPortIndex         = MP3D_OUTPUT_PORT;    </span><br><span class="line">        pPortFormat-&gt;nIndex             = OMX_IndexParamAudioPcm;    </span><br><span class="line">        pPortFormat-&gt;eEncoding          = OMX_AUDIO_CodingPCM;    </span><br><span class="line">    <span class="comment">/* ......çœç•¥éƒ¨åˆ†å†…å®¹ */</span>    </span><br><span class="line">    eError = Mp3Dec_StartCompThread(pHandle);   <span class="comment">// å¯åŠ¨MP3è§£ç çº¿ç¨‹    </span></span><br><span class="line">    <span class="comment">/* ......çœç•¥éƒ¨åˆ†å†…å®¹ */</span>    </span><br><span class="line">    <span class="keyword">return</span> eError;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> è¿™ä¸ªç»„ä»¶æ˜¯OpenMaxçš„æ ‡å‡†å®ç°æ–¹å¼ï¼Œå¯¹å¤–çš„æ¥å£çš„å†…å®¹åªæœ‰ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°ã€‚å®ŒæˆOMX_COMPONENTTYPEç±»å‹çš„åˆå§‹åŒ–ã€‚è¾“å…¥ç«¯å£çš„ç¼–å·ä¸ºMP3D_INPUT_PORTï¼ˆ==0ï¼‰ï¼Œç±»å‹ä¸ºOMX_PortDomainAudioï¼Œæ ¼å¼ä¸ºOMX_AUDIO_CodingMP3ã€‚è¾“å‡ºç«¯å£çš„ç¼–å·æ˜¯MP3D_OUTPUT_PORTï¼ˆ==1ï¼‰ï¼Œç±»å‹ä¸ºOMX_PortDomainAudioï¼Œæ ¼å¼ä¸ºOMXAUDIO CodingPCMã€‚</p><p>  OMX_Mp3Dec_CompThread.cä¸­å®šä¹‰äº†MP3DEC_ComponentThread()å‡½æ•°ï¼Œç”¨äºåˆ›å»ºMP3è§£ç çš„çº¿ç¨‹çš„æ‰§è¡Œå‡½æ•°ã€‚<br>  OMX_Mp3Dec_Utils.cä¸­çš„Mp3Dec_StartCompThread()å‡½æ•°ï¼Œè°ƒç”¨äº†POSIXçš„çº¿ç¨‹åº“å»ºç«‹MP3è§£ç çš„çº¿ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nRet = pthread_create (&amp;(pComponentPrivate-&gt;ComponentThread), <span class="literal">NULL</span>,    </span><br><span class="line">    MP3DEC_ComponentThread, pComponentPrivate);</span><br></pre></td></tr></table></figure><p> Mp3Dec_StartCompThread()å‡½æ•°å°±æ˜¯åœ¨ç»„ä»¶åˆå§‹åŒ–å‡½æ•°OMX_ComponentInit()æœ€åè°ƒç”¨çš„å†…å®¹ã€‚MP3çº¿ç¨‹çš„å¼€å§‹å¹¶ä¸è¡¨ç¤ºè§£ç è¿‡ç¨‹å¼€å§‹ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…é€šè¿‡pipeæœºåˆ¶è·å¾—å‘½ä»¤å’Œæ•°æ®ï¼ˆcmdPipeå’ŒdataPipeï¼‰ï¼Œåœ¨é€‚å½“çš„æ—¶å€™å¼€å§‹å·¥ä½œã€‚è¿™ä¸ªpipeåœ¨MP3è§£ç ç»„ä»¶çš„SendCommandç­‰å®ç°å†™æ“ä½œï¼Œåœ¨çº¿ç¨‹ä¸­è¯»å–å…¶å†…å®¹ã€‚</p><h5 id="2-4ã€Qualcomm-é«˜é€š-OpenMax-ILçš„ç¡¬ä»¶å®ç°"><a href="#2-4ã€Qualcomm-é«˜é€š-OpenMax-ILçš„ç¡¬ä»¶å®ç°" class="headerlink" title="2.4ã€Qualcomm(é«˜é€š) OpenMax ILçš„ç¡¬ä»¶å®ç°"></a>2.4ã€Qualcomm(é«˜é€š) OpenMax ILçš„ç¡¬ä»¶å®ç°</h5><h6 id="2-4-1ã€qcom-OpenMax-ILå®ç°çš„ç»“æ„å’Œæœºåˆ¶"><a href="#2-4-1ã€qcom-OpenMax-ILå®ç°çš„ç»“æ„å’Œæœºåˆ¶" class="headerlink" title="2.4.1ã€qcom OpenMax ILå®ç°çš„ç»“æ„å’Œæœºåˆ¶"></a>2.4.1ã€qcom OpenMax ILå®ç°çš„ç»“æ„å’Œæœºåˆ¶</h6><p>ï¼ˆ1ï¼‰åœ¨AOSPä¸­ä¾ç„¶æœ‰å¯¹é«˜é€šå¹³å°çš„OpenMax ILå±‚å®ç°ä»£ç ï¼Œä½äºhardware/qcom/media/mm-coreä¸‹ã€‚è¿™ä¸€éƒ¨åˆ†æ˜¯OpenMaxæ ¸å¿ƒå’Œå…¬å…±éƒ¨åˆ†ï¼Œä¸»è¦ç¼–è¯‘ä¸ºlibOmxCore.soã€‚</p><p>ï¼ˆ2ï¼‰e.g. ç»§ç»­åœ¨hardware/qcom/mediaä¸‹ï¼Œé€‰å–mm-video-v4l2ç›®å½•ã€‚å³Video4linux2ï¼ˆç®€ç§°V4L2),æ˜¯linuxä¸­å…³äºè§†é¢‘è®¾å¤‡çš„å†…æ ¸é©±åŠ¨ã€‚å†æ¬¡è¿›å…¥vidcï¼Œï¼ˆDivxDrmDecryptä¸ºDRMæ•°å­—ç‰ˆæƒç›¸å…³ï¼‰ä¸»è¦ç›®å½•å¦‚ä¸‹ï¼š</p><p>â˜¯ vdecï¼šè§†é¢‘è§£ç å¤„ç†ï¼Œç¼–è¯‘æˆlibOmxVdec.so/libOmxVdecHevc.so<br>â˜¯ vencï¼šè§†é¢‘ç¼–ç å¤„ç†ï¼Œç¼–è¯‘æˆlibOmxVenc.so<br>qcom OpenMax ILçš„æ ¸å¿ƒå’Œå…¬å…±å†…å®¹<br>       ç±»ä¼¼äºå‰é¢ä»‹ç»çš„TIï¼Œé«˜é€šå¹³å°åœ¨OpenMax ILå®ç°ä¹Ÿæ˜¯å¤§åŒå°å¼‚ï¼Œä½äºhardware/qcom/media/mm-coreï¼Œç”ŸæˆlibOmxCore.soåº“ã€‚<br>       å…¶ä¸­qc_omx_coreä¸ºä¸»è¦æ–‡ä»¶ï¼Œä½äºhardware/qcom/media/mm-core/omxcore/src/common/ä¸‹é¢ã€‚å’ŒTIçš„å·®ä¸å¤šï¼ŒOMX_GetHandle()å‡½æ•°ç”¨æˆ·è·å–å„ä¸ªç»„ä»¶çš„å¥æŸ„ï¼Œå…¶å®ç°çš„ä¸»è¦ç‰‡æ–­å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¼–è§£ç å™¨ç»„ä»¶é›†åˆæ•°ç»„</span></span><br><span class="line"><span class="keyword">extern</span> omx_core_cb_type core[];</span><br><span class="line"></span><br><span class="line"> OMX_API OMX_ERRORTYPE OMX_APIENTRY</span><br><span class="line">OMX_GetHandle(OMX_OUT OMX_HANDLETYPE*     handle,</span><br><span class="line">              OMX_IN OMX_STRING    componentName,</span><br><span class="line">              OMX_IN OMX_PTR             appData,</span><br><span class="line">              OMX_IN OMX_CALLBACKTYPE* callBacks)</span><br><span class="line">&#123;</span><br><span class="line">  OMX_ERRORTYPE  eRet = OMX_ErrorNone;</span><br><span class="line">  <span class="keyword">int</span> cmp_index = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">int</span> hnd_index = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  DEBUG_PRINT(<span class="string">"OMXCORE API :  Get Handle %p %s %p\n"</span>, handle,</span><br><span class="line">                                                     componentName,</span><br><span class="line">                                                     appData);</span><br><span class="line">  pthread_mutex_lock(&amp;lock_core);</span><br><span class="line">  <span class="keyword">if</span>(handle)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sd</span>;</span></span><br><span class="line"><span class="comment">//ç»„ä»¶å¥æŸ„</span></span><br><span class="line">    *handle = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//è·å–æ ¹æ®ç»„ä»¶åè·å–ç›¸åº”index</span></span><br><span class="line">    cmp_index = get_cmp_index(componentName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(cmp_index &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       DEBUG_PRINT(<span class="string">"getting fn pointer\n"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dynamically load the so åŠ¨æ€åŠ è½½ç»„ä»¶çš„soåº“</span></span><br><span class="line">      core[cmp_index].fn_ptr =</span><br><span class="line">        omx_core_load_cmp_library(core[cmp_index].so_lib_name,</span><br><span class="line">                                  &amp;core[cmp_index].so_lib_handle);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(core[cmp_index].fn_ptr)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Construct the component requested</span></span><br><span class="line">        <span class="comment">// Function returns the opaque handle</span></span><br><span class="line">        <span class="comment">//æ ¹æ®è·å–çš„ç»„ä»¶å¥æŸ„åˆå§‹åŒ–å®ƒ</span></span><br><span class="line">        <span class="keyword">void</span>* pThis = (*(core[cmp_index].fn_ptr))();</span><br><span class="line">        <span class="keyword">if</span>(pThis)</span><br><span class="line">        &#123;</span><br><span class="line">      <span class="comment">//åŒ…è£…ä¸€å±‚ï¼Œå¿½ç•¥</span></span><br><span class="line">          <span class="keyword">void</span> *hComp = <span class="literal">NULL</span>;</span><br><span class="line">          hComp = qc_omx_create_component_wrapper((OMX_PTR)pThis);</span><br><span class="line">          <span class="keyword">if</span>((eRet = qc_omx_component_init(hComp, core[cmp_index].name)) !=</span><br><span class="line">                           OMX_ErrorNone)</span><br><span class="line">          &#123;</span><br><span class="line">              DEBUG_PRINT(<span class="string">"Component not created succesfully\n"</span>);</span><br><span class="line">              pthread_mutex_unlock(&amp;lock_core);</span><br><span class="line">              <span class="keyword">return</span> eRet;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//è®¾ç½®å›è°ƒ</span></span><br><span class="line">          qc_omx_component_set_callbacks(hComp,callBacks,appData);</span><br><span class="line">          hnd_index = get_comp_handle_index(componentName);</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">if</span>(hnd_index &gt;= <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">//ä¿å­˜è¿™ä¸ªç»„ä»¶å¥æŸ„</span></span><br><span class="line">            core[cmp_index].inst[hnd_index]= *handle = (OMX_HANDLETYPE) hComp;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">          <span class="comment">/*-------ä¸‹é¢å…¨æ˜¯é”™è¯¯å¤„ç†ï¼Œå¿½ç•¥------*/</span></span><br><span class="line">            DEBUG_PRINT(<span class="string">"OMX_GetHandle:NO free slot available to store Component Handle\n"</span>);</span><br><span class="line">            pthread_mutex_unlock(&amp;lock_core);</span><br><span class="line">            <span class="keyword">return</span> OMX_ErrorInsufficientResources;</span><br><span class="line">          &#125;</span><br><span class="line">          DEBUG_PRINT(<span class="string">"Component %p Successfully created\n"</span>,*handle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          eRet = OMX_ErrorInsufficientResources;</span><br><span class="line">          DEBUG_PRINT(<span class="string">"Component Creation failed\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        eRet = OMX_ErrorNotImplemented;</span><br><span class="line">        DEBUG_PRINT(<span class="string">"library couldnt return create instance fn\n"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      eRet = OMX_ErrorNotImplemented;</span><br><span class="line">      DEBUG_PRINT(<span class="string">"ERROR: Already another instance active  ;rejecting \n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    eRet =  OMX_ErrorBadParameter;</span><br><span class="line">    DEBUG_PRINT(<span class="string">"\n OMX_GetHandle: NULL handle \n"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_mutex_unlock(&amp;lock_core);</span><br><span class="line">  <span class="keyword">return</span> eRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  è¿™é‡Œçš„æœ‰ä¸ªæ•°ç»„ï¼šextern omx_core_cb_type core[]ï¼Œæ˜¯ä»åˆ«çš„æ–‡ä»¶ä¸­å£°æ˜è¿‡æ¥çš„å…¨å±€å˜é‡ï¼Œå…¶ä¸­åŒ…å«äº†å„ç§ç¼–è§£ç å™¨çš„åç§°å’Œä¸€äº›å±æ€§çš„ç»“æ„ä½“ã€‚ç»“æ„ä½“å®šä¹‰ä½äºhardware/qcom/media/mm-core/omxcore/src/common/qc_omx_core.hï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">omx_core_cb_type</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span>*                         name;<span class="comment">// Component name ç»„ä»¶å</span></span><br><span class="line">  create_qc_omx_component     fn_ptr;<span class="comment">// create instance fn ptr åˆ›å»ºå®ä¾‹å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">  <span class="keyword">void</span>*                         inst[OMX_COMP_MAX_INST];<span class="comment">// Instance handle å®ä¾‹å¥æŸ„</span></span><br><span class="line">  <span class="keyword">void</span>*                so_lib_handle;<span class="comment">// So Library handle soåº“å¥æŸ„</span></span><br><span class="line">  <span class="keyword">char</span>*                  so_lib_name;<span class="comment">// so directory soå</span></span><br><span class="line">  <span class="keyword">char</span>* roles[OMX_CORE_MAX_CMP_ROLES];<span class="comment">// roles played ç»„ä»¶æ‰®æ¼”çš„è§’è‰²</span></span><br><span class="line">&#125;omx_core_cb_type;</span><br></pre></td></tr></table></figure><p>  ä½†æ˜¯ç»™omx_core_cb_type core[]è¿™ä¸ªç»“æ„ä½“æ•°ç»„å¤åˆ¶çš„åœ°æ–¹è¦æ ¹æ®ä¸åŒå‹å·è¿›è¡Œé€‰å–ï¼Œæˆ‘ä»¬è¿›å…¥hardware/qcom/media/mm-core/srcä¸‹é¢ï¼Œä¼šçœ‹åˆ°æœ‰è®¸å¤šå‹å·ï¼Œ7627Aã€7630ã€8084ã€8226ã€8610ã€8660ç­‰ç­‰ã€‚æ¯”å¦‚è¿™ä¸ª8974çš„ï¼Œä½äºhardware/qcom/media/mm-core/src/8974/qc_registry_table_android.cä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">omx_core_cb_type core[] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//avc/h264è§£ç å™¨</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"OMX.qcom.video.decoder.avc"</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// Create instance function</span></span><br><span class="line">    <span class="comment">// Unique instance handle</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="literal">NULL</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">NULL</span>,   <span class="comment">// Shared object library handle</span></span><br><span class="line">    <span class="string">"libOmxVdec.so"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"video_decoder.avc"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//mpeg4è§£ç å™¨</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"OMX.qcom.video.decoder.mpeg4"</span>,</span><br><span class="line">    <span class="literal">NULL</span>,   <span class="comment">// Create instance function</span></span><br><span class="line">    <span class="comment">// Unique instance handle</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="literal">NULL</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">NULL</span>,   <span class="comment">// Shared object library handle</span></span><br><span class="line">    <span class="string">"libOmxVdec.so"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"video_decoder.mpeg4"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">    <span class="comment">//wmvè§£ç å™¨</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"OMX.qcom.video.decoder.wmv"</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// Create instance function</span></span><br><span class="line">    <span class="comment">// Unique instance handle</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="literal">NULL</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">NULL</span>,   <span class="comment">// Shared object library handle</span></span><br><span class="line">    <span class="string">"libOmxVdec.so"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"video_decoder.vc1"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">    <span class="comment">//hevc/h265ç¼–ç å™¨</span></span><br><span class="line">   &#123;</span><br><span class="line">    <span class="string">"OMX.qcom.video.encoder.hevc"</span>,</span><br><span class="line">    <span class="literal">NULL</span>,   <span class="comment">// Create instance function</span></span><br><span class="line">    <span class="comment">// Unique instance handle</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="literal">NULL</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">NULL</span>,   <span class="comment">// Shared object library handle</span></span><br><span class="line">    <span class="string">"libOmxVencHevc.so"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"video_encoder.hevc"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  ...å¤ªå¤šäº†ï¼Œçœç•¥...</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯å¯¹ç¼–è§£ç å™¨ç›¸å…³ä¿¡æ¯çš„æ³¨å†Œã€‚</p><p>åœ¨OMX_GetHandle()å‡½æ•°ä¸­ï¼Œæ ¹æ®omx_core_cb_type core[]æ•°ç»„ä¸­åŠ¨æ€åº“çš„åç§°ï¼ŒåŠ¨æ€æ‰“å¼€å„ä¸ªç¼–è§£ç å®ç°çš„åŠ¨æ€åº“,ç„¶åè¿›è¡Œåˆå§‹åŒ–ã€‚</p><h6 id="2-4-1ã€ä¸€ä¸ªqcom-OpenMax-ILç»„ä»¶çš„å®ç°"><a href="#2-4-1ã€ä¸€ä¸ªqcom-OpenMax-ILç»„ä»¶çš„å®ç°" class="headerlink" title="2.4.1ã€ä¸€ä¸ªqcom OpenMax ILç»„ä»¶çš„å®ç°"></a>2.4.1ã€ä¸€ä¸ªqcom OpenMax ILç»„ä»¶çš„å®ç°</h6><p> é«˜é€šå¹³å°å¯¹äºç¼–è§£ç ç»„ä»¶çš„å¤„ç†éƒ½æ¯”è¾ƒé›†ä¸­ï¼Œä¸åƒTIé‚£ä¹ˆåˆ†æ•£å’Œç»†è‡´ã€‚ä¸€ä¸ªç»„ä»¶å®ç°éƒ½è¦åŒ…å«Qc_omx_component.hå¤´æ–‡ä»¶ï¼Œä½äºå¾ˆå¤šåœ°æ–¹ï¼Œå¦‚hardware/qcom/media/mm-core/incï¼Œè¦å®ç°é‡Œé¢ç›¸å…³çº¯è™šå‡½æ•°ã€‚å½“ä¸€ä¸ªç»„ä»¶è¢«åˆ›å»ºåè¦åˆå§‹åŒ–ï¼Œå°±è¦å®ç°component_init(OMX_IN OMX_STRING componentName)æ–¹æ³•ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¾ç„¶ä»¥Video4linux2å¹³å°ï¼Œè¿›å…¥hardware/qcom/media/mm-video-v4l2/vidc/vdec/srcæŸ¥çœ‹è§†é¢‘è§£ç ç›¸å…³ç»„ä»¶ã€‚æ¯”å¦‚æˆ‘ä»¬çœ‹çœ‹è§£ç ç»„ä»¶omx_vdec_hevc.cppï¼ŒæŸ¥çœ‹component_initæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VENUS_HEVC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">"/dev/video/venus_dec"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">"/dev/video/q6_dec"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ======================================================================</span></span><br><span class="line"><span class="comment">   FUNCTION</span></span><br><span class="line"><span class="comment">   omx_vdec::ComponentInit</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   DESCRIPTION</span></span><br><span class="line"><span class="comment">   Initialize the component.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   PARAMETERS</span></span><br><span class="line"><span class="comment">   ctxt -- Context information related to the self.</span></span><br><span class="line"><span class="comment">   id   -- Event identifier. This could be any of the following:</span></span><br><span class="line"><span class="comment">   1. Command completion event</span></span><br><span class="line"><span class="comment">   2. Buffer done callback event</span></span><br><span class="line"><span class="comment">   3. Frame done callback event</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   RETURN VALUE</span></span><br><span class="line"><span class="comment">   None.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   ========================================================================== */</span></span><br><span class="line">OMX_ERRORTYPE omx_vdec::component_init(OMX_STRING role)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    OMX_ERRORTYPE eRet = OMX_ErrorNone;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_fmtdesc</span> <span class="title">fdesc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_format</span> <span class="title">fmt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_requestbuffers</span> <span class="title">bufreq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_control</span> <span class="title">control</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>   alignment = <span class="number">0</span>,buffer_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> fds[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> r,ret=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> codec_ambiguous = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//æ‰“å¼€è®¾å¤‡æ–‡ä»¶"/dev/video/venus_dec"æˆ–"/dev/video/q6_dec"</span></span><br><span class="line">    OMX_STRING device_name = (OMX_STRING)DEVICE_NAME;</span><br><span class="line">    ......</span><br><span class="line">    drv_ctx.video_driver_fd = open(device_name, O_RDWR);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯ä¸€ä¸ªæ‰“å¼€æˆåŠŸåï¼Œä¸ºä»€ä¹ˆè¦å†æ¬¡æ‰“å¼€ï¼Ÿï¼Ÿexcuse me ï¼Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (drv_ctx.video_driver_fd == <span class="number">0</span>) &#123;</span><br><span class="line">        drv_ctx.video_driver_fd = open(device_name, O_RDWR);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//æ‰“å¼€è®¾å¤‡æ–‡ä»¶å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (drv_ctx.video_driver_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        DEBUG_PRINT_ERROR(<span class="string">"Omx_vdec::Comp Init Returning failure, errno %d"</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> OMX_ErrorInsufficientResources;</span><br><span class="line">    &#125;</span><br><span class="line">    drv_ctx.frame_rate.fps_numerator = DEFAULT_FPS;<span class="comment">//å¸§ç‡åˆ†å­</span></span><br><span class="line">    drv_ctx.frame_rate.fps_denominator = <span class="number">1</span>;<span class="comment">//å¸§ç‡åˆ†æ¯</span></span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ï¼Œæ‰§è¡Œasync_message_threadå‡½æ•°ï¼Œå¯¹è¾“å…¥ç«¯è¿›è¡Œè®¾ç½®</span></span><br><span class="line">    ret = pthread_create(&amp;async_thread_id,<span class="number">0</span>,async_message_thread,<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºçº¿ç¨‹å¤±è´¥ï¼Œåˆ™å…³é—­è®¾å¤‡æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        close(drv_ctx.video_driver_fd);</span><br><span class="line">        DEBUG_PRINT_ERROR(<span class="string">"Failed to create async_message_thread"</span>);</span><br><span class="line">        <span class="keyword">return</span> OMX_ErrorInsufficientResources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy the role information which provides the decoder kind</span></span><br><span class="line">    <span class="comment">//å°†ç»„å»ºè§’è‰²åå­—copyè¿›è®¾å¤‡é©±åŠ¨ä¸Šä¸‹æ–‡ç»“æ„ä½“çš„kindå±æ€§</span></span><br><span class="line">    strlcpy(drv_ctx.kind,role,<span class="number">128</span>);</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯mpeg4è§£ç ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind,<span class="string">"OMX.qcom.video.decoder.mpeg4"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.mpeg4"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        drv_ctx.timestamp_adjust = <span class="literal">true</span>;</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_MPEG4;</span><br><span class="line">        eCompressionFormat = OMX_VIDEO_CodingMPEG4;</span><br><span class="line">        output_capability=V4L2_PIX_FMT_MPEG4;</span><br><span class="line">        <span class="comment">/*Initialize Start Code for MPEG4*/</span></span><br><span class="line">        codec_type_parse = CODEC_TYPE_MPEG4;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line">......</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯mpeg2è§£ç ç»„ä»¶</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind,<span class="string">"OMX.qcom.video.decoder.mpeg2"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.mpeg2"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_MPEG2;</span><br><span class="line">        output_capability = V4L2_PIX_FMT_MPEG2;</span><br><span class="line">        eCompressionFormat = OMX_VIDEO_CodingMPEG2;</span><br><span class="line">        <span class="comment">/*Initialize Start Code for MPEG2*/</span></span><br><span class="line">        codec_type_parse = CODEC_TYPE_MPEG2;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line">......</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯h263è§£ç ç»„ä»¶</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.h263"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.h263"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        DEBUG_PRINT_LOW(<span class="string">"H263 Decoder selected"</span>);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_H263;</span><br><span class="line">        eCompressionFormat = OMX_VIDEO_CodingH263;</span><br><span class="line">        output_capability = V4L2_PIX_FMT_H263;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_H263;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line">......</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯divx311...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.divx311"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.divx"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        DEBUG_PRINT_LOW (<span class="string">"DIVX 311 Decoder selected"</span>);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_DIVX_3;</span><br><span class="line">        output_capability = V4L2_PIX_FMT_DIVX_311;</span><br><span class="line">        eCompressionFormat = (OMX_VIDEO_CODINGTYPE)QOMX_VIDEO_CodingDivx;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_DIVX;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line"></span><br><span class="line">        eRet = createDivxDrmContext();</span><br><span class="line">        <span class="keyword">if</span> (eRet != OMX_ErrorNone) &#123;</span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"createDivxDrmContext Failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> eRet;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯divx4...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.divx4"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.divx"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        DEBUG_PRINT_ERROR (<span class="string">"DIVX 4 Decoder selected"</span>);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_DIVX_4;</span><br><span class="line">        output_capability = V4L2_PIX_FMT_DIVX;</span><br><span class="line">        eCompressionFormat = (OMX_VIDEO_CODINGTYPE)QOMX_VIDEO_CodingDivx;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_DIVX;</span><br><span class="line">        codec_ambiguous = <span class="literal">true</span>;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line"></span><br><span class="line">        eRet = createDivxDrmContext();</span><br><span class="line">        <span class="keyword">if</span> (eRet != OMX_ErrorNone) &#123;</span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"createDivxDrmContext Failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> eRet;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯divx...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.divx"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.divx"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        DEBUG_PRINT_ERROR (<span class="string">"DIVX 5/6 Decoder selected"</span>);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_DIVX_6;</span><br><span class="line">        output_capability = V4L2_PIX_FMT_DIVX;</span><br><span class="line">        eCompressionFormat = (OMX_VIDEO_CODINGTYPE)QOMX_VIDEO_CodingDivx;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_DIVX;</span><br><span class="line">        codec_ambiguous = <span class="literal">true</span>;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line"></span><br><span class="line">        eRet = createDivxDrmContext();</span><br><span class="line">        <span class="keyword">if</span> (eRet != OMX_ErrorNone) &#123;</span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"createDivxDrmContext Failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> eRet;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯avc/h264...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.avc"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.avc"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_H264;</span><br><span class="line">        output_capability=V4L2_PIX_FMT_H264;</span><br><span class="line">        eCompressionFormat = OMX_VIDEO_CodingAVC;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_H264;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line">        m_frame_parser.init_nal_length(nal_length);</span><br><span class="line">......</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯hevc/h265...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.hevc"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.hevc"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_HEVC;</span><br><span class="line">        output_capability=V4L2_PIX_FMT_HEVC;</span><br><span class="line">        eCompressionFormat = (OMX_VIDEO_CODINGTYPE)QOMX_VIDEO_CodingHevc;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_HEVC;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line">        m_frame_parser.init_nal_length(nal_length);</span><br><span class="line">...</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯vc1...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.vc1"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.vc1"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_VC1;</span><br><span class="line">        eCompressionFormat = OMX_VIDEO_CodingWMV;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_VC1;</span><br><span class="line">        output_capability = V4L2_PIX_FMT_VC1_ANNEX_G;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯wmv...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.wmv"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.vc1"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        drv_ctx.decoder_format = VDEC_CODECTYPE_VC1_RCV;</span><br><span class="line">        eCompressionFormat = OMX_VIDEO_CodingWMV;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_VC1;</span><br><span class="line">        output_capability = V4L2_PIX_FMT_VC1_ANNEX_L;</span><br><span class="line">        m_frame_parser.init_start_codes (codec_type_parse);</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯vp8...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drv_ctx.kind, <span class="string">"OMX.qcom.video.decoder.vp8"</span>,\</span><br><span class="line">                OMX_MAX_STRINGNAME_SIZE)) &#123;</span><br><span class="line">        strlcpy((<span class="keyword">char</span> *)m_cRole, <span class="string">"video_decoder.vp8"</span>,OMX_MAX_STRINGNAME_SIZE);</span><br><span class="line">        output_capability=V4L2_PIX_FMT_VP8;</span><br><span class="line">        eCompressionFormat = OMX_VIDEO_CodingVPX;</span><br><span class="line">        codec_type_parse = CODEC_TYPE_VP8;</span><br><span class="line">        arbitrary_bytes = <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ä¸è®¤è¯†çš„è§£ç ç»„ä»¶ï¼Œåˆ™æŠ¥é”™</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DEBUG_PRINT_ERROR(<span class="string">"ERROR:Unknown Component"</span>);</span><br><span class="line">        eRet = OMX_ErrorInvalidComponentName;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//å¦‚æœé”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (eRet == OMX_ErrorNone) &#123;</span><br><span class="line"><span class="comment">//è®¾ç½®è§†é¢‘è¾“å‡ºç¼–ç æ ¼å¼ä¸ºYUVçš„ä¸€ç§</span></span><br><span class="line">        drv_ctx.output_format = VDEC_YUV_FORMAT_NV12;</span><br><span class="line">        <span class="comment">//è®¾ç½®é¢œè‰²ç¼–ç </span></span><br><span class="line">        OMX_COLOR_FORMATTYPE dest_color_format = (OMX_COLOR_FORMATTYPE)</span><br><span class="line">            QOMX_COLOR_FORMATYUV420PackedSemiPlanar32m;</span><br><span class="line">        <span class="keyword">if</span> (!client_buffers.set_color_format(dest_color_format)) &#123;</span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"Setting color format failed"</span>);</span><br><span class="line">            eRet = OMX_ErrorInsufficientResources;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//è®¢é˜…äº‹ä»¶</span></span><br><span class="line">        capture_capability= V4L2_PIX_FMT_NV12;</span><br><span class="line">        ret = subscribe_to_events(drv_ctx.video_driver_fd);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"Subscribe Event Failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> OMX_ErrorInsufficientResources;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_capability</span> <span class="title">cap</span>;</span></span><br><span class="line">        <span class="comment">//è®¾ç½®æŸ¥è¯¢èƒ½åŠ›æ ‡å¿—ä½</span></span><br><span class="line">        ret = ioctl(drv_ctx.video_driver_fd, VIDIOC_QUERYCAP, &amp;cap);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"Failed to query capabilities"</span>);</span><br><span class="line">            <span class="comment">/*<span class="doctag">TODO:</span> How to handle this case */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            DEBUG_PRINT_HIGH(<span class="string">"Capabilities: driver_name = %s, card = %s, bus_info = %s,"</span></span><br><span class="line">                    <span class="string">" version = %d, capabilities = %x"</span>, cap.driver, cap.card,</span><br><span class="line">                    cap.bus_info, cap.version, cap.capabilities);</span><br><span class="line">        &#125;</span><br><span class="line">        ret=<span class="number">0</span>;</span><br><span class="line">        fdesc.type=V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br><span class="line">        fdesc.index=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (ioctl(drv_ctx.video_driver_fd, VIDIOC_ENUM_FMT, &amp;fdesc) == <span class="number">0</span>) &#123;</span><br><span class="line">            DEBUG_PRINT_HIGH(<span class="string">"fmt: description: %s, fmt: %x, flags = %x"</span>, fdesc.description,</span><br><span class="line">                    fdesc.pixelformat, fdesc.flags);</span><br><span class="line">            fdesc.index++;</span><br><span class="line">        &#125;</span><br><span class="line">        fdesc.type=V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE;</span><br><span class="line">        fdesc.index=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (ioctl(drv_ctx.video_driver_fd, VIDIOC_ENUM_FMT, &amp;fdesc) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            DEBUG_PRINT_HIGH(<span class="string">"fmt: description: %s, fmt: %x, flags = %x"</span>, fdesc.description,</span><br><span class="line">                    fdesc.pixelformat, fdesc.flags);</span><br><span class="line">            fdesc.index++;</span><br><span class="line">        &#125;</span><br><span class="line">        update_resolution(<span class="number">320</span>, <span class="number">240</span>);</span><br><span class="line">        fmt.type = V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE;</span><br><span class="line">        fmt.fmt.pix_mp.height = drv_ctx.video_resolution.frame_height;</span><br><span class="line">        fmt.fmt.pix_mp.width = drv_ctx.video_resolution.frame_width;</span><br><span class="line">        fmt.fmt.pix_mp.pixelformat = output_capability;</span><br><span class="line">        ret = ioctl(drv_ctx.video_driver_fd, VIDIOC_S_FMT, &amp;fmt);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            <span class="comment">/*<span class="doctag">TODO:</span> How to handle this case */</span></span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"Failed to set format on output port"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        DEBUG_PRINT_HIGH(<span class="string">"Set Format was successful"</span>);</span><br><span class="line">        <span class="comment">//å¦‚æœæœ‰æ­§ä¹‰çš„è§£ç ç»„ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (codec_ambiguous) &#123;</span><br><span class="line">            <span class="keyword">if</span> (output_capability == V4L2_PIX_FMT_DIVX) &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_control</span> <span class="title">divx_ctrl</span>;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (drv_ctx.decoder_format == VDEC_CODECTYPE_DIVX_4) &#123;</span><br><span class="line">                    divx_ctrl.value = V4L2_MPEG_VIDC_VIDEO_DIVX_FORMAT_4;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (drv_ctx.decoder_format == VDEC_CODECTYPE_DIVX_5) &#123;</span><br><span class="line">                    divx_ctrl.value = V4L2_MPEG_VIDC_VIDEO_DIVX_FORMAT_5;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    divx_ctrl.value = V4L2_MPEG_VIDC_VIDEO_DIVX_FORMAT_6;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                divx_ctrl.id = V4L2_CID_MPEG_VIDC_VIDEO_DIVX_FORMAT;</span><br><span class="line">                ret = ioctl(drv_ctx.video_driver_fd, VIDIOC_S_CTRL, &amp;divx_ctrl);</span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                    DEBUG_PRINT_ERROR(<span class="string">"Failed to set divx version"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                DEBUG_PRINT_ERROR(<span class="string">"Codec should not be ambiguous"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//è§£ç ç›¸å…³å‚æ•°è®¾ç½®</span></span><br><span class="line">        fmt.type = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br><span class="line">        fmt.fmt.pix_mp.height = drv_ctx.video_resolution.frame_height;</span><br><span class="line">        fmt.fmt.pix_mp.width = drv_ctx.video_resolution.frame_width;</span><br><span class="line">        fmt.fmt.pix_mp.pixelformat = capture_capability;</span><br><span class="line">        ret = ioctl(drv_ctx.video_driver_fd, VIDIOC_S_FMT, &amp;fmt);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            <span class="comment">/*<span class="doctag">TODO:</span> How to handle this case */</span></span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"Failed to set format on capture port"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        DEBUG_PRINT_HIGH(<span class="string">"Set Format was successful"</span>);</span><br><span class="line">        <span class="keyword">if</span> (secure_mode) &#123;</span><br><span class="line">            control.id = V4L2_CID_MPEG_VIDC_VIDEO_SECURE;</span><br><span class="line">            control.value = <span class="number">1</span>;</span><br><span class="line">            DEBUG_PRINT_LOW(<span class="string">"Omx_vdec:: calling to open secure device %d"</span>, ret);</span><br><span class="line">            ret=ioctl(drv_ctx.video_driver_fd, VIDIOC_S_CTRL,&amp;control);</span><br><span class="line">            <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                DEBUG_PRINT_ERROR(<span class="string">"Omx_vdec:: Unable to open secure device %d"</span>, ret);</span><br><span class="line">                close(drv_ctx.video_driver_fd);</span><br><span class="line">                <span class="keyword">return</span> OMX_ErrorInsufficientResources;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*Get the Buffer requirements for input and output ports*/</span></span><br><span class="line">        <span class="comment">//è·å¾—è¾“å…¥å’Œè¾“å‡ºçš„ç¼“å†²æ¡ä»¶</span></span><br><span class="line">        drv_ctx.ip_buf.buffer_type = VDEC_BUFFER_TYPE_INPUT;</span><br><span class="line">        drv_ctx.op_buf.buffer_type = VDEC_BUFFER_TYPE_OUTPUT;</span><br><span class="line">        <span class="keyword">if</span> (secure_mode) &#123;</span><br><span class="line">            drv_ctx.op_buf.alignment=SZ_1M;</span><br><span class="line">            drv_ctx.ip_buf.alignment=SZ_1M;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            drv_ctx.op_buf.alignment=SZ_4K;</span><br><span class="line">            drv_ctx.ip_buf.alignment=SZ_4K;</span><br><span class="line">        &#125;</span><br><span class="line">        drv_ctx.interlace = VDEC_InterlaceFrameProgressive;</span><br><span class="line">        drv_ctx.extradata = <span class="number">0</span>;</span><br><span class="line">        drv_ctx.picture_order = VDEC_ORDER_DISPLAY;</span><br><span class="line">        control.id = V4L2_CID_MPEG_VIDC_VIDEO_OUTPUT_ORDER;</span><br><span class="line">        control.value = V4L2_MPEG_VIDC_VIDEO_OUTPUT_ORDER_DISPLAY;</span><br><span class="line">        ret = ioctl(drv_ctx.video_driver_fd, VIDIOC_S_CTRL, &amp;control);</span><br><span class="line">        drv_ctx.idr_only_decoding = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        m_state = OMX_StateLoaded;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEFAULT_EXTRADATA</span></span><br><span class="line">        <span class="keyword">if</span> (eRet == OMX_ErrorNone &amp;&amp; !secure_mode)</span><br><span class="line">            enable_extradata(DEFAULT_EXTRADATA, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        eRet=get_buffer_req(&amp;drv_ctx.ip_buf);</span><br><span class="line">        DEBUG_PRINT_HIGH(<span class="string">"Input Buffer Size =%d"</span>,drv_ctx.ip_buf.buffer_size);</span><br><span class="line">        get_buffer_req(&amp;drv_ctx.op_buf);</span><br><span class="line">        <span class="comment">//å¦‚æœè§£ç å™¨æ ¼å¼æ˜¯h264æˆ–è€…hevc/h265</span></span><br><span class="line">        <span class="keyword">if</span> (drv_ctx.decoder_format == VDEC_CODECTYPE_H264 ||</span><br><span class="line">                drv_ctx.decoder_format == VDEC_CODECTYPE_HEVC) &#123;</span><br><span class="line">            h264_scratch.nAllocLen = drv_ctx.ip_buf.buffer_size;</span><br><span class="line">            h264_scratch.pBuffer = (OMX_U8 *)<span class="built_in">malloc</span> (drv_ctx.ip_buf.buffer_size);</span><br><span class="line">            h264_scratch.nFilledLen = <span class="number">0</span>;</span><br><span class="line">            h264_scratch.nOffset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (h264_scratch.pBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                DEBUG_PRINT_ERROR(<span class="string">"h264_scratch.pBuffer Allocation failed "</span>);</span><br><span class="line">                <span class="keyword">return</span> OMX_ErrorInsufficientResources;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//å¦‚æœè§£ç å™¨æ ¼å¼æ˜¯h264</span></span><br><span class="line">        <span class="keyword">if</span> (drv_ctx.decoder_format == VDEC_CODECTYPE_H264) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_frame_parser.mutils == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                m_frame_parser.mutils = <span class="keyword">new</span> H264_Utils();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (m_frame_parser.mutils == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    DEBUG_PRINT_ERROR(<span class="string">"parser utils Allocation failed "</span>);</span><br><span class="line">                    eRet = OMX_ErrorInsufficientResources;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    m_frame_parser.mutils-&gt;initialize_frame_checking_environment();</span><br><span class="line">                    m_frame_parser.mutils-&gt;allocate_rbsp_buffer (drv_ctx.ip_buf.buffer_size);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªh264æµçš„è§£æå™¨</span></span><br><span class="line">            h264_parser = <span class="keyword">new</span> h264_stream_parser();</span><br><span class="line">            <span class="keyword">if</span> (!h264_parser) &#123;</span><br><span class="line">                DEBUG_PRINT_ERROR(<span class="string">"ERROR: H264 parser allocation failed!"</span>);</span><br><span class="line">                eRet = OMX_ErrorInsufficientResources;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//æ‰“å¼€ä¸€ä¸ªç®¡é“ï¼Œè¯»å†™ç«¯ä¿å­˜è¿›fdsæ•°ç»„</span></span><br><span class="line">        <span class="keyword">if</span> (pipe(fds)) &#123;</span><br><span class="line">            DEBUG_PRINT_ERROR(<span class="string">"pipe creation failed"</span>);</span><br><span class="line">            eRet = OMX_ErrorInsufficientResources;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> temp1[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">if</span> (fds[<span class="number">0</span>] == <span class="number">0</span> || fds[<span class="number">1</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pipe (temp1)) &#123;</span><br><span class="line">                    DEBUG_PRINT_ERROR(<span class="string">"pipe creation failed"</span>);</span><br><span class="line">                    <span class="keyword">return</span> OMX_ErrorInsufficientResources;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//close (fds[0]);</span></span><br><span class="line">                <span class="comment">//close (fds[1]);</span></span><br><span class="line">                fds[<span class="number">0</span>] = temp1 [<span class="number">0</span>];</span><br><span class="line">                fds[<span class="number">1</span>] = temp1 [<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¾“å…¥/è¯»</span></span><br><span class="line">            m_pipe_in = fds[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">//è¾“å‡º/å†™</span></span><br><span class="line">            m_pipe_out = fds[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè°ƒç”¨omxå¼€å§‹å¤„ç†è§£ç ï¼Œå¹¶è¿›è¡Œi/oæ“ä½œ</span></span><br><span class="line">            r = pthread_create(&amp;msg_thread_id,<span class="number">0</span>,message_thread,<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                DEBUG_PRINT_ERROR(<span class="string">"component_init(): message_thread creation failed"</span>);</span><br><span class="line">                eRet = OMX_ErrorInsufficientResources;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//æ²¡æœ‰é”™è¯¯ï¼Œç„¶åæ”¶å°¾</span></span><br><span class="line">    <span class="keyword">if</span> (eRet != OMX_ErrorNone) &#123;</span><br><span class="line">        DEBUG_PRINT_ERROR(<span class="string">"Component Init Failed"</span>);</span><br><span class="line">        DEBUG_PRINT_HIGH(<span class="string">"Calling VDEC_IOCTL_STOP_NEXT_MSG"</span>);</span><br><span class="line">        (<span class="keyword">void</span>)ioctl(drv_ctx.video_driver_fd, VDEC_IOCTL_STOP_NEXT_MSG,</span><br><span class="line">                <span class="literal">NULL</span>);</span><br><span class="line">        DEBUG_PRINT_HIGH(<span class="string">"Calling close() on Video Driver"</span>);</span><br><span class="line">        close (drv_ctx.video_driver_fd);</span><br><span class="line">        drv_ctx.video_driver_fd = <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DEBUG_PRINT_HIGH(<span class="string">"omx_vdec::component_init() success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//memset(&amp;h264_mv_buff,0,sizeof(struct h264_mv_buffer));</span></span><br><span class="line">    <span class="keyword">return</span> eRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> è¿™ä¸ªæ˜¯è§£ç ç»„ä»¶çš„åˆå§‹åŒ–å®ç°ã€‚æˆ‘ä»¬èƒ½å¤Ÿçœ‹å‡ºå’ŒTIçš„å·®è·æŒºå¤§çš„ã€‚æ­¥éª¤å¤§æ¦‚å¦‚ä¸‹ï¼ˆmaybe wrongï¼‰ï¼š</p><p>â˜¯ æ‰“å¼€mediaç›¸å…³è®¾å¤‡æ–‡ä»¶<br>â˜¯ åˆ›å»ºä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ï¼Œæ‰§è¡Œasync_message_threadå‡½æ•°ï¼Œå¯¹è¾“å…¥ç«¯è¿›è¡Œè®¾ç½®<br>â˜¯ æ ¹æ®è§£ç å™¨roleåé…ç½®ç›¸å…³å±æ€§<br>â˜¯ å¯¹è§†é¢‘è§£ç ç›¸å…³åŸºæœ¬é…ç½®è¿›è¡Œè®¾ç½®<br>â˜¯ åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œç„¶åå†å¼€ä¸€ä¸ªä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè°ƒç”¨omxå¼€å§‹å¤„ç†è§£ç ï¼Œå¹¶è¿›è¡Œi/oæ“ä½œ</p><h4 id="ï¼ˆä¸‰ï¼‰ã€Androidä¸­OpenMaxçš„å®ç°"><a href="#ï¼ˆä¸‰ï¼‰ã€Androidä¸­OpenMaxçš„å®ç°" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Androidä¸­OpenMaxçš„å®ç°"></a>ï¼ˆä¸‰ï¼‰ã€Androidä¸­OpenMaxçš„å®ç°</h4><h5 id="3-1ã€android-MediaCodec-ACodec"><a href="#3-1ã€android-MediaCodec-ACodec" class="headerlink" title="3.1ã€android MediaCodec ACodec"></a>3.1ã€android MediaCodec ACodec</h5><h5 id="3-1-1ã€MediaCodec"><a href="#3-1-1ã€MediaCodec" class="headerlink" title="3.1.1ã€MediaCodec"></a>3.1.1ã€MediaCodec</h5><p>MediaCodecç±»å¯ç”¨äºè®¿é—®Androidåº•å±‚çš„åª’ä½“ç¼–è§£ç å™¨ï¼Œä¾‹å¦‚ï¼Œç¼–ç /è§£ç ç»„ä»¶ã€‚å®ƒæ˜¯Androidä¸ºå¤šåª’ä½“æ”¯æŒæä¾›çš„åº•å±‚æ¥å£çš„ä¸€éƒ¨åˆ†ï¼ˆé€šå¸¸ä¸MediaExtractor, MediaSync, MediaMuxer, MediaCrypto, MediaDrm, Image, Surface, ä»¥åŠAudioTrackä¸€èµ·ä½¿ç”¨ï¼‰ã€‚<br>ä»å¹¿ä¹‰ä¸Šè®²ï¼Œä¸€ä¸ªç¼–è§£ç å™¨é€šè¿‡å¤„ç†è¾“å…¥æ•°æ®æ¥äº§ç”Ÿè¾“å‡ºæ•°æ®ã€‚å®ƒé€šè¿‡å¼‚æ­¥æ–¹å¼å¤„ç†æ•°æ®ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ä¸€ç»„è¾“å…¥è¾“å‡ºbuffersã€‚åœ¨ç®€å•å±‚é¢ï¼Œè¯·æ±‚ï¼ˆæˆ–æ¥æ”¶ï¼‰åˆ°ä¸€ä¸ªç©ºçš„è¾“å…¥bufferï¼Œå‘é‡Œé¢å¡«æ»¡æ•°æ®å¹¶å°†å®ƒä¼ é€’ç»™ç¼–è§£ç å™¨å¤„ç†ã€‚è¿™ä¸ªç¼–è§£ç å™¨å°†ä½¿ç”¨å®Œè¿™äº›æ•°æ®å¹¶å‘æ‰€æœ‰ç©ºçš„è¾“å‡ºbufferä¸­çš„ä¸€ä¸ªå¡«å……è¿™äº›æ•°æ®ã€‚æœ€ç»ˆï¼Œè¯·æ±‚ï¼ˆæˆ–æ¥å—ï¼‰åˆ°ä¸€ä¸ªå¡«å……äº†æ•°æ®çš„buffer,å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„æ•°æ®å†…å®¹ï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨å®Œåå°†å…¶é‡Šæ”¾å›ç¼–è§£ç å™¨ã€‚</p><p>1ã€    Data Types<br>ç¼–è§£ç å™¨å¤„ç†ä¸‰ç§ç±»å‹çš„æ•°æ®ï¼šå‹ç¼©æ•°æ®ï¼ŒåŸå§‹éŸ³é¢‘æ•°æ®ï¼ŒåŸå§‹è§†é¢‘æ•°æ®ã€‚ä¸Šè¿°ä¸‰ç§æ•°æ®éƒ½å¯ä»¥é€šè¿‡ByteBuffersè¿›è¡Œå¤„ç†ï¼Œä½†éœ€è¦ä¸ºåŸå§‹è§†é¢‘æ•°æ®æä¾›ä¸€ä¸ªSurfaceæ¥æé«˜ç¼–è§£ç æ€§èƒ½ã€‚<br>ï¬    å‹ç¼©ç¼“å­˜ï¼ˆCompressed Buffersï¼‰ï¼šè¾“å…¥ç¼“å†²åŒº(è§£ç å™¨)å’Œè¾“å‡ºç¼“å†²åŒº(ç¼–ç å™¨)åŒ…å«å‹ç¼©æ•°æ®æ ¼å¼çš„ç±»å‹ã€‚<br>ï¬    åŸå§‹éŸ³é¢‘ç¼“å­˜ï¼ˆRaw Audio Buffersï¼‰ï¼šåŸå§‹éŸ³é¢‘ç¼“å†²åŒºåŒ…å«æ•´ä¸ªPCMéŸ³é¢‘å¸§æ•°æ®ã€‚<br>ï¬    åŸå§‹è§†é¢‘ç¼“å­˜ï¼ˆRaw Video Buffersï¼‰ï¼šByteBufferæ¨¡å¼è§†é¢‘ç¼“å†²åŒºæ ¹æ®ä»–ä»¬çš„é¢œè‰²æ ¼å¼å¸ƒå±€ã€‚è§†é¢‘ç¼–è§£ç å™¨å¯èƒ½æ”¯æŒä¸‰ç§ç±»å‹çš„è‰²å½©æ ¼å¼ï¼š1)ã€native raw video formatï¼šè¢«COLOR_FormatSurfaceæ ‡è®°ï¼Œå…¶å¯ä¸è¾“å…¥æˆ–è¾“å‡ºSurfaceä¸€èµ·ä½¿ç”¨ï¼›2)ã€flexible YUV buffersï¼ˆå¦‚COLOR_FormatYUV420Flexibleï¼‰ï¼Œå¯ä»¥ä¸è¾“å…¥/è¾“å‡ºSurfaceä¸€èµ·ä½¿ç”¨, ByteBufferæ¨¡å¼ä¸‹å¯ä»¥é€šè¿‡è°ƒç”¨getInput/OutputImage(int)æ–¹æ³•è¿›è¡Œä½¿ç”¨ï¼›3)ã€é€šå¸¸åªåœ¨ByteBufferæ¨¡å¼ä¸‹è¢«æ”¯æŒã€‚ç”±ä¾›åº”å•†æŒ‡å®šï¼Œå¯ä»¥ä½¿ç”¨ getInput/OutputImage(int)æ–¹æ³•ã€‚</p><p>2ã€States<br>åœ¨ç¼–è§£ç å™¨çš„ç”Ÿå‘½å‘¨æœŸå†…æœ‰ä¸‰ç§ç†è®ºçŠ¶æ€ï¼šåœæ­¢æ€-Stoppedã€æ‰§è¡Œæ€-Executingã€é‡Šæ”¾æ€-Releasedã€‚åœæ­¢çŠ¶æ€ï¼ˆStoppedï¼‰åŒ…æ‹¬äº†ä¸‰ç§å­çŠ¶æ€ï¼šæœªåˆå§‹åŒ–ï¼ˆUninitializedï¼‰ã€é…ç½®ï¼ˆConfiguredï¼‰ã€é”™è¯¯ï¼ˆErrorï¼‰ã€‚æ‰§è¡ŒçŠ¶æ€ï¼ˆExecutingï¼‰åœ¨æ¦‚å¿µä¸Šä¼šç»å†ä¸‰ç§å­çŠ¶æ€ï¼šåˆ·æ–°ï¼ˆFlushedï¼‰ã€è¿è¡Œï¼ˆRunningï¼‰ã€æµç»“æŸï¼ˆEnd-of-Streamï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-10-MediaCodec-states.png" alt="Alt text | center"></p><p>ä½¿ç”¨å·¥å‚æ–¹æ³•ä¹‹ä¸€åˆ›å»ºä¸€ä¸ªç¼–è§£ç å™¨çš„æ—¶å€™ï¼Œæ˜¯å¤„äºUninitializedçŠ¶æ€ã€‚é¦–å…ˆï¼Œéœ€è¦é€šè¿‡configure(â€¦)æ–¹æ³•é…ç½®å®ƒï¼Œä»¥æ­¤è¿›å…¥Configured çŠ¶æ€ã€‚ç„¶åï¼Œé€šè¿‡è°ƒç”¨start()æ–¹æ³•è½¬å…¥Executing çŠ¶æ€ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸‹å¯ä»¥é€šè¿‡ä¸Šè¿°bufferé˜Ÿåˆ—æ“ä½œè¿‡ç¨‹æ•°æ®ã€‚<br>è°ƒç”¨start()æ–¹æ³•åç«‹å³è¿›å…¥FlushedçŠ¶æ€ï¼Œæ­¤æ—¶ç¼–è§£ç å™¨æ‹¥æœ‰æ‰€æœ‰çš„ç¼“å­˜ã€‚ä¸€æ—¦ç¬¬ä¸€ä¸ªè¾“å…¥ç¼“å­˜è¢«ç§»å‡ºé˜Ÿåˆ—ï¼Œç¼–è§£ç å™¨å°±è½¬å…¥è¿è¡Œå­çŠ¶æ€ï¼Œè¿™ç§çŠ¶æ€å æ®äº†ç¼–è§£ç å™¨çš„å¤§éƒ¨åˆ†ç”Ÿå‘½å‘¨æœŸã€‚å½“å°†ä¸€ä¸ªå¸¦æœ‰end-of-stream markeræ ‡è®°çš„è¾“å…¥ç¼“å­˜å…¥é˜Ÿåˆ—æ—¶ï¼Œç¼–è§£ç å™¨å°†è½¬å…¥æµç»“æŸå­çŠ¶æ€ã€‚å¯åœ¨ExecutingçŠ¶æ€çš„ä»»ä½•æ—¶å€™é€šè¿‡è°ƒç”¨flush()ã€‚<br>è°ƒç”¨stop()æ–¹æ³•è¿”å›ç¼–è§£ç å™¨çš„Uninitialized çŠ¶æ€ï¼Œå› æ­¤è¿™ä¸ªç¼–è§£ç å™¨éœ€è¦å†æ¬¡configured ã€‚å½“ä½¿ç”¨å®Œç¼–è§£ç å™¨åï¼Œå¿…é¡»è°ƒç”¨release()æ–¹æ³•é‡Šæ”¾å…¶èµ„æºã€‚</p><p>3ã€Data Processing<br>æ¯ä¸€ä¸ªç¼–è§£ç å™¨åŒ…å«ä¸€ç»„è¾“å…¥å’Œè¾“å‡ºç¼“å­˜ï¼Œè¿™äº›ç¼“å­˜åœ¨APIè°ƒç”¨ä¸­é€šè¿‡buffer-IDè¿›è¡Œå¼•ç”¨ã€‚å½“æˆåŠŸè°ƒç”¨start()æ–¹æ³•åå®¢æˆ·ç«¯å°†ä¸ä¼šæ‹¥æœ‰è¾“å…¥æˆ–è¾“å‡ºbuffersã€‚åœ¨åŒæ­¥æ¨¡å¼ä¸‹ï¼Œé€šè¿‡è°ƒç”¨dequeueInput/OutputBuffer(â€¦) æ–¹æ³•ä»ç¼–è§£ç å™¨è·å¾—ä¸€ä¸ªè¾“å…¥æˆ–è¾“å‡ºbufferï¼›åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œå¯ä»¥é€šè¿‡MediaCodec.Callback.onInput/OutputBufferAvailable(â€¦)çš„å›è°ƒæ–¹æ³•è‡ªåŠ¨åœ°è·å¾—å¯ç”¨çš„buffersã€‚<br>åœ¨è·å¾—ä¸€ä¸ªè¾“å…¥buffeåï¼Œå¡«å……æ•°æ®ï¼Œåˆ©ç”¨queueInputBuffer/queueSecureInputBufferæ–¹æ³•å°†å…¶æäº¤ç»™ç¼–è§£ç å™¨ï¼Œä¸è¦æäº¤å¤šä¸ªå…·æœ‰ç›¸åŒæ—¶é—´æˆ³çš„è¾“å…¥bufersï¼ˆé™¤éå®ƒæ˜¯ä¹Ÿè¢«åŒæ ·æ ‡è®°çš„codec-specific dataï¼Œå› ä¸ºcodec-specific dataç¼“å†²çš„æ—¶é—´æˆ³æ— æ„ä¹‰ï¼‰ã€‚<br>a.    Asynchronous Processing using Buffers<br>    ä»Android 5.0å¼€å§‹ï¼Œé¦–é€‰çš„æ–¹æ³•æ˜¯è°ƒç”¨configureä¹‹å‰é€šè¿‡è®¾ç½®å›è°ƒå¼‚æ­¥åœ°å¤„ç†æ•°æ®ã€‚å¼‚æ­¥æ¨¡å¼ç¨å¾®æ”¹å˜äº†çŠ¶æ€è½¬æ¢æ–¹å¼ï¼Œå› ä¸ºå¿…é¡»åœ¨è°ƒç”¨flush()æ–¹æ³•åå†è°ƒç”¨start()æ–¹æ³•æ‰èƒ½ä½¿ç¼–è§£ç å™¨çš„çŠ¶æ€è½¬æ¢ä¸ºRunningå­çŠ¶æ€å¹¶å¼€å§‹æ¥æ”¶è¾“å…¥buffersã€‚åŒæ ·ï¼Œåˆå§‹è°ƒç”¨startæ–¹æ³•å°†ç¼–è§£ç å™¨çš„çŠ¶æ€ç›´æ¥å˜åŒ–ä¸ºRunning å­çŠ¶æ€å¹¶é€šè¿‡å›è°ƒæ–¹æ³•å¼€å§‹ä¼ é€’å¯ç”¨çš„è¾“å…¥buufersã€‚<br>b.    Synchronous Processing using Buffers<br>ä»Android 5.0å¼€å§‹ï¼Œå³ä½¿åœ¨åŒæ­¥æ¨¡å¼ä¸‹ä½¿ç”¨ç¼–è§£ç å™¨ï¼Œä¹Ÿåº”è¯¥é€šè¿‡getInput/OutputBuffer(int) å’Œ/æˆ– getInput/OutputImage(int) æ–¹æ³•æ£€ç´¢è¾“å…¥å’Œè¾“å‡ºbuffersã€‚</p><h5 id="3-1-2ã€ACodec"><a href="#3-1-2ã€ACodec" class="headerlink" title="3.1.2ã€ACodec"></a>3.1.2ã€ACodec</h5><p>1ã€ACodecæ¶ˆæ¯æœºåˆ¶ï¼š<br>ï¬    ACodecæœ‰ä¸€ä¸ªBaseStateå’Œæ´¾ç”Ÿå‡ºæ¥çš„å…¶ä»–Stateï¼Œå¦‚ UninitializedState, LoadedToIdleState, ExecutingStateç­‰ã€‚å½“æœ‰æ¶ˆæ¯è¿‡æ¥æ—¶ï¼Œå¦‚æœæ´¾ç”Ÿç±»æœ‰é‡å†™çš„æ–¹æ³•ï¼Œåˆ™ä¼šè°ƒåˆ°é‡å†™çš„æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šè°ƒåˆ°BaseStateçš„<br>ï¬    ACodecç»§æ‰¿è‡ªAHierarchicalStateMachineç±»ï¼Œè¯¥ç±»ç”¨äºå°†æ”¶åˆ°çš„æ¶ˆæ¯ä¼ é€’ç»™å“ªä¸ªstateã€‚<br>ï¬    ACodecæ”¶åˆ°çš„æ¶ˆæ¯åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯MediaCodecä¼ è¿‡æ¥çš„ï¼Œå¯¹åº”onMessageReceivedæ–¹æ³•ï¼›å¦ä¸€ç§æ˜¯OMX Componentä¼ è¿‡æ¥çš„ï¼Œå¯¹åº”onOMXMessageæ–¹æ³•ã€‚è€ŒonOMXMessageé‡Œé¢åˆåˆ†äº†4ç§æƒ…å†µæ¥è°ƒç”¨ä¸åŒçš„æ–¹æ³•ã€‚ï¼ˆEVENTã€EMPTY_BUFFER_DONEã€FILL_BUFFER_DONEå’ŒFRAME_RENDEREDï¼‰</p><p>2ã€MediaCodecä¸ACodecçš„é€šçŸ¥ï¼š<br>ï¬    OMXçš„ç»„ä»¶è§£ç ä¹‹åï¼ŒACodec::BaseState:: onOMXFillBufferDone (â€¦)ä¼šè¢«å›è°ƒï¼Œå»å–å¾—è§£ç åçš„æ•°æ®ã€‚ç„¶åä¼šåœ¨onOMXFillBufferDoneä¸­è°ƒç”¨notifyé€šçŸ¥MediaCodecï¼Œå‘ç»™MediaCodecçš„æ¶ˆæ¯å½¢å¦‚notify-&gt;setInt32(â€œwhatâ€, CodecBase::kWhatDrainThisBuffer);<br>ï¬    MediaCodecæ”¶åˆ°ACodecå‘çš„æ¶ˆæ¯ä¹‹åä¼šupdateBuffers(kPortIndexOutput, msg) è¿›è¡Œæ›´æ–°ï¼ŒåŒæ—¶è°ƒç”¨onOutputBufferAvailable()ä¸­é€šçŸ¥NuPlayer::Decoderæœ‰å¯ç”¨çš„output bufferã€‚</p><p>3ã€ACodecæœ‰ä¸‰ç§ç«¯å£æ¨¡å¼çŠ¶æ€ï¼Œå…¶ä¼šæ ¹æ®å½“å‰å¤„äºå“ªä¸ªçŠ¶æ€æ¥å†³å®šbufferå¦‚ä½•å¤„ç†ï¼š<br>ï¬    KEEP_BUFFERSï¼šå½“ACodecå¤„äºBaseStateæˆ–è€…æ”¶åˆ°OnInputBufferFilledæ¶ˆæ¯ä½†æ˜¯bufferé‡Œé¢æ²¡æœ‰å¡«å……æœ‰æ•ˆçš„æ•°æ®æ—¶ï¼ŒACodecæ¡æœ‰çš„bufferä¸ä¼šé€åˆ°OMX ç»„ä»¶ï¼›<br>ï¬    RESUBMIT_BUFFERSï¼šå½“ACodecå¤„äºExecutingStateæˆ–è€…å¤„äºOutputPortSettingChangedStateä½†æ˜¯å½“å‰æ˜¯inputå£çš„bufferæ—¶ï¼ŒACodecå°†æ¡æœ‰çš„bufferé€ç»™OMX ç»„ä»¶ï¼›<br>ï¬    FREE_BUFFERSï¼šå½“ACodecå¤„äºOutputPortSettingChangedStateå¹¶ä¸”å½“å‰æ˜¯outputå£çš„bufferæ—¶ï¼ŒACodecå°†æ¡æœ‰çš„buffer freeã€‚</p><p>4ã€stagefrightç±»çš„è°ƒç”¨å…³ç³»ï¼š<br>ï¬    OMXNodeInstanceè´Ÿè´£åˆ›å»ºå¹¶ç»´æŠ¤ä¸åŒçš„å®ä¾‹ï¼Œè¿™äº›å®ä¾‹ä»¥nodeä½œä¸ºå”¯ä¸€æ ‡è¯†ã€‚è¿™æ ·æ’­æ”¾å™¨ä¸­æ¯ä¸ªACodecåœ¨OMXæœåŠ¡ç«¯éƒ½å¯¹åº”æœ‰äº†è‡ªå·±çš„OMXNodeInstanceå®ä¾‹ã€‚<br>ï¬    OMXMasterç”¨æ¥ç»´æŠ¤åº•å±‚è½¯ç¡¬ä»¶è§£ç åº“ï¼Œæ ¹æ®OMXNodeInstanceä¸­æƒ³è¦çš„è§£ç å™¨æ¥åˆ›å»ºè§£ç å®ä½“ç»„ä»¶ã€‚<br>ï¬    OMXPluginBaseè´Ÿè´£åŠ è½½ç»„ä»¶åº“ï¼Œåˆ›å»ºç»„ä»¶å®ä¾‹ï¼Œç”±OMXMasterç®¡ç†ã€‚AndroidåŸç”Ÿæä¾›çš„ç»„ä»¶éƒ½æ˜¯ç”±SoftOMXPluginç±»æ¥ç®¡ç†ï¼Œè¿™ä¸ªç±»å°±æ˜¯ç»§æ‰¿è‡ªOMXPluginBaseã€‚ï¼ˆAndroidæºç æä¾›äº†ä¸€äº›è½¯ä»¶è§£ç å’Œç¼–ç çš„ç»„ä»¶ï¼Œå®ƒä»¬è¢«æŠ½è±¡ä¸ºSoftOMXComponentï¼‰<br>ï¬    OMXClientæ˜¯å®¢æˆ·ç«¯ç”¨æ¥ä¸OMX ILè¿›è¡Œé€šä¿¡çš„ã€‚<br>ï¬    å†…éƒ¨ç»“æ„CallbackDispatcherä½œç”¨æ˜¯ç”¨æ¥æ¥æ”¶å›è°ƒå‡½æ•°çš„æ¶ˆæ¯<br>ï¬    OMXNodeInstance + CallbackDispatcher = åˆä½œå®Œæˆä¸åŒå®ä¾‹çš„æ¶ˆæ¯å¤„ç†ä»»åŠ¡</p><p>5ã€ACodecåŒOMXNodeInstanceçš„æ¶ˆæ¯ä¼ é€’ï¼š<br>ï¬    ACodecå°†CodecObserver observerå¯¹è±¡é€šè¿‡omx-&gt;allocateNode()ä¼ é€’åˆ°OMXNodeInstanceã€‚<br>ï¬    OMXNodeInstanceå°†kCallbacks(OnEvent,OnEmptyBufferDone,OnFillBufferDone)ä¼ é€’ç»™OMX Component<br>ï¬    å½“OMX Componentæœ‰æ¶ˆæ¯notifyä¸Šæ¥æ—¶ï¼ŒOMXNodeInstanceæœ€å…ˆæ”¶åˆ°ï¼Œç„¶åè°ƒç”¨OMX.cppã€‚å°†æ¶ˆæ¯åœ¨OMX.cppé‡Œé¢å°†OMX Component threadè½¬æ¢åˆ°CallbackDispatcherçº¿ç¨‹ä¸­å¤„ç†ã€‚CallbackDispatcheråˆå°†æ¶ˆæ¯åè°ƒåˆ°OMXNodeInstance. æœ€åè°ƒç”¨CodecObserver çš„onMessage()å›åˆ°ACodecä¸­</p><p>6ã€    ACodecä¸OMXç»„ä»¶çš„å…³ç³»<br>ï¬    ACodec ï¼ŒCodecObserverå’ŒOMXNodeInstanceæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œç®€å•çš„å¯ä»¥ç†è§£å®ƒä»¬3ä¸ªæ„æˆäº†OpenMAX ILçš„ä¸€ä¸ªComponentï¼Œæ¯ä¸€ä¸ªnodeå°±æ˜¯ä¸€ä¸ªcodecåœ¨OMXæœåŠ¡ç«¯çš„æ ‡è¯†ã€‚å½“ç„¶è¿˜æœ‰CallbackDispatcherï¼Œç”¨äºå¤„ç†codecè¿‡æ¥çš„æ¶ˆæ¯ï¼Œé€šè¿‡å®ƒçš„post/loop/dispatchæ¥å‘èµ·æ¥æ”¶ï¼Œä»OMX.cppå‘é€æ¶ˆæ¯ï¼Œæœ€ç»ˆé€šè¿‡OMXNodeInstance::onMessage -&gt; CodecObserver::onMessage -&gt; ACodec::onMessageä¸€è·¯å¾€ä¸Šï¼Œå½“ç„¶æ¶ˆæ¯çš„æ¥æºæ˜¯å› ä¸ºæˆ‘ä»¬æœ‰å‘codecæ³¨å†ŒOMXNodeInstance::kCallbacksã€‚<br>ï¬    è€Œåœ¨OMXPluginBaseåˆ›å»ºç»„ä»¶å®ä¾‹çš„æ—¶å€™ï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ªcallbackç»™ç»„ä»¶ï¼Œè¿™ä¸ªcallbackç”¨äºæ¥æ”¶ç»„ä»¶çš„æ¶ˆæ¯ï¼Œå®ƒçš„å®ç°æ˜¯åœ¨OMXNodeInstance.cppä¸­ã€‚è€Œkcallbacksæ˜¯OMXNodeInstanceçš„é™æ€æˆå‘˜å˜é‡ï¼Œå®ƒå†…éƒ¨çš„ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆåˆ†åˆ«æŒ‡å‘äº†OMXNodeInstanceçš„ä¸‰ä¸ªé™æ€æ–¹æ³•ï¼Œä¹Ÿå³æ˜¯è¿™ä¸‰ä¸ªæ–¹æ³•ä¸ç»„ä»¶è¿›è¡Œç€æ¶ˆæ¯ä¼ é€’</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-11-OMX-allocateNode.png" alt="Alt text | center"></p><p>ï¬    å¯¹äºNuPlayeræ¥è¯´ï¼Œå®ƒå¹¶ä¸ç›´æ¥æ¥è§¦è§£ç ç»„ä»¶ï¼Œè€Œæ˜¯é€šè¿‡åˆ›å»ºACodecæ¥å’Œç»„ä»¶äº¤äº’ã€‚ACodeå†…éƒ¨æœ‰ä¸€ä¸ªidï¼Œè¿™ä¸ªidå¯¹åº”äºä¸€ä¸ªOMXNodeInstanceã€‚OMXå¯¹è±¡ä¸­ä¼šå¯¹äº§ç”Ÿçš„æ¯ä¸€ä¸ªOMXNodeInstanceåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„node_idã€‚æ¯ä¸€ä¸ªOMXNodeInstanceå†…éƒ¨åˆä¿å­˜ç€ç»„ä»¶å®ä¾‹çš„æŒ‡é’ˆã€OMX_HANDLETYPE mHandle;ã€‘ï¼Œé€šè¿‡è¿™ä¸ªæŒ‡é’ˆå°±å¯ä»¥å’Œç»„ä»¶è¿›è¡Œäº¤äº’ã€‚äº¤äº’çš„æµç¨‹ä¸ºï¼šACodec â†’ OMX â†’ OMXNodeInstance â†’ COMPONENTã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-12-NuPlayer-libstagefrighthw.png" alt="Alt text | center"></p><p>8ã€ç»„ä»¶çš„ç®¡ç†<br>ï¬    å¯¹ç»„ä»¶çš„ç®¡ç†å¯ä»¥æ€»ç»“ä¸ºï¼šé€šè¿‡OMXMasteråŠ è½½libstagefrighthw.soåº“æ–‡ä»¶ï¼Œåˆ›å»ºOMXPluginBaseã€å³åˆ›å»ºç»§æ‰¿æ­¤ç±»çš„ç»„ä»¶å¯¹è±¡ã€‘ï¼Œé€šè¿‡è¿™ä¸ªç±»æ¥ç®¡ç†ç»„ä»¶ã€‚<br>ï¬    Androidæºç æä¾›äº†ä¸€äº›è½¯ä»¶è§£ç å’Œç¼–ç çš„ç»„ä»¶ï¼Œå®ƒä»¬è¢«æŠ½è±¡ä¸ºSoftOMXComponentã€‚OMXPluginBaseæ‰®æ¼”è€…ç»„ä»¶çš„ç®¡ç†è€…ã€‚å®ƒè´Ÿè´£åŠ è½½ç»„ä»¶åº“ï¼Œåˆ›å»ºç»„ä»¶å®ä¾‹ã€‚è€ŒOMXMasteråˆ™ç®¡ç†ç€OMXPluginBaseï¼ŒAndroidåŸç”Ÿæä¾›çš„ç»„ä»¶éƒ½æ˜¯ç”±SoftOMXPluginç±»æ¥ç®¡ç†ï¼Œè¿™ä¸ªç±»å°±æ˜¯ç»§æ‰¿è‡ªOMXPluginBaseã€‚<br>ï¬    å¯¹äºå‚å•†æ¥è¯´ï¼Œå¦‚æœè¦å®ç°è‡ªå·±çš„ç»„ä»¶ç®¡ç†æ¨¡å—ï¼Œéœ€è¦é€šè¿‡ç»§æ‰¿å®ç°OMXPluginBaseï¼Œå¹¶å°†ä¹‹ç¼–è¯‘ä¸ºlibstagefrighthw.soã€‚åœ¨OMXMasterä¸­ä¼šåŠ è½½è¿™ä¸ªåº“æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨å…¶createOMXPluginæ–¹æ³•è·å¾—ä¸€ä¸ªOMXPluginBaseæŒ‡é’ˆï¼Œç„¶åå°†å…¶åŠ å…¥OMXPluginBaseåˆ—è¡¨ä»¥åŠä¸ç»„ä»¶åç›¸å…³çš„map ã€mPluginByComponentNameã€‘ä¸­ï¼Œåç»­éƒ½ä¼šé€šè¿‡OMXPluginBaseæ¥ç®¡ç†ç»„ä»¶ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-04-13-OMXMaster-addPlugin.png" alt="Alt text | center"></p><h5 id="3-2ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†"><a href="#3-2ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†" class="headerlink" title="3.2ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†"></a>3.2ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†</h5><p>æ•°æ®å¤„ç†è¯·å‚è€ƒï¼š <a href="http://zhoujinjian.cc/2018/06/06/Android%20Video%20System%EF%BC%882%EF%BC%89%EF%BC%9A%E9%9F%B3%E8%A7%86%E9%A2%91%E5%88%86%E7%A6%BBMediaExtractor%E3%80%81%E8%A7%A3%E7%A0%81Decoder%E3%80%81%E6%B8%B2%E6%9F%93Renderer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81%E9%9F%B3%E8%A7%86%E9%A2%91%E8%A7%A3%E7%A0%81%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86">éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†</a></p><h5 id="3-3ã€é«˜é€šå®ç°ï¼ˆå‚è€ƒé«˜é€šæ–‡æ¡£ï¼‰"><a href="#3-3ã€é«˜é€šå®ç°ï¼ˆå‚è€ƒé«˜é€šæ–‡æ¡£ï¼‰" class="headerlink" title="3.3ã€é«˜é€šå®ç°ï¼ˆå‚è€ƒé«˜é€šæ–‡æ¡£ï¼‰"></a>3.3ã€é«˜é€šå®ç°ï¼ˆå‚è€ƒé«˜é€šæ–‡æ¡£ï¼‰</h5><p><a href="https://createpoint.qti.qualcomm.com" target="_blank" rel="noopener">OpenMAX Integration Layer Video Encoder for Linux Androidï¼ˆé«˜é€šæ–‡æ¡£ï¼‰</a><br><a href="https://createpoint.qti.qualcomm.com" target="_blank" rel="noopener">OpenMAX Integration Layer Video Decoder for Linux Androidï¼ˆé«˜é€šæ–‡æ¡£ï¼‰</a></p><h4 id="ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="http://windrunnerlihuan.com/2016/12/15/Android%E5%A4%9A%E5%AA%92%E4%BD%93%E5%BC%80%E5%8F%91-%E4%BA%94-OpenMax%E7%AE%80%E4%BB%8B/" target="_blank" rel="noopener">Androidå¤šåª’ä½“å¼€å‘(äº”)â€”-OpenMaxç®€ä»‹</a><br><a href="http://windrunnerlihuan.com/2016/12/26/Android%E5%A4%9A%E5%AA%92%E4%BD%93%E5%BC%80%E5%8F%91-%E5%85%AD-Android%E4%B8%ADOpenMax%E7%9A%84%E5%AE%9E%E7%8E%B0-preview/" target="_blank" rel="noopener">Androidå¤šåª’ä½“å¼€å‘(å…­)â€”-Androidä¸­OpenMaxçš„å®ç°(preview)</a><br><a href="http://windrunnerlihuan.com/2016/12/29/Android%E5%A4%9A%E5%AA%92%E4%BD%93%E5%BC%80%E5%8F%91-%E4%B8%83-Android%E4%B8%ADOpenMax%E7%9A%84%E5%AE%9E%E7%8E%B0/" target="_blank" rel="noopener">Androidå¤šåª’ä½“å¼€å‘(ä¸ƒ)â€”-Androidä¸­OpenMaxçš„å®ç°</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">android ACodec MediaCodec NuPlayer flow - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">android MediaCodec ACodec - CSDNåšå®¢</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</title>
    <link href="http://zhoujinjian.cc/2018/08/30/Android%20Display%20System%EF%BC%885%EF%BC%89%EF%BC%9AAndroid%20Display%20System%20%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B9%8BDisplay%20Driver%20Architecture/"/>
    <id>http://zhoujinjian.cc/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/</id>
    <published>2018-08-29T16:00:00.000Z</published>
    <updated>2018-06-20T15:15:33.034Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/display.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p><a href="https://blog.csdn.net/eliot_shao/article/details/74926010" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - é«˜é€šAndroidå¹³å°-åº”ç”¨ç©ºé—´æ“ä½œframebuffer dump LCDæ€»ç»“ã€‘</a><br><a href="https://blog.csdn.net/u012719256/article/details/52096727" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  linux qcom LCD framworkã€‘</a><br><a href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  msm8610 lcd driver code analysisã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><p> ğŸŒ€ğŸŒ€ï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶</p><p>ã€Android Display System ç³»ç»Ÿåˆ†æç³»åˆ—ã€‘ï¼š<br>ã€Android Display Systemï¼ˆ1ï¼‰ï¼šAndroid 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL &amp;&amp; OpenGLã€‘<br>ã€Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc &amp;&amp; HWComposeræ¨¡å—åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architectureã€‘ </p><hr><p>è·¯å¾„ï¼š<br>kernel\msm-3.18\drivers\video\msm\mdss</p><p> MDSS driver software block diagram</p><ul><li>mdss_fb â†’ Top-level IOCTL/native framebufferinterface</li><li>mdss_mdp.c â†’ MDP resources(clocks/irq/bus-bw/power)</li><li>mdss_mdp_overlay â†’ Overlay/DMA top-levelAPI</li><li>mdss_mdp_ctl â†’ Controls the hardware abstraction to club the (LM + DSPP + Ping-pong +<br>interface)</li><li>mdss_mdp_pipe â†’ SRC pipe related handling</li><li>mdss_mdp_intf_cmd/mdss_mdp_intf_video/mdss_mdp_intf_writeback â†’ MDP panel<br>interface relatedhandling</li><li>mdss_mdp_pp â†’ Postprocessing related implementation</li><li>mdss_mdp_rotator â†’ Rotator APIs (overlay_set/overlay_playinterface)</li><li>mdss_mdp_pp.c â†’ Postprocessing relatedmaterial</li></ul><hr><p><strong>æ³¨ï¼š</strong>é¦–å…ˆè¯´æ˜ï¼Œç”±äºåšä¸»ä¸æ˜¯kernelå¼€å‘æ–¹å‘çš„ï¼Œå¯èƒ½ç†è§£ä¸å¤Ÿé€å½»ï¼Œè¿˜è¯·çœ‹å®˜è§è°…ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç†è§£Kernel DisplayåŸç†ã€‚ä¸ºäº†åŠ æ·±å¯¹æ˜¾ç¤ºå±å·¥ä½œåŸç†çš„ç†è§£ï¼Œé¦–å…ˆå…ˆçœ‹ä¸¤ä¸ªæ“ä½œLCDæ˜¾ç¤ºå±çš„ä¾‹å­<br>ç»ªè®ºï¼ˆæ€»ä½“æ¶æ„å›¾ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-01-Display-Architecture.png" alt="Alt text | center"></p><h4 id="ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"><a href="#ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"></a>ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ</h4><h5 id="1-1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"><a href="#1-1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ" class="headerlink" title="1.1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"></a>1.1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ</h5><h5 id="1-1-1ã€æºä»£ç "><a href="#1-1-1ã€æºä»£ç " class="headerlink" title="1.1.1ã€æºä»£ç "></a>1.1.1ã€æºä»£ç </h5><p><strong>panel_test.c</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fb.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"yellow_face.zif"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> fbfd = <span class="number">0</span>;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">vinfo</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">finfo</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_cmap</span> <span class="title">cmapinfo</span>;</span>  </span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> screensize = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">char</span> *fbp = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> location = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">int</span> b,g,r;  </span><br><span class="line">    <span class="comment">// Open the file for reading and writing  </span></span><br><span class="line">    fbfd = open(<span class="string">"/dev/graphics/fb0"</span>, O_RDWR,<span class="number">0</span>);                    <span class="comment">// æ‰“å¼€Frame Bufferè®¾å¤‡  </span></span><br><span class="line">    <span class="keyword">if</span> (fbfd &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error: cannot open framebuffer device.%x\n"</span>,fbfd);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The framebuffer device was opened successfully.\n"</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Get fixed screen information  </span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fbfd, FBIOGET_FSCREENINFO, &amp;finfo)) &#123;            <span class="comment">// è·å–è®¾å¤‡å›ºæœ‰ä¿¡æ¯  </span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error reading fixed information.\n"</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">2</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\ntype:0x%x\n"</span>, finfo.type );                            <span class="comment">// FrameBuffer ç±»å‹,å¦‚0ä¸ºè±¡ç´   </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"visual:%d\n"</span>, finfo.visual );                        <span class="comment">// è§†è§‰ç±»å‹ï¼šå¦‚çœŸå½©2ï¼Œä¼ªå½©3   </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"line_length:%d\n"</span>, finfo.line_length );        <span class="comment">// æ¯è¡Œé•¿åº¦  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\nsmem_start:0x%lx,smem_len:%u\n"</span>, finfo.smem_start, finfo.smem_len ); <span class="comment">// æ˜ è±¡RAMçš„å‚æ•°  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"mmio_start:0x%lx ,mmio_len:%u\n"</span>, finfo.mmio_start, finfo.mmio_len );  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">// Get variable screen information  </span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fbfd, FBIOGET_VSCREENINFO, &amp;vinfo)) &#123;            <span class="comment">// è·å–è®¾å¤‡å¯å˜ä¿¡æ¯  </span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error reading variable information.\n"</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">3</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%dx%d, %dbpp,xres_virtual=%d,yres_virtual=%dvinfo.xoffset=%d,vinfo.yoffset=%d\n"</span>, vinfo.xres, vinfo.yres, vinfo.bits_per_pixel,vinfo.xres_virtual,vinfo.yres_virtual,vinfo.xoffset,vinfo.yoffset);  </span><br><span class="line"></span><br><span class="line">screensize = finfo.line_length * vinfo.yres_virtual;</span><br><span class="line">    <span class="comment">// Map the device to memory é€šè¿‡mmapç³»ç»Ÿè°ƒç”¨å°†framebufferå†…å­˜æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´,å¹¶è¿”å›æ˜ å°„åçš„èµ·å§‹åœ°å€  </span></span><br><span class="line">    fbp = (<span class="keyword">char</span> *)mmap(<span class="number">0</span>, screensize, PROT_READ | PROT_WRITE, MAP_SHARED,fbfd, <span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">int</span>)fbp == <span class="number">-1</span>) &#123;  </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error: failed to map framebuffer device to memory.\n"</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">4</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The framebuffer device was mapped to memory successfully.\n"</span>);  </span><br><span class="line"><span class="comment">/***************exampel 1**********************/</span></span><br><span class="line">b = <span class="number">10</span>;</span><br><span class="line">g = <span class="number">100</span>;</span><br><span class="line">r = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">for</span> ( y = <span class="number">0</span>; y &lt; <span class="number">340</span>; y++ )</span><br><span class="line">        <span class="keyword">for</span> ( x = <span class="number">0</span>; x &lt; <span class="number">420</span>; x++ ) &#123; </span><br><span class="line">      </span><br><span class="line">         location = (x+<span class="number">100</span>) * (vinfo.bits_per_pixel/<span class="number">8</span>) + </span><br><span class="line">             (y+<span class="number">100</span>) * finfo.line_length; </span><br><span class="line">      </span><br><span class="line">         <span class="keyword">if</span> ( vinfo.bits_per_pixel == <span class="number">32</span> ) &#123;        <span class="comment">//          </span></span><br><span class="line">                        *(fbp + location) = b; <span class="comment">// Some blue  </span></span><br><span class="line">                        *(fbp + location + <span class="number">1</span>) = g;             <span class="comment">// A little green  </span></span><br><span class="line">                        *(fbp + location + <span class="number">2</span>) = r;             <span class="comment">// A lot of red  </span></span><br><span class="line">                        *(fbp + location + <span class="number">3</span>) = <span class="number">0</span>;     <span class="comment">// No transparency  </span></span><br><span class="line">         &#125;</span><br><span class="line">      </span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/*****************exampel 1********************/</span></span><br><span class="line"><span class="comment">/*****************exampel 2********************/</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> *pTemp = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)fbp;</span><br><span class="line"><span class="keyword">int</span> i, j;</span><br><span class="line"><span class="comment">//èµ·å§‹åæ ‡(x,y),ç»ˆç‚¹åæ ‡(right,bottom)</span></span><br><span class="line">x = <span class="number">400</span>;</span><br><span class="line">y = <span class="number">400</span>;</span><br><span class="line"><span class="keyword">int</span> right = <span class="number">700</span>;<span class="comment">//vinfo.xres;</span></span><br><span class="line"><span class="keyword">int</span> bottom = <span class="number">1000</span>;<span class="comment">//vinfo.yres;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=y; i&lt; bottom; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span>(j=x; j&lt;right; j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> data = yellow_face_data[(((i-y)  % <span class="number">128</span>) * <span class="number">128</span>) + ((j-x) %<span class="number">128</span>)];</span><br><span class="line">pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">2</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0xF800</span>) &gt;&gt; <span class="number">11</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0x7E0</span>) &gt;&gt; <span class="number">5</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line">pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">0</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/*****************exampel 2********************/</span></span><br><span class="line"><span class="comment">//noteï¼švinfo.xoffset =0 vinfo.yoffset =0 å¦åˆ™FBIOPAN_DISPLAYä¸æˆåŠŸ</span></span><br><span class="line"><span class="keyword">if</span> (ioctl(fbfd, FBIOPAN_DISPLAY, &amp;vinfo)) &#123;    </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error FBIOPAN_DISPLAY information.\n"</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">5</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">sleep(<span class="number">10</span>);</span><br><span class="line">munmap(fbp,finfo.smem_len);<span class="comment">//finfo.smem_len == screensize == finfo.line_length * vinfo.yres_virtual </span></span><br><span class="line">    close(fbfd);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Android.mk</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Copyright 2006-2014 The Android Open Source Project</span><br><span class="line"></span><br><span class="line">LOCAL_PATH:= $(call my-dir)</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES:= panel_test.c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOCAL_SHARED_LIBRARIES        := $(common_libs) libqdutils libdl liblog libbase libcutils</span><br><span class="line">LOCAL_C_INCLUDES              := $(common_includes) $(kernel_includes)</span><br><span class="line">LOCAL_ADDITIONAL_DEPENDENCIES := $(common_deps) $(kernel_deps)</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE := panel_test</span><br><span class="line"></span><br><span class="line">LOCAL_CFLAGS := -Werror</span><br><span class="line"></span><br><span class="line">include $(BUILD_EXECUTABLE)</span><br><span class="line"></span><br><span class="line">include $(call first-makefiles-under,$(LOCAL_PATH))</span><br></pre></td></tr></table></figure><p><strong>yellow_face.zif</strong><br><a href="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-yellow_face.zif" target="_blank" rel="noopener">yellow_face.zif</a></p><h5 id="1-1-2ã€ç¼–è¯‘æµ‹è¯•"><a href="#1-1-2ã€ç¼–è¯‘æµ‹è¯•" class="headerlink" title="1.1.2ã€ç¼–è¯‘æµ‹è¯•"></a>1.1.2ã€ç¼–è¯‘æµ‹è¯•</h5><p>ç¼–è¯‘ä¼šç”Ÿæˆpanel_testï¼Œç„¶åè¿›è¡Œæµ‹è¯•ã€‚</p><blockquote><p>æ³¨æ„äº‹é¡¹ï¼š<br>1ã€adb shell stop æ€æ‰surfaceflinger ä¹‹ååœ¨æµ‹è¯•ï¼›<br>2ã€è®¾ç½®èƒŒå…‰ echo 255 &gt; /sys/class/leds/lcd-backlight/brightness</p><p>1ã€è¿æ¥adb<br>2ã€adb push panel_test system/bin<br>3ã€è¿›å…¥adb shell<br>4ã€stop<br>5ã€echo 255 &gt; /sys/class/leds/lcd-backlight/brightness<br>6ã€system/bin/panel_test</p></blockquote><h5 id="1-1-3ã€æ˜¾ç¤ºæ•ˆæœ"><a href="#1-1-3ã€æ˜¾ç¤ºæ•ˆæœ" class="headerlink" title="1.1.3ã€æ˜¾ç¤ºæ•ˆæœ"></a>1.1.3ã€æ˜¾ç¤ºæ•ˆæœ</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-02-Qcom_FrameBuffer_test_.gif" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-03-yellow_face_zif_test.jpg" alt="Alt text | center"></p><h5 id="1-1-4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰"><a href="#1-1-4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰" class="headerlink" title="1.1.4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰"></a>1.1.4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰</h5><p><a href="https://www.youtube.com/watch?v=BUPPyR6VasI" target="_blank" rel="noopener">Android Frame Buffer and Screen Shots Tutorial</a><br><a href="https://www.youtube.com/watch?v=7n_hDZ6kHjc" target="_blank" rel="noopener">Mplayer on Android Through Chroot and Frame Buffer</a></p><h5 id="1-1-5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾"><a href="#1-1-5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾" class="headerlink" title="1.1.5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾"></a>1.1.5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-04-msm8x25-display-overview.png" alt="Alt text | center"></p><h4 id="ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ"><a href="#ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ" class="headerlink" title="ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ"></a>ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ</h4><p>FrameBufferé€šå¸¸ä½œä¸ºLCDæ§åˆ¶å™¨æˆ–è€…å…¶ä»–æ˜¾ç¤ºè®¾å¤‡çš„é©±åŠ¨ï¼ŒFrameBufferé©±åŠ¨æ˜¯ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œè®¾å¤‡èŠ‚ç‚¹æ˜¯/dev/fbXï¼ˆAndroid è®¾å¤‡ä¸º/dev/graphics/fb0ï¼‰ï¼Œä¸»è®¾å¤‡å·ä¸º29ï¼Œæ¬¡è®¾å¤‡å·é€’å¢ï¼Œç”¨æˆ·å¯ä»¥å°†Framebufferçœ‹æˆæ˜¯æ˜¾ç¤ºå†…å­˜çš„ä¸€ä¸ªæ˜ åƒï¼Œå°†å…¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œè€Œå†™æ“ä½œå¯ä»¥ç«‹å³ååº”åœ¨å±å¹•ä¸Šã€‚è¿™ç§æ“ä½œæ˜¯æŠ½è±¡çš„ï¼Œç»Ÿä¸€çš„ã€‚ç”¨æˆ·ä¸å¿…å…³å¿ƒç‰©ç†æ˜¾å­˜çš„ä½ç½®ã€æ¢é¡µæœºåˆ¶ç­‰ç­‰å…·ä½“ç»†èŠ‚ã€‚è¿™äº›éƒ½æ˜¯ç”±Framebufferè®¾å¤‡é©±åŠ¨æ¥å®Œæˆçš„ã€‚Framebufferè®¾å¤‡ä¸ºä¸Šå±‚åº”ç”¨ç¨‹åºæä¾›ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿä¸ºä¸‹ä¸€å±‚çš„ç‰¹å®šç¡¬ä»¶é©±åŠ¨æä¾›æ¥å£ï¼›é‚£äº›åº•å±‚ç¡¬ä»¶é©±åŠ¨éœ€è¦ç”¨åˆ°è¿™å„¿çš„æ¥å£æ¥å‘ç³»ç»Ÿå†…æ ¸æ³¨å†Œå®ƒä»¬è‡ªå·±ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-05-mdss-driver-architecture.png" alt="Alt text | center"></p><p>Linuxä¸­çš„PCIè®¾å¤‡å¯ä»¥å°†å…¶æ§åˆ¶å¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜ç©ºé—´ï¼Œè€Œåï¼Œå¯¹è¿™äº›æ§åˆ¶å¯„å­˜å™¨çš„è®¿é—®å˜æˆäº†å¯¹ç†å†…å­˜çš„è®¿é—®ï¼Œå› æ­¤ï¼Œè¿™äº›å¯„å­˜å™¨åˆè¢«ç§°ä¸ºâ€memioâ€ã€‚ä¸€æ—¦è¢«æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼ŒLinuxçš„æ™®é€šè¿›ç¨‹å°±å¯ä»¥é€šè¿‡mmapå°†è¿™äº›å†…å­˜I/Oæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è®¿é—®è¿™äº›å¯„å­˜å™¨äº†ã€‚</p><p>FrameBufferè®¾å¤‡å±äºå­—ç¬¦è®¾å¤‡ï¼Œé‡‡ç”¨äº†æ–‡ä»¶å±‚â€”é©±åŠ¨å±‚çš„æ¥å£æ–¹å¼ï¼ŒLinuxä¸ºå¸§ç¼“å†²è®¾å¤‡å®šä¹‰äº†é©±åŠ¨å±‚çš„æ¥å£fb_infoç»“æ„ï¼Œåœ¨æ–‡ä»¶å±‚ä¸Šï¼Œç”¨æˆ·è°ƒç”¨file_operationsçš„å‡½æ•°æ“ä½œï¼Œé—´æ¥è°ƒç”¨fb_infoä¸­çš„fb_opså‡½æ•°é›†æ¥æ“ä½œç¡¬ä»¶ã€‚</p><h5 id="2-1ã€-Framebufferæ•°æ®ç»“æ„"><a href="#2-1ã€-Framebufferæ•°æ®ç»“æ„" class="headerlink" title="2.1ã€ Framebufferæ•°æ®ç»“æ„"></a>2.1ã€ Framebufferæ•°æ®ç»“æ„</h5><h5 id="2-1-1ã€-fb-info"><a href="#2-1-1ã€-fb-info" class="headerlink" title="2.1.1ã€ fb_info"></a>2.1.1ã€ fb_info</h5><p>fb_infoæ˜¯Linuxä¸ºå¸§ç¼“å†²è®¾å¤‡å®šä¹‰çš„é©±åŠ¨å±‚æ¥å£ã€‚å®ƒä¸ä»…åŒ…å«äº†åº•å±‚å‡½æ•°ï¼Œè€Œä¸”è¿˜æœ‰è®°å½•è®¾å¤‡çŠ¶æ€çš„æ•°æ®ã€‚æ¯ä¸ªå¸§ç¼“å†²è®¾å¤‡éƒ½ä¸ä¸€ä¸ªfb_infoç»“æ„ç›¸å¯¹åº”ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;kernel\include\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> &#123;</span></span><br><span class="line"><span class="keyword">atomic_t</span> count;</span><br><span class="line"><span class="keyword">int</span> node;</span><br><span class="line"><span class="keyword">int</span> flags;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span><span class="comment">/* Lock for open/release/ioctl funcs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mm_lock</span>;</span><span class="comment">/* Lock for fb_mmap and smem_* fields */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">var</span>;</span><span class="comment">/* Current var */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">fix</span>;</span><span class="comment">/* Current fix */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_monspecs</span> <span class="title">monspecs</span>;</span><span class="comment">/* Current Monitor specs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">queue</span>;</span><span class="comment">/* Framebuffer event queue */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_pixmap</span> <span class="title">pixmap</span>;</span><span class="comment">/* Image hardware mapper */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_pixmap</span> <span class="title">sprite</span>;</span><span class="comment">/* Cursor hardware mapper */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_cmap</span> <span class="title">cmap</span>;</span><span class="comment">/* Current cmap */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">modelist</span>;</span>      <span class="comment">/* mode list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_videomode</span> *<span class="title">mode</span>;</span><span class="comment">/* current mode */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span><span class="comment">/* current file node */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_DEFERRED_IO</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> <span class="title">deferred_work</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_deferred_io</span> *<span class="title">fbdefio</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> *<span class="title">fbops</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span><span class="comment">/* This is the parent */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span><span class="comment">/* This is this fb device */</span></span><br><span class="line"><span class="keyword">int</span> class_flag;                    <span class="comment">/* private sysfs flags */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_TILEBLITTING</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_tile_ops</span> *<span class="title">tileops</span>;</span>    <span class="comment">/* Tile Blitting */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">char</span> __iomem *screen_base;<span class="comment">/* Virtual address */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> screen_size;<span class="comment">/* Amount of ioremapped VRAM or 0 */</span> </span><br><span class="line"><span class="keyword">void</span> *pseudo_palette;<span class="comment">/* Fake palette of 16 colors */</span> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FBINFO_STATE_RUNNING0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FBINFO_STATE_SUSPENDED1</span></span><br><span class="line">u32 state;<span class="comment">/* Hardware state i.e suspend */</span></span><br><span class="line"><span class="keyword">void</span> *fbcon_par;                <span class="comment">/* fbcon use-only private area */</span></span><br><span class="line"><span class="comment">/* From here on everything is device dependent */</span></span><br><span class="line"><span class="keyword">void</span> *par;</span><br><span class="line"><span class="comment">/* we need the PCI or similar aperture base/size not</span></span><br><span class="line"><span class="comment">   smem_start/size as smem_start may just be an object</span></span><br><span class="line"><span class="comment">   allocated inside the aperture so may not actually overlap */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">apertures_struct</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">aperture</span> &#123;</span></span><br><span class="line"><span class="keyword">resource_size_t</span> base;</span><br><span class="line"><span class="keyword">resource_size_t</span> size;</span><br><span class="line">&#125; ranges[<span class="number">0</span>];</span><br><span class="line">&#125; *apertures;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> skip_vt_switch; <span class="comment">/* no VT switch on suspend/resume required */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="2-1-2ã€fb-var-screeninfo"><a href="#2-1-2ã€fb-var-screeninfo" class="headerlink" title="2.1.2ã€fb_var_screeninfo"></a>2.1.2ã€fb_var_screeninfo</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-06-xres-yres.png" alt="Alt text | center"></p><p>fb_var_screeninfoï¼šç”¨äºè®°å½•ç”¨æˆ·å¯ä¿®æ”¹çš„æ˜¾ç¤ºæ§åˆ¶å™¨å‚æ•°ï¼ŒåŒ…æ‹¬å±å¹•åˆ†è¾¨ç‡ã€æ¯ä¸ªåƒç´ ç‚¹çš„æ¯”ç‰¹æ•°ç­‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\uapi\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> &#123;</span>  </span><br><span class="line">    __u32 xres;         <span class="comment">/* è¡Œå¯è§åƒç´ */</span>  </span><br><span class="line">    __u32 yres;         <span class="comment">/* åˆ—å¯è§åƒç´ */</span>  </span><br><span class="line">    __u32 xres_virtual; <span class="comment">/* è¡Œè™šæ‹Ÿåƒç´ */</span>  </span><br><span class="line">    __u32 yres_virtual; <span class="comment">/* åˆ—è™šæ‹Ÿåƒç´ */</span>  </span><br><span class="line">    __u32 xoffset;      <span class="comment">/* æ°´å¹³åç§»é‡*/</span>  </span><br><span class="line">    __u32 yoffset;      <span class="comment">/* å‚ç›´åç§»é‡*/</span>  </span><br><span class="line">    __u32 bits_per_pixel;<span class="comment">/*æ¯ä¸ªåƒç´ æ‰€å bitä½æ•°*/</span>  </span><br><span class="line">    __u32 grayscale;    <span class="comment">/* ç°è‰²åˆ»åº¦*/</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">red</span>;</span> <span class="comment">/* bitfield in fb mem if true color, */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">green</span>;</span>   <span class="comment">/* else only length is significant */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">blue</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">transp</span>;</span>  <span class="comment">/* transparency         */</span>    </span><br><span class="line">    __u32 nonstd;           <span class="comment">/* != 0 Non standard pixel format */</span>  </span><br><span class="line">    __u32 activate;         <span class="comment">/* see FB_ACTIVATE_*        */</span>  </span><br><span class="line">    __u32 height;           <span class="comment">/* å›¾åƒé«˜åº¦*/</span>  </span><br><span class="line">    __u32 width;            <span class="comment">/* å›¾åƒå®½åº¦*/</span>  </span><br><span class="line">    __u32 accel_flags;      <span class="comment">/* (OBSOLETE) see fb_info.flags */</span>  </span><br><span class="line">    __u32 pixclock;         <span class="comment">/* pixel clock in ps (pico seconds) */</span>  </span><br><span class="line">    __u32 left_margin;      <span class="comment">/* time from sync to picture    */</span>  </span><br><span class="line">    __u32 right_margin;     <span class="comment">/* time from picture to sync    */</span>  </span><br><span class="line">    __u32 upper_margin;     <span class="comment">/* time from sync to picture    */</span>  </span><br><span class="line">    __u32 lower_margin;  </span><br><span class="line">    __u32 hsync_len;        <span class="comment">/* length of horizontal sync    */</span>  </span><br><span class="line">    __u32 vsync_len;        <span class="comment">/* length of vertical sync  */</span>  </span><br><span class="line">    __u32 sync;         <span class="comment">/* see FB_SYNC_*        */</span>  </span><br><span class="line">    __u32 vmode;            <span class="comment">/* see FB_VMODE_*       */</span>  </span><br><span class="line">    __u32 rotate;           <span class="comment">/* angle we rotate counter clockwise */</span>  </span><br><span class="line">    __u32 reserved[<span class="number">5</span>];      <span class="comment">/* Reserved for future compatibility */</span>  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="2-1-3ã€fb-fix-screeninfo"><a href="#2-1-3ã€fb-fix-screeninfo" class="headerlink" title="2.1.3ã€fb_fix_screeninfo"></a>2.1.3ã€fb_fix_screeninfo</h5><p>fb_fix_screeninfoï¼šè®°å½•äº†ç”¨æˆ·ä¸èƒ½ä¿®æ”¹çš„æ˜¾ç¤ºæ§åˆ¶å™¨çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°æ˜¯åœ¨é©±åŠ¨åˆå§‹åŒ–æ—¶è®¾ç½®çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\uapi\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> &#123;</span></span><br><span class="line"><span class="keyword">char</span> id[<span class="number">16</span>];<span class="comment">/* identification string eg "TT Builtin" */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> smem_start;<span class="comment">/* Start of frame buffer mem */</span></span><br><span class="line"><span class="comment">/* (physical address) */</span></span><br><span class="line">__u32 smem_len;<span class="comment">/* Length of frame buffer mem */</span></span><br><span class="line">__u32 type;<span class="comment">/* see FB_TYPE_**/</span></span><br><span class="line">__u32 type_aux;<span class="comment">/* Interleave for interleaved Planes */</span></span><br><span class="line">__u32 visual;<span class="comment">/* see FB_VISUAL_**/</span> </span><br><span class="line">__u16 xpanstep;<span class="comment">/* zero if no hardware panning  */</span></span><br><span class="line">__u16 ypanstep;<span class="comment">/* zero if no hardware panning  */</span></span><br><span class="line">__u16 ywrapstep;<span class="comment">/* zero if no hardware ywrap    */</span></span><br><span class="line">__u32 line_length;<span class="comment">/* length of a line in bytes    */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> mmio_start;<span class="comment">/* Start of Memory Mapped I/O   */</span></span><br><span class="line"><span class="comment">/* (physical address) */</span></span><br><span class="line">__u32 mmio_len;<span class="comment">/* Length of Memory Mapped I/O  */</span></span><br><span class="line">__u32 accel;<span class="comment">/* Indicate to driver which*/</span></span><br><span class="line"><span class="comment">/*  specific chip/card we have*/</span></span><br><span class="line">__u16 capabilities;<span class="comment">/* see FB_CAP_**/</span></span><br><span class="line">__u16 reserved[<span class="number">2</span>];<span class="comment">/* Reserved for future compatibility */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>fb_opsæ˜¯æä¾›ç»™åº•å±‚è®¾å¤‡é©±åŠ¨çš„ä¸€ä¸ªæ¥å£ã€‚å½“æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªFrameBufferçš„æ—¶å€™ï¼Œå°±è¦ä¾ç…§Linux FrameBufferç¼–ç¨‹çš„å¥—è·¯ï¼Œå¡«å†™fb_opsç»“æ„ä½“ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> &#123;</span></span><br><span class="line"><span class="comment">/* open/release and usage marking */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="keyword">int</span> (*fb_open)(struct fb_info *info, <span class="keyword">int</span> user);</span><br><span class="line"><span class="keyword">int</span> (*fb_release)(struct fb_info *info, <span class="keyword">int</span> user);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* For framebuffers with strange non linear layouts or that do not</span></span><br><span class="line"><span class="comment"> * work with normal memory mapped access</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">ssize_t</span> (*fb_read)(struct fb_info *info, <span class="keyword">char</span> __user *buf,</span><br><span class="line">   <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos);</span><br><span class="line"><span class="keyword">ssize_t</span> (*fb_write)(struct fb_info *info, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span><br><span class="line">    <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* checks var and eventually tweaks it to something supported,</span></span><br><span class="line"><span class="comment"> * DO NOT MODIFY PAR */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_check_var)(struct fb_var_screeninfo *var, struct fb_info *info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* set the video mode according to info-&gt;var */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_set_par)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* set color register */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_setcolreg)(<span class="keyword">unsigned</span> regno, <span class="keyword">unsigned</span> red, <span class="keyword">unsigned</span> green,</span><br><span class="line">    <span class="keyword">unsigned</span> blue, <span class="keyword">unsigned</span> transp, struct fb_info *info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* set color registers in batch */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_setcmap)(struct fb_cmap *cmap, struct fb_info *info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* blank display */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_blank)(<span class="keyword">int</span> blank, struct fb_info *info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pan display */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_pan_display)(struct fb_var_screeninfo *var, struct fb_info *info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Draws a rectangle */</span></span><br><span class="line"><span class="keyword">void</span> (*fb_fillrect) (struct fb_info *info, <span class="keyword">const</span> struct fb_fillrect *rect);</span><br><span class="line"><span class="comment">/* Copy data from area to another */</span></span><br><span class="line"><span class="keyword">void</span> (*fb_copyarea) (struct fb_info *info, <span class="keyword">const</span> struct fb_copyarea *region);</span><br><span class="line"><span class="comment">/* Draws a image to the display */</span></span><br><span class="line"><span class="keyword">void</span> (*fb_imageblit) (struct fb_info *info, <span class="keyword">const</span> struct fb_image *image);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Draws cursor */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_cursor) (struct fb_info *info, struct fb_cursor *cursor);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Rotates the display */</span></span><br><span class="line"><span class="keyword">void</span> (*fb_rotate)(struct fb_info *info, <span class="keyword">int</span> angle);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* wait for blit idle, optional */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_sync)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* perform fb specific ioctl (optional) */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_ioctl)(struct fb_info *info, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* perform fb specific ioctl v2 (optional) - provides file param */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_ioctl_v2)(struct fb_info *info, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg, struct file *file);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Handle 32bit compat ioctl (optional) */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_compat_ioctl)(struct fb_info *info, <span class="keyword">unsigned</span> cmd,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Handle 32bit compat ioctl (optional) */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_compat_ioctl_v2)(struct fb_info *info, <span class="keyword">unsigned</span> cmd,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg, struct file *file);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* perform fb specific mmap */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_mmap)(struct fb_info *info, struct vm_area_struct *vma);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* get capability given var */</span></span><br><span class="line"><span class="keyword">void</span> (*fb_get_caps)(struct fb_info *info, struct fb_blit_caps *caps,</span><br><span class="line">    struct fb_var_screeninfo *var);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* teardown any resources to do with this framebuffer */</span></span><br><span class="line"><span class="keyword">void</span> (*fb_destroy)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* called at KDB enter and leave time to prepare the console */</span></span><br><span class="line"><span class="keyword">int</span> (*fb_debug_enter)(struct fb_info *info);</span><br><span class="line"><span class="keyword">int</span> (*fb_debug_leave)(struct fb_info *info);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="2-2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹"><a href="#2-2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹" class="headerlink" title="2.2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹"></a>2.2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹</h5><p>åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå†…æ ¸è°ƒç”¨æ‰€æœ‰æ³¨å†Œé©±åŠ¨ç¨‹åºçš„é©±åŠ¨ç¨‹åºåˆå§‹åŒ–å‡½æ•°ã€‚ ä¸ºäº†å¸§ç¼“å†²åŒºé©±åŠ¨ç¨‹åºï¼Œè°ƒç”¨mdss_fb_initã€‚ mdss_fb_initæ³¨å†Œmdss_fb_driverã€‚é©±åŠ¨åœ¨mdss_fb.cæ–‡ä»¶ä¸­æ³¨å†Œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdss_fb_driver</span> = &#123;</span></span><br><span class="line">.probe = mdss_fb_probe,</span><br><span class="line">.remove = mdss_fb_remove,</span><br><span class="line">.suspend = mdss_fb_suspend,</span><br><span class="line">.resume = mdss_fb_resume,</span><br><span class="line">.shutdown = mdss_fb_shutdown,</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = <span class="string">"mdss_fb"</span>,</span><br><span class="line">.of_match_table = mdss_fb_dt_match,</span><br><span class="line">.pm = &amp;mdss_fb_pm_ops,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨initä¹‹åï¼Œå†…æ ¸è°ƒç”¨æ¯ä¸ªå¹³å°é©±åŠ¨ç¨‹åºçš„æ¢æµ‹å‡½æ•°ã€‚ åœ¨è°ƒç”¨mdss_fb_probeæ—¶ï¼Œå‡½æ•°æ‰§è¡Œèµ„æºåˆ†é…å¹¶è°ƒç”¨mdss_fb_registerã€‚ å¯ä»¥æœ‰å¤šä¸ªå¸§ç¼“å†²åŒºï¼ˆfbï¼‰è®¾å¤‡ï¼ˆèŠ‚ç‚¹ï¼‰ã€‚ è¯¥é©±åŠ¨ç¨‹åºé€šè¿‡è°ƒç”¨mdss_fb_registeræ¥æ³¨å†Œå„ä¸ªfbè®¾å¤‡ï¼Œåè€…åˆè°ƒç”¨register_framebufferã€‚ HDMIå’Œä¸»æ˜¾ç¤ºå™¨æ˜¯å„ä¸ªfbè®¾å¤‡çš„ä¾‹å­ã€‚ ä»¥ä¸‹æ“ä½œå·²æ³¨å†Œï¼š</p><p>é¦–å…ˆçœ‹ä¸€ä¸‹mdss_fb_probe()å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_fb_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msm_fb_data_type</span> *<span class="title">mfd</span> = <span class="title">NULL</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fbi</span>;</span></span><br><span class="line"><span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">pdata = dev_get_platdata(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * alloc framebuffer info + par data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">fbi = framebuffer_alloc(<span class="keyword">sizeof</span>(struct msm_fb_data_type), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">mfd = (struct msm_fb_data_type *)fbi-&gt;par;</span><br><span class="line">mfd-&gt;key = MFD_KEY;</span><br><span class="line">mfd-&gt;fbi = fbi;</span><br><span class="line">mfd-&gt;panel_info = &amp;pdata-&gt;panel_info;</span><br><span class="line">mfd-&gt;panel.type = pdata-&gt;panel_info.type;</span><br><span class="line">mfd-&gt;panel.id = mfd-&gt;index;</span><br><span class="line">mfd-&gt;fb_page = MDSS_FB_NUM;</span><br><span class="line">mfd-&gt;index = fbi_list_index;</span><br><span class="line">mfd-&gt;mdp_fb_page_protection = MDP_FB_PAGE_PROTECTION_WRITECOMBINE;</span><br><span class="line"></span><br><span class="line">mfd-&gt;ext_ad_ctrl = <span class="number">-1</span>;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">platform_set_drvdata(pdev, mfd);</span><br><span class="line"></span><br><span class="line">rc = mdss_fb_register(mfd);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨framebuffer_alloc()å‡½æ•°è¿”å›ä¸€ä¸ªfb_info ç»“æ„ä½“ï¼Œç„¶åè°ƒç”¨mdss_fb_register(mfd)<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_fb_register</span><span class="params">(struct msm_fb_data_type *mfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> ret = -ENODEV;</span><br><span class="line"><span class="keyword">int</span> bpp;</span><br><span class="line"><span class="keyword">char</span> panel_name[<span class="number">20</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_info</span> *<span class="title">panel_info</span> = <span class="title">mfd</span>-&gt;<span class="title">panel_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fbi</span> = <span class="title">mfd</span>-&gt;<span class="title">fbi</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> *<span class="title">fix</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> *<span class="title">var</span>;</span></span><br><span class="line"><span class="keyword">int</span> *id;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fb info initialization</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">fix = &amp;fbi-&gt;fix;</span><br><span class="line">var = &amp;fbi-&gt;var;</span><br><span class="line"></span><br><span class="line">fix-&gt;type_aux = <span class="number">0</span>;<span class="comment">/* if type == FB_TYPE_INTERLEAVED_PLANES */</span></span><br><span class="line">fix-&gt;visual = FB_VISUAL_TRUECOLOR;<span class="comment">/* True Color */</span></span><br><span class="line">fix-&gt;ywrapstep = <span class="number">0</span>;<span class="comment">/* No support */</span></span><br><span class="line">fix-&gt;mmio_start = <span class="number">0</span>;<span class="comment">/* No MMIO Address */</span></span><br><span class="line">fix-&gt;mmio_len = <span class="number">0</span>;<span class="comment">/* No MMIO Address */</span></span><br><span class="line">fix-&gt;accel = FB_ACCEL_NONE;<span class="comment">/* FB_ACCEL_MSM needes to be added in fb.h */</span></span><br><span class="line"></span><br><span class="line">var-&gt;xoffset = <span class="number">0</span>,<span class="comment">/* Offset from virtual to visible */</span></span><br><span class="line">var-&gt;yoffset = <span class="number">0</span>,<span class="comment">/* resolution */</span></span><br><span class="line">var-&gt;grayscale = <span class="number">0</span>,<span class="comment">/* No graylevels */</span></span><br><span class="line">var-&gt;nonstd = <span class="number">0</span>,<span class="comment">/* standard pixel format */</span></span><br><span class="line">var-&gt;activate = FB_ACTIVATE_VBL,<span class="comment">/* activate it at vsync */</span></span><br><span class="line">var-&gt;height = <span class="number">-1</span>,<span class="comment">/* height of picture in mm */</span></span><br><span class="line">var-&gt;width = <span class="number">-1</span>,<span class="comment">/* width of picture in mm */</span></span><br><span class="line">var-&gt;accel_flags = <span class="number">0</span>,<span class="comment">/* acceleration flags */</span></span><br><span class="line">var-&gt;sync = <span class="number">0</span>,<span class="comment">/* see FB_SYNC_* */</span></span><br><span class="line">var-&gt;rotate = <span class="number">0</span>,<span class="comment">/* angle we rotate counter clockwise */</span></span><br><span class="line">mfd-&gt;op_enable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (mfd-&gt;fb_imgType) &#123;</span><br><span class="line"><span class="keyword">case</span> MDP_RGB_565:</span><br><span class="line">......</span><br><span class="line">var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">bpp = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> MDP_RGB_888:</span><br><span class="line">......</span><br><span class="line">var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">bpp = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> MDP_ARGB_8888:</span><br><span class="line">......</span><br><span class="line">var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">var-&gt;transp.length = <span class="number">8</span>;</span><br><span class="line">bpp = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> MDP_RGBA_8888:</span><br><span class="line">......</span><br><span class="line">var-&gt;transp.offset = <span class="number">24</span>;</span><br><span class="line">var-&gt;transp.length = <span class="number">8</span>;</span><br><span class="line">bpp = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> MDP_YCRYCB_H2V1:</span><br><span class="line">......</span><br><span class="line">var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">bpp = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mdss_panelinfo_to_fb_var(panel_info, var);</span><br><span class="line"></span><br><span class="line">fix-&gt;type = panel_info-&gt;is_3d_panel;</span><br><span class="line"><span class="keyword">if</span> (mfd-&gt;mdp.fb_stride)</span><br><span class="line">fix-&gt;line_length = mfd-&gt;mdp.fb_stride(mfd-&gt;index, var-&gt;xres,</span><br><span class="line">bpp);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">fix-&gt;line_length = var-&gt;xres * bpp;</span><br><span class="line"></span><br><span class="line">var-&gt;xres_virtual = var-&gt;xres;</span><br><span class="line">var-&gt;yres_virtual = panel_info-&gt;yres * mfd-&gt;fb_page;</span><br><span class="line">var-&gt;bits_per_pixel = bpp * <span class="number">8</span>;<span class="comment">/* FrameBuffer color depth */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Populate smem length here for uspace to get the</span></span><br><span class="line"><span class="comment"> * Framebuffer size when FBIO_FSCREENINFO ioctl is called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">fix-&gt;smem_len = PAGE_ALIGN(fix-&gt;line_length * var-&gt;yres) * mfd-&gt;fb_page;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* id field for fb app  */</span></span><br><span class="line">id = (<span class="keyword">int</span> *)&amp;mfd-&gt;panel;</span><br><span class="line"></span><br><span class="line"><span class="built_in">snprintf</span>(fix-&gt;id, <span class="keyword">sizeof</span>(fix-&gt;id), <span class="string">"mdssfb_%x"</span>, (u32) *id);</span><br><span class="line"></span><br><span class="line">fbi-&gt;fbops = &amp;mdss_fb_ops;</span><br><span class="line">fbi-&gt;flags = FBINFO_FLAG_DEFAULT;</span><br><span class="line">fbi-&gt;pseudo_palette = mdss_fb_pseudo_palette;</span><br><span class="line"></span><br><span class="line">mfd-&gt;ref_cnt = <span class="number">0</span>;</span><br><span class="line">mfd-&gt;panel_power_state = MDSS_PANEL_POWER_OFF;</span><br><span class="line">mfd-&gt;dcm_state = DCM_UNINIT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mdss_fb_alloc_fbmem(mfd))</span><br><span class="line">pr_warn(<span class="string">"unable to allocate fb memory in fb register\n"</span>);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">ret = fb_alloc_cmap(&amp;fbi-&gt;cmap, <span class="number">256</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line">pr_err(<span class="string">"fb_alloc_cmap() failed!\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (register_framebuffer(fbi) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">fb_dealloc_cmap(&amp;fbi-&gt;cmap);</span><br><span class="line">mfd-&gt;op_enable = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">snprintf</span>(panel_name, ARRAY_SIZE(panel_name), <span class="string">"mdss_panel_fb%d"</span>,</span><br><span class="line">mfd-&gt;index);</span><br><span class="line">mdss_panel_debugfs_init(panel_info, panel_name);</span><br><span class="line">pr_info(<span class="string">"FrameBuffer[%d] %dx%d registered successfully!\n"</span>, mfd-&gt;index,</span><br><span class="line">fbi-&gt;var.xres, fbi-&gt;var.yres);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»»ä½•ä¸€ä¸ªç‰¹å®šç¡¬ä»¶Framebufferé©±åŠ¨åœ¨åˆå§‹åŒ–æ—¶éƒ½å¿…é¡»å‘fbmem.cæ³¨å†Œï¼ŒFrameBufferæ¨¡å—æä¾›äº†é©±åŠ¨æ³¨å†Œæ¥å£å‡½æ•°register_framebufferï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\fbdev\core\fbmem.c]</span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">register_framebuffer(struct fb_info *fb_info)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;registration_lock);</span><br><span class="line">ret = do_register_framebuffer(fb_info);</span><br><span class="line">mutex_unlock(&amp;registration_lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°fb_infoæè¿°ç‰¹å®šç¡¬ä»¶çš„FrameBufferé©±åŠ¨ä¿¡æ¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\fbdev\core\fbmem.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_register_framebuffer</span><span class="params">(struct fb_info *fb_info)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> i;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_event</span> <span class="title">event</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_videomode</span> <span class="title">mode</span>;</span>  </span><br><span class="line">    <span class="keyword">if</span> (fb_check_foreignness(fb_info))  </span><br><span class="line">        <span class="keyword">return</span> -ENOSYS;  </span><br><span class="line">    <span class="comment">//æ ¹æ®å½“å‰æ³¨å†Œçš„fb_infoçš„apertureså±æ€§ä»FrameBufferé©±åŠ¨æ•°ç»„registered_fbä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨å†²çª  </span></span><br><span class="line">    do_remove_conflicting_framebuffers(fb_info-&gt;apertures, fb_info-&gt;fix.id,  </span><br><span class="line">                     fb_is_primary_device(fb_info));  </span><br><span class="line">    <span class="comment">//åˆ¤æ–­å·²æ³¨å†Œçš„é©±åŠ¨æ˜¯å¦è¶…è¿‡32ä¸ªFrameBufferé©±åŠ¨  </span></span><br><span class="line">    <span class="keyword">if</span> (num_registered_fb == FB_MAX)  </span><br><span class="line">        <span class="keyword">return</span> -ENXIO;  </span><br><span class="line">    <span class="comment">//å¢åŠ å·²æ³¨å†Œçš„é©±åŠ¨ä¸ªæ•°  </span></span><br><span class="line">    num_registered_fb++;  </span><br><span class="line">    <span class="comment">//ä»æ•°ç»„registered_fbä¸­æŸ¥æ‰¾ç©ºé—²å…ƒç´ ï¼Œç”¨äºå­˜å‚¨å½“å‰æ³¨å†Œçš„fb_info  </span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; FB_MAX; i++)  </span><br><span class="line">        <span class="keyword">if</span> (!registered_fb[i])  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">    <span class="comment">//å°†å½“å‰æ³¨å†Œçš„fb_infoåœ¨æ•°ç»„registered_fbä¸­çš„ç´¢å¼•ä½ç½®ä¿å­˜åˆ°fb_info-&gt;node  </span></span><br><span class="line">    fb_info-&gt;node = i;  </span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å½“å‰æ³¨å†Œçš„fb_infoçš„æˆå‘˜ä¿¡æ¯  </span></span><br><span class="line">    atomic_set(&amp;fb_info-&gt;count, <span class="number">1</span>);  </span><br><span class="line">    mutex_init(&amp;fb_info-&gt;lock);  </span><br><span class="line">    mutex_init(&amp;fb_info-&gt;mm_lock);  </span><br><span class="line">    <span class="comment">//åœ¨/devç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªfbxçš„è®¾å¤‡æ–‡ä»¶ï¼Œæ¬¡è®¾å¤‡å·å°±æ˜¯è¯¥fb_infoåœ¨æ•°ç»„registered_fbä¸­çš„ç´¢å¼•  </span></span><br><span class="line">    fb_info-&gt;dev = device_create(fb_class, fb_info-&gt;device,MKDEV(FB_MAJOR, i), <span class="literal">NULL</span>, <span class="string">"fb%d"</span>, i);  </span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(fb_info-&gt;dev)) &#123;  </span><br><span class="line">        printk(KERN_WARNING <span class="string">"Unable to create device for framebuffer %d; errno = %ld\n"</span>, i, PTR_ERR(fb_info-&gt;dev));  </span><br><span class="line">        fb_info-&gt;dev = <span class="literal">NULL</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span>  </span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–fb_info  </span></span><br><span class="line">        fb_init_device(fb_info);  </span><br><span class="line">    <span class="keyword">if</span> (fb_info-&gt;pixmap.addr == <span class="literal">NULL</span>) &#123;  </span><br><span class="line">        fb_info-&gt;pixmap.addr = kmalloc(FBPIXMAPSIZE, GFP_KERNEL);  </span><br><span class="line">        <span class="keyword">if</span> (fb_info-&gt;pixmap.addr) &#123;  </span><br><span class="line">            fb_info-&gt;pixmap.size = FBPIXMAPSIZE;  </span><br><span class="line">            fb_info-&gt;pixmap.buf_align = <span class="number">1</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.scan_align = <span class="number">1</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.access_align = <span class="number">32</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.flags = FB_PIXMAP_DEFAULT;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;     </span><br><span class="line">    fb_info-&gt;pixmap.offset = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;pixmap.blit_x)  </span><br><span class="line">        fb_info-&gt;pixmap.blit_x = ~(u32)<span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;pixmap.blit_y)  </span><br><span class="line">        fb_info-&gt;pixmap.blit_y = ~(u32)<span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;modelist.prev || !fb_info-&gt;modelist.next)  </span><br><span class="line">        INIT_LIST_HEAD(&amp;fb_info-&gt;modelist);  </span><br><span class="line">    fb_var_to_videomode(&amp;mode, &amp;fb_info-&gt;var);  </span><br><span class="line">    fb_add_videomode(&amp;mode, &amp;fb_info-&gt;modelist);  </span><br><span class="line">    <span class="comment">//å°†ç‰¹å®šç¡¬ä»¶å¯¹åº”çš„fb_infoæ³¨å†Œåˆ°registered_fbæ•°ç»„ä¸­  </span></span><br><span class="line">    registered_fb[i] = fb_info;  </span><br><span class="line">    event.info = fb_info;  </span><br><span class="line">    <span class="keyword">if</span> (!lock_fb_info(fb_info))  </span><br><span class="line">        <span class="keyword">return</span> -ENODEV;  </span><br><span class="line">    <span class="comment">//ä½¿ç”¨Linuxäº‹ä»¶é€šçŸ¥æœºåˆ¶å‘é€ä¸€ä¸ªFrameBufferæ³¨å†Œäº‹ä»¶FB_EVENT_FB_REGISTERED  </span></span><br><span class="line">    fb_notifier_call_chain(FB_EVENT_FB_REGISTERED, &amp;event);  </span><br><span class="line">    unlock_fb_info(fb_info);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œè¿‡ç¨‹å°±æ˜¯å°†æŒ‡å®šçš„è®¾å¤‡é©±åŠ¨ä¿¡æ¯fb_infoå­˜æ”¾åˆ°registered_fbæ•°ç»„ä¸­ã€‚å› æ­¤åœ¨æ³¨å†Œå…·ä½“çš„fb_infoæ—¶ï¼Œé¦–å…ˆè¦æ„é€ ä¸€ä¸ªfb_infoæ•°æ®ç»“æ„ï¼Œå¹¶åˆå§‹åŒ–è¯¥æ•°æ®ç»“æ„ï¼Œè¯¥ç»“æ„ç”¨äºæè¿°ä¸€ä¸ªç‰¹å®šçš„FrameBufferé©±åŠ¨ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-07-fb-device-create.jpg" alt="Alt text | center"></p><h4 id="ï¼ˆä¸‰ï¼‰ã€MDP-driver"><a href="#ï¼ˆä¸‰ï¼‰ã€MDP-driver" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€MDP driver"></a>ï¼ˆä¸‰ï¼‰ã€MDP driver</h4><p>MDPä¹Ÿè¢«æ³¨å†Œä¸ºå¹³å°é©±åŠ¨ç¨‹åºã€‚ mdp3_driver_initæ‰§è¡Œé©±åŠ¨ç¨‹åºinitã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdp3.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdp3_driver</span> = &#123;</span></span><br><span class="line">.probe = mdp3_probe,</span><br><span class="line">.remove = mdp3_remove,</span><br><span class="line">.suspend = mdp3_suspend,</span><br><span class="line">.resume = mdp3_resume,</span><br><span class="line">.shutdown = <span class="literal">NULL</span>,</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = <span class="string">"mdp3"</span>,</span><br><span class="line">.of_match_table = mdp3_dt_match,</span><br><span class="line">.pm             = &amp;mdp3_pm_ops,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">mdp3_driver_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">ret = platform_driver_register(&amp;mdp3_driver);</span><br><span class="line"><span class="keyword">if</span> (ret) &#123;</span><br><span class="line">pr_err(<span class="string">"register mdp3 driver failed!\n"</span>);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdp3_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> rc;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">msm_mdp_interface</span> <span class="title">mdp3_interface</span> = &#123;</span></span><br><span class="line">.init_fnc = mdp3_init,</span><br><span class="line">.fb_mem_get_iommu_domain = mdp3_fb_mem_get_iommu_domain,</span><br><span class="line">.panel_register_done = mdp3_panel_register_done,</span><br><span class="line">.fb_stride = mdp3_fb_stride,</span><br><span class="line">.check_dsi_status = mdp3_check_dsi_ctrl_status,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mdp3_intr_cb</span> <span class="title">underrun_cb</span> = &#123;</span></span><br><span class="line">.cb = mdp3_dma_underrun_intr_handler,</span><br><span class="line">.data = <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">pr_debug(<span class="string">"%s: START\n"</span>, __func__);</span><br><span class="line"><span class="keyword">if</span> (!pdev-&gt;dev.of_node) &#123;</span><br><span class="line">pr_err(<span class="string">"MDP driver only supports device tree probe\n"</span>);</span><br><span class="line"><span class="keyword">return</span> -ENOTSUPP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mdp3_res) &#123;</span><br><span class="line">pr_err(<span class="string">"MDP already initialized\n"</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mdp3_res = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(struct mdp3_hw_resource),</span><br><span class="line">GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (mdp3_res == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">pdev-&gt;id = <span class="number">0</span>;</span><br><span class="line">mdp3_res-&gt;pdev = pdev;</span><br><span class="line">mutex_init(&amp;mdp3_res-&gt;res_mutex);</span><br><span class="line">spin_lock_init(&amp;mdp3_res-&gt;irq_lock);</span><br><span class="line">platform_set_drvdata(pdev, mdp3_res);</span><br><span class="line">atomic_set(&amp;mdp3_res-&gt;active_intf_cnt, <span class="number">0</span>);</span><br><span class="line">mutex_init(&amp;mdp3_res-&gt;reg_bus_lock);</span><br><span class="line">INIT_LIST_HEAD(&amp;mdp3_res-&gt;reg_bus_clist);</span><br><span class="line"></span><br><span class="line">mdp3_res-&gt;mdss_util = mdss_get_util_intf();</span><br><span class="line"><span class="keyword">if</span> (mdp3_res-&gt;mdss_util == <span class="literal">NULL</span>) &#123;</span><br><span class="line">pr_err(<span class="string">"Failed to get mdss utility functions\n"</span>);</span><br><span class="line">rc =  -ENODEV;</span><br><span class="line"><span class="keyword">goto</span> get_util_fail;</span><br><span class="line">&#125;</span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;get_iommu_domain = mdp3_get_iommu_domain;</span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;iommu_attached = is_mdss_iommu_attached;</span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;iommu_ctrl = mdp3_iommu_ctrl;</span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;bus_scale_set_quota = mdp3_bus_scale_set_quota;</span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;panel_intf_type = mdp3_panel_intf_type;</span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;dyn_clk_gating_ctrl =</span><br><span class="line">mdp3_dynamic_clock_gating_ctrl;</span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;panel_intf_type = mdp3_panel_intf_type;</span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;panel_intf_status = mdp3_panel_get_intf_status;</span><br><span class="line">rc = mdp3_parse_dt(pdev);</span><br><span class="line"><span class="keyword">if</span> (rc)</span><br><span class="line"><span class="keyword">goto</span> probe_done;</span><br><span class="line"></span><br><span class="line">rc = mdp3_res_init();</span><br><span class="line"><span class="keyword">if</span> (rc) &#123;</span><br><span class="line">pr_err(<span class="string">"unable to initialize mdp3 resources\n"</span>);</span><br><span class="line"><span class="keyword">goto</span> probe_done;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mdp3_res-&gt;fs_ena = <span class="literal">false</span>;</span><br><span class="line">mdp3_res-&gt;fs = devm_regulator_get(&amp;pdev-&gt;dev, <span class="string">"vdd"</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR_OR_NULL(mdp3_res-&gt;fs)) &#123;</span><br><span class="line">pr_err(<span class="string">"unable to get mdss gdsc regulator\n"</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rc = mdp3_debug_init(pdev);</span><br><span class="line"><span class="keyword">if</span> (rc) &#123;</span><br><span class="line">pr_err(<span class="string">"unable to initialize mdp debugging\n"</span>);</span><br><span class="line"><span class="keyword">goto</span> probe_done;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pm_runtime_set_autosuspend_delay(&amp;pdev-&gt;dev, AUTOSUSPEND_TIMEOUT_MS);</span><br><span class="line"><span class="keyword">if</span> (mdp3_res-&gt;idle_pc_enabled) &#123;</span><br><span class="line">pr_debug(<span class="string">"%s: Enabling autosuspend\n"</span>, __func__);</span><br><span class="line">pm_runtime_use_autosuspend(&amp;pdev-&gt;dev);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Enable PM runtime */</span></span><br><span class="line">pm_runtime_set_suspended(&amp;pdev-&gt;dev);</span><br><span class="line">pm_runtime_enable(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pm_runtime_enabled(&amp;pdev-&gt;dev)) &#123;</span><br><span class="line">rc = mdp3_footswitch_ctrl(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (rc) &#123;</span><br><span class="line">pr_err(<span class="string">"unable to turn on FS\n"</span>);</span><br><span class="line"><span class="keyword">goto</span> probe_done;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rc = mdp3_check_version();</span><br><span class="line"><span class="keyword">if</span> (rc) &#123;</span><br><span class="line">pr_err(<span class="string">"mdp3 check version failed\n"</span>);</span><br><span class="line"><span class="keyword">goto</span> probe_done;</span><br><span class="line">&#125;</span><br><span class="line">rc = mdp3_register_sysfs(pdev);</span><br><span class="line"><span class="keyword">if</span> (rc)</span><br><span class="line">pr_err(<span class="string">"unable to register mdp sysfs nodes\n"</span>);</span><br><span class="line"></span><br><span class="line">rc = mdss_fb_register_mdp_instance(&amp;mdp3_interface);</span><br><span class="line"><span class="keyword">if</span> (rc)</span><br><span class="line">pr_err(<span class="string">"unable to register mdp instance\n"</span>);</span><br><span class="line"></span><br><span class="line">rc = mdp3_set_intr_callback(MDP3_INTR_LCDC_UNDERFLOW,</span><br><span class="line">&amp;underrun_cb);</span><br><span class="line"><span class="keyword">if</span> (rc)</span><br><span class="line">pr_err(<span class="string">"unable to configure interrupt callback\n"</span>);</span><br><span class="line"></span><br><span class="line">rc = mdss_smmu_init(mdss_res, &amp;pdev-&gt;dev);</span><br><span class="line"><span class="keyword">if</span> (rc)</span><br><span class="line">pr_err(<span class="string">"mdss smmu init failed\n"</span>);</span><br><span class="line"></span><br><span class="line">mdp3_res-&gt;mdss_util-&gt;mdp_probe_done = <span class="literal">true</span>;</span><br><span class="line">pr_debug(<span class="string">"%s: END\n"</span>, __func__);</span><br><span class="line"><span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…æ ¸è°ƒç”¨MDPæ¢æµ‹å‡½æ•°mdp3_probeã€‚ åœ¨æ¢æµ‹å™¨ä¸Šï¼Œé©±åŠ¨ç¨‹åºä»è®¾å¤‡æ ‘ä¸­è·å–é¢æ¿ä¿¡æ¯ï¼Œå¹¶é€šè¿‡è°ƒç”¨mdp3_parse_dtæ¥è§£æä¿¡æ¯ã€‚ åœ¨mdp3_ctrl_onæœŸé—´ï¼ŒMDPé©±åŠ¨ç¨‹åºè°ƒç”¨mdp3_ctrl_res_req_clkå¹¶è¯·æ±‚MDPå’ŒVsyncæ—¶é’Ÿã€‚ åœ¨mdp3_ctrl_offæœŸé—´ï¼Œé©±åŠ¨ç¨‹åºè¯·æ±‚å…³é—­MDPå’ŒVsyncæ—¶é’Ÿã€‚</p><h4 id="ï¼ˆå››ï¼‰ã€DSI-controller-driver-ï¼ˆlcdé©±åŠ¨-dsiï¼‰"><a href="#ï¼ˆå››ï¼‰ã€DSI-controller-driver-ï¼ˆlcdé©±åŠ¨-dsiï¼‰" class="headerlink" title="ï¼ˆå››ï¼‰ã€DSI controller driver ï¼ˆlcdé©±åŠ¨ dsiï¼‰"></a>ï¼ˆå››ï¼‰ã€DSI controller driver ï¼ˆlcdé©±åŠ¨ dsiï¼‰</h4><p>msm_dsi_v2_driver_initæ‰§è¡Œé©±åŠ¨ç¨‹åºåˆå§‹åŒ–ã€‚ msm_dsi_v2_driver_initè°ƒç”¨ msm_dsi_v2_register_driveræ³¨å†Œé©±åŠ¨ç¨‹åºã€‚<br>æ€»ä½“æ—¶åºå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-08-dsi-host-v2.png" alt="Alt text | center"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\dsi_host_v2.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">msm_dsi_v2_driver</span> = &#123;</span></span><br><span class="line">.probe = msm_dsi_probe,</span><br><span class="line">.remove = msm_dsi_remove,</span><br><span class="line">.shutdown = <span class="literal">NULL</span>,</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = <span class="string">"msm_dsi_v2"</span>,</span><br><span class="line">.of_match_table = msm_dsi_v2_dt_match,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm_dsi_v2_register_driver</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> platform_driver_register(&amp;msm_dsi_v2_driver);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm_dsi_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dsi_interface</span> <span class="title">intf</span>;</span></span><br><span class="line"><span class="keyword">char</span> panel_cfg[MDSS_MAX_PANEL_LEN];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mdss_dsi_ctrl_pdata</span> *<span class="title">ctrl_pdata</span> = <span class="title">NULL</span>;</span></span><br><span class="line"><span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">dsi_pan_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line"><span class="keyword">bool</span> cmd_cfg_cont_splash = <span class="literal">false</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">mdss_dsi_mres</span>;</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">pr_debug(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line"></span><br><span class="line">rc = msm_dsi_init();</span><br><span class="line"></span><br><span class="line">pdev-&gt;id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">ctrl_pdata = platform_get_drvdata(pdev);</span><br><span class="line"><span class="keyword">if</span> (!ctrl_pdata) &#123;</span><br><span class="line">ctrl_pdata = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line"><span class="keyword">sizeof</span>(struct mdss_dsi_ctrl_pdata), GFP_KERNEL);</span><br><span class="line">platform_set_drvdata(pdev, ctrl_pdata);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctrl_pdata-&gt;mdss_util = mdss_get_util_intf();</span><br><span class="line"><span class="keyword">if</span> (mdp3_res-&gt;mdss_util == <span class="literal">NULL</span>) &#123;</span><br><span class="line">pr_err(<span class="string">"Failed to get mdss utility functions\n"</span>);</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mdss_dsi_mres = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!mdss_dsi_mres) &#123;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">dsi_host_private-&gt;dsi_reg_size = resource_size(mdss_dsi_mres);</span><br><span class="line">dsi_host_private-&gt;dsi_base = ioremap(mdss_dsi_mres-&gt;start,</span><br><span class="line">dsi_host_private-&gt;dsi_reg_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mdss_dsi_mres = platform_get_resource(pdev, IORESOURCE_IRQ, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">rc = of_platform_populate(pdev-&gt;dev.of_node, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* DSI panels can be different between controllers */</span></span><br><span class="line">rc = dsi_get_panel_cfg(panel_cfg);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* find panel device node */</span></span><br><span class="line">dsi_pan_node = dsi_find_panel_of_node(pdev, panel_cfg);</span><br><span class="line"></span><br><span class="line">cmd_cfg_cont_splash = mdp3_panel_get_boot_cfg() ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">rc = mdss_dsi_panel_init(dsi_pan_node, ctrl_pdata, cmd_cfg_cont_splash);</span><br><span class="line"></span><br><span class="line">rc = dsi_ctrl_config_init(pdev, ctrl_pdata);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msm_dsi_parse_lane_swap(pdev-&gt;dev.of_node, &amp;(ctrl_pdata-&gt;dlane_swap));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>;  i &lt; DSI_MAX_PM; i++) &#123;</span><br><span class="line">rc = msm_dsi_io_init(pdev, &amp;(ctrl_pdata-&gt;power_data[i]));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pr_debug(<span class="string">"%s: Dsi Ctrl-&gt;0 initialized\n"</span>, __func__);</span><br><span class="line"></span><br><span class="line">dsi_host_private-&gt;dis_dev = pdev-&gt;dev;</span><br><span class="line">intf.on = msm_dsi_on;</span><br><span class="line">intf.off = msm_dsi_off;</span><br><span class="line">intf.cont_on = msm_dsi_cont_on;</span><br><span class="line">intf.clk_ctrl = msm_dsi_clk_ctrl;</span><br><span class="line">intf.op_mode_config = msm_dsi_op_mode_config;</span><br><span class="line">intf.index = <span class="number">0</span>;</span><br><span class="line">intf.<span class="keyword">private</span> = <span class="literal">NULL</span>;</span><br><span class="line">dsi_register_interface(&amp;intf);</span><br><span class="line"></span><br><span class="line">msm_dsi_debug_init();</span><br><span class="line"></span><br><span class="line">msm_dsi_ctrl_init(ctrl_pdata);</span><br><span class="line"></span><br><span class="line">rc = msm_dsi_irq_init(&amp;pdev-&gt;dev, mdss_dsi_mres-&gt;start,</span><br><span class="line">   ctrl_pdata);</span><br><span class="line"></span><br><span class="line">rc = dsi_panel_device_register_v2(pdev, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">pr_debug(<span class="string">"%s success\n"</span>, __func__);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…æ ¸è°ƒç”¨msm_dsi_probeã€‚ é¢æ¿è¢«æ£€æµ‹åˆ°ã€‚ msm_dsi_probeè°ƒç”¨mdss_dsi_panel_initå‡½æ•°ã€‚ mdss_dsi_panel_initè°ƒç”¨mdss_panel_parse_dtæ¥è·å–é¢æ¿å‚æ•°ã€‚<br>MDPé©±åŠ¨ç¨‹åºä½¿ç”¨è¯¥äº‹ä»¶ä¸DSIé©±åŠ¨ç¨‹åºè¿›è¡Œé€šä¿¡ã€‚ DSIé©±åŠ¨ç¨‹åºå…·æœ‰mdss_dsi_event_handlerï¼Œè¿™æ˜¯MDPæ ¸å¿ƒäº‹ä»¶çš„å›è°ƒå¤„ç†ç¨‹åºã€‚ mdss_panel.hå®šä¹‰äº†MDPæ ¸å¿ƒäº‹ä»¶ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_panel.h]</span><br><span class="line"><span class="keyword">enum</span> mdss_intf_events &#123;</span><br><span class="line">MDSS_EVENT_RESET = <span class="number">1</span>,</span><br><span class="line">MDSS_EVENT_LINK_READY,</span><br><span class="line">MDSS_EVENT_UNBLANK,</span><br><span class="line">MDSS_EVENT_PANEL_ON,</span><br><span class="line">MDSS_EVENT_POST_PANEL_ON,</span><br><span class="line">MDSS_EVENT_BLANK,</span><br><span class="line">MDSS_EVENT_PANEL_OFF,</span><br><span class="line">MDSS_EVENT_CLOSE,</span><br><span class="line">MDSS_EVENT_SUSPEND,</span><br><span class="line">MDSS_EVENT_RESUME,</span><br><span class="line">MDSS_EVENT_CHECK_PARAMS,</span><br><span class="line">MDSS_EVENT_CONT_SPLASH_BEGIN,</span><br><span class="line">MDSS_EVENT_CONT_SPLASH_FINISH,</span><br><span class="line">MDSS_EVENT_PANEL_UPDATE_FPS,</span><br><span class="line">MDSS_EVENT_FB_REGISTERED,</span><br><span class="line">MDSS_EVENT_PANEL_CLK_CTRL,</span><br><span class="line">MDSS_EVENT_DSI_CMDLIST_KOFF,</span><br><span class="line">MDSS_EVENT_ENABLE_PARTIAL_ROI,</span><br><span class="line">MDSS_EVENT_DSC_PPS_SEND,</span><br><span class="line">MDSS_EVENT_DSI_STREAM_SIZE,</span><br><span class="line">MDSS_EVENT_DSI_UPDATE_PANEL_DATA,</span><br><span class="line">MDSS_EVENT_REGISTER_RECOVERY_HANDLER,</span><br><span class="line">MDSS_EVENT_REGISTER_MDP_CALLBACK,</span><br><span class="line">MDSS_EVENT_DSI_PANEL_STATUS,</span><br><span class="line">MDSS_EVENT_DSI_DYNAMIC_SWITCH,</span><br><span class="line">MDSS_EVENT_DSI_RECONFIG_CMD,</span><br><span class="line">MDSS_EVENT_DSI_RESET_WRITE_PTR,</span><br><span class="line">MDSS_EVENT_PANEL_TIMING_SWITCH,</span><br><span class="line">MDSS_EVENT_MAX,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨msm_dsi_onæœŸé—´ï¼Œé€šè¿‡è°ƒç”¨msm_dsi_clk_enableæ‰“å¼€DSIæ—¶é’Ÿã€‚ åœ¨msm_dsi_offæœŸé—´ï¼Œé€šè¿‡è°ƒç”¨msm_dsi_clk_disableå…³é—­clksã€‚</p><h4 id="ï¼ˆäº”ï¼‰ã€-Panel-driver-ï¼ˆé¢æ¿-dsiï¼‰"><a href="#ï¼ˆäº”ï¼‰ã€-Panel-driver-ï¼ˆé¢æ¿-dsiï¼‰" class="headerlink" title="ï¼ˆäº”ï¼‰ã€ Panel driver ï¼ˆé¢æ¿ dsiï¼‰"></a>ï¼ˆäº”ï¼‰ã€ Panel driver ï¼ˆé¢æ¿ dsiï¼‰</h4><p>MDSS : Multimedia Display sub system<br>DSI: Display Serial Interface</p><blockquote><p>qcom,mdss-dsi-force-clock-lane-hs;          // faulse ï¼šclockæ¯å¸§å›lp11<br>ture: clockä¸å› qcom,mdss-dsi-hfp-power-mode;               // data æ¯è¡Œå›lp11,å¯¹åº”çš„hfpè¦ä¿®æ”¹æˆ300ä»¥ä¸Š</p></blockquote><p>é¢æ¿ä¿¡æ¯ä½äºkernel\arch\arm\boot\dts\ä¸­çš„.dtsiæ–‡ä»¶ä¸­ã€‚ è¿™åŒ…å«æ‰€æœ‰é¢æ¿ç‰¹å®šçš„å‘½ä»¤ï¼Œä¾‹å¦‚onï¼Œoffå’Œresetï¼ˆmdss-dsi-on-commandï¼Œmdss-dsi-off-commandï¼Œmdss-dsi-reset-sequenceï¼‰ï¼ŒBLæ§åˆ¶å’Œå…¶ä»–é¢æ¿ ç‹¬ç«‹å‚æ•°ã€‚<br>ä¾‹å¦‚ï¼š<br>msm8610-mdss.dtsi ï¼ˆæ–‡ä»¶åé€šå¸¸ä¸º msmxxx-mdss.dtsi æŒ‡å®šäº†mdss çš„ mdp å’Œ dsiï¼‰</p><h5 id="5-1ã€-dtsiæ–‡ä»¶è§£æ"><a href="#5-1ã€-dtsiæ–‡ä»¶è§£æ" class="headerlink" title="5.1ã€.dtsiæ–‡ä»¶è§£æ"></a>5.1ã€.dtsiæ–‡ä»¶è§£æ</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mdss_mdp: qcom,mdss_mdp@fd900000 &#123;</span><br><span class="line">            compatible = <span class="string">"qcom,mdss_mdp3"</span>;  <span class="comment">// å¯¹åº”mdssé©±åŠ¨ mdss_mdp.c</span></span><br><span class="line">----------</span><br><span class="line">  mdss_dsi0: qcom,mdss_dsi@fdd00000 &#123;</span><br><span class="line">        compatible = <span class="string">"qcom,msm-dsi-v2"</span>;      <span class="comment">// å¯¹åº”dsiè§£æé©±åŠ¨ dsi_host_v2.c</span></span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line"></span><br><span class="line">  mdss_dsi0: qcom,mdss_dsi_ctrl0@<span class="number">1</span>a94000 &#123;</span><br><span class="line">        compatible = <span class="string">"qcom,mdss-dsi-ctrl"</span>;  <span class="comment">// å¯¹åº”dsiè§£æé©±åŠ¨ mdss_dsi.c</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸‹é¢å‡½æ•°å‘ mdss_fb.c æ³¨å†Œäº†fb_infoç»“æ„  (åŒ…å«åœ¨mdss_dsi_ctrl_pdataç»“æ„ä¸­)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">drivers\video\msm\mdss\dsi_host_v2.c ï¼ˆlcdé©±åŠ¨ dsiï¼‰</span><br><span class="line">dsi_panel_device_register_v2(struct platform_device *dev,struct mdss_dsi_ctrl_pdata *ctrl_pdata)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static const struct of_device_id msm_dsi_v2_dt_match[] = &#123;</span><br><span class="line">    &#123;.compatible = &quot;qcom,msm-dsi-v2&quot;&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">æˆ–è€… </span><br><span class="line">drivers\video\msm\mdss\mdss_dsi.c</span><br></pre></td></tr></table></figure><p>msm8610-asus.dts ï¼ˆæŒ‡å®šmdpä¸­çš„å“ªä¸€ä¸ªé…ç½®ï¼‰<br>é€šå¸¸åœ¨dtsæ–‡ä»¶çš„ mdss_dsi0 labé‡Œé¢é€šè¿‡ qcom,dsi-pref-prim-pan å±æ€§ æŒ‡å®šä½¿ç”¨å“ªä¸€ä¸ªlcdé…ç½®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;mdss_dsi0 &#123;</span><br><span class="line">        qcom,dsi-pref-prim-pan = &lt;&amp;dsi_fl10802_fwvga_vid&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>dsi-panel-fl10802-fwvga-video.dtsi</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&amp;mdss_mdp &#123;</span><br><span class="line">    dsi_fl10802_fwvga_vid: qcom,mdss_dsi_fl10802_fwvga_video &#123;</span><br><span class="line">        qcom,mdss-dsi-panel-name = &quot;fl10802 fwvga video mode dsi panel&quot;;</span><br><span class="line">        qcom,mdss-dsi-drive-ic = &quot;fl10802&quot;;</span><br><span class="line">        qcom,mdss-dsi-panel-controller = &lt;&amp;mdss_dsi0&gt;;</span><br><span class="line">        qcom,mdss-dsi-panel-type = &quot;dsi_video_mode&quot;;</span><br><span class="line">        qcom,mdss-dsi-panel-destination = &quot;display_1&quot;;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h5 id="5-2ã€mdss-mdp-å’Œ-mdss-dsi0-çš„å…³ç³»"><a href="#5-2ã€mdss-mdp-å’Œ-mdss-dsi0-çš„å…³ç³»" class="headerlink" title="5.2ã€mdss_mdp å’Œ mdss_dsi0 çš„å…³ç³»"></a>5.2ã€mdss_mdp å’Œ mdss_dsi0 çš„å…³ç³»</h5><p>mdss_mdp ç›¸å½“äºä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢å®šä¹‰äº†å¾ˆå¤šä¸åŒlcdæ˜¾ç¤ºå±çš„é…ç½®é¡¹åŒ…æ‹¬åˆ†è¾¨ç‡ç­‰ç­‰</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-09-mdss_mdp-mdss_dsi0.jpg" alt="Alt text | center"></p><p>é¢æ¿é©±åŠ¨ç¨‹åºå¯ä»¥æ ¹æ®è¿æ¥çš„å®é™…é¢æ¿æ•°é‡å…·æœ‰å¤šä¸ªèŠ‚ç‚¹ã€‚<br>mdss_register_panelæ³¨å†Œé¢æ¿é©±åŠ¨ç¨‹åºï¼š<br>msm_dsi_probeâ†’dsi_panel_device_register_v2â†’mdss_register_panelâ†’<br>of_platform_device_create<br>ä»¥ä¸‹é¢æ¿æ§åˆ¶åŠŸèƒ½å¯ç”¨å¹¶åœ¨mdss_dsi_panel_initä¸­åˆå§‹åŒ–ï¼š<br>ctrl_pdataâ†’on = mdss_dsi_panel_on;<br>ctrl_pdataâ†’off = mdss_dsi_panel_off;<br>ctrl_pdataâ†’panel_data.set_backlight = mdss_dsi_panel_bl_ctrl;<br>  ä¾‹å¦‚ï¼Œåœ¨mdp3_ctrl.cä¸­ï¼Œå‡½æ•°mdp3_ctrl_onï¼ˆï¼‰ä¼šè°ƒç”¨ä»¥ä¸‹DSIå¤„ç†ç¨‹åº<br>MDSS_EVENT_UNBLANKå’ŒMDSS_EVENT_PANEL_ONäº‹ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š<br>rc = panelâ†’event_handlerï¼ˆpanelï¼ŒMDSS_EVENT_UNBLANKï¼ŒNULLï¼‰;<br>rc | =é¢æ¿â†’event_handlerï¼ˆé¢æ¿ï¼ŒMDSS_EVENT_PANEL_ONï¼ŒNULLï¼‰;</p><h5 id="5-3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨"><a href="#5-3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨" class="headerlink" title="5.3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨"></a>5.3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨</h5><h5 id="5-3-1ã€å¯åŠ¨"><a href="#5-3-1ã€å¯åŠ¨" class="headerlink" title="5.3.1ã€å¯åŠ¨"></a>5.3.1ã€å¯åŠ¨</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-10-display-subsystem-on-bootup.png" alt="Alt text | center"></p><p>æŒ‰ç…§ä¸Šé¢çš„éƒ¨åˆ†æ‰€è¿°æ³¨å†Œè®¾å¤‡åï¼š<br>mdss_fb_openâ†’mdss_fb_blank_subâ†’pdataâ†’onï¼ˆé¢æ¿ONåŠŸèƒ½ï¼‰<br>æ³¨æ„ï¼šå¯¹äºå‘½ä»¤æ¨¡å¼é¢æ¿ï¼Œå¦‚æœé¢æ¿åœ¨å¯åŠ¨æ—¶å·²æ‰“å¼€ï¼Œåˆ™ä¼šè·³è¿‡è¯¥å¯åŠ¨åºåˆ— ä»¥é¿å…å…³é—­/ -onçš„æ–‡ç‰©ã€‚</p><h5 id="5-3-2ã€æš‚åœ-æ¢å¤"><a href="#5-3-2ã€æš‚åœ-æ¢å¤" class="headerlink" title="5.3.2ã€æš‚åœ/æ¢å¤"></a>5.3.2ã€æš‚åœ/æ¢å¤</h5><p>æŒ‚èµ·/æ¢å¤æ—¶ï¼Œè°ƒç”¨fbé©±åŠ¨ç¨‹åºæŒ‚èµ·/æ¢å¤å’ŒMDPé©±åŠ¨ç¨‹åºæŒ‚èµ·/æ¢å¤ã€‚ fbé©±åŠ¨ç¨‹åºä¾æ¬¡è°ƒç”¨é¢æ¿é©±åŠ¨ç¨‹åºçš„å¼€/å…³åŠŸèƒ½ã€‚</p><h5 id="5-3-2-1ã€æš‚åœåºåˆ—"><a href="#5-3-2-1ã€æš‚åœåºåˆ—" class="headerlink" title="5.3.2.1ã€æš‚åœåºåˆ—"></a>5.3.2.1ã€æš‚åœåºåˆ—</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-11-suspend sequence.png" alt="Alt text | center"></p><p>Kernelcallâ†’mdss_fb_release_allâ†’mdss_fb_blankâ†’mdss_fb_blank_subâ†’mdp3_ctrl_offâ†’<br>mdp3_ctrl_offå‘é€ä¸¤ä¸ªäº‹ä»¶ï¼š</p><ol><li>MDSS_EVENT_PANEL_OFF - dsi_event_handleræ¥æ”¶äº‹ä»¶ã€‚ å½“äº‹ä»¶å‘ç”Ÿæ—¶<br>æ¥æ”¶åˆ°æ—¶ï¼Œè°ƒç”¨å°ç»„å…³é—­åºåˆ—ã€‚</li><li>MDSS_EVENT_BLANK - è¯¥äº‹ä»¶ç”±è°ƒç”¨çš„dsi_event_handlerå¤„ç†<br>mdss_dsi_offã€‚</li></ol><ul><li>Kernelcallâ†’mdp3_suspend - æœªä½¿ç”¨<h5 id="5-3-2-2ã€æ¢å¤åºåˆ—"><a href="#5-3-2-2ã€æ¢å¤åºåˆ—" class="headerlink" title="5.3.2.2ã€æ¢å¤åºåˆ—"></a>5.3.2.2ã€æ¢å¤åºåˆ—</h5></li></ul><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-12-resume sequence.png" alt="Alt text | center"></p><p>Kernelcallâ†’mdss_fb_blankâ†’mdss_fb_blank_subâ†’mdp3_ctrl_onâ†’<br>mdp3_ctrl_onå‘é€ä¸¤ä¸ªäº‹ä»¶ï¼š</p><ol><li>MDSS_EVENT_UNBLANK - dsi_event_handleræ¥æ”¶äº‹ä»¶ã€‚ å½“äº‹ä»¶å‘ç”Ÿæ—¶<br>æ”¶åˆ°ï¼ŒDSI-onè¢«è°ƒç”¨ã€‚</li><li>MDSS_EVENT_PANEL_ON - äº‹ä»¶ç”±dsi_event_handlerå¤„ç†ï¼Œdsi_event_handlerå‘é€<br>é¢æ¿ä¸Šçš„åºåˆ—ã€‚<br>Kernelcallâ†’mdp3_resume - æœªä½¿ç”¨</li></ol><h5 id="5-4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿"><a href="#5-4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿" class="headerlink" title="5.4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿"></a>5.4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-13-flow for display subsystem commit.png" alt="Alt text | center"></p><p> ç”¨æˆ·å¿…é¡»ç¡®ä¿MSMFB_OVERLAY_SET IOCTLåœ¨å‘¼å«ä¹‹å‰è‡³å°‘è¢«è°ƒç”¨ä¸€æ¬¡ åˆ°MSMFB_OVERLAY_PLAY IOCLTï¼ˆä¾‹å¦‚ioctl(fd, MSMFB_OVERLAY_PLAY, &amp;od)ï¼‰ã€‚MSMFB_OVERLAY_PLAYé˜Ÿåˆ—ç¼“å†²åŒº æ˜¾ç¤ºåœ¨é¢æ¿ä¸Šã€‚ ç”¨æˆ·ä½¿ç”¨MSMFB_DISPLAY_COMMITè°ƒç”¨fb IOCLTã€‚è¿™ä¼šå¯åŠ¨ä¸€ä¸ªå‘¼å«<br> mdss_fb_display_commit å¹¶å®‰æ’å·¥ä½œé˜Ÿåˆ—ã€‚æ­¤å·¥ä½œé˜Ÿåˆ—å¤„ç†ç¨‹åºè°ƒç”¨<br> msm_fb_pan_display_exï¼Œç„¶åè°ƒç”¨mdp3_ctrl_pan_displayã€‚<br> mdss_fb_ioctlâ†’ï¼ˆMSMFB_DISPLAY_COMMITï¼‰â†’mdss_fb_display_commitâ†’<br> mdss_fb_pan_display_exâ†’è®¡åˆ’å·¥ä½œmdss_fb_commit_wq_handler<br> msm_fb_commit_wq_handlerâ†’mdp3_ctrl_display_commit_kickoffâ†’mdp3_dmap_update<br>ä¸€æ¬¡å‘¼å«åï¼Œå¯ä»¥æœ‰å¤šä¸ªå¯¹PLAYå’ŒCOMMIT IOCLTçš„å‘¼å« MSMFB_OVERLAY_SET IOCTLã€‚é¢æ¿æ›´æ–°å®Œæˆå¹¶ä¸”è®¾å¤‡å®Œæˆå<br>éœ€è¦è¿›å…¥æŒ‚èµ·æˆ–å…³é—­çŠ¶æ€ï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨MSMFB_OVERLAY_UNSETã€‚</p><p>æ³¨æ„ï¼šå·¥ä½œé˜Ÿåˆ—æ¶æ„æ­£åœ¨è¢«å³å°†å‘å¸ƒçš„çº¿ç¨‹å–ä»£ï¼Œ<br>è¿™äº›æ–‡ä»¶æœªè¢«æ•è·ã€‚è§†é¢‘å’Œå‘½ä»¤æ¨¡å¼é¢æ¿çš„é¢æ¿æ›´æ–°ç•¥æœ‰ä¸åŒã€‚ä¸ºäº†åœ¨å‘½ä»¤æ¨¡å¼é¢æ¿ä¸­ï¼Œmdp3_dmap_updateå‡½æ•°ä¼šç­‰å¾…ï¼Œç›´åˆ°å‰ä¸€ä¸ªå›¾åƒæ›´æ–°ä¸ºæ­¢å®Œæˆä½¿ç”¨MDP DMAå¼€å§‹æ–°å¸§æ›´æ–°</p><p>ifï¼ˆdma-&gt; output_config.out_sel == MDP3_DMA_OUTPUT_SEL_DSI_CMDï¼‰{<br>cb_type = MDP3_DMA_CALLBACK_TYPE_DMA_DONE;<br>å¦‚æœï¼ˆintf-&gt; activeï¼‰<br>wait_for_completion_killableï¼ˆDMA-&gt; dma_compï¼‰;</p><p>å¯¹äºè§†é¢‘é¢æ¿ï¼Œåœ¨DMAè§¦å‘åï¼Œmdp3_dmap_updateç­‰å¾…vsyncã€‚</p><h4 id="ï¼ˆå…­ï¼‰ã€Msm8610-lcd-driver-å†…æ ¸åˆå§‹åŒ–åˆ†æ"><a href="#ï¼ˆå…­ï¼‰ã€Msm8610-lcd-driver-å†…æ ¸åˆå§‹åŒ–åˆ†æ" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Msm8610  lcd driver å†…æ ¸åˆå§‹åŒ–åˆ†æ"></a>ï¼ˆå…­ï¼‰ã€Msm8610  lcd driver å†…æ ¸åˆå§‹åŒ–åˆ†æ</h4><p>è¯·å‚è€ƒ<a href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347" target="_blank" rel="noopener">ã€msm8610 lcd driver code analysisã€‘</a></p><h4 id="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><strong>(à¹‘ä¹›â—¡ä¹›à¹‘) ã€ï¼ˆ Í¡Â° ÍœÊ– Í¡Â°ï¼‰ã€ï¼ˆà²¡Ï‰à²¡ï¼‰ï¼ï¼ï¼ç´¯~~~</strong><br><strong>æ—¶è‡³ä»Šæ—¥ï¼Œç»ˆäºå®Œæ•´çš„åˆ†æäº†Android Display System æ€»ä½“æ¡†æ¶æµç¨‹ï¼Œä¸ç¦æ„Ÿå¹è®¡ç®—æœºä¸–ç•Œçš„åšå¤§ç²¾æ·±ï¼Œåœ¨è¿™ä¸ªç³»åˆ—çš„åˆ†æä¸­å†ç»ƒäº†å¦‚ä½•æ‹†è§£åˆ†æä¸€ä¸ªåºå¤§å¤æ‚çš„æ¨¡å—ã€å­¦ä¹ æ”¶è·è‰¯å¤šï¼ŒåŒæ—¶ä¹Ÿäº†è§£äº†è‡ªèº«çŸ¥è¯†çš„æ¬ ç¼ºï¼Œç”±äºæ¶‰åŠçŸ¥è¯†è¾ƒå¤šè¾ƒå¹¿ï¼Œåšä¸»ä¹Ÿæœªèƒ½å®Œå…¨åƒé€ï¼Œå…¶ä¸­åˆ†ææœ‰è¯¯çš„åœ°æ–¹è¿˜è¯·å„ä½è§è°…ã€‚æ‰€è°“è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢ã€‚</strong><br><strong>Todoï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶ï¼ŒMultimedia System ä»»è¿˜æœ‰è®¸å¤šæœªè§£ä¹‹æƒ‘ï¼Œéœ€æ¶è¡¥Linuxå†…æ ¸çŸ¥è¯†ï¼Œå°‘å¹´ï¼ŒåŠ æ²¹ï¼ˆâ½â½â½ï¼‰</strong></p><h4 id="ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://s3.amazonaws.com/connect.linaro.org/bkk16/Presentations/Wednesday/BKK16-315.pdf" target="_blank" rel="noopener">Graphics Stack Update</a><br><a href="https://blog.csdn.net/eliot_shao/article/details/74926010" target="_blank" rel="noopener">é«˜é€šAndroidå¹³å°-åº”ç”¨ç©ºé—´æ“ä½œframebuffer dump LCDæ€»ç»“</a><br><a href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347" target="_blank" rel="noopener">msm8610 lcd driver code analysis</a><br><a href="https://blog.csdn.net/u012719256/article/details/52096727" target="_blank" rel="noopener">linux qcom LCD framwork</a><br><a href="https://blog.csdn.net/weijory/article/details/69391838" target="_blank" rel="noopener">Qualcommå¹³å° display bring up è¿‡ç¨‹è¯¦è§£</a><br><a href="https://blog.csdn.net/wlwl0071986/article/details/8247443" target="_blank" rel="noopener">é«˜é€š8x25å¹³å°displayæ¨¡å—æ€»ç»“</a><br><a href="https://blog.csdn.net/sfrysh/article/details/7305253" target="_blank" rel="noopener">Android ä¸­çš„ framebuffer</a><br><a href="https://blog.csdn.net/yangwen123/article/details/12096483" target="_blank" rel="noopener">FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ</a><br><a href="http://www.wxtlife.com/2017/06/07/Android-framebuffer/" target="_blank" rel="noopener">Android Framebufferä»‹ç»åŠä½¿ç”¨</a><br><a href="https://www.wolfcstech.com/categories/Android-%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F/" target="_blank" rel="noopener">Android å›¾å½¢ç³»ç»Ÿ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc &amp;&amp; HWComposeræ¨¡å—åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/08/16/Android%20Display%20System%EF%BC%884%EF%BC%89%EF%BC%9AAndroid%20Display%20System%20%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B9%8BGralloc%20&amp;&amp;%20HWComposer%E6%A8%A1%E5%9D%97%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/08/16/Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc &amp;&amp; HWComposeræ¨¡å—åˆ†æ/</id>
    <published>2018-08-15T16:00:00.000Z</published>
    <updated>2018-06-20T15:16:27.801Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/display.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p><a href="https://blog.csdn.net/putiancaijunyu/article/category/2558539" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Androidç ”ç©¶ Gralloc &amp;&amp; HWComposerç³»åˆ—åˆ†æã€‘</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/54234354" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Android display ç³»åˆ—åˆ†æã€‘</a><br><a href="https://blog.csdn.net/yangwen123/article/details/12192401" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Androidå›¾å½¢æ˜¾ç¤ºä¹‹ç¡¬ä»¶æŠ½è±¡å±‚Grallocã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><p> ğŸŒ€ğŸŒ€ï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶</p><p>ã€Android Display System ç³»ç»Ÿåˆ†æç³»åˆ—ã€‘ï¼š<br>ã€Android Display Systemï¼ˆ1ï¼‰ï¼šAndroid 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL &amp;&amp; OpenGLã€‘<br>ã€Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc &amp;&amp; HWComposeræ¨¡å—åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architectureã€‘</p><hr><p>\hardware\libhardware\include\hardware</p><ul><li>fb.h</li></ul><p>\hardware\libhardware\modules\gralloc</p><ul><li>framebuffer.cpp</li><li>gralloc.cpp</li><li>gralloc_priv.h</li><li>gr.h</li><li>mapper.cpp</li></ul><p>\hardware\qcom\display\msm8996\libgralloc</p><ul><li>alloc_controller.cpp</li><li>framebuffer.cpp</li><li>gpu.cpp</li><li>gralloc.cpp</li><li>ionalloc.cpp</li><li>mapper.cpp</li></ul><p>\hardware\qcom\display\msm8996\libgralloc1</p><ul><li>gr_adreno_info.cpp</li><li>gr_allocator.cpp</li><li>gr_buf_mgr.cpp</li><li>gr_device_impl.cpp</li><li>gr_ion_alloc.cpp</li><li>gr_utils.cpp</li></ul><p>\frameworks\native\services\surfaceflinger</p><ul><li>DisplayDevice.cpp</li><li>SurfaceFlinger.cpp</li><li>MonitoredProducer.cpp</li><li>SurfaceFlingerConsumer.cpp</li><li>SurfaceFlinger_hwc1.cpp</li><li>Client.cpp</li><li>DispSync.cpp</li><li>EventControlThread.cpp</li><li>EventThread.cpp</li><li>Layer.cpp</li><li>MessageQueue.cpp</li></ul><p>\frameworks\native\services\surfaceflinger\DisplayHardware</p><ul><li>FramebufferSurface.cpp</li><li>HWC2.cpp</li><li>HWC2On1Adapter.cpp</li><li>HWComposer.cpp</li><li>HWComposer_hwc1.cpp</li></ul><hr><p>Linuxç³»ç»Ÿä¸‹çš„æ˜¾ç¤ºé©±åŠ¨æ¡†æ¶ï¼Œæ¯ä¸ªæ˜¾ç¤ºå±è¢«æŠ½è±¡ä¸ºä¸€ä¸ªå¸§ç¼“å†²åŒºï¼Œæ³¨å†Œåˆ°FrameBufferæ¨¡å—ä¸­ï¼Œå¹¶åœ¨/dev/graphicsç›®å½•ä¸‹åˆ›å»ºå¯¹åº”çš„fbXè®¾å¤‡ã€‚Androidç³»ç»Ÿåœ¨ç¡¬ä»¶æŠ½è±¡å±‚ä¸­æä¾›äº†ä¸€ä¸ªGrallocæ¨¡å—ï¼Œå°è£…äº†å¯¹å¸§ç¼“å†²åŒºçš„æ‰€æœ‰è®¿é—®æ“ä½œã€‚ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºåœ¨ä½¿ç”¨å¸§ç¼“å†²åŒºä¹‹é—´ï¼Œé¦–å…ˆè¦åŠ è½½Grallocæ¨¡å—ï¼Œå¹¶ä¸”è·å¾—ä¸€ä¸ªgrallocè®¾å¤‡å’Œä¸€ä¸ªfbè®¾å¤‡ã€‚æœ‰äº†grallocè®¾å¤‡ä¹‹åï¼Œç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥ç”³è¯·åˆ†é…ä¸€å—å›¾å½¢ç¼“å†²åŒºï¼Œå¹¶ä¸”å°†è¿™å—å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´æ¥ï¼Œä»¥ä¾¿å¯ä»¥å‘é‡Œé¢å†™å…¥è¦ç»˜åˆ¶çš„ç”»é¢çš„å†…å®¹ã€‚æœ€åï¼Œç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºå°±é€šè¿‡fbè®¾å¤‡æ¥å°†å·²ç»å‡†å¤‡å¥½äº†çš„å›¾å½¢ç¼“å†²åŒºæ¸²æŸ“åˆ°å¸§ç¼“å†²åŒºä¸­å»ï¼Œå³å°†å›¾å½¢ç¼“å†²åŒºçš„å†…å®¹ç»˜åˆ¶åˆ°æ˜¾ç¤ºå±ä¸­å»ã€‚ç›¸åº”åœ°ï¼Œå½“ç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºä¸å†éœ€è¦ä½¿ç”¨ä¸€å—å›¾å½¢ç¼“å†²åŒºçš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡grallocè®¾å¤‡æ¥é‡Šæ”¾å®ƒï¼Œå¹¶ä¸”å°†å®ƒä»åœ°å€ç©ºé—´ä¸­è§£é™¤æ˜ å°„ã€‚</p><p>é«˜é€šMSM8996 <a href="Android å›¾å½¢ç³»ç»Ÿä¹‹gralloc">Grallocæ¨¡å—</a> å®ç°æºç ä½äºï¼š<br>\hardware\qcom\display\msm8996\libgralloc<br>æ¯ä¸ªç¡¬ä»¶æŠ½è±¡å±‚æ¨¡å—éƒ½å¿…é¡»å®šä¹‰HAL_MODULE_INFO_SYMç¬¦å·ï¼Œå¹¶ä¸”æœ‰è‡ªå·±å”¯ä¸€çš„IDï¼ŒGrallocä¹Ÿä¸ä¾‹å¤–ï¼ŒGrallocæ¨¡å—IDå®šä¹‰ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/libhardware/include/hardware/gralloc.h]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The id of this module</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GRALLOC_HARDWARE_MODULE_ID <span class="meta-string">"gralloc"</span></span></span><br></pre></td></tr></table></figure><p>åŒæ—¶å®šä¹‰äº†ä»¥HAL_MODULE_INFO_SYMä¸ºç¬¦å·çš„ç±»å‹ä¸º private_module_tçš„ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">hardware\libhardware\modules\gralloc\gralloc.cpp</span><br><span class="line"><span class="comment">// HAL module methods</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_methods_t</span> <span class="title">gralloc_module_methods</span> = &#123;</span></span><br><span class="line">    .open = gralloc_device_open</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HAL module initialize</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">private_module_t</span> <span class="title">HAL_MODULE_INFO_SYM</span> = &#123;</span></span><br><span class="line">    .base = &#123;</span><br><span class="line">        .common = &#123;</span><br><span class="line">            .tag = HARDWARE_MODULE_TAG,</span><br><span class="line">            .version_major = <span class="number">1</span>,</span><br><span class="line">            .version_minor = <span class="number">0</span>,</span><br><span class="line">            .id = GRALLOC_HARDWARE_MODULE_ID,</span><br><span class="line">            .name = <span class="string">"Graphics Memory Allocator Module"</span>,</span><br><span class="line">            .author = <span class="string">"The Android Open Source Project"</span>,</span><br><span class="line">            .methods = &amp;gralloc_module_methods,</span><br><span class="line">            .dso = <span class="number">0</span>,</span><br><span class="line">            .reserved = &#123;<span class="number">0</span>&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        .registerBuffer = gralloc_register_buffer,</span><br><span class="line">        .unregisterBuffer = gralloc_unregister_buffer,</span><br><span class="line">        .lock = gralloc_lock,</span><br><span class="line">        .unlock = gralloc_unlock,</span><br><span class="line">        .perform = gralloc_perform,</span><br><span class="line">        .lock_ycbcr = gralloc_lock_ycbcr,</span><br><span class="line">    &#125;,</span><br><span class="line">    .framebuffer = <span class="number">0</span>,</span><br><span class="line">    .fbFormat = <span class="number">0</span>,</span><br><span class="line">    .flags = <span class="number">0</span>,</span><br><span class="line">    .numBuffers = <span class="number">0</span>,</span><br><span class="line">    .bufferMask = <span class="number">0</span>,</span><br><span class="line">    .lock = PTHREAD_MUTEX_INITIALIZER,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<a href="Android å›¾å½¢ç³»ç»Ÿä¹‹gralloc">Grallocæ¨¡å—åŠ è½½</a> åˆ†æçš„æ–¹æ³•å°†Grallocæ¨¡å—åŠ è½½åˆ°å†…å­˜ä¸­æ¥ä¹‹åï¼Œå°±å¯ä»¥è°ƒç”¨å‡½æ•°dlsymæ¥è·å¾—å®ƒæ‰€å¯¼å‡ºçš„ç¬¦å·HMIï¼Œå¾—åˆ°private_module_tçš„é¦–åœ°å€åï¼Œç”±äºprivate_module_tçš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡çš„ç±»å‹ä¸ºgralloc_module_tï¼Œå› æ­¤ä¹Ÿæ˜¯gralloc_module_tçš„é¦–åœ°å€ï¼Œç”±äºgralloc_module_tçš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ç±»å‹ä¸ºhw_module_tï¼Œå› æ­¤ä¹Ÿæ˜¯hw_module_tçš„é¦–åœ°å€ï¼Œå› æ­¤åªè¦å¾—åˆ°è¿™ä¸‰ç§ç±»å‹ä¸­å…¶ä¸­ä¸€ç§ç±»å‹å˜é‡çš„åœ°å€ï¼Œå°±å¯ä»¥ç›¸äº’è½¬æ¢ä¸ºå…¶ä»–ä¸¤ç§ç±»å‹çš„æŒ‡é’ˆã€‚</p><h4 id="ï¼ˆä¸€ï¼‰ã€Grallocæ¨¡å—-æ•°æ®ç»“æ„"><a href="#ï¼ˆä¸€ï¼‰ã€Grallocæ¨¡å—-æ•°æ®ç»“æ„" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Grallocæ¨¡å— æ•°æ®ç»“æ„"></a>ï¼ˆä¸€ï¼‰ã€Grallocæ¨¡å— æ•°æ®ç»“æ„</h4><p>åœ¨åˆ†æGrallocæ¨¡å—ä¹‹å‰ï¼Œé¦–å…ˆä»‹ç»Grallocæ¨¡å—å®šä¹‰çš„ä¸€äº›æ•°æ®ç»“æ„ã€‚private_module_tç”¨äºæè¿°Grallocæ¨¡å—ä¸‹çš„ç³»ç»Ÿå¸§ç¼“å†²åŒºä¿¡æ¯<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\fb_priv.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">private_module_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">gralloc_module_t</span> base;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">private_handle_t</span>* <span class="title">framebuffer</span>;</span><span class="comment">//æŒ‡å‘ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„å¥æŸ„  </span></span><br><span class="line">    <span class="keyword">uint32_t</span> fbFormat;</span><br><span class="line">    <span class="keyword">uint32_t</span> flags;<span class="comment">//ç”¨æ¥æ ‡å¿—ç³»ç»Ÿå¸§ç¼“å†²åŒºæ˜¯å¦æ”¯æŒåŒç¼“å†²</span></span><br><span class="line">    <span class="keyword">uint32_t</span> numBuffers;<span class="comment">//è¡¨ç¤ºç³»ç»Ÿå¸§ç¼“å†²åŒºåŒ…å«æœ‰å¤šå°‘ä¸ªå›¾å½¢ç¼“å†²åŒº  </span></span><br><span class="line">    <span class="keyword">uint32_t</span> bufferMask;<span class="comment">//è®°å½•ç³»ç»Ÿå¸§ç¼“å†²åŒºä¸­çš„å›¾å½¢ç¼“å†²åŒºçš„ä½¿ç”¨æƒ…å†µ </span></span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> lock;<span class="comment">//ä¸€ä¸ªäº’æ–¥é”ï¼Œç”¨æ¥ä¿æŠ¤ç»“æ„ä½“private_module_tçš„å¹¶è¡Œè®¿é—®</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">info</span>;</span><span class="comment">//ä¿å­˜è®¾å¤‡æ˜¾ç¤ºå±çš„åŠ¨æ€å±æ€§ä¿¡æ¯  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">finfo</span>;</span><span class="comment">//ä¿å­˜è®¾å¤‡æ˜¾ç¤ºå±çš„å›ºå®šå±æ€§ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">float</span> xdpi;<span class="comment">//æè¿°è®¾å¤‡æ˜¾ç¤ºå±åœ¨å®½åº¦  </span></span><br><span class="line">    <span class="keyword">float</span> ydpi;<span class="comment">//æè¿°è®¾å¤‡æ˜¾ç¤ºå±åœ¨é«˜åº¦  </span></span><br><span class="line">    <span class="keyword">float</span> fps;<span class="comment">//ç”¨æ¥æè¿°æ˜¾ç¤ºå±çš„åˆ·æ–°é¢‘ç‡  </span></span><br><span class="line">    <span class="keyword">uint32_t</span> swapInterval;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>framebuffer_device_tç”¨æ¥æè¿°ç³»ç»Ÿå¸§ç¼“å†²åŒºè®¾å¤‡çš„ä¿¡æ¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/libhardware/include/hardware/fb.h]</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">framebuffer_device_t</span> &#123;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Common methods of the framebuffer device.  This *must* be the first member of</span></span><br><span class="line"><span class="comment">     * framebuffer_device_t as users of this structure will cast a hw_device_t to</span></span><br><span class="line"><span class="comment">     * framebuffer_device_t pointer in contexts where it's known the hw_device_t references a</span></span><br><span class="line"><span class="comment">     * framebuffer_device_t.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_device_t</span> <span class="title">common</span>;</span></span><br><span class="line">    <span class="comment">//ç”¨æ¥è®°å½•ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„æ ‡å¿—</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint32_t</span>  flags;</span><br><span class="line">    <span class="comment">//ç”¨æ¥æè¿°è®¾å¤‡æ˜¾ç¤ºå±çš„å®½åº¦ã€é«˜åº¦ </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint32_t</span>  width;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint32_t</span>  height;</span><br><span class="line">    <span class="comment">//ç”¨æ¥æè¿°è®¾å¤‡æ˜¾ç¤ºå±çš„ä¸€è¡Œæœ‰å¤šå°‘ä¸ªåƒç´ ç‚¹  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span>       stride;</span><br><span class="line">    <span class="comment">//ç”¨æ¥æè¿°ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„åƒç´ æ ¼å¼</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span>       format;</span><br><span class="line">    <span class="comment">//ç”¨æ¥æè¿°è®¾å¤‡æ˜¾ç¤ºå±åœ¨å®½åº¦ä¸Šçš„å¯†åº¦ã€å¯†åº¦</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span>     xdpi;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span>     ydpi;</span><br><span class="line">    <span class="comment">//ç”¨æ¥æè¿°è®¾å¤‡æ˜¾ç¤ºå±çš„åˆ·æ–°é¢‘ç‡  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span>     fps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨æ¥è®¾ç½®å¸§ç¼“å†²åŒºäº¤æ¢å‰åä¸¤ä¸ªå›¾å½¢ç¼“å†²åŒºçš„æœ€å°å’Œæœ€å¤§æ—¶é—´é—´éš” </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span>       minSwapInterval;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span>       maxSwapInterval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of framebuffers supported*/</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span>       numFramebuffers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> reserved[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨æ¥è®¾ç½®å¸§ç¼“å†²åŒºäº¤æ¢å‰åä¸¤ä¸ªå›¾å½¢ç¼“å†²åŒºçš„æœ€å°å’Œæœ€å¤§æ—¶é—´é—´éš”</span></span><br><span class="line">    <span class="keyword">int</span> (*setSwapInterval)(struct <span class="keyword">framebuffer_device_t</span>* window,</span><br><span class="line">            <span class="keyword">int</span> interval);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨æ¥è®¾ç½®å¸§ç¼“å†²åŒºçš„æ›´æ–°åŒºåŸŸ</span></span><br><span class="line">    <span class="keyword">int</span> (*setUpdateRect)(struct <span class="keyword">framebuffer_device_t</span>* window,</span><br><span class="line">            <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> width, <span class="keyword">int</span> height);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨æ¥å°†å›¾å½¢ç¼“å†²åŒºbufferçš„å†…å®¹æ¸²æŸ“åˆ°å¸§ç¼“å†²åŒºä¸­å»</span></span><br><span class="line">    <span class="keyword">int</span> (*post)(struct <span class="keyword">framebuffer_device_t</span>* dev, <span class="keyword">buffer_handle_t</span> buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨æ¥é€šçŸ¥fbè®¾å¤‡ï¼Œå›¾å½¢ç¼“å†²åŒºçš„ç»„åˆå·¥ä½œå·²ç»å®Œæˆ</span></span><br><span class="line">    <span class="keyword">int</span> (*compositionComplete)(struct <span class="keyword">framebuffer_device_t</span>* dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*dump)(struct <span class="keyword">framebuffer_device_t</span>* dev, <span class="keyword">char</span> *buff, <span class="keyword">int</span> buff_len);</span><br><span class="line">    <span class="keyword">int</span> (*enableScreen)(struct <span class="keyword">framebuffer_device_t</span>* dev, <span class="keyword">int</span> enable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* reserved_proc[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">framebuffer_device_t</span>;</span><br></pre></td></tr></table></figure><p>gralloc_module_tç”¨äºæè¿°grallocæ¨¡å—ä¿¡æ¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware\include\hardware\gralloc.h]</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">gralloc_module_t</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> <span class="title">common</span>;</span></span><br><span class="line">    <span class="comment">//æ˜ å°„ä¸€å—å›¾å½¢ç¼“å†²åŒºåˆ°ä¸€ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´å» </span></span><br><span class="line">    <span class="keyword">int</span> (*registerBuffer)(struct <span class="keyword">gralloc_module_t</span> <span class="keyword">const</span>* <span class="keyword">module</span>,</span><br><span class="line">            <span class="keyword">buffer_handle_t</span> handle);</span><br><span class="line">    <span class="comment">//å–æ¶ˆæ˜ å°„ä¸€å—å›¾å½¢ç¼“å†²åŒºåˆ°ä¸€ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´å»</span></span><br><span class="line">    <span class="keyword">int</span> (*unregisterBuffer)(struct <span class="keyword">gralloc_module_t</span> <span class="keyword">const</span>* <span class="keyword">module</span>,</span><br><span class="line">            <span class="keyword">buffer_handle_t</span> handle);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> (*lock)(struct <span class="keyword">gralloc_module_t</span> <span class="keyword">const</span>* <span class="keyword">module</span>,</span><br><span class="line">            <span class="keyword">buffer_handle_t</span> handle, <span class="keyword">int</span> usage,</span><br><span class="line">            <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> w, <span class="keyword">int</span> h,</span><br><span class="line">            <span class="keyword">void</span>** vaddr);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">int</span> (*unlock)(struct <span class="keyword">gralloc_module_t</span> <span class="keyword">const</span>* <span class="keyword">module</span>,</span><br><span class="line">            <span class="keyword">buffer_handle_t</span> handle);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* reserved for future use */</span></span><br><span class="line">    <span class="keyword">void</span>* reserved_proc[<span class="number">3</span>];</span><br><span class="line">&#125; <span class="keyword">gralloc_module_t</span>;</span><br></pre></td></tr></table></figure><p>alloc_device_tç”¨äºæè¿°grallocè®¾å¤‡çš„ä¿¡æ¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware\include\hardware\gralloc.h]</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">alloc_device_t</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_device_t</span> <span class="title">common</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> (*alloc)(struct <span class="keyword">alloc_device_t</span>* dev,</span><br><span class="line">            <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> usage,</span><br><span class="line">            <span class="keyword">buffer_handle_t</span>* handle, <span class="keyword">int</span>* stride);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">int</span> (*<span class="built_in">free</span>)(struct <span class="keyword">alloc_device_t</span>* dev,</span><br><span class="line">            <span class="keyword">buffer_handle_t</span> handle);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">void</span> (*dump)(struct <span class="keyword">alloc_device_t</span> *dev, <span class="keyword">char</span> *buff, <span class="keyword">int</span> buff_len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* reserved_proc[<span class="number">7</span>];</span><br><span class="line">&#125; <span class="keyword">alloc_device_t</span>;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/libhardware/include/hardware/hardware.h]</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">uint32_t</span> tag;<span class="comment">//æ ‡ç­¾  </span></span><br><span class="line">ã€€ã€€<span class="keyword">uint16_t</span> version_major;<span class="comment">//æ¨¡å—ä¸»è®¾å¤‡å·  </span></span><br><span class="line">ã€€ã€€<span class="keyword">uint16_t</span> version_minor;<span class="comment">//æ¨¡å—æ¬¡è®¾å¤‡å·  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *id;<span class="comment">//æ¨¡å—ID  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;<span class="comment">//æ¨¡å—åç§°  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *author;<span class="comment">//æ¨¡å—ä½œè€…  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_methods_t</span>* <span class="title">methods</span>;</span><span class="comment">//æ¨¡å—æ“ä½œæ–¹æ³•  </span></span><br><span class="line">    <span class="keyword">void</span>* dso;<span class="comment">//ä¿å­˜æ¨¡å—é¦–åœ°å€  </span></span><br><span class="line">    <span class="keyword">uint32_t</span> reserved[<span class="number">32</span><span class="number">-7</span>];<span class="comment">//ä¿ç•™ä½  </span></span><br><span class="line">&#125; <span class="keyword">hw_module_t</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">æ¨¡å—</th><th style="text-align:right">è®¾å¤‡</th><th style="text-align:center">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left">private_module_t</td><td style="text-align:right">framebuffer_device_t</td><td style="text-align:center">å°†å›¾å½¢ç¼“å†²å™¨æ˜ å°„åˆ°å¸§ç¼“å†²åŒº</td></tr><tr><td style="text-align:left">gralloc_module_t</td><td style="text-align:right">alloc_module_t</td><td style="text-align:center">åˆ†é…æˆ–é‡Šæ”¾å›¾å½¢ç¼“å†²åŒº</td></tr><tr><td style="text-align:left">hw_module_t</td><td style="text-align:right">hw_module_t</td><td style="text-align:center">å…³è”è®¾å¤‡å’Œæ¨¡å—</td></tr></tbody></table><p>ç¡¬ä»¶æŠ½è±¡å±‚Grallocæ¨¡å—å®šä¹‰äº†è®¾å¤‡fbå’Œè®¾å¤‡gpuï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware\include\hardware\fb.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GRALLOC_HARDWARE_FB0 <span class="meta-string">"fb0"</span></span></span><br><span class="line">[-&gt;/hardware/libhardware/include/hardware/gralloc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GRALLOC_HARDWARE_GPU0 <span class="meta-string">"gpu0"</span></span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-04-01-GRALLOC_HARDWARE_.png" alt="Alt text | center"></p><p>è®¾å¤‡gpuç”¨äºåˆ†é…å›¾å½¢ç¼“å†²åŒºï¼Œè€Œè®¾å¤‡fbç”¨äºæ¸²æŸ“å›¾å½¢ç¼“å†²åŒºï¼›hw_module_tç”¨äºæè¿°ç¡¬ä»¶æŠ½è±¡å±‚Grallocæ¨¡å—ï¼Œè€Œhw_device_tåˆ™ç”¨äºæè¿°ç¡¬ä»¶æŠ½è±¡å±‚Grallocè®¾å¤‡ï¼Œé€šè¿‡ç¡¬ä»¶æŠ½è±¡å±‚è®¾å¤‡å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ç¡¬ä»¶æŠ½è±¡å±‚æ¨¡å—ã€‚åœ¨Grallocæ¨¡å—ä¸­ï¼Œæ— è®ºæ˜¯å®šä¹‰fbè®¾å¤‡è¿˜æ˜¯gpuè®¾å¤‡ï¼Œéƒ½æ˜¯ç”¨æ¥å¤„ç†å›¾å½¢ç¼“å†²åŒºï¼Œä»¥ä¸‹æ˜¯å…³äºç¼“å†²åŒºçš„æ•°æ®ç»“æ„ å®šä¹‰ï¼š<br>private_handle_tç”¨æ¥æè¿°ä¸€å—ç¼“å†²åŒºï¼ŒAndroidå¯¹ç¼“å†²åŒºçš„å®šä¹‰æä¾›äº†Cå’ŒC++ä¸¤ç§æ–¹å¼ï¼ŒC++ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\gralloc_priv.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">private_handle_t</span> :</span> <span class="keyword">public</span> native_handle &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">private_handle_t</span> &#123;</span></span><br><span class="line">        <span class="keyword">native_handle_t</span> nativeHandle;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">enum</span> &#123;</span><br><span class="line">            PRIV_FLAGS_FRAMEBUFFER        = <span class="number">0x00000001</span>,</span><br><span class="line">            ......</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// file-descriptors</span></span><br><span class="line">        <span class="keyword">int</span>     fd;</span><br><span class="line">        <span class="keyword">int</span>     fd_metadata;          <span class="comment">// fd for the meta-data</span></span><br><span class="line">        <span class="comment">// ints</span></span><br><span class="line">        <span class="keyword">int</span>     magic;</span><br><span class="line">        <span class="keyword">int</span>     flags;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span>  size;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span>  offset;</span><br><span class="line">        <span class="keyword">int</span>     bufferType;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">int</span>     format;</span><br><span class="line">        <span class="keyword">int</span>     width;</span><br><span class="line">        <span class="keyword">int</span>     height;</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure></p><p>ä¸¤ç§ç¼–è¯‘å™¨ä¸‹çš„private_handle_tå®šä¹‰éƒ½ç»§æ‰¿äºnative_handleï¼Œnative_handleçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/system/core/include/cutils/native_handle.h]</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">native_handle</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">    <span class="keyword">int</span> version; <span class="comment">//è®¾ç½®ä¸ºç»“æ„ä½“native_handle_tçš„å¤§å°ï¼Œç”¨æ¥æ ‡è¯†ç»“æ„ä½“native_handle_tçš„ç‰ˆæœ¬  </span></span><br><span class="line">    <span class="keyword">int</span> numFds;  <span class="comment">//è¡¨ç¤ºç»“æ„ä½“native_handle_tæ‰€åŒ…å«çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œè¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¿å­˜åœ¨æˆå‘˜å˜é‡dataæ‰€æŒ‡å‘çš„ä¸€å—ç¼“å†²åŒºä¸­ã€‚  </span></span><br><span class="line">    <span class="keyword">int</span> numInts; <span class="comment">//è¡¨ç¤ºç»“æ„ä½“native_handle_tæ‰€åŒ…å«çš„æ•´æ•°å€¼çš„ä¸ªæ•°ï¼Œè¿™äº›æ•´æ•°ä¿å­˜åœ¨æˆå‘˜å˜é‡dataæ‰€æŒ‡å‘çš„ä¸€å—ç¼“å†²åŒºä¸­ã€‚  </span></span><br><span class="line">    <span class="keyword">int</span> data[<span class="number">0</span>]; <span class="comment">//æŒ‡å‘çš„ä¸€å—ç¼“å†²åŒºä¸­  </span></span><br><span class="line">&#125; <span class="keyword">native_handle_t</span>;  </span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="keyword">native_handle_t</span>* <span class="keyword">buffer_handle_t</span>;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-04-02-gralloc-hwt.png" alt="Alt text | center"></p><p>  ä¸‹é¢å°±åˆ†æGrallocæ¨¡å—ä¸­å®šä¹‰äº†ä¸¤ç§è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-04-03-GRALLOC_HARDWARE.png" alt="Alt text | center"></p><h4 id="ï¼ˆäºŒï¼‰ã€Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹"><a href="#ï¼ˆäºŒï¼‰ã€Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹"></a>ï¼ˆäºŒï¼‰ã€Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹</h4><p>Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹æ˜¯ä»SurfaceFlinger.init()å‡½æ•°é€šè¿‡HWComposerå¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ‰“å¼€çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\services\surfaceflinger\SurfaceFlinger_hwc1.cpp]</span><br><span class="line"><span class="keyword">void</span> SurfaceFlinger::init() &#123;</span><br><span class="line">    <span class="comment">// initialize EGL for the default display</span></span><br><span class="line">    mEGLDisplay = eglGetDisplay(EGL_DEFAULT_DISPLAY);</span><br><span class="line">    eglInitialize(mEGLDisplay, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start the EventThread</span></span><br><span class="line">    sp&lt;VSyncSource&gt; vsyncSrc = <span class="keyword">new</span> DispSyncSource(&amp;mPrimaryDispSync,</span><br><span class="line">            vsyncPhaseOffsetNs, <span class="literal">true</span>, <span class="string">"app"</span>);</span><br><span class="line">    mEventThread = <span class="keyword">new</span> EventThread(vsyncSrc, *<span class="keyword">this</span>);</span><br><span class="line">    sp&lt;VSyncSource&gt; sfVsyncSrc = <span class="keyword">new</span> DispSyncSource(&amp;mPrimaryDispSync,</span><br><span class="line">            sfVsyncPhaseOffsetNs, <span class="literal">true</span>, <span class="string">"sf"</span>);</span><br><span class="line">    mSFEventThread = <span class="keyword">new</span> EventThread(sfVsyncSrc, *<span class="keyword">this</span>);</span><br><span class="line">    mEventQueue.setEventThread(mSFEventThread);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Initialize the H/W composer object.  There may or may not be an</span></span><br><span class="line">    <span class="comment">// actual hardware composer underneath.</span></span><br><span class="line">    mHwc = <span class="keyword">new</span> HWComposer(<span class="keyword">this</span>,</span><br><span class="line">            *<span class="keyword">static_cast</span>&lt;HWComposer::EventHandler *&gt;(<span class="keyword">this</span>));</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹HWComposeræ„é€ å‡½æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">HWComposer::HWComposer(</span><br><span class="line">        const sp&lt;SurfaceFlinger&gt;&amp; flinger,</span><br><span class="line">        EventHandler&amp; handler)</span><br><span class="line">    : mFlinger(flinger),</span><br><span class="line">      mFbDev(0), mHwc(0), mNumDisplays(1),</span><br><span class="line">      mCBContext(new cb_context),</span><br><span class="line">      mEventHandler(handler),</span><br><span class="line">      mDebugForceFakeVSync(false)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    // Note: some devices may insist that the FB HAL be opened before HWC.</span><br><span class="line">    int fberr = loadFbHalModule();</span><br><span class="line">    loadHwcModule();</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">int HWComposer::loadFbHalModule()</span><br><span class="line">&#123;</span><br><span class="line">    hw_module_t const* module;</span><br><span class="line"></span><br><span class="line">    int err = hw_get_module(GRALLOC_HARDWARE_MODULE_ID, &amp;module);</span><br><span class="line">    ......</span><br><span class="line">    return framebuffer_open(module, &amp;mFbDev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Androidç³»ç»Ÿåœ¨ç¡¬ä»¶æŠ½è±¡å±‚ä¸­æä¾›äº†ä¸€ä¸ªGrallocæ¨¡å—ï¼Œå°è£…äº†å¯¹framebufferçš„æ‰€æœ‰è®¿é—®æ“ä½œã€‚Grallocæ¨¡å—ç¬¦åˆAndroidæ ‡å‡†çš„HALæ¶æ„è®¾è®¡ã€‚Grallocå¯¹åº”çš„hardware idä¸ºï¼šGRALLOC_HARDWARE_MODULE_ID</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware\include\hardware\fb.h]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">framebuffer_open</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct <span class="keyword">framebuffer_device_t</span>** device)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">module</span>-&gt;methods-&gt;open(<span class="keyword">module</span>,</span><br><span class="line">            GRALLOC_HARDWARE_FB0, (struct <span class="keyword">hw_device_t</span>**)device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºåœ¨ä½¿ç”¨å¸§ç¼“å†²åŒºä¹‹å‰ï¼Œé¦–å…ˆè¦åŠ è½½Grallocæ¨¡å—ï¼Œå¹¶ä¸”è·å¾—ä¸€ä¸ªgpu0è®¾å¤‡(gralloc_device, modulename:GRALLOC_HARDWARE_GPU0)å’Œä¸€ä¸ªfb0è®¾å¤‡(modulename:GRALLOC_HARDWARE_FB0)ã€‚</p><p>æœ‰äº†allocè®¾å¤‡ä¹‹åï¼Œç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥ç”³è¯·åˆ†é…ä¸€å—å›¾å½¢ç¼“å†²åŒºï¼Œå¹¶ä¸”å°†è¿™å—å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´æ¥ï¼Œä»¥ä¾¿å¯ä»¥å‘é‡Œé¢å†™å…¥è¦ç»˜åˆ¶çš„ç”»é¢çš„å†…å®¹ã€‚æœ€åï¼Œç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºå°±é€šè¿‡fb0è®¾å¤‡æ¥å°†å·²ç»å‡†å¤‡å¥½äº†çš„å›¾å½¢ç¼“å†²åŒºæ¸²æŸ“åˆ°å¸§ç¼“å†²åŒºä¸­å»ï¼Œå³å°†å›¾å½¢ç¼“å†²åŒºçš„å†…å®¹ç»˜åˆ¶åˆ°æ˜¾ç¤ºå±ä¸­å»ã€‚ç›¸åº”åœ°ï¼Œå½“ç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºä¸å†éœ€è¦ä½¿ç”¨ä¸€å—å›¾å½¢ç¼“å†²åŒºçš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡allocè®¾å¤‡æ¥é‡Šæ”¾å®ƒï¼Œå¹¶ä¸”å°†å®ƒä»åœ°å€ç©ºé—´ä¸­è§£é™¤æ˜ å°„ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\gralloc.cpp]</span><br><span class="line"><span class="comment">// Open Gralloc device</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gralloc_device_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, <span class="keyword">const</span> <span class="keyword">char</span>* name,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">hw_device_t</span>** device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, GRALLOC_HARDWARE_GPU0)) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">private_module_t</span>* m = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">private_module_t</span>*&gt;(</span><br><span class="line">            <span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">gpu_context_t</span> *dev;</span><br><span class="line">        IAllocController* alloc_ctrl = IAllocController::getInstance();</span><br><span class="line">        dev = <span class="keyword">new</span> <span class="keyword">gpu_context_t</span>(m, alloc_ctrl);</span><br><span class="line">        <span class="keyword">if</span>(!dev)</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">        *device = &amp;dev-&gt;common;</span><br><span class="line">        status = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//GRALLOC_HARDWARE_FB0,</span></span><br><span class="line">        status = fb_device_open(<span class="keyword">module</span>, name, device);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-1ã€Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹fb-device-open"><a href="#2-1ã€Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹fb-device-open" class="headerlink" title="2.1ã€Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹fb_device_open()"></a>2.1ã€Fbè®¾å¤‡æ‰“å¼€è¿‡ç¨‹fb_device_open()</h5><p>çœ‹ä¸‹fb_device_open()å‡½æ•°å®ç°è¿‡ç¨‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\framebuffer.cpp]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fb_device_open</span><span class="params">(<span class="keyword">hw_module_t</span> <span class="keyword">const</span>* <span class="keyword">module</span>, <span class="keyword">const</span> <span class="keyword">char</span>* name,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">hw_device_t</span>** device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, GRALLOC_HARDWARE_FB0)) &#123;</span><br><span class="line">        <span class="keyword">alloc_device_t</span>* gralloc_device;</span><br><span class="line">        <span class="comment">// æ‰“å¼€gralloc_deviceè®¾å¤‡ã€‚GRALLOC_HARDWARE_GPU0</span></span><br><span class="line">        status = gralloc_open(<span class="keyword">module</span>, &amp;gralloc_device);</span><br><span class="line">        <span class="keyword">if</span> (status &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªfb_context_tå¯¹è±¡ï¼Œç”¨æ¥æè¿°fbè®¾å¤‡ä¸Šä¸‹æ–‡  </span></span><br><span class="line">        <span class="keyword">fb_context_t</span> *dev = (<span class="keyword">fb_context_t</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*dev));</span><br><span class="line">        ......</span><br><span class="line">        <span class="built_in">memset</span>(dev, <span class="number">0</span>, <span class="keyword">sizeof</span>(*dev));</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–fb_context_tå¯¹è±¡  </span></span><br><span class="line">        <span class="comment">/* initialize the procs */</span></span><br><span class="line">        dev-&gt;device.common.tag      = HARDWARE_DEVICE_TAG;</span><br><span class="line">        dev-&gt;device.common.version  = <span class="number">0</span>;</span><br><span class="line">        dev-&gt;device.common.<span class="keyword">module</span>   = <span class="keyword">const_cast</span>&lt;<span class="keyword">hw_module_t</span>*&gt;(<span class="keyword">module</span>);</span><br><span class="line">        <span class="comment">//æ³¨å†Œfbè®¾å¤‡çš„æ“ä½œå‡½æ•°</span></span><br><span class="line">        dev-&gt;device.common.close    = fb_close;</span><br><span class="line">        dev-&gt;device.setSwapInterval = fb_setSwapInterval;</span><br><span class="line">        dev-&gt;device.post            = fb_post;</span><br><span class="line">        dev-&gt;device.setUpdateRect   = <span class="number">0</span>;</span><br><span class="line">        dev-&gt;device.compositionComplete = fb_compositionComplete;</span><br><span class="line">        <span class="comment">//å°†fbæ˜ å°„åˆ°å½“å‰è¿›ç¨‹åœ°å€ç©ºé—´ </span></span><br><span class="line">        status = mapFrameBuffer((<span class="keyword">framebuffer_device_t</span>*)dev);</span><br><span class="line">        <span class="keyword">private_module_t</span>* m = (<span class="keyword">private_module_t</span>*)dev-&gt;device.common.<span class="keyword">module</span>;</span><br><span class="line">        <span class="keyword">if</span> (status &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> stride = m-&gt;finfo.line_length / (m-&gt;info.bits_per_pixel &gt;&gt; <span class="number">3</span>);</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">uint32_t</span>&amp;&gt;(dev-&gt;device.flags) = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">uint32_t</span>&amp;&gt;(dev-&gt;device.width) = m-&gt;info.xres;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">uint32_t</span>&amp;&gt;(dev-&gt;device.height) = m-&gt;info.yres;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(dev-&gt;device.stride) = stride;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(dev-&gt;device.format) = m-&gt;fbFormat;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">float</span>&amp;&gt;(dev-&gt;device.xdpi) = m-&gt;xdpi;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">float</span>&amp;&gt;(dev-&gt;device.ydpi) = m-&gt;ydpi;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">float</span>&amp;&gt;(dev-&gt;device.fps) = m-&gt;fps;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(dev-&gt;device.minSwapInterval) =</span><br><span class="line">                                                        PRIV_MIN_SWAP_INTERVAL;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(dev-&gt;device.maxSwapInterval) =</span><br><span class="line">                                                        PRIV_MAX_SWAP_INTERVAL;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(dev-&gt;device.numFramebuffers) = m-&gt;numBuffers;</span><br><span class="line">            dev-&gt;device.setUpdateRect = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            *device = &amp;dev-&gt;device.common;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Close the gralloc module</span></span><br><span class="line">        gralloc_close(gralloc_device);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªfb_context_tç»“æ„ä½“ï¼Œå¹¶ä¸”å¯¹å®ƒçš„æˆå‘˜å˜é‡deviceè¿›è¡Œåˆå§‹åŒ–ã€‚ç»“æ„ä½“fb_context_tçš„æˆå‘˜å˜é‡deviceçš„ç±»å‹ä¸ºframebuffer_device_tï¼Œå®ƒæ˜¯ç”¨æ¥æè¿°fbè®¾å¤‡çš„ã€‚fbè®¾å¤‡ä¸»è¦æ˜¯ç”¨æ¥æ¸²æŸ“å›¾å½¢ç¼“å†²åŒºçš„ï¼Œè¿™æ˜¯é€šè¿‡è°ƒç”¨å®ƒçš„æˆå‘˜å‡½æ•°postæ¥å®ç°çš„ã€‚å‡½æ•°fb_device_openæ‰€æ‰“å¼€çš„fbè®¾å¤‡çš„æˆå‘˜å‡½æ•°postè¢«è®¾ç½®ä¸ºGrallocæ¨¡å—ä¸­çš„å‡½æ•°fb_postã€‚å‡½æ•°mapFrameBufferé™¤äº†ç”¨æ¥è·å¾—ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜ä¼šå°†ç³»ç»Ÿå¸§ç¼“å†²åŒºæ˜ å°„åˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´æ¥ã€‚line_lengthç”¨æ¥æè¿°æ˜¾ç¤ºå±ä¸€è¡Œåƒç´ æ€»å…±æ‰€å ç”¨çš„å­—èŠ‚æ•°ï¼Œbits_per_pixelç”¨æ¥æè¿°æ˜¾ç¤ºå±æ¯ä¸€ä¸ªåƒç´ æ‰€å ç”¨çš„ä½æ•°ï¼Œbits_per_pixelçš„å€¼å‘å³ç§»3ä½ï¼Œå°±å¯ä»¥å¾—åˆ°æ˜¾ç¤ºå±æ¯ä¸€ä¸ªåƒç´ æ‰€å ç”¨çš„å­—èŠ‚æ•°ã€‚ç”¨æ˜¾ç¤ºå±åƒç´ æ€»å…±æ‰€å ç”¨çš„å­—èŠ‚æ•°line_lengthé™¤ä»¥æ¯ä¸€ä¸ªåƒç´ æ‰€å ç”¨çš„å­—èŠ‚æ•°å°±å¯ä»¥å¾—åˆ°æ˜¾ç¤ºå±ä¸€è¡Œæœ‰å¤šå°‘ä¸ªåƒç´ ç‚¹ï¼Œå¹¶ä¿å­˜åœ¨strideä¸­ã€‚</p><h5 id="2-2ã€Fbè®¾å¤‡åœ°å€ç©ºé—´æ˜ å°„mapFrameBuffer"><a href="#2-2ã€Fbè®¾å¤‡åœ°å€ç©ºé—´æ˜ å°„mapFrameBuffer" class="headerlink" title="2.2ã€Fbè®¾å¤‡åœ°å€ç©ºé—´æ˜ å°„mapFrameBuffer()"></a>2.2ã€Fbè®¾å¤‡åœ°å€ç©ºé—´æ˜ å°„mapFrameBuffer()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\framebuffer.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mapFrameBuffer</span><span class="params">(<span class="keyword">framebuffer_device_t</span> *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> property[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">if</span>((property_get(<span class="string">"debug.gralloc.map_fb_memory"</span>, property, <span class="literal">NULL</span>) &gt; <span class="number">0</span>) &amp;&amp;</span><br><span class="line">       (!<span class="built_in">strncmp</span>(property, <span class="string">"1"</span>, PROPERTY_VALUE_MAX ) ||</span><br><span class="line">        (!strncasecmp(property,<span class="string">"true"</span>, PROPERTY_VALUE_MAX )))) &#123;</span><br><span class="line">        <span class="keyword">private_module_t</span>* <span class="keyword">module</span> =</span><br><span class="line">            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">private_module_t</span>*&gt;(dev-&gt;common.<span class="keyword">module</span>);</span><br><span class="line">        pthread_mutex_lock(&amp;<span class="keyword">module</span>-&gt;lock);</span><br><span class="line">        err = mapFrameBufferLocked(dev);</span><br><span class="line">        pthread_mutex_unlock(&amp;<span class="keyword">module</span>-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨mapFrameBufferLockedå‡½æ•°æ‰§è¡Œæ˜ å°„è¿‡ç¨‹ï¼Œè¯¥å‡½æ•°åœ¨çº¿ç¨‹ä¿æŠ¤ä¸‹å®Œæˆã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\framebuffer.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mapFrameBufferLocked</span><span class="params">(<span class="keyword">framebuffer_device_t</span> *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">private_module_t</span>* <span class="keyword">module</span> =</span><br><span class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">private_module_t</span>*&gt;(dev-&gt;common.<span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">fb_context_t</span> *ctx = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">fb_context_t</span>*&gt;(dev);</span><br><span class="line">    <span class="comment">// already initialized...</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;framebuffer) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> <span class="keyword">const</span> * <span class="keyword">const</span> device_template[] = &#123;</span><br><span class="line">        <span class="string">"/dev/graphics/fb%u"</span>,</span><br><span class="line">        <span class="string">"/dev/fb%u"</span>,</span><br><span class="line">        <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">char</span> property[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="comment">//æ£€æŸ¥æ˜¯å¦å­˜åœ¨è®¾å¤‡æ–‡ä»¶/dev/graphics/fb0æˆ–è€…/dev/fb0ã€‚å¦‚æœå­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆå°±è°ƒç”¨å‡½æ•°openæ¥æ‰“å¼€å®ƒï¼Œå¹¶ä¸”å°†å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦ä¿å­˜åœ¨å˜é‡fdä¸­ </span></span><br><span class="line">    <span class="keyword">while</span> ((fd==<span class="number">-1</span>) &amp;&amp; device_template[i]) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(name, <span class="number">64</span>, device_template[i], <span class="number">0</span>);</span><br><span class="line">        fd = open(name, O_RDWR, <span class="number">0</span>);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//é€šè¿‡IOæ§åˆ¶å‘½ä»¤FBIOGET_FSCREENINFOæ¥è·å¾—ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„å›ºå®šä¿¡æ¯ï¼Œä¿å­˜åœ¨fb_fix_screeninfoç»“æ„ä½“finfoä¸­  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">finfo</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, FBIOGET_FSCREENINFO, &amp;finfo) == <span class="number">-1</span>) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> -errno;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é€šè¿‡IOæ§åˆ¶å‘½ä»¤FBIOGET_VSCREENINFOæ¥è·å¾—ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„å¯å˜ä¿¡æ¯ï¼Œä¿å­˜åœ¨fb_var_screeninfoç»“æ„ä½“infoä¸­ </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">info</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, FBIOGET_VSCREENINFO, &amp;info) == <span class="number">-1</span>) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> -errno;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–info  </span></span><br><span class="line">    info.reserved[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    info.reserved[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    info.reserved[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    info.xoffset = <span class="number">0</span>;</span><br><span class="line">    info.yoffset = <span class="number">0</span>;</span><br><span class="line">    info.activate = FB_ACTIVATE_NOW;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Interpretation of offset for color fields: All offsets are from the</span></span><br><span class="line"><span class="comment">     * right, inside a "pixel" value, which is exactly 'bits_per_pixel' wide</span></span><br><span class="line"><span class="comment">     * (means: you can use the offset as right argument to &lt;&lt;). A pixel</span></span><br><span class="line"><span class="comment">     * afterwards is a bit stream and is written to video memory as that</span></span><br><span class="line"><span class="comment">     * unmodified. This implies big-endian byte order if bits_per_pixel is</span></span><br><span class="line"><span class="comment">     * greater than 8.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(info.bits_per_pixel == <span class="number">32</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Explicitly request RGBA_8888</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        info.bits_per_pixel = <span class="number">32</span>;</span><br><span class="line">        info.red.offset     = <span class="number">24</span>;</span><br><span class="line">        info.red.length     = <span class="number">8</span>;</span><br><span class="line">        info.green.offset   = <span class="number">16</span>;</span><br><span class="line">        info.green.length   = <span class="number">8</span>;</span><br><span class="line">        info.blue.offset    = <span class="number">8</span>;</span><br><span class="line">        info.blue.length    = <span class="number">8</span>;</span><br><span class="line">        info.transp.offset  = <span class="number">0</span>;</span><br><span class="line">        info.transp.length  = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Note: the GL driver does not have a r=8 g=8 b=8 a=0 config, so if we</span></span><br><span class="line"><span class="comment">         * do not use the MDP for composition (i.e. hw composition == 0), ask</span></span><br><span class="line"><span class="comment">         * for RGBA instead of RGBX. */</span></span><br><span class="line">        <span class="keyword">if</span> (property_get(<span class="string">"debug.sf.hw"</span>, property, <span class="literal">NULL</span>) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                                           atoi(property) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">module</span>-&gt;fbFormat = HAL_PIXEL_FORMAT_RGBX_8888;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(property_get(<span class="string">"debug.composition.type"</span>, property, <span class="literal">NULL</span>) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                (<span class="built_in">strncmp</span>(property, <span class="string">"mdp"</span>, <span class="number">3</span>) == <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">module</span>-&gt;fbFormat = HAL_PIXEL_FORMAT_RGBX_8888;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">module</span>-&gt;fbFormat = HAL_PIXEL_FORMAT_RGBA_8888;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Explicitly request 5/6/5</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        info.bits_per_pixel = <span class="number">16</span>;</span><br><span class="line">        info.red.offset     = <span class="number">11</span>;</span><br><span class="line">        info.red.length     = <span class="number">5</span>;</span><br><span class="line">        info.green.offset   = <span class="number">5</span>;</span><br><span class="line">        info.green.length   = <span class="number">6</span>;</span><br><span class="line">        info.blue.offset    = <span class="number">0</span>;</span><br><span class="line">        info.blue.length    = <span class="number">5</span>;</span><br><span class="line">        info.transp.offset  = <span class="number">0</span>;</span><br><span class="line">        info.transp.length  = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">module</span>-&gt;fbFormat = HAL_PIXEL_FORMAT_RGB_565;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//adreno needs 4k aligned offsets. Max hole size is 4096-1</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size = roundUpToPageSize(info.yres * info.xres *</span><br><span class="line">                                               (info.bits_per_pixel/<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Request NUM_BUFFERS screens (at least 2 for page flipping)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> numberOfBuffers = (<span class="keyword">int</span>)(finfo.smem_len/size);</span><br><span class="line">    ALOGV(<span class="string">"num supported framebuffers in kernel = %d"</span>, numberOfBuffers);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (property_get(<span class="string">"debug.gr.numframebuffers"</span>, property, <span class="literal">NULL</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> num = atoi(property);</span><br><span class="line">        <span class="keyword">if</span> ((num &gt;= NUM_FRAMEBUFFERS_MIN) &amp;&amp; (num &lt;= NUM_FRAMEBUFFERS_MAX)) &#123;</span><br><span class="line">            numberOfBuffers = num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (numberOfBuffers &gt; NUM_FRAMEBUFFERS_MAX)</span><br><span class="line">        numberOfBuffers = NUM_FRAMEBUFFERS_MAX;</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"We support %d buffers"</span>, numberOfBuffers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//consider the included hole by 4k alignment</span></span><br><span class="line">    <span class="keyword">uint32_t</span> line_length = (info.xres * info.bits_per_pixel / <span class="number">8</span>);</span><br><span class="line">    info.yres_virtual = (<span class="keyword">uint32_t</span>) ((size * numberOfBuffers) / line_length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> flags = PAGE_FLIP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info.yres_virtual &lt; ((size * <span class="number">2</span>) / line_length) ) &#123;</span><br><span class="line">        <span class="comment">// we need at least 2 for page-flipping</span></span><br><span class="line">        info.yres_virtual = (<span class="keyword">int</span>)(size / line_length);</span><br><span class="line">        flags &amp;= ~PAGE_FLIP;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, FBIOGET_VSCREENINFO, &amp;info) == <span class="number">-1</span>) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> -errno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">int</span>(info.width) &lt;= <span class="number">0</span> || <span class="keyword">int</span>(info.height) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        info.width  = (<span class="keyword">uint32_t</span>)(((<span class="keyword">float</span>)(info.xres) * <span class="number">25.4f</span>)/<span class="number">160.0f</span> + <span class="number">0.5f</span>);</span><br><span class="line">        info.height = (<span class="keyword">uint32_t</span>)(((<span class="keyword">float</span>)(info.yres) * <span class="number">25.4f</span>)/<span class="number">160.0f</span> + <span class="number">0.5f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> xdpi = ((<span class="keyword">float</span>)(info.xres) * <span class="number">25.4f</span>) / (<span class="keyword">float</span>)info.width;</span><br><span class="line">    <span class="keyword">float</span> ydpi = ((<span class="keyword">float</span>)(info.yres) * <span class="number">25.4f</span>) / (<span class="keyword">float</span>)info.height;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡IOæ§åˆ¶å‘½ä»¤FBIOGET_VSCREENINFOæ¥é‡æ–°è·å¾—ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„å¯å˜ä¿¡æ¯  </span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, FBIOGET_FSCREENINFO, &amp;finfo) == <span class="number">-1</span>) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> -errno;</span><br><span class="line">    &#125;......</span><br><span class="line">    <span class="keyword">module</span>-&gt;flags = flags;</span><br><span class="line">    <span class="keyword">module</span>-&gt;info = info;</span><br><span class="line">    <span class="keyword">module</span>-&gt;finfo = finfo;</span><br><span class="line">    <span class="keyword">module</span>-&gt;xdpi = xdpi;</span><br><span class="line">    <span class="keyword">module</span>-&gt;ydpi = ydpi;</span><br><span class="line">    <span class="keyword">module</span>-&gt;fps = fps;</span><br><span class="line">    <span class="keyword">module</span>-&gt;swapInterval = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * map the framebuffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">module</span>-&gt;numBuffers = info.yres_virtual / info.yres;</span><br><span class="line">    <span class="keyword">module</span>-&gt;bufferMask = <span class="number">0</span>;</span><br><span class="line">   <span class="comment">//æ•´ä¸ªç³»ç»Ÿå¸§ç¼“å†²åŒºçš„å¤§å°=è™šæ‹Ÿåˆ†è¾¨ç‡çš„é«˜åº¦å€¼info.yres_virtual * æ¯ä¸€è¡Œæ‰€å ç”¨çš„å­—èŠ‚æ•°finfo.line_length,å¹¶å°†æ•´ä¸ªç³»ç»Ÿå¸§ç¼“å†²åŒºçš„å¤§å°å¯¹é½åˆ°é¡µé¢è¾¹ç•Œ  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> fbSize = roundUpToPageSize(finfo.line_length * info.yres)*</span><br><span class="line">                    <span class="keyword">module</span>-&gt;numBuffers;</span><br><span class="line">   <span class="comment">//ç³»ç»Ÿå¸§ç¼“å†²åŒºåœ¨å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­çš„èµ·å§‹åœ°å€ä¿å­˜åˆ°private_handle_tçš„åŸŸbaseä¸­  </span></span><br><span class="line">    <span class="keyword">void</span>* vaddr = mmap(<span class="number">0</span>, fbSize, PROT_READ|PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//store the framebuffer fd in the ctx</span></span><br><span class="line">    ctx-&gt;fbFd = fd;</span><br><span class="line">   ......</span><br><span class="line">   <span class="comment">//åˆ›å»ºä¸€ä¸ªprivate_handle_tï¼Œç”¨æ¥æè¿°æ•´ä¸ªç³»ç»Ÿå¸§ç¼“å†²åŒºçš„ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// Create framebuffer handle using the ION fd</span></span><br><span class="line">    <span class="keyword">module</span>-&gt;framebuffer = <span class="keyword">new</span> <span class="keyword">private_handle_t</span>(fd, fbSize,</span><br><span class="line">                                        <span class="keyword">private_handle_t</span>::PRIV_FLAGS_USES_ION,</span><br><span class="line">                                        BUFFER_TYPE_UI,</span><br><span class="line">                                        <span class="keyword">module</span>-&gt;fbFormat, info.xres, info.yres);</span><br><span class="line">    <span class="comment">//ä»¥è¯»å†™å…±äº«æ–¹å¼å°†å¸§ç¼“å†²åŒºæ˜ å°„åˆ°å½“å‰è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">module</span>-&gt;framebuffer-&gt;base = <span class="keyword">uint64_t</span>(vaddr);</span><br><span class="line">    <span class="built_in">memset</span>(vaddr, <span class="number">0</span>, fbSize);</span><br><span class="line">    <span class="comment">//Enable vsync</span></span><br><span class="line">    <span class="keyword">int</span> enable = <span class="number">1</span>;</span><br><span class="line">    ioctl(ctx-&gt;fbFd, MSMFB_OVERLAY_VSYNC_CTRL, &amp;enable);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3ã€GPUè®¾å¤‡æ‰“å¼€è¿‡ç¨‹gralloc-open"><a href="#2-3ã€GPUè®¾å¤‡æ‰“å¼€è¿‡ç¨‹gralloc-open" class="headerlink" title="2.3ã€GPUè®¾å¤‡æ‰“å¼€è¿‡ç¨‹gralloc_open()"></a>2.3ã€GPUè®¾å¤‡æ‰“å¼€è¿‡ç¨‹gralloc_open()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware\include\hardware\gralloc.h]</span><br><span class="line"><span class="comment">/** convenience API for opening and closing a supported device */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">gralloc_open</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">        struct <span class="keyword">alloc_device_t</span>** device)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">module</span>-&gt;methods-&gt;open(<span class="keyword">module</span>, </span><br><span class="line">            GRALLOC_HARDWARE_GPU0, (struct <span class="keyword">hw_device_t</span>**)device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¼šèµ°åˆ°gralloc_device_open()å‡½æ•°<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware\include\hardware\gralloc.cpp]</span><br><span class="line"></span><br><span class="line"><span class="comment">// HAL module methods</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_methods_t</span> <span class="title">gralloc_module_methods</span> = &#123;</span></span><br><span class="line">    .open = gralloc_device_open</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Open Gralloc device</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gralloc_device_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, <span class="keyword">const</span> <span class="keyword">char</span>* name,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">hw_device_t</span>** device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, GRALLOC_HARDWARE_GPU0)) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">private_module_t</span>* m = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">private_module_t</span>*&gt;(</span><br><span class="line">            <span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">gpu_context_t</span> *dev;</span><br><span class="line">        IAllocController* alloc_ctrl = IAllocController::getInstance();</span><br><span class="line">        dev = <span class="keyword">new</span> <span class="keyword">gpu_context_t</span>(m, alloc_ctrl);</span><br><span class="line">        ......</span><br><span class="line">        *device = &amp;dev-&gt;common;</span><br><span class="line">        status = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        status = fb_device_open(<span class="keyword">module</span>, name, device);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªgpu_context_t ç»“æ„ä½“ï¼Œå¹¶ä¸”å¯¹å®ƒçš„æˆå‘˜å˜é‡deviceè¿›è¡Œåˆå§‹åŒ–ã€‚gpu_context_tç±»ç»§æ‰¿äº†alloc_device_tï¼Œå¹¶å®ç°äº†alloc_device_tä¸­çš„allocï¼Œfreeç­‰æ–¹æ³•ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\gpu.cpp]</span><br><span class="line"><span class="keyword">gpu_context_t</span>::<span class="keyword">gpu_context_t</span>(<span class="keyword">const</span> <span class="keyword">private_module_t</span>* <span class="keyword">module</span>,</span><br><span class="line">                             IAllocController* alloc_ctrl ) :</span><br><span class="line">    mAllocCtrl(alloc_ctrl)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Zero out the alloc_device_t</span></span><br><span class="line">    <span class="built_in">memset</span>(<span class="keyword">static_cast</span>&lt;<span class="keyword">alloc_device_t</span>*&gt;(<span class="keyword">this</span>), <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">alloc_device_t</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the procs</span></span><br><span class="line">    common.tag     = HARDWARE_DEVICE_TAG;</span><br><span class="line">    common.version = <span class="number">0</span>;</span><br><span class="line">    common.<span class="keyword">module</span>  = <span class="keyword">const_cast</span>&lt;<span class="keyword">hw_module_t</span>*&gt;(&amp;<span class="keyword">module</span>-&gt;base.common);</span><br><span class="line">    common.close   = gralloc_close;</span><br><span class="line">    alloc          = gralloc_alloc;</span><br><span class="line">    <span class="built_in">free</span>           = gralloc_free;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å®Œæˆalloc_device_tå‚æ•°çš„åˆå§‹åŒ–ã€‚å…¶æˆå‘˜å‡½æ•°allocï¼Œfreeè¢«è®¾ç½®æˆgralloc_alloc &amp; gralloc_freeã€‚è‡ªæ­¤ï¼Œallocè®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹å°±åˆ†æå®Œæˆäº†ã€‚<br>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‡ç‚¹åˆ†æalloc_device_tä¸­æä¾›çš„å‡ ä¸ªå…³é”®å‡½æ•°ã€‚</p><h4 id="ï¼ˆä¸‰ï¼‰ã€-Grallocåˆ†é…å’Œé‡Šæ”¾Buffer"><a href="#ï¼ˆä¸‰ï¼‰ã€-Grallocåˆ†é…å’Œé‡Šæ”¾Buffer" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€ Grallocåˆ†é…å’Œé‡Šæ”¾Buffer"></a>ï¼ˆä¸‰ï¼‰ã€ Grallocåˆ†é…å’Œé‡Šæ”¾Buffer</h4><h5 id="3-1ã€Grallocåˆ†é…buffer"><a href="#3-1ã€Grallocåˆ†é…buffer" class="headerlink" title="3.1ã€Grallocåˆ†é…buffer"></a>3.1ã€Grallocåˆ†é…buffer</h5><p>å…ˆæ¥å›å¿†ä¸€ä¸‹SurfacFlingerå›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GraphicBuffer::GraphicBuffer </span><br><span class="line">  -&gt; initSize </span><br><span class="line">    -&gt; GraphicBufferAllocator::alloc </span><br><span class="line">      -&gt; <span class="keyword">alloc_device_t</span>::alloc </span><br><span class="line">        -&gt; gralloc_alloc</span><br></pre></td></tr></table></figure><p>ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºç”¨åˆ°çš„å›¾å½¢ç¼“å†²åŒºæ˜¯ç”±Grallocæ¨¡å—ä¸­çš„å‡½æ•°gralloc_allocæ¥åˆ†é…çš„ï¼Œè¿™ä¸ªå‡½æ•°å®ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\gpu.cpp]</span><br><span class="line"><span class="keyword">int</span> <span class="keyword">gpu_context_t</span>::gralloc_alloc(<span class="keyword">alloc_device_t</span>* dev, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format,</span><br><span class="line">                                 <span class="keyword">int</span> usage, <span class="keyword">buffer_handle_t</span>* pHandle,</span><br><span class="line">                                 <span class="keyword">int</span>* pStride)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">gpu_context_t</span>* gpu = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">gpu_context_t</span>*&gt;(dev);</span><br><span class="line">    <span class="keyword">return</span> gpu-&gt;alloc_impl(w, h, format, usage, pHandle, pStride, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">gpu_context_t</span>::alloc_impl(<span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> usage,</span><br><span class="line">                              <span class="keyword">buffer_handle_t</span>* pHandle, <span class="keyword">int</span>* pStride,</span><br><span class="line">                              <span class="keyword">unsigned</span> <span class="keyword">int</span> bufferSize) &#123;</span><br><span class="line">   </span><br><span class="line">    ......</span><br><span class="line">     <span class="comment">// å‚æ•°formatç”¨æ¥æè¿°è¦åˆ†é…çš„å›¾å½¢ç¼“å†²åŒºçš„é¢œè‰²æ ¼å¼ã€‚è¿™äº›æ ¼å¼å®šä¹‰åœ¨system/core/include/system/graphic.hä¸­</span></span><br><span class="line">    <span class="keyword">if</span>(format == HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED ||</span><br><span class="line">       format == HAL_PIXEL_FORMAT_YCbCr_420_888) &#123;</span><br><span class="line">        <span class="keyword">if</span> (usage &amp; GRALLOC_USAGE_PRIVATE_ALLOC_UBWC)</span><br><span class="line">            grallocFormat = HAL_PIXEL_FORMAT_YCbCr_420_SP_VENUS_UBWC;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(usage &amp; GRALLOC_USAGE_HW_VIDEO_ENCODER)</span><br><span class="line">            grallocFormat = HAL_PIXEL_FORMAT_NV12_ENCODEABLE; <span class="comment">//NV12</span></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®buffertypeï¼ŒBUFFER_TYPE_UI: RGB formats &amp; HAL_PIXEL_FORMAT_R_8 &amp;HAL_PIXEL_FORMAT_RG_88ã€‚å…¶ä»–çš„éƒ½ä¸ºBUFFER_TYPE_VIDEO</span></span><br><span class="line">    getGrallocInformationFromFormat(grallocFormat, &amp;bufferType);</span><br><span class="line">    <span class="comment">// æ ¹æ®formate &amp; wï¼Œhç®—å‡ºbuffersize</span></span><br><span class="line">    size = getBufferSizeAndDimensions(w, h, grallocFormat, usage, alignedw,</span><br><span class="line">                   alignedh);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    size = (bufferSize &gt;= size)? bufferSize : size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(useFbMem) &#123;</span><br><span class="line">        err = gralloc_alloc_framebuffer(usage, pHandle);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = gralloc_alloc_buffer(size, usage, pHandle, bufferType,</span><br><span class="line">                                   grallocFormat, alignedw, alignedh);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    *pStride = alignedw;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ ¹æ®memory allocå‡ºå¤„ï¼ŒåŒºåˆ«è°ƒç”¨gralloc_alloc_framebuffer&amp;  gralloc_alloc_bufferå‡½æ•°ã€‚</p><p>é¦–å…ˆæ¥çœ‹çœ‹ gralloc_alloc_framebufferçš„å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\gpu.cpp]</span><br><span class="line"><span class="keyword">int</span> <span class="keyword">gpu_context_t</span>::gralloc_alloc_framebuffer_locked(<span class="keyword">int</span> usage,</span><br><span class="line">                                                    <span class="keyword">buffer_handle_t</span>* pHandle)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å˜é‡bufferMaskç”¨æ¥æè¿°ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">    <span class="comment">// å˜é‡numBuffersç”¨æ¥æè¿°ç³»ç»Ÿå¸§ç¼“å†²åŒºå¯ä»¥åˆ’åˆ†ä¸ºå¤šå°‘ä¸ªå›¾å½¢ç¼“å†²åŒºæ¥ä½¿ç”¨</span></span><br><span class="line">    <span class="comment">// å˜é‡bufferSizeç”¨æ¥æè¿°è®¾å¤‡æ˜¾ç¤ºå±ä¸€å±å†…å®¹æ‰€å ç”¨çš„å†…å­˜çš„å¤§å°,åŒæ—¶é«˜é€šçš„ç¡¬ä»¶è¦æ±‚4Kå¯¹é½ã€‚</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> bufferMask = m-&gt;bufferMask;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint32_t</span> numBuffers = m-&gt;numBuffers;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bufferSize = m-&gt;finfo.line_length * m-&gt;info.yres;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//adreno needs FB size to be page aligned</span></span><br><span class="line">    bufferSize = roundUpToPageSize(bufferSize);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‡è®¾æ­¤æ—¶ç³»ç»Ÿå¸§ç¼“å†²åŒºä¸­å°šæœ‰ç©ºé—²çš„å›¾å½¢ç¼“å†²åŒºçš„ï¼Œæ¥ä¸‹æ¥å‡½æ•°å°±ä¼šåˆ›å»ºä¸€ä¸ªprivate_handle_tç»“æ„ä½“hndæ¥æè¿°è¿™ä¸ªå³å°†è¦åˆ†é…å‡ºå»çš„å›¾å½¢ç¼“å†²åŒºã€‚æ³¨æ„ï¼Œè¿™ä¸ªå›¾å½¢ç¼“å†²åŒºçš„æ ‡å¿—å€¼ç­‰äºPRIV_FLAGS_FRAMEBUFFERï¼Œå³è¡¨ç¤ºè¿™æ˜¯ä¸€å—åœ¨ç³»ç»Ÿå¸§ç¼“å†²åŒºä¸­åˆ†é…çš„å›¾å½¢ç¼“å†²åŒºã€‚</span></span><br><span class="line">    <span class="keyword">uint64_t</span> vaddr = <span class="keyword">uint64_t</span>(m-&gt;framebuffer-&gt;base);</span><br><span class="line">    <span class="comment">// As GPU needs ION FD, the private handle is created</span></span><br><span class="line">    <span class="comment">// using ION fd and ION flags are set</span></span><br><span class="line">    <span class="keyword">private_handle_t</span>* hnd = <span class="keyword">new</span> <span class="keyword">private_handle_t</span>(</span><br><span class="line">        dup(m-&gt;framebuffer-&gt;fd), bufferSize,</span><br><span class="line">        <span class="keyword">private_handle_t</span>::PRIV_FLAGS_USES_ION |</span><br><span class="line">        <span class="keyword">private_handle_t</span>::PRIV_FLAGS_FRAMEBUFFER,</span><br><span class="line">        BUFFER_TYPE_UI, m-&gt;fbFormat, m-&gt;info.xres,</span><br><span class="line">        m-&gt;info.yres);</span><br><span class="line">    <span class="comment">//  æ¥ä¸‹æ¥çš„forå¾ªç¯ä»ä½ä½åˆ°é«˜ä½æ£€æŸ¥å˜é‡bufferMaskçš„å€¼ï¼Œå¹¶ä¸”æ‰¾åˆ°ç¬¬ä¸€ä¸ªå€¼ç­‰äº0çš„ä½ï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“åœ¨ç³»ç»Ÿå¸§ç¼“å†²åŒºä¸­ï¼Œç¬¬å‡ ä¸ªå›¾å½¢ç¼“å†²åŒºçš„æ˜¯ç©ºé—²çš„ã€‚æ³¨æ„ï¼Œå˜é‡vadrrçš„å€¼å¼€å§‹çš„æ—¶å€™æŒ‡å‘ç³»ç»Ÿå¸§ç¼“å†²åŒºçš„åŸºåœ°å€ï¼Œåœ¨ä¸‹é¢çš„forå¾ªç¯ä¸­ï¼Œæ¯å¾ªç¯ä¸€æ¬¡å®ƒçš„å€¼éƒ½ä¼šå¢åŠ bufferSizeã€‚ä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºï¼Œæ¯æ¬¡ä»ç³»ç»Ÿå¸§ç¼“å†²åŒºä¸­åˆ†é…å‡ºå»çš„å›¾å½¢ç¼“å†²åŒºçš„å¤§å°éƒ½æ˜¯åˆšå¥½ç­‰äºæ˜¾ç¤ºå±ä¸€å±å†…å®¹å¤§å°çš„ã€‚</span></span><br><span class="line">    <span class="comment">// find a free slot</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i=<span class="number">0</span> ; i&lt;numBuffers ; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((bufferMask &amp; (<span class="number">1L</span>U&lt;&lt;i)) == <span class="number">0</span>) &#123;</span><br><span class="line">            m-&gt;bufferMask |= (<span class="keyword">uint32_t</span>)(<span class="number">1L</span>U&lt;&lt;i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        vaddr += bufferSize;</span><br><span class="line">    &#125;</span><br><span class="line">    / å°†åˆ†é…çš„ç¼“å†²åŒºçš„å¼€å§‹åœ°å€ä¿å­˜åˆ°å˜é‡baseä¸­ï¼Œè¿™æ ·ç”¨æˆ·æ§ä»¶çš„åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥å°†éœ€è¦æ¸²æŸ“çš„å›¾å½¢å†…å®¹æ‹·è´åˆ°è¿™ä¸ªåœ°å€ä¸Šã€‚è¿™æ ·ï¼Œå°±ç›¸å½“äºæ˜¯ç›´æ¥å°†å›¾å½¢æ¸²æŸ“åˆ°ç³»ç»Ÿå¸§ç¼“å†²åŒºä¸­å»ã€‚</span><br><span class="line"><span class="comment">// offsetè¡¨ç¤ºåˆ†é…åˆ°çš„å›¾å½¢ç¼“å†²åŒºçš„èµ·å§‹åœ°å€æ­£å¯¹äºç³»ç»Ÿå¸§ç¼“å†²åŒºåŸºåœ°å€çš„åç§»é‡ã€‚</span></span><br><span class="line">    hnd-&gt;base = vaddr;</span><br><span class="line">    hnd-&gt;offset = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(vaddr - m-&gt;framebuffer-&gt;base);</span><br><span class="line">    *pHandle = hnd;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">gpu_context_t</span>::gralloc_alloc_framebuffer(<span class="keyword">int</span> usage,</span><br><span class="line">                                             <span class="keyword">buffer_handle_t</span>* pHandle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private_module_t</span>* m = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">private_module_t</span>*&gt;(common.<span class="keyword">module</span>);</span><br><span class="line">    pthread_mutex_lock(&amp;m-&gt;lock);</span><br><span class="line">    <span class="keyword">int</span> err = gralloc_alloc_framebuffer_locked(usage, pHandle);</span><br><span class="line">    pthread_mutex_unlock(&amp;m-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åˆ†æäº†ä»framebufferä¸­åˆ†é…å›¾å½¢ç¼“å†²åŒºçš„è¿‡ç¨‹ã€‚æ€»ç»“ä¸‹è¿™å—bufferçš„æ¥å†ã€‚é¦–å…ˆåœ¨fbè®¾å¤‡opençš„æ—¶å€™ï¼Œé€šè¿‡mmapä»fb0ä¸­æ˜ å°„ä¸€å—å†…å­˜åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå³ä¸€ä¸ªå†…å­˜æ± ï¼ˆmodule-&gt;framebuffer)ï¼Œé€šè¿‡bufferMaskæ¥è¡¨ç¤ºè¯¥æ± ä¸­å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚è€Œallocåšçš„äº‹æƒ…ï¼Œå°±æ˜¯ä»è¿™ä¸ªå†…å­˜æ± ä¸­æ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„åŒºå—ï¼Œç„¶åè¿”å›è¯¥åŒºå—çš„hanlderæŒ‡é’ˆpHandleã€‚</p><p>æˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹ä»å†…å­˜ä¸­åˆ†é…å›¾å½¢ç¼“å†²åŒºçš„æƒ…å†µã€‚ä»Android 4.0å¼€å§‹ï¼ŒAndroidå¯åŠ¨æ–°çš„å†…å­˜ç®¡ç†æ–¹å¼IONï¼Œä»¥å–ä»£PMEMã€‚PMEMéœ€è¦ä¸€ä¸ªè¿ç»­çš„ç‰©ç†å†…å­˜ï¼ŒåŒæ—¶éœ€è¦åœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ï¼Œå°±å®Œæˆåˆ†é…ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\gpu.cpp]</span><br><span class="line"><span class="keyword">int</span> <span class="keyword">gpu_context_t</span>::gralloc_alloc_buffer(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">int</span> usage,</span><br><span class="line">                                        <span class="keyword">buffer_handle_t</span>* pHandle, <span class="keyword">int</span> bufferType,</span><br><span class="line">                                        <span class="keyword">int</span> format, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line">    size = roundUpToPageSize(size);</span><br><span class="line">    <span class="comment">// é¦–å…ˆåˆ†é…ä¸€ä¸ªdataåŒºåŸŸ</span></span><br><span class="line">    alloc_data data;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// è¿½æŸ¥ä»£ç å¯ä»¥çŸ¥é“mallocCtrlæŒ‡å‘IonControllerå¯¹è±¡ï¼Œå…³é”®ä»£ç å¯ä»¥å‚è€ƒhardware/qrom/display/msm8974/libgralloc/alloc_controller.cppã€‚å…·ä½“æ€ä¹ˆä»ionä¸­åˆ†é…buffer</span></span><br><span class="line">    data.size = size;</span><br><span class="line">    data.pHandle = (<span class="keyword">uintptr_t</span>) pHandle;</span><br><span class="line">    err = mAllocCtrl-&gt;allocate(data, usage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        <span class="comment">/* allocate memory for enhancement data */</span></span><br><span class="line">        alloc_data eData;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">int</span> eDataErr = mAllocCtrl-&gt;allocate(eData, eDataUsage);</span><br><span class="line">        ......</span><br><span class="line">        flags |= data.allocType;</span><br><span class="line">        <span class="keyword">uint64_t</span> eBaseAddr = (<span class="keyword">uint64_t</span>)(eData.base) + eData.offset;</span><br><span class="line">        <span class="keyword">private_handle_t</span> *hnd = <span class="keyword">new</span> <span class="keyword">private_handle_t</span>(data.fd, size, flags,</span><br><span class="line">                bufferType, format, width, height, eData.fd, eData.offset,</span><br><span class="line">                eBaseAddr);</span><br><span class="line"></span><br><span class="line">        hnd-&gt;offset = data.offset;</span><br><span class="line">        hnd-&gt;base = (<span class="keyword">uint64_t</span>)(data.base) + data.offset;</span><br><span class="line">        hnd-&gt;gpuaddr = <span class="number">0</span>;</span><br><span class="line">        ColorSpace_t colorSpace = ITU_R_601;</span><br><span class="line">        setMetaData(hnd, UPDATE_COLOR_SPACE, (<span class="keyword">void</span>*) &amp;colorSpace);</span><br><span class="line"></span><br><span class="line">        *pHandle = hnd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ALOGE_IF(err, <span class="string">"gralloc failed err=%s"</span>, strerror(-err));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-2ã€Grallocé‡Šæ”¾buffer"><a href="#3-2ã€Grallocé‡Šæ”¾buffer" class="headerlink" title="3.2ã€Grallocé‡Šæ”¾buffer"></a>3.2ã€Grallocé‡Šæ”¾buffer</h5><p>é‡Šæ”¾bufferæœ¬è´¨æ˜¯è°ƒç”¨gralloc_freeå‡½æ•°ï¼Œè¯¥å‡½æ•°åˆè°ƒç”¨äº†free_implå‡½æ•°ã€‚åœ¨å¤„ç†free bufferçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯æŒ‰ç…§ä¸¤ç§æƒ…å†µæ¥åˆ†åˆ«å¤„ç†çš„ã€‚å¦‚æœä¹‹å‰è¿™ä¸ªbufferæ˜¯ä»framebufferåˆ†é…çš„è¯ï¼Œå°±åªè¦æŠŠbufferMaskä¸­è®¾ç½®æˆ0å³å¯ã€‚è€Œå¯¹åº”ä»å†…å­˜ä¸­ç”³è¯·çš„ï¼Œåˆ™æ˜¯è°ƒç”¨allocCtrlï¼ˆionï¼‰ä¸­çš„free_bufferæ¥å®Œæˆé‡Šæ”¾ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\display\msm8996\libgralloc\framebuffer.cpp]</span><br><span class="line"><span class="keyword">int</span> <span class="keyword">gpu_context_t</span>::free_impl(<span class="keyword">private_handle_t</span> <span class="keyword">const</span>* hnd) &#123;</span><br><span class="line">    <span class="keyword">private_module_t</span>* m = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">private_module_t</span>*&gt;(common.<span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">if</span> (hnd-&gt;flags &amp; <span class="keyword">private_handle_t</span>::PRIV_FLAGS_FRAMEBUFFER) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> bufferSize = m-&gt;finfo.line_length * m-&gt;info.yres;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> index = (<span class="keyword">unsigned</span> <span class="keyword">int</span>) ((hnd-&gt;base - m-&gt;framebuffer-&gt;base)</span><br><span class="line">                / bufferSize);</span><br><span class="line">        m-&gt;bufferMask &amp;= (<span class="keyword">uint32_t</span>)~(<span class="number">1L</span>U&lt;&lt;index);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        terminateBuffer(&amp;m-&gt;base, <span class="keyword">const_cast</span>&lt;<span class="keyword">private_handle_t</span>*&gt;(hnd));</span><br><span class="line">        IMemAlloc* memalloc = mAllocCtrl-&gt;getAllocator(hnd-&gt;flags);</span><br><span class="line">        <span class="keyword">int</span> err = memalloc-&gt;free_buffer((<span class="keyword">void</span>*)hnd-&gt;base, hnd-&gt;size,</span><br><span class="line">                                        hnd-&gt;offset, hnd-&gt;fd);</span><br><span class="line">        <span class="keyword">if</span>(err)</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        <span class="comment">// free the metadata space</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> size = ROUND_UP_PAGESIZE(<span class="keyword">sizeof</span>(MetaData_t));</span><br><span class="line">        err = memalloc-&gt;free_buffer((<span class="keyword">void</span>*)hnd-&gt;base_metadata,</span><br><span class="line">                                    size, hnd-&gt;offset_metadata,</span><br><span class="line">                                    hnd-&gt;fd_metadata);</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> hnd;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆå››ï¼‰ã€å›¾å½¢ç¼“å†²åŒºæ˜ å°„è¿‡ç¨‹"><a href="#ï¼ˆå››ï¼‰ã€å›¾å½¢ç¼“å†²åŒºæ˜ å°„è¿‡ç¨‹" class="headerlink" title="ï¼ˆå››ï¼‰ã€å›¾å½¢ç¼“å†²åŒºæ˜ å°„è¿‡ç¨‹"></a>ï¼ˆå››ï¼‰ã€å›¾å½¢ç¼“å†²åŒºæ˜ å°„è¿‡ç¨‹</h4><p> å›¾å½¢ç¼“å†²åŒºå¯ä»¥ä»ç³»ç»Ÿå¸§ç¼“å†²åŒºåˆ†é…ä¹Ÿå¯ä»¥ä»å†…å­˜ä¸­åˆ†é…ï¼Œåˆ†é…ä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºåè¿˜éœ€è¦å°†è¯¥å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°åˆ†é…è¯¥bufferçš„è¿›ç¨‹åœ°å€ç©ºé—´æ¥ï¼Œåœ¨Androidç³»ç»Ÿä¸­ï¼Œå›¾å½¢ç¼“å†²åŒºçš„ç®¡ç†ç”±SurfaceFlingeræœåŠ¡æ¥è´Ÿè´£ã€‚åœ¨ç³»ç»Ÿå¸§ç¼“å†²åŒºä¸­åˆ†é…çš„å›¾å½¢ç¼“å†²åŒºæ˜¯åœ¨SurfaceFlingeræœåŠ¡ä¸­ä½¿ç”¨ï¼Œè€Œåœ¨å†…å­˜ä¸­åˆ†é…çš„å›¾å½¢ç¼“å†²åŒºæ—¢å¯ä»¥åœ¨SurfaceFlingeræœåŠ¡ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨å…¶å®ƒçš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚å½“å…¶å®ƒçš„åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨å›¾å½¢ç¼“å†²åŒºçš„æ—¶å€™ï¼Œå®ƒä»¬å°±ä¼šè¯·æ±‚SurfaceFlingeræœåŠ¡ä¸ºå®ƒä»¬åˆ†é…å¹¶å°†SurfaceFlingeræœåŠ¡è¿”å›æ¥çš„å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹åœ°å€ç©ºé—´ã€‚åœ¨ä»å†…å­˜ä¸­åˆ†é…bufferæ—¶ï¼Œå·²ç»å°†åˆ†é…çš„bufferæ˜ å°„åˆ°äº†SurfaceFlingeræœåŠ¡è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œå¦‚æœè¯¥bufferæ˜¯åº”ç”¨ç¨‹åºè¯·æ±‚SurfaceFlingeræœåŠ¡ä¸ºå®ƒä»¬åˆ†é…çš„ï¼Œé‚£ä¹ˆè¿˜éœ€è¦å°†SurfaceFlingeræœåŠ¡è¿”å›æ¥çš„å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹åœ°å€ç©ºé—´ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-04-04-grallocbuffer.jpg" alt="Alt text | center"></p><p>ä¸€ä¸ªå¯¹è±¡è¦åœ¨è¿›ç¨‹é—´ä¼ è¾“å¿…é¡»ç»§æ‰¿äºFlattenableç±»ï¼Œå¹¶ä¸”å®ç°flattenå’Œunflattenæ–¹æ³•ï¼Œflattenæ–¹æ³•ç”¨äºåºåˆ—åŒ–è¯¥å¯¹è±¡ï¼Œunflattenæ–¹æ³•ç”¨äºååºåˆ—åŒ–å¯¹è±¡ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-04-05-graphicbuffer-flatten.jpg" alt="Alt text | center"></p><p>GraphicBufferç±»ä»æ¨¡æ¿ç±»Flattenableæ´¾ç”Ÿï¼Œè¿™ä¸ªæ´¾ç”Ÿç±»å¯ä»¥é€šè¿‡Parcelä¼ é€’ï¼Œé€šå¸¸æ´¾ç”Ÿç±»éœ€è¦é‡è½½flattenå’Œunflattenæ–¹æ³•ï¼Œç”¨äºå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><p>1ï¼‰å°†ä¸€ä¸ªå¯¹è±¡å†™å…¥åˆ°Parcelä¸­ï¼Œéœ€è¦ä½¿ç”¨flattenå‡½æ•°åºåˆ—åŒ–è¯¥å¯¹è±¡ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹flattenå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\libs\ui\GraphicBuffer.cpp]</span><br><span class="line"><span class="keyword">status_t</span> GraphicBuffer::flatten(<span class="keyword">void</span>*&amp; buffer, <span class="keyword">size_t</span>&amp; size, <span class="keyword">int</span>*&amp; fds, <span class="keyword">size_t</span>&amp; count) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">size_t</span> sizeNeeded = GraphicBuffer::getFlattenedSize();</span><br><span class="line">    <span class="keyword">if</span> (size &lt; sizeNeeded) <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> fdCountNeeded = GraphicBuffer::getFdCount();</span><br><span class="line">    <span class="keyword">if</span> (count &lt; fdCountNeeded) <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span>* buf = <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>*&gt;(buffer);</span><br><span class="line">    buf[0] = 'GBFR';</span><br><span class="line">    buf[<span class="number">1</span>] = width;</span><br><span class="line">    buf[<span class="number">2</span>] = height;</span><br><span class="line">    buf[<span class="number">3</span>] = stride;</span><br><span class="line">    buf[<span class="number">4</span>] = format;</span><br><span class="line">    buf[<span class="number">5</span>] = usage;</span><br><span class="line">    buf[<span class="number">6</span>] = <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(mId &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    buf[<span class="number">7</span>] = <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(mId &amp; <span class="number">0xFFFFFFFF</span>ull);</span><br><span class="line">    buf[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    buf[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handle) &#123;</span><br><span class="line">        buf[<span class="number">8</span>] = handle-&gt;numFds;</span><br><span class="line">        buf[<span class="number">9</span>] = handle-&gt;numInts;</span><br><span class="line">        <span class="keyword">native_handle_t</span> <span class="keyword">const</span>* <span class="keyword">const</span> h = handle;</span><br><span class="line">        <span class="comment">//æŠŠhandleä¸­çš„dataå¤åˆ¶åˆ°fdsä¸­ </span></span><br><span class="line">        <span class="built_in">memcpy</span>(fds,     h-&gt;data,             h-&gt;numFds*<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buf[<span class="number">10</span>], h-&gt;data + h-&gt;numFds, h-&gt;numInts*<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buffer = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>*&gt;(buffer) + sizeNeeded);</span><br><span class="line">    size -= sizeNeeded;</span><br><span class="line">    <span class="keyword">if</span> (handle) &#123;</span><br><span class="line">        fds += handle-&gt;numFds;</span><br><span class="line">        count -= handle-&gt;numFds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªhandleç±»å‹ä¸ºnative_handle_t ï¼Œä¸”typedefæˆäº†buffer_handle_tï¼Œæˆ‘ä»¬è´´ä¸€ä¸‹å®ƒçš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/system/core/include/cutils/native_handle.h]</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">native_handle</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">    <span class="keyword">int</span> version; <span class="comment">//è®¾ç½®ä¸ºç»“æ„ä½“native_handle_tçš„å¤§å°ï¼Œç”¨æ¥æ ‡è¯†ç»“æ„ä½“native_handle_tçš„ç‰ˆæœ¬  </span></span><br><span class="line">    <span class="keyword">int</span> numFds;  <span class="comment">//è¡¨ç¤ºç»“æ„ä½“native_handle_tæ‰€åŒ…å«çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œè¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¿å­˜åœ¨æˆå‘˜å˜é‡dataæ‰€æŒ‡å‘çš„ä¸€å—ç¼“å†²åŒºä¸­ã€‚  </span></span><br><span class="line">    <span class="keyword">int</span> numInts; <span class="comment">//è¡¨ç¤ºç»“æ„ä½“native_handle_tæ‰€åŒ…å«çš„æ•´æ•°å€¼çš„ä¸ªæ•°ï¼Œè¿™äº›æ•´æ•°ä¿å­˜åœ¨æˆå‘˜å˜é‡dataæ‰€æŒ‡å‘çš„ä¸€å—ç¼“å†²åŒºä¸­ã€‚  </span></span><br><span class="line">    <span class="keyword">int</span> data[<span class="number">0</span>]; <span class="comment">//æŒ‡å‘çš„ä¸€å—ç¼“å†²åŒºä¸­  </span></span><br><span class="line">&#125; <span class="keyword">native_handle_t</span>;</span><br></pre></td></tr></table></figure><p> æ‰€ä»¥æˆ‘ä»¬å›åˆ°flattenå‡½æ•°ä¸­ï¼Œfdså‚æ•°ç”¨æ¥ä¼ é€’æ–‡ä»¶å¥æŸ„ï¼Œå‡½æ•°æŠŠhandleä¸­çš„è¡¨ç¤ºæŒ‡å‘å›¾å½¢ç¼“å†²åŒºæ–‡ä»¶æè¿°ç¬¦å¥æŸ„å¤åˆ¶åˆ°fdsä¸­ï¼Œå› æ­¤è¿™äº›å¥æŸ„å°±èƒ½é€šè¿‡binderä¼ é€’åˆ°ç›®æ ‡è¿›ç¨‹ä¸­å»ã€‚</p><p>2ï¼‰åœ¨åº”ç”¨ç¨‹åºè¯»å–æ¥è‡ªæœåŠ¡è¿›ç¨‹çš„GraphicBufferå¯¹è±¡æ—¶ï¼Œä¹Ÿå°±æ˜¯result = reply.read(*p)ï¼Œä¼šè°ƒç”¨GraphicBufferç±»çš„unflattenå‡½æ•°è¿›è¡Œååºåˆ—åŒ–è¿‡ç¨‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\libs\ui\GraphicBuffer.cpp]</span><br><span class="line"><span class="keyword">status_t</span> GraphicBuffer::unflatten(</span><br><span class="line">        <span class="keyword">void</span> <span class="keyword">const</span>*&amp; buffer, <span class="keyword">size_t</span>&amp; size, <span class="keyword">int</span> <span class="keyword">const</span>*&amp; fds, <span class="keyword">size_t</span>&amp; count) &#123;</span><br><span class="line">    <span class="keyword">if</span> (size &lt; <span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">int</span>)) <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">const</span>* buf = <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span> <span class="keyword">const</span>*&gt;(buffer);</span><br><span class="line">    if (buf[0] != 'GBFR') return BAD_TYPE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> numFds  = buf[<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> numInts = buf[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> sizeNeeded = (<span class="number">10</span> + numInts) * <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">if</span> (size &lt; sizeNeeded) <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> fdCountNeeded = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; fdCountNeeded) <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handle) &#123;</span><br><span class="line">        <span class="comment">// free previous handle if any</span></span><br><span class="line">        free_handle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numFds || numInts) &#123;</span><br><span class="line">        width  = buf[<span class="number">1</span>];</span><br><span class="line">        height = buf[<span class="number">2</span>];</span><br><span class="line">        stride = buf[<span class="number">3</span>];</span><br><span class="line">        format = buf[<span class="number">4</span>];</span><br><span class="line">        usage  = buf[<span class="number">5</span>];</span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªnative_handleå¯¹è±¡</span></span><br><span class="line">        native_handle* h = native_handle_create(numFds, numInts);</span><br><span class="line">        <span class="comment">//å°†fdså¤åˆ¶åˆ°native_handleå¯¹è±¡çš„dataä¸­ï¼Œå’Œflattenæ“ä½œç›¸å</span></span><br><span class="line">        <span class="built_in">memcpy</span>(h-&gt;data,          fds,     numFds*<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(h-&gt;data + numFds, &amp;buf[<span class="number">10</span>], numInts*<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        handle = h;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        width = height = stride = format = usage = <span class="number">0</span>;</span><br><span class="line">        handle = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mId = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint64_t</span>&gt;(buf[<span class="number">6</span>]) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">    mId |= <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(buf[<span class="number">7</span>]);</span><br><span class="line"></span><br><span class="line">    mOwner = ownHandle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handle != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨GraphicBufferMapperå°†æœåŠ¡ç«¯åˆ›å»ºçš„å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°å½“å‰è¿›ç¨‹åœ°å€ç©ºé—´  </span></span><br><span class="line">        <span class="keyword">status_t</span> err = mBufferMapper.registerBuffer(handle);</span><br><span class="line">        <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">            width = height = stride = format = usage = <span class="number">0</span>;</span><br><span class="line">            handle = <span class="literal">NULL</span>;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buffer = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> <span class="keyword">const</span>*&gt;(<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span> <span class="keyword">const</span>*&gt;(buffer) + sizeNeeded);</span><br><span class="line">    size -= sizeNeeded;</span><br><span class="line">    fds += numFds;</span><br><span class="line">    count -= numFds;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨unflattenå‡½æ•°æ—¶ï¼Œå…±äº«åŒºçš„æ–‡ä»¶å¥æŸ„å·²ç»å‡†å¤‡å¥½äº†ï¼Œä½†æ˜¯å†…å­˜è¿˜æ²¡æœ‰è¿›è¡Œæ˜ å°„ï¼Œè°ƒç”¨äº†mBufferMapper.registerBufferå‡½æ•°æ¥è¿›è¡Œå†…å­˜æ˜ å°„ã€‚</p><h5 id="4-1ã€å›¾å½¢ç¼“å†²åŒºçš„æ³¨å†Œè¿‡ç¨‹"><a href="#4-1ã€å›¾å½¢ç¼“å†²åŒºçš„æ³¨å†Œè¿‡ç¨‹" class="headerlink" title="4.1ã€å›¾å½¢ç¼“å†²åŒºçš„æ³¨å†Œè¿‡ç¨‹"></a>4.1ã€å›¾å½¢ç¼“å†²åŒºçš„æ³¨å†Œè¿‡ç¨‹</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> GraphicBufferMapper::registerBuffer(<span class="keyword">const</span> GraphicBuffer* buffer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">gralloc1_error_t</span> error = mDevice-&gt;retain(buffer);</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨äº†mDevice-&gt;retain(buffer)å‡½æ•°ï¼Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\libs\ui\Gralloc1On0Adapter.cpp]</span><br><span class="line"><span class="keyword">gralloc1_error_t</span> Gralloc1On0Adapter::retain(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Buffer&gt;&amp; buffer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mBufferMutex);</span><br><span class="line">    buffer-&gt;retain();</span><br><span class="line">    <span class="keyword">return</span> GRALLOC1_ERROR_NONE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">gralloc1_error_t</span> Gralloc1On0Adapter::retain(</span><br><span class="line">        <span class="keyword">const</span> android::GraphicBuffer* graphicBuffer)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">buffer_handle_t</span> handle = graphicBuffer-&gt;getNativeBuffer()-&gt;handle;</span><br><span class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mBufferMutex);</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"Calling registerBuffer(%p)"</span>, handle);</span><br><span class="line">    <span class="keyword">int</span> result = mModule-&gt;registerBuffer(mModule, handle);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä¸€ç³»åˆ—æ­¥éª¤çš„è°ƒç”¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/display/msm8996/libgralloc/mapper.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gralloc_register_buffer</span><span class="params">(<span class="keyword">gralloc_module_t</span> <span class="keyword">const</span>* <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">buffer_handle_t</span> handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">int</span> err =  gralloc_map(<span class="keyword">module</span>, handle);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">gralloc_map</span><span class="params">(<span class="keyword">gralloc_module_t</span> <span class="keyword">const</span>* <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">buffer_handle_t</span> handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">private_handle_t</span>* hnd = (<span class="keyword">private_handle_t</span>*)handle;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line">    IMemAlloc* memalloc = getAllocator(hnd-&gt;flags) ;</span><br><span class="line">    <span class="keyword">void</span> *mappedAddress = MAP_FAILED;</span><br><span class="line">    hnd-&gt;base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dont map framebuffer and secure buffers</span></span><br><span class="line">    <span class="keyword">if</span> (!(hnd-&gt;flags &amp; <span class="keyword">private_handle_t</span>::PRIV_FLAGS_FRAMEBUFFER) &amp;&amp;</span><br><span class="line">        !(hnd-&gt;flags &amp; <span class="keyword">private_handle_t</span>::PRIV_FLAGS_SECURE_BUFFER)) &#123;</span><br><span class="line">        size = hnd-&gt;size;</span><br><span class="line">        err = memalloc-&gt;map_buffer(&amp;mappedAddress, size,</span><br><span class="line">                                       hnd-&gt;offset, hnd-&gt;fd);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        hnd-&gt;base = <span class="keyword">uint64_t</span>(mappedAddress) + hnd-&gt;offset;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = -EACCES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Allow mapping of metadata for all buffers including secure ones, but not</span></span><br><span class="line">    <span class="comment">//of framebuffer</span></span><br><span class="line">    <span class="keyword">int</span> metadata_err = gralloc_map_metadata(handle);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥è°ƒç”¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/display/msm8996/libgralloc/ionalloc.cpp]</span><br><span class="line"><span class="keyword">int</span> IonAlloc::map_buffer(<span class="keyword">void</span> **pBase, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> offset,</span><br><span class="line">        <span class="keyword">int</span> fd)</span><br><span class="line">&#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *base = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// It is a (quirky) requirement of ION to have opened the</span></span><br><span class="line">    <span class="comment">// ion fd in the process that is doing the mapping</span></span><br><span class="line">    err = open_device(); </span><br><span class="line">    ......</span><br><span class="line">    base = mmap(<span class="number">0</span>, size, PROT_READ| PROT_WRITE,</span><br><span class="line">                MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">    *pBase = base;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯è°ƒç”¨äº†mmapæ¥è¿›è¡Œå…±äº«å†…å­˜çš„æ˜ å°„ã€‚</p><h5 id="4-2ã€å›¾å½¢ç¼“å†²åŒºçš„é‡Šæ”¾è¿‡ç¨‹"><a href="#4-2ã€å›¾å½¢ç¼“å†²åŒºçš„é‡Šæ”¾è¿‡ç¨‹" class="headerlink" title="4.2ã€å›¾å½¢ç¼“å†²åŒºçš„é‡Šæ”¾è¿‡ç¨‹"></a>4.2ã€å›¾å½¢ç¼“å†²åŒºçš„é‡Šæ”¾è¿‡ç¨‹</h5><p>é‡Šæ”¾è¿‡ç¨‹è°ƒç”¨æµç¨‹ç±»ä¼¼ï¼Œæœ€åä¼šè°ƒç”¨unmap_buffer()é‡Šæ”¾å›¾åƒç¼“å†²åŒºã€‚</p><h5 id="4-3ã€å°ç»“"><a href="#4-3ã€å°ç»“" class="headerlink" title="4.3ã€å°ç»“"></a>4.3ã€å°ç»“</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-04-06-sf-app-dup-mmap.png" alt="Alt text | center"></p><h4 id="ï¼ˆäº”ï¼‰HWComposeræ¨¡å—"><a href="#ï¼ˆäº”ï¼‰HWComposeræ¨¡å—" class="headerlink" title="ï¼ˆäº”ï¼‰HWComposeræ¨¡å—"></a>ï¼ˆäº”ï¼‰HWComposeræ¨¡å—</h4><p>å‰é¢åˆ†æHWComposeræ„é€ å‡½æ•°æ²¡æœ‰åˆ†æloadHwcModule()å‡½æ•°ï¼Œ<br>loadHwcModule()å‡½æ•°ç”¨æ¥åŠ è½½HWCæ¨¡å—ï¼Œæˆ‘ä»¬ç»§ç»­æŸ¥çœ‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[E-&gt;\frameworks\native\services\surfaceflinger\DisplayHardware\HWComposer_hwc1.cpp]</span><br><span class="line">HWComposer::HWComposer(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;SurfaceFlinger&gt;&amp; flinger,</span><br><span class="line">        EventHandler&amp; handler)</span><br><span class="line">    : mFlinger(flinger),</span><br><span class="line">      mFbDev(<span class="number">0</span>), mHwc(<span class="number">0</span>), mNumDisplays(<span class="number">1</span>),</span><br><span class="line">      mCBContext(<span class="keyword">new</span> cb_context),<span class="comment">//è¿™é‡Œç›´æ¥newäº†ä¸€ä¸ªè®¾å¤‡ä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line">      mEventHandler(handler),</span><br><span class="line">      mDebugForceFakeVSync(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//è£…è½½HWComposerçš„ç¡¬ä»¶æ¨¡å—,è¿™ä¸ªå‡½æ•°ä¸­ä¼šå°†mHwcç½®ä¸ºtrue</span></span><br><span class="line">    loadHwcModule();</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//ç¡¬ä»¶vsyncä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (mHwc) &#123;</span><br><span class="line">        ALOGI(<span class="string">"Using %s version %u.%u"</span>, HWC_HARDWARE_COMPOSER,</span><br><span class="line">              (hwcApiVersion(mHwc) &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>,</span><br><span class="line">              (hwcApiVersion(mHwc) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="keyword">if</span> (mHwc-&gt;registerProcs) &#123;</span><br><span class="line">            <span class="comment">//HWComposerè®¾å¤‡ä¸Šä¸‹æ–‡å˜é‡mCBContextèµ‹å€¼</span></span><br><span class="line">            mCBContext-&gt;hwc = <span class="keyword">this</span>;</span><br><span class="line">            <span class="comment">//å‡½æ•°æŒ‡é’ˆé’©å­å‡½æ•°hook_invalidateæ”¾å…¥ä¸Šä¸‹æ–‡</span></span><br><span class="line">            mCBContext-&gt;procs.invalidate = &amp;hook_invalidate;</span><br><span class="line">            <span class="comment">//vsyncé’©å­å‡½æ•°æ”¾å…¥ä¸Šä¸‹æ–‡</span></span><br><span class="line">            mCBContext-&gt;procs.vsync = &amp;hook_vsync;</span><br><span class="line">            <span class="keyword">if</span> (hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1))</span><br><span class="line">                <span class="comment">//hotplugç‹—å­å‡½æ•°æ”¾å…¥ä¸Šä¸‹æ–‡</span></span><br><span class="line">                mCBContext-&gt;procs.hotplug = &amp;hook_hotplug;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                mCBContext-&gt;procs.hotplug = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="built_in">memset</span>(mCBContext-&gt;procs.zero, <span class="number">0</span>, <span class="keyword">sizeof</span>(mCBContext-&gt;procs.zero));</span><br><span class="line">            <span class="comment">//å°†é’©å­å‡½æ•°æ³¨å†Œè¿›ç¡¬ä»¶è®¾å¤‡ï¼Œç¡¬ä»¶é©±åŠ¨å›è°ƒè¿™äº›é’©å­å‡½æ•°</span></span><br><span class="line">            mHwc-&gt;registerProcs(mHwc, &amp;mCBContext-&gt;procs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// don't need a vsync thread if we have a hardware composer</span></span><br><span class="line">        <span class="comment">//å¦‚æœæœ‰ç¡¬ä»¶vsyncä¿¡å·ï¼Œ åˆ™ä¸éœ€è¦è½¯ä»¶vsyncå®ç°</span></span><br><span class="line">        needVSyncThread = <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Load and prepare the hardware composer module.  Sets mHwc.</span></span><br><span class="line"><span class="keyword">void</span> HWComposer::loadHwcModule()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">hw_module_t</span> <span class="keyword">const</span>* <span class="keyword">module</span>;</span><br><span class="line">    <span class="comment">//åŒæ ·æ˜¯HALå±‚å°è£…çš„å‡½æ•°ï¼Œå‚æ•°æ˜¯HWC_HARDWARE_MODULE_IDï¼ŒåŠ è½½hwcæ¨¡å—</span></span><br><span class="line">    <span class="keyword">if</span> (hw_get_module(HWC_HARDWARE_MODULE_ID, &amp;<span class="keyword">module</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‰“å¼€hwcè®¾å¤‡</span></span><br><span class="line">    <span class="keyword">int</span> err = hwc_open_1(<span class="keyword">module</span>, &amp;mHwc);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœç¡¬ä»¶è®¾å¤‡æ‰“å¼€æˆåŠŸï¼Œåˆ™å°†é’©å­å‡½æ•°hook_invalidateã€hook_vsyncå’Œhook_hotplugæ³¨å†Œè¿›ç¡¬ä»¶è®¾å¤‡ï¼Œä½œä¸ºå›è°ƒå‡½æ•°ã€‚è¿™ä¸‰ä¸ªéƒ½æ˜¯ç¡¬ä»¶äº§ç”Ÿäº‹ä»¶ä¿¡å·ï¼Œé€šçŸ¥ä¸Šå±‚SurfaceFlingerçš„å›è°ƒå‡½æ•°ï¼Œç”¨äºå¤„ç†è¿™ä¸ªä¿¡å·ã€‚</p><p>å› ä¸ºæˆ‘ä»¬æœ¬èŠ‚æ˜¯Vsyncä¿¡å·ç›¸å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬åªçœ‹çœ‹hook_vsyncé’©å­å‡½æ•°ã€‚è¿™é‡ŒæŒ‡å®šäº†vsyncçš„å›è°ƒå‡½æ•°æ˜¯hook_vsyncï¼Œå¦‚æœç¡¬ä»¶ä¸­äº§ç”Ÿäº†VSyncä¿¡å·ï¼Œå°†é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥é€šçŸ¥ä¸Šå±‚ï¼Œçœ‹çœ‹å®ƒçš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[E-&gt;\frameworks\native\services\surfaceflinger\DisplayHardware\HWComposer_hwc1.cpp]</span><br><span class="line"><span class="keyword">void</span> HWComposer::hook_vsync(<span class="keyword">const</span> struct hwc_procs* procs, <span class="keyword">int</span> disp,</span><br><span class="line">        <span class="keyword">int64_t</span> timestamp) &#123;</span><br><span class="line">    cb_context* ctx = <span class="keyword">reinterpret_cast</span>&lt;cb_context*&gt;(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">hwc_procs_t</span>*&gt;(procs));</span><br><span class="line">    ctx-&gt;hwc-&gt;vsync(disp, timestamp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  hook_vsyncé’©å­å‡½æ•°ä¼šè°ƒç”¨vsyncå‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[E-&gt;\frameworks\native\services\surfaceflinger\DisplayHardware\HWComposer_hwc1.cpp]</span><br><span class="line"><span class="keyword">void</span> HWComposer::vsync(<span class="keyword">int</span> disp, <span class="keyword">int64_t</span> timestamp) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">uint32_t</span>(disp) &lt; HWC_NUM_PHYSICAL_DISPLAY_TYPES) &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            Mutex::Autolock _l(mLock);</span><br><span class="line">            mLastHwVSync[disp] = timestamp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> tag[<span class="number">16</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(tag, <span class="keyword">sizeof</span>(tag), <span class="string">"HW_VSYNC_%1u"</span>, disp);</span><br><span class="line">        ATRACE_INT(tag, ++mVSyncCounts[disp] &amp; <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//è¿™é‡Œè°ƒç”¨EventHandlerç±»å‹å˜é‡mEventHandlerå°±æ˜¯SurfaceFlingerï¼Œ</span></span><br><span class="line">        <span class="comment">//æ‰€ä»¥è°ƒç”¨äº†SurfaceFlingerçš„onVSyncReceivedå‡½æ•°</span></span><br><span class="line">        mEventHandler.onVSyncReceived(disp, timestamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mEventHandlerå¯¹è±¡ç±»å‹ä¸ºEventHandlerï¼Œæˆ‘ä»¬åœ¨SurfaceFlingerçš„initå‡½æ•°åˆ›å»ºHWComposerç±»å®ä¾‹æ—¶å€™è®²SurfaceFlingerå¼ºè½¬ä¸ºEventHandlerä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°ä¼ å…¥å…¶ä¸­ã€‚å†è€…SurfaceFlingerç»§æ‰¿HWComposer::EventHandlerï¼Œæ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨SurfaceFlingerçš„onVSyncReceivedå‡½æ•°ï¼Œè¿™å°±æ˜¯ç¡¬ä»¶vsyncä¿¡å·çš„äº§ç”Ÿã€‚</p><h5 id="5-1ã€HWCè®¾å¤‡æ‰“å¼€è¿‡ç¨‹"><a href="#5-1ã€HWCè®¾å¤‡æ‰“å¼€è¿‡ç¨‹" class="headerlink" title="5.1ã€HWCè®¾å¤‡æ‰“å¼€è¿‡ç¨‹"></a>5.1ã€HWCè®¾å¤‡æ‰“å¼€è¿‡ç¨‹</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/libhardware/include/hardware/hwcomposer.h]</span><br><span class="line"><span class="comment">/** convenience API for opening and closing a device */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">hwc_open_1</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">hwc_composer_device_1_t</span>** device)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">module</span>-&gt;methods-&gt;open(<span class="keyword">module</span>,</span><br><span class="line">            HWC_HARDWARE_COMPOSER, (struct <span class="keyword">hw_device_t</span>**)device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“å®ç°/hardware/qcom/display/msm8996/sdm/libs/hwc/ or /hardware/qcom/display/msm8996/sdm/libs/hwc2/ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/display/msm8996/sdm/libs/hwc/hwc_session.h]</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">HWCModuleMethods</span> :</span> <span class="keyword">public</span> <span class="keyword">hw_module_methods_t</span> &#123;</span><br><span class="line">    HWCModuleMethods() &#123;</span><br><span class="line">      <span class="keyword">hw_module_methods_t</span>::open = HWCSession::Open;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">[-&gt;/hardware/qcom/display/msm8996/sdm/libs/hwc/hwc_session.cpp]</span><br><span class="line"><span class="keyword">int</span> HWCSession::Open(<span class="keyword">const</span> <span class="keyword">hw_module_t</span> *<span class="keyword">module</span>, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">hw_device_t</span> **device) &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, HWC_HARDWARE_COMPOSER)) &#123;</span><br><span class="line">    HWCSession *hwc_session = <span class="keyword">new</span> HWCSession(<span class="keyword">module</span>);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> status = hwc_session-&gt;Init();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">hwc_composer_device_1_t</span> *composer_device = hwc_session;</span><br><span class="line">    *device = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">hw_device_t</span> *&gt;(composer_device);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HWCSession::HWCSession(<span class="keyword">const</span> <span class="keyword">hw_module_t</span> *<span class="keyword">module</span>) &#123;</span><br><span class="line">  <span class="comment">// By default, drop any events. Calls will be routed to SurfaceFlinger after registerProcs.</span></span><br><span class="line">  hwc_procs_default_.invalidate = Invalidate;</span><br><span class="line">  hwc_procs_default_.vsync = VSync;</span><br><span class="line">  hwc_procs_default_.hotplug = Hotplug;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::common.tag = HARDWARE_DEVICE_TAG;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::common.version = HWC_DEVICE_API_VERSION_1_5;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::common.<span class="keyword">module</span> = <span class="keyword">const_cast</span>&lt;<span class="keyword">hw_module_t</span>*&gt;(<span class="keyword">module</span>);</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::common.close = Close;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::prepare = Prepare;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::<span class="built_in">set</span> = Set;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::eventControl = EventControl;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::setPowerMode = SetPowerMode;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::query = Query;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::registerProcs = RegisterProcs;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::dump = Dump;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::getDisplayConfigs = GetDisplayConfigs;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::getDisplayAttributes = GetDisplayAttributes;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::getActiveConfig = GetActiveConfig;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::setActiveConfig = SetActiveConfig;</span><br><span class="line">  <span class="keyword">hwc_composer_device_1_t</span>::setCursorPositionAsync = SetCursorPositionAsync;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://blog.csdn.net/putiancaijunyu/article/category/2558539" target="_blank" rel="noopener"> Androidç ”ç©¶ Gralloc &amp;&amp; HWComposerç³»åˆ—åˆ†æ</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/54234354" target="_blank" rel="noopener">Android Display ç³»åˆ—åˆ†æ</a><br><a href="https://blog.csdn.net/honour2sword/article/details/12004289" target="_blank" rel="noopener">Android display: framebuffer æ˜ å°„å…³ç³»</a><br><a href="https://blog.csdn.net/honour2sword/article/details/38265879" target="_blank" rel="noopener">Android displayæ¡†æ¶ä¸æ•°æ®æµ</a><br><a href="https://blog.csdn.net/yangwen123/article/details/12192401" target="_blank" rel="noopener">Androidå›¾å½¢æ˜¾ç¤ºä¹‹ç¡¬ä»¶æŠ½è±¡å±‚Gralloc</a><br><a href="https://www.jianshu.com/p/af5858c06d5d" target="_blank" rel="noopener">SurfaceFlingerä¸­Bufferçš„åˆ›å»ºä¸æ˜¾ç¤º</a><br><a href="https://www.wolfcstech.com/2017/09/21/android_graphics_gralloc/" target="_blank" rel="noopener">Android å›¾å½¢ç³»ç»Ÿä¹‹gralloc</a><br><a href="https://blog.csdn.net/yangwen123/article/category/1647761" target="_blank" rel="noopener">æ·±å…¥å‰–æAndroidç³»ç»Ÿ æ˜¾ç¤ºæ¨¡å—</a><br><a href="http://windrunnerlihuan.com/" target="_blank" rel="noopener">Android SurfaceFlinger å­¦ä¹ ä¹‹è·¯</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æ ä¹‹  HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/08/01/Android%20Display%20System%EF%BC%883%EF%BC%89%EF%BC%9AAndroid%20Display%20System%20%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B9%8BHardwareRenderer.draw%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/08/01/Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.drawç»˜åˆ¶æµç¨‹åˆ†æ/</id>
    <published>2018-07-31T16:00:00.000Z</published>
    <updated>2018-06-20T15:11:18.995Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/display.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p><a href="https://blog.csdn.net/luoshengyang/article/details/45601143" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Androidåº”ç”¨ç¨‹åºUIç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“æŠ€æœ¯ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ã€‘</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/54234354" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Nä¸­UIç¡¬ä»¶æ¸²æŸ“ï¼ˆhwuiï¼‰çš„HWUI_NEW_OPS(åŸºäºAndroid 7.1)ã€‘</a><br><a href="https://www.jianshu.com/p/7bf306c09c7e" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android DisplayList æ„å»ºè¿‡ç¨‹ã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><p> ğŸŒ€ğŸŒ€ï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶</p><p>ã€Android Display System ç³»ç»Ÿåˆ†æç³»åˆ—ã€‘ï¼š<br>ã€Android Display Systemï¼ˆ1ï¼‰ï¼šAndroid 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL &amp;&amp; OpenGLã€‘<br>ã€Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc &amp;&amp; HWComposeræ¨¡å—åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architectureã€‘ </p><hr><p>\frameworks\base\core\java\android\view\</p><ul><li>ViewRootImpl.java</li><li>RenderNode.java</li><li>View.java</li><li>DisplayListCanvas.java</li></ul><p>\frameworks\base\core\jni\</p><ul><li>android_view_DisplayListCanvas.cpp</li><li>android_view_RenderNode.cpp</li><li>android_view_ThreadedRenderer.cpp</li><li>android_view_Surface.cpp</li><li>android_server_AssetAtlasService.cpp</li></ul><p>\frameworks\base\core\jni\android\graphics\</p><ul><li>Graphics.cpp</li><li>Bitmap.cpp</li></ul><p>\frameworks\base\libs\hwui\</p><ul><li>AssetAtlas.cpp</li><li>BakedOpDispatcher.cpp</li><li>BakedOpRenderer.cpp</li><li>DeferredDisplayList.cpp</li><li>DeferredLayerUpdater.cpp</li><li>DisplayList.cpp</li><li>DisplayListCanvas.cpp</li><li>LayerBuilder.cpp</li><li>LayerRenderer.cpp</li><li>LayerUpdateQueue.cpp</li><li>Patch.cpp</li><li>RecordingCanvas.cpp</li><li>RenderNode.cpp</li></ul><p>\frameworks\base\libs\hwui\hwui\</p><ul><li>Canvas.cpp</li></ul><p>\frameworks\base\libs\hwui\renderthread\</p><ul><li>EglManager.cpp</li><li>CanvasContext.cpp</li><li>DrawFrameTask.cpp</li><li>RenderProxy.cpp</li><li>RenderTask.cpp</li><li>RenderThread.cpp</li></ul><hr><p>UIä½œä¸ºç”¨æˆ·ä½“éªŒçš„æ ¸å¿ƒä¹‹ä¸€ï¼Œå§‹ç»ˆæ˜¯Androidæ¯æ¬¡å‡çº§ä¸­çš„é‡ç‚¹ã€‚ä»Androd 3.0(Honeycomb)å¼€å§‹ï¼ŒAndroidå¼€å§‹æ”¯æŒhwuiï¼ˆUIç¡¬ä»¶åŠ é€Ÿï¼‰ã€‚åˆ°Android 4.0ï¼ˆICSï¼‰æ—¶ï¼Œç¡¬ä»¶åŠ é€Ÿè¢«é»˜è®¤å¼€å¯ã€‚åŒæ—¶ICSè¿˜å¼•å…¥äº†DisplayListçš„æ¦‚å¿µï¼ˆä¸æ˜¯OpenGLé‡Œçš„é‚£ä¸ªï¼‰ï¼Œå®ƒç›¸å½“äºæ˜¯ä»Viewçš„ç»˜åˆ¶å‘½ä»¤åˆ°GLå‘½ä»¤ä¹‹é—´çš„â€œä¸­é—´è¯­è¨€â€ã€‚å®ƒè®°å½•äº†ç»˜åˆ¶è¯¥Viewæ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ï¼Œä¹‹ååªè¦é‡æ”¾ï¼ˆreplayï¼‰å³å¯å®Œæˆå†…å®¹çš„ç»˜åˆ¶ã€‚è¿™æ ·å¦‚æœViewæ²¡æœ‰æ”¹åŠ¨æˆ–åªéƒ¨åˆ†æ”¹åŠ¨ï¼Œä¾¿å¯é‡ç”¨æˆ–ä¿®æ”¹DisplayListï¼Œä»è€Œé¿å…è°ƒç”¨äº†ä¸€äº›ä¸Šå±‚ä»£ç ï¼Œæé«˜äº†æ•ˆç‡ã€‚Android 4.3ï¼ˆJBï¼‰ä¸­å¼•å…¥äº†DisplayListçš„deferæ“ä½œï¼Œå®ƒä¸»è¦ç”¨äºå¯¹DisplayListä¸­å‘½ä»¤è¿›è¡ŒBatchï¼ˆæ‰¹æ¬¡ï¼‰å’ŒMergeï¼ˆåˆå¹¶ï¼‰ã€‚è¿™æ ·å¯ä»¥å‡å°‘GL draw callå’Œcontextåˆ‡æ¢ä»¥æé«˜æ•ˆç‡ã€‚ä¹‹åï¼Œåœ¨Android 5.0ï¼ˆLollipopï¼‰ä¸­åˆå¼•å…¥äº†RenderNodeï¼ˆæ¸²æŸ“èŠ‚ç‚¹ï¼‰çš„æ¦‚å¿µï¼Œå®ƒæ˜¯å¯¹DisplayListåŠä¸€äº›Viewæ˜¾ç¤ºå±æ€§çš„è¿›ä¸€æ­¥å°è£…ã€‚ä»£ç ä¸Šï¼Œä¸€ä¸ªViewå¯¹åº”ä¸€ä¸ªRenderNodeï¼ˆNativeå±‚å¯¹åº”åŒåç±»ï¼‰ï¼Œå…¶ä¸­ç®¡ç†ç€å¯¹åº”çš„DisplayListå’ŒOffscreenBufferï¼ˆå¦‚æœè¯¥Viewä¸ºç¡¬ä»¶ç»˜åˆ¶å±‚ï¼‰ã€‚æ¯ä¸ªå‘WindowManagerServiceæ³¨å†Œçš„çª—å£å¯¹åº”ä¸€ä¸ªRootRenderNodeï¼Œé€šè¿‡å®ƒå¯ä»¥æ‰¾åˆ°Viewå±‚æ¬¡ç»“æ„ä¸­æ‰€æœ‰Viewçš„DisplayListä¿¡æ¯ã€‚åœ¨Javaå±‚çš„DisplayListCanvasç”¨äºç”ŸæˆDisplayListï¼Œå…¶åœ¨nativeå±‚çš„å¯¹åº”ç±»ä¸ºRecordingCanvasï¼ˆåœ¨Android Nå‰ä¸ºDisplayListCanvasï¼‰ã€‚å¦å¤–Android Lä¸­è¿˜å¼•å…¥äº†RenderThreadï¼ˆæ¸²æŸ“çº¿ç¨‹ï¼‰ã€‚æ‰€æœ‰çš„GLå‘½ä»¤æ‰§è¡Œéƒ½æ”¾åˆ°è¿™ä¸ªçº¿ç¨‹ä¸Šã€‚æ¸²æŸ“çº¿ç¨‹åœ¨RenderNodeä¸­å­˜æœ‰æ¸²æŸ“å¸§çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¸”è¿˜ç›‘å¬VSyncä¿¡å·ï¼Œå› æ­¤å¯ä»¥ç‹¬ç«‹åšä¸€äº›å±æ€§åŠ¨ç”»ã€‚è¿™æ ·å³ä¾¿ä¸»çº¿ç¨‹blockä¹Ÿå¯ä»¥ä¿è¯åŠ¨ç”»æµç•…ã€‚å¼•å…¥æ¸²æŸ“çº¿ç¨‹åThreadedRendereræ›¿ä»£äº†Gl20Rendererï¼Œä½œä¸ºproxyç”¨äºä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰æŠŠæ¸²æŸ“ä»»åŠ¡äº¤ç»™æ¸²æŸ“çº¿ç¨‹ã€‚è¿‘æœŸï¼Œåœ¨Android 7.0ï¼ˆNougatï¼‰ä¸­åˆå¯¹hwuiè¿›è¡Œäº†å°è§„æ¨¡é‡æ„ï¼Œå¼•å…¥äº†BakedOpRenderer, FrameBuilder, LayerBuilder, RecordingCanvasç­‰ç±»ï¼Œç”¨å®HWUI_NEW_OPSç®¡ç†ã€‚ä¸‹é¢ç®€å•ä»‹ç»ä¸‹è¿™äº›æ–°æˆå‘˜ï¼š</p><p>â˜¯ <strong>RecordingCanvas</strong>: ä¹‹å‰Javaå±‚çš„DisplayListCanvaså¯¹åº”nativeå±‚çš„DisplayListCanvasã€‚å¼•å…¥RecordingCanvasåï¼Œå…¶åœ¨nativeå±‚çš„å¯¹åº”ç‰©å°±å˜æˆäº†RecordingCanvasã€‚å’ŒDisplayListCanvasç±»ä¼¼ï¼Œç”»åœ¨RecordingCanvasä¸Šçš„å†…å®¹éƒ½ä¼šè¢«è®°å½•åœ¨RenderNodeçš„DisplayListä¸­ã€‚</p><p>â˜¯ <strong>BakedOpRenderer</strong>: é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç”¨äºç»˜åˆ¶batch/mergeå¥½çš„æ“ä½œã€‚ç”¨äºæ›¿ä»£ä¹‹å‰çš„OpenGLRendererã€‚å®ƒæ˜¯çœŸæ­£ç”¨GLç»˜åˆ¶åˆ°on-screen surfaceä¸Šçš„ã€‚</p><p>â˜¯ <strong>BakedOpDispatcher</strong>: æä¾›ä¸€ç³»åˆ—onXXXï¼ˆå¦‚onBitmapOpï¼‰å’ŒonMergedXXXï¼ˆå¦‚onMergedBitmapOpsï¼‰é™æ€å‡½æ•°ä¾›replayæ—¶è°ƒç”¨ã€‚è¿™äº›dispatchå‡½æ•°æœ€åä¸€èˆ¬éƒ½ä¼šé€šè¿‡GlopBuilderæ¥æ„é€ Glopç„¶åé€šè¿‡BakedOpRendererçš„renderGlop()å‡½æ•°æ¥ç”¨OpenGLç»˜åˆ¶ã€‚</p><p>â˜¯ <strong>LayerBuilder</strong>: ç”¨äºå­˜å‚¨ç»˜åˆ¶æŸä¸€å±‚çš„æ“ä½œå’ŒçŠ¶æ€ã€‚æ›¿ä»£äº†éƒ¨åˆ†åŸDeferredDisplayListçš„å·¥ä½œã€‚å¯¹äºæ‰€æœ‰Viewé€šç”¨ï¼Œå³å¦‚æœViewæœ‰render layerï¼Œå®ƒå¯¹åº”ä¸€ä¸ªFBOï¼›å¦‚æœå¯¹äºæ™®é€šViewï¼Œå®ƒå¯¹åº”çš„æ˜¯SurfaceFlingeræä¾›çš„surfaceã€‚ å…¶ä¸­çš„mBatcheså­˜å‚¨äº†å½“å‰å±‚deferåï¼ˆå³batch/mergeå¥½ï¼‰çš„ç»˜åˆ¶æ“ä½œã€‚</p><p>â˜¯ <strong>FrameBuilder</strong>: ç®¡ç†æŸä¸€å¸§çš„æ„å»ºï¼Œç”¨äºå¤„ç†ï¼Œä¼˜åŒ–å’Œå­˜å‚¨ä»RenderNodeå’ŒLayerUpdateQueueä¸­æ¥çš„æ¸²æŸ“å‘½ä»¤ï¼ŒåŒæ—¶å®ƒçš„replayBakedOps()æ–¹æ³•è¿˜ç”¨äºè¯¥å¸§çš„ç»˜åˆ¶å‘½ä»¤é‡æ”¾ã€‚ä¸€å¸§ä¸­å¯èƒ½éœ€è¦ç»˜åˆ¶å¤šä¸ªå±‚ï¼Œæ¯ä¸€å±‚çš„ä¸Šä¸‹æ–‡éƒ½ä¼šå­˜åœ¨ç›¸åº”çš„LayerBuilderä¸­ã€‚åœ¨FrameBuilderä¸­é€šè¿‡mLayerBuilderså’ŒmLayerStackå­˜å‚¨ä¸€ä¸ªlayer stackã€‚å®ƒæ›¿ä»£äº†åŸSnapshotç±»çš„ä¸€éƒ¨åˆ†åŠŸèƒ½ã€‚</p><p>â˜¯ <strong>OffscreenBuffer</strong>: ç”¨äºæ›¿ä»£Layerç±»ï¼Œä½†æ˜¯è®¾è®¡ä¸Šæ›´è½»é‡ï¼Œè€Œä¸”è‡ªå¸¦å†…å­˜æ± ï¼ˆé€šè¿‡OffscreenBufferPoolï¼‰ã€‚</p><p>â˜¯ <strong>LayerUpdateQueue</strong>ï¼šç”¨äºè®°å½•ç±»å‹ä¸ºç¡¬ä»¶ç»˜åˆ¶å±‚çš„RenderNodeçš„æ›´æ–°æ“ä½œã€‚ä¹‹åä¼šé€šè¿‡FrameBuilderå°†è¯¥layerå¯¹åº”çš„RenderNodeé€šè¿‡deferNodeOps()æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p><p>â˜¯ <strong>RecordedOp</strong>: ç”±RecordedCanvaså°†Viewä¸­çš„ç»˜åˆ¶å‘½ä»¤è½¬åŒ–ä¸ºRecordedOpã€‚RecordedOpä¹Ÿæ˜¯DisplayListä¸­çš„åŸºæœ¬å…ƒç´ ï¼Œç”¨äºæ›¿ä»£Android Nä¹‹å‰çš„DisplayListOpã€‚å®ƒæœ‰ä¸€å¨å„å¼å„æ ·çš„ç»§æ‰¿ç±»ä»£è¡¨å„ç§å„æ ·çš„ç»˜åˆ¶æ“ä½œã€‚BakedOpStateæ˜¯RecordedOpå’Œç›¸åº”çš„çŠ¶æ€çš„è‡ªåŒ…å«å°è£…ï¼ˆå°è£…çš„è¿‡ç¨‹ç§°ä¸ºbakeï¼‰ã€‚</p><p>â˜¯ <strong>BatchBase</strong>: LayerBuilderä¸­å¯¹DisplayListè¿›è¡Œbatch/mergeå¤„ç†åçš„ç»“æœä»¥BatchBaseå½¢å¼ä¿å­˜åœ¨LayerBuilderçš„mBatchesæˆå‘˜ä¸­ã€‚å®ƒæœ‰ä¸¤ä¸ªç»§æ‰¿ç±»åˆ†åˆ«ä¸ºOpBatchå’ŒMergingOpBatchï¼Œåˆ†åˆ«ç”¨äºä¸å¯åˆå¹¶å’Œå¯åˆå¹¶æ“ä½œã€‚</p><p>æ¦‚æ‹¬ä¸‹å®ƒä»¬å’Œç›¸å…³ç±»çš„å…³ç³»å›¾å¦‚ä¸‹ï¼Œæ¥ä¸‹æ¥ä»DisplayList(RenderNode)çš„æ„å»ºå’Œç»˜åˆ¶ä¸¤ä¸ªé˜¶æ®µåˆ†æä¸‹å…·ä½“æœ‰å“ªäº›æ”¹åŠ¨ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-01-android-hw-ops.png" alt="Alt text | center"></p><p>é¦–å…ˆçœ‹çœ‹æ€»ä½“æ—¶åºå›¾ï¼šç„¶åä¸€æ­¥ä¸€æ­¥åˆ†æï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-02-HW.Draw.png" alt="Alt text | center"></p><h4 id="ï¼ˆä¸€ï¼‰ã€Androidç¡¬ä»¶æ¸²æŸ“ç¯å¢ƒåˆå§‹åŒ–ViewRootImpl-enableHardwareAcceleration"><a href="#ï¼ˆä¸€ï¼‰ã€Androidç¡¬ä»¶æ¸²æŸ“ç¯å¢ƒåˆå§‹åŒ–ViewRootImpl-enableHardwareAcceleration" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Androidç¡¬ä»¶æ¸²æŸ“ç¯å¢ƒåˆå§‹åŒ–ViewRootImpl.enableHardwareAcceleration()"></a>ï¼ˆä¸€ï¼‰ã€Androidç¡¬ä»¶æ¸²æŸ“ç¯å¢ƒåˆå§‹åŒ–ViewRootImpl.enableHardwareAcceleration()</h4><p>åœ¨ViewRootImpl.javaçš„setViewé‡Œï¼Œä¼šå»enableç¡¬ä»¶åŠ é€ŸåŠŸèƒ½ã€‚å¦‚æœå½“å‰åˆ›å»ºçš„çª—å£æ”¯æŒç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºä¸€ä¸ªHardwareRendererå¯¹è±¡ï¼Œè¿™ä¸ªHardwareRendererå¯¹è±¡ä»¥åå°†è´Ÿè´£æ‰§è¡Œçª—å£ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“çš„ç›¸å…³æ“ä½œã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\view\ViewRootImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enableHardwareAcceleration</span><span class="params">(WindowManager.LayoutParams attrs)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (hardwareAccelerated) &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (fakeHwAccelerated) &#123;</span><br><span class="line">                ......</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!ThreadedRenderer.sRendererDisabled</span><br><span class="line">                    || (ThreadedRenderer.sSystemRendererDisabled &amp;&amp; forceHwAccelerated)) &#123;</span><br><span class="line">                ......</span><br><span class="line">                mAttachInfo.mHardwareRenderer = ThreadedRenderer.create(mContext, translucent);</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>ThreadedRendererç±»çš„é™æ€æˆå‘˜å‡½æ•°createçš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><h5 id="1-1ã€ThreadedRendereråˆ›å»ºè¿‡ç¨‹"><a href="#1-1ã€ThreadedRendereråˆ›å»ºè¿‡ç¨‹" class="headerlink" title="1.1ã€ThreadedRendereråˆ›å»ºè¿‡ç¨‹"></a>1.1ã€ThreadedRendereråˆ›å»ºè¿‡ç¨‹</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks\base\core\java\android\view\ThreadedRenderer.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadedRenderer <span class="title">create</span><span class="params">(Context context, <span class="keyword">boolean</span> translucent)</span> </span>&#123;</span><br><span class="line">        ThreadedRenderer renderer = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (DisplayListCanvas.isAvailable()) &#123;</span><br><span class="line">            renderer = <span class="keyword">new</span> ThreadedRenderer(context, translucent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> renderer;</span><br><span class="line">    &#125;</span><br><span class="line">    ThreadedRenderer(Context context, <span class="keyword">boolean</span> translucent) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//1ã€nCreateRootRenderNodeåœ¨Nativeå±‚åˆ›å»ºäº†ä¸€ä¸ªRender Node</span></span><br><span class="line">        <span class="keyword">long</span> rootNodePtr = nCreateRootRenderNode();</span><br><span class="line">        mRootNode = RenderNode.adopt(rootNodePtr);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//2ã€nCreateProxyåœ¨Nativeå±‚åˆ›å»ºäº†ä¸€ä¸ªRender Proxyå¯¹è±¡</span></span><br><span class="line">        mNativeProxy = nCreateProxy(translucent, rootNodePtr);</span><br><span class="line">        <span class="comment">//3ã€åˆå§‹åŒ–ä¸€ä¸ªç³»ç»Ÿé¢„åŠ è½½èµ„æºçš„åœ°å›¾é›†,ä¼˜åŒ–èµ„æºçš„å†…å­˜ä½¿ç”¨</span></span><br><span class="line">        ProcessInitializer.sInstance.init(context, mNativeProxy);</span><br><span class="line"></span><br><span class="line">        loadSystemProperties();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="1-1-1ã€åˆ›å»ºRenderNode"><a href="#1-1-1ã€åˆ›å»ºRenderNode" class="headerlink" title="1.1.1ã€åˆ›å»ºRenderNode"></a>1.1.1ã€åˆ›å»ºRenderNode</h5><p>nCreateRootRenderNodeåœ¨Nativeå±‚åˆ›å»ºäº†ä¸€ä¸ªRender Nodeã€‚ ä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºï¼Œçª—å£åœ¨Nativeå±‚çš„Root Render Nodeå®é™…ä¸Šæ˜¯ä¸€ä¸ªRootRenderNodeå¯¹è±¡ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\jni\android_view_ThreadedRenderer.cpp]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RootRenderNode</span> :</span> <span class="keyword">public</span> RenderNode, ErrorHandler &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    RootRenderNode(JNIEnv* env) : RenderNode() &#123;</span><br><span class="line">        mLooper = Looper::getForThread();</span><br><span class="line">        env-&gt;GetJavaVM(&amp;mVm);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">android_view_ThreadedRenderer_createRootRenderNode</span><span class="params">(JNIEnv* env, jobject clazz)</span> </span>&#123;</span><br><span class="line">    RootRenderNode* node = <span class="keyword">new</span> RootRenderNode(env);</span><br><span class="line">    node-&gt;incStrong(<span class="number">0</span>);</span><br><span class="line">    node-&gt;setName(<span class="string">"RootRenderNode"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹å‡ºä¼šåˆ›å»ºä¸€ä¸ªC++å±‚çš„RootRenderNodeå¯¹è±¡ï¼ŒRootRenderNodeç»§æ‰¿è‡ªRenderNodeï¼Œå»çœ‹çœ‹RenderNodeæ„é€ å‡½æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\RenderNode.cpp]</span><br><span class="line">RenderNode::RenderNode()</span><br><span class="line">        : mDirtyPropertyFields(<span class="number">0</span>)</span><br><span class="line">        , mNeedsDisplayListSync(<span class="literal">false</span>)</span><br><span class="line">        , mDisplayList(<span class="literal">nullptr</span>)</span><br><span class="line">        , mStagingDisplayList(<span class="literal">nullptr</span>)</span><br><span class="line">        , mAnimatorManager(*<span class="keyword">this</span>)</span><br><span class="line">        , mParentCount(<span class="number">0</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†è¿™ä¸ªRootRenderNodeå¯¹è±¡ä¹‹åï¼Œå‡½æ•°android_view_ThreadedRenderer_createProxyå°±åˆ›å»ºäº†ä¸€ä¸ªRenderProxyå¯¹è±¡ã€‚</p><h5 id="1-1-2ã€åˆ›å»ºRenderProxy"><a href="#1-1-2ã€åˆ›å»ºRenderProxy" class="headerlink" title="1.1.2ã€åˆ›å»ºRenderProxy"></a>1.1.2ã€åˆ›å»ºRenderProxy</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\jni\android_view_ThreadedRenderer.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">android_view_ThreadedRenderer_createProxy</span><span class="params">(JNIEnv* env, jobject clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jboolean translucent, jlong rootRenderNodePtr)</span> </span>&#123;</span><br><span class="line">    RootRenderNode* rootRenderNode = <span class="keyword">reinterpret_cast</span>&lt;RootRenderNode*&gt;(rootRenderNodePtr);</span><br><span class="line">    <span class="function">ContextFactoryImpl <span class="title">factory</span><span class="params">(rootRenderNode)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> (jlong) <span class="keyword">new</span> RenderProxy(translucent, rootRenderNode, &amp;factory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RenderProxyå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> [-&gt;\frameworks\base\libs\hwui\renderthread\RenderProxy.cpp]</span><br><span class="line"> RenderProxy::RenderProxy(<span class="keyword">bool</span> translucent, RenderNode* rootRenderNode, IContextFactory* contextFactory)</span><br><span class="line">        : mRenderThread(RenderThread::getInstance())</span><br><span class="line">        , mContext(<span class="literal">nullptr</span>) &#123;</span><br><span class="line">    SETUP_TASK(createContext);</span><br><span class="line">    args-&gt;translucent = translucent;</span><br><span class="line">    args-&gt;rootRenderNode = rootRenderNode;</span><br><span class="line">    args-&gt;thread = &amp;mRenderThread;</span><br><span class="line">    args-&gt;contextFactory = contextFactory;</span><br><span class="line">    mContext = (CanvasContext*) postAndWait(task);</span><br><span class="line">    mDrawFrameTask.setContext(&amp;mRenderThread, mContext, rootRenderNode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RenderProxyç±»æœ‰ä¸‰ä¸ªé‡è¦çš„æˆå‘˜å˜é‡mRenderThreadã€mContextå’ŒmDrawFrameTaskï¼ŒmRenderThreadæè¿°çš„å°±æ˜¯Render Threadï¼ŒmContextæè¿°çš„æ˜¯ä¸€ä¸ªç”»å¸ƒä¸Šä¸‹æ–‡ï¼ŒmDrawFrameTaskæè¿°çš„æ˜¯ä¸€ä¸ªç”¨æ¥æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡çš„Task</p><h5 id="1-1-2-1ã€RenderThread-å®ä¾‹åŒ–"><a href="#1-1-2-1ã€RenderThread-å®ä¾‹åŒ–" class="headerlink" title="1.1.2.1ã€RenderThread å®ä¾‹åŒ–"></a>1.1.2.1ã€RenderThread å®ä¾‹åŒ–</h5><p>æ¥çœ‹çœ‹RenderThread::getInstance()å®ä¾‹åŒ–è¿‡ç¨‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\RenderThread.cpp]</span><br><span class="line">RenderThread&amp; RenderThread::getInstance() &#123;</span><br><span class="line">    <span class="keyword">static</span> RenderThread* sInstance = <span class="keyword">new</span> RenderThread();</span><br><span class="line">    gHasRenderThreadInstance = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> *sInstance;</span><br><span class="line">&#125;</span><br><span class="line">RenderThread::RenderThread() : Thread(<span class="literal">true</span>)</span><br><span class="line">        , mNextWakeup(LLONG_MAX)</span><br><span class="line">        , mDisplayEventReceiver(<span class="literal">nullptr</span>)</span><br><span class="line">        , mVsyncRequested(<span class="literal">false</span>)</span><br><span class="line">        , mFrameCallbackTaskPending(<span class="literal">false</span>)</span><br><span class="line">        , mFrameCallbackTask(<span class="literal">nullptr</span>)</span><br><span class="line">        , mRenderState(<span class="literal">nullptr</span>)</span><br><span class="line">        , mEglManager(<span class="literal">nullptr</span>) &#123;</span><br><span class="line">    Properties::load();</span><br><span class="line">    mFrameCallbackTask = <span class="keyword">new</span> DispatchFrameCallbacks(<span class="keyword">this</span>);</span><br><span class="line">    mLooper = <span class="keyword">new</span> Looper(<span class="literal">false</span>);</span><br><span class="line">    run(<span class="string">"RenderThread"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//RenderThreadç±»çš„æˆå‘˜å˜é‡mFrameCallbackTaskæè¿°çš„Taskæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„å‘¢ï¼ŸåŸæ¥å°±æ˜¯ç”¨æ¥æ˜¾ç¤ºåŠ¨ç”»çš„ã€‚å½“Javaå±‚æ³¨å†Œä¸€ä¸ªåŠ¨ç”»</span></span><br><span class="line"><span class="comment">//ç±»å‹çš„Render Nodeåˆ°Render Threadæ—¶ï¼Œä¸€ä¸ªç±»å‹ä¸ºIFrameCallbackçš„å›è°ƒæ¥å£å°±ä¼šé€šè¿‡RenderThreadç±»çš„æˆå‘˜å‡½æ•°</span></span><br><span class="line"><span class="comment">//postFrameCallbackæ³¨å†Œåˆ°Render Threadçš„ä¸€ä¸ªPending Registration Frame Callbacksåˆ—è¡¨ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DispatchFrameCallbacks</span> :</span> <span class="keyword">public</span> RenderTask &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    RenderThread* mRenderThread;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    DispatchFrameCallbacks(RenderThread* rt) : mRenderThread(rt) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> override </span>&#123;</span><br><span class="line">        mRenderThread-&gt;dispatchFrameCallbacks();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RenderThread::dispatchFrameCallbacks() &#123;</span><br><span class="line">   ......</span><br><span class="line">    <span class="keyword">if</span> (callbacks.size()) &#123;</span><br><span class="line">        ......</span><br><span class="line">        requestVsync();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">set</span>&lt;IFrameCallback*&gt;::iterator it = callbacks.begin(); it != callbacks.end(); it++) &#123;</span><br><span class="line">            (*it)-&gt;doFrame();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€mFrameCallbackTaskæŒ‡å‘ä¸€ä¸ªDispatchFrameCallbackså¯¹è±¡ï¼Œç”¨æ¥æè¿°ä¸€ä¸ªå¸§ç»˜åˆ¶ä»»åŠ¡<br>2ã€mLooperæŒ‡å‘ä¸€ä¸ªLooperå¯¹è±¡ï¼Œæ¶ˆæ¯é©±åŠ¨æ¨¡å‹<br>3ã€RenderThreadç±»æ˜¯ä»Threadç±»ç»§æ‰¿ä¸‹æ¥çš„ï¼Œå½“æˆ‘ä»¬è°ƒç”¨å®ƒçš„æˆå‘˜å‡½æ•°runçš„æ—¶å€™ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚è¿™ä¸ªæ–°çš„çº¿ç¨‹çš„å…¥å£ç‚¹å‡½æ•°ä¸ºRenderThreadç±»çš„æˆå‘˜å‡½æ•°threadLoopï¼Œå®ƒçš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\RenderThread.cpp]</span><br><span class="line">bool RenderThread::threadLoop() &#123;</span><br><span class="line">    setpriority(PRIO_PROCESS, 0, PRIORITY_DISPLAY);</span><br><span class="line">    initThreadLocals();</span><br><span class="line"></span><br><span class="line">    int timeoutMillis = -1;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int result = mLooper-&gt;pollOnce(timeoutMillis);</span><br><span class="line"></span><br><span class="line">        nsecs_t nextWakeup;</span><br><span class="line">        // Process our queue, if we have anything</span><br><span class="line">        while (RenderTask* task = nextTask(&amp;nextWakeup)) &#123;</span><br><span class="line">            task-&gt;run();</span><br><span class="line">            // task may have deleted itself, do not reference it again</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        if (mPendingRegistrationFrameCallbacks.size() &amp;&amp; !mFrameCallbackTaskPending) &#123;</span><br><span class="line">            drainDisplayEventQueue();</span><br><span class="line">            mFrameCallbacks.insert(</span><br><span class="line">                    mPendingRegistrationFrameCallbacks.begin(), mPendingRegistrationFrameCallbacks.end());</span><br><span class="line">            mPendingRegistrationFrameCallbacks.clear();</span><br><span class="line">            requestVsync();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!mFrameCallbackTaskPending &amp;&amp; !mVsyncRequested &amp;&amp; mFrameCallbacks.size()) &#123;</span><br><span class="line">            requestVsync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°Render Threadçš„è¿è¡Œæ¨¡å‹ï¼š<br>1ã€ç©ºé—²çš„æ—¶å€™ï¼ŒRender Threadå°±ç¡çœ åœ¨æˆå‘˜å˜é‡mLooperæŒ‡å‘çš„ä¸€ä¸ªLooperå¯¹è±¡çš„æˆå‘˜å‡½æ•°pollOnceä¸­ã€‚<br>2ã€å½“å…¶å®ƒçº¿ç¨‹éœ€è¦è°ƒåº¦Render Threadï¼Œå°±ä¼šå‘å®ƒçš„ä»»åŠ¡é˜Ÿåˆ—å¢åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åå”¤é†’Render Threadè¿›è¡Œå¤„ç†ã€‚Render Threadé€šè¿‡æˆå‘˜å‡½æ•°nextTaskè·å¾—éœ€è¦å¤„ç†çš„ä»»åŠ¡ï¼Œå¹¶ä¸”è°ƒç”¨å®ƒçš„æˆå‘˜å‡½æ•°runè¿›è¡Œå¤„ç†ã€‚<br>RenderThreadç±»çš„æˆå‘˜å‡½æ•°nextTaskçš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\RenderThread.cpp]</span><br><span class="line">RenderTask* RenderThread::nextTask(nsecs_t* nextWakeup) &#123;</span><br><span class="line">    AutoMutex _lock(mLock);</span><br><span class="line">    RenderTask* next = mQueue.peek();</span><br><span class="line">    if (!next) &#123;</span><br><span class="line">        mNextWakeup = LLONG_MAX;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ......</span><br><span class="line">        if (next-&gt;mRunAt &lt;= 0 || next-&gt;mRunAt &lt;= systemTime(SYSTEM_TIME_MONOTONIC)) &#123;</span><br><span class="line">            next = mQueue.next();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            next = nullptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    return next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªä»»åŠ¡å¯ä»¥æ‰§è¡Œï¼Œé‚£ä¹ˆRenderThreadç±»çš„æˆå‘˜å‡½æ•°nextTaské€šè¿‡å‚æ•°nextWakeupè¿”å›çš„å€¼ä¸ºLLONG_MAXï¼Œè¡¨ç¤ºRender Threadæ¥ä¸‹æ¥æ— é™æœŸè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç›´åˆ°è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’ä¸ºæ­¢ã€‚<br> RenderThreadç±»æä¾›äº†queueã€queueAndWaitã€queueAtFrontå’ŒqueueAtå››ä¸ªæˆå‘˜å‡½æ•°å‘Task Queueå¢åŠ ä¸€ä¸ªTaskï¼Œå®ƒä»¬çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\RenderThread.cpp]</span><br><span class="line"><span class="keyword">void</span> RenderThread::<span class="built_in">queue</span>(RenderTask* task) &#123;</span><br><span class="line">    AutoMutex _lock(mLock);</span><br><span class="line">    mQueue.<span class="built_in">queue</span>(task);</span><br><span class="line">    <span class="keyword">if</span> (mNextWakeup &amp;&amp; task-&gt;mRunAt &lt; mNextWakeup) &#123;</span><br><span class="line">        mNextWakeup = <span class="number">0</span>;</span><br><span class="line">        mLooper-&gt;wake();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RenderThread::queueAndWait(RenderTask* task) &#123;</span><br><span class="line">    Mutex mutex;</span><br><span class="line">    Condition condition;</span><br><span class="line">    <span class="function">SignalingRenderTask <span class="title">syncTask</span><span class="params">(task, &amp;mutex, &amp;condition)</span></span>;</span><br><span class="line"></span><br><span class="line">    AutoMutex _lock(mutex);</span><br><span class="line">    <span class="built_in">queue</span>(&amp;syncTask);</span><br><span class="line">    condition.wait(mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RenderThread::queueAtFront(RenderTask* task) &#123;</span><br><span class="line">    AutoMutex _lock(mLock);</span><br><span class="line">    mQueue.queueAtFront(task);</span><br><span class="line">    mLooper-&gt;wake();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RenderThread::queueAt(RenderTask* task, <span class="keyword">nsecs_t</span> runAtNs) &#123;</span><br><span class="line">    task-&gt;mRunAt = runAtNs;</span><br><span class="line">    <span class="built_in">queue</span>(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹Render Threadåœ¨è¿›å…¥æ— é™å¾ªç¯ä¹‹å‰è°ƒç”¨çš„initThreadLocals()å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\RenderThread.cpp]</span><br><span class="line"><span class="keyword">void</span> RenderThread::initThreadLocals() &#123;</span><br><span class="line">    sp&lt;IBinder&gt; dtoken(SurfaceComposerClient::getBuiltInDisplay(</span><br><span class="line">            ISurfaceComposer::eDisplayIdMain));</span><br><span class="line">    <span class="keyword">status_t</span> status = SurfaceComposerClient::getDisplayInfo(dtoken, &amp;mDisplayInfo);</span><br><span class="line">    ......</span><br><span class="line">    initializeDisplayEventReceiver();</span><br><span class="line">    mEglManager = <span class="keyword">new</span> EglManager(*<span class="keyword">this</span>);</span><br><span class="line">    mRenderState = <span class="keyword">new</span> RenderState(*<span class="keyword">this</span>);</span><br><span class="line">    mJankTracker = <span class="keyword">new</span> JankTracker(mDisplayInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€initializeDisplayEventReceiveråˆ›å»ºå’Œåˆå§‹åŒ–ä¸€ä¸ªDisplayEventReceiverå¯¹è±¡ï¼Œç”¨æ¥æ¥æ”¶Vsyncä¿¡å·ã€‚<br>äº§ç”ŸVsyncä¿¡å·æ—¶ï¼ŒSurfaceFlingeræœåŠ¡ï¼ˆVsyncä¿¡å·ç”±SurfaceFlingeræœåŠ¡è¿›è¡Œç®¡ç†å’Œåˆ†å‘ï¼‰ä¼šé€šè¿‡ä¸Šè¿°æ–‡ä»¶æè¿°ç¬¦å·å”¤é†’Render Threadã€‚è¿™æ—¶å€™Render Threadå°±ä¼šè°ƒç”¨RenderThreadç±»çš„é™æ€æˆå‘˜å‡½æ•°displayEventReceiverCallback()-&gt;drainDisplayEventQueue()-&gt;<br>2ã€åˆ›å»ºä¸€ä¸ªEglManagerå¯¹è±¡ï¼Œä¹‹åä¼šè°ƒç”¨EglManager::initialize() Open GL ESç¯å¢ƒåˆå§‹åŒ–<br>3ã€åˆ›å»ºä¸€ä¸ªRenderStateå¯¹è±¡ï¼ˆè®°å½•Render Threadå½“å‰çš„ä¸€äº›æ¸²æŸ“çŠ¶æ€ï¼‰</p><h5 id="1-1-2-2ã€CanvasContext-ç”»å¸ƒä¸Šä¸‹æ–‡-çš„åˆå§‹åŒ–è¿‡ç¨‹"><a href="#1-1-2-2ã€CanvasContext-ç”»å¸ƒä¸Šä¸‹æ–‡-çš„åˆå§‹åŒ–è¿‡ç¨‹" class="headerlink" title="1.1.2.2ã€CanvasContext(ç”»å¸ƒä¸Šä¸‹æ–‡)çš„åˆå§‹åŒ–è¿‡ç¨‹"></a>1.1.2.2ã€CanvasContext(ç”»å¸ƒä¸Šä¸‹æ–‡)çš„åˆå§‹åŒ–è¿‡ç¨‹</h5><p>äº†è§£äº†Render Threadçš„åˆ›å»ºè¿‡ç¨‹ä¹‹åï¼Œå›åˆ°RenderProxyç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åˆ†æå®ƒçš„æˆå‘˜å˜é‡mContextçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ç”»å¸ƒä¸Šä¸‹æ–‡çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚è¿™æ˜¯é€šè¿‡å‘Render Threadå‘é€ä¸€ä¸ªcreateContextå‘½ä»¤æ¥å®Œæˆçš„ã€‚ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘ä»¬å°†ç›¸å…³çš„ä»£ç åˆ—å‡ºæ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\RenderProxy.cpp]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARGS(method) method ## Args  </span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CREATE_BRIDGE4(name, a1, a2, a3, a4) CREATE_BRIDGE(name, a1,a2,a3,a4,,,,)  </span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CREATE_BRIDGE(name, a1, a2, a3, a4, a5, a6, a7, a8) \  </span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span> \  </span><br><span class="line">        a1; a2; a3; a4; a5; a6; a7; a8; \  </span><br><span class="line">    &#125; ARGS(name); \  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span>* Bridge_ #<span class="meta"># name(ARGS(name)* args)  </span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SETUP_TASK(method) \  </span></span><br><span class="line">    .......  </span><br><span class="line">    MethodInvokeRenderTask* task = <span class="keyword">new</span> MethodInvokeRenderTask((RunnableMethod) Bridge_ ## method); \  </span><br><span class="line">    ARGS(method) *args = (ARGS(method) *) task-&gt;payload()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">CREATE_BRIDGE4(createContext, RenderThread* thread, <span class="keyword">bool</span> translucent,  </span><br><span class="line">        RenderNode* rootRenderNode, IContextFactory* contextFactory) &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CanvasContext(*args-&gt;thread, args-&gt;translucent,  </span><br><span class="line">            args-&gt;rootRenderNode, args-&gt;contextFactory);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> æˆ‘ä»¬é¦–å…ˆçœ‹å®SETUP_TASKï¼Œå®ƒéœ€è¦ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªå‡½æ•°é€šè¿‡CREATE_BRIDGEXæ¥å£°æ˜ï¼Œå…¶ä¸­Xæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ•°å­—çš„å¤§å°å°±ç­‰äºå‡½æ•°éœ€è¦çš„å‚æ•°çš„ä¸ªæ•°ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡CREATE_BRIDGE4å£°æ˜çš„å‡½æ•°æœ‰4ä¸ªå‚æ•°ã€‚åœ¨ä¸Šé¢çš„ä»£ç æ®µä¸­ï¼Œæˆ‘ä»¬é€šè¿‡CREATE_BRIDGE4å®å£°æ˜äº†ä¸€ä¸ªcreateContextå‡½æ•°ã€‚</p><p>å®SETUP_TASKçš„ä½œç”¨åˆ›å»ºä¸€ä¸ªç±»å‹MethodInvokeRenderTaskçš„Taskã€‚è¿™ä¸ªTaskå…³è”æœ‰ä¸€ä¸ªç”±CREATE_BRIDGEXå®å£°æ˜çš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼ŒSETUP_TASK(createContext)åˆ›å»ºçš„MethodInvokeRenderTaskå…³è”çš„å‡½æ•°æ˜¯ç”±CREATE_BRIDGE4å£°æ˜çš„å‡½æ•°createContextã€‚è¿™ä¸ªTaskæœ€ç»ˆä¼šé€šè¿‡RenderProxyç±»çš„æˆå‘˜å‡½æ•°postAndWaitæ·»åŠ åˆ°Render Threadçš„Task Queueä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\RenderProxy.cpp]</span><br><span class="line"><span class="keyword">void</span>* RenderProxy::postAndWait(MethodInvokeRenderTask* task) &#123;</span><br><span class="line">    <span class="keyword">void</span>* retval;</span><br><span class="line">    task-&gt;setReturnPtr(&amp;retval);</span><br><span class="line">    <span class="function">SignalingRenderTask <span class="title">syncTask</span><span class="params">(task, &amp;mSyncMutex, &amp;mSyncCondition)</span></span>;</span><br><span class="line">    AutoMutex _lock(mSyncMutex);</span><br><span class="line">    mRenderThread.<span class="built_in">queue</span>(&amp;syncTask);</span><br><span class="line">    mSyncCondition.wait(mSyncMutex);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RenderProxyå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹å°±åˆ†æå®Œæˆäº†ï¼Œä»ä¸­æˆ‘ä»¬ä¹Ÿçœ‹åˆ°Render Threadçš„åˆ›å»ºè¿‡ç¨‹å’Œè¿è¡Œæ¨¡å‹ï¼Œä»¥åŠRender Proxyä¸Render Threadçš„äº¤äº’æ¨¡å‹ï¼Œæ€»ç»“æ¥è¯´ï¼š</p><p>1ã€RenderProxyå†…éƒ¨æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡mRenderThreadï¼Œå®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªRenderThreadå¯¹è±¡ï¼Œé€šè¿‡å®ƒå¯ä»¥å‘Render Threadçº¿ç¨‹å‘é€å‘½ä»¤ã€‚</p><p>2ã€ RenderProxyå†…éƒ¨æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡mContextï¼Œå®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªCanvasContextå¯¹è±¡ï¼ŒRender Threadçš„æ¸²æŸ“å·¥ä½œå°±æ˜¯é€šè¿‡å®ƒæ¥å®Œæˆçš„ã€‚</p><p>3ã€RenderProxyå†…éƒ¨æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡mDrawFrameTaskï¼Œå®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªDrawFrameTaskå¯¹è±¡ï¼ŒMain Threadé€šè¿‡å®ƒå‘Render Threadçº¿ç¨‹å‘é€æ¸²æŸ“ä¸‹ä¸€å¸§çš„å‘½ä»¤ã€‚</p><h4 id="ï¼ˆäºŒï¼‰ã€Open-GL-ESç¯å¢ƒåˆå§‹åŒ–-ç»‘å®šçª—å£åˆ°Render-Threadä¸­"><a href="#ï¼ˆäºŒï¼‰ã€Open-GL-ESç¯å¢ƒåˆå§‹åŒ–-ç»‘å®šçª—å£åˆ°Render-Threadä¸­" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Open GL ESç¯å¢ƒåˆå§‹åŒ– (ç»‘å®šçª—å£åˆ°Render Threadä¸­)"></a>ï¼ˆäºŒï¼‰ã€Open GL ESç¯å¢ƒåˆå§‹åŒ– (ç»‘å®šçª—å£åˆ°Render Threadä¸­)</h4><p>Activityçª—å£çš„ç»˜åˆ¶æµç¨‹æ˜¯åœ¨ViewRoot(Impl)ç±»çš„æˆå‘˜å‡½æ•°performTraversalså‘èµ·çš„ã€‚åœ¨ç»˜åˆ¶ä¹‹å‰ï¼Œé¦–å…ˆè¦è·å¾—ä¸€ä¸ªSurfaceã€‚è¿™ä¸ªSurfaceæè¿°çš„å°±æ˜¯ä¸€ä¸ªçª—å£ã€‚å› æ­¤ï¼Œä¸€æ—¦è·å¾—äº†å¯¹åº”çš„Surfaceï¼Œå°±éœ€è¦å°†å®ƒç»‘å®šåˆ°Render Threadä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>,  </span></span><br><span class="line"><span class="class">        <span class="title">View</span>.<span class="title">AttachInfo</span>.<span class="title">Callbacks</span>, <span class="title">HardwareRenderer</span>.<span class="title">HardwareDrawCallbacks</span> </span>&#123;  </span><br><span class="line">    ......  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        ......</span><br><span class="line">        hwInitialized = mAttachInfo.mHardwareRenderer.initialize(  </span><br><span class="line">                                        mSurface);  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mHardwareRendererå¯¹è±¡ï¼Œå®ƒçš„æˆå‘˜å‡½æ•°initializeçš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\view\ThreadedRenderer.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">(Surface surface)</span> <span class="keyword">throws</span> OutOfResourcesException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> status = !mInitialized;</span><br><span class="line">        mInitialized = <span class="keyword">true</span>;</span><br><span class="line">        updateEnabledState(surface);</span><br><span class="line">        nInitialize(mNativeProxy, surface);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>nInitializeæ˜¯ä¸€ä¸ªJNIå‡½æ•°ï¼Œç”±Nativeå±‚çš„å‡½æ•°android_view_ThreadedRenderer_initializeå®ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\jni\android_view_ThreadedRenderer.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_view_ThreadedRenderer_initialize</span><span class="params">(JNIEnv* env, jobject clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong proxyPtr, jobject jsurface)</span> </span>&#123;</span><br><span class="line">    RenderProxy* proxy = <span class="keyword">reinterpret_cast</span>&lt;RenderProxy*&gt;(proxyPtr);</span><br><span class="line">    sp&lt;Surface&gt; surface = android_view_Surface_getSurface(env, jsurface);</span><br><span class="line">    proxy-&gt;initialize(surface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaå±‚çš„Surfaceåœ¨Nativeå±‚å¯¹åº”çš„æ˜¯ä¸€ä¸ªANativeWindowã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‡½æ•°android_view_Surface_getNativeWindowæ¥è·å¾—ä¸€ä¸ªJavaå±‚çš„Surfaceåœ¨Nativeå±‚å¯¹åº”çš„ANativeWindow<br>RenderProxy-&gt;initialize()å‡½æ•°å®ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE_BRIDGE2(initialize, CanvasContext* context, Surface* surface) &#123;</span><br><span class="line">    args-&gt;context-&gt;initialize(args-&gt;surface);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RenderProxy::initialize(<span class="keyword">const</span> sp&lt;Surface&gt;&amp; surface) &#123;</span><br><span class="line">    SETUP_TASK(initialize);</span><br><span class="line">    args-&gt;context = mContext;</span><br><span class="line">    args-&gt;surface = surface.get();</span><br><span class="line">    post(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è¿™ä¸ªTaskåœ¨Render Threadä¸­æ‰§è¡Œæ—¶ï¼Œç”±å®CREATE_BRIDGE2å£°æ˜çš„å‡½æ•°initializeå°±ä¼šè¢«æ‰§è¡Œã€‚</p><p>åœ¨ç”±å®CREATE_BRIDGE2å£°æ˜çš„å‡½æ•°initializeä¸­ï¼Œå‚æ•°contextæŒ‡å‘çš„æ˜¯RenderProxyç±»çš„æˆå‘˜å˜é‡mContextæŒ‡å‘çš„ä¸€ä¸ªCanvasContextå¯¹è±¡ï¼Œè€Œå‚æ•°windowæŒ‡å‘çš„ANativeWindowå°±æ˜¯è¦ç»‘å®šåˆ°Render Threadçš„ANativeWindowã€‚</p><p>ç”±å®CREATE_BRIDGE2å£°æ˜çš„å‡½æ•°initializeé€šè¿‡è°ƒç”¨å‚æ•°contextæŒ‡å‘çš„CanvasContextå¯¹è±¡çš„æˆå‘˜å‡½æ•°initializeæ¥ç»‘å®šå‚æ•°windowæŒ‡å‘çš„ANativeWindowï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\CanvasContext.cpp]</span><br><span class="line"><span class="keyword">void</span> CanvasContext::initialize(Surface* surface) &#123;</span><br><span class="line">    setSurface(surface);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !HWUI_NEW_OPS</span></span><br><span class="line">    <span class="keyword">if</span> (mCanvas) <span class="keyword">return</span>;</span><br><span class="line">    mCanvas = <span class="keyword">new</span> OpenGLRenderer(mRenderThread.renderState());</span><br><span class="line">    mCanvas-&gt;initProperties();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> CanvasContext::setSurface(Surface* surface) &#123;</span><br><span class="line">    mNativeSurface = surface;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (surface) &#123;</span><br><span class="line">        mEglSurface = mEglManager.createSurface(surface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mEglSurface != EGL_NO_SURFACE) &#123;</span><br><span class="line">        ......</span><br><span class="line">        mHaveNewSurface = <span class="literal">true</span>;</span><br><span class="line">        .....</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mRenderThread.removeFrameCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªOpen GLæ¸²æŸ“ä¸Šä¸‹æ–‡éƒ½éœ€è¦å…³è”æœ‰ä¸€ä¸ªEGL Surfaceã€‚è¿™ä¸ªEGL Surfaceæè¿°çš„æ˜¯ä¸€ä¸ªç»˜å›¾è¡¨é¢ï¼Œå®ƒå°è£…çš„å®é™…ä¸Šæ˜¯ä¸€ä¸ªANativeWindowã€‚æœ‰äº†è¿™ä¸ªEGL Surfaceä¹‹åï¼Œæˆ‘ä»¬åœ¨æ‰§è¡ŒOpen GLå‘½ä»¤çš„æ—¶å€™ï¼Œæ‰èƒ½ç¡®å®šè¿™äº›å‘½ä»¤æ˜¯ä½œç”¨åœ¨å“ªä¸ªçª—å£ä¸Šã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\EglManager.cpp]</span><br><span class="line">EGLSurface EglManager::createSurface(EGLNativeWindowType window) &#123;</span><br><span class="line">    initialize();</span><br><span class="line">    EGLSurface surface = eglCreateWindowSurface(mEglDisplay, mEglConfig, window, <span class="literal">nullptr</span>);</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> surface;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> EglManager::initialize() &#123;</span><br><span class="line">    ......</span><br><span class="line">    loadConfig();<span class="comment">//</span></span><br><span class="line">    createContext();<span class="comment">//</span></span><br><span class="line">    createPBufferSurface();<span class="comment">//</span></span><br><span class="line">    makeCurrent(mPBufferSurface);<span class="comment">//</span></span><br><span class="line">    DeviceInfo::initialize();</span><br><span class="line">    mRenderThread.renderState().onGLContextCreated();</span><br><span class="line">    initAtlas();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨EGLçš„ç»˜å›¾çš„ä¸€èˆ¬æ­¥éª¤ï¼š<br>1ã€è·å– EGL Display å¯¹è±¡ï¼šeglGetDisplay()<br>2ã€åˆå§‹åŒ–ä¸ EGLDisplay ä¹‹é—´çš„è¿æ¥ï¼šeglInitialize()<br>3ã€è·å– EGLConfig å¯¹è±¡ï¼šeglChooseConfig()<br>4ã€åˆ›å»º EGLContext å®ä¾‹ï¼šeglCreateContext()<br>5ã€åˆ›å»º EGLSurface å®ä¾‹ï¼šeglCreateWindowSurface()<br>6ã€è¿æ¥ EGLContext å’Œ EGLSurfaceï¼šeglMakeCurrent()<br>7ã€ä½¿ç”¨ OpenGL ES API ç»˜åˆ¶å›¾å½¢ï¼šgl_*()<br>8ã€åˆ‡æ¢ front buffer å’Œ back buffer é€æ˜¾ï¼šeglSwapBuffer()<br>9ã€æ–­å¼€å¹¶é‡Šæ”¾ä¸ EGLSurface å…³è”çš„ EGLContext å¯¹è±¡ï¼šeglRelease()<br>10ã€åˆ é™¤ EGLSurface å¯¹è±¡<br>11ã€åˆ é™¤ EGLContext å¯¹è±¡<br>12ã€ç»ˆæ­¢ä¸ EGLDisplay ä¹‹é—´çš„è¿æ¥</p></blockquote><p>Android EGL &amp;&amp; OpenGLåˆ†æè¯·å‚è€ƒã€Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æ ä¹‹ Android EGL &amp;&amp; OpenGLã€‘</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-03-UIThread-ThreadRenderer.png" alt="Alt text | center"></p><p>è‡³æ­¤ï¼Œå°†å½“å‰çª—å£ç»‘å®šåˆ°Render Threadçš„è¿‡ç¨‹å°±åˆ†æå®Œæˆäº†ï¼Œæ•´ä¸ªAndroidåº”ç”¨ç¨‹åºUIç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ç¯å¢ƒçš„åˆå§‹åŒ–è¿‡ç¨‹ä¹Ÿåˆ†æå®Œæˆäº†ã€‚</p><h4 id="ï¼ˆä¸‰ï¼‰ã€RenderNodeæ„å»º"><a href="#ï¼ˆä¸‰ï¼‰ã€RenderNodeæ„å»º" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€RenderNodeæ„å»º"></a>ï¼ˆä¸‰ï¼‰ã€RenderNodeæ„å»º</h4><p>æˆ‘ä»¬çŸ¥é“ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒAppè¦å®Œæˆä¸€å¸§æ¸²æŸ“ï¼Œæ˜¯é€šè¿‡ViewRootImplçš„performTraversals()å‡½æ•°æ¥å®ç°ã€‚è€Œå®ƒåˆå¯åˆ†ä¸ºmeasure, layout, drawä¸‰ä¸ªé˜¶æ®µã€‚ä¸Šé¢è¿™äº›æ”¹åŠ¨ä¸»è¦å½±å“çš„æ˜¯æœ€åè¿™æ­¥ï¼Œå› æ­¤æˆ‘ä»¬å°±ä¸»è¦focusåœ¨drawè¿™ä¸ªé˜¶æ®µçš„æµç¨‹ã€‚é¦–å…ˆçœ‹DisplayListæ˜¯æ€ä¹ˆå½•åˆ¶çš„ã€‚åœ¨ViewRootImpl::performDraw()ä¸­ä¼šè°ƒç”¨draw()å‡½æ•°ã€‚å½“åˆ¤æ–­éœ€è¦è¿›è¡Œç»˜åˆ¶æ—¶ï¼ˆæ¯”å¦‚æœ‰è„åŒºåŸŸï¼Œæˆ–åœ¨åŠ¨ç”»ä¸­æ—¶ï¼‰ï¼Œåˆå¦‚æœç¡¬ä»¶åŠ é€Ÿå¯ç”¨ï¼ˆé€šè¿‡ThreadedRendererçš„isEnabled()ï¼‰ï¼Œä¼šè¿›è¡Œä¸‹é¢çš„é‡ç»˜åŠ¨ä½œã€‚æ¥ä¸‹æ¥æ ¹æ®æ˜¯å¦æœ‰ç›¸å…³è¯·æ±‚ï¼ˆå¦‚resizeæ—¶ï¼‰æˆ–offsetæ˜¯å¦æœ‰å˜åŒ–æ¥åˆ¤æ–­æ˜¯å¦è¦è°ƒç”¨ThreadedRendererçš„invalidRoot()æ¥æ ‡è®°æ›´æ–°RootRenderNodeã€‚</p><p>æ‰¯ä¸ªé¢˜å¤–è¯ã€‚å’ŒAndroid Mç›¸æ¯”ï¼ŒNä¸­UIå­ç³»ç»Ÿä¸­åŠ å…¥äº†ä¸å°‘å¯¹ç”¨æˆ·è¿›è¡Œçª—å£resizeçš„å¤„ç†ï¼Œä¸»è¦åº”è¯¥æ˜¯ä¸ºäº†Android Næ–°å¢åŠ çš„å¤šçª—å£åˆ†å±æ¨¡å¼ã€‚æ¯”å¦‚å½“ç”¨æˆ·æ‹–æ‹½åˆ†å±çª—å£è¾¹ç¼˜æ—¶ï¼ŒonWindowDragResizeStart()è¢«è°ƒç”¨ã€‚å®ƒå…¶ä¸­ä¼šåˆ›å»ºBackdropFrameRendererã€‚BackdropFrameRendereræœ¬èº«è¿è¡Œå•ç‹¬çš„çº¿ç¨‹ï¼Œå®ƒè´Ÿè´£åœ¨resizeçª—å£è€Œçª—å£ç»˜åˆ¶æ¥ä¸åŠçš„æƒ…å†µä¸‹å¡«å……èƒŒæ™¯ã€‚å®ƒä¼šé€šè¿‡addRenderNode()åŠ å…¥ä¸“ç”¨çš„RenderNodeã€‚åŒæ—¶ï¼ŒAndroid Nä¸­å°†DecorViewä»PhoneWindowä¸­åˆ†ç¦»æˆä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œå¹¶å®ç°æ–°åŠ çš„WindowCallbacksæ¥å£ã€‚å®ƒä¸»è¦ç”¨äºå½“ç”¨æˆ·å˜åŒ–çª—å£å¤§å°æ—¶ViewRootImplå¯¹DecorViewçš„å›è°ƒã€‚å› ä¸ºViewRootImplå’ŒWindowManagerServiceé€šä¿¡ï¼Œå®ƒä¼šè¢«é€šçŸ¥åˆ°çª—å£å˜åŒ–ï¼Œç„¶åå›è°ƒåˆ°DecorViewä¸­ã€‚è€ŒDecorViewä¸­çš„ç›¸åº”å›è°ƒä¼šå’ŒBackupdropFrameRendereräº¤äº’ã€‚å¦‚updateContentDrawBounds()ä¸­æœ€åä¼šè°ƒç”¨åˆ°äº†BackupdropFrmeRendererçš„onContentDrawn()å‡½æ•°ï¼Œå…¶è¿”å›å€¼ä»£è¡¨åœ¨ä¸‹é¢çš„å†…å®¹ç»˜åˆ¶åæ˜¯å¦éœ€è¦å†å‘èµ·ä¸€æ¬¡ç»˜åˆ¶ã€‚å¦‚æœéœ€è¦ï¼Œä¹‹åä¼šè°ƒç”¨requestDrawWindow()ã€‚</p><p>å›åˆ°ViewRootImpl::performDraw()å‡½æ•°ï¼Œæ¥ä¸‹æ¥ï¼Œæœ€é‡è¦çš„å°±æ˜¯é€šè¿‡ThreadedRendererçš„draw()æ¥è¿›è¡Œç»˜åˆ¶ã€‚åœ¨è¿™ä¸ªdraw()å‡½æ•°ä¸­ï¼Œæ¯”è¾ƒé‡è¦çš„ä¸€æ­¥æ˜¯é€šè¿‡updateRootDisplayList()å‡½æ•°æ¥æ›´æ–°æ ¹ç»“ç‚¹çš„DisplayListã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\view\ThreadedRenderer.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateViewTreeDisplayList</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        view.mPrivateFlags |= View.PFLAG_DRAWN;</span><br><span class="line">        view.mRecreateDisplayList = (view.mPrivateFlags &amp; View.PFLAG_INVALIDATED)</span><br><span class="line">                == View.PFLAG_INVALIDATED;</span><br><span class="line">        view.mPrivateFlags &amp;= ~View.PFLAG_INVALIDATED;</span><br><span class="line">        view.updateDisplayListIfDirty();</span><br><span class="line">        view.mRecreateDisplayList = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRootDisplayList</span><span class="params">(View view, HardwareDrawCallbacks callbacks)</span> </span>&#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"Record View#draw()"</span>);</span><br><span class="line">        updateViewTreeDisplayList(view);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mRootNodeNeedsUpdate || !mRootNode.isValid()) &#123;</span><br><span class="line">            DisplayListCanvas canvas = mRootNode.start(mSurfaceWidth, mSurfaceHeight);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> saveCount = canvas.save();</span><br><span class="line">                canvas.translate(mInsetLeft, mInsetTop);</span><br><span class="line">                callbacks.onHardwarePreDraw(canvas);</span><br><span class="line"></span><br><span class="line">                canvas.insertReorderBarrier();</span><br><span class="line">                canvas.drawRenderNode(view.updateDisplayListIfDirty());</span><br><span class="line">                canvas.insertInorderBarrier();</span><br><span class="line"></span><br><span class="line">                callbacks.onHardwarePostDraw(canvas);</span><br><span class="line">                canvas.restoreToCount(saveCount);</span><br><span class="line">                mRootNodeNeedsUpdate = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mRootNode.end(canvas);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å‡½æ•°updateRootDisplayList()ä¸­çš„updateViewTreeDisplayList()ä¼šè°ƒåˆ°DecorViewçš„updateDisplayListIfDirty()å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦åŠŸèƒ½æ˜¯æ›´æ–°DecorViewå¯¹åº”çš„RenderNodeä¸­çš„DisplayListã€‚å®ƒè¿”å›çš„RenderNodeä¼šé€šè¿‡RecordingCanvas::drawRenderNode()å‡½æ•°å°†ä¹‹ä½œä¸ºRenderNodeOpåŠ å…¥åˆ°RootRenderNodeçš„DisplayListä¸­ã€‚å‡½æ•°updateDisplayListIfDirty()ä¸­é¦–å…ˆåˆ¤æ–­å½“å‰Viewæ˜¯å¦éœ€è¦æ›´æ–°ã€‚å¦‚æœä¸éœ€è¦å°±è°ƒç”¨dispatchGetDisplayList()è®©å­Viewæ›´æ–°ï¼Œç„¶åç›´æ¥è¿”å›ã€‚å¦åˆ™å°±æ˜¯å½“å‰Viewçš„DisplayListéœ€è¦æ›´æ–°ã€‚è¿™é‡Œæˆ‘ä»¬å‡è®¾æ˜¯ç¬¬ä¸€æ¬¡ç»˜åˆ¶ï¼Œæ›´æ–°DisplayListçš„æµç¨‹é¦–å…ˆé€šè¿‡RenderNodeçš„start()æ¥è·å¾—ä¸€ä¸ªç”¨äºè®°å½•ç»˜åˆ¶æ“ä½œçš„Canvasï¼Œå³DisplayListCanvasï¼ˆåœ¨Android Mä¸­Javaå±‚ç”±GLES20RecordingCanvasæ”¹ä¸ºDisplayListCanvasï¼Œnativeå±‚ä¸­çš„DisplayListRendereræ”¹ä¸ºDisplayListCanvasï¼ŒAndroid Nä¸­nativeå±‚ä¸­çš„DisplayListCanvasæ”¹ä¸ºRecordingCanvasï¼‰ã€‚</p><p>æ¥ä¸‹å»å°±æ˜¯æ¯”è¾ƒå…³é”®çš„æ­¥éª¤äº†ã€‚è¿™é‡Œå°±è¦åˆ†å‡ ç§æƒ…å†µäº†ï¼Œä¸€ä¸ªViewå¯ä»¥ä¸ºä¸‰ç§ç±»å‹ï¼ˆLAYER_TYPE_NONE, LAYER_TYPE_SOFTWARE, LAYER_TYPE_HARDWAREï¼‰ä¸­çš„ä¸€ç§ã€‚LAYER_TYPE_NONEä¸ºé»˜è®¤å€¼ï¼Œä»£è¡¨æ²¡æœ‰layerã€‚LAYER_TYPE_SOFTWAREä»£è¡¨è¯¥Viewæœ‰è½¯ä»¶å±‚ï¼Œä»¥bitmapä¸ºbackï¼Œå†…å®¹ç”¨è½¯ä»¶æ¸²æŸ“ã€‚LAYER_TYPE_HARDWAREå’ŒLAYER_TYPE_SOFTWAREç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå…¶æœ‰ç¡¬ä»¶å±‚ï¼Œä»¥FBOï¼ˆFramebuffer objectï¼‰ä¸ºbackï¼Œå†…å®¹ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“ã€‚å¦‚æœç¡¬ä»¶åŠ é€Ÿæ²¡æœ‰æ‰“å¼€ï¼Œå®ƒçš„è¡Œä¸ºå’ŒLAYER_TYPE_SOFTWAREæ˜¯ä¸€æ ·çš„ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\view\ThreadedRenderer.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RenderNode <span class="title">updateDisplayListIfDirty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        final RenderNode renderNode = mRenderNode;</span><br><span class="line">       .......</span><br><span class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == <span class="number">0</span></span><br><span class="line">                || !renderNode.isValid()</span><br><span class="line">                || (mRecreateDisplayList)) &#123;</span><br><span class="line">            <span class="comment">// Don't need to recreate the display list, just need to tell our</span></span><br><span class="line">            <span class="comment">// children to restore/recreate theirs</span></span><br><span class="line">            <span class="keyword">if</span> (renderNode.isValid()</span><br><span class="line">                    &amp;&amp; !mRecreateDisplayList) &#123;</span><br><span class="line">                mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</span><br><span class="line">                mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</span><br><span class="line">                dispatchGetDisplayList();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> renderNode; <span class="comment">// no work needed</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we got here, we're recreating it. Mark it as such to ensure that</span></span><br><span class="line">            <span class="comment">// we copy in child display lists into ours in drawChild()</span></span><br><span class="line">            mRecreateDisplayList = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> width = mRight - mLeft;</span><br><span class="line">            <span class="keyword">int</span> height = mBottom - mTop;</span><br><span class="line">            <span class="keyword">int</span> layerType = getLayerType();</span><br><span class="line"></span><br><span class="line">            final DisplayListCanvas canvas = renderNode.start(width, height);</span><br><span class="line">            canvas.setHighContrastText(mAttachInfo.mHighContrastText);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (layerType == LAYER_TYPE_SOFTWARE) &#123;</span><br><span class="line">                    buildDrawingCache(<span class="literal">true</span>);</span><br><span class="line">                    Bitmap cache = getDrawingCache(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (cache != null) &#123;</span><br><span class="line">                        canvas.drawBitmap(cache, <span class="number">0</span>, <span class="number">0</span>, mLayerPaint);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    computeScroll();</span><br><span class="line"></span><br><span class="line">                    canvas.translate(-mScrollX, -mScrollY);</span><br><span class="line">                    mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</span><br><span class="line">                    mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Fast path for layouts with no backgrounds</span></span><br><span class="line">                    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SKIP_DRAW) == PFLAG_SKIP_DRAW) &#123;</span><br><span class="line">                        dispatchDraw(canvas);</span><br><span class="line">                        <span class="keyword">if</span> (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) &#123;</span><br><span class="line">                            mOverlay.getOverlayView().draw(canvas);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        draw(canvas);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                renderNode.end(canvas);</span><br><span class="line">                setDisplayListProperties(renderNode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</span><br><span class="line">            mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> renderNode;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå½“å‰Viewæ˜¯è½¯ä»¶æ¸²æŸ“å±‚ï¼ˆç±»å‹ä¸ºLAYER_TYPE_SOFTWAREï¼‰çš„è¯ï¼Œåˆ™è°ƒç”¨buildDrawingCache()è·å¾—Bitmapåè°ƒç”¨drawBitmap()å°†è¯¥Bitmapè®°å½•åˆ°DisplayListCanvasä¸­ã€‚ç°åœ¨Androidä¸­éƒ½é»˜è®¤ç¡¬ä»¶æ¸²æŸ“äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è€ƒè™‘è½¯ä»¶æ¸²æŸ“å±‚å‘¢?ä¸€æ–¹é¢æœ‰äº›å¹³å°ä¸æ”¯æŒç¡¬ä»¶æ¸²æŸ“ï¼Œæˆ–appä¸å¯ç”¨ç¡¬ä»¶åŠ é€Ÿï¼Œå¦ä¸€æ–¹é¢æœ‰äº›UIæ§ä»¶ä¸æ”¯æŒç¡¬ä»¶æ¸²æŸ“ ã€‚åœ¨å¤æ‚çš„Viewï¼ˆåŠå­Viewï¼‰åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è¢«ç»˜åˆ¶æˆçº¹ç†ï¼Œè¿™æ ·åªéœ€è¦ç”»ä¸€æ¬¡ã€‚æ˜¾ç„¶ï¼Œåœ¨Viewç»å¸¸æ›´æ–°çš„æƒ…å†µä¸‹å¹¶ä¸é€‚ç”¨ã€‚å› ä¸ºè¿™æ ·æ¯æ¬¡éƒ½éœ€è¦é‡æ–°ç”¨è½¯ä»¶æ¸²æŸ“ï¼Œå¦‚æœç¡¬ä»¶æ¸²æŸ“æ‰“å¼€æ—¶è¿˜è¦ä¸Šä¼ æˆç¡¬ä»¶çº¹ç†ï¼ˆä¸Šä¼ çº¹ç†æ˜¯ä¸ªæ¯”è¾ƒæ…¢çš„æ“ä½œï¼‰ã€‚ç±»ä¼¼çš„ï¼Œç¡¬ä»¶æ¸²æŸ“å±‚ï¼ˆLAYER_TYPE_HARDWAREï¼‰ä¹Ÿæ˜¯é€‚ç”¨äºç±»ä¼¼çš„å¤æ‚Viewç»“æ„è¿›è¡Œå±æ€§åŠ¨ç”»çš„åœºæ™¯ï¼Œä½†å®ƒä¸LAYER_TYPE_SOFTWAREçš„å±‚çš„åŒºåˆ«ä¸ºå®ƒå¯¹åº”FBOï¼Œå¯ä»¥ç›´æ¥ç¡¬ä»¶æ¸²æŸ“ç”Ÿæˆçº¹ç†ã€‚å› æ­¤æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ä¸éœ€è¦å…ˆç”ŸæˆBitmapï¼Œä»è€Œçœå»äº†ä¸Šä¼ æˆç¡¬ä»¶çº¹ç†çš„è¿™ä¸€æ­¥æ“ä½œã€‚</p><p>å¦‚æœå½“å‰Viewå¯¹åº”LAYER_TYPE_NONEæˆ–è€…LAYER_TYPE_HARDWAREï¼Œä¸‹é¢ä¼šè€ƒæŸ¥æ˜¯å¦ä¸ºæ²¡æœ‰èƒŒæ™¯çš„Layoutã€‚è¿™ç§æƒ…å†µä¸‹å½“å‰Viewæ²¡ä»€ä¹ˆå¥½ç”»çš„ï¼Œä¼šèµ°å¿«é€Ÿè·¯å¾„ã€‚å³é€šè¿‡dispatchDraw()ç›´æ¥è®©å­Viewé‡ç»˜ã€‚å¦åˆ™å°±è°ƒdraw()æ¥ç»˜åˆ¶å½“å‰ViewåŠå…¶å­Viewã€‚æ³¨æ„Viewä¸­çš„draw()æœ‰ä¸¤ä¸ªé‡è½½åŒåå‡½æ•°ã€‚ä¸€ä¸ªå‚æ•°çš„ç‰ˆæœ¬ç”¨äºç›´æ¥è°ƒç”¨ã€‚ä¸‰ä¸ªå‚æ•°çš„ç‰ˆæœ¬ç”¨äºViewGroupä¸­drawChild()æ—¶è°ƒç”¨ã€‚è¿™é‡Œè°ƒçš„æ˜¯ä¸€ä¸ªå‚æ•°çš„ç‰ˆæœ¬ã€‚è¿™ä¸ªdraw()å‡½æ•°ä¸­ä¼šæŒ‰ä¸‹é¢çš„é¡ºåºè¿›è¡Œç»˜åˆ¶ï¼ˆDisplayListçš„æ›´æ–°ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</span><br><span class="line">            (mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</span><br><span class="line">    mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Draw traversal performs several drawing steps which must be executed</span></span><br><span class="line"><span class="comment">     * in the appropriate order:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      1. Draw the background</span></span><br><span class="line"><span class="comment">     *      2. If necessary, save the canvas' layers to prepare for fading</span></span><br><span class="line"><span class="comment">     *      3. Draw view's content</span></span><br><span class="line"><span class="comment">     *      4. Draw children</span></span><br><span class="line"><span class="comment">     *      5. If necessary, draw the fading edges and restore layers</span></span><br><span class="line"><span class="comment">     *      6. Draw decorations (scrollbars for instance)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1, draw the background, if needed</span></span><br><span class="line">    ......</span><br><span class="line">    drawBackground(canvas);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</span><br><span class="line">    <span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 3, draw the content</span></span><br><span class="line">    <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 4, draw the children</span></span><br><span class="line">    dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 5, draw the fade effect and restore layers</span></span><br><span class="line">    <span class="keyword">final</span> Paint p = scrollabilityCache.paint;</span><br><span class="line">    <span class="keyword">final</span> Matrix matrix = scrollabilityCache.matrix;</span><br><span class="line">    <span class="keyword">final</span> Shader fade = scrollabilityCache.shader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (drawTop) &#123;</span><br><span class="line">        matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</span><br><span class="line">        matrix.postTranslate(left, top);</span><br><span class="line">        fade.setLocalMatrix(matrix);</span><br><span class="line">        p.setShader(fade);</span><br><span class="line">        canvas.drawRect(left, top, right, top + length, p);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    canvas.restoreToCount(saveCount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Overlay is part of the content and draws beneath Foreground</span></span><br><span class="line">    <span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</span><br><span class="line">        mOverlay.getOverlayView().dispatchDraw(canvas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 6, draw decorations (foreground, scrollbars)</span></span><br><span class="line">    onDrawForeground(canvas);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›æ˜¯é€šè¿‡drawBackground(), onDraw(), dispatchDraw()å’ŒonDrawForeground()ç­‰å‡½æ•°å®ç°ã€‚è¿™äº›å‡½æ•°æœ¬è´¨ä¸Šå°±æ˜¯å°†ç›¸åº”å†…å®¹ç»˜åˆ¶åˆ°æä¾›çš„DisplayListCanvasä¸Šã€‚ç”±äºViewæ˜¯ä»¥æ ‘å½¢å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ï¼Œdraw()ä¸­ä¼šé€šè¿‡dispatchDraw()æ¥æ›´æ–°å­Viewçš„DisplayListã€‚dispatchDraw()ä¸ºå¯¹æ¯ä¸ªå­Viewè°ƒç”¨drawChild()ã€‚ç„¶åè°ƒç”¨å­Viewçš„draw()å‡½æ•°ï¼ˆè¿™æ¬¡å°±æ˜¯ä¸Šé¢è¯´çš„draw()çš„ä¸‰ä¸ªå‚æ•°çš„ç‰ˆæœ¬äº†ï¼‰ã€‚è¿™ä¸ªç‰ˆæœ¬çš„draw()å‡½æ•°é‡Œä¼šæ›´æ–°å…¶Viewçš„DisplayListï¼Œç„¶åè°ƒç”¨DisplayListCanvasçš„drawRenderNode()å°†è¯¥å­viewå¯¹åº”çš„RenderNodeè®°å½•åˆ°å…¶çˆ¶viewçš„DisplayListä¸­å»ã€‚è¿™æ ·ä¾¿æ ¹æ®Viewçš„æ ‘å‹ç»“æ„ç”Ÿæˆäº†DisplayListçš„æ ‘å‹ç»“æ„ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-04-DisplayList-RootRenderNode.png" alt="Alt text | center"></p><p>å…¶ä¸­onDraw()ç”¨äºç»˜åˆ¶å½“å‰Viewçš„è‡ªå®šä¹‰UIï¼Œå®ƒæ˜¯æ¯ä¸ªViewéœ€è¦è‡ªå®šä¹‰çš„æˆå‘˜å‡½æ•°ã€‚æ¯”è¾ƒå…¸å‹åœ°ï¼Œåœ¨Viewçš„ç»˜åˆ¶å‡½æ•°ä¸­ä¼šè°ƒç”¨canvasçš„drawXXXå‡½æ•°ã€‚æ¯”å¦‚canvas.drawLine()-&gt;drawLines(android_graphics_Canvas.cpp)ï¼Œå®ƒä¼šé€šè¿‡JNIæœ€åè°ƒåˆ°RecordingCanvas.cppä¸­çš„RecordingCanvas::drawLines()ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\RecordingCanvas.cpp]</span><br><span class="line"><span class="keyword">void</span> RecordingCanvas::drawLines(<span class="keyword">const</span> <span class="keyword">float</span>* points, <span class="keyword">int</span> floatCount, <span class="keyword">const</span> SkPaint&amp; paint) &#123;</span><br><span class="line">    <span class="keyword">if</span> (CC_UNLIKELY(floatCount &lt; <span class="number">4</span> || PaintUtils::paintWillNotDraw(paint))) <span class="keyword">return</span>;</span><br><span class="line">    floatCount &amp;= ~<span class="number">0x3</span>; <span class="comment">// round down to nearest four</span></span><br><span class="line"></span><br><span class="line">    addOp(alloc().create_trivial&lt;LinesOp&gt;(</span><br><span class="line">            calcBoundsOfPoints(points, floatCount),</span><br><span class="line">            *mState.currentSnapshot()-&gt;transform,</span><br><span class="line">            getRecordedClip(),</span><br><span class="line">            refPaint(&amp;paint), refBuffer&lt;<span class="keyword">float</span>&gt;(points, floatCount), floatCount));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RecordingCanvasä¸­ç»å¤§å¤šæ•°çš„drawXXXç³»å‡½æ•°éƒ½æ˜¯ç±»ä¼¼äºè¿™æ ·ï¼Œé€šè¿‡addOp()å°†ä¸€ä¸ªRecordedOpçš„ç»§æ‰¿ç±»å­˜åˆ°å…¶æˆå‘˜mDisplayListä¸­ã€‚RecordedOpå®¶åº­æˆå‘˜å¾ˆå¤šï¼Œæœ‰ä¸å°‘ç»§æ‰¿ç±»ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ç§æ“ä½œã€‚æ“ä½œçš„ç§ç±»å¯ä»¥å‚ç…§ä¸‹è¿™ä¸ªè¡¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\RecordedOp.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAP_OPS_BASED_ON_TYPE(PRE_RENDER_OP_FN, RENDER_ONLY_OP_FN, UNMERGEABLE_OP_FN, MERGEABLE_OP_FN) \</span></span><br><span class="line">        PRE_RENDER_OP_FN(RenderNodeOp) \</span><br><span class="line">        PRE_RENDER_OP_FN(CirclePropsOp) \</span><br><span class="line">        PRE_RENDER_OP_FN(RoundRectPropsOp) \</span><br><span class="line">        PRE_RENDER_OP_FN(BeginLayerOp) \</span><br><span class="line">        PRE_RENDER_OP_FN(EndLayerOp) \</span><br><span class="line">        PRE_RENDER_OP_FN(BeginUnclippedLayerOp) \</span><br><span class="line">        PRE_RENDER_OP_FN(EndUnclippedLayerOp) \</span><br><span class="line">        PRE_RENDER_OP_FN(VectorDrawableOp) \</span><br><span class="line">        \</span><br><span class="line">        RENDER_ONLY_OP_FN(ShadowOp) \</span><br><span class="line">        RENDER_ONLY_OP_FN(LayerOp) \</span><br><span class="line">        RENDER_ONLY_OP_FN(CopyToLayerOp) \</span><br><span class="line">        RENDER_ONLY_OP_FN(CopyFromLayerOp) \</span><br><span class="line">        \</span><br><span class="line">        UNMERGEABLE_OP_FN(ArcOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(BitmapMeshOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(BitmapRectOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(ColorOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(FunctorOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(LinesOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(OvalOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(PathOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(PointsOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(RectOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(RoundRectOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(SimpleRectsOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(TextOnPathOp) \</span><br><span class="line">        UNMERGEABLE_OP_FN(TextureLayerOp) \</span><br><span class="line">        \</span><br><span class="line">        MERGEABLE_OP_FN(BitmapOp) \</span><br><span class="line">        MERGEABLE_OP_FN(PatchOp) \</span><br><span class="line">        MERGEABLE_OP_FN(TextOp)</span><br></pre></td></tr></table></figure><p>å„ä¸ªViewçš„DisplayListæ›´æ–°å¥½åï¼Œå›åˆ°udpateRootDisplayList()ã€‚å¦‚æœå‘ç°RootRenderNodeä¹Ÿéœ€è¦æ›´æ–°ï¼Œåˆ™å…ˆé€šè¿‡Javaå±‚çš„RenderNode::start()è·å¾—DisplayListCanvasï¼Œåœ¨è¿™ä¸ªCanvasä¸Šçš„åŠ¨ä½œéƒ½ä¼šè¢«è®°å½•åˆ°DisplayListä¸­ï¼Œç›´åˆ°è°ƒç”¨RenderNode.end()ã€‚ç„¶åä¸ºäº†é˜²æ­¢å¯¹ä¸Šä¸‹æ–‡çŠ¶æ€çš„å½±å“ï¼Œç”¨Canvas::save()å’ŒCanvas::restoreToCount()æ¥ç”Ÿæˆä¸´æ—¶çš„ç”»å¸ƒçŠ¶æ€ã€‚å†æ¥ä¸‹æ¥å°±æ˜¯é€šè¿‡drawRenderNode()å°†DecorViewçš„RenderNodeä»¥RenderNodeOpçš„å½¢å¼è®°å½•åˆ°RootRenderNodeã€‚</p><p><strong>DisplayListæ„å»ºå®ä¾‹ï¼š</strong><br><a href="https://www.jianshu.com/p/7bf306c09c7e" target="_blank" rel="noopener">Android DisplayList æ„å»ºè¿‡ç¨‹</a><br><strong>activity_main.xml</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">é“¾æ¥ï¼šhttps://www.jianshu.com/p/7bf306c09c7e</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;</span><br><span class="line">    android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/sample_text&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;60dp&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:textSize=&quot;20sp&quot;</span><br><span class="line">        android:text=&quot;Hello World!&quot; /&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;cc.bobby.debugapp.MyView</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;100dp&quot; /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-05-activity_main.xml.png" alt="Alt text | center"></p><p><strong>udpateRootDisplayList()</strong></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-06-updateRootDisplayList.jpg" alt="Alt text | center"></p><p><strong>çˆ¶Viewä¸å­Viewçš„DisplayList</strong></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-07-rootview-childview-displaylist.png" alt="Alt text | center"></p><h4 id="ï¼ˆå››ï¼‰ã€RenderNodeç»˜åˆ¶"><a href="#ï¼ˆå››ï¼‰ã€RenderNodeç»˜åˆ¶" class="headerlink" title="ï¼ˆå››ï¼‰ã€RenderNodeç»˜åˆ¶"></a>ï¼ˆå››ï¼‰ã€RenderNodeç»˜åˆ¶</h4><p>åœ¨ThreadedRendererçš„draw()å‡½æ•°ä¸­æ„å»ºå®ŒDisplayListåï¼Œæ¥ä¸‹æ¥éœ€è¦å‡†å¤‡æ¸²æŸ“äº†ã€‚é¦–å…ˆé€šè¿‡JNIè°ƒç”¨nSyncAndDrawFrame()è°ƒç”¨åˆ°nativeå±‚çš„android_view_ThreadedRenderer_syncAndDrawFrame()ã€‚å…¶ä¸­å°†å‚æ•°ä¸­çš„FrameInfoæ•°ç»„ä¼ åˆ°RenderProxyçš„mFrameInfoæˆå‘˜ä¸­ã€‚å®ƒæ˜¯Android Må¼€å§‹åŠ å…¥ç”¨æ¥ç»†åŒ–hwuiæ€§èƒ½ç»Ÿè®¡çš„ã€‚åŒæ—¶è°ƒç”¨RenderProxyçš„syncAndDrawFrame()å‡½æ•°ï¼Œå¹¶å°†åˆ›å»ºçš„TreeObserverä½œä¸ºå‚æ•°ã€‚å‡½æ•°syncAndDrawFrame()ä¸­å³è°ƒç”¨DrawFrameTaskï¼ˆè¿™æ˜¯RenderThreadçš„TaskQueueä¸­çš„ç‰¹æ®ŠTaskå®ä¾‹ï¼‰çš„drawFrame()å‡½æ•°ã€‚ç»§è€Œé€šè¿‡postAndWait()å¾€RenderThreadçš„TaskQueueé‡Œæ’å…¥è‡ªèº«ï¼ˆå³DrawFrameTaskï¼‰æ¥ç”³è¯·æ–°ä¸€å¸§çš„æ¸²æŸ“ã€‚åœ¨RenderThreadçš„queue()å‡½æ•°ä¸­ä¼šæŒ‰Taskçš„è¿è¡Œæ—¶é—´å°†ä¹‹æ’å…¥åˆ°é€‚å½“çš„ä½ç½®ã€‚æ¥ç€postAndWait()å‡½æ•°ä¸­ä¼šblock UIçº¿ç¨‹ç­‰å¾…æ¸²æŸ“çº¿ç¨‹å°†ä¹‹unblockã€‚æ¸²æŸ“çº¿ç¨‹åœ¨Nä¸­çš„æ”¹åŠ¨ä¸å¤§ï¼Œè¿™é‡Œå°±ä¸èŠ±å¤ªå¤šæ–‡å­—ä»‹ç»äº†ï¼Œéœ€è¦çš„æ—¶å€™æŠŠå®ƒå½“ä½œè·¨çº¿ç¨‹è°ƒç”¨å³å¯ã€‚</p><p>å¦ä¸€è¾¹ï¼Œæ¸²æŸ“çº¿ç¨‹å¤„ç†è¿™ä¸ªDrawFrameTaskæ—¶ä¼šè°ƒç”¨åˆ°å…¶run()å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\DrawFrameTask.cpp]</span><br><span class="line"><span class="keyword">void</span> DrawFrameTask::run() &#123;</span><br><span class="line">    ATRACE_NAME(<span class="string">"DrawFrame"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> canUnblockUiThread;</span><br><span class="line">    <span class="keyword">bool</span> canDrawThisFrame;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">TreeInfo <span class="title">info</span><span class="params">(TreeInfo::MODE_FULL, *mContext)</span></span>;</span><br><span class="line">        info.observer = mObserver;</span><br><span class="line">        canUnblockUiThread = syncFrameState(info);</span><br><span class="line">        canDrawThisFrame = info.out.canDrawThisFrame;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grab a copy of everything we need</span></span><br><span class="line">    CanvasContext* context = mContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// From this point on anything in "this" is *UNSAFE TO ACCESS*</span></span><br><span class="line">    <span class="keyword">if</span> (canUnblockUiThread) &#123;</span><br><span class="line">        unblockUiThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CC_LIKELY(canDrawThisFrame)) &#123;</span><br><span class="line">        context-&gt;draw();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// wait on fences so tasks don't overlap next frame</span></span><br><span class="line">        context-&gt;waitOnFences();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!canUnblockUiThread) &#123;</span><br><span class="line">        unblockUiThread();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­é¦–å…ˆé€šè¿‡DrawFrameTask::syncFrameState()å‡½æ•°å°†ä¸»çº¿ç¨‹çš„æ¸²æŸ“ä¿¡æ¯ï¼ˆå¦‚DisplayListï¼ŒPropertyå’ŒBitmapç­‰ï¼‰åŒæ­¥åˆ°æ¸²æŸ“çº¿ç¨‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syncFrameState()</span><br><span class="line">  -&gt; eglMakeCurrent </span><br><span class="line">    -&gt; eglMakeCurrent(OEM EGL) </span><br><span class="line">      -&gt; <span class="keyword">egl_window_surface_v2_t</span>::connect()</span><br><span class="line">      -&gt; Surface::hook_dequeueBuffer() </span><br><span class="line">        -&gt; Surface::dequeueBuffer() </span><br><span class="line">            -&gt; BpGraphicBufferProducer::dequeueBuffer()</span><br><span class="line">            -&gt; BpGraphicBufferProducer::requestBuffer()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸­é¦–å…ˆä¼šå¤„ç†DrawFrameTaskä¸­çš„mLayersã€‚å®ƒæ˜¯DeferredLayerUpdaterçš„vectorï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å»¶è¿Ÿå¤„ç†çš„layeræ›´æ–°ä»»åŠ¡ã€‚è¿™ä¸»è¦ç”¨äºTextureViewã€‚TextureViewæ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ç±»ã€‚å®ƒé€šå¸¸ç”¨äºæ˜¾ç¤ºå†…å®¹æµï¼Œç”Ÿäº§è€…ç«¯å¯ä»¥æ˜¯å¦ä¸€ä¸ªè¿›ç¨‹ã€‚ä¸­é—´é€šè¿‡BufferQueueè¿›è¡Œbufferçš„ä¼ è¾“å’Œäº¤æ¢ã€‚å½“æœ‰æ–°çš„bufferæ¥åˆ°ï¼ˆæˆ–è€…æœ‰å±æ€§å˜åŒ–ï¼Œå¦‚visibilityç­‰ï¼‰æ˜¯ï¼Œä¼šé€šè¿‡å›è°ƒè®¾ç½®æ ‡å¿—ä½(mUpdateLayer)å¹¶é€šè¿‡invalidate()è°ƒåº¦ä¸‹ä¸€æ¬¡é‡ç»˜ã€‚å½“ä¸‹ä¸€æ¬¡draw()è¢«è°ƒç”¨æ—¶ï¼Œå…ˆé€šè¿‡applyUpdate()-&gt;updateSurfaceTexture()-&gt;ThreadedRenderer::pushLayerUpdate()ï¼Œå†è°ƒåˆ°æ¸²æŸ“çº¿ç¨‹ä¸­çš„ DrawFrameTask::pushLayerUpdate()ï¼Œå°†æœ¬æ¬¡æ›´æ–°è®°å½•åœ¨DrawFrameTaskçš„mLayersä¸­ã€‚è¿™æ ·ï¼Œåœ¨åé¢è°ƒç”¨DrawFrameTask::syncFrameState()æ˜¯ä¼šä¾æ¬¡è°ƒç”¨mLayersä¸­çš„apply()è¿›è¡ŒçœŸæ­£çš„æ›´æ–°ã€‚è¿™é‡Œè°ƒç”¨å®ƒçš„apply()å‡½æ•°å°±ä¼šå–æ–°å¯ç”¨bufferï¼ˆé€šè¿‡doUpdateTexImage()å‡½æ•°ï¼‰ï¼Œå¹¶å°†ç›¸å…³çº¹ç†ä¿¡æ¯æ›´æ–°åˆ°mLayerã€‚åœ¨syncFrameState()å‡½æ•°ä¸­ï¼Œæ¥ä¸‹æ¥ï¼Œé€šè¿‡CanvasContextçš„prepareTree()ç»§è€Œè°ƒç”¨RenderNodeçš„prepareTree()åŒæ­¥æ¸²æŸ“ä¿¡æ¯ã€‚æœ€åä¼šè¾“å‡ºTreeInfoç»“æ„ï¼Œå…¶ä¸­çš„prepareTexturesä»£è¡¨çº¹ç†ä¸Šä¼ æ˜¯å¦æˆåŠŸã€‚å¦‚æœä¸ºfalseï¼Œè¯´æ˜texture cacheç”¨å®Œäº†ã€‚è¿™æ ·ä¸ºäº†é˜²æ­¢æ¸²æŸ“çº¿ç¨‹åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ä½¿ç”¨çš„èµ„æºå’Œä¸»çº¿ç¨‹ç«äº‰ï¼Œåœ¨æ¸²æŸ“çº¿ç¨‹ç»˜åˆ¶å½“å‰å¸§æ—¶å°±ä¸èƒ½è®©ä¸»çº¿ç¨‹ç»§ç»­å¾€ä¸‹è·‘äº†ï¼Œä¹Ÿå°±ä¸èƒ½åšåˆ°çœŸæ­£å¹¶è¡Œã€‚åœ¨syncå®Œæ•°æ®åï¼ŒDrawFrameTask::run()æœ€åä¼šè°ƒç”¨CanvasContext::draw()æ¥è¿›è¡Œæ¥ä¸‹æ¥çš„æ¸²æŸ“ã€‚è¿™éƒ¨åˆ†çš„å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-08-ThreadRender-draw.png" alt="Alt text | center"></p><p>æ¥ä¸‹æ¥ç„ä¸‹CanvasContext::draw()é‡Œåšäº†ä»€ä¹ˆã€‚å…ˆè¦å°å°å‡†å¤‡ä¸‹EGLç¯å¢ƒï¼Œæ¯”å¦‚é€šè¿‡EglManagerçš„beginFrame()å‡½æ•°ï¼Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">beginFrame()</span><br><span class="line">  -&gt; eglMakeCurrent </span><br><span class="line">    -&gt; eglMakeCurrent(OEM EGL) </span><br><span class="line">      -&gt; Surface::hook_dequeueBuffer() </span><br><span class="line">        -&gt; Surface::dequeueBuffer() </span><br><span class="line">            -&gt; BpGraphicBufferProducer::dequeueBuffer()</span><br><span class="line">            -&gt; BpGraphicBufferProducer::requestBuffer()</span><br><span class="line"></span><br><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line">Frame EglManager::beginFrame(EGLSurface surface) &#123;</span><br><span class="line">    .....</span><br><span class="line">    makeCurrent(surface);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">bool</span> EglManager::makeCurrent(EGLSurface surface, EGLint* errOut) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!eglMakeCurrent(mEglDisplay, surface, surface, mEglContext)) &#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglMakeCurrent</span><span class="params">(  EGLDisplay dpy, EGLSurface draw,</span></span></span><br><span class="line"><span class="function"><span class="params">                            EGLSurface read, EGLContext ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx == EGL_NO_CONTEXT) &#123;</span><br><span class="line">        <span class="comment">// if we're detaching, we need the current context</span></span><br><span class="line">        current_ctx = (EGLContext)getGlThreadSpecific();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">egl_surface_t</span>* d = (<span class="keyword">egl_surface_t</span>*)draw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (d) &#123;</span><br><span class="line">        <span class="keyword">if</span> (d-&gt;connect() == EGL_FALSE) &#123;</span><br><span class="line">            <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setError(EGL_BAD_ACCESS, EGL_FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EGLBoolean <span class="keyword">egl_window_surface_v2_t</span>::connect()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dequeue a buffer</span></span><br><span class="line">    <span class="keyword">int</span> fenceFd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (nativeWindow-&gt;dequeueBuffer(nativeWindow, &amp;buffer,</span><br><span class="line">            &amp;fenceFd) != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_ALLOC, EGL_FALSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for the buffer</span></span><br><span class="line">    sp&lt;Fence&gt; fence(<span class="keyword">new</span> Fence(fenceFd));</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;wait(Fence::TIMEOUT_NEVER) != NO_ERROR) &#123;</span><br><span class="line">        nativeWindow-&gt;cancelBuffer(nativeWindow, buffer, fenceFd);</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_ALLOC, EGL_FALSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§è€Œç”¨eglMakeCurrent()å°†æ¸²æŸ“contextåˆ‡æ¢åˆ°ç›¸åº”çš„surfaceã€‚ç„¶åEglManagerçš„damageFrame()è®¾å®šå½“å‰å¸§çš„è„åŒºåŸŸï¼ˆå¦‚æœgfxå¹³å°æ”¯æŒå±€éƒ¨æ›´æ–°çš„è¯ï¼‰ã€‚æ¥ä¸‹æ¥å°±æ˜¯ç»˜åˆ¶çš„ä¸»ä½“éƒ¨åˆ†äº†ã€‚è¿™ä¹Ÿæ˜¯Nä¸­æ”¹åŠ¨æ¯”è¾ƒå¤§çš„éƒ¨åˆ†ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\renderthread\CanvasContext.cpp]</span><br><span class="line"><span class="keyword">void</span> CanvasContext::draw() &#123;</span><br><span class="line">    SkRect dirty;</span><br><span class="line">    mDamageAccumulator.finish(&amp;dirty);</span><br><span class="line"></span><br><span class="line">    mCurrentFrameInfo-&gt;markIssueDrawCommandsStart();</span><br><span class="line"></span><br><span class="line">    Frame frame = mEglManager.beginFrame(mEglSurface);</span><br><span class="line">    ......</span><br><span class="line">    <span class="function">SkRect <span class="title">screenDirty</span><span class="params">(dirty)</span></span>;</span><br><span class="line">    ......</span><br><span class="line">    mEglManager.damageFrame(frame, dirty);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HWUI_NEW_OPS</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; caches = Caches::getInstance();</span><br><span class="line">    FrameBuilder frameBuilder(dirty, frame.width(), frame.height(), mLightGeometry, caches);</span><br><span class="line"></span><br><span class="line">    frameBuilder.deferLayers(mLayerUpdateQueue);</span><br><span class="line">    mLayerUpdateQueue.clear();</span><br><span class="line"></span><br><span class="line">    frameBuilder.deferRenderNodeScene(mRenderNodes, mContentDrawBounds);</span><br><span class="line"></span><br><span class="line">    BakedOpRenderer renderer(caches, mRenderThread.renderState(),</span><br><span class="line">            mOpaque, mLightInfo);</span><br><span class="line">    frameBuilder.replayBakedOps&lt;BakedOpDispatcher&gt;(renderer);</span><br><span class="line">    profiler().draw(&amp;renderer);</span><br><span class="line">    <span class="keyword">bool</span> drew = renderer.didDraw();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// post frame cleanup</span></span><br><span class="line">    caches.clearGarbage();</span><br><span class="line">    caches.pathCache.trim();</span><br><span class="line">    caches.tessellationCache.trim();</span><br><span class="line">    ......</span><br><span class="line">    mCanvas-&gt;prepareDirty(frame.width(), frame.height(),</span><br><span class="line">            dirty.fLeft, dirty.fTop, dirty.fRight, dirty.fBottom, mOpaque);</span><br><span class="line"></span><br><span class="line">    Rect outBounds;</span><br><span class="line">    <span class="comment">// It there are multiple render nodes, they are laid out as follows:</span></span><br><span class="line">    <span class="comment">// #0 - backdrop (content + caption)</span></span><br><span class="line">    <span class="comment">// #1 - content (positioned at (0,0) and clipped to - its bounds mContentDrawBounds)</span></span><br><span class="line">    <span class="comment">// #2 - additional overlay nodes</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Draw all render nodes. Note that</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> sp&lt;RenderNode&gt;&amp; node : mRenderNodes) &#123;</span><br><span class="line">        <span class="keyword">if</span> (layer == <span class="number">0</span>) &#123; <span class="comment">// Backdrop.</span></span><br><span class="line">            .......</span><br><span class="line">            <span class="comment">// Check if we have to draw something on the left side ...</span></span><br><span class="line">            <span class="keyword">if</span> (targetBounds.left &lt; contentBounds.left) &#123;</span><br><span class="line">                mCanvas-&gt;save(SaveFlags::Clip);</span><br><span class="line">                <span class="keyword">if</span> (mCanvas-&gt;clipRect(targetBounds.left, targetBounds.top,</span><br><span class="line">                                      contentBounds.left, targetBounds.bottom,</span><br><span class="line">                                      SkRegion::kIntersect_Op)) &#123;</span><br><span class="line">                    mCanvas-&gt;drawRenderNode(node.get(), outBounds);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Reduce the target area by the area we have just painted.</span></span><br><span class="line">                targetBounds.left = <span class="built_in">std</span>::min(contentBounds.left, targetBounds.right);</span><br><span class="line">                mCanvas-&gt;restore();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ... or on the right side ...</span></span><br><span class="line">            <span class="comment">// ... or at the top ...</span></span><br><span class="line">            <span class="comment">// ... or at the bottom.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (layer == <span class="number">1</span>) &#123; <span class="comment">// Content</span></span><br><span class="line">            <span class="comment">// It gets cropped against the bounds of the backdrop to stay inside.</span></span><br><span class="line">            mCanvas-&gt;save(SaveFlags::MatrixClip);</span><br><span class="line">            ......</span><br><span class="line">            mCanvas-&gt;translate(dx, dy);</span><br><span class="line">            <span class="keyword">if</span> (mCanvas-&gt;clipRect(left, top, left + width, top + height, SkRegion::kIntersect_Op)) &#123;</span><br><span class="line">                mCanvas-&gt;drawRenderNode(node.get(), outBounds);</span><br><span class="line">            &#125;</span><br><span class="line">            mCanvas-&gt;restore();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// draw the rest on top at will!</span></span><br><span class="line">            mCanvas-&gt;drawRenderNode(node.get(), outBounds);</span><br><span class="line">        &#125;</span><br><span class="line">        layer++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    profiler().draw(mCanvas);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> drew = mCanvas-&gt;finish();</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>å…ˆå¾—åˆ°Cachesçš„å®ä¾‹ã€‚å®ƒæ˜¯ä¸€ä¸ªå•ä¾‹ç±»ï¼ŒåŒ…å«äº†å„ç§ç»˜åˆ¶èµ„æºçš„cacheã€‚ç„¶ååˆ›å»ºFrameBuilderã€‚è¯¥ç±»ç”¨äºå½“å‰å¸§çš„æ„å»ºã€‚FrameBuilderçš„æ„é€ å‡½æ•°ä¸­åˆä¼šåˆ›å»ºå¯¹åº”fbo0çš„LayerBuilderã€‚fbo0å³å¯¹åº”é€šè¿‡SurfaceFlingerç”³è¯·æ¥çš„on-screen surfaceï¼Œç„¶åå°†ä¹‹æ”¾å…¥layer stackï¼ˆé€šè¿‡mLayerBuilderså’ŒmLayerStackä¸¤ä¸ªæˆå‘˜ç»´æŠ¤ï¼‰ã€‚åŒæ—¶è¿˜ä¼šåœ¨initializeSaveStack()å‡½æ•°ä¸­åˆ›å»ºå’Œåˆå§‹åŒ–Snapshotã€‚å°±åƒåå­—ä¸€æ ·ï¼Œå®ƒä¿å­˜äº†æ¸²æŸ“surfaceçš„å½“å‰çŠ¶æ€çš„ä¸€ä¸ªâ€œå¿«ç…§â€ã€‚æ¯ä¸ªSnapshotæœ‰ä¸€ä¸ªæŒ‡å‘å‰ç»§çš„Snapshotï¼Œä»è€Œå½¢æˆä¸€ä¸ªâ€æ ˆâ€ã€‚æ¯æ¬¡è°ƒç”¨save()å’Œrestore()å°±ç›¸å½“äºå‹æ ˆå’Œå¼¹æ ˆã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-09-frameBuilder.deferLayers.png" alt="Alt text | center"></p><p>æ¥ä¸‹æ¥deferLayers()å‡½æ•°å¤„ç†LayerUpdateQueueä¸­çš„å…ƒç´ ã€‚ä¹‹å‰åœ¨æ¸²æŸ“çº¿ç¨‹æ¯ç”»ä¸€å¸§å‰åŒæ­¥ä¿¡æ¯æ—¶è°ƒç”¨RenderNode::prepareTree()ä¼šéå†DisplayListçš„æ ‘å½¢ç»“æ„ï¼Œå¯¹äºå­èŠ‚ç‚¹é€’å½’è°ƒç”¨prepareTreeImpl()ï¼Œå¦‚æœæ˜¯render layerï¼Œåœ¨RenderNode::pushLayerUpdate()ä¸­ä¼šå°†è¯¥layerçš„æ›´æ–°æ“ä½œè®°å½•åˆ°LayerUpdateQueueä¸­ã€‚è‡³äºå“ªäº›èŠ‚ç‚¹æ˜¯render layerã€‚ä¸»è¦æ˜¯æ ¹æ®ä¹‹å‰æåˆ°çš„viewç±»å‹ï¼ˆLAYER_TYPE_NONE/SOFTWARE/HARDWAREï¼‰ã€‚ä½†ä¼šæœ‰ä¸€ä¸ªä¼˜åŒ–ï¼Œå¦‚æœä¸€ä¸ªæ™®é€šviewæ»¡è¶³promotedToLayer()å®šä¹‰çš„æ¡ä»¶ï¼Œå®ƒä¼šè¢«å½“åšrender layerå¤„ç†ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\FrameBuilder.cpp]</span><br><span class="line"><span class="keyword">void</span> FrameBuilder::deferLayers(<span class="keyword">const</span> LayerUpdateQueue&amp; layers) &#123;</span><br><span class="line">    <span class="comment">// Render all layers to be updated, in order. Defer in reverse order, so that they'll be</span></span><br><span class="line">    <span class="comment">// updated in the order they're passed in (mLayerBuilders are issued to Renderer in reverse)</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = layers.entries().size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        RenderNode* layerNode = layers.entries()[i].renderNode;</span><br><span class="line">        <span class="comment">// only schedule repaint if node still on layer - possible it may have been</span></span><br><span class="line">        <span class="comment">// removed during a dropped frame, but layers may still remain scheduled so</span></span><br><span class="line">        <span class="comment">// as not to lose info on what portion is damaged</span></span><br><span class="line">        OffscreenBuffer* layer = layerNode-&gt;getLayer();</span><br><span class="line">        <span class="keyword">if</span> (CC_LIKELY(layer)) &#123;</span><br><span class="line">            ATRACE_FORMAT(<span class="string">"Optimize HW Layer DisplayList %s %ux%u"</span>,</span><br><span class="line">                    layerNode-&gt;getName(), layerNode-&gt;getWidth(), layerNode-&gt;getHeight());</span><br><span class="line"></span><br><span class="line">            Rect layerDamage = layers.entries()[i].damage;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> ensure layer damage can't be larger than layer</span></span><br><span class="line">            layerDamage.doIntersect(<span class="number">0</span>, <span class="number">0</span>, layer-&gt;viewportWidth, layer-&gt;viewportHeight);</span><br><span class="line">            layerNode-&gt;computeOrdering();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// map current light center into RenderNode's coordinate space</span></span><br><span class="line">            Vector3 lightCenter = mCanvasState.currentSnapshot()-&gt;getRelativeLightCenter();</span><br><span class="line">            layer-&gt;inverseTransformInWindow.mapPoint3d(lightCenter);</span><br><span class="line"></span><br><span class="line">            saveForLayer(layerNode-&gt;getWidth(), layerNode-&gt;getHeight(), <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                    layerDamage, lightCenter, <span class="literal">nullptr</span>, layerNode);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (layerNode-&gt;getDisplayList()) &#123;</span><br><span class="line">                deferNodeOps(*layerNode);</span><br><span class="line">            &#125;</span><br><span class="line">            restoreForLayer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°deferLayers()å‡½æ•°ã€‚è¿™é‡Œå°±æ˜¯æŠŠLayerUpdateQueueé‡Œçš„å…ƒç´ æŒ‰é€†åºæ‹¿å‡ºæ¥ï¼Œä¾æ¬¡è°ƒç”¨saveForLayer()ï¼ŒdeferNodeOps()å’ŒrestoreForLayer()ã€‚saveForLayer()ä¸ºè¯¥render layeåˆ›å»ºSnapshotå’ŒLayerBuilderå¹¶æ”¾è¿›mLayerStackå’ŒmLayerBuildersã€‚è€ŒrestoreForLayer()åˆ™æ˜¯å®ƒçš„é€†æ“ä½œã€‚Layer stackå’Œcanvas stateæ˜¯æ ˆçš„ç»“æ„ã€‚saveForLayer() å’ŒrestoreForLayer()å°±ç›¸å½“äºä¸€ä¸ªpush stackï¼Œä¸€ä¸ªpop stackã€‚è¿™é‡Œæ ¸å¿ƒçš„deferNodeOps()å‡½æ•°å¤„ç†è¯¥layerå¯¹åº”çš„DisplayListï¼Œå°†å®ƒä»¬æŒ‰ä»¥ä¸‹ç±»å‹ä»¥batchçš„å½¢å¼ç»„ç»‡å­˜æ”¾åœ¨LayerBuilderçš„mBatchesæˆå‘˜ä¸­ã€‚å…¶ä¸­åŒä¸€ç±»å‹ä¸­èƒ½åˆå¹¶çš„æ“ä½œè¿˜ä¼šè¿›è¡Œåˆå¹¶ï¼ˆç›®å‰åªæ”¯æŒBitmap, Textå’ŒPatchä¸‰ç§ç±»å‹çš„æ“ä½œåˆå¹¶ï¼‰ã€‚Batchçš„ç±»å‹æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\LayerBuilder.h]</span><br><span class="line"><span class="keyword">namespace</span> OpBatchType &#123;</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        Bitmap,</span><br><span class="line">        MergedPatch,</span><br><span class="line">        AlphaVertices,</span><br><span class="line">        Vertices,</span><br><span class="line">        AlphaMaskTexture,</span><br><span class="line">        Text,</span><br><span class="line">        ColorText,</span><br><span class="line">        Shadow,</span><br><span class="line">        TextureLayer,</span><br><span class="line">        Functor,</span><br><span class="line">        CopyToLayer,</span><br><span class="line">        CopyFromLayer,</span><br><span class="line"></span><br><span class="line">        Count <span class="comment">// must be last</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹deferNodeOps()å‡½æ•°é‡Œæ˜¯æ€ä¹ˆå¤„ç†RenderNodeçš„ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\FrameBuilder.cpp]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Used to define a list of lambdas referencing private FrameBuilder::onXX::defer() methods.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This allows opIds embedded in the RecordedOps to be used for dispatching to these lambdas.</span></span><br><span class="line"><span class="comment"> * E.g. a BitmapOp op then would be dispatched to FrameBuilder::onBitmapOp(const BitmapOp&amp;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OP_RECEIVER(Type) \</span></span><br><span class="line">        [](FrameBuilder&amp; frameBuilder, <span class="keyword">const</span> RecordedOp&amp; op) &#123; frameBuilder.defer##Type(<span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> Type&amp;&gt;(op)); &#125;,</span><br><span class="line"><span class="keyword">void</span> FrameBuilder::deferNodeOps(<span class="keyword">const</span> RenderNode&amp; renderNode) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*OpDispatcher)</span> <span class="params">(FrameBuilder&amp; frameBuilder, <span class="keyword">const</span> RecordedOp&amp; op)</span></span>;</span><br><span class="line">    <span class="keyword">static</span> OpDispatcher receivers[] = BUILD_DEFERRABLE_OP_LUT(OP_RECEIVER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// can't be null, since DL=null node rejection happens before deferNodePropsAndOps</span></span><br><span class="line">    <span class="keyword">const</span> DisplayList&amp; displayList = *(renderNode.getDisplayList());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; chunk : displayList.getChunks()) &#123;</span><br><span class="line">        FatVector&lt;ZRenderNodeOpPair, <span class="number">16</span>&gt; zTranslatedNodes;</span><br><span class="line">        buildZSortedChildList(&amp;zTranslatedNodes, displayList, chunk);</span><br><span class="line"></span><br><span class="line">        defer3dChildren(chunk.reorderClip, ChildrenSelectMode::Negative, zTranslatedNodes);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> opIndex = chunk.beginOpIndex; opIndex &lt; chunk.endOpIndex; opIndex++) &#123;</span><br><span class="line">            <span class="keyword">const</span> RecordedOp* op = displayList.getOps()[opIndex];</span><br><span class="line">            receivers[op-&gt;opId](*<span class="keyword">this</span>, *op);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (CC_UNLIKELY(!renderNode.mProjectedNodes.empty()</span><br><span class="line">                    &amp;&amp; displayList.projectionReceiveIndex &gt;= <span class="number">0</span></span><br><span class="line">                    &amp;&amp; <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(opIndex) == displayList.projectionReceiveIndex)) &#123;</span><br><span class="line">                deferProjectedChildren(renderNode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        defer3dChildren(chunk.reorderClip, ChildrenSelectMode::Positive, zTranslatedNodes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DisplayListä»¥chunkä¸ºå•ä½ç»„åˆRecordedOpã€‚è¿™äº›RecordedOpçš„opIdä»£è¡¨å®ƒä»¬çš„ç±»å‹ã€‚æ ¹æ®è¿™ä¸ªç±»å‹è°ƒç”¨receiversè¿™ä¸ªæŸ¥æ‰¾è¡¨ï¼ˆé€šè¿‡BUILD_DEFERABLE_OP_LUTæ„é€ ï¼‰ä¸­çš„å‡½æ•°ã€‚å®ƒä¼šè°ƒç”¨FrameBuilderä¸­ç›¸åº”çš„deferXXXå‡½æ•°ï¼ˆæ¯”å¦‚deferArcOp, deferBitmapOp, deferRenderNodeOpç­‰ï¼‰ã€‚è¿™äº›deferXXXç³»å‡½æ•°ä¸€èˆ¬ä¼šå°†RecordedOpç”¨BakedOpStateå°è£…ä¸€ä¸‹ï¼Œç„¶åä¼šè°ƒç”¨LayerBuilderçš„deferUnmergeableOp()å’ŒdeferMergeableOp()å‡½æ•°å°†BakedOpStateç»„ç»‡è¿›mBatchesæˆå‘˜ã€‚åŒæ—¶è¿˜æœ‰ä¸¤ä¸ªæŸ¥æ‰¾è¡¨mBatchLookupå’ŒmMergingBatchLookupåˆ†åˆ«ç”¨äºä¸èƒ½åˆå¹¶çš„batchï¼ˆOpBatchï¼‰å’Œèƒ½åˆå¹¶çš„batchï¼ˆMergingOpBatchï¼‰ã€‚å®ƒä»¬åˆ†åˆ«ç”¨äºæŸ¥æ‰¾ç‰¹å®šç±»å‹çš„æœ€è¿‘ä¸€ä¸ªOpBatchæˆ–è€…MergingOpBatchã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-10-DisplayList-chunk.png" alt="Alt text | center"></p><p>å…ˆçœ‹ä¸‹deferUnmergeableOp()å‡½æ•°ã€‚å®ƒä¼šå°†BakedOpStateæŒ‰batchç±»å‹æ”¾è¿›mBatchesä¸­ã€‚mBatchesæ˜¯æŒ‡å‘BatchBaseå¯¹è±¡çš„vectorï¼Œæ¯ä¸ªå¤„ç†å¥½çš„BakedOpStateéƒ½ä¼šæŒ‰ç±»å‹æ”¾è¿›æ¥ã€‚å¦‚æœè¿˜æœªæœ‰è¯¥ç±»å‹çš„batchåˆ™åˆ›å»ºOpBatchï¼Œå¹¶æŠŠå®ƒæ’å…¥åˆ°mBatchesçš„æœ«å°¾ã€‚åŒæ—¶æ’å…¥mBatchLookupè¿™ä¸ªæŸ¥æ‰¾è¡¨ï¼ˆbatchIdåˆ°æœ€è¿‘ä¸€ä¸ªè¯¥ç±»å‹çš„OpBatchå¯¹è±¡çš„æ˜ å°„ï¼‰ã€‚è¿™æ ·ä¹‹åå¤„ç†åŒç±»å‹çš„BakedOpStateæ—¶å€™ï¼Œå°±ä¼šå…ˆæœç´¢è¿™ä¸ªæŸ¥æ‰¾è¡¨ã€‚å‡å¦‚æ‰¾åˆ°äº†ï¼Œåˆ™è¿›ä¸€æ­¥åœ¨mBatchesæ•°ç»„ä¸­æ‰¾åˆ°ç›¸åº”çš„OpBatchå¹¶é€šè¿‡å®ƒçš„batchOp()å°†è¯¥BakedOpStateåŠ å…¥ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\LayerBuilder.cpp]</span><br><span class="line"><span class="keyword">void</span> LayerBuilder::deferUnmergeableOp(LinearAllocator&amp; allocator,</span><br><span class="line">        BakedOpState* op, <span class="keyword">batchid_t</span> batchId) &#123;</span><br><span class="line">    onDeferOp(allocator, op);</span><br><span class="line">    OpBatch* targetBatch = mBatchLookup[batchId];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> insertBatchIndex = mBatches.size();</span><br><span class="line">    <span class="keyword">if</span> (targetBatch) &#123;</span><br><span class="line">        locateInsertIndex(batchId, op-&gt;computedState.clippedBounds,</span><br><span class="line">                (BatchBase**)(&amp;targetBatch), &amp;insertBatchIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetBatch) &#123;</span><br><span class="line">        targetBatch-&gt;batchOp(op);</span><br><span class="line">    &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">        <span class="comment">// new non-merging batch</span></span><br><span class="line">        targetBatch = allocator.create&lt;OpBatch&gt;(batchId, op);</span><br><span class="line">        mBatchLookup[batchId] = targetBatch;</span><br><span class="line">        mBatches.insert(mBatches.begin() + insertBatchIndex, targetBatch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹ç”¨äºåˆå¹¶æ“ä½œçš„deferMergeableOp()å‡½æ•°ã€‚å®ƒä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå½“æ²¡æœ‰å¯ä»¥åˆå¹¶çš„MergingOpBatchæ—¶ä¼šåˆ›å»ºæ–°çš„ï¼Œå¹¶ä¸”æ’å…¥åˆ°mBatchesã€‚å› ä¸ºå¯èƒ½å­˜åœ¨æƒ…å†µè¿™ä¸ªbatchIdåœ¨mBatchesä¸­æœ‰ä½†æ˜¯mMergingBatchLookupä¸­æ²¡æ‰¾åˆ°ï¼ˆè¯´æ˜è¿˜æ²¡æœ‰å¯åˆå¹¶çš„MergingOpBatchå¯¹è±¡ï¼‰æˆ–è€…é€šè¿‡MergingOpBatch::canMergeWidth()åˆ¤æ–­ä¸æ»¡è¶³åˆå¹¶æ¡ä»¶ã€‚è¿™æ—¶å€™å°±è¦æ’å…¥åˆ°mBatchesä¸­è¯¥ç±»å‹æ‰€åœ¨ä½ç½®ã€‚å¦‚æœå¾ˆé¡ºåˆ©çš„æƒ…å†µä¸‹ï¼Œå‰é¢å·²ç»æœ‰MergingOpBatchåœ¨mMergingBatchLookupä¸­è€Œä¸”åˆæ»¡è¶³åˆå¹¶æ¡ä»¶ï¼Œå°±é€šè¿‡MergingOpBatch::mergeOp()å°†è¯¥BakedOpStateå’Œå·²æœ‰çš„è¿›è¡Œåˆå¹¶ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\LayerBuilder.cpp]</span><br><span class="line"><span class="keyword">void</span> LayerBuilder::deferMergeableOp(LinearAllocator&amp; allocator,</span><br><span class="line">        BakedOpState* op, <span class="keyword">batchid_t</span> batchId, <span class="keyword">mergeid_t</span> mergeId) &#123;</span><br><span class="line">    onDeferOp(allocator, op);</span><br><span class="line">    MergingOpBatch* targetBatch = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to merge with any existing batch with same mergeId</span></span><br><span class="line">    <span class="keyword">auto</span> getResult = mMergingBatchLookup[batchId].find(mergeId);</span><br><span class="line">    <span class="keyword">if</span> (getResult != mMergingBatchLookup[batchId].end()) &#123;</span><br><span class="line">        targetBatch = getResult-&gt;second;</span><br><span class="line">        <span class="keyword">if</span> (!targetBatch-&gt;canMergeWith(op)) &#123;</span><br><span class="line">            targetBatch = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> insertBatchIndex = mBatches.size();</span><br><span class="line">    locateInsertIndex(batchId, op-&gt;computedState.clippedBounds,</span><br><span class="line">            (BatchBase**)(&amp;targetBatch), &amp;insertBatchIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetBatch) &#123;</span><br><span class="line">        targetBatch-&gt;mergeOp(op);</span><br><span class="line">    &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">        <span class="comment">// new merging batch</span></span><br><span class="line">        targetBatch = allocator.create&lt;MergingOpBatch&gt;(batchId, op);</span><br><span class="line">        mMergingBatchLookup[batchId].insert(<span class="built_in">std</span>::make_pair(mergeId, targetBatch));</span><br><span class="line"></span><br><span class="line">        mBatches.insert(mBatches.begin() + insertBatchIndex, targetBatch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å›åˆ°CanvasContext::draw()å‡½æ•°ï¼Œå¤„ç†å¥½layeråï¼Œä¸‹é¢å¾—å°±æ˜¯é€šè¿‡FrameBuilder::deferRenderNodeScene()å‡½æ•°å¤„ç†FrameBuilderæˆå‘˜mRenderNodesä¸­çš„RenderNodeï¼Œå…¶ä¸­åŒ…å«äº†RootRenderNodeï¼ˆä¹Ÿå¯èƒ½æœ‰å…¶å®ƒçš„RenderNodeï¼Œæ¯”å¦‚backdropå’Œoverlay nodesï¼‰ã€‚å¯¹äºæ¯ä¸ªRenderNodeï¼Œå¦‚æœéœ€è¦ç»˜åˆ¶åˆ™è°ƒç”¨FrameBuilderçš„deferRenderNode()å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\FrameBuilder.cpp]</span><br><span class="line"><span class="keyword">void</span> FrameBuilder::deferRenderNode(RenderNode&amp; renderNode) &#123;</span><br><span class="line">    renderNode.computeOrdering();</span><br><span class="line"></span><br><span class="line">    mCanvasState.save(SaveFlags::MatrixClip);</span><br><span class="line">    deferNodePropsAndOps(renderNode);</span><br><span class="line">    mCanvasState.restore();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå’Œå‰é¢ç±»ä¼¼ï¼Œä¼šä¸ºä¹‹åˆ›å»ºç‹¬ç«‹çš„Snapshotï¼ˆCanvasæ¸²æŸ“çŠ¶æ€ï¼‰ï¼ŒdeferNodePropsAndOps()æ ¹æ®RenderNodeä¸­çš„RenderPropertiesé€šè¿‡CanvasStateè®¾ç½®ä¸€å †çŠ¶æ€ã€‚å¦‚æœè¯¥RenderNodeå¯¹åº”æ˜¯ä¸€ä¸ªrender layerï¼Œåˆ™å°†å®ƒå°è£…ä¸ºLayerOpï¼ˆç»˜åˆ¶offscreen bufferï¼‰å¹¶é€šè¿‡deferUnmergeableOp()åŠ å…¥batchã€‚å¦‚æœè¯¥RenderNodeå¯¹åº”RenderPropertiesæœ‰åŠé€æ˜æ•ˆæœä¸”ä¸æ˜¯render layerï¼Œåˆ™å¯ä»¥å°†è¯¥RenderNodeç»˜åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶çš„layerï¼ˆç§°ä¸ºsave layerï¼‰ã€‚è¿™æ˜¯é€šè¿‡BeginLayerOpå’ŒEndLayerOpæ¥è®°å½•çš„ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯é€šè¿‡deferNodeOps()æ¥å°†RenderNodeè¿›è¡Œbatch/mergeã€‚è¿™ä¸ªå‡½æ•°å‰é¢å·²æœ‰è¯´æ˜ã€‚</p><p>å†æ¬¡å›åˆ°CanvasContext::draw()å‡½æ•°ï¼Œä¸‹é¢ç»ˆäºè¦çœŸå¾—è¿›è¡Œæ¸²æŸ“äº†ã€‚é¦–å…ˆåˆ›å»ºBakedOpRendererï¼Œç„¶åè°ƒç”¨FrameBuilder::replayBakedOps()å‡½æ•°å¹¶å°†BakedOpRendererä½œä¸ºå‚æ•°ä¼ è¿›å»ã€‚æ³¨æ„è¿™æ˜¯ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œè¿™é‡Œæ¨¡æ¿å‚æ•°ä¸ºBakedOpDispatcherã€‚åœ¨replayBakedOps()å‡½æ•°ä¸­ä¼šæ„é€ ä¸¤ä¸ªç”¨äºå¤„ç†BakedOpStateçš„å‡½æ•°æŸ¥æ‰¾è¡¨ã€‚å®ƒä»¬å°†BakedOpStateæŒ‰æ“ä½œç±»å‹åˆ†å‘åˆ°BakedOpDispatcherçš„ç›¸åº”é™æ€å¤„ç†å‡½æ•°ï¼ˆonXXXæˆ–è€…onMergedXXXï¼Œåˆ†åˆ«ç”¨äºéåˆå¹¶å’Œåˆå¹¶çš„æ“ä½œï¼‰ ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\FrameBuilder.h]</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> StaticDispatcher, <span class="keyword">typename</span> Renderer&gt;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">replayBakedOps</span><span class="params">(Renderer&amp; renderer)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;OffscreenBuffer*&gt; temporaryLayers;</span><br><span class="line">        finishDefer();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Defines a LUT of lambdas which allow a recorded BakedOpState to use state-&gt;op-&gt;opId to</span></span><br><span class="line"><span class="comment">         * dispatch the op via a method on a static dispatcher when the op is replayed.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For example a BitmapOp would resolve, via the lambda lookup, to calling:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * StaticDispatcher::onBitmapOp(Renderer&amp; renderer, const BitmapOp&amp; op, const BakedOpState&amp; state);</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> X(Type) \</span></span><br><span class="line">                [](<span class="keyword">void</span>* renderer, <span class="keyword">const</span> BakedOpState&amp; state) &#123; \</span><br><span class="line">                    StaticDispatcher::on##Type(*(<span class="keyword">static_cast</span>&lt;Renderer*&gt;(renderer)), \</span><br><span class="line">                            <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> Type&amp;&gt;(*(state.op)), state); \</span><br><span class="line">                &#125;,</span><br><span class="line">        <span class="keyword">static</span> BakedOpReceiver unmergedReceivers[] = BUILD_RENDERABLE_OP_LUT(X);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">undef</span> X</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Defines a LUT of lambdas which allow merged arrays of BakedOpState* to be passed to a</span></span><br><span class="line"><span class="comment">         * static dispatcher when the group of merged ops is replayed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> X(Type) \</span></span><br><span class="line">                [](<span class="keyword">void</span>* renderer, <span class="keyword">const</span> MergedBakedOpList&amp; opList) &#123; \</span><br><span class="line">                    StaticDispatcher::onMerged##Type#<span class="meta">#s(*(static_cast<span class="meta-string">&lt;Renderer*&gt;(renderer)), opList); \</span></span></span><br><span class="line">                &#125;,</span><br><span class="line">        <span class="keyword">static</span> MergedOpReceiver mergedReceivers[] = BUILD_MERGEABLE_OP_LUT(X);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">undef</span> X</span></span><br></pre></td></tr></table></figure><p> å¦‚å‰é¢å¦‚è¿°ï¼Œä¹‹å‰å·²ç»åœ¨FrameBuilderä¸­æ„é€ äº†LayerBuilderçš„stackã€‚æ¥ä¸‹æ¥ï¼Œè¿™å„¿å°±æ˜¯æŒ‰pushæ—¶çš„é€†åºï¼ˆz-orderé«˜åˆ°åº•ï¼‰å¯¹å…¶ä¸­çš„BakedOpStateè¿›è¡Œreplayï¼Œå› ä¸ºä¸‹é¢çš„layerå¯èƒ½ä¼šä¾èµ–çš„ä¸Šé¢layerçš„æ¸²æŸ“ç»“æœã€‚æ¯”å¦‚è¦æŠŠä¸Šé¢layerç”»åœ¨FBOä¸Šçš„ä¸œè¥¿å½“æˆçº¹ç†ç”»åˆ°ä¸‹ä¸€å±‚layerä¸Šã€‚å¯¹äºlayerï¼ˆpersistentæˆ–è€…temporaryçš„ï¼‰ï¼Œå…ˆåœ¨BakedOpRenderer::startRepaintLayer()ä¸­åˆå§‹åŒ–ç›¸å…³GLç¯å¢ƒï¼Œæ¯”å¦‚åˆ›å»ºFBOï¼Œç»‘å®šlayerå¯¹åº”OffscreenBufferä¸­çš„çº¹ç†ï¼Œè®¾ç½®viewportï¼Œæ¸…color bufferç­‰ç­‰ã€‚å¯¹åº”åœ°ï¼ŒBakedOpRenderer::endLayer()ä¸­æœ€ç›¸åº”çš„é”€æ¯å’Œæ¸…ç†å·¥ä½œã€‚ä¸­é—´è°ƒç”¨LayerBuilder::replayBakedOpsImpl()å‡½æ•°åšçœŸæ­£çš„replayåŠ¨ä½œã€‚å¯¹äºfbo0ï¼ˆå³on-screen surfaceï¼‰ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯æŠŠstartRepaintLayer()å’ŒendLayer()æ¢æˆBakedOpRenderer::startFrame()å’ŒBakedOpRenderer::endFrame()ã€‚å®ƒä»¬çš„åŠŸèƒ½ä¹Ÿæ˜¯åˆå§‹åŒ–å’Œé”€æ¯GLç¯å¢ƒã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\libs\hwui\FrameBuilder.h]</span><br><span class="line">template &lt;typename StaticDispatcher, typename Renderer&gt;</span><br><span class="line">    void replayBakedOps(Renderer&amp; renderer) &#123;</span><br><span class="line">        .....</span><br><span class="line">       // Relay through layers in reverse order, since layers</span><br><span class="line">        // later in the list will be drawn by earlier ones</span><br><span class="line">        for (int i = mLayerBuilders.size() - 1; i &gt;= 1; i--) &#123;</span><br><span class="line">            GL_CHECKPOINT(MODERATE);</span><br><span class="line">            LayerBuilder&amp; layer = *(mLayerBuilders[i]);</span><br><span class="line">            if (layer.renderNode) &#123;</span><br><span class="line">                // cached HW layer - can&apos;t skip layer if empty</span><br><span class="line">                renderer.startRepaintLayer(layer.offscreenBuffer, layer.repaintRect);</span><br><span class="line">                GL_CHECKPOINT(MODERATE);</span><br><span class="line">                layer.replayBakedOpsImpl((void*)&amp;renderer, unmergedReceivers, mergedReceivers);</span><br><span class="line">                GL_CHECKPOINT(MODERATE);</span><br><span class="line">                renderer.endLayer();</span><br><span class="line">            &#125; else if (!layer.empty()) &#123;</span><br><span class="line">                // save layer - skip entire layer if empty (in which case, LayerOp has null layer).</span><br><span class="line">                layer.offscreenBuffer = renderer.startTemporaryLayer(layer.width, layer.height);</span><br><span class="line">                temporaryLayers.push_back(layer.offscreenBuffer);</span><br><span class="line">                GL_CHECKPOINT(MODERATE);</span><br><span class="line">                layer.replayBakedOpsImpl((void*)&amp;renderer, unmergedReceivers, mergedReceivers);</span><br><span class="line">                GL_CHECKPOINT(MODERATE);</span><br><span class="line">                renderer.endLayer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        GL_CHECKPOINT(MODERATE);</span><br><span class="line">        if (CC_LIKELY(mDrawFbo0)) &#123;</span><br><span class="line">            const LayerBuilder&amp; fbo0 = *(mLayerBuilders[0]);</span><br><span class="line">            renderer.startFrame(fbo0.width, fbo0.height, fbo0.repaintRect);</span><br><span class="line">            GL_CHECKPOINT(MODERATE);</span><br><span class="line">            fbo0.replayBakedOpsImpl((void*)&amp;renderer, unmergedReceivers, mergedReceivers);</span><br><span class="line">            GL_CHECKPOINT(MODERATE);</span><br><span class="line">            renderer.endFrame(fbo0.repaintRect);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (auto&amp; temporaryLayer : temporaryLayers) &#123;</span><br><span class="line">            renderer.recycleTemporaryLayer(temporaryLayer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨replayBakedOpsImpl()å‡½æ•°ä¸­ï¼Œä¼šæ ¹æ®æ“ä½œçš„ç±»å‹è°ƒç”¨å‰é¢ç”Ÿæˆçš„unmergedReceiverså’ŒmergedReceiversä¸¤ä¸ªå‡½æ•°åˆ†å‘è¡¨ä¸­çš„å¯¹åº”å¤„ç†å‡½æ•°ã€‚å®ƒä»¬å®è´¨æŒ‡å‘BakedOpDispatcherä¸­çš„é™æ€å‡½æ•°ã€‚è¿™äº›å‡½æ•°onXXXOp()å’ŒonMergedXXXOps()å‡½æ•°å¤§åŒå°å¼‚ï¼ŒåŸºæœ¬éƒ½æ˜¯é€šè¿‡GlopBuilderå°†BakedOpStateå’Œç›¸å…³çš„ä¿¡æ¯å°è£…æˆGlopå¯¹è±¡ï¼Œç„¶åè°ƒç”¨BakedOpRenderer::renderGlop()ï¼Œæ¥ç€é€šè¿‡DefaultGlopReceiver()è°ƒç”¨BakedOpRenderer::renderGlopImpl()å‡½æ•°ï¼Œæœ€ååœ¨RenderState::render()ä¸­é€šè¿‡GLå‘½ä»¤å°†Glopæ¸²æŸ“å‡ºæ¥ã€‚å¤§åŠŸå‘Šæˆã€‚</p><p><strong>ç»“è¯­</strong><br>åˆå¹¶ä¹‹åï¼ŒDeferredDisplayList Vector<batch *=""> mBatches åŒ…å«å…¨éƒ¨æ•´åˆåçš„ç»˜åˆ¶å‘½ä»¤ï¼Œä¹‹åæ¸²æŸ“å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„åˆå¹¶å¹¶ä¸æ˜¯å¤šä¸ªå˜ä¸€ä¸ªï¼Œåªæ˜¯åšäº†ä¸€ä¸ªé›†åˆï¼Œä¸»è¦æ˜¯æ–¹ä¾¿ä½¿ç”¨å„èµ„æºçº¹ç†ç­‰ï¼Œæ¯”å¦‚ç»˜åˆ¶æ–‡å­—çš„æ—¶å€™ï¼Œéœ€è¦æ ¹æ®æ–‡å­—çš„çº¹ç†è¿›è¡Œæ¸²æŸ“ï¼Œè€Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æŸ¥è¯¢æ–‡å­—çš„çº¹ç†åæ ‡ç³»ï¼Œåˆå¹¶åˆ°ä¸€èµ·æ–¹ä¾¿ç»Ÿä¸€å¤„ç†ï¼Œä¸€æ¬¡æ¸²æŸ“ï¼Œå‡å°‘èµ„æºåŠ è½½çš„æµªè´¹ï¼Œå½“ç„¶å¯¹äºç†è§£ç¡¬ä»¶åŠ é€Ÿçš„æ•´ä½“æµç¨‹ï¼Œè¿™ä¸ªåˆå¹¶æ“ä½œå¯ä»¥å®Œå…¨æ— è§†ï¼Œç”šè‡³å¯ä»¥ç›´è§‚è®¤ä¸ºï¼Œæ„å»ºå®Œä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥æ¸²æŸ“ï¼Œå®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯åœ¨å¦ä¸€ä¸ªRenderçº¿ç¨‹ä½¿ç”¨OpenGLè¿›è¡Œç»˜åˆ¶ï¼Œè¿™ä¸ªæ˜¯å®ƒæœ€é‡è¦çš„ç‰¹ç‚¹ã€‚è€ŒmBatchesä¸­æ‰€æœ‰çš„DrawOpéƒ½ä¼šé€šè¿‡OpenGLè¢«ç»˜åˆ¶åˆ°GraphicBufferä¸­ï¼Œæœ€åé€šè¿‡swapBufferså‡½æ•°è°ƒç”¨queueBuffer()é€šçŸ¥SurfaceFlingeråˆæˆã€‚</batch></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line">EGLBoolean egl_window_surface_v2_t::swapBuffers()</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">nativeWindow-&gt;queueBuffer(nativeWindow, buffer); </span><br><span class="line">nativeWindow-&gt;dequeueBuffer(nativeWindow, &amp;buffer);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»çš„æ¥è¯´ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªViewä¸Šçš„ä¸œè¥¿è¦ç»˜åˆ¶å‡ºæ¥ï¼Œè¦ç»è¿‡å¤šæ­¥çš„è½¬åŒ–ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-11-View-draw-Surface.png" alt="Alt text | center"></p><p>è¿™æ ·åšæœ‰å‡ ä¸ªå¥½å¤„ï¼šç¬¬ä¸€ã€å¯¹ç»˜åˆ¶æ“ä½œè¿›è¡Œbatch/mergeå¯ä»¥å‡å°‘GLçš„draw callï¼Œä»è€Œå‡å°‘æ¸²æŸ“çŠ¶æ€åˆ‡æ¢ï¼Œæé«˜äº†æ€§èƒ½ã€‚ç¬¬äºŒã€å› ä¸ºå°†Viewå±‚æ¬¡ç»“æ„è¦ç»˜åˆ¶çš„ä¸œè¥¿è½¬åŒ–ä¸ºDisplayListè¿™ç§â€œä¸­é—´è¯­è¨€â€çš„å½¢å¼ï¼Œå½“éœ€è¦ç»˜åˆ¶æ—¶æ‰è½¬åŒ–ä¸ºGLå‘½ä»¤ã€‚å› æ­¤åœ¨Viewä¸­å†…å®¹æ²¡æœ‰æ›´æ”¹æˆ–åªæœ‰éƒ¨åˆ†å±æ€§æ›´æ”¹æ—¶åªè¦ä¿®æ”¹ä¸­é—´è¡¨ç¤ºï¼ˆå³RenderNodeå’ŒRenderPropertiesï¼‰å³å¯ï¼Œä»è€Œé¿å…å¾ˆå¤šé‡å¤åŠ³åŠ¨ã€‚ç¬¬ä¸‰ã€ç”±äºDisplayListä¸­åŒ…å«äº†è¦ç»˜åˆ¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¸€äº›å±æ€§åŠ¨ç”»å¯ä»¥ç”±æ¸²æŸ“çº¿ç¨‹å…¨æƒå¤„ç†ï¼Œæ— éœ€ä¸»çº¿ç¨‹ä»‹å…¥ï¼Œä¸»çº¿ç¨‹å¡ä½ä¹Ÿä¸ä¼šè®©ç•Œé¢å¡ä½ã€‚å¦ä¸€æ–¹é¢ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€äº›æ½œåŠ›å¯æŒ–ã€‚æ¯”å¦‚å½“å‰å¯ä»¥åˆå¹¶çš„æ“ä½œç±»å‹æœ‰é™ã€‚å¦å¤–ä¸»çº¿ç¨‹å’Œæ¸²æŸ“çº¿ç¨‹é—´çš„å¾ˆå¤šè°ƒç”¨è¿˜æ˜¯åŒæ­¥çš„ï¼Œå¹¶è¡Œåº¦æˆ–è®¸å¯ä»¥è¿›ä¸€æ­¥æé«˜ã€‚å¦å¤–Vulkançš„å¼•å…¥ä¹Ÿå¯ä»¥å¸®åŠ©è¿›ä¸€æ­¥æ¦¨å¹²GPUçš„èƒ½åŠ›ã€‚<br><strong>ä¾‹å¦‚ï¼š</strong></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-12-one_button_draw.png" alt="Alt text | center"></p><p>ç»˜åˆ¶çš„æ‰¹æ¬¡æŒ‰æ–‡æœ¬ã€å›¾ç‰‡èµ„æºã€å‡ ä½•å›¾å½¢ç­‰è¿›è¡Œåˆ†ç±»ï¼Œåˆ†æ‰¹ç»˜åˆ¶çš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-03-13-BakedOpDispatcher-onMergedBitmapOps.gif" alt="Alt text | center"></p><h4 id="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://blog.csdn.net/jinzhuojun/article/details/54234354" target="_blank" rel="noopener">Android Nä¸­UIç¡¬ä»¶æ¸²æŸ“ï¼ˆhwuiï¼‰çš„HWUI_NEW_OPS(åŸºäºAndroid 7.1) </a><br><a href="https://blog.csdn.net/luoshengyang/article/details/45601143" target="_blank" rel="noopener">Androidåº”ç”¨ç¨‹åºUIç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“æŠ€æœ¯ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/54234354" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Nä¸­UIç¡¬ä»¶æ¸²æŸ“ï¼ˆhwuiï¼‰çš„HWUI_NEW_OPS(åŸºäºAndroid 7.1)ã€‘</a><br><a href="https://www.jianshu.com/p/7bf306c09c7e" target="_blank" rel="noopener">Android DisplayList æ„å»ºè¿‡ç¨‹</a><br><a href="http://www.androidperformance.com/2015/08/12/AndroidL-hwui-RenderThread-workflow/" target="_blank" rel="noopener">Android5.0ä¸­ hwui ä¸­ RenderThread å·¥ä½œæµç¨‹</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL &amp;&amp; OpenGL</title>
    <link href="http://zhoujinjian.cc/2018/07/20/Android%20Display%20System%EF%BC%882%EF%BC%89%EF%BC%9AAndroid%20Display%20System%20%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B9%8BAndroid%20EGL%20&amp;&amp;%20OpenGL/"/>
    <id>http://zhoujinjian.cc/2018/07/20/Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL &amp;&amp; OpenGL/</id>
    <published>2018-07-19T16:00:00.000Z</published>
    <updated>2018-06-20T15:11:14.394Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/display.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p><a href="http://www.kandroid.org/board/data/board/conference/file_in_body/1/3AndroidGraphicsAndAndroidEGL.pdf" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Graphics and Android EGLã€‘</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/17427491" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android 4.4 (KitKat) Design Pattern-Graphics Subsystemã€‘</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/17293325" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android 4.4 (KitKat) in virtualization VSync signalã€‘</a><br><a href="https://blog.csdn.net/yangwen123/article/details/22647255" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Androidæ˜¾ç¤ºç³»ç»Ÿè®¾è®¡æ¡†æ¶ä»‹ç»ã€‘</a><br><a href="http://www.cnblogs.com/samchen2009/p/3367496.html" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - å›¾è§£Android - Android GUI ç³»ç»Ÿ (2) - çª—å£ç®¡ç† (View, Canvas, Window Manager)ã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><p> ğŸŒ€ğŸŒ€ï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶</p><p>ã€Android Display System ç³»ç»Ÿåˆ†æç³»åˆ—ã€‘ï¼š<br>ã€Android Display Systemï¼ˆ1ï¼‰ï¼šAndroid 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL &amp;&amp; OpenGLã€‘<br>ã€Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc &amp;&amp; HWComposeræ¨¡å—åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architectureã€‘</p><hr><blockquote><p><strong>Android EGLã€GLES_CMã€GLES2ï¼š</strong></p></blockquote><p>\frameworks\native\opengl\libs\EGL</p><ul><li>egl.cpp</li><li>egl_display.cpp</li><li>eglApi.cpp</li><li>Loader.cpp</li></ul><p>\frameworks\native\opengl\libs\GLES_CM</p><ul><li>gl.cpp</li><li>gl_api.in</li><li>glext_api.in</li></ul><p>\frameworks\native\opengl\libs\GLES2</p><ul><li>gl2.cpp</li><li>gl2_api.in</li><li>gl2ext_api.in</li></ul><blockquote><p><strong>OpenGL Native &amp;&amp; JNI ï¼š</strong></p></blockquote><p>\frameworks\base\core\jni\</p><ul><li>android_opengl_GLES10.cpp</li><li>android_opengl_GLES10Ext.cpp</li><li>android_opengl_GLES11.cpp</li><li>android_opengl_GLES11Ext.cpp</li><li>android_opengl_GLES20.cpp</li><li>android_opengl_GLES30.cpp</li><li>android_opengl_GLES31.cpp</li><li>android_opengl_GLES31Ext.cpp</li><li>android_opengl_GLES32.cpp</li><li>com_google_android_gles_jni_EGLImpl.cpp</li><li>com_google_android_gles_jni_GLImpl.cpp</li></ul><blockquote><p><strong>Opengl Javaï¼š</strong></p></blockquote><p>\frameworks\base\opengl\java\android\opengl</p><ul><li>GLES10.java</li><li>GLES10Ext.java</li><li>GLLogWrapper.java</li><li>GLSurfaceView.java</li><li>EGLDisplay.java</li><li>EGLConfig.java</li><li>EGLContext.java</li><li>EGLSurface.java</li></ul><p>\frameworks\base\opengl\java\javax\microedition\khronos\opengles</p><ul><li>GL10.java</li><li>GL11.java</li></ul><p>\frameworks\base\opengl\java\com\google\android\gles_jni</p><ul><li>GLImpl.java</li><li>EGLImpl.java</li><li>EGLConfigImpl.java</li><li>EGLContextImpl.java</li><li>EGLDisplayImpl.java</li></ul><hr><p>æ€»ä½“æ¶æ„ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-01-Android-Graphics-Architecture-EGL.png" alt="Alt text | center"></p><p><a href="http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/">ã€Android Display Systemï¼ˆ1ï¼‰- Android Graphics ç³»ç»Ÿ åˆ†æã€‘</a></p><p>####ï¼ˆä¸€ï¼‰ã€ Android EGL åº”ç”¨å®ä¾‹</p><h5 id="1-1ã€Android-Graphics-æµ‹è¯•ç¨‹åº"><a href="#1-1ã€Android-Graphics-æµ‹è¯•ç¨‹åº" class="headerlink" title="1.1ã€Android Graphics æµ‹è¯•ç¨‹åº"></a>1.1ã€Android Graphics æµ‹è¯•ç¨‹åº</h5><p>é¦–å…ˆçœ‹ä¸€ä¸‹Androidæµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒ\frameworks\native\services\surfaceflinger\tests\Transaction_test.cpp</span><br><span class="line">æ‹·è´åŒç›®å½•ä¸‹.mkæ–‡ä»¶pushåˆ°æ‰‹æœºè¿è¡Œå³å¯çœ‹åˆ°æ•ˆæœã€‚</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gtest/gtest.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/native_window.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/IMemory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gui/ISurfaceComposer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gui/Surface.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gui/SurfaceComposerClient.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;private/gui/ComposerService.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;private/gui/LayerState.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/String8.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ui/DisplayInfo.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fill an RGBA_8888 formatted surface with a single color.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fillSurfaceRGBA8</span><span class="params">(<span class="keyword">const</span> sp&lt;SurfaceControl&gt;&amp; sc,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint8_t</span> r, <span class="keyword">uint8_t</span> g, <span class="keyword">uint8_t</span> b)</span> </span>&#123;</span><br><span class="line">    ANativeWindow_Buffer outBuffer;</span><br><span class="line">    sp&lt;Surface&gt; s = sc-&gt;getSurface();</span><br><span class="line">    ASSERT_TRUE(s != <span class="literal">NULL</span>);</span><br><span class="line">    ASSERT_EQ(NO_ERROR, s-&gt;lock(&amp;outBuffer, <span class="literal">NULL</span>));</span><br><span class="line">    <span class="keyword">uint8_t</span>* img = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(outBuffer.bits);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; outBuffer.height; y++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; outBuffer.width; x++) &#123;</span><br><span class="line">            <span class="keyword">uint8_t</span>* pixel = img + (<span class="number">4</span> * (y*outBuffer.stride + x));</span><br><span class="line">            pixel[<span class="number">0</span>] = r;</span><br><span class="line">            pixel[<span class="number">1</span>] = g;</span><br><span class="line">            pixel[<span class="number">2</span>] = b;</span><br><span class="line">            pixel[<span class="number">3</span>] = <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ASSERT_EQ(NO_ERROR, s-&gt;unlockAndPost());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LayerTest</span> :</span> <span class="keyword">public</span> ::testing::Test &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mComposerClient = <span class="keyword">new</span> SurfaceComposerClient;</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mComposerClient-&gt;initCheck());</span><br><span class="line"></span><br><span class="line">        sp&lt;IBinder&gt; display(SurfaceComposerClient::getBuiltInDisplay(</span><br><span class="line">                ISurfaceComposer::eDisplayIdMain));</span><br><span class="line">        DisplayInfo info;</span><br><span class="line">        SurfaceComposerClient::getDisplayInfo(display, &amp;info);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">ssize_t</span> displayWidth = info.w;</span><br><span class="line">        <span class="keyword">ssize_t</span> displayHeight = info.h;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Background surface black</span></span><br><span class="line">        mBGSurfaceControl = mComposerClient-&gt;createSurface(</span><br><span class="line">                String8(<span class="string">"BG Test Surface"</span>), displayWidth, displayHeight<span class="number">-720</span>,</span><br><span class="line">                PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line">        ASSERT_TRUE(mBGSurfaceControl != <span class="literal">NULL</span>);</span><br><span class="line">        ASSERT_TRUE(mBGSurfaceControl-&gt;isValid());</span><br><span class="line">        fillSurfaceRGBA8(mBGSurfaceControl, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Foreground surface red</span></span><br><span class="line">        mFGSurfaceControl = mComposerClient-&gt;createSurface(</span><br><span class="line">                String8(<span class="string">"FG Test Surface"</span>), <span class="number">360</span>, <span class="number">360</span>, PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line">        ASSERT_TRUE(mFGSurfaceControl != <span class="literal">NULL</span>);</span><br><span class="line">        ASSERT_TRUE(mFGSurfaceControl-&gt;isValid());</span><br><span class="line"></span><br><span class="line">        fillSurfaceRGBA8(mFGSurfaceControl, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Foreground surface blue</span></span><br><span class="line">        mFGSurfaceControlBlue = mComposerClient-&gt;createSurface(</span><br><span class="line">                String8(<span class="string">"FG Test Surface"</span>), <span class="number">360</span>, <span class="number">360</span>, PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line">        ASSERT_TRUE(mFGSurfaceControlBlue != <span class="literal">NULL</span>);</span><br><span class="line">        ASSERT_TRUE(mFGSurfaceControlBlue-&gt;isValid());</span><br><span class="line"></span><br><span class="line">        fillSurfaceRGBA8(mFGSurfaceControl, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Foreground surface green</span></span><br><span class="line">        mFGSurfaceControlGreen = mComposerClient-&gt;createSurface(</span><br><span class="line">                String8(<span class="string">"FG Test Surface"</span>), <span class="number">360</span>, <span class="number">360</span>, PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line">        ASSERT_TRUE(mFGSurfaceControlGreen != <span class="literal">NULL</span>);</span><br><span class="line">        ASSERT_TRUE(mFGSurfaceControlGreen-&gt;isValid());</span><br><span class="line"></span><br><span class="line">        fillSurfaceRGBA8(mFGSurfaceControl, <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Synchronization surface</span></span><br><span class="line">        mSyncSurfaceControl = mComposerClient-&gt;createSurface(</span><br><span class="line">                String8(<span class="string">"Sync Test Surface"</span>), <span class="number">1</span>, <span class="number">1</span>, PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line">        ASSERT_TRUE(mSyncSurfaceControl != <span class="literal">NULL</span>);</span><br><span class="line">        ASSERT_TRUE(mSyncSurfaceControl-&gt;isValid());</span><br><span class="line"></span><br><span class="line">        fillSurfaceRGBA8(mSyncSurfaceControl, <span class="number">31</span>, <span class="number">31</span>, <span class="number">31</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SurfaceComposerClient::openGlobalTransaction()</span></span><br><span class="line"></span><br><span class="line">        SurfaceComposerClient::openGlobalTransaction();</span><br><span class="line"></span><br><span class="line">        mComposerClient-&gt;setDisplayLayerStack(display, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//black</span></span><br><span class="line">        ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-4</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;show());</span><br><span class="line">        <span class="comment">//red</span></span><br><span class="line">        ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-3</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setPosition(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;show());</span><br><span class="line"><span class="comment">//blue</span></span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControlBlue-&gt;setLayer(INT_MAX<span class="number">-2</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mFGSurfaceControlBlue-&gt;setPosition(<span class="number">360</span>, <span class="number">360</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mFGSurfaceControlBlue-&gt;show());</span><br><span class="line"><span class="comment">//green</span></span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControlGreen-&gt;setLayer(INT_MAX<span class="number">-1</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mFGSurfaceControlGreen-&gt;setPosition(<span class="number">720</span>, <span class="number">720</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mFGSurfaceControlGreen-&gt;show());</span><br><span class="line"></span><br><span class="line">        ASSERT_EQ(NO_ERROR, mSyncSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-1</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mSyncSurfaceControl-&gt;setPosition(displayWidth<span class="number">-2</span>,</span><br><span class="line">                displayHeight<span class="number">-2</span>));</span><br><span class="line">        ASSERT_EQ(NO_ERROR, mSyncSurfaceControl-&gt;show());</span><br><span class="line"></span><br><span class="line">        SurfaceComposerClient::closeGlobalTransaction(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">waitForPostedBuffers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">TearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mComposerClient-&gt;dispose();</span><br><span class="line">        mBGSurfaceControl = <span class="number">0</span>;</span><br><span class="line">        mFGSurfaceControl = <span class="number">0</span>;</span><br><span class="line">        mSyncSurfaceControl = <span class="number">0</span>;</span><br><span class="line">        mComposerClient = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">waitForPostedBuffers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Since the sync surface is in synchronous mode (i.e. double buffered)</span></span><br><span class="line">        <span class="comment">// posting three buffers to it should ensure that at least two</span></span><br><span class="line">        <span class="comment">// SurfaceFlinger::handlePageFlip calls have been made, which should</span></span><br><span class="line">        <span class="comment">// guaranteed that a buffer posted to another Surface has been retired.</span></span><br><span class="line">        fillSurfaceRGBA8(mFGSurfaceControl, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        fillSurfaceRGBA8(mFGSurfaceControlBlue, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>);</span><br><span class="line">        fillSurfaceRGBA8(mFGSurfaceControlGreen, <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">    fillSurfaceRGBA8(mSyncSurfaceControl, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;SurfaceComposerClient&gt; mComposerClient;</span><br><span class="line">    sp&lt;SurfaceControl&gt; mBGSurfaceControl;</span><br><span class="line">    sp&lt;SurfaceControl&gt; mFGSurfaceControl;<span class="comment">//red</span></span><br><span class="line">    sp&lt;SurfaceControl&gt; mFGSurfaceControlBlue;</span><br><span class="line">    sp&lt;SurfaceControl&gt; mFGSurfaceControlGreen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This surface is used to ensure that the buffers posted to</span></span><br><span class="line">    <span class="comment">// mFGSurfaceControl have been picked up by SurfaceFlinger.</span></span><br><span class="line">    sp&lt;SurfaceControl&gt; mSyncSurfaceControl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">TEST_F(LayerTest, LayerWorks) &#123;</span><br><span class="line"></span><br><span class="line">    SurfaceComposerClient::openGlobalTransaction();</span><br><span class="line">    ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setPosition(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SurfaceComposerClient::closeGlobalTransaction(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">sp&lt;IBinder&gt; display(SurfaceComposerClient::getBuiltInDisplay(</span><br><span class="line">ISurfaceComposer::eDisplayIdMain));</span><br><span class="line">DisplayInfo info;</span><br><span class="line">SurfaceComposerClient::getDisplayInfo(display, &amp;info);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> displayWidth = info.w;</span><br><span class="line"><span class="keyword">ssize_t</span> displayHeight = info.h;</span><br><span class="line"></span><br><span class="line">SurfaceComposerClient::openGlobalTransaction();</span><br><span class="line"></span><br><span class="line">mComposerClient-&gt;setDisplayLayerStack(display, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-4</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;show());</span><br><span class="line"><span class="comment">//red</span></span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-3</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setPosition(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;show());</span><br><span class="line"><span class="comment">//blue</span></span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControlBlue-&gt;setLayer(INT_MAX<span class="number">-2</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControlBlue-&gt;setPosition(<span class="number">360</span>, <span class="number">360</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControlBlue-&gt;show());</span><br><span class="line"><span class="comment">//green</span></span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControlGreen-&gt;setLayer(INT_MAX<span class="number">-1</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControlGreen-&gt;setPosition(<span class="number">720</span>, <span class="number">720</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mFGSurfaceControlGreen-&gt;show());</span><br><span class="line"><span class="comment">//Sync</span></span><br><span class="line">ASSERT_EQ(NO_ERROR, mSyncSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-1</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mSyncSurfaceControl-&gt;setPosition(displayWidth<span class="number">-2</span>,</span><br><span class="line">displayHeight<span class="number">-2</span>));</span><br><span class="line">ASSERT_EQ(NO_ERROR, mSyncSurfaceControl-&gt;show());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SurfaceComposerClient::closeGlobalTransaction(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°æ•ˆæœï¼ˆä¿æŒè¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°ç•Œé¢æœ€é¡¶å±‚ä¼šç»˜åˆ¶é»‘è‰²èƒŒæ™¯å’Œçº¢ç»¿è“ä¸‰ä¸ªè‰²å—ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-02-Android-graphics-surface-test.gif" alt="Alt text | center"></p><p>å¯ä»¥çœ‹åˆ°æ¯”è¾ƒå…³é”®çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºSurfaceComposerClient</span></span><br><span class="line">mComposerClient = <span class="keyword">new</span> SurfaceComposerClient;</span><br><span class="line">ASSERT_EQ(NO_ERROR, mComposerClient-&gt;initCheck());</span><br><span class="line"><span class="comment">//è·å–displayä¿¡æ¯</span></span><br><span class="line">sp&lt;IBinder&gt; display(SurfaceComposerClient::getBuiltInDisplay(</span><br><span class="line">        ISurfaceComposer::eDisplayIdMain));</span><br><span class="line">DisplayInfo info;</span><br><span class="line">SurfaceComposerClient::getDisplayInfo(display, &amp;info);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> displayWidth = info.w;</span><br><span class="line"><span class="keyword">ssize_t</span> displayHeight = info.h;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Background surface black</span></span><br><span class="line"><span class="comment">//è¯·æ±‚SurfaceFlingeråˆ›å»ºSurface</span></span><br><span class="line">mBGSurfaceControl = mComposerClient-&gt;createSurface(</span><br><span class="line">        String8(<span class="string">"BG Test Surface"</span>), displayWidth, displayHeight<span class="number">-720</span>,</span><br><span class="line">        PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//å¡«å……Surface</span></span><br><span class="line">fillSurfaceRGBA8(mBGSurfaceControl, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//è®¾ç½®Layerå±‚çº§</span></span><br><span class="line">ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-4</span>));</span><br><span class="line"><span class="comment">//SurfaceControl-&gt;show()æ˜¾ç¤ºsurface</span></span><br><span class="line">ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;show());</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†çš„åˆ†æè¯·å‚è€ƒ<a href="http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/">ã€Android Display Systemï¼ˆ1ï¼‰- Android Graphics ç³»ç»Ÿ åˆ†æã€‘</a><br>æˆ‘ä»¬è¿™é‡Œä¸»è¦ä¸ºäº†å¼•å‡ºAndroidåº•å±‚å¦‚ä½•åˆ©ç”¨EGLç»˜å›¾ã€‚</p><h5 id="1-2ã€Android-BootAnimation-å¼€æœºåŠ¨ç”»-EGLåœ¨Androidä¸­åº”ç”¨"><a href="#1-2ã€Android-BootAnimation-å¼€æœºåŠ¨ç”»-EGLåœ¨Androidä¸­åº”ç”¨" class="headerlink" title="1.2ã€Android BootAnimation å¼€æœºåŠ¨ç”»(EGLåœ¨Androidä¸­åº”ç”¨)"></a>1.2ã€Android BootAnimation å¼€æœºåŠ¨ç”»(EGLåœ¨Androidä¸­åº”ç”¨)</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-03-Android-boot-egl.png" alt="Alt text | center"></p><p>å…³é”®ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\cmds\bootanimation\BootAnimation.cpp]</span><br><span class="line"><span class="keyword">status_t</span> BootAnimation::readyToRun() &#123;</span><br><span class="line">    mAssets.addDefaultAssets();</span><br><span class="line">    sp&lt;IBinder&gt; dtoken(SurfaceComposerClient::getBuiltInDisplay(</span><br><span class="line">            ISurfaceComposer::eDisplayIdMain));</span><br><span class="line">    DisplayInfo dinfo;</span><br><span class="line">    <span class="keyword">status_t</span> status = SurfaceComposerClient::getDisplayInfo(dtoken, &amp;dinfo);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// create the native surface</span></span><br><span class="line">    sp&lt;SurfaceControl&gt; control = session()-&gt;createSurface(String8(<span class="string">"BootAnimation"</span>),</span><br><span class="line">            dinfo.w, dinfo.h, PIXEL_FORMAT_RGB_565);</span><br><span class="line"></span><br><span class="line">    SurfaceComposerClient::openGlobalTransaction();</span><br><span class="line">    control-&gt;setLayer(<span class="number">0x40000000</span>);</span><br><span class="line">    SurfaceComposerClient::closeGlobalTransaction();</span><br><span class="line"></span><br><span class="line">    sp&lt;Surface&gt; s = control-&gt;getSurface();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize opengl and egl</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// (1)ã€è·å¾— EGLDisplay å¯¹è±¡ã€‚</span></span><br><span class="line">    EGLDisplay display = eglGetDisplay(EGL_DEFAULT_DISPLAY);</span><br><span class="line">    <span class="comment">// (2)ã€åˆå§‹åŒ– EGLDisplay å¯¹è±¡</span></span><br><span class="line">    eglInitialize(display, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// (3)ã€é€‰æ‹© EGLConfig</span></span><br><span class="line">    eglChooseConfig(display, attribs, &amp;config, <span class="number">1</span>, &amp;numConfigs);</span><br><span class="line">    <span class="comment">// (4)ã€åˆ›å»º Windows Surface</span></span><br><span class="line">    surface = eglCreateWindowSurface(display, config, s.get(), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// (5)ã€åˆ›å»º EGL context</span></span><br><span class="line">    context = eglCreateContext(display, config, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    eglQuerySurface(display, surface, EGL_WIDTH, &amp;w);</span><br><span class="line">    eglQuerySurface(display, surface, EGL_HEIGHT, &amp;h);</span><br><span class="line">    <span class="comment">// (6)ã€å¯ç”¨å‰é¢åˆ›å»ºçš„ EGL context</span></span><br><span class="line">    <span class="keyword">if</span> (eglMakeCurrent(display, surface, surface, context) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">bool</span> BootAnimation::playAnimation(<span class="keyword">const</span> Animation&amp; animation)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">                <span class="comment">// (7)ã€OpenGL ES API ç»˜åˆ¶å›¾å½¢ï¼šgl_*()</span></span><br><span class="line">                glDrawTexiOES(xc, mHeight - (yc + frame.trimHeight),</span><br><span class="line">                              <span class="number">0</span>, frame.trimWidth, frame.trimHeight);</span><br><span class="line">                ......</span><br><span class="line">                <span class="comment">// (8)ã€SwapBuffersæ˜¾ç¤º</span></span><br><span class="line">                eglSwapBuffers(mDisplay, mSurface);</span><br><span class="line">                ......</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨EGLä¸€èˆ¬ä¼šç»å†ä»¥ä¸Šå‡ ä¸ªæ­¥éª¤ã€‚</p><h5 id="1-2ã€Understanding-Android-Graphics-Internals"><a href="#1-2ã€Understanding-Android-Graphics-Internals" class="headerlink" title="1.2ã€Understanding Android Graphics Internals"></a>1.2ã€Understanding Android Graphics Internals</h5><p>è¦æ·±å…¥äº†è§£Android Graphicsæœºåˆ¶ï¼Œéœ€è¦äº†è§£ç†Ÿæ‚‰ä»¥ä¸‹çŸ¥è¯†ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-04-understand-android-graphics-internals.png" alt="Alt text | center"></p><p>####ï¼ˆäºŒï¼‰ã€OpenGL ES 2.0 çŸ¥è¯†ä¸²è®²<br>åœ¨äº†è§£EGLä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹å‰äººæ€»ç»“çš„çŸ¥è¯†<a href="http://geekfaner.com/shineengine/index.html" target="_blank" rel="noopener">OPENGL ES 2.0 çŸ¥è¯†ä¸²è®²</a>ï¼š</p><h5 id="2-1ã€å†™åœ¨å‰é¢çš„è¯"><a href="#2-1ã€å†™åœ¨å‰é¢çš„è¯" class="headerlink" title="2.1ã€å†™åœ¨å‰é¢çš„è¯"></a>2.1ã€å†™åœ¨å‰é¢çš„è¯</h5><h5 id="2-1-1ã€ç”µè„‘æ˜¯åšä»€ä¹ˆç”¨çš„"><a href="#2-1-1ã€ç”µè„‘æ˜¯åšä»€ä¹ˆç”¨çš„" class="headerlink" title="2.1.1ã€ç”µè„‘æ˜¯åšä»€ä¹ˆç”¨çš„?"></a>2.1.1ã€ç”µè„‘æ˜¯åšä»€ä¹ˆç”¨çš„?</h5><p>ç”µè„‘åˆè¢«ç§°ä¸ºè®¡ç®—æœº,é‚£ä¹ˆæœ€é‡è¦çš„å·¥ä½œå°±æ˜¯è®¡ç®—ã€‚çœ‹è¿‡ä¸‰ä½“çš„åŒå­¦éƒ½çŸ¥é“, ç”µè„‘ä¸­æœ‰æ— æ•°çº³ç±³çº§åˆ«çš„è®¡ç®—å•å…ƒ,é€šè¿‡ 0 å’Œ 1 çš„è½¬æ¢,å®ŒæˆåŠ å‡ä¹˜é™¤çš„æ“ä½œã€‚</p><h5 id="2-1-2ã€æ˜¯ä»€ä¹ˆä½¿å¾—ç”µè„‘å·¥ä½œ"><a href="#2-1-2ã€æ˜¯ä»€ä¹ˆä½¿å¾—ç”µè„‘å·¥ä½œ" class="headerlink" title="2.1.2ã€æ˜¯ä»€ä¹ˆä½¿å¾—ç”µè„‘å·¥ä½œ?"></a>2.1.2ã€æ˜¯ä»€ä¹ˆä½¿å¾—ç”µè„‘å·¥ä½œ?</h5><p>é©±åŠ¨,é©±ä½¿ç€ç¡¬ä»¶å®Œæˆå·¥ä½œã€‚</p><h5 id="2-1-3ã€è°æ¥å†™é©±åŠ¨"><a href="#2-1-3ã€è°æ¥å†™é©±åŠ¨" class="headerlink" title="2.1.3ã€è°æ¥å†™é©±åŠ¨?"></a>2.1.3ã€è°æ¥å†™é©±åŠ¨?</h5><p>åˆ¶é€ ç”µè„‘çš„å…¬å¸è‡ªå·±æ¥å†™é©±åŠ¨,å› ä¸ºä»–ä»¬å¯¹è‡ªå·±çš„åº•å±‚ç¡¬ä»¶æ¶æ„æœ€ç†Ÿæ‚‰ã€‚</p><h5 id="2-1-4ã€è°ä¼šä½¿ç”¨é©±åŠ¨"><a href="#2-1-4ã€è°ä¼šä½¿ç”¨é©±åŠ¨" class="headerlink" title="2.1.4ã€è°ä¼šä½¿ç”¨é©±åŠ¨?"></a>2.1.4ã€è°ä¼šä½¿ç”¨é©±åŠ¨?</h5><p>æ‰€æœ‰çš„è½¯ä»¶å·¥ç¨‹å¸ˆéƒ½ä¼šç›´æ¥æˆ–è€…é—´æ¥çš„ä½¿ç”¨åˆ°é©±åŠ¨ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†,å¦‚æœè¯´ä¸åŒçš„ç”µè„‘å…¬å¸,åˆ¶é€ å‡ºæ¥ä¸åŒçš„ç¡¬ä»¶,ä½¿ç”¨ä¸åŒçš„ é©±åŠ¨,æä¾›å‡ºæ¥ä¸åŒçš„æ¥å£ä¾›è½¯ä»¶å·¥ç¨‹å¸ˆè¿›è¡Œä½¿ç”¨,é‚£ä¹ˆè½¯ä»¶å·¥ç¨‹å¸ˆå°±è¦å´©æºƒäº†ã€‚</p><p>æ‰€ä»¥,ä¸€å®šæ˜¯éœ€è¦ä¸€ä¸ªæ ‡å‡†,æ¥ç»Ÿä¸€ä¸€ä¸‹ã€‚</p><h5 id="2-1-5ã€é‚£ä¹ˆåœ¨å“ªé‡Œè¿›è¡Œç»Ÿä¸€"><a href="#2-1-5ã€é‚£ä¹ˆåœ¨å“ªé‡Œè¿›è¡Œç»Ÿä¸€" class="headerlink" title="2.1.5ã€é‚£ä¹ˆåœ¨å“ªé‡Œè¿›è¡Œç»Ÿä¸€?"></a>2.1.5ã€é‚£ä¹ˆåœ¨å“ªé‡Œè¿›è¡Œç»Ÿä¸€?</h5><p>ç¡¬ä»¶æ²¡æœ‰åŠæ³•ç»Ÿä¸€,æ¯ä¸ªç”µè„‘å…¬å¸ä¸ºäº†ä¼˜åŒ–è‡ªå·±ç”µè„‘æ€§èƒ½å’ŒåŠŸè€—,åˆ¶é€ å‡ºæ¥ ä¸åŒçš„ç¡¬ä»¶æ¶æ„,è¿™æ˜¯éœ€è¦æ— æ•°çš„å¿ƒè¡€å®Œæˆçš„,å¦‚æœç»Ÿä¸€äº†,é‚£ä¹ˆå°±ä¸éœ€è¦é‚£ä¹ˆ å¤šç”µè„‘å…¬å¸äº†ã€‚</p><p>æ‰€ä»¥åªèƒ½ç»Ÿä¸€é©±åŠ¨çš„æ¥å£ã€‚</p><p>ç”µè„‘ç»„ä»¶å¤§è‡´åˆ†ä¸º:CPUã€GPUã€å†…å­˜ã€æ€»çº¿ç­‰ã€‚è€Œ OpenGL å°±æ˜¯ GPU é©±åŠ¨ çš„ä¸€å¥—æ ‡å‡†æ¥å£(OpenGL ES ä¸ºåµŒå…¥å¼è®¾å¤‡ GPU é©±åŠ¨çš„æ ‡å‡†æ¥å£,æ¯”å¦‚æ‰‹æœº, OpenGL ES å…¨ç§°:OpenGL for Embedded Systems)ã€‚</p><p>æ‰€ä»¥ç»¼ä¸Šæ‰€è¿°,æˆ‘ä½¿ç”¨äº† 5 ä¸ªé—®é¢˜,å¼•å‡ºäº† OpenGL çš„ç”¨å¤„:å°±æ˜¯å°†å¤æ‚çš„ã€ å„ç§å„æ ·çš„ GPU ç¡¬ä»¶åŒ…è£…èµ·æ¥,å„ä¸ªç”µè„‘å…¬å¸ç¼–å†™è‡ªå®¶çš„é©±åŠ¨,ç„¶åæä¾›å‡ºæ¥ ä¸€å¥—ç»Ÿä¸€çš„æ¥å£,ä¾›ä¸Šå±‚è½¯ä»¶å·¥ç¨‹å¸ˆè°ƒç”¨ã€‚è¿™æ ·,ä¸–ç•Œå°±å’Œå¹³äº†ã€‚</p><h5 id="2-1-6ã€è°è¿™ä¹ˆç‰›-å®šä¹‰äº†-OpenGL-è¿™å¥—æ ‡å‡†"><a href="#2-1-6ã€è°è¿™ä¹ˆç‰›-å®šä¹‰äº†-OpenGL-è¿™å¥—æ ‡å‡†" class="headerlink" title="2.1.6ã€è°è¿™ä¹ˆç‰›,å®šä¹‰äº† OpenGL è¿™å¥—æ ‡å‡†?"></a>2.1.6ã€è°è¿™ä¹ˆç‰›,å®šä¹‰äº† OpenGL è¿™å¥—æ ‡å‡†?</h5><p>Khronosã€‚æ¯å½“æˆ‘æ‰“è¿™å‡ ä¸ªå­—æ¯çš„æ—¶å€™,éƒ½ä¼šæŠ±æœ‰ä¸€ç§æ•¬ç•çš„å¿ƒç†,å› ä¸ºå®ƒ ä¸æ˜¯ä¸€å®¶å…¬å¸,å®ƒæ˜¯ä¸€ä¸ªç»„ç»‡,å®ƒæ˜¯ç”±ä¼—å¤šå¤§å…¬å¸è”åˆç»„å»ºè€Œæ¥,æ¯”å¦‚ Appleã€ Intelã€AMDã€Googleã€ARMã€Qualcommã€Nvidia ç­‰ç­‰ç­‰ç­‰ã€‚å„ä¸ªå¤§å…¬å¸æŠ•å…¥äº†å¤§ é‡çš„äººåŠ›ã€èµ„é‡‘ç­‰åˆ›å»ºäº†è¿™ä¸ªç»„ç»‡ã€‚å¯¹ç”µè„‘ GPU å®šä¹‰äº†ç»Ÿä¸€çš„æ¥å£ OpenGL,å¯¹ æ‰‹æœº GPU å®šä¹‰äº†ç»Ÿä¸€çš„æ¥å£ OpenGL ES(æˆ‘ä¹Ÿéå¸¸æœ‰å¹¸,åœ¨ Intel å·¥ä½œæœŸé—´,è·Ÿ Intel é©» Khronos çš„ 3D è´Ÿè´£äººå…±äº‹äº†ä¸€æ®µæ—¶é—´,æ¯å‘¨ä¸€æ¬¡çš„è·¨æ´‹ç”µè¯,éƒ½ä¼šè®©æˆ‘å—ç›ŠåŒªæµ…)</p><p>è¿™ä¸ªç»„ç»‡é™¤äº†å®šä¹‰äº† OpenGL æ¥å£ä¹‹å¤–,è¿˜å®šä¹‰äº†å¾ˆå¤šå…¶ä»–æ¥å£ã€‚ç›®å‰é’ˆå¯¹ GPU åˆæå‡ºäº†å¦å¤–ä¸€å¥—æ›´åº•å±‚çš„æ¥å£ Vulkan,è¿™æ˜¯ä¸€å¥—æ¯” OpenGL æ›´åº•å±‚çš„æ¥å£, ä½¿ç”¨å…¶å¯ä»¥æ›´å®¹æ˜“ä¼˜åŒ–,ä¸è¿‡ç›®å‰ç¡¬ä»¶å‚å•†çš„é©±åŠ¨è¿˜æœ‰å¾…å¼€å‘,å¯èƒ½æ™®åŠ Vulkan è¿˜éœ€è¦å¾ˆå¤šå¹´ã€‚å°±å¥½æ¯” OpenGL ES å·²ç»å‘å±•åˆ°äº† 3.1,è€Œå¸‚é¢ä¸Šçš„æ‰‹æœºå¾ˆå¤šè¿˜æ˜¯ åªèƒ½æ”¯æŒ OpenGL ES 2.0 ä¸€æ ·ã€‚æ‰€ä»¥æ–°çš„ç§‘æŠ€ä»æå‡º,åˆ°å®ç°,åˆ°é‡äº§,åˆ°ä½¿ç”¨, åˆ°æ™®åŠ,æ˜¯ä¸€æ®µå¾ˆé•¿çš„è·¯ã€‚</p><p>æ‰€ä»¥,æˆ‘ä»¬ç°åœ¨å­¦ä¹  OpenGL ES 2.0 æ˜¯é€‚æ—¶çš„,ä¸”æ˜¯éå¸¸å¿…è¦çš„(ä¸æ‡‚ 2.0, æƒ³ç›´æ¥å­¦ä¹ æ›´éš¾çš„ 3.0ã€3.1ã€Vulkan,å¾ˆéš¾)ã€‚</p><p>äº‹å…ˆé¢„å‘Šä¸€ä¸‹,OpenGL ES 2.0 ä¼šåˆ†åä¸‰ä¸ªè¯¾ç¨‹,ç»“æŸä¹‹å,æˆ‘ä¼šç«‹å³å¥‰ä¸Š OpenGL ES 3.0 åœ¨ OpenGL ES 2.0 åŸºç¡€ä¸Šçš„æ”¹å˜ã€‚</p><h5 id="2-1-7ã€OpenGL-å’Œæˆ‘ä»¬æ¸¸æˆï¼ˆAndroid-ï¼‰å¼€å‘è€…æœ‰ä»€ä¹ˆå…³ç³»"><a href="#2-1-7ã€OpenGL-å’Œæˆ‘ä»¬æ¸¸æˆï¼ˆAndroid-ï¼‰å¼€å‘è€…æœ‰ä»€ä¹ˆå…³ç³»" class="headerlink" title="2.1.7ã€OpenGL å’Œæˆ‘ä»¬æ¸¸æˆï¼ˆAndroid ï¼‰å¼€å‘è€…æœ‰ä»€ä¹ˆå…³ç³»?"></a>2.1.7ã€OpenGL å’Œæˆ‘ä»¬æ¸¸æˆï¼ˆAndroid ï¼‰å¼€å‘è€…æœ‰ä»€ä¹ˆå…³ç³»?</h5><p>ç”µè„‘/æ‰‹æœºå±å¹•ä¸Šæ˜¾ç¤ºçš„ä¸œè¥¿,è¦ä¹ˆæ˜¯ 2D çš„,è¦ä¹ˆæ˜¯ 3D çš„,é‚£ä¹ˆå¦‚æœæ˜¯ 3D çš„,ä¸ç®¡æ˜¯ App ä¹Ÿå¥½,æ¸¸æˆä¹Ÿå¥½,ç®€å•çš„å›¾ç‰‡ç•Œé¢ä¹Ÿå¥½,åº•å±‚éƒ½æ˜¯é€šè¿‡ GPUã€ é€šè¿‡ OpenGL(ES)ç»˜åˆ¶å‡ºæ¥çš„ã€‚</p><p>å¼€å‘ App çš„æ—¶å€™,æ˜¯é€šè¿‡åˆ›å»ºæ§ä»¶çš„æ–¹å¼,è€Œæ§ä»¶å·²ç»å¯¹åº•å±‚è¿›è¡Œäº†ä¸€å±‚å°è£…,æ‰€ä»¥ App å¼€å‘è€…å¾ˆå°‘ä¼šæ¥è§¦åˆ° OpenGL(ES)ã€‚</p><p>æ¸¸æˆçš„å¼€å‘æ˜¯é€šè¿‡æ¸¸æˆå¼•æ“,è€Œæ¸¸æˆå¼•æ“çš„æœ€åº•å±‚,æ˜¯ç›´æ¥è°ƒç”¨äº† OpenGL(ES),ç›´æ¥å¯¹ GPU è¿›è¡Œæ§åˆ¶ã€‚</p><p>æ‰€ä»¥è¯´æ¸¸æˆå¼•æ“å·¥ç¨‹å¸ˆå¿…é¡»æ‡‚ OpenGL(ES),è€Œæ¸¸æˆå¼€å‘è€…,æƒ³è¦æ›´å¥½çš„å¯¹æ¸¸æˆè¿›è¡Œæ›´å¥½çš„ç†è§£å’Œä¼˜åŒ–,ä¹Ÿå»ºè®®å­¦ä¸€äº› OpenGL(ES)ã€‚</p><h5 id="2-1-8ã€DirectX-æ˜¯ä»€ä¹ˆ"><a href="#2-1-8ã€DirectX-æ˜¯ä»€ä¹ˆ" class="headerlink" title="2.1.8ã€DirectX æ˜¯ä»€ä¹ˆ?"></a>2.1.8ã€DirectX æ˜¯ä»€ä¹ˆ?</h5><p>æœ€åä¸€ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å‘ç° Khronos ç»„ç»‡çš„æˆå‘˜ä¸­,æˆ‘æ²¡æœ‰æåˆ°å¤§åé¼é¼çš„å¾® è½¯,å› ä¸ºå¾®è½¯ä¸åœ¨ç»„ç»‡ä¸­,è€Œå®ƒæå‡ºäº†è‡ªå·±çš„ GPU é©±åŠ¨æ ‡å‡†,DirectXã€‚</p><p>æ‰€ä»¥ç›®å‰æ‰‹æœº,ä¸ç®¡æ˜¯ iOS è¿˜æ˜¯ Android,éƒ½æ˜¯æ”¯æŒ OpenGL ESã€‚ç”µè„‘,Windows ç³»ç»Ÿæ”¯æŒ DirectX å’Œ OpenGL,Linux/Mac(Unix)ç³»ç»Ÿæ”¯æŒ OpenGLã€‚</p><h4 id="2-2ã€OpenGL-ES-çš„ä¸¤ä¸ªå°ä¼™ä¼´"><a href="#2-2ã€OpenGL-ES-çš„ä¸¤ä¸ªå°ä¼™ä¼´" class="headerlink" title="2.2ã€OpenGL ES çš„ä¸¤ä¸ªå°ä¼™ä¼´"></a>2.2ã€OpenGL ES çš„ä¸¤ä¸ªå°ä¼™ä¼´</h4><p>è™½ç„¶,æˆ‘ä»¬æ•™ç¨‹çš„æ ‡é¢˜æ˜¯ OpenGL ES,ä½†æ˜¯æˆ‘ä»¬çš„å†…å®¹å°†ä¸ä»…é™äº OpenGL ESã€‚ OpenGL ES æ˜¯è´Ÿè´£ GPU å·¥ä½œçš„,ç›®çš„æ˜¯é€šè¿‡ GPU è®¡ç®—,å¾—åˆ°ä¸€å¼ å›¾ç‰‡,è¿™å¼ å›¾ ç‰‡åœ¨å†…å­˜ä¸­å…¶å®å°±æ˜¯ä¸€å— buffer,å­˜å‚¨æœ‰æ¯ä¸ªç‚¹çš„é¢œè‰²ä¿¡æ¯ç­‰ã€‚è€Œè¿™å¼ å›¾ç‰‡æœ€ç»ˆæ˜¯è¦æ˜¾ç¤ºåˆ°å±å¹•ä¸Š,æ‰€ä»¥è¿˜éœ€è¦å…·ä½“çš„çª—å£ç³»ç»Ÿæ¥æ“ä½œ,OpenGL ES å¹¶æ²¡æœ‰ç›¸å…³çš„å‡½æ•°ã€‚æ‰€ä»¥,OpenGL ES æœ‰ä¸€ä¸ªå¥½æ­æ¡£ EGLã€‚</p><p>EGL,å…¨ç§°:embedded Graphic Interface,æ˜¯ OpenGL ES å’Œåº•å±‚ Native å¹³å° è§†çª—ç³»ç»Ÿä¹‹é—´çš„æ¥å£ã€‚æ‰€ä»¥å¤§æ¦‚æµç¨‹æ˜¯è¿™æ ·çš„:é¦–å…ˆ,é€šè¿‡ EGL è·å–åˆ°æ‰‹æœºå±å¹• çš„ handle,è·å–åˆ°æ‰‹æœºæ”¯æŒçš„é…ç½®(RGBA8888/RGB565 ä¹‹ç±»,è¡¨ç¤ºæ¯ä¸ªåƒç´ ä¸­åŒ… å«çš„é¢œè‰²ç­‰ä¿¡æ¯çš„å­˜å‚¨ç©ºé—´æ˜¯å¤šå°‘ä½),ç„¶åæ ¹æ®è¿™ä¸ªé…ç½®åˆ›å»ºä¸€å—åŒ…å«é»˜è®¤ buffer çš„ surface(buffer çš„å¤§å°æ˜¯æ ¹æ®å±å¹•åˆ†è¾¨ç‡ä¹˜ä»¥æ¯ä¸ªåƒç´ ä¿¡æ¯æ‰€å å¤§å°è®¡ ç®—è€Œå¾—)å’Œç”¨äºå­˜æ”¾ OpenGL ES çŠ¶æ€é›†çš„ context,å¹¶å°†å®ƒä»¬ enable èµ·æ¥ã€‚ç„¶å, é€šè¿‡ OpenGL ES æ“ä½œ GPU è¿›è¡Œè®¡ç®—,å°†è®¡ç®—çš„ç»“æœä¿å­˜åœ¨ surface çš„ buffer ä¸­ã€‚ æœ€å,ä½¿ç”¨ EGL,å°†ç»˜åˆ¶çš„å›¾ç‰‡æ˜¾ç¤ºåˆ°æ‰‹æœºå±å¹•ä¸Šã€‚</p><p>è€Œåœ¨ OpenGL ES æ“ä½œ GPU è®¡ç®—çš„æ—¶å€™,è¿˜éœ€è¦ä»‹ç» OpenGL ES çš„å¦å¤–ä¸€ä¸ªå¥½æ­æ¡£ GLSLã€‚</p><p>GLSL,å…¨ç§°:OpenGL Shading Language,æ˜¯ OpenGL ES ä¸­ä½¿ç”¨åˆ°çš„ç€è‰²å™¨çš„ è¯­è¨€,ç”¨è¿™ä¸ªè¯­è¨€å¯ä»¥ç¼–å†™å°ç¨‹åºè¿è¡Œåœ¨ GPU ä¸Šã€‚</p><p>åœ¨è¿™é‡Œéœ€è¦å…ˆæåˆ° CPU å’Œ GPU çš„åŒºåˆ«,å®ƒä»¬çš„åŠŸèƒ½éƒ½æ˜¯ç”¨äºè®¡ç®—,ä¹Ÿéƒ½æ˜¯ç”±å¾ˆå¤šæ ¸ç»„æˆ,åŒºåˆ«åœ¨äº CPU çš„æ ¸æ¯”è¾ƒå°‘,ä½†æ˜¯å•ä¸ªæ ¸çš„è®¡ç®—èƒ½åŠ›æ¯”è¾ƒå¼º,è€Œ GPU çš„æ ¸å¾ˆå¤š,ä½†æ˜¯æ¯ä¸ªæ ¸çš„è®¡ç®—èƒ½åŠ›éƒ½ä¸ç®—ç‰¹åˆ«å¼ºã€‚ç›®å‰ GPU çš„ä¸»è¦å·¥ä½œæ˜¯ç”¨äºç”Ÿæˆå›¾ç‰‡(ç°åœ¨ä¹Ÿæœ‰é€šè¿‡ GPU è¿›è¡Œé«˜æ€§èƒ½è¿ç®—_å¹¶è¡Œè¿ç®—,ä½†æ˜¯åœ¨è¿™é‡Œä¸å±äºè®¨è®ºçš„èŒƒå›´),åŸå› å°±æ˜¯å›¾ç‰‡æ˜¯ç”±å¾ˆå¤šåƒç´ ç»„æˆ,æ¯ä¸ªåƒç´ éƒ½åŒ…å«æœ‰é¢œè‰²ã€æ·±åº¦ç­‰ä¿¡æ¯,è€Œä¸ºäº†å¾—åˆ°è¿™äº›ä¿¡æ¯æ•°æ®,é’ˆå¯¹æ¯ä¸ªåƒç´ ç‚¹çš„è®¡ç®—,æ˜¯å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„ç®—æ³•æ¥å®Œæˆã€‚GPU å°±æ“…é•¿å¤„ç†é’ˆå¯¹è¿™ç§å¤§è§„æ¨¡æ•°æ®,ä½¿ç”¨åŒä¸€ä¸ªç®—æ³•è¿›è¡Œè®¡ç®—ã€‚è€Œè¿™ä¸ªç®—æ³•,å°±æ˜¯ä½¿ç”¨ GLSL å†™æˆ Shader,ä¾› GPU è¿ç®—ä½¿ç”¨ã€‚</p><p>åœ¨å›¾å½¢å­¦çš„è§†è§’ä¸­,æ‰€æœ‰çš„å›¾ç‰‡éƒ½æ˜¯ç”±ä¸‰è§’å½¢æ„æˆçš„ã€‚æ‰€ä»¥é€šè¿‡ OpenGL ES ç»˜åˆ¶å›¾ç‰‡çš„æ—¶å€™,æˆ‘ä»¬éœ€è¦é€šè¿‡ OpenGL ES API åˆ›å»ºç”¨äºåœ¨ GPU ä¸Šè¿è¡Œçš„ shader, ç„¶åå°†é€šè¿‡ CPU è·å–åˆ°çš„å›¾ç‰‡é¡¶ç‚¹ä¿¡æ¯,ä¼ å…¥ GPU ä¸­çš„ Shader ä¸­ã€‚åœ¨ Vertex Shader ä¸­é€šè¿‡çŸ©é˜µå˜æ¢,å°†é¡¶ç‚¹åæ ‡ä»æ¨¡å‹åæ ‡ç³»è½¬æ¢åˆ°ä¸–ç•Œåæ ‡ç³»,å†åˆ°è§‚å¯Ÿåæ ‡ç³»,åˆ°è£å‰ªåæ ‡ç³»,æœ€åæŠ•å½±åˆ°å±å¹•åæ ‡ç³»ä¸­,è®¡ç®—å‡ºåœ¨å±å¹•ä¸Šå„ä¸ªé¡¶ç‚¹çš„åæ ‡ã€‚ç„¶å,é€šè¿‡å…‰æ …åŒ–,ä»¥æ’å€¼çš„æ–¹æ³•å¾—åˆ°æ‰€æœ‰åƒç´ ç‚¹çš„ä¿¡æ¯,å¹¶åœ¨ Fragment shader ä¸­è®¡ç®—å‡ºæ‰€æœ‰åƒç´ ç‚¹çš„é¢œè‰²ã€‚æœ€å,é€šè¿‡ OpenGL ES çš„ API è®¾å®šçš„çŠ¶æ€,å°†å¾—åˆ°çš„åƒç´ ä¿¡æ¯è¿›è¡Œ depth/stencil testã€blend,å¾—åˆ°æœ€ç»ˆçš„å›¾ç‰‡ã€‚</p><h4 id="2-3ã€å±å¹•å›¾ç‰‡çš„æœ¬è´¨å’Œäº§ç”Ÿè¿‡ç¨‹"><a href="#2-3ã€å±å¹•å›¾ç‰‡çš„æœ¬è´¨å’Œäº§ç”Ÿè¿‡ç¨‹" class="headerlink" title="2.3ã€å±å¹•å›¾ç‰‡çš„æœ¬è´¨å’Œäº§ç”Ÿè¿‡ç¨‹"></a>2.3ã€å±å¹•å›¾ç‰‡çš„æœ¬è´¨å’Œäº§ç”Ÿè¿‡ç¨‹</h4><p>å½“æˆ‘ä»¬ä¹°ä¸€ä¸ªæ‰‹æœºçš„æ—¶å€™,æˆ‘ä»¬ä¼šéå¸¸å…³æ³¨è¿™ä¸ªæ‰‹æœºçš„åˆ†è¾¨ç‡ã€‚åˆ†è¾¨ç‡ä»£è¡¨ç€åƒç´ çš„å¤šå°‘,æ¯”å¦‚æˆ‘ä»¬ç†ŸçŸ¥çš„ iphone6 çš„åˆ†è¾¨ç‡ä¸º 1334Ã—750,è€Œ iphone6 plus çš„åˆ†è¾¨ç‡æ˜¯1920Ã—1080ã€‚</p><p>æ‰‹æœºå±å¹•ä¸Šçš„å›¾ç‰‡,æ˜¯ç”±ä¸€ä¸ªä¸€ä¸ªçš„åƒç´ ç»„æˆ,é‚£ä¹ˆå¯ä»¥è®¡ç®—å‡ºæ¥,ä¸€ä¸ªå±å¹•ä¸Šçš„å›¾ç‰‡,æ˜¯ç”±ä¸Šç™¾ä¸‡ä¸ªåƒç´ ç‚¹ç»„æˆã€‚è€Œæ¯ä¸ªåƒç´ ç‚¹éƒ½æœ‰è‡ªå·±çš„é¢œè‰²,æ¯ç§é¢œè‰²éƒ½æ˜¯ç”± RGB ä¸‰åŸè‰²ç»„æˆã€‚ä¸‰åŸè‰²æŒ‰ç…§ä¸åŒçš„æ¯”ä¾‹æ··åˆ,ç»„æˆäº†æ‰‹æœºæ‰€èƒ½æ˜¾ç¤ºå‡ºæ¥çš„é¢œè‰²ã€‚</p><p>æ¯ä¸ªåƒç´ çš„é¢œè‰²ä¿¡æ¯éƒ½ä¿å­˜åœ¨ buffer ä¸­,è¿™å— buffer å¯ä»¥åˆ†ç»™ RGB æ¯ä¸ªé€š é“å„ 8bit è¿›è¡Œä¿¡æ¯ä¿å­˜,ä¹Ÿå¯ä»¥åˆ†ç»™ RGB æ¯ä¸ªé€šé“ä¸åŒçš„ç©ºé—´è¿›è¡Œä¿¡æ¯ä¿å­˜, æ¯”å¦‚ç”±äºäººçœ¼å¯¹ç»¿è‰²æœ€æ•æ„Ÿ,é‚£ä¹ˆå¯ä»¥åˆ†é…ç»™ G é€šé“ 6 ä½,R å’Œ B é€šé“å„ 5 ä½ã€‚è¿™äº›éƒ½æ˜¯å¸¸è§çš„æ‰‹æœºé…ç½®ã€‚å‡å¦‚ä½¿ç”¨ RGB888 çš„æ‰‹æœºé…ç½®,ä¹Ÿå°±æ˜¯æ¯ç§é¢œè‰²çš„å–å€¼ä» 0 åˆ° 255,0 æœ€å°,255 æœ€å¤§ã€‚é‚£ä¹ˆçº¢ç»¿è“éƒ½ä¸º 0 çš„æ—¶å€™,è¿™ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å°±æ˜¯é»‘è‰²,çº¢ç»¿è“éƒ½ä¸º 255 çš„æ—¶å€™,è¿™ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å°±æ˜¯ç™½è‰²ã€‚å½“çº¢ä¸º 255, ç»¿è“éƒ½ä¸º 0 çš„æ—¶å€™,è¿™ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å°±æ˜¯çº¢è‰²ã€‚å½“çº¢ç»¿ä¸º 255,è“ä¸º 0 çš„æ—¶å€™, è¿™ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å°±æ˜¯é»„è‰²ã€‚å½“ç„¶ä¸æ˜¯åªå– 0 æˆ–è€… 255,å¯ä»¥å– 0-255 ä¸­é—´çš„å€¼, 100,200,ä»»æ„åœ¨ 0 å’Œ 255 ä¸­é—´çš„å€¼éƒ½æ²¡æœ‰é—®é¢˜ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç®—ä¸€ä¸‹,æŒ‰ç…§çº¢ç»¿è“ä¸åŒæ¯”ä¾‹è¿›è¡Œæ­é…,æ¯ä¸ªåƒç´ ç‚¹,å¯ä»¥æ˜¾ç¤ºçš„é¢œè‰²æœ‰ 255<em>255</em>255=16581375 ç§,è¿™ä¸ªæ•°å­—æ˜¯éå¸¸ææ€–,æ‰€ä»¥æˆ‘ä»¬çš„æ‰‹æœºå¯ä»¥æ˜¾ç¤ºå‡ºæ¥å„ç§å„æ ·çš„é¢œè‰²ã€‚ è¿™é‡Œåœ¨å»¶ä¼¸çš„ç§‘æ™®ä¸€ä¸‹,æˆ‘ä»¬çœ‹åˆ°æ‰‹æœºå¯ä»¥æ˜¾ç¤ºé‚£ä¹ˆå¤šç§é¢œè‰²äº†,ä½†æ˜¯æ˜¯ä¸æ˜¯è¯´æˆ‘ä»¬çš„æ‰‹æœºåœ¨é¢œè‰²ä¸Šå°±å·²ç»å‘å±•åˆ°æè‡´äº†å‘¢?å…¶å®æ˜¯è¿œè¿œæ²¡æœ‰çš„,åœ¨è¿™ä¸ªæ‰‹æœºé…ç½®ä¸‹,ä¸‰åŸè‰²ä¸­æ¯ä¸€ç§çš„å–å€¼å¯ä»¥ä» 0 åˆ° 255,è€Œåœ¨ç°å®ç”Ÿæ´»ä¸­,å®ƒä»¬çš„å– å€¼å¯ä»¥ä» 0 åˆ° 1 äº¿,è€Œæˆ‘ä»¬äººç±»çš„çœ¼ç›æ‰€èƒ½çœ‹åˆ°çš„èŒƒå›´æ˜¯,ä» 0 åˆ° 10 ä¸‡ã€‚æ‰€ä»¥æ‰‹æœºç¡¬ä»¶è¿˜å­˜åœ¨å¾ˆå¤§çš„æå‡ç©ºé—´ã€‚è€Œåœ¨æ‰‹æœºç¡¬ä»¶æå‡ä¹‹å‰,æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ HDR ç­‰æŠ€æœ¯å°½é‡çš„åœ¨æ‰‹æœºä¸­å¤šæ˜¾ç¤ºä¸€äº›é¢œè‰²ã€‚æ‰€ä»¥,è®²åˆ°è¿™é‡Œ,æˆ‘ä»¬çŸ¥é“äº†,æ‰‹æœºå±å¹•ä¸Šæ˜¾ç¤ºçš„å›¾ç‰‡,æ˜¯ç”±è¿™ä¸Šç™¾ä¸‡ä¸ªåƒç´ ç‚¹,ä»¥åŠè¿™ä¸Šç™¾ä¸‡ä¸ªåƒç´ ç‚¹å¯¹åº”çš„é¢œè‰²ç»„æˆçš„ã€‚</p><p>ç”¨ç¨‹åºå‘˜çš„è§’åº¦æ¥çœ‹,å°±æ˜¯æ‰‹æœºå±å¹•å¯¹åº”ç€ä¸€å— buffer,è¿™å— buffer å¯¹åº”ä¸Šç™¾ä¸‡ä¸ªåƒç´ ç‚¹,æ¯ä¸ªåƒç´ ç‚¹éœ€è¦ä¸€å®šçš„ç©ºé—´æ¥å­˜å‚¨å…¶é¢œè‰²ã€‚å¦‚æœä½¿ç”¨æ›´åŠ å½¢è±¡çš„ä¾‹å­æ¥æ¯”å–»,æ‰‹æœºå±å¹•å¯¹åº”çš„ buffer å°±å¥½åƒä¸€å—å·¨å¤§çš„æ£‹ç›˜,æ£‹ç›˜ä¸Šæœ‰ä¸Šç™¾ä¸‡ä¸ªæ ¼å­,æ¯ä¸ªæ ¼å­éƒ½æœ‰è‡ªå·±çš„é¢œè‰²,é‚£ä¹ˆä»è¿œå¤„æ•´ä½“çš„çœ‹è¿™ä¸ªæ£‹ç›˜,å°±æ˜¯æˆ‘ä»¬çœ‹æ‰‹æœºçš„æ—¶å€™æ˜¾ç¤ºçš„æ ·å­ã€‚è¿™å°±æ˜¯æ‰‹æœºå±å¹•ä¸Šå›¾ç‰‡çš„æœ¬è´¨ã€‚</p><p>é€šè¿‡æˆ‘ä»¬å¯¹ EGLã€GLSLã€OpenGL ES çš„ç†è§£,å€ŸåŠ©ä¸€å¼ å›¾ç‰‡,ä»ä¸“ä¸šçš„è§’åº¦æ¥è§£é‡Šä¸€ä¸‹æ‰‹æœºå±å¹•ä¸Šçš„å›¾ç‰‡æ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-05-OpenGL-Picture-Generate.png" alt="Alt text | center"></p><p>é¦–å…ˆ,é€šè¿‡ EGL è·å–æ‰‹æœºå±å¹•,è¿›è€Œè·å–åˆ°æ‰‹æœºå±å¹•å¯¹åº”çš„è¿™ä¸ªæ£‹ç›˜,åŒæ—¶, åœ¨æ‰‹æœºçš„ GPU ä¸­æ ¹æ®æ‰‹æœºçš„é…ç½®ä¿¡æ¯,ç”Ÿæˆå¦å¤–ä¸€ä¸ªçš„æ£‹ç›˜å’Œä¸€ä¸ªæœ¬å­,æœ¬å­æ˜¯ç”¨äºè®°å½•è¿™ä¸ªæ£‹ç›˜åˆå§‹é¢œè‰²ç­‰ä¿¡æ¯ã€‚</p><p>ç„¶å,OpenGL ES å°±å¥½åƒç¨‹åºå‘˜çš„ç”»ç¬”,ç¨‹åºå‘˜éœ€è¦çŸ¥é“è‡ªå·±æƒ³ç”»ä»€ä¹ˆä¸œè¥¿,æ¯”å¦‚æƒ³ç”»ä¸€ä¸ªè‹¹æœ,é‚£ä¹ˆå°±éœ€è¦é€šè¿‡ä¸ºæ•°ä¸å¤šçš„åŸºæœ¬å‡ ä½•å›¾å…ƒ(å¦‚ç‚¹ã€ç›´çº¿ã€ä¸‰ è§’å½¢)æ¥åˆ›å»ºæ‰€éœ€è¦çš„æ¨¡å‹ã€‚æ¯”å¦‚ç”¨å‡ ä¸ªä¸‰è§’å½¢å’Œç‚¹å’Œçº¿æ¥è¿‘ä¼¼çš„ç»„æˆè¿™ä¸ªè‹¹æœ (å›¾å½¢å­¦çš„æ ¹æœ¬å°±æ˜¯ç‚¹ã€çº¿å’Œä¸‰è§’å½¢,æ‰€æœ‰çš„å›¾å½¢,éƒ½å¯ä»¥ç”±è¿™äº›åŸºæœ¬å›¾å½¢ç»„æˆ, æ¯”å¦‚æ­£æ–¹å½¢æˆ–è€…é•¿æ–¹å½¢,å°±å¯ä»¥ç”±ä¸¤ä¸ªä¸‰è§’å½¢ç»„æˆ,åœ†å½¢å¯ä»¥ç”±æ— æ•°ä¸ªä¸‰è§’å½¢ç»„æˆ,åªæ˜¯ä¸‰è§’å½¢çš„æ•°é‡è¶Šå¤š,åœ†å½¢çœ‹ä¸Šå»è¶Šåœ†æ¶¦)ã€‚</p><p>æ ¹æ®è¿™äº›å‡ ä½•å›¾å…ƒ,å»ºç«‹æ•°å­¦æè¿°,æ¯”å¦‚æ¯ä¸ªä¸‰è§’å½¢æˆ–è€…çº¿çš„é¡¶ç‚¹åæ ‡ä½ç½®ã€æ¯ä¸ªé¡¶ç‚¹çš„é¢œè‰²ã€‚å¾—åˆ°è¿™äº›ä¿¡æ¯ä¹‹å,å¯ä»¥å…ˆé€šè¿‡ OpenGL ES å°† EGL ç”Ÿæˆçš„æ£‹ç›˜ (buffer)è¿›è¡Œé¢œè‰²åˆå§‹åŒ–,ä¸€èˆ¬ä¼šè¢«åˆå§‹åŒ–ä¸ºé»‘è‰²ã€‚ç„¶åå°†åˆšæ‰æˆ‘ä»¬è·å–åˆ°çš„é¡¶ç‚¹åæ ‡ä½ç½®,é€šè¿‡çŸ©é˜µå˜åŒ–çš„æ–¹å¼,è¿›è¡Œæ¨¡å‹å˜æ¢ã€è§‚å¯Ÿå˜æ¢ã€æŠ•å½±å˜æ¢,æœ€åæ˜ å°„åˆ°å±å¹•ä¸Š,å¾—åˆ°å±å¹•ä¸Šçš„åæ ‡ã€‚è¿™ä¸ªæ­¥éª¤å¯ä»¥åœ¨ CPU ä¸­å®Œæˆ,ä¹Ÿå°±æ˜¯åœ¨ OpenGL ES æŠŠåæ ‡ä¿¡æ¯ä¼ ç»™ Shader ä¹‹å‰,åœ¨ CPU ä¸­é€šè¿‡çŸ©é˜µç›¸ä¹˜ç­‰æ–¹å¼è¿›è¡Œæ›´æ–°,æˆ–è€…æ˜¯ç›´æ¥æŠŠåæ ‡ä¿¡æ¯é€šè¿‡ OpenGL ES ä¼ ç»™ Shader,åŒæ—¶ä¹ŸæŠŠçŸ©é˜µä¿¡æ¯ä¼ ç»™ Shader,é€šè¿‡ Shader åœ¨ GPU ç«¯è¿›è¡Œåæ ‡æ›´æ–°,æ›´æ–°çš„ç®—æ³•é€šè¿‡ GLSL å†™åœ¨ Shader ä¸­ã€‚è¿™ä¸ªè¿›è¡Œåæ ‡æ›´æ–°çš„ Shader è¢«ç§°ä¸º vertex shader,ç®€ç§° VS,æ˜¯ OpenGL ES2.0, ä¹Ÿæ˜¯ GLSL130 ç‰ˆæœ¬å¯¹åº”çš„æœ€é‡è¦ä¸¤ä¸ª shader ä¹‹ä¸€,ä½œç”¨æ˜¯å®Œæˆé¡¶ç‚¹æ“ä½œé˜¶æ®µä¸­çš„æ‰€æœ‰æ“ä½œã€‚ç»è¿‡çŸ©é˜µå˜æ¢åçš„åƒç´ åæ ‡ä¿¡æ¯,ä¸ºå±å¹•åæ ‡ç³»ä¸­çš„åæ ‡ä¿¡æ¯ã€‚åœ¨ VS ä¸­,æœ€é‡è¦çš„è¾“å…¥ä¸ºé¡¶ç‚¹åæ ‡ã€çŸ©é˜µ(è¿˜å¯ä»¥ä¼ å…¥é¡¶ç‚¹çš„é¢œè‰²ã€æ³•çº¿ã€çº¹ç† åæ ‡ç­‰ä¿¡æ¯),è€Œæœ€é‡è¦çš„è¿ç®—ç»“æœ,å°±æ˜¯è¿™ä¸ªå°†è¦æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„åæ ‡ä¿¡æ¯ã€‚ VS ä¼šé’ˆå¯¹ä¼ å…¥çš„æ‰€æœ‰é¡¶ç‚¹è¿›è¡Œè¿ç®—,æ¯”å¦‚åœ¨ OpenGL ES ä¸­åªæƒ³ç»˜åˆ¶ä¸€ä¸ªä¸‰è§’å½¢ å’Œä¸€æ¡çº¿,è¿™ä¸¤ä¸ªå›¾å…ƒä¸å…±äº«é¡¶ç‚¹,é‚£ä¹ˆåœ¨ VS ä¸­,ä¹Ÿå°±ä¼ å…¥äº† 5 ä¸ªé¡¶ç‚¹ä¿¡æ¯, æ ¹æ®çŸ©é˜µå˜æ¢,è¿™ 5 ä¸ªé¡¶ç‚¹çš„åæ ‡è½¬æ¢æˆäº†å±å¹•ä¸Šçš„é¡¶ç‚¹åæ ‡ä¿¡æ¯,ä»å›¾ä¸Šæ˜¾ç¤º, ä¹Ÿå°±æ˜¯ä»å·¦ä¸Šè§’çš„å›¾ä¸€,æ›´æ–°æˆäº†ä¸­ä¸Šå›¾çš„å›¾äºŒã€‚</p><p>å†ç„¶å,å½“å›¾äºŒç”Ÿæˆä¹‹å,æˆ‘ä»¬çŸ¥é“äº†å›¾å…ƒåœ¨å±å¹•ä¸Šçš„é¡¶ç‚¹ä½ç½®,è€Œé¡¶ç‚¹çš„é¢œè‰²åœ¨ VS ä¸­æ²¡æœ‰å‘ç”Ÿå˜åŒ–,æ‰€ä»¥å›¾å…ƒçš„é¡¶ç‚¹é¢œè‰²æˆ‘ä»¬ä¹Ÿæ˜¯çŸ¥é“çš„ã€‚ä¸‹é¢å°±æ˜¯æ ¹æ® OpenGL ES ä¸­è®¾ç½®çš„çŠ¶æ€,è¡¨æ˜å“ªäº›ç‚¹è¿æˆçº¿,å“ªäº›ç‚¹ç»„æˆä¸‰è§’å½¢,è¿›è¡Œå›¾å…ƒè£…é…,ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å³ä¸Šè§’çš„å›¾ä¸‰ä¸­çœ‹åˆ°çš„æ ·å­ã€‚è¿™ä¸ªæ ·å­åœ¨ GPU ä¸­ä¸ä¼šæ˜¾ç¤º, é‚£å‡ æ¡çº¿ä¹Ÿæ˜¯è™šæ‹Ÿçš„çº¿,æ˜¯ä¸ä¼šæ˜¾ç¤ºåœ¨æ£‹ç›˜ buffer ä¸­çš„,è€Œ GPU åšçš„æ˜¯å…‰çŠåŒ–,è¿™ä¸€æ­¥æ˜¯å‘ç”Ÿåœ¨ä» VS å‡ºæ¥,è¿›å…¥å¦å¤–ä¸€ä¸ªShader (Pixel shader,ä¹Ÿç§° fragment shader)ä¹‹å‰,åœ¨ GPU ä¸­è¿›è¡Œçš„ã€‚ä½œç”¨æ˜¯æŠŠçº¿ä¸Š,æˆ–è€…ä¸‰è§’å½¢å†…éƒ¨æ‰€æœ‰çš„åƒç´ ç‚¹æ‰¾åˆ°,å¹¶æ ¹æ®æ’å€¼æˆ–è€…å…¶ä»–æ–¹å¼è®¡ç®—å‡ºå…¶é¢œè‰²ç­‰ä¿¡æ¯(å¦‚æœä¸é€šè¿‡æ’å€¼,å¯ä»¥ä½¿ç”¨å…¶ä»–çš„æ–¹æ³•,è¿™äº›åœ¨ OpenGL ES å’Œ GLSL ä¸­éƒ½å¯ä»¥è¿›è¡Œè®¾ç½®)ã€‚ä¹Ÿå°±ç”Ÿæˆäº†ä¸‹é¢ä¸€è¡Œçš„å›¾å››å’Œå›¾äº”ã€‚</p><p>æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çœ‹åˆ°åœ¨å›¾ 4 å’Œå›¾ 5 ç§å‡ºç°äº†å¤§é‡çš„é¡¶ç‚¹,å¤§æ¦‚æ•°ä¸€ä¸‹ä¼°è®¡æœ‰ 40 ä¸ªç‚¹å·¦å³,è¿™äº›ç‚¹å…¨éƒ¨éƒ½ä¼šè¿›å…¥ PS è¿›è¡Œæ“ä½œ,åœ¨ PS ä¸­å¯ä»¥å¯¹è¿™äº›ç‚¹çš„é¢œè‰²è¿›è¡Œæ“ä½œ,æ¯”å¦‚å¯ä»¥åªæ˜¾ç¤ºè¿™äº›ç‚¹çš„çº¢è‰²é€šé“,å…¶ä»–çš„ç»¿è“é€šé“çš„å€¼è®¾ç½®ä¸º 0, æ¯”å¦‚ä¹‹å‰æŸä¸ªç‚¹çš„ RGB ä¸º 200,100,100ã€‚åœ¨ PS ä¸­å¯ä»¥å°†å…¶é€šè¿‡è®¡ç®—,æ›´æ–°ä¸º 200,0,0ã€‚è¿™æ ·åšçš„ç»“æœå°±æ˜¯æ‰€æ˜¾ç¤ºçš„å›¾ç‰‡å‡ä¸ºçº¢è‰²,åªæ˜¯æ·±æµ…ä¸åŒã€‚è¿™ä¹Ÿå°±å¥½åƒæˆ´ä¸Šäº†ä¸€å±‚çº¢è‰²çš„æ»¤é•œ,å…¶ä»–é¢œè‰²å‡ä¸ºæ»¤æ‰äº†ã€‚æ‰€ä»¥ç”¨ PS æ¥åšæ»¤é•œæ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚å†æ¯”å¦‚,å‡å¦‚ä¸€ç›çº¢è‰²çš„ç¯ç…§åˆ°äº†è‹¹æœä¸Š,é‚£ä¹ˆæ˜¾ç¤ºå‡ºæ¥çš„é¢œè‰²å°±æ˜¯åœ¨è‹¹æœåŸæœ¬çš„é¢œè‰²åŸºç¡€ä¸Š,çº¢è‰²å€¼è¿›è¡Œä¸€å®šçš„å¢å€¼ã€‚</p><p>æ‰€ä»¥,æ€»ç»“ä¸€ä¸‹,ç»è¿‡ VS å’Œ PS ä¹‹å,ç¨‹åºå‘˜æƒ³è¦ç”»çš„ä¸œè¥¿,å°±å·²ç»è¢«ç”»å‡ºæ¥äº†ã€‚æƒ³è¦ç»˜åˆ¶çš„ä¸œè¥¿,ä¹Ÿå°±æ˜¯å·¦ä¸‹è§’å›¾äº”çš„æ ·å­ã€‚ç„¶åå†æ ¹æ® OpenGL ES çš„è®¾ç½®,å¯¹æ–°ç»˜åˆ¶å‡ºæ¥çš„ä¸œè¥¿è¿›è¡Œ Depth/Stencil Test,å‰”é™¤æ‰è¢«é®æŒ¡çš„éƒ¨åˆ†,å°†å‰©ä½™éƒ¨åˆ†ä¸åŸå›¾ç‰‡è¿›è¡Œ Blend,ç”Ÿæˆæ–°çš„å›¾ç‰‡ã€‚ æœ€å,é€šè¿‡ EGL,æŠŠè¿™ä¸ªç”Ÿæˆçš„æ£‹ç›˜ buffer å’Œæ‰‹æœºå±å¹•ä¸Šå¯¹åº”çš„æ£‹ç›˜ buffer è¿›è¡Œè°ƒæ¢,è®©æ‰‹æœºå±å¹•æ˜¾ç¤ºè¿™ä¸ªæ–°ç”Ÿæˆçš„æ£‹ç›˜,æ—§çš„é‚£ä¸ªæ£‹ç›˜å†å»ç»˜åˆ¶æ–°çš„å›¾ç‰‡ä¿¡æ¯ã€‚å‘¨è€Œå¤å§‹,ä¸åœçš„æŠŠæ£‹ç›˜è¿›è¡Œåˆ‡æ¢,ä¹Ÿå°±åƒè¿‡å»çœ‹è¿ç¯ç”»ä¸€æ ·,åŠ¨ç”»å°±æ˜¯ç”±ä¸€å¹…å¹…çš„å›¾ç‰‡ç»„æˆ,å½“æ¯ç§’åˆ‡æ¢çš„å›¾ç‰‡æ•°é‡è¶…è¿‡ 30 å¼ çš„æ—¶å€™,æˆ‘ä»¬çš„æ‰‹æœºä¹Ÿå°±çœ‹åˆ°äº†åŠ¨æ€çš„æ•ˆæœã€‚è¿™å°±æ˜¯å±å¹•ä¸Šå›¾ç‰‡çš„äº§ç”Ÿè¿‡ç¨‹ã€‚</p><p>åœ¨è¿™é‡Œå†è¿›è¡Œä¸€ä¸‹å»¶ä¼¸,è¿™ä¸ªä¾‹å­ä¸­,VS è®¡ç®—äº† 5 ä¸ªé¡¶ç‚¹çš„æ•°æ®,PS è®¡ç®— äº†å¤§æ¦‚ 40 ä¸ªé¡¶ç‚¹çš„æ•°æ®,è€Œæˆ‘ä»¬åˆšæ‰è¯´è¿‡,æ‰‹æœºä¸­å­˜åœ¨ä¸Šç™¾ä¸‡ä¸ªåƒç´ ç‚¹,è¿™ä¸Šç™¾ä¸‡ä¸ªåƒç´ ç‚¹éƒ½å¯ä»¥æ˜¯é¡¶ç‚¹,é‚£ä¹ˆè¿™ä¸ªè®¡ç®—é‡æ˜¯éå¸¸å¤§çš„ã€‚è€Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¦å°† shader è¿ç®—æ”¾åœ¨ GPU ä¸­çš„åŸå› ,å› ä¸º GPU æ“…é•¿è¿›è¡Œè¿™ç§è¿ç®—ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ CPU ç°åœ¨ä¸€èˆ¬éƒ½æ˜¯åŒæ ¸æˆ–è€… 4 æ ¸,å¤šçš„ä¹Ÿå°±æ˜¯ 8 æ ¸æˆ–è€… 16 æ ¸,ä½†æ˜¯ GPU åŠ¨è¾„å°±æ˜¯ 72 æ ¸,å¤šçš„è¿˜æœ‰ä¸Šåƒæ ¸,è¿™ä¹ˆå¤šæ ¸çš„ç›®çš„å°±æ˜¯è¿›è¡Œå¹¶è¡Œè¿ç®—, è™½ç„¶å•ä¸ªçš„ GPU æ ¸ä¸å¦‚ CPU æ ¸,ä½†æ˜¯å•ä¸ªçš„ GPU æ ¸è¶³å¤Ÿè¿›è¡ŒåŠ å‡ä¹˜é™¤è¿ç®—,æ‰€ä»¥å¤§é‡çš„ GPU æ ¸ç”¨åœ¨å›¾å½¢å­¦åƒç´ ç‚¹è¿ç®—ä¸Š,æ˜¯éå¸¸æœ‰æ•ˆçš„ã€‚è€Œ CPU è™½ç„¶å•ä¸ªå¾ˆå¼ºå¤§,è€Œä¸”ä¹Ÿå¯ä»¥é€šè¿‡å¤šçº§æµæ°´æ¥æé«˜ååç‡,ä½†æ˜¯ç»ˆç©¶è¿˜æ˜¯ä¸å¦‚ GPU çš„å¤šæ ¸æ¥å¾—å¿«ã€‚ä½†æ˜¯åœ¨é€šè¿‡ GPU è¿›è¡Œå¤šæ ¸è¿ç®—çš„æ—¶å€™,éœ€è¦æ³¨æ„çš„æ˜¯:å¦‚æœ shader ä¸­å­˜æ”¾åˆ¤æ–­è¯­å¥,å°±ä¼šå¯¹ GPU é€ æˆæ¯”è¾ƒå¤§çš„è´Ÿè·,ä¸åŒ GPU çš„å®ç°æ–¹å¼ä¸åŒ,å¤šæ•° GPU ä¼šå¯¹åˆ¤æ–­è¯­å¥çš„ä¸¤ç§æƒ…å†µéƒ½è¿›è¡Œè¿ç®—,ç„¶åæ ¹æ®åˆ¤æ–­ç»“æœå–å…¶ä¸­ä¸€ä¸ªã€‚</p><p>æˆ‘ä»¬é€šè¿‡è¿™ä¸ªä¾‹å­å†æ¬¡æ¸…æ¥šäº† OpenGL ES ç»˜åˆ¶çš„æ•´ä¸ªæµç¨‹,è€Œè¿™ä¸ªä¾‹å­ä¹Ÿæ˜¯æœ€ç®€å•çš„ä¸€ä¸ªä¾‹å­,å…¶ä¸­æœ‰å¾ˆå¤š OpenGL ES çš„å…¶ä»–æ“ä½œæ²¡æœ‰è¢«æ¶‰åŠåˆ°ã€‚æ¯”å¦‚,æˆ‘ä»¬ç»˜åˆ¶ç‰©ä½“çš„é¢œè‰²å¤§å¤šæ˜¯ä»çº¹ç†ä¸­é‡‡æ ·å‡ºæ¥,é‚£ä¹ˆè®¾è®¡åˆ°é€šè¿‡ OpenGL ES å¯¹çº¹ç† è¿›è¡Œæ“ä½œã€‚è€Œ OpenGL ES çš„è¿™äº›åŠŸèƒ½,æˆ‘ä»¬ä¼šåœ¨ä¸‹é¢ä¸€ç‚¹ä¸€ç‚¹è¿›è¡Œå­¦ä¹ ã€‚</p><h4 id="2-4-2ã€OpenGL-æµæ°´çº¿ï¼ˆpipelineï¼‰"><a href="#2-4-2ã€OpenGL-æµæ°´çº¿ï¼ˆpipelineï¼‰" class="headerlink" title="2.4.2ã€OpenGL æµæ°´çº¿ï¼ˆpipelineï¼‰"></a>2.4.2ã€OpenGL æµæ°´çº¿ï¼ˆpipelineï¼‰</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-06-OpenGL-ES-pipeline.png" alt="Alt text | center"></p><p>EGL æ˜¯ç”¨äºä¸æ‰‹æœºè®¾å¤‡æ‰“äº¤é“,æ¯”å¦‚è·å–ç»˜åˆ¶ buffer,å°†ç»˜åˆ¶ buffer å±•ç°åˆ°æ‰‹æœºå±å¹•ä¸­ã€‚é‚£ä¹ˆæŠ›å¼€ EGL ä¸è¯´,OpenGL ES ä¸ GLSL çš„ä¸»è¦åŠŸèƒ½,å°±æ˜¯å¾€è¿™å— buffer ä¸Šç»˜åˆ¶å›¾ç‰‡ã€‚</p><p>æ‰€ä»¥,æˆ‘ä»¬å¯ä»¥æŠŠOpenGL ESå’ŒGLSLçš„æµç¨‹å•ç‹¬æ‹¿å‡ºæ¥è¿›è¡Œå½’çº³æ€»ç»“,è€Œè¿™å¹…æµç¨‹å›¾å°±æ˜¯è‘—åçš„ OpenGL ES2.0 pipelineã€‚</p><p>é¦–å…ˆ,æœ€å·¦è¾¹çš„ API æŒ‡çš„å°±æ˜¯ OpenGL ES çš„ API,OpenGL ES å…¶å®æ˜¯ä¸€ä¸ªå›¾å½¢å­¦åº“,ç”± 109 ä¸ª API ç»„æˆ,åªè¦æ˜ç™½äº†è¿™ 109 ä¸ª API çš„æ„ä¹‰å’Œç”¨é€”,å°±æŒæ¡äº†OpenGL ES 2.0ã€‚</p><p>ç„¶å,æˆ‘ä»¬é€šè¿‡ API å…ˆè®¾å®šäº†é¡¶ç‚¹çš„ä¿¡æ¯,é¡¶ç‚¹çš„åæ ‡ã€ç´¢å¼•ã€é¢œè‰²ç­‰ä¿¡æ¯,å°†è¿™äº›ä¿¡æ¯ä¼ å…¥ VSã€‚</p><p>åœ¨ VS ä¸­è¿›è¡Œè¿ç®—,å¾—åˆ°æœ€ç»ˆçš„é¡¶ç‚¹åæ ‡ã€‚å†æŠŠç®—å‡ºæ¥çš„é¡¶ç‚¹åæ ‡è¿›è¡Œå›¾å…ƒè£…é…,æ„å»ºæˆè™šæ‹Ÿçš„çº¿å’Œä¸‰è§’å½¢ã€‚å†è¿›è¡Œå…‰çŠåŒ–(åœ¨å…‰çŠåŒ–çš„æ—¶å€™,æŠŠé¡¶ç‚¹è¿æ¥èµ·æ¥å½¢æˆç›´çº¿,æˆ–è€…å¡«å……å¤šè¾¹å½¢çš„æ—¶å€™,éœ€è¦è€ƒè™‘ç›´çº¿å’Œå¤šè¾¹å½¢çš„ç›´çº¿å®½åº¦ã€ç‚¹çš„å¤§å°ã€æ¸å˜ç®—æ³•ä»¥åŠæ˜¯å¦ä½¿ç”¨æ”¯æŒæŠ—é”¯é½¿å¤„ç†çš„è¦†ç›–ç®—æ³•ã€‚æœ€ç»ˆçš„æ¯ä¸ªåƒç´ ç‚¹,éƒ½å…·æœ‰å„è‡ªçš„é¢œè‰²å’Œæ·±åº¦å€¼)ã€‚</p><p>å°†å…‰çŠåŒ–çš„ç»“æœä¼ å…¥ PS,è¿›è¡Œæœ€ç»ˆçš„é¢œè‰²è®¡ç®—ã€‚</p><p>ç„¶å,è¿™æ‰€è°“æœ€ç»ˆçš„ç»“æœåœ¨è¢«å®é™…å­˜å‚¨åˆ°ç»˜åˆ¶ buffer ä¹‹å‰,è¿˜éœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œã€‚è¿™äº›æ“ä½œå¯èƒ½ä¼šä¿®æ”¹ç”šè‡³ä¸¢å¼ƒè¿™äº›åƒç´ ç‚¹ã€‚</p><p>è¿™äº›æ“ä½œä¸»è¦ä¸º alpha testã€Depth/Stencil testã€Blendã€Ditherã€‚</p><p>Alpha Test é‡‡ç”¨ä¸€ç§å¾ˆéœ¸é“æç«¯çš„æœºåˆ¶,åªè¦ä¸€ä¸ªåƒç´ çš„ alpha ä¸æ»¡è¶³æ¡ä»¶, é‚£ä¹ˆå®ƒå°±ä¼šè¢« fragment shader èˆå¼ƒ,è¢«èˆå¼ƒçš„ fragments ä¸ä¼šå¯¹åé¢çš„å„ç§ Tests äº§ç”Ÿå½±å“;å¦åˆ™,å°±ä¼šæŒ‰æ­£å¸¸æ–¹å¼ç»§ç»­ä¸‹é¢çš„æ£€éªŒã€‚Alpha Test äº§ç”Ÿçš„æ•ˆæœä¹Ÿå¾ˆæç«¯,è¦ä¹ˆå®Œå…¨é€æ˜,å³çœ‹ä¸åˆ°,è¦ä¹ˆå®Œå…¨ä¸é€æ˜ã€‚</p><p>Depth/stencil test æ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚ç”±äºæˆ‘ä»¬ç»˜åˆ¶çš„æ˜¯ 3D å›¾å½¢,é‚£ä¹ˆåæ ‡ä¸º XYZ,è€Œ Z ä¸€èˆ¬å°±æ˜¯æ·±åº¦å€¼,OpenGL ES å¯ä»¥å¯¹æ·±åº¦æµ‹è¯•è¿›è¡Œè®¾å®š,æ¯”å¦‚è®¾å®šæ·±åº¦å€¼å¤§çš„è¢«æŠ›å¼ƒ,é‚£ä¹ˆå‡å¦‚ç»˜åˆ¶ buffer ä¸ŠæŸä¸ªåƒç´ ç‚¹çš„æ·±åº¦å€¼ä¸º 0,è€Œ PS è¾“å‡ºçš„ åƒç´ ç‚¹çš„æ·±åº¦å€¼ä¸º 1,é‚£ä¹ˆ PS è¾“å‡ºçš„åƒç´ ç‚¹å°±è¢«æŠ›å¼ƒäº†ã€‚è€Œ stencil æµ‹è¯•æ›´åŠ ç®€å•,å…¶åˆè¢«ç§°ä¸ºè’™ç‰ˆæµ‹è¯•,æ¯”å¦‚å¯ä»¥é€šè¿‡ OpenGL ES è®¾å®šä¸åŒ stencil å€¼çš„é…æŠ›å¼ƒ, é‚£ä¹ˆå‡å¦‚ç»˜åˆ¶ buffer ä¸ŠæŸä¸ªåƒç´ ç‚¹çš„ stencil å€¼ä¸º 0,è€Œ PS è¾“å‡ºçš„åƒç´ ç‚¹çš„ stencil å€¼ä¸º 1,é‚£ä¹ˆ PS è¾“å‡ºçš„åƒç´ ç‚¹å°±è¢«æŠ›å¼ƒäº†ã€‚</p><p>æ—¢ç„¶è¯´åˆ°äº† Depth/stencil,é‚£ä¹ˆå°±åœ¨è¿™é‡Œè¯´ä¸€ä¸‹ç»˜åˆ¶ buffer åˆ°åº•æœ‰å¤šå¤§,å­˜ å‚¨äº†å¤šå°‘ä¿¡æ¯ã€‚æŒ‰ç…§æˆ‘ä»¬åˆšæ‰çš„è¯´æ³•,æ‰‹æœºå¯ä»¥æ”¯æŒä¸€ç™¾ä¸‡ä¸ªåƒç´ ,é‚£ä¹ˆç”Ÿæˆçš„ ç»˜åˆ¶ buffer å°±éœ€è¦å­˜å‚¨è¿™ä¸€ç™¾ä¸‡ä¸ªåƒç´ æ‰€åŒ…å«çš„ä¿¡æ¯,è€Œæ¯ä¸ªåƒç´ åŒ…å«çš„ä¿¡æ¯, ä¸æ‰‹æœºé…ç½®æœ‰å…³,å‡å¦‚æ‰‹æœºæ”¯æŒ Depth/stencilã€‚é‚£ä¹ˆé€šè¿‡ EGL è·å–çš„ç»˜åˆ¶ buffer ä¸­,æ¯ä¸ªåƒç´ ç‚¹å°±åŒ…å«äº† RGBA çš„é¢œè‰²å€¼,depth å€¼å’Œ stencil å€¼,å…¶ä¸­ RGBA æ¯ä¸ªåˆ†é‡ä¸€èˆ¬å æ® 8 ä½,ä¹Ÿå°±æ˜¯ 8bit,ä¹Ÿå°±æ˜¯ 1byte,è€Œ depth å¤§å¤šæ•°å  24 ä½,stencil å  8 ä½ã€‚æ‰€ä»¥æ¯ä¸ªåƒç´ å  64bit,ä¹Ÿå°±æ˜¯ 8byteã€‚é‚£ä¹ˆ iphone6 plus çš„ç»˜åˆ¶ buffer çš„å°ºå¯¸ä¸º 1920Ã—1080Ã—8=16588800byte=16200KB=15.8MBã€‚</p><p>ä¸‹é¢è¿˜æœ‰ blend,é€šè¿‡ OpenGL ES å¯ä»¥è®¾ç½® blend æ··åˆæ¨¡å¼ã€‚ç”±äºç»˜åˆ¶ buffer ä¸­åŸæœ¬æ¯ä¸ªåƒç´ ç‚¹å·²ç»æœ‰é¢œè‰²äº†,é‚£ä¹ˆ PS è¾“å‡ºçš„é¢œè‰²ä¸ç»˜åˆ¶ buffer ä¸­çš„é¢œè‰²å¦‚ä½•æ··åˆ,ç”Ÿæˆæ–°çš„é¢œè‰²å­˜å‚¨åœ¨ç»˜åˆ¶ buffer ä¸­,å°±æ˜¯é€šè¿‡ blend æ¥è¿›è¡Œè®¾å®šã€‚</p><p>æœ€åçš„ dither,dither æ˜¯ä¸€ç§å›¾åƒå¤„ç†æŠ€æœ¯,æ˜¯æ•…æ„é€ æˆçš„å™ªéŸ³,ç”¨ä»¥éšæœºåŒ–é‡åŒ–è¯¯å·®,é˜»æ­¢å¤§å¹…åº¦æ‹‰å‡å›¾åƒæ—¶,å¯¼è‡´çš„åƒ banding(è‰²å¸¦)è¿™æ ·çš„é—®é¢˜ã€‚ä¹Ÿ æ˜¯é€šè¿‡OpenGL ES å¯ä»¥å¼€å¯æˆ–è€…å…³é—­ã€‚</p><p>ç»è¿‡äº†è¿™ä¸€ç³»åˆ—çš„è¿ç®—å’Œæµ‹è¯•,ä¹Ÿå°±å¾—åˆ°äº†æœ€ç»ˆçš„åƒç´ ç‚¹ä¿¡æ¯,å°†å…¶å­˜å‚¨åˆ°ç»˜åˆ¶ buffer ä¸Šä¹‹å,OpenGL ES çš„ pipeline ä¹Ÿå°±ç»“æŸäº†ã€‚</p><p>æ•´ä¸ªpipelineä¸­ï¼Œçºµå‘æŒ‰ç…§æµæ°´çº¿ä½œä¸šï¼Œæ¨ªçº¿æŒ‰ç…§ç‹¬ç«‹ä½œä¸šï¼Œå¤šçº§å¹¶è¡Œã€æé«˜æ¸²æŸ“æ€§èƒ½</p><p>####ï¼ˆä¸‰ï¼‰ã€ Android EGL Overviewï¼š OpenGL ES å’Œ EGL ä»‹ç»</p><h4 id="3-1-0ã€OpenGL-ES"><a href="#3-1-0ã€OpenGL-ES" class="headerlink" title="3.1.0ã€OpenGL ES"></a>3.1.0ã€OpenGL ES</h4><p>OpenGL ESï¼ˆOpenGL for Embedded Systemsï¼‰æ˜¯ OpenGL ä¸‰ç»´å›¾å½¢APIçš„å­é›†ï¼Œé’ˆå¯¹æ‰‹æœºã€PDAå’Œæ¸¸æˆä¸»æœºç­‰åµŒå…¥å¼è®¾å¤‡è€Œè®¾è®¡ï¼Œå„æ˜¾å¡åˆ¶é€ å•†å’Œç³»ç»Ÿåˆ¶é€ å•†æ¥å®ç°è¿™ç»„ APIã€‚</p><h4 id="3-1-1ã€OpenGL-åŸºæœ¬æ¦‚å¿µ"><a href="#3-1-1ã€OpenGL-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="3.1.1ã€OpenGL åŸºæœ¬æ¦‚å¿µ"></a>3.1.1ã€OpenGL åŸºæœ¬æ¦‚å¿µ</h4><p>OpenGL çš„ç»“æ„å¯ä»¥ä»é€»è¾‘ä¸Šåˆ’åˆ†ä¸ºä¸‹é¢ 3 ä¸ªéƒ¨åˆ†ï¼š</p><p>â˜¯ å›¾å…ƒï¼ˆPrimitivesï¼‰<br>â˜¯ ç¼“å†²åŒºï¼ˆBuffersï¼‰<br>â˜¯ å…‰æ …åŒ–ï¼ˆRasterizeï¼‰<br> <strong>å›¾å…ƒï¼ˆPrimitivesï¼‰</strong><br>åœ¨ OpenGL çš„ä¸–ç•Œé‡Œï¼Œæˆ‘ä»¬åªèƒ½ç”»ç‚¹ã€çº¿ã€ä¸‰è§’å½¢è¿™ä¸‰ç§åŸºæœ¬å›¾å½¢ï¼Œè€Œå…¶å®ƒå¤æ‚çš„å›¾å½¢éƒ½å¯ä»¥é€šè¿‡ä¸‰è§’å½¢æ¥ç»„æˆã€‚æ‰€ä»¥è¿™é‡Œçš„å›¾å…ƒæŒ‡çš„å°±æ˜¯è¿™ä¸‰ç§åŸºç¡€å›¾å½¢ï¼š</p><p>â˜¯ ç‚¹ï¼šç‚¹å­˜åœ¨äºä¸‰ç»´ç©ºé—´ï¼Œåæ ‡ç”¨ï¼ˆx,y,zï¼‰è¡¨ç¤ºã€‚<br>â˜¯ çº¿ï¼šç”±ä¸¤ä¸ªä¸‰ç»´ç©ºé—´ä¸­çš„ç‚¹ç»„æˆã€‚<br>â˜¯ ä¸‰è§’å½¢ï¼šç”±ä¸‰ä¸ªä¸‰ç»´ç©ºé—´çš„ç‚¹ç»„æˆã€‚<br><strong>ç¼“å†²åŒºï¼ˆBuffersï¼‰</strong><br>OpenGL ä¸­ä¸»è¦æœ‰ 3 ç§ Bufferï¼š</p><p><strong>å¸§ç¼“å†²åŒºï¼ˆFrame Buffersï¼‰</strong> å¸§ç¼“å†²åŒºï¼š<strong>è¿™ä¸ªæ˜¯å­˜å‚¨OpenGL æœ€ç»ˆæ¸²æŸ“è¾“å‡ºç»“æœçš„åœ°æ–¹</strong>ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå›¾åƒçš„é›†åˆï¼Œä¾‹å¦‚é¢œè‰²å›¾åƒã€æ·±åº¦å›¾åƒã€æ¨¡æ¿å›¾åƒç­‰ã€‚</p><p><strong>æ¸²æŸ“ç¼“å†²åŒºï¼ˆRender Buffersï¼‰</strong> æ¸²æŸ“ç¼“å†²åŒºï¼šæ¸²æŸ“ç¼“å†²åŒºå°±æ˜¯ä¸€ä¸ªå›¾åƒï¼Œå®ƒæ˜¯ Frame Buffer çš„ä¸€ä¸ªå­é›†ã€‚</p><p><strong>ç¼“å†²åŒºå¯¹è±¡ï¼ˆBuffer Objectsï¼‰</strong> ç¼“å†²åŒºå¯¹è±¡å°±æ˜¯ç¨‹åºå‘˜è¾“å…¥åˆ° OpenGL çš„æ•°æ®ï¼Œåˆ†ä¸ºç»“æ„ç±»å’Œç´¢å¼•ç±»çš„ã€‚å‰è€…è¢«ç§°ä¸ºâ€œæ•°ç»„ç¼“å†²åŒºå¯¹è±¡â€æˆ–â€œé¡¶ç‚¹ç¼“å†²åŒºå¯¹è±¡â€ï¼ˆâ€œArray Buffer Objectâ€æˆ–â€œVertex Buff er Objectâ€ï¼‰ï¼Œå³ç”¨æ¥æè¿°æ¨¡å‹çš„æ•°ç»„ï¼Œå¦‚é¡¶ç‚¹æ•°ç»„ã€çº¹ç†æ•°ç»„ç­‰ï¼› åè€…è¢«ç§°ä¸ºâ€œç´¢å¼•ç¼“å†²åŒºå¯¹è±¡â€ï¼ˆâ€œIndex Buffer Objectâ€ï¼‰ï¼Œæ˜¯å¯¹ä¸Šè¿°æ•°ç»„çš„ç´¢å¼•ã€‚</p><p><strong>å…‰æ …åŒ–ï¼ˆRasterizeï¼‰</strong><br>åœ¨ä»‹ç»å…‰æ …åŒ–ä¹‹å‰ï¼Œé¦–å…ˆæ¥è¡¥å…… OpenGL ä¸­çš„ä¸¤ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼š</p><p>Vertex Vertex å°±æ˜¯å›¾å½¢ä¸­é¡¶ç‚¹ï¼Œä¸€ç³»åˆ—çš„é¡¶ç‚¹å°±å›´æˆäº†ä¸€ä¸ªå›¾å½¢ã€‚<br>Fragment Fragment æ˜¯ä¸‰ç»´ç©ºé—´çš„ç‚¹ã€çº¿ã€ä¸‰è§’å½¢è¿™äº›åŸºæœ¬å›¾å…ƒæ˜ å°„åˆ°äºŒç»´å¹³é¢ä¸Šçš„æ˜ å°„åŒºåŸŸï¼Œé€šå¸¸ä¸€ä¸ª Fragment å¯¹åº”äºå±å¹•ä¸Šçš„ä¸€ä¸ªåƒç´ ï¼Œä½†é«˜åˆ†è¾¨ç‡çš„å±å¹•å¯èƒ½ä¼šç”¨å¤šä¸ªåƒç´ ç‚¹æ˜ å°„åˆ°ä¸€ä¸ª Fragmentï¼Œä»¥å‡å°‘ GPU çš„å·¥ä½œã€‚<br>è€Œå…‰æ …åŒ–æ˜¯æŠŠç‚¹ã€çº¿ã€ä¸‰è§’å½¢æ˜ å°„åˆ°å±å¹•ä¸Šçš„åƒç´ ç‚¹çš„è¿‡ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-07-OpenGL-guangshanhua.png" alt="Alt text | center"></p><p>ç€è‰²å™¨ç¨‹åºï¼ˆShaderï¼‰<br>Shader ç”¨æ¥æè¿°å¦‚ä½•ç»˜åˆ¶ï¼ˆæ¸²æŸ“ï¼‰ï¼ŒGLSL æ˜¯ OpenGL çš„ç¼–ç¨‹è¯­è¨€ï¼Œå…¨ç§° OpenGL Shader Languageï¼Œå®ƒçš„è¯­æ³•ç±»ä¼¼äº C è¯­è¨€ã€‚OpenGL æ¸²æŸ“éœ€è¦ä¸¤ç§ Shaderï¼šVertex Shader å’Œ Fragment Shaderã€‚</p><p>Vertex Shader Vertex Shader å¯¹äº3Dæ¨¡å‹ç½‘æ ¼çš„æ¯ä¸ªé¡¶ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼Œä¸»è¦æ˜¯ç¡®å®šè¯¥é¡¶ç‚¹çš„æœ€ç»ˆä½ç½®ã€‚<br>Fragment Shader Fragment Shaderå¯¹å…‰æ …åŒ–ä¹‹å2Då›¾åƒä¸­çš„æ¯ä¸ªåƒç´ å¤„ç†ä¸€æ¬¡ã€‚3Dç‰©ä½“çš„è¡¨é¢æœ€ç»ˆæ˜¾ç¤ºæˆä»€ä¹ˆæ ·å°†ç”±å®ƒå†³å®šï¼Œä¾‹å¦‚ä¸ºæ¨¡å‹çš„å¯è§è¡¨é¢æ·»åŠ çº¹ç†ï¼Œå¤„ç†å…‰ç…§ã€é˜´å½±çš„å½±å“ç­‰ç­‰ã€‚</p><h4 id="3-2ã€EGL-Overview"><a href="#3-2ã€EGL-Overview" class="headerlink" title="3.2ã€EGL Overview"></a>3.2ã€EGL Overview</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-08-OpenGL-EGL-Overview.png.png" alt="Alt text | center"></p><p>What is the Direction?<br>SW : Standard API (Java, NDK Stable API)<br>HW : OpenGLES, OpenSLES, OpenMAX<br>EGLâ„¢ is an interface between Khronos rendering APIs such as OpenGL ES or OpenVG and the underlying native platform window system</p><h4 id="3-2-1ã€ä»€ä¹ˆæ˜¯-EGLï¼Ÿ"><a href="#3-2-1ã€ä»€ä¹ˆæ˜¯-EGLï¼Ÿ" class="headerlink" title="3.2.1ã€ä»€ä¹ˆæ˜¯ EGLï¼Ÿ"></a>3.2.1ã€ä»€ä¹ˆæ˜¯ EGLï¼Ÿ</h4><p>EGL æ˜¯ OpenGL ES æ¸²æŸ“ API å’Œæœ¬åœ°çª—å£ç³»ç»Ÿ(native platform window system)ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´æ¥å£å±‚ï¼Œå®ƒä¸»è¦ç”±ç³»ç»Ÿåˆ¶é€ å•†å®ç°ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-09-eglCreateWindowSurface.png" alt="Alt text | center"></p><p>EGLæä¾›å¦‚ä¸‹æœºåˆ¶ï¼š<br>ä¸è®¾å¤‡çš„åŸç”Ÿçª—å£ç³»ç»Ÿé€šä¿¡<br>æŸ¥è¯¢ç»˜å›¾è¡¨é¢çš„å¯ç”¨ç±»å‹å’Œé…ç½®<br>åˆ›å»ºç»˜å›¾è¡¨é¢<br>åœ¨OpenGL ES å’Œå…¶ä»–å›¾å½¢æ¸²æŸ“APIä¹‹é—´åŒæ­¥æ¸²æŸ“<br>ç®¡ç†çº¹ç†è´´å›¾ç­‰æ¸²æŸ“èµ„æº<br>ä¸ºäº†è®©OpenGL ESèƒ½å¤Ÿç»˜åˆ¶åœ¨å½“å‰è®¾å¤‡ä¸Šï¼Œæˆ‘ä»¬éœ€è¦EGLä½œä¸ºOpenGL ESä¸è®¾å¤‡çš„æ¡¥æ¢ã€‚</p><h4 id="3-2-2ã€ä½¿ç”¨-EGL-ç»˜å›¾çš„åŸºæœ¬æ­¥éª¤"><a href="#3-2-2ã€ä½¿ç”¨-EGL-ç»˜å›¾çš„åŸºæœ¬æ­¥éª¤" class="headerlink" title="3.2.2ã€ä½¿ç”¨ EGL ç»˜å›¾çš„åŸºæœ¬æ­¥éª¤"></a>3.2.2ã€ä½¿ç”¨ EGL ç»˜å›¾çš„åŸºæœ¬æ­¥éª¤</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-10-egl-draw-surface.png.png" alt="Alt text | center"></p><p>â˜¯  Display(EGLDisplay) æ˜¯å¯¹å®é™…æ˜¾ç¤ºè®¾å¤‡çš„æŠ½è±¡ã€‚<br>â˜¯  Surfaceï¼ˆEGLSurfaceï¼‰æ˜¯å¯¹ç”¨æ¥å­˜å‚¨å›¾åƒçš„å†…å­˜åŒºåŸŸ<br>â˜¯  FrameBuffer çš„æŠ½è±¡ï¼ŒåŒ…æ‹¬ Color Bufferï¼Œ Stencil Buffer ï¼ŒDepth Bufferã€‚Context (EGLContext) å­˜å‚¨ OpenGL ESç»˜å›¾çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ã€‚<br>ä½¿ç”¨EGLçš„ç»˜å›¾çš„ä¸€èˆ¬æ­¥éª¤ï¼š</p><p>1ã€è·å– EGL Display å¯¹è±¡ï¼šeglGetDisplay()<br>2ã€åˆå§‹åŒ–ä¸ EGLDisplay ä¹‹é—´çš„è¿æ¥ï¼šeglInitialize()<br>3ã€è·å– EGLConfig å¯¹è±¡ï¼šeglChooseConfig()<br>4ã€åˆ›å»º EGLContext å®ä¾‹ï¼šeglCreateContext()<br>5ã€åˆ›å»º EGLSurface å®ä¾‹ï¼šeglCreateWindowSurface()<br>6ã€è¿æ¥ EGLContext å’Œ EGLSurfaceï¼šeglMakeCurrent()<br>7ã€ä½¿ç”¨ OpenGL ES API ç»˜åˆ¶å›¾å½¢ï¼šgl_*()<br>8ã€åˆ‡æ¢ front buffer å’Œ back buffer é€æ˜¾ï¼šeglSwapBuffer()<br>9ã€æ–­å¼€å¹¶é‡Šæ”¾ä¸ EGLSurface å…³è”çš„ EGLContext å¯¹è±¡ï¼šeglRelease()<br>10ã€åˆ é™¤ EGLSurface å¯¹è±¡<br>11ã€åˆ é™¤ EGLContext å¯¹è±¡<br>12ã€ç»ˆæ­¢ä¸ EGLDisplay ä¹‹é—´çš„è¿æ¥</p><h4 id="3-3ã€EGLSurface-and-ANativeWindow-å…³ç³»"><a href="#3-3ã€EGLSurface-and-ANativeWindow-å…³ç³»" class="headerlink" title="3.3ã€EGLSurface and ANativeWindow å…³ç³»"></a>3.3ã€EGLSurface and ANativeWindow å…³ç³»</h4><p>OpenGL ES å®šä¹‰äº†ä¸€ä¸ªæ¸²æŸ“å›¾å½¢çš„ APIï¼Œä½†æ²¡æœ‰å®šä¹‰çª—å£ç³»ç»Ÿã€‚ä¸ºäº†è®© GLES èƒ½å¤Ÿé€‚åˆå„ç§å¹³å°ï¼ŒGLES å°†ä¸çŸ¥é“å¦‚ä½•é€šè¿‡æ“ä½œç³»ç»Ÿåˆ›å»ºå’Œè®¿é—®çª—å£çš„åº“ç»“åˆä½¿ç”¨ã€‚ç”¨äº Android çš„åº“ç§°ä¸º EGLã€‚å¦‚æœè¦ç»˜åˆ¶çº¹ç†å¤šè¾¹å½¢ï¼Œåº”ä½¿ç”¨ GLES è°ƒç”¨ï¼›å¦‚æœè¦åœ¨å±å¹•ä¸Šè¿›è¡Œæ¸²æŸ“ï¼Œåº”ä½¿ç”¨ EGL è°ƒç”¨ã€‚</p><p>åœ¨ä½¿ç”¨ GLES è¿›è¡Œä»»ä½•æ“ä½œä¹‹å‰ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ª GL ä¸Šä¸‹æ–‡ã€‚åœ¨ EGL ä¸­ï¼Œè¿™æ„å‘³ç€è¦åˆ›å»ºä¸€ä¸ª EGLContext å’Œä¸€ä¸ª EGLSurfaceã€‚GLES æ“ä½œé€‚ç”¨äºå½“å‰ä¸Šä¸‹æ–‡ï¼Œè¯¥ä¸Šä¸‹æ–‡é€šè¿‡çº¿ç¨‹å±€éƒ¨å­˜å‚¨è®¿é—®ï¼Œè€Œä¸æ˜¯ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ã€‚è¿™æ„å‘³ç€æ‚¨å¿…é¡»æ³¨æ„æ¸²æŸ“ä»£ç åœ¨å“ªä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œä»¥åŠè¯¥çº¿ç¨‹ä¸Šçš„å½“å‰ä¸Šä¸‹æ–‡ã€‚</p><h4 id="3-3-1ã€EGLSurface"><a href="#3-3-1ã€EGLSurface" class="headerlink" title="3.3.1ã€EGLSurface"></a>3.3.1ã€EGLSurface</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-11-eglsurface-anativewindwo.png" alt="Alt text | center"></p><p>EGLSurface å¯ä»¥æ˜¯ç”± EGL åˆ†é…çš„ç¦»å±ç¼“å†²åŒºï¼ˆç§°ä¸ºâ€œpbufferâ€ï¼‰ï¼Œæˆ–ç”±æ“ä½œç³»ç»Ÿåˆ†é…çš„çª—å£ã€‚EGL çª—å£ Surface é€šè¿‡ eglCreateWindowSurface() è°ƒç”¨è¢«åˆ›å»ºã€‚è¯¥è°ƒç”¨å°†â€œçª—å£å¯¹è±¡â€ä½œä¸ºå‚æ•°ï¼Œåœ¨ Android ä¸Šï¼Œè¯¥å¯¹è±¡å¯ä»¥æ˜¯ SurfaceViewã€SurfaceTextureã€SurfaceHolder æˆ– Surfaceï¼Œæ‰€æœ‰è¿™äº›å¯¹è±¡ä¸‹é¢éƒ½æœ‰ä¸€ä¸ª BufferQueueã€‚å½“æ‚¨è¿›è¡Œæ­¤è°ƒç”¨æ—¶ï¼ŒEGL å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ EGLSurface å¯¹è±¡ï¼Œå¹¶å°†å…¶è¿æ¥åˆ°çª—å£å¯¹è±¡çš„ BufferQueue çš„ç”Ÿäº§æ–¹æ¥å£ã€‚æ­¤åï¼Œæ¸²æŸ“åˆ°è¯¥ EGLSurface ä¼šå¯¼è‡´ä¸€ä¸ªç¼“å†²åŒºç¦»å¼€é˜Ÿåˆ—ã€è¿›è¡Œæ¸²æŸ“ï¼Œç„¶åæ’é˜Ÿç­‰å¾…æ¶ˆè€—æ–¹ä½¿ç”¨ã€‚ï¼ˆæœ¯è¯­â€œçª—å£â€è¡¨ç¤ºé¢„æœŸç”¨é€”ï¼Œä½†è¯·æ³¨æ„ï¼Œè¾“å‡ºå†…å®¹ä¸ä¸€å®šä¼šæ˜¾ç¤ºåœ¨æ˜¾ç¤ºå±ä¸Šã€‚ï¼‰</p><p>EGL ä¸æä¾›é”å®š/è§£é”è°ƒç”¨ï¼Œè€Œæ˜¯ç”±æ‚¨å‘å‡ºç»˜åˆ¶å‘½ä»¤ï¼Œç„¶åè°ƒç”¨ eglSwapBuffers() æ¥æäº¤å½“å‰å¸§ã€‚æ–¹æ³•åç§°æ¥è‡ªä¼ ç»Ÿçš„å‰åç¼“å†²åŒºäº¤æ¢ï¼Œä½†å®é™…å®ç°å¯èƒ½ä¼šæœ‰å¾ˆå¤§çš„ä¸åŒã€‚</p><p>ä¸€ä¸ª Surface ä¸€æ¬¡åªèƒ½ä¸ä¸€ä¸ª EGLSurface å…³è”ï¼ˆæ‚¨åªèƒ½å°†ä¸€ä¸ªç”Ÿäº§æ–¹è¿æ¥åˆ°ä¸€ä¸ª BufferQueueï¼‰ï¼Œä½†æ˜¯å¦‚æœæ‚¨é”€æ¯è¯¥ EGLSurfaceï¼Œå®ƒå°†ä¸è¯¥ BufferQueue æ–­å¼€è¿æ¥ï¼Œå¹¶å…è®¸å…¶ä»–å†…å®¹è¿æ¥åˆ°è¯¥ BufferQueueã€‚</p><p>é€šè¿‡æ›´æ”¹â€œå½“å‰â€EGLSurfaceï¼ŒæŒ‡å®šçº¿ç¨‹å¯åœ¨å¤šä¸ª EGLSurface ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚ä¸€ä¸ª EGLSurface ä¸€æ¬¡åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå¤„äºå½“å‰çŠ¶æ€ã€‚</p><p>å…³äº EGLSurface æœ€å¸¸è§çš„ä¸€ä¸ªé”™è¯¯ç†è§£å°±æ˜¯å‡è®¾å®ƒåªæ˜¯ Surface çš„å¦ä¸€æ–¹é¢ï¼ˆå¦‚ SurfaceHolderï¼‰ã€‚å®ƒæ˜¯ä¸€ä¸ªç›¸å…³ä½†ç‹¬ç«‹çš„æ¦‚å¿µã€‚æ‚¨å¯ä»¥åœ¨æ²¡æœ‰ Surface ä½œä¸ºæ”¯æŒçš„ EGLSurface ä¸Šç»˜åˆ¶ï¼Œä¹Ÿå¯ä»¥åœ¨æ²¡æœ‰ EGL çš„æƒ…å†µä¸‹ä½¿ç”¨ Surfaceã€‚EGLSurface ä»…ä¸º GLES æä¾›ä¸€ä¸ªç»˜åˆ¶çš„åœ°æ–¹ã€‚</p><h4 id="3-3-2ã€ANativeWindow"><a href="#3-3-2ã€ANativeWindow" class="headerlink" title="3.3.2ã€ANativeWindow"></a>3.3.2ã€ANativeWindow</h4><p>å…¬å¼€çš„ Surface ç±»ä»¥ Java ç¼–ç¨‹è¯­è¨€å®ç°ã€‚C/C++ ä¸­çš„åŒç­‰é¡¹æ˜¯ ANATIONWindow ç±»ï¼Œç”± Android NDK åŠå…¬å¼€ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ ANativeWindow_fromSurface() è°ƒç”¨ä» Surface è·å– ANativeWindowã€‚å°±åƒå®ƒçš„ Java è¯­è¨€åŒç­‰é¡¹ä¸€æ ·ï¼Œæ‚¨å¯ä»¥å¯¹ ANativeWindow è¿›è¡Œé”å®šã€åœ¨è½¯ä»¶ä¸­è¿›è¡Œæ¸²æŸ“ï¼Œä»¥åŠè§£é”å¹¶å‘å¸ƒã€‚</p><p>è¦ä»åŸç”Ÿä»£ç åˆ›å»º EGL çª—å£ Surfaceï¼Œå¯å°† EGLNativeWindowType çš„å®ä¾‹ä¼ é€’åˆ° eglCreateWindowSurface()ã€‚EGLNativeWindowType æ˜¯ ANativeWindow çš„åŒä¹‰è¯ï¼Œæ‚¨å¯ä»¥è‡ªç”±åœ°åœ¨å®ƒä»¬ä¹‹é—´è½¬æ¢ã€‚</p><p>åŸºæœ¬çš„â€œåŸç”Ÿçª—å£â€ç±»å‹åªæ˜¯å°è£… BufferQueue çš„ç”Ÿäº§æ–¹ï¼Œè¿™ä¸€ç‚¹å¹¶ä¸è¶³ä¸ºå¥‡ã€‚</p><h4 id="3-3-3ã€egl-surface-t-å…³ç³»å›¾"><a href="#3-3-3ã€egl-surface-t-å…³ç³»å›¾" class="headerlink" title="3.3.3ã€egl_surface_t å…³ç³»å›¾"></a>3.3.3ã€egl_surface_t å…³ç³»å›¾</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-12-egl_surface_t.png" alt="Alt text | center"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> EGLSurface <span class="title">createWindowSurface</span><span class="params">(EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">        NativeWindowType window, <span class="keyword">const</span> EGLint* <span class="comment">/*attrib_list*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    EGLint surfaceType;</span><br><span class="line">    <span class="keyword">if</span> (!(surfaceType &amp; EGL_WINDOW_BIT))</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_MATCH, EGL_NO_SURFACE);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">static_cast</span>&lt;ANativeWindow*&gt;(window)-&gt;common.magic !=</span><br><span class="line">            ANDROID_NATIVE_WINDOW_MAGIC) &#123;</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_NATIVE_WINDOW, EGL_NO_SURFACE);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    EGLint configID;</span><br><span class="line">    <span class="keyword">if</span> (getConfigAttrib(dpy, config, EGL_CONFIG_ID, &amp;configID) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> depthFormat;</span><br><span class="line">    <span class="keyword">int32_t</span> pixelFormat;</span><br><span class="line">    <span class="keyword">if</span> (getConfigFormatInfo(configID, pixelFormat, depthFormat) != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_MATCH, EGL_NO_SURFACE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">    <span class="keyword">egl_surface_t</span>* surface;</span><br><span class="line">    surface = <span class="keyword">new</span> <span class="keyword">egl_window_surface_v2_t</span>(dpy, config, depthFormat,</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;ANativeWindow*&gt;(window));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> surface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-13-framebufferwindow-surface.png" alt="Alt text | center"></p><h4 id="3-3-4ã€EGLContext-and-Thread-Local-Storage"><a href="#3-3-4ã€EGLContext-and-Thread-Local-Storage" class="headerlink" title="3.3.4ã€EGLContext and Thread Local Storage"></a>3.3.4ã€EGLContext and Thread Local Storage</h4><h4 id="3-3-4-1ã€EGLContext"><a href="#3-3-4-1ã€EGLContext" class="headerlink" title="3.3.4.1ã€EGLContext"></a>3.3.4.1ã€EGLContext</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-14-eglcontect-TLS.png" alt="Alt text | center"></p><h4 id="3-3-4-2ã€Thread-Local-Storage"><a href="#3-3-4-2ã€Thread-Local-Storage" class="headerlink" title="3.3.4.2ã€Thread Local Storage"></a>3.3.4.2ã€Thread Local Storage</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-15-eglcontect-Thread-Loacal.png.png" alt="Alt text | center"></p><h4 id="3-3-5ã€EGLImplementation-HWCompser-and-SurfaceFlinger"><a href="#3-3-5ã€EGLImplementation-HWCompser-and-SurfaceFlinger" class="headerlink" title="3.3.5ã€EGLImplementation : HWCompser and SurfaceFlinger"></a>3.3.5ã€EGLImplementation : HWCompser and SurfaceFlinger</h4><h4 id="3-3-5-1ã€HWCompser"><a href="#3-3-5-1ã€HWCompser" class="headerlink" title="3.3.5.1ã€HWCompser"></a>3.3.5.1ã€HWCompser</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-16-Android-graphics-components.png" alt="Alt text | center"></p><h4 id="3-3-5-2ã€SurfaceFlinger"><a href="#3-3-5-2ã€SurfaceFlinger" class="headerlink" title="3.3.5.2ã€SurfaceFlinger"></a>3.3.5.2ã€SurfaceFlinger</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-17-eglimp-hwrenderer-surfaceflinger.png" alt="Alt text | center"></p><p>####ï¼ˆå››ï¼‰ã€Android EGLï¼šOpenGL ES åº“å’Œ EGL åº“åŠ è½½è¿‡ç¨‹<br>åœ¨è¯¦ç»†åˆ†æ EGL ç»˜å›¾åŸºæœ¬æ­¥éª¤ å‰ï¼Œå…ˆæ¥çœ‹çœ‹OpenGL ES åº“å’Œ EGL åº“åŠ è½½è¿‡ç¨‹ã€‚</p><h5 id="4-1ã€OpenGL-ES-å’Œ-OpenGL-ES-åº“çš„åŒºåˆ«"><a href="#4-1ã€OpenGL-ES-å’Œ-OpenGL-ES-åº“çš„åŒºåˆ«" class="headerlink" title="4.1ã€OpenGL ES å’Œ OpenGL ES åº“çš„åŒºåˆ«"></a>4.1ã€OpenGL ES å’Œ OpenGL ES åº“çš„åŒºåˆ«</h5><p><strong>OpenGL ES ï¼š</strong> å®ƒæœ¬èº«åªæ˜¯ä¸€ä¸ªåè®®è§„èŒƒï¼Œå®šä¹‰äº†ä¸€å¥—å¯ä»¥ä¾›ä¸Šå±‚åº”ç”¨ç¨‹åºè¿›è¡Œè°ƒç”¨çš„ APIï¼Œå®ƒæŠ½è±¡äº† GPU çš„åŠŸèƒ½ï¼Œä½¿åº”ç”¨å¼€å‘è€…ä¸å¿…å…³å¿ƒåº•å±‚çš„ GPU ç±»å‹å’Œå…·ä½“å®ç°ã€‚<br><strong>OpenGL ES åº“ï¼š</strong>OpenGL ES åº“å°±æ˜¯ä¸Šé¢ OpenGL ES ä¸­å®šä¹‰çš„ API çš„å…·ä½“å®ç°ã€‚ç”±äºæ¯ä¸ªæ˜¾å¡åˆ¶é€ å‚å•†çš„ GPU ç¡¬ä»¶ç»“æ„ä¸åŒï¼Œä»è€Œå¯¼è‡´å„ä¸ªå‚å•†çš„OpenGL ES åº“ä¹Ÿå„ä¸ç›¸åŒï¼Œæ‰€ä»¥ Android ç³»ç»Ÿä¸­çš„ OpenGL ES åº“é€šå¸¸æ˜¯ç”±ç¡¬ä»¶å‚å•†æä¾›çš„ï¼Œé€šå¸¸å­˜æ”¾åœ¨ Android ç³»ç»Ÿä¸­çš„ /system/lib64/ï¼ˆ/system/lib/ï¼‰ ã€‚<br><strong>OpenGL ES Wrapper åº“ï¼š</strong>OpenGL ES Wrapper åº“æ˜¯ä¸€ä¸ªå¯¹ OpenGL ES API è¿›è¡Œå°è£…çš„ä¸€ä¸ªåŒ…è£¹åº“ï¼Œå®ƒå‘ä¸Šä¸ºåº”ç”¨ç¨‹åºæä¾›äº†æ ‡å‡†çš„ OpenGL ES APIï¼Œå‘ä¸‹å¯ä»¥å’Œä¸åŒå‚å•†å®ç°çš„ OpenGL ES åº“è¿›è¡Œç»‘å®šï¼Œå°† OpenGL ES API å’Œå¯¹åº”çš„å®ç°å‡½æ•°ä¸€ä¸€ç»‘å®šåœ¨ä¸€èµ·ã€‚<br>å¹¶ä¸”ï¼ŒOpenGL ES åº“çš„å®ç°åˆ†ä¸ºï¼š<br><strong>è½¯ä»¶æ¨¡æ‹Ÿå®ç°</strong><br><strong>ç¡¬ä»¶åŠ é€Ÿå®ç°</strong><br>ç°åœ¨ï¼Œå› ä¸ºæˆ‘ä»¬ Android æ‰‹æœºä¸­çš„ Soc ç‰‡ä¸ŠèŠ¯ç‰‡ä¸­éƒ½é›†æˆäº† GPU æ¨¡å—ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„å°±æ˜¯ç¡¬ä»¶åŠ é€Ÿå®ç°çš„ OpenGL ES åº“ã€‚ä½†æ˜¯ï¼Œåƒ Android Emulator ä¸­çš„ Android ç³»ç»Ÿï¼Œå¦‚æœä¸æ”¯æŒå°† OpenGL ES API æŒ‡ä»¤é‡å®šå‘åˆ°ä¸»æœºç³»ç»Ÿçš„ GPU åŠ é€Ÿæ‰§è¡Œçš„è¯ï¼Œå®ƒæ‰€é‡‡ç”¨çš„ OpenGL ES åº“å°±æ˜¯è½¯ä»¶æ¨¡æ‹Ÿå®ç°çš„ã€‚</p><p>è¡¥å……ï¼šå¦‚å‰é¢å°èŠ‚ã€OpenGL ES å’Œ EGL ä»‹ç»ã€‘ä¸­ä»‹ç»çš„ï¼ŒEGL ä¹Ÿæ˜¯ä¸€å¥— APIï¼Œå®ƒçš„å®ç°ä¹Ÿéœ€è¦ç³»ç»Ÿå‚å•†æ¥æä¾›ã€‚ç³»ç»Ÿå‚å•†é€šå¸¸ä¼šå°†è¿™ä¸¤å¥— API çš„å®ç°å°è£…åœ¨ä¸€ä¸ªå…±äº«é“¾æ¥åº“ä¸­ï¼Œä½†æ˜¯æ ¹æ®æœ€æ–°çš„æ ‡å‡†ï¼ŒOpenGL ES API å®ç°çš„å…±äº«é“¾æ¥åº“å’Œ EGL API å®ç°çš„å…±äº«é“¾æ¥åº“æ˜¯ç‹¬ç«‹åˆ†å¼€çš„ï¼Œä¾‹å¦‚  Nexus 9 å¹³æ¿è®¾å¤‡ä¸­ OpenGL ES å’Œ EGL API å®ç°åº“å°±æ˜¯ç‹¬ç«‹åˆ†å¼€çš„ã€‚</p><h5 id="4-2ã€Android-ä¸­-OpenGL-ES-è½¯ä»¶å±‚æ¬¡æ ˆ"><a href="#4-2ã€Android-ä¸­-OpenGL-ES-è½¯ä»¶å±‚æ¬¡æ ˆ" class="headerlink" title="4.2ã€Android ä¸­ OpenGL ES è½¯ä»¶å±‚æ¬¡æ ˆ"></a>4.2ã€Android ä¸­ OpenGL ES è½¯ä»¶å±‚æ¬¡æ ˆ</h5><p>æŒ‰ç…§åˆ†å±‚ç†å¿µçš„è®¾è®¡ï¼ŒAndroid ä¸­çš„ OpenGL ES å®ç°ä¹Ÿæ˜¯å±‚æ¬¡è®¾è®¡çš„ï¼Œå½¢æˆä¸€ä¸ªè½¯ä»¶å±‚æ¬¡æ ˆã€‚æœ€ä¸Šé¢çš„æ˜¯ Java å±‚ï¼Œæ¥ç€ä¸‹é¢æ˜¯ JNI å±‚ï¼Œå†è°ƒç”¨ä¸‹é¢çš„ wrapper å±‚ï¼Œwrapper å±‚ä¸‹é¢åˆ™æ˜¯ OpenGL ES API çš„å…·ä½“è½¯ä»¶å®æˆ–è€…ç¡¬ä»¶å®ç°äº†ã€‚æ•´ä¸ª OpenGL è½¯ä»¶å±‚æ¬¡æ ˆçš„è°ƒç”¨å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-18-OpenGL_ES_call_graph_so.png" alt="Alt text | center"></p><h5 id="4-3ã€OpenGL-ES-EGL-Wrapper-åº“"><a href="#4-3ã€OpenGL-ES-EGL-Wrapper-åº“" class="headerlink" title="4.3ã€OpenGL ES/EGL Wrapper åº“"></a>4.3ã€OpenGL ES/EGL Wrapper åº“</h5><p>å‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡ OpenGL ES/EGL Wrapper åº“æ˜¯ä¸€ä¸ªå°† OpenGL ES API å’Œ OpenGL ES API å…·ä½“å®ç°ç»‘å®šåœ¨ä¸€èµ·çš„åº“ï¼Œå®ƒå¯¹åº”çš„æºç è·¯å¾„æ˜¯ï¼š/frameworks/native/opengl/libs/ï¼Œå…¶ä¸­:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libGLESv1_CM.soï¼šOpenGL ES <span class="number">1.</span>x API çš„ Wrapper åº“</span><br><span class="line">libGLESv2.soï¼šOpenGL ES <span class="number">2.0</span> çš„ Wrapper åº“</span><br><span class="line">libGLESv3.soï¼šOpenGL ES <span class="number">3.0</span> çš„ Wrapper åº“</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å› ä¸º OpenGL ES 3.0 API æ˜¯å…¼å®¹ OpenGL ES 2.0 API çš„ï¼Œæ‰€ä»¥ libGLESv2.so åº“æœ¬è´¨ä¸Šå’Œ libGLESv3.so åº“æ˜¯ä¸€æ ·çš„ã€‚</p><h5 id="4-3-1ã€OpenGL-ES-EGL-å®ç°åº“"><a href="#4-3-1ã€OpenGL-ES-EGL-å®ç°åº“" class="headerlink" title="4.3.1ã€OpenGL ES/EGL å®ç°åº“"></a>4.3.1ã€OpenGL ES/EGL å®ç°åº“</h5><p>å¦‚æœAndroidç³»ç»Ÿå¹³å°æ”¯æŒ OpenGL ES ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ï¼Œé‚£ä¹ˆ OpenGL ES/EGL å®ç°åº“ç”±ç³»ç»Ÿå‚å•†ä»¥.soçš„å…±äº«é“¾æ¥åº“çš„å½¢å¼æä¾›ï¼Œä¾‹å¦‚ï¼Œé«˜é€šçš„å®ç°ï¼šsystem\vendor\lib\egl</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libEGL_adreno.so </span><br><span class="line">libGLESv1_CM_adreno.so</span><br><span class="line">libGLESv2_adreno.so</span><br></pre></td></tr></table></figure><p>å¦‚æœAndroidç³»ç»Ÿå¹³å°ä¸æ”¯æŒ OpenGL ES ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šé»˜è®¤å¯ç”¨è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“ï¼Œè¿™æ—¶ OpenGL ES/EGL å®ç°åº“å°±æ˜¯ç”± AOSP æä¾›ï¼Œé“¾æ¥åº“çš„å­˜åœ¨çš„è·¯å¾„ä¸ºï¼š /system/lib64/egl/libGLES_android.soã€‚è€Œ libGLES_android.so åº“åœ¨ Android 7.1 ç³»ç»Ÿå¯¹åº”çš„å®ç°æºç è·¯å¾„ä¸ºï¼š/frameworks/native/opengl/libagl/ ã€‚</p><h5 id="4-3-2ã€Android-7-1-ä¸­åŠ è½½-OpenGL-ES-åº“çš„è¿‡ç¨‹"><a href="#4-3-2ã€Android-7-1-ä¸­åŠ è½½-OpenGL-ES-åº“çš„è¿‡ç¨‹" class="headerlink" title="4.3.2ã€Android 7.1 ä¸­åŠ è½½ OpenGL ES åº“çš„è¿‡ç¨‹"></a>4.3.2ã€Android 7.1 ä¸­åŠ è½½ OpenGL ES åº“çš„è¿‡ç¨‹</h5><p>Android ä¸­å›¾å½¢æ¸²æŸ“æ‰€é‡‡ç”¨çš„æ–¹å¼ï¼ˆç¡¬ä»¶ or è½¯ä»¶ï¼‰æ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨ä¹‹ååŠ¨æ€ç¡®å®šçš„ï¼Œè€Œç¡®å®šæ¸²æŸ“æ–¹å¼çš„è¿™ä¸ªæºç æ–‡ä»¶å°±æ˜¯ /frameworks/native/opengl/libs/EGL/Loader.cpp ã€‚</p><h5 id="4-3-2-1ã€-Android-7-1-OpenGL-ES-åº“å’Œ-EGL-åº“åŠ è½½è¯´æ˜"><a href="#4-3-2-1ã€-Android-7-1-OpenGL-ES-åº“å’Œ-EGL-åº“åŠ è½½è¯´æ˜" class="headerlink" title="4.3.2.1ã€ Android 7.1 OpenGL ES åº“å’Œ EGL åº“åŠ è½½è¯´æ˜"></a>4.3.2.1ã€ Android 7.1 OpenGL ES åº“å’Œ EGL åº“åŠ è½½è¯´æ˜</h5><p><a href="http://www.2net.co.uk/tutorial/android-egl-cgf-is-dead" target="_blank" rel="noopener">How Android finds OpenGL libraries, and the death of egl.cfg</a> è¿™ç¯‡æ–‡ç« ä¸­æåˆ°äº†éå¸¸å…³é”®çš„ä¸€ç‚¹ï¼Œå°±æ˜¯ä» Android Kitkat 4.4 ä¹‹åï¼ŒAndroid ä¸­åŠ è½½ OpenGL ES/EGL åº“çš„æ–¹æ³•å‘ç”Ÿäº†å˜åŒ–äº†ï¼ˆä½†æ˜¯æ•´ä¸ªåŠ è½½è¿‡ç¨‹éƒ½æ˜¯ç”± /frameworks/native/opengl/libs/EGL/Loader.cpp ç¨‹åºæ‰€å†³å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Loader.cpp æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–ï¼‰ã€‚</p><p>åœ¨ Android 4.4 ä¹‹å‰ï¼ŒåŠ è½½ OpenGL ES åº“æ˜¯ç”± /system/lib/egl/egl.cfg æ–‡ä»¶æ‰€å†³å®šçš„ï¼Œé€šè¿‡è¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶æ¥ç¡®å®šæ˜¯åŠ è½½ OpenGL ES è½¯ä»¶æ¨¡æ‹Ÿå®ç°çš„åº“ï¼Œè¿˜æ˜¯OpenGL ES ç¡¬ä»¶åŠ é€Ÿå®ç°çš„åº“ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨Android 4.4 ä¹‹åï¼ŒAndroid ä¸å†é€šè¿‡è¯»å– egl.cfg é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥åŠ è½½ OpenGL ES åº“ï¼Œæ–°çš„åŠ è½½ OpenGL ES åº“çš„è§„åˆ™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>ä» /system/lib/egl æˆ–è€… /system/vendor/lib/egl/ ç›®å½•ä¸‹åŠ è½½ libGLES.so åº“æ–‡ä»¶æˆ–è€… libEGL_vendor.soï¼ŒlibGLESv1_CM_vendor.soï¼ŒlibGLESv2<em>vendor.so åº“æ–‡ä»¶ã€‚<br>ä¸ºäº†å‘ä¸‹å…¼å®¹æ—§çš„åº“çš„å‘½åæ–¹å¼ï¼ŒåŒæ ·ä¹Ÿä¼šåŠ è½½ /system/lib/egl æˆ–è€… /vendor/lib/egl/ ç›®å½•ä¸‹çš„ libGLES</em><em>.so æˆ–è€… libEGL_</em>.soï¼ŒlibGLESv1CM<em>.soï¼ŒlibGLESv2_</em>.so åº“æ–‡ä»¶ã€‚</p><h5 id="4-3-2-2ã€ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“-or-è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“ï¼Ÿ"><a href="#4-3-2-2ã€ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“-or-è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“ï¼Ÿ" class="headerlink" title="4.3.2.2ã€ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ or è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“ï¼Ÿ"></a>4.3.2.2ã€ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ or è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“ï¼Ÿ</h5><p>å‰é¢æˆ‘ä»¬æåˆ° OpenGL ES åº“çš„å®ç°æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ç¡¬ä»¶åŠ é€Ÿå®ç°ï¼Œä¸€ç§æ˜¯è½¯ä»¶æ¨¡æ‹Ÿå®ç°ï¼Œé‚£ä¹ˆç³»ç»Ÿæ˜¯æ€ä¹ˆç¡®å®šåŠ è½½é‚£ä¸€ç§ OpenGL ES åº“çš„å‘¢ï¼Ÿ</p><p>Android 7.1 æºç ä¸­è´Ÿè´£åŠ è½½ OpenGL ES/EGL åº“éƒ¨åˆ†çš„ä»£ç ä½äºï¼š/frameworks/native/opengl/libs/EGL/Loader.cpp æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­ä»£ç çš„ä¸»è¦å…¥å£å‡½æ•°æ˜¯ Loader::open() å‡½æ•°ï¼Œè€Œå†³å®šåŠ è½½ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“åº“è¿˜æ˜¯è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“åº“ä¸»è¦æ¶‰åŠåˆ°ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setEmulatorGlesValue()</span><br><span class="line">checkGlesEmulationStatus()</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°±æ¥ç®€è¦çš„åˆ†æä¸€ä¸‹ Android ç³»ç»Ÿæ˜¯å¦‚ä½•é€‰æ‹©åŠ è½½ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“åº“è¿˜æ˜¯è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“åº“ï¼š</p><p>é¦–å…ˆï¼ŒLoader::open() å…¥å£å‡½æ•°ä¼šè°ƒç”¨ setEmulatorGlesValue() ä» property å±æ€§ç³»ç»Ÿä¸­è·å–ä¸€äº›å±æ€§å€¼æ¥åˆ¤æ–­å½“å‰ Android ç³»ç»Ÿæ˜¯å¦åœ¨ Emulator ç¯å¢ƒä¸­è¿è¡Œï¼Œå¹¶æ ¹æ®è¯»å–å‡ºæ¥çš„ä¿¡æ¯æ¥é‡æ–°è®¾ç½®æ–°çš„å±æ€§é”®å€¼å¯¹ï¼ŒsetEmulatorGlesValue() å‡½æ•°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/native/opengl/libs/EGL/Loader.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setEmulatorGlesValue</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">char</span> prop[PROPERTY_VALUE_MAX];</span><br><span class="line">     property_get(<span class="string">"ro.kernel.qemu"</span>, prop, <span class="string">"0"</span>); <span class="comment">//è¯»å– ro.kernel.qemu å±æ€§å€¼ï¼Œåˆ¤æ–­Androidç³»ç»Ÿæ˜¯å¦è¿è¡Œåœ¨ qemu ä¸­</span></span><br><span class="line">     <span class="keyword">if</span> (atoi(prop) != <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">     property_get(<span class="string">"ro.kernel.qemu.gles"</span>, prop, <span class="string">"0"</span>); <span class="comment">//è¯»å– ro.kernel.qemu.gles å±æ€§å€¼ï¼Œåˆ¤æ–­ qemu ä¸­ OpenGL ES åº“çš„å®ç°æ–¹å¼</span></span><br><span class="line">     <span class="keyword">if</span> (atoi(prop) == <span class="number">1</span>) &#123;</span><br><span class="line">         ALOGD(<span class="string">"Emulator has host GPU support, qemu.gles is set to 1."</span>);</span><br><span class="line">         property_set(<span class="string">"qemu.gles"</span>, <span class="string">"1"</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">// for now, checking the following</span></span><br><span class="line">     <span class="comment">// directory is good enough for emulator system images</span></span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">char</span>* vendor_lib_path =</span><br><span class="line"> #<span class="keyword">if</span> defined(__LP64__)</span><br><span class="line">         <span class="string">"/vendor/lib64/egl"</span>;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">         <span class="string">"/vendor/lib/egl"</span>;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">bool</span> has_vendor_lib = (access(vendor_lib_path, R_OK) == <span class="number">0</span>);</span><br><span class="line">     <span class="comment">//å¦‚æœå­˜åœ¨ vendor_lib_path è¿™ä¸ªè·¯å¾„ï¼Œé‚£ä¹ˆå°±è¯´æ˜å‚å•†æä¾›äº† OpenGL ESåº“è‡ªå·±çš„è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“åº“ï¼Œè€Œä¸æ˜¯ Android ç³»ç»Ÿè‡ªå·±ç¼–è¯‘å¾—åˆ°çš„è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“åº“</span></span><br><span class="line">     <span class="keyword">if</span> (has_vendor_lib) &#123;</span><br><span class="line">         ALOGD(<span class="string">"Emulator has vendor provided software renderer, qemu.gles is set to 2."</span>);</span><br><span class="line">         property_set(<span class="string">"qemu.gles"</span>, <span class="string">"2"</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         ALOGD(<span class="string">"Emulator without GPU support detected. "</span></span><br><span class="line">               <span class="string">"Fallback to legacy software renderer, qemu.gles is set to 0."</span>);</span><br><span class="line">         property_set(<span class="string">"qemu.gles"</span>, <span class="string">"0"</span>); <span class="comment">//æœ€åï¼Œé»˜è®¤é‡‡å–çš„æ˜¯æ–¹æ¡ˆå°±æ˜¯è°ƒç”¨ä¼ ç»Ÿçš„Androidç³»ç»Ÿè‡ªå·±ç¼–è¯‘å¾—åˆ°è½¯ä»¶æ¨¡æ‹Ÿæ¸²æŸ“åº“</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨ load_system_driver() å‡½æ•°ä¸­ï¼Œå†…éƒ¨ç±» MatchFile ç±»ä¸­ä¼šè°ƒç”¨ checkGlesEmulationStatus() å‡½æ•°æ¥æ£€æŸ¥ Android ç³»ç»Ÿæ˜¯å¦è¿è¡Œåœ¨æ¨¡æ‹Ÿå™¨ä¸­ï¼Œä»¥åŠåœ¨æ¨¡æ‹Ÿå™¨ä¸­æ˜¯å¦å¯ç”¨äº†ä¸»æœºç¡¬ä»¶åŠ é€Ÿçš„åŠŸèƒ½ï¼Œç„¶åæ ¹æ® checkGlesEmulationStatus() å‡½æ•°çš„è¿”å›çŠ¶æ€å€¼æ¥ç¡®å®šè¦åŠ è½½å…±äº«é“¾æ¥åº“çš„æ–‡ä»¶ç»å¯¹è·¯å¾„ã€‚load_system_driver() å’Œ checkGlesEmulationStatus() å‡½æ•°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/native/opengl/libs/EGL/Loader.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">load_system_driver</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* kind)</span> </span>&#123;</span><br><span class="line">     ATRACE_CALL();</span><br><span class="line">     <span class="class"><span class="keyword">class</span> <span class="title">MatchFile</span> &#123;</span></span><br><span class="line">     <span class="keyword">public</span>:</span><br><span class="line">         <span class="comment">//è¿™ä¸ªå‡½æ•°ä½œç”¨æ˜¯è¿”å›éœ€è¦åŠ è½½æ‰“å¼€çš„ OpenGL ES å’Œ EGL API å®ç°åº“æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">         <span class="function"><span class="keyword">static</span> String8 <span class="title">find</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* kind)</span> </span>&#123;</span><br><span class="line">             String8 result;</span><br><span class="line">             <span class="keyword">int</span> emulationStatus = checkGlesEmulationStatus(); <span class="comment">//æ£€æŸ¥ Android ç³»ç»Ÿæ˜¯å¦è¿è¡Œåœ¨æ¨¡æ‹Ÿå™¨ä¸­ï¼Œä»¥åŠåœ¨æ¨¡æ‹Ÿå™¨ä¸­æ˜¯å¦å¯ç”¨äº†ä¸»æœºç¡¬ä»¶åŠ é€Ÿçš„åŠŸèƒ½</span></span><br><span class="line">             <span class="keyword">switch</span> (emulationStatus) &#123;</span><br><span class="line">             <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">//Android è¿è¡Œåœ¨æ¨¡æ‹Ÿå™¨ä¸­ï¼Œä½¿ç”¨ç³»ç»Ÿè½¯ä»¶æ¨¡æ‹Ÿå®ç°çš„ OpenGL ES API åº“ libGLES_android.so</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__)</span></span><br><span class="line">                 result.setTo(<span class="string">"/system/lib64/egl/libGLES_android.so"</span>);</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                 result.setTo(<span class="string">"/system/lib/egl/libGLES_android.so"</span>);</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                 <span class="keyword">return</span> result;</span><br><span class="line">             <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// Android è¿è¡Œåœ¨æ¨¡æ‹Ÿå™¨ä¸­ï¼Œé€šè¿‡ä¸»æœºç³»ç»Ÿä¸­å®ç° OpenGL ES åŠ é€Ÿæ¸²æŸ“ï¼Œé€šè¿‡ libGLES_emulation.so åº“å°†  OpenGL ES API æŒ‡ä»¤é‡å®šå‘åˆ° host ä¸­æ‰§è¡Œ</span></span><br><span class="line">                 <span class="comment">// Use host-side OpenGL through the "emulation" library</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__)</span></span><br><span class="line">                 result.appendFormat(<span class="string">"/system/lib64/egl/lib%s_emulation.so"</span>, kind);</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                 result.appendFormat(<span class="string">"/system/lib/egl/lib%s_emulation.so"</span>, kind);</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                 <span class="keyword">return</span> result;</span><br><span class="line">             <span class="keyword">default</span>:</span><br><span class="line">                 <span class="comment">// Not in emulator, or use other guest-side implementation</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">    </span><br><span class="line">             <span class="comment">// å¦‚æœä¸æ˜¯ä¸Šé¢ä¸¤ç§æƒ…å†µï¼Œå°±æ ¹æ®åº“çš„å‘½åè§„åˆ™å»æ‰¾åˆ°å‚å•†å®ç°åº“æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">             String8 pattern;</span><br><span class="line">             pattern.appendFormat(<span class="string">"lib%s"</span>, kind);</span><br><span class="line">             <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> searchPaths[] = &#123;</span><br><span class="line"> #<span class="keyword">if</span> defined(__LP64__)</span><br><span class="line">                 <span class="string">"/vendor/lib64/egl"</span>,</span><br><span class="line">                 <span class="string">"/system/lib64/egl"</span></span><br><span class="line"> #<span class="keyword">else</span></span><br><span class="line">                 <span class="string">"/vendor/lib/egl"</span>,</span><br><span class="line">                 <span class="string">"/system/lib/egl"</span></span><br><span class="line"> #endif</span><br><span class="line">             &#125;;</span><br><span class="line">                </span><br><span class="line">             ......</span><br><span class="line">     &#125;</span><br><span class="line">        </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢ä»£ç çš„åŠŸèƒ½å°±æ˜¯ï¼Œé¦–å…ˆåˆ¤æ–­ Android æ˜¯å¦åœ¨ qemu è™šæ‹Ÿæœºä¸­è¿è¡Œï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥å»åŠ è½½å‚å•†å­˜æ”¾åº“çš„è·¯å¾„ä¸­å»åŠ è½½ OpenGL ES å®ç°åº“ï¼ˆä¸ç®¡æ˜¯ç¡¬ä»¶åŠ é€Ÿå®ç°çš„ï¼Œè¿˜æ˜¯è½¯ä»¶æ¨¡æ‹Ÿå®ç°çš„ï¼‰ï¼›å¦‚æœæ˜¯åœ¨ qemu ä¸­è¿è¡Œï¼Œé‚£ä¹ˆå°±è¦æ ¹æ®è¿”å›çš„ emulationStatus å€¼ æ¥ç¡®å®šæ˜¯åŠ è½¯ä»¶æ¨¡æ‹Ÿå®ç°çš„ OpenGL ES API åº“ libGLES_android.soï¼Œè¿˜æ˜¯åŠ è½½ libGLES_emulation.soåº“å°† OpenGL ES æŒ‡ä»¤é‡å®šå‘åˆ° Host ç³»ç»Ÿä¸­å»æ‰§è¡Œã€‚</p><h5 id="4-3-3ã€OpenGL-ES-EGL-åº“åŠ è½½å’Œè§£æè¿‡ç¨‹"><a href="#4-3-3ã€OpenGL-ES-EGL-åº“åŠ è½½å’Œè§£æè¿‡ç¨‹" class="headerlink" title="4.3.3ã€OpenGL ES/EGL åº“åŠ è½½å’Œè§£æè¿‡ç¨‹"></a>4.3.3ã€OpenGL ES/EGL åº“åŠ è½½å’Œè§£æè¿‡ç¨‹</h5><p>æ­£å¦‚å‰é¢åˆ†æï¼Œåœ¨è¿›è¡Œ OpenGL ç¼–ç¨‹æ—¶ï¼Œæœ€å…ˆå¼€å§‹éœ€è¦è·å– Displayï¼Œè¿™å°†è°ƒç”¨ eglgGetDisplay() å‡½æ•°è¢«è°ƒç”¨ã€‚åœ¨ eglGetDisplay() é‡Œåˆ™ä¼šè°ƒç”¨ egl_init_drivers() åˆå§‹åŒ–é©±åŠ¨ï¼šè£…è½½å„ä¸ªåº“è¿›è¡Œè§£æï¼Œå°† OpenGL ES/EGL API å‡½æ•°æ¥å£å’Œå…·ä½“çš„å®ç°ç»‘å®šåœ¨ä¸€èµ·ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ egl_connection_t ç±»å‹çš„å…¨å±€å˜é‡ gEGLImpl çš„ç»“æ„ä½“çš„æˆå‘˜å˜é‡ä¸­ã€‚</p><p>ä¸‹é¢ä»¥ SurfaceFlinger è¿›ç¨‹init()ä¸ºä¾‹è¿›è¡Œåˆ†æï¼Œæ•´ä¸ª OpenGL ES/EGL åº“çš„åŠ è½½å’Œè§£ææµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-19-SF_init.png" alt="Alt text | center"></p><p>è¿™é‡Œé€šè¿‡è°ƒç”¨ EGL åº“çš„ eglGetDisplay() è·å¾— Displayã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libs\EGL\eglApi.cpp]</span><br><span class="line"><span class="function">EGLDisplay <span class="title">eglGetDisplay</span><span class="params">(EGLNativeDisplayType display)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (egl_init_drivers() == EGL_FALSE) &#123;</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_PARAMETER, EGL_NO_DISPLAY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EGLDisplay dpy = <span class="keyword">egl_display_t</span>::getFromNativeDisplay(display);</span><br><span class="line">    <span class="keyword">return</span> dpy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°EGLBoolean egl_init_drivers()å°±æ˜¯è´Ÿè´£OpenGLåº“çš„åŠ è½½ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libs\EGL\egl.cpp]</span><br><span class="line"><span class="function">EGLBoolean <span class="title">egl_init_drivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    EGLBoolean res;</span><br><span class="line">    pthread_mutex_lock(&amp;sInitDriverMutex);</span><br><span class="line">    res = egl_init_drivers_locked();</span><br><span class="line">    pthread_mutex_unlock(&amp;sInitDriverMutex);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸ºä¿è¯å¤šçº¿ç¨‹è®¿é—®çš„å®‰å…¨æ€§ï¼Œä½¿ç”¨çº¿ç¨‹é”æ¥æ”¾å®Œå¦ä¸€ä¸ªæ¥å£å‡½æ•°egl_init_drivers_locked()<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libs\EGL\egl.cpp]</span><br><span class="line"><span class="comment">//åœ¨è¯¥æ–‡ä»¶èµ·å§‹ä½ç½®å®šä¹‰çš„å…¨å±€å˜é‡</span></span><br><span class="line"><span class="keyword">egl_connection_t</span> gEGLImpl; <span class="comment">// æè¿°EGLå®ç°å†…å®¹çš„ç»“æ„ä½“å¯¹è±¡</span></span><br><span class="line"><span class="keyword">gl_hooks_t</span> gHooks[<span class="number">2</span>]; <span class="comment">// gl_hooks_t æ˜¯åŒ…å« OpenGL ES API å‡½æ•°å£°æ˜å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">gl_hooks_t</span> gHooksNoContext;</span><br><span class="line"><span class="keyword">pthread_key_t</span> gGLWrapperKey = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> EGLBoolean <span class="title">egl_init_drivers_locked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sEarlyInitState) &#123;</span><br><span class="line">        <span class="comment">// initialized by static ctor. should be set here.</span></span><br><span class="line">        <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾—åˆ° Loader å¯¹è±¡å•ä¾‹</span></span><br><span class="line">    <span class="comment">// get our driver loader</span></span><br><span class="line">    Loader&amp; loader(Loader::getInstance());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  gEGLImple æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ•°æ®ç±»å‹ä¸º egl_connection_t ç»“æ„ä½“ç±»å‹</span></span><br><span class="line">    <span class="comment">// dynamically load our EGL implementation</span></span><br><span class="line">    <span class="keyword">egl_connection_t</span>* cnx = &amp;gEGLImpl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cnx-&gt;dso æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª (void *)ç±»å‹çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘çš„å¯¹è±¡æ˜¯ EGL å…±äº«åº“æ‰“å¼€ä¹‹åçš„å¥æŸ„</span></span><br><span class="line">    <span class="keyword">if</span> (cnx-&gt;dso == <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="comment">// &gt;= å°†cnxä¸­çš„ hooks æ•°ç»„ä¸­æŒ‡å‘OpenGL ES API å‡½æ•°æŒ‡é’ˆç»“æ„ä½“æŒ‡çš„æ•°ç»„æˆå‘˜ï¼Œç”¨ gHooks ä¸­çš„æˆå‘˜çš„åœ°å€å»åˆå§‹åŒ–</span></span><br><span class="line">        <span class="comment">//ä¹Ÿå°±æ˜¯è¯´ gEGLImpl ä¸­ hook æ•°ç»„æŒ‡å‘ gHooks æ•°ç»„ï¼Œæœ€ç»ˆæŒ‡å‘åŒä¸€ä¸ª OpenGL ES API å‡½æ•°æŒ‡é’ˆçš„å®ç°</span></span><br><span class="line">        cnx-&gt;hooks[<span class="keyword">egl_connection_t</span>::GLESv1_INDEX] =</span><br><span class="line">            &amp;gHooks[<span class="keyword">egl_connection_t</span>::GLESv1_INDEX];</span><br><span class="line">        cnx-&gt;hooks[<span class="keyword">egl_connection_t</span>::GLESv2_INDEX] =</span><br><span class="line">            &amp;gHooks[<span class="keyword">egl_connection_t</span>::GLESv2_INDEX];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &gt;= æœ€åé€šè¿‡loaderå¯¹è±¡çš„openå‡½æ•°å¼€å§‹åŠ è½½ OpenGL ES å’Œ EGL wrapper åº“</span></span><br><span class="line">        cnx-&gt;dso = loader.open(cnx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cnx-&gt;dso ? EGL_TRUE : EGL_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæœ‰ä¸€ä¸ªéå¸¸å…³é”®çš„ egl_connection_t æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå…¨å±€å˜é‡ gEGLImplï¼Œå½“ç¬¬ä¸€æ¬¡åˆå§‹åŒ–åŠ è½½ OpenGL ES å®ç°åº“å’Œ EGL å®ç°åº“æ—¶ï¼Œè¿˜éœ€è¦å°† gEGLImpl ä¸­çš„ hooks æ•°ç»„ä¸­çš„ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå…¨å±€çš„ gl_hooks_t æ•°ç»„ gHooksï¼ˆè¿™å°±æ˜¯ä¸¤ä¸ªæŒ‡é’ˆé’©å­ï¼Œæœ€ç»ˆåˆå§‹åŒ–å®Œæˆåå°†åˆ†åˆ«å‹¾ä½ OpenGL ES 1.0 å’Œ OpenGL ES 2.0 çš„å®ç°åº“ï¼‰ï¼Œæ¥ç€è°ƒç”¨ Loader ç±»çš„å®ä¾‹çš„ open() å‡½æ•°å®Œæˆä» OpenGL ES å®ç°åº“ä¸­å®Œæˆç¬¦å·è§£æå·¥ä½œã€‚</p><p>Loader::open() å‡½æ•°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[/frameworks/native/opengl/libs/EGL/Loader.cpp]</span><br><span class="line"><span class="comment">// &gt;= Loader ç±»å¯¹è±¡æ„é€ å®Œæˆåï¼Œå°±åœ¨ /EGL/egl.cpp æ–‡ä»¶ä¸­çš„ egl_init_drivers_locked() ä¸­è¢«è°ƒç”¨</span></span><br><span class="line"><span class="keyword">void</span>* Loader::open(<span class="keyword">egl_connection_t</span>* cnx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>* dso;</span><br><span class="line">    <span class="keyword">driver_t</span>* hnd = <span class="number">0</span>;</span><br><span class="line">    setEmulatorGlesValue();</span><br><span class="line">    dso = load_driver(<span class="string">"GLES"</span>, cnx, EGL | GLESv1_CM | GLESv2);</span><br><span class="line">    <span class="keyword">if</span> (dso) &#123;</span><br><span class="line">        hnd = <span class="keyword">new</span> <span class="keyword">driver_t</span>(dso);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Always load EGL first</span></span><br><span class="line">        dso = load_driver(<span class="string">"EGL"</span>, cnx, EGL);</span><br><span class="line">        <span class="keyword">if</span> (dso) &#123;</span><br><span class="line">            hnd = <span class="keyword">new</span> <span class="keyword">driver_t</span>(dso);</span><br><span class="line">            hnd-&gt;<span class="built_in">set</span>( load_driver(<span class="string">"GLESv1_CM"</span>, cnx, GLESv1_CM), GLESv1_CM );</span><br><span class="line">            hnd-&gt;<span class="built_in">set</span>( load_driver(<span class="string">"GLESv2"</span>,    cnx, GLESv2),    GLESv2 );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    cnx-&gt;libEgl   = load_wrapper(EGL_WRAPPER_DIR <span class="string">"/libEGL.so"</span>);</span><br><span class="line">    cnx-&gt;libGles2 = load_wrapper(EGL_WRAPPER_DIR <span class="string">"/libGLESv2.so"</span>);</span><br><span class="line">    cnx-&gt;libGles1 = load_wrapper(EGL_WRAPPER_DIR <span class="string">"/libGLESv1_CM.so"</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span>*)hnd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>open() å‡½æ•°ä¸»è¦è´Ÿè´£ OpenGL ES åº“åŠ è½½å‰çš„å‡†å¤‡å·¥ä½œï¼Œå…·ä½“çš„åŠ è½½ç»†èŠ‚ï¼Œåˆ™æ˜¯é€šè¿‡è°ƒç”¨ load_driver() å»å®Œæˆçš„ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[/frameworks/native/opengl/libs/EGL/Loader.cpp]</span><br><span class="line">oid *Loader::load_driver(<span class="keyword">const</span> <span class="keyword">char</span>* kind,</span><br><span class="line">                          <span class="keyword">egl_connection_t</span>* cnx, <span class="keyword">uint32_t</span> mask)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>* dso = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (mGetDriverNamespace) &#123;</span><br><span class="line">        <span class="keyword">android_namespace_t</span>* ns = mGetDriverNamespace();</span><br><span class="line">        <span class="keyword">if</span> (ns) &#123;</span><br><span class="line">            dso = load_updated_driver(kind, ns); <span class="comment">//åŠ è½½ OpenGL ES å®ç°åº“ï¼Œæ”¾å›æ‰“å¼€çš„å…±äº«é“¾æ¥åº“çš„å¥æŸ„</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!dso) &#123;</span><br><span class="line">        dso = load_system_driver(kind);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ EGL åº“ï¼Œå¹¶å°†wrapper åº“ libEGL.so ä¸­çš„å‡½æ•° API æŒ‡é’ˆå’Œå…·ä½“çš„å®ç°ç»‘å®šåœ¨ä¸€èµ·</span></span><br><span class="line">    <span class="keyword">if</span> (mask &amp; EGL) &#123;</span><br><span class="line">        getProcAddress = (getProcAddressType)dlsym(dso, <span class="string">"eglGetProcAddress"</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">egl_t</span>* egl = &amp;cnx-&gt;egl; <span class="comment">//å°† egl æŒ‡é’ˆæŒ‡å‘æè¿°å½“å‰ç³»ç»Ÿæ”¯æŒ OpenGL ESå’Œ EGL å…¨å±€å˜é‡çš„ gEGLImpl</span></span><br><span class="line">        __eglMustCastToProperFunctionPointerType* curr =</span><br><span class="line">            (__eglMustCastToProperFunctionPointerType*)egl;</span><br><span class="line">        <span class="keyword">char</span> <span class="keyword">const</span> * <span class="keyword">const</span> * api = egl_names; <span class="comment">//egl_names æ˜¯å®šä¹‰åœ¨ egl.cpp æ–‡ä»¶ä¸­çš„ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ æ˜¯ EGL API å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">while</span> (*api) &#123;</span><br><span class="line">            <span class="keyword">char</span> <span class="keyword">const</span> * name = *api;</span><br><span class="line">            __eglMustCastToProperFunctionPointerType f =</span><br><span class="line">                (__eglMustCastToProperFunctionPointerType)dlsym(dso, name);</span><br><span class="line">            <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// couldn't find the entry-point, use eglGetProcAddress()</span></span><br><span class="line">                f = getProcAddress(name);</span><br><span class="line">                <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    f = (__eglMustCastToProperFunctionPointerType)<span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            *curr++ = f; <span class="comment">//è¿™ä¸€æ­¥å°±æ˜¯æœ€å…³é”®çš„å°†å…±äº«é“¾æ¥åº“ä¸­çš„ EGL API çš„å®ç°å’Œä¸Šå±‚è°ƒç”¨çš„ API å‡½æ•°æŒ‡é’ˆç»‘å®šåœ¨ä¸€èµ·</span></span><br><span class="line">            api++; <span class="comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªéœ€è¦ç»‘å®šçš„ api å‡½æ•°</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ OpenGL ES åº“ä¸­çš„ OpenGL ES 1.x API ç¬¦å·</span></span><br><span class="line">    <span class="keyword">if</span> (mask &amp; GLESv1_CM) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ init_api å®ç° OpenGL API å’Œå¯¹åº”å®ç°å‡½æ•°çš„ç»‘å®š</span></span><br><span class="line">        init_api(dso, gl_names, <span class="comment">// gl_names æ˜¯å®šä¹‰åœ¨ egl.cpp æ–‡ä»¶ä¸­çš„ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ æ˜¯ OpenGL ES API å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">                 (__eglMustCastToProperFunctionPointerType*)</span><br><span class="line">                 &amp;cnx-&gt;hooks[<span class="keyword">egl_connection_t</span>::GLESv1_INDEX]-&gt;gl, <span class="comment">//glæˆå‘˜å˜é‡æ˜¯ä¸€ä¸ªç»“æ„ä½“å˜é‡ï¼Œç»“æ„ä½“ä¸­çš„æ˜¯ OpenGL ES API å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">                 getProcAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ OpenGL ES åº“ä¸­çš„ OpenGL ES 2.0 API ç¬¦å·</span></span><br><span class="line">    <span class="keyword">if</span> (mask &amp; GLESv2) &#123;</span><br><span class="line">        init_api(dso, gl_names,</span><br><span class="line">                 (__eglMustCastToProperFunctionPointerType*)</span><br><span class="line">                 &amp;cnx-&gt;hooks[<span class="keyword">egl_connection_t</span>::GLESv2_INDEX]-&gt;gl,</span><br><span class="line">                 getProcAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dso;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Loader::load_driver() å®ƒä¸»è¦å®ç°äº†ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><p>é€šè¿‡ load_system_driver()  å‡½æ•°æŸ¥æ‰¾ OpenGL ES/EGL å®ç°åº“ï¼Œå¹¶åœ¨æŒ‡å®šçš„å­˜æ”¾è·¯å¾„ä¸­æ‰¾åˆ°å…±äº«é“¾æ¥åº“æ–‡ä»¶å¹¶æ‰“å¼€å®ƒã€‚<br>è°ƒç”¨ init_api()è§£ææ‰“å¼€çš„ OpenGL ES/EGL å…±äº«é“¾æ¥åº“ï¼Œå°† OpenGL ES/EGL API å‡½æ•°æŒ‡é’ˆå’Œå…±äº«é“¾æ¥åº“ä¸­å®ç°çš„å¯¹åº”çš„å‡½æ•°ç¬¦å·ç»‘å®šåœ¨ä¸€èµ·ï¼Œè¿™æ ·è°ƒç”¨ OpenGL ES/EGL API å°±ä¼šè°ƒç”¨åˆ°å…·ä½“å®ç°çš„OpenGL ES/EGL å…±äº«é“¾æ¥åº“ä¸­å¯¹åº”å‡½æ•°ã€‚</p><h5 id="4-4ã€å°ç»“"><a href="#4-4ã€å°ç»“" class="headerlink" title="4.4ã€å°ç»“"></a>4.4ã€å°ç»“</h5><p>Android OpenGL ES å›¾å½¢åº“ç»“æ„<br>Android çš„ OpenGL ES å›¾å½¢ç³»ç»Ÿæ¶‰åŠå¤šä¸ªåº“ï¼Œæ ¹æ®è®¾å¤‡ç±»å‹çš„ä¸åŒï¼Œè¿™äº›åº“æœ‰ç€ä¸åŒçš„ç»“æ„ã€‚</p><p>å¯¹äºæ¨¡æ‹Ÿå™¨ï¼Œæ²¡æœ‰å¼€å¯ OpenGL ES çš„ GPU ç¡¬ä»¶æ¨¡æ‹Ÿçš„æƒ…å†µï¼ŒAndroid OpenGL ES å›¾å½¢åº“ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-20-opencl-egl-imp.png" alt="Alt text | center"></p><p>å½“ä¸ºæ¨¡æ‹Ÿå™¨å¼€å¯äº† OpenGL ES çš„ GPU ç¡¬ä»¶æ¨¡æ‹Ÿï¼Œå®é™…çš„ EGL å’Œ OpenGL ES å®ç°åº“ä¼šé‡‡ç”¨ç”± android-7.1.1_r22/device/generic/goldfish-opengl ä¸‹çš„æºç ç¼–è¯‘å‡ºæ¥çš„å‡ ä¸ªåº“æ–‡ä»¶ï¼Œå³ libGLESv2_emulation.soã€libGLESv1_CM_emulation.so å’Œ libEGL_emulation.soã€‚æ­¤æ—¶ï¼ŒOpenGL ES å›¾å½¢åº“ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-21-opencl-egl-imp-emulate.png" alt="Alt text | center"></p><p>å¯¹äºçœŸå®çš„ç‰©ç† Android è®¾å¤‡ï¼ŒOpenGL ES å›¾å½¢åº“ç»“æ„å¦‚ä¸‹ï¼Œä¾‹å¦‚é«˜é€šå®ç°ï¼ˆlibEGL_adreno.so<br>libGLESv1_CM_adreno.so libGLESv2_adreno.so [\system\vendor\lib64\egl]ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS-02-22-opencl-egl-imp-qcom-adreno.png" alt="Alt text | center"></p><p>####ï¼ˆäº”ï¼‰ã€OpenGL ESï¼šEGLæ¥å£è§£æä¸ç†è§£</p><p>ç”±å‰é¢çš„åˆ†æçŸ¥é“EGLçš„ç»˜å›¾çš„ä¸€èˆ¬æ­¥éª¤å¦‚ä¸‹ï¼Œæ¥ä¸‹æ¥åˆ†æä¸»è¦çš„1-8ä¸ªå°æ­¥éª¤ï¼š</p><blockquote><p>ä½¿ç”¨EGLçš„ç»˜å›¾çš„ä¸€èˆ¬æ­¥éª¤ï¼š<br>1ã€è·å– EGL Display å¯¹è±¡ï¼šeglGetDisplay()<br>2ã€åˆå§‹åŒ–ä¸ EGLDisplay ä¹‹é—´çš„è¿æ¥ï¼šeglInitialize()<br>3ã€è·å– EGLConfig å¯¹è±¡ï¼šeglChooseConfig()<br>4ã€åˆ›å»º EGLContext å®ä¾‹ï¼šeglCreateContext()<br>5ã€åˆ›å»º EGLSurface å®ä¾‹ï¼šeglCreateWindowSurface()<br>6ã€è¿æ¥ EGLContext å’Œ EGLSurfaceï¼šeglMakeCurrent()<br>7ã€ä½¿ç”¨ OpenGL ES API ç»˜åˆ¶å›¾å½¢ï¼šgl_*()<br>8ã€åˆ‡æ¢ front buffer å’Œ back buffer é€æ˜¾ï¼šeglSwapBuffer()<br>9ã€æ–­å¼€å¹¶é‡Šæ”¾ä¸ EGLSurface å…³è”çš„ EGLContext å¯¹è±¡ï¼šeglRelease()<br>10ã€åˆ é™¤ EGLSurface å¯¹è±¡<br>11ã€åˆ é™¤ EGLContext å¯¹è±¡<br>12ã€ç»ˆæ­¢ä¸ EGLDisplay ä¹‹é—´çš„è¿æ¥</p></blockquote><p>æ ‡å‡† EGL æ•°æ®ç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>EGLBoolean â€”â€”EGL_TRUE =1, EGL_FALSE=0<br>EGLint â€”â€”int æ•°æ®ç±»å‹<br>EGLDisplay â€”â€”ç³»ç»Ÿæ˜¾ç¤º ID æˆ–å¥æŸ„ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå‰ç«¯çš„æ˜¾ç¤ºçª—å£<br>EGLConfig â€”â€”Surfaceçš„EGLé…ç½®ï¼Œå¯ä»¥ç†è§£ä¸ºç»˜åˆ¶ç›®æ ‡framebufferçš„é…ç½®å±æ€§<br>EGLSurface â€”â€”ç³»ç»Ÿçª—å£æˆ– frame buffer å¥æŸ„ ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåç«¯çš„æ¸²æŸ“ç›®æ ‡çª—å£ã€‚<br>EGLContext â€”â€”OpenGL ES å›¾å½¢ä¸Šä¸‹æ–‡ï¼Œå®ƒä»£è¡¨äº†OpenGLçŠ¶æ€æœºï¼›å¦‚æœæ²¡æœ‰å®ƒï¼ŒOpenGLæŒ‡ä»¤å°±æ²¡æœ‰æ‰§è¡Œçš„ç¯å¢ƒã€‚</p><p>ä¸‹é¢å‡ ä¸ªç±»å‹æ¯”è¾ƒå¤æ‚ï¼Œé€šè¿‡ä¾‹å­å¯ä»¥æ›´æ·±å…¥çš„ç†è§£ã€‚è¿™é‡Œè¦è¯´æ˜çš„æ˜¯è¿™å‡ ä¸ªç±»å‹åœ¨ä¸åŒå¹³å°å…¶å®ç°æ˜¯ä¸åŒçš„ï¼ŒEGLåªæä¾›æŠ½è±¡æ ‡å‡†ã€‚</p><p>NativeDisplayTypeâ€”â€”Native ç³»ç»Ÿæ˜¾ç¤ºç±»å‹ï¼Œæ ‡è¯†ä½ æ‰€å¼€å‘è®¾å¤‡çš„ç‰©ç†å±å¹•<br>NativeWindowType â€”â€”Native ç³»ç»Ÿçª—å£ç¼“å­˜ç±»å‹ï¼Œæ ‡è¯†ç³»ç»Ÿçª—å£<br>NativePixmapType â€”â€”Native ç³»ç»Ÿ frame bufferï¼Œå¯ä»¥ä½œä¸º Framebuffer çš„ç³»ç»Ÿå›¾åƒï¼ˆå†…å­˜ï¼‰æ•°æ®ç±»å‹ï¼Œè¯¥ç±»å‹åªç”¨äºç¦»å±æ¸²æŸ“.</p><h5 id="5-1ã€eglGetDisplay"><a href="#5-1ã€eglGetDisplay" class="headerlink" title="5.1ã€eglGetDisplay()"></a>5.1ã€eglGetDisplay()</h5><p>EGLDisplay æ˜¯ä¸€ä¸ªå…³è”ç³»ç»Ÿç‰©ç†å±å¹•çš„é€šç”¨æ•°æ®ç±»å‹ï¼Œè¡¨ç¤ºæ˜¾ç¤ºè®¾å¤‡å¥æŸ„ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå‰ç«¯æ˜¾ç¤ºçª—ã€‚ä¸ºäº†ä½¿ç”¨ç³»ç»Ÿçš„æ˜¾ç¤ºè®¾å¤‡ï¼Œ EGL æä¾›äº† EGLDisplay æ•°æ®ç±»å‹ï¼Œä»¥åŠä¸€ç»„æ“ä½œè®¾å¤‡æ˜¾ç¤ºçš„ API ã€‚<br>ä¸‹é¢çš„å‡½æ•°åŸå‹ç”¨äºè·å– Native Display ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line"><span class="function">EGLDisplay <span class="title">eglGetDisplay</span><span class="params">(NativeDisplayType display)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">if</span> (display == EGL_DEFAULT_DISPLAY) &#123;</span><br><span class="line">        EGLDisplay dpy = (EGLDisplay)<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">egl_display_t</span>&amp; d = <span class="keyword">egl_display_t</span>::get_display(dpy);</span><br><span class="line">        d.type = display;</span><br><span class="line">        <span class="keyword">return</span> dpy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> EGL_NO_DISPLAY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">egl_display_t</span>&amp; <span class="keyword">egl_display_t</span>::get_display(EGLDisplay dpy) &#123;</span><br><span class="line">    <span class="keyword">return</span> gDisplays[<span class="keyword">uintptr_t</span>(dpy)<span class="number">-1U</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ ä¸­ display å‚æ•°æ˜¯ native ç³»ç»Ÿçš„çª—å£æ˜¾ç¤º ID å€¼ã€‚å¦‚æœä½ åªæ˜¯æƒ³å¾—åˆ°ä¸€ä¸ªç³»ç»Ÿé»˜è®¤çš„ Display ï¼Œä½ å¯ä»¥ä½¿ç”¨ EGL_DEFAULT_DISPLAY å‚æ•°ã€‚å¦‚æœç³»ç»Ÿä¸­æ²¡æœ‰ä¸€ä¸ªå¯ç”¨çš„ native display ID ä¸ç»™å®šçš„ display å‚æ•°åŒ¹é…ï¼Œå‡½æ•°å°†è¿”å› EGL_NO_DISPLAY ï¼Œè€Œæ²¡æœ‰ä»»ä½• Error çŠ¶æ€è¢«è®¾ç½®ã€‚</p><h5 id="5-2ã€eglInitialize"><a href="#5-2ã€eglInitialize" class="headerlink" title="5.2ã€eglInitialize()"></a>5.2ã€eglInitialize()</h5><p>æ¯ä¸ª EGLDisplay åœ¨ä½¿ç”¨å‰éƒ½éœ€è¦åˆå§‹åŒ–ã€‚åˆå§‹åŒ– EGLDisplay çš„åŒæ—¶ï¼Œä½ å¯ä»¥å¾—åˆ°ç³»ç»Ÿä¸­ EGL çš„å®ç°ç‰ˆæœ¬å·ã€‚äº†è§£å½“å‰çš„ç‰ˆæœ¬å·åœ¨å‘åå…¼å®¹æ€§æ–¹é¢æ˜¯éå¸¸æœ‰ä»·å€¼çš„ã€‚åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œé€šè¿‡åŠ¨æ€æŸ¥è¯¢ EGL ç‰ˆæœ¬å·ï¼Œä½ å¯ä»¥ä¸ºæ–°æ—§ç‰ˆæœ¬çš„ EGL é™„åŠ é¢å¤–çš„ç‰¹æ€§æˆ–è¿è¡Œç¯å¢ƒã€‚åŸºäºå¹³å°é…ç½®ï¼Œè½¯ä»¶å¼€å‘å¯ç”¨æ¸…æ¥šçŸ¥é“å“ªäº› API å¯ç”¨è®¿é—®ï¼Œè¿™å°†ä¼šä¸ºä½ çš„ä»£ç æä¾›æœ€å¤§é™åº¦çš„å¯ç§»æ¤æ€§ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglInitialize</span><span class="params">(EGLDisplay dpy, EGLint *major, EGLint *minor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">egl_display_t</span>::is_valid(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    EGLBoolean res = EGL_TRUE;</span><br><span class="line">    <span class="keyword">egl_display_t</span>&amp; d = <span class="keyword">egl_display_t</span>::get_display(dpy);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (d.initialized.fetch_add(<span class="number">1</span>, <span class="built_in">std</span>::memory_order_acquire) == <span class="number">0</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == EGL_TRUE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (major != <span class="literal">NULL</span>) *major = VERSION_MAJOR;</span><br><span class="line">        <span class="keyword">if</span> (minor != <span class="literal">NULL</span>) *minor = VERSION_MINOR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ dpy åº”è¯¥æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ EGLDisplay ã€‚å‡½æ•°è¿”å›æ—¶ï¼Œ major å’Œ minor å°†è¢«èµ‹äºˆå½“å‰ EGL ç‰ˆæœ¬å·ã€‚æ¯”å¦‚ EGL1.0 ï¼Œ major è¿”å› 1 ï¼Œ minor åˆ™è¿”å› 0 ã€‚ç»™ major å’Œ minor ä¼  NULL æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœä½ ä¸å…³å¿ƒç‰ˆæœ¬å·ã€‚<br>eglQueryString() å‡½æ•°æ˜¯å¦å¤–ä¸€ä¸ªè·å–ç‰ˆæœ¬ä¿¡æ¯å’Œå…¶ä»–ä¿¡æ¯çš„é€”å¾„ã€‚é€šè¿‡ eglQueryString() è·å–ç‰ˆæœ¬ä¿¡æ¯éœ€è¦è§£æç‰ˆæœ¬å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥é€šè¿‡ä¼ é€’ä¸€ä¸ªæŒ‡é’ˆç»™ eglInitializ() å‡½æ•°æ¯”è¾ƒå®¹æ˜“è·å¾—è¿™ä¸ªä¿¡æ¯ã€‚æ³¨æ„åœ¨è°ƒç”¨ eglQueryString() å¿…é¡»å…ˆä½¿ç”¨ eglInitialize() åˆå§‹åŒ– EGLDisplay ï¼Œå¦åˆ™å°†å¾—åˆ° EGL_NOT_INITIALIZED é”™è¯¯ä¿¡æ¯ã€‚</p><h5 id="5-3ã€eglChooseConfig"><a href="#5-3ã€eglChooseConfig" class="headerlink" title="5.3ã€eglChooseConfig()"></a>5.3ã€eglChooseConfig()</h5><p>åŸº äº EGL çš„å±æ€§ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªå’Œéœ€æ±‚æ¥è¿‘çš„Configï¼Œä½†ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªå·±éœ€è¦çš„Configï¼Œåªè¦å¹³å°æ”¯æŒã€‚ä¸æ˜¯æ‰€æœ‰çš„Configéƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œä¹Ÿå°±æ˜¯ä¸æ˜¯æ‰€æœ‰Configéƒ½ä¼šæ”¯æŒã€‚ eglChooseConfig() å‡½æ•°å°†é€‚é…ä¸€ä¸ªæ‰€æœŸæœ›çš„é…ç½®ï¼Œå¹¶ä¸”å°½å¯èƒ½æ¥è¿‘ä¸€ä¸ªæœ‰æ•ˆçš„ç³»ç»Ÿé…ç½®ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglChooseConfig</span><span class="params">( EGLDisplay dpy, <span class="keyword">const</span> EGLint *attrib_list,</span></span></span><br><span class="line"><span class="function"><span class="params">                            EGLConfig *configs, EGLint config_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                            EGLint *num_config)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">egl_display_t</span>::is_valid(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ggl_unlikely(num_config==<span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_PARAMETER, EGL_FALSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ggl_unlikely(attrib_list==<span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * A NULL attrib_list should be treated as though it was an empty</span></span><br><span class="line"><span class="comment">         * one (terminated with EGL_NONE) as defined in</span></span><br><span class="line"><span class="comment">         * section 3.4.1 "Querying Configurations" in the EGL specification.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">const</span> EGLint dummy = EGL_NONE;</span><br><span class="line">        attrib_list = &amp;dummy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numAttributes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> numConfigs =  NELEM(gConfigs);</span><br><span class="line">    <span class="keyword">uint32_t</span> possibleMatch = (<span class="number">1</span>&lt;&lt;numConfigs)<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(possibleMatch &amp;&amp; *attrib_list != EGL_NONE) &#123;</span><br><span class="line">        numAttributes++;</span><br><span class="line">        EGLint attr = *attrib_list++;</span><br><span class="line">        EGLint val  = *attrib_list++;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ; possibleMatch &amp;&amp; i&lt;numConfigs ; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(possibleMatch &amp; (<span class="number">1</span>&lt;&lt;i)))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (isAttributeMatching(i, attr, val) == <span class="number">0</span>) &#123;</span><br><span class="line">                possibleMatch &amp;= ~(<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now, handle the attributes which have a useful default value</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> j=<span class="number">0</span> ; possibleMatch &amp;&amp; j&lt;NELEM(config_defaults) ; j++) &#123;</span><br><span class="line">        <span class="comment">// see if this attribute was specified, if not, apply its</span></span><br><span class="line">        <span class="comment">// default value</span></span><br><span class="line">        <span class="keyword">if</span> (binarySearch&lt;<span class="keyword">config_pair_t</span>&gt;(</span><br><span class="line">                (<span class="keyword">config_pair_t</span> <span class="keyword">const</span>*)attrib_list,</span><br><span class="line">                <span class="number">0</span>, numAttributes<span class="number">-1</span>,</span><br><span class="line">                config_defaults[j].key) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ; possibleMatch &amp;&amp; i&lt;numConfigs ; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(possibleMatch &amp; (<span class="number">1</span>&lt;&lt;i)))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> (isAttributeMatching(i,</span><br><span class="line">                        config_defaults[j].key,</span><br><span class="line">                        config_defaults[j].value) == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    possibleMatch &amp;= ~(<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return the configurations found</span></span><br><span class="line">    <span class="keyword">int</span> n=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (possibleMatch) &#123;</span><br><span class="line">        <span class="keyword">if</span> (configs) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ; config_size &amp;&amp; i&lt;numConfigs ; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (possibleMatch &amp; (<span class="number">1</span>&lt;&lt;i)) &#123;</span><br><span class="line">                    *configs++ = (EGLConfig)(<span class="keyword">uintptr_t</span>)i;</span><br><span class="line">                    config_size--;</span><br><span class="line">                    n++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ; i&lt;numConfigs ; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (possibleMatch &amp; (<span class="number">1</span>&lt;&lt;i)) &#123;</span><br><span class="line">                    n++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *num_config = n;</span><br><span class="line">     <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•° attrib_list æŒ‡å®šäº†é€‰æ‹©é…ç½®æ—¶éœ€è¦å‚ç…§çš„å±æ€§ã€‚å‚æ•° configs å°†è¿”å›ä¸€ä¸ªæŒ‰ç…§ attrib_list æ’åºçš„å¹³å°æœ‰æ•ˆçš„æ‰€æœ‰ EGL framebuffer é…ç½®åˆ—è¡¨ã€‚å‚æ•° config_size æŒ‡å®šäº†å¯ä»¥è¿”å›åˆ° configs çš„æ€»é…ç½®ä¸ªæ•°ã€‚å‚æ•° num_config è¿”å›äº†å®é™…åŒ¹é…çš„é…ç½®æ€»æ•°ã€‚</p><h5 id="5-4ã€eglCreateContext"><a href="#5-4ã€eglCreateContext" class="headerlink" title="5.4ã€eglCreateContext()"></a>5.4ã€eglCreateContext()</h5><p>OpenGL ESçš„pipelineä»ç¨‹åºçš„è§’åº¦çœ‹å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œæœ‰å½“å‰çš„é¢œè‰²ã€çº¹ç†åæ ‡ã€å˜æ¢çŸ©é˜µã€ç»šæŸ“æ¨¡å¼ç­‰ä¸€å¤§å †çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€ä½œç”¨äºOpenGL APIç¨‹åºæäº¤çš„é¡¶ç‚¹åæ ‡ç­‰å›¾å…ƒä»è€Œå½¢æˆå¸§ç¼“å†²å†…çš„åƒç´ ã€‚åœ¨OpenGLçš„ç¼–ç¨‹æ¥å£ä¸­ï¼ŒContextå°±ä»£è¡¨è¿™ä¸ªçŠ¶æ€æœºï¼ŒOpenGL APIç¨‹åºçš„ä¸»è¦å·¥ä½œå°±æ˜¯å‘Contextæä¾›å›¾å…ƒã€è®¾ç½®çŠ¶æ€ï¼Œå¶å°”ä¹Ÿä»Contexté‡Œè·å–ä¸€äº›ä¿¡æ¯ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line"><span class="function">EGLContext <span class="title">eglCreateContext</span><span class="params">(EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">                            EGLContext <span class="comment">/*share_list*/</span>, <span class="keyword">const</span> EGLint* <span class="comment">/*attrib_list*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">egl_display_t</span>::is_valid(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_DISPLAY, EGL_NO_SURFACE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ogles_context_t</span>* gl = ogles_init(<span class="keyword">sizeof</span>(<span class="keyword">egl_context_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (!gl) <span class="keyword">return</span> setError(EGL_BAD_ALLOC, EGL_NO_CONTEXT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">egl_context_t</span>* c = <span class="keyword">static_cast</span>&lt;<span class="keyword">egl_context_t</span>*&gt;(gl-&gt;rasterizer.base);</span><br><span class="line">    c-&gt;flags = <span class="keyword">egl_context_t</span>::NEVER_CURRENT;</span><br><span class="line">    c-&gt;dpy = dpy;</span><br><span class="line">    c-&gt;config = config;</span><br><span class="line">    c-&gt;read = <span class="number">0</span>;</span><br><span class="line">    c-&gt;draw = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> (EGLContext)gl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="5-5ã€eglCreateWindowSurface"><a href="#5-5ã€eglCreateWindowSurface" class="headerlink" title="5.5ã€eglCreateWindowSurface()"></a>5.5ã€eglCreateWindowSurface()</h5><p>Surfaceå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªFrameBufferï¼Œä¹Ÿå°±æ˜¯æ¸²æŸ“ç›®çš„åœ°ï¼Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line"><span class="function">EGLSurface <span class="title">eglCreateWindowSurface</span><span class="params">(  EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    NativeWindowType window,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">const</span> EGLint *attrib_list)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createWindowSurface(dpy, config, window, attrib_list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> EGLSurface <span class="title">createWindowSurface</span><span class="params">(EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">        NativeWindowType window, <span class="keyword">const</span> EGLint* <span class="comment">/*attrib_list*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">egl_display_t</span>::is_valid(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_DISPLAY, EGL_NO_SURFACE);</span><br><span class="line">    <span class="keyword">if</span> (window == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_MATCH, EGL_NO_SURFACE);</span><br><span class="line"></span><br><span class="line">    EGLint surfaceType;</span><br><span class="line">    <span class="keyword">if</span> (getConfigAttrib(dpy, config, EGL_SURFACE_TYPE, &amp;surfaceType) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(surfaceType &amp; EGL_WINDOW_BIT))</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_MATCH, EGL_NO_SURFACE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">static_cast</span>&lt;ANativeWindow*&gt;(window)-&gt;common.magic !=</span><br><span class="line">            ANDROID_NATIVE_WINDOW_MAGIC) &#123;</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_NATIVE_WINDOW, EGL_NO_SURFACE);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    EGLint configID;</span><br><span class="line">    <span class="keyword">if</span> (getConfigAttrib(dpy, config, EGL_CONFIG_ID, &amp;configID) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> depthFormat;</span><br><span class="line">    <span class="keyword">int32_t</span> pixelFormat;</span><br><span class="line">    <span class="keyword">if</span> (getConfigFormatInfo(configID, pixelFormat, depthFormat) != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_MATCH, EGL_NO_SURFACE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">egl_surface_t</span>* surface;</span><br><span class="line">    surface = <span class="keyword">new</span> <span class="keyword">egl_window_surface_v2_t</span>(dpy, config, depthFormat,</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;ANativeWindow*&gt;(window));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!surface-&gt;initCheck()) &#123;</span><br><span class="line">        <span class="keyword">delete</span> surface;</span><br><span class="line">        surface = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> surface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥åˆ›å»ºä¸€ä¸ªå¯å®é™…æ˜¾ç¤ºçš„Surfaceã€‚</p><p>ç³»ç»Ÿé€šå¸¸è¿˜æ”¯æŒå¦å¤–ä¸¤ç§Surfaceï¼šPixmapSurfaceå’ŒPBufferSurfaceï¼Œè¿™ä¸¤ç§éƒ½ä¸æ˜¯å¯æ˜¾ç¤ºçš„Surfaceï¼ŒPixmapSurfaceæ˜¯ä¿å­˜åœ¨ç³»ç»Ÿå†…å­˜ä¸­çš„ä½å›¾ï¼ŒPBufferåˆ™æ˜¯ä¿å­˜åœ¨æ˜¾å­˜ä¸­çš„å¸§ã€‚</p><p>å¯¹äºè¿™ä¸¤ç§surfaceï¼ŒAndroidç³»ç»Ÿä¸­ï¼Œæ”¯æŒPBufferSurfaceã€‚</p><h5 id="5-6ã€eglMakeCurrent"><a href="#5-6ã€eglMakeCurrent" class="headerlink" title="5.6ã€eglMakeCurrent()"></a>5.6ã€eglMakeCurrent()</h5><p>è¯¥æ¥å£å°†ç”³è¯·åˆ°çš„displayï¼Œdrawï¼ˆsurfaceï¼‰å’Œ contextè¿›è¡Œäº†ç»‘å®šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨contextä¸‹çš„OpenGLAPIæŒ‡ä»¤å°†drawï¼ˆsurfaceï¼‰ä½œä¸ºå…¶æ¸²æŸ“æœ€ç»ˆç›®çš„åœ°ã€‚è€Œdisplayä½œä¸ºdrawï¼ˆsurfaceï¼‰çš„å‰ç«¯æ˜¾ç¤ºã€‚è°ƒç”¨åï¼Œå½“å‰çº¿ç¨‹ä½¿ç”¨çš„EGLContexä¸ºcontextã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglMakeCurrent</span><span class="params">(  EGLDisplay dpy, EGLSurface draw,</span></span></span><br><span class="line"><span class="function"><span class="params">                            EGLSurface read, EGLContext ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">egl_display_t</span>::is_valid(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line">    <span class="keyword">if</span> (draw) &#123;</span><br><span class="line">        <span class="keyword">egl_surface_t</span>* s = (<span class="keyword">egl_surface_t</span>*)draw;</span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;isValid())</span><br><span class="line">            <span class="keyword">return</span> setError(EGL_BAD_SURFACE, EGL_FALSE);</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;dpy != dpy)</span><br><span class="line">            <span class="keyword">return</span> setError(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> check that draw is compatible with the context</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (read &amp;&amp; read!=draw) &#123;</span><br><span class="line">        <span class="keyword">egl_surface_t</span>* s = (<span class="keyword">egl_surface_t</span>*)read;</span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;isValid())</span><br><span class="line">            <span class="keyword">return</span> setError(EGL_BAD_SURFACE, EGL_FALSE);</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;dpy != dpy)</span><br><span class="line">            <span class="keyword">return</span> setError(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> check that read is compatible with the context</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EGLContext current_ctx = EGL_NO_CONTEXT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((read == EGL_NO_SURFACE &amp;&amp; draw == EGL_NO_SURFACE) &amp;&amp; (ctx != EGL_NO_CONTEXT))</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_MATCH, EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((read != EGL_NO_SURFACE || draw != EGL_NO_SURFACE) &amp;&amp; (ctx == EGL_NO_CONTEXT))</span><br><span class="line">        <span class="keyword">return</span> setError(EGL_BAD_MATCH, EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx == EGL_NO_CONTEXT) &#123;</span><br><span class="line">        <span class="comment">// if we're detaching, we need the current context</span></span><br><span class="line">        current_ctx = (EGLContext)getGlThreadSpecific();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">egl_context_t</span>* c = <span class="keyword">egl_context_t</span>::context(ctx);</span><br><span class="line">        <span class="keyword">egl_surface_t</span>* d = (<span class="keyword">egl_surface_t</span>*)draw;</span><br><span class="line">        <span class="keyword">egl_surface_t</span>* r = (<span class="keyword">egl_surface_t</span>*)read;</span><br><span class="line">        <span class="keyword">if</span> ((d &amp;&amp; d-&gt;ctx &amp;&amp; d-&gt;ctx != ctx) ||</span><br><span class="line">            (r &amp;&amp; r-&gt;ctx &amp;&amp; r-&gt;ctx != ctx)) &#123;</span><br><span class="line">            <span class="comment">// one of the surface is bound to a context in another thread</span></span><br><span class="line">            <span class="keyword">return</span> setError(EGL_BAD_ACCESS, EGL_FALSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ogles_context_t</span>* gl = (<span class="keyword">ogles_context_t</span>*)ctx;</span><br><span class="line">    <span class="keyword">if</span> (makeCurrent(gl) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ctx) &#123;</span><br><span class="line">            <span class="keyword">egl_context_t</span>* c = <span class="keyword">egl_context_t</span>::context(ctx);</span><br><span class="line">            <span class="keyword">egl_surface_t</span>* d = (<span class="keyword">egl_surface_t</span>*)draw;</span><br><span class="line">            <span class="keyword">egl_surface_t</span>* r = (<span class="keyword">egl_surface_t</span>*)read;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (c-&gt;draw) &#123;</span><br><span class="line">                <span class="keyword">egl_surface_t</span>* s = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">egl_surface_t</span>*&gt;(c-&gt;draw);</span><br><span class="line">                s-&gt;disconnect();</span><br><span class="line">                s-&gt;ctx = EGL_NO_CONTEXT;</span><br><span class="line">                <span class="keyword">if</span> (s-&gt;zombie)</span><br><span class="line">                    <span class="keyword">delete</span> s;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (c-&gt;read) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">FIXME:</span> unlock/disconnect the read surface too </span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            c-&gt;draw = draw;</span><br><span class="line">            c-&gt;read = read;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c-&gt;flags &amp; <span class="keyword">egl_context_t</span>::NEVER_CURRENT) &#123;</span><br><span class="line">                c-&gt;flags &amp;= ~<span class="keyword">egl_context_t</span>::NEVER_CURRENT;</span><br><span class="line">                GLint w = <span class="number">0</span>;</span><br><span class="line">                GLint h = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (draw) &#123;</span><br><span class="line">                    w = d-&gt;getWidth();</span><br><span class="line">                    h = d-&gt;getHeight();</span><br><span class="line">                &#125;</span><br><span class="line">                ogles_surfaceport(gl, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                ogles_viewport(gl, <span class="number">0</span>, <span class="number">0</span>, w, h);</span><br><span class="line">                ogles_scissor(gl, <span class="number">0</span>, <span class="number">0</span>, w, h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (d) &#123;</span><br><span class="line">                <span class="keyword">if</span> (d-&gt;connect() == EGL_FALSE) &#123;</span><br><span class="line">                    <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line">                &#125;</span><br><span class="line">                d-&gt;ctx = ctx;</span><br><span class="line">                d-&gt;bindDrawSurface(gl);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">FIXME:</span> lock/connect the read surface too </span></span><br><span class="line">                r-&gt;ctx = ctx;</span><br><span class="line">                r-&gt;bindReadSurface(gl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// if surfaces were bound to the context bound to this thread</span></span><br><span class="line">            <span class="comment">// mark then as unbound.</span></span><br><span class="line">            <span class="keyword">if</span> (current_ctx) &#123;</span><br><span class="line">                <span class="keyword">egl_context_t</span>* c = <span class="keyword">egl_context_t</span>::context(current_ctx);</span><br><span class="line">                <span class="keyword">egl_surface_t</span>* d = (<span class="keyword">egl_surface_t</span>*)c-&gt;draw;</span><br><span class="line">                <span class="keyword">egl_surface_t</span>* r = (<span class="keyword">egl_surface_t</span>*)c-&gt;read;</span><br><span class="line">                <span class="keyword">if</span> (d) &#123;</span><br><span class="line">                    c-&gt;draw = <span class="number">0</span>;</span><br><span class="line">                    d-&gt;disconnect();</span><br><span class="line">                    d-&gt;ctx = EGL_NO_CONTEXT;</span><br><span class="line">                    <span class="keyword">if</span> (d-&gt;zombie)</span><br><span class="line">                        <span class="keyword">delete</span> d;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (r) &#123;</span><br><span class="line">                    c-&gt;read = <span class="number">0</span>;</span><br><span class="line">                    r-&gt;ctx = EGL_NO_CONTEXT;</span><br><span class="line">                    <span class="comment">// <span class="doctag">FIXME:</span> unlock/disconnect the read surface too </span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setError(EGL_BAD_ACCESS, EGL_FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="5-7ã€ç»˜åˆ¶gl"><a href="#5-7ã€ç»˜åˆ¶gl" class="headerlink" title="5.7ã€ç»˜åˆ¶gl_*()"></a>5.7ã€ç»˜åˆ¶gl_*()</h5><p>åº”ç”¨ç¨‹åºé€šè¿‡OpenGL APIè¿›è¡Œç»˜åˆ¶ï¼Œä¸€å¸§å®Œæˆä¹‹åï¼Œè°ƒç”¨eglSwapBuffers(EGLDisplay dpy, EGLContext ctx)æ¥æ˜¾ç¤ºã€‚</p><h5 id="5-8ã€eglSwapBuffersæ¥å£å®ç°è¯´æ˜"><a href="#5-8ã€eglSwapBuffersæ¥å£å®ç°è¯´æ˜" class="headerlink" title="5.8ã€eglSwapBuffersæ¥å£å®ç°è¯´æ˜"></a>5.8ã€eglSwapBuffersæ¥å£å®ç°è¯´æ˜</h5><p>Androidå¹³å°ï¼š</p><p>ä¸ºäº†å®ç°eglSwapBuffersï¼Œ eglSurfaceå…¶å®ä»£è¡¨äº†ä¸€ä¸ªä»NativeWindow ç”³è¯·åˆ°çš„ä¸€ä¸ªBufferï¼ˆDequeueæ“ä½œï¼‰ã€‚å½“è°ƒç”¨eglSwapBuffersæ—¶ï¼Œå¯¹äºä¸€èˆ¬åº”ç”¨çª—å£è€Œè¨€ï¼ŒNativeWindowå°†è¯¥Surfaceçš„Buffer æäº¤å›å»ç»™SurfaceFlingerï¼ˆQueueæ“ä½œ)ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line">EGLBoolean egl_window_surface_v2_t::swapBuffers()</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">nativeWindow-&gt;queueBuffer(nativeWindow, buffer); </span><br><span class="line">nativeWindow-&gt;dequeueBuffer(nativeWindow, &amp;buffer);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååˆé‡æ–°ä»NativeWindowä¸­é‡æ–°Dequeueå‡ºæ¥ä¸€ä¸ªæ–°çš„Bufferç»™eglSurfaceã€‚è€ŒeglDisplayå¹¶ä¸ä»£è¡¨å®é™…çš„æ„ä¹‰ã€‚æˆ‘ä»¬åªæ˜¯ä»æ¥å£ä¸Šæ„Ÿè§‰æ˜¯ï¼Œsurfaceå’Œdisplayè¿›è¡Œäº†äº¤æ¢ã€‚ï¼ˆæ³¨ï¼šç°åœ¨æ˜¯Triple Bufferï¼‰</p><blockquote><p><strong>æ€»ç»“ï¼šä»å‰é¢å…³äºAndroid EGLã€OpenGL ESçš„åˆ†æçŸ¥é“ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡SurfaceFlingerç”³è¯·ä¸€å—Surfaceï¼ˆBufferï¼‰ï¼Œç„¶åå¯ä»¥åˆ©ç”¨OpenGL ESæ¥å£åœ¨Native å±‚ç»˜åˆ¶ç›¸å…³çš„å›¾ç‰‡ã€æ–‡å­—ï¼›é‚£ä¹ˆç–‘é—®æ¥äº†ï¼ŒAndroidä¸Šå±‚ç»šä¸½å¤šå½©çš„Appç•Œé¢æ˜¯å¦‚ä½•ç»˜åˆ¶è€Œæˆçš„å‘¢ã€Appå±‚å¦‚ä½•é€šè¿‡åº•å±‚çš„OpenGL ESæ¥å£æ¥å®Œæˆç»˜åˆ¶å‘¢ï¼Ÿï¼Ÿï¼Ÿ</strong></p></blockquote><h4 id="ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://www.khronos.org/" target="_blank" rel="noopener">Khronos Group</a><br><a href="https://source.android.com/devices/graphics/architecture" target="_blank" rel="noopener">Androidå›¾å½¢æ¶æ„ å®˜æ–¹æ–‡æ¡£</a><br><a href="http://geekfaner.com/shineengine/index.html" target="_blank" rel="noopener">OPENGL ES 2.0 çŸ¥è¯†ä¸²è®²</a><br><a href="https://www.slideshare.net/namjungsoo/egl-31239467" target="_blank" rel="noopener">OpenGL ES EGL Spec&amp;APIs</a><br><a href="https://www.slideshare.net/SuhanLee2/understaing-android-egl" target="_blank" rel="noopener">Understaing-Android-Egl</a><br><a href="https://woshijpf.github.io/category/android/" target="_blank" rel="noopener">Android ç³»ç»Ÿå›¾å½¢æ ˆ(1) &amp;&amp;(2)ï¼š OpenGL ES å’Œ EGL</a><br><a href="https://blog.csdn.net/hovan/article/details/43198399" target="_blank" rel="noopener">Android L çš„å¼€æœºåŠ¨ç”»æµç¨‹ - CSDNåšå®¢</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/07/10/Android%20Camera%20System%EF%BC%882%EF%BC%89%EF%BC%9ACamera%20System%5BCamera%20%E7%B3%BB%E7%BB%9F%5DstartPreview%E3%80%81takePicture%E3%80%81Recorder%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/07/10/Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera System[Camera ç³»ç»Ÿ]startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ/</id>
    <published>2018-07-09T16:00:00.000Z</published>
    <updated>2018-05-25T12:12:49.620Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/camera.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="https://blog.csdn.net/armwind/article/category/6282972" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera fwå­¦ä¹ -Armwindã€‘</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/category/3066721" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera API2åˆ†æ-Gzzaigcnforeverã€‘</a><br><a href="https://blog.csdn.net/qq_16775897/article/category/7112759" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera æµç¨‹å­¦ä¹ è®°å½• Android 7.12-QQ_16775897ã€‘</a><br><a href="https://blog.csdn.net/column/details/guming-camera.html" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - ä¸“æ ï¼šå¤å†¥çš„android6.0ä¸‹çš„Camera API2.0çš„æºç åˆ†æä¹‹æ—…ã€‘</a><br>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><p> ğŸŒ€ğŸŒ€ï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶</p><hr><p>â˜¯ Applicationï¼š<br>â˜¯ /packages/apps/Camera2/src/com/android/camera/</p><p>â˜¯ Frameworkï¼š<br>â˜¯ /frameworks/base/core/java/android/hardware/Camera.java</p><p>â˜¯ JNI:<br>â˜¯ /frameworks/base/core/jni/android_hardware_Camera.cpp</p><p>â˜¯ Native:<br>â˜¯ Clientï¼š<br>frameworks/av/camera/CameraBase.cpp<br>frameworks/av/camera/Camera.cpp<br>frameworks/av/camera/ICamera.cpp<br>frameworks/av/camera/aidl/android/hardware/ICamera.aidl<br>frameworks/av/camera/aidl/android/hardware/ICameraClient.aidl<br>â˜¯ Serverï¼š<br>frameworks/av/camera/cameraserver/main_cameraserver.cpp<br>frameworks/av/services/camera/libcameraservice/CameraService.cpp<br>frameworks/av/services/camera/libcameraservice/api1/CameraClient.cpp<br>frameworks/av/camera/aidl/android/hardware/ICameraService.aidl</p><p>â˜¯ HALï¼š<br>â˜¯ /frameworks/av/services/camera/libcameraservice/device3/<br>â˜¯ /hardware/qcom/camera/QCamera2(é«˜é€šHAL)<br>â˜¯ /vendor/qcom/proprietary/mm-camera(é«˜é€šmm-camera)<br>â˜¯ /vendor/qcom/proprietary/mm-still(é«˜é€šJPEG)</p><p>â˜¯ Kernelï¼š<br>â˜¯ /kernel/drivers/media/platform/msm/camera_v2(é«˜é€šV4L2)<br>â˜¯ /kernel/arch/arm/boot/dts/(é«˜é€šdts)</p><hr><h4 id="ï¼ˆä¸€ï¼‰ã€Camera-System-startPreviewæµç¨‹åˆ†æ"><a href="#ï¼ˆä¸€ï¼‰ã€Camera-System-startPreviewæµç¨‹åˆ†æ" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Camera System startPreviewæµç¨‹åˆ†æ"></a>ï¼ˆä¸€ï¼‰ã€Camera System startPreviewæµç¨‹åˆ†æ</h4><h5 id="1-1ã€Camera2-startPreviewçš„åº”ç”¨å±‚-Java-æµç¨‹åˆ†æ"><a href="#1-1ã€Camera2-startPreviewçš„åº”ç”¨å±‚-Java-æµç¨‹åˆ†æ" class="headerlink" title="1.1ã€Camera2 startPreviewçš„åº”ç”¨å±‚(Java)æµç¨‹åˆ†æ"></a>1.1ã€Camera2 startPreviewçš„åº”ç”¨å±‚(Java)æµç¨‹åˆ†æ</h5><p>previewæµç¨‹éƒ½æ˜¯ä»startPreviewå¼€å§‹çš„ï¼Œæ‰€ä»¥æ¥çœ‹startPreviewæ–¹æ³•çš„ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startPreview</span><span class="params">(Surface previewSurface, CaptureReadyCallback listener)</span> </span>&#123;</span><br><span class="line">    mPreviewSurface = previewSurface;</span><br><span class="line">    <span class="comment">//æ ¹æ®Surfaceä»¥åŠCaptureReadyCallbackå›è°ƒæ¥å»ºç«‹previewç¯å¢ƒ</span></span><br><span class="line">    setupAsync(mPreviewSurface, listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™å…¶ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å›è°ƒCaptureReadyCallbackï¼Œå…ˆåˆ†æsetupAsyncæ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupAsync</span><span class="params">(<span class="keyword">final</span> Surface previewSurface, <span class="keyword">final</span> CaptureReadyCallback listener)</span> </span>&#123;</span><br><span class="line">    mCameraHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">//å»ºç«‹previewç¯å¢ƒ</span></span><br><span class="line">            setup(previewSurface, listener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œé€šè¿‡CameraHandleræ¥postä¸€ä¸ªRunnableå¯¹è±¡ï¼Œå®ƒåªä¼šè°ƒç”¨Runnableçš„runæ–¹æ³•ï¼Œå®ƒä»ç„¶å±äºUIçº¿ç¨‹ï¼Œå¹¶æ²¡æœ‰åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œç»§ç»­åˆ†æsetupæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Surface previewSurface, <span class="keyword">final</span> CaptureReadyCallback listener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCaptureSession != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mCaptureSession.abortCaptures();</span><br><span class="line">            mCaptureSession = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Surface&gt; outputSurfaces = <span class="keyword">new</span> ArrayList&lt;Surface&gt;(<span class="number">2</span>);</span><br><span class="line">        outputSurfaces.add(previewSurface);</span><br><span class="line">        outputSurfaces.add(mCaptureImageReader.getSurface());</span><br><span class="line">        <span class="comment">//åˆ›å»ºCaptureSessionä¼šè¯æ¥ä¸Camera Deviceå‘é€Previewè¯·æ±‚</span></span><br><span class="line">        mDevice.createCaptureSession(outputSurfaces, <span class="keyword">new</span> CameraCaptureSession.StateCallback() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigureFailed</span><span class="params">(CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//å¦‚æœé…ç½®å¤±è´¥ï¼Œåˆ™å›è°ƒCaptureReadyCallbackçš„onSetupFailedæ–¹æ³•</span></span><br><span class="line">                listener.onSetupFailed();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigured</span><span class="params">(CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">                mCaptureSession = session;</span><br><span class="line">                mAFRegions = ZERO_WEIGHT_3A_REGION;</span><br><span class="line">                mAERegions = ZERO_WEIGHT_3A_REGION;</span><br><span class="line">                mZoomValue = <span class="number">1f</span>;</span><br><span class="line">                mCropRegion = cropRegionForZoom(mZoomValue);</span><br><span class="line">                <span class="comment">//è°ƒç”¨repeatingPreviewæ¥å¯åŠ¨preview</span></span><br><span class="line">                <span class="keyword">boolean</span> success = repeatingPreview(<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                    <span class="comment">//è‹¥å¯åŠ¨æˆåŠŸï¼Œåˆ™å›è°ƒCaptureReadyCallbackçš„onReadyForCaptureï¼Œè¡¨ç¤ºå‡†å¤‡æ‹ç…§æˆåŠŸ</span></span><br><span class="line">                    listener.onReadyForCapture();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//è‹¥å¯åŠ¨å¤±è´¥ï¼Œåˆ™å›è°ƒCaptureReadyCallbackçš„onSetupFailedï¼Œè¡¨ç¤ºpreviewå»ºç«‹å¤±è´¥</span></span><br><span class="line">                    listener.onSetupFailed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClosed</span><span class="params">(CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.onClosed(session);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, mCameraHandler);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CameraAccessException ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Could not set up capture session"</span>, ex);</span><br><span class="line">        listener.onSetupFailed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œè°ƒç”¨Deviceçš„createCaptureSessionæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œå¹¶å®šä¹‰äº†ä¼šè¯çš„çŠ¶æ€å›è°ƒCameraCaptureSession.StateCallback()ï¼Œå…¶ä¸­ï¼Œå½“ä¼šè¯åˆ›å»ºæˆåŠŸï¼Œåˆ™ä¼šå›è°ƒonConfigured()æ–¹æ³•,åœ¨å…¶ä¸­ï¼Œé¦–å…ˆè°ƒç”¨repeatingPreviewæ¥å¯åŠ¨previewï¼Œç„¶åå¤„ç†previewçš„ç»“æœå¹¶è°ƒç”¨å…ˆå‰å®šä¹‰çš„CaptureReadyCallbackæ¥é€šçŸ¥ç”¨æˆ·è¿›è¡ŒCaptureæ“ä½œã€‚å…ˆåˆ†ærepeatingPreviewæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">repeatingPreview</span><span class="params">(Object tag)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡CameraDeviceå¯¹è±¡åˆ›å»ºä¸€ä¸ªCaptureRequestçš„previewè¯·æ±‚</span></span><br><span class="line">        CaptureRequest.Builder builder = mDevice.createCaptureRequest(</span><br><span class="line">                CameraDevice.TEMPLATE_PREVIEW);</span><br><span class="line">        <span class="comment">//æ·»åŠ é¢„è§ˆçš„ç›®æ ‡Surface</span></span><br><span class="line">        builder.addTarget(mPreviewSurface);</span><br><span class="line">        <span class="comment">//è®¾ç½®é¢„è§ˆæ¨¡å¼</span></span><br><span class="line">        builder.set(CaptureRequest.CONTROL_MODE, CameraMetadata.CONTROL_MODE_AUTO);</span><br><span class="line">        addBaselineCaptureKeysToRequest(builder);</span><br><span class="line">        <span class="comment">//åˆ©ç”¨ä¼šè¯å‘é€è¯·æ±‚ï¼ŒmCaptureCallbackä¸º</span></span><br><span class="line">        mCaptureSession.setRepeatingRequest(builder.build(), mCaptureCallback,mCameraHandler);</span><br><span class="line">        Log.v(TAG, String.format(<span class="string">"Sent repeating Preview request, zoom = %.2f"</span>, mZoomValue));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CameraAccessException ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Could not access camera setting up preview."</span>, ex);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨CameraDeviceImplçš„createCaptureRequestæ–¹æ³•åˆ›å»ºç±»å‹ä¸ºTEMPLATE_PREVIEW çš„CaptureRequestï¼Œç„¶åè°ƒç”¨CameraCaptureSessionImplçš„setRepeatingRequestæ–¹æ³•å°†æ­¤è¯·æ±‚å‘é€å‡ºå»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/base/core/java/android/hardware/camera2/impl/CameraCaptureSessionImpl.java]</span><br><span class="line">Override</span><br><span class="line">public synchronized int setRepeatingRequest(CaptureRequest request, CaptureCallback callback,</span><br><span class="line">        Handler handler) throws CameraAccessException &#123;</span><br><span class="line">    if (request == null) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;request must not be null&quot;);</span><br><span class="line">    &#125; else if (request.isReprocess()) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;repeating reprocess requests are not supported&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    checkNotClosed();</span><br><span class="line">    handler = checkHandler(handler, callback);</span><br><span class="line">    ...</span><br><span class="line">    //å°†æ­¤è¯·æ±‚æ·»åŠ åˆ°å¾…å¤„ç†çš„åºåˆ—é‡Œ</span><br><span class="line">    return addPendingSequence(mDeviceImpl.setRepeatingRequest(request,createCaptureCallbackProxy(</span><br><span class="line">        handler, callback), mDeviceHandler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤åº”ç”¨å±‚çš„previewçš„è¯·æ±‚æµç¨‹åˆ†æç»“æŸï¼Œç»§ç»­åˆ†æå…¶ç»“æœå¤„ç†ï¼Œå¦‚æœpreviewå¼€å¯æˆåŠŸï¼Œåˆ™ä¼šå›è°ƒCaptureReadyCallbackçš„onReadyForCaptureæ–¹æ³•ï¼Œç°åœ¨åˆ†æCaptureReadyCallbackå›è°ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="keyword">new</span> CaptureReadyCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSetupFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mCameraOpenCloseLock.release();</span><br><span class="line">        Log.e(TAG, <span class="string">"Could not set up preview."</span>);</span><br><span class="line">        mMainThread.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (mCamera == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"Camera closed, aborting."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mCamera.close();</span><br><span class="line">                mCamera = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReadyForCapture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mCameraOpenCloseLock.release();</span><br><span class="line">        mMainThread.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Ready for capture."</span>);</span><br><span class="line">                <span class="keyword">if</span> (mCamera == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"Camera closed, aborting."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                onPreviewStarted();</span><br><span class="line">                onReadyStateChanged(<span class="keyword">true</span>);</span><br><span class="line">                mCamera.setReadyStateChangedListener(CaptureModule.<span class="keyword">this</span>);</span><br><span class="line">                mUI.initializeZoom(mCamera.getMaxZoom());</span><br><span class="line">                mCamera.setFocusStateListener(CaptureModule.<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‰é¢çš„åˆ†æï¼Œé¢„è§ˆæˆåŠŸåä¼šå›è°ƒonReadyForCaptureæ–¹æ³•ï¼Œå®ƒä¸»è¦æ˜¯é€šçŸ¥ä¸»çº¿ç¨‹çš„çŠ¶æ€æ”¹å˜ï¼Œå¹¶è®¾ç½®Cameraçš„ReadyStateChangedListenerçš„ç›‘å¬ï¼Œå…¶å›è°ƒæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReadyStateChanged</span><span class="params">(<span class="keyword">boolean</span> readyForCapture)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (readyForCapture) &#123;</span><br><span class="line">        mAppController.getCameraAppUI().enableModeOptions();</span><br><span class="line">    &#125;</span><br><span class="line">    mAppController.setShutterEnabled(readyForCapture);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä»£ç æ‰€ç¤ºï¼Œå½“å…¶çŠ¶æ€å˜æˆå‡†å¤‡å¥½æ‹ç…§ï¼Œåˆ™å°†ä¼šè°ƒç”¨CameraActivityçš„setShutterEnabledæ–¹æ³•ï¼Œå³ä½¿èƒ½å¿«é—¨æŒ‰é”®ï¼Œæ­¤æ—¶ä¹Ÿå°±æ˜¯è¯´é¢„è§ˆæˆåŠŸç»“æŸï¼Œå¯ä»¥æŒ‰å¿«é—¨è¿›è¡Œæ‹ç…§äº†ï¼Œæ‰€ä»¥ï¼Œåˆ°è¿™é‡Œï¼Œåº”ç”¨å±‚çš„previewçš„æµç¨‹åŸºæœ¬åˆ†æå®Œæ¯•ï¼Œä¸‹å›¾æ˜¯åº”ç”¨å±‚çš„å…³é”®è°ƒç”¨çš„æµç¨‹æ—¶åºå›¾ï¼š </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-01-preview_java_flow.png" alt="Alt text"></p><h5 id="1-2ã€Camera2-startPreviewçš„Nativeå±‚æµç¨‹åˆ†æ"><a href="#1-2ã€Camera2-startPreviewçš„Nativeå±‚æµç¨‹åˆ†æ" class="headerlink" title="1.2ã€Camera2 startPreviewçš„Nativeå±‚æµç¨‹åˆ†æ"></a>1.2ã€Camera2 startPreviewçš„Nativeå±‚æµç¨‹åˆ†æ</h5><p>åˆ†æPreviewçš„Nativeçš„ä»£ç çœŸæ˜¯è´¹äº†ä¹ç‰›äºŒè™ä¹‹åŠ›ï¼Œè‹¥æœ‰åˆ†æä¸æ­£ç¡®ä¹‹å¤„ï¼Œè¯·å„ä½å¤§ç¥æŒ‡æ­£ï¼Œåœ¨ç¬¬ä¸€å°èŠ‚çš„åæ®µæœ€åä¼šè°ƒç”¨CameraDeviceImplçš„setRepeatingRequestæ–¹æ³•æ¥æäº¤è¯·æ±‚ï¼Œè€Œåœ¨android6.0æºç åˆ†æä¹‹Camera API2.0ç®€ä»‹ä¸­ï¼Œåˆ†æäº†Camera2æ¡†æ¶Java IPCé€šä¿¡ä½¿ç”¨äº†CameraDeviceUseræ¥è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥çœ‹Nativeå±‚çš„ICameraDeviceUserçš„onTransactæ–¹æ³•æ¥å¤„ç†è¯·æ±‚çš„æäº¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.aidl]</span><br><span class="line">status_t BnCameraDeviceUser::onTransact(uint32_t code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, </span><br><span class="line">        uint32_t flags)&#123;</span><br><span class="line">    <span class="keyword">switch</span>(code) &#123;</span><br><span class="line">        â€¦</span><br><span class="line">        <span class="comment">//è¯·æ±‚æäº¤</span></span><br><span class="line">        <span class="keyword">case</span> SUBMIT_REQUEST: &#123;</span><br><span class="line">            CHECK_INTERFACE(ICameraDeviceUser, data, reply);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// arg0 = request</span></span><br><span class="line">            sp&lt;CaptureRequest&gt; request;</span><br><span class="line">            <span class="keyword">if</span> (data.readInt32() != <span class="number">0</span>) &#123;</span><br><span class="line">                request = <span class="keyword">new</span> CaptureRequest();</span><br><span class="line">                request-&gt;readFromParcel(const_cast&lt;Parcel*&gt;(&amp;data));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// arg1 = streaming (bool)</span></span><br><span class="line">            bool repeating = data.readInt32();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// return code: requestId (int32)</span></span><br><span class="line">            reply-&gt;writeNoException();</span><br><span class="line">            int64_t lastFrameNumber = -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//å°†å®ç°BnCameraDeviceUserçš„å¯¹ä¸‹å²—çš„submitRequestæ–¹æ³•ä»£ç å†™å…¥Binder</span></span><br><span class="line">            reply-&gt;writeInt32(submitRequest(request, repeating, &amp;lastFrameNumber));</span><br><span class="line">            reply-&gt;writeInt32(<span class="number">1</span>);</span><br><span class="line">            reply-&gt;writeInt64(lastFrameNumber);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CameraDeviceClientBaseç»§æ‰¿äº†BnCameraDeviceUserç±»ï¼Œæ‰€ä»¥CameraDeviceClientBaseç›¸å½“äºIPC Binderä¸­çš„clientï¼Œæ‰€ä»¥ä¼šè°ƒç”¨å…¶submitRequestæ–¹æ³•ï¼Œæ­¤å¤„ï¼Œè‡³äºIPC Binderé€šä¿¡åŸç†ä¸åšåˆ†æï¼Œå…¶å‚ç…§å…¶å®ƒèµ„æ–™ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp]</span><br><span class="line"><span class="keyword">status_t</span> CameraDeviceClient::submitRequest(sp&lt;CaptureRequest&gt; request,<span class="keyword">bool</span> streaming,</span><br><span class="line">        <span class="comment">/*out*/</span><span class="keyword">int64_t</span>* lastFrameNumber) &#123;</span><br><span class="line">    List&lt;sp&lt;CaptureRequest&gt; &gt; requestList;</span><br><span class="line">    requestList.push_back(request);</span><br><span class="line">    <span class="keyword">return</span> submitRequestList(requestList, streaming, lastFrameNumber);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•çš„è°ƒç”¨ï¼Œç»§ç»­åˆ†æsubmitRequestListï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp]</span><br><span class="line"><span class="keyword">status_t</span> CameraDeviceClient::submitRequestList(List&lt;sp&lt;CaptureRequest&gt; &gt; requests,<span class="keyword">bool</span> streaming, </span><br><span class="line">        <span class="keyword">int64_t</span>* lastFrameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//Metadataé“¾è¡¨</span></span><br><span class="line">    List&lt;<span class="keyword">const</span> CameraMetadata&gt; metadataRequestList;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (List&lt;sp&lt;CaptureRequest&gt; &gt;::iterator it = requests.begin(); it != requests.end(); ++it) &#123;</span><br><span class="line">        sp&lt;CaptureRequest&gt; request = *it;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–Metadataæ•°æ®</span></span><br><span class="line">        <span class="function">CameraMetadata <span class="title">metadata</span><span class="params">(request-&gt;mMetadata)</span></span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//è®¾ç½®Streamçš„å®¹é‡</span></span><br><span class="line">        Vector&lt;<span class="keyword">int32_t</span>&gt; outputStreamIds;</span><br><span class="line">        outputStreamIds.setCapacity(request-&gt;mSurfaceList.size());</span><br><span class="line">        <span class="comment">//å¾ªç¯åˆå§‹åŒ–Surface</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; request-&gt;mSurfaceList.size(); ++i) &#123;</span><br><span class="line">            sp&lt;Surface&gt; surface = request-&gt;mSurfaceList[i];</span><br><span class="line">            <span class="keyword">if</span> (surface == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            sp&lt;IGraphicBufferProducer&gt; gbp = surface-&gt;getIGraphicBufferProducer();</span><br><span class="line">            <span class="keyword">int</span> idx = mStreamMap.indexOfKey(IInterface::asBinder(gbp));</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">int</span> streamId = mStreamMap.valueAt(idx);</span><br><span class="line">            outputStreamIds.push_back(streamId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ›´æ–°æ•°æ®</span></span><br><span class="line">        metadata.update(ANDROID_REQUEST_OUTPUT_STREAMS, &amp;outputStreamIds[<span class="number">0</span>],</span><br><span class="line">                        outputStreamIds.size());</span><br><span class="line">        <span class="keyword">if</span> (request-&gt;mIsReprocess) &#123;</span><br><span class="line">            metadata.update(ANDROID_REQUEST_INPUT_STREAMS, &amp;mInputStream.id, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        metadata.update(ANDROID_REQUEST_ID, &amp;requestId, <span class="comment">/*size*/</span><span class="number">1</span>);</span><br><span class="line">        loopCounter++; <span class="comment">// loopCounter starts from 1</span></span><br><span class="line">        <span class="comment">//å‹æ ˆ</span></span><br><span class="line">        metadataRequestList.push_back(metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    mRequestIdCounter++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (streaming) &#123;</span><br><span class="line">        <span class="comment">//é¢„è§ˆä¼šèµ°æ­¤æ¡é€šé“</span></span><br><span class="line">        res = mDevice-&gt;setStreamingRequestList(metadataRequestList, lastFrameNumber);</span><br><span class="line">        <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mStreamingRequestList.push_back(requestId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//Captureç­‰èµ°æ­¤æ¡é€šé“</span></span><br><span class="line">        res = mDevice-&gt;captureList(metadataRequestList, lastFrameNumber);</span><br><span class="line">        <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (res == OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> requestId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>setStreamingRequestListå’ŒcaptureListæ–¹æ³•éƒ½è°ƒç”¨äº†submitRequestsHelperæ–¹æ³•ï¼Œåªæ˜¯ä»–ä»¬çš„repeatingå‚æ•°ä¸€ä¸ªture,ä¸€ä¸ªä¸ºfalseï¼Œè€Œæœ¬èŠ‚åˆ†æçš„previewè°ƒç”¨çš„æ˜¯setStreamingRequestListæ–¹æ³•ï¼Œå¹¶ä¸”API2.0ä¸‹Deviceçš„å®ç°ä¸ºCamera3Deviceï¼Œæ‰€ä»¥çœ‹å®ƒçš„submitRequestsHelperå®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::submitRequestsHelper(<span class="keyword">const</span> List&lt;<span class="keyword">const</span> CameraMetadata&gt; &amp;requests, </span><br><span class="line">        <span class="keyword">bool</span> repeating,<span class="comment">/*out*/</span><span class="keyword">int64_t</span> *lastFrameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    RequestList requestList;</span><br><span class="line">    <span class="comment">//åœ¨è¿™é‡Œé¢ä¼šè¿›è¡ŒCaptureRequestçš„åˆ›å»ºï¼Œå¹¶è°ƒç”¨configureStreamLockedè¿›è¡Œstreamçš„é…ç½®ï¼Œä¸»è¦æ˜¯è®¾ç½®äº†ä¸€ä¸ªå›è°ƒcaptureResultCbï¼Œå³åé¢è¦åˆ†æçš„é‡è¦çš„å›è°ƒ</span></span><br><span class="line">    res = convertMetadataListToRequestListLocked(requests, <span class="comment">/*out*/</span>&amp;requestList);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (repeating) &#123;</span><br><span class="line">        <span class="comment">//çœ¼ç†Ÿä¸ï¼Œè¿™ä¸ªæ–¹æ³•åå’Œåº”ç”¨å±‚ä¸­CameraDeviceçš„setRepeatingRequestsä¸€æ ·</span></span><br><span class="line">        res = mRequestThread-&gt;setRepeatingRequests(requestList, lastFrameNumber);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸éœ€é‡å¤ï¼Œå³repeatingä¸ºfalseæ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æ¥è®²è¯·æ±‚æäº¤</span></span><br><span class="line">        res = mRequestThread-&gt;queueRequestList(requestList, lastFrameNumber);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-02-preview_native_architecture.png" alt="Alt text"></p><p>ä»ä»£ç å¯çŸ¥ï¼Œåœ¨Camera3Deviceé‡Œåˆ›å»ºäº†è¦ç»™RequestThreadçº¿ç¨‹ï¼Œè°ƒç”¨å®ƒçš„setRepeatingRequestsæˆ–è€…queueRequestListæ–¹æ³•æ¥å°†åº”ç”¨å±‚å‘é€è¿‡æ¥çš„Requestæäº¤ï¼Œç»§ç»­çœ‹setRepeatingRequestsæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::RequestThread::setRepeatingRequests(<span class="keyword">const</span> RequestList &amp;requests,</span><br><span class="line">        <span class="comment">/*out*/</span><span class="keyword">int64_t</span> *lastFrameNumber) &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mRequestLock)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (lastFrameNumber != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *lastFrameNumber = mRepeatingLastFrameNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    mRepeatingRequests.clear();</span><br><span class="line">    <span class="comment">//å°†å…¶æ’å…¥mRepeatingRequesté“¾è¡¨</span></span><br><span class="line">    mRepeatingRequests.insert(mRepeatingRequests.begin(),</span><br><span class="line">            requests.begin(), requests.end());</span><br><span class="line"></span><br><span class="line">    unpauseForNewRequests();</span><br><span class="line"></span><br><span class="line">    mRepeatingLastFrameNumber = NO_IN_FLIGHT_REPEATING_FRAMES;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒNativeå±‚çš„previewè¿‡ç¨‹åŸºæœ¬åˆ†æç»“æŸï¼Œä¸‹é¢çš„å·¥ä½œå°†ä¼šäº¤ç»™Camera HALå±‚æ¥å¤„ç†ï¼Œå…ˆç»™å‡ºNativeå±‚çš„è°ƒç”¨æ—¶åºå›¾ï¼š </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-03-preview_native_flow.png" alt="Alt text"></p><h5 id="1-3ã€Camera2-startPreviewçš„HALå±‚æµç¨‹åˆ†æ"><a href="#1-3ã€Camera2-startPreviewçš„HALå±‚æµç¨‹åˆ†æ" class="headerlink" title="1.3ã€Camera2 startPreviewçš„HALå±‚æµç¨‹åˆ†æ"></a>1.3ã€Camera2 startPreviewçš„HALå±‚æµç¨‹åˆ†æ</h5><p>æœ¬èŠ‚å°†ä¸å†å¯¹Cameraçš„HALå±‚çš„åˆå§‹åŒ–ä»¥åŠç›¸å…³é…ç½®è¿›è¡Œåˆ†æï¼Œåªå¯¹previewç­‰ç›¸å…³æµç¨‹ä¸­çš„frame metadataçš„å¤„ç†æµç¨‹è¿›è¡Œåˆ†æï¼Œå…·ä½“çš„CameraHALåˆ†æè¯·å‚è€ƒå‰ä¸€ç¯‡åˆ†æï¼Œåœ¨ç¬¬äºŒå°èŠ‚çš„submitRequestsHelperæ–¹æ³•ä¸­è°ƒç”¨convertMetadataListToRequestListLockedçš„æ—¶å€™ä¼šè¿›è¡ŒCaptureRequestçš„åˆ›å»ºï¼Œå¹¶è°ƒç”¨configureStreamLockedè¿›è¡Œstreamçš„é…ç½®ï¼Œä¸»è¦æ˜¯è®¾ç½®äº†ä¸€ä¸ªå›è°ƒcaptureResultCbï¼Œæ‰€ä»¥Nativeå±‚åœ¨requestæäº¤åï¼Œä¼šå›è°ƒæ­¤captureResultCbæ–¹æ³•ï¼Œé¦–å…ˆåˆ†æcaptureResultCbï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/camera/QCamera2/HAL3/QCamera3HWI.cpp]</span><br><span class="line"><span class="keyword">void</span> QCamera3HardwareInterface::captureResultCb(<span class="keyword">mm_camera_super_buf_t</span> *metadata_buf,</span><br><span class="line">        <span class="keyword">camera3_stream_buffer_t</span> *buffer, <span class="keyword">uint32_t</span> frame_number)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (metadata_buf) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mBatchSize) &#123;</span><br><span class="line">            <span class="comment">//æ‰¹å¤„ç†æ¨¡å¼ï¼Œä½†ä»£ç ä¹Ÿæ˜¯å¾ªç¯è°ƒç”¨handleMetadataWithLockæ–¹æ³•</span></span><br><span class="line">            handleBatchMetadata(metadata_buf, <span class="literal">true</span> <span class="comment">/* free_and_bufdone_meta_buf */</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">/* mBatchSize = 0 */</span></span><br><span class="line">            pthread_mutex_lock(&amp;mMutex);    </span><br><span class="line">            <span class="comment">//å¤„ç†å…ƒæ•°æ®</span></span><br><span class="line">            handleMetadataWithLock(metadata_buf, <span class="literal">true</span> <span class="comment">/* free_and_bufdone_meta_buf */</span>);</span><br><span class="line">            pthread_mutex_unlock(&amp;mMutex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;mMutex);</span><br><span class="line">        handleBufferWithLock(buffer, frame_number);</span><br><span class="line">        pthread_mutex_unlock(&amp;mMutex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ç§æ˜¯é€šè¿‡å¾ªç¯æ¥è¿›è¡Œå…ƒæ•°æ®çš„æ‰¹å¤„ç†ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥è¿›è¡Œå…ƒæ•°æ®çš„å¤„ç†ï¼Œä½†æ˜¯æ‰¹å¤„ç†æœ€ç»ˆä¹Ÿæ˜¯å¾ªç¯è°ƒç”¨handleMetadataWithLockæ¥å¤„ç†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/camera/QCamera2/HAL3/QCamera3HWI.cpp]</span><br><span class="line"><span class="keyword">void</span> QCamera3HardwareInterface::handleMetadataWithLock(<span class="keyword">mm_camera_super_buf_t</span> *metadata_buf, </span><br><span class="line">        <span class="keyword">bool</span> free_and_bufdone_meta_buf)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//Partial result on process_capture_result for timestamp</span></span><br><span class="line">    <span class="keyword">if</span> (urgent_frame_number_valid) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">for</span> (List&lt;PendingRequestInfo&gt;::iterator i =mPendingRequestsList.begin(); </span><br><span class="line">                i != mPendingRequestsList.end(); i++) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (i-&gt;frame_number == urgent_frame_number &amp;&amp;i-&gt;bUrgentReceived == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">camera3_capture_result_t</span> result;</span><br><span class="line">                <span class="built_in">memset</span>(&amp;result, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">camera3_capture_result_t</span>));</span><br><span class="line">                i-&gt;partial_result_cnt++;</span><br><span class="line">                i-&gt;bUrgentReceived = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//æå–3Aæ•°æ®</span></span><br><span class="line">                result.result =translateCbUrgentMetadataToResultMetadata(metadata);</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">//å¯¹Capture Resultè¿›è¡Œå¤„ç†</span></span><br><span class="line">                mCallbackOps-&gt;process_capture_result(mCallbackOps, &amp;result);</span><br><span class="line">                <span class="comment">//é‡Šæ”¾camera_metadata_t</span></span><br><span class="line">                free_camera_metadata((<span class="keyword">camera_metadata_t</span> *)result.result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (List&lt;PendingRequestInfo&gt;::iterator i = mPendingRequestsList.begin();</span><br><span class="line">            i != mPendingRequestsList.end() &amp;&amp; i-&gt;frame_number &lt;= frame_number;) &#123;</span><br><span class="line">        <span class="keyword">camera3_capture_result_t</span> result;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;result, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">camera3_capture_result_t</span>));</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (i-&gt;frame_number &lt; frame_number) &#123;</span><br><span class="line">            <span class="comment">//æ¸…ç©ºæ•°æ®ç»“æ„</span></span><br><span class="line">            <span class="keyword">camera3_notify_msg_t</span> notify_msg;</span><br><span class="line">            <span class="built_in">memset</span>(&amp;notify_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">camera3_notify_msg_t</span>));</span><br><span class="line">            <span class="comment">//å®šä¹‰æ¶ˆæ¯ç±»å‹</span></span><br><span class="line">            notify_msg.type = CAMERA3_MSG_SHUTTER;</span><br><span class="line">            notify_msg.message.shutter.frame_number = i-&gt;frame_number;</span><br><span class="line">            notify_msg.message.shutter.timestamp = (<span class="keyword">uint64_t</span>)capture_time (urgent_frame_number - </span><br><span class="line">                i-&gt;frame_number) * NSEC_PER_33MSEC;</span><br><span class="line">            <span class="comment">//è°ƒç”¨å›è°ƒé€šçŸ¥åº”ç”¨å±‚å‘ç”ŸCAMERA3_MSG_SHUTTERæ¶ˆæ¯</span></span><br><span class="line">            mCallbackOps-&gt;notify(mCallbackOps, &amp;notify_msg);</span><br><span class="line">            ...</span><br><span class="line">            CameraMetadata dummyMetadata;</span><br><span class="line">            <span class="comment">//æ›´æ–°å…ƒæ•°æ®</span></span><br><span class="line">            dummyMetadata.update(ANDROID_SENSOR_TIMESTAMP,</span><br><span class="line">                    &amp;i-&gt;timestamp, <span class="number">1</span>);</span><br><span class="line">            dummyMetadata.update(ANDROID_REQUEST_ID,</span><br><span class="line">                    &amp;(i-&gt;request_id), <span class="number">1</span>);</span><br><span class="line">            <span class="comment">//å¾—åˆ°å…ƒæ•°æ®é‡Šæ”¾ç»“æœ</span></span><br><span class="line">            result.result = dummyMetadata.release();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">camera3_notify_msg_t</span> notify_msg;</span><br><span class="line">            <span class="built_in">memset</span>(&amp;notify_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">camera3_notify_msg_t</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Send shutter notify to frameworks</span></span><br><span class="line">            notify_msg.type = CAMERA3_MSG_SHUTTER;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//ä»HALä¸­è·å¾—Metadata</span></span><br><span class="line">            result.result = translateFromHalMetadata(metadata,</span><br><span class="line">                    i-&gt;timestamp, i-&gt;request_id, i-&gt;jpegMetadata, i-&gt;pipeline_depth,</span><br><span class="line">                    i-&gt;capture_intent);</span><br><span class="line">            saveExifParams(metadata);</span><br><span class="line">            <span class="keyword">if</span> (i-&gt;blob_request) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (enabled &amp;&amp; metadata-&gt;is_tuning_params_valid) &#123;</span><br><span class="line">                    <span class="comment">//å°†Metadataå¤åˆ¶åˆ°æ–‡ä»¶</span></span><br><span class="line">                    dumpMetadataToFile(metadata-&gt;tuning_params, mMetaFrameCount, enabled,</span><br><span class="line">                        <span class="string">"Snapshot"</span>,frame_number);</span><br><span class="line">                &#125;</span><br><span class="line">                mPictureChannel-&gt;queueReprocMetadata(metadata_buf);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Return metadata buffer</span></span><br><span class="line">                <span class="keyword">if</span> (free_and_bufdone_meta_buf) &#123;</span><br><span class="line">                    mMetadataChannel-&gt;bufDone(metadata_buf);</span><br><span class="line">                    <span class="built_in">free</span>(metadata_buf);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨å›è°ƒçš„process_capture_resultæ–¹æ³•æ¥å¯¹Capture Resultè¿›è¡Œå¤„ç†ï¼Œç„¶åä¼šè°ƒç”¨å›è°ƒçš„notifyæ–¹æ³•æ¥å‘é€ä¸€ä¸ªCAMERA3_MSG_SHUTTERæ¶ˆæ¯ï¼Œè€Œprocess_capture_resultæ‰€å¯¹åº”çš„å®ç°å…¶å®å°±æ˜¯Camera3Deviceçš„processCaptureResultæ–¹æ³•ï¼Œå…ˆåˆ†æprocessCaptureResultï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line">void Camera3Device::processCaptureResult(const camera3_capture_result *result) &#123;</span><br><span class="line">    ...</span><br><span class="line">    //å¯¹äºHAL3.2+,å¦‚æœHALä¸æ”¯æŒpartialï¼Œå½“metadataè¢«åŒ…å«åœ¨resultä¸­æ—¶ï¼Œå®ƒå¿…é¡»å°†partial_resultè®¾ç½®ä¸º1</span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock l(mInFlightLock);</span><br><span class="line">        ssize_t idx = mInFlightMap.indexOfKey(frameNumber);</span><br><span class="line">        ...</span><br><span class="line">        InFlightRequest &amp;request = mInFlightMap.editValueAt(idx);</span><br><span class="line">        if (result-&gt;partial_result != 0)</span><br><span class="line">            request.resultExtras.partialResultCount = result-&gt;partial_result;</span><br><span class="line">        // æ£€æŸ¥ç»“æœæ˜¯å¦åªæœ‰partial metadata</span><br><span class="line">        if (mUsePartialResult &amp;&amp; result-&gt;result != NULL) &#123;</span><br><span class="line">            if (mDeviceVersion &gt;= CAMERA_DEVICE_API_VERSION_3_2) &#123;//HALç‰ˆæœ¬é«˜äº3.2</span><br><span class="line">                if (result-&gt;partial_result &gt; mNumPartialResults || result-&gt;partial_result &lt; 1) &#123;</span><br><span class="line">                    //Logæ˜¾ç¤ºé”™è¯¯</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                isPartialResult = (result-&gt;partial_result &lt; mNumPartialResults);</span><br><span class="line">                if (isPartialResult) &#123;</span><br><span class="line">                    //å°†ç»“æœåŠ å…¥åˆ°è¯·æ±‚çš„ç»“æœé›†ä¸­</span><br><span class="line">                    request.partialResult.collectedResult.append(result-&gt;result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;//ä½äº3.2</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            if (isPartialResult) &#123;</span><br><span class="line">                // Fire off a 3A-only result if possible</span><br><span class="line">                if (!request.partialResult.haveSent3A) &#123;</span><br><span class="line">                    request.partialResult.haveSent3A =processPartial3AResult(frameNumber,</span><br><span class="line">                        request.partialResult.collectedResult,request.resultExtras);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        if (result-&gt;result != NULL &amp;&amp; !isPartialResult) &#123;</span><br><span class="line">            if (shutterTimestamp == 0) &#123;</span><br><span class="line">                request.pendingMetadata = result-&gt;result;</span><br><span class="line">                request.partialResult.collectedResult = collectedPartialResult;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                CameraMetadata metadata;</span><br><span class="line">                metadata = result-&gt;result;</span><br><span class="line">                //å‘é€Capture Result</span><br><span class="line">                sendCaptureResult(metadata, request.resultExtras, collectedPartialResult, </span><br><span class="line">                    frameNumber, hasInputBufferInRequest,request.aeTriggerCancelOverride);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //ç»“æœå¤„ç†å¥½äº†ï¼Œå°†è¯·æ±‚ç§»é™¤</span><br><span class="line">        removeInFlightRequestIfReadyLocked(idx);</span><br><span class="line">    &#125; // scope for mInFlightLock</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒä¼šå¤„ç†å±€éƒ¨çš„æˆ–è€…å…¨éƒ¨çš„metadataæ•°æ®ï¼Œæœ€åå¦‚æœresultä¸ä¸ºç©ºï¼Œä¸”å¾—åˆ°çš„æ˜¯è¯·æ±‚å¤„ç†çš„å…¨éƒ¨æ•°æ®ï¼Œåˆ™ä¼šè°ƒç”¨sendCaptureResultæ–¹æ³•æ¥å°†è¯·æ±‚ç»“æœå‘é€å‡ºå»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line"><span class="keyword">void</span> Camera3Device::sendCaptureResult(CameraMetadata &amp;pendingMetadata,CaptureResultExtras </span><br><span class="line">        &amp;resultExtras,CameraMetadata &amp;collectedPartialResult,<span class="keyword">uint32_t</span> frameNumber,<span class="keyword">bool</span> reprocess,</span><br><span class="line">        <span class="keyword">const</span> AeTriggerCancelOverride_t &amp;aeTriggerCancelOverride) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pendingMetadata.isEmpty())<span class="comment">//å¦‚æœæ•°æ®ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    ...</span><br><span class="line">    CaptureResult captureResult;</span><br><span class="line">    captureResult.mResultExtras = resultExtras;</span><br><span class="line">    captureResult.mMetadata = pendingMetadata;</span><br><span class="line">    <span class="comment">//æ›´æ–°metadata</span></span><br><span class="line">    <span class="keyword">if</span> (captureResult.mMetadata.update(ANDROID_REQUEST_FRAME_COUNT(<span class="keyword">int32_t</span>*)&amp;frameNumber, <span class="number">1</span>) </span><br><span class="line">            != OK) &#123;</span><br><span class="line">        SET_ERR(<span class="string">"Failed to set frame# in metadata (%d)"</span>,frameNumber);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append any previous partials to form a complete result</span></span><br><span class="line">    <span class="keyword">if</span> (mUsePartialResult &amp;&amp; !collectedPartialResult.isEmpty()) &#123;</span><br><span class="line">        captureResult.mMetadata.append(collectedPartialResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ’åº</span></span><br><span class="line">    captureResult.mMetadata.sort();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check that there's a timestamp in the result metadata</span></span><br><span class="line">    camera_metadata_entry entry = captureResult.mMetadata.find(ANDROID_SENSOR_TIMESTAMP);</span><br><span class="line">    ...</span><br><span class="line">    overrideResultForPrecaptureCancel(&amp;captureResult.mMetadata, aeTriggerCancelOverride);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ‰æ•ˆçš„ç»“æœï¼Œå°†å…¶æ’å…¥Buffer</span></span><br><span class="line">    List&lt;CaptureResult&gt;::iterator queuedResult =mResultQueue.insert(mResultQueue.end(), </span><br><span class="line">        CaptureResult(captureResult));</span><br><span class="line">    ...</span><br><span class="line">    mResultSignal.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œå®ƒå°†Capture Resultæ’å…¥äº†ç»“æœé˜Ÿåˆ—ï¼Œå¹¶é‡Šæ”¾äº†ç»“æœçš„ä¿¡å·é‡ï¼Œæ‰€ä»¥åˆ°è¿™é‡Œï¼ŒCapture Resultå¤„ç†æˆåŠŸï¼Œä¸‹é¢åˆ†æå‰é¢çš„notifyå‘é€CAMERA3_MSG_SHUTTERæ¶ˆæ¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line"><span class="keyword">void</span> Camera3Device::notify(<span class="keyword">const</span> camera3_notify_msg *msg) &#123;</span><br><span class="line"></span><br><span class="line">    NotificationListener *listener;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mOutputLock)</span></span>;</span><br><span class="line">        listener = mListener;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> CAMERA3_MSG_ERROR: &#123;</span><br><span class="line">            notifyError(msg-&gt;message.error, listener);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> CAMERA3_MSG_SHUTTER: &#123;</span><br><span class="line">            notifyShutter(msg-&gt;message.shutter, listener);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            SET_ERR(<span class="string">"Unknown notify message from HAL: %d"</span>,</span><br><span class="line">                    msg-&gt;type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒè°ƒç”¨äº†notifyShutteræ–¹æ³•ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line"><span class="keyword">void</span> Camera3Device::notifyShutter(<span class="keyword">const</span> <span class="keyword">camera3_shutter_msg_t</span> &amp;msg,</span><br><span class="line">        NotificationListener *listener) &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Set timestamp for the request in the in-flight tracking</span></span><br><span class="line">    <span class="comment">// and get the request ID to send upstream</span></span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mInFlightLock)</span></span>;</span><br><span class="line">        idx = mInFlightMap.indexOfKey(msg.frame_number);</span><br><span class="line">        <span class="keyword">if</span> (idx &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            InFlightRequest &amp;r = mInFlightMap.editValueAt(idx);</span><br><span class="line">            <span class="comment">// Call listener, if any</span></span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨ç›‘å¬çš„notifyShutteræ³•å›½æ³•</span></span><br><span class="line">                listener-&gt;notifyShutter(r.resultExtras, msg.timestamp);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//å°†å¾…å¤„ç†çš„resultå‘é€åˆ°Buffer</span></span><br><span class="line">            sendCaptureResult(r.pendingMetadata, r.resultExtras,</span><br><span class="line">                r.partialResult.collectedResult, msg.frame_number,</span><br><span class="line">                r.hasInputBuffer, r.aeTriggerCancelOverride);</span><br><span class="line">            returnOutputBuffers(r.pendingOutputBuffers.<span class="built_in">array</span>(),</span><br><span class="line">                r.pendingOutputBuffers.size(), r.shutterTimestamp);</span><br><span class="line">            r.pendingOutputBuffers.clear();</span><br><span class="line">            removeInFlightRequestIfReadyLocked(idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é¦–å…ˆå®ƒä¼šé€šçŸ¥listener previewæˆåŠŸï¼Œæœ€åä¼šè°ƒç”¨sendCaptureResultå°†ç»“æœåŠ å…¥åˆ°ç»“æœé˜Ÿåˆ—ã€‚å®ƒä¼šè°ƒç”¨listenerçš„notifyShutteræ–¹æ³•ï¼Œæ­¤å¤„çš„listenerå…¶å®æ˜¯CameraDeviceClientç±»ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨CameraDeviceClientç±»çš„notifyShutteræ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp]</span><br><span class="line"><span class="keyword">void</span> CameraDeviceClient::notifyShutter(<span class="keyword">const</span> CaptureResultExtras&amp; resultExtras,<span class="keyword">nsecs_t</span> timestamp) &#123;</span><br><span class="line">    <span class="comment">// Thread safe. Don't bother locking.</span></span><br><span class="line">    sp&lt;ICameraDeviceCallbacks&gt; remoteCb = getRemoteCallback();</span><br><span class="line">    <span class="keyword">if</span> (remoteCb != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨åº”ç”¨å±‚çš„å›è°ƒ(CaptureCallbackçš„onCaptureStartedæ–¹æ³•)</span></span><br><span class="line">        remoteCb-&gt;onCaptureStarted(resultExtras, timestamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„çš„ICameraDeviceCallbackså¯¹åº”çš„æ˜¯Javaå±‚çš„CameraDeviceImpl.javaä¸­çš„å†…éƒ¨ç±»CameraDeviceCallbacksï¼Œæ‰€ä»¥ä¼šè°ƒç”¨å®ƒçš„onCaptureStartedæ–¹æ³•ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</span><br><span class="line">@Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureStarted</span><span class="params">(final CaptureResultExtras resultExtras, final <span class="keyword">long</span> timestamp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> requestId = resultExtras.getRequestId();</span><br><span class="line">    final <span class="keyword">long</span> frameNumber = resultExtras.getFrameNumber();</span><br><span class="line">    final CaptureCallbackHolder holder;</span><br><span class="line"></span><br><span class="line">    synchronized(mInterfaceLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mRemoteDevice == null) <span class="keyword">return</span>; <span class="comment">// Camera already closed</span></span><br><span class="line">        <span class="comment">// Get the callback for this frame ID, if there is one</span></span><br><span class="line">        holder = CameraDeviceImpl.<span class="keyword">this</span>.mCaptureCallbackMap.get(requestId);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Dispatch capture start notice</span></span><br><span class="line">        holder.getHandler().post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</span><br><span class="line">                <span class="keyword">if</span> (!CameraDeviceImpl.<span class="keyword">this</span>.isClosed()) &#123;</span><br><span class="line">                    holder.getCallback().onCaptureStarted(CameraDeviceImpl.<span class="keyword">this</span>,holder.getRequest(</span><br><span class="line">                        resultExtras.getSubsequenceId()),timestamp, frameNumber);</span><br><span class="line">                &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®ƒä¼šè°ƒç”¨OneCameraImpl.javaä¸­çš„mCaptureCallbackçš„onCaptureStartedæ–¹æ³•ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</span><br><span class="line"><span class="comment">//Common listener for preview frame metadata.  </span></span><br><span class="line"><span class="keyword">private</span> final CameraCaptureSession.CaptureCallback mCaptureCallback =</span><br><span class="line">    <span class="keyword">new</span> CameraCaptureSession.CaptureCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> onCaptureStarted(CameraCaptureSession session,CaptureRequest request, </span><br><span class="line">            <span class="keyword">long</span> timestamp,<span class="keyword">long</span> frameNumber) &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getTag() == RequestTag.CAPTURE&amp;&amp; mLastPictureCallback != null) &#123;</span><br><span class="line">                mLastPictureCallback.onQuickExpose();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>cameraå·¥ä½œæ—¶ï¼Œå­˜åœ¨äº†ï¼•ä¸­æµå¤„ç†çº¿ç¨‹å’Œä¸€ä¸ªä¸“é—¨å‘halå‘é€è¯·æ±‚çš„requestçº¿ç¨‹ã€‚çº¿ç¨‹ä¹‹é—´é€šè¿‡ä¿¡å·æ¥åŒæ­¥ï¼Œç¨ä¸æ³¨æ„å°±æä¸æ˜ç™½ä»£ç æ˜¯å¦‚ä½•è¿è¡Œçš„äº†ã€‚å…¶ä¸­å¾ˆå®¹æ˜“è®©æˆ‘ä»¬å¿½è§†çš„å°±æ˜¯åœ¨æµå‘é€ä¹‹å‰çš„parent-&gt;registerInFlight()è¯¥æ“ä½œå°†å½“å‰çš„è¯·æ±‚ä¿å­˜åˆ°ä¸€ä¸ªæ•°ç»„(å¯ä»¥ç†è§£æˆ)ä¸­ã€‚è¿™ä¸ªæ•°ç»„å¯¹è±¡åœ¨åç»­å›å¸§æ“ä½œä¸­ï¼Œä¼šå°†ç›¸åº”å¸§çš„shutter,æ—¶é—´æˆ³ä¿¡æ¯å¡«å……åˆ°å¯¹åº”çš„requestä¸­ï¼Œç´§æ¥ç€å°±æŠŠå¯¹åº”å¸§çš„ä¿¡æ¯è¿”å›ç»™appã€‚å¥½äº†å…ˆåˆ°è¿™å§ï¼Œä¸‹ä¸€ç¯‡åˆ†æCamera recordingæµç¨‹ã€‚</p></blockquote><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-04-preview_hal_architecture.png" alt="Alt text"></p><p>æ³¨æ„ï¼šCapture,previewä»¥åŠautoFocuséƒ½æ˜¯ä½¿ç”¨çš„è¿™ä¸ªå›è°ƒï¼Œè€ŒCaptureè°ƒç”¨çš„æ—¶å€™ï¼Œå…¶RequestTagä¸ºCAPTUREï¼Œè€ŒautoFocusçš„æ—¶å€™ä¸ºTAP_TO_FOCUS,è€Œpreviewè¯·æ±‚æ—¶æ²¡æœ‰å¯¹RequestTagè¿›è¡Œè®¾ç½®ï¼Œæ‰€ä»¥å›è°ƒåˆ°onCaptureStartedæ–¹æ³•æ—¶ï¼Œä¸éœ€è¦è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯åˆ°æ­¤æ—¶ï¼Œpreviewå·²ç»å¯åŠ¨æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œé¢„è§ˆäº†ï¼Œå…¶æ•°æ®éƒ½åœ¨bufferé‡Œã€‚æ‰€ä»¥åˆ°æ­¤æ—¶ï¼Œpreviewçš„æµç¨‹å…¨éƒ¨åˆ†æç»“æŸï¼Œä¸‹é¢ç»™å‡ºHALå±‚ä¸Šçš„æµç¨‹æ—¶åºå›¾ </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-05-preview_hal_flow.png" alt="Alt text"></p><h4 id="ï¼ˆäºŒï¼‰ã€Camera-System-takePictureæµç¨‹åˆ†æ"><a href="#ï¼ˆäºŒï¼‰ã€Camera-System-takePictureæµç¨‹åˆ†æ" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Camera System takePictureæµç¨‹åˆ†æ"></a>ï¼ˆäºŒï¼‰ã€Camera System takePictureæµç¨‹åˆ†æ</h4><p>ä¸TakePictureæ¯æ¯ç›¸å…³çš„ä¸»è¦æœ‰4ä¸ªçº¿ç¨‹CaptureSequencer,JpegProcessor,Camera3Device::RequestThread,FrameProcessorBaseå¦‚ä¸‹é¢çš„ä»£ç å¯ä»¥å‘ç°ï¼Œåœ¨Camera2clientå¯¹è±¡åˆå§‹åŒ–åï¼Œå·²ç»æœ‰ï¼“ä¸ªçº¿ç¨‹å·²ç»runèµ·æ¥äº†ï¼Œè¿˜æœ‰æœ‰ä¸€ä¸ªRequestThreadçº¿ç¨‹ä¼šåœ¨Camera3Deviceåˆå§‹åŒ–æ—¶åˆ›å»ºçš„ã€‚ä»–ä»¬å·¥ä½œéå¸¸å¯†åˆ‡ï¼Œå¦‚ä¸‹å¤§æ¦‚ç”»äº†ä¸€ä¸ªä»–ä»¬çš„å·¥ä½œæœºåˆ¶ï¼Œï¼”ä¸ªçº¿ç¨‹éƒ½æ˜¯é€šè¿‡Conditonæ¡ä»¶å˜é‡æ¥åŒæ­¥çš„ã€‚ </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-06-Camera3Device-RequestThread.png" alt="Alt text"></p><p>å‰é¢åˆ†æpreviewçš„æ—¶å€™ï¼Œå½“é¢„è§ˆæˆåŠŸåï¼Œä¼šä½¿èƒ½ShutterButtonï¼Œå³å¯ä»¥è¿›è¡Œæ‹ç…§ï¼Œå®šä½åˆ°ShutterButtonçš„ç›‘å¬äº‹ä»¶ä¸ºonShutterButtonClickæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShutterButtonClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Cameraæœªæ‰“å¼€</span></span><br><span class="line">    <span class="keyword">if</span> (mCamera == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> countDownDuration = mSettingsManager.getInteger(SettingsManager</span><br><span class="line">        .SCOPE_GLOBAL,Keys.KEY_COUNTDOWN_DURATION);</span><br><span class="line">    <span class="keyword">if</span> (countDownDuration &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å¼€å§‹å€’è®¡æ—¶</span></span><br><span class="line">        mAppController.getCameraAppUI().transitionToCancel();</span><br><span class="line">        mAppController.getCameraAppUI().hideModeOptions();</span><br><span class="line">        mUI.setCountdownFinishedListener(<span class="keyword">this</span>);</span><br><span class="line">        mUI.startCountdown(countDownDuration);</span><br><span class="line">        <span class="comment">// Will take picture later via listener callback.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å³åˆ»æ‹ç…§</span></span><br><span class="line">        takePictureNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œè¯»å–Cameraçš„é…ç½®ï¼Œåˆ¤æ–­é…ç½®æ˜¯å¦éœ€è¦å»¶æ—¶æ‹ç…§ï¼Œæ­¤å¤„åˆ†æä¸éœ€å»¶æ—¶çš„æƒ…å†µï¼Œå³è°ƒç”¨takePictureNowæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">takePictureNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mCamera == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"Not taking picture since Camera is closed."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºCaptureä¼šè¯å¹¶å¼€å¯ä¼šè¯</span></span><br><span class="line">    CaptureSession session = createAndStartCaptureSession();</span><br><span class="line">    <span class="comment">//è·å–Cameraçš„æ–¹å‘</span></span><br><span class="line">    <span class="keyword">int</span> orientation = mAppController.getOrientationManager()</span><br><span class="line">        .getDeviceOrientation().getDegrees();</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å›¾ç‰‡å‚æ•°</span></span><br><span class="line">    PhotoCaptureParameters params = <span class="keyword">new</span> PhotoCaptureParameters(</span><br><span class="line">            session.getTitle(), orientation, session.getLocation(),</span><br><span class="line">            mContext.getExternalCacheDir(), <span class="keyword">this</span>, mPictureSaverCallback,</span><br><span class="line">            mHeadingSensor.getCurrentHeading(), mZoomValue, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//è£…é…Session</span></span><br><span class="line">    decorateSessionAtCaptureTime(session);</span><br><span class="line">    <span class="comment">//æ‹ç…§</span></span><br><span class="line">    mCamera.takePicture(params, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒé¦–å…ˆè°ƒç”¨createAndStartCaptureSessionæ¥åˆ›å»ºä¸€ä¸ªCaptureSessionå¹¶ä¸”å¯åŠ¨ä¼šè¯,è¿™é‡Œå¹¶ä¸”ä¼šè¿›è¡Œåˆå§‹å‚æ•°çš„è®¾ç½®ï¼Œè­¬å¦‚è®¾ç½®CaptureModule(æ­¤å¤„å®å‚ä¸ºthis)ä¸ºå›¾ç‰‡å¤„ç†çš„å›è°ƒ(åé¢å†åˆ†æ)ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> CaptureSession <span class="title">createAndStartCaptureSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–ä¼šè¯æ—¶é—´</span></span><br><span class="line">    <span class="keyword">long</span> sessionTime = getSessionTime();</span><br><span class="line">    <span class="comment">//å½“å‰ä½ç½®</span></span><br><span class="line">    Location location = mLocationManager.getCurrentLocation();</span><br><span class="line">    <span class="comment">//è®¾ç½®picture name</span></span><br><span class="line">    String title = CameraUtil.instance().createJpegName(sessionTime);</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¼šè¯</span></span><br><span class="line">    CaptureSession session = getServices().getCaptureSessionManager()</span><br><span class="line">           .createNewSession(title, sessionTime, location);</span><br><span class="line">    <span class="comment">//å¼€å¯ä¼šè¯</span></span><br><span class="line">    session.startEmpty(<span class="keyword">new</span> CaptureStats(mHdrPlusEnabled),<span class="keyword">new</span> Size(</span><br><span class="line">        (<span class="keyword">int</span>) mPreviewArea.width(), (<span class="keyword">int</span>) mPreviewArea.height()));</span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line">é¦–å…ˆï¼Œè·å–ä¼šè¯çš„ç›¸å…³å‚æ•°ï¼ŒåŒ…æ‹¬ä¼šè¯æ—¶é—´ï¼Œæ‹ç…§çš„ç…§ç‰‡åå­—ä»¥åŠä½ç½®ä¿¡æ¯ç­‰ï¼Œç„¶åè°ƒç”¨Sessionç®¡ç†æ¥åˆ›å»ºCaptureSessionï¼Œæœ€åå°†æ­¤CaptureSessionå¯åŠ¨ã€‚åˆ°è¿™é‡Œï¼Œä¼šè¯å°±åˆ›å»ºå¹¶å¯åŠ¨äº†ï¼Œæ‰€ä»¥æ¥ç€åˆ†æä¸Šé¢çš„æ‹ç…§æµç¨‹ï¼Œå®ƒä¼šè°ƒç”¨OneCameraImplçš„takePictureæ–¹æ³•æ¥è¿›è¡Œæ‹ç…§ï¼š</span><br><span class="line"></span><br><span class="line">``` java</span><br><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takePicture</span><span class="params">(<span class="keyword">final</span> PhotoCaptureParameters params, <span class="keyword">final</span> CaptureSession session)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// é™¤éæ‹ç…§å·²ç»è¿”å›ï¼Œå¦åˆ™å°±å¹¿æ’­ä¸€ä¸ªæœªå‡†å¤‡å¥½çŠ¶æ€çš„å¹¿æ’­ï¼Œå³ç­‰å¾…æœ¬æ¬¡æ‹ç…§ç»“æŸ</span></span><br><span class="line">    broadcastReadyState(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    mTakePictureRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">//æ‹ç…§</span></span><br><span class="line">            takePictureNow(params, session);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//è®¾ç½®å›è°ƒï¼Œæ­¤å›è°ƒåé¢å°†åˆ†æï¼Œå®ƒå…¶å®å°±æ˜¯CaptureModule,å®ƒå®ç°äº†PictureCallback</span></span><br><span class="line">    mLastPictureCallback = params.callback;</span><br><span class="line">    mTakePictureStartMillis = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœéœ€è¦è‡ªåŠ¨èšç„¦</span></span><br><span class="line">    <span class="keyword">if</span> (mLastResultAFState == AutoFocusState.ACTIVE_SCAN) &#123;</span><br><span class="line">        mTakePictureWhenLensIsStopped = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//æ‹ç…§</span></span><br><span class="line">        takePictureNow(params, session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ‹ç…§é‡Œï¼Œé¦–å…ˆå¹¿æ’­ä¸€ä¸ªæœªå‡†å¤‡å¥½çš„çŠ¶æ€å¹¿æ’­ï¼Œç„¶åè¿›è¡Œæ‹ç…§çš„å›è°ƒè®¾ç½®ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦æœ‰è‡ªåŠ¨èšç„¦ï¼Œå¦‚æœæ˜¯åˆ™å°†mTakePictureWhenLensIsStopped è®¾ä¸ºtureï¼Œå³å³åˆ»æ‹ç…§è¢«åœæ­¢äº†ï¼Œå¦åˆ™åˆ™è°ƒç”¨OneCameraImplçš„takePictureNowæ–¹æ³•æ¥å‘èµ·æ‹ç…§è¯·æ±‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takePictureNow</span><span class="params">(PhotoCaptureParameters params, CaptureSession </span></span></span><br><span class="line"><span class="function"><span class="params">        session)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> dt = SystemClock.uptimeMillis() - mTakePictureStartMillis;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ„é€ JPEGå›¾ç‰‡æ‹ç…§çš„è¯·æ±‚</span></span><br><span class="line">        CaptureRequest.Builder builder = mDevice.createCaptureRequest(</span><br><span class="line">            CameraDevice.TEMPLATE_STILL_CAPTURE);</span><br><span class="line">        builder.setTag(RequestTag.CAPTURE);</span><br><span class="line">        addBaselineCaptureKeysToRequest(builder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Enable lens-shading correction for even better DNGs.</span></span><br><span class="line">        <span class="keyword">if</span> (sCaptureImageFormat == ImageFormat.RAW_SENSOR) &#123;</span><br><span class="line">            builder.set(CaptureRequest.STATISTICS_LENS_SHADING_MAP_MODE,</span><br><span class="line">                CaptureRequest.STATISTICS_LENS_SHADING_MAP_MODE_ON);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sCaptureImageFormat == ImageFormat.JPEG) &#123;</span><br><span class="line">            builder.set(CaptureRequest.JPEG_QUALITY, JPEG_QUALITY);</span><br><span class="line">                .getJpegRotation(params.orientation, mCharacteristics));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ç”¨äºpreviewçš„æ§ä»¶</span></span><br><span class="line">        builder.addTarget(mPreviewSurface);</span><br><span class="line">        <span class="comment">//ç”¨äºå›¾ç‰‡æ˜¾ç¤ºçš„æ§ä»¶</span></span><br><span class="line">        builder.addTarget(mCaptureImageReader.getSurface());</span><br><span class="line">        CaptureRequest request = builder.build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_WRITE_CAPTURE_DATA) &#123;</span><br><span class="line">            <span class="keyword">final</span> String debugDataDir = makeDebugDir(params.debugDataFolder,</span><br><span class="line">                        <span class="string">"normal_capture_debug"</span>);</span><br><span class="line">            Log.i(TAG, <span class="string">"Writing capture data to: "</span> + debugDataDir);</span><br><span class="line">            CaptureDataSerializer.toFile(<span class="string">"Normal Capture"</span>, request, </span><br><span class="line">                <span class="keyword">new</span> File(debugDataDir,<span class="string">"capture.txt"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‹ç…§ï¼ŒmCaptureCallbackä¸ºå›è°ƒ</span></span><br><span class="line">        mCaptureSession.capture(request, mCaptureCallback, mCameraHandler);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Could not access camera for still image capture."</span>);</span><br><span class="line">        broadcastReadyState(<span class="keyword">true</span>);</span><br><span class="line">        params.callback.onPictureTakingFailed();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mCaptureQueue) &#123;</span><br><span class="line">        mCaptureQueue.add(<span class="keyword">new</span> InFlightCapture(params, session));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸previewç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡CaptureRequestæ¥ä¸Cameraè¿›è¡Œé€šä¿¡çš„ï¼Œé€šè¿‡sessionçš„captureæ¥è¿›è¡Œæ‹ç…§ï¼Œå¹¶è®¾ç½®æ‹ç…§çš„å›è°ƒå‡½æ•°ä¸ºmCaptureCallbackï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/base/core/java/android/hardware/camera2/impl/CameraCaptureSessionImpl.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">capture</span><span class="params">(CaptureRequest request,CaptureCallback callback,Handler handler)</span><span class="keyword">throws</span> CameraAccessException</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    handler = checkHandler(handler,callback);</span><br><span class="line">    <span class="keyword">return</span> addPendingSequence(mDeviceImpl.capture(request,createCaptureCallbackProxy(</span><br><span class="line">        handler,callback),mDeviceHandler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸previewä¸­çš„ç±»ä¼¼ï¼Œéƒ½æ˜¯å°†è¯·æ±‚åŠ å…¥åˆ°å¾…å¤„ç†çš„è¯·æ±‚é›†ï¼Œç°åœ¨çœ‹CaptureCallbackå›è°ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CameraCaptureSession.CaptureCallback mCaptureCallback = <span class="keyword">new</span> CameraCaptureSession.CaptureCallback()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureStarted</span><span class="params">(CameraCaptureSession session,CaptureRequest request,<span class="keyword">long</span> </span></span></span><br><span class="line"><span class="function"><span class="params">            timestamp,<span class="keyword">long</span> frameNumber)</span></span>&#123;</span><br><span class="line">ã€€ã€€ã€€ã€€ã€€<span class="comment">//ä¸previewç±»ä¼¼</span></span><br><span class="line">        <span class="keyword">if</span>(request.getTag() == RequestTag.CAPTURE&amp;&amp;mLastPictureCallback!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            mLastPictureCallback.onQuickExpose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureCompleted</span><span class="params">(CameraCaptureSession session,CaptureRequest request</span></span></span><br><span class="line"><span class="function"><span class="params">            ,TotalCaptureResult result)</span></span>&#123;</span><br><span class="line">        autofocusStateChangeDispatcher(result);</span><br><span class="line">        <span class="keyword">if</span>(result.get(CaptureResult.CONTROL_AF_STATE) == <span class="keyword">null</span>)&#123;</span><br><span class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">//æ£€æŸ¥è‡ªåŠ¨èšç„¦çš„çŠ¶æ€</span></span><br><span class="line">            AutoFocusHelper.checkControlAfState(result);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span>(request.getTag() == RequestTag.CAPTURE)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(mCaptureQueue)&#123;</span><br><span class="line">                <span class="keyword">if</span>(mCaptureQueue.getFirst().setCaptureResult(result).isCaptureComplete())&#123;</span><br><span class="line">                    capture = mCaptureQueue.removeFirst();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(capture != <span class="keyword">null</span>)&#123;</span><br><span class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">//æ‹ç…§ç»“æŸ</span></span><br><span class="line">                OneCameraImpl.<span class="keyword">this</span>.onCaptureCompleted(capture);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onCaptureCompleted(session,request,result);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯Nativeå±‚åœ¨å¤„ç†è¯·æ±‚æ—¶ï¼Œä¼šè°ƒç”¨ç›¸åº”çš„å›è°ƒï¼Œå¦‚captureå¼€å§‹æ—¶ï¼Œä¼šå›è°ƒonCaptureStarted,å…·ä½“çš„åœ¨previewä¸­æœ‰è¿‡åˆ†æï¼Œå½“æ‹ç…§ç»“æŸæ—¶ï¼Œä¼šå›è°ƒonCaptureCompletedæ–¹æ³•ï¼Œå…¶ä¸­ä¼šæ ¹æ®CaptureResultæ¥æ£€æŸ¥è‡ªåŠ¨èšç„¦çš„çŠ¶æ€ï¼Œå¹¶é€šè¿‡TAGåˆ¤æ–­å…¶æ˜¯CaptureåŠ¨ä½œæ—¶ï¼Œå†æ¥çœ‹å®ƒæ˜¯å¦æ˜¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†è¯·æ±‚ç§»é™¤ï¼Œå› ä¸ºè¯·æ±‚å·²ç»å¤„ç†æˆåŠŸï¼Œæœ€åå†è°ƒç”¨OneCameraImplçš„onCaptureCompletedæ–¹æ³•æ¥è¿›è¡Œå¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCaptureCompleted</span><span class="params">(InFlightCapture capture)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(isCaptureImageFormat == ImageFormat.RAW_SENSOR)&#123;</span><br><span class="line">        ...</span><br><span class="line">        File dngFile = <span class="keyword">new</span> File(RAW_DIRECTORY,capture.session.getTitle()+<span class="string">".dng"</span>);</span><br><span class="line">        writeDngBytesAndClose(capture.image,capture.totalCaptureResult,mCharacteristics,dngFile);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//è§£æresultä¸­çš„å›¾ç‰‡æ•°æ®</span></span><br><span class="line">        <span class="keyword">byte</span>[] imageBytes = acquireJpegBytesAndClose(capture.image);</span><br><span class="line">        <span class="comment">//ä¿å­˜Jpegå›¾ç‰‡</span></span><br><span class="line">        saveJpegPicture(imageBytes,capture.parameters,capture.session,capture.totalCaptureResult);</span><br><span class="line">    &#125;</span><br><span class="line">    broadcastReadyState(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">//è°ƒç”¨å›è°ƒ</span></span><br><span class="line">    capture.parameters.callback.onPictureTaken(capture.session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä»£ç æ‰€ç¤ºï¼Œé¦–å…ˆï¼Œå¯¹resultä¸­çš„å›¾ç‰‡æ•°æ®è¿›è¡Œäº†è§£æï¼Œç„¶åè°ƒç”¨saveJpegPictureæ–¹æ³•å°†è§£æå¾—åˆ°çš„å›¾ç‰‡æ•°æ®è¿›è¡Œä¿å­˜ï¼Œæœ€åå†è°ƒç”¨é‡Œé¢çš„å›è°ƒ(å³CaptureModuleï¼Œå‰é¢åœ¨åˆå§‹åŒ–Parametersæ—¶è¯´æ˜äº†ï¼Œå®ƒå®ç°äº†PictureCallbakæ¥å£)çš„onPictureTakenæ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œæ¥ä¸‹æ¥å…ˆåˆ†æsaveJpegPictureæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/OneCameraImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveJpegPicture</span><span class="params">(<span class="keyword">byte</span>[] jpegData,<span class="keyword">final</span> PhotoCaptureParameters captureParams,CaptureSession session,CaptureResult result)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ListenableFuture&lt;Optional&lt;Uri&gt;&gt; futureUri = session.saveAndFinish(jpegData,width,</span><br><span class="line">            height,rotation,exif);</span><br><span class="line">    Futures.addCallback(futureUri,<span class="keyword">new</span> FutureCallback&lt;Optional&lt;Uri&gt;&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Optional&lt;Uri&gt; uriOptional)</span></span>&#123;</span><br><span class="line">            captureParams.callback.onPictureSaved(mOptional.orNull());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable throwable)</span></span>&#123;</span><br><span class="line">            captureParams.callback.onPictureSaved(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒæœ€åä¼šå›è°ƒonPictureSavedæ–¹æ³•æ¥å¯¹å›¾ç‰‡è¿›è¡Œä¿å­˜ï¼Œæ‰€ä»¥éœ€è¦åˆ†æCaptureModuleçš„onPictureSavedæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPictureSaved</span><span class="params">(Uri uri)</span></span>&#123;</span><br><span class="line">    mAppController.notifyNewMedia(uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mAppControllerçš„å®ç°ä¸ºCameraActivityï¼Œæ‰€ä»¥åˆ†ænotifyNewMediaæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CameraActivity.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyNewMedia</span><span class="params">(Uri uri)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(FilmstripItemUtils.isMimeTypeVideo(mimeType))&#123;</span><br><span class="line">ã€€ã€€ã€€ã€€<span class="comment">//å¦‚æœæ‹æ‘„çš„æ˜¯video</span></span><br><span class="line">        sendBroadcast(<span class="keyword">new</span> Intent(CameraUtil.ACTION_NEW_VIDEO,uri));</span><br><span class="line">        newData = mVideoItemFactory.queryContentUri(uri);</span><br><span class="line">        ...</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(FilmstripItemUtils.isMimeTypeImage(mimeType))&#123;</span><br><span class="line">ã€€ã€€ã€€ã€€<span class="comment">//å¦‚æœæ˜¯æ‹æ‘„å›¾ç‰‡</span></span><br><span class="line">        CameraUtil.broadcastNewPicture(mAppContext,uri);</span><br><span class="line">        newData = mPhotoItemFactory.queryCotentUri(uri);</span><br><span class="line">        ...</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> AsyncTask&lt;FilmstripItem,Void,FilmstripItem&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> FilmstripItem <span class="title">doInBackground</span><span class="params">(FilmstripItem... Params)</span></span>&#123;</span><br><span class="line">            FilmstripItem data = params[<span class="number">0</span>];</span><br><span class="line">            MetadataLoader.loadMetadata(getAndroidContet(),data);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æ•°æ®çš„å¤„ç†ï¼Œä¸€ç§æ˜¯videoï¼Œå¦ä¸€ç§æ˜¯imageã€‚è€Œæˆ‘ä»¬è¿™é‡Œåˆ†æçš„æ˜¯captureå›¾ç‰‡æ•°æ®ï¼Œæ‰€ä»¥é¦–å…ˆä¼šæ ¹æ®åœ¨å›è°ƒå‡½æ•°ä¼ å…¥çš„å‚æ•°Uriå’ŒPhotoItemFactoryæ¥æŸ¥è¯¢åˆ°ç›¸åº”çš„æ‹ç…§æ•°æ®ï¼Œç„¶åå†å¼€å¯ä¸€ä¸ªå¼‚æ­¥çš„Taskæ¥å¯¹æ­¤æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå³é€šè¿‡MetadataLoaderçš„loadMetadataæ¥åŠ è½½æ•°æ®ï¼Œå¹¶è¿”å›ã€‚è‡³æ­¤ï¼Œcaptureçš„æµç¨‹å°±åŸºæœ¬åˆ†æç»“æŸäº†ï¼Œä¸‹é¢å°†ç»™å‡ºcaptureæµç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ä¸­çš„æ—¶åºå›¾ï¼š </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-07-capture_over_flow.png" alt="Alt text"></p><h4 id="ï¼ˆä¸‰ï¼‰ã€Camera-System-takepicture-ZSL-æµç¨‹åˆ†æï¼ˆæœ¬å°èŠ‚åŸºäº-Android-5-1-API11æºç ï¼‰"><a href="#ï¼ˆä¸‰ï¼‰ã€Camera-System-takepicture-ZSL-æµç¨‹åˆ†æï¼ˆæœ¬å°èŠ‚åŸºäº-Android-5-1-API11æºç ï¼‰" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Camera System takepicture(ZSL)æµç¨‹åˆ†æï¼ˆæœ¬å°èŠ‚åŸºäº Android 5.1 API11æºç ï¼‰"></a>ï¼ˆä¸‰ï¼‰ã€Camera System takepicture(ZSL)æµç¨‹åˆ†æï¼ˆæœ¬å°èŠ‚åŸºäº Android 5.1 API11æºç ï¼‰</h4><p>ZSL(zear shutter lag)å³é›¶å»¶æ—¶ï¼Œå°±æ˜¯åœ¨æ‹ç…§æ—¶ä¸åœé¢„è§ˆå°±å¯ä»¥æ‹ç…§.ç”±äºæœ‰è¾ƒå¥½çš„ç”¨æˆ·ä½“éªŒåº¦ï¼Œè¯¥featureæ˜¯ç°åœ¨å¤§éƒ¨åˆ†æ‰‹æœºéƒ½æ‹¥æœ‰çš„åŠŸèƒ½ã€‚<br>é¢ä¸å†è´´å‡ºå¤§é‡ä»£ç æ¥æè¿°è¿‡ç¨‹ï¼Œç›´æ¥ä¸Šå›¾ã€‚ä¸‹å›¾æ˜¯ç”»äº†2ä¸ªå°æ—¶æ•´ç†å‡ºæ¥çš„Android5.1 Zslçš„åŸºæœ¬æµç¨‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸ZSLå¯†åˆ‡ç›¸å…³çš„æœ‰5ä¸ªçº¿ç¨‹frameprocessorã€captureSequencerã€ZslProcessor3ã€JpegProcessorã€Camera3Device:requestThreadã€‚å…¶å®è¿˜æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ç”¨äºæ›´æ–°å‚æ•°ã€‚é’ˆå¯¹Android5.1çœ‹ä»£ç æ‰€å¾—ï¼ŒZSLè¿‡ç¨‹ä¸­å¤§æ¦‚åˆ†æˆä¸‹é¢7ä¸ªæµç¨‹.</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-08-ZSL_takepicture.png" alt="Alt text"></p><p>æ›´æ­£ï¼šå›¾ä¸­å·¦ä¸Šè§’çš„FrameProcessorçº¿ç¨‹èµ·æ¥åä¼šåœ¨waitForNextFrameä¸­æ‰§è¡ŒmResultSignal.waitRelative()ï¼Œå›¾ä¸­æ²¡æœ‰æ›´æ”¹è¿‡æ¥ã€‚</p><h5 id="3-0ã€æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡"><a href="#3-0ã€æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡" class="headerlink" title="3.0ã€æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡"></a>3.0ã€æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡</h5><h5 id="3-0-1ã€captureSequenceçº¿ç¨‹æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡"><a href="#3-0-1ã€captureSequenceçº¿ç¨‹æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡" class="headerlink" title="3.0.1ã€captureSequenceçº¿ç¨‹æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡"></a>3.0.1ã€captureSequenceçº¿ç¨‹æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡</h5><h5 id="3-0-1-1ã€æ³¨å†Œæ—¶æœº"><a href="#3-0-1-1ã€æ³¨å†Œæ—¶æœº" class="headerlink" title="3.0.1.1ã€æ³¨å†Œæ—¶æœº"></a>3.0.1.1ã€æ³¨å†Œæ—¶æœº</h5><p>å½“ä¸Šå±‚å‘å‡ºZSLæ‹ç…§è¯·æ±‚æ—¶ï¼Œåº•å±‚å°±ä¼šè§¦å‘æ‹ç…§æ•è·çŠ¶æ€æœºï¼Œæ”¹çŠ¶æ€æœºçš„åŸºæœ¬æµç¨‹å›¾åœ¨ä¸Šç¯‡ç¬”è®°ä¸­å·²ç»æ•´ç†å‡ºæ¥è¿‡ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚ç”±äºcamera2Clientä¸å…¶å®ƒå¤„ç†çº¿ç¨‹å¯¹è±¡åŸºæœ¬ç¬¦åˆé‡‘å­—å¡”å½¢çš„æ¶æ„ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯é€šè¿‡camera2Clientçš„å¯¹è±¡å°†å¸§å¯ç”¨ç›‘å¬å¯¹è±¡æ³¨å†Œåˆ°FrameProcesså¯¹è±¡ä¸­çš„List<rangelistener> mRangeListeners;å¯¹è±¡ä¸­ã€‚</rangelistener></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/CaptureSequencer.cpp]</span><br><span class="line">CaptureSequencer::CaptureState CaptureSequencer::manageZslStart(</span><br><span class="line">        sp&lt;Camera2Client&gt; &amp;client) &#123;</span><br><span class="line">    ALOGV(<span class="string">"%s"</span>, __FUNCTION__);</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    sp&lt;ZslProcessorInterface&gt; processor = mZslProcessor.promote();</span><br><span class="line">    <span class="comment">// We don't want to get partial results for ZSL capture.</span></span><br><span class="line">    client-&gt;registerFrameListener(mCaptureId, mCaptureId + <span class="number">1</span>,</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            <span class="comment">/*sendPartials*/</span><span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Actually select the right thing here.</span></span><br><span class="line">    res = processor-&gt;pushToReprocess(mCaptureId);</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹åˆ«æ³¨æ„ï¼šå¯ä»¥çœ‹åˆ°åœ¨æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡æ—¶ï¼Œä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°æ˜¯mCaptureId, mCaptureId + 1,ä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·å‘¢,å› ä¸ºè¿™ä¸ªå°±æ˜¯æ ‡è®°æˆ‘ä»¬æƒ³æŠ“çš„æ˜¯å“ªä¸€å¸§,å½“æ‹ç…§bufferä»halä¸Šæ¥ä¹‹å,Camera3Deviceå°±ä¼šå›è°ƒå¸§å¯ç”¨ç›‘å¬å¯¹è±¡ï¼Œç„¶åå¾—åˆ°æ‹ç…§å¸§çš„æ—¶é—´æˆ³ï¼Œç´§æ¥ç€æ ¹æ®æ—¶é—´æˆ³ä»ZSL RingBufferä¸­æ‰¾åˆ°æœ€ç†æƒ³çš„inputBufferï¼Œç„¶åä¸‹å‘ç»™halè¿›è¡ŒJpegç¼–è§£ç ã€‚å¯¹æ¯”ä¸‹é¢ZSLçº¿ç¨‹çš„CaptureId,åº”è¯¥å°±ç†è§£äº†.</p><h5 id="3-0-1-2ã€æ•è·æ—¶æœº"><a href="#3-0-1-2ã€æ•è·æ—¶æœº" class="headerlink" title="3.0.1.2ã€æ•è·æ—¶æœº"></a>3.0.1.2ã€æ•è·æ—¶æœº</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/CaptureSequencer.cpp]</span><br><span class="line"><span class="keyword">void</span> CaptureSequencer::onResultAvailable(<span class="keyword">const</span> CaptureResult &amp;result) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    ALOGV(<span class="string">"%s: New result available."</span>, __FUNCTION__);</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mInputMutex)</span></span>;</span><br><span class="line">    mNewFrameId = result.mResultExtras.requestId;</span><br><span class="line">    mNewFrame = result.mMetadata;</span><br><span class="line">    <span class="keyword">if</span> (!mNewFrameReceived) &#123;</span><br><span class="line">        mNewFrameReceived = <span class="literal">true</span>;</span><br><span class="line">        .signal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å³æ˜¯æ‹ç…§çŠ¶æ€æœºæ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œå…¶ä¸­å½“ZSLæ‹ç…§å¸§ä¸Šæ¥ä¹‹åï¼Œæœºä¼šæ¿€æ´»æ­£åœ¨ç­‰å¾…ä¸­çš„CaptureSequencerçº¿ç¨‹ï¼Œä»¥è¿›è¡Œåç»­çš„æ“ä½œã€‚</p><h5 id="3-0-2ã€ZslProcess3çº¿ç¨‹æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡"><a href="#3-0-2ã€ZslProcess3çº¿ç¨‹æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡" class="headerlink" title="3.0.2ã€ZslProcess3çº¿ç¨‹æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡"></a>3.0.2ã€ZslProcess3çº¿ç¨‹æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡</h5><h5 id="3-0-2-1ã€æ³¨å†Œæ—¶æœº"><a href="#3-0-2-1ã€æ³¨å†Œæ—¶æœº" class="headerlink" title="3.0.2.1ã€æ³¨å†Œæ—¶æœº"></a>3.0.2.1ã€æ³¨å†Œæ—¶æœº</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/ZslProcessor.cpp]</span><br><span class="line"><span class="keyword">status_t</span> ZslProcessor::updateStream(<span class="keyword">const</span> Parameters &amp;params) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mZslStreamId == NO_STREAM) &#123;</span><br><span class="line">        <span class="comment">// Create stream for HAL production</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Sort out better way to select resolution for ZSL</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note that format specified internally in Camera3ZslStream</span></span><br><span class="line">        res = device-&gt;createZslStream(</span><br><span class="line">                params.fastInfo.arrayWidth, params.fastInfo.arrayHeight,</span><br><span class="line">                mBufferQueueDepth,</span><br><span class="line">                &amp;mZslStreamId,</span><br><span class="line">                &amp;mZslStream);</span><br><span class="line">        <span class="comment">// Only add the camera3 buffer listener when the stream is created.</span></span><br><span class="line">        mZslStream-&gt;addBufferListener(<span class="keyword">this</span>);<span class="comment">//è¿™é‡Œæ˜¯åœ¨BufferQueueæ³¨å†Œçš„callbackï¼Œæš‚æ—¶ä¸ç”¨å…³å¿ƒã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">    client-&gt;registerFrameListener(Camera2Client::kPreviewRequestIdStart,</span><br><span class="line">            Camera2Client::kPreviewRequestIdEnd,</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            <span class="comment">/*sendPartials*/</span><span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å³ä¸ºæ›´æ–°zslæµæ—¶è°ƒç”¨çš„å‡½æ•°,å¯ä»¥çœ‹åˆ°å…¶ä¸­ä½¿ç”¨registerFrameListeneræ³¨å†Œäº†RingBufferå¯ç”¨ç›‘å¬å¯¹è±¡ï¼Œè¿™é‡Œæˆ‘ä»¬è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ä¸‹é¢2ä¸ªå®ã€‚è¿™ä¸ªæ˜¯ä¸“é—¨ä¸ºé¢„è§ˆé¢„ç•™çš„requestIdï¼Œè€ƒè™‘è¿™æ ·ä¹Ÿä¼šæœ‰å½•åƒå’Œæ‹ç…§çš„requestId,æ¯æ¬¡æ›´æ–°å‚æ•°åï¼Œè¿™ä¸ªrequestIdä¼šæœ‰+1æ“ä½œï¼Œæ²¡æœ‰å‚æ•°æ›´æ–°ï¼Œåˆ™ä¸ä¼š+1ï¼Œè¿™ä¸ªå¯ä»¥åœ¨å„è‡ªçš„Debugæ‰‹æœºä¸Šå‘ç°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/Camera2Client.h]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int32_t</span> kPreviewRequestIdStart = <span class="number">10000000</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int32_t</span> kPreviewRequestIdEnd   = <span class="number">20000000</span>;</span><br></pre></td></tr></table></figure><h5 id="3-0-2-2ã€æ•è·æ—¶æœº"><a href="#3-0-2-2ã€æ•è·æ—¶æœº" class="headerlink" title="3.0.2.2ã€æ•è·æ—¶æœº"></a>3.0.2.2ã€æ•è·æ—¶æœº</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/ZslProcessor.cpp]</span><br><span class="line"><span class="keyword">void</span> ZslProcessor::onResultAvailable(<span class="keyword">const</span> CaptureResult &amp;result) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    ALOGV(<span class="string">"%s:"</span>, __FUNCTION__);</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mInputMutex)</span></span>;</span><br><span class="line">    <span class="keyword">camera_metadata_ro_entry_t</span> entry;</span><br><span class="line">    entry = result.mMetadata.find(ANDROID_SENSOR_TIMESTAMP);</span><br><span class="line">    <span class="keyword">nsecs_t</span> timestamp = entry.data.i64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    entry = result.mMetadata.find(ANDROID_REQUEST_FRAME_COUNT);</span><br><span class="line">    <span class="keyword">int32_t</span> frameNumber = entry.data.i32[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Corresponding buffer has been cleared. No need to push into mFrameList</span></span><br><span class="line">    <span class="keyword">if</span> (timestamp &lt;= mLatestClearedBufferTimestamp) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    mFrameList.editItemAt(mFrameListHead) = result.mMetadata;</span><br><span class="line">    mFrameListHead = (mFrameListHead + <span class="number">1</span>) % mFrameListDepth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å»æ‰é”™è¯¯æ£€æŸ¥ä»£ç ï¼Œä¸Šé¢ç”±äºCaptureIDæ˜¯ä¸‹é¢2ä¸ªï¼Œä¹Ÿå°±æ˜¯ZSLçš„æ‰€æœ‰é¢„è§ˆBufferå¯ç”¨ä¹‹åéƒ½ä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•,å½“é˜Ÿåˆ—æ»¡ä¹‹åï¼Œæ–°bufferä¼šè¦†ç›–æ—§bufferä½ç½®ã€‚ä¸Šé¢å¯ä»¥çœ‹åˆ°mFrameListä¸­ä¼šä¿å­˜æ¯ä¸€å¸§çš„metadataæ•°æ®ï¼ŒmFrameListHeadç”¨æ¥æ ‡è¯†ä¸‹ä¸€æ¬¡å­˜æ”¾æ•°æ®çš„ä½ç½®ã€‚</p><h5 id="3-1ã€æŸ¥æ‰¾ZSLæ‹ç…§æœ€åˆé€‚çš„buffer"><a href="#3-1ã€æŸ¥æ‰¾ZSLæ‹ç…§æœ€åˆé€‚çš„buffer" class="headerlink" title="3.1ã€æŸ¥æ‰¾ZSLæ‹ç…§æœ€åˆé€‚çš„buffer"></a>3.1ã€æŸ¥æ‰¾ZSLæ‹ç…§æœ€åˆé€‚çš„buffer</h5><p>ä¸€å¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯æ˜¯æ ¹æ®æƒ³è¦æŠ“å–é‚£å¸§çš„captureIdæ¥æ‰¾åˆ°zslæ‹ç…§bufferçš„ï¼Œä½†æ˜¯ç°åœ¨çœ‹æ¥å°±æ˜¯æ‰¾æ—¶é—´æˆ³æœ€è¿‘çš„é‚£ä¸ªbufferæ¥è¿›è¡Œjpegç¼–è§£ç (è€Œä¸”googleå·¥ç¨‹å¸ˆåœ¨æºç ä¸­æ³¨é‡Šä¹Ÿæ˜¯è¿™æ ·è¯´çš„).</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/ZslProcessor.cpp]</span><br><span class="line"><span class="keyword">status_t</span> ZslProcessor::pushToReprocess(<span class="keyword">int32_t</span> requestId) &#123;</span><br><span class="line">    ALOGV(<span class="string">"%s: Send in reprocess request with id %d"</span>,</span><br><span class="line">            __FUNCTION__, requestId);</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mInputMutex)</span></span>;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    sp&lt;Camera2Client&gt; client = mClient.promote();</span><br><span class="line">    <span class="comment">//ä¸‹é¢æ˜¯å°±æ˜¯åœ¨mFrameListæŸ¥æ‰¾æ—¶é—´æˆ³æœ€è¿‘çš„å¸§ã€‚</span></span><br><span class="line">    <span class="keyword">size_t</span> metadataIdx;</span><br><span class="line">    <span class="keyword">nsecs_t</span> candidateTimestamp = getCandidateTimestampLocked(&amp;metadataIdx);</span><br><span class="line">   <span class="comment">//æ ¹æ®ä¸Šä¸€æ¬¡æŸ¥æ‰¾çš„æ—¶é—´æˆ³ï¼Œä»ZSL BufferQueueä¸­æŸ¥æ‰¾æ—¶é—´æœ€æ¥è¿‘çš„Bufferï¼Œå¹¶å°†</span></span><br><span class="line">   <span class="comment">//bufferä¿å­˜åˆ°mInputBufferQueueé˜Ÿåˆ—ä¸­ã€‚</span></span><br><span class="line">    res = mZslStream-&gt;enqueueInputBufferByTimestamp(candidateTimestamp,</span><br><span class="line">                                                    <span class="comment">/*actualTimestamp*/</span><span class="literal">NULL</span>);</span><br><span class="line">   <span class="comment">//-----------------</span></span><br><span class="line">    &#123;<span class="comment">//è·å–zsl ç¼–è§£ç çš„metadataIdï¼Œç¨åä¼šä¼ å…¥ç»™halç¼–è§£ç ã€‚</span></span><br><span class="line">        CameraMetadata request = mFrameList[metadataIdx];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Verify that the frame is reasonable for reprocessing</span></span><br><span class="line">        <span class="keyword">camera_metadata_entry_t</span> entry;</span><br><span class="line">        entry = request.find(ANDROID_CONTROL_AE_STATE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (entry.data.u8[<span class="number">0</span>] != ANDROID_CONTROL_AE_STATE_CONVERGED &amp;&amp;</span><br><span class="line">                entry.data.u8[<span class="number">0</span>] != ANDROID_CONTROL_AE_STATE_LOCKED) &#123;</span><br><span class="line">            ALOGV(<span class="string">"%s: ZSL queue frame AE state is %d, need full capture"</span>,</span><br><span class="line">                    __FUNCTION__, entry.data.u8[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> NOT_ENOUGH_DATA;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">//è¿™ä¸­é—´ä¼šæ›´æ–°è¾“å…¥streamçš„æµIDã€æ›´æ–°æ•è·æ„å›¾ä¸ºé™æ€æ‹ç…§ã€åˆ¤æ–­è¿™ä¸€å¸§æ˜¯å¦AEç¨³å®šã€</span></span><br><span class="line">       <span class="comment">//è·å–jpegStreamIDå¹¶æ›´æ–°åˆ°metadataä¸­ã€æ›´æ–°è¯·æ±‚IDï¼Œæœ€åæ ¹æ®æ›´æ–°åçš„request metadata</span></span><br><span class="line">       <span class="comment">//æ›´æ–°jpeg metadataã€‚æœ€åä¸€æ­¥å¯åŠ¨Camera3DeviceæŠ“å–å›¾ç‰‡ã€‚</span></span><br><span class="line">        <span class="comment">// Update post-processing settings</span></span><br><span class="line">        res = updateRequestWithDefaultStillRequest(request);</span><br><span class="line">        mLatestCapturedRequest = request;</span><br><span class="line">        res = client-&gt;getCameraDevice()-&gt;capture(request);</span><br><span class="line">        mState = LOCKED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€ƒè¿˜è®°å¾—åœ¨å¯åŠ¨çŠ¶æ€æœºå™¨æ—¶ï¼Œæ³¨å†Œçš„å¸§ç›‘å¬å¯¹è±¡å§ã€‚è¿™é‡Œå‚æ•°requestIdå°±æ˜¯æˆ‘ä»¬æƒ³è¦æŠ“æ‹çš„å›¾ç‰‡çš„è¯·æ±‚ID,ç›®å‰å‘ç°è¯¥è¯·æ±‚IDåé¢ä¼šæ›´æ–°åˆ°metadataä¸­ã€‚è¿™é‡Œåªè¦çŸ¥é“è¯¥å‡½æ•°åŠŸèƒ½å°±å¯ä»¥äº†ã€‚</p><p>â˜¯ 1ã€ä»mFrameListä¸­æŸ¥æ‰¾æ—¶é—´æˆ³æœ€å°çš„metadataã€‚<br>â˜¯ 2ã€æ ¹æ®ä»ç¬¬ä¸€æ­¥è·å–åˆ°æ—¶é—´æˆ³ï¼Œä»ZSL BufferQueueé€‰æ‹©æ—¶é—´æœ€æ¥è¿‘Buffer.<br>â˜¯3ã€å°†Bufferæ”¾åˆ°mInputBufferQueueä¸­ï¼Œæ›´æ–°jpegç¼–è§£ç metadataï¼Œå¯åŠ¨CaptureåŠŸèƒ½ã€‚</p><h5 id="3-2ã€è®¾ç½®zsl-input-bufferå’Œ-jpeg-out-buffer"><a href="#3-2ã€è®¾ç½®zsl-input-bufferå’Œ-jpeg-out-buffer" class="headerlink" title="3.2ã€è®¾ç½®zsl input bufferå’Œ jpeg out buffer"></a>3.2ã€è®¾ç½®zsl input bufferå’Œ jpeg out buffer</h5><p>â€ƒâ€ƒå…¶å®è¿™ä¸€æ­¥ä¹‹å‰å·²ç»è®¨è®ºè¿‡ï¼ŒinputBufferæ˜¯ZslProcess3çº¿ç¨‹æŸ¥æ‰¾åˆ°æœ€åˆé€‚çš„ç”¨äºjpegç¼–è§£ç çš„bufferã€‚outputBufferä¸ºJpegProcessorçº¿ç¨‹æ›´æ–°çš„bufferç”¨äºå­˜æ”¾halç¼–è§£ç ä¹‹åçš„jpegå›¾ç‰‡ã€‚å…¶ä¸­å‡†å¤‡jpeg OutBufferçš„æ“ä½œå°±æ˜¯åœ¨ä¸‹é¢æ“ä½œçš„ã€‚å¯ä»¥çœ‹åˆ°å°†outputStreamçš„IDï¼Œä¿å­˜åˆ°metadataä¸­äº†ã€‚è¿™æ ·å°±ä¼šåœ¨Camera3Deviceä¸­æ ¹æ®è¿™é¡¹metadataæ¥æ·»åŠ outputBufferåˆ°halã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> ZslProcessor::pushToReprocess(<span class="keyword">int32_t</span> requestId) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Shouldn't we also update the latest preview frame?</span></span><br><span class="line">        <span class="keyword">int32_t</span> outputStreams[<span class="number">1</span>] =</span><br><span class="line">                &#123; client-&gt;getCaptureStreamId() &#125;;</span><br><span class="line">        res = request.update(ANDROID_REQUEST_OUTPUT_STREAMS,</span><br><span class="line">                outputStreams, <span class="number">1</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h5 id="3-3ã€å½’è¿˜jpeg-Bufferå¹²äº†ä»€ä¹ˆ"><a href="#3-3ã€å½’è¿˜jpeg-Bufferå¹²äº†ä»€ä¹ˆ" class="headerlink" title="3.3ã€å½’è¿˜jpeg Bufferå¹²äº†ä»€ä¹ˆ."></a>3.3ã€å½’è¿˜jpeg Bufferå¹²äº†ä»€ä¹ˆ.</h5><p>â€ƒâ€ƒå½“frameworkå°†ZSL inputBufferå’Œjpeg outputBuffer,ä¼ ç»™halåï¼Œhalå°±ä¼šå¯åŠ¨STLL_CAPTUREæµç¨‹ï¼Œå°†inputBufferä¸­çš„å›¾åƒæ•°æ®ï¼Œè¿›è¡Œä¸€ç³»åˆ—çš„åå¤„ç†æµç¨‹ã€‚å½“åå¤„ç†å®Œæˆåï¼Œhalåˆ™ä¼šå°†ä¸´æ—¶Bufferæ‹·è´åˆ°outPutBufferä¸­(æ³¨æ„ï¼šè¿™é‡Œè¦è®°å¾—åšflushæ“ä½œï¼Œå³åˆ·æ–°Buffer,è¦ä¸ç„¶å›¾ç‰‡æœ‰å¯èƒ½ä¼šå‡ºç°ç»¿æ¡).<br>â€ƒâ€ƒå› ä¸ºJpegBufferä¹Ÿæ˜¯ä»BufferQueue Dequeueå‡ºæ¥çš„buffer,è€Œä¸”åœ¨åˆ›å»ºBufferQueueæ—¶ï¼Œä¹Ÿæ³¨å†Œäº†å¸§ç›‘å¬å¯¹è±¡(å³ï¼šonFrameAvailable()å›è°ƒ).è¿™æ ·çš„è¯å½“å¸§å¯ç”¨(å³ï¼šè¿›è¡Œäº†enqueueæ“ä½œï¼‰ï¼Œå°±ä¼šå›è°ƒonFrameAvailable()æ–¹æ³•ï¼Œè¿™æ ·å½“halå½’è¿˜jpegBufferæ—¶å°±æ˜¯è¦è¿›è¡Œenqueue()æ“ä½œã€‚åœ¨onFrameAvailable()æ–¹æ³•ä¸­ï¼Œä¼šæ¿€æ´»jpegprocesçº¿ç¨‹ï¼Œè¿›è¡Œåç»­çš„å¤„ç†ï¼Œæœ€åæ¿€æ´»captureSequeueæ‹ç…§çŠ¶æ€æœºçº¿ç¨‹ã€‚</p><h5 id="3-4ã€ä¿å­˜ZSLBuffer"><a href="#3-4ã€ä¿å­˜ZSLBuffer" class="headerlink" title="3.4ã€ä¿å­˜ZSLBuffer."></a>3.4ã€ä¿å­˜ZSLBuffer.</h5><p>â€ƒâ€ƒè¿™é‡Œç”±äºZSL Bufferä¸€ç›´ä¼šä»halä¸Šæ¥ï¼Œæ‰€ä»¥å½“zslBufferä¸Šæ¥åï¼Œå°±ä¼šæ¿€æ´»FrameProcesorçº¿ç¨‹ä¿å­˜è¿™ä¸€ZslBufferï¼Œç›®å‰FrameWorké‚£è¾¹é»˜è®¤æ˜¯4ä¸ªbufferï¼Œè¿™æ ·çš„è¯å½“é˜Ÿåˆ—æ»¡ä¹‹åï¼Œå°±ä¼šè¦†ç›–ä¹‹å‰æœ€è€çš„buffer,å¦‚æ­¤åå¤æ“ä½œã€‚</p><h5 id="3-5ã€è·å–æ‹ç…§jpeg-Buffer"><a href="#3-5ã€è·å–æ‹ç…§jpeg-Buffer" class="headerlink" title="3.5ã€è·å–æ‹ç…§jpeg Buffer"></a>3.5ã€è·å–æ‹ç…§jpeg Buffer</h5><p>â€ƒâ€ƒå½“halä¸Šæ¥jpegå¸§åï¼Œå°±ä¼šæ¿€æ´»jpegProcessçº¿ç¨‹,å¹¶ä»BufferQueueä¸­æ‹¿åˆ°jpegbufferï¼Œä¸‹é¢å¯ä»¥å‘ç°è¿›è¡ŒlockNextBuffer,unlockBufferæ“ä½œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/JpegProcessor.cpp]</span><br><span class="line"><span class="keyword">status_t</span> JpegProcessor::processNewCapture() &#123;</span><br><span class="line">    res = mCaptureConsumer-&gt;lockNextBuffer(&amp;imgBuffer);</span><br><span class="line">    mCaptureConsumer-&gt;unlockBuffer(imgBuffer);</span><br><span class="line">    sp&lt;CaptureSequencer&gt; sequencer = mSequencer.promote();</span><br><span class="line">   <span class="comment">//...... </span></span><br><span class="line">    <span class="keyword">if</span> (sequencer != <span class="number">0</span>) &#123;</span><br><span class="line">        sequencer-&gt;onCaptureAvailable(imgBuffer.timestamp, captureBuffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å¯ä»¥å‘ç°æœ€åå›è°ƒäº†captureSequencerçº¿ç¨‹çš„onCaptureAvailable()å›è°ƒæ–¹æ³•ã€‚è¯¥å›è°ƒæ–¹æ³•ä¸»è¦ä½œç”¨å°±æ˜¯å°†æ—¶é—´æˆ³å’Œjpeg bufferçš„ä¼ é€åˆ°CaptureSequencerçº¿ç¨‹ä¸­,ç„¶åæ¿€æ´»CaptureSequencerçº¿ç¨‹ã€‚æœ€åå°†Buffer CallBackåˆ°åº”ç”¨å±‚ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/CaptureSequencer.cpp]</span><br><span class="line"><span class="keyword">void</span> CaptureSequencer::onCaptureAvailable(<span class="keyword">nsecs_t</span> timestamp,</span><br><span class="line">        sp&lt;MemoryBase&gt; captureBuffer) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    ALOGV(<span class="string">"%s"</span>, __FUNCTION__);</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mInputMutex)</span></span>;</span><br><span class="line">    mCaptureTimestamp = timestamp;</span><br><span class="line">    mCaptureBuffer = captureBuffer;</span><br><span class="line">    <span class="keyword">if</span> (!mNewCaptureReceived) &#123;</span><br><span class="line">        mNewCaptureReceived = <span class="literal">true</span>;</span><br><span class="line">        mNewCaptureSignal.signal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-6ã€æ‹ç…§å¸§å¯ç”¨å›è°ƒ"><a href="#3-6ã€æ‹ç…§å¸§å¯ç”¨å›è°ƒ" class="headerlink" title="3.6ã€æ‹ç…§å¸§å¯ç”¨å›è°ƒ"></a>3.6ã€æ‹ç…§å¸§å¯ç”¨å›è°ƒ</h5><p>å½“æ‹ç…§å¸§å›åˆ°Frameworkåï¼Œå°±ä¼šå›è°ƒCaptureSequencerçš„onResultAvailable()æ¥å£ï¼Œç”¨äºè®¾ç½®captureSequencerçŠ¶æ€æœºçš„æ ‡å¿—ä½å’Œæ¡ä»¶æ¿€æ´»,å¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚æ¡ä»¶å˜é‡å’Œæ ‡å¿—ä½çš„ä½¿ç”¨å¯ä»¥åœ¨çŠ¶æ€æœºæ–¹æ³•manageStandardCaptureWait()çœ‹åˆ°ä½¿ç”¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/CaptureSequencer.cpp]</span><br><span class="line"><span class="keyword">void</span> CaptureSequencer::onResultAvailable(<span class="keyword">const</span> CaptureResult &amp;result) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    ALOGV(<span class="string">"%s: New result available."</span>, __FUNCTION__);</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mInputMutex)</span></span>;</span><br><span class="line">    mNewFrameId = result.mResultExtras.requestId;</span><br><span class="line">    mNewFrame = result.mMetadata;</span><br><span class="line">    <span class="keyword">if</span> (!mNewFrameReceived) &#123;</span><br><span class="line">        mNewFrameReceived = <span class="literal">true</span>;</span><br><span class="line">        mNewFrameSignal.signal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-7ã€jpeg-bufferå›è°ƒåˆ°app"><a href="#3-7ã€jpeg-bufferå›è°ƒåˆ°app" class="headerlink" title="3.7ã€jpeg bufferå›è°ƒåˆ°app"></a>3.7ã€jpeg bufferå›è°ƒåˆ°app</h5><p>è¯¥callbackæ˜¯åº”ç”¨æ³¨å†Œè¿‡æ¥çš„ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¸‹é¢å°±æ˜¯é€šè¿‡binderè¿›ç¨‹é—´è°ƒç”¨å°†jpeg Bufferä¼ é€åˆ°APPç«¯ï¼Œæ³¨æ„è¿™é‡Œçš„msgTyep = CAMERA_MSG_COMPRESSED_IMAGE,å°±æ˜¯å‘Šè¯‰ä¸Šå±‚è¿™æ˜¯ä¸€ä¸ªå‹ç¼©çš„å›¾åƒæ•°æ®ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/CaptureSequencer.cpp]</span><br><span class="line">CaptureSequencer::CaptureState CaptureSequencer::manageDone(sp&lt;Camera2Client&gt; &amp;client) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res = OK;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    mCaptureId++;</span><br><span class="line">        ......</span><br><span class="line">            Camera2Client::SharedCameraCallbacks::Lock</span><br><span class="line">            l(client-&gt;mSharedCameraCallbacks);</span><br><span class="line">        ALOGV(<span class="string">"%s: Sending still image to client"</span>, __FUNCTION__);</span><br><span class="line">        <span class="keyword">if</span> (l.mRemoteCallback != <span class="number">0</span>) &#123;</span><br><span class="line">            l.mRemoteCallback-&gt;dataCallback(CAMERA_MSG_COMPRESSED_IMAGE,</span><br><span class="line">                    mCaptureBuffer, <span class="literal">NULL</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGV(<span class="string">"%s: No client!"</span>, __FUNCTION__);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆå››ï¼‰ã€Camera-System-Recorderæµç¨‹åˆ†æ"><a href="#ï¼ˆå››ï¼‰ã€Camera-System-Recorderæµç¨‹åˆ†æ" class="headerlink" title="ï¼ˆå››ï¼‰ã€Camera System Recorderæµç¨‹åˆ†æ"></a>ï¼ˆå››ï¼‰ã€Camera System Recorderæµç¨‹åˆ†æ</h4><p>camera Video.è™½ç„¶æ ‡é¢˜æ˜¯recordingæµç¨‹åˆ†æï¼Œä½†è¿™é‡Œå¾ˆå¤šå’Œpreviewæ˜¯ç›¸ä¼¼çš„(åŒ…å«æ›´æ–°ï¼Œåˆ›å»ºStream,åˆ›å»ºRequest)ï¼Œè¿™é‡Œä¸»è¦åˆ†æMediaRecorderå¯¹è±¡åˆ›å»ºã€videoå¸§ç›‘å¬å¯¹è±¡æ³¨å†Œã€å¸§å¯ç”¨äº‹ä»¶ä»¥åŠä¸€ç³»åˆ—callbackæµç¨‹åˆ†æã€‚</p><h5 id="4-1ã€è®¤è¯†video-mediaRecorder-çŠ¶æ€æœº"><a href="#4-1ã€è®¤è¯†video-mediaRecorder-çŠ¶æ€æœº" class="headerlink" title="4.1ã€è®¤è¯†video(mediaRecorder)çŠ¶æ€æœº"></a>4.1ã€è®¤è¯†video(mediaRecorder)çŠ¶æ€æœº</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-09-mediaRecorder-status.png" alt="Alt text"></p><blockquote><p>Used to record audio and video. The recording control is based on a<br>simple state machine (see below).çŠ¶æ€æœºè¯·çœ‹ä¸Šé¢æºç ä¸­ç»™çš„æµç¨‹å›¾ã€‚<br>A common case of using MediaRecorder to record audio works as follows:<br>1.MediaRecorder recorder = new MediaRecorder();<br>2.recorder.setAudioSource(MediaRecorder.AudioSource.MIC);<br>3.recorder.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);<br>4.recorder.setAudioEncoder(MediaRecorder.AudioEncoder.AMR_NB);<br>5.recorder.setOutputFile(PATH_NAME);<br>6.recorder.prepare();<br>7.recorder.start(); // Recording is now started<br>8â€¦.<br>9.recorder.stop();<br>10.recorder.reset(); // You can reuse the object by going back to setAudioSource() step<br>recorder.release(); // Now the object cannot be reused<br>â€ƒâ€ƒApplications may want to register for informational and error<br>events in order to be informed of some internal update and possible<br>runtime errors during recording. Registration for such events is<br>done by setting the appropriate listeners (via calls<br>(to {@link #setOnInfoListener(OnInfoListener)}setOnInfoListener and/or<br>{@link #setOnErrorListener(OnErrorListener)}setOnErrorListener).<br>In order to receive the respective callback associated with these listeners,<br>applications are required to create MediaRecorder objects on threads with a<br>Looper running (the main UI thread by default already has a Looper running).</p></blockquote><p>ä¸Šé¢æ˜¯googoleå·¥ç¨‹å¸ˆåŠ çš„æ³¨é‡Šï¼Œæœ€æƒå¨çš„èµ„æ–™ã€‚å¤§æ¦‚æ„æ€å°±æ˜¯è¯´â€œä½¿ç”¨mediaRecorderè®°å½•éŸ³è§†é¢‘ï¼Œéœ€è¦ä¸€ä¸ªç®€å•çš„çŠ¶æ€æœºæ¥æ§åˆ¶â€ã€‚ä¸Šé¢çš„1,2,3â€¦å°±æ˜¯åœ¨æ“ä½œæ—¶éœ€è¦å‡†å®ˆçš„æ­¥éª¤ã€‚ç®—äº†å§ï¼Œç¿»è¯‘æ°´å¹³æœ‰é™ï¼Œé‡ç‚¹è¿˜æ˜¯æ”¾åˆ°cameraè¿™è¾¹å§ã€‚</p><h5 id="4-2ã€Camera-appå¦‚ä½•å¯åŠ¨å½•åƒ"><a href="#4-2ã€Camera-appå¦‚ä½•å¯åŠ¨å½•åƒ" class="headerlink" title="4.2ã€Camera appå¦‚ä½•å¯åŠ¨å½•åƒ"></a>4.2ã€Camera appå¦‚ä½•å¯åŠ¨å½•åƒ</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æºç è·¯å¾„:pdk/apps/TestingCamera/src/com/android/testingcamera/TestingCamera.java</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startRecording</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">"Starting recording"</span>);</span><br><span class="line">        logIndent(<span class="number">1</span>);</span><br><span class="line">        log(<span class="string">"Configuring MediaRecoder"</span>);</span><br><span class="line">        <span class="comment">//è¿™é‡Œä¼šæ£€æŸ¥æ˜¯å¦æ‰“å¼€äº†å½•åƒåŠŸèƒ½ã€‚è¿™é‡Œæˆ‘ä»¬çœç•¥äº†ï¼Œç›´æ¥ä¸å¦‚æ­£é¢˜</span></span><br><span class="line"><span class="comment">//ä¸Šé¢é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªMediaRecorderçš„javaå¯¹è±¡(æ³¨æ„è¿™é‡ŒåŒcamera.javaç±»ä¼¼ï¼Œjavaå¯¹è±¡ä¸­è‚¯å®šåŒ…å«äº†ä¸€ä¸ªmediaRecorder jniæœ¬åœ°å¯¹è±¡ï¼Œç»§ç»­å¾€ä¸‹çœ‹)</span></span><br><span class="line">        mRecorder = <span class="keyword">new</span> MediaRecorder();</span><br><span class="line">        <span class="comment">//ä¸‹é¢å°±æ˜¯è®¾ç½®ä¸€äº›callback.</span></span><br><span class="line">        mRecorder.setOnErrorListener(mRecordingErrorListener);</span><br><span class="line">        mRecorder.setOnInfoListener(mRecordingInfoListener);</span><br><span class="line">        <span class="keyword">if</span> (!mRecordHandoffCheckBox.isChecked()) &#123;</span><br><span class="line">    <span class="comment">//å°†å½“å‰camera javaå¯¹è±¡è®¾ç½®ç»™äº†mediaRecorder javaå¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="comment">//è¿™é‡ŒsetCameraæ˜¯jniæ¥å£ï¼Œåé¢æˆ‘ä»¬è´´ä»£ç åœ¨åˆ†æã€‚</span></span><br><span class="line">            mRecorder.setCamera(mCamera);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//å°†preview surface javaå¯¹è±¡è®¾ç½®ç»™mediaRecorder javaå¯¹è±¡ï¼Œåé¢è´´ä»£ç </span></span><br><span class="line">    <span class="comment">//è¯¦ç»†è¯´æ˜ã€‚</span></span><br><span class="line">        mRecorder.setPreviewDisplay(mPreviewHolder.getSurface());</span><br><span class="line">ã€€ã€€ã€€ã€€<span class="comment">//ä¸‹é¢ï¼’ä¸ªæ˜¯è®¾ç½®éŸ³é¢‘å’Œè§†é¢‘çš„èµ„æºã€‚</span></span><br><span class="line">        mRecorder.setAudioSource(MediaRecorder.AudioSource.CAMCORDER);</span><br><span class="line">        mRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);</span><br><span class="line">        mRecorder.setProfile(mCamcorderProfiles.get(mCamcorderProfile));</span><br><span class="line">        <span class="comment">//ä»appæ§ä»¶é€‰æ‹©å½•åƒå¸§å¤§å°ï¼Œå¹¶è®¾ç½®ç»™mediaRecorder</span></span><br><span class="line">        Camera.Size videoRecordSize = mVideoRecordSizes.get(mVideoRecordSize);</span><br><span class="line">        <span class="keyword">if</span> (videoRecordSize.width &gt; <span class="number">0</span> &amp;&amp; videoRecordSize.height &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mRecorder.setVideoSize(videoRecordSize.width, videoRecordSize.height);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä»appæ§ä»¶é€‰æ‹©å½•åƒå¸§ç‡ï¼Œå¹¶è®¾ç½®ç»™mediaRecorder.</span></span><br><span class="line">        <span class="keyword">if</span> (mVideoFrameRates.get(mVideoFrameRate) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mRecorder.setVideoFrameRate(mVideoFrameRates.get(mVideoFrameRate));</span><br><span class="line">        &#125;</span><br><span class="line">        File outputFile = getOutputMediaFile(MEDIA_TYPE_VIDEO);</span><br><span class="line">        log(<span class="string">"File name:"</span> + outputFile.toString());</span><br><span class="line">        mRecorder.setOutputFile(outputFile.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> ready = <span class="keyword">false</span>;</span><br><span class="line">        log(<span class="string">"Preparing MediaRecorder"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//å‡†å¤‡ä¸€ä¸‹ï¼Œè¯·çœ‹ä¸‹é¢googleç»™çš„ä½¿ç”¨mediaRecorderæ ‡å‡†æµç¨‹</span></span><br><span class="line">            mRecorder.prepare();</span><br><span class="line">            ready = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;<span class="comment">//------å¼‚å¸¸å¤„ç†çœç•¥</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ready) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log(<span class="string">"Starting MediaRecorder"</span>);</span><br><span class="line">                mRecorder.start();<span class="comment">//å¯åŠ¨å½•åƒ</span></span><br><span class="line">                mState = CAMERA_RECORD;</span><br><span class="line">                log(<span class="string">"Recording active"</span>);</span><br><span class="line">                mRecordingFile = outputFile;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;<span class="comment">//-----å¼‚å¸¸å¤„ç†çœç•¥</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//------------</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åº”ç”¨å¯åŠ¨å½•åƒåŠŸèƒ½æ˜¯æ˜¯ç¬¦åˆçŠ¶æ€æœºæµç¨‹çš„ã€‚åœ¨åº”ç”¨å¼€å‘ä¸­ï¼Œä¹Ÿè¦è¿™æ ·æ¥åšã€‚</p><p>â˜¯ 1.åˆ›å»ºmediaRecorderjavaå¯¹è±¡ï¼ŒmRecorder = new MediaRecorder();<br>â˜¯ 2.è®¾ç½®camera javaå¯¹è±¡åˆ°mediaRecorderä¸­ï¼ŒmRecorder.setCamera(mCamera);<br>â˜¯ 3.å°†preview surfaceå¯¹è±¡è®¾ç½®ç»™mediaRecorder,mRecorder.setPreviewDisplay(mPreviewHolder.getSurface());<br>â˜¯ 4.è®¾ç½®éŸ³é¢‘æºï¼ŒmRecorder.setAudioSource(MediaRecorder.AudioSource.CAMCORDER);<br>â˜¯ 5.è®¾ç½®è§†é¢‘æºï¼ŒmRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);<br>â˜¯ 6.è®¾ç½®å½•åƒå¸§å¤§å°å’Œå¸§ç‡ï¼Œä»¥åŠsetOutputFile<br>â˜¯ 8.å‡†å¤‡å·¥ä½œï¼ŒmRecorder.prepare();<br>â˜¯ 9.å¯åŠ¨mdiaRecorder,mRecorder.start();</p><h5 id="4-3ã€ä¸MediaPlayerServiceç›¸å…³çš„ç±»æ¥å£ä¹‹é—´çš„å…³ç³»ç®€ä»‹"><a href="#4-3ã€ä¸MediaPlayerServiceç›¸å…³çš„ç±»æ¥å£ä¹‹é—´çš„å…³ç³»ç®€ä»‹" class="headerlink" title="4.3ã€ä¸MediaPlayerServiceç›¸å…³çš„ç±»æ¥å£ä¹‹é—´çš„å…³ç³»ç®€ä»‹"></a>4.3ã€ä¸MediaPlayerServiceç›¸å…³çš„ç±»æ¥å£ä¹‹é—´çš„å…³ç³»ç®€ä»‹</h5><h5 id="4-3-1ã€mediaRecorderä½•æ—¶ä¸MediaPlayerServiceå‘é€å…³ç³»"><a href="#4-3-1ã€mediaRecorderä½•æ—¶ä¸MediaPlayerServiceå‘é€å…³ç³»" class="headerlink" title="4.3.1ã€mediaRecorderä½•æ—¶ä¸MediaPlayerServiceå‘é€å…³ç³»"></a>4.3.1ã€mediaRecorderä½•æ—¶ä¸MediaPlayerServiceå‘é€å…³ç³»</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-10-MediaRecorder.png" alt="Alt text"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/media/java/android/media/MediaRecorder.java</span><br><span class="line">MediaRecorder::MediaRecorder() : mSurfaceMediaSource(<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="string">"constructor"</span>);</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IMediaPlayerService&gt;&amp; service(getMediaPlayerService());</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mMediaRecorder = service-&gt;createMediaRecorder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mMediaRecorder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mCurrentState = MEDIA_RECORDER_IDLE;</span><br><span class="line">    &#125;</span><br><span class="line">    doCleanUp();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨jniä¸­åˆ›å»ºmediaRecorderå¯¹è±¡æ—¶ï¼Œå…¶å®åœ¨æ„é€ å‡½æ•°ä¸­å·å·çš„é“¾æ¥äº†mediaPlayerServiceï¼Œè¿™ä¹Ÿæ˜¯Androidä¹ æƒ¯ç”¨çš„æ–¹æ³•ã€‚è·å–åˆ°MediaPlayerServiceä»£ç†å¯¹è±¡åï¼Œé€šè¿‡åŒ¿åbinderè·å–mediaRecorderä»£ç†å¯¹è±¡ã€‚ </p><h5 id="4-3-2ã€mediaPlayerServiceç±»å’Œæ¥å£ä¹‹é—´å…³ç³»"><a href="#4-3-2ã€mediaPlayerServiceç±»å’Œæ¥å£ä¹‹é—´å…³ç³»" class="headerlink" title="4.3.2ã€mediaPlayerServiceç±»å’Œæ¥å£ä¹‹é—´å…³ç³»"></a>4.3.2ã€mediaPlayerServiceç±»å’Œæ¥å£ä¹‹é—´å…³ç³»</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-11-mediaPlayerService.png" alt="Alt text"></p><table><thead><tr><th style="text-align:left">æ¥å£ç±»å‹</th><th>æ¥å£è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">virtual sp createMediaRecorder() = 0;</td><td>åˆ›å»ºmediaRecorderå½•è§†é¢‘æœåŠ¡å¯¹è±¡çš„æ¥å£</td></tr><tr><td style="text-align:left">virtual sp create(const sp&amp; client, intã€€audioSessionId = 0) = 0;</td><td>åˆ›å»ºmediaPlayeræ’­æ”¾éŸ³ä¹æœåŠ¡å¯¹è±¡çš„æ¥å£ï¼Œæ’­æ”¾éŸ³ä¹éƒ½æ˜¯é€šè¿‡mediaPlayerå¯¹è±¡æ’­æ”¾çš„</td></tr><tr><td style="text-align:left">virtual status_t decode() = 0;</td><td>éŸ³é¢‘è§£ç å™¨</td></tr></tbody></table><h5 id="4-3-3ã€MediaRecorderç±»å’Œæ¥å£ä¹‹é—´å…³ç³»"><a href="#4-3-3ã€MediaRecorderç±»å’Œæ¥å£ä¹‹é—´å…³ç³»" class="headerlink" title="4.3.3ã€MediaRecorderç±»å’Œæ¥å£ä¹‹é—´å…³ç³»"></a>4.3.3ã€MediaRecorderç±»å’Œæ¥å£ä¹‹é—´å…³ç³»</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-12-IMediaRecorder.png" alt="Alt text"></p><p>mediaRecorderåŠŸèƒ½å°±æ˜¯æ¥å½•åƒçš„ã€‚å…¶ä¸­MediaRecorderç±»ä¸­ï¼ŒåŒ…å«äº†BpMediaRecorderä»£ç†å¯¹è±¡å¼•ç”¨ã€‚MediaRecorderClientæœ¬åœ°å¯¹è±¡é©»ç•™åœ¨mediaPlayServiceä¸­ã€‚å®ƒçš„æ¥å£æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå°±åˆ—å‡ºæˆ‘ä»¬ä»Šå¤©å…³æ³¨çš„å‡ ä¸ªæ¥å£ã€‚å…¶å®ƒæ¥å£æŸ¥çœ‹æºç å§<br>è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒæºç ï¼šframeworks/av/include/media/IMediaRecorder.h<br>| æ¥å£ç±»å‹ |     æ¥å£è¯´æ˜|<br>| :â€”â€”â€“ |: â€”â€”â€“|<br>| virtual status_t setCamera(const sp&amp; camera,const sp&amp; proxy) = 0;        |   è¿™ä¸ªæ¥å£ä¹Ÿæ˜¯éå¸¸éœ€è¦æˆ‘ä»¬å…³æ³¨çš„ï¼Œè¿™é‡Œè·å–åˆ°äº†å¯åŠ¨å½•åƒæ“ä½œçš„æœ¬åœ°å¯¹è±¡(BnCameraRecordingProxyï¼‰ï¼Œå¹¶é€šè¿‡åŒ¿åbinderé€šä¿¡æ–¹å¼ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æœ¬åœ°å¯¹è±¡.ç„¶ååœ¨startRecordingæ—¶å°†å¸§ç›‘å¬å¯¹è±¡æ³¨å†Œåˆ°cameraæœ¬åœ°å¯¹è±¡ä¸­äº†|<br>| virtual status_t setPreviewSurface(const sp&amp; surface) = 0;            |   å°†previewé¢„è§ˆsurfaceå¯¹è±¡è®¾ç½®ç»™medaiRecorderï¼Œå› ä¸ºmediaRecorderä¹Ÿæœ‰ä¸€ä¸ªcameraæœ¬åœ°client,æ‰€ä»¥è¿™ä¸ªsurfaceå¯¹è±¡æœ€ç»ˆè¿˜æ˜¯ä¼šè®¾ç½®åˆ°cameraServiceç”¨äºæ˜¾ç¤ºã€‚è€Œå½•åƒçš„å¸§ä¼šåœ¨CameraServiceæœ¬åœ°åˆ›å»ºä¸€ä¸ªbufferQueueï¼Œå…·ä½“ä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜|<br>| virtual status_t setListener(const sp&amp; listener) = 0;        |   è¿™é‡Œä¸€çœ‹å°±æ˜¯è®¾ç½®ç›‘å¬å¯¹è±¡ï¼Œç›‘å¬å¯¹è±¡æ˜¯jniä¸­çš„JNIMediaRecorderListenerå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥å›è°ƒMediaRecorder.javaç±»ä¸­çš„postEventFromNativeæ–¹æ³•ï¼Œå°†æ—¶é—´é€åˆ°javaå±‚ã€‚å…¶å®MediaRecorderå®ç°äº†BnMediaRecorderClientæ¥å£ï¼Œå³å®ç°notifyæ¥å£ï¼Œé‚£ä¹ˆè¿™é‡Œå…¶å®å°†æœ¬åœ°å¯¹è±¡ä¼ åˆ°MediaRecorderæœ¬åœ°çš„å®¢æˆ·ç«¯å¯¹è±¡ä¸­ï¼ˆæœ¬åœ°å¯¹è±¡æ‹¿åˆ°çš„å°±æ˜¯ä»£ç†å¯¹è±¡äº†ï¼‰ï¼Œå‚è€ƒä»£ç ç‰‡æ®µ1|<br>| virtual status_t start() = 0;        |   å¯åŠ¨å½•åƒåŠŸèƒ½ï¼Œå‡½æ•°è¿½ç©¶ä¸‹å»å’ŒCameraå…³ç³»ä¸å¤§äº†ï¼Œè¿™é‡Œå°±ä¸ç»†è¯´äº†|  </p><h5 id="4-3-3-1ã€ä»£ç ç‰‡æ®µ1"><a href="#4-3-3-1ã€ä»£ç ç‰‡æ®µ1" class="headerlink" title="4.3.3.1ã€ä»£ç ç‰‡æ®µ1"></a>4.3.3.1ã€ä»£ç ç‰‡æ®µ1</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æºç è·¯å¾„ï¼šframeworks/base/media/jni/android_media_MediaRecorder.cpp</span><br><span class="line"><span class="comment">// create new listener and give it to MediaRecorder</span></span><br><span class="line">sp&lt;JNIMediaRecorderListener&gt; listener = <span class="keyword">new</span> JNIMediaRecorderListener(env, thiz, weak_this);</span><br><span class="line">mr-&gt;setListener(listener);</span><br></pre></td></tr></table></figure><p>mediaRecorder jniæ¥å£å›è°ƒjavaæ–¹æ³•ï¼Œé€šçŸ¥ä¸Šå±‚nativeäº‹ä»¶ã€‚</p><h5 id="4-3-3-2ã€ä»£ç ç‰‡æ®µ2"><a href="#4-3-3-2ã€ä»£ç ç‰‡æ®µ2" class="headerlink" title="4.3.3.2ã€ä»£ç ç‰‡æ®µ2"></a>4.3.3.2ã€ä»£ç ç‰‡æ®µ2</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\jni\android_media_MediaRecorder.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_media_MediaRecorder_setCamera</span><span class="params">(JNIEnv* env, jobject thiz, jobject camera)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// we should not pass a null camera to get_native_camera() call.</span></span><br><span class="line"><span class="comment">//è¿™é‡Œæ£€æŸ¥cameraæ˜¯ä¸æ˜¯ç©ºçš„ï¼Œæ˜¾ç„¶ä¸æ˜¯ç©ºçš„ã€‚</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªåœ°æ–¹éœ€è¦å¥½å¥½ç ”ç©¶ä¸€ä¸‹ï¼Œå…¶ä¸­cameraæ˜¯javaå±‚çš„cameraå¯¹è±¡(å³camera.java)</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œç”±javaå¯¹è±¡è·å–åˆ°cameraåº”ç”¨ç«¯æœ¬åœ°å¯¹è±¡ã€‚</span></span><br><span class="line">    sp&lt;Camera&gt; c = get_native_camera(env, camera, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">// get_native_camera will throw an exception in this case</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–mediaRecorderæœ¬åœ°å¯¹è±¡</span></span><br><span class="line">    sp&lt;MediaRecorder&gt; mr = getMediaRecorder(env, thiz);</span><br><span class="line">    <span class="comment">//ä¸‹é¢è¦ç‰¹åˆ«æ³¨æ„ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¼ å…¥çš„ä¸æ˜¯Cameraå¯¹è±¡è€Œæ˜¯c-&gt;remote()ï¼Œå½“æ—¶ç¢ç£¨</span></span><br><span class="line">    <span class="comment">//ç€ï¼Œcamera.cppä¹Ÿæ²¡å®ç°ä»€ä¹ˆä»£ç†ç±»çš„æ¥å£å•Šï¼Œä¸è¿‡åæ¥åœ¨cameraBaseç±»ä¸­å‘ç°</span></span><br><span class="line">    <span class="comment">//é‡è½½äº†remote()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ICameraä»£ç†å¯¹è±¡ï¼Œå‘µå‘µã€‚è¿™æ ·çš„è¯å°±ä¼šåœ¨</span></span><br><span class="line">    <span class="comment">//mediaRecorderä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ICameraä»£ç†å¯¹è±¡ã€‚å¹¶åœ¨mediaPlayerServiceä¸­</span></span><br><span class="line">    <span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°çš„Cameraå¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="comment">//c-&gt;getRecordingProxy():è·å–cameraæœ¬åœ°å¯¹è±¡å®ç°çš„Recordingæœ¬åœ°å¯¹è±¡ã€‚è¿™é‡Œ</span></span><br><span class="line">    <span class="comment">//è°ƒç”¨setCameraè®¾ç½®åˆ°mediaRecorderæœ¬åœ°å¯¹è±¡ä¸­äº†(è§ä»£ç ç‰‡æ®µï¼“)</span></span><br><span class="line">   process_media_recorder_call(env, mr-&gt;setCamera(c-&gt;remote(), c-&gt;getRecordingProxy()),</span><br><span class="line">            <span class="string">"java/lang/RuntimeException"</span>, <span class="string">"setCamera failed."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//cameraç«¯</span></span><br><span class="line">sp&lt;ICameraRecordingProxy&gt; Camera::getRecordingProxy() &#123;</span><br><span class="line">    ALOGV(<span class="string">"getProxy"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RecordingProxy(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//çœ‹çœ‹ä¸‹é¢RecordingProxyå®ç°äº†BnCameraRecordingProxyæ¥å£ï¼Œ</span></span><br><span class="line"><span class="comment">//æ˜¯ä¸ªæœ¬åœ°å¯¹è±¡ï¼Œæ°´è½çŸ³å‡ºäº†ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecordingProxy</span> :</span> <span class="keyword">public</span> BnCameraRecordingProxy</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        RecordingProxy(<span class="keyword">const</span> sp&lt;Camera&gt;&amp; camera);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ICameraRecordingProxy interface</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> status_t <span class="title">startRecording</span><span class="params">(<span class="keyword">const</span> sp&lt;ICameraRecordingProxyListener&gt;&amp; listener)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">stopRecording</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">releaseRecordingFrame</span><span class="params">(<span class="keyword">const</span> sp&lt;IMemory&gt;&amp; mem)</span></span>;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„æ˜¯mCameraå·²ç»ä¸å†æ˜¯ä¹‹å‰previewå¯åŠ¨æ—¶å¯¹åº”çš„é‚£ä¸ªæœ¬åœ°Cameraå¯¹è±¡</span></span><br><span class="line">    <span class="comment">//è¿™æ˜¯mediaRecorderé‡æ–°åˆ›å»ºçš„cameraæœ¬åœ°å¯¹è±¡ã€‚</span></span><br><span class="line">        sp&lt;Camera&gt;         mCamera;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><h5 id="4-3-3-3ã€ä»£ç ç‰‡æ®µ3-setCameraæœ¬åœ°å®ç°"><a href="#4-3-3-3ã€ä»£ç ç‰‡æ®µ3-setCameraæœ¬åœ°å®ç°" class="headerlink" title="4.3.3.3ã€ä»£ç ç‰‡æ®µ3-setCameraæœ¬åœ°å®ç°"></a>4.3.3.3ã€ä»£ç ç‰‡æ®µ3-setCameraæœ¬åœ°å®ç°</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\MediaRecorderClient.cpp]</span><br><span class="line"><span class="keyword">status_t</span> MediaRecorderClient::setCamera(<span class="keyword">const</span> sp&lt;ICamera&gt;&amp; camera,</span><br><span class="line">                                        <span class="keyword">const</span> sp&lt;ICameraRecordingProxy&gt;&amp; proxy)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="string">"setCamera"</span>);</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (mRecorder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"recorder is not initialized"</span>);</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mRecorder-&gt;setCamera(camera, proxy);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ„é€ å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°åˆ›å»ºäº†ä¸€ä¸ªStagefrightRecorderå¯¹è±¡ï¼Œåç»­çš„å…¶å®ƒæ“ä½œ</span></span><br><span class="line"><span class="comment">//éƒ½æ˜¯é€šè¿‡mRecorderå¯¹è±¡å®ç°çš„</span></span><br><span class="line">MediaRecorderClient::MediaRecorderClient(<span class="keyword">const</span> sp&lt;MediaPlayerService&gt;&amp; service, <span class="keyword">pid_t</span> pid)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="string">"Client constructor"</span>);</span><br><span class="line">    mPid = pid;</span><br><span class="line">    mRecorder = <span class="keyword">new</span> StagefrightRecorder;</span><br><span class="line">    mMediaPlayerService = service;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//StagefrightRecorder::setCameraå®ç°</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">StagefrightRecorder</span> :</span> <span class="keyword">public</span> MediaRecorderBase &#123;&#125;</span><br><span class="line"><span class="keyword">status_t</span> StagefrightRecorder::setCamera(<span class="keyword">const</span> sp&lt;ICamera&gt; &amp;camera,</span><br><span class="line">                                        <span class="keyword">const</span> sp&lt;ICameraRecordingProxy&gt; &amp;proxy) &#123;</span><br><span class="line"><span class="comment">//çœå»ä¸€äº›é”™è¯¯æ£€æŸ¥ä»£ç </span></span><br><span class="line">    mCamera = camera;</span><br><span class="line">    mCameraProxy = proxy;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆICamera,ICameraRecordingProxyä»£ç†å¯¹è±¡éƒ½å­˜æ”¾åˆ°StagefrightRecorderå¯¹åº”çš„æˆå‘˜å˜é‡ä¸­ï¼Œçœ‹æ¥çŒªè„šå°±åœ¨è¿™ä¸ªç±»ä¸­ã€‚</p><h5 id="4-3-3-4ã€ä»£ç ç‰‡æ®µ4"><a href="#4-3-3-4ã€ä»£ç ç‰‡æ®µ4" class="headerlink" title="4.3.3.4ã€ä»£ç ç‰‡æ®µ4"></a>4.3.3.4ã€ä»£ç ç‰‡æ®µ4</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/media/libstagefright/CameraSource.cpp]</span><br><span class="line"><span class="keyword">status_t</span> CameraSource::isCameraAvailable(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;ICamera&gt;&amp; camera, <span class="keyword">const</span> sp&lt;ICameraRecordingProxy&gt;&amp; proxy,</span><br><span class="line">    <span class="keyword">int32_t</span> cameraId, <span class="keyword">const</span> String16&amp; clientName, <span class="keyword">uid_t</span> clientUid) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera == <span class="number">0</span>) &#123;</span><br><span class="line">        mCamera = Camera::connect(cameraId, clientName, clientUid);</span><br><span class="line">        <span class="keyword">if</span> (mCamera == <span class="number">0</span>) <span class="keyword">return</span> -EBUSY;</span><br><span class="line">        mCameraFlags &amp;= ~FLAGS_HOT_CAMERA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We get the proxy from Camera, not ICamera. We need to get the proxy</span></span><br><span class="line">        <span class="comment">// to the remote Camera owned by the application. Here mCamera is a</span></span><br><span class="line">        <span class="comment">// local Camera object created by us. We cannot use the proxy from</span></span><br><span class="line">        <span class="comment">// mCamera here.</span></span><br><span class="line">        <span class="comment">//æ ¹æ®ICameraä»£ç†å¯¹è±¡é‡æ–°åˆ›å»ºCameraæœ¬åœ°å¯¹è±¡</span></span><br><span class="line">        mCamera = Camera::create(camera);</span><br><span class="line">        <span class="keyword">if</span> (mCamera == <span class="number">0</span>) <span class="keyword">return</span> -EBUSY;</span><br><span class="line">        mCameraRecordingProxy = proxy;</span><br><span class="line">        <span class="comment">//ç›®å‰è¿˜ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆæ ‡è®°ï¼Œæƒä¸”ç†è§£æˆæ”¯æŒçƒ­æ’æ‹”æ ‡è®°</span></span><br><span class="line">        mCameraFlags |= FLAGS_HOT_CAMERA;</span><br><span class="line">        <span class="comment">//ä»£ç†å¯¹è±¡ç»‘å®šæ­»äº¡é€šçŸ¥å¯¹è±¡</span></span><br><span class="line">        mDeathNotifier = <span class="keyword">new</span> DeathNotifier();</span><br><span class="line">        <span class="comment">// isBinderAlive needs linkToDeath to work.</span></span><br><span class="line">        mCameraRecordingProxy-&gt;asBinder()-&gt;linkToDeath(mDeathNotifier);</span><br><span class="line">    &#125;</span><br><span class="line">    mCamera-&gt;lock();</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ç”±ä¸Šé¢çš„ç±»å›¾ä¹‹é—´çš„å…³ç³»çš„ï¼Œå°±çŸ¥é“mediaRecorderé—´æ¥åŒ…å«äº†cameaSourceå¯¹è±¡ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ç›´æ¥è¦å®³ä»£ç ã€‚</p><p>â˜¯ 1.åœ¨åˆ›å»ºCameraSourceå¯¹è±¡æ—¶ï¼Œä¼šå»æ£€æŸ¥ä¸€ä¸‹Cameraå¯¹è±¡æ˜¯å¦å¯ç”¨ï¼Œå¯ç”¨çš„è¯å°±ä¼šæ ¹æ®ä¼ è¿›æ¥çš„ä»£ç†å¯¹è±¡é‡æ–°åˆ›å»ºCameraæœ¬åœ°å¯¹è±¡ï¼ˆæ³¨æ„è¿™ä¸ªæ—¶å€™Cameraä»£ç†å¯¹è±¡åœ¨mediaRecorderä¸­ï¼‰<br>â˜¯ 2.ç„¶åä¿å­˜RecordingProxyä»£ç†å¯¹è±¡åˆ°mCameraRecordingProxyæˆå‘˜ä¸­ï¼Œç„¶åç»‘å®šæ­»äº¡é€šçŸ¥å¯¹è±¡åˆ°RecordingProxyä»£ç†å¯¹è±¡ã€‚</p><h5 id="4-3-3-5ã€ä»£ç ç‰‡æ®µ5"><a href="#4-3-3-5ã€ä»£ç ç‰‡æ®µ5" class="headerlink" title="4.3.3.5ã€ä»£ç ç‰‡æ®µ5"></a>4.3.3.5ã€ä»£ç ç‰‡æ®µ5</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/media/libstagefright/CameraSource.cpp]</span><br><span class="line"><span class="keyword">status_t</span> CameraSource::startCameraRecording() &#123;</span><br><span class="line">    ALOGV(<span class="string">"startCameraRecording"</span>);</span><br><span class="line">    <span class="comment">// Reset the identity to the current thread because media server owns the</span></span><br><span class="line">    <span class="comment">// camera and recording is started by the applications. The applications</span></span><br><span class="line">    <span class="comment">// will connect to the camera in ICameraRecordingProxy::startRecording.</span></span><br><span class="line">    <span class="keyword">int64_t</span> token = IPCThreadState::self()-&gt;clearCallingIdentity();</span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="keyword">if</span> (mNumInputBuffers &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        err = mCamera-&gt;sendCommand(</span><br><span class="line">            CAMERA_CMD_SET_VIDEO_BUFFER_COUNT, mNumInputBuffers, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    err = OK;</span><br><span class="line">    <span class="keyword">if</span> (mCameraFlags &amp; FLAGS_HOT_CAMERA) &#123;<span class="comment">//å‰é¢å·²ç»ç½®ä½FLAGS_HOT_CAMERAï¼Œæˆç«‹</span></span><br><span class="line">        mCamera-&gt;unlock();</span><br><span class="line">        mCamera.clear();</span><br><span class="line">        <span class="comment">//é€šè¿‡recordingä»£ç†å¯¹è±¡ï¼Œç›´æ¥å¯åŠ¨cameraæœ¬åœ°ç«¯çš„recording</span></span><br><span class="line">        <span class="keyword">if</span> ((err = mCameraRecordingProxy-&gt;startRecording(</span><br><span class="line">                <span class="keyword">new</span> ProxyListener(<span class="keyword">this</span>))) != OK) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    IPCThreadState::self()-&gt;restoreCallingIdentity(token);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç éœ€è¦æˆ‘ä»¬æ³¨æ„çš„æ˜¯åœ¨å¯åŠ¨startRecording()æ—¶ï¼Œåˆ›å»ºçš„ç›‘å¬å¯¹è±¡new ProxyListener(this),è¯¥ç›‘å¬å¯¹è±¡ä¼šä¼ åˆ°Cameraæœ¬åœ°å¯¹è±¡ä¸­ã€‚å½“å¸§å¯ç”¨æ—¶ï¼Œç”¨æ¥é€šçŸ¥mediaRecorderæœ‰å¸§å¯ä»¥ä½¿ç”¨äº†ï¼Œèµ¶ç´§ç¼–ç å§ã€‚</p><h5 id="4-3-3-6ã€ä»£ç ç‰‡æ®µ6-mediaRecorderæ³¨å†Œå¸§å¯ç”¨ç›‘å¬å¯¹è±¡"><a href="#4-3-3-6ã€ä»£ç ç‰‡æ®µ6-mediaRecorderæ³¨å†Œå¸§å¯ç”¨ç›‘å¬å¯¹è±¡" class="headerlink" title="4.3.3.6ã€ä»£ç ç‰‡æ®µ6-mediaRecorderæ³¨å†Œå¸§å¯ç”¨ç›‘å¬å¯¹è±¡"></a>4.3.3.6ã€ä»£ç ç‰‡æ®µ6-mediaRecorderæ³¨å†Œå¸§å¯ç”¨ç›‘å¬å¯¹è±¡</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/include/media/stagefright/CameraSource.h]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyListener</span>:</span> <span class="keyword">public</span> BnCameraRecordingProxyListener &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        ProxyListener(<span class="keyword">const</span> sp&lt;CameraSource&gt;&amp; source);</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dataCallbackTimestamp</span><span class="params">(<span class="keyword">int64_t</span> timestampUs, <span class="keyword">int32_t</span> msgType,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> sp&lt;IMemory&gt; &amp;data)</span></span>;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        sp&lt;CameraSource&gt; mSource;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">//frameworks/av/camera/Camera.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera::RecordingProxy::startRecording(<span class="keyword">const</span> sp&lt;ICameraRecordingProxyListener&gt;&amp; listener)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="string">"RecordingProxy::startRecording"</span>);</span><br><span class="line">    mCamera-&gt;setRecordingProxyListener(listener);</span><br><span class="line">    mCamera-&gt;reconnect();</span><br><span class="line">    <span class="keyword">return</span> mCamera-&gt;startRecording();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œå¸§ç›‘å¬å¯¹è±¡å°±æ˜¯åœ¨å¯åŠ¨Recordingæ—¶æ³¨å†Œï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ æ­¥ï¼š</p><p>â˜¯ 1.ä½¿ç”¨setRecordingProxyListeneræ¥å£ï¼Œå°†ç›‘å¬å¯¹è±¡è®¾ç½®ç»™mRecordingProxyListener æˆå‘˜ã€‚<br>â˜¯ 2.é‡æ–°å’ŒcameraServiceæ¡æ‰‹(previewåœæ­¢æ—¶å°±ä¼šæ–­å¼€é“¾æ¥ï¼Œåœ¨åˆ‡æ¢ç¬é—´å°±æ–­å¼€äº†)<br>â˜¯ 3.ä½¿ç”¨ICameraä»£ç†å¯¹è±¡å¯åŠ¨å½•åƒã€‚</p><h5 id="4-4ã€é˜¶æ®µå°ç»“"><a href="#4-4ã€é˜¶æ®µå°ç»“" class="headerlink" title="4.4ã€é˜¶æ®µå°ç»“"></a>4.4ã€é˜¶æ®µå°ç»“</h5><p>åˆ°è¿™é‡ŒCameraå¦‚ä½•ä½¿ç”¨medaiRecorderå½•åƒçš„åŸºæœ¬æµç¨‹å·²ç»æ¸…æ¥šäº†ï¼Œè¿™é‡Œæˆ‘ç”»äº†ä¸€ä¸ªæµç¨‹å›¾ï¼Œå¤§æ¦‚åŒ…å«ä¸‹é¢9ä¸ªæµç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/02-13-medaiRecorder-java-native.png" alt="Alt text"></p><p>â˜¯ è¿‡ç¨‹1ï¼šä¸Šå±‚ç‚¹å‡»äº†å½•åƒåŠŸèƒ½ï¼Œæˆ–è€…å½•åƒpreviewæ¨¡å¼ä¸‹ï¼Œä¼šåˆ›å»ºä¸€ä¸ªmediaRecorDer Javaå±‚å¯¹è±¡ã€‚<br>â˜¯ è¿‡ç¨‹2:javaå±‚mediaRecorderå¯¹è±¡è°ƒç”¨native_jni native_setupæ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªnativeçš„mediaRecorderå¯¹è±¡ã€‚åˆ›å»ºçš„è¿‡ç¨‹ä¸­è¿æ¥mediaPlayerService,å¹¶é€šè¿‡åŒ¿åbinderé€šä¿¡æ–¹å¼è·å–åˆ°ä¸€ä¸ªmediaRecorderClientä»£ç†å¯¹è±¡ï¼Œå¹¶ä¿å­˜åˆ°mediaRecorderå¯¹è±¡çš„æˆå‘˜å˜é‡mMediaRecorderä¸­ã€‚<br>â˜¯ è¿‡ç¨‹3:avaå±‚çš„Cameraå¯¹è±¡ä¼ ç»™mediaRecorder nativeå±‚æ—¶ï¼Œå¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•è·å–åˆ°Cameraæœ¬åœ°å¯¹è±¡å’ŒICameraä»£ç†å¯¹è±¡ã€‚è¿™é‡Œæ˜¯è·å–ICameraä»£ç†å¯¹è±¡å’ŒRecordingProxyæœ¬åœ°å¯¹è±¡<br>â˜¯ è¿‡ç¨‹4:å°†ICameraä»£ç†å¯¹è±¡å’ŒRecordingProxyæœ¬åœ°å¯¹è±¡ä¼ ç»™åœ¨MedaiServiceæœ¬åœ°ç«¯çš„MediaRecorderClientå¯¹è±¡ï¼Œè¿™æ—¶ICameraæ˜¯é‡æ–°åˆ›å»ºçš„ICamerä»£ç†å¯¹è±¡ï¼Œä»¥åŠè·å–åˆ°RecordingProxyä»£ç†å¯¹è±¡ã€‚<br>â˜¯ è¿‡ç¨‹5ï¼šæ ¹æ®è¿‡ç¨‹ï¼”è·å–åˆ°çš„æ–°çš„ICameraä»£ç†å¯¹è±¡å’ŒRecordingProxyä»£ç†å¯¹è±¡ï¼Œåˆ›å»ºæ–°çš„æœ¬åœ°Cameraå¯¹è±¡Camera2ï¼Œä»¥åŠæ³¨å†Œå½•åƒå¸§ç›‘å¬å¯¹è±¡åˆ°Camera2ä¸­ã€‚<br>â˜¯ è¿‡ç¨‹6ï¼šå¯åŠ¨StartRecording<br>â˜¯ è¿‡ç¨‹7:å½“å½•åƒå¸§å¯ç”¨æ—¶ï¼Œé€šçŸ¥é©»ç•™åœ¨MedaiRecorderClientä¸­çš„Camera2æœ¬åœ°å¯¹è±¡æ”¶å¸§ï¼Œäºæ­¤åŒæ—¶Camera2åˆæ˜¯é€šè¿‡æ³¨å†Œçš„å¸§ç›‘å¬å¯¹è±¡å‘ŠçŸ¥MediaClientClientå¯¹è±¡ã€‚MediaClientClientå¯¹è±¡æ‹¿åˆ°å¸§åè¿›è¡Œå½•åƒç¼–ç ã€‚<br>â˜¯ è¿‡ç¨‹8,è¿‡ç¨‹ï¼™ï¼šé€šè¿‡å›è°ƒå‡½æ•°ï¼Œå°†ä¸€äº›æ¶ˆæ¯å‘é€ç»™åº”ç”¨ç«¯ã€‚</p><h5 id="4-5ã€Camera-videoåˆ›å»ºBufferQueue"><a href="#4-5ã€Camera-videoåˆ›å»ºBufferQueue" class="headerlink" title="4.5ã€Camera videoåˆ›å»ºBufferQueue."></a>4.5ã€Camera videoåˆ›å»ºBufferQueue.</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/StreamingProcessor.cpp]</span><br><span class="line"><span class="keyword">status_t</span> StreamingProcessor::updateRecordingStream(<span class="keyword">const</span> Parameters &amp;params) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">m</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">    sp&lt;CameraDeviceBase&gt; device = mDevice.promote();</span><br><span class="line">    <span class="comment">//----------------</span></span><br><span class="line">    <span class="keyword">bool</span> newConsumer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mRecordingConsumer == <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGV(<span class="string">"%s: Camera %d: Creating recording consumer with %zu + 1 "</span></span><br><span class="line">                <span class="string">"consumer-side buffers"</span>, __FUNCTION__, mId, mRecordingHeapCount);</span><br><span class="line">        <span class="comment">// Create CPU buffer queue endpoint. We need one more buffer here so that we can</span></span><br><span class="line">        <span class="comment">// always acquire and free a buffer when the heap is full; otherwise the consumer</span></span><br><span class="line">        <span class="comment">// will have buffers in flight we'll never clear out.</span></span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">        sp&lt;IGraphicBufferConsumer&gt; consumer;</span><br><span class="line">        <span class="comment">//åˆ›å»ºbufferQueueï¼ŒåŒæ—¶è·å–åˆ°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯¹è±¡ã€‚</span></span><br><span class="line">        BufferQueue::createBufferQueue(&amp;producer, &amp;consumer);</span><br><span class="line">        <span class="comment">//æ³¨æ„ä¸‹é¢è®¾ç½®bufferçš„ç”¨å¤„æ˜¯GRALLOC_USAGE_HW_VIDEO_ENCODERï¼Œè¿™ä¸ªä¼šåœ¨</span></span><br><span class="line">        <span class="comment">//mediaRecorderä¸­ä½¿ç”¨åˆ°ã€‚</span></span><br><span class="line">        mRecordingConsumer = <span class="keyword">new</span> BufferItemConsumer(consumer,</span><br><span class="line">                GRALLOC_USAGE_HW_VIDEO_ENCODER,</span><br><span class="line">                mRecordingHeapCount + <span class="number">1</span>);</span><br><span class="line">        mRecordingConsumer-&gt;setFrameAvailableListener(<span class="keyword">this</span>);</span><br><span class="line">        mRecordingConsumer-&gt;setName(String8(<span class="string">"Camera2-RecordingConsumer"</span>));</span><br><span class="line">        mRecordingWindow = <span class="keyword">new</span> Surface(producer);</span><br><span class="line">        newConsumer = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// Allocate memory later, since we don't know buffer size until receipt</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//æ›´æ–°éƒ¨åˆ†ä»£ç ï¼Œå°±ä¸è´´å‡ºæ¥äº†ï¼ï¼ï¼ï¼</span></span><br><span class="line"><span class="comment">//æ³¨æ„ä¸‹é¢video å½•åƒbufferçš„åƒç´ æ ¼å¼æ˜¯CAMERA2_HAL_PIXEL_FORMAT_OPAQUE</span></span><br><span class="line">    <span class="keyword">if</span> (mRecordingStreamId == NO_STREAM) &#123;</span><br><span class="line">        mRecordingFrameCount = <span class="number">0</span>;</span><br><span class="line">        res = device-&gt;createStream(mRecordingWindow,</span><br><span class="line">                params.videoWidth, params.videoHeight,</span><br><span class="line">                CAMERA2_HAL_PIXEL_FORMAT_OPAQUE, &amp;mRecordingStreamId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å¤„ç†ä¸‹é¢å‡ ä»¶äº‹æƒ…ã€‚</p><p>â˜¯ 1.ç”±äºå½•åƒä¸éœ€è¦æ˜¾ç¤ºï¼Œè¿™é‡Œåˆ›å»ºCameraService BufferQueueæœ¬åœ°å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™è·å–åˆ°çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯æœ¬åœ°çš„ï¼Œåªæœ‰BufferQueueä¿å­˜çš„æœ‰IGraphicBufferAllocä»£ç†å¯¹è±¡mAllocatorï¼Œä¸“é—¨ç”¨æ¥åˆ†é…bufferã€‚<br>â˜¯ 2.ç”±äºStremingProcess.cppä¸­å®ç°äº†FrameAvailableListenerç›‘å¬æ¥å£æ–¹æ³•onFrameAvailable()ã€‚è¿™é‡Œä¼šé€šè¿‡setFrameAvailableListeneræ–¹æ³•æ³¨å†Œåˆ°BufferQueueä¸­ã€‚<br>â˜¯ 3.æ ¹æ®ç”Ÿäº§è€…å¯¹è±¡åˆ›å»ºsurfaceå¯¹è±¡ï¼Œå¹¶ä¼ ç»™Camera3Deviceç”³è¯·å½•åƒbuffer.<br>â˜¯ 4.å¦‚æœå‚æ•°æœ‰åå·®æˆ–è€…ä¹‹å‰å·²ç»åˆ›å»ºè¿‡video Stream.è¿™é‡Œä¼šåˆ é™¤æˆ–è€…æ›´æ–°videoStream.å¦‚æœå‹æ ¹æ²¡æœ‰åˆ›å»ºVideoStream,ç›´æ¥åˆ›å»ºVideoStreamå¹¶æ ¹æ®å‚æ•°æ›´æ–°æµä¿¡æ¯ã€‚</p><h5 id="4-6ã€ä½•æ—¶å½•åƒå¸§å¯ç”¨"><a href="#4-6ã€ä½•æ—¶å½•åƒå¸§å¯ç”¨" class="headerlink" title="4.6ã€ä½•æ—¶å½•åƒå¸§å¯ç”¨"></a>4.6ã€ä½•æ—¶å½•åƒå¸§å¯ç”¨</h5><h5 id="4-6-1ã€onFrameAvailable"><a href="#4-6-1ã€onFrameAvailable" class="headerlink" title="4.6.1ã€onFrameAvailable()"></a>4.6.1ã€onFrameAvailable()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/StreamingProcessor.cpp]</span><br><span class="line"><span class="keyword">void</span> StreamingProcessor::onFrameAvailable(<span class="keyword">const</span> BufferItem&amp; <span class="comment">/*item*/</span>) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!mRecordingFrameAvailable) &#123;</span><br><span class="line">        mRecordingFrameAvailable = <span class="literal">true</span>;</span><br><span class="line">        mRecordingFrameAvailableSignal.signal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“video bufferè¿›è¡Œenqueueæ“ä½œå,è¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚å‡½æ•°ä¸­å¯ç”¨å‘ç°ï¼Œæ¿€æ´»äº†StreamingProcessorä¸»çº¿ç¨‹ã€‚</p><h5 id="4-6-2ã€StreamingProcessorçº¿ç¨‹loop"><a href="#4-6-2ã€StreamingProcessorçº¿ç¨‹loop" class="headerlink" title="4.6.2ã€StreamingProcessorçº¿ç¨‹loop"></a>4.6.2ã€StreamingProcessorçº¿ç¨‹loop</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/api1/client2/StreamingProcessor.cpp]</span><br><span class="line"><span class="keyword">bool</span> StreamingProcessor::threadLoop() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="keyword">while</span> (!mRecordingFrameAvailable) &#123;</span><br><span class="line">        <span class="comment">//ä¹‹å‰æ˜¯åœ¨è¿™é‡ŒæŒ‚èµ·çš„,ç°åœ¨æœ‰å¸§å¯ç”¨å°±ä¼šä»è¿™é‡Œå”¤é†’ã€‚</span></span><br><span class="line">            res = mRecordingFrameAvailableSignal.waitRelative(</span><br><span class="line">                mMutex, kWaitDuration);</span><br><span class="line">            <span class="keyword">if</span> (res == TIMED_OUT) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mRecordingFrameAvailable = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        res = processRecordingFrame();<span class="comment">//è¿›ä¸€æ­¥å¤„ç†ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (res == OK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå‘ç°ï¼ŒåŸæ¥StreamingProcessorä¸»çº¿ç¨‹åªä¸ºå½•åƒæœåŠ¡ï¼ŒpreviewStreamåªæ˜¯ä½¿ç”¨äº†å®ƒçš„å‡ ä¸ªæ–¹æ³•è€Œå·²ã€‚</p><h5 id="4-6-3ã€å¸§å¯ç”¨æ¶ˆæ¯å‘é€ç»™Cameraæœ¬åœ°å¯¹è±¡"><a href="#4-6-3ã€å¸§å¯ç”¨æ¶ˆæ¯å‘é€ç»™Cameraæœ¬åœ°å¯¹è±¡" class="headerlink" title="4.6.3ã€å¸§å¯ç”¨æ¶ˆæ¯å‘é€ç»™Cameraæœ¬åœ°å¯¹è±¡"></a>4.6.3ã€å¸§å¯ç”¨æ¶ˆæ¯å‘é€ç»™Cameraæœ¬åœ°å¯¹è±¡</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\api1\client2\StreamingProcessor.cpp]</span><br><span class="line"><span class="keyword">status_t</span> StreamingProcessor::processRecordingFrame() &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    sp&lt;Camera2Heap&gt; recordingHeap;</span><br><span class="line">    <span class="keyword">size_t</span> heapIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">nsecs_t</span> timestamp;</span><br><span class="line">    sp&lt;Camera2Client&gt; client = mClient.promote();</span><br><span class="line"></span><br><span class="line">    BufferItemConsumer::BufferItem imgBuffer;</span><br><span class="line">    <span class="comment">//å–å‡ºbufferæ¶ˆè´¹ï¼Œå°±æ˜¯æ‹¿ç»™mediaRecorderç¼–ç </span></span><br><span class="line">    res = mRecordingConsumer-&gt;acquireBuffer(&amp;imgBuffer, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//----------------------------</span></span><br><span class="line">    <span class="comment">// Call outside locked parameters to allow re-entrancy from notification</span></span><br><span class="line">    Camera2Client::SharedCameraCallbacks::<span class="function">Lock <span class="title">l</span><span class="params">(client-&gt;mSharedCameraCallbacks)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (l.mRemoteCallback != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//è°ƒç”¨Callbacké€šçŸ¥Cameaæœ¬åœ°å¯¹è±¡ã€‚</span></span><br><span class="line">        l.mRemoteCallback-&gt;dataCallbackTimestamp(timestamp,</span><br><span class="line">                CAMERA_MSG_VIDEO_FRAME,</span><br><span class="line">                recordingHeap-&gt;mBuffers[heapIdx]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGW(<span class="string">"%s: Camera %d: Remote callback gone"</span>, __FUNCTION__, mId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br></pre></td></tr></table></figure><p>ä¹‹å‰æˆ‘ä»¬å·²ç»çŸ¥é“Cameraè¿è¡Œæ—¶å­˜åœ¨ç±»å‹ä¸ºICameraClientçš„ä¸¤ä¸ªå¯¹è±¡,å…¶ä¸­ä¸€ä¸ªä»£ç†å¯¹è±¡ä¿å­˜åœ¨CameraServiceä¸­ï¼Œæœ¬åœ°å¯¹è±¡ä¿å­˜çš„Cameraæœ¬åœ°å¯¹è±¡ä¸­ã€‚è¿™é‡Œä»£ç†å¯¹è±¡é€šçŸ¥æœ¬åœ°å¯¹è±¡å–å¸§äº†ã€‚æ³¨æ„è¿™é‡Œæ¶ˆæ¯å‘é€çš„æ˜¯â€œCAMERA_MSG_VIDEO_FRAMEâ€ã€‚</p><h5 id="4-6-4ã€Cameraæœ¬åœ°å¯¹è±¡è½¬å‘æ¶ˆæ¯ç»™mediaRecorder"><a href="#4-6-4ã€Cameraæœ¬åœ°å¯¹è±¡è½¬å‘æ¶ˆæ¯ç»™mediaRecorder" class="headerlink" title="4.6.4ã€Cameraæœ¬åœ°å¯¹è±¡è½¬å‘æ¶ˆæ¯ç»™mediaRecorder."></a>4.6.4ã€Cameraæœ¬åœ°å¯¹è±¡è½¬å‘æ¶ˆæ¯ç»™mediaRecorder.</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/camera/Camera.cpp]</span><br><span class="line"><span class="keyword">void</span> Camera::dataCallbackTimestamp(<span class="keyword">nsecs_t</span> timestamp, <span class="keyword">int32_t</span> msgType, <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// If recording proxy listener is registered, forward the frame and return.</span></span><br><span class="line">    <span class="comment">// The other listener (mListener) is ignored because the receiver needs to</span></span><br><span class="line">    <span class="comment">// call releaseRecordingFrame.</span></span><br><span class="line">    sp&lt;ICameraRecordingProxyListener&gt; proxylistener;</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡ŒmRecordingProxyListenerå°±æ˜¯mediaRecorderæ³¨å†Œè¿‡æ¥çš„ç›‘å¬ä»£ç†å¯¹è±¡</span></span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        proxylistener = mRecordingProxyListener;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (proxylistener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œå°±æŠŠbufferé€åˆ°äº†mediaRecorderä¸­è¿›è¡Œç¼–ç </span></span><br><span class="line">        proxylistener-&gt;dataCallbackTimestamp(timestamp, msgType, dataPtr);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//---------çœç•¥ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡ŒCameraæœ¬åœ°å¯¹è±¡å°±ä¼šè°ƒç”¨mediaRecorderæ³¨å†Œæ¥çš„å¸§ç›‘å¬å¯¹è±¡ã€‚å‰é¢æˆ‘ä»¬å·²ç»åšäº†é‚£ä¹ˆé•¿çš„é“ºå«ï¼Œæˆ‘æƒ³åº”è¯¥å¯ä»¥ç†è§£äº†ã€‚å¥½äº†,mediaRecorderæœ‰é¥­åƒäº†ã€‚</p><h5 id="4-7ã€æ€»ç»“"><a href="#4-7ã€æ€»ç»“" class="headerlink" title="4.7ã€æ€»ç»“"></a>4.7ã€æ€»ç»“</h5><p>1.ä¸€å¼€å§‹æˆ‘è‡ªä»¥ä¸ºpreviewå’ŒVideoä½¿ç”¨åŒä¸€ä¸ªcameraæœ¬åœ°å¯¹è±¡ï¼Œçœ‹äº†ä»£ç å‘ç°ï¼ŒåŸæ¥æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚<br>2.é¢„è§ˆçš„BufferQueueæ˜¯åœ¨CameraServiceä¸­åˆ›å»ºçš„ï¼Œå’ŒsurfaceFlingeræ²¡æœ‰å…³ç³»ï¼Œåªæ˜¯ä¿ç•™äº†IGraphicBufferAllocä»£ç†å¯¹è±¡mAllocatorï¼Œç”¨äºåˆ†é…buffer.<br>3.ä¹‹åŒ¿åbinderæ²¡æœ‰ç†è§£é€å½»ï¼Œä»¥ä¸ºåªæœ‰ä¼ é€’æœ¬åœ°å¯¹è±¡æ‰èƒ½ä½¿ç”¨writeStrongBinder()æ¥å£ä¿å­˜binderå¯¹è±¡ï¼ŒåŒæ—¶åœ¨ä½¿ç”¨ç«¯ä½¿ç”¨readStrongBinder()å°±å¯ä»¥è·å–åˆ°ä»£ç†å¯¹è±¡äº†ã€‚å…¶å®ä¹Ÿå¯ä»¥ä¼ é€’ä»£ç†å¯¹è±¡ï¼Œåªä¸è¿‡ä»£ç ä¼šèµ°å¦å¤–ä¸€å¥—é€»è¾‘ï¼Œåœ¨kernelä¸­é‡æ–°åˆ›å»ºä¸€ä¸ªbinder_refç´¢å¼•å¯¹è±¡è¿”å›ç»™å¦ä¸€ç«¯ã€‚å¦‚ä¸‹mediaRecorderè®¾ç½®cameraæ—¶å°±æ˜¯ä¼ é€’çš„ICameraä»£ç†å¯¹è±¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/media/libmedia/IMediaRecorder.cpp]</span><br><span class="line">    <span class="keyword">status_t</span> setCamera(<span class="keyword">const</span> sp&lt;ICamera&gt;&amp; camera, <span class="keyword">const</span> sp&lt;ICameraRecordingProxy&gt;&amp; proxy)</span><br><span class="line">    &#123;</span><br><span class="line">        ALOGV(<span class="string">"setCamera(%p,%p)"</span>, camera.get(), proxy.get());</span><br><span class="line">        Parcel data, reply;</span><br><span class="line">        data.writeInterfaceToken(IMediaRecorder::getInterfaceDescriptor());</span><br><span class="line">        <span class="comment">//camera-&gt;asBinder()æ˜¯ICameraä»£ç†å¯¹è±¡</span></span><br><span class="line">        data.writeStrongBinder(camera-&gt;asBinder());</span><br><span class="line">        data.writeStrongBinder(proxy-&gt;asBinder());</span><br><span class="line">        remote()-&gt;transact(SET_CAMERA, data, &amp;reply);</span><br><span class="line">        <span class="keyword">return</span> reply.readInt32();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://source.android.com/devices/camera/" target="_blank" rel="noopener">Android Cameraå®˜æ–¹æ–‡æ¡£</a><br><a href="https://blog.csdn.net/eternity9255" target="_blank" rel="noopener">Android 5.0 Cameraç³»ç»Ÿæºç åˆ†æ-CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/stonedemo/category/1080451.html" target="_blank" rel="noopener">Android Camera æµç¨‹å­¦ä¹ è®°å½• - StoneDemo - åšå®¢å›­</a><br><a href="https://blog.csdn.net/shell812/article/category/5905525" target="_blank" rel="noopener">Android Camera ç³»ç»Ÿæ¶æ„æºç åˆ†æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/hbw1992322/article/details/75259311" target="_blank" rel="noopener">Cameraå®‰å“æºç -é«˜é€šmm_cameraæ¶æ„å‰–æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/yanbixing123/article/details/52294305/" target="_blank" rel="noopener">5.2 åº”ç”¨ç¨‹åºå’Œé©±åŠ¨ç¨‹åºä¸­bufferçš„ä¼ è¾“æµç¨‹ - CSDNåšå®¢</a><br><a href="https://www.jianshu.com/p/ecb1be82e6a8" target="_blank" rel="noopener">Camera2 æ•°æ®æµä»frameworkåˆ°Halæºç åˆ†æ - ç®€ä¹¦</a><br><a href="https://www.jianshu.com/p/1baad2a5281d" target="_blank" rel="noopener">mm-cameraå±‚frameæ•°æ®æµæºç åˆ†æ - ç®€ä¹¦</a><br><a href="https://blog.csdn.net/yanbixing123/article/month/2016/08/4?" target="_blank" rel="noopener">v4l2_capture.cåˆ†æâ€”probeå‡½æ•°åˆ†æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/armwind/article/category/6282972" target="_blank" rel="noopener">@@Android Camera fwå­¦ä¹  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/category/3066721" target="_blank" rel="noopener">@@Android Camera API2åˆ†æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/qq_16775897/article/category/7112759" target="_blank" rel="noopener">@@Android Camera æµç¨‹å­¦ä¹ è®°å½• 7.12- CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/guming-camera.html" target="_blank" rel="noopener">@@ä¸“æ ï¼šå¤å†¥çš„android6.0ä¸‹çš„Camera API2.0çš„æºç åˆ†æä¹‹æ—… - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/17751109" target="_blank" rel="noopener">linux3.3 v4l2è§†é¢‘é‡‡é›†é©±åŠ¨æ¡†æ¶(vfe, camera i2c driverï¼Œv4l2_subdevç­‰ä¹‹é—´çš„è”ç³») - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/48974523" target="_blank" rel="noopener">Android Cameraä»Camera HAL1åˆ°Camera HAL3çš„è¿‡æ¸¡ï¼ˆå·²æ›´æ–°åˆ°Android6.0 HAL3.3ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/48972477" target="_blank" rel="noopener">æˆ‘å¿ƒä¾æ—§ä¹‹Android Cameraæ¨¡å—FW/HAL3æ¢å­¦åº - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/armwind/article/details/73709808" target="_blank" rel="noopener">Android Camera fwå­¦ä¹ (å››)-recordingæµç¨‹åˆ†æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/armwind/article/details/52076879" target="_blank" rel="noopener">android cameraåŠ¨æ€åº“åŠ è½½è¿‡ç¨‹ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/49468475" target="_blank" rel="noopener">Android Camera API2.0ä¸‹å…¨æ–°çš„Camera FW/HALæ¶æ„ç®€è¿° - CSDNåšå®¢</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/06/30/Android%20Camera%20System%EF%BC%881%EF%BC%89%EF%BC%9ACamera%20System%5BCamera%20%E7%B3%BB%E7%BB%9F%5D%E6%A1%86%E6%9E%B6%E3%80%81Open%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/06/30/Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera System[Camera ç³»ç»Ÿ]æ¡†æ¶ã€Openè¿‡ç¨‹åˆ†æ/</id>
    <published>2018-06-29T16:00:00.000Z</published>
    <updated>2018-05-25T12:12:49.774Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/camera.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="https://blog.csdn.net/armwind/article/category/6282972" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera fwå­¦ä¹ -Armwindã€‘</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/category/3066721" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera API2åˆ†æ-Gzzaigcnforeverã€‘</a><br><a href="https://blog.csdn.net/qq_16775897/article/category/7112759" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera æµç¨‹å­¦ä¹ è®°å½• Android 7.12-QQ_16775897ã€‘</a><br><a href="https://blog.csdn.net/column/details/guming-camera.html" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - ä¸“æ ï¼šå¤å†¥çš„android6.0ä¸‹çš„Camera API2.0çš„æºç åˆ†æä¹‹æ—…ã€‘</a><br>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><p> ğŸŒ€ğŸŒ€ï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶</p><hr><p>â˜¯ Applicationï¼š<br>â˜¯ /packages/apps/Camera2/src/com/android/camera/</p><p>â˜¯ Frameworkï¼š<br>â˜¯ /frameworks/base/core/java/android/hardware/Camera.java</p><p>â˜¯ JNI:<br>â˜¯ /frameworks/base/core/jni/android_hardware_Camera.cpp</p><p>â˜¯ Native:<br>â˜¯ Clientï¼š<br>frameworks/av/camera/CameraBase.cpp<br>frameworks/av/camera/Camera.cpp<br>frameworks/av/camera/ICamera.cpp<br>frameworks/av/camera/aidl/android/hardware/ICamera.aidl<br>frameworks/av/camera/aidl/android/hardware/ICameraClient.aidl<br>â˜¯ Serverï¼š<br>frameworks/av/camera/cameraserver/main_cameraserver.cpp<br>frameworks/av/services/camera/libcameraservice/CameraService.cpp<br>frameworks/av/services/camera/libcameraservice/api1/CameraClient.cpp<br>frameworks/av/camera/aidl/android/hardware/ICameraService.aidl</p><p>â˜¯ HALï¼š<br>â˜¯ /frameworks/av/services/camera/libcameraservice/device3/<br>â˜¯ /hardware/qcom/camera/QCamera2(é«˜é€šHAL)<br>â˜¯ /vendor/qcom/proprietary/mm-camera(é«˜é€šmm-camera)<br>â˜¯ /vendor/qcom/proprietary/mm-still(é«˜é€šJPEG)</p><p>â˜¯ Kernelï¼š<br>â˜¯ /kernel/drivers/media/platform/msm/camera_v2(é«˜é€šV4L2)<br>â˜¯ /kernel/arch/arm/boot/dts/(é«˜é€šdts)</p><hr><h4 id="ï¼ˆä¸€ï¼‰ã€Android-Camera-System-Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰"><a href="#ï¼ˆä¸€ï¼‰ã€Android-Camera-System-Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Android Camera System Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰"></a>ï¼ˆä¸€ï¼‰ã€Android Camera System Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰</h4><h5 id="1-1ã€Android-Camera-Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰"><a href="#1-1ã€Android-Camera-Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰" class="headerlink" title="1.1ã€Android Camera Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰"></a>1.1ã€Android Camera Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰</h5><h5 id="1-1-1ã€é¦–å…ˆçœ‹çœ‹Android-å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š"><a href="#1-1-1ã€é¦–å…ˆçœ‹çœ‹Android-å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š" class="headerlink" title="1.1.1ã€é¦–å…ˆçœ‹çœ‹Android å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š"></a>1.1.1ã€é¦–å…ˆçœ‹çœ‹Android å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-01-android_ape_fwk_camera.png" alt="Alt text"></p><p><strong>â˜¯åº”ç”¨æ¡†æ¶</strong><br>åº”ç”¨ä»£ç ä½äºåº”ç”¨æ¡†æ¶çº§åˆ«ï¼Œå®ƒåˆ©ç”¨ android.hardware.Camera API æ¥ä¸ç›¸æœºç¡¬ä»¶è¿›è¡Œäº’åŠ¨ã€‚åœ¨å†…éƒ¨ï¼Œæ­¤ä»£ç ä¼šè°ƒç”¨ç›¸åº”çš„ JNI ç²˜åˆç±»ï¼Œä»¥è®¿é—®ä¸è¯¥ç›¸æœºäº’åŠ¨çš„åŸç”Ÿä»£ç ã€‚<br><strong>â˜¯JNI</strong><br>ä¸ android.hardware.Camera å…³è”çš„ JNI ä»£ç ä½äº frameworks/base/core/jni/android_hardware_Camera.cpp ä¸­ã€‚æ­¤ä»£ç ä¼šè°ƒç”¨è¾ƒä½çº§åˆ«çš„åŸç”Ÿä»£ç ä»¥è·å–å¯¹ç‰©ç†ç›¸æœºçš„è®¿é—®æƒé™ï¼Œå¹¶è¿”å›ç”¨äºåœ¨æ¡†æ¶çº§åˆ«åˆ›å»º android.hardware.Camera å¯¹è±¡çš„æ•°æ®ã€‚<br><strong>â˜¯åŸç”Ÿæ¡†æ¶</strong><br>åœ¨ frameworks/av/camera/Camera.cpp ä¸­å®šä¹‰çš„åŸç”Ÿæ¡†æ¶å¯æä¾›ç›¸å½“äº android.hardware.Camera ç±»çš„åŸç”Ÿç±»ã€‚æ­¤ç±»ä¼šè°ƒç”¨ IPC binder ä»£ç†ï¼Œä»¥è·å–å¯¹ç›¸æœºæœåŠ¡çš„è®¿é—®æƒé™ã€‚<br><strong>â˜¯Binder IPC ä»£ç†</strong><br>IPC binder ä»£ç†ç”¨äºä¿ƒè¿›è·¨è¶Šè¿›ç¨‹è¾¹ç•Œçš„é€šä¿¡ã€‚è°ƒç”¨ç›¸æœºæœåŠ¡çš„ frameworks/av/camera ç›®å½•ä¸­æœ‰ 3 ä¸ªç›¸æœº binder ç±»ã€‚ICameraService æ˜¯ç›¸æœºæœåŠ¡çš„æ¥å£ï¼ŒICamera æ˜¯å·²æ‰“å¼€çš„ç‰¹å®šç›¸æœºè®¾å¤‡çš„æ¥å£ï¼ŒICameraClient æ˜¯è¿”å›åº”ç”¨æ¡†æ¶çš„è®¾å¤‡æ¥å£ã€‚<br><strong>â˜¯ç›¸æœºæœåŠ¡</strong><br>ä½äº frameworks/av/services/camera/libcameraservice/CameraService.cpp ä¸‹çš„ç›¸æœºæœåŠ¡æ˜¯ä¸ HAL è¿›è¡Œäº’åŠ¨çš„å®é™…ä»£ç ã€‚<br><strong>â˜¯HAL</strong><br>ç¡¬ä»¶æŠ½è±¡å±‚å®šä¹‰äº†ç”±ç›¸æœºæœåŠ¡è°ƒç”¨ä¸”æ‚¨å¿…é¡»å®ç°ä»¥ç¡®ä¿ç›¸æœºç¡¬ä»¶æ­£å¸¸è¿è¡Œçš„æ ‡å‡†æ¥å£ã€‚<br><strong>â˜¯å†…æ ¸é©±åŠ¨ç¨‹åº</strong><br>ç›¸æœºçš„é©±åŠ¨ç¨‹åºå¯ä¸å®é™…ç›¸æœºç¡¬ä»¶ä»¥åŠæ‚¨çš„ HAL å®ç°è¿›è¡Œäº’åŠ¨ã€‚ç›¸æœºå’Œé©±åŠ¨ç¨‹åºå¿…é¡»æ”¯æŒ YV12 å’Œ NV21 å›¾ç‰‡æ ¼å¼ï¼Œä»¥ä¾¿åœ¨æ˜¾ç¤ºå’Œè§†é¢‘å½•åˆ¶æ—¶æ”¯æŒé¢„è§ˆç›¸æœºå›¾ç‰‡ã€‚</p><h5 id="1-1-2ã€Qualcommå¹³å°Camera-æ¶æ„"><a href="#1-1-2ã€Qualcommå¹³å°Camera-æ¶æ„" class="headerlink" title="1.1.2ã€Qualcommå¹³å°Camera æ¶æ„"></a>1.1.2ã€Qualcommå¹³å°Camera æ¶æ„</h5><p>Qualcommå¹³å°Camera æ¶æ„ä¸»è¦åŒºåˆ«åœ¨äºHALå±‚å’ŒKernelå±‚çš„å˜åŒ–ï¼Œæ€»ä½“æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><h5 id="1-1-2-1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„"><a href="#1-1-2-1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„" class="headerlink" title="1.1.2.1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„"></a>1.1.2.1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-02-Android-Camera-Software-Architecture.png" alt="Alt text"></p><h5 id="1-1-2-2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera"><a href="#1-1-2-2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera" class="headerlink" title="1.1.2.2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera"></a>1.1.2.2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-03-HAL-and-mm-camera-interface.png" alt="Alt text"></p><h5 id="1-1-2-3ã€Qualcommå¹³å°Cameraçš„Kernel"><a href="#1-1-2-3ã€Qualcommå¹³å°Cameraçš„Kernel" class="headerlink" title="1.1.2.3ã€Qualcommå¹³å°Cameraçš„Kernel"></a>1.1.2.3ã€Qualcommå¹³å°Cameraçš„Kernel</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-04-Camera-Kernel-Architecture.png" alt="Alt text"></p><h5 id="1-2ã€Android-Camera-API-2-0-å…¨æ–°çš„HAL-å­ç³»ç»Ÿ"><a href="#1-2ã€Android-Camera-API-2-0-å…¨æ–°çš„HAL-å­ç³»ç»Ÿ" class="headerlink" title="1.2ã€Android Camera API 2.0 å…¨æ–°çš„HAL å­ç³»ç»Ÿ"></a>1.2ã€Android Camera API 2.0 å…¨æ–°çš„HAL å­ç³»ç»Ÿ</h5><p>Android 7.1.2ç°åœ¨ä½¿ç”¨çš„æ˜¯Camera API 2.0 å’Œ Camera Device 3ä»¥åŠ HAL3ã€‚</p><h5 id="1-2-1ã€è¯·æ±‚"><a href="#1-2-1ã€è¯·æ±‚" class="headerlink" title="1.2.1ã€è¯·æ±‚"></a>1.2.1ã€è¯·æ±‚</h5><p>åº”ç”¨æ¡†æ¶é’ˆå¯¹æ•è·çš„ç»“æœå‘ç›¸æœºå­ç³»ç»Ÿå‘å‡ºè¯·æ±‚ã€‚ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ç»„ç»“æœã€‚è¯·æ±‚åŒ…å«æœ‰å…³æ•è·å’Œå¤„ç†è¿™äº›ç»“æœçš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚å…¶ä¸­åŒ…æ‹¬åˆ†è¾¨ç‡å’Œåƒç´ æ ¼å¼ï¼›æ‰‹åŠ¨ä¼ æ„Ÿå™¨ã€é•œå¤´å’Œé—ªå…‰ç¯æ§ä»¶ï¼›3A æ“ä½œæ¨¡å¼ï¼›RAW åˆ° YUV å¤„ç†æ§ä»¶ï¼›ä»¥åŠç»Ÿè®¡ä¿¡æ¯çš„ç”Ÿæˆã€‚è¿™æ ·ä¸€æ¥ï¼Œä¾¿å¯æ›´å¥½åœ°æ§åˆ¶ç»“æœçš„è¾“å‡ºå’Œå¤„ç†ã€‚ä¸€æ¬¡å¯å‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œè€Œä¸”æäº¤çš„è¯·æ±‚ä¸ä¼šå‡ºç°é˜»å¡çš„æƒ…å†µã€‚è¯·æ±‚å§‹ç»ˆæŒ‰ç…§æ¥æ”¶çš„é¡ºåºè¿›è¡Œå¤„ç†ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-05-camera2api.png.png" alt="Alt text"></p><h5 id="1-2-2ã€HAL-å’Œç›¸æœºå­ç³»ç»Ÿ"><a href="#1-2-2ã€HAL-å’Œç›¸æœºå­ç³»ç»Ÿ" class="headerlink" title="1.2.2ã€HAL å’Œç›¸æœºå­ç³»ç»Ÿ"></a>1.2.2ã€HAL å’Œç›¸æœºå­ç³»ç»Ÿ</h5><p>ç›¸æœºå­ç³»ç»ŸåŒ…æ‹¬ç›¸æœºç®¡é“ä¸­ç»„ä»¶çš„å®ç°ï¼Œä¾‹å¦‚ 3A ç®—æ³•å’Œå¤„ç†æ§ä»¶ã€‚ç›¸æœº HAL ä¸ºæ‚¨æä¾›äº†å®ç°æ‚¨ç‰ˆæœ¬çš„è¿™äº›ç»„ä»¶æ‰€éœ€çš„æ¥å£ã€‚ä¸ºäº†ä¿æŒå¤šä¸ªè®¾å¤‡åˆ¶é€ å•†å’Œå›¾åƒä¿¡å·å¤„ç†å™¨ï¼ˆISPï¼Œä¹Ÿç§°ä¸ºç›¸æœºä¼ æ„Ÿå™¨ï¼‰ä¾›åº”å•†ä¹‹é—´çš„è·¨å¹³å°å…¼å®¹æ€§ï¼Œç›¸æœºç®¡é“æ¨¡å‹æ˜¯è™šæ‹Ÿçš„ï¼Œä¸”ä¸ç›´æ¥å¯¹åº”ä»»ä½•çœŸæ­£çš„ ISPã€‚ä¸è¿‡ï¼Œå®ƒä¸çœŸæ­£çš„å¤„ç†ç®¡é“è¶³å¤Ÿç›¸ä¼¼ï¼Œå› æ­¤æ‚¨å¯ä»¥æœ‰æ•ˆåœ°å°†å…¶æ˜ å°„åˆ°ç¡¬ä»¶ã€‚æ­¤å¤–ï¼Œå®ƒè¶³å¤ŸæŠ½è±¡ï¼Œå¯æ”¯æŒå¤šç§ä¸åŒçš„ç®—æ³•å’Œæ“ä½œé¡ºåºï¼Œè€Œä¸ä¼šå½±å“è´¨é‡ã€æ•ˆç‡æˆ–è·¨è®¾å¤‡å…¼å®¹æ€§ã€‚<br>ç›¸æœºç®¡é“è¿˜æ”¯æŒåº”ç”¨æ¡†æ¶å¼€å¯è‡ªåŠ¨å¯¹ç„¦ç­‰åŠŸèƒ½çš„è§¦å‘å™¨ã€‚å®ƒè¿˜ä¼šå°†é€šçŸ¥å‘é€å›åº”ç”¨æ¡†æ¶ï¼Œä»¥é€šçŸ¥åº”ç”¨è‡ªåŠ¨å¯¹ç„¦é”å®šæˆ–é”™è¯¯ç­‰äº‹ä»¶ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-06-camera_hal_request_control.png.png" alt="Alt text"></p><blockquote><p>RAW Bayer è¾“å‡ºåœ¨ ISP å†…éƒ¨ä¸ç»è¿‡ä»»ä½•å¤„ç†ã€‚<br>ç»Ÿè®¡ä¿¡æ¯æ ¹æ®åŸå§‹ä¼ æ„Ÿå™¨æ•°æ®ç”Ÿæˆã€‚<br>å°†åŸå§‹ä¼ æ„Ÿå™¨æ•°æ®è½¬æ¢ä¸º YUV çš„å„ç§å¤„ç†å—æŒ‰ä»»æ„é¡ºåºæ’åˆ—ã€‚<br>å½“æ˜¾ç¤ºå¤šä¸ªåˆ»åº¦å’Œå‰ªè£å•å…ƒæ—¶ï¼Œæ‰€æœ‰çš„ç¼©æ”¾å™¨å•å…ƒå…±äº«è¾“å‡ºåŒºåŸŸæ§ä»¶ï¼ˆæ•°å­—ç¼©æ”¾ï¼‰ã€‚ä¸è¿‡ï¼Œæ¯ä¸ªå•å…ƒéƒ½å¯èƒ½å…·æœ‰ä¸åŒçš„è¾“å‡ºåˆ†è¾¨ç‡å’Œåƒç´ æ ¼å¼ã€‚</p></blockquote><h5 id="1-2-3ã€HAL-æ“ä½œæ‘˜è¦"><a href="#1-2-3ã€HAL-æ“ä½œæ‘˜è¦" class="headerlink" title="1.2.3ã€HAL æ“ä½œæ‘˜è¦"></a>1.2.3ã€HAL æ“ä½œæ‘˜è¦</h5><p>â˜¯ æ•è·çš„å¼‚æ­¥è¯·æ±‚æ¥è‡ªäºæ¡†æ¶ã€‚<br>â˜¯ HAL è®¾å¤‡å¿…é¡»æŒ‰é¡ºåºå¤„ç†è¯·æ±‚ã€‚å¯¹äºæ¯ä¸ªè¯·æ±‚ï¼Œå‡äº§ç”Ÿè¾“å‡ºç»“æœå…ƒæ•°æ®ä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡ºå›¾ç‰‡ç¼“å†²åŒºã€‚<br>â˜¯ è¯·æ±‚å’Œç»“æœä»¥åŠåç»­è¯·æ±‚å¼•ç”¨çš„æµéµå®ˆå…ˆè¿›å…ˆå‡ºè§„åˆ™ã€‚<br>â˜¯ æŒ‡å®šè¯·æ±‚çš„æ‰€æœ‰è¾“å‡ºçš„æ—¶é—´æˆ³å¿…é¡»å®Œå…¨ç›¸åŒï¼Œä»¥ä¾¿æ¡†æ¶å¯ä»¥æ ¹æ®éœ€è¦å°†å®ƒä»¬åŒ¹é…åœ¨ä¸€èµ·ã€‚<br>â˜¯ æ‰€æœ‰æ•è·é…ç½®å’ŒçŠ¶æ€ï¼ˆä¸åŒ…æ‹¬ 3A ä¾‹ç¨‹ï¼‰éƒ½åŒ…å«åœ¨è¯·æ±‚å’Œç»“æœä¸­ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-07-camera-hal-overview-oo.png.png" alt="Alt text"></p><h5 id="1-2-4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº"><a href="#1-2-4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº" class="headerlink" title="1.2.4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº"></a>1.2.4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº</h5><p>1ã€æ¡†æ¶è°ƒç”¨ camera_module_t-&gt;common.open()ï¼Œè€Œè¿™ä¼šè¿”å›ä¸€ä¸ª hardware_device_t ç»“æ„ã€‚<br>2ã€æ¡†æ¶æ£€æŸ¥ hardware_device_t-&gt;version å­—æ®µï¼Œå¹¶ä¸ºè¯¥ç‰ˆæœ¬çš„ç›¸æœºç¡¬ä»¶è®¾å¤‡å®ä¾‹åŒ–ç›¸åº”çš„å¤„ç†ç¨‹åºã€‚å¦‚æœç‰ˆæœ¬æ˜¯ CAMERA_DEVICE_API_VERSION_3_0ï¼Œåˆ™è¯¥è®¾å¤‡ä¼šè½¬å‹ä¸º camera3_device_tã€‚<br>3ã€æ¡†æ¶è°ƒç”¨ camera3_device_t-&gt;ops-&gt;initialize() å¹¶æ˜¾ç¤ºæ¡†æ¶å›è°ƒå‡½æ•°æŒ‡é’ˆã€‚åœ¨è°ƒç”¨ ops ç»“æ„ä¸­çš„ä»»ä½•å…¶ä»–å‡½æ•°ä¹‹å‰ï¼Œè¿™åªä¼šåœ¨ open() ä¹‹åè°ƒç”¨ä¸€æ¬¡ã€‚<br>4ã€æ¡†æ¶è°ƒç”¨ camera3_device_t-&gt;ops-&gt;configure_streams() å¹¶æ˜¾ç¤ºåˆ° HAL è®¾å¤‡çš„è¾“å…¥/è¾“å‡ºæµåˆ—è¡¨ã€‚<br>5ã€æ¡†æ¶ä¸º configure_streams ä¸­åˆ—å‡ºçš„è‡³å°‘ä¸€ä¸ªè¾“å‡ºæµåˆ†é… gralloc ç¼“å†²åŒºå¹¶è°ƒç”¨ camera3_device_t-&gt;ops-&gt;register_stream_buffers()ã€‚ç›¸åŒçš„æµä»…æ³¨å†Œä¸€æ¬¡ã€‚<br>6ã€æ¡†æ¶é€šè¿‡è°ƒç”¨ camera3_device_t-&gt;ops-&gt;construct_default_request_settings() æ¥ä¸ºæŸäº›ä½¿ç”¨æƒ…å½¢è¯·æ±‚é»˜è®¤è®¾ç½®ã€‚è¿™å¯èƒ½ä¼šåœ¨ç¬¬ 3 æ­¥ä¹‹åçš„ä»»ä½•æ—¶é—´å‘ç”Ÿã€‚<br>7ã€æ¡†æ¶é€šè¿‡åŸºäºå…¶ä¸­ä¸€ç»„é»˜è®¤è®¾ç½®çš„è®¾ç½®ä»¥åŠè‡³å°‘ä¸€ä¸ªæ¡†æ¶ä¹‹å‰æ³¨å†Œçš„è¾“å‡ºæµæ¥æ„å»ºç¬¬ä¸€ä¸ªæ•è·è¯·æ±‚å¹¶å°†å…¶å‘é€åˆ° HALã€‚å®ƒé€šè¿‡ camera3_device_t-&gt;ops-&gt;process_capture_request() å‘é€åˆ° HALã€‚HAL å¿…é¡»é˜»æ­¢æ­¤è°ƒç”¨è¿”å›ï¼Œç›´åˆ°å‡†å¤‡å¥½å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚<br>8ã€æ¡†æ¶ç»§ç»­æäº¤è¯·æ±‚ï¼Œå¹¶ä¸”å¯èƒ½ä¼šä¸ºå°šæœªæ³¨å†Œçš„æµè°ƒç”¨ register_stream_buffers()ï¼Œå¹¶è°ƒç”¨ construct_default_request_settings æ¥ä¸ºå…¶ä»–ä½¿ç”¨æƒ…å½¢è·å–é»˜è®¤è®¾ç½®ç¼“å†²åŒºã€‚<br>9ã€å½“è¯·æ±‚æ•è·å¼€å§‹ï¼ˆä¼ æ„Ÿå™¨å¼€å§‹æ›å…‰ä»¥è¿›è¡Œæ•è·ï¼‰æ—¶ï¼ŒHAL ä¼šè°ƒç”¨ camera3_callback_ops_t-&gt;notify() å¹¶æ˜¾ç¤º SHUTTER äº‹ä»¶ï¼ŒåŒ…æ‹¬å¸§å·å’Œå¼€å§‹æ›å…‰çš„æ—¶é—´æˆ³ã€‚æ­¤é€šçŸ¥è°ƒç”¨å¿…é¡»åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å¸§å·çš„ process_capture_result() ä¹‹å‰è¿›è¡Œã€‚<br>10ã€åœ¨æŸä¸ªç®¡é“å»¶è¿Ÿåï¼ŒHAL å¼€å§‹ä½¿ç”¨ camera3_callback_ops_t-&gt;process_capture_result() å°†å®Œæˆçš„æ•è·è¿”å›åˆ°æ¡†æ¶ã€‚è¿™äº›æ•è·æŒ‰ç…§ä¸æäº¤è¯·æ±‚ç›¸åŒçš„é¡ºåºè¿”å›ã€‚ä¸€æ¬¡å¯å‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œå…·ä½“å–å†³äºç›¸æœº HAL è®¾å¤‡çš„ç®¡é“æ·±åº¦ã€‚<br>11ã€ä¸€æ®µæ—¶é—´åï¼Œæ¡†æ¶å¯èƒ½ä¼šåœæ­¢æäº¤æ–°çš„è¯·æ±‚ã€ç­‰å¾…ç°æœ‰æ•è·å®Œæˆï¼ˆæ‰€æœ‰ç¼“å†²åŒºéƒ½å·²å¡«å……ï¼Œæ‰€æœ‰ç»“æœéƒ½å·²è¿”å›ï¼‰ï¼Œç„¶åå†æ¬¡è°ƒç”¨ configure_streams()ã€‚è¿™ä¼šé‡ç½®ç›¸æœºç¡¬ä»¶å’Œç®¡é“ï¼Œä»¥è·å¾—ä¸€ç»„æ–°çš„è¾“å…¥/è¾“å‡ºæµã€‚å¯é‡å¤ä½¿ç”¨å…ˆå‰é…ç½®ä¸­çš„éƒ¨åˆ†æµï¼›å¦‚æœè¿™äº›æµçš„ç¼“å†²åŒºå·²ç»è¿‡ HAL æ³¨å†Œï¼Œåˆ™ä¸ä¼šå†æ¬¡æ³¨å†Œã€‚å¦‚æœè‡³å°‘è¿˜æœ‰ä¸€ä¸ªå·²æ³¨å†Œçš„è¾“å‡ºæµï¼Œåˆ™æ¡†æ¶ä»ç¬¬ 7 æ­¥ç»§ç»­ï¼ˆå¦åˆ™ï¼Œéœ€è¦å…ˆå®Œæˆç¬¬ 5 æ­¥ï¼‰ã€‚<br>12ã€æˆ–è€…ï¼Œæ¡†æ¶å¯èƒ½ä¼šè°ƒç”¨ camera3_device_t-&gt;common-&gt;close() ä»¥ç»“æŸç›¸æœºä¼šè¯ã€‚å½“æ¡†æ¶ä¸­æ²¡æœ‰å…¶ä»–å¤„äºæ´»åŠ¨çŠ¶æ€çš„è°ƒç”¨æ—¶ï¼Œå®ƒå¯èƒ½éšæ—¶ä¼šè¢«è°ƒç”¨ï¼›å°½ç®¡åœ¨æ‰€æœ‰å‘èµ·çš„æ•è·å®Œæˆï¼ˆæ‰€æœ‰ç»“æœéƒ½å·²è¿”å›ï¼Œæ‰€æœ‰ç¼“å†²åŒºéƒ½å·²å¡«å……ï¼‰ä¹‹å‰ï¼Œè°ƒç”¨å¯èƒ½ä¼šé˜»å¡ã€‚åœ¨ close è°ƒç”¨è¿”å›åï¼Œä¸å…è®¸å†ä» HAL å¯¹ camera3_callback_ops_t å‡½æ•°è¿›è¡Œæ›´å¤šè°ƒç”¨ã€‚ä¸€æ—¦è¿›è¡Œ close() è°ƒç”¨ï¼Œè¯¥æ¡†æ¶å¯èƒ½ä¸ä¼šè°ƒç”¨ä»»ä½•å…¶ä»– HAL è®¾å¤‡å‡½æ•°ã€‚<br>13ã€åœ¨å‘ç”Ÿé”™è¯¯æˆ–å…¶ä»–å¼‚æ­¥äº‹ä»¶æ—¶ï¼ŒHAL å¿…é¡»è°ƒç”¨ camera3_callback_ops_t-&gt;notify() å¹¶è¿”å›ç›¸åº”çš„é”™è¯¯/äº‹ä»¶æ¶ˆæ¯ã€‚ä»ä¸¥é‡çš„è®¾å¤‡èŒƒå›´é”™è¯¯é€šçŸ¥è¿”å›åï¼ŒHAL åº”è¡¨ç°ä¸ºåœ¨å…¶ä¸Šè°ƒç”¨äº† close()ã€‚ä½†æ˜¯ï¼ŒHAL å¿…é¡»åœ¨è°ƒç”¨ notify() ä¹‹å‰å–æ¶ˆæˆ–å®Œæˆæ‰€æœ‰å¾…å¤„ç†çš„æ•è·ï¼Œä»¥ä¾¿åœ¨è°ƒç”¨ notify() å¹¶è¿”å›ä¸¥é‡é”™è¯¯æ—¶ï¼Œæ¡†æ¶ä¸ä¼šæ”¶åˆ°æ¥è‡ªè®¾å¤‡çš„æ›´å¤šå›è°ƒã€‚åœ¨ä¸¥é‡çš„é”™è¯¯æ¶ˆæ¯è¿”å› notify() æ–¹æ³•åï¼Œclose() ä¹‹å¤–çš„æ–¹æ³•åº”è¯¥è¿”å› -ENODEV æˆ– NULLã€‚</p><h5 id="1-3ã€Android-Graphics-å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»"><a href="#1-3ã€Android-Graphics-å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»" class="headerlink" title="1.3ã€Android Graphics å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»"></a>1.3ã€Android Graphics å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-08-Android-graphics-SurfaceFlinger-BufferQueue.jpg.png" alt="Alt text"></p><p>Graphics ç³»ç»Ÿè¯¦ç»†åˆ†æè¯·å‚è€ƒï¼šã€Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿåˆ†æã€‘(<a href="http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/">http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/</a>)</p><h5 id="1-4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨"><a href="#1-4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨" class="headerlink" title="1.4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨"></a>1.4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨</h5><h5 id="1-4-1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ"><a href="#1-4-1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ" class="headerlink" title="1.4.1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ"></a>1.4.1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-09-Android-Camera-class.png" alt="Alt text"></p><p>â˜¯ 1ã€ICameraClient: è¿™ä¸»è¦æ˜¯ä¸€äº›æ¶ˆæ¯å‘é€çš„æ¥å£ï¼ŒåŒ…æ‹¬å¸§å¯ç”¨é€šçŸ¥ï¼Œå›è°ƒä¸€äº›ä¿¡æ¯ç»™clientç­‰æ¶ˆæ¯ã€‚ä¸è¿‡è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼ŒBnCameraClientå¯¹è±¡å…¶å®æ˜¯åœ¨clientè¿™ç«¯ï¼Œä¸åœ¨CameraServiceç«¯ã€‚<br>â˜¯ 2ã€ICamera:cameraçš„ä¸€äº›æ ‡å‡†æ“ä½œæ¥å£ï¼Œæ¯”å¦‚startpreviewï¼Œtakepicuture,autofocus,æ‰€æœ‰çš„æ“ä½œåŠ¨ä½œéƒ½æ˜¯ç”¨çš„è¿™ä¸€å¥—æ¥å£ã€‚<br>â˜¯ 3ã€ICameraService: é“¾æ¥CameraæœåŠ¡ï¼ŒCamera device,è·å–Cameraæ•°é‡ï¼ŒCameraç¡¬ä»¶ä¿¡æ¯ï¼Œè§†å‚è§’ï¼Œé•œå¤´ç­‰ä¿¡æ¯ã€‚</p><h5 id="1-4-2ã€ICameraClient"><a href="#1-4-2ã€ICameraClient" class="headerlink" title="1.4.2ã€ICameraClient"></a>1.4.2ã€ICameraClient</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-10-ICameraClient.png" alt="Alt text"></p><h5 id="1-4-3ã€ICamera"><a href="#1-4-3ã€ICamera" class="headerlink" title="1.4.3ã€ICamera"></a>1.4.3ã€ICamera</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-11-ICamera.png" alt="Alt text"></p><h5 id="1-4-4ã€ICameraService"><a href="#1-4-4ã€ICameraService" class="headerlink" title="1.4.4ã€ICameraService"></a>1.4.4ã€ICameraService</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-12-ICameraService.png" alt="Alt text"></p><h4 id="ï¼ˆäºŒï¼‰ã€Android-CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ"><a href="#ï¼ˆäºŒï¼‰ã€Android-CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Android CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ"></a>ï¼ˆäºŒï¼‰ã€Android CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ</h4><p>é¦–å…ˆçœ‹ä¸‹æ€»ä½“æ—¶åºå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-13-CameraService_onFirstRef.png" alt="Alt text"></p><h5 id="2-1ã€CameraService-åˆå§‹åŒ–è¿‡ç¨‹"><a href="#2-1ã€CameraService-åˆå§‹åŒ–è¿‡ç¨‹" class="headerlink" title="2.1ã€CameraService åˆå§‹åŒ–è¿‡ç¨‹"></a>2.1ã€CameraService åˆå§‹åŒ–è¿‡ç¨‹</h5><p>Androidå¯åŠ¨çš„æ—¶å€™ä¼šæ”¶é›†ç³»ç»Ÿçš„.rcæ–‡ä»¶ï¼Œå¯åŠ¨å¯¹åº”çš„Native Serviceï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\camera\cameraserver\cameraserver.rc]</span><br><span class="line">service cameraserver /system/bin/cameraserver</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">cameraserver</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">audio</span> <span class="title">camera</span> <span class="title">input</span> <span class="title">drmrpc</span></span></span><br><span class="line"><span class="class">    <span class="title">ioprio</span> <span class="title">rt</span> 4</span></span><br><span class="line"><span class="class">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">camera</span>-<span class="title">daemon</span>/<span class="title">tasks</span> /<span class="title">dev</span>/<span class="title">stune</span>/<span class="title">top</span>-<span class="title">app</span>/<span class="title">tasks</span></span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\camera\cameraserver\main_cameraserver.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span>** argv __unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line">    sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    ALOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">    CameraService::instantiate();</span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CameraServiceç»§æ‰¿è‡ªBinderServiceï¼Œinstantiateä¹Ÿæ˜¯åœ¨BinderServiceä¸­å®šä¹‰çš„ï¼Œæ­¤æ–¹æ³•å°±æ˜¯è°ƒç”¨publishæ–¹æ³•ï¼Œæ‰€ä»¥æ¥çœ‹publishæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\include\binder\BinderService.h]</span><br><span class="line"><span class="function"><span class="keyword">static</span> status_t <span class="title">publish</span><span class="params">(<span class="keyword">bool</span> allowIsolated = <span class="literal">false</span>)</span> </span>&#123;</span><br><span class="line">    sp&lt;IServiceManager&gt; sm(defaultServiceManager());</span><br><span class="line">    <span class="comment">//å°†æœåŠ¡æ·»åŠ åˆ°ServiceManager</span></span><br><span class="line">    <span class="keyword">return</span> sm-&gt;addService(String16(SERVICE::getServiceName()),<span class="keyword">new</span> SERVICE(), allowIsolated);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œå°†ä¼šæŠŠCameraServiceæœåŠ¡åŠ å…¥åˆ°ServiceManagerè¿›è¡Œç®¡ç†ã€‚ CameraServiceçš„æ„é€ æ—¶ï¼Œä¼šè°ƒç”¨CameraServiceçš„onFirstRefæ–¹æ³•ï¼š</p><h5 id="2-1-1ã€CameraService-onFirstRef"><a href="#2-1-1ã€CameraService-onFirstRef" class="headerlink" title="2.1.1ã€CameraService::onFirstRef()"></a>2.1.1ã€CameraService::onFirstRef()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> CameraService::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    ALOGI(<span class="string">"CameraService process starting"</span>);</span><br><span class="line"></span><br><span class="line">    BnCameraService::onFirstRef();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update battery life tracking if service is restarting</span></span><br><span class="line">    BatteryNotifier&amp; notifier(BatteryNotifier::getInstance());</span><br><span class="line">    notifier.noteResetCamera();</span><br><span class="line">    notifier.noteResetFlashlight();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">camera_module_t</span> *rawModule;</span><br><span class="line">    <span class="keyword">int</span> err = hw_get_module(CAMERA_HARDWARE_MODULE_ID,</span><br><span class="line">            (<span class="keyword">const</span> <span class="keyword">hw_module_t</span> **)&amp;rawModule);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    mModule = <span class="keyword">new</span> CameraModule(rawModule);</span><br><span class="line">    err = mModule-&gt;init();</span><br><span class="line">    ......</span><br><span class="line">    mFlashlight = <span class="keyword">new</span> CameraFlashlight(*mModule, *<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">status_t</span> res = mFlashlight-&gt;findFlashUnits();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mModule-&gt;getModuleApiVersion() &gt;= CAMERA_MODULE_API_VERSION_2_1) &#123;</span><br><span class="line">        mModule-&gt;setCallbacks(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CameraService::pingCameraServiceProxy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šé€šè¿‡HALæ¡†æ¶çš„hw_get_moduleæ¥åˆ›å»ºCameraModuleå¯¹è±¡ï¼Œç„¶åä¼šå¯¹å…¶è¿›è¡Œç›¸åº”çš„åˆå§‹åŒ–ï¼Œå¹¶ä¼šè¿›è¡Œä¸€äº›å‚æ•°çš„è®¾ç½®ï¼Œå¦‚cameraçš„æ•°é‡ï¼Œé—ªå…‰ç¯çš„åˆå§‹åŒ–ï¼Œä»¥åŠå›è°ƒå‡½æ•°çš„è®¾ç½®ç­‰ï¼Œåˆ°è¿™é‡Œï¼ŒCamera2 HALçš„æ¨¡å—å°±åˆå§‹åŒ–ç»“æŸäº†ã€‚</p><h5 id="2-1-2ã€Camera-åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹"><a href="#2-1-2ã€Camera-åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹" class="headerlink" title="2.1.2ã€Camera åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹"></a>2.1.2ã€Camera åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹</h5><p>åœ¨æºç ä¸­ä¸çŸ¥å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„åˆ°ç¬¬äºŒä¸ªå‚æ•°æ˜¯hw_module_t <strong>module,è¿™é‡Œæ˜¯æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œè€Œæˆ‘ä»¬åˆšæ‰ä¼ çš„æ˜¯camera_module_t</strong>æŒ‡é’ˆã€‚å¤§å®¶å¯ä»¥çœ‹åˆ°camera_module_t ç»“æ„ç¬¬ä¸€ä¸ªåŸŸå°±æ˜¯hw_module_t æ‰€ä»¥è¿™é‡Œå°±ä¸éš¾ç†è§£äº†ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">æºç è·¯å¾„ï¼šhardware/libhardware/hardware.c</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Base path of the hal modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH1 <span class="meta-string">"/system/lib/hw"</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH2 <span class="meta-string">"/vendor/lib/hw"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hw_get_module</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *id, <span class="keyword">const</span> struct <span class="keyword">hw_module_t</span> **<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hw_get_module_by_class(id, <span class="literal">NULL</span>, <span class="keyword">module</span>); </span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„idå°±æ˜¯cameraæ¨¡å—çš„idï¼Œæ¯ä¸€ä¸ªhal moduleéƒ½æœ‰å¯¹åº”çš„idï¼Œ</span></span><br><span class="line">    <span class="comment">//åŒºåˆ†ä»–ä»¬å°±é€šè¿‡è¿™ä¸ªidæ¥åŒºåˆ†äº†ã€‚</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hw_get_module_by_class</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *class_id, <span class="keyword">const</span> <span class="keyword">char</span> *inst,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> struct <span class="keyword">hw_module_t</span> **<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> *<span class="title">hmi</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">char</span> prop[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> path[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> name[PATH_MAX];</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* Loop through the configuration variants looking for a module */</span></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span> ; i&lt;HAL_VARIANT_KEYS_COUNT+<span class="number">1</span> ; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; HAL_VARIANT_KEYS_COUNT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (property_get(variant_keys[i], prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123; <span class="comment">//å…³é”®å­—æ•°ç»„ï¼Œä¸Šé¢æœ‰å®ä»£ç ã€‚</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">"%s/%s.%s.so"</span>,</span><br><span class="line">                     HAL_LIBRARY_PATH2, name, prop);</span><br><span class="line">            <span class="keyword">if</span> (access(path, R_OK) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">"%s/%s.%s.so"</span>, <span class="comment">//æ‹¼æ¥å®Œæ•´çš„cameraåº“ã€‚</span></span><br><span class="line">                     HAL_LIBRARY_PATH1, name, prop);</span><br><span class="line">            <span class="keyword">if</span> (access(path, R_OK) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">"%s/%s.default.so"</span>,</span><br><span class="line">                     HAL_LIBRARY_PATH2, name);</span><br><span class="line">            <span class="keyword">if</span> (access(path, R_OK) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">"%s/%s.default.so"</span>,</span><br><span class="line">                     HAL_LIBRARY_PATH1, name);</span><br><span class="line">            <span class="keyword">if</span> (access(path, R_OK) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = -ENOENT;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; HAL_VARIANT_KEYS_COUNT+<span class="number">1</span>) &#123;</span><br><span class="line">        status = load(class_id, path, <span class="keyword">module</span>); <span class="comment">//å¦‚æœä¸Šé¢éƒ½è¿›è¡Œå®Œæ¯•ï¼Œèµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜å·²ç»æ‰¾åˆ°åº“äº†ï¼Œè¿™é‡Œå°±å»åŠ è½½ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ ¹æ®idæ¥åŠ è½½halçš„module</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">load</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *id,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">char</span> *path,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> struct <span class="keyword">hw_module_t</span> **pHmi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">void</span> *handle;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> *<span class="title">hmi</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    handle = dlopen(path, RTLD_NOW); <span class="comment">//åŠ¨æ€åŠ è½½å†…å­˜çš„apiï¼Œè¿™é‡Œçš„path=/system/lib/hw/camera.msm8996.so</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* Get the address of the struct hal_module_info. */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sym = HAL_MODULE_INFO_SYM_AS_STR;   <span class="comment">//åˆ«çš„åœ°æ–¹å®šä¹‰#define HAL_MODULE_INFO_SYM_AS_STR  "HMI"</span></span><br><span class="line">    hmi = (struct <span class="keyword">hw_module_t</span> *)dlsym(handle, sym); <span class="comment">//æˆ‘ä»¬åŠ¨æ€é“¾æ¥çš„æ˜¯"HMI"è¿™ä¸ªç¬¦å·ã€‚</span></span><br><span class="line">    ......</span><br><span class="line">    *pHmi = hmi; <span class="comment">//æœ€åå°†è¿™ä¸ªæŒ‡é’ˆï¼Œèµ‹ç»™æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ struct camera_moduleå˜é‡ã€‚è¿™é‡Œæ¨¡å—å°±åŠ è½½è¿›æ¥äº†ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//halä»£ç </span></span><br><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\QCamera2Hal.cpp]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">hw_module_t</span> camera_common = &#123;</span><br><span class="line">    .tag                    = HARDWARE_MODULE_TAG,</span><br><span class="line">    .module_api_version     = CAMERA_MODULE_API_VERSION_2_4,</span><br><span class="line">    .hal_api_version        = HARDWARE_HAL_API_VERSION,</span><br><span class="line">    .id                     = CAMERA_HARDWARE_MODULE_ID,</span><br><span class="line">    .name                   = <span class="string">"QCamera Module"</span>,</span><br><span class="line">    .author                 = <span class="string">"Qualcomm Innovation Center Inc"</span>,</span><br><span class="line">    .methods                = &amp;qcamera::QCamera2Factory::mModuleMethods, <span class="comment">//å®ƒçš„æ–¹æ³•æ•°ç»„é‡Œç»‘å®šäº†openæ¥å£</span></span><br><span class="line">    .dso                    = <span class="literal">NULL</span>,</span><br><span class="line">    .reserved               = &#123;<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">camera_module_t</span> HAL_MODULE_INFO_SYM = &#123;</span><br><span class="line">    .common                 = camera_common,</span><br><span class="line">    .get_number_of_cameras  = qcamera::QCamera2Factory::get_number_of_cameras,</span><br><span class="line">    .get_camera_info        = qcamera::QCamera2Factory::get_camera_info,</span><br><span class="line">    .set_callbacks          = qcamera::QCamera2Factory::set_callbacks,</span><br><span class="line">    .get_vendor_tag_ops     = qcamera::QCamera3VendorTags::get_vendor_tag_ops,</span><br><span class="line">    .open_legacy            = qcamera::QCamera2Factory::open_legacy,</span><br><span class="line">    .set_torch_mode         = qcamera::QCamera2Factory::set_torch_mode,</span><br><span class="line">    .init                   = <span class="literal">NULL</span>,</span><br><span class="line">    .reserved               = &#123;<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hw_module_methods_t</span> <span class="title">QCamera2Factory</span>:</span>:mModuleMethods = &#123;</span><br><span class="line">    <span class="comment">//openæ–¹æ³•çš„ç»‘å®š</span></span><br><span class="line">    open: QCamera2Factory::camera_device_open,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Camera HALå±‚çš„openå…¥å£å…¶å®å°±æ˜¯camera_device_openæ–¹æ³•ï¼š</p><h5 id="2-1-3ã€å›¾è§£camera-moduleå’Œcamera-device-tå…³ç³»"><a href="#2-1-3ã€å›¾è§£camera-moduleå’Œcamera-device-tå…³ç³»" class="headerlink" title="2.1.3ã€å›¾è§£camera_moduleå’Œcamera_device_tå…³ç³»"></a>2.1.3ã€å›¾è§£camera_moduleå’Œcamera_device_tå…³ç³»</h5><p>camer moduleåœ¨ç³»ç»Ÿä¸­è½¬æŒ‡cameraæ¨¡å—ï¼Œcamera_device_t è½¬æŒ‡æŸä¸€ä¸ªcamera è®¾å¤‡ã€‚åœ¨æµç¨‹ä¸Šï¼Œnative framwork å…ˆåŠ è½½åœ¨halå±‚å®šä¹‰çš„camer_moduleå¯¹è±¡ï¼Œç„¶åé€šè¿‡camera_moduleçš„methods openæ–¹æ³•å¡«å……camera_device_t ç»“æ„ä½“ï¼Œå¹¶æœ€ç»ˆè·å–åˆ°camera opsè¿™ä¸€æ•´ä¸ªcameraæœ€é‡è¦çš„æ“ä½œé›†åˆã€‚ä¸‹å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°struct hw_module_tåœ¨camera_moduleæœ€ä¸Šé¢ è€Œcamera_device_tæœ€å¼€å§‹ä¿å­˜çš„æ˜¯struct hw_device_t. ç”±æ­¤æˆ‘ä»¬å¹³æ—¶åœ¨çœ‹ä»£ç æ—¶ï¼Œè¦æ³¨æ„ä¸€äº›æŒ‡é’ˆè½¬æ¢ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-14-camera_module camera_device_t.png" alt="Alt text"></p><h4 id="ï¼ˆä¸‰ï¼‰ã€Android-Camera-Openè¿‡ç¨‹"><a href="#ï¼ˆä¸‰ï¼‰ã€Android-Camera-Openè¿‡ç¨‹" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Android Camera Openè¿‡ç¨‹"></a>ï¼ˆä¸‰ï¼‰ã€Android Camera Openè¿‡ç¨‹</h4><h5 id="3-1ã€Camera2-HALå±‚Open-è¿‡ç¨‹åˆ†æ"><a href="#3-1ã€Camera2-HALå±‚Open-è¿‡ç¨‹åˆ†æ" class="headerlink" title="3.1ã€Camera2 HALå±‚Open()è¿‡ç¨‹åˆ†æ"></a>3.1ã€Camera2 HALå±‚Open()è¿‡ç¨‹åˆ†æ</h5><p>é«˜é€šçš„Cameraï¼Œå®ƒåœ¨åå°ä¼šæœ‰ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹daemonï¼Œdaemonæ˜¯ä»‹äºåº”ç”¨å’Œé©±åŠ¨ä¹‹é—´ç¿»è¯‘ioctlçš„ä¸­é—´å±‚(å§”æ‰˜å¤„ç†)ã€‚æœ¬èŠ‚å°†ä»¥Cameraä¸­çš„openæµç¨‹ä¸ºä¾‹ï¼Œæ¥åˆ†æCamera HALçš„å·¥ä½œè¿‡ç¨‹ï¼Œåœ¨åº”ç”¨å¯¹ç¡¬ä»¶å‘å‡ºopenè¯·æ±‚åï¼Œä¼šé€šè¿‡Camera HALæ¥å‘èµ·openè¯·æ±‚ï¼Œè€ŒCamera HALçš„openå…¥å£åœ¨QCamera2Hal.cppè¿›è¡Œäº†å®šä¹‰ï¼Œå³å‰é¢åˆ†æçš„Camera HALå±‚çš„openå…¥å£å…¶å®å°±æ˜¯camera_device_openæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\QCamera2Factory.cpp]</span><br><span class="line"><span class="keyword">int</span> QCamera2Factory::camera_device_open(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span> *<span class="keyword">module</span>, <span class="keyword">const</span> <span class="keyword">char</span> *id,</span><br><span class="line">        struct <span class="keyword">hw_device_t</span> **hw_device)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> gQCamera2Factory-&gt;cameraDeviceOpen(atoi(id), hw_device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒè°ƒç”¨äº†cameraDeviceOpenæ–¹æ³•ï¼Œè€Œå…¶ä¸­çš„hw_deviceå°±æ˜¯æœ€åè¦è¿”å›ç»™åº”ç”¨å±‚çš„CameraDeviceImplåœ¨Camera HALå±‚çš„å¯¹è±¡ï¼Œç»§ç»­åˆ†æcameraDeviceOpenæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\QCamera2Factory.cpp]</span><br><span class="line"><span class="keyword">int</span> QCamera2Factory::cameraDeviceOpen(<span class="keyword">int</span> camera_id, struct <span class="keyword">hw_device_t</span> **hw_device)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//Camera2é‡‡ç”¨çš„Camera HALç‰ˆæœ¬ä¸ºHAL3.0</span></span><br><span class="line">    <span class="keyword">if</span> ( mHalDescriptors[camera_id].device_version == CAMERA_DEVICE_API_VERSION_3_0 ) &#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–QCamera3HardwareInterfaceå¯¹è±¡ï¼Œè¿™é‡Œæ„é€ å‡½æ•°é‡Œå°†ä¼šè¿›è¡Œconfigure_streamsä»¥åŠ</span></span><br><span class="line">        <span class="comment">//process_capture_resultç­‰çš„ç»‘å®š</span></span><br><span class="line">        QCamera3HardwareInterface *hw = <span class="keyword">new</span> QCamera3HardwareInterface(</span><br><span class="line">            mHalDescriptors[camera_id].cameraId, mCallbacks);</span><br><span class="line">        <span class="comment">//é€šè¿‡QCamera3HardwareInterfaceæ¥æ‰“å¼€Camera</span></span><br><span class="line">        rc = hw-&gt;openCamera(hw_device);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mHalDescriptors[camera_id].device_version == CAMERA_DEVICE_API_VERSION_1_0) &#123;</span><br><span class="line">        <span class="comment">//HAL APIä¸º2.0</span></span><br><span class="line">        QCamera2HardwareInterface *hw = <span class="keyword">new</span> QCamera2HardwareInterface((<span class="keyword">uint32_t</span>)camera_id);</span><br><span class="line">        rc = hw-&gt;openCamera(hw_device);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼šä¸€ä¸ªæ˜¯QCamera3HardwareInterfaceå¯¹è±¡çš„åˆ›å»ºï¼Œå®ƒæ˜¯ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´è¿›è¡Œäº¤äº’çš„æ¥å£ï¼›å¦ä¸€ä¸ªæ˜¯è°ƒç”¨å®ƒçš„openCameraæ–¹æ³•æ¥æ‰“å¼€Cameraï¼Œä¸‹é¢å°†åˆ†åˆ«è¿›è¡Œåˆ†æã€‚</p><h5 id="3-1-1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ"><a href="#3-1-1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ" class="headerlink" title="3.1.1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ"></a>3.1.1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ</h5><p>åœ¨å®ƒçš„æ„é€ å‡½æ•°é‡Œé¢æœ‰ä¸€ä¸ªå…³é”®çš„åˆå§‹åŒ–ï¼Œå³mCameraDevice.ops = &amp;mCameraOpsï¼Œå®ƒä¼šå®šä¹‰Deviceæ“ä½œçš„æ¥å£ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</span><br><span class="line"><span class="keyword">camera3_device_ops_t</span> QCamera3HardwareInterface::mCameraOps = &#123;</span><br><span class="line">    initialize:                         QCamera3HardwareInterface::initialize,</span><br><span class="line">    <span class="comment">//é…ç½®æµæ•°æ®çš„ç›¸å…³å¤„ç†</span></span><br><span class="line">    configure_streams:                  QCamera3HardwareInterface::configure_streams,</span><br><span class="line">    register_stream_buffers:            <span class="literal">NULL</span>,</span><br><span class="line">    construct_default_request_settings: </span><br><span class="line">        QCamera3HardwareInterface::construct_default_request_settings,</span><br><span class="line">    <span class="comment">//å¤„ç†ç»“æœçš„æ¥å£</span></span><br><span class="line">    process_capture_request:            </span><br><span class="line">        QCamera3HardwareInterface::process_capture_request,</span><br><span class="line">    get_metadata_vendor_tag_ops:        <span class="literal">NULL</span>,</span><br><span class="line">    dump:                               QCamera3HardwareInterface::dump,</span><br><span class="line">    flush:                              QCamera3HardwareInterface::flush,</span><br><span class="line">    reserved:                           &#123;<span class="number">0</span>&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œä¼šåœ¨configure_streamsä¸­é…ç½®å¥½æµçš„å¤„ç†handleï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</span><br><span class="line"><span class="keyword">int</span> QCamera3HardwareInterface::configure_streams(<span class="keyword">const</span> struct camera3_device *device,</span><br><span class="line">        <span class="keyword">camera3_stream_configuration_t</span> *stream_list)&#123;</span><br><span class="line">    <span class="comment">//è·å¾—QCamera3HardwareInterfaceå¯¹è±¡</span></span><br><span class="line">    QCamera3HardwareInterface *hw =<span class="keyword">reinterpret_cast</span>&lt;QCamera3HardwareInterface *&gt;(device-&gt;priv);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//è°ƒç”¨å®ƒçš„configureStreamsè¿›è¡Œé…ç½®</span></span><br><span class="line">    <span class="keyword">int</span> rc = hw-&gt;configureStreams(stream_list);</span><br><span class="line">    ..</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è¿½è¸ªconfigureStreamæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</span><br><span class="line"><span class="keyword">int</span> QCamera3HardwareInterface::configureStreams(<span class="keyword">camera3_stream_configuration_t</span> *streamList)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–Cameraç‰ˆæœ¬</span></span><br><span class="line">    al_version = CAM_HAL_V3;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//å¼€å§‹é…ç½®stream</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ç›¸å…³Channelä¸ºNULL</span></span><br><span class="line">    <span class="keyword">if</span> (mMetadataChannel) &#123;</span><br><span class="line">        <span class="keyword">delete</span> mMetadataChannel;</span><br><span class="line">        mMetadataChannel = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mSupportChannel) &#123;</span><br><span class="line">        <span class="keyword">delete</span> mSupportChannel;</span><br><span class="line">        mSupportChannel = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAnalysisChannel) &#123;</span><br><span class="line">        <span class="keyword">delete</span> mAnalysisChannel;</span><br><span class="line">        mAnalysisChannel = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºMetadata Channelï¼Œå¹¶å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">    mMetadataChannel = <span class="keyword">new</span> QCamera3MetadataChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">        mCameraHandle-&gt;ops, captureResultCb,&amp;gCamCapability[mCameraId]-&gt;padding_info, </span><br><span class="line">        CAM_QCOM_FEATURE_NONE, <span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">    rc = mMetadataChannel-&gt;initialize(IS_TYPE_NONE);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//å¦‚æœh/w supportå¯ç”¨ï¼Œåˆ™åˆ›å»ºåˆ†æstreamçš„Channel</span></span><br><span class="line">    <span class="keyword">if</span> (gCamCapability[mCameraId]-&gt;hw_analysis_supported) &#123;</span><br><span class="line">        mAnalysisChannel = <span class="keyword">new</span> QCamera3SupportChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">                mCameraHandle-&gt;ops,&amp;gCamCapability[mCameraId]-&gt;padding_info,</span><br><span class="line">                CAM_QCOM_FEATURE_PP_SUPERSET_HAL3,CAM_STREAM_TYPE_ANALYSIS,</span><br><span class="line">                &amp;gCamCapability[mCameraId]-&gt;analysis_recommended_res,<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isRawStreamRequested = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//æ¸…ç©ºstreamé…ç½®ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;mStreamConfigInfo, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">cam_stream_size_info_t</span>));</span><br><span class="line">    <span class="comment">//ä¸ºrequested streamåˆ†é…ç›¸å…³çš„channelå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; streamList-&gt;num_streams; i++) &#123;</span><br><span class="line">        <span class="keyword">camera3_stream_t</span> *newStream = streamList-&gt;streams[i];</span><br><span class="line">        <span class="keyword">uint32_t</span> stream_usage = newStream-&gt;usage;</span><br><span class="line">        mStreamConfigInfo.stream_sizes[mStreamConfigInfo.num_streams].width = (<span class="keyword">int32_t</span>)newStream-</span><br><span class="line">                &gt;width;</span><br><span class="line">        mStreamConfigInfo.stream_sizes[mStreamConfigInfo.num_streams].height = (<span class="keyword">int32_t</span>)newStream-</span><br><span class="line">                &gt;height;</span><br><span class="line">        <span class="keyword">if</span> ((newStream-&gt;stream_type == CAMERA3_STREAM_BIDIRECTIONAL||newStream-&gt;usage &amp; </span><br><span class="line">                GRALLOC_USAGE_HW_CAMERA_ZSL) &amp;&amp;newStream-&gt;format == </span><br><span class="line">                HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED &amp;&amp; jpegStream)&#123;</span><br><span class="line">            mStreamConfigInfo.type[mStreamConfigInfo.num_streams] = CAM_STREAM_TYPE_SNAPSHOT;</span><br><span class="line">            mStreamConfigInfo.postprocess_mask[mStreamConfigInfo.num_streams] = </span><br><span class="line">                CAM_QCOM_FEATURE_NONE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(newStream-&gt;stream_type == CAMERA3_STREAM_INPUT) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (newStream-&gt;format) &#123;</span><br><span class="line">                <span class="comment">//ä¸ºézsl streamsæŸ¥æ‰¾ä»–ä»¬çš„format</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newStream-&gt;priv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//ä¸ºæ–°çš„streamæ„é€ Channel</span></span><br><span class="line">            <span class="keyword">switch</span> (newStream-&gt;stream_type) &#123;<span class="comment">//åˆ†ç±»å‹æ„é€ </span></span><br><span class="line">            <span class="keyword">case</span> CAMERA3_STREAM_INPUT:</span><br><span class="line">                newStream-&gt;usage |= GRALLOC_USAGE_HW_CAMERA_READ;</span><br><span class="line">                newStream-&gt;usage |= GRALLOC_USAGE_HW_CAMERA_WRITE;<span class="comment">//WR for inplace algo's</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CAMERA3_STREAM_BIDIRECTIONAL:</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CAMERA3_STREAM_OUTPUT:</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ ¹æ®å‰é¢çš„å¾—åˆ°çš„streamçš„å‚æ•°ç±»å‹ä»¥åŠformatåˆ†åˆ«å¯¹å„ç±»å‹çš„channelè¿›è¡Œæ„é€ </span></span><br><span class="line">            <span class="keyword">if</span> (newStream-&gt;stream_type == CAMERA3_STREAM_OUTPUT ||</span><br><span class="line">                    newStream-&gt;stream_type == CAMERA3_STREAM_BIDIRECTIONAL) &#123;</span><br><span class="line">                QCamera3Channel *channel = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">switch</span> (newStream-&gt;format) &#123;</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED:</span><br><span class="line">                    <span class="comment">/* use higher number of buffers for HFR mode */</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">//åˆ›å»ºRegular Channel</span></span><br><span class="line">                    channel = <span class="keyword">new</span> QCamera3RegularChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">                        mCameraHandle-&gt;ops, captureResultCb,&amp;gCamCapability[mCameraId]-</span><br><span class="line">                        &gt;padding_info,<span class="keyword">this</span>,newStream,(<span class="keyword">cam_stream_type_t</span>)mStreamConfigInfo.type[</span><br><span class="line">                        mStreamConfigInfo.num_streams],mStreamConfigInfo.postprocess_mask[</span><br><span class="line">                        mStreamConfigInfo.num_streams],mMetadataChannel,numBuffers);</span><br><span class="line">                    ...</span><br><span class="line">                    newStream-&gt;max_buffers = channel-&gt;getNumBuffers();</span><br><span class="line">                    newStream-&gt;priv = channel;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_YCbCr_420_888:</span><br><span class="line">                    <span class="comment">//åˆ›å»ºYWV Channel</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_RAW_OPAQUE:</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_RAW16:</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_RAW10:</span><br><span class="line">                    <span class="comment">//åˆ›å»ºRaw Channel</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_BLOB:</span><br><span class="line">                    <span class="comment">//åˆ›å»ºQCamera3PicChannel</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStream-&gt;stream_type == CAMERA3_STREAM_INPUT) &#123;</span><br><span class="line">                newStream-&gt;max_buffers = MAX_INFLIGHT_REPROCESS_REQUESTS;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (List&lt;<span class="keyword">stream_info_t</span>*&gt;::iterator it=mStreamInfo.begin();it != mStreamInfo.end(); </span><br><span class="line">                    it++) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((*it)-&gt;stream == newStream) &#123;</span><br><span class="line">                    (*it)-&gt;channel = (QCamera3Channel*) newStream-&gt;priv;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newStream-&gt;stream_type != CAMERA3_STREAM_INPUT)</span><br><span class="line">            mStreamConfigInfo.num_streams++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isZsl) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPictureChannel) &#123;</span><br><span class="line">           mPictureChannel-&gt;overrideYuvSize(zslStream-&gt;width, zslStream-&gt;height);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPictureChannel &amp;&amp; m_bIs4KVideo) &#123;</span><br><span class="line">        mPictureChannel-&gt;overrideYuvSize(videoWidth, videoHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RAW DUMP channel</span></span><br><span class="line">    <span class="keyword">if</span> (mEnableRawDump &amp;&amp; isRawStreamRequested == <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">cam_dimension_t</span> rawDumpSize;</span><br><span class="line">        rawDumpSize = getMaxRawSize(mCameraId);</span><br><span class="line">        mRawDumpChannel = <span class="keyword">new</span> QCamera3RawDumpChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">            mCameraHandle-&gt;ops,rawDumpSize,&amp;gCamCapability[mCameraId]-&gt;padding_info,</span><br><span class="line">            <span class="keyword">this</span>, CAM_QCOM_FEATURE_NONE);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿›è¡Œç›¸å…³Channelçš„é…ç½®</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* Initialize mPendingRequestInfo and mPendnigBuffersMap */</span></span><br><span class="line">    <span class="keyword">for</span> (List&lt;PendingRequestInfo&gt;::iterator i = mPendingRequestsList.begin();</span><br><span class="line">                i != mPendingRequestsList.end(); i++) &#123;</span><br><span class="line">        clearInputBuffer(i-&gt;input_buffer);</span><br><span class="line">        i = mPendingRequestsList.erase(i);</span><br><span class="line">    &#125;</span><br><span class="line">    mPendingFrameDropList.clear();</span><br><span class="line">    <span class="comment">// Initialize/Reset the pending buffers list</span></span><br><span class="line">    mPendingBuffersMap.num_buffers = <span class="number">0</span>;</span><br><span class="line">    mPendingBuffersMap.mPendingBufferList.clear();</span><br><span class="line">    mPendingReprocessResultList.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•å†…å®¹æ¯”è¾ƒå¤šï¼ŒåªæŠ½å–å…¶ä¸­æ ¸å¿ƒçš„ä»£ç è¿›è¡Œè¯´æ˜ï¼Œå®ƒé¦–å…ˆä¼šæ ¹æ®HALçš„ç‰ˆæœ¬æ¥å¯¹streamè¿›è¡Œç›¸åº”çš„é…ç½®åˆå§‹åŒ–ï¼Œç„¶åå†æ ¹æ®streamç±»å‹å¯¹stream_listçš„streamåˆ›å»ºç›¸åº”çš„Channelï¼Œä¸»è¦æœ‰QCamera3MetadataChannelï¼ŒQCamera3SupportChannelç­‰ï¼Œç„¶åå†è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œå…¶ä¸­QCamera3MetadataChannelåœ¨åé¢çš„å¤„ç†capture requestçš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œè¿™é‡Œå°±ä¸åšåˆ†æï¼Œè€ŒCamerametadataåˆ™æ˜¯Javaå±‚å’ŒCameraServiceä¹‹é—´ä¼ é€’çš„å…ƒæ•°æ®ï¼Œè§android6.0æºç åˆ†æä¹‹Camera API2.0ç®€ä»‹ä¸­çš„Camera2æ¶æ„å›¾ï¼Œè‡³æ­¤ï¼ŒQCamera3HardwareInterfaceæ„é€ ç»“æŸï¼Œä¸æœ¬æ–‡ç›¸å…³çš„å°±æ˜¯é…ç½®äº†mCameraDevice.opsã€‚</p><h5 id="3-1-2ã€openCamera-åˆ†æ"><a href="#3-1-2ã€openCamera-åˆ†æ" class="headerlink" title="3.1.2ã€openCamera()åˆ†æ"></a>3.1.2ã€openCamera()åˆ†æ</h5><p>æœ¬èŠ‚ä¸»è¦åˆ†æModuleæ˜¯å¦‚ä½•æ‰“å¼€Cameraçš„ï¼ŒopenCameraçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\HAL3\QCamera3HWI.cpp]</span><br><span class="line"><span class="keyword">int</span> QCamera3HardwareInterface::openCamera(struct <span class="keyword">hw_device_t</span> **hw_device)&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (mCameraOpened) &#123;<span class="comment">//å¦‚æœCameraå·²ç»è¢«æ‰“å¼€ï¼Œåˆ™æ­¤æ¬¡æ‰“å¼€çš„è®¾å¤‡ä¸ºNULLï¼Œå¹¶ä¸”æ‰“å¼€ç»“æœä¸ºPERMISSION_DENIED</span></span><br><span class="line">        *hw_device = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è°ƒç”¨openCameraæ–¹æ³•æ¥æ‰“å¼€</span></span><br><span class="line">    rc = openCamera();</span><br><span class="line">    <span class="comment">//æ‰“å¼€ç»“æœå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//è·å–æ‰“å¼€æˆåŠŸçš„hw_device_tå¯¹è±¡</span></span><br><span class="line">        *hw_device = &amp;mCameraDevice.common;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        *hw_device = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒè°ƒç”¨äº†openCamera()æ–¹æ³•æ¥æ‰“å¼€Camera:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\HAL3\QCamera3HWI.cpp]</span><br><span class="line"><span class="keyword">int</span> QCamera3HardwareInterface::openCamera()</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ‰“å¼€cameraï¼Œè·å–mCameraHandle</span></span><br><span class="line">    mCameraHandle = camera_open((<span class="keyword">uint8_t</span>)mCameraId);</span><br><span class="line">    ...</span><br><span class="line">    mCameraOpened = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//æ³¨å†Œmm-camera-interfaceé‡Œçš„äº‹ä»¶å¤„ç†,å…¶ä¸­camEctHandleä¸ºäº‹ä»¶å¤„ç†Handle</span></span><br><span class="line">    rc = mCameraHandle-&gt;ops-&gt;register_event_notify(mCameraHandle-&gt;camera_handle,camEvtHandle</span><br><span class="line">            ,(<span class="keyword">void</span> *)<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒè°ƒç”¨camera_openæ–¹æ³•æ¥æ‰“å¼€Cameraï¼Œå¹¶ä¸”å‘CameraHandleæ³¨å†Œäº†Camera æ—¶é—´å¤„ç†çš„Handleâ€“camEvtHandleï¼Œé¦–å…ˆåˆ†æcamera_openæ–¹æ³•ï¼Œè¿™é‡Œå°±å°†è¿›å…¥é«˜é€šçš„Cameraçš„å®ç°äº†ï¼Œè€ŒMm_camera_interface.cæ˜¯é«˜é€šæä¾›çš„ç›¸å…³æ“ä½œçš„æ¥å£ï¼Œæ¥ä¸‹æ¥åˆ†æé«˜é€šCameraçš„camera_openæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\vendor\qcom\proprietary\mm-camera\apps\appslib\mm_camera_interface.c]</span><br><span class="line"><span class="keyword">mm_camera_vtbl_t</span> * camera_open(<span class="keyword">uint8_t</span> camera_idx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">mm_camera_obj_t</span>* cam_obj = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/* opened already å¦‚æœå·²ç»æ‰“å¼€*/</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> != g_cam_ctrl.cam_obj[camera_idx]) &#123;</span><br><span class="line">        <span class="comment">/* Add reference */</span></span><br><span class="line">        g_cam_ctrl.cam_obj[camera_idx]-&gt;ref_count++;</span><br><span class="line">        pthread_mutex_unlock(&amp;g_intf_lock);</span><br><span class="line">        <span class="keyword">return</span> &amp;g_cam_ctrl.cam_obj[camera_idx]-&gt;vtbl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cam_obj = (<span class="keyword">mm_camera_obj_t</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">mm_camera_obj_t</span>));</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* initialize camera obj */</span></span><br><span class="line">    <span class="built_in">memset</span>(cam_obj, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">mm_camera_obj_t</span>));</span><br><span class="line">    cam_obj-&gt;ctrl_fd = <span class="number">-1</span>;</span><br><span class="line">    cam_obj-&gt;ds_fd = <span class="number">-1</span>;</span><br><span class="line">    cam_obj-&gt;ref_count++;</span><br><span class="line">    cam_obj-&gt;my_hdl = mm_camera_util_generate_handler(camera_idx);</span><br><span class="line">    cam_obj-&gt;vtbl.camera_handle = cam_obj-&gt;my_hdl; <span class="comment">/* set handler */</span></span><br><span class="line">    <span class="comment">//mm_camera_opsé‡Œç»‘å®šäº†ç›¸å…³çš„æ“ä½œæ¥å£</span></span><br><span class="line">    cam_obj-&gt;vtbl.ops = &amp;mm_camera_ops;</span><br><span class="line">    pthread_mutex_init(&amp;cam_obj-&gt;cam_lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_lock(&amp;cam_obj-&gt;cam_lock);</span><br><span class="line">    pthread_mutex_unlock(&amp;g_intf_lock);</span><br><span class="line">    <span class="comment">//è°ƒç”¨mm_camera_openæ–¹æ³•æ¥æ‰“å¼€camera</span></span><br><span class="line">    rc = mm_camera_open(cam_obj);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;g_intf_lock);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//ç»“æœå¤„ç†ï¼Œå¹¶è¿”å›</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œè¿™é‡Œå°†ä¼šåˆå§‹åŒ–ä¸€ä¸ªmm_camera_obj_tå¯¹è±¡ï¼Œå…¶ä¸­ï¼Œds_fdä¸ºsocket fdï¼Œè€Œmm_camera_opsåˆ™ç»‘å®šäº†ç›¸å…³çš„æ¥å£ï¼Œæœ€åè°ƒç”¨mm_camera_openæ¥æ‰“å¼€Cameraï¼Œé¦–å…ˆæ¥çœ‹çœ‹mm_camera_opsç»‘å®šäº†å“ªäº›æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\vendor\qcom\proprietary\mm-camera\apps\appslib\mm_camera_interface.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mm_camera_ops_t</span> mm_camera_ops = &#123;</span><br><span class="line">    .query_capability = mm_camera_intf_query_capability,</span><br><span class="line">    <span class="comment">//æ³¨å†Œäº‹ä»¶é€šçŸ¥çš„æ–¹æ³•</span></span><br><span class="line">    .register_event_notify = mm_camera_intf_register_event_notify,</span><br><span class="line">    .close_camera = mm_camera_intf_close,</span><br><span class="line">    .set_parms = mm_camera_intf_set_parms,</span><br><span class="line">    .get_parms = mm_camera_intf_get_parms,</span><br><span class="line">    .do_auto_focus = mm_camera_intf_do_auto_focus,</span><br><span class="line">    .cancel_auto_focus = mm_camera_intf_cancel_auto_focus,</span><br><span class="line">    .prepare_snapshot = mm_camera_intf_prepare_snapshot,</span><br><span class="line">    .start_zsl_snapshot = mm_camera_intf_start_zsl_snapshot,</span><br><span class="line">    .stop_zsl_snapshot = mm_camera_intf_stop_zsl_snapshot,</span><br><span class="line">    .map_buf = mm_camera_intf_map_buf,</span><br><span class="line">    .unmap_buf = mm_camera_intf_unmap_buf,</span><br><span class="line">    .add_channel = mm_camera_intf_add_channel,</span><br><span class="line">    .delete_channel = mm_camera_intf_del_channel,</span><br><span class="line">    .get_bundle_info = mm_camera_intf_get_bundle_info,</span><br><span class="line">    .add_stream = mm_camera_intf_add_stream,</span><br><span class="line">    .link_stream = mm_camera_intf_link_stream,</span><br><span class="line">    .delete_stream = mm_camera_intf_del_stream,</span><br><span class="line">    <span class="comment">//é…ç½®streamçš„æ–¹æ³•</span></span><br><span class="line">    .config_stream = mm_camera_intf_config_stream,</span><br><span class="line">    .qbuf = mm_camera_intf_qbuf,</span><br><span class="line">    .get_queued_buf_count = mm_camera_intf_get_queued_buf_count,</span><br><span class="line">    .map_stream_buf = mm_camera_intf_map_stream_buf,</span><br><span class="line">    .unmap_stream_buf = mm_camera_intf_unmap_stream_buf,</span><br><span class="line">    .set_stream_parms = mm_camera_intf_set_stream_parms,</span><br><span class="line">    .get_stream_parms = mm_camera_intf_get_stream_parms,</span><br><span class="line">    .start_channel = mm_camera_intf_start_channel,</span><br><span class="line">    .stop_channel = mm_camera_intf_stop_channel,</span><br><span class="line">    .request_super_buf = mm_camera_intf_request_super_buf,</span><br><span class="line">    .cancel_super_buf_request = mm_camera_intf_cancel_super_buf_request,</span><br><span class="line">    .flush_super_buf_queue = mm_camera_intf_flush_super_buf_queue,</span><br><span class="line">    .configure_notify_mode = mm_camera_intf_configure_notify_mode,</span><br><span class="line">    <span class="comment">//å¤„ç†captureçš„æ–¹æ³•</span></span><br><span class="line">    .process_advanced_capture = mm_camera_intf_process_advanced_capture</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¥ç€åˆ†æmm_camera_openæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/camera/QCamera2/<span class="built_in">stack</span>/mm-camera-interface/src/mm_camera.c]</span><br><span class="line"><span class="keyword">int32_t</span> mm_camera_open(<span class="keyword">mm_camera_obj_t</span> *my_obj)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        n_try--;</span><br><span class="line">        <span class="comment">//æ ¹æ®è®¾å¤‡åå­—ï¼Œæ‰“å¼€ç›¸åº”çš„è®¾å¤‡é©±åŠ¨fd</span></span><br><span class="line">        my_obj-&gt;ctrl_fd = open(dev_name, O_RDWR | O_NONBLOCK);</span><br><span class="line">        <span class="keyword">if</span>((my_obj-&gt;ctrl_fd &gt;= <span class="number">0</span>) || (errno != EIO) || (n_try &lt;= <span class="number">0</span> )) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        usleep(sleep_msec * <span class="number">1000U</span>);</span><br><span class="line">    &#125;<span class="keyword">while</span> (n_try &gt; <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ‰“å¼€domain socket</span></span><br><span class="line">    n_try = MM_CAMERA_DEV_OPEN_TRIES;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        n_try--;</span><br><span class="line">        my_obj-&gt;ds_fd = mm_camera_socket_create(cam_idx, MM_CAMERA_SOCK_TYPE_UDP);</span><br><span class="line">        usleep(sleep_msec * <span class="number">1000U</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (n_try &gt; <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–é”</span></span><br><span class="line">    pthread_mutex_init(&amp;my_obj-&gt;msg_lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_init(&amp;my_obj-&gt;cb_lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_init(&amp;my_obj-&gt;evt_lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;my_obj-&gt;evt_cond, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼€å¯çº¿ç¨‹ï¼Œå®ƒçš„çº¿ç¨‹ä½“åœ¨mm_camera_dispatch_app_eventæ–¹æ³•ä¸­</span></span><br><span class="line">    mm_camera_cmd_thread_launch(&amp;my_obj-&gt;evt_thread,</span><br><span class="line">                                mm_camera_dispatch_app_event,</span><br><span class="line">                                (<span class="keyword">void</span> *)my_obj);</span><br><span class="line">    mm_camera_poll_thread_launch(&amp;my_obj-&gt;evt_poll_thread,</span><br><span class="line">                                 MM_CAMERA_POLL_TYPE_EVT);</span><br><span class="line">    mm_camera_evt_sub(my_obj, TRUE);</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒä¼šæ‰“å¼€Cameraçš„è®¾å¤‡æ–‡ä»¶ï¼Œç„¶åå¼€å¯dispatch_app_eventçº¿ç¨‹ï¼Œçº¿ç¨‹æ–¹æ³•ä½“mm_camera_dispatch_app_eventæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/camera/QCamera2/<span class="built_in">stack</span>/mm-camera-interface/src/mm_camera.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mm_camera_dispatch_app_event</span><span class="params">(<span class="keyword">mm_camera_cmdcb_t</span> *cmd_cb,<span class="keyword">void</span>* user_data)</span></span>&#123;</span><br><span class="line">    mm_camera_cmd_thread_name(<span class="string">"mm_cam_event"</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">mm_camera_event_t</span> *event = &amp;cmd_cb-&gt;u.evt;</span><br><span class="line">    <span class="keyword">mm_camera_obj_t</span> * my_obj = (<span class="keyword">mm_camera_obj_t</span> *)user_data;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != my_obj) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;my_obj-&gt;cb_lock);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MM_CAMERA_EVT_ENTRY_MAX; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(my_obj-&gt;evt.evt[i].evt_cb) &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨camEvtHandleæ–¹æ³•</span></span><br><span class="line">                my_obj-&gt;evt.evt[i].evt_cb(</span><br><span class="line">                    my_obj-&gt;my_hdl,</span><br><span class="line">                    event,</span><br><span class="line">                    my_obj-&gt;evt.evt[i].user_data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pthread_mutex_unlock(&amp;my_obj-&gt;cb_lock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¼šè°ƒç”¨mm-camera-interfaceä¸­æ³¨å†Œå¥½çš„äº‹ä»¶å¤„ç†evt_cbï¼Œå®ƒå°±æ˜¯åœ¨å‰é¢æ³¨å†Œå¥½çš„camEvtHandleï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\HAL3\QCamera3HWI.cpp]</span><br><span class="line"><span class="keyword">void</span> QCamera3HardwareInterface::camEvtHandle(<span class="keyword">uint32_t</span> <span class="comment">/*camera_handle*/</span>,<span class="keyword">mm_camera_event_t</span> *evt,</span><br><span class="line">        <span class="keyword">void</span> *user_data)&#123;</span><br><span class="line">    <span class="comment">//è·å–QCamera3HardwareInterfaceæ¥å£æŒ‡é’ˆ</span></span><br><span class="line">    QCamera3HardwareInterface *obj = (QCamera3HardwareInterface *)user_data;</span><br><span class="line">    <span class="keyword">if</span> (obj &amp;&amp; evt) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(evt-&gt;server_event_type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CAM_EVENT_TYPE_DAEMON_DIED:</span><br><span class="line">                <span class="keyword">camera3_notify_msg_t</span> notify_msg;</span><br><span class="line">                <span class="built_in">memset</span>(&amp;notify_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">camera3_notify_msg_t</span>));</span><br><span class="line">                notify_msg.type = CAMERA3_MSG_ERROR;</span><br><span class="line">                notify_msg.message.error.error_code = CAMERA3_MSG_ERROR_DEVICE;</span><br><span class="line">                notify_msg.message.error.error_stream = <span class="literal">NULL</span>;</span><br><span class="line">                notify_msg.message.error.frame_number = <span class="number">0</span>;</span><br><span class="line">                obj-&gt;mCallbackOps-&gt;notify(obj-&gt;mCallbackOps, &amp;notify_msg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CAM_EVENT_TYPE_DAEMON_PULL_REQ:</span><br><span class="line">                pthread_mutex_lock(&amp;obj-&gt;mMutex);</span><br><span class="line">                obj-&gt;mWokenUpByDaemon = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//å¼€å¯process_capture_request</span></span><br><span class="line">                obj-&gt;unblockRequestIfNecessary();</span><br><span class="line">                pthread_mutex_unlock(&amp;obj-&gt;mMutex);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒä¼šè°ƒç”¨QCamera3HardwareInterfaceçš„unblockRequestIfNecessaryæ¥å‘èµ·ç»“æœå¤„ç†è¯·æ±‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\HAL3\QCamera3HWI.cpp]</span><br><span class="line"><span class="keyword">void</span> QCamera3HardwareInterface::unblockRequestIfNecessary()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Unblock process_capture_request</span></span><br><span class="line">   <span class="comment">//å¼€å¯process_capture_request</span></span><br><span class="line">   pthread_cond_signal(&amp;mRequestCond);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆå§‹åŒ–QCamera3HardwareInterfaceå¯¹è±¡çš„æ—¶å€™ï¼Œå°±ç»‘å®šäº†å¤„ç†Metadataçš„å›è°ƒcaptureResultCbæ–¹æ³•ï¼šå®ƒä¸»è¦æ˜¯å¯¹æ•°æ®æºè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œè€Œå…·ä½“çš„captureè¯·æ±‚çš„ç»“æœå¤„ç†è¿˜æ˜¯ç”±process_capture_requestæ¥è¿›è¡Œå¤„ç†çš„ï¼Œè€Œè¿™é‡Œä¼šè°ƒç”¨æ–¹æ³•unblockRequestIfNecessaryæ¥è§¦å‘process_capture_requestæ–¹æ³•æ‰§è¡Œï¼Œè€Œåœ¨Cameraæ¡†æ¶ä¸­ï¼Œå‘èµ·è¯·æ±‚æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªRequestThreadçº¿ç¨‹ï¼Œåœ¨å®ƒçš„threadLoopæ–¹æ³•ä¸­ï¼Œä¼šä¸åœçš„è°ƒç”¨process_capture_requestæ–¹æ³•æ¥è¿›è¡Œè¯·æ±‚çš„å¤„ç†ï¼Œè€Œå®ƒæœ€åä¼šå›è°ƒCamera3Deviceä¸­çš„processCaptureResultæ–¹æ³•æ¥è¿›è¡Œç»“æœå¤„ç†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp]</span><br><span class="line"><span class="keyword">void</span> Camera3Device::processCaptureResult(<span class="keyword">const</span> camera3_capture_result *result) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (mUsePartialResult &amp;&amp; result-&gt;result != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDeviceVersion &gt;= CAMERA_DEVICE_API_VERSION_3_2) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (isPartialResult) &#123;</span><br><span class="line">                    request.partialResult.collectedResult.append(result-&gt;result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">camera_metadata_ro_entry_t</span> partialResultEntry;</span><br><span class="line">                res = find_camera_metadata_ro_entry(result-&gt;result,</span><br><span class="line">                        ANDROID_QUIRKS_PARTIAL_RESULT, &amp;partialResultEntry);</span><br><span class="line">                <span class="keyword">if</span> (res != NAME_NOT_FOUND &amp;&amp;partialResultEntry.count &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        partialResultEntry.data.u8[<span class="number">0</span>] ==ANDROID_QUIRKS_PARTIAL_RESULT_PARTIAL) &#123;</span><br><span class="line">                    isPartialResult = <span class="literal">true</span>;</span><br><span class="line">                    request.partialResult.collectedResult.append(</span><br><span class="line">                        result-&gt;result);</span><br><span class="line">                    request.partialResult.collectedResult.erase(</span><br><span class="line">                        ANDROID_QUIRKS_PARTIAL_RESULT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isPartialResult) &#123;</span><br><span class="line">                <span class="comment">// Fire off a 3A-only result if possible</span></span><br><span class="line">                <span class="keyword">if</span> (!request.partialResult.haveSent3A) &#123;</span><br><span class="line">                    <span class="comment">//å¤„ç†3Aç»“æœ</span></span><br><span class="line">                    request.partialResult.haveSent3A =processPartial3AResult(frameNumber,</span><br><span class="line">                        request.partialResult.collectedResult,request.resultExtras);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾cameraå…ƒæ•°æ®å…¥å£</span></span><br><span class="line">        <span class="keyword">camera_metadata_ro_entry_t</span> entry;</span><br><span class="line">        res = find_camera_metadata_ro_entry(result-&gt;result,</span><br><span class="line">                ANDROID_SENSOR_TIMESTAMP, &amp;entry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shutterTimestamp == <span class="number">0</span>) &#123;</span><br><span class="line">            request.pendingOutputBuffers.appendArray(result-&gt;output_buffers,</span><br><span class="line">                result-&gt;num_output_buffers);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            é‡è¦çš„åˆ†æ<span class="comment">//è¿”å›å¤„ç†çš„outputbuffer</span></span><br><span class="line">            returnOutputBuffers(result-&gt;output_buffers,</span><br><span class="line">                result-&gt;num_output_buffers, shutterTimestamp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result-&gt;result != <span class="literal">NULL</span> &amp;&amp; !isPartialResult) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shutterTimestamp == <span class="number">0</span>) &#123;</span><br><span class="line">                request.pendingMetadata = result-&gt;result;</span><br><span class="line">                request.partialResult.collectedResult = collectedPartialResult;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                CameraMetadata metadata;</span><br><span class="line">                metadata = result-&gt;result;</span><br><span class="line">                <span class="comment">//å‘é€Captureç»“æ„ï¼Œå³è°ƒç”¨é€šçŸ¥å›è°ƒ</span></span><br><span class="line">                sendCaptureResult(metadata, request.resultExtras,</span><br><span class="line">                    collectedPartialResult, frameNumber, hasInputBufferInRequest,</span><br><span class="line">                    request.aeTriggerCancelOverride);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        removeInFlightRequestIfReadyLocked(idx);</span><br><span class="line">    &#125; <span class="comment">// scope for mInFlightLock</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result-&gt;input_buffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasInputBufferInRequest) &#123;</span><br><span class="line">            Camera3Stream *stream =</span><br><span class="line">                Camera3Stream::cast(result-&gt;input_buffer-&gt;stream);</span><br><span class="line">            é‡è¦çš„åˆ†æ<span class="comment">//è¿”å›å¤„ç†çš„inputbuffer</span></span><br><span class="line">            res = stream-&gt;returnInputBuffer(*(result-&gt;input_buffer));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æreturnOutputBuffersæ–¹æ³•ï¼Œinputbufferçš„runturnInputBufferæ–¹æ³•æµç¨‹ç±»ä¼¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp]</span><br><span class="line"><span class="keyword">void</span> Camera3Device::returnOutputBuffers(<span class="keyword">const</span> <span class="keyword">camera3_stream_buffer_t</span> *outputBuffers, <span class="keyword">size_t</span> </span><br><span class="line">        numBuffers, <span class="keyword">nsecs_t</span> timestamp) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; numBuffers; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Camera3Stream *stream = Camera3Stream::cast(outputBuffers[i].stream);</span><br><span class="line">        <span class="keyword">status_t</span> res = stream-&gt;returnBuffer(outputBuffers[i], timestamp);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•é‡Œè°ƒç”¨äº†returnBufferæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/device3/Camera3Stream.cpp]</span><br><span class="line"><span class="keyword">status_t</span> Camera3Stream::returnBuffer(<span class="keyword">const</span> camera3_stream_buffer &amp;buffer,<span class="keyword">nsecs_t</span> timestamp) &#123;</span><br><span class="line">    <span class="comment">//è¿”å›buffer</span></span><br><span class="line">    <span class="keyword">status_t</span> res = returnBufferLocked(buffer, timestamp);</span><br><span class="line">    <span class="keyword">if</span> (res == OK) &#123;</span><br><span class="line">        fireBufferListenersLocked(buffer, <span class="comment">/*acquired*/</span><span class="literal">false</span>, <span class="comment">/*output*/</span><span class="literal">true</span>);</span><br><span class="line">        mOutputBufferReturnedSignal.signal();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†ç»§ç»­çœ‹returnBufferLocked,å®ƒè°ƒç”¨äº†returnAnyBufferLockedæ–¹æ³•ï¼Œè€ŒreturnAnyBufferLockedæ–¹æ³•åˆè°ƒç”¨äº†returnBufferCheckedLockedæ–¹æ³•ï¼Œç°åœ¨åˆ†æreturnBufferCheckedLockedï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/device3/Camera3OutputStream.cpp]</span><br><span class="line"><span class="keyword">status_t</span> Camera3OutputStream::returnBufferCheckedLocked(<span class="keyword">const</span> camera3_stream_buffer &amp;buffer,</span><br><span class="line">            <span class="keyword">nsecs_t</span> timestamp,<span class="keyword">bool</span> output,<span class="comment">/*out*/</span>sp&lt;Fence&gt; *releaseFenceOut) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Fence management - always honor release fence from HAL</span></span><br><span class="line">    sp&lt;Fence&gt; releaseFence = <span class="keyword">new</span> Fence(buffer.release_fence);</span><br><span class="line">    <span class="keyword">int</span> anwReleaseFence = releaseFence-&gt;dup();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer.status == CAMERA3_BUFFER_STATUS_ERROR) &#123;</span><br><span class="line">        <span class="comment">// Cancel buffer</span></span><br><span class="line">        res = currentConsumer-&gt;cancelBuffer(currentConsumer.get(),</span><br><span class="line">                container_of(buffer.buffer, ANativeWindowBuffer, handle),</span><br><span class="line">                anwReleaseFence);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        res = currentConsumer-&gt;queueBuffer(currentConsumer.get(),</span><br><span class="line">                container_of(buffer.buffer, ANativeWindowBuffer, handle),</span><br><span class="line">                anwReleaseFence);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œå¦‚æœBufferæ²¡æœ‰å‡ºç°çŠ¶æ€é”™è¯¯ï¼Œå®ƒä¼šè°ƒç”¨currentConsumerçš„queueBufferæ–¹æ³•ï¼Œè€Œå…·ä½“çš„Consumeråˆ™æ˜¯åœ¨åº”ç”¨å±‚åˆå§‹åŒ–Cameraæ—¶è¿›è¡Œç»‘å®šçš„ï¼Œå…¸å‹çš„Consumeræœ‰SurfaceTextureï¼ŒImageReaderç­‰ï¼Œè€Œåœ¨Nativeå±‚ä¸­ï¼Œå®ƒä¼šè°ƒç”¨BufferQueueProducerçš„queueBufferæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\libs\gui\BufferQueueProducer.cpp]</span><br><span class="line"><span class="keyword">status_t</span> BufferQueueProducer::queueBuffer(<span class="keyword">int</span> slot,</span><br><span class="line">        <span class="keyword">const</span> QueueBufferInput &amp;input, QueueBufferOutput *output) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–Frameå¯ç”¨çš„ç›‘å¬å™¨</span></span><br><span class="line">    sp&lt;IConsumerListener&gt; frameAvailableListener;</span><br><span class="line">    sp&lt;IConsumerListener&gt; frameReplacedListener;</span><br><span class="line">    <span class="keyword">int</span> callbackTicket = <span class="number">0</span>;</span><br><span class="line">    BufferItem item;</span><br><span class="line">    &#123; <span class="comment">// Autolock scope</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">const</span> sp&lt;GraphicBuffer&gt;&amp; graphicBuffer(mSlots[slot].mGraphicBuffer);</span><br><span class="line">        Rect bufferRect(graphicBuffer-&gt;getWidth(), graphicBuffer-&gt;getHeight());</span><br><span class="line">        Rect croppedRect;</span><br><span class="line">        crop.intersect(bufferRect, &amp;croppedRect);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//å¦‚æœé˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (mCore-&gt;mQueue.empty()) &#123;</span><br><span class="line">            mCore-&gt;mQueue.push_back(item);</span><br><span class="line">            frameAvailableListener = mCore-&gt;mConsumerListener;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œä¸ä¸ºç©ºï¼Œå¯¹Bufferè¿›è¡Œå¤„ç†ï¼Œå¹¶è·å–FrameAvailableListenerç›‘å¬</span></span><br><span class="line">            BufferQueueCore::Fifo::iterator front(mCore-&gt;mQueue.begin());</span><br><span class="line">            <span class="keyword">if</span> (front-&gt;mIsDroppable) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCore-&gt;stillTracking(front)) &#123;</span><br><span class="line">                    mSlots[front-&gt;mSlot].mBufferState = BufferSlot::FREE;</span><br><span class="line">                    mCore-&gt;mFreeBuffers.push_front(front-&gt;mSlot);</span><br><span class="line">                &#125;</span><br><span class="line">                *front = item;</span><br><span class="line">                frameReplacedListener = mCore-&gt;mConsumerListener;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mCore-&gt;mQueue.push_back(item);</span><br><span class="line">                frameAvailableListener = mCore-&gt;mConsumerListener;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCore-&gt;mBufferHasBeenQueued = <span class="literal">true</span>;</span><br><span class="line">        mCore-&gt;mDequeueCondition.broadcast();</span><br><span class="line"></span><br><span class="line">        output-&gt;inflate(mCore-&gt;mDefaultWidth, mCore-&gt;mDefaultHeight,mCore-&gt;mTransformHint,</span><br><span class="line">                <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(mCore-&gt;mQueue.size()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Take a ticket for the callback functions</span></span><br><span class="line">        callbackTicket = mNextCallbackTicket++;</span><br><span class="line"></span><br><span class="line">        mCore-&gt;validateConsistencyLocked();</span><br><span class="line">    &#125; <span class="comment">// Autolock scope</span></span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (frameAvailableListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//å›è°ƒSurfaceTextureä¸­å®šä¹‰å¥½çš„ç›‘å¬IConsumerListenerçš„onFrameAvailableæ–¹æ³•æ¥å¯¹æ•°æ®è¿›è¡Œå¤„ç†</span></span><br><span class="line">            frameAvailableListener-&gt;onFrameAvailable(item);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frameReplacedListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            frameReplacedListener-&gt;onFrameReplaced(item);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ++mCurrentCallbackTicket;</span><br><span class="line">        mCallbackCondition.broadcast();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒæœ€åä¼šè°ƒç”¨Consumerçš„å›è°ƒFrameAvailableListenerçš„onFrameAvailableæ–¹æ³•ï¼Œåˆ°è¿™é‡Œï¼Œå°±æ¯”è¾ƒæ¸…æ™°ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å†™Cameraåº”ç”¨ï¼Œä¸ºå…¶åˆå§‹åŒ–Surfaceæ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™FrameAvailableListeneräº†ï¼Œå› ä¸ºåœ¨æ­¤æ–¹æ³•é‡Œé¢ï¼Œä¼šè¿›è¡Œç»“æœçš„å¤„ç†ï¼Œè‡³æ­¤ï¼ŒCamera HALçš„Openæµç¨‹å°±åˆ†æç»“æŸäº†ã€‚ä¸‹é¢ç»™å‡ºæµç¨‹çš„æ—¶åºå›¾ï¼š </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-15-open_camera.png" alt="Alt text"></p><h4 id="ï¼ˆå››ï¼‰ã€Camera-API2-0-åˆå§‹åŒ–æµç¨‹åˆ†æ"><a href="#ï¼ˆå››ï¼‰ã€Camera-API2-0-åˆå§‹åŒ–æµç¨‹åˆ†æ" class="headerlink" title="ï¼ˆå››ï¼‰ã€Camera API2.0 åˆå§‹åŒ–æµç¨‹åˆ†æ"></a>ï¼ˆå››ï¼‰ã€Camera API2.0 åˆå§‹åŒ–æµç¨‹åˆ†æ</h4><h5 id="4-1ã€Camera2-åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open-è¿‡ç¨‹åˆ†æ"><a href="#4-1ã€Camera2-åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open-è¿‡ç¨‹åˆ†æ" class="headerlink" title="4.1ã€Camera2 åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open()è¿‡ç¨‹åˆ†æ"></a>4.1ã€Camera2 åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open()è¿‡ç¨‹åˆ†æ</h5><p>Camera2çš„åˆå§‹åŒ–æµç¨‹ä¸Camera1.0æœ‰æ‰€åŒºåˆ«ï¼Œæœ¬æ–‡å°†å°±Camera2çš„å†…ç½®åº”ç”¨æ¥åˆ†æCamera2.0çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚Camera2.0é¦–å…ˆå¯åŠ¨çš„æ˜¯CameraActivityï¼Œè€Œå®ƒç»§æ‰¿è‡ªQuickActivityï¼Œåœ¨ä»£ç ä¸­ä½ ä¼šå‘ç°æ²¡æœ‰é‡å†™OnCreateç­‰ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå› ä¸ºæ­¤å¤„é‡‡ç”¨çš„æ˜¯æ¨¡æ¿æ–¹æ³•çš„è®¾è®¡æ¨¡å¼ï¼Œåœ¨QuickActivityä¸­çš„onCreateæ–¹æ³•è°ƒç”¨çš„æ˜¯onCreateTasksç­‰æ–¹æ³•ï¼Œæ‰€ä»¥è¦çœ‹onCreateæ–¹æ³•å°±åªé¡»çœ‹onCreateTasksæ–¹æ³•å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CameraActivity.java]</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreateTasks</span><span class="params">(Bundle state)</span> </span>&#123;</span><br><span class="line">    Profile profile = mProfiler.create(<span class="string">"CameraActivity.onCreateTasks"</span>)</span><br><span class="line">                            .start();</span><br><span class="line">    ...</span><br><span class="line">    mOnCreateTime = System.currentTimeMillis();</span><br><span class="line">    mAppContext = getApplicationContext();</span><br><span class="line">    mMainHandler = <span class="keyword">new</span> MainHandler(<span class="keyword">this</span>, getMainLooper());</span><br><span class="line">    â€¦</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–OneCameraOpenerå¯¹è±¡</span></span><br><span class="line">        â‘ mOneCameraOpener = OneCameraModule.provideOneCameraOpener(</span><br><span class="line">                mFeatureConfig, mAppContext,mActiveCameraDeviceTracker,</span><br><span class="line">                ResolutionUtil.getDisplayMetrics(<span class="keyword">this</span>));</span><br><span class="line">        mOneCameraManager = OneCameraModule.provideOneCameraManager();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OneCameraException e) &#123;...&#125;</span><br><span class="line">    â€¦</span><br><span class="line">    <span class="comment">//å»ºç«‹æ¨¡å—ä¿¡æ¯</span></span><br><span class="line">    â‘¡ModulesInfo.setupModules(mAppContext, mModuleManager, mFeatureConfig);</span><br><span class="line">    â€¦</span><br><span class="line">    <span class="comment">//è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">    â‘¢mCurrentModule.init(<span class="keyword">this</span>, isSecureCamera(), isCaptureIntent());</span><br><span class="line">    â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä»£ç æ‰€ç¤ºï¼Œé‡è¦çš„æœ‰ä»¥ä¸Šä¸‰ç‚¹ï¼Œå…ˆçœ‹ç¬¬ä¸€ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/OneCameraModule.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OneCameraOpener <span class="title">provideOneCameraOpener</span><span class="params">(OneCameraFeatureConfig     </span></span></span><br><span class="line"><span class="function"><span class="params">            featureConfig, Context context, ActiveCameraDeviceTracker </span></span></span><br><span class="line"><span class="function"><span class="params">            activeCameraDeviceTracker,DisplayMetrics displayMetrics)</span> </span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> OneCameraException </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºOneCameraOpenerå¯¹è±¡</span></span><br><span class="line">    Optional&lt;OneCameraOpener&gt; manager = Camera2OneCameraOpenerImpl.create(</span><br><span class="line">              featureConfig, context, activeCameraDeviceTracker, displayMetrics);</span><br><span class="line">    <span class="keyword">if</span> (!manager.isPresent()) &#123;</span><br><span class="line">        manager = LegacyOneCameraOpenerImpl.create();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> manager.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒè°ƒç”¨Camera2OneCameraOpenerImplçš„createæ–¹æ³•æ¥è·å¾—ä¸€ä¸ªOneCameraOpenerå¯¹è±¡ï¼Œä»¥ä¾›CameraActivityä¹‹åçš„æ“ä½œä½¿ç”¨ï¼Œç»§ç»­çœ‹createæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/OneCameraModule.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Optional&lt;OneCameraOpener&gt; <span class="title">create</span><span class="params">(OneCameraFeatureConfig </span></span></span><br><span class="line"><span class="function"><span class="params">            featureConfig, Context context, ActiveCameraDeviceTracker </span></span></span><br><span class="line"><span class="function"><span class="params">            activeCameraDeviceTracker, DisplayMetrics displayMetrics)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    CameraManager cameraManager;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cameraManager = AndroidServices.instance().provideCameraManager();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException ex) &#123;...&#125;</span><br><span class="line">    <span class="comment">//æ–°å»ºä¸€ä¸ªCamera2OneCameraOpenerImplå¯¹è±¡</span></span><br><span class="line">    OneCameraOpener oneCameraOpener = <span class="keyword">new</span> Camera2OneCameraOpenerImpl(</span><br><span class="line">                featureConfig, context, cameraManager,</span><br><span class="line">                activeCameraDeviceTracker, displayMetrics);</span><br><span class="line">    <span class="keyword">return</span> Optional.of(oneCameraOpener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œå®ƒé¦–å…ˆè·å–ä¸€ä¸ªcameraMangerå¯¹è±¡ï¼Œç„¶åæ ¹æ®è¿™ä¸ªcameraManagerå¯¹è±¡æ¥æ–°åˆ›å»ºäº†ä¸€ä¸ªCamera2OneCameraOpenerImplå¯¹è±¡ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥ä¸»è¦æ˜¯ä¸ºäº†è·å–ä¸€ä¸ªOneCameraOpenerå¯¹è±¡ï¼Œå®ƒçš„å®ç°ä¸ºCamera2OneCameraOpenerImplç±»ã€‚<br>ç»§ç»­çœ‹ç¬¬äºŒæ­¥ï¼ŒModulesInfo.setupModules:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/<span class="keyword">module</span>/ModulesInfo.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupModules</span><span class="params">(Context context, ModuleManager moduleManager,</span></span></span><br><span class="line"><span class="function"><span class="params">            OneCameraFeatureConfig config)</span> </span>&#123;</span><br><span class="line">        Resources res = context.getResources();</span><br><span class="line">        <span class="keyword">int</span> photoModuleId = context.getResources().getInteger(</span><br><span class="line">            R.integer.camera_mode_photo);</span><br><span class="line">        <span class="comment">//æ³¨å†ŒPhotoæ¨¡å—</span></span><br><span class="line">        registerPhotoModule(moduleManager, photoModuleId, </span><br><span class="line">            SettingsScopeNamespaces.PHOTO,config.isUsingCaptureModule());</span><br><span class="line">        <span class="comment">//è®¡ç®—ä½ è¿˜Photoæ¨¡å—è®¾ç½®ä¸ºé»˜è®¤çš„æ¨¡å—</span></span><br><span class="line">        moduleManager.setDefaultModuleIndex(photoModuleId);</span><br><span class="line">        <span class="comment">//æ³¨å†ŒVideaæ¨¡å—</span></span><br><span class="line">        registerVideoModule(moduleManager, res.getInteger(</span><br><span class="line">            R.integer.camera_mode_video),SettingsScopeNamespaces.VIDEO);</span><br><span class="line">        <span class="keyword">if</span> (PhotoSphereHelper.hasLightCycleCapture(context)) &#123;<span class="comment">//å¼€å¯é—ªå…‰</span></span><br><span class="line">            <span class="comment">//æ³¨å†Œå¹¿è§’é•œå¤´</span></span><br><span class="line">            registerWideAngleModule(moduleManager, res.getInteger(</span><br><span class="line">                R.integer.camera_mode_panorama),SettingsScopeNamespaces</span><br><span class="line">                .PANORAMA);</span><br><span class="line">            <span class="comment">//æ³¨å†Œå…‰çƒæ¨¡å—</span></span><br><span class="line">            registerPhotoSphereModule(moduleManager,res.getInteger(</span><br><span class="line">                R.integer.camera_mode_photosphere),</span><br><span class="line">                SettingsScopeNamespaces.PANORAMA);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è‹¥éœ€é‡æ–°èšç„¦</span></span><br><span class="line">        <span class="keyword">if</span> (RefocusHelper.hasRefocusCapture(context)) &#123;</span><br><span class="line">            <span class="comment">//æ³¨å†Œé‡èšç„¦æ¨¡å—</span></span><br><span class="line">            registerRefocusModule(moduleManager, res.getInteger(</span><br><span class="line">                R.integer.camera_mode_refocus),</span><br><span class="line">                SettingsScopeNamespaces.REFOCUS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæœ‰è‰²åˆ†ç¦»æ¨¡å—</span></span><br><span class="line">        <span class="keyword">if</span> (GcamHelper.hasGcamAsSeparateModule(config)) &#123;</span><br><span class="line">            <span class="comment">//æ³¨å†Œè‰²åˆ†ç¦»æ¨¡å—</span></span><br><span class="line">            registerGcamModule(moduleManager, res.getInteger(</span><br><span class="line">                R.integer.camera_mode_gcam),SettingsScopeNamespaces.PHOTO,</span><br><span class="line">                config.getHdrPlusSupportLevel(OneCamera.Facing.BACK));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> imageCaptureIntentModuleId = res.getInteger(</span><br><span class="line">            R.integer.camera_mode_capture_intent);</span><br><span class="line">        registerCaptureIntentModule(moduleManager, </span><br><span class="line">            imageCaptureIntentModuleId,SettingsScopeNamespaces.PHOTO,</span><br><span class="line">            config.isUsingCaptureModule());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç æ ¹æ®é…ç½®ä¿¡æ¯ï¼Œè¿›è¡Œä¸€ç³»åˆ—æ¨¡å—çš„æ³¨å†Œï¼Œå…¶ä¸­PhotoModuleå’ŒVideoModuleè¢«æ³¨å†Œï¼Œè€Œå…¶ä»–çš„moduleåˆ™æ˜¯æ ¹æ®é…ç½®æ¥è¿›è¡Œçš„ï¼Œå› ä¸ºæ‰“å¼€Cameraåº”ç”¨ï¼Œæ—¢å¯ä»¥æ‹ç…§ç‰‡ä¹Ÿå¯ä»¥æ‹è§†é¢‘ï¼Œæ­¤å¤„ï¼Œåªåˆ†æPhoneModuleçš„æ³¨å†Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/<span class="keyword">module</span>/ModulesInfo.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerPhotoModule</span><span class="params">(ModuleManager moduleManager, final </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> moduleId, final String <span class="keyword">namespace</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">            final boolean enableCaptureModule)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å‘ModuleManageræ³¨å†ŒPhotoModuleæ¨¡å—</span></span><br><span class="line">        moduleManager.registerModule(<span class="keyword">new</span> ModuleManager.ModuleAgent() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> getModuleId() &#123;</span><br><span class="line">                <span class="keyword">return</span> moduleId;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> boolean requestAppForCamera() &#123;</span><br><span class="line">                <span class="keyword">return</span> !enableCaptureModule;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> String getScopeNamespace() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">namespace</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> ModuleController createModule(AppController app, Intent </span><br><span class="line">                    intent) &#123;</span><br><span class="line">                Log.v(TAG, <span class="string">"EnableCaptureModule = "</span> + enableCaptureModule);</span><br><span class="line">                <span class="comment">//åˆ›å»ºModuleController</span></span><br><span class="line">                <span class="keyword">return</span> enableCaptureModule ? <span class="keyword">new</span> CaptureModule(app) </span><br><span class="line">                        : <span class="keyword">new</span> PhotoModule(app);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒæœ€ç»ˆæ˜¯ç”±ModuleManageræ¥æ–°å»ºä¸€ä¸ªCaptureModuleå®ä¾‹ï¼Œè€ŒCaptureModuleå…¶å®å®ç°äº†ModuleController ï¼Œå³åˆ›å»ºäº†ä¸€ä¸ªCaptureModuleæ¨¡å¼ä¸‹çš„ModuleControllerå¯¹è±¡ï¼Œè€ŒçœŸæ­£çš„CaptureModuleçš„å…·ä½“å®ç°ä¸ºModuleManagerImplã€‚<br>è‡³æ­¤ï¼Œå‰ä¸¤æ­¥å·²ç»è·å¾—äº†OneCameraOpenerä»¥åŠæ–°å»ºäº†ModuleControllerï¼Œå¹¶è¿›è¡Œäº†æ³¨å†Œï¼Œæ¥ä¸‹æ¥åˆ†æç¬¬ä¸‰æ­¥ï¼ŒmCurrentModule.init(this, isSecureCamera(), isCaptureIntent()):</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(CameraActivity activity, <span class="keyword">boolean</span> isSecureCamera, <span class="keyword">boolean</span> </span></span></span><br><span class="line"><span class="function"><span class="params">            isCaptureIntent)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"CaptureModule.mCameraHandler"</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">        mCameraHandler = <span class="keyword">new</span> Handler(thread.getLooper());</span><br><span class="line">        <span class="comment">//è·å–ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„OneCameraOpenerå¯¹è±¡</span></span><br><span class="line">        mOneCameraOpener = mAppController.getCameraOpener();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–å‰é¢åˆ›å»ºçš„OneCameraManagerå¯¹è±¡</span></span><br><span class="line">            mOneCameraManager = OneCameraModule.provideOneCameraManager();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OneCameraException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Unable to provide a OneCameraManager. "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">       `...</span><br><span class="line">        <span class="comment">//æ–°å»ºCaptureModuleçš„UI</span></span><br><span class="line">        mUI = <span class="keyword">new</span> CaptureModuleUI(activity, mAppController.</span><br><span class="line">                getModuleLayoutRoot(), mUIListener);</span><br><span class="line">        <span class="comment">//è®¾ç½®é¢„è§ˆçŠ¶æ€çš„ç›‘å¬</span></span><br><span class="line">        mAppController.setPreviewStatusListener(mPreviewStatusListener);</span><br><span class="line">        <span class="keyword">synchronized</span> (mSurfaceTextureLock) &#123;</span><br><span class="line">            <span class="comment">//è·å–SurfaceTexture</span></span><br><span class="line">            mPreviewSurfaceTexture = mAppController.getCameraAppUI()</span><br><span class="line">                .getSurfaceTexture();</span><br><span class="line">        &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–å‰é¢åˆ›å»ºçš„OneCameraOpenerå¯¹è±¡ä»¥åŠOneCameraManagerå¯¹è±¡ï¼Œç„¶åå†è®¾ç½®é¢„è§ˆçŠ¶æ€ç›‘å¬ï¼Œè¿™é‡Œä¸»è¦åˆ†æé¢„è§ˆçŠ¶æ€çš„ç›‘å¬ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PreviewStatusListener mPreviewStatusListener = <span class="keyword">new</span> </span><br><span class="line">    PreviewStatusListener() &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureAvailable</span><span class="params">(SurfaceTexture surface, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">            updatePreviewTransform(width, height, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (mSurfaceTextureLock) &#123;</span><br><span class="line">                mPreviewSurfaceTexture = surface;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ‰“å¼€Camera</span></span><br><span class="line">            reopenCamera();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSurfaceTextureDestroyed</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"onSurfaceTextureDestroyed"</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (mSurfaceTextureLock) &#123;</span><br><span class="line">                mPreviewSurfaceTexture = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å…³é—­Camera</span></span><br><span class="line">            closeCamera();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureSizeChanged</span><span class="params">(SurfaceTexture surface, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//æ›´æ–°é¢„è§ˆå°ºå¯¸</span></span><br><span class="line">            updatePreviewBufferSize();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">``` </span><br><span class="line">ç”±ä»£ç å¯çŸ¥ï¼Œå½“SurfaceTextureçš„çŠ¶æ€å˜æˆå¯ç”¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨reopenCamera()æ–¹æ³•æ¥æ‰“å¼€Cameraï¼Œæ‰€ä»¥ç»§ç»­åˆ†æreopenCamera()æ–¹æ³•ï¼š</span><br><span class="line">``` java</span><br><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reopenCamera</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPaused) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    AsyncTask.THREAD_POOL_EXECUTOR.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            closeCamera();</span><br><span class="line">            <span class="keyword">if</span>(!mAppController.isPaused()) &#123;</span><br><span class="line">                <span class="comment">//å¼€å¯Cameraå¹¶å¼€å§‹é¢„è§ˆ</span></span><br><span class="line">                openCameraAndStartPreview();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line">å®ƒé‡‡ç”¨å¼‚æ­¥ä»»åŠ¡çš„æ–¹æ³•ï¼Œå¼€å¯ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ¥è¿›è¡Œå¯åŠ¨æ“ä½œï¼Œé¦–å…ˆå…³é—­æ‰“å¼€çš„Cameraï¼Œç„¶åå¦‚æœAppControllerä¸å¤„äºæš‚åœçŠ¶æ€ï¼Œåˆ™æ‰“å¼€Cameraå¹¶å¯åŠ¨Previewæ“ä½œï¼Œæ‰€ä»¥ç»§ç»­åˆ†æopenCameraAndStartPreviewæ–¹æ³•ï¼š</span><br><span class="line">``` java</span><br><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openCameraAndStartPreview</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mOneCameraOpener == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"no available OneCameraManager, showing error dialog"</span>);</span><br><span class="line">        <span class="comment">//é‡Šæ”¾CameraOpenCloseLocké”</span></span><br><span class="line">        mCameraOpenCloseLock.release();</span><br><span class="line">        mAppController.getFatalErrorHandler().onGenericCameraAccessFailure();</span><br><span class="line">        guard.stop(<span class="string">"No OneCameraManager"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Derive objects necessary for camera creation.</span></span><br><span class="line">    MainThread mainThread = MainThread.create();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŸ¥æ‰¾éœ€è¦æ‰“å¼€çš„CameraId</span></span><br><span class="line">    CameraId cameraId = mOneCameraManager.findFirstCameraFacing(</span><br><span class="line">        mCameraFacing);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ‰“å¼€Camera</span></span><br><span class="line">    mOneCameraOpener.open(cameraId, captureSetting, mCameraHandler,</span><br><span class="line">        mainThread, imageRotationCalculator, mBurstController, </span><br><span class="line">        mSoundPlayer,<span class="keyword">new</span> OpenCallback() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//è¿›è¡Œå¤±è´¥çš„å¤„ç†</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCameraClosed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCameraOpened</span><span class="params">(@Nonnull <span class="keyword">final</span> OneCamera camera)</span> </span>&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"onCameraOpened: "</span> + camera);</span><br><span class="line">                mCamera = camera;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mAppController.isPaused()) &#123;</span><br><span class="line">                    onFailure();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">                mMainThread.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//é€šçŸ¥UIï¼ŒCameraçŠ¶æ€å˜åŒ–</span></span><br><span class="line">                        mAppController.getCameraAppUI().onChangeCamera();</span><br><span class="line">                        <span class="comment">//ä½¿èƒ½æ‹ç…§æŒ‰é’®</span></span><br><span class="line">                        mAppController.getButtonManager().enableCameraButton();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">//è‡³æ­¤ï¼ŒCameraæ‰“å¼€æˆåŠŸï¼Œå¼€å§‹é¢„è§ˆ                    </span></span><br><span class="line">                camera.startPreview(<span class="keyword">new</span> Surface(getPreviewSurfaceTexture()), </span><br><span class="line">                    <span class="keyword">new</span> CaptureReadyCallback() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSetupFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            ...</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReadyForCapture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">                            mCameraOpenCloseLock.release();</span><br><span class="line">                            mMainThread.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    ...</span><br><span class="line">                                    onPreviewStarted();</span><br><span class="line">                                    ...</span><br><span class="line">                                    onReadyStateChanged(<span class="keyword">true</span>);</span><br><span class="line">                                    <span class="comment">//è®¾ç½®CaptureModuleä¸ºCaptureå‡†å¤‡çš„çŠ¶æ€ç›‘å¬</span></span><br><span class="line">                                    mCamera.setReadyStateChangedListener(</span><br><span class="line">                                        CaptureModule.<span class="keyword">this</span>);</span><br><span class="line">                                        mUI.initializeZoom(mCamera.getMaxZoom());                                 </span><br><span class="line">                                        mCamera.setFocusStateListener(</span><br><span class="line">                                            CaptureModule.<span class="keyword">this</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125; </span><br><span class="line">              &#125;, mAppController.getFatalErrorHandler());</span><br><span class="line">        guard.stop(<span class="string">"mOneCameraOpener.open()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">é¦–å…ˆï¼Œå®ƒä¸»è¦ä¼šè°ƒç”¨Camera2OneCameraOpenerImplçš„openæ–¹æ³•æ¥æ‰“å¼€Cameraï¼Œå¹¶å®šä¹‰äº†å¼€å¯çš„å›è°ƒå‡½æ•°ï¼Œå¯¹å¼€å¯ç»“æŸåçš„ç»“æœè¿›è¡Œå¤„ç†ï¼Œå¦‚å¤±è´¥åˆ™é‡Šæ”¾mCameraOpenCloseLockï¼Œå¹¶æš‚åœmAppControllerï¼Œå¦‚æœæ‰“å¼€æˆåŠŸï¼Œé€šçŸ¥UIæˆåŠŸï¼Œå¹¶å¼€å¯Cameraçš„Previewï¼Œå¹¶ä¸”å®šä¹‰äº†Previewçš„å„ç§å›è°ƒæ“ä½œï¼Œè¿™é‡Œä¸»è¦åˆ†æOpenè¿‡ç¨‹ï¼Œæ‰€ä»¥ç»§ç»­åˆ†æï¼š</span><br><span class="line"></span><br><span class="line">``` java</span><br><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/Camera2OneCameraOpenerImpl.java]</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ...</span></span></span><br><span class="line"><span class="function"><span class="params">    mActiveCameraDeviceTracker.onCameraOpening(cameraKey)</span></span>;</span><br><span class="line">    <span class="comment">//æ‰“å¼€Cameraï¼Œæ­¤å¤„è°ƒç”¨æ¡†æ¶å±‚çš„CameraManagerç±»çš„openCameraï¼Œè¿›å…¥frameworkså±‚</span></span><br><span class="line">    mCameraManager.openCamera(cameraKey.getValue(), </span><br><span class="line">        <span class="keyword">new</span> CameraDevice.StateCallback() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstCallback = <span class="keyword">true</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpened</span><span class="params">(CameraDevice device)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//ç¬¬ä¸€æ¬¡è°ƒç”¨æ­¤å›è°ƒ</span></span><br><span class="line">            <span class="keyword">if</span> (isFirstCallback) &#123;</span><br><span class="line">                isFirstCallback = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    CameraCharacteristics characteristics = mCameraManager</span><br><span class="line">                        .getCameraCharacteristics(device.getId());</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">//åˆ›å»ºOneCameraå¯¹è±¡</span></span><br><span class="line">                    OneCamera oneCamera = OneCameraCreator.create(device,</span><br><span class="line">                        characteristics, mFeatureConfig, captureSetting,</span><br><span class="line">                        mDisplayMetrics, mContext, mainThread,</span><br><span class="line">                        imageRotationCalculator, burstController, soundPlayer,</span><br><span class="line">                        fatalErrorHandler);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (oneCamera != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœoneCameraä¸ä¸ºç©ºï¼Œåˆ™å›è°ƒonCameraOpenedï¼Œåé¢å°†åšåˆ†æ</span></span><br><span class="line">                        openCallback.onCameraOpened(oneCamera);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ...</span><br><span class="line">                        openCallback.onFailure();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">                    openCallback.onFailure();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (OneCameraAccessException e) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"Could not create OneCamera"</span>, e);</span><br><span class="line">                    openCallback.onFailure();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, handler);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è‡³æ­¤ï¼ŒCameraçš„åˆå§‹åŒ–æµç¨‹ä¸­åº”ç”¨å±‚çš„åˆ†æå°±å·®ä¸å¤šäº†ï¼Œä¸‹ä¸€æ­¥å°†ä¼šè°ƒç”¨CameraManagerçš„openCameraæ–¹æ³•æ¥è¿›å…¥æ¡†æ¶å±‚ï¼Œå¹¶è¿›è¡ŒCameraçš„åˆå§‹åŒ–ï¼Œä¸‹é¢å°†åº”ç”¨å±‚çš„åˆå§‹åŒ–æ—¶åºå›¾ï¼š </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-16-camera_open_java.png" alt="Alt text"></p><h5 id="4-2ã€Camera2-æ¡†æ¶å±‚ï¼ˆJNI-amp-Nativeï¼‰Open-è¿‡ç¨‹åˆ†æ"><a href="#4-2ã€Camera2-æ¡†æ¶å±‚ï¼ˆJNI-amp-Nativeï¼‰Open-è¿‡ç¨‹åˆ†æ" class="headerlink" title="4.2ã€Camera2 æ¡†æ¶å±‚ï¼ˆJNI &amp; Nativeï¼‰Open()è¿‡ç¨‹åˆ†æ"></a>4.2ã€Camera2 æ¡†æ¶å±‚ï¼ˆJNI &amp; Nativeï¼‰Open()è¿‡ç¨‹åˆ†æ</h5><p>ç”±ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œå°†ç”±åº”ç”¨å±‚è¿›å…¥åˆ°æ¡†æ¶å±‚å¤„ç†ï¼Œå°†ä¼šè°ƒç”¨CameraManagerçš„openCameraæ–¹æ³•ï¼Œå¹¶ä¸”å®šä¹‰äº†CameraDeviceçš„çŠ¶æ€å›è°ƒå‡½æ•°ï¼Œå…·ä½“çš„å›è°ƒæ“ä½œæ­¤å¤„ä¸åšåˆ†æï¼Œç»§ç»­è·Ÿè¸ªopenCamera()æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CameraManager.java(frameworks/base/core/java/android/hardware/camera2)</span></span><br><span class="line">@RequiresPermission(android.Manifest.permission.CAMERA)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCamera</span><span class="params">(@NonNull String cameraId,@NonNull final </span></span></span><br><span class="line"><span class="function"><span class="params">        CameraDevice.StateCallback callback, @Nullable Handler handler)</span></span></span><br><span class="line"><span class="function">        throws CameraAccessException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    openCameraDeviceUserAsync(cameraId, callback, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œæ­¤å¤„ä¸Camera1.0æœ‰æ˜æ˜¾ä¸åŒï¼ŒCamera1.0æ˜¯é€šè¿‡ä¸€ä¸ªå¼‚æ­¥çš„çº¿ç¨‹ä»¥åŠJNIæ¥è°ƒç”¨android_hardware_camera.javaé‡Œé¢çš„native_setupæ–¹æ³•æ¥è¿æ¥Cameraï¼Œå…¶ä½¿ç”¨çš„æ˜¯C++çš„Binderæ¥ä¸CameraServiceè¿›è¡Œé€šä¿¡çš„ï¼Œè€Œæ­¤å¤„åˆ™ä¸ä¸€æ ·ï¼Œå®ƒç›´æ¥ä½¿ç”¨çš„æ˜¯Javaå±‚çš„Binderæ¥è¿›è¡Œé€šä¿¡ï¼Œå…ˆçœ‹openCameraDeviceUserAsyncä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CameraManager.java(frameworks/base/core/java/android/hardware/camera2)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> CameraDevice <span class="title">openCameraDeviceUserAsync</span><span class="params">(String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        CameraDevice.StateCallback callback, Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    CameraCharacteristics characteristics = getCameraCharacteristics(</span><br><span class="line">        cameraId);</span><br><span class="line">    CameraDevice device = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            ICameraDeviceUser cameraUser = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªCameraDeviceå¯¹è±¡</span></span><br><span class="line">            android.hardware.camera2.impl.CameraDeviceImpl deviceImpl =</span><br><span class="line">                <span class="keyword">new</span> android.hardware.camera2.impl.CameraDeviceImpl(cameraId,</span><br><span class="line">                callback, handler, characteristics);</span><br><span class="line">            BinderHolder holder = <span class="keyword">new</span> BinderHolder();</span><br><span class="line">            <span class="comment">//è·å–å›è°ƒ</span></span><br><span class="line">            ICameraDeviceCallbacks callbacks = deviceImpl.getCallbacks();</span><br><span class="line">            <span class="keyword">int</span> id = Integer.parseInt(cameraId);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (supportsCamera2ApiLocked(cameraId)) &#123;</span><br><span class="line">                    <span class="comment">//é€šè¿‡Javaå±‚çš„Binderè·å–CameraService                        </span></span><br><span class="line">                    ICameraService cameraService = CameraManagerGlobal.get()</span><br><span class="line">                        .getCameraService();</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">//é€šè¿‡CameraServiceè¿æ¥Cameraè®¾å¤‡</span></span><br><span class="line">                    cameraService.connectDevice(callbacks, id, mContext</span><br><span class="line">                        .getOpPackageName(), USE_CALLING_UID, holder);</span><br><span class="line">                    <span class="comment">//è·å–è¿æ¥æˆåŠŸçš„CameraUserå¯¹è±¡ï¼Œå®ƒç”¨æ¥ä¸CameraServiceé€šä¿¡</span></span><br><span class="line">                    cameraUser = ICameraDeviceUser.Stub.asInterface(</span><br><span class="line">                        holder.getBinder());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//ä½¿ç”¨é—ç•™çš„API</span></span><br><span class="line">                    cameraUser = CameraDeviceUserShim.connectBinderShim(</span><br><span class="line">                        callbacks, id);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CameraRuntimeException e) &#123;</span><br><span class="line">                ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//å°†å…¶åŒ…è£…æˆDeviceImplå¯¹è±¡ï¼Œä¾›åº”ç”¨å±‚ä½¿ç”¨</span></span><br><span class="line">            deviceImpl.setRemoteDevice(cameraUser);</span><br><span class="line">            device = deviceImpl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CameraRuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.asChecked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> device;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•çš„ç›®çš„æ˜¯é€šè¿‡CameraServiceæ¥è¿æ¥å¹¶è·å–CameraDeviceå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨æ¥ä¸Cameraè¿›è¡Œé€šä¿¡æ“ä½œã€‚ä»£ç é¦–å…ˆé€šè¿‡Javaå±‚çš„Binderæœºåˆ¶è·å–CameraServiceï¼Œç„¶åè°ƒç”¨å…¶connectDeviceæ–¹æ³•æ¥è¿æ¥CaneraDeviceï¼Œæœ€åCameraè¿”å›çš„æ˜¯CameraDeviceUserå¯¹è±¡ï¼Œè€Œæ¥ç€å°†å…¶å°è£…æˆJavå±‚CameraDeviceå¯¹è±¡ï¼Œè€Œä¹‹åæ‰€æœ‰ä¸Cameraçš„é€šä¿¡éƒ½é€šè¿‡CameraDeviceçš„æ¥å£æ¥è¿›è¡Œã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹Nativeå±‚ä¸‹çš„CameraDeviceçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\CameraService.cpp]</span><br><span class="line"><span class="comment">//CameraService.cppï¼Œå…¶ä¸­deviceä¸ºè¾“å‡ºå¯¹è±¡</span></span><br><span class="line"><span class="keyword">status_t</span> CameraService::connectDevice(<span class="keyword">const</span> sp&lt;ICameraDeviceCallbacks&gt;&amp; cameraCb,<span class="keyword">int</span> cameraId,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,<span class="keyword">int</span> clientUid,<span class="comment">/*out*/</span>sp&lt;ICameraDeviceUser&gt;&amp; device) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> ret = NO_ERROR;</span><br><span class="line">    String8 id = String8::format(<span class="string">"%d"</span>, cameraId);</span><br><span class="line">    sp&lt;CameraDeviceClient&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    ret = connectHelper&lt;ICameraDeviceCallbacks,CameraDeviceClient&gt;(cameraCb, id,</span><br><span class="line">            CAMERA_HAL_API_VERSION_UNSPECIFIED, clientPackageName, clientUid, API_2, <span class="literal">false</span>, <span class="literal">false</span>,</span><br><span class="line">            <span class="comment">/*out*/</span>client);<span class="comment">//clientä¸ºè¾“å‡ºå¯¹è±¡</span></span><br><span class="line">    ...</span><br><span class="line">    device = client;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Nativeå±‚çš„connectDeviceæ–¹æ³•å°±æ˜¯è°ƒç”¨äº†connectHelperæ–¹æ³•ï¼Œæ‰€ä»¥ç»§ç»­åˆ†æconnectHelperï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\CameraService.h]</span><br><span class="line"><span class="comment">//CameraService.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">CALLBACK</span>, <span class="title">class</span> <span class="title">CLIENT</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">CameraService</span>:</span>:connectHelper(<span class="keyword">const</span> sp&lt;CALLBACK&gt;&amp; cameraCb, <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> halVersion, <span class="keyword">const</span> String16&amp; clientPackageName, <span class="keyword">int</span> clientUid,</span><br><span class="line">        apiLevel effectiveApiLevel, <span class="keyword">bool</span> legacyMode, <span class="keyword">bool</span> shimUpdateOnly,</span><br><span class="line">        <span class="comment">/*out*/</span>sp&lt;CLIENT&gt;&amp; device) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> ret = NO_ERROR;</span><br><span class="line">    <span class="function">String8 <span class="title">clientName8</span><span class="params">(clientPackageName)</span></span>;</span><br><span class="line">    <span class="keyword">int</span> clientPid = getCallingPid();</span><br><span class="line">    ...</span><br><span class="line">    sp&lt;CLIENT&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœæœ‰å¿…è¦ï¼Œç»™FlashLightå…³é—­è®¾å¤‡çš„æœºä¼š</span></span><br><span class="line">        mFlashlight-&gt;prepareDeviceOpen(cameraId);</span><br><span class="line">        <span class="comment">//è·å–CameraId</span></span><br><span class="line">        <span class="keyword">int</span> id = cameraIdToInt(cameraId);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//è·å–Deviceçš„ç‰ˆæœ¬ï¼Œæ­¤å¤„ä¸ºDevice3</span></span><br><span class="line">        <span class="keyword">int</span> deviceVersion = getDeviceVersion(id, <span class="comment">/*out*/</span>&amp;facing);</span><br><span class="line">        sp&lt;BasicClient&gt; tmp = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">//è·å–clientå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span>((ret = makeClient(<span class="keyword">this</span>, cameraCb, clientPackageName, cameraId, facing, clientPid,</span><br><span class="line">                clientUid, getpid(), legacyMode, halVersion, deviceVersion, effectiveApiLevel,</span><br><span class="line">                <span class="comment">/*out*/</span>&amp;tmp)) != NO_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        client = <span class="keyword">static_cast</span>&lt;CLIENT*&gt;(tmp.get());</span><br><span class="line">        <span class="comment">//è°ƒç”¨clientçš„åˆå§‹åŒ–å‡½æ•°æ¥åˆå§‹åŒ–æ¨¡å—</span></span><br><span class="line">        <span class="keyword">if</span> ((ret = client-&gt;initialize(mModule)) != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Could not initialize client from HAL module."</span>, __FUNCTION__);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sp&lt;IBinder&gt; remoteCallback = client-&gt;getRemote();</span><br><span class="line">        <span class="keyword">if</span> (remoteCallback != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            remoteCallback-&gt;linkToDeath(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// lock is destroyed, allow further connect calls</span></span><br><span class="line">    <span class="comment">//å°†clientèµ‹å€¼ç»™è¾“å‡ºDevice</span></span><br><span class="line">    device = client;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CameraServiceæ ¹æ®Cameraçš„ç›¸å…³å‚æ•°æ¥è·å–ä¸€ä¸ªclientï¼Œå¦‚makeClientæ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨clientçš„initializeæ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œé¦–å…ˆçœ‹makeClientï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\CameraService.cpp]</span><br><span class="line"><span class="comment">//CameraService.cppï¼Œå…¶ä¸­deviceä¸ºè¾“å‡ºå¯¹è±¡</span></span><br><span class="line"><span class="keyword">status_t</span> CameraService::makeClient(<span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IInterface&gt;&amp; cameraCb, <span class="keyword">const</span> String16&amp; packageName, <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> facing, <span class="keyword">int</span> clientPid, <span class="keyword">uid_t</span> clientUid, <span class="keyword">int</span> servicePid, <span class="keyword">bool</span> legacyMode,</span><br><span class="line">        <span class="keyword">int</span> halVersion, <span class="keyword">int</span> deviceVersion, apiLevel effectiveApiLevel,</span><br><span class="line">        <span class="comment">/*out*/</span>sp&lt;BasicClient&gt;* client) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å­—ç¬¦ä¸²çš„CameraIdè½¬æ¢æˆæ•´å½¢</span></span><br><span class="line">    <span class="keyword">int</span> id = cameraIdToInt(cameraId);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (halVersion &lt; <span class="number">0</span> || halVersion == deviceVersion) &#123;<span class="comment">//åˆ¤æ–­Camera HALç‰ˆæœ¬æ˜¯å¦å’ŒDeviceçš„ç‰ˆæœ¬ç›¸åŒ</span></span><br><span class="line">        <span class="keyword">switch</span>(deviceVersion) &#123;</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_1_0:</span><br><span class="line">            <span class="keyword">if</span> (effectiveApiLevel == API_1) &#123;  <span class="comment">// Camera1 API route</span></span><br><span class="line">                sp&lt;ICameraClient&gt; tmp = <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> CameraClient(cameraService, tmp, packageName, id, facing,</span><br><span class="line">                        clientPid, clientUid, getpid(), legacyMode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Camera2 API route</span></span><br><span class="line">                ALOGW(<span class="string">"Camera using old HAL version: %d"</span>, deviceVersion);</span><br><span class="line">                <span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_2_0:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_2_1:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_0:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_1:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_2:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_3:</span><br><span class="line">            <span class="keyword">if</span> (effectiveApiLevel == API_1) &#123; <span class="comment">// Camera1 API route</span></span><br><span class="line">                sp&lt;ICameraClient&gt; tmp = <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> Camera2Client(cameraService, tmp, packageName, id, facing,</span><br><span class="line">                        clientPid, clientUid, servicePid, legacyMode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Camera2 API route</span></span><br><span class="line">                sp&lt;ICameraDeviceCallbacks&gt; tmp =</span><br><span class="line">                        <span class="keyword">static_cast</span>&lt;ICameraDeviceCallbacks*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> CameraDeviceClient(cameraService, tmp, packageName, id,</span><br><span class="line">                        facing, clientPid, clientUid, servicePid);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Should not be reachable</span></span><br><span class="line">            ALOGE(<span class="string">"Unknown camera device HAL version: %d"</span>, deviceVersion);</span><br><span class="line">            <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// A particular HAL version is requested by caller. Create CameraClient</span></span><br><span class="line">        <span class="comment">// based on the requested HAL version.</span></span><br><span class="line">        <span class="keyword">if</span> (deviceVersion &gt; CAMERA_DEVICE_API_VERSION_1_0 &amp;&amp;</span><br><span class="line">            halVersion == CAMERA_DEVICE_API_VERSION_1_0) &#123;</span><br><span class="line">            <span class="comment">// Only support higher HAL version device opened as HAL1.0 device.</span></span><br><span class="line">            sp&lt;ICameraClient&gt; tmp = <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">            *client = <span class="keyword">new</span> CameraClient(cameraService, tmp, packageName, id, facing,</span><br><span class="line">                    clientPid, clientUid, servicePid, legacyMode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Other combinations (e.g. HAL3.x open as HAL2.x) are not supported yet.</span></span><br><span class="line">            ALOGE(<span class="string">"Invalid camera HAL version %x: HAL %x device can only be"</span></span><br><span class="line">                    <span class="string">" opened as HAL %x device"</span>, halVersion, deviceVersion,</span><br><span class="line">                    CAMERA_DEVICE_API_VERSION_1_0);</span><br><span class="line">            <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­å°±æ˜¯åˆ›å»ºä¸€ä¸ªClientå¯¹è±¡ï¼Œç”±äºæ­¤å¤„åˆ†æçš„æ˜¯Camera API2.0ï¼Œå…¶HALçš„ç‰ˆæœ¬æ˜¯3.0+ï¼Œè€ŒDeviceçš„ç‰ˆæœ¬åˆ™å…¶Deviceçš„ç‰ˆæœ¬å³ä¸º3.0+ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºä¸€ä¸ªCameraDeviceClientå¯¹è±¡ï¼Œè‡³æ­¤ï¼ŒmakeClientå·²ç»åˆ›å»ºäº†clientå¯¹è±¡ï¼Œå¹¶è¿”å›äº†ï¼Œæ¥ç€çœ‹å®ƒçš„åˆå§‹åŒ–ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp]</span><br><span class="line"><span class="keyword">status_t</span> CameraDeviceClient::initialize(CameraModule *<span class="keyword">module</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    <span class="comment">//è°ƒç”¨Camera2ClientBaseçš„åˆå§‹åŒ–å‡½æ•°æ¥åˆå§‹åŒ–CameraModuleæ¨¡å—</span></span><br><span class="line">    res = Camera2ClientBase::initialize(<span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String8 threadName;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–FrameProcessor</span></span><br><span class="line">    mFrameProcessor = <span class="keyword">new</span> FrameProcessorBase(mDevice);</span><br><span class="line">    threadName = String8::format(<span class="string">"CDU-%d-FrameProc"</span>, mCameraId);</span><br><span class="line">    mFrameProcessor-&gt;run(threadName.<span class="built_in">string</span>());</span><br><span class="line">    <span class="comment">//å¹¶æ³¨å†Œç›‘å¬ï¼Œç›‘å¬çš„å®ç°å°±åœ¨CameraDeviceClientç±»ä¸­</span></span><br><span class="line">    mFrameProcessor-&gt;registerListener(FRAME_PROCESSOR_LISTENER_MIN_ID,</span><br><span class="line">            FRAME_PROCESSOR_LISTENER_MAX_ID, <span class="comment">/*listener*/</span><span class="keyword">this</span>,<span class="comment">/*sendPartials*/</span><span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒä¼šè°ƒç”¨Camera2ClientBaseçš„initializeæ–¹æ³•æ¥åˆå§‹åŒ–ï¼Œå¹¶ä¸”ä¼šåˆå§‹åŒ–ä¸€ä¸ªFrameProcessoræ¥è¿›è¡Œå¸§å¤„ç†ï¼Œä¸»è¦æ˜¯å›è°ƒæ¯ä¸€å¸§çš„ExtraResultåˆ°åº”ç”¨ä¸­ï¼Œä¹Ÿå°±æ˜¯3Aç›¸å…³çš„æ•°æ®ä¿¡æ¯ã€‚è€ŒCamera1.0ä¸­å„ç§Processoræ¨¡å—ï¼Œå³å°†æ•°æ®æ‰“åŒ…å¤„ç†åå†è¿”å›åˆ°åº”ç”¨çš„æ¨¡å—éƒ½å·²ç»ä¸å­˜åœ¨ï¼Œè€ŒCamera2.0ä¸­å°†ç”±MediaRecorderã€SurfaceViewã€ImageReaderç­‰æ¥ç›´æ¥å¤„ç†ï¼Œæ€»ä½“æ¥è¯´æ•ˆç‡æ›´å¥½ã€‚ç»§ç»­çœ‹initializeï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\common\Camera2ClientBase.cpp]</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initialize(CameraModule *<span class="keyword">module</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//è°ƒç”¨Deviceçš„initialieæ–¹æ³•</span></span><br><span class="line">    res = mDevice-&gt;initialize(<span class="keyword">module</span>);</span><br><span class="line">    ...</span><br><span class="line">    res = mDevice-&gt;setNotifyCallback(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç å°±æ˜¯è°ƒç”¨äº†Deviceçš„initializeæ–¹æ³•ï¼Œæ­¤å¤„çš„Deviceæ˜¯åœ¨Camera2ClientBaseçš„æ„é€ å‡½æ•°ä¸­åˆ›å»ºçš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\common\Camera2ClientBase.cpp]</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line">Camera2ClientBase&lt;TClientBase&gt;::Camera2ClientBase(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;TCamCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">int</span> cameraId,</span><br><span class="line">        <span class="keyword">int</span> cameraFacing,</span><br><span class="line">        <span class="keyword">int</span> clientPid,</span><br><span class="line">        <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">        <span class="keyword">int</span> servicePid):</span><br><span class="line">        TClientBase(cameraService, remoteCallback, clientPackageName,</span><br><span class="line">                cameraId, cameraFacing, clientPid, clientUid, servicePid),</span><br><span class="line">        mSharedCameraCallbacks(remoteCallback),</span><br><span class="line">        mDeviceVersion(cameraService-&gt;getDeviceVersion(cameraId)),</span><br><span class="line">        mDeviceActive(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGI(<span class="string">"Camera %d: Opened. Client: %s (PID %d, UID %d)"</span>, cameraId,</span><br><span class="line">            String8(clientPackageName).<span class="built_in">string</span>(), clientPid, clientUid);</span><br><span class="line"></span><br><span class="line">    mInitialClientPid = clientPid;</span><br><span class="line">    mDevice = <span class="keyword">new</span> Camera3Device(cameraId);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mDevice == <span class="number">0</span>, <span class="string">"Device should never be NULL here."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®å‰Camera APIæ˜¯2.0ï¼Œè€ŒDeviceçš„APIå·²ç»æ˜¯3.0+äº†ï¼Œç»§ç»­çœ‹Camera3Deviceçš„æ„é€ æ–¹æ³•ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line">Camera3Device::Camera3Device(<span class="keyword">int</span> id):</span><br><span class="line">        mId(id),</span><br><span class="line">        mIsConstrainedHighSpeedConfiguration(<span class="literal">false</span>),</span><br><span class="line">        mHal3Device(<span class="literal">NULL</span>),</span><br><span class="line">        mStatus(STATUS_UNINITIALIZED),</span><br><span class="line">        mStatusWaiters(<span class="number">0</span>),</span><br><span class="line">        mUsePartialResult(<span class="literal">false</span>),</span><br><span class="line">        mNumPartialResults(<span class="number">1</span>),</span><br><span class="line">        mTimestampOffset(<span class="number">0</span>),</span><br><span class="line">        mNextResultFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mNextReprocessResultFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mNextShutterFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mNextReprocessShutterFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mListener(<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    camera3_callback_ops::notify = &amp;sNotify;</span><br><span class="line">    camera3_callback_ops::process_capture_result = &amp;sProcessCaptureResult;</span><br><span class="line">    ALOGV(<span class="string">"%s: Created device for camera %d"</span>, __FUNCTION__, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶ï¼Œå®ƒå°†ä¼šåˆ›å»ºä¸€ä¸ªCamera3Deviceå¯¹è±¡ï¼Œæ‰€ä»¥ï¼ŒDeviceçš„initializeå°±æ˜¯è°ƒç”¨äº†Camera3Deviceçš„initializeæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::initialize(CameraModule *<span class="keyword">module</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">camera3_device_t</span> *device;</span><br><span class="line">    <span class="comment">//æ‰“å¼€Camera HALå±‚çš„Deivce</span></span><br><span class="line">    res = <span class="keyword">module</span>-&gt;open(deviceName.<span class="built_in">string</span>(),</span><br><span class="line">            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">hw_device_t</span>**&gt;(&amp;device));</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº¤å‰æ£€æŸ¥Deviceçš„ç‰ˆæœ¬</span></span><br><span class="line">    <span class="keyword">if</span> (device-&gt;common.version &lt; CAMERA_DEVICE_API_VERSION_3_0) &#123;</span><br><span class="line">        SET_ERR_L(<span class="string">"Could not open camera: "</span></span><br><span class="line">                <span class="string">"Camera device should be at least %x, reports %x instead"</span>,</span><br><span class="line">                CAMERA_DEVICE_API_VERSION_3_0,</span><br><span class="line">                device-&gt;common.version);</span><br><span class="line">        device-&gt;common.close(&amp;device-&gt;common);</span><br><span class="line">        <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨å›è°ƒå‡½æ•°æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå³è°ƒç”¨æ‰“å¼€Deviceçš„initializeæ–¹æ³•æ¥è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">    res = device-&gt;ops-&gt;initialize(device, <span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨è¯·æ±‚é˜Ÿåˆ—çº¿ç¨‹</span></span><br><span class="line">    mRequestThread = <span class="keyword">new</span> RequestThread(<span class="keyword">this</span>, mStatusTracker, device, aeLockAvailable);</span><br><span class="line">    res = mRequestThread-&gt;run(String8::format(<span class="string">"C3Dev-%d-ReqQueue"</span>, mId).<span class="built_in">string</span>());</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        SET_ERR_L(<span class="string">"Unable to start request queue thread: %s (%d)"</span>,</span><br><span class="line">                strerror(-res), res);</span><br><span class="line">        device-&gt;common.close(&amp;device-&gt;common);</span><br><span class="line">        mRequestThread.clear();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//è¿”å›åˆå§‹æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œä¼šä¾èµ–HALæ¡†æ¶æ‰“å¼€å¹¶è·å¾—ç›¸åº”çš„Deviceå¯¹è±¡ï¼Œå…·ä½“çš„æµç¨‹è¯·å‚è€ƒandroid6.0æºç åˆ†æä¹‹Camera2 HALåˆ†æï¼Œç„¶åå†å›è°ƒæ­¤å¯¹è±¡çš„initializeæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€åå†å¯åŠ¨RequestThreadç­‰çº¿ç¨‹ï¼Œå¹¶è¿”å›initializeæˆåŠŸã€‚è‡³æ­¤Camera API2.0ä¸‹çš„åˆå§‹åŒ–è¿‡ç¨‹å°±åˆ†æç»“æŸäº†ã€‚æ¡†æ¶å±‚çš„åˆå§‹åŒ–æ—¶åºå›¾å¦‚ä¸‹ï¼š </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-17-camera_open_native.png" alt="Alt text"></p><h5 id="4-2ã€æ€»ç»“"><a href="#4-2ã€æ€»ç»“" class="headerlink" title="4.2ã€æ€»ç»“"></a>4.2ã€æ€»ç»“</h5><p>Open()è¿‡ç¨‹é“è·¯è‰°è¾›ï¼Œä¸»è¦ä¸ºäº†åç»­Cameraæ­£å¸¸å·¥ä½œï¼Œæ·»ç –åŠ ç“¦ï¼Œé“ºè·¯ã€‚ä¸‹é¢æˆ‘ä»¬åˆ—ä¸¾ä¸€ä¸‹ï¼Œä¸»è¦éƒ½å‡†å¤‡äº†ä»€ä¹ˆã€‚<br>1ã€Cameraåº”ç”¨å°†ä¸€äº›Callbackå‡½æ•°ï¼Œæ³¨å†Œåˆ°Camera.javaä¸­ï¼Œä»¥ä½¿åœ¨çº¿ç¨‹å¤„ç†å‡½æ•°ä¸­å¯ä»¥è°ƒç”¨åˆ°ç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚<br>2ã€camera connectæˆåŠŸåï¼Œåˆ›å»ºäº†BpCameraä»£ç†å¯¹è±¡å’ŒBnCameraClientæœ¬åœ°å¯¹è±¡ã€‚<br>3ã€åœ¨JNICameraContextå®ç°CameraListeneræ¥å£ï¼Œå¹¶å°†æ¥å£æ³¨å†Œåˆ°å®¢æˆ·ç«¯cameraæœ¬åœ°å¯¹è±¡ä¸­ï¼Œå¹¶åœ¨BnCameraClientæœ¬åœ°å¯¹è±¡ä¸­å›è°ƒè¿™äº›æ¥å£ã€‚<br>4ã€CameraService connectè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®halç¡¬ä»¶ç‰ˆæœ¬ï¼Œåˆ›å»ºå¯¹åº”çš„CameraClientå¯¹è±¡ã€‚åœ¨åç»­çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œåˆ›å»º6å¤§çº¿ç¨‹ã€‚<br>æœ€åä»¥ä¸€ä¸ªç®€å•çš„å·¥ä½œæµç¨‹å›¾æ¥ç»“æŸåšæ–‡ </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/camera.system/01-18-Camera_open_overview.png" alt="Alt text"></p><h4 id="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://source.android.com/devices/camera/" target="_blank" rel="noopener">Android Cameraå®˜æ–¹æ–‡æ¡£</a><br><a href="https://blog.csdn.net/eternity9255" target="_blank" rel="noopener">Android 5.0 Cameraç³»ç»Ÿæºç åˆ†æ-CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/stonedemo/category/1080451.html" target="_blank" rel="noopener">Android Camera æµç¨‹å­¦ä¹ è®°å½• - StoneDemo - åšå®¢å›­</a><br><a href="https://blog.csdn.net/shell812/article/category/5905525" target="_blank" rel="noopener">Android Camera ç³»ç»Ÿæ¶æ„æºç åˆ†æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/hbw1992322/article/details/75259311" target="_blank" rel="noopener">Cameraå®‰å“æºç -é«˜é€šmm_cameraæ¶æ„å‰–æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/yanbixing123/article/details/52294305/" target="_blank" rel="noopener">5.2 åº”ç”¨ç¨‹åºå’Œé©±åŠ¨ç¨‹åºä¸­bufferçš„ä¼ è¾“æµç¨‹ - CSDNåšå®¢</a><br><a href="https://www.jianshu.com/p/ecb1be82e6a8" target="_blank" rel="noopener">Camera2 æ•°æ®æµä»frameworkåˆ°Halæºç åˆ†æ - ç®€ä¹¦</a><br><a href="https://www.jianshu.com/p/1baad2a5281d" target="_blank" rel="noopener">mm-cameraå±‚frameæ•°æ®æµæºç åˆ†æ - ç®€ä¹¦</a><br><a href="https://blog.csdn.net/yanbixing123/article/month/2016/08/4?" target="_blank" rel="noopener">v4l2_capture.cåˆ†æâ€”probeå‡½æ•°åˆ†æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/armwind/article/category/6282972" target="_blank" rel="noopener">@@Android Camera fwå­¦ä¹  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/category/3066721" target="_blank" rel="noopener">@@Android Camera API2åˆ†æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/qq_16775897/article/category/7112759" target="_blank" rel="noopener">@@Android Camera æµç¨‹å­¦ä¹ è®°å½• 7.12- CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/guming-camera.html" target="_blank" rel="noopener">@@ä¸“æ ï¼šå¤å†¥çš„android6.0ä¸‹çš„Camera API2.0çš„æºç åˆ†æä¹‹æ—… - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/17751109" target="_blank" rel="noopener">linux3.3 v4l2è§†é¢‘é‡‡é›†é©±åŠ¨æ¡†æ¶(vfe, camera i2c driverï¼Œv4l2_subdevç­‰ä¹‹é—´çš„è”ç³») - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/48974523" target="_blank" rel="noopener">Android Cameraä»Camera HAL1åˆ°Camera HAL3çš„è¿‡æ¸¡ï¼ˆå·²æ›´æ–°åˆ°Android6.0 HAL3.3ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/48972477" target="_blank" rel="noopener">æˆ‘å¿ƒä¾æ—§ä¹‹Android Cameraæ¨¡å—FW/HAL3æ¢å­¦åº - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/armwind/article/details/73709808" target="_blank" rel="noopener">Android Camera fwå­¦ä¹ (å››)-recordingæµç¨‹åˆ†æ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/armwind/article/details/52076879" target="_blank" rel="noopener">android cameraåŠ¨æ€åº“åŠ è½½è¿‡ç¨‹ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/49468475" target="_blank" rel="noopener">Android Camera API2.0ä¸‹å…¨æ–°çš„Camera FW/HALæ¶æ„ç®€è¿° - CSDNåšå®¢</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Video Systemï¼ˆ3ï¼‰ï¼šéŸ³è§†é¢‘å½•åˆ¶Recorderã€ç¼–ç Encoderã€æ··åˆMediaMuxeræºç åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/06/18/Android%20Video%20System%EF%BC%883%EF%BC%89%EF%BC%9A%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BD%95%E5%88%B6Recorder%E3%80%81%E7%BC%96%E7%A0%81Encoder%E3%80%81%E6%B7%B7%E5%90%88MediaMuxer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/06/18/Android Video Systemï¼ˆ3ï¼‰ï¼šéŸ³è§†é¢‘å½•åˆ¶Recorderã€ç¼–ç Encoderã€æ··åˆMediaMuxeræºç åˆ†æ/</id>
    <published>2018-06-17T16:00:00.000Z</published>
    <updated>2018-07-03T12:51:51.638Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/video.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Android NuPlayeræ’­æ”¾æ¡†æ¶ã€‘</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  android ACodec MediaCodec NuPlayer flowã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>â˜¯ V4l2 æ¡†æ¶ä»£ç <br>â˜¯ kernel/drivers/media/v4l2-core/ï¼ˆæ–‡ä»¶å‰ç¼€ä¸º videobuf2ï¼‰</p><p>â˜¯ MSM è§†é¢‘é©±åŠ¨ç¨‹åºæ–‡ä»¶<br>â˜¯ kernel/drivers/media/platform/msm/vidc/</p><p>â˜¯ è®¾å¤‡æ ‘<br>â˜¯ /kernel/arch/arm/boot/dts/qcomï¼ˆVenus çš„å¯„å­˜å™¨åŸºå€ï¼Œæ—¶é’Ÿé¢‘ç‡ï¼‰</p><p>â˜¯ Stagefrightã€libmediaã€libmediaplayerserviceã€mediaserver<br>â˜¯ /frameworks/av/media/</p><p>â˜¯ OMX<br>â˜¯ /hardware/qcom/media/mam8996/mm-video-v4l2/vidc/</p><p>â˜¯ OMX æ ¸å¿ƒ<br>â˜¯ /hardware/qcom/media/mm-core</p><p>â˜¯ è½¯ä»¶ç¼–è§£ç å™¨è·¯å¾„<br>â˜¯ /vendor/qcom/proprietary/mm-video/omx_vpp(?) â†’ è§£ç å™¨ä»£ç <br>â˜¯ /vendor/qcom/proprietary/mm-video/omx_vpp(?) â†’ ç¼–ç å™¨ä»£ç </p><hr><p>é¦–å…ˆçœ‹ä¸€ä¸‹ä½¿ç”¨MediaRecorder å½•åˆ¶éŸ³é¢‘çš„Javaå®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MediaRecorder recorder=newMediaRecorder();</span><br><span class="line">recorder.setAudioSource(MediaRecorder.AudioSource.MIC);</span><br><span class="line">recorder.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);</span><br><span class="line">recorder.setAudioEncoder(MediaRecorder.AudioEncoder.AMR_NB);</span><br><span class="line">recorder.setOutputFile(PATH_NAME);</span><br><span class="line">recorder.prepare();</span><br><span class="line">recorder.start();  <span class="comment">// Recording is now started</span></span><br><span class="line">...</span><br><span class="line">recorder.stop();  <span class="comment">//</span></span><br><span class="line">recorder.reset();  <span class="comment">// You can reuse the object by going back to setAudioSource() step</span></span><br><span class="line">recorder.release();<span class="comment">// Now the object cannot be reused</span></span><br></pre></td></tr></table></figure><p>ä¹‹å‰åœ¨<a href="http://zhoujinjian.cc/2018/05/15/Audio%20System%EF%BC%882%EF%BC%89%EF%BC%9ALinux%20ALSA%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/#%EF%BC%88%E5%85%AB%EF%BC%89%E3%80%81tinyplay-playback%E3%80%81capture">Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ</a> ç¬¬ï¼ˆå…«ï¼‰èŠ‚ç”»è¿‡tinyplay captureå½•éŸ³æ—¶åºå›¾ï¼Œä½†å½“æ—¶æ²¡æœ‰ä»”ç»†åˆ†æï¼Œä»Šå¤©æ¥åˆ†æAudioå½•éŸ³å¦‚ä½•ä»Javaå±‚ä¸€æ­¥æ­¥æœ€ç»ˆåˆ°è¾¾tinyalsaå±‚çš„pcm_open()ã€pcm_read()å‡½æ•°çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;E:\android<span class="number">-7.1</span><span class="number">.2</span>_r1\external\tinyalsa\tinycap.c]</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">capture_sample</span><span class="params">(FILE *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> card, <span class="keyword">unsigned</span> <span class="keyword">int</span> device,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">unsigned</span> <span class="keyword">int</span> channels, <span class="keyword">unsigned</span> <span class="keyword">int</span> rate,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">enum</span> pcm_format format, <span class="keyword">unsigned</span> <span class="keyword">int</span> period_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">unsigned</span> <span class="keyword">int</span> period_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pcm_config</span> <span class="title">config</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *buffer;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bytes_read = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;config, <span class="number">0</span>, <span class="keyword">sizeof</span>(config));</span><br><span class="line">    config.channels = channels;</span><br><span class="line">    config.rate = rate;</span><br><span class="line">    config.period_size = period_size;</span><br><span class="line">    config.period_count = period_count;</span><br><span class="line">    config.format = format;</span><br><span class="line">    config.start_threshold = <span class="number">0</span>;</span><br><span class="line">    config.stop_threshold = <span class="number">0</span>;</span><br><span class="line">    config.silence_threshold = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//æ‰“å¼€å½•åˆ¶èŠ‚ç‚¹</span></span><br><span class="line">    pcm = pcm_open(card, device, PCM_IN, &amp;config);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶è¯»å–ä»Kernelå†…æ ¸ä¼ è¿‡æ¥çš„æ•°æ®æœ€ç»ˆåˆæˆéŸ³é¢‘æ–‡ä»¶çš„è¿‡ç¨‹<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;E:\android<span class="number">-7.1</span><span class="number">.2</span>_r1\external\tinyalsa\tinycap.c]</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">capture_sample</span><span class="params">(FILE *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> card, <span class="keyword">unsigned</span> <span class="keyword">int</span> device,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">unsigned</span> <span class="keyword">int</span> channels, <span class="keyword">unsigned</span> <span class="keyword">int</span> rate,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">enum</span> pcm_format format, <span class="keyword">unsigned</span> <span class="keyword">int</span> period_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">unsigned</span> <span class="keyword">int</span> period_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//å¾ªç¯è¯»å–éŸ³é¢‘æ•°æ®</span></span><br><span class="line">    size = pcm_frames_to_bytes(pcm, pcm_get_buffer_size(pcm));</span><br><span class="line">    buffer = <span class="built_in">malloc</span>(size);</span><br><span class="line">        <span class="keyword">while</span> (capturing &amp;&amp; !pcm_read(pcm, buffer, size)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fwrite(buffer, <span class="number">1</span>, size, file) != size) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error capturing sample\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bytes_read += size;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>å¼€å§‹åˆ†æéŸ³é¢‘å½•åˆ¶ç¼–ç åˆæˆä¹‹æ—…ï¼Œä¹‹ååˆ†æè§†é¢‘å½•åˆ¶ç¼–ç åˆæˆè¿‡ç¨‹ã€‚</p><h4 id="ï¼ˆä¸€ï¼‰ã€Audio-Recorder-éŸ³é¢‘å½•åˆ¶æºç åˆ†æ"><a href="#ï¼ˆä¸€ï¼‰ã€Audio-Recorder-éŸ³é¢‘å½•åˆ¶æºç åˆ†æ" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Audio Recorder éŸ³é¢‘å½•åˆ¶æºç åˆ†æ"></a>ï¼ˆä¸€ï¼‰ã€Audio Recorder éŸ³é¢‘å½•åˆ¶æºç åˆ†æ</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-03-01-MediaRecorder-flow.png" alt="Alt text"></p><h4 id="ï¼ˆäºŒï¼‰ã€Media-Recorder-è§†é¢‘å½•åˆ¶æºç åˆ†æ"><a href="#ï¼ˆäºŒï¼‰ã€Media-Recorder-è§†é¢‘å½•åˆ¶æºç åˆ†æ" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Media Recorder è§†é¢‘å½•åˆ¶æºç åˆ†æ"></a>ï¼ˆäºŒï¼‰ã€Media Recorder è§†é¢‘å½•åˆ¶æºç åˆ†æ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mCamera = getCameraInstance();</span><br><span class="line">mCamera .open()</span><br><span class="line">mCamera.startPreview() </span><br><span class="line"></span><br><span class="line">      mMediaRecorder = new MediaRecorder();</span><br><span class="line">      mMediaRecorder.setCamera(mCamera);</span><br><span class="line"> </span><br><span class="line">      mMediaRecorder.setPreviewDisplay(android.view.SurfaceHolder);</span><br><span class="line">      mMediaRecorder.setAudioSource(MediaRecorder.AudioSource.CAMCORDER);</span><br><span class="line">      mMediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);</span><br><span class="line"></span><br><span class="line">      mMediaRecorder.setVideoSize(videoRecordSize.width, videoRecordSize.height);</span><br><span class="line">mMediaRecorder.setProfile(CamcorderProfile.get(CamcorderProfile.QUALITY_HIGH));</span><br><span class="line">      mMediaRecorder.setOutputFile(outputFile.toString());</span><br><span class="line">      //MediaRecorder.OutputFormat.MPEG_4.</span><br><span class="line"></span><br><span class="line">      mMediaRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AMR_NB)</span><br><span class="line">      mMediaRecorder.setVideoEncoder(MediaRecorder.VideoEncoder.MPEG_4_SP)</span><br><span class="line">      </span><br><span class="line">      mMediaRecorder.prepare();</span><br><span class="line">      mMediaRecorder.start();</span><br><span class="line"></span><br><span class="line">mMediaRecorder.stop()</span><br><span class="line">mMediaRecorder.release()</span><br><span class="line">mCamera.stopPreview()</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-03-02-MediaRecorder-video-flow.png" alt="Alt text"></p><h4 id="ï¼ˆä¸‰ï¼‰ã€éŸ³é¢‘Recorderç¼–ç Encoder"><a href="#ï¼ˆä¸‰ï¼‰ã€éŸ³é¢‘Recorderç¼–ç Encoder" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€éŸ³é¢‘Recorderç¼–ç Encoder"></a>ï¼ˆä¸‰ï¼‰ã€éŸ³é¢‘Recorderç¼–ç Encoder</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">Line 3036: 07-02 17:00:07.175  8430  8479 V ACodec  : Now uninitialized</span><br><span class="line">Line 3674: 07-02 17:00:35.717   745  1949 V ACodec  : Now uninitialized</span><br><span class="line">Line 3675: 07-02 17:00:35.718   745  8649 V ACodec  : onAllocateComponent</span><br><span class="line">Line 3678: 07-02 17:00:35.721   731   921 I OMXMaster: makeComponentInstance(OMX.google.amrnb.encoder) in mediacodec process</span><br><span class="line">Line 3679: 07-02 17:00:35.742   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Now Loaded</span><br><span class="line">Line 3680: 07-02 17:00:35.742   745  8649 I MediaCodec: MediaCodec will operate in async mode</span><br><span class="line">Line 3680: 07-02 17:00:35.742   745  8649 I MediaCodec: MediaCodec will operate in async mode</span><br><span class="line">Line 3681: 07-02 17:00:35.742   745  8649 V MediaCodec: Found 0 pieces of codec specific data.</span><br><span class="line">Line 3682: 07-02 17:00:35.742   745  8649 V ACodec  : onConfigureComponent</span><br><span class="line">Line 3684: 07-02 17:00:35.744   745  8649 I ACodec  : codec does not support config priority (err -2147483648)</span><br><span class="line">Line 3686: 07-02 17:00:35.751   745  8649 I ACodec  : codec does not support config priority (err -2147483648)</span><br><span class="line">Line 3687: 07-02 17:00:35.755   745  8649 V MediaCodec: [OMX.google.amrnb.encoder] configured as input format: AMessage(what = 0x00000000) = &#123;</span><br><span class="line">Line 3688: 07-02 17:00:35.755   745  8649 V MediaCodec:       string mime = &quot;audio/raw&quot;</span><br><span class="line">Line 3689: 07-02 17:00:35.755   745  8649 V MediaCodec:       int32_t channel-count = 1</span><br><span class="line">Line 3690: 07-02 17:00:35.755   745  8649 V MediaCodec:       int32_t sample-rate = 8000</span><br><span class="line">Line 3691: 07-02 17:00:35.755   745  8649 V MediaCodec:       int32_t pcm-encoding = 2</span><br><span class="line">Line 3692: 07-02 17:00:35.755   745  8649 V MediaCodec:     &#125;, output format: AMessage(what = 0x00000000) = &#123;</span><br><span class="line">Line 3693: 07-02 17:00:35.755   745  8649 V MediaCodec:       int32_t bitrate = 12200</span><br><span class="line">Line 3694: 07-02 17:00:35.755   745  8649 V MediaCodec:       int32_t max-bitrate = 12200</span><br><span class="line">Line 3695: 07-02 17:00:35.755   745  8649 V MediaCodec:       int32_t channel-count = 1</span><br><span class="line">Line 3696: 07-02 17:00:35.755   745  8649 V MediaCodec:       string mime = &quot;audio/3gpp&quot;</span><br><span class="line">Line 3697: 07-02 17:00:35.755   745  8649 V MediaCodec:       int32_t sample-rate = 8000</span><br><span class="line">Line 3698: 07-02 17:00:35.755   745  8649 V MediaCodec:     &#125;</span><br><span class="line">Line 3699: 07-02 17:00:35.757   745  8649 V ACodec  : onStart</span><br><span class="line">Line 3700: 07-02 17:00:35.758   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Now Loaded-&gt;Idle</span><br><span class="line">Line 3701: 07-02 17:00:35.758   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Allocating 4 buffers of size 2048/2048 (from 2048 using Invalid) on input port</span><br><span class="line">Line 3702: 07-02 17:00:35.766   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Allocating 4 buffers of size 8192/8192 (from 8192 using Invalid) on output port</span><br><span class="line">Line 3703: 07-02 17:00:35.771   745  8649 V MediaCodec: input buffers allocated</span><br><span class="line">Line 3704: 07-02 17:00:35.771   745  8649 V MediaCodec: output buffers allocated</span><br><span class="line">Line 3705: 07-02 17:00:35.772   745  8646 I MediaCodecSource: MediaCodecSource (audio) starting</span><br><span class="line">    Line 3706: 07-02 17:00:35.772   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Now Idle-&gt;Executing</span><br><span class="line">Line 3701: 07-02 17:00:35.758   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Allocating 4 buffers of size 2048/2048 (from 2048 using Invalid) on input port</span><br><span class="line">Line 3702: 07-02 17:00:35.766   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Allocating 4 buffers of size 8192/8192 (from 8192 using Invalid) on output port</span><br><span class="line">Line 3706: 07-02 17:00:35.772   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Now Idle-&gt;Executing</span><br><span class="line">Line 3707: 07-02 17:00:35.773   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 5</span><br><span class="line">Line 3708: 07-02 17:00:35.773   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 6</span><br><span class="line">Line 3711: 07-02 17:00:35.775   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 7</span><br><span class="line">Line 3715: 07-02 17:00:35.775   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 8</span><br><span class="line">Line 3717: 07-02 17:00:35.776   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Now Executing</span><br><span class="line">Line 3833: 07-02 17:00:35.902   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling emptyBuffer 1 w/ time 20000 us</span><br><span class="line">Line 3834: 07-02 17:00:35.904   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXEmptyBufferDone 1</span><br><span class="line">Line 3835: 07-02 17:00:35.907   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 5 time 20000 us, flags = 0x00000010</span><br><span class="line">Line 3836: 07-02 17:00:35.911   745  8649 V MediaCodec: [OMX.google.amrnb.encoder] output format changed to: AMessage(what = 0x00000000) = &#123;</span><br><span class="line">Line 3843: 07-02 17:00:35.913   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 5</span><br><span class="line">Line 3844: 07-02 17:00:35.925   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling emptyBuffer 2 w/ time 40000 us</span><br><span class="line">Line 3845: 07-02 17:00:35.926   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXEmptyBufferDone 2</span><br><span class="line">Line 3846: 07-02 17:00:35.927   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 6 time 40000 us, flags = 0x00000010</span><br><span class="line">Line 3847: 07-02 17:00:35.927   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 6</span><br><span class="line">Line 3848: 07-02 17:00:35.942   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling emptyBuffer 3 w/ time 60000 us</span><br><span class="line">Line 3849: 07-02 17:00:35.945   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXEmptyBufferDone 3</span><br><span class="line">Line 3850: 07-02 17:00:35.945   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 7 time 60000 us, flags = 0x00000010</span><br><span class="line">Line 3851: 07-02 17:00:35.946   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 7</span><br><span class="line">Line 3852: 07-02 17:00:35.963   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling emptyBuffer 4 w/ time 80000 us</span><br><span class="line">Line 3853: 07-02 17:00:35.965   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXEmptyBufferDone 4</span><br><span class="line">Line 3854: 07-02 17:00:35.966   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 8 time 80000 us, flags = 0x00000010</span><br><span class="line">Line 3855: 07-02 17:00:35.967   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 8</span><br><span class="line">Line 3856: 07-02 17:00:35.982   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling emptyBuffer 1 w/ time 100000 us</span><br><span class="line">Line 3857: 07-02 17:00:35.983   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXEmptyBufferDone 1</span><br><span class="line">Line 3858: 07-02 17:00:35.985   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 5 time 100000 us, flags = 0x00000010</span><br><span class="line">......</span><br><span class="line">Line 8217: 07-02 17:00:56.446   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 8</span><br><span class="line">Line 8218: 07-02 17:00:56.462   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling emptyBuffer 1 w/ time 20580000 us</span><br><span class="line">Line 8219: 07-02 17:00:56.464   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXEmptyBufferDone 1</span><br><span class="line">Line 8220: 07-02 17:00:56.466   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 5 time 20580000 us, flags = 0x00000010</span><br><span class="line">Line 8221: 07-02 17:00:56.467   745  8649 V ACodec  : [OMX.google.amrnb.encoder] calling fillBuffer 5</span><br><span class="line">Line 8222: 07-02 17:00:56.468   745  8646 I MediaCodecSource: encoder (audio) stopping</span><br><span class="line">Line 8223: 07-02 17:00:56.483   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Now Executing-&gt;Idle</span><br><span class="line">Line 8224: 07-02 17:00:56.484   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 5 time 20580000 us, flags = 0x00000000</span><br><span class="line">Line 8225: 07-02 17:00:56.484   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 6 time 20520000 us, flags = 0x00000000</span><br><span class="line">Line 8226: 07-02 17:00:56.484   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 7 time 20540000 us, flags = 0x00000000</span><br><span class="line">Line 8227: 07-02 17:00:56.484   745  8649 V ACodec  : [OMX.google.amrnb.encoder] onOMXFillBufferDone 8 time 20560000 us, flags = 0x00000000</span><br><span class="line">Line 8228: 07-02 17:00:56.496   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Now Idle-&gt;Loaded</span><br><span class="line">Line 8229: 07-02 17:00:56.496   745  8649 V ACodec  : [OMX.google.amrnb.encoder] Now Loaded</span><br><span class="line">Line 8231: 07-02 17:00:56.499   745  8646 I MediaCodecSource: encoder (audio) stopped</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆå››ï¼‰ã€è§†é¢‘Recorderç¼–ç Encoder"><a href="#ï¼ˆå››ï¼‰ã€è§†é¢‘Recorderç¼–ç Encoder" class="headerlink" title="ï¼ˆå››ï¼‰ã€è§†é¢‘Recorderç¼–ç Encoder"></a>ï¼ˆå››ï¼‰ã€è§†é¢‘Recorderç¼–ç Encoder</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">44.947</span>  <span class="number">6238</span>  <span class="number">6238</span> V CAM_VideoModule: startVideoRecording</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">44.974</span>  <span class="number">6238</span>  <span class="number">6238</span> D CameraStorage: External storage state=mounted</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">44.995</span>  <span class="number">6238</span>  <span class="number">6238</span> D CameraStorage: External storage state=mounted</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">44.998</span>  <span class="number">6238</span>  <span class="number">6238</span> V CAM_VideoModule: initializeRecorder</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.003</span>   <span class="number">741</span>  <span class="number">1966</span> V MediaPlayerService: Create <span class="keyword">new</span> media recorder client from pid <span class="number">6238</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.009</span>  <span class="number">6238</span>  <span class="number">6238</span> I CAM_VideoModule: NOTE: hfr = off : hsr = off</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.024</span>   <span class="number">802</span>  <span class="number">6282</span> E mm-camera: &lt;ISP   &gt;&lt;ERROR&gt; <span class="number">378</span>: tintless40_algo_process_be: failed: update_func rc <span class="number">-4</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.024</span>   <span class="number">802</span>  <span class="number">6282</span> E mm-camera: &lt;ISP   &gt;&lt;ERROR&gt; <span class="number">851</span>: tintless40_algo_execute: failed: tintless40_trigger_algo</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.024</span>   <span class="number">802</span>  <span class="number">6282</span> E mm-camera: &lt;ISP   &gt;&lt;ERROR&gt; <span class="number">98</span>: isp_algo_execute_internal_algo: failed to run algo tintless</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.024</span>   <span class="number">802</span>  <span class="number">6282</span> E mm-camera: &lt;ISP   &gt;&lt;ERROR&gt; <span class="number">710</span>: isp_parser_thread_func: failed: isp_parser_process</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.031</span>  <span class="number">6238</span>  <span class="number">6238</span> D LocationManager: No location received yet.</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.033</span>  <span class="number">6238</span>  <span class="number">6238</span> D LocationManager: No location received yet.</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.033</span>  <span class="number">6238</span>  <span class="number">6238</span> V CAM_VideoModule: New video filename: /storage/emulated/<span class="number">0</span>/DCIM/Camera/VID_20180703_114345.mp4</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.059</span>  <span class="number">1391</span>  <span class="number">2526</span> I MediaFocusControl:  AudioFocus  requestAudioFocus() from uid/pid <span class="number">10025</span>/<span class="number">6238</span> clientId=android.media.AudioManager@<span class="number">11f</span>939d req=<span class="number">2</span> flags=<span class="number">0x0</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.062</span>  <span class="number">4966</span>  <span class="number">4966</span> D AudioManager: AudioManager dispatching onAudioFocusChange(<span class="number">-2</span>) <span class="keyword">for</span> android.media.AudioManager@e6fb066com.android.music.MediaPlaybackService$<span class="number">4</span>@<span class="number">2315f</span>a7</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.063</span>  <span class="number">4966</span>  <span class="number">4966</span> V MediaPlaybackService: AudioFocus: received AUDIOFOCUS_LOSS_TRANSIENT</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.079</span>   <span class="number">726</span>  <span class="number">6266</span> E QCamera : &lt;HAL&gt;&lt;ERROR&gt; <span class="keyword">status_t</span> qcamera::QCameraParameters::setSkinBeautify(<span class="keyword">const</span> qcamera::QCameraParameters &amp;): <span class="number">15184</span>: gpw <span class="keyword">status_t</span> qcamera::QCameraParameters::setSkinBeautify(<span class="keyword">const</span> qcamera::QCameraParameters &amp;): str=off , prev_str=off</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.079</span>   <span class="number">726</span>  <span class="number">6266</span> E QCamera : &lt;HAL&gt;&lt;ERROR&gt; <span class="keyword">int32_t</span> qcamera::QCameraParameters::setAjustLevel(<span class="keyword">const</span> qcamera::QCameraParameters &amp;): <span class="number">15302</span>: gpw   <span class="number">-1</span> <span class="number">-1</span> <span class="number">-1</span> <span class="number">-1</span> <span class="number">-1</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.079</span>   <span class="number">726</span>  <span class="number">6266</span> E QCamera : &lt;HAL&gt;&lt;ERROR&gt; <span class="keyword">int32_t</span> qcamera::QCameraParameters::setAjustLevel(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>): <span class="number">15232</span>: ggw3 <span class="number">-1</span> <span class="number">-1</span>  </span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.091</span>   <span class="number">726</span>  <span class="number">2209</span> E CameraClient: setVideoBufferMode: <span class="number">535</span>: videoBufferMode <span class="number">2</span> is <span class="keyword">not</span> supported.</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.100</span>   <span class="number">802</span>  <span class="number">6282</span> E mm-camera: &lt;ISP   &gt;&lt;ERROR&gt; <span class="number">378</span>: tintless40_algo_process_be: failed: update_func rc <span class="number">-4</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.101</span>   <span class="number">802</span>  <span class="number">6282</span> E mm-camera: &lt;ISP   &gt;&lt;ERROR&gt; <span class="number">851</span>: tintless40_algo_execute: failed: tintless40_trigger_algo</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.101</span>   <span class="number">802</span>  <span class="number">6282</span> E mm-camera: &lt;ISP   &gt;&lt;ERROR&gt; <span class="number">98</span>: isp_algo_execute_internal_algo: failed to run algo tintless</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.101</span>   <span class="number">802</span>  <span class="number">6282</span> E mm-camera: &lt;ISP   &gt;&lt;ERROR&gt; <span class="number">710</span>: isp_parser_thread_func: failed: isp_parser_process</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.105</span>   <span class="number">802</span>  <span class="number">6296</span> E mm-camera: &lt;IMGLIB&gt;&lt;ERROR&gt; <span class="number">318</span>: faceproc_comp_set_param: Error param=<span class="number">523</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.111</span>   <span class="number">726</span>  <span class="number">6266</span> E QCamera : &lt;HAL&gt;&lt;ERROR&gt; <span class="keyword">status_t</span> qcamera::QCameraParameters::setSkinBeautify(<span class="keyword">const</span> qcamera::QCameraParameters &amp;): <span class="number">15184</span>: gpw <span class="keyword">status_t</span> qcamera::QCameraParameters::setSkinBeautify(<span class="keyword">const</span> qcamera::QCameraParameters &amp;): str=off , prev_str=off</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.111</span>   <span class="number">726</span>  <span class="number">6266</span> E QCamera : &lt;HAL&gt;&lt;ERROR&gt; <span class="keyword">int32_t</span> qcamera::QCameraParameters::setAjustLevel(<span class="keyword">const</span> qcamera::QCameraParameters &amp;): <span class="number">15302</span>: gpw   <span class="number">-1</span> <span class="number">-1</span> <span class="number">-1</span> <span class="number">-1</span> <span class="number">-1</span></span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.111</span>   <span class="number">726</span>  <span class="number">6266</span> E QCamera : &lt;HAL&gt;&lt;ERROR&gt; <span class="keyword">int32_t</span> qcamera::QCameraParameters::setAjustLevel(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>): <span class="number">15232</span>: ggw3 <span class="number">-1</span> <span class="number">-1</span>  </span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.121</span>   <span class="number">741</span>  <span class="number">6349</span> I MediaPlayerService: MediaPlayerService::getOMX</span><br><span class="line"><span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.122</span>   <span class="number">741</span>  <span class="number">6349</span> I OMXClient: MuxOMX ctor</span><br><span class="line"></span><br><span class="line">Line <span class="number">5362</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">41.712</span>  <span class="number">6238</span>  <span class="number">6238</span> V CAM_VideoModule: Video Encoder selected = <span class="number">2</span></span><br><span class="line">Line <span class="number">5363</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">41.712</span>  <span class="number">6238</span>  <span class="number">6238</span> V CAM_VideoModule: Audio Encoder selected = <span class="number">3</span></span><br><span class="line">Line <span class="number">5449</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">41.944</span>  <span class="number">6238</span>  <span class="number">6238</span> V CAM_VideoModule: Video Encoder selected = <span class="number">2</span></span><br><span class="line">Line <span class="number">5450</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">41.944</span>  <span class="number">6238</span>  <span class="number">6238</span> V CAM_VideoModule: Audio Encoder selected = <span class="number">3</span></span><br><span class="line">Line <span class="number">6011</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.123</span>   <span class="number">732</span>  <span class="number">2029</span> I OMXMaster: makeComponentInstance(OMX.qcom.video.encoder.avc) in mediacodec process</span><br><span class="line">Line <span class="number">6014</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.170</span>   <span class="number">732</span>  <span class="number">2029</span> I OMX-VENC: Component_init : OMX.qcom.video.encoder.avc : <span class="keyword">return</span> = <span class="number">0x0</span></span><br><span class="line">Line <span class="number">6017</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.180</span>   <span class="number">732</span>  <span class="number">2168</span> E OMXNodeInstance: getParameter(<span class="number">2</span>dc0040:qcom.encoder.avc, ParamConsumerUsageBits(<span class="number">0x6f800004</span>)) ERROR: UnsupportedIndex(<span class="number">0x8000101a</span>)</span><br><span class="line">Line <span class="number">6019</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.181</span>   <span class="number">732</span>  <span class="number">1863</span> W OMXNodeInstance: [<span class="number">2</span>dc0040:qcom.encoder.avc] component does <span class="keyword">not</span> support metadata mode; <span class="keyword">using</span> fallback</span><br><span class="line">Line <span class="number">6020</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.181</span>   <span class="number">741</span>  <span class="number">6349</span> E ACodec  : [OMX.qcom.video.encoder.avc] storeMetaDataInBuffers (output) failed w/ err <span class="number">-1010</span></span><br><span class="line">Line <span class="number">6021</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.182</span>   <span class="number">741</span>  <span class="number">6349</span> I ExtendedACodec: setupVideoEncoder()</span><br><span class="line">Line <span class="number">6026</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.231</span>   <span class="number">741</span>  <span class="number">6349</span> I ACodec  : setupAVCEncoderParameters with [profile: Baseline] [level: Level1]</span><br><span class="line">Line <span class="number">6028</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.241</span>   <span class="number">732</span>  <span class="number">1863</span> E OMXNodeInstance: getConfig(<span class="number">2</span>dc0040:qcom.encoder.avc, ??(<span class="number">0x7f000062</span>)) ERROR: UnsupportedSetting(<span class="number">0x80001019</span>)</span><br><span class="line">Line <span class="number">6029</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.245</span>   <span class="number">741</span>  <span class="number">6349</span> I ACodec  : [OMX.qcom.video.encoder.avc] cannot encode HDR <span class="keyword">static</span> metadata. Ignoring.</span><br><span class="line">Line <span class="number">6030</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.245</span>   <span class="number">741</span>  <span class="number">6349</span> I ACodec  : setupVideoEncoder succeeded</span><br><span class="line">Line 6031: 07-03 11:43:45.245   741  6349 I ExtendedACodec: [OMX.qcom.video.encoder.avc] configure, AMessage : AMessage(what = 'conf', target = 75) = &#123;</span><br><span class="line">Line <span class="number">6044</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.245</span>   <span class="number">741</span>  <span class="number">6349</span> I ExtendedACodec:   <span class="keyword">int32_t</span> encoder = <span class="number">1</span></span><br><span class="line">Line <span class="number">6174</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.455</span>   <span class="number">732</span>  <span class="number">2169</span> I OMXMaster: makeComponentInstance(OMX.qcom.audio.encoder.aac) in mediacodec process</span><br><span class="line">Line <span class="number">6180</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.460</span>   <span class="number">732</span>  <span class="number">2169</span> E QC_AACENC:  component init: role = OMX.qcom.audio.encoder.aac</span><br><span class="line">Line <span class="number">6182</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.491</span>   <span class="number">732</span>   <span class="number">732</span> E OMXNodeInstance: setConfig(<span class="number">2</span>dc0041:qcom.encoder.aac, ConfigPriority(<span class="number">0x6f800002</span>)) ERROR: UnsupportedIndex(<span class="number">0x8000101a</span>)</span><br><span class="line">Line <span class="number">6184</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.502</span>   <span class="number">732</span>  <span class="number">2169</span> E OMXNodeInstance: setConfig(<span class="number">2</span>dc0041:qcom.encoder.aac, ConfigPriority(<span class="number">0x6f800002</span>)) ERROR: UnsupportedIndex(<span class="number">0x8000101a</span>)</span><br><span class="line">Line <span class="number">6193</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.537</span>   <span class="number">741</span>  <span class="number">6363</span> I CameraSource: Using encoder format: <span class="number">0x22</span></span><br><span class="line">Line <span class="number">6194</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">45.537</span>   <span class="number">741</span>  <span class="number">6363</span> I CameraSource: Using encoder data space: <span class="number">0x104</span></span><br><span class="line">Line <span class="number">7431</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">56.472</span>   <span class="number">741</span>  <span class="number">6347</span> I MediaCodecSource: encoder (video) stopping</span><br><span class="line">Line <span class="number">7456</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">56.611</span>   <span class="number">741</span>  <span class="number">6347</span> I MediaCodecSource: encoder (video) stopped</span><br><span class="line">Line <span class="number">7494</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">56.677</span>   <span class="number">741</span>  <span class="number">6347</span> I MediaCodecSource: encoder (audio) stopping</span><br><span class="line">Line <span class="number">7534</span>: <span class="number">07</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">43</span>:<span class="number">56.800</span>   <span class="number">741</span>  <span class="number">6347</span> I MediaCodecSource: encoder (audio) stopped</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆäº”ï¼‰ã€éŸ³è§†é¢‘æ··åˆMediaMuxeræºç åˆ†æ"><a href="#ï¼ˆäº”ï¼‰ã€éŸ³è§†é¢‘æ··åˆMediaMuxeræºç åˆ†æ" class="headerlink" title="ï¼ˆäº”ï¼‰ã€éŸ³è§†é¢‘æ··åˆMediaMuxeræºç åˆ†æ"></a>ï¼ˆäº”ï¼‰ã€éŸ³è§†é¢‘æ··åˆMediaMuxeræºç åˆ†æ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;MediaWriter&gt; mWriter;</span><br><span class="line">[-&gt;\android\frameworks\av\media\libstagefright\MediaMuxer.cpp]</span><br><span class="line"><span class="keyword">status_t</span> MediaMuxer::start() &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mMuxerLock)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (mState == INITIALIZED) &#123;</span><br><span class="line">        mState = STARTED;</span><br><span class="line">        mFileMeta-&gt;setInt32(kKeyRealTimeRecording, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> mWriter-&gt;start(mFileMeta.get());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGE(<span class="string">"start() is called in invalid state %d"</span>, mState);</span><br><span class="line">        <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…·ä½“è¿˜æ˜¯è°ƒç”¨çš„MediaWriterå®ç°çš„ã€‚æˆ‘ä»¬æ¥åˆ†æå…·ä½“å®ä¾‹ï¼šMPEG4Writer.cppï¼Œå³MP4æ–‡ä»¶çš„æ ¼å¼å°è£…è¿‡ç¨‹ã€‚</p><p>1)       å½•åˆ¶å¼€å§‹æ—¶ï¼Œå†™å…¥æ–‡ä»¶å¤´éƒ¨ã€‚</p><p>2)       å½•åˆ¶è¿›è¡Œæ—¶ï¼Œå®æ—¶å†™å…¥éŸ³è§†é¢‘è½¨è¿¹çš„æ•°æ®å—ã€‚</p><p>3)       å½•åˆ¶ç»“æŸæ—¶ï¼Œå†™å…¥ç´¢å¼•ä¿¡æ¯å¹¶æ›´æ–°å¤´éƒ¨å‚æ•°ã€‚</p><p>  ç´¢å¼•è´Ÿè´£æè¿°éŸ³è§†é¢‘è½¨è¿¹çš„ç‰¹å¾ï¼Œä¼šéšç€éŸ³è§†é¢‘è½¨è¿¹çš„å­˜å‚¨è€Œå˜åŒ–ï¼Œæ‰€ä»¥é€šå¸¸åšæ³•ä¼šå°†å½•åƒæ–‡ä»¶ç´¢å¼•ä¿¡æ¯æ”¾åœ¨éŸ³è§†é¢‘è½¨è¿¹æµåé¢ï¼Œåœ¨åª’ä½“æµæ•°æ®å†™å®Œï¼ˆå½•åƒç»“æŸï¼‰åæ‰èƒ½å†™å…¥ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå­˜æ”¾éŸ³è§†é¢‘æ•°æ®çš„mdat boxæ˜¯ä½äºç¬¬äºŒä½çš„ï¼Œè€Œè´Ÿè´£æ£€ç´¢éŸ³è§†é¢‘çš„moov boxæ˜¯ä½äºæœ€åçš„ï¼Œè¿™ä¸é€šå¸¸çš„MP4å°è£…çš„æ’åˆ—é¡ºåºä¸åŒï¼Œå½“ç„¶è¿™æ˜¯ä¸ºäº†ç¬¦åˆå½•åˆ¶è€Œäº§ç”Ÿçš„ç»“æœã€‚å› ä¸º moovçš„å¤§å°æ˜¯éšç€ mdat å˜åŒ–çš„ï¼Œè€Œæˆ‘ä»¬å½•åˆ¶è§†é¢‘çš„æ—¶é—´é¢„å…ˆæ˜¯ä¸çŸ¥é“çš„ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°†mdat æ•°æ®å†™å…¥ï¼Œæœ€åå†å†™å…¥moovï¼Œå®Œæˆå°è£…ã€‚ </p><p>  ç°æœ‰Androidç³»ç»Ÿä¸Šå½•åƒéƒ½æ˜¯å½•åˆ¶æ˜¯MP4æˆ–3GPæ ¼å¼ï¼Œåº•å±‚å°±æ˜¯ä½¿ç”¨MPEG4Writerç»„åˆå™¨ç±»æ¥å®Œæˆçš„ï¼Œå®ƒå°†ç¼–ç åçš„éŸ³è§†é¢‘è½¨è¿¹æŒ‰ç…§MPEG4è§„èŒƒè¿›è¡Œå°è£…ï¼Œå¡«å…¥å„ä¸ªå‚æ•°ï¼Œå°±ç»„åˆæˆå®Œæ•´çš„MP4æ ¼å¼æ–‡ä»¶ã€‚MPEG4Writerçš„ç»„åˆåŠŸèƒ½ä¸»è¦ç”±ä¸¤ç§çº¿ç¨‹å®Œæˆï¼Œä¸€ç§æ˜¯è´Ÿè´£éŸ³è§†é¢‘æ•°æ®å†™å…¥å°è£…æ–‡ä»¶çš„å†™çº¿ç¨‹ï¼ˆWriterThreadï¼‰ï¼Œä¸€ç§æ˜¯éŸ³è§†é¢‘æ•°æ®è¯»å–å¤„ç†çš„è½¨è¿¹çº¿ç¨‹ï¼ˆTrackThreadï¼‰ã€‚è½¨è¿¹çº¿ç¨‹ä¸€èˆ¬æœ‰ä¸¤ä¸ªï¼šè§†é¢‘è½¨è¿¹æ•°æ®è¯»å–çº¿ç¨‹å’ŒéŸ³é¢‘è½¨è¿¹æ•°æ®è¯»å–çº¿ç¨‹ï¼Œè€Œå†™çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œè´Ÿè´£å°†è½¨è¿¹çº¿ç¨‹ä¸­æ‰“åŒ…æˆChunkçš„æ•°æ®å†™å…¥å°è£…æ–‡ä»¶ã€‚</p><p>  å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè½¨è¿¹çº¿ç¨‹æ˜¯ä»¥å¸§ä¸ºå•ä½è·å–æ•°æ®å¸§ï¼ˆSampleï¼‰ï¼Œå¹¶å°†æ¯å¸§ä¸­çš„ä¿¡æ¯åŠç³»ç»Ÿç¯å¢ƒä¿¡æ¯æå–æ±‡æ€»å­˜å‚¨åœ¨å†…å­˜çš„trakè¡¨ä¸­ï¼Œå…¶ä¸­éœ€è¦ç»´æŒçš„ä¿¡æ¯æœ‰Chunkå†™å…¥æ–‡ä»¶çš„åç§»åœ°å€Stcoï¼ˆChunk Offsetï¼‰ã€Sampleä¸Chunkçš„æ˜ å°„å…³ç³»Stscï¼ˆSample-to-Chunkï¼‰ã€å…³é”®å¸§Stssï¼ˆSync Sampleï¼‰ã€æ¯ä¸€å¸§çš„æŒç»­æ—¶é—´Sttsï¼ˆTime-to-Sampleï¼‰ç­‰ï¼Œè¿™äº›ä¿¡æ¯æ˜¯è·Ÿæ¯ä¸€å¸§çš„ä¿¡æ¯å¯†åˆ‡ç›¸å…³çš„ï¼Œç”±å›¾å¯ä»¥çœ‹å‡ºtrakè¡¨ç”±å„è‡ªçš„çº¿ç¨‹ç»´æŠ¤ï¼Œå½“å½•åƒç»“æŸæ—¶trakè¡¨ä¼šå°±ä¼šå†™å…¥å°è£…æ–‡ä»¶ã€‚è€Œæ¯ä¸€å¸§çš„æ•°æ®æµä¼šå…ˆå­˜å…¥ä¸€ä¸ªé“¾è¡¨ç¼“å­˜ä¸­ï¼Œå½“å¸§çš„æ•°é‡è¾¾åˆ°ä¸€å®šå€¼æ—¶ï¼Œè½¨è¿¹çº¿ç¨‹ä¼šå°†è¿™äº›å¸§æ•°æ®æ‰“åŒ…æˆå—ï¼ˆChunkï¼‰å¹¶é€šçŸ¥å†™çº¿ç¨‹å†™å…¥åˆ°å°è£…æ–‡ä»¶ã€‚å†™çº¿ç¨‹æ¥åˆ°Chunkå·²å‡†å¤‡å¥½çš„é€šçŸ¥åå°±é©¬ä¸Šæœç´¢Chunké“¾è¡¨ï¼ˆé“¾è¡¨ä¸ªæ•°ä¸è½¨è¿¹çº¿ç¨‹ä¸ªæ•°ç›¸å…³ï¼Œä¸€èˆ¬æœ‰ä¸¤ä¸ªï¼ŒéŸ³è§†é¢‘è½¨è¿¹çº¿ç¨‹å„æœ‰ä¸€ä¸ªï¼‰ï¼Œå°†æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªChunkåä¾¿å†™å…¥å°è£…æ–‡ä»¶ï¼Œå¹¶ä¼šå°†å†™å…¥çš„åç§»åœ°å€æ›´æ–°åˆ°ç›¸åº”çš„trakè¡¨çš„Stcoé¡¹ï¼ˆä½†trakè¡¨ä¸­å…¶å®ƒæ•°æ®æ˜¯ç”±è½¨è¿¹çº¿ç¨‹æ›´æ–°ï¼‰ã€‚éŸ³è§†é¢‘çš„Chunkæ•°æ®æ˜¯å­˜å‚¨äºåŒä¸€mdat boxä¸­ï¼ŒæŒ‰æ·»åŠ åˆ°Chunké“¾è¡¨æ—¶é—´å…ˆåé¡ºåºæ’åˆ—ã€‚ç­‰åˆ°å½•åƒç»“æŸæ—¶ï¼Œå½•åƒåº”ç”¨ä¼šè°ƒç”¨MPEG4Writerçš„stopæ–¹æ³•ï¼Œæ­¤æ—¶å°±ä¼šå°†éŸ³è§†é¢‘çš„trakè¡¨åˆ†åˆ«å†™å…¥moovã€‚</p><p>  <img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-03-03-MPEG4Writer.png" alt="Alt text"></p><p> å…¶å®çœ‹å®Œä¸Šé¢çš„å†…å®¹ï¼Œåº”è¯¥å¯¹Androidå½•åˆ¶è§†é¢‘è¿‡ç¨‹ä¸­ï¼Œå½•åˆ¶çš„è§†é¢‘çš„å°è£…è¿‡ç¨‹æœ‰ä¸€ä¸ªå¤§ä½“äº†è§£ï¼Œæˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„è§†é¢‘åç¼€å.mp4/.mkvç­‰ç­‰å°±æ˜¯è§†é¢‘å°è£…çš„å„ç§æ ¼å¼ã€‚<br>å…ˆçœ‹çœ‹æ„é€ å‡½æ•°ï¼šåœ¨è¿™é‡Œå°†å®ç°ä¸€äº›å‚æ•°çš„åˆå§‹åŒ–ï¼Œfdæ˜¯ä¼ è¿›æ¥çš„å½•åˆ¶æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\android\frameworks\av\media\libstagefright\MPEG4Writer.cpp]</span><br><span class="line">MPEG4Writer::MPEG4Writer(<span class="keyword">int</span> fd)</span><br><span class="line">    : mFd(dup(fd)),</span><br><span class="line">      mInitCheck(mFd &lt; <span class="number">0</span>? NO_INIT: OK),</span><br><span class="line">      mIsRealTimeRecording(<span class="literal">true</span>),</span><br><span class="line">      mUse4ByteNalLength(<span class="literal">true</span>),</span><br><span class="line">      mUse32BitOffset(<span class="literal">true</span>),</span><br><span class="line">      mIsFileSizeLimitExplicitlyRequested(<span class="literal">false</span>),</span><br><span class="line">      mPaused(<span class="literal">false</span>),</span><br><span class="line">      mStarted(<span class="literal">false</span>),</span><br><span class="line">      mWriterThreadStarted(<span class="literal">false</span>),</span><br><span class="line">      mOffset(<span class="number">0</span>),</span><br><span class="line">      mMdatOffset(<span class="number">0</span>),</span><br><span class="line">      mMoovBoxBuffer(<span class="literal">NULL</span>),</span><br><span class="line">      mMoovBoxBufferOffset(<span class="number">0</span>),</span><br><span class="line">      mWriteMoovBoxToMemory(<span class="literal">false</span>),</span><br><span class="line">      mFreeBoxOffset(<span class="number">0</span>),</span><br><span class="line">      mStreamableFile(<span class="literal">false</span>),</span><br><span class="line">      mEstimatedMoovBoxSize(<span class="number">0</span>),</span><br><span class="line">      mMoovExtraSize(<span class="number">0</span>),</span><br><span class="line">      mInterleaveDurationUs(<span class="number">1000000</span>),</span><br><span class="line">      mTimeScale(<span class="number">-1</span>),</span><br><span class="line">      mStartTimestampUs(<span class="number">-1l</span>l),</span><br><span class="line">      mLatitudex10000(<span class="number">0</span>),</span><br><span class="line">      mLongitudex10000(<span class="number">0</span>),</span><br><span class="line">      mAreGeoTagsAvailable(<span class="literal">false</span>),</span><br><span class="line">      mStartTimeOffsetMs(<span class="number">-1</span>),</span><br><span class="line">      mMetaKeys(<span class="keyword">new</span> AMessage()),</span><br><span class="line">      mIsAudioAMR(<span class="literal">false</span>) &#123;</span><br><span class="line">    addDeviceMeta();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify mFd is seekable</span></span><br><span class="line">    <span class="keyword">off64_t</span> off = lseek64(mFd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    <span class="keyword">if</span> (off &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"cannot seek mFd: %s (%d)"</span>, strerror(errno), errno);</span><br><span class="line">        release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ä» MPEG4Writer.cpp çš„start()å‡½æ•°å¼€å§‹ï¼š<br>åœ¨startéƒ¨åˆ†ï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨è¿™ä¸€éƒ¨åˆ†ï¼ŒwriteFtypBox(param) å°†å®ç°å½•åˆ¶æ–‡ä»¶æ–‡ä»¶å¤´éƒ¨ä¿¡æ¯çš„ç›¸å…³ä¿¡æ¯çš„å†™å…¥æ“ä½œï¼›startWriterThread() å¼€å¯å°è£…è§†é¢‘æ–‡ä»¶çš„å†™çº¿ç¨‹ï¼›startTracks(param) å¼€å¯è§†é¢‘æ•°æ®çš„è¯»çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯å‰é¢æ–‡ä»¶éƒ¨åˆ†æ‰€è¯´çš„è½¨è¿¹çº¿ç¨‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">status_t MPEG4Writer::start(MetaData *param) &#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    if (mStarted) &#123;</span><br><span class="line">        if (mPaused) &#123;</span><br><span class="line">            mPaused = false;</span><br><span class="line">            return startTracks(param);</span><br><span class="line">        &#125;</span><br><span class="line">        return OK;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    mWriteMoovBoxToMemory = false;</span><br><span class="line">    mMoovBoxBuffer = NULL;</span><br><span class="line">    mMoovBoxBufferOffset = 0;</span><br><span class="line"></span><br><span class="line">    writeFtypBox(param);</span><br><span class="line"></span><br><span class="line">    mFreeBoxOffset = mOffset;</span><br><span class="line"></span><br><span class="line">    if (mEstimatedMoovBoxSize == 0) &#123;</span><br><span class="line">        int32_t bitRate = -1;</span><br><span class="line">        if (param) &#123;</span><br><span class="line">            param-&gt;findInt32(kKeyBitRate, &amp;bitRate);</span><br><span class="line">        &#125;</span><br><span class="line">        mEstimatedMoovBoxSize = estimateMoovBoxSize(bitRate);</span><br><span class="line">    &#125;</span><br><span class="line">    CHECK_GE(mEstimatedMoovBoxSize, 8);</span><br><span class="line">    if (mStreamableFile) &#123;</span><br><span class="line">        // Reserve a &apos;free&apos; box only for streamable file</span><br><span class="line">        lseek64(mFd, mFreeBoxOffset, SEEK_SET);</span><br><span class="line">        writeInt32(mEstimatedMoovBoxSize);</span><br><span class="line">        write(&quot;free&quot;, 4);</span><br><span class="line">        mMdatOffset = mFreeBoxOffset + mEstimatedMoovBoxSize;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mMdatOffset = mOffset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mOffset = mMdatOffset;</span><br><span class="line">    lseek64(mFd, mMdatOffset, SEEK_SET);</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    status_t err = startWriterThread();</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    err = startTracks(param);</span><br><span class="line">   ......</span><br><span class="line">    mStarted = true;</span><br><span class="line">    return OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  ç»§ç»­çœ‹ä¸‹ startWriterThreadï¼ˆï¼‰éƒ¨åˆ†ï¼Œåœ¨startWriterThreadï¼ˆï¼‰å‡½æ•°ä¸­ï¼Œå°†çœŸæ­£å»ºç«‹æ–°çš„å­çº¿ç¨‹ï¼Œå¹¶åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡ŒThreadWrappeå‡½æ•°ä¸­çš„æ“ä½œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> MPEG4Writer::startWriterThread() &#123;</span><br><span class="line">    ALOGV(<span class="string">"startWriterThread"</span>);</span><br><span class="line"></span><br><span class="line">    mDone = <span class="literal">false</span>;</span><br><span class="line">    mIsFirstChunk = <span class="literal">true</span>;</span><br><span class="line">    mDriftTimeUs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (List&lt;Track *&gt;::iterator it = mTracks.begin();</span><br><span class="line">         it != mTracks.end(); ++it) &#123;</span><br><span class="line">        ChunkInfo info;</span><br><span class="line">        info.mTrack = *it;</span><br><span class="line">        info.mPrevChunkTimestampUs = <span class="number">0</span>;</span><br><span class="line">        info.mMaxInterChunkDurUs = <span class="number">0</span>;</span><br><span class="line">        mChunkInfos.push_back(info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_attr_t</span> attr;</span><br><span class="line">    pthread_attr_init(&amp;attr);</span><br><span class="line">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_JOINABLE);</span><br><span class="line">    pthread_create(&amp;mThread, &amp;attr, ThreadWrapper, <span class="keyword">this</span>);</span><br><span class="line">    pthread_attr_destroy(&amp;attr);</span><br><span class="line">    mWriterThreadStarted = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ç»§ç»­çœ‹ ThreadWrapperï¼ˆï¼‰å‡½æ•°,åœ¨è¿™é‡Œnew äº†ä¸€ä¸ªMPEGWriterå¯¹è±¡ï¼ŒçœŸæ­£çš„æ“ä½œåœ¨threadFunc()ä¸­ä½“ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *MPEG4Writer::ThreadWrapper(<span class="keyword">void</span> *me) &#123;</span><br><span class="line">    ALOGV(<span class="string">"ThreadWrapper: %p"</span>, me);</span><br><span class="line">    MPEG4Writer *writer = <span class="keyword">static_cast</span>&lt;MPEG4Writer *&gt;(me);</span><br><span class="line">    writer-&gt;threadFunc();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹threadFun()ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå°†æ ¹æ®å˜é‡mDone è¿›è¡Œwhileå¾ªç¯ï¼Œä¸€ç›´æ£€æµ‹æ˜¯å¦æœ‰æ•°æ®å—Chunkå¯å†™ã€‚è½¨è¿¹çº¿ç¨‹æ˜¯ä¸€ç›´å°†è¯»æ•°æ®çš„æ•°æ®å¾€bufferä¸­å†™å…¥ï¼Œbufferåˆ°äº†ä¸€å®šé‡åï¼Œå°±æ˜¯chunk,è¿™æ—¶å°±ä¼šé€šè¿‡ä¿¡å·é‡ mChunkReadyConditionæ¥é€šçŸ¥å°è£…æ–‡ä»¶çš„å†™çº¿ç¨‹å»æ£€æµ‹é“¾è¡¨ï¼Œç„¶åå°†æ£€ç´¢åˆ°çš„Chunkæ•°æ®å†™å…¥æ–‡ä»¶çš„æ•°æ®åŒºï¼Œå½“ç„¶å†™ä¹‹å‰ï¼Œè‚¯å®šä¼šå»åˆ¤æ–­ä¸‹æ˜¯å¦çœŸçš„æœ‰æ•°æ®å¯å†™ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MPEG4Writer::threadFunc() &#123;</span><br><span class="line">    ALOGV(<span class="string">"threadFunc"</span>);</span><br><span class="line"></span><br><span class="line">    prctl(PR_SET_NAME, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="string">"MPEG4Writer"</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (!mDone) &#123;</span><br><span class="line">        Chunk chunk;</span><br><span class="line">        <span class="keyword">bool</span> chunkFound = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mDone &amp;&amp; !(chunkFound = findChunkToWrite(&amp;chunk))) &#123;</span><br><span class="line">            mChunkReadyCondition.wait(mLock);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (chunkFound) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mIsRealTimeRecording) &#123;</span><br><span class="line">                mLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            writeChunkToFile(&amp;chunk);</span><br><span class="line">            <span class="keyword">if</span> (mIsRealTimeRecording) &#123;</span><br><span class="line">                mLock.lock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    writeAllChunks();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ä¸‹é¢çœ‹ä¸‹writerChunkToFile(&amp;chunk);è½¨è¿¹çº¿ç¨‹è¯»æ•°æ®æ—¶æ˜¯ä»¥æ•°æ®å¸§Sampleä¸ºå•ä½ï¼Œæ‰€ä»¥è¿™é‡Œå°†Chunkå†™å…¥å°è£…æ–‡ä»¶ï¼Œä¹Ÿæ˜¯ä»¥Sampleä¸ºå•ä½ï¼Œéå†æ•´ä¸ªé“¾è¡¨ï¼Œå°†æ•°æ®å†™å…¥å°è£…æ–‡ä»¶ï¼ŒçœŸæ­£çš„å†™å…¥æ“ä½œæ˜¯addSamole_l(*it);</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MPEG4Writer::writeAllChunks() &#123;</span><br><span class="line">    ALOGV(<span class="string">"writeAllChunks"</span>);</span><br><span class="line">    <span class="keyword">size_t</span> outstandingChunks = <span class="number">0</span>;</span><br><span class="line">    Chunk chunk;</span><br><span class="line">    <span class="keyword">while</span> (findChunkToWrite(&amp;chunk)) &#123;</span><br><span class="line">        writeChunkToFile(&amp;chunk);</span><br><span class="line">        ++outstandingChunks;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sendSessionSummary();</span><br><span class="line"></span><br><span class="line">    mChunkInfos.clear();</span><br><span class="line">    ALOGD(<span class="string">"%zu chunks are written in the last batch"</span>, outstandingChunks);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> MPEG4Writer::writeChunkToFile(Chunk* chunk) &#123;</span><br><span class="line">    ALOGV(<span class="string">"writeChunkToFile: %"</span> PRId64 <span class="string">" from %s track"</span>,</span><br><span class="line">        chunk-&gt;mTimeStampUs, chunk-&gt;mTrack-&gt;isAudio()? <span class="string">"audio"</span>: <span class="string">"video"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> isFirstSample = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (!chunk-&gt;mSamples.empty()) &#123;</span><br><span class="line">        List&lt;MediaBuffer *&gt;::iterator it = chunk-&gt;mSamples.begin();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">off64_t</span> offset = (chunk-&gt;mTrack-&gt;isAvc() || chunk-&gt;mTrack-&gt;isHevc())</span><br><span class="line">                                ? addMultipleLengthPrefixedSamples_l(*it)</span><br><span class="line">                                : addSample_l(*it);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isFirstSample) &#123;</span><br><span class="line">            chunk-&gt;mTrack-&gt;addChunkOffset(offset);</span><br><span class="line">            isFirstSample = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        (*it)-&gt;release();</span><br><span class="line">        (*it) = <span class="literal">NULL</span>;</span><br><span class="line">        chunk-&gt;mSamples.erase(it);</span><br><span class="line">    &#125;</span><br><span class="line">    chunk-&gt;mSamples.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  ä¸‹é¢çœ‹ä¸‹addSamole_l(*it) å‡½æ•°ï¼Œwirteå†™å…¥æ“ä½œï¼ŒmFd æ˜¯ä¸Šå±‚è®¾ç½®å½•åˆ¶çš„æ–‡ä»¶è·¯å¾„ä¼ ä¸‹æ¥çš„æ–‡ä»¶æè¿°ç¬¦</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">off64_t</span> MPEG4Writer::addSample_l(MediaBuffer *buffer) &#123;</span><br><span class="line">    <span class="keyword">off64_t</span> old_offset = mOffset;</span><br><span class="line"></span><br><span class="line">    ::write(mFd,</span><br><span class="line">          (<span class="keyword">const</span> <span class="keyword">uint8_t</span> *)buffer-&gt;data() + buffer-&gt;range_offset(),</span><br><span class="line">          buffer-&gt;range_length());</span><br><span class="line"></span><br><span class="line">    mOffset += buffer-&gt;range_length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> old_offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  åˆ°æ­¤ï¼Œå°è£…æ–‡ä»¶çš„å†™å…¥çº¿ç¨‹çš„æ“ä½œå¤§ä½“èµ°å®Œï¼Œä¸‹é¢çœ‹è½¨è¿¹çº¿ç¨‹çš„æ“ä½œã€‚</p><hr><p>   startTracks(param) è½¨è¿¹çº¿ç¨‹çš„å¼€å¯ã€‚æ–‡ä»¶çš„å½•åˆ¶è¿‡ç¨‹ä¸­æ˜¯æœ‰2æ¡è½¨è¿¹çº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯è§†é¢‘çš„è½¨è¿¹çº¿ç¨‹ï¼Œå¦ä¸€æ¡åˆ™æ˜¯éŸ³é¢‘çš„è½¨è¿¹çº¿ç¨‹ï¼Œåœ¨starTrackï¼ˆparamï¼‰ä¸­æ˜¯åœ¨for å¾ªç¯ä¸­startäº†ä¸¤æ¡è½¨è¿¹çº¿ç¨‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> MPEG4Writer::startTracks(MetaData *params) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mTracks.empty()) &#123;</span><br><span class="line">        ALOGE(<span class="string">"No source added"</span>);</span><br><span class="line">        <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (List&lt;Track *&gt;::iterator it = mTracks.begin();</span><br><span class="line">         it != mTracks.end(); ++it) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> err = (*it)-&gt;start(params);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="keyword">for</span> (List&lt;Track *&gt;::iterator it2 = mTracks.begin();</span><br><span class="line">                 it2 != it; ++it2) &#123;</span><br><span class="line">                (*it2)-&gt;stop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ<em>it)-&gt;start(params) å°†ä¼šæ‰§è¡Œstatus_t MPEG4Writer::Track::start(MetaData </em>params) {} ã€‚åœ¨è¿™è¾¹ä¹Ÿæ˜¯åŒæ ·æ–°å»ºå­çº¿ç¨‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œè½¨è¿¹çº¿ç¨‹çš„ç›¸åº”æ“ä½œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> MPEG4Writer::Track::start(MetaData *params) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> startTimeUs;</span><br><span class="line">    ......</span><br><span class="line">    mStartTimeRealUs = startTimeUs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> rotationDegrees;</span><br><span class="line">    ......</span><br><span class="line">    initTrackingProgressStatus(params);</span><br><span class="line"></span><br><span class="line">    sp&lt;MetaData&gt; meta = <span class="keyword">new</span> MetaData;</span><br><span class="line">    <span class="keyword">if</span> (mOwner-&gt;isRealTimeRecording() &amp;&amp; mOwner-&gt;numTracks() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> startTimeOffsetUs = mOwner-&gt;getStartTimeOffsetMs() * <span class="number">1000L</span>L;</span><br><span class="line">        <span class="keyword">if</span> (startTimeOffsetUs &lt; <span class="number">0</span>) &#123;  <span class="comment">// Start time offset was not set</span></span><br><span class="line">            startTimeOffsetUs = kInitialDelayTimeUs;</span><br><span class="line">        &#125;</span><br><span class="line">        startTimeUs += startTimeOffsetUs;</span><br><span class="line">        ALOGI(<span class="string">"Start time offset: %"</span> PRId64 <span class="string">" us"</span>, startTimeOffsetUs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    meta-&gt;setInt64(kKeyTime, startTimeUs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = mSource-&gt;start(meta.get());</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_attr_t</span> attr;</span><br><span class="line">    pthread_attr_init(&amp;attr);</span><br><span class="line">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_JOINABLE);</span><br><span class="line"></span><br><span class="line">    mDone = <span class="literal">false</span>;</span><br><span class="line">    mStarted = <span class="literal">true</span>;</span><br><span class="line">    mTrackDurationUs = <span class="number">0</span>;</span><br><span class="line">    mReachedEOS = <span class="literal">false</span>;</span><br><span class="line">    mEstimatedTrackSizeBytes = <span class="number">0</span>;</span><br><span class="line">    mMdatSizeBytes = <span class="number">0</span>;</span><br><span class="line">    mMaxChunkDurationUs = <span class="number">0</span>;</span><br><span class="line">    mLastDecodingTimeUs = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;mThread, &amp;attr, ThreadWrapper, <span class="keyword">this</span>);</span><br><span class="line">    pthread_attr_destroy(&amp;attr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹ä¸Šé¢ThreadWrapperå‡½æ•°,çœŸæ­£çš„æ“ä½œåˆæ˜¯æ”¾åˆ°äº†threadEntry()ä¸­å»æ‰§è¡Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *MPEG4Writer::Track::ThreadWrapper(<span class="keyword">void</span> *me) &#123;</span><br><span class="line"> </span><br><span class="line">    Track *track = <span class="keyword">static_cast</span>&lt;Track *&gt;(me);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">status_t</span> err = track-&gt;threadEntry();</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *) err;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">status_t</span> MPEG4Writer::Track::threadEntry() &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int64_t</span> interleaveDurationUs = mOwner-&gt;interleaveDuration();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> hasMultipleTracks = (mOwner-&gt;numTracks() &gt; <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int64_t</span> chunkTimestampUs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> nChunks = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> nActualFrames = <span class="number">0</span>;        <span class="comment">// frames containing non-CSD data (non-0 length)</span></span><br><span class="line">    <span class="keyword">int32_t</span> nZeroLengthFrames = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> lastTimestampUs = <span class="number">0</span>;      <span class="comment">// Previous sample time stamp</span></span><br><span class="line">    <span class="keyword">int64_t</span> lastDurationUs = <span class="number">0</span>;       <span class="comment">// Between the previous two samples</span></span><br><span class="line">    <span class="keyword">int64_t</span> currDurationTicks = <span class="number">0</span>;    <span class="comment">// Timescale based ticks</span></span><br><span class="line">    <span class="keyword">int64_t</span> lastDurationTicks = <span class="number">0</span>;    <span class="comment">// Timescale based ticks</span></span><br><span class="line">    <span class="keyword">int32_t</span> sampleCount = <span class="number">1</span>;          <span class="comment">// Sample count in the current stts table entry</span></span><br><span class="line">    <span class="keyword">uint32_t</span> previousSampleSize = <span class="number">0</span>;  <span class="comment">// Size of the previous sample</span></span><br><span class="line">    <span class="keyword">int64_t</span> previousPausedDurationUs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> timestampUs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> cttsOffsetTimeUs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> currCttsOffsetTimeTicks = <span class="number">0</span>;   <span class="comment">// Timescale based ticks</span></span><br><span class="line">    <span class="keyword">int64_t</span> lastCttsOffsetTimeTicks = <span class="number">-1</span>;  <span class="comment">// Timescale based ticks</span></span><br><span class="line">    <span class="keyword">int32_t</span> cttsSampleCount = <span class="number">0</span>;           <span class="comment">// Sample count in the current ctts table entry</span></span><br><span class="line">    <span class="keyword">uint32_t</span> lastSamplesPerChunk = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsAudio) &#123;</span><br><span class="line">        prctl(PR_SET_NAME, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="string">"AudioTrackEncoding"</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        prctl(PR_SET_NAME, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="string">"VideoTrackEncoding"</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mOwner-&gt;isRealTimeRecording()) &#123;</span><br><span class="line">        androidSetThreadPriority(<span class="number">0</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;MetaData&gt; meta_data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = OK;</span><br><span class="line">    MediaBuffer *buffer;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *trackName = mIsAudio ? <span class="string">"Audio"</span> : <span class="string">"Video"</span>;</span><br><span class="line">    <span class="keyword">while</span> (!mDone &amp;&amp; (err = mSource-&gt;read(&amp;buffer)) == OK) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buffer-&gt;range_length() == <span class="number">0</span>) &#123;</span><br><span class="line">            buffer-&gt;release();</span><br><span class="line">            buffer = <span class="literal">NULL</span>;</span><br><span class="line">            ++nZeroLengthFrames;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the codec specific data has not been received yet, delay pause.</span></span><br><span class="line">        <span class="comment">// After the codec specific data is received, discard what we received</span></span><br><span class="line">        <span class="comment">// when the track is to be paused.</span></span><br><span class="line">        <span class="keyword">if</span> (mPaused &amp;&amp; !mResumed) &#123;</span><br><span class="line">            buffer-&gt;release();</span><br><span class="line">            buffer = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ++count;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int32_t</span> isCodecConfig;</span><br><span class="line">        <span class="keyword">if</span> (buffer-&gt;meta_data()-&gt;findInt32(kKeyIsCodecConfig, &amp;isCodecConfig)</span><br><span class="line">                &amp;&amp; isCodecConfig) &#123;</span><br><span class="line">            <span class="comment">// if config format (at track addition) already had CSD, keep that</span></span><br><span class="line">            <span class="comment">// UNLESS we have not received any frames yet.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> for now the entire CSD has to come in one frame for encoders, even though</span></span><br><span class="line">            <span class="comment">// they need to be spread out for decoders.</span></span><br><span class="line">            <span class="keyword">if</span> (mGotAllCodecSpecificData &amp;&amp; nActualFrames &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGI(<span class="string">"ignoring additional CSD for video track after first frame"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mMeta = mSource-&gt;getFormat(); <span class="comment">// get output format after format change</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mIsAvc) &#123;</span><br><span class="line">                    <span class="keyword">status_t</span> err = makeAVCCodecSpecificData(</span><br><span class="line">                            (<span class="keyword">const</span> <span class="keyword">uint8_t</span> *)buffer-&gt;data()</span><br><span class="line">                                + buffer-&gt;range_offset(),</span><br><span class="line">                            buffer-&gt;range_length());</span><br><span class="line">                    CHECK_EQ((<span class="keyword">status_t</span>)OK, err);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mIsHevc) &#123;</span><br><span class="line">                    <span class="keyword">status_t</span> err = makeHEVCCodecSpecificData(</span><br><span class="line">                            (<span class="keyword">const</span> <span class="keyword">uint8_t</span> *)buffer-&gt;data()</span><br><span class="line">                                + buffer-&gt;range_offset(),</span><br><span class="line">                            buffer-&gt;range_length());</span><br><span class="line">                    CHECK_EQ((<span class="keyword">status_t</span>)OK, err);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mIsMPEG4) &#123;</span><br><span class="line">                    copyCodecSpecificData((<span class="keyword">const</span> <span class="keyword">uint8_t</span> *)buffer-&gt;data() + buffer-&gt;range_offset(),</span><br><span class="line">                            buffer-&gt;range_length());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mIsAudio) &#123;</span><br><span class="line">                <span class="keyword">int32_t</span> fps;</span><br><span class="line">                mMeta-&gt;findInt32(kKeyFrameRate, &amp;fps);</span><br><span class="line">                <span class="keyword">int64_t</span> cttsOffsetTimeUs = <span class="number">1000000L</span>L/fps;</span><br><span class="line">                mCttsOffsetTimeUs = cttsOffsetTimeUs + kMinCttsOffsetTimeUs; <span class="comment">//delta factor</span></span><br><span class="line">            &#125;</span><br><span class="line">            buffer-&gt;release();</span><br><span class="line">            buffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            mGotAllCodecSpecificData = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ++nActualFrames;</span><br><span class="line"></span><br><span class="line">        MediaBuffer *copy = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// Check if the upstream source hints it is OK to hold on to the</span></span><br><span class="line">        <span class="comment">// buffer without releasing immediately and avoid cloning the buffer</span></span><br><span class="line">        <span class="keyword">if</span> (AVUtils::get()-&gt;canDeferRelease(buffer-&gt;meta_data())) &#123;</span><br><span class="line">            copy = buffer;</span><br><span class="line">            meta_data = <span class="keyword">new</span> MetaData(*buffer-&gt;meta_data().get());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Make a deep copy of the MediaBuffer and Metadata and release</span></span><br><span class="line">            <span class="comment">// the original as soon as we can</span></span><br><span class="line">            copy = <span class="keyword">new</span> MediaBuffer(buffer-&gt;range_length());</span><br><span class="line">            <span class="built_in">memcpy</span>(copy-&gt;data(), (<span class="keyword">uint8_t</span> *)buffer-&gt;data() + buffer-&gt;range_offset(),</span><br><span class="line">                    buffer-&gt;range_length());</span><br><span class="line">            copy-&gt;set_range(<span class="number">0</span>, buffer-&gt;range_length());</span><br><span class="line">            meta_data = <span class="keyword">new</span> MetaData(*buffer-&gt;meta_data().get());</span><br><span class="line">            buffer-&gt;release();</span><br><span class="line">            buffer = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mIsAvc || mIsHevc) StripStartcode(copy);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">size_t</span> sampleSize = copy-&gt;range_length();</span><br><span class="line">        <span class="keyword">if</span> (mIsAvc || mIsHevc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mOwner-&gt;useNalLengthFour()) &#123;</span><br><span class="line">                sampleSize += <span class="number">4</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sampleSize += <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Max file size or duration handling</span></span><br><span class="line">        mMdatSizeBytes += sampleSize;</span><br><span class="line">        updateTrackSizeEstimate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mOwner-&gt;exceedsFileSizeLimit()) &#123;</span><br><span class="line">            ALOGW(<span class="string">"Recorded file size exceeds limit %"</span> PRId64 <span class="string">"bytes"</span>,</span><br><span class="line">                    mOwner-&gt;mMaxFileSizeLimitBytes);</span><br><span class="line">            mOwner-&gt;notify(MEDIA_RECORDER_EVENT_INFO, MEDIA_RECORDER_INFO_MAX_FILESIZE_REACHED, <span class="number">0</span>);</span><br><span class="line">            copy-&gt;release();</span><br><span class="line">            mSource-&gt;stop();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mOwner-&gt;exceedsFileDurationLimit()) &#123;</span><br><span class="line">            ALOGW(<span class="string">"Recorded file duration exceeds limit %"</span> PRId64 <span class="string">"microseconds"</span>,</span><br><span class="line">                    mOwner-&gt;mMaxFileDurationLimitUs);</span><br><span class="line">            mOwner-&gt;notify(MEDIA_RECORDER_EVENT_INFO, MEDIA_RECORDER_INFO_MAX_DURATION_REACHED, <span class="number">0</span>);</span><br><span class="line">            copy-&gt;release();</span><br><span class="line">            mSource-&gt;stop();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int32_t</span> isSync = <span class="literal">false</span>;</span><br><span class="line">        meta_data-&gt;findInt32(kKeyIsSyncFrame, &amp;isSync);</span><br><span class="line">        CHECK(meta_data-&gt;findInt64(kKeyTime, &amp;timestampUs));</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="keyword">if</span> (mStszTableEntries-&gt;count() == <span class="number">0</span>) &#123;</span><br><span class="line">            mFirstSampleTimeRealUs = systemTime() / <span class="number">1000</span>;</span><br><span class="line">            mStartTimestampUs = timestampUs;</span><br><span class="line">            mOwner-&gt;setStartTimestampUs(mStartTimestampUs);</span><br><span class="line">            previousPausedDurationUs = mStartTimestampUs;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mResumed) &#123;</span><br><span class="line">            <span class="keyword">int64_t</span> durExcludingEarlierPausesUs = timestampUs - previousPausedDurationUs;</span><br><span class="line">            <span class="keyword">if</span> (WARN_UNLESS(durExcludingEarlierPausesUs &gt;= <span class="number">0l</span>l, <span class="string">"for %s track"</span>, trackName)) &#123;</span><br><span class="line">                copy-&gt;release();</span><br><span class="line">                mSource-&gt;stop();</span><br><span class="line">                mIsMalformed = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int64_t</span> pausedDurationUs = durExcludingEarlierPausesUs - mTrackDurationUs;</span><br><span class="line">            <span class="keyword">if</span> (WARN_UNLESS(pausedDurationUs &gt;= lastDurationUs, <span class="string">"for %s track"</span>, trackName)) &#123;</span><br><span class="line">                copy-&gt;release();</span><br><span class="line">                mSource-&gt;stop();</span><br><span class="line">                mIsMalformed = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            previousPausedDurationUs += pausedDurationUs - lastDurationUs;</span><br><span class="line">            mResumed = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        timestampUs -= previousPausedDurationUs;</span><br><span class="line">        <span class="keyword">if</span> (WARN_UNLESS(timestampUs &gt;= <span class="number">0l</span>l, <span class="string">"for %s track"</span>, trackName)) &#123;</span><br><span class="line">            copy-&gt;release();</span><br><span class="line">            mSource-&gt;stop();</span><br><span class="line">            mIsMalformed = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mIsAudio) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Composition time: timestampUs</span></span><br><span class="line"><span class="comment">             * Decoding time: decodingTimeUs</span></span><br><span class="line"><span class="comment">             * Composition time offset = composition time - decoding time</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">int64_t</span> decodingTimeUs;</span><br><span class="line">            CHECK(meta_data-&gt;findInt64(kKeyDecodingTime, &amp;decodingTimeUs));</span><br><span class="line">            decodingTimeUs -= previousPausedDurationUs;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ensure non-negative, monotonic decoding time</span></span><br><span class="line">            <span class="keyword">if</span> (mLastDecodingTimeUs &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                decodingTimeUs = <span class="built_in">std</span>::max((<span class="keyword">int64_t</span>)<span class="number">0</span>, decodingTimeUs);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// increase decoding time by at least 1 tick</span></span><br><span class="line">                decodingTimeUs = <span class="built_in">std</span>::max(</span><br><span class="line">                        mLastDecodingTimeUs + divUp(<span class="number">1000000</span>, mTimeScale), decodingTimeUs);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mLastDecodingTimeUs = decodingTimeUs;</span><br><span class="line">            cttsOffsetTimeUs =</span><br><span class="line">                    timestampUs + mCttsOffsetTimeUs - decodingTimeUs;</span><br><span class="line">            <span class="keyword">if</span> (cttsOffsetTimeUs &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                cttsOffsetTimeUs = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (WARN_UNLESS(cttsOffsetTimeUs &gt;= <span class="number">0l</span>l, <span class="string">"for %s track"</span>, trackName)) &#123;</span><br><span class="line">                copy-&gt;release();</span><br><span class="line">                mSource-&gt;stop();</span><br><span class="line">                mIsMalformed = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            timestampUs = decodingTimeUs;</span><br><span class="line">            ALOGV(<span class="string">"decoding time: %"</span> PRId64 <span class="string">" and ctts offset time: %"</span> PRId64,</span><br><span class="line">                timestampUs, cttsOffsetTimeUs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update ctts box table if necessary</span></span><br><span class="line">            currCttsOffsetTimeTicks =</span><br><span class="line">                    (cttsOffsetTimeUs * mTimeScale + <span class="number">500000L</span>L) / <span class="number">1000000L</span>L;</span><br><span class="line">            <span class="keyword">if</span> (WARN_UNLESS(currCttsOffsetTimeTicks &lt;= <span class="number">0x0FFFFFFFF</span>LL, <span class="string">"for %s track"</span>, trackName)) &#123;</span><br><span class="line">                copy-&gt;release();</span><br><span class="line">                mSource-&gt;stop();</span><br><span class="line">                mIsMalformed = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mStszTableEntries-&gt;count() == <span class="number">0</span>) &#123;</span><br><span class="line">                lastCttsOffsetTimeTicks = currCttsOffsetTimeTicks;</span><br><span class="line">                <span class="comment">//addOneCttsTableEntry(1, currCttsOffsetTimeTicks);</span></span><br><span class="line">                <span class="comment">//cttsSampleCount = 0;      // No sample in ctts box is pending</span></span><br><span class="line">                cttsSampleCount = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (currCttsOffsetTimeTicks != lastCttsOffsetTimeTicks) &#123;</span><br><span class="line">                    addOneCttsTableEntry(cttsSampleCount, lastCttsOffsetTimeTicks);</span><br><span class="line">                    lastCttsOffsetTimeTicks = currCttsOffsetTimeTicks;</span><br><span class="line">                    cttsSampleCount = <span class="number">1</span>;  <span class="comment">// One sample in ctts box is pending</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ++cttsSampleCount;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update ctts time offset range</span></span><br><span class="line">            <span class="keyword">if</span> (mStszTableEntries-&gt;count() == <span class="number">0</span>) &#123;</span><br><span class="line">                mMinCttsOffsetTimeUs = currCttsOffsetTimeTicks;</span><br><span class="line">                mMaxCttsOffsetTimeUs = currCttsOffsetTimeTicks;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (currCttsOffsetTimeTicks &gt; mMaxCttsOffsetTimeUs) &#123;</span><br><span class="line">                    mMaxCttsOffsetTimeUs = currCttsOffsetTimeTicks;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currCttsOffsetTimeTicks &lt; mMinCttsOffsetTimeUs) &#123;</span><br><span class="line">                    mMinCttsOffsetTimeUs = currCttsOffsetTimeTicks;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mOwner-&gt;isRealTimeRecording()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mIsAudio) &#123;</span><br><span class="line">                updateDriftTime(meta_data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (WARN_UNLESS(timestampUs &gt;= <span class="number">0l</span>l, <span class="string">"for %s track"</span>, trackName)) &#123;</span><br><span class="line">            copy-&gt;release();</span><br><span class="line">            mSource-&gt;stop();</span><br><span class="line">            mIsMalformed = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ALOGV(<span class="string">"%s media time stamp: %"</span> PRId64 <span class="string">" and previous paused duration %"</span> PRId64,</span><br><span class="line">                trackName, timestampUs, previousPausedDurationUs);</span><br><span class="line">        <span class="keyword">if</span> (timestampUs &gt; mTrackDurationUs) &#123;</span><br><span class="line">            mTrackDurationUs = timestampUs;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We need to use the time scale based ticks, rather than the</span></span><br><span class="line">        <span class="comment">// timestamp itself to determine whether we have to use a new</span></span><br><span class="line">        <span class="comment">// stts entry, since we may have rounding errors.</span></span><br><span class="line">        <span class="comment">// The calculation is intended to reduce the accumulated</span></span><br><span class="line">        <span class="comment">// rounding errors.</span></span><br><span class="line">        currDurationTicks =</span><br><span class="line">            ((timestampUs * mTimeScale + <span class="number">500000L</span>L) / <span class="number">1000000L</span>L -</span><br><span class="line">                (lastTimestampUs * mTimeScale + <span class="number">500000L</span>L) / <span class="number">1000000L</span>L);</span><br><span class="line">        <span class="keyword">if</span> (currDurationTicks &lt; <span class="number">0l</span>l) &#123;</span><br><span class="line">            ALOGE(<span class="string">"do not support out of order frames (timestamp: %lld &lt; last: %lld for %s track"</span>,</span><br><span class="line">                    (<span class="keyword">long</span> <span class="keyword">long</span>)timestampUs, (<span class="keyword">long</span> <span class="keyword">long</span>)lastTimestampUs, trackName);</span><br><span class="line">            copy-&gt;release();</span><br><span class="line">            mSource-&gt;stop();</span><br><span class="line">            mIsMalformed = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if the duration is different for this sample, see if it is close enough to the previous</span></span><br><span class="line">        <span class="comment">// duration that we can fudge it and use the same value, to avoid filling the stts table</span></span><br><span class="line">        <span class="comment">// with lots of near-identical entries.</span></span><br><span class="line">        <span class="comment">// "close enough" here means that the current duration needs to be adjusted by less</span></span><br><span class="line">        <span class="comment">// than 0.1 milliseconds</span></span><br><span class="line">        <span class="keyword">if</span> (lastDurationTicks &amp;&amp; (currDurationTicks != lastDurationTicks)) &#123;</span><br><span class="line">            <span class="keyword">int64_t</span> deltaUs = ((lastDurationTicks - currDurationTicks) * <span class="number">1000000L</span>L</span><br><span class="line">                    + (mTimeScale / <span class="number">2</span>)) / mTimeScale;</span><br><span class="line">            <span class="keyword">if</span> (deltaUs &gt; <span class="number">-100</span> &amp;&amp; deltaUs &lt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="comment">// use previous ticks, and adjust timestamp as if it was actually that number</span></span><br><span class="line">                <span class="comment">// of ticks</span></span><br><span class="line">                currDurationTicks = lastDurationTicks;</span><br><span class="line">                timestampUs += deltaUs;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mStszTableEntries-&gt;add(htonl(sampleSize));</span><br><span class="line">        <span class="keyword">if</span> (mStszTableEntries-&gt;count() &gt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Force the first sample to have its own stts entry so that</span></span><br><span class="line">            <span class="comment">// we can adjust its value later to maintain the A/V sync.</span></span><br><span class="line">            <span class="keyword">if</span> (mStszTableEntries-&gt;count() == <span class="number">3</span> || currDurationTicks != lastDurationTicks) &#123;</span><br><span class="line">                addOneSttsTableEntry(sampleCount, lastDurationTicks);</span><br><span class="line">                sampleCount = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ++sampleCount;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSamplesHaveSameSize) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mStszTableEntries-&gt;count() &gt;= <span class="number">2</span> &amp;&amp; previousSampleSize != sampleSize) &#123;</span><br><span class="line">                mSamplesHaveSameSize = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            previousSampleSize = sampleSize;</span><br><span class="line">        &#125;</span><br><span class="line">        ALOGV(<span class="string">"%s timestampUs/lastTimestampUs: %"</span> PRId64 <span class="string">"/%"</span> PRId64,</span><br><span class="line">                trackName, timestampUs, lastTimestampUs);</span><br><span class="line">        lastDurationUs = timestampUs - lastTimestampUs;</span><br><span class="line">        lastDurationTicks = currDurationTicks;</span><br><span class="line">        lastTimestampUs = timestampUs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isSync != <span class="number">0</span>) &#123;</span><br><span class="line">            addOneStssTableEntry(mStszTableEntries-&gt;count());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mTrackingProgressStatus) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPreviousTrackTimeUs &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mPreviousTrackTimeUs = mStartTimestampUs;</span><br><span class="line">            &#125;</span><br><span class="line">            trackProgressStatus(timestampUs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!hasMultipleTracks) &#123;</span><br><span class="line">            <span class="keyword">off64_t</span> offset = (mIsAvc || mIsHevc) ? mOwner-&gt;addMultipleLengthPrefixedSamples_l(copy)</span><br><span class="line">                                 : mOwner-&gt;addSample_l(copy);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">uint32_t</span> count = (mOwner-&gt;use32BitFileOffset()</span><br><span class="line">                        ? mStcoTableEntries-&gt;count()</span><br><span class="line">                        : mCo64TableEntries-&gt;count());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                addChunkOffset(offset);</span><br><span class="line">            &#125;</span><br><span class="line">            copy-&gt;release();</span><br><span class="line">            copy = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mChunkSamples.push_back(copy);</span><br><span class="line">        <span class="keyword">if</span> (interleaveDurationUs == <span class="number">0</span>) &#123;</span><br><span class="line">            addOneStscTableEntry(++nChunks, <span class="number">1</span>);</span><br><span class="line">            bufferChunk(timestampUs);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (chunkTimestampUs == <span class="number">0</span>) &#123;</span><br><span class="line">                chunkTimestampUs = timestampUs;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int64_t</span> chunkDurationUs = timestampUs - chunkTimestampUs;</span><br><span class="line">                <span class="keyword">if</span> (chunkDurationUs &gt; interleaveDurationUs) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (chunkDurationUs &gt; mMaxChunkDurationUs) &#123;</span><br><span class="line">                        mMaxChunkDurationUs = chunkDurationUs;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ++nChunks;</span><br><span class="line">                    <span class="keyword">if</span> (nChunks == <span class="number">1</span> ||  <span class="comment">// First chunk</span></span><br><span class="line">                        lastSamplesPerChunk != mChunkSamples.size()) &#123;</span><br><span class="line">                        lastSamplesPerChunk = mChunkSamples.size();</span><br><span class="line">                        addOneStscTableEntry(nChunks, lastSamplesPerChunk);</span><br><span class="line">                    &#125;</span><br><span class="line">                    bufferChunk(timestampUs);</span><br><span class="line">                    chunkTimestampUs = timestampUs;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isTrackMalFormed()) &#123;</span><br><span class="line">        err = ERROR_MALFORMED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mOwner-&gt;trackProgressStatus(mTrackId, <span class="number">-1</span>, err);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Last chunk</span></span><br><span class="line">    <span class="keyword">if</span> (!hasMultipleTracks) &#123;</span><br><span class="line">        addOneStscTableEntry(<span class="number">1</span>, mStszTableEntries-&gt;count());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mChunkSamples.empty()) &#123;</span><br><span class="line">        addOneStscTableEntry(++nChunks, mChunkSamples.size());</span><br><span class="line">        bufferChunk(timestampUs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We don't really know how long the last frame lasts, since</span></span><br><span class="line">    <span class="comment">// there is no frame time after it, just repeat the previous</span></span><br><span class="line">    <span class="comment">// frame's duration.</span></span><br><span class="line">    <span class="keyword">if</span> (mStszTableEntries-&gt;count() == <span class="number">1</span>) &#123;</span><br><span class="line">        lastDurationUs = <span class="number">0</span>;  <span class="comment">// A single sample's duration</span></span><br><span class="line">        lastDurationTicks = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ++sampleCount;  <span class="comment">// Count for the last sample</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStszTableEntries-&gt;count() &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">        addOneSttsTableEntry(<span class="number">1</span>, lastDurationTicks);</span><br><span class="line">        <span class="keyword">if</span> (sampleCount - <span class="number">1</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            addOneSttsTableEntry(sampleCount - <span class="number">1</span>, lastDurationTicks);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addOneSttsTableEntry(sampleCount, lastDurationTicks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The last ctts box may not have been written yet, and this</span></span><br><span class="line">    <span class="comment">// is to make sure that we write out the last ctts box.</span></span><br><span class="line">    <span class="keyword">if</span> (currCttsOffsetTimeTicks == lastCttsOffsetTimeTicks) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cttsSampleCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            addOneCttsTableEntry(cttsSampleCount, lastCttsOffsetTimeTicks);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mTrackDurationUs += lastDurationUs;</span><br><span class="line">    mReachedEOS = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    sendTrackSummary(hasMultipleTracks);</span><br><span class="line"></span><br><span class="line">    ALOGI(<span class="string">"Received total/0-length (%d/%d) buffers and encoded %d frames. - %s"</span>,</span><br><span class="line">            count, nZeroLengthFrames, mStszTableEntries-&gt;count(), trackName);</span><br><span class="line">    <span class="keyword">if</span> (mIsAudio) &#123;</span><br><span class="line">        ALOGI(<span class="string">"Audio track drift time: %"</span> PRId64 <span class="string">" us"</span>, mOwner-&gt;getDriftTimeUs());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if err is ERROR_IO (ex: during SSR), return OK to save the</span></span><br><span class="line">    <span class="comment">// recorded file successfully. Session tear down will happen as part of</span></span><br><span class="line">    <span class="comment">// client callback</span></span><br><span class="line">    <span class="keyword">if</span> ((err == ERROR_IO) || (err == ERROR_END_OF_STREAM)) &#123;</span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p> ä¸‹é¢çœ‹ä¸‹ï¼Œå½•åˆ¶æ–‡ä»¶ç»“æŸæ—¶çš„ä¸€äº›æ“ä½œã€‚å½•åˆ¶æ–‡ä»¶ç»“æŸæ—¶ï¼Œä¸Šå±‚åº”ç”¨åˆ†åˆ«æ˜¯è°ƒç”¨ MediaRecorderçš„stop()ã€reset()å’Œrelease()æ³•ï¼Œä¸‹é¢çœ‹ä¸‹MPEG4Writer.cppä¸­ç›¸å¯¹åº”çš„æ“ä½œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> MPEG4Writer::Track::stop() &#123;</span><br><span class="line">    ALOGD(<span class="string">"%s track stopping"</span>, mIsAudio? <span class="string">"Audio"</span>: <span class="string">"Video"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!mStarted) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Stop() called but track is not started"</span>);</span><br><span class="line">        <span class="keyword">return</span> ERROR_END_OF_STREAM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mDone) &#123;</span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line">    mDone = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"%s track source stopping"</span>, mIsAudio? <span class="string">"Audio"</span>: <span class="string">"Video"</span>);</span><br><span class="line">    mSource-&gt;stop();</span><br><span class="line">    ALOGD(<span class="string">"%s track source stopped"</span>, mIsAudio? <span class="string">"Audio"</span>: <span class="string">"Video"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *dummy;</span><br><span class="line">    pthread_join(mThread, &amp;dummy);</span><br><span class="line">    <span class="keyword">status_t</span> err = <span class="keyword">static_cast</span>&lt;<span class="keyword">status_t</span>&gt;(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(dummy));</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"%s track stopped"</span>, mIsAudio? <span class="string">"Audio"</span>: <span class="string">"Video"</span>);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> MPEG4Writer::release() &#123;</span><br><span class="line">    close(mFd);</span><br><span class="line">    mFd = <span class="number">-1</span>;</span><br><span class="line">    mInitCheck = NO_INIT;</span><br><span class="line">    mStarted = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">free</span>(mMoovBoxBuffer);</span><br><span class="line">    mMoovBoxBuffer = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://developer.android.com/guide/topics/media/camera#capture-video" target="_blank" rel="noopener">Camera#capture-video</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">Android NuPlayeræ’­æ”¾æ¡†æ¶ </a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">android ACodec MediaCodec NuPlayer flow - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">android MediaCodec ACodec - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/16222.html" target="_blank" rel="noopener">ffmpegå¼€å‘ä¹‹æ—…(1)-(7)ï¼ˆæ€»å…±ä¸ƒç¯‡ï¼‰</a><br><a href="https://blog.csdn.net/nonmarking/article/category/6746500" target="_blank" rel="noopener">æ·±å…¥ç†è§£AndroidéŸ³è§†é¢‘åŒæ­¥æœºåˆ¶ï¼ˆæ€»å…±äº”ç¯‡ï¼‰</a><br><a href="https://blog.csdn.net/junzia/article/details/54018671" target="_blank" rel="noopener">Androidç¡¬ç¼–ç â€”â€”éŸ³é¢‘ç¼–ç ã€è§†é¢‘ç¼–ç åŠéŸ³è§†é¢‘æ··åˆ</a><br><a href="https://blog.csdn.net/mr_zjc/article/details/46822833" target="_blank" rel="noopener">Android é«˜é€šå¹³å°Cameraå½•åˆ¶â€“MPEG4Writer.cpp ç®€å•è·Ÿè¯»</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/06/06/Android%20Video%20System%EF%BC%882%EF%BC%89%EF%BC%9A%E9%9F%B3%E8%A7%86%E9%A2%91%E5%88%86%E7%A6%BBMediaExtractor%E3%80%81%E8%A7%A3%E7%A0%81Decoder%E3%80%81%E6%B8%B2%E6%9F%93Renderer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/06/06/Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ/</id>
    <published>2018-06-05T16:00:00.000Z</published>
    <updated>2018-05-17T16:23:42.126Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/video.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Android NuPlayeræ’­æ”¾æ¡†æ¶ã€‘</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  android ACodec MediaCodec NuPlayer flowã€‘</a><br>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>â˜¯ V4l2 æ¡†æ¶ä»£ç <br>â˜¯ kernel/drivers/media/v4l2-core/ï¼ˆæ–‡ä»¶å‰ç¼€ä¸º videobuf2ï¼‰</p><p>â˜¯ MSM è§†é¢‘é©±åŠ¨ç¨‹åºæ–‡ä»¶<br>â˜¯ kernel/drivers/media/platform/msm/vidc/</p><p>â˜¯ è®¾å¤‡æ ‘<br>â˜¯ /kernel/arch/arm/boot/dts/qcomï¼ˆVenus çš„å¯„å­˜å™¨åŸºå€ï¼Œæ—¶é’Ÿé¢‘ç‡ï¼‰</p><p>â˜¯ Stagefrightã€libmediaã€libmediaplayerserviceã€mediaserver<br>â˜¯ /frameworks/av/media/</p><p>â˜¯ OMX<br>â˜¯ /hardware/qcom/media/mam8996/mm-video-v4l2/vidc/</p><p>â˜¯ OMX æ ¸å¿ƒ<br>â˜¯ /hardware/qcom/media/mm-core</p><p>â˜¯ è½¯ä»¶ç¼–è§£ç å™¨è·¯å¾„<br>â˜¯ /vendor/qcom/proprietary/mm-video/omx_vpp(?)â†’ è§£ç å™¨ä»£ç <br>â˜¯ /vendor/qcom/proprietary/mm-video/omx_vpp(?) â†’ ç¼–ç å™¨ä»£ç </p><hr><p>Androidåœ¨Javaå±‚ä¸­æä¾›äº†ä¸€ä¸ªMediaPlayerçš„ç±»æ¥ä½œä¸ºæ’­æ”¾åª’ä½“èµ„æºçš„æ¥å£ï¼Œåœ¨ä½¿ç”¨ä¸­æˆ‘ä»¬é€šå¸¸ä¼šç¼–å†™ä»¥ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mMediaPlayer = <span class="keyword">new</span> MediaPlayer();</span><br><span class="line">mMediaPlayer.setDataSource(Environment.getExternalStorageDirectory()+<span class="string">"/test_video.mp4"</span>);</span><br><span class="line">mMediaPlayer.setDisplay(...);</span><br><span class="line">mMediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);</span><br><span class="line">mMediaPlayer.prepareAsync();</span><br><span class="line">mMediaPlayer.start();</span><br><span class="line">mediaPlayer.pause(); </span><br><span class="line">mediaPlayer.stop();</span><br><span class="line">mediaPlayer.reset();</span><br><span class="line">mediaPlayer.release();</span><br></pre></td></tr></table></figure><p>å‰é¢ç¬¬ä¸€ç« èŠ‚å·²ç»åˆ†æè¿‡mMediaPlayer.setDataSource()ã€mMediaPlayer.setDisplay()ä¸‹æ¥çš„åˆ†æå°è¯•åˆ†æè§£ç­”å¦‚ä¸‹ç–‘é—®ï¼š</p><blockquote><p><strong>ä¸åŒæ ¼å¼çš„å¤šåª’ä½“æ–‡ä»¶å¦‚ä½•æ¢æµ‹å¹¶è§£æçš„ï¼ŸéŸ³è§†é¢‘æ•°æ®ç¼“å†²åŒºåœ¨å“ªé‡Œï¼Ÿï¼ˆSourceï¼‰</strong><br><strong>éŸ³é¢‘è§£ç çº¿ç¨‹ã€è§†é¢‘è§£ç çº¿ç¨‹åœ¨å“ªé‡Œï¼Ÿ ï¼ˆDecoderBaseï¼‰</strong><br><strong>è§†é¢‘å¦‚ä½•æ˜¾ç¤ºçš„ï¼ŸéŸ³é¢‘å¦‚ä½•æ’­æ”¾çš„ï¼ŸéŸ³è§†é¢‘åŒæ­¥åœ¨å“ªé‡Œï¼Ÿï¼ˆRendererï¼‰</strong></p></blockquote><h4 id="ï¼ˆä¸€ï¼‰ã€å¤šåª’ä½“æ–‡ä»¶è§£æ-MediaExtractoråˆ†ç¦»éŸ³è§†é¢‘"><a href="#ï¼ˆä¸€ï¼‰ã€å¤šåª’ä½“æ–‡ä»¶è§£æ-MediaExtractoråˆ†ç¦»éŸ³è§†é¢‘" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€å¤šåª’ä½“æ–‡ä»¶è§£æ - MediaExtractoråˆ†ç¦»éŸ³è§†é¢‘"></a>ï¼ˆä¸€ï¼‰ã€å¤šåª’ä½“æ–‡ä»¶è§£æ - MediaExtractoråˆ†ç¦»éŸ³è§†é¢‘</h4><p>æ¥ä¸‹æ¥ç»§ç»­åˆ†æmMediaPlayer.prepareAsync()</p><h5 id="1-1ã€mMediaPlayer-prepareAsync"><a href="#1-1ã€mMediaPlayer-prepareAsync" class="headerlink" title="1.1ã€mMediaPlayer.prepareAsync()"></a>1.1ã€mMediaPlayer.prepareAsync()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\java\android\media\MediaPlayer.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">prepareAsync</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br></pre></td></tr></table></figure><p>é€šè¿‡JNIè°ƒç”¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\jni\android_media_MediaPlayer.cpp]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">android_media_MediaPlayer_prepareAsync(JNIEnv *env, jobject thiz)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;MediaPlayer&gt; mp = getMediaPlayer(env, thiz);</span><br><span class="line">    <span class="keyword">if</span> (mp == <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        jniThrowException(env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle the case where the display surface was set before the mp was</span></span><br><span class="line">    <span class="comment">// initialized. We try again to make it stick.</span></span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; st = getVideoSurfaceTexture(env, thiz);</span><br><span class="line">    mp-&gt;setVideoSurfaceTexture(st);</span><br><span class="line"></span><br><span class="line">    process_media_player_call( env, thiz, mp-&gt;prepareAsync(), <span class="string">"java/io/IOException"</span>, <span class="string">"Prepare Async failed."</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè®¾ç½®è§†é¢‘çš„ display surfaceï¼ˆå…³äºIGraphicBufferProducerç›¸å…³çŸ¥è¯†è¯·å‚è€ƒï¼šAndroid 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]ï¼‰ï¼Œ</p><h5 id="1-1-1ã€MediaPlayer-setVideoSurfaceTexture"><a href="#1-1-1ã€MediaPlayer-setVideoSurfaceTexture" class="headerlink" title="1.1.1ã€MediaPlayer.setVideoSurfaceTexture()"></a>1.1.1ã€MediaPlayer.setVideoSurfaceTexture()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmedia\mediaplayer.cpp]</span><br><span class="line"><span class="keyword">status_t</span> MediaPlayer::setVideoSurfaceTexture(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; bufferProducer)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="string">"setVideoSurfaceTexture"</span>);</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="keyword">if</span> (mPlayer == <span class="number">0</span>) <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    <span class="keyword">return</span> mPlayer-&gt;setVideoSurfaceTexture(bufferProducer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰é¢setDataSource()åˆ†æè¿‡ï¼Œæ­¤å¤„ä¼šè°ƒç”¨NuPlayerçš„setVideoSurfaceTexture()å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::setVideoSurfaceTextureAsync(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt; &amp;bufferProducer) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetVideoSurface, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufferProducer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="keyword">new</span> Surface(bufferProducer, <span class="literal">true</span> <span class="comment">/* controlledByApp */</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„é¦–å…ˆæ„é€ äº†ä¸€ä¸ªAMessageæ¶ˆæ¯ï¼Œç„¶ånew Surface()ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹æ¶ˆæ¯å¤„ç†è¿‡ç¨‹ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">case</span> kWhatSetVideoSurface:</span><br><span class="line">        &#123;</span><br><span class="line">            sp&lt;RefBase&gt; obj;</span><br><span class="line">            CHECK(msg-&gt;findObject(<span class="string">"surface"</span>, &amp;obj));</span><br><span class="line">            sp&lt;Surface&gt; surface = <span class="keyword">static_cast</span>&lt;Surface *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mSource == <span class="literal">NULL</span> || !mStarted || mSource-&gt;getFormat(<span class="literal">false</span> <span class="comment">/* audio */</span>) == <span class="literal">NULL</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">NOTE:</span> mVideoDecoder's mSurface is always non-null</span></span><br><span class="line">                    || (mVideoDecoder != <span class="literal">NULL</span> &amp;&amp; mVideoDecoder-&gt;setVideoSurface(surface) == OK)) &#123;</span><br><span class="line">                performSetSurface(surface);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mDeferredActions.push_back(</span><br><span class="line">                    <span class="keyword">new</span> FlushDecoderAction(FLUSH_CMD_FLUSH <span class="comment">/* audio */</span>,</span><br><span class="line">                                           FLUSH_CMD_SHUTDOWN <span class="comment">/* video */</span>));</span><br><span class="line"></span><br><span class="line">            mDeferredActions.push_back(<span class="keyword">new</span> SetSurfaceAction(surface));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="literal">NULL</span> || mAudioDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">                    <span class="keyword">int64_t</span> currentPositionUs = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (getCurrentPosition(&amp;currentPositionUs) == OK) &#123;</span><br><span class="line">                        mDeferredActions.push_back(</span><br><span class="line">                                <span class="keyword">new</span> SeekAction(currentPositionUs));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                mDeferredActions.push_back(</span><br><span class="line">                        <span class="keyword">new</span> SimpleAction(&amp;NuPlayer::performScanSources));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mDeferredActions.push_back(</span><br><span class="line">                    <span class="keyword">new</span> ResumeDecoderAction(<span class="literal">false</span> <span class="comment">/* needNotify */</span>));</span><br><span class="line"></span><br><span class="line">            processDeferredActions();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::performSetSurface(<span class="keyword">const</span> sp&lt;Surface&gt; &amp;surface) &#123;</span><br><span class="line">    ALOGV(<span class="string">"performSetSurface"</span>);</span><br><span class="line"></span><br><span class="line">    mSurface = surface;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XXX - ignore error from setVideoScalingMode for now</span></span><br><span class="line">    setVideoScalingMode(mVideoScalingMode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mDriver != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sp&lt;NuPlayerDriver&gt; driver = mDriver.promote();</span><br><span class="line">        <span class="keyword">if</span> (driver != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            driver-&gt;notifySetSurfaceComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°å°†surface èµ‹å€¼ç»™NuPlayerçš„mSurface ï¼Œå¾…è§†é¢‘è§£ç åå°±å¯ä»¥åœ¨æ­¤surface ä¸Šæ¸²æŸ“ç”»é¢äº†ï¼Œ<br>è¿™ä¸ªç¨åå†ä½œåˆ†æã€‚</p><h5 id="1-1-2ã€MediaPlayer-prepareAsync"><a href="#1-1-2ã€MediaPlayer-prepareAsync" class="headerlink" title="1.1.2ã€MediaPlayer.prepareAsync()"></a>1.1.2ã€MediaPlayer.prepareAsync()</h5><p>ç„¶åæ¥ç€è°ƒç”¨MediaPlayer prepareAsync()å‡½æ•°ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmedia\mediaplayer.cpp]</span><br><span class="line"><span class="keyword">status_t</span> MediaPlayer::prepareAsync()</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="string">"prepareAsync"</span>);</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="keyword">return</span> prepareAsync_l();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> MediaPlayer::prepareAsync_l()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( (mPlayer != <span class="number">0</span>) &amp;&amp; ( mCurrentState &amp; (MEDIA_PLAYER_INITIALIZED | MEDIA_PLAYER_STOPPED) ) ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAudioAttributesParcel != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mPlayer-&gt;setParameter(KEY_PARAMETER_AUDIO_ATTRIBUTES, *mAudioAttributesParcel);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mPlayer-&gt;setAudioStreamType(mStreamType);</span><br><span class="line">        &#125;</span><br><span class="line">        mCurrentState = MEDIA_PLAYER_PREPARING;</span><br><span class="line">        <span class="keyword">return</span> mPlayer-&gt;prepareAsync();</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGE(<span class="string">"prepareAsync called in state %d, mPlayer(%p)"</span>, mCurrentState, mPlayer.get());</span><br><span class="line">    <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ­¤å¤„ä¼šè°ƒç”¨NuPlayerçš„prepareAsync()å‡½æ•°ï¼ŒprepareAsync()å‘é€äº†ä¸€ä¸ªkWhatPrepareçš„AMessageï¼Œæˆ‘ä»¬ç›´æ¥çœ‹çœ‹æ¶ˆæ¯å¤„ç†ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::prepareAsync() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatPrepare, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;        </span><br><span class="line"><span class="keyword">case</span> kWhatPrepare:</span><br><span class="line">&#123;</span><br><span class="line">    mSource-&gt;prepareAsync();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„åˆè°ƒç”¨äº†GenericSourceçš„prepareAsync()å‡½æ•°ï¼Œå‘é€äº†ä¸€ä¸ªkWhatPrepareAsyncæ¶ˆæ¯ã€‚ç›´æ¥çœ‹çœ‹GenericSourceå¦‚ä½•å¤„ç†çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\GenericSource.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::GenericSource::prepareAsync() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mLooper == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">        mLooper-&gt;setName(<span class="string">"generic"</span>);</span><br><span class="line">        mLooper-&gt;start();</span><br><span class="line"></span><br><span class="line">        mLooper-&gt;registerHandler(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatPrepareAsync, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">      <span class="keyword">case</span> kWhatPrepareAsync:</span><br><span class="line">      &#123;</span><br><span class="line">          onPrepareAsync();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="keyword">void</span> NuPlayer::GenericSource::onPrepareAsync() &#123;</span><br><span class="line">    <span class="comment">// delayed data source creation</span></span><br><span class="line">    <span class="keyword">if</span> (mDataSource == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// set to false first, if the extractor</span></span><br><span class="line">        <span class="comment">// comes back as secure, set it to true then.</span></span><br><span class="line">        mIsSecure = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mUri.empty()) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span>* uri = mUri.c_str();</span><br><span class="line">            String8 contentType;</span><br><span class="line">            mIsWidevine = !strncasecmp(uri, <span class="string">"widevine://"</span>, <span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!strncasecmp(<span class="string">"http://"</span>, uri, <span class="number">7</span>)</span><br><span class="line">                    || !strncasecmp(<span class="string">"https://"</span>, uri, <span class="number">8</span>)</span><br><span class="line">                    || mIsWidevine) &#123;</span><br><span class="line">                mHttpSource = DataSource::CreateMediaHTTP(mHTTPService);</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mDataSource = DataSource::CreateFromURI(</span><br><span class="line">                   mHTTPService, uri, &amp;mUriHeaders, &amp;contentType,</span><br><span class="line">                   <span class="keyword">static_cast</span>&lt;HTTPBase *&gt;(mHttpSource.get()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mIsWidevine = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            mDataSource = <span class="keyword">new</span> FileSource(mFd, mOffset, mLength);</span><br><span class="line">            mFd = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mDataSource-&gt;flags() &amp; DataSource::kIsCachingDataSource) &#123;</span><br><span class="line">        mCachedSource = <span class="keyword">static_cast</span>&lt;NuCachedSource2 *&gt;(mDataSource.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mIsStreaming = (mIsWidevine || mCachedSource != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// init extractor from data source</span></span><br><span class="line">    <span class="keyword">status_t</span> err = initFromDataSource();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mVideoTrack.mSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sp&lt;MetaData&gt; meta = doGetFormatMeta(<span class="literal">false</span> <span class="comment">/* audio */</span>);</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage;</span><br><span class="line">        err = convertMetaDataToMessage(meta, &amp;msg);</span><br><span class="line">        ......</span><br><span class="line">        notifyVideoSizeChanged(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mIsSecure) &#123;</span><br><span class="line">        <span class="comment">// secure decoders must be instantiated before starting widevine source</span></span><br><span class="line">        sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatSecureDecodersInstantiated, <span class="keyword">this</span>);</span><br><span class="line">        notifyInstantiateSecureDecoders(reply);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        finishPrepareAsync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ„é€ äº†  mDataSource = new FileSourceï¼Œç„¶åè°ƒç”¨äº†initFromDataSource()ï¼Œè¿™é‡Œé¢åŒ…å«å¤šåª’ä½“æ–‡ä»¶æ ¼å¼æ¢æµ‹ï¼Œã€‚</p><h5 id="1-1-3ã€GenericSource-initFromDataSource"><a href="#1-1-3ã€GenericSource-initFromDataSource" class="headerlink" title="1.1.3ã€GenericSource.initFromDataSource()"></a>1.1.3ã€GenericSource.initFromDataSource()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\GenericSource.cpp]</span><br><span class="line"><span class="keyword">status_t</span> NuPlayer::GenericSource::initFromDataSource() &#123;</span><br><span class="line">    sp&lt;IMediaExtractor&gt; extractor;</span><br><span class="line">    String8 mimeType;</span><br><span class="line">    <span class="keyword">float</span> confidence;</span><br><span class="line">    sp&lt;AMessage&gt; dummy;</span><br><span class="line">    <span class="keyword">bool</span> isWidevineStreaming = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    CHECK(mDataSource != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsWidevine) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mIsStreaming) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mDataSource-&gt;sniff(&amp;mimeType, &amp;confidence, &amp;dummy)) &#123;</span><br><span class="line">            <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        isWidevineStreaming = !strcasecmp(</span><br><span class="line">                mimeType.<span class="built_in">string</span>(), MEDIA_MIMETYPE_CONTAINER_WVM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isWidevineStreaming) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        extractor = MediaExtractor::Create(mDataSource,</span><br><span class="line">                mimeType.isEmpty() ? <span class="literal">NULL</span> : mimeType.<span class="built_in">string</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (extractor-&gt;getDrmFlag()) &#123;</span><br><span class="line">        checkDrmStatus(mDataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mFileMeta = extractor-&gt;getMetaData();</span><br><span class="line">    <span class="keyword">if</span> (mFileMeta != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> duration;</span><br><span class="line">        <span class="keyword">if</span> (mFileMeta-&gt;findInt64(kKeyDuration, &amp;duration)) &#123;</span><br><span class="line">            mDurationUs = duration;</span><br><span class="line">        &#125;......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> totalBitrate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> numtracks = extractor-&gt;countTracks();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; numtracks; ++i) &#123;</span><br><span class="line">        sp&lt;IMediaSource&gt; track = extractor-&gt;getTrack(i);</span><br><span class="line">        </span><br><span class="line">        sp&lt;MetaData&gt; meta = extractor-&gt;getTrackMetaData(i);</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *mime;</span><br><span class="line">        CHECK(meta-&gt;findCString(kKeyMIMEType, &amp;mime));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Do the string compare immediately with "mime",</span></span><br><span class="line">        <span class="comment">// we can't assume "mime" would stay valid after another</span></span><br><span class="line">        <span class="comment">// extractor operation, some extractors might modify meta</span></span><br><span class="line">        <span class="comment">// during getTrack() and make it invalid.</span></span><br><span class="line">        <span class="keyword">if</span> (!strncasecmp(mime, <span class="string">"audio/"</span>, <span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAudioTrack.mSource == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                mAudioTrack.mIndex = i;</span><br><span class="line">                mAudioTrack.mSource = track;</span><br><span class="line">                mAudioTrack.mPackets =</span><br><span class="line">                    <span class="keyword">new</span> AnotherPacketSource(mAudioTrack.mSource-&gt;getFormat());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_VORBIS)) &#123;</span><br><span class="line">                    mAudioIsVorbis = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mAudioIsVorbis = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strncasecmp(mime, <span class="string">"video/"</span>, <span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mVideoTrack.mSource == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                mVideoTrack.mIndex = i;</span><br><span class="line">                mVideoTrack.mSource = track;</span><br><span class="line">                mVideoTrack.mPackets =</span><br><span class="line">                    <span class="keyword">new</span> AnotherPacketSource(mVideoTrack.mSource-&gt;getFormat());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// check if the source requires secure buffers</span></span><br><span class="line">                <span class="keyword">int32_t</span> secure;</span><br><span class="line">                <span class="keyword">if</span> (meta-&gt;findInt32(kKeyRequiresSecureBuffers, &amp;secure)</span><br><span class="line">                        &amp;&amp; secure) &#123;</span><br><span class="line">                    mIsSecure = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">                        extractor-&gt;setUID(mUID);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mSources.push(track);</span><br><span class="line">        <span class="keyword">int64_t</span> durationUs;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;findInt64(kKeyDuration, &amp;durationUs)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (durationUs &gt; mDurationUs) &#123;</span><br><span class="line">                mDurationUs = durationUs;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int32_t</span> bitrate;</span><br><span class="line">        <span class="keyword">if</span> (totalBitrate &gt;= <span class="number">0</span> &amp;&amp; meta-&gt;findInt32(kKeyBitRate, &amp;bitrate)) &#123;</span><br><span class="line">            totalBitrate += bitrate;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            totalBitrate = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   ......</span><br><span class="line">    mBitrate = totalBitrate;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é€šè¿‡MediaExtractor::Create()å¾—åˆ°MediaExtractorï¼Œç„¶åå°†æ•°æ®è§£ææˆtrack èµ‹å€¼ç»™mAudioTrack.mSourceã€mVideoTrack.mSourceã€‚</p><h5 id="1-1-4ã€MediaExtractor-Create"><a href="#1-1-4ã€MediaExtractor-Create" class="headerlink" title="1.1.4ã€MediaExtractor::Create()"></a>1.1.4ã€MediaExtractor::Create()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaExtractor.cpp]</span><br><span class="line">sp&lt;IMediaExtractor&gt; MediaExtractor::Create(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source, <span class="keyword">const</span> <span class="keyword">char</span> *mime) &#123;</span><br><span class="line">    ALOGV(<span class="string">"MediaExtractor::Create %s"</span>, mime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> value[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">if</span> (property_get(<span class="string">"media.stagefright.extractremote"</span>, value, <span class="literal">NULL</span>)</span><br><span class="line">            &amp;&amp; (!<span class="built_in">strcmp</span>(<span class="string">"0"</span>, value) || !strcasecmp(<span class="string">"false"</span>, value))) &#123;</span><br><span class="line">        <span class="comment">// local extractor</span></span><br><span class="line">        ALOGW(<span class="string">"creating media extractor in calling process"</span>);</span><br><span class="line">        <span class="keyword">return</span> CreateFromService(source, mime);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Check if it's WVM, since WVMExtractor needs to be created in the media server process,</span></span><br><span class="line">        <span class="comment">// not the extractor process.</span></span><br><span class="line">        String8 mime8;</span><br><span class="line">        <span class="keyword">float</span> confidence;</span><br><span class="line">        sp&lt;AMessage&gt; meta;</span><br><span class="line">        <span class="keyword">if</span> (SniffWVM(source, &amp;mime8, &amp;confidence, &amp;meta) &amp;&amp;</span><br><span class="line">                !strcasecmp(mime8, MEDIA_MIMETYPE_CONTAINER_WVM)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WVMExtractor(source);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (SniffDRM(source, &amp;mime8, &amp;confidence, &amp;meta)) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *drmMime = mime8.<span class="built_in">string</span>();</span><br><span class="line">            ALOGV(<span class="string">"Detected media content as '%s' with confidence %.2f"</span>, drmMime, confidence);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(drmMime, <span class="string">"drm+es_based+"</span>, <span class="number">13</span>)) &#123;</span><br><span class="line">                <span class="comment">// DRMExtractor sets container metadata kKeyIsDRM to 1</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> DRMExtractor(source, drmMime + <span class="number">14</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// remote extractor</span></span><br><span class="line">        ALOGV(<span class="string">"get service manager"</span>);</span><br><span class="line">        sp&lt;IBinder&gt; binder = defaultServiceManager()-&gt;getService(String16(<span class="string">"media.extractor"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (binder != <span class="number">0</span>) &#123;</span><br><span class="line">            sp&lt;IMediaExtractorService&gt; mediaExService(interface_cast&lt;IMediaExtractorService&gt;(binder));</span><br><span class="line">            sp&lt;IMediaExtractor&gt; ex = mediaExService-&gt;makeExtractor(RemoteDataSource::wrap(source), mime);</span><br><span class="line">            <span class="keyword">return</span> ex;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é€šè¿‡Binderé€šä¿¡è·å–â€media.extractorâ€æœåŠ¡å¾—åˆ°ä¸€ä¸ªExtractorã€‚</p><h5 id="1-1-5ã€IMediaExtractor-gt-getTrack"><a href="#1-1-5ã€IMediaExtractor-gt-getTrack" class="headerlink" title="1.1.5ã€IMediaExtractor-&gt;getTrack()"></a>1.1.5ã€IMediaExtractor-&gt;getTrack()</h5><p>æ ¹æ®ä¸åŒç±»åˆ«è§£æå‡ºä¸åŒçš„Track</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\]</span><br><span class="line"></span><br><span class="line">AACExtractor.cpp sp&lt;IMediaSource&gt; AACExtractor::getTrack(<span class="keyword">size_t</span> index)</span><br><span class="line">AMRExtractor.cpp sp&lt;IMediaSource&gt; AMRExtractor::getTrack(<span class="keyword">size_t</span> index)</span><br><span class="line">MP3Extractor.cpp sp&lt;IMediaSource&gt; MP3Extractor::getTrack(<span class="keyword">size_t</span> index)</span><br><span class="line">NuMediaExtractor.cpp sp&lt;IMediaSource&gt; source = mImpl-&gt;getTrack(index)</span><br><span class="line">WAVExtractor.cpp sp&lt;IMediaSource&gt; WAVExtractor::getTrack(<span class="keyword">size_t</span> index)</span><br><span class="line">FLACExtractor.cpp sp&lt;IMediaSource&gt; FLACExtractor::getTrack(<span class="keyword">size_t</span> index) </span><br><span class="line">StagefrightMetadataRetriever.cpp sp&lt;IMediaSource&gt; source = mExtractor-&gt;getTrack(i)</span><br><span class="line">AVIExtractor.cpp sp&lt;MediaSource&gt; AVIExtractor::getTrack(<span class="keyword">size_t</span> index)</span><br><span class="line">OggExtractor.cpp sp&lt;IMediaSource&gt; OggExtractor::getTrack(<span class="keyword">size_t</span> index)</span><br><span class="line">MPEG4Extractor.cpp sp&lt;IMediaSource&gt; MPEG4Extractor::getTrack(<span class="keyword">size_t</span> index)</span><br><span class="line"></span><br><span class="line"><span class="comment">//MP3</span></span><br><span class="line">sp&lt;IMediaSource&gt; MP3Extractor::getTrack(<span class="keyword">size_t</span> index) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MP3Source(</span><br><span class="line">            mMeta, mDataSource, mFirstFramePos, mFixedHeader,</span><br><span class="line">            mSeeker);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//MPEG4</span></span><br><span class="line">sp&lt;IMediaSource&gt; MPEG4Extractor::getTrack(<span class="keyword">size_t</span> index) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    ......</span><br><span class="line">    Track *track = mFirstTrack;</span><br><span class="line">    <span class="keyword">while</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (track == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        track = track-&gt;next;</span><br><span class="line">        --index;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    Trex *trex = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> trackId;</span><br><span class="line">    <span class="keyword">if</span> (track-&gt;meta-&gt;findInt32(kKeyTrackID, &amp;trackId)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mTrex.size(); i++) &#123;</span><br><span class="line">            Trex *t = &amp;mTrex.editItemAt(i);</span><br><span class="line">            <span class="keyword">if</span> (t-&gt;track_ID == (<span class="keyword">uint32_t</span>) trackId) &#123;</span><br><span class="line">                trex = t;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mime;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_VIDEO_AVC)) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> type;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">void</span> *data;</span><br><span class="line">        <span class="keyword">size_t</span> size;</span><br><span class="line">        <span class="keyword">if</span> (!track-&gt;meta-&gt;findData(kKeyAVCC, &amp;type, &amp;data, &amp;size)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint8_t</span> *ptr = (<span class="keyword">const</span> <span class="keyword">uint8_t</span> *)data;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_VIDEO_HEVC)) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> type;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">void</span> *data;</span><br><span class="line">        <span class="keyword">size_t</span> size;</span><br><span class="line">        <span class="keyword">if</span> (!track-&gt;meta-&gt;findData(kKeyHVCC, &amp;type, &amp;data, &amp;size)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint8_t</span> *ptr = (<span class="keyword">const</span> <span class="keyword">uint8_t</span> *)data;</span><br><span class="line">       ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MPEG4Source(<span class="keyword">this</span>,</span><br><span class="line">            track-&gt;meta, mDataSource, track-&gt;timescale, track-&gt;sampleTable,</span><br><span class="line">            mSidxEntries, trex, mMoofOffset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸åŒæ ¼å¼çš„ MP3Extractorã€MPEG4Source â€¦â€¦</p><p>è¿˜è®°çš„å‰é¢æå‡ºçš„ç¬¬ä¸€ç‚¹ç–‘é—®å—ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•åˆ†ç¦»éŸ³è§†é¢‘äº†å¹¶ä¸”å¾—åˆ°äº†ç›¸åº”çš„æ–‡ä»¶Sourceäº†ã€‚<br>å›¾ç¤ºï¼ˆçº¢çº¿éƒ¨åˆ†ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/02-01-source-demux-decoder-output-MediaExtractor.jpg" alt="Alt text"></p><h4 id="ï¼ˆäºŒï¼‰ã€å¤šåª’ä½“æ–‡ä»¶-éŸ³è§†é¢‘è§£ç ï¼ˆDecoderï¼‰"><a href="#ï¼ˆäºŒï¼‰ã€å¤šåª’ä½“æ–‡ä»¶-éŸ³è§†é¢‘è§£ç ï¼ˆDecoderï¼‰" class="headerlink" title="ï¼ˆäºŒï¼‰ã€å¤šåª’ä½“æ–‡ä»¶ - éŸ³è§†é¢‘è§£ç ï¼ˆDecoderï¼‰"></a>ï¼ˆäºŒï¼‰ã€å¤šåª’ä½“æ–‡ä»¶ - éŸ³è§†é¢‘è§£ç ï¼ˆDecoderï¼‰</h4><p>éŸ³é¢‘è§£ç ã€è§†é¢‘è§£ç åœ¨ä½•å¤„ï¼Œç­”æ¡ˆå°±åœ¨mMediaPlayer.start()æµç¨‹å½“ä¸­ï¼Œå…ˆçœ‹çœ‹start()æ€»ä½“æ—¶åºå›¾ï¼Œç„¶åä¸€æ­¥æ­¥åˆ†æ</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/02-02-NuPlayer-Start-instantiateDecoder.png" alt="Alt text"></p><p>ç”±äºä»Javaå±‚åˆ°JNIå‰é¢å·²å¤šæ¬¡åˆ†æï¼Œè¿™é‡Œç›´æ¥ä»NuPlayer::start()å¼€å§‹åˆ†æ</p><h5 id="2-1ã€NuPlayer-start"><a href="#2-1ã€NuPlayer-start" class="headerlink" title="2.1ã€NuPlayer::start()"></a>2.1ã€NuPlayer::start()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::start() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatStart, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">case</span> kWhatStart:</span><br><span class="line">        &#123;</span><br><span class="line">            ALOGV(<span class="string">"kWhatStart"</span>);</span><br><span class="line">            <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">                <span class="comment">// do not resume yet if the source is still buffering</span></span><br><span class="line">                <span class="keyword">if</span> (!mPausedForBuffering) &#123;</span><br><span class="line">                    onResume();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                onStart();</span><br><span class="line">            &#125;</span><br><span class="line">            mPausedByClient = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">void</span> NuPlayer::onStart(<span class="keyword">int64_t</span> startPositionUs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mSourceStarted) &#123;</span><br><span class="line">        mSourceStarted = <span class="literal">true</span>;</span><br><span class="line">        mSource-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (startPositionUs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        performSeek(startPositionUs);</span><br><span class="line">        <span class="keyword">if</span> (mSource-&gt;getFormat(<span class="literal">false</span> <span class="comment">/* audio */</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mOffloadAudio = <span class="literal">false</span>;</span><br><span class="line">    mAudioEOS = <span class="literal">false</span>;</span><br><span class="line">    mVideoEOS = <span class="literal">false</span>;</span><br><span class="line">    mStarted = <span class="literal">true</span>;</span><br><span class="line">    mPaused = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSource-&gt;isRealTime()) &#123;</span><br><span class="line">        flags |= Renderer::FLAG_REAL_TIME;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;MetaData&gt; audioMeta = mSource-&gt;getFormatMeta(<span class="literal">true</span> <span class="comment">/* audio */</span>);</span><br><span class="line">    sp&lt;MetaData&gt; videoMeta = mSource-&gt;getFormatMeta(<span class="literal">false</span> <span class="comment">/* audio */</span>);</span><br><span class="line">    ......</span><br><span class="line">    ALOGV_IF(audioMeta == <span class="literal">NULL</span>, <span class="string">"no metadata for audio source"</span>);  <span class="comment">// video only stream</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">audio_stream_type_t</span> streamType = AUDIO_STREAM_MUSIC;</span><br><span class="line">    <span class="keyword">if</span> (mAudioSink != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        streamType = mAudioSink-&gt;getAudioStreamType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; videoFormat = mSource-&gt;getFormat(<span class="literal">false</span> <span class="comment">/* audio */</span>);</span><br><span class="line"></span><br><span class="line">    mOffloadAudio =</span><br><span class="line">        canOffloadStream(audioMeta, (videoFormat != <span class="literal">NULL</span>), mSource-&gt;isStreaming(), streamType)</span><br><span class="line">                &amp;&amp; (mPlaybackSettings.mSpeed == <span class="number">1.f</span> &amp;&amp; mPlaybackSettings.mPitch == <span class="number">1.f</span>);</span><br><span class="line">    <span class="keyword">if</span> (mOffloadAudio) &#123;</span><br><span class="line">        flags |= Renderer::FLAG_OFFLOAD_AUDIO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatRendererNotify, <span class="keyword">this</span>);</span><br><span class="line">    ++mRendererGeneration;</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"generation"</span>, mRendererGeneration);</span><br><span class="line">    mRenderer = <span class="keyword">new</span> Renderer(mAudioSink, notify, flags);</span><br><span class="line">    mRendererLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">    mRendererLooper-&gt;setName(<span class="string">"NuPlayerRenderer"</span>);</span><br><span class="line">    mRendererLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">    mRendererLooper-&gt;registerHandler(mRenderer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = mRenderer-&gt;setPlaybackSettings(mPlaybackSettings);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">float</span> rate = getFrameRate();</span><br><span class="line">    <span class="keyword">if</span> (rate &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        mRenderer-&gt;setVideoFrameRate(rate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mVideoDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mVideoDecoder-&gt;setRenderer(mRenderer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mAudioDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mAudioDecoder-&gt;setRenderer(mRenderer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    postScanSources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºäº†åä¸ºNuPlayerRendererçš„Rendererå¯¹è±¡ï¼Œç„¶åå¯åŠ¨å¾ªç¯ï¼Œçœ‹çœ‹åˆå§‹åŒ–</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line">NuPlayer::Renderer::Renderer(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;MediaPlayerBase::AudioSink&gt; &amp;sink,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;notify,</span><br><span class="line">        <span class="keyword">uint32_t</span> flags)</span><br><span class="line">    : mAudioSink(sink),</span><br><span class="line">      mUseVirtualAudioSink(<span class="literal">false</span>),</span><br><span class="line">      mNotify(notify),</span><br><span class="line">      mFlags(flags),</span><br><span class="line">      mNumFramesWritten(<span class="number">0</span>),</span><br><span class="line">      mDrainAudioQueuePending(<span class="literal">false</span>),</span><br><span class="line">      mDrainVideoQueuePending(<span class="literal">false</span>),</span><br><span class="line">      mAudioQueueGeneration(<span class="number">0</span>),</span><br><span class="line">      mVideoQueueGeneration(<span class="number">0</span>),</span><br><span class="line">      mAudioDrainGeneration(<span class="number">0</span>),</span><br><span class="line">      mVideoDrainGeneration(<span class="number">0</span>),</span><br><span class="line">      mAudioEOSGeneration(<span class="number">0</span>),</span><br><span class="line">      mPlaybackSettings(AUDIO_PLAYBACK_RATE_DEFAULT),</span><br><span class="line">      ......</span><br><span class="line">      mWakeLock(<span class="keyword">new</span> AWakeLock()) &#123;</span><br><span class="line">    mMediaClock = <span class="keyword">new</span> MediaClock;</span><br><span class="line">    mPlaybackRate = mPlaybackSettings.mSpeed;</span><br><span class="line">    mMediaClock-&gt;setPlaybackRate(mPlaybackRate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-2ã€postScanSources"><a href="#2-2ã€postScanSources" class="headerlink" title="2.2ã€postScanSources()"></a>2.2ã€postScanSources()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::postScanSources() &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatScanSources, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"generation"</span>, mScanSourcesGeneration);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line"></span><br><span class="line">    mScanSourcesPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> kWhatScanSources:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int32_t</span> generation;</span><br><span class="line">            mScanSourcesPending = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">bool</span> mHadAnySourcesBefore =</span><br><span class="line">                (mAudioDecoder != <span class="literal">NULL</span>) || (mVideoDecoder != <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">bool</span> rescan = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// initialize video before audio because successful initialization of</span></span><br><span class="line">            <span class="comment">// video may change deep buffer mode of audio.</span></span><br><span class="line">            <span class="keyword">if</span> (mSurface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instantiateDecoder(<span class="literal">false</span>, &amp;mVideoDecoder) == -EWOULDBLOCK) &#123;</span><br><span class="line">                    rescan = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Don't try to re-open audio sink if there's an existing decoder.</span></span><br><span class="line">            <span class="keyword">if</span> (mAudioSink != <span class="literal">NULL</span> &amp;&amp; mAudioDecoder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instantiateDecoder(<span class="literal">true</span>, &amp;mAudioDecoder) == -EWOULDBLOCK) &#123;</span><br><span class="line">                    rescan = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„è°ƒç”¨äº†instantiateDecoder()æ¥åˆå§‹åŒ–éŸ³è§†é¢‘è§£ç å™¨Decoder</p><h5 id="2-3ã€instantiateDecoder"><a href="#2-3ã€instantiateDecoder" class="headerlink" title="2.3ã€instantiateDecoder()"></a>2.3ã€instantiateDecoder()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">status_t</span> NuPlayer::instantiateDecoder(</span><br><span class="line">        <span class="keyword">bool</span> audio, sp&lt;DecoderBase&gt; *decoder, <span class="keyword">bool</span> checkAudioModeChange) &#123;</span><br><span class="line">    ......</span><br><span class="line">    sp&lt;AMessage&gt; format = mSource-&gt;getFormat(audio);</span><br><span class="line"></span><br><span class="line">    format-&gt;setInt32(<span class="string">"priority"</span>, <span class="number">0</span> <span class="comment">/* realtime */</span>);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (audio) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatAudioNotify, <span class="keyword">this</span>);</span><br><span class="line">        ++mAudioDecoderGeneration;</span><br><span class="line">        notify-&gt;setInt32(<span class="string">"generation"</span>, mAudioDecoderGeneration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (checkAudioModeChange) &#123;</span><br><span class="line">            determineAudioModeChange(format);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mOffloadAudio) &#123;</span><br><span class="line">            mSource-&gt;setOffloadAudio(<span class="literal">true</span> <span class="comment">/* offload */</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">bool</span> hasVideo = (mSource-&gt;getFormat(<span class="literal">false</span> <span class="comment">/*audio */</span>) != <span class="literal">NULL</span>);</span><br><span class="line">            format-&gt;setInt32(<span class="string">"has-video"</span>, hasVideo);</span><br><span class="line">            *decoder = <span class="keyword">new</span> DecoderPassThrough(notify, mSource, mRenderer);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSource-&gt;setOffloadAudio(<span class="literal">false</span> <span class="comment">/* offload */</span>);</span><br><span class="line"></span><br><span class="line">            *decoder = <span class="keyword">new</span> Decoder(notify, mSource, mPID, mRenderer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatVideoNotify, <span class="keyword">this</span>);</span><br><span class="line">        ++mVideoDecoderGeneration;</span><br><span class="line">        notify-&gt;setInt32(<span class="string">"generation"</span>, mVideoDecoderGeneration);</span><br><span class="line"></span><br><span class="line">        *decoder = <span class="keyword">new</span> Decoder(</span><br><span class="line">                notify, mSource, mPID, mRenderer, mSurface, mCCDecoder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// enable FRC if high-quality AV sync is requested, even if not</span></span><br><span class="line">        <span class="comment">// directly queuing to display, as this will even improve textureview</span></span><br><span class="line">        <span class="comment">// playback.</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> value[PROPERTY_VALUE_MAX];</span><br><span class="line">            <span class="keyword">if</span> (property_get(<span class="string">"persist.sys.media.avsync"</span>, value, <span class="literal">NULL</span>) &amp;&amp;</span><br><span class="line">                    (!<span class="built_in">strcmp</span>(<span class="string">"1"</span>, value) || !strcasecmp(<span class="string">"true"</span>, value))) &#123;</span><br><span class="line">                format-&gt;setInt32(<span class="string">"auto-frc"</span>, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    (*decoder)-&gt;init();</span><br><span class="line">    (*decoder)-&gt;configure(format);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-1ã€åˆ›å»ºéŸ³è§†é¢‘è§£ç å™¨new-Decoder"><a href="#2-3-1ã€åˆ›å»ºéŸ³è§†é¢‘è§£ç å™¨new-Decoder" class="headerlink" title="2.3.1ã€åˆ›å»ºéŸ³è§†é¢‘è§£ç å™¨new Decoder()"></a>2.3.1ã€åˆ›å»ºéŸ³è§†é¢‘è§£ç å™¨new Decoder()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line">NuPlayer::Decoder::Decoder(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;notify,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Source&gt; &amp;source,</span><br><span class="line">        <span class="keyword">pid_t</span> pid,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Renderer&gt; &amp;renderer,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Surface&gt; &amp;surface,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;CCDecoder&gt; &amp;ccDecoder)</span><br><span class="line">    : DecoderBase(notify),</span><br><span class="line">      mSurface(surface),</span><br><span class="line">      mSource(source),</span><br><span class="line">      mRenderer(renderer),</span><br><span class="line">      mCCDecoder(ccDecoder),</span><br><span class="line">      ......</span><br><span class="line">      mVideoWidth(<span class="number">0</span>),</span><br><span class="line">      mVideoHeight(<span class="number">0</span>),</span><br><span class="line">      mIsAudio(<span class="literal">true</span>),</span><br><span class="line">      ......</span><br><span class="line">      mComponentName(<span class="string">"decoder"</span>) &#123;</span><br><span class="line">    mCodecLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">    mCodecLooper-&gt;setName(<span class="string">"NPDecoder-CL"</span>);</span><br><span class="line">    mCodecLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">    mVideoTemporalLayerAggregateFps[<span class="number">0</span>] = mFrameRateTotal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºéŸ³è§†é¢‘è§£ç å™¨ï¼ˆNuPlayer::Decoderï¼‰ï¼Œä¸ºå…¶åˆ›å»ºåä¸ºNPDecoder-CLçš„mCodecLooper ã€å…¶çˆ¶ç±»NuPlayer::DecoderBaseçš„æ„é€ ä¸­åˆ™ä¼šåˆ›å»ºNPDecoderã€‘</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoderBase.cpp]</span><br><span class="line">NuPlayer::DecoderBase::DecoderBase(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;notify)</span><br><span class="line">    :  mNotify(notify),</span><br><span class="line">       mBufferGeneration(<span class="number">0</span>),</span><br><span class="line">       mPaused(<span class="literal">false</span>),</span><br><span class="line">       mStats(<span class="keyword">new</span> AMessage),</span><br><span class="line">       mRequestInputBuffersPending(<span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// Every decoder has its own looper because MediaCodec operations</span></span><br><span class="line">    <span class="comment">// are blocking, but NuPlayer needs asynchronous operations.</span></span><br><span class="line">    mDecoderLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">    mDecoderLooper-&gt;setName(<span class="string">"NPDecoder"</span>);</span><br><span class="line">    mDecoderLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-2ã€åˆå§‹åŒ–Decoder-gt-init"><a href="#2-3-2ã€åˆå§‹åŒ–Decoder-gt-init" class="headerlink" title="2.3.2ã€åˆå§‹åŒ–Decoder-&gt;init()"></a>2.3.2ã€åˆå§‹åŒ–Decoder-&gt;init()</h5><p>å¯¹è¯¥è§£ç å™¨è¿›è¡Œinit()æ“ä½œï¼Œè°ƒç”¨NuPlayer::DecoderBase::init()ä¸ºmDecoderLooperæ³¨å†Œhandlerã€init()å’Œconfigure()éƒ½æ˜¯NuPlayerDecoderç»§æ‰¿è‡ªNuPlayer::DecoderBaseçš„æ–¹æ³•ã€‘</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoderBase.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::DecoderBase::configure(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatConfigure, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setMessage(<span class="string">"format"</span>, format);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::DecoderBase::init() &#123;</span><br><span class="line">    mDecoderLooper-&gt;registerHandler(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> kWhatConfigure:</span><br><span class="line">        &#123;</span><br><span class="line">            sp&lt;AMessage&gt; format;</span><br><span class="line">            CHECK(msg-&gt;findMessage(<span class="string">"format"</span>, &amp;format));</span><br><span class="line">            onConfigure(format);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å¯¹è¯¥è§£ç å™¨è¿›è¡Œconfigure(format)æ“ä½œï¼Œè°ƒç”¨NuPlayer::DecoderBase::configure(â€¦)äº§ç”Ÿä¸€ä¸ªkWhatConfigureæ¶ˆæ¯ï¼Œç„¶åæ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨NuPlayer::Decoder::onConfigure(â€¦)</p><h5 id="2-3-3ã€é…ç½®Decoder-gt-configure"><a href="#2-3-3ã€é…ç½®Decoder-gt-configure" class="headerlink" title="2.3.3ã€é…ç½®Decoder-&gt;configure()"></a>2.3.3ã€é…ç½®Decoder-&gt;configure()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Decoder::onConfigure(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line">  </span><br><span class="line">    mFormatChangePending = <span class="literal">false</span>;</span><br><span class="line">    mTimeChangePending = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ++mBufferGeneration;</span><br><span class="line"></span><br><span class="line">    AString mime;</span><br><span class="line"></span><br><span class="line">    mIsAudio = !strncasecmp(<span class="string">"audio/"</span>, mime.c_str(), <span class="number">6</span>);</span><br><span class="line">    mIsVideoAVC = !strcasecmp(MEDIA_MIMETYPE_VIDEO_AVC, mime.c_str());</span><br><span class="line"></span><br><span class="line">    mComponentName = mime;</span><br><span class="line">    mComponentName.append(<span class="string">" decoder"</span>);</span><br><span class="line">    ALOGV(<span class="string">"[%s] onConfigure (surface=%p)"</span>, mComponentName.c_str(), mSurface.get());</span><br><span class="line"></span><br><span class="line">    mCodec = MediaCodec::CreateByType(</span><br><span class="line">            mCodecLooper, mime.c_str(), <span class="literal">false</span> <span class="comment">/* encoder */</span>, <span class="literal">NULL</span> <span class="comment">/* err */</span>, mPid);</span><br><span class="line">    <span class="keyword">int32_t</span> secure = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (format-&gt;findInt32(<span class="string">"secure"</span>, &amp;secure) &amp;&amp; secure != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCodec != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mCodec-&gt;getName(&amp;mComponentName);</span><br><span class="line">            mComponentName.append(<span class="string">".secure"</span>);</span><br><span class="line">            mCodec-&gt;release();</span><br><span class="line">            ALOGI(<span class="string">"[%s] creating"</span>, mComponentName.c_str());</span><br><span class="line">            mCodec = MediaCodec::CreateByComponentName(</span><br><span class="line">                    mCodecLooper, mComponentName.c_str(), <span class="literal">NULL</span> <span class="comment">/* err */</span>, mPid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    mIsSecure = secure;</span><br><span class="line"></span><br><span class="line">    mCodec-&gt;getName(&amp;mComponentName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="keyword">if</span> (mSurface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// disconnect from surface as MediaCodec will reconnect</span></span><br><span class="line">        err = native_window_api_disconnect(</span><br><span class="line">                mSurface.get(), NATIVE_WINDOW_API_MEDIA);</span><br><span class="line">        <span class="comment">// We treat this as a warning, as this is a preparatory step.</span></span><br><span class="line">        <span class="comment">// Codec will try to connect to the surface, which is where</span></span><br><span class="line">        <span class="comment">// any error signaling will occur.</span></span><br><span class="line">        ALOGW_IF(err != OK, <span class="string">"failed to disconnect from surface: %d"</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line">    err = mCodec-&gt;configure(</span><br><span class="line">            format, mSurface, <span class="literal">NULL</span> <span class="comment">/* crypto */</span>, <span class="number">0</span> <span class="comment">/* flags */</span>);</span><br><span class="line">    ......</span><br><span class="line">    rememberCodecSpecificData(format);</span><br><span class="line">    mStats-&gt;setString(<span class="string">"mime"</span>, mime.c_str());</span><br><span class="line">    mStats-&gt;setString(<span class="string">"component-name"</span>, mComponentName.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mIsAudio) &#123;</span><br><span class="line">        <span class="keyword">int32_t</span> width, height;</span><br><span class="line">        <span class="keyword">if</span> (mOutputFormat-&gt;findInt32(<span class="string">"width"</span>, &amp;width)</span><br><span class="line">                &amp;&amp; mOutputFormat-&gt;findInt32(<span class="string">"height"</span>, &amp;height)) &#123;</span><br><span class="line">            mStats-&gt;setInt32(<span class="string">"width"</span>, width);</span><br><span class="line">            mStats-&gt;setInt32(<span class="string">"height"</span>, height);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatCodecNotify, <span class="keyword">this</span>);</span><br><span class="line">    mCodec-&gt;setCallback(reply);</span><br><span class="line"></span><br><span class="line">    err = mCodec-&gt;start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    releaseAndResetMediaBuffers();</span><br><span class="line"></span><br><span class="line">    mPaused = <span class="literal">false</span>;</span><br><span class="line">    mResumePending = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨onConfigureä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨MediaCodec::CreateByType(â€¦)æˆ–è€…MediaCodec::CreateByComponentName(â€¦)æ ¹æ®æƒ…å†µåˆ›å»ºMediaCodecï¼Œæ¥ç€è°ƒç”¨MediaCodec::init(â€¦)ï¼Œéšåè°ƒç”¨MediaCodec::configure(â€¦)å¯¹MediaCodecè¿›è¡Œé…ç½®ä½¿å…¶è½¬å…¥ConfiguredçŠ¶æ€;ç„¶ååˆè°ƒç”¨MediaCodec::start()ä½¿MediaCodecè½¬å…¥ExecutingçŠ¶æ€ã€‚</p><h5 id="2-3-4ã€MediaCodec-init-â€¦"><a href="#2-3-4ã€MediaCodec-init-â€¦" class="headerlink" title="2.3.4ã€MediaCodec::init(â€¦)"></a>2.3.4ã€MediaCodec::init(â€¦)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodec.cpp]</span><br><span class="line">sp&lt;MediaCodec&gt; MediaCodec::CreateByType(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ALooper&gt; &amp;looper, <span class="keyword">const</span> AString &amp;mime, <span class="keyword">bool</span> encoder, <span class="keyword">status_t</span> *err, <span class="keyword">pid_t</span> pid) &#123;</span><br><span class="line">    sp&lt;MediaCodec&gt; codec = <span class="keyword">new</span> MediaCodec(looper, pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">status_t</span> ret = codec-&gt;init(mime, <span class="literal">true</span> <span class="comment">/* nameIsType */</span>, encoder);</span><br><span class="line">    <span class="keyword">return</span> ret == OK ? codec : <span class="literal">NULL</span>; <span class="comment">// NULL deallocates codec.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;MediaCodec&gt; MediaCodec::CreateByComponentName(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ALooper&gt; &amp;looper, <span class="keyword">const</span> AString &amp;name, <span class="keyword">status_t</span> *err, <span class="keyword">pid_t</span> pid) &#123;</span><br><span class="line">    sp&lt;MediaCodec&gt; codec = <span class="keyword">new</span> MediaCodec(looper, pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">status_t</span> ret = codec-&gt;init(name, <span class="literal">false</span> <span class="comment">/* nameIsType */</span>, <span class="literal">false</span> <span class="comment">/* encoder */</span>);</span><br><span class="line">    <span class="keyword">return</span> ret == OK ? codec : <span class="literal">NULL</span>; <span class="comment">// NULL deallocates codec.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;MediaCodec&gt; MediaCodec::CreateByType(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ALooper&gt; &amp;looper, <span class="keyword">const</span> AString &amp;mime, <span class="keyword">bool</span> encoder, <span class="keyword">status_t</span> *err, <span class="keyword">pid_t</span> pid) &#123;</span><br><span class="line">    sp&lt;MediaCodec&gt; codec = <span class="keyword">new</span> MediaCodec(looper, pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">status_t</span> ret = codec-&gt;init(mime, <span class="literal">true</span> <span class="comment">/* nameIsType */</span>, encoder);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *err = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret == OK ? codec : <span class="literal">NULL</span>; <span class="comment">// NULL deallocates codec.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">status_t</span> MediaCodec::init(<span class="keyword">const</span> AString &amp;name, <span class="keyword">bool</span> nameIsType, <span class="keyword">bool</span> encoder) &#123;</span><br><span class="line">    mResourceManagerService-&gt;init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// save init parameters for reset</span></span><br><span class="line">    mInitName = name;</span><br><span class="line">    mInitNameIsType = nameIsType;</span><br><span class="line">    mInitIsEncoder = encoder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Current video decoders do not return from OMX_FillThisBuffer</span></span><br><span class="line">    <span class="comment">// quickly, violating the OpenMAX specs, until that is remedied</span></span><br><span class="line">    <span class="comment">// we need to invest in an extra looper to free the main event</span></span><br><span class="line">    <span class="comment">// queue.</span></span><br><span class="line"></span><br><span class="line">    mCodec = GetCodecBase(name, nameIsType);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> secureCodec = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (nameIsType &amp;&amp; !strncasecmp(name.c_str(), <span class="string">"video/"</span>, <span class="number">6</span>)) &#123;</span><br><span class="line">        mIsVideo = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        AString tmp = name;</span><br><span class="line">        <span class="keyword">if</span> (tmp.endsWith(<span class="string">".secure"</span>)) &#123;</span><br><span class="line">            secureCodec = <span class="literal">true</span>;</span><br><span class="line">            tmp.erase(tmp.size() - <span class="number">7</span>, <span class="number">7</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IMediaCodecList&gt; mcl = MediaCodecList::getInstance();</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">ssize_t</span> codecIdx = mcl-&gt;findCodecByName(tmp.c_str());</span><br><span class="line">        <span class="keyword">if</span> (codecIdx &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> sp&lt;MediaCodecInfo&gt; info = mcl-&gt;getCodecInfo(codecIdx);</span><br><span class="line">            Vector&lt;AString&gt; mimes;</span><br><span class="line">            info-&gt;getSupportedMimes(&amp;mimes);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mimes.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mimes[i].startsWith(<span class="string">"video/"</span>)) &#123;</span><br><span class="line">                    mIsVideo = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsVideo) &#123;</span><br><span class="line">        <span class="comment">// video codec needs dedicated looper</span></span><br><span class="line">        <span class="keyword">if</span> (mCodecLooper == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mCodecLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">            mCodecLooper-&gt;setName(<span class="string">"CodecLooper"</span>);</span><br><span class="line">            mCodecLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCodecLooper-&gt;registerHandler(mCodec);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mLooper-&gt;registerHandler(mCodec);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLooper-&gt;registerHandler(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    mCodec-&gt;setNotificationMessage(<span class="keyword">new</span> AMessage(kWhatCodecNotify, <span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatInit, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setString(<span class="string">"name"</span>, name);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"nameIsType"</span>, nameIsType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nameIsType) &#123;</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"encoder"</span>, encoder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    Vector&lt;MediaResource&gt; resources;</span><br><span class="line">    MediaResource::Type type =</span><br><span class="line">            secureCodec ? MediaResource::kSecureCodec : MediaResource::kNonSecureCodec;</span><br><span class="line">    MediaResource::SubType subtype =</span><br><span class="line">            mIsVideo ? MediaResource::kVideoCodec : MediaResource::kAudioCodec;</span><br><span class="line">    resources.push_back(MediaResource(type, subtype, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= kMaxRetry; ++i) &#123;</span><br><span class="line">        </span><br><span class="line">        sp&lt;AMessage&gt; response;</span><br><span class="line">        err = PostAndAwaitResponse(msg, &amp;response);</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-4-1ã€GetCodecBase"><a href="#2-3-4-1ã€GetCodecBase" class="headerlink" title="2.3.4.1ã€GetCodecBase"></a>2.3.4.1ã€GetCodecBase</h5><p>å½“ç¼–è§£ç ä»¥â€omx.â€å¼€å¤´åˆ™åˆ›å»ºACodecå¯¹è±¡ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodec.cpp]</span><br><span class="line">sp&lt;CodecBase&gt; MediaCodec::GetCodecBase(<span class="keyword">const</span> AString &amp;name, <span class="keyword">bool</span> nameIsType) &#123;</span><br><span class="line">    <span class="comment">// at this time only ACodec specifies a mime type.</span></span><br><span class="line">    <span class="keyword">if</span> (nameIsType || name.startsWithIgnoreCase(<span class="string">"omx."</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ACodec;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWithIgnoreCase(<span class="string">"android.filter."</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MediaFilter;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="2-3-4-2ã€MediaCodecList-getInstance"><a href="#2-3-4-2ã€MediaCodecList-getInstance" class="headerlink" title="2.3.4.2ã€MediaCodecList::getInstance()"></a>2.3.4.2ã€MediaCodecList::getInstance()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodecList.cpp]</span><br><span class="line">sp&lt;IMediaCodecList&gt; MediaCodecList::getInstance() &#123;</span><br><span class="line">    Mutex::Autolock _l(sRemoteInitMutex);</span><br><span class="line">    <span class="keyword">if</span> (sRemoteList == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sp&lt;IBinder&gt; binder =</span><br><span class="line">            defaultServiceManager()-&gt;getService(String16(<span class="string">"media.player"</span>));</span><br><span class="line">        sp&lt;IMediaPlayerService&gt; service =</span><br><span class="line">            interface_cast&lt;IMediaPlayerService&gt;(binder);</span><br><span class="line">        <span class="keyword">if</span> (service.get() != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sRemoteList = service-&gt;getCodecList();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sRemoteList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡Binderé€šä¿¡è·å–MediaCodecåˆ—è¡¨ã€‚getCodecList()å‡½æ•°å®ç°åœ¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\MediaPlayerService.cpp]</span><br><span class="line">sp&lt;IMediaCodecList&gt; MediaPlayerService::getCodecList() <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> MediaCodecList::getLocalInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodecList.cpp]</span><br><span class="line">sp&lt;IMediaCodecList&gt; MediaCodecList::getLocalInstance() &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(sInitMutex)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (sCodecList == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        MediaCodecList *codecList = <span class="keyword">new</span> MediaCodecList;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sCodecList;</span><br><span class="line">&#125;</span><br><span class="line">MediaCodecList::MediaCodecList()</span><br><span class="line">    : mInitCheck(NO_INIT),</span><br><span class="line">      mUpdate(<span class="literal">false</span>),</span><br><span class="line">      mGlobalSettings(<span class="keyword">new</span> AMessage()) &#123;</span><br><span class="line">    parseTopLevelXMLFile(<span class="string">"/etc/media_codecs.xml"</span>);</span><br><span class="line">    parseTopLevelXMLFile(<span class="string">"/etc/media_codecs_performance.xml"</span>, <span class="literal">true</span><span class="comment">/* ignore_errors */</span>);</span><br><span class="line">    parseTopLevelXMLFile(kProfilingResults, <span class="literal">true</span><span class="comment">/* ignore_errors */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œç»ˆäºåˆ†æåˆ°CodecsåŠ è½½çš„åœ°æ–¹äº†ã€‚è¿˜è®°å¾—ç¬¬ä¸€ç« èŠ‚åˆ†æçš„é™„å½•å—ï¼Œé«˜é€šçš„éŸ³è§†é¢‘ç¡¬è§£ç ï¼Œè¿™é‡Œå†è´´ä¸€ä¸‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[AOSP/device/qcom/msm8996/media_codecs.xml(system/etc/media_codecs.xml)]</span><br><span class="line"></span><br><span class="line">    &lt;Decoders&gt;</span><br><span class="line">       &lt;!-- Video Hardware  --&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.avc"</span> type=<span class="string">"video/avc"</span> &gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-input-ports"</span> /&gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-output-ports"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"size"</span> min=<span class="string">"64x64"</span> max=<span class="string">"4096x2160"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"alignment"</span> value=<span class="string">"2x2"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"block-size"</span> value=<span class="string">"16x16"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"blocks-per-second"</span> min=<span class="string">"1"</span> max=<span class="string">"1958400"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"bitrate"</span> range=<span class="string">"1-100000000"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"frame-rate"</span> range=<span class="string">"1-240"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-version"</span> value=<span class="string">"65537"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-low-latency"</span> value=<span class="string">"1"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-macroblock-processing-rate"</span> value=<span class="string">"972000"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-level"</span> value=<span class="string">"52"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-instances"</span> value=<span class="string">"16"</span> /&gt;</span><br><span class="line">            &lt;Feature name=<span class="string">"adaptive-playback"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"concurrent-instances"</span> max=<span class="string">"16"</span> /&gt;</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.avc.secure"</span> type=<span class="string">"video/avc"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.mpeg4"</span> type=<span class="string">"video/mp4v-es"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.h263"</span> type=<span class="string">"video/3gpp"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vc1"</span> type=<span class="string">"video/x-ms-wmv"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vc1.secure"</span> type=<span class="string">"video/x-ms-wmv"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx"</span> type=<span class="string">"video/divx"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx311"</span> type=<span class="string">"video/divx311"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx4"</span> type=<span class="string">"video/divx4"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp8"</span> type=<span class="string">"video/x-vnd.on2.vp8"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp9"</span> type=<span class="string">"video/x-vnd.on2.vp9"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp9.secure"</span> type=<span class="string">"video/x-vnd.on2.vp9"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.hevc"</span> type=<span class="string">"video/hevc"</span> &gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.hevc.secure"</span> type=<span class="string">"video/hevc"</span> &gt;</span><br><span class="line">        &lt;!-- Audio Software  --&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qti.audio.decoder.flac"</span> type=<span class="string">"audio/flac"</span> /&gt;</span><br><span class="line">    &lt;/Decoders&gt;</span><br><span class="line">    &lt;Include href=<span class="string">"media_codecs_google_video.xml"</span> /&gt;</span><br></pre></td></tr></table></figure><h5 id="2-3-5ã€MediaCodec-gt-configure"><a href="#2-3-5ã€MediaCodec-gt-configure" class="headerlink" title="2.3.5ã€MediaCodec-&gt;configure()"></a>2.3.5ã€MediaCodec-&gt;configure()</h5><p>äº§ç”ŸkWhatConfigureæ¶ˆæ¯ï¼Œåœ¨æ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨ACodec::initiateConfigureComponent(â€¦)åˆäº§ç”Ÿæ¶ˆæ¯kWhatConfigureComponentï¼Œç„¶åè¯¥æ¶ˆæ¯å¤„ç†ä¸­åˆè°ƒç”¨äº†ACodec::LoadedState::onConfigureComponent(â€¦)ã€‚ç„¶ååœ¨å…¶ä¸­åˆä¼šå…ˆè°ƒç”¨ACodec::configureCodec(â€¦)ï¼Œåœ¨configureCodecä¸­ä¼šå¯¹IOMXè¿›è¡Œä¸€ç³»åˆ—çš„è®¾ç½®ä»¥åŠé…ç½®æ“ä½œï¼Œé€šè¿‡Binderé€šä¿¡å°±å¯¹OMXNodeInstanceè¿›è¡Œç›¸åº”çš„è®¾ç½®å’Œé…ç½®æ“ä½œï¼Œæœ€ç»ˆå°±å¯¹OMXç»„ä»¶è¿›è¡Œäº†ç›¸åº”çš„è®¾ç½®å’Œé…ç½®ã€‚ç„¶åå‘MediaCodecå‘é€kWhatComponentConfiguredæ¶ˆæ¯ï¼Œåœ¨æ¶ˆæ¯å¤„ç†ä¸­å°†MediaCodecçŠ¶æ€è®¾ä¸ºCONFIGUREDï¼›</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodec.cpp]</span><br><span class="line"><span class="keyword">status_t</span> MediaCodec::configure(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;format,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Surface&gt; &amp;surface,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ICrypto&gt; &amp;crypto,</span><br><span class="line">        <span class="keyword">uint32_t</span> flags) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatConfigure, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">case</span> kWhatConfigure:</span><br><span class="line">        &#123;</span><br><span class="line">            sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">            ......</span><br><span class="line">            sp&lt;RefBase&gt; obj;</span><br><span class="line">            sp&lt;AMessage&gt; format;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                format-&gt;setObject(<span class="string">"native-window"</span>, obj);</span><br><span class="line">                <span class="keyword">status_t</span> err = handleSetSurface(<span class="keyword">static_cast</span>&lt;Surface *&gt;(obj.get()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                handleSetSurface(<span class="literal">NULL</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mReplyID = replyID;</span><br><span class="line">            setState(CONFIGURING);</span><br><span class="line">            ......</span><br><span class="line">            extractCSD(format);</span><br><span class="line"></span><br><span class="line">            mCodec-&gt;initiateConfigureComponent(format);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">void</span> ACodec::initiateConfigureComponent(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    msg-&gt;setWhat(kWhatConfigureComponent);</span><br><span class="line">    msg-&gt;setTarget(<span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ACodec::kWhatConfigureComponent:</span><br><span class="line">        &#123;</span><br><span class="line">            onConfigureComponent(msg);</span><br><span class="line">            handled = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">bool</span> ACodec::LoadedState::onConfigureComponent(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> err = OK;</span><br><span class="line">    AString mime;</span><br><span class="line">    <span class="keyword">if</span> (!msg-&gt;findString(<span class="string">"mime"</span>, &amp;mime)) &#123;</span><br><span class="line">        err = BAD_VALUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = mCodec-&gt;configureCodec(mime.c_str(), msg);</span><br><span class="line">    &#125;</span><br><span class="line">   ......</span><br><span class="line">    &#123;</span><br><span class="line">        sp&lt;AMessage&gt; notify = mCodec-&gt;mNotify-&gt;dup();</span><br><span class="line">        notify-&gt;setInt32(<span class="string">"what"</span>, CodecBase::kWhatComponentConfigured);</span><br><span class="line">        notify-&gt;setMessage(<span class="string">"input-format"</span>, mCodec-&gt;mInputFormat);</span><br><span class="line">        notify-&gt;setMessage(<span class="string">"output-format"</span>, mCodec-&gt;mOutputFormat);</span><br><span class="line">        notify-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-6ã€MediaCodec-gt-start"><a href="#2-3-6ã€MediaCodec-gt-start" class="headerlink" title="2.3.6ã€MediaCodec-&gt;start()"></a>2.3.6ã€MediaCodec-&gt;start()</h5><p>äº§ç”ŸkWhatStartæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†ä¸­å…ˆå°†MediaCodecçŠ¶æ€è®¾ä¸ºSTARTINGï¼Œç„¶åè°ƒç”¨ACodec::initiateStart()äº§ç”ŸkWhatStartæ¶ˆæ¯ï¼Œåœ¨å…¶æ¶ˆæ¯å¤„ç†ä¸­åˆè°ƒç”¨ACodec::LoadedState::onStart()ï¼Œç„¶ååœ¨å…¶ä¸­é¦–å…ˆå‘IOMXå‘é€çŠ¶æ€è½¬æ¢å‘½ä»¤ï¼Œç»è¿‡OMXNodeInstanceæœ€ç»ˆå¯¹å°†OMXç»„ä»¶çŠ¶æ€è½¬æ¢æˆIdleï¼ˆè½¬æ¢å®Œæˆæ—¶OMXä¼šå‘é€OMX_EventCmdCompleteäº‹ä»¶ï¼‰ï¼Œæ¥ç€å¯¹ACodecè¿›è¡ŒchangeStateè‡³LoadedToIdleStateã€‚è€Œåœ¨changeStateè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ACodec::LoadedToIdleState::stateEntered() =&gt;  ACodec::LoadedToIdleState::allocateBuffers() =&gt; ACodec::allocateBuffersOnPort(â€¦)ï¼Œå…¶ä¸­ä¼šä¸ºOMXç»„ä»¶ç«¯å£åˆ†é…ç¼“å†²ï¼Œå¹¶å‘MediaCodecå‘é€æ¶ˆæ¯kWhatBuffersAllocatedï¼Œæ¶ˆæ¯å¤„ç†ä¸­å°†MediaCodecçŠ¶æ€è®¾ä¸ºSTARTEDè€Œè‹¥allocateBufferså¤±è´¥åˆ™ç”±IOMXç»OMXNodeInstanceå°†OMXç»„ä»¶è½¬æ¢å›LoadedçŠ¶æ€ï¼ŒåŒæ—¶æŠŠACodecçŠ¶æ€è½¬æ¢å›LoadedState</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodec.cpp]</span><br><span class="line"><span class="keyword">status_t</span> MediaCodec::start() &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatStart, <span class="keyword">this</span>);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">case</span> kWhatStart:</span><br><span class="line">        &#123;</span><br><span class="line">            sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">            ......</span><br><span class="line">            setState(STARTING);</span><br><span class="line"></span><br><span class="line">            mCodec-&gt;initiateStart();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">void</span> ACodec::initiateStart() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatStart, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ACodec::kWhatStart:</span><br><span class="line">        &#123;</span><br><span class="line">            onStart();</span><br><span class="line">            handled = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ACodec::LoadedState::onStart() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> err = mCodec-&gt;mOMX-&gt;sendCommand(mCodec-&gt;mNode, OMX_CommandStateSet, OMX_StateIdle);</span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        mCodec-&gt;signalError(OMX_ErrorUndefined, makeNoSideEffectStatus(err));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mCodec-&gt;changeState(mCodec-&gt;mLoadedToIdleState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦ç¼“å†²åŒºæˆåŠŸåˆ†é…åˆ°è¾“å…¥å’Œè¾“å‡ºç«¯å£ï¼ŒOMXç»„ä»¶ï¼ˆç¼–è§£ç ï¼‰ä¼šä¸ºLoaded-to-IdleçŠ¶æ€ç”ŸæˆOMX_EventCmdCompleteäº‹ä»¶è½¬æ¢å¹¶ä½¿ç”¨EventHandlerCallbackå°†å…¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p><h4 id="ï¼ˆä¸‰ï¼‰ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†"><a href="#ï¼ˆä¸‰ï¼‰ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†"></a>ï¼ˆä¸‰ï¼‰ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†</h4><h5 id="3-1ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†-emptyBuffer"><a href="#3-1ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†-emptyBuffer" class="headerlink" title="3.1ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†-emptyBuffer"></a>3.1ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†-emptyBuffer</h5><p>è¿˜æ˜¯è€æ ·å­ï¼Œå…ˆçœ‹çœ‹æ—¶åºå›¾ï¼Œç„¶åä¸€æ­¥æ­¥åˆ†æ</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/02-03-acodec-emptyBuffer.png" alt="Alt text"></p><p>1ã€    MediaCodec::start()ä¹‹åACodecæ˜¯åœ¨LoadedToIdleStateçŠ¶æ€ï¼Œæ­¤æ—¶è‹¥ACodec::LoadedToIdleState::onOMXEvent(â€¦)æ¥æ”¶åˆ°ç»„ä»¶è½¬æ¢è‡³IdleçŠ¶æ€åçš„OMX_EventCmdCompleteäº‹ä»¶ï¼Œä¼šå‘IOMXå‘é€çŠ¶æ€è½¬æ¢å‘½ä»¤ï¼Œç»è¿‡OMXNodeInstanceæœ€ç»ˆå¯¹å°†OMXç»„ä»¶çŠ¶æ€è½¬æ¢æˆExecutingçŠ¶æ€ï¼ˆè¿™é‡ŒOMXä¼šå‘é€OMX_EventCmdCompleteäº‹ä»¶ï¼‰ï¼Œç„¶åACodecè¿›è¡ŒchangeStateè‡³IdleToExecutingStateã€‚<br>2ã€    æ­¤æ—¶ACodec::IdleToExecutingState::onOMXEvent(â€¦)æ£€æµ‹åˆ°ä¸Šé¢çš„OMX_EventCmdCompleteäº‹ä»¶åï¼Œä¼šé¦–å…ˆè°ƒç”¨å‡½æ•°ACodec::ExecutingState::resume()ï¼Œç„¶åå¯¹ACodecè¿›è¡ŒchangeStateè‡³ExecutingStateã€‚</p><h5 id="3-1-1ã€ACodec-ExecutingState-resume"><a href="#3-1-1ã€ACodec-ExecutingState-resume" class="headerlink" title="3.1.1ã€ACodec::ExecutingState::resume()"></a>3.1.1ã€ACodec::ExecutingState::resume()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">void</span> ACodec::ExecutingState::resume() &#123;</span><br><span class="line">    submitOutputBuffers();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mCodec-&gt;mBuffers[kPortIndexInput].size(); i++) &#123;</span><br><span class="line">        BufferInfo *info = &amp;mCodec-&gt;mBuffers[kPortIndexInput].editItemAt(i);</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;mStatus == BufferInfo::OWNED_BY_US) &#123;</span><br><span class="line">            postFillThisBuffer(info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mActive = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ACodec::BaseState::postFillThisBuffer(BufferInfo *info) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mCodec-&gt;mPortEOS[kPortIndexInput]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHECK_EQ((<span class="keyword">int</span>)info-&gt;mStatus, (<span class="keyword">int</span>)BufferInfo::OWNED_BY_US);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = mCodec-&gt;mNotify-&gt;dup();</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"what"</span>, CodecBase::kWhatFillThisBuffer);</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"buffer-id"</span>, info-&gt;mBufferID);</span><br><span class="line"></span><br><span class="line">    info-&gt;mData-&gt;meta()-&gt;clear();</span><br><span class="line">    notify-&gt;setBuffer(<span class="string">"buffer"</span>, info-&gt;mData);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatInputBufferFilled, mCodec);</span><br><span class="line">    reply-&gt;setInt32(<span class="string">"buffer-id"</span>, info-&gt;mBufferID);</span><br><span class="line"></span><br><span class="line">    notify-&gt;setMessage(<span class="string">"reply"</span>, reply);</span><br><span class="line"></span><br><span class="line">    notify-&gt;post();</span><br><span class="line"></span><br><span class="line">    info-&gt;mStatus = BufferInfo::OWNED_BY_UPSTREAM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°ACodec::ExecutingState::resume()ä¸­ä¼šè°ƒç”¨ACodec::BaseState::postFillThisBuffer(â€¦)ï¼Œç„¶åå…¶ä¸­ä¼šå…ˆå‘MediaCodecå‘é€kWhatFillThisBufferæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†ä¸­åœ¨æ»¡è¶³ç›¸åº”çš„æ¡ä»¶ä¸‹å°±ä¼šå»è°ƒç”¨å‡½æ•°MediaCodec::onInputBufferAvailable()æ¥é€šçŸ¥NuPlayer::Decoderæœ‰å¯ç”¨çš„inputbufferï¼›ç„¶åå†ç”ŸæˆkWhatInputBufferFilledæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨ACodec::BaseState::onInputBufferFilled(â€¦)ã€‚<br>ã€äº§ç”Ÿä¸¤ä¸ªæ¶ˆæ¯ï¼Œä¸€ä¸ªå‘ä¸Š(MediaCodec)å¤„ç†ï¼Œä¸€ä¸ªå‘ä¸‹(OMX)å¤„ç†ã€‘</p><h5 id="3-1-1-1ã€kWhatFillThisBufferæ¶ˆæ¯å¤„ç†"><a href="#3-1-1-1ã€kWhatFillThisBufferæ¶ˆæ¯å¤„ç†" class="headerlink" title="3.1.1.1ã€kWhatFillThisBufferæ¶ˆæ¯å¤„ç†"></a>3.1.1.1ã€kWhatFillThisBufferæ¶ˆæ¯å¤„ç†</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodec.cpp]</span><br><span class="line">                <span class="keyword">case</span> CodecBase::kWhatFillThisBuffer:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">/* size_t index = */</span>updateBuffers(kPortIndexInput, msg);</span><br><span class="line">                    ......</span><br><span class="line">                    <span class="keyword">if</span> (mFlags &amp; kFlagIsAsync) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!mHaveInputSurface) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (mState == FLUSHED) &#123;</span><br><span class="line">                                mHavePendingInputBuffers = <span class="literal">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                onInputBufferAvailable();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFlags &amp; kFlagDequeueInputPending) &#123;</span><br><span class="line">                        ++mDequeueInputTimeoutGeneration;</span><br><span class="line">                        mFlags &amp;= ~kFlagDequeueInputPending;</span><br><span class="line">                        mDequeueInputReplyID = <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        postActivityNotificationIfPossible();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="keyword">void</span> MediaCodec::onInputBufferAvailable() &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    <span class="keyword">while</span> ((index = dequeuePortBuffer(kPortIndexInput)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = mCallback-&gt;dup();</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"callbackID"</span>, CB_INPUT_AVAILABLE);</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"index"</span>, index);</span><br><span class="line">        msg-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>P.S. 1ï¼šMediaCodec::onInputBufferAvailable()çš„è°ƒç”¨ï¼š<br>å…¶ä¸­ä¼šå…ˆè°ƒç”¨å‡½æ•°MediaCodec::dequeuePortBuffer(â€¦)è·å–bufferçš„ç´¢å¼•ï¼Œç„¶åå°†ä¸€ä¸ªæ–°æ¶ˆæ¯å‘é€ç»™NuPlayer::Decoderï¼Œå¹¶è®¾ç½®æ¶ˆæ¯çš„callbackIDä¸ºCB_INPUT_AVAILABLEï¼ŒåŒæ—¶è®¾ç½®indexï¼Œæ¥ç€NuPlayer::Decoderæ¥æ”¶åˆ°è¯¥CB_INPUT_AVAILABLEæ¶ˆæ¯ï¼Œåœ¨æ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨NuPlayer::Decoder::handleAnInputBuffer(â€¦)ï¼Œå…¶ä¼šï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">case</span> MediaCodec::CB_INPUT_AVAILABLE:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"index"</span>, &amp;index));</span><br><span class="line"></span><br><span class="line">    handleAnInputBuffer(index);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">bool</span> NuPlayer::Decoder::handleAnInputBuffer(<span class="keyword">size_t</span> index) &#123;</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    mCodec-&gt;getInputBuffer(index, &amp;buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mInputBuffers.size()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = mInputBuffers.size(); i &lt;= index; ++i) &#123;</span><br><span class="line">            mInputBuffers.add();</span><br><span class="line">            mMediaBuffers.add();</span><br><span class="line">            mInputBufferIsDequeued.add();</span><br><span class="line">            mMediaBuffers.editItemAt(i) = <span class="literal">NULL</span>;</span><br><span class="line">            mInputBufferIsDequeued.editItemAt(i) = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBuffers.editItemAt(index) = buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mMediaBuffers[index] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mMediaBuffers[index]-&gt;release();</span><br><span class="line">        mMediaBuffers.editItemAt(index) = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBufferIsDequeued.editItemAt(index) = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mCSDsToSubmit.isEmpty()) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage();</span><br><span class="line">        msg-&gt;setSize(<span class="string">"buffer-ix"</span>, index);</span><br><span class="line"></span><br><span class="line">        sp&lt;ABuffer&gt; buffer = mCSDsToSubmit.itemAt(<span class="number">0</span>);</span><br><span class="line">        msg-&gt;setBuffer(<span class="string">"buffer"</span>, buffer);</span><br><span class="line">        mCSDsToSubmit.removeAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!mPendingInputMessages.empty()) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = *mPendingInputMessages.begin();</span><br><span class="line">        <span class="keyword">if</span> (!onInputBufferFetched(msg)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingInputMessages.erase(mPendingInputMessages.begin());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mInputBufferIsDequeued.editItemAt(index)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDequeuedInputBuffers.push_back(index);</span><br><span class="line"></span><br><span class="line">    onRequestInputBuffers();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â—‹1ã€å…ˆé€šè¿‡MediaCodec::getInputBuffer(â€¦) -&gt; MediaCodec::getBufferAndFormat(â€¦)è·å–è¯¥buffer</p><p>â—‹2ã€ç„¶åè°ƒç”¨NuPlayer::Decoder::onInputBufferFetched(â€¦)æ‰§è¡Œå†…å­˜æ‹·è´å°†bufferæ‹·è´åˆ°ç¼–è§£ç å™¨ï¼Œç„¶ååˆè°ƒç”¨äº†MediaCodec::queueInputBuffer(â€¦)å°†bufferæäº¤ç»™è§£ç å™¨ï¼Œå…¶ä¼šäº§ç”Ÿæ¶ˆæ¯kWhatQueueInputBufferï¼Œæ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨MediaCodec::onQueueInputBuffer(â€¦)</p><p>â—‹3ã€ä¹‹åè°ƒç”¨å‡½æ•°NuPlayer::DecoderBase::onRequestInputBuffers()ï¼Œå¤„ç†æ˜¯å¦éœ€è¦æ›´å¤šçš„æ•°æ®ã€‚å…¶ä¸­ä¼šè°ƒç”¨NuPlayer::Decoder::doRequestBuffersï¼Œè‹¥è¿”å›trueåˆ™éœ€è¦æ›´å¤šçš„æ•°æ®ï¼Œåˆ™ä¼šäº§ç”Ÿæ–°æ¶ˆæ¯kWhatRequestInputBuffersï¼Œæ¶ˆæ¯å¤„ç†ä¸­åˆå°†è°ƒç”¨onRequestInputBuffersã€‚ï¼ˆå®é™…è·å–æ›´å¤šç¼“å†²çš„æ“ä½œåœ¨ä¸‹é¢ACodecéƒ¨åˆ†å®Œæˆï¼‰</p><h5 id="3-1-1-2ã€kWhatInputBufferFilledæ¶ˆæ¯å¤„ç†"><a href="#3-1-1-2ã€kWhatInputBufferFilledæ¶ˆæ¯å¤„ç†" class="headerlink" title="3.1.1.2ã€kWhatInputBufferFilledæ¶ˆæ¯å¤„ç†"></a>3.1.1.2ã€kWhatInputBufferFilledæ¶ˆæ¯å¤„ç†</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line">        <span class="keyword">case</span> kWhatInputBufferFilled:</span><br><span class="line">        &#123;</span><br><span class="line">            onInputBufferFilled(msg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">void</span> ACodec::BaseState::onInputBufferFilled(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    IOMX::buffer_id bufferID;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"buffer-id"</span>, (<span class="keyword">int32_t</span>*)&amp;bufferID));</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    <span class="keyword">int32_t</span> err = OK;</span><br><span class="line">    <span class="keyword">bool</span> eos = <span class="literal">false</span>;</span><br><span class="line">    PortMode mode = getPortMode(kPortIndexInput);</span><br><span class="line">    <span class="keyword">int32_t</span> tmp;</span><br><span class="line">    BufferInfo *info = mCodec-&gt;findBufferByID(kPortIndexInput, bufferID);</span><br><span class="line">    BufferInfo::Status status = BufferInfo::getSafeStatus(info);</span><br><span class="line">    info-&gt;mStatus = BufferInfo::OWNED_BY_US;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> KEEP_BUFFERS:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (eos) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mCodec-&gt;mPortEOS[kPortIndexInput]) &#123;</span><br><span class="line">                    mCodec-&gt;mPortEOS[kPortIndexInput] = <span class="literal">true</span>;</span><br><span class="line">                    mCodec-&gt;mInputEOSResult = err;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> RESUBMIT_BUFFERS:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (buffer != <span class="literal">NULL</span> &amp;&amp; !mCodec-&gt;mPortEOS[kPortIndexInput]) &#123;</span><br><span class="line">                <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">                CHECK(buffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs));</span><br><span class="line"></span><br><span class="line">                OMX_U32 flags = OMX_BUFFERFLAG_ENDOFFRAME;</span><br><span class="line"></span><br><span class="line">                MetadataBufferType metaType = mCodec-&gt;mInputMetadataType;</span><br><span class="line">                <span class="keyword">int32_t</span> isCSD = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (buffer-&gt;meta()-&gt;findInt32(<span class="string">"csd"</span>, &amp;isCSD) &amp;&amp; isCSD != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mCodec-&gt;mIsLegacyVP9Decoder) &#123;</span><br><span class="line">                        postFillThisBuffer(info);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    flags |= OMX_BUFFERFLAG_CODECCONFIG;</span><br><span class="line">                    metaType = kMetadataBufferTypeInvalid;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">               ......</span><br><span class="line">                <span class="keyword">if</span> (buffer != info-&gt;mCodecData) &#123;</span><br><span class="line">                    sp&lt;DataConverter&gt; converter = mCodec-&gt;mConverter[kPortIndexInput];</span><br><span class="line">                    <span class="keyword">status_t</span> err = converter-&gt;convert(buffer, info-&gt;mCodecData);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                info-&gt;checkReadFence(<span class="string">"onInputBufferFilled"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">status_t</span> err2 = OK;</span><br><span class="line">                <span class="keyword">switch</span> (metaType) &#123;</span><br><span class="line">                <span class="keyword">case</span> kMetadataBufferTypeInvalid:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> OMX_ANDROID_COMPILE_AS_32BIT_ON_64BIT_PLATFORMS</span></span><br><span class="line">                <span class="keyword">case</span> kMetadataBufferTypeNativeHandleSource:</span><br><span class="line">                    <span class="keyword">if</span> (info-&gt;mCodecData-&gt;size() &gt;= <span class="keyword">sizeof</span>(VideoNativeHandleMetadata)) &#123;</span><br><span class="line">                        VideoNativeHandleMetadata *vnhmd =</span><br><span class="line">                            (VideoNativeHandleMetadata*)info-&gt;mCodecData-&gt;base();</span><br><span class="line">                        err2 = mCodec-&gt;mOMX-&gt;updateNativeHandleInMeta(</span><br><span class="line">                                mCodec-&gt;mNode, kPortIndexInput,</span><br><span class="line">                                NativeHandle::create(vnhmd-&gt;pHandle, <span class="literal">false</span> <span class="comment">/* ownsHandle */</span>),</span><br><span class="line">                                bufferID);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> kMetadataBufferTypeANWBuffer:</span><br><span class="line">                    <span class="keyword">if</span> (info-&gt;mCodecData-&gt;size() &gt;= <span class="keyword">sizeof</span>(VideoNativeMetadata)) &#123;</span><br><span class="line">                        VideoNativeMetadata *vnmd = (VideoNativeMetadata*)info-&gt;mCodecData-&gt;base();</span><br><span class="line">                        err2 = mCodec-&gt;mOMX-&gt;updateGraphicBufferInMeta(</span><br><span class="line">                                mCodec-&gt;mNode, kPortIndexInput,</span><br><span class="line">                                <span class="keyword">new</span> GraphicBuffer(vnmd-&gt;pBuffer, <span class="literal">false</span> <span class="comment">/* keepOwnership */</span>),</span><br><span class="line">                                bufferID);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    err2 = ERROR_UNSUPPORTED;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err2 == OK) &#123;</span><br><span class="line">                    err2 = mCodec-&gt;mOMX-&gt;emptyBuffer(</span><br><span class="line">                        mCodec-&gt;mNode,</span><br><span class="line">                        bufferID,</span><br><span class="line">                        <span class="number">0</span>,</span><br><span class="line">                        info-&gt;mCodecData-&gt;size(),</span><br><span class="line">                        flags,</span><br><span class="line">                        timeUs,</span><br><span class="line">                        info-&gt;mFenceFd);</span><br><span class="line">                &#125;</span><br><span class="line">                info-&gt;mFenceFd = <span class="number">-1</span>;</span><br><span class="line">                ......</span><br><span class="line">                info-&gt;mStatus = BufferInfo::OWNED_BY_COMPONENT;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!eos &amp;&amp; err == OK) &#123;</span><br><span class="line">                    getMoreInputDataIfPossible();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGV(<span class="string">"[%s] Signalled EOS (%d) on the input port"</span>,</span><br><span class="line">                         mCodec-&gt;mComponentName.c_str(), err);</span><br><span class="line"></span><br><span class="line">                    mCodec-&gt;mPortEOS[kPortIndexInput] = <span class="literal">true</span>;</span><br><span class="line">                    mCodec-&gt;mInputEOSResult = err;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mCodec-&gt;mPortEOS[kPortIndexInput]) &#123;</span><br><span class="line">                ......</span><br><span class="line"></span><br><span class="line">                info-&gt;checkReadFence(<span class="string">"onInputBufferFilled"</span>);</span><br><span class="line">                <span class="keyword">status_t</span> err2 = mCodec-&gt;mOMX-&gt;emptyBuffer(</span><br><span class="line">                        mCodec-&gt;mNode,</span><br><span class="line">                        bufferID,</span><br><span class="line">                        <span class="number">0</span>,</span><br><span class="line">                        <span class="number">0</span>,</span><br><span class="line">                        OMX_BUFFERFLAG_EOS,</span><br><span class="line">                        <span class="number">0</span>,</span><br><span class="line">                        info-&gt;mFenceFd);</span><br><span class="line">                info-&gt;mFenceFd = <span class="number">-1</span>;</span><br><span class="line">                ......</span><br><span class="line">                info-&gt;mStatus = BufferInfo::OWNED_BY_COMPONENT;</span><br><span class="line"></span><br><span class="line">                mCodec-&gt;mPortEOS[kPortIndexInput] = <span class="literal">true</span>;</span><br><span class="line">                mCodec-&gt;mInputEOSResult = err;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>P.S. 2ï¼šACodec::BaseState::onInputBufferFilled(â€¦)çš„è°ƒç”¨ï¼š<br>å› ä¸ºå½“å‰ACodecåœ¨ExecutingStateï¼Œæ‰€ä»¥PortModeä¸ºRESUBMIT_BUFFERSï¼Œæ•…ä¼šè°ƒç”¨IOMXçš„emptyBuffer(â€¦)æ–¹æ³•ï¼Œç»è¿‡è¿›ç¨‹é—´é€šä¿¡è°ƒç”¨åˆ°OMX::emptyBuffer(â€¦)ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨OMXNodeInstance::emptyBuffer(â€¦)ï¼Œå…¶ä¸­åˆä¼šè°ƒç”¨åˆ°å‡½æ•°OMXNodeInstance::emptyBuffer_l(â€¦)ï¼Œå…¶åˆ™ä¼šè°ƒç”¨OMX_EmptyThisBufferå®å¯¹OMXç»„ä»¶è¿›è¡Œç›¸å…³çš„æ“ä½œï¼ˆæ ¹æ®éœ€è¦é€‰æ‹©ç›¸åº”çš„è½¯è§£ç»„ä»¶æˆ–è€…ç¡¬è§£ç»„ä»¶ï¼‰ã€‚å¯¹äºè½¯è§£ç»„ä»¶SoftOMXComponent</p><p>â—‹1ã€å…¶çš„æ„é€ å‡½æ•°çš„åˆå§‹åŒ–åˆ—è¡¨ä¸­æœ‰mComponent-&gt;EmptyThisBuffer = EmptyThisBufferWrapper;æ•…å®é™…ä¼šè°ƒç”¨å…¶EmptyThisBufferWrapper(â€¦)å‡½æ•°ï¼Œè€Œå…¶ä¸­è°ƒç”¨SoftOMXComponentçš„è™šå‡½æ•°emptyThisBufferã€‚</p><p>â—‹2ã€æ‰€ä»¥è°ƒç”¨å­ç±»çš„emptyThisBufferå³SimpleSoftOMXComponent::emptyThisBuffer(â€¦)äº§ç”ŸkWhatEmptyThisBufferæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†ä¸­å®é™…çš„è§£ç å™¨å°±è¦è°ƒç”¨onQueueFilled(â€¦)å‡½æ•°ã€å®é™…ç»„ä»¶ç»§æ‰¿è‡ªSimpleSoftOMXComponentã€‘</p><p>â—‹3ã€æ¥ç€ä¼šè°ƒç”¨SoftOMXComponent::notifyEmptyBufferDone(â€¦)ä½¿ç”¨OMXçš„å›è°ƒæœºåˆ¶ï¼Œé—­ç¯å‘é€æ¶ˆæ¯åˆ°OMXå®¢æˆ·ç«¯ACodecã€‚</p><p>â—‹4ã€è°ƒç”¨åˆ°OMXNodeInstance::OnEmptyBufferDone(â€¦)ï¼Œå…¶åˆä¼šè°ƒç”¨OMX::OnEmptyBufferDone(â€¦)ï¼Œç„¶ååœ¨å…¶ä¸­ä¼šå‘é€omx_message::EMPTY_BUFFER_DONEæ¶ˆæ¯ï¼ŒACodecä¸­æ”¶åˆ°è¯¥æ¶ˆæ¯ã€CodecObserverä¸­å…ˆæ”¶åˆ°ï¼Œä½†åªè®¾ç½®æ¶ˆæ¯ã€‘è°ƒç”¨ACodec::BaseState::onOMXEmptyBufferDone(â€¦)</p><p>â—‹5ã€åœ¨onOMXEmptyBufferDoneä¸­è·å–PortModeï¼Œä¸ºRESUBMIT_BUFFERSåˆ™ACodec::BaseState::postFillThisBuffer(â€¦)è¢«è°ƒç”¨ï¼Œä»è€Œåˆä»3ä¸­çš„postFillThisBufferå¼€å§‹å¾ªç¯æ‰§è¡Œç›¸å…³æ“ä½œä»¥å¤„ç†æ›´å¤šçš„è¾“å…¥ç¼“å†²ã€‚</p><h5 id="3-2ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†-fillBuffer"><a href="#3-2ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†-fillBuffer" class="headerlink" title="3.2ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†-fillBuffer"></a>3.2ã€éŸ³è§†é¢‘è§£ç æ•°æ®å¤„ç†-fillBuffer</h5><p>è¿˜æ˜¯è€æ ·å­ï¼Œå…ˆçœ‹çœ‹æ—¶åºå›¾ï¼Œç„¶åä¸€æ­¥æ­¥åˆ†æ</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/02-04-acodec-fillBuffer.png" alt="Alt text"></p><h5 id="3-2-1ã€ACodec-ExecutingState-resume"><a href="#3-2-1ã€ACodec-ExecutingState-resume" class="headerlink" title="3.2.1ã€ACodec::ExecutingState::resume()"></a>3.2.1ã€ACodec::ExecutingState::resume()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">void</span> ACodec::ExecutingState::resume() &#123;</span><br><span class="line">    submitOutputBuffers();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mCodec-&gt;mBuffers[kPortIndexInput].size(); i++) &#123;</span><br><span class="line">        BufferInfo *info = &amp;mCodec-&gt;mBuffers[kPortIndexInput].editItemAt(i);</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;mStatus == BufferInfo::OWNED_BY_US) &#123;</span><br><span class="line">            postFillThisBuffer(info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActive = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ACodec::ExecutingState::submitOutputBuffers() &#123;</span><br><span class="line">    submitRegularOutputBuffers();</span><br><span class="line">    <span class="keyword">if</span> (mCodec-&gt;storingMetadataInDecodedBuffers()) &#123;</span><br><span class="line">        submitOutputMetaBuffers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ACodec::ExecutingState::submitRegularOutputBuffers() &#123;</span><br><span class="line">    <span class="keyword">bool</span> failed = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mCodec-&gt;mBuffers[kPortIndexOutput].size(); ++i) &#123;</span><br><span class="line">        BufferInfo *info = &amp;mCodec-&gt;mBuffers[kPortIndexOutput].editItemAt(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCodec-&gt;mNativeWindow != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        info-&gt;checkWriteFence(<span class="string">"submitRegularOutputBuffers"</span>);</span><br><span class="line">        <span class="keyword">status_t</span> err = mCodec-&gt;mOMX-&gt;fillBuffer(mCodec-&gt;mNode, info-&gt;mBufferID, info-&gt;mFenceFd);</span><br><span class="line">        info-&gt;mFenceFd = <span class="number">-1</span>;</span><br><span class="line">        ......</span><br><span class="line">        info-&gt;mStatus = BufferInfo::OWNED_BY_COMPONENT;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€ACodec::ExecutingState::resume()å‡½æ•°ï¼Œåœ¨resume()ä¸­è°ƒç”¨ACodec::BaseState::postFillThisBuffer(â€¦)å‰ä¼šå…ˆè°ƒç”¨å‡½æ•°ACodec::ExecutingState::submitOutputBuffers()ï¼Œå³åœ¨è·å–è¾“å…¥æ•°æ®å‰ä¼šå…ˆæŠŠè¾“å‡ºç«¯çš„æ•°æ®æäº¤å‡ºå»ã€‚</p><p>2ã€åœ¨submitOutputBuffers()ä¸­è°ƒç”¨ACodec::ExecutingState::submitRegularOutputBuffers()ï¼Œå…¶ä¸­åˆä¼šè°ƒç”¨åˆ°IOMXçš„fillBuffer (â€¦)æ–¹æ³•ï¼Œç»è¿‡è¿›ç¨‹é—´é€šä¿¡è°ƒç”¨åˆ°OMX:: fillBuffer (â€¦)ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨OMXNodeInstance:: fillBuffer (â€¦)ï¼Œå…¶ä¸­åˆä¼šè°ƒç”¨åˆ°OMX_FillThisBufferå®å¯¹OMXç»„ä»¶è¿›è¡Œç›¸å…³çš„æ“ä½œï¼ˆåŒæ ·æ ¹æ®éœ€è¦é€‰æ‹©ç›¸åº”çš„è½¯è§£ç»„ä»¶æˆ–è€…ç¡¬è§£ç»„ä»¶ï¼‰ã€‚å¯¹äºè½¯è§£ç»„ä»¶SoftOMXComponentï¼šï¼ˆä¸‹é¢çš„æ“ä½œä¸emptyBufferæ—¶ç±»ä¼¼ï¼‰</p><p>â—‹1ã€åœ¨å…¶æ„é€ å‡½æ•°çš„åˆå§‹åŒ–åˆ—è¡¨ä¸­æœ‰mComponent-&gt;FillThisBuffer = FillThisBufferWrapper;æ‰€ä»¥å®é™…ä¼šè°ƒç”¨åˆ°å…¶FillThisBufferWrapper (â€¦)å‡½æ•°<br>â—‹2ã€ç„¶åè°ƒç”¨SimpleSoftOMXComponent::fillThisBuffer(â€¦)äº§ç”ŸkWhatFillThisBufferæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†ä¸­å®é™…çš„ç»„ä»¶å°±è¦è°ƒç”¨onQueueFilled(â€¦)å‡½æ•°ã€å®é™…ç»„ä»¶ç»§æ‰¿è‡ªSimpleSoftOMXComponentã€‘</p><p>â—‹3ã€æ¥ç€ä¼šè°ƒç”¨SoftOMXComponent::notifyFillBufferDone(â€¦)ä½¿ç”¨OMXçš„å›è°ƒæœºåˆ¶ï¼Œé—­ç¯å‘é€æ¶ˆæ¯åˆ°OMXå®¢æˆ·ç«¯ACodecã€‚<br>â—‹4ä¹‹åè°ƒç”¨åˆ°OMXNodeInstance:: OnFillBufferDone (â€¦)å‡½æ•°ï¼Œå…¶åˆä¼šè°ƒç”¨OMX:: OnFillBufferDone (â€¦)ï¼Œç„¶ååœ¨å…¶ä¸­ä¼šå‘é€omx_message:: FILL_BUFFER_DONEæ¶ˆæ¯ï¼ŒACodecä¸­æ”¶åˆ°è¯¥æ¶ˆæ¯ã€CodecObserverä¸­å…ˆæ”¶åˆ°ï¼Œä½†åªè®¾ç½®æ¶ˆæ¯ã€‘è°ƒç”¨ACodec::BaseState:: onOMXFillBufferDone (â€¦)<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">bool</span> ACodec::BaseState::onOMXFillBufferDone(</span><br><span class="line">        IOMX::buffer_id bufferID,</span><br><span class="line">        <span class="keyword">size_t</span> rangeOffset, <span class="keyword">size_t</span> rangeLength,</span><br><span class="line">        OMX_U32 flags,</span><br><span class="line">        <span class="keyword">int64_t</span> timeUs,</span><br><span class="line">        <span class="keyword">int</span> fenceFd) &#123;</span><br><span class="line">    ALOGV(<span class="string">"[%s] onOMXFillBufferDone %u time %"</span> PRId64 <span class="string">" us, flags = 0x%08x"</span>,</span><br><span class="line">         mCodec-&gt;mComponentName.c_str(), bufferID, timeUs, flags);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> index;</span><br><span class="line">    <span class="keyword">status_t</span> err= OK;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TRACK_BUFFER_TIMING</span></span><br><span class="line">    index = mCodec-&gt;mBufferStats.indexOfKey(timeUs);</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        ACodec::BufferStats *stats = &amp;mCodec-&gt;mBufferStats.editValueAt(index);</span><br><span class="line">        stats-&gt;mFillBufferDoneTimeUs = ALooper::GetNowUs();</span><br><span class="line"></span><br><span class="line">        ALOGI(<span class="string">"frame PTS %lld: %lld"</span>,</span><br><span class="line">                timeUs,</span><br><span class="line">                stats-&gt;mFillBufferDoneTimeUs - stats-&gt;mEmptyBufferTimeUs);</span><br><span class="line"></span><br><span class="line">        mCodec-&gt;mBufferStats.removeItemsAt(index);</span><br><span class="line">        stats = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    BufferInfo *info =</span><br><span class="line">        mCodec-&gt;findBufferByID(kPortIndexOutput, bufferID, &amp;index);</span><br><span class="line">    BufferInfo::Status status = BufferInfo::getSafeStatus(info);</span><br><span class="line">    <span class="keyword">if</span> (status != BufferInfo::OWNED_BY_COMPONENT) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Wrong ownership in FBD: %s(%d) buffer #%u"</span>, _asString(status), status, bufferID);</span><br><span class="line">        mCodec-&gt;dumpBuffers(kPortIndexOutput);</span><br><span class="line">        mCodec-&gt;signalError(OMX_ErrorUndefined, FAILED_TRANSACTION);</span><br><span class="line">        <span class="keyword">if</span> (fenceFd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ::close(fenceFd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info-&gt;mDequeuedAt = ++mCodec-&gt;mDequeueCounter;</span><br><span class="line">    info-&gt;mStatus = BufferInfo::OWNED_BY_US;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;mRenderInfo != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// The fence for an emptied buffer must have signaled, but there still could be queued</span></span><br><span class="line">        <span class="comment">// or out-of-order dequeued buffers in the render queue prior to this buffer. Drop these,</span></span><br><span class="line">        <span class="comment">// as we will soon requeue this buffer to the surface. While in theory we could still keep</span></span><br><span class="line">        <span class="comment">// track of buffers that are requeued to the surface, it is better to add support to the</span></span><br><span class="line">        <span class="comment">// buffer-queue to notify us of released buffers and their fences (in the future).</span></span><br><span class="line">        mCodec-&gt;notifyOfRenderedFrames(<span class="literal">true</span> <span class="comment">/* dropIncomplete */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// byte buffers cannot take fences, so wait for any fence now</span></span><br><span class="line">    <span class="keyword">if</span> (mCodec-&gt;mNativeWindow == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (<span class="keyword">void</span>)mCodec-&gt;waitForFence(fenceFd, <span class="string">"onOMXFillBufferDone"</span>);</span><br><span class="line">        fenceFd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    info-&gt;setReadFence(fenceFd, <span class="string">"onOMXFillBufferDone"</span>);</span><br><span class="line"></span><br><span class="line">    PortMode mode = getPortMode(kPortIndexOutput);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> KEEP_BUFFERS:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> RESUBMIT_BUFFERS:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (rangeLength == <span class="number">0</span> &amp;&amp; (!(flags &amp; OMX_BUFFERFLAG_EOS)</span><br><span class="line">                    || mCodec-&gt;mPortEOS[kPortIndexOutput])) &#123;</span><br><span class="line">                ......</span><br><span class="line">                err = mCodec-&gt;mOMX-&gt;fillBuffer(mCodec-&gt;mNode, info-&gt;mBufferID, info-&gt;mFenceFd);</span><br><span class="line">                info-&gt;mFenceFd = <span class="number">-1</span>;</span><br><span class="line">                ......</span><br><span class="line">                info-&gt;mStatus = BufferInfo::OWNED_BY_COMPONENT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sp&lt;AMessage&gt; reply =</span><br><span class="line">                <span class="keyword">new</span> AMessage(kWhatOutputBufferDrained, mCodec);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mCodec-&gt;mOutputFormat != mCodec-&gt;mLastOutputFormat &amp;&amp; rangeLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// pretend that output format has changed on the first frame (we used to do this)</span></span><br><span class="line">                <span class="keyword">if</span> (mCodec-&gt;mBaseOutputFormat == mCodec-&gt;mOutputFormat) &#123;</span><br><span class="line">                    mCodec-&gt;onOutputFormatChanged(mCodec-&gt;mOutputFormat);</span><br><span class="line">                &#125;</span><br><span class="line">                mCodec-&gt;addKeyFormatChangesToRenderBufferNotification(reply);</span><br><span class="line">                mCodec-&gt;sendFormatChange();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rangeLength &gt; <span class="number">0</span> &amp;&amp; mCodec-&gt;mNativeWindow != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// If potentially rendering onto a surface, always save key format data (crop &amp;</span></span><br><span class="line">                <span class="comment">// data space) so that we can set it if and once the buffer is rendered.</span></span><br><span class="line">                mCodec-&gt;addKeyFormatChangesToRenderBufferNotification(reply);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mCodec-&gt;usingMetadataOnEncoderOutput()) &#123;</span><br><span class="line">                <span class="keyword">native_handle_t</span> *handle = <span class="literal">NULL</span>;</span><br><span class="line">                VideoNativeHandleMetadata &amp;nativeMeta =</span><br><span class="line">                    *(VideoNativeHandleMetadata *)info-&gt;mData-&gt;data();</span><br><span class="line">                <span class="keyword">if</span> (info-&gt;mData-&gt;size() &gt;= <span class="keyword">sizeof</span>(nativeMeta)</span><br><span class="line">                        &amp;&amp; nativeMeta.eType == kMetadataBufferTypeNativeHandleSource) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OMX_ANDROID_COMPILE_AS_32BIT_ON_64BIT_PLATFORMS</span></span><br><span class="line">                    <span class="comment">// handle is only valid on 32-bit/mediaserver process</span></span><br><span class="line">                    handle = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                    handle = (<span class="keyword">native_handle_t</span> *)nativeMeta.pHandle;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                &#125;</span><br><span class="line">                info-&gt;mData-&gt;meta()-&gt;setPointer(<span class="string">"handle"</span>, handle);</span><br><span class="line">                info-&gt;mData-&gt;meta()-&gt;setInt32(<span class="string">"rangeOffset"</span>, rangeOffset);</span><br><span class="line">                info-&gt;mData-&gt;meta()-&gt;setInt32(<span class="string">"rangeLength"</span>, rangeLength);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info-&gt;mData == info-&gt;mCodecData) &#123;</span><br><span class="line">                info-&gt;mData-&gt;setRange(rangeOffset, rangeLength);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                info-&gt;mCodecData-&gt;setRange(rangeOffset, rangeLength);</span><br><span class="line">                <span class="comment">// in this case we know that mConverter is not null</span></span><br><span class="line">                <span class="keyword">status_t</span> err = mCodec-&gt;mConverter[kPortIndexOutput]-&gt;convert(</span><br><span class="line">                        info-&gt;mCodecData, info-&gt;mData);</span><br><span class="line">                <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                    mCodec-&gt;signalError(OMX_ErrorUndefined, makeNoSideEffectStatus(err));</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mCodec-&gt;mSkipCutBuffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                mCodec-&gt;mSkipCutBuffer-&gt;submit(info-&gt;mData);</span><br><span class="line">            &#125;</span><br><span class="line">            info-&gt;mData-&gt;meta()-&gt;setInt64(<span class="string">"timeUs"</span>, timeUs);</span><br><span class="line"></span><br><span class="line">            sp&lt;AMessage&gt; notify = mCodec-&gt;mNotify-&gt;dup();</span><br><span class="line">            notify-&gt;setInt32(<span class="string">"what"</span>, CodecBase::kWhatDrainThisBuffer);</span><br><span class="line">            notify-&gt;setInt32(<span class="string">"buffer-id"</span>, info-&gt;mBufferID);</span><br><span class="line">            notify-&gt;setBuffer(<span class="string">"buffer"</span>, info-&gt;mData);</span><br><span class="line">            notify-&gt;setInt32(<span class="string">"flags"</span>, flags);</span><br><span class="line"></span><br><span class="line">            reply-&gt;setInt32(<span class="string">"buffer-id"</span>, info-&gt;mBufferID);</span><br><span class="line"></span><br><span class="line">            notify-&gt;setMessage(<span class="string">"reply"</span>, reply);</span><br><span class="line"></span><br><span class="line">            notify-&gt;post();</span><br><span class="line"></span><br><span class="line">            info-&gt;mStatus = BufferInfo::OWNED_BY_DOWNSTREAM;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (flags &amp; OMX_BUFFERFLAG_EOS) &#123;</span><br><span class="line">                ALOGV(<span class="string">"[%s] saw output EOS"</span>, mCodec-&gt;mComponentName.c_str());</span><br><span class="line"></span><br><span class="line">                sp&lt;AMessage&gt; notify = mCodec-&gt;mNotify-&gt;dup();</span><br><span class="line">                notify-&gt;setInt32(<span class="string">"what"</span>, CodecBase::kWhatEOS);</span><br><span class="line">                notify-&gt;setInt32(<span class="string">"err"</span>, mCodec-&gt;mInputEOSResult);</span><br><span class="line">                notify-&gt;post();</span><br><span class="line"></span><br><span class="line">                mCodec-&gt;mPortEOS[kPortIndexOutput] = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> FREE_BUFFERS:</span><br><span class="line">            err = mCodec-&gt;freeBuffer(kPortIndexOutput, index);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                mCodec-&gt;signalError(OMX_ErrorUndefined, makeNoSideEffectStatus(err));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ALOGE(<span class="string">"Invalid port mode: %d"</span>, mode);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>â—‹5ã€åœ¨onOMXFillBufferDoneä¸­è·å–PortModeï¼Œä¸ºRESUBMIT_BUFFERSåˆ™é¦–å…ˆå¦‚æœéœ€è¦ç»§ç»­è°ƒç”¨åˆ°IOMXçš„fillBuffer (â€¦)å¡«å……è¾“å‡ºç¼“å†²é‡å¤åšç›¸å…³æ“ä½œï¼Œæ¥ç€ACodecåˆä¼šç”Ÿæˆä¸€ä¸ªkWhatOutputBufferDrainedæ¶ˆæ¯å­˜åœ¨replyä¸­ï¼Œä½œä¸ºkWhatDrainThisBufferæ¶ˆæ¯çš„è¿”å›æ¶ˆæ¯ã€notify-&gt;setMessage(â€œreplyâ€, reply);ã€‘ï¼Œç„¶åå‘MediaCodecå‘é€æ¶ˆæ¯kWhatDrainThisBufferï¼Œæ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨å‡½æ•°MediaCodec::onOutputBufferAvailable()é€šçŸ¥NuPlayer::Decoderæœ‰å¯ç”¨çš„output bufferï¼Œå…¶ä¸­ä¼šè®¾ç½®æ¶ˆæ¯çš„callbackIDä¸ºCB_OUTPUT_AVAILABLEï¼ŒåŒæ—¶è®¾ç½®indexï¼Œæ¥ç€NuPlayer::Decoderæ¥æ”¶åˆ°è¯¥CB_OUTPUT_AVAILABLEæ¶ˆæ¯ï¼Œåœ¨æ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨NuPlayer::Decoder::handleAnOutputBuffer(â€¦)ï¼Œåœ¨å…¶ä¸­ä¼šè¿›è¡Œå¦‚ä¸‹å¤„ç†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodec.cpp]</span><br><span class="line"><span class="keyword">void</span> MediaCodec::onOutputBufferAvailable() &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    <span class="keyword">while</span> ((index = dequeuePortBuffer(kPortIndexOutput)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer =</span><br><span class="line">            mPortBuffers[kPortIndexOutput].itemAt(index).mData;</span><br><span class="line">        sp&lt;AMessage&gt; msg = mCallback-&gt;dup();</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"callbackID"</span>, CB_OUTPUT_AVAILABLE);</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"index"</span>, index);</span><br><span class="line">        msg-&gt;setSize(<span class="string">"offset"</span>, buffer-&gt;offset());</span><br><span class="line">        msg-&gt;setSize(<span class="string">"size"</span>, buffer-&gt;size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">        CHECK(buffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs));</span><br><span class="line"></span><br><span class="line">        msg-&gt;setInt64(<span class="string">"timeUs"</span>, timeUs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int32_t</span> omxFlags;</span><br><span class="line">        CHECK(buffer-&gt;meta()-&gt;findInt32(<span class="string">"omxFlags"</span>, &amp;omxFlags));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> flags = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (omxFlags &amp; OMX_BUFFERFLAG_SYNCFRAME) &#123;</span><br><span class="line">            flags |= BUFFER_FLAG_SYNCFRAME;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (omxFlags &amp; OMX_BUFFERFLAG_CODECCONFIG) &#123;</span><br><span class="line">            flags |= BUFFER_FLAG_CODECCONFIG;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (omxFlags &amp; OMX_BUFFERFLAG_EOS) &#123;</span><br><span class="line">            flags |= BUFFER_FLAG_EOS;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        msg-&gt;setInt32(<span class="string">"flags"</span>, flags);</span><br><span class="line"></span><br><span class="line">        msg-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆå››ï¼‰ã€å¤šåª’ä½“æ–‡ä»¶-éŸ³è§†é¢‘æ¸²æŸ“ï¼ˆRendererï¼‰"><a href="#ï¼ˆå››ï¼‰ã€å¤šåª’ä½“æ–‡ä»¶-éŸ³è§†é¢‘æ¸²æŸ“ï¼ˆRendererï¼‰" class="headerlink" title="ï¼ˆå››ï¼‰ã€å¤šåª’ä½“æ–‡ä»¶ - éŸ³è§†é¢‘æ¸²æŸ“ï¼ˆRendererï¼‰"></a>ï¼ˆå››ï¼‰ã€å¤šåª’ä½“æ–‡ä»¶ - éŸ³è§†é¢‘æ¸²æŸ“ï¼ˆRendererï¼‰</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">bool</span> NuPlayer::Decoder::handleAnOutputBuffer(</span><br><span class="line">        <span class="keyword">size_t</span> index,</span><br><span class="line">        <span class="keyword">size_t</span> offset,</span><br><span class="line">        <span class="keyword">size_t</span> size,</span><br><span class="line">        <span class="keyword">int64_t</span> timeUs,</span><br><span class="line">        <span class="keyword">int32_t</span> flags) &#123;</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    mCodec-&gt;getOutputBuffer(index, &amp;buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mOutputBuffers.size()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = mOutputBuffers.size(); i &lt;= index; ++i) &#123;</span><br><span class="line">            mOutputBuffers.add();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mOutputBuffers.editItemAt(index) = buffer;</span><br><span class="line"></span><br><span class="line">    buffer-&gt;setRange(offset, size);</span><br><span class="line">    buffer-&gt;meta()-&gt;clear();</span><br><span class="line">    buffer-&gt;meta()-&gt;setInt64(<span class="string">"timeUs"</span>, timeUs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> eos = flags &amp; MediaCodec::BUFFER_FLAG_EOS;</span><br><span class="line">    <span class="comment">// we do not expect CODECCONFIG or SYNCFRAME for decoder</span></span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatRenderBuffer, <span class="keyword">this</span>);</span><br><span class="line">    reply-&gt;setSize(<span class="string">"buffer-ix"</span>, index);</span><br><span class="line">    reply-&gt;setInt32(<span class="string">"generation"</span>, mBufferGeneration);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eos) &#123;</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt32(<span class="string">"eos"</span>, <span class="literal">true</span>);</span><br><span class="line">        reply-&gt;setInt32(<span class="string">"eos"</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSkipRenderingUntilMediaTimeUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (timeUs &lt; mSkipRenderingUntilMediaTimeUs) &#123;</span><br><span class="line">            reply-&gt;post();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mSkipRenderingUntilMediaTimeUs = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mNumFramesTotal += !mIsAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait until 1st frame comes out to signal resume complete</span></span><br><span class="line">    notifyResumeCompleteIfNecessary();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mRenderer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// send the buffer to renderer.</span></span><br><span class="line">        mRenderer-&gt;queueBuffer(mIsAudio, buffer, reply);</span><br><span class="line">        <span class="keyword">if</span> (eos &amp;&amp; !isDiscontinuityPending()) &#123;</span><br><span class="line">            mRenderer-&gt;queueEOS(mIsAudio, ERROR_END_OF_STREAM);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>a.    åœ¨kWhatRenderBufferæ¶ˆæ¯å¤„ç†ä¸­ä¼šè°ƒç”¨NuPlayer::Decoder::onRenderBuffer(â€¦)ï¼Œåœ¨å…¶ä¸­æ ¹æ®æƒ…å†µè°ƒç”¨å‡½æ•°MediaCodec::renderOutputBufferAndRelease(..)æ¸²æŸ“å¹¶é‡Šæ”¾ï¼Œæˆ–è€…è°ƒç”¨MediaCodec::releaseOutputBuffer(â€¦)ä¸æ¸²æŸ“ç›´æ¥é‡Šæ”¾ï¼Œä¸¤ä¸­æƒ…å†µéƒ½ä¼šäº§ç”ŸkWhatReleaseOutputBufferæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨å‡½æ•°MediaCodec::onReleaseOutputBuffer(â€¦)ï¼Œå…¶ä¸­åˆ¤æ–­è‹¥SoftRendereréç©ºåˆ™è¿›è¡Œè½¯ä»¶æ¸²æŸ“ï¼Œä¸ç„¶å°±ä¼šé€šè¿‡â—‹5ä¸­çš„replyè®©ACodecå»ç¡¬ä»¶æ¸²æŸ“ï¼Œåœ¨kWhatOutputBufferDrainedæ¶ˆæ¯å¤„ç†å°±ä¼šä¸­è°ƒç”¨åˆ°å‡½æ•°ACodec::BaseState::onOutputBufferDrained(â€¦)è¿›è¡ŒçœŸæ­£çš„ç¡¬ä»¶æ¸²æŸ“ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Decoder::onRenderBuffer(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="keyword">int32_t</span> render;</span><br><span class="line">    <span class="keyword">size_t</span> bufferIx;</span><br><span class="line">    <span class="keyword">int32_t</span> eos;</span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"buffer-ix"</span>, &amp;bufferIx));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mIsAudio) &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">        sp&lt;ABuffer&gt; buffer = mOutputBuffers[bufferIx];</span><br><span class="line">        buffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCCDecoder != <span class="literal">NULL</span> &amp;&amp; mCCDecoder-&gt;isSelected()) &#123;</span><br><span class="line">            mCCDecoder-&gt;display(timeUs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"render"</span>, &amp;render) &amp;&amp; render) &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> timestampNs;</span><br><span class="line">        CHECK(msg-&gt;findInt64(<span class="string">"timestampNs"</span>, &amp;timestampNs));</span><br><span class="line">        err = mCodec-&gt;renderOutputBufferAndRelease(bufferIx, timestampNs);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mNumOutputFramesDropped += !mIsAudio;</span><br><span class="line">        err = mCodec-&gt;releaseOutputBuffer(bufferIx);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>b.    MediaCodec:: getOutputBuffer (â€¦) -&gt; MediaCodec::getBufferAndFormat(â€¦)è·å–è¯¥bufferçš„ä¿¡æ¯<br>c.    è‹¥Rendereréç©ºåˆ™ä¼šè°ƒç”¨NuPlayer::Renderer::queueBuffer(â€¦)è¿›è¡ŒRendererçš„ç›¸å…³å¤„ç†åŒæ—¶æ¶ˆè€—äº§ç”Ÿçš„kWhatRenderBufferæ¶ˆæ¯ã€‚queueBuffer()ä¼šäº§ç”ŸkWhatQueueBufferæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†ä¸­ä¼šè°ƒç”¨å‡½æ•°NuPlayer::Renderer::onQueueBuffer(â€¦) â€“&gt; NuPlayer::Renderer::postDrainVideoQueue() ã€å¦å¤–æœ‰audioçš„ç›¸å…³å¤„ç†ã€‘ï¼Œå…¶ä¸­äº§ç”ŸkWhatDrainVideoQueueæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†ä¸­è°ƒç”¨å…ˆNuPlayer::Renderer::onDrainVideoQueue()åœ¨VideoQueueä¸­å–ç›¸å…³æ•°æ®ï¼Œå†è°ƒç”¨NuPlayer::Renderer::postDrainVideoQueue()å¾ªç¯å–videoæ•°æ®ï¼Œæ¥ç€è¿˜ä¼šå‘é€kWhatRenderBufferæ¶ˆæ¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerRenderer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Renderer::onQueueBuffer(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> audio;</span><br><span class="line">    <span class="keyword">if</span> (audio) &#123;</span><br><span class="line">        mHasAudio = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mHasVideo = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mHasVideo) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mVideoScheduler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mVideoScheduler = <span class="keyword">new</span> VideoFrameScheduler();</span><br><span class="line">            mVideoScheduler-&gt;init();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    CHECK(msg-&gt;findBuffer(<span class="string">"buffer"</span>, &amp;buffer));</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notifyConsumed;</span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"notifyConsumed"</span>, &amp;notifyConsumed));</span><br><span class="line"></span><br><span class="line">    QueueEntry entry;</span><br><span class="line">    entry.mBuffer = buffer;</span><br><span class="line">    entry.mNotifyConsumed = notifyConsumed;</span><br><span class="line">    entry.mOffset = <span class="number">0</span>;</span><br><span class="line">    entry.mFinalResult = OK;</span><br><span class="line">    entry.mBufferOrdinal = ++mTotalBuffersQueued;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (audio) &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        mAudioQueue.push_back(entry);</span><br><span class="line">        postDrainAudioQueue_l();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mVideoQueue.push_back(entry);</span><br><span class="line">        postDrainVideoQueue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!mSyncQueues || mAudioQueue.empty() || mVideoQueue.empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; firstAudioBuffer = (*mAudioQueue.begin()).mBuffer;</span><br><span class="line">    sp&lt;ABuffer&gt; firstVideoBuffer = (*mVideoQueue.begin()).mBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (firstAudioBuffer == <span class="literal">NULL</span> || firstVideoBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        syncQueuesDone_l();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> firstAudioTimeUs;</span><br><span class="line">    <span class="keyword">int64_t</span> firstVideoTimeUs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> diff = firstVideoTimeUs - firstAudioTimeUs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (diff &gt; <span class="number">100000l</span>l) &#123;</span><br><span class="line">        (*mAudioQueue.begin()).mNotifyConsumed-&gt;post();</span><br><span class="line">        mAudioQueue.erase(mAudioQueue.begin());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    syncQueuesDone_l();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/02-05-source-demux-decoder-output-render.jpg" alt="Alt text"></p><h4 id="ï¼ˆäº”ï¼‰ã€è§†é¢‘è§£ç è¾“å‡ºåˆ°SurfaceFlinger"><a href="#ï¼ˆäº”ï¼‰ã€è§†é¢‘è§£ç è¾“å‡ºåˆ°SurfaceFlinger" class="headerlink" title="ï¼ˆäº”ï¼‰ã€è§†é¢‘è§£ç è¾“å‡ºåˆ°SurfaceFlinger"></a>ï¼ˆäº”ï¼‰ã€è§†é¢‘è§£ç è¾“å‡ºåˆ°SurfaceFlinger</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">void</span> ACodec::BaseState::onOutputBufferDrained(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    IOMX::buffer_id bufferID;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"buffer-id"</span>, (<span class="keyword">int32_t</span>*)&amp;bufferID));</span><br><span class="line">    <span class="keyword">ssize_t</span> index;</span><br><span class="line">    BufferInfo *info = mCodec-&gt;findBufferByID(kPortIndexOutput, bufferID, &amp;index);</span><br><span class="line">    BufferInfo::Status status = BufferInfo::getSafeStatus(info);</span><br><span class="line">    <span class="keyword">if</span> (status != BufferInfo::OWNED_BY_DOWNSTREAM) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Wrong ownership in OBD: %s(%d) buffer #%u"</span>, _asString(status), status, bufferID);</span><br><span class="line">        mCodec-&gt;dumpBuffers(kPortIndexOutput);</span><br><span class="line">        mCodec-&gt;signalError(OMX_ErrorUndefined, FAILED_TRANSACTION);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">android_native_rect_t</span> crop;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findRect(<span class="string">"crop"</span>, &amp;crop.left, &amp;crop.top, &amp;crop.right, &amp;crop.bottom)</span><br><span class="line">            &amp;&amp; <span class="built_in">memcmp</span>(&amp;crop, &amp;mCodec-&gt;mLastNativeWindowCrop, <span class="keyword">sizeof</span>(crop)) != <span class="number">0</span>) &#123;</span><br><span class="line">        mCodec-&gt;mLastNativeWindowCrop = crop;</span><br><span class="line">        <span class="keyword">status_t</span> err = native_window_set_crop(mCodec-&gt;mNativeWindow.get(), &amp;crop);</span><br><span class="line">        ALOGW_IF(err != NO_ERROR, <span class="string">"failed to set crop: %d"</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> dataSpace;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"dataspace"</span>, &amp;dataSpace)</span><br><span class="line">            &amp;&amp; dataSpace != mCodec-&gt;mLastNativeWindowDataSpace) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> err = native_window_set_buffers_data_space(</span><br><span class="line">                mCodec-&gt;mNativeWindow.get(), (android_dataspace)dataSpace);</span><br><span class="line">        mCodec-&gt;mLastNativeWindowDataSpace = dataSpace;</span><br><span class="line">        ALOGW_IF(err != NO_ERROR, <span class="string">"failed to set dataspace: %d"</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> render;</span><br><span class="line">    <span class="keyword">if</span> (mCodec-&gt;mNativeWindow != <span class="literal">NULL</span></span><br><span class="line">            &amp;&amp; msg-&gt;findInt32(<span class="string">"render"</span>, &amp;render) &amp;&amp; render != <span class="number">0</span></span><br><span class="line">            &amp;&amp; info-&gt;mData != <span class="literal">NULL</span> &amp;&amp; info-&gt;mData-&gt;size() != <span class="number">0</span>) &#123;</span><br><span class="line">        ATRACE_NAME(<span class="string">"render"</span>);</span><br><span class="line">        <span class="comment">// The client wants this buffer to be rendered.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// save buffers sent to the surface so we can get render time when they return</span></span><br><span class="line">        <span class="keyword">int64_t</span> mediaTimeUs = <span class="number">-1</span>;</span><br><span class="line">        info-&gt;mData-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;mediaTimeUs);</span><br><span class="line">        <span class="keyword">if</span> (mediaTimeUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            mCodec-&gt;mRenderTracker.onFrameQueued(</span><br><span class="line">                    mediaTimeUs, info-&gt;mGraphicBuffer, <span class="keyword">new</span> Fence(::dup(info-&gt;mFenceFd)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int64_t</span> timestampNs = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!msg-&gt;findInt64(<span class="string">"timestampNs"</span>, &amp;timestampNs)) &#123;</span><br><span class="line">            <span class="comment">// use media timestamp if client did not request a specific render timestamp</span></span><br><span class="line">            <span class="keyword">if</span> (info-&gt;mData-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timestampNs)) &#123;</span><br><span class="line">                ALOGV(<span class="string">"using buffer PTS of %lld"</span>, (<span class="keyword">long</span> <span class="keyword">long</span>)timestampNs);</span><br><span class="line">                timestampNs *= <span class="number">1000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">status_t</span> err;</span><br><span class="line">        err = native_window_set_buffers_timestamp(mCodec-&gt;mNativeWindow.get(), timestampNs);</span><br><span class="line">        ALOGW_IF(err != NO_ERROR, <span class="string">"failed to set buffer timestamp: %d"</span>, err);</span><br><span class="line"></span><br><span class="line">        info-&gt;checkReadFence(<span class="string">"onOutputBufferDrained before queueBuffer"</span>);</span><br><span class="line">        err = mCodec-&gt;mNativeWindow-&gt;queueBuffer(</span><br><span class="line">                    mCodec-&gt;mNativeWindow.get(), info-&gt;mGraphicBuffer.get(), info-&gt;mFenceFd);</span><br><span class="line">        info-&gt;mFenceFd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">            info-&gt;mStatus = BufferInfo::OWNED_BY_NATIVE_WINDOW;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGE(<span class="string">"queueBuffer failed in onOutputBufferDrained: %d"</span>, err);</span><br><span class="line">            mCodec-&gt;signalError(OMX_ErrorUndefined, makeNoSideEffectStatus(err));</span><br><span class="line">            info-&gt;mStatus = BufferInfo::OWNED_BY_US;</span><br><span class="line">            <span class="comment">// keeping read fence as write fence to avoid clobbering</span></span><br><span class="line">            info-&gt;mIsReadFence = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCodec-&gt;mNativeWindow != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">            (info-&gt;mData == <span class="literal">NULL</span> || info-&gt;mData-&gt;size() != <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="comment">// move read fence into write fence to avoid clobbering</span></span><br><span class="line">            info-&gt;mIsReadFence = <span class="literal">false</span>;</span><br><span class="line">            ATRACE_NAME(<span class="string">"frame-drop"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        info-&gt;mStatus = BufferInfo::OWNED_BY_US;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-1ã€Surfaceflinger-è§†é¢‘è§£ç ç¼“å­˜ç”³è¯·"><a href="#5-1ã€Surfaceflinger-è§†é¢‘è§£ç ç¼“å­˜ç”³è¯·" class="headerlink" title="5.1ã€Surfaceflinger è§†é¢‘è§£ç ç¼“å­˜ç”³è¯·"></a>5.1ã€Surfaceflinger è§†é¢‘è§£ç ç¼“å­˜ç”³è¯·</h5><p>å‰é¢2.3.6ã€MediaCodec-&gt;start()åˆ†æè¿‡ï¼š<br>äº§ç”ŸkWhatStartæ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤„ç†ä¸­å…ˆå°†MediaCodecçŠ¶æ€è®¾ä¸ºSTARTINGï¼Œç„¶åè°ƒç”¨ACodec::initiateStart()äº§ç”ŸkWhatStartæ¶ˆæ¯ï¼Œåœ¨å…¶æ¶ˆæ¯å¤„ç†ä¸­åˆè°ƒç”¨ACodec::LoadedState::onStart()ï¼Œç„¶ååœ¨å…¶ä¸­é¦–å…ˆå‘IOMXå‘é€çŠ¶æ€è½¬æ¢å‘½ä»¤ï¼Œç»è¿‡OMXNodeInstanceæœ€ç»ˆå¯¹å°†OMXç»„ä»¶çŠ¶æ€è½¬æ¢æˆIdleï¼ˆè½¬æ¢å®Œæˆæ—¶OMXä¼šå‘é€OMX_EventCmdCompleteäº‹ä»¶ï¼‰ï¼Œæ¥ç€å¯¹ACodecè¿›è¡ŒchangeStateè‡³LoadedToIdleStateã€‚è€Œåœ¨changeStateè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ACodec::LoadedToIdleState::stateEntered() =&gt;  ACodec::LoadedToIdleState::allocateBuffers() =&gt; ACodec::allocateBuffersOnPort(â€¦)ï¼Œå…¶ä¸­ä¼šä¸ºOMXç»„ä»¶ç«¯å£åˆ†é…ç¼“å†²ï¼Œå¹¶å‘MediaCodecå‘é€æ¶ˆæ¯kWhatBuffersAllocatedï¼Œæ¶ˆæ¯å¤„ç†ä¸­å°†MediaCodecçŠ¶æ€è®¾ä¸ºSTARTEDè€Œè‹¥allocateBufferså¤±è´¥åˆ™ç”±IOMXç»OMXNodeInstanceå°†OMXç»„ä»¶è½¬æ¢å›LoadedçŠ¶æ€ï¼ŒåŒæ—¶æŠŠACodecçŠ¶æ€è½¬æ¢å›LoadedState<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="comment">//ä½¿ç”¨surfaceæ¸²æŸ“ï¼Œä¸ºè¾“å‡ºåˆ†é…å›¾å½¢ç¼“å­˜GraphicBuffer  </span></span><br><span class="line"><span class="keyword">status_t</span> ACodec::LoadedToIdleState::allocateBuffers() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> err = mCodec-&gt;allocateBuffersOnPort(kPortIndexInput);</span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mCodec-&gt;allocateBuffersOnPort(kPortIndexOutput);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">status_t</span> ACodec::allocateBuffersOnPort(OMX_U32 portIndex) &#123;</span><br><span class="line">    CHECK(portIndex == kPortIndexInput || portIndex == kPortIndexOutput);</span><br><span class="line"></span><br><span class="line">    CHECK(mDealer[portIndex] == <span class="literal">NULL</span>);</span><br><span class="line">    CHECK(mBuffers[portIndex].isEmpty());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="keyword">if</span> (mNativeWindow != <span class="literal">NULL</span> &amp;&amp; portIndex == kPortIndexOutput) &#123;</span><br><span class="line">        <span class="keyword">if</span> (storingMetadataInDecodedBuffers()) &#123;</span><br><span class="line">            err = allocateOutputMetadataBuffers();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = allocateOutputBuffersFromNativeWindow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="5-1-1ã€allocateOutputBuffersFromNativeWindow-çš„å®ç°"><a href="#5-1-1ã€allocateOutputBuffersFromNativeWindow-çš„å®ç°" class="headerlink" title="5.1.1ã€allocateOutputBuffersFromNativeWindow()çš„å®ç°"></a>5.1.1ã€allocateOutputBuffersFromNativeWindow()çš„å®ç°</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">status_t</span> ACodec::allocateOutputBuffersFromNativeWindow() &#123;</span><br><span class="line">    OMX_U32 bufferCount, bufferSize, minUndequeuedBuffers;</span><br><span class="line">    <span class="keyword">status_t</span> err = configureOutputBuffersFromNativeWindow(</span><br><span class="line">            &amp;bufferCount, &amp;bufferSize, &amp;minUndequeuedBuffers, <span class="literal">true</span> <span class="comment">/* preregister */</span>);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    mNumUndequeuedBuffers = minUndequeuedBuffers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!storingMetadataInDecodedBuffers()) &#123;</span><br><span class="line">        <span class="keyword">static_cast</span>&lt;Surface*&gt;(mNativeWindow.get())</span><br><span class="line">                -&gt;getIGraphicBufferProducer()-&gt;allowAllocation(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Dequeue buffers and send them to OMX</span></span><br><span class="line">    <span class="keyword">for</span> (OMX_U32 i = <span class="number">0</span>; i &lt; bufferCount; i++) &#123;</span><br><span class="line">        ANativeWindowBuffer *buf;</span><br><span class="line">        <span class="keyword">int</span> fenceFd;</span><br><span class="line">        err = mNativeWindow-&gt;dequeueBuffer(mNativeWindow.get(), &amp;buf, &amp;fenceFd);</span><br><span class="line">        ......</span><br><span class="line">        sp&lt;GraphicBuffer&gt; graphicBuffer(<span class="keyword">new</span> GraphicBuffer(buf, <span class="literal">false</span>));</span><br><span class="line">        BufferInfo info;</span><br><span class="line">        info.mStatus = BufferInfo::OWNED_BY_US;</span><br><span class="line">        info.mFenceFd = fenceFd;</span><br><span class="line">        info.mIsReadFence = <span class="literal">false</span>;</span><br><span class="line">        info.mRenderInfo = <span class="literal">NULL</span>;</span><br><span class="line">        info.mData = <span class="keyword">new</span> ABuffer(<span class="literal">NULL</span> <span class="comment">/* data */</span>, bufferSize <span class="comment">/* capacity */</span>);</span><br><span class="line">        info.mCodecData = info.mData;</span><br><span class="line">        info.mGraphicBuffer = graphicBuffer;</span><br><span class="line">        mBuffers[kPortIndexOutput].push(info);</span><br><span class="line"></span><br><span class="line">        IOMX::buffer_id bufferId;</span><br><span class="line">        err = mOMX-&gt;useGraphicBuffer(mNode, kPortIndexOutput, graphicBuffer,</span><br><span class="line">                &amp;bufferId);</span><br><span class="line">        ......</span><br><span class="line">        mBuffers[kPortIndexOutput].editItemAt(i).mBufferID = bufferId;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-1-1-1ã€é¦–å…ˆä¸ºè§†é¢‘ç¼–ç è¾“å‡ºå‡†å¤‡Surface"><a href="#5-1-1-1ã€é¦–å…ˆä¸ºè§†é¢‘ç¼–ç è¾“å‡ºå‡†å¤‡Surface" class="headerlink" title="5.1.1.1ã€é¦–å…ˆä¸ºè§†é¢‘ç¼–ç è¾“å‡ºå‡†å¤‡Surface"></a>5.1.1.1ã€é¦–å…ˆä¸ºè§†é¢‘ç¼–ç è¾“å‡ºå‡†å¤‡Surface</h5><p>æ­¤å¤„é€šè¿‡Binderé€šä¿¡ä½¿ç”¨IGraphicBufferProducerè¯·æ±‚åˆ†é…ä¸€ä¸ªNative Surface<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static_cast</span>&lt;Surface*&gt;(mNativeWindow.get())</span><br><span class="line">        -&gt;getIGraphicBufferProducer()-&gt;allowAllocation(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/02-06-Surface-ANativeWindow.png" alt="Alt text"></p><h5 id="5-1-1-2ã€Surface-gt-dequeueBuffer"><a href="#5-1-1-2ã€Surface-gt-dequeueBuffer" class="headerlink" title="5.1.1.2ã€Surface-&gt;dequeueBuffer"></a>5.1.1.2ã€Surface-&gt;dequeueBuffer</h5><p>ä¸ºSurfaceåˆ†é…Bufferï¼Œæä¾›ç»™è§†é¢‘è§£ç åæ•°æ®ä½¿ç”¨<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">status_t</span> ACodec::allocateOutputBuffersFromNativeWindow() &#123;</span><br><span class="line">    <span class="keyword">for</span> (OMX_U32 i = <span class="number">0</span>; i &lt; bufferCount; i++) &#123;</span><br><span class="line">        ANativeWindowBuffer *buf;</span><br><span class="line">        <span class="keyword">int</span> fenceFd;</span><br><span class="line">        err = mNativeWindow-&gt;dequeueBuffer(mNativeWindow.get(), &amp;buf, &amp;fenceFd);</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="5-2ã€Surface-gt-queueBuffer"><a href="#5-2ã€Surface-gt-queueBuffer" class="headerlink" title="5.2ã€Surface-&gt;queueBuffer()"></a>5.2ã€Surface-&gt;queueBuffer()</h5><p>å¾…è§†é¢‘è§£ç åï¼Œä½¿ç”¨queueBuffer()äº¤ç»™SurfaceFlingeræ¸²æŸ“ï¼Œå°±å¯ä»¥åœ¨å±å¹•ä¸Šçœ‹åˆ°è§†é¢‘ç”»é¢äº†ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">void</span> ACodec::BaseState::onOutputBufferDrained(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">        err = mCodec-&gt;mNativeWindow-&gt;queueBuffer(</span><br><span class="line">                    mCodec-&gt;mNativeWindow.get(), info-&gt;mGraphicBuffer.get(), info-&gt;mFenceFd);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/02-07-OpenMax-Based video decode-surfaceflinger.png" alt="Alt text"></p><p>å…³äºSurfaceFlingerçš„çŸ¥è¯†è¯·å‚è€ƒï¼šã€Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿåˆ†æã€‘</p><p><strong>ï¼ˆ Í¡Â° ÍœÊ– Í¡Â°ï¼‰ã€ï¼ˆà²¡Ï‰à²¡ï¼‰ç´¯~~~ï¼Œæœ‰æ—¶é—´å†ç»§ç»­Todoçš„åˆ†æå§ï¼Œ(à¹‘ä¹›â—¡ä¹›à¹‘) ï¼ï¼ï¼</strong><br><strong>Todoï¼šAndroid OpenMaxæœºåˆ¶ å®ç°åˆ†æ</strong><br><strong>Todoï¼šAndroid éŸ³è§†é¢‘åŒæ­¥æœºåˆ¶ æºç åˆ†æ</strong><br><strong>Todoï¼šAndroid éŸ³è§†é¢‘å½•åˆ¶ï¼ˆRecoderï¼‰ã€ç¼–ç ï¼ˆEncodeï¼‰ã€æ··åˆï¼ˆMediaMuxerï¼‰æºç åˆ†æ</strong></p><h4 id="ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå…­ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">Android NuPlayeræ’­æ”¾æ¡†æ¶ </a><br><a href="https://blog.csdn.net/column/details/12812.html" target="_blank" rel="noopener">ä¸“æ ï¼šMultiMediaæ¡†æ¶æ€»ç»“(åŸºäº6.0æºç ) - CSDNåšå®¢</a><br><a href="windrunnerlihuan.com">Androidå¤šåª’ä½“å¼€å‘-å½’æ¡£ | April is your lie</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57415505" target="_blank" rel="noopener">Android-7.0-Nuplayeræ¦‚è¿° - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57409783" target="_blank" rel="noopener">Android-7.0-MediaPlayerçŠ¶æ€æœº - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/56961370" target="_blank" rel="noopener">Android-7.0-Nuplayer-å¯åŠ¨æµç¨‹ - CSDNåšå®¢</a><br><a href="https://zh.wikipedia.org/wiki/YUV" target="_blank" rel="noopener">YUV - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53386010" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-Nuplayerï¼ˆ1ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53397945" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-AHandler AMessage ALooper - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/category/2135451/1?" target="_blank" rel="noopener">Android 4.2.2 stagefrightæ¶æ„ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/26849549" target="_blank" rel="noopener">android4.2.2çš„stagefrightæ¶æ„ä¸‹åŸºäºSurfaceFlingerçš„è§†é¢‘è§£ç è¾“å‡ºç¼“å­˜åˆ›å»ºæœºåˆ¶ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/category/7610722" target="_blank" rel="noopener">husanlim çš„ä¸“æ  å‚è€ƒ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">android ACodec MediaCodec NuPlayer flow - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">android MediaCodec ACodec - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/16222.html" target="_blank" rel="noopener">ffmpegå¼€å‘ä¹‹æ—…(1)-(7)ï¼ˆæ€»å…±ä¸ƒç¯‡ï¼‰</a><br><a href="https://blog.csdn.net/nonmarking/article/category/6746500" target="_blank" rel="noopener">æ·±å…¥ç†è§£AndroidéŸ³è§†é¢‘åŒæ­¥æœºåˆ¶ï¼ˆæ€»å…±äº”ç¯‡ï¼‰</a><br><a href="https://blog.csdn.net/junzia/article/details/54018671" target="_blank" rel="noopener">Androidç¡¬ç¼–ç â€”â€”éŸ³é¢‘ç¼–ç ã€è§†é¢‘ç¼–ç åŠéŸ³è§†é¢‘æ··åˆ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/06/01/Android%20Video%20System%EF%BC%881%EF%BC%89%EF%BC%9AVideo%20System%5B%E8%A7%86%E9%A2%91%E7%B3%BB%E7%BB%9F%5D%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/06/01/Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System[è§†é¢‘ç³»ç»Ÿ]æ¡†æ¶åˆ†æ/</id>
    <published>2018-05-31T16:00:00.000Z</published>
    <updated>2018-05-17T16:21:51.537Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/video.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  Android NuPlayeræ’­æ”¾æ¡†æ¶ã€‘</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ -  android ACodec MediaCodec NuPlayer flowã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>â˜¯ V4l2 æ¡†æ¶ä»£ç <br>â˜¯ kernel/drivers/media/v4l2-core/ï¼ˆæ–‡ä»¶å‰ç¼€ä¸º videobuf2ï¼‰</p><p>â˜¯ MSM è§†é¢‘é©±åŠ¨ç¨‹åºæ–‡ä»¶<br>â˜¯ kernel/drivers/media/platform/msm/vidc/</p><p>â˜¯ è®¾å¤‡æ ‘<br>â˜¯ /kernel/arch/arm/boot/dts/qcomï¼ˆVenus çš„å¯„å­˜å™¨åŸºå€ï¼Œæ—¶é’Ÿé¢‘ç‡ï¼‰</p><p>â˜¯ Stagefrightã€libmediaã€libmediaplayerserviceã€mediaserver<br>â˜¯ /frameworks/av/media/</p><p>â˜¯ OMX<br>â˜¯ /hardware/qcom/media/mam8996/mm-video-v4l2/vidc/</p><p>â˜¯ OMX æ ¸å¿ƒ<br>â˜¯ /hardware/qcom/media/mm-core</p><p>â˜¯ è½¯ä»¶ç¼–è§£ç å™¨è·¯å¾„<br>â˜¯ /vendor/qcom/proprietary/mm-video/omx_vpp(?)â†’ è§£ç å™¨ä»£ç <br>â˜¯ /vendor/qcom/proprietary/mm-video/omx_vpp(?) â†’ ç¼–ç å™¨ä»£ç </p><hr><h4 id="ä¸€-ã€Android-Video-Overview"><a href="#ä¸€-ã€Android-Video-Overview" class="headerlink" title="(ä¸€)ã€Android Video Overview"></a>(ä¸€)ã€Android Video Overview</h4><p>åŸºäº OpenMAX çš„è§†é¢‘è§£ç  â€“ æ•°æ®æµ<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-01-OpenMax-Based video decode - data flow.png" alt="Alt text"></p><blockquote><p>YUVï¼Œæ˜¯ä¸€ç§é¢œè‰²ç¼–ç æ–¹æ³•ã€‚å¸¸ä½¿ç”¨åœ¨å„ä¸ªè§†é¢‘å¤„ç†ç»„ä»¶ä¸­ã€‚ YUVåœ¨å¯¹ç…§ç‰‡æˆ–è§†é¢‘ç¼–ç æ—¶ï¼Œè€ƒè™‘åˆ°äººç±»çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œå…è®¸é™ä½è‰²åº¦çš„å¸¦å®½ã€‚<a href="https://zh.wikipedia.org/wiki/YUV" target="_blank" rel="noopener">YUV</a><br>VPUï¼ŒVideo processing unit </p></blockquote><p>åŸºäº OpenMAX çš„è§†é¢‘ç¼–ç  â€“ æ•°æ®æµ<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-02-OpenMax-Based video encode - data flow.png.png" alt="Alt text"></p><p>è§†é¢‘æ¡†æ¶ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-03-Video Architecture Software Stack.png" alt="Alt text"></p><p>ç»„ä»¶æè¿°ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-04-Q Component Description.png" alt="Alt text"></p><p>æ€»ç»“ï¼š<br>    ä»è§†é¢‘æ¡†æ¶å¯ä»¥äº†è§£åˆ°ã€‚è§†é¢‘æ–‡ä»¶å…ˆç»Stagefrightä¼ åˆ°OMX decoderè§£ç ï¼ˆè½¯è§£æˆ–ç¡¬è§£ï¼‰ã€OMX decoderå°†è§£ç åçš„YUVæ•°æ®å›ä¼ åˆ°Stagefrightï¼Œä¸æ–­å¾ªç¯æ’­æ”¾åŒæ—¶ç»ç”±SurfaceFlingeræ¸²æŸ“åˆ°LCDå±å¹•ä¸Šã€‚</p><h4 id="äºŒ-ã€Android-MediaPlayer-amp-Nuplayer-æ¡†æ¶åˆ†æ"><a href="#äºŒ-ã€Android-MediaPlayer-amp-Nuplayer-æ¡†æ¶åˆ†æ" class="headerlink" title="(äºŒ)ã€Android MediaPlayer &amp; Nuplayer æ¡†æ¶åˆ†æ"></a>(äºŒ)ã€Android MediaPlayer &amp; Nuplayer æ¡†æ¶åˆ†æ</h4><h5 id="2-1ã€MediaPlayer"><a href="#2-1ã€MediaPlayer" class="headerlink" title="2.1ã€MediaPlayer"></a>2.1ã€MediaPlayer</h5><p>Androidåœ¨Javaå±‚ä¸­æä¾›äº†ä¸€ä¸ªMediaPlayerçš„ç±»æ¥ä½œä¸ºæ’­æ”¾åª’ä½“èµ„æºçš„æ¥å£ï¼Œåœ¨ä½¿ç”¨ä¸­æˆ‘ä»¬é€šå¸¸ä¼šç¼–å†™ä»¥ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mMediaPlayer = <span class="keyword">new</span> MediaPlayer();</span><br><span class="line">mMediaPlayer.setDataSource(Environment.getExternalStorageDirectory()+<span class="string">"/test_video.mp4"</span>);</span><br><span class="line">mMediaPlayer.setDisplay(...);</span><br><span class="line">mMediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);</span><br><span class="line">mMediaPlayer.prepareAsync();</span><br><span class="line">mMediaPlayer.start();</span><br><span class="line">mediaPlayer.pause(); </span><br><span class="line">mediaPlayer.stop();</span><br><span class="line">mediaPlayer.reset();</span><br><span class="line">mediaPlayer.release();</span><br></pre></td></tr></table></figure><p>é€šå¸¸MediaPlayerçš„è°ƒç”¨é€»è¾‘æ˜¯ï¼Œæ„é€ å‡½æ•°-&gt; setDataSource -&gt; SetVideoSurfaceTexture-&gt; prepare/prepareAsync -&gt; start-&gt; stop-&gt; reset-&gt; ææ„å‡½æ•°ï¼ŒæŒ‰ç…§å®é™…éœ€æ±‚è¿˜ä¼šè°ƒç”¨pauseã€isPlayingã€getDurationã€getCurrentPositionã€setLoopingã€seekToç­‰æ–¹æ³•ã€‚</p><h5 id="2-1-1ã€MediaPlayerçŠ¶æ€å›¾"><a href="#2-1-1ã€MediaPlayerçŠ¶æ€å›¾" class="headerlink" title="2.1.1ã€MediaPlayerçŠ¶æ€å›¾:"></a>2.1.1ã€MediaPlayerçŠ¶æ€å›¾:</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-05-MediaPlayer-status-turn-.png" alt="Alt text"></p><p>â˜¯ IdleçŠ¶æ€<br>è°ƒç”¨newæˆ–reset()æ–¹æ³•åˆ›å»ºMediaPlayeråè¿›å…¥ç©ºé—²<br>â˜¯ EndçŠ¶æ€<br>è°ƒç”¨release()åå°±ç»“æŸ<br>â˜¯ ErrorçŠ¶æ€<br>æ’­æ”¾æ§åˆ¶æ“ä½œå‡ºé”™æˆ–æ— æ•ˆçŠ¶æ€ä¸‹è°ƒç”¨æ’­æ”¾æ§åˆ¶æ“ä½œ<br>â˜¯ InitializedçŠ¶æ€</p><p>è°ƒç”¨setDataSourceä¹‹åå®Œæˆåˆå§‹åŒ–<br>â˜¯ PreparedçŠ¶æ€<br>åŒæ­¥prepare()æˆ–å¼‚æ­¥prepareAsync()å®Œæˆå‡†å¤‡<br>â˜¯ PreparingçŠ¶æ€<br>æ˜¯ä¸€ç§ç¬æ—¶çŠ¶æ€ï¼Œè°ƒç”¨prepareAsync()æ—¶ä¼šå…ˆè¿›å…¥æ­¤çŠ¶æ€<br>â˜¯ Started  çŠ¶æ€<br>è¦å¼€å§‹æ’­æ”¾å¿…é¡»è°ƒç”¨start()<br>â˜¯ Paused  çŠ¶æ€<br>è°ƒç”¨pause()å¹¶æˆåŠŸè¿”å›åæ’­æ”¾å¯ä»¥è¢«æš‚åœ<br>â˜¯ StoppedçŠ¶æ€<br>è°ƒç”¨stop()ä¼šåœæ­¢æ’­æ”¾<br>â˜¯ PlaybackCompletedçŠ¶æ€<br>å½“æ’­æ”¾åˆ°è¾¾æµæœ«ç«¯æ—¶ï¼Œæ’­æ”¾å®Œæˆ</p><h5 id="2-1-2ã€MediaPlayerå’ŒMediaPlayerService"><a href="#2-1-2ã€MediaPlayerå’ŒMediaPlayerService" class="headerlink" title="2.1.2ã€MediaPlayerå’ŒMediaPlayerService"></a>2.1.2ã€MediaPlayerå’ŒMediaPlayerService</h5><p>mediaserver å¯åŠ¨åä¼šæŠŠmediaç›¸å…³ä¸€äº›æœåŠ¡æ·»åŠ åˆ°servicemanagerä¸­ï¼Œå…¶ä¸­å°±æœ‰mediaPlayerServiceã€‚è¿™æ ·åº”ç”¨å¯åŠ¨å‰ï¼Œç³»ç»Ÿå°±æœ‰äº†mediaPlayerServiceè¿™ä¸ªæœåŠ¡ç¨‹åºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\mediaserver\main_mediaserver.cpp]</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-06-Main_mediaserver.png" alt="Alt text"></p><h5 id="2-1-3ã€åˆ›å»ºMediaPlayer"><a href="#2-1-3ã€åˆ›å»ºMediaPlayer" class="headerlink" title="2.1.3ã€åˆ›å»ºMediaPlayer"></a>2.1.3ã€åˆ›å»ºMediaPlayer</h5><p>â˜¯ Javaåº”ç”¨ç¨‹åºä¸­åˆ›å»ºMediaPlayerå¯¹è±¡<br>MediaPlayer mediaPlayer = new MediaPlayer();<br>â˜¯ MediaPlayerçš„æ„é€ å‡½æ•°ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯æœ¬åœ°çš„nativeå‡½æ•°ï¼šnative_setup()å…¶å¯¹åº”çš„JNIå‡½æ•°ä¸º<br>android_media_MediaPlayer_native_setup()</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\jni\android_media_MediaPlayer.cpp]</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-07-android_media_MediaPlayer_native_setup.png" alt="Alt text"></p><p>æ„é€ Nativeå±‚çš„MediaPlayerå¯¹è±¡çš„æ—¶å€™ã€MediaPlayer.cppã€‘ï¼Œä¹Ÿä¼šæ„é€ å…¶çˆ¶ç±»çš„å¯¹è±¡ã€‚åœ¨MediaPlayerçš„çˆ¶ç±»IMediaDeathNotifierä¸­æœ‰ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•getMediaPlayerService()æ¥è·å–MediaPlayerServiceï¼Œå…¶å…³ç³»åˆ°MediaPlayerå’ŒMediaPlayerServiceä¹‹é—´çš„é€šä¿¡ã€‚</p><h5 id="2-1-4ã€setDataSource-è®¾ç½®æ’­æ”¾èµ„æº"><a href="#2-1-4ã€setDataSource-è®¾ç½®æ’­æ”¾èµ„æº" class="headerlink" title="2.1.4ã€setDataSource()è®¾ç½®æ’­æ”¾èµ„æº"></a>2.1.4ã€setDataSource()è®¾ç½®æ’­æ”¾èµ„æº</h5><p>åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„è¿›ç¨‹ä¸­ï¼ŒMediaplayer.cpp ä¸­ setDataSourceä¼šä»service managerä¸­è·å¾—mediaPlayerService æœåŠ¡ï¼Œç„¶åé€šè¿‡æœåŠ¡æ¥åˆ›å»ºplayerï¼Œè¿™ä¸ªplayerå°±æ˜¯æ’­æ”¾å™¨çš„çœŸå®å®ä¾‹ï¼ŒåŒæ—¶ä¹Ÿä½¿MediaPlayerå’ŒMediaPlayerServiceå»ºç«‹äº†è”ç³»ã€‚<br>åœ¨javaå±‚MediaPlayer.javaä¸­çš„setDataSourceæœ€ç»ˆä¼šè°ƒç”¨_setDataSourceæ–¹æ³•ï¼Œå¯¹åº”nativeå±‚MediaPlayer.cppä¸­çš„setDataSourceæ–¹æ³•ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-08-mp_setDataSource.png" alt="Alt text"></p><p>é€šè¿‡ getMediaPlayerService å¾—åˆ°çš„BpMediaPlayerServiceç±»å‹çš„serviceï¼Œå’ŒmediaPlayerServiceè¿›ç¨‹ä¸­çš„BnMediaPlayerService ç›¸å¯¹åº”è´Ÿè´£binderé€šè®¯ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-09-MediaPlayerService_Create.png" alt="Alt text"></p><p>åœ¨createå‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªMediaPlayerService::Clientçš„å®ä¾‹ï¼Œæ˜¯MediaPlayerServiceçš„å†…éƒ¨ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´MediaPlayerServiceä¼šä¸ºæ¯ä¸ªclientåº”ç”¨è¿›ç¨‹åˆ›å»ºä¸€ä¸ªç›¸åº”çš„MediaPlayerService::Clientçš„å®ä¾‹ï¼Œæ¥å®ç°æ’­æ”¾ä»¥åŠæ’­æ”¾è¿‡ç¨‹çš„æ§åˆ¶ï¼Œå‘MediaPlayerå‘äº‹ä»¶é€šçŸ¥ã€‚åˆ°è¿™é‡Œï¼Œåœ¨Serverç«¯çš„å¯¹è±¡å°±åˆ›å»ºå®Œæˆäº†ã€‚</p><p>ç„¶ååœ¨MediaPlayer.cppä¸­å°±å¾—åˆ°äº†ä¸€ä¸ªseverç«¯çš„playerå®ä¾‹ï¼Œå®ƒå’Œæœ¬åœ°å…¶ä»–ç±»çš„å®ä¾‹æ²¡ä»€ä¹ˆç”¨æ³•ä¸Šçš„åŒºåˆ«ï¼Œè€Œå®é™…ä¸Šåˆ™æ˜¯é€šè¿‡binderæœºåˆ¶è¿è¡Œåœ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ã€‚è·å¾—æ­¤å®ä¾‹åç»§ç»­player-&gt;setDataSourceæ“ä½œã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-10-player-setDataSource.png" alt="Alt text"></p><p>å°ç»“ï¼š<br>Javaåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨MediaPlayer.javaçš„setDataSource()ä¼šä¼ é€’åˆ°Nativeå±‚ä¸­MediaPlayer.cppçš„setDataSource()å»æ‰§è¡Œï¼Œè€ŒMediaPlayer.cppåˆä¼šæŠŠè¿™ä¸ªæ–¹æ³•äº¤ç»™MediaPlayerserviceå»æ‰§è¡Œã€‚MediaPlayerServiceåˆ™æ˜¯ä½¿ç”¨NuPlayerå®ç°çš„ï¼Œæœ€åï¼Œ setDataSourceè¿˜æ˜¯äº¤ç»™äº†NuPlayerå»æ‰§è¡Œäº†ã€‚è¿™ä¸ªè¿‡ç¨‹æŠŠMediaPlayerå’ŒMediaPlayerServiceä¹‹é—´çš„è”ç³»å»ºç«‹èµ·æ¥ï¼ŒåŒæ—¶åˆæŠŠMediaPlayerServiceå’ŒNuPlayerçš„å…³ç³»å»ºç«‹äº†èµ·æ¥ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-11-GenericSource-setDataSource.png" alt="Alt text"></p><h5 id="2-1-5ã€setDisplay"><a href="#2-1-5ã€setDisplay" class="headerlink" title="2.1.5ã€setDisplay()"></a>2.1.5ã€setDisplay()</h5><p> ä¸‹ä¸€æ­¥å°±æ˜¯javaå±‚çš„setDisplayï¼Œä¾ç„¶æŸ¥çœ‹javaå±‚MediaPlayerï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\java\android\media\MediaPlayer.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplay</span><span class="params">(SurfaceHolder sh)</span> </span>&#123;</span><br><span class="line">        mSurfaceHolder = sh;</span><br><span class="line">        Surface surface;</span><br><span class="line">        <span class="keyword">if</span> (sh != null) &#123;</span><br><span class="line">            surface = sh.getSurface();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            surface = null;</span><br><span class="line">        &#125;</span><br><span class="line">        _setVideoSurface(surface);</span><br><span class="line">        updateSurfaceScreenOn();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¼šè°ƒç”¨æœ¬åœ°æ–¹æ³•_setVideoSurfaceï¼Œæˆ‘ä»¬ç»§ç»­æ‰¾åˆ°å®ƒçš„jniå®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\jni\android_media_MediaPlayer.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_media_MediaPlayer_setVideoSurface</span><span class="params">(JNIEnv *env, jobject thiz, jobject jsurface)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setVideoSurface(env, thiz, jsurface, <span class="literal">true</span> <span class="comment">/* mediaPlayerMustBeAlive */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setVideoSurface</span><span class="params">(JNIEnv *env, jobject thiz, jobject jsurface, jboolean mediaPlayerMustBeAlive)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;MediaPlayer&gt; mp = getMediaPlayer(env, thiz);<span class="comment">//è·å–C++çš„MediaPlayer</span></span><br><span class="line">    <span class="keyword">if</span> (mp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mediaPlayerMustBeAlive) &#123;</span><br><span class="line">            jniThrowException(env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//å°†æ—§çš„IGraphicBufferProducerçš„å¼ºå¼•ç”¨å‡ä¸€</span></span><br><span class="line">    decVideoSurfaceRef(env, thiz);</span><br><span class="line"><span class="comment">//IGraphicBufferProducerå›¾å±‚ç¼“å†²åŒºåˆæˆå™¨</span></span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; new_st;</span><br><span class="line">    <span class="keyword">if</span> (jsurface) &#123;</span><br><span class="line">    <span class="comment">//å¾—åˆ°javaå±‚çš„surface</span></span><br><span class="line">        sp&lt;Surface&gt; surface(android_view_Surface_getSurface(env, jsurface));</span><br><span class="line">        <span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//è·å–IGraphicBufferProducer</span></span><br><span class="line">            new_st = surface-&gt;getIGraphicBufferProducer();</span><br><span class="line">            <span class="keyword">if</span> (new_st == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                jniThrowException(env, <span class="string">"java/lang/IllegalArgumentException"</span>,</span><br><span class="line">                    <span class="string">"The surface does not have a binding SurfaceTexture!"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¢åŠ IGraphicBufferProducerçš„å¼ºå¼•ç”¨+1</span></span><br><span class="line">            new_st-&gt;incStrong((<span class="keyword">void</span>*)decVideoSurfaceRef);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            jniThrowException(env, <span class="string">"java/lang/IllegalArgumentException"</span>,</span><br><span class="line">                    <span class="string">"The surface has been released"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//ä¸Šé¢æˆ‘ä»¬åœ¨native_initæ–¹æ³•ä¸­å°†javaå±‚mNativeSurfaceTextureæŸ¥æ‰¾ç»™äº†jniå±‚ï¼Œæ­£å¥½ï¼Œåœ¨è¿™é‡Œå°†IGraphicBufferProducerèµ‹ç»™å®ƒ</span></span><br><span class="line">    env-&gt;SetLongField(thiz, fields.surface_texture, (jlong)new_st.get());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This will fail if the media player has not been initialized yet. This</span></span><br><span class="line">    <span class="comment">// can be the case if setDisplay() on MediaPlayer.java has been called</span></span><br><span class="line">    <span class="comment">// before setDataSource(). The redundant call to setVideoSurfaceTexture()</span></span><br><span class="line">    <span class="comment">// in prepare/prepareAsync covers for this case.</span></span><br><span class="line">    <span class="comment">//å¦‚æœMediaPlayeræ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿™ä¸€æ­¥ä¼šå¤±è´¥ã€‚åŸå› å¯èƒ½æ˜¯setDisplayåœ¨setDataSourceä¹‹å‰ã€‚å¦‚æœåœ¨prepare/prepareAsync æ—¶æƒ³è§„é¿è¿™ä¸ªé”™è¯¯è€Œå»è°ƒç”¨setVideoSurfaceTextureæ˜¯å¤šä½™çš„ã€‚</span></span><br><span class="line">    <span class="comment">//æœ€ç»ˆä¼šè°ƒç”¨C++å±‚çš„setVideoSurfaceTextureæ–¹æ³•ï¼Œä¸‹ä¸€èŠ‚åœ¨åˆ†æ</span></span><br><span class="line">    mp-&gt;setVideoSurfaceTexture(new_st);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å°†æ—§çš„IGraphicBufferProducerçš„å¼ºå¼•ç”¨å‡ä¸€</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decVideoSurfaceRef</span><span class="params">(JNIEnv *env, jobject thiz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;MediaPlayer&gt; mp = getMediaPlayer(env, thiz);</span><br><span class="line">    <span class="keyword">if</span> (mp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; old_st = getVideoSurfaceTexture(env, thiz);</span><br><span class="line">    <span class="keyword">if</span> (old_st != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        old_st-&gt;decStrong((<span class="keyword">void</span>*)decVideoSurfaceRef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯å¯¹å›¾åƒæ˜¾ç¤ºçš„surfaceçš„ä¿å­˜ï¼Œç„¶åå°†æ—§çš„IGraphicBufferProducerå¼ºå¼•ç”¨å‡ä¸€ï¼Œå†è·å¾—æ–°çš„IGraphicBufferProducerï¼Œæœ€åä¼šè°ƒç”¨C++çš„MediaPlayerçš„setVideoSurfaceTextureå°†å®ƒæŠ˜çº¸è¿›å»ã€‚</p><p>IGraphicBufferProduceræ˜¯SurfaceFlingerçš„å†…å®¹ï¼Œä¸€ä¸ªUIå®Œå…¨æ˜¾ç¤ºåˆ°diplayçš„è¿‡ç¨‹ï¼ŒSurfaceFlingeræ‰®æ¼”ç€é‡è¦çš„è§’è‰²ä½†æ˜¯å®ƒçš„èŒè´£æ˜¯â€œFlingerâ€ï¼Œå³æŠŠç³»ç»Ÿä¸­æ‰€æœ‰åº”ç”¨ç¨‹åºçš„æœ€ç»ˆçš„â€œç»˜å›¾ç»“æœâ€è¿›è¡Œâ€œæ··åˆâ€ï¼Œç„¶åç»Ÿä¸€æ˜¾ç¤ºåˆ°ç‰©ç†å±å¹•ä¸Šï¼Œè€Œå…¶ä»–æ–¹é¢æ¯”å¦‚å„ä¸ªç¨‹åºçš„ç»˜ç”»è¿‡ç¨‹ï¼Œå°±ç”±å…¶ä»–ä¸œè¥¿æ¥æ‹…ä»»äº†ã€‚è¿™ä¸ªå…‰è£çš„ä»»åŠ¡è‡ªç„¶è€Œç„¶åœ°è½åœ¨äº†BufferQueueçš„è‚©è†€ä¸Šï¼Œå®ƒæ˜¯æ¯ä¸ªåº”ç”¨ç¨‹åºâ€œä¸€å¯¹ä¸€â€çš„è¾…å¯¼è€å¸ˆï¼ŒæŒ‡å¯¼ç€UIç¨‹åºçš„â€œç”»æ¿ç”³è¯·â€ã€â€œä½œç”»æµç¨‹â€ç­‰ä¸€ç³»åˆ—ç»†èŠ‚ã€‚ä¸‹é¢çš„å›¾æè¿°äº†è¿™ä¸‰è€…çš„å…³ç³»ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-12-IGraphicBufferProducer.png" alt="Alt text"></p><p>   è™½è¯´æ˜¯ä¸‰è€…çš„å…³ç³»ï¼Œä½†æ˜¯ä»–ä»¬æ‰€å±çš„å±‚å´åªæœ‰ä¸¤ä¸ªï¼Œappå±äºJavaå±‚ï¼ŒBufferQueue/SurfaceFlingerå±äºnativeå±‚ã€‚ä¹Ÿå°±æ˜¯è¯´BufferQueueä¹Ÿæ˜¯éš¶å±SurfaceFlingerï¼Œæ‰€æœ‰å·¥ä½œå›´ç»•SurfaceFlingerå±•å¼€ã€‚<br>       è¿™é‡ŒIGraphicBufferProducerå°±æ˜¯appå’ŒBufferQueueé‡è¦æ¡¥æ¢ï¼ŒGraphicBufferProduceræ‰¿æ‹…ç€å•ä¸ªåº”ç”¨è¿›ç¨‹ä¸­çš„UIæ˜¾ç¤ºéœ€æ±‚ï¼Œä¸BufferQueueæ‰“äº¤é“çš„å°±æ˜¯å®ƒã€‚</p><h5 id="2-1-6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹"><a href="#2-1-6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹" class="headerlink" title="2.1.6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹"></a>2.1.6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹</h5><p>NuPlayerä¸ç®¡æœ‰å¤šä¹ˆç¥ç§˜ï¼Œè¯´åˆ°åº•è¿˜æ˜¯ä¸ªæ’­æ”¾å™¨ã€‚åœ¨æ’­æ”¾å™¨çš„åŸºæœ¬æ¨¡å‹ä¸Šï¼Œä»–ä¸VCLã€mplayerã€ffmpegç­‰å¼€æºçš„ç»“æ„æ˜¯ä¸€è‡´çš„ã€‚åªæ˜¯ç»„ç»‡å®ç°çš„æ–¹å¼ä¸åŒã€‚<br>æ·±å…¥äº†è§£NuPlayerä¹‹å‰ï¼ŒæŠŠæ’­æ”¾å™¨çš„åŸºæœ¬æ¨¡å‹æ€»ç»“ä¸€ä¸‹ï¼Œç„¶åæŒ‰ç…§æ¨¡å‹çš„å„ä¸ªéƒ¨åˆ†æ¥æ·±å…¥ç ”ç©¶NuPlayerçš„å®ç°æ–¹å¼ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-13-source-demux-decoder-output.jpg" alt="Alt text"></p><p>â˜¯ datasourceæ•°æ®æºï¼šæ•°æ®æºï¼Œæ•°æ®çš„æ¥æºä¸ä¸€å®šéƒ½æ˜¯æœ¬åœ°fileï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç½‘è·¯ä¸Šçš„å„ç§åè®®ä¾‹å¦‚ï¼šhttpã€rtspã€HLSç­‰ã€‚sourceçš„ä»»åŠ¡å°±æ˜¯æŠŠæ•°æ®æºæŠ½è±¡å‡ºæ¥ï¼Œä¸ºä¸‹ä¸€ä¸ªdemuxæ¨¡å—æä¾›å®ƒéœ€è¦çš„ç¨³å®šçš„æ•°æ®æµã€‚demuxä¸ç”¨å…³ä¿¡æ•°æ®åˆ°åº•æ˜¯ä»ä»€ä¹ˆåœ°æ–¹æ¥çš„ã€‚</p><p>â˜¯ demuxerè§£å¤ç”¨ï¼šè§†é¢‘æ–‡ä»¶ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯æŠŠéŸ³è§†é¢‘çš„ESæµäº¤ç»‡çš„é€šè¿‡æŸç§è§„åˆ™æ”¾åœ¨ä¸€èµ·ã€‚è¿™ç§è§„åˆ™å°±æ˜¯å®¹å™¨è§„åˆ™ã€‚ç°åœ¨æœ‰å¾ˆå¤šä¸åŒçš„å®¹å™¨æ ¼å¼ã€‚å¦‚tsã€mp4ã€flvã€mkvã€aviã€rmvbç­‰ç­‰ã€‚demuxçš„åŠŸèƒ½å°±æ˜¯æŠŠéŸ³è§†é¢‘çš„ESæµä»å®¹å™¨ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œç„¶ååˆ†åˆ«é€åˆ°ä¸åŒçš„è§£ç å™¨ä¸­ã€‚å…¶å®éŸ³é¢‘å’Œè§†é¢‘æœ¬èº«å°±æ˜¯2ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿã€‚å®¹å™¨æŠŠå®ƒä»¬åŒ…åœ¨äº†ä¸€èµ·ã€‚ä½†æ˜¯ä»–ä»¬éƒ½æ˜¯ç‹¬ç«‹è§£ç çš„ï¼Œæ‰€ä»¥è§£ç ä¹‹å‰ï¼Œéœ€è¦æŠŠå®ƒåˆ†åˆ« ç‹¬ç«‹å‡ºæ¥ã€‚demuxå°±æ˜¯å¹²è¿™æ´»çš„ï¼Œä»–ä¸ºä¸‹ä¸€æ­¥decoderè§£ç æä¾›äº†æ•°æ®æµã€‚</p><p>â˜¯ decoderè§£ç ï¼šè§£ç å™¨â€”-æ’­æ”¾å™¨çš„æ ¸å¿ƒæ¨¡å—ã€‚åˆ†ä¸ºéŸ³é¢‘å’Œè§†é¢‘è§£ç å™¨ã€‚å½±åƒåœ¨å½•åˆ¶å, åŸå§‹çš„éŸ³è§†é¢‘éƒ½æ˜¯å ç”¨å¤§é‡ç©ºé—´, è€Œä¸”æ˜¯å†—ä½™åº¦è¾ƒé«˜çš„æ•°æ®. å› æ­¤, é€šå¸¸ä¼šåœ¨åˆ¶ä½œçš„æ—¶å€™å°±ä¼šè¿›è¡ŒæŸç§å‹ç¼© ( å‹ç¼©æŠ€æœ¯å°±æ˜¯å°†æ•°æ®ä¸­çš„å†—ä½™ä¿¡æ¯å»é™¤æ•°æ®ä¹‹é—´çš„ç›¸å…³æ€§ ). è¿™å°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„éŸ³è§†é¢‘ç¼–ç æ ¼å¼, åŒ…æ‹¬MPEG1ï¼ˆVCDï¼‰\ MPEG2ï¼ˆDVDï¼‰\ MPEG4 \ H.264 ç­‰ç­‰. éŸ³è§†é¢‘è§£ç å™¨çš„ä½œç”¨å°±æ˜¯æŠŠè¿™äº›å‹ç¼©äº†çš„æ•°æ®è¿˜åŸæˆåŸå§‹çš„éŸ³è§†é¢‘æ•°æ®. å½“ç„¶, ç¼–ç è§£ç è¿‡ç¨‹åŸºæœ¬ä¸Šéƒ½æ˜¯æœ‰æŸçš„ .è§£ç å™¨çš„ä½œç”¨å°±æ˜¯æŠŠç¼–ç åçš„æ•°æ®è¿˜åŸæˆåŸå§‹æ•°æ®ã€‚</p><p>â˜¯ outputè¾“å‡ºï¼šè¾“å‡ºéƒ¨åˆ†åˆ†ä¸ºéŸ³é¢‘å’Œè§†é¢‘è¾“å‡ºã€‚è§£ç åçš„éŸ³é¢‘ï¼ˆpcmï¼‰å’Œè§†é¢‘ï¼ˆyuvï¼‰çš„åŸå§‹æ•°æ®éœ€è¦å¾—åˆ°éŸ³è§†é¢‘çš„outputæ¨¡å—çš„æ”¯æŒæ‰èƒ½çœŸæ­£çš„è®©äººçš„æ„Ÿå®˜ç³»ç»Ÿï¼ˆçœ¼å’Œè€³ï¼‰è¾¨è¯†åˆ°ã€‚</p><p>æ‰€ä»¥ï¼Œæ’­æ”¾å™¨å¤§è‡´åˆ†æˆä¸Šè¿°4éƒ¨åˆ†ã€‚æ€ä¹ˆæŠ½è±¡çš„å®ç°è¿™4å¤§éƒ¨åˆ†ã€ä»¥åŠæ‰¾åˆ°ä¸€ç§åˆç†çš„æ–¹å¼å°†è¿™å‡ éƒ¨åˆ†ç»„ç»‡å¹¶è¿åŠ¨èµ·æ¥ã€‚æ˜¯æ¯ä¸ªæ’­æ”¾å™¨ä¸åŒçš„å®ç°æ–¹å¼è€Œå·²ã€‚æ¥ä¸‹æ¥å°±å›´ç»•è¿™4å¤§éƒ¨åˆ†åšæ·±å…¥å­¦ä¹ ï¼Œçœ‹çœ‹NuPlayerçš„å·¥ä½œåŸç†ã€‚</p><h5 id="2-2ã€NuPlayeråˆ†æ"><a href="#2-2ã€NuPlayeråˆ†æ" class="headerlink" title="2.2ã€NuPlayeråˆ†æ"></a>2.2ã€NuPlayeråˆ†æ</h5><h5 id="2-2-0ã€NuPlayerç®€ä»‹"><a href="#2-2-0ã€NuPlayerç®€ä»‹" class="headerlink" title="2.2.0ã€NuPlayerç®€ä»‹"></a>2.2.0ã€NuPlayerç®€ä»‹</h5><p>Android2.3æ—¶å¼•å…¥æµåª’ä½“æ¡†æ¶ï¼Œè€Œæµåª’ä½“æ¡†æ¶çš„æ ¸å¿ƒæ˜¯NuPlayerã€‚åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¸€èˆ¬è®¤ä¸ºLocal Playbackå°±ç”¨Stagefrightplayer+Awesomeplayerï¼Œæµåª’ä½“ç”¨NuPlayerã€‚Android4.0ä¹‹åHttpLiveå’ŒRTSPåè®®å¼€å§‹ä½¿ç”¨NuPlayeræ’­æ”¾å™¨ï¼ŒAndroid5.0ï¼ˆLç‰ˆæœ¬ï¼‰ä¹‹åæœ¬åœ°æ’­æ”¾ä¹Ÿå¼€å§‹ä½¿ç”¨NuPlayeræ’­æ”¾å™¨ã€‚ Android7.0(Nç‰ˆæœ¬)åˆ™å®Œå…¨å»æ‰äº†Awesomeplayerã€‚<br>é€šä¿—ç‚¹è¯´ï¼ŒNuPlayeræ˜¯AOSPä¸­æä¾›çš„å¤šåª’ä½“æ’­æ”¾æ¡†æ¶ï¼Œèƒ½å¤Ÿæ”¯æŒæœ¬åœ°æ–‡ä»¶ã€HTTPï¼ˆHLSï¼‰ã€RTSPç­‰åè®®çš„æ’­æ”¾ï¼Œé€šå¸¸æ”¯æŒH.264ã€H.265/HEVCã€AACç¼–ç æ ¼å¼ï¼Œæ”¯æŒMP4ã€MPEG-TSå°è£…ã€‚<br>åœ¨å®ç°ä¸ŠNuPlayerå’ŒAwesomeplayerä¸åŒï¼ŒNuPlayeråŸºäºStagefrightPlayerçš„åŸºç¡€ç±»æ„å»ºï¼Œåˆ©ç”¨äº†æ›´åº•å±‚çš„ALooper/AHandleræœºåˆ¶æ¥å¼‚æ­¥åœ°å¤„ç†è¯·æ±‚ï¼ŒALooperåˆ—é˜Ÿæ¶ˆæ¯è¯·æ±‚ï¼ŒAHandlerä¸­å»å¤„ç†ï¼Œæ‰€ä»¥æœ‰æ›´å°‘çš„Mutex/Lockåœ¨NuPlayerä¸­ã€‚Awesomeplayerä¸­åˆ©ç”¨äº†omxcodecè€ŒNuPlayerä¸­åˆ©ç”¨äº†Acodecã€‚</p><h5 id="2-2-1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾"><a href="#2-2-1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾" class="headerlink" title="2.2.1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾"></a>2.2.1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-14-NuPlayer-arc.jpg" alt="Alt text"></p><p>NuPlayerç”±NuPlayerDriverå°è£…ï¼Œåˆ©ç”¨äº†åº•å±‚çš„ALooper/AHandleræœºåˆ¶æ¥å¼‚æ­¥åœ°å¤„ç†è¯·æ±‚ï¼ŒALooperä¿å­˜æ¶ˆæ¯è¯·æ±‚ï¼Œç„¶ååœ¨AHandlerä¸­å¤„ç†ã€‚å¦å¤–ï¼ŒNuPlayerä¸­åˆ©ç”¨åˆ°äº†Acodecã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-15-NuPlayer-class.jpg" alt="Alt text"></p><p>â˜¯ NuPlayer::Source<br>è§£ææ¨¡å—ï¼ˆparserï¼ŒåŠŸèƒ½ç±»ä¼¼FFmpegçš„avformatï¼‰ã€‚å…¶æ¥å£ä¸MediaExtractorå’Œ<br>MediaSourceç»„åˆçš„æ¥å£å·®ä¸å¤šï¼ŒåŒæ—¶æä¾›äº†ç”¨äºå¿«é€Ÿå®šä½çš„seekToæ¥å£ã€‚</p><p>â˜¯ NuPlayer::Decoder<br>è§£ç æ¨¡å—ï¼ˆdecoderï¼ŒåŠŸèƒ½ç±»ä¼¼FFmpegçš„avcodecï¼‰ï¼Œå°è£…äº†ç”¨äºAVCã€AACè§£ç çš„æ¥å£ï¼Œ<br>é€šè¿‡ACodecå®ç°è§£ç ï¼ˆåŒ…å«OMXç¡¬è§£ç å’Œè½¯è§£ç ï¼‰ã€‚</p><p>â˜¯ NuPlayer::Render<br>æ¸²æŸ“æ¨¡å—ï¼ˆrenderï¼ŒåŠŸèƒ½ç±»ä¼¼å£°å¡é©±åŠ¨å’Œæ˜¾å¡é©±åŠ¨ï¼‰ï¼Œä¸»è¦ç”¨äºéŸ³è§†é¢‘æ¸²æŸ“å’ŒåŒæ­¥ï¼Œä¸<br>NativeWindowæœ‰å…³ã€‚</p><p>â˜¯ NuPlayer  æ˜¯æ’­æ”¾æ¡†æ¶ä¸­è¿æ¥Sourceã€Decoderã€Rendererçš„çº½å¸¦</p><p>â˜¯ NuPlayerDriver<br>ä½œä¸ºNuPlayerç±»çš„å°è£…ï¼Œç›´æ¥è°ƒç”¨NuPlayerã€‚</p><p>NuPlayeræ¡†æ¶ä¸­æœ€é¡¶å±‚çš„ç±»æ˜¯NuPlayerDriverï¼Œç»§æ‰¿è‡ªMediaPlayerInterfaceï¼Œä¸»è¦æä¾›ä¸€ä¸ªçŠ¶æ€è½¬æ¢æœºåˆ¶ï¼Œä½œä¸ºNuPlayerç±»çš„Wrapperã€‚NuPlayerDriverç±»ä¸­æœ€é‡è¦çš„æˆå‘˜æ˜¯ä»¥ä¸‹å‡ ä¸ªï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; State mState æ’­æ”¾å™¨çŠ¶ä½“æ ‡å¿— </span><br><span class="line">&gt; sp &lt;ALooper&gt; mLooper å†…éƒ¨æ¶ˆæ¯é©±åŠ¨æœºåˆ¶ </span><br><span class="line">&gt; sp &lt;NuPlayer&gt;  mPlayer çœŸæ­£å®Œæˆæ’­æ”¾å™¨çš„ç±»</span><br></pre></td></tr></table></figure><p>NuPlayerDriverä¸»è¦æ˜¯ æ„é€ å‡½æ•°-&gt; setDataSource -&gt; SetVideoSurfaceTexture-&gt; prepare/prepareAsync -&gt; start-&gt; stop-&gt; reset-&gt; ææ„å‡½æ•°ï¼Œå®é™…éœ€æ±‚pauseã€isPlayingã€getDurationã€getCurrentPositionã€setLoopingã€seekToç­‰æ–¹æ³•</p><h5 id="2-2-2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹"><a href="#2-2-2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹" class="headerlink" title="2.2.2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹"></a>2.2.2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NuPlayerçš„æ¡†æ¶ï¼Œå…¶å†…éƒ¨å®ç°é€»è¾‘ã€‚é‚£ä¹ˆæœ€ç»ˆå°±è½å®åˆ°å¦‚ä½•ä»ä¸€ä¸ªç±»ä¸­æå–å‡ºéœ€è¦çš„æ¡†æ¶åŠçŸ¥è¯†ç‚¹ã€‚é‚£ä¹ˆä¸€ä¸ªç±»çš„å¯¹å¤–æ¥å£éƒ¨åˆ†é€šå¸¸åŒ…æ‹¬ï¼š</span><br><span class="line">--- æ„é€ å‡½æ•°å’Œææ„å‡½æ•°</span><br><span class="line">--- å¿…é¡»è°ƒç”¨çš„æ¥å£</span><br><span class="line">--- å¯é€‰çš„è°ƒç”¨æ¥å£</span><br><span class="line"></span><br><span class="line">åœ¨å¤šåª’ä½“æ’­æ”¾ä¸­ï¼Œé€šè¿‡å…³æ³¨çš„ç‚¹æœ‰ï¼š</span><br><span class="line">--- å¦‚ä½•å®ç°è§£å¤ç”¨ï¼Œå¾—åˆ°éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ç­‰æ•°æ®</span><br><span class="line">--- å¦‚ä½•å®ç°è§£ç </span><br><span class="line">--- å¦‚ä½•å®ç°éŸ³è§†é¢‘åŒæ­¥</span><br><span class="line">--- å¦‚ä½•æ¸²æŸ“è§†é¢‘</span><br><span class="line">--- å¦‚ä½•æ’­æ”¾éŸ³é¢‘</span><br><span class="line">--- å¦‚ä½•å®ç°å¿«é€Ÿå®šä½</span><br></pre></td></tr></table></figure><h4 id="ä¸‰-ã€Android-MediaPlayeræ¡†æ¶åˆ†æ-AHandler-AMessage-ALooper"><a href="#ä¸‰-ã€Android-MediaPlayeræ¡†æ¶åˆ†æ-AHandler-AMessage-ALooper" class="headerlink" title="(ä¸‰)ã€Android MediaPlayeræ¡†æ¶åˆ†æ - AHandler AMessage ALooper"></a>(ä¸‰)ã€Android MediaPlayeræ¡†æ¶åˆ†æ - AHandler AMessage ALooper</h4><p>å‰æ–‡ä¸­æåˆ°è¿‡NuPlayeråŸºäºStagefrightPlayerçš„åŸºç¡€ç±»æ„å»ºï¼Œåˆ©ç”¨äº†æ›´åº•å±‚çš„ALooper/AHandleræœºåˆ¶æ¥<strong>å¼‚æ­¥åœ°å¤„ç†è¯·æ±‚</strong>ï¼ŒALooperä¿å­˜æ¶ˆæ¯è¯·æ±‚ï¼Œç„¶åè°ƒç”¨AHandleræ¥å£å»å¤„ç†ã€‚<br>å®é™…ä¸Šåœ¨ä»£ç ä¸­NuPlayeræœ¬èº«ç»§æ‰¿è‡ªAHandlerç±»ï¼Œè€ŒALooperå¯¹è±¡ä¿å­˜åœ¨NuPlayerDriverä¸­ã€‚<br>ALooper/AHandleræœºåˆ¶æ˜¯æ¨¡æ‹Ÿçš„æ¶ˆæ¯å¾ªç¯å¤„ç†æ–¹å¼ï¼Œé€šå¸¸æœ‰ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼šæ¶ˆæ¯ï¼ˆmessageï¼Œé€šå¸¸åŒ…å«Handlerï¼‰ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆqueueï¼‰ã€æ¶ˆæ¯å¤„ç†çº¿ç¨‹ï¼ˆlooper threadï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-16-AHandler-ALooper-AMessage.png" alt="Alt text"></p><p>å¯¹äºhandleræ¶ˆæ¯æœºåˆ¶ï¼Œæ„æˆå°±å¿…é¡»åŒ…æ‹¬ä¸€ä¸ªLoopï¼Œmessageã€‚é‚£ä¹ˆå¯¹åº”çš„AHandlerï¼Œä¹Ÿåº”è¯¥æœ‰å¯¹åº”çš„ALooperã€AMessageã€‚<br>å› æ­¤æœ¬å°èŠ‚ä¸»è¦æ¶‰åŠåˆ°ä¸‰ä¸ªç±»ALooperã€AHandlerã€AMessageã€‚</p><h5 id="3-1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰"><a href="#3-1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰" class="headerlink" title="3.1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰"></a>3.1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰</h5><p>ä¸‹é¢ä»£ç æ˜¯AHandleræ¥å£:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"./frameworks/av/include/media/stagefright/AHandler.h"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AHandler</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">    AHandler();</span><br><span class="line"></span><br><span class="line">    ALooper::<span class="function">handler_id <span class="title">id</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    sp&lt;ALooper&gt; looper() <span class="keyword">const</span>;</span><br><span class="line">    wp&lt;ALooper&gt; getLooper() <span class="keyword">const</span>;</span><br><span class="line">    wp&lt;AHandler&gt; getHandler() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onMessageReceived</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">AMessage</span>;</span>      <span class="comment">// deliverMessage()</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">ALooperRoster</span>;</span> <span class="comment">// setID()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> mMessageCounter;</span><br><span class="line">    KeyedVector&lt;<span class="keyword">uint32_t</span>, <span class="keyword">uint32_t</span>&gt; mMessages;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setID</span><span class="params">(ALooper::handler_id id, wp&lt;ALooper&gt; looper)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deliverMessage</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šé¢æ¥å£ï¼Œåˆæ­¥å°è±¡æ˜¯AHandleræ²¡æœ‰ç›´æ¥å¯¹å¤–çš„æ¥å£ï¼ˆåªæœ‰è·å–æˆå‘˜å˜é‡çš„æ¥å£ï¼‰ï¼ŒåŸºæœ¬ä¸Šåªæœ‰ä¸€ä¸ªonMessageReceivedç”¨äºå­ç±»ç»§æ‰¿ï¼ŒdeliverMessageç”¨äºç»™ç±»AMessageä½¿ç”¨ï¼ŒsetIDç”¨äºç»™å‹å…ƒç±»ALooperRosterä½¿ç”¨ã€‚ä»è¿™ç‚¹æ¥è¯´ï¼ŒçœŸæ­£ä»£ç åº”è¯¥åœ¨AMessageé‡Œè¾¹ã€‚</p><h5 id="3-2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰"><a href="#3-2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰" class="headerlink" title="3.2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰"></a>3.2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰</h5><p>ä¸‹é¢ä»£ç æ˜¯AMessageçš„å£°æ˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"./frameworks/av/include/media/stagefright/AMessage.h"</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AMessage</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">    AMessage();</span><br><span class="line">    AMessage(<span class="keyword">uint32_t</span> what, <span class="keyword">const</span> sp&lt;<span class="keyword">const</span> AHandler&gt; &amp;handler); <span class="comment">// ä»£ç ä¸­å¸¸ç”¨çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">static</span> sp&lt;AMessage&gt; FromParcel(<span class="keyword">const</span> Parcel &amp;parcel, <span class="keyword">size_t</span> maxNestingLevel = <span class="number">255</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write this AMessage to a parcel.</span></span><br><span class="line">    <span class="comment">// All items in the AMessage must have types that are recognized by</span></span><br><span class="line">    <span class="comment">// FromParcel(); otherwise, TRESPASS error will occur.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel *parcel)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setWhat</span><span class="params">(<span class="keyword">uint32_t</span> what)</span></span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> what() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™æ˜¯ä¸€ä¸ªAHandlerï¼Œé€šè¿‡è¿™ä¸ªå¯ä»¥è·å¾—ALooperå¯¹è±¡å¼•ç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTarget</span><span class="params">(<span class="keyword">const</span> sp&lt;<span class="keyword">const</span> AHandler&gt; &amp;handler)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤æ‰€æœ‰è®¾ç½®çš„æ¶ˆæ¯å±æ€§å‚æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸€ç³»åˆ—è®¾ç½®/è·å– Message å±æ€§çš„å‡½æ•°ã€‚ã€‚ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> setInt32/setInt64/setSize/setFloat/setDouble/setPointer/setPointer/setString/setRect/setObject/setBuffer/setMessage(...);</span><br><span class="line">    <span class="keyword">bool</span> findInt32/findInt64/findSize/findFloat/findDouble/findPointer/findString/findObject/findBuffer/findMessage/findRect(...) <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡è¿™ä¸ªå‡½æ•°æ£€ç´¢ä¸‹æŒ‡å®šåç§°çš„æ¶ˆæ¯å±æ€§æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">contains</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ•é€’æ¶ˆæ¯çš„æ¥å£ï¼Œé¡¾åæ€ä¹‰ç›´æ¥æŠ•é€’ç»™æ„é€ å‡½æ•°çš„ALooperï¼Œæ³¨æ„æ”¯æŒå»¶æ—¶æ¶ˆæ¯ï¼Œä½†ä¸æ”¯æŒæå‰æ¶ˆæ¯ï¼ŒdelayUS &gt; 0</span></span><br><span class="line">    <span class="keyword">status_t</span> post(<span class="keyword">int64_t</span> delayUs = <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ•é€’æ¶ˆæ¯å¹¶ç­‰å¾…æ‰§è¡Œç»“æŸåå‘é€responseæ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">status_t</span> postAndAwaitResponse(sp&lt;AMessage&gt; *response);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this returns true, the sender of this message is synchronously</span></span><br><span class="line">    <span class="comment">// awaiting a response and the reply token is consumed from the message</span></span><br><span class="line">    <span class="comment">// and stored into replyID. The reply token must be used to send the response</span></span><br><span class="line">    <span class="comment">// using "postReply" below.</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">senderAwaitsResponse</span><span class="params">(sp&lt;AReplyToken&gt; *replyID)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Posts the message as a response to a reply token.  A reply token can</span></span><br><span class="line">    <span class="comment">// only be used once. Returns OK if the response could be posted; otherwise,</span></span><br><span class="line">    <span class="comment">// an error.</span></span><br><span class="line">    <span class="keyword">status_t</span> postReply(<span class="keyword">const</span> sp&lt;AReplyToken&gt; &amp;replyID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·±æ‹·è´</span></span><br><span class="line">    sp&lt;AMessage&gt; dup() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯”è¾ƒä¸¤ä¸ªæ¶ˆæ¯ï¼Œå¹¶è¿”å›å·®å¼‚</span></span><br><span class="line">    sp&lt;AMessage&gt; changesFrom(<span class="keyword">const</span> sp&lt;<span class="keyword">const</span> AMessage&gt; &amp;other, <span class="keyword">bool</span> deep = <span class="literal">false</span>) <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ¶ˆæ¯å±æ€§å­˜å‚¨çš„ä¸ªæ•°åŠç‰¹å®šç´¢å¼•ä¸Šçš„æ¶ˆæ¯å±æ€§å‚æ•°</span></span><br><span class="line">    <span class="keyword">size_t</span> countEntries() <span class="keyword">const</span>;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">getEntryNameAt</span><span class="params">(<span class="keyword">size_t</span> index, Type *type)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~AMessage();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">ALooper</span>;</span> <span class="comment">// deliver()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> mWhat;</span><br><span class="line"></span><br><span class="line">    wp&lt;AHandler&gt; mHandler;</span><br><span class="line">    wp&lt;ALooper&gt; mLooper;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºALooperè°ƒç”¨çš„ï¼Œå‘é€æ¶ˆæ¯çš„æ¥å£</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deliver</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ¥å£å¯ä»¥çœ‹å‡ºåœ¨ä½¿ç”¨AMessageæ˜¯åªéœ€è¦æŒ‡å®šæ¶ˆæ¯çš„idå’Œè¦å¤„ç†è¯¥æ¶ˆæ¯çš„AHandlerå³å¯ï¼Œå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ï¼Œä¹Ÿå¯ä»¥å•ç‹¬è°ƒç”¨setWhatå’ŒsetTargetæ¥å£ã€‚AMessageæ„é€ å®Œæˆä¹‹åï¼Œå¯ä»¥è°ƒç”¨setXXXè®¾ç½®å¯¹åº”çš„å‚æ•°ï¼Œé€šè¿‡findXXXè·å–ä¼ é€’çš„å‚æ•°ã€‚æœ€åé€šè¿‡postå³å¯å°†æ¶ˆæ¯æŠ•é€’åˆ°AHandlerçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</p><h5 id="3-3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰"><a href="#3-3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰" class="headerlink" title="3.3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰"></a>3.3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰</h5><p>å…¶ç®€åŒ–çš„å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"./frameworks/av/include/media/stagefright/ALooper.h"</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ALooper</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">    ALooper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Takes effect in a subsequent call to start().</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setName</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">getName</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">handler_id <span class="title">registerHandler</span><span class="params">(<span class="keyword">const</span> sp&lt;AHandler&gt; &amp;handler)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregisterHandler</span><span class="params">(handler_id handlerID)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> start(<span class="keyword">bool</span> runOnCallingThread = <span class="literal">false</span>,</span><br><span class="line">            <span class="keyword">bool</span> canCallJava = <span class="literal">false</span>, <span class="keyword">int32_t</span> priority = PRIORITY_DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> stop();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> int64_t <span class="title">GetNowUs</span><span class="params">()</span></span>;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~ALooper();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">AMessage</span>;</span>       <span class="comment">// post()</span></span><br><span class="line"></span><br><span class="line">    AString mName;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Event</span> &#123;</span></span><br><span class="line">        <span class="keyword">int64_t</span> mWhenUs;</span><br><span class="line">        sp&lt;AMessage&gt; mMessage;</span><br><span class="line">    &#125;;</span><br><span class="line">    List&lt;Event&gt; mEventQueue;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">LooperThread</span>;</span></span><br><span class="line">    sp&lt;LooperThread&gt; mThread;</span><br><span class="line">    <span class="keyword">bool</span> mRunningLocally;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// START --- methods used only by AMessage</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// posts a message on this looper with the given timeout</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg, <span class="keyword">int64_t</span> delayUs)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// creates a reply token to be used with this looper</span></span><br><span class="line">    sp&lt;AReplyToken&gt; createReplyToken();</span><br><span class="line">    <span class="comment">// waits for a response for the reply token.  If status is OK, the response</span></span><br><span class="line">    <span class="comment">// is stored into the supplied variable.  Otherwise, it is unchanged.</span></span><br><span class="line">    <span class="keyword">status_t</span> awaitResponse(<span class="keyword">const</span> sp&lt;AReplyToken&gt; &amp;replyToken, sp&lt;AMessage&gt; *response);</span><br><span class="line">    <span class="comment">// posts a reply for a reply token.  If the reply could be successfully posted,</span></span><br><span class="line">    <span class="comment">// it returns OK. Otherwise, it returns an error value.</span></span><br><span class="line">    <span class="keyword">status_t</span> postReply(<span class="keyword">const</span> sp&lt;AReplyToken&gt; &amp;replyToken, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// END --- methods used only by AMessage</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">loop</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ALooperå¯¹å¤–æ¥å£æ¯”è¾ƒç®€å•ï¼Œé€šå¸¸å°±æ˜¯NuPlayerDriveræ„é€ å‡½æ•°ä¸­çš„è°ƒç”¨é€»è¾‘ã€‚å…ˆåˆ›å»ºä¸€ä¸ªALooperå¯¹è±¡ï¼Œç„¶åè°ƒç”¨setNameå’Œstartæ¥å£ï¼Œä¹‹åè°ƒç”¨registerHandlerè®¾ç½®ä¸€ä¸ªAHandlerï¼Œè¿™æ ·å°±å®Œæˆäº†åˆå§‹åŒ–ã€‚åœ¨ææ„ä¹‹å‰éœ€è¦è°ƒç”¨stopæ¥å£ã€‚<br>è¿™é‡Œéœ€è¦è¯´æ˜ä¸‹ï¼ŒALooper::startæ¥å£ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶è°ƒç”¨ALooper::loopå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦å®ç°æ¶ˆæ¯çš„å®é™…æ‰§è¡Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ALooper::loop() &#123;</span><br><span class="line">    Event event;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (mThread == <span class="literal">NULL</span> &amp;&amp; !mRunningLocally) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»mEventQueueå–å‡ºæ¶ˆæ¯ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œï¼Œä¸éœ€è¦çš„è¯å°±ç­‰å¾…</span></span><br><span class="line">        <span class="comment">// éœ€è¦çš„è¯å°±è°ƒç”¨handleræ‰§è¡Œï¼Œå¹¶åˆ é™¤å¯¹åº”æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">if</span> (mEventQueue.empty()) &#123;</span><br><span class="line">            mQueueChangedCondition.wait(mLock);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int64_t</span> whenUs = (*mEventQueue.begin()).mWhenUs;</span><br><span class="line">        <span class="keyword">int64_t</span> nowUs = GetNowUs();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (whenUs &gt; nowUs) &#123;</span><br><span class="line">            <span class="keyword">int64_t</span> delayUs = whenUs - nowUs;</span><br><span class="line">            mQueueChangedCondition.waitRelative(mLock, delayUs * <span class="number">1000l</span>l);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        event = *mEventQueue.begin();</span><br><span class="line">        mEventQueue.erase(mEventQueue.begin());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event.mMessage-&gt;deliver();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ¶ˆæ¯æ˜¯é€šè¿‡é‚£ä¸ªå‡½æ•°æ·»åŠ è¿›æ¥çš„å‘¢ï¼Ÿ è¿™å°±æ˜¯å‹å…ƒç±»AMessageçš„ä½œç”¨ï¼Œé€šè¿‡è°ƒç”¨ALooper::postæ¥å£ï¼Œå°†AMessageæ·»åŠ åˆ°mEventQueueä¸­ã€‚</p><h5 id="3-4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹"><a href="#3-4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹" class="headerlink" title="3.4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹"></a>3.4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹</h5><p>ä»¥NuPlayer::setVideoSurfaceTextureAsyncä¸ºç¤ºä¾‹åˆ†æä¸‹ALooper/AHandleræœºåˆ¶ã€‚<br>è¿™é‡Œä¸è§£é‡ŠALooperçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒèµ„æ–™Android Nativeå±‚å¼‚æ­¥æ¶ˆæ¯å¤„ç†æ¡†æ¶çš„å†…å®¹ã€‚<br>ä¸‹é¢æ˜¯setVideoSurfaceTextureAsyncçš„ä»£ç ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::setVideoSurfaceTextureAsync(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt; &amp;bufferProducer) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetVideoSurface, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufferProducer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="keyword">new</span> Surface(bufferProducer, <span class="literal">true</span> <span class="comment">/* controlledByApp */</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åŠŸèƒ½å¾ˆç®€å•ï¼Œåˆ›å»ºä¸€ä¸ªAMessageå¯¹è±¡ï¼Œå¹¶è®¾ç½®ä¸‹å‚æ•°ï¼Œå‚æ•°ç±»å‹ä¸ºObjectï¼Œåç§°æ˜¯â€surfaceâ€ï¼Œç„¶åé€šè¿‡AMessage::postæ¥å£ï¼Œé—´æ¥è°ƒç”¨ALooper::postæ¥å£ï¼Œå°†æ¶ˆæ¯å‘é€ç»™ALooper-NuPlayerDriver::mLooperï¼›ALooperçš„æ¶ˆæ¯å¾ªç¯çº¿ç¨‹æ£€æµ‹åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œåœ¨ALooper::loopå‡½æ•°ä¸­é€šè¿‡AMessageçš„deliveræ¥å£ï¼Œè°ƒç”¨AHandler::deliverMessageæ¥å£ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒåŠ¨NuPlayer::onMessageReceivedï¼ˆé€šè¿‡ç»§æ‰¿æœºåˆ¶å®ç°ï¼‰æ¥å£ã€‚è¿™æ ·ç»•äº†ä¸€åœˆã€‚æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ALooper/AHandleræœºåˆ¶å¤„ç†æ¶ˆæ¯äº†ã€‚<br>å…·ä½“å¤„ç†ä»£ç å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="keyword">case</span> kWhatSetVideoSurface:</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            sp&lt;RefBase&gt; obj;</span><br><span class="line">            CHECK(msg-&gt;findObject(<span class="string">"surface"</span>, &amp;obj));</span><br><span class="line">            sp&lt;Surface&gt; surface = <span class="keyword">static_cast</span>&lt;Surface *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">            ALOGD(<span class="string">"onSetVideoSurface(%p video decoder)"</span>, surface.get());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Need to check mStarted before calling mSource-&gt;getFormat because NuPlayer might</span></span><br><span class="line">            <span class="comment">// be in preparing state and it could take long time.</span></span><br><span class="line">            <span class="comment">// When mStarted is true, mSource must have been set.</span></span><br><span class="line">            <span class="keyword">if</span> (mSource == <span class="literal">NULL</span> || !mStarted || mSource-&gt;getFormat(<span class="literal">false</span> <span class="comment">/* audio */</span>) == <span class="literal">NULL</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">NOTE:</span> mVideoDecoder's mSurface is always non-null</span></span><br><span class="line">                    || (mVideoDecoder != <span class="literal">NULL</span> &amp;&amp; mVideoDecoder-&gt;setVideoSurface(surface) == OK)) &#123;</span><br><span class="line">                performSetSurface(surface);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å››-ã€NuPlayeræºç åˆ†æ"><a href="#å››-ã€NuPlayeræºç åˆ†æ" class="headerlink" title="(å››)ã€NuPlayeræºç åˆ†æ"></a>(å››)ã€NuPlayeræºç åˆ†æ</h4><p>è¿™æ¬¡æˆ‘ä»¬éœ€è¦æ·±å…¥åˆ†æçš„æ˜¯NuPlayerç±»ï¼Œç›¸æ¯”äºNuPlayerDriverçš„æ¥å£åŠŸèƒ½ï¼ŒNuPlayerç»§æ‰¿è‡ªAHandlerç±»ï¼Œæ˜¯AOSPæ’­æ”¾æ¡†æ¶ä¸­è¿æ¥Sourceã€Decoderã€Renderçš„çº½å¸¦ã€‚</p><h5 id="4-1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜"><a href="#4-1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜" class="headerlink" title="4.1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜"></a>4.1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜</h5><p>NuPlayerç±»è¢«NuPlayerDriverç›´æ¥è°ƒç”¨ï¼Œå…¶ä¸»è¦æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// code from NuPlayer.h (~/frameworks/av/media/libmediaplayerservice/nuplayer/)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NuPlayer</span> :</span> <span class="keyword">public</span> AHandler &#123;</span><br><span class="line">    NuPlayer(<span class="keyword">pid_t</span> pid);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setUID</span><span class="params">(<span class="keyword">uid_t</span> uid)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDriver</span><span class="params">(<span class="keyword">const</span> wp&lt;NuPlayerDriver&gt; &amp;driver)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareAsync</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setVideoSurfaceTextureAsync</span><span class="params">(<span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt; &amp;bufferProducer)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will notify the driver through "notifyResetComplete" once finished.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">resetAsync</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will notify the driver through "notifySeekComplete" once finished</span></span><br><span class="line">    <span class="comment">// and needNotify is true.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">seekToAsync</span><span class="params">(<span class="keyword">int64_t</span> seekTimeUs, <span class="keyword">bool</span> needNotify = <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> setVideoScalingMode(<span class="keyword">int32_t</span> mode);</span><br><span class="line">    <span class="keyword">status_t</span> getTrackInfo(Parcel* reply) <span class="keyword">const</span>;</span><br><span class="line">    <span class="keyword">status_t</span> getSelectedTrack(<span class="keyword">int32_t</span> type, Parcel* reply) <span class="keyword">const</span>;</span><br><span class="line">    <span class="keyword">status_t</span> selectTrack(<span class="keyword">size_t</span> trackIndex, <span class="keyword">bool</span> select, <span class="keyword">int64_t</span> timeUs);</span><br><span class="line">    <span class="keyword">status_t</span> getCurrentPosition(<span class="keyword">int64_t</span> *mediaUs);</span><br><span class="line"></span><br><span class="line">    sp&lt;MetaData&gt; getFileMeta();</span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">getFrameRate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~NuPlayer();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onMessageReceived</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£åˆ†ç±»ä¸‹ï¼Œæ— å¤–ä¹å‡ ä¸ªåˆ†ç±»ï¼š</p><p>â˜¯ ç”¨äºåˆå§‹åŒ–çš„ï¼ˆæ¯”å¦‚æ„é€ å‡½æ•°ã€setDriver/setDataSourceAsync/prepareAsync/setVideoSurfaceTextureAsyncï¼‰<br>â˜¯ ç”¨äºé”€æ¯çš„ï¼ˆæ¯”å¦‚ææ„å‡½æ•°ã€resetAsyncï¼‰<br>â˜¯ ç”¨äºæ’­æ”¾æ§åˆ¶çš„ï¼ˆæ¯”å¦‚start/pause/seekToAsyncï¼‰<br>â˜¯ ç”¨äºçŠ¶æ€è·å–çš„ï¼ˆæ¯”å¦‚getCurrentPosition/getFileMetaï¼‰<br>ä¸‹é¢æ˜¯ä¸»è¦çš„ç±»æˆå‘˜éƒ¨åˆ†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.h]</span><br><span class="line">wp&lt;NuPlayerDriver&gt; mDriver; <span class="comment">// æ¥å£è°ƒç”¨æ–¹</span></span><br><span class="line">sp&lt;Source&gt; mSource; <span class="comment">// ç›¸å½“äºFFmpegä¸­çš„demuxer</span></span><br><span class="line">sp&lt;Surface&gt; mSurface; <span class="comment">// æ˜¾ç¤ºç”¨çš„Surface</span></span><br><span class="line">sp&lt;DecoderBase&gt; mVideoDecoder; <span class="comment">// è§†é¢‘è§£ç å™¨</span></span><br><span class="line">sp&lt;DecoderBase&gt; mAudioDecoder; <span class="comment">// éŸ³é¢‘è§£ç å™¨</span></span><br><span class="line">sp&lt;CCDecoder&gt; mCCDecoder; </span><br><span class="line">sp&lt;Renderer&gt; mRenderer; <span class="comment">// æ¸²æŸ“å™¨</span></span><br><span class="line">sp&lt;ALooper&gt; mRendererLooper;</span><br></pre></td></tr></table></figure><h5 id="4-2ã€setDataSourceAsync-ç°åˆ†æ"><a href="#4-2ã€setDataSourceAsync-ç°åˆ†æ" class="headerlink" title="4.2ã€setDataSourceAsync()ç°åˆ†æ"></a>4.2ã€setDataSourceAsync()ç°åˆ†æ</h5><p>è¿™ä¸ªå‡½æ•°æœ‰å¤šé‡ä¸åŒçš„é‡è½½å½¢å¼ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.h]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(<span class="keyword">const</span> sp&lt;IStreamSource&gt; &amp;source)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(<span class="keyword">const</span> sp&lt;IMediaHTTPService&gt; &amp;httpService, <span class="keyword">const</span> <span class="keyword">char</span> *url,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> KeyedVector&lt;String8, String8&gt; *headers)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int64_t</span> offset, <span class="keyword">int64_t</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(<span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source)</span></span>;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ï¼Œè¿™é‡Œä»¥ç¬¬ä¸‰ä¸ªæ¥å£ä¸ºä¾‹ï¼Œè¯´æ˜ä¸‹å¤šæœ¬åœ°åª’ä½“æ–‡ä»¶æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚<br>ä¸‹é¢æ˜¯è¿™ä¸ªå‡½æ•°çš„å®ç°ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::setDataSourceAsync(<span class="keyword">int</span> fd, <span class="keyword">int64_t</span> offset, <span class="keyword">int64_t</span> length) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetDataSource, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSourceNotify, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå¯¹è±¡ç”¨äºè¯»å–æœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    sp&lt;GenericSource&gt; source =</span><br><span class="line">            <span class="keyword">new</span> GenericSource(notify, mUIDValid, mUID);</span><br><span class="line">    <span class="comment">// å®é™…å¹²æ´»çš„çš„ä»£ç </span></span><br><span class="line">    <span class="keyword">status_t</span> err = source-&gt;setDataSource(fd, offset, length);</span><br><span class="line">    </span><br><span class="line">    msg-&gt;setObject(<span class="string">"source"</span>, source);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹å®ç°å¾ˆç®€å•ï¼Œåˆ›å»ºGenericSourceå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶setDataSourceæ¥å£ï¼Œç„¶åå‘é€kWhatSetDataSourceæ¶ˆæ¯ã€‚<br>æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å¤„ç†ç„¶åå‘é€kWhatSetDataSourceæ¶ˆæ¯å‘¢ï¼Ÿä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">case</span> kWhatSetDataSource:</span><br><span class="line">&#123;</span><br><span class="line">    CHECK(mSource == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = OK;</span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    CHECK(msg-&gt;findObject(<span class="string">"source"</span>, &amp;obj));</span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mSourceLock)</span></span>;</span><br><span class="line">        mSource = <span class="keyword">static_cast</span>&lt;Source *&gt;(obj.get());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šçŸ¥Driverå‡½æ•°è°ƒç”¨å®Œæˆ</span></span><br><span class="line">    CHECK(mDriver != <span class="literal">NULL</span>);</span><br><span class="line">    sp&lt;NuPlayerDriver&gt; driver = mDriver.promote();</span><br><span class="line">    <span class="keyword">if</span> (driver != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        driver-&gt;notifySetDataSourceCompleted(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>çœ‹åˆ°è¿™é‡Œå‘ç°ï¼Œå…¶å®æ²¡åšä»€ä¹ˆå°±æ˜¯ç›´æ¥é€šçŸ¥NuPlayerDriverã€‚æˆ‘ä»¬è¿˜æ³¨æ„åˆ°è¿™é‡Œæ„å»ºäº†ä¸€ä¸ªç‰¹æ®Šæ¶ˆæ¯ï¼ˆAMessageï¼‰notifyï¼Œè¿™ä¸ªæ¶ˆæ¯ç”¨äºåœ¨Sourceå’ŒNuPlayerç›´æ¥ä¼ é€’ã€‚ä¸‹é¢è¿™æ˜¯æ¶ˆæ¯å¾ªç¯ä¸­çš„å¤„ç†å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">case</span> kWhatSourceNotify:</span><br><span class="line">&#123;</span><br><span class="line">    onSourceNotify(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åç»­è®¨è®ºSourceçš„æ—¶å€™è¯¦ç»†è¯´æ˜è¿™ä¸ªæ¶ˆæ¯é€šçŸ¥çš„æ„ä¹‰ã€‚</p><h5 id="4-3ã€prepareAsync"><a href="#4-3ã€prepareAsync" class="headerlink" title="4.3ã€prepareAsync()"></a>4.3ã€prepareAsync()</h5><p>è¿™ä¸ªå‡½æ•°å®ç°çš„åŠŸèƒ½å¯¹åº”äºMediaPlayerBase::prepare/prepareAsyncæ¥å£ï¼Œå®ç°å¼‚æ­¥çš„prepareåŠŸèƒ½ï¼Œä¸€èˆ¬å°±æ˜¯åšä¸€äº›é¢å¤–çš„åˆå§‹åŒ–å·¥ä½œã€‚é‚£ä¹ˆç›´æ¥çœ‹ä¸€ä¸‹å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::prepareAsync() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatPrepare, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç å°±æ˜¯å‘äº†ä¸€ä¸ªkWhatPrepareçš„æ¶ˆæ¯ã€‚æ¥ä¸‹æ¥æ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ªæ¶ˆæ¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatPrepare:</span><br><span class="line">&#123;</span><br><span class="line">    mSource-&gt;prepareAsync();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†Source::prepareAsyncæ¥å£ã€‚åé¢ä¼šè§£é‡Šå…¶åŠŸèƒ½ã€‚ï¼ˆè¿™é‡Œé¢å¯èƒ½ä¼šè§£æä¸‹ç æµï¼Œè¯»å–éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•æµä¿¡æ¯ï¼Œè¯»å–æ—¶é•¿ã€å…ƒæ•°æ®ç­‰ï¼‰ã€‚</p><h5 id="4-4ã€setVideoSurfaceTextureAsync"><a href="#4-4ã€setVideoSurfaceTextureAsync" class="headerlink" title="4.4ã€setVideoSurfaceTextureAsync()"></a>4.4ã€setVideoSurfaceTextureAsync()</h5><p>è°ƒç”¨è¿™ä¸ªæ¥å£ä¸»è¦ä¸ºäº†è®¾ç½®è§†é¢‘æ¸²æŸ“çª—å£ã€‚å…¶å®ç°ç›¸å¯¹ç®€å•ï¼Œåˆ›å»ºä¸€ä¸ªSurfaceï¼Œç„¶åå‘é€å¼‚æ­¥çš„kWhatSetVideoSurfaceæ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::setVideoSurfaceTextureAsync( <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt; &amp;bufferProducer) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetVideoSurface, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufferProducer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="keyword">new</span> Surface(bufferProducer, <span class="literal">true</span> <span class="comment">/* controlledByApp */</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆçœ‹çœ‹å¦‚ä½•å¤„ç†kWhatSetVideoSurfaceæ¶ˆæ¯å‘¢ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatSetVideoSurface: &#123;</span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    CHECK(msg-&gt;findObject(<span class="string">"surface"</span>, &amp;obj));</span><br><span class="line">    sp&lt;Surface&gt; surface = <span class="keyword">static_cast</span>&lt;Surface *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Need to check mStarted before calling mSource-&gt;getFormat because NuPlayer might</span></span><br><span class="line">    <span class="comment">// be in preparing state and it could take long time.</span></span><br><span class="line">    <span class="comment">// When mStarted is true, mSource must have been set.</span></span><br><span class="line">    <span class="keyword">if</span> (mSource == <span class="literal">NULL</span> || !mStarted || mSource-&gt;getFormat(<span class="literal">false</span> <span class="comment">/* audio */</span>) == <span class="literal">NULL</span></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> mVideoDecoder's mSurface is always non-null</span></span><br><span class="line">            || (mVideoDecoder != <span class="literal">NULL</span> &amp;&amp; mVideoDecoder-&gt;setVideoSurface(surface) == OK)) &#123;</span><br><span class="line">        performSetSurface(surface); <span class="comment">// é€šçŸ¥NuPlayerDriverè®¾ç½®å®Œæˆ</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¸…ç©ºéŸ³é¢‘ã€è§†é¢‘ç¼“å†²</span></span><br><span class="line">    mDeferredActions.push_back(</span><br><span class="line">            <span class="keyword">new</span> FlushDecoderAction(FLUSH_CMD_FLUSH <span class="comment">/* audio */</span>,FLUSH_CMD_SHUTDOWN <span class="comment">/* video */</span>));</span><br><span class="line">    <span class="comment">// æœ€ç»ˆè°ƒç”¨NuPlayer::performSetSurfaceæ¥å£</span></span><br><span class="line">    mDeferredActions.push_back(<span class="keyword">new</span> SetSurfaceAction(surface));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="literal">NULL</span> || mAudioDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">            <span class="comment">// Issue a seek to refresh the video screen only if started otherwise</span></span><br><span class="line">            <span class="comment">// the extractor may not yet be started and will assert.</span></span><br><span class="line">            <span class="comment">// If the video decoder is not set (perhaps audio only in this case)</span></span><br><span class="line">            <span class="comment">// do not perform a seek as it is not needed.</span></span><br><span class="line">            <span class="keyword">int64_t</span> currentPositionUs = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (getCurrentPosition(&amp;currentPositionUs) == OK) &#123;</span><br><span class="line">                mDeferredActions.push_back(</span><br><span class="line">                        <span class="keyword">new</span> SeekAction(currentPositionUs));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯¹äºæ–°çš„surfaceè®¾ç½®ï¼Œé‡ç½®ä¸‹è§£ç å™¨</span></span><br><span class="line">        mDeferredActions.push_back(<span class="keyword">new</span> SimpleAction(&amp;NuPlayer::performScanSources));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After a flush without shutdown, decoder is paused.</span></span><br><span class="line">    <span class="comment">// Don't resume it until source seek is done, otherwise it could</span></span><br><span class="line">    <span class="comment">// start pulling stale data too soon.</span></span><br><span class="line">    mDeferredActions.push_back(</span><br><span class="line">            <span class="keyword">new</span> ResumeDecoderAction(<span class="literal">false</span> <span class="comment">/* needNotify */</span>));</span><br><span class="line">    <span class="comment">// æŠŠä¸Šé¢mDeferredActionsä¸­ç¼“å­˜çš„æ‰€æœ‰Actionå¤„ç†ä¸‹ï¼Œå¹¶æ¸…ç©º</span></span><br><span class="line">    processDeferredActions();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä»£ç ç›¸å¯¹å¤æ‚ç‚¹ï¼Œæ¶‰åŠåˆ°å¾ˆå¤šï¼Œå…¶å®ä¸»è¦æ˜¯ä¸ºäº†è®¾ç½®Surfaceä¹‹åï¼Œå¯ä»¥æ­£å¸¸è§£ç æ˜¾ç¤ºï¼Œå› ä¸ºæŸäº›æƒ…å†µä¸‹è§£ç å™¨åˆå§‹åŒ–éœ€è¦ä¾èµ–äºå…·ä½“çš„Surfaceã€‚å½“ç„¶ï¼Œé‡Œè¾¹è¿˜æ¶‰åŠåˆ°NuPlayerçŠ¶æ€åŠåˆå§‹åŒ–åˆ¤æ–­ã€‚</p><h5 id="4-5ã€start-pause"><a href="#4-5ã€start-pause" class="headerlink" title="4.5ã€start()/pause()"></a>4.5ã€start()/pause()</h5><p>startå‡½æ•°å®ç°å¾ˆç®€å•ï¼Œå®é™…å°±å‘é€äº†kWhatStartæ¶ˆæ¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::start() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatStart, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ¶ˆæ¯å¤„ç†å‡½æ•°ä¸­çš„å¤„ç†å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatStart:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">        <span class="comment">// do not resume yet if the source is still buffering</span></span><br><span class="line">        <span class="keyword">if</span> (!mPausedForBuffering) &#123;</span><br><span class="line">            onResume();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onStart();</span><br><span class="line">    &#125;</span><br><span class="line">    mPausedByClient = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨äº†OnStart/OnResumeå‡½æ•°ã€‚<br>pauseå‡½æ•°å®ç°ç±»ä¼¼ï¼Œåªæ˜¯å‘é€çš„æ˜¯kWhatPauseæ¶ˆæ¯ã€‚åœ¨æ¶ˆæ¯å¤„ç†å‡½æ•°ä¸­çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatPause:</span><br><span class="line">&#123;</span><br><span class="line">    onPause();</span><br><span class="line">    mPausedByClient = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨çš„onPauseå‡½æ•°ã€‚ä¸‹é¢å•ç‹¬åˆ†æä¸‹è¿™ä¸‰ä¸ªå‡½æ•°ã€‚å…ˆä»ç®€å•çš„å‡½æ•°å¼€å§‹OnPause/onResume</p><p>NuPlayer::onPause<br>è¿™ä¸ªå‡½æ•°å®ç°æš‚åœåŠŸèƒ½ï¼Œæ€»ä½“æ¥è¯´å°±æ˜¯æŠŠSourceå’ŒRenderæš‚åœå°±å¯ä»¥äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::onPause() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPaused) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mPaused = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (mSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mSource-&gt;pause();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mRenderer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mRenderer-&gt;pause();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NuPlayer::onResume<br>è¿™ä¸ªå‡½æ•°å®ç°æ¢å¤åŠŸèƒ½ï¼Œä»£ç é€»è¾‘è·ŸonPauseå·®ä¸å¤šï¼ŒæŠŠSourceå’ŒRenderæ¢å¤ï¼Œè¿˜å¯èƒ½æ¶‰åŠå…¶å®ƒæ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::onResume() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mPaused || mResetting) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mPaused = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mSource-&gt;resume();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// |mAudioDecoder| may have been released due to the pause timeout, so re-create it if</span></span><br><span class="line">    <span class="comment">// needed.</span></span><br><span class="line">    <span class="keyword">if</span> (audioDecoderStillNeeded() &amp;&amp; mAudioDecoder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        instantiateDecoder(<span class="literal">true</span> <span class="comment">/* audio */</span>, &amp;mAudioDecoder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mRenderer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mRenderer-&gt;resume();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NuPlayer::onStart<br>è¿™ä¸ªæ¥å£å®ç°å¯åŠ¨çš„æ“ä½œï¼Œç›¸å¯¹å¤æ‚ç‚¹ï¼Œéœ€è¦åˆå§‹åŒ–è§£ç å™¨ã€åˆå§‹åŒ–Renderã€è®¾ç½®SourceçŠ¶æ€ï¼Œå¹¶å°†ä¸‰è€…å…³è”èµ·æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::onStart(<span class="keyword">int64_t</span> startPositionUs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mSourceStarted) &#123;</span><br><span class="line">        mSourceStarted = <span class="literal">true</span>;</span><br><span class="line">        mSource-&gt;start(); <span class="comment">// è®¾ç½®SourceçŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... (çœç•¥éƒ¨åˆ†ä»£ç )</span></span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatRendererNotify, <span class="keyword">this</span>);</span><br><span class="line">    ++mRendererGeneration; <span class="comment">// åˆ›å»ºRenderå’ŒRenderLooperï¼Œå±æ€§è®¾ç½®ã€ä¸è§£ç å™¨å…³è”</span></span><br><span class="line">    notify-&gt;setInt32(<span class="string">"generation"</span>, mRendererGeneration);</span><br><span class="line">    mRenderer = <span class="keyword">new</span> Renderer(mAudioSink, notify, flags);</span><br><span class="line">    mRendererLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">    mRendererLooper-&gt;setName(<span class="string">"NuPlayerRenderer"</span>);</span><br><span class="line">    mRendererLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">    mRendererLooper-&gt;registerHandler(mRenderer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = mRenderer-&gt;setPlaybackSettings(mPlaybackSettings);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> rate = getFrameRate();</span><br><span class="line">    <span class="keyword">if</span> (rate &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        mRenderer-&gt;setVideoFrameRate(rate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mVideoDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mVideoDecoder-&gt;setRenderer(mRenderer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mAudioDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mAudioDecoder-&gt;setRenderer(mRenderer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    postScanSources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­æ²¡æœ‰è§£ç å™¨çš„åˆå§‹åŒ–ï¼Œé‚£åªèƒ½ç»§ç»­çœ‹çœ‹postScanSourcesä»£ç äº†ã€‚çœ‹å®ç°å‘ç°å°±æ˜¯å‘é€äº†kWhatScanSourcesæ¶ˆæ¯ã€‚é‚£ä¹ˆæ¶ˆæ¯å¾ªç¯é‡Œè¾¹æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatScanSources:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> generation;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"generation"</span>, &amp;generation));</span><br><span class="line">    <span class="keyword">if</span> (generation != mScanSourcesGeneration) &#123;</span><br><span class="line">        <span class="comment">// Drop obsolete msg.</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mScanSourcesPending = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> mHadAnySourcesBefore = (mAudioDecoder != <span class="literal">NULL</span>) || (mVideoDecoder != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">bool</span> rescan = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize video before audio because successful initialization of</span></span><br><span class="line">    <span class="comment">// video may change deep buffer mode of audio.</span></span><br><span class="line">    <span class="keyword">if</span> (mSurface != <span class="literal">NULL</span>) &#123; <span class="comment">// åˆå§‹åŒ–è§†é¢‘è§£ç å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (instantiateDecoder(<span class="literal">false</span>, &amp;mVideoDecoder) == -EWOULDBLOCK) &#123;</span><br><span class="line">            rescan = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don't try to re-open audio sink if there's an existing decoder.</span></span><br><span class="line">    <span class="keyword">if</span> (mAudioSink != <span class="literal">NULL</span> &amp;&amp; mAudioDecoder == <span class="literal">NULL</span>) &#123; <span class="comment">// åˆå§‹åŒ–éŸ³é¢‘è§£ç å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (instantiateDecoder(<span class="literal">true</span>, &amp;mAudioDecoder) == -EWOULDBLOCK) &#123;</span><br><span class="line">            rescan = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mHadAnySourcesBefore &amp;&amp; (mAudioDecoder != <span class="literal">NULL</span> || mVideoDecoder != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="comment">// This is the first time we've found anything playable.</span></span><br><span class="line">        <span class="comment">// è®¾ç½®å®šæœŸæŸ¥è¯¢æ—¶é•¿</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceFlags &amp; Source::FLAG_DYNAMIC_DURATION) &#123;</span><br><span class="line">            schedulePollDuration();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err; <span class="comment">// ä¸€äº›å¼‚å¸¸å¤„ç†é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> ((err = mSource-&gt;feedMoreTSData()) != OK) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAudioDecoder == <span class="literal">NULL</span> &amp;&amp; mVideoDecoder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// We're not currently decoding anything (no audio or</span></span><br><span class="line">            <span class="comment">// video tracks found) and we just ran out of input data.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == ERROR_END_OF_STREAM) &#123;</span><br><span class="line">                notifyListener(MEDIA_PLAYBACK_COMPLETE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                notifyListener(MEDIA_ERROR, MEDIA_ERROR_UNKNOWN, err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦çš„è¯ï¼Œé‡æ–°æ‰«æSource</span></span><br><span class="line">    <span class="keyword">if</span> (rescan) &#123;</span><br><span class="line">        msg-&gt;post(<span class="number">100000l</span>l);</span><br><span class="line">        mScanSourcesPending = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜æœ‰seekToAsync()ã€resetAsync()ã€getCurrentPosition()ã€getFileMeta()ã€‚ç”±äºå®ç°ç±»ä¼¼ï¼Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚</p><h5 id="4-6ã€å°ç»“ç»“å’Œç–‘é—®"><a href="#4-6ã€å°ç»“ç»“å’Œç–‘é—®" class="headerlink" title="4.6ã€å°ç»“ç»“å’Œç–‘é—®"></a>4.6ã€å°ç»“ç»“å’Œç–‘é—®</h5><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æŠŠNuPlayerä¸»è¦çš„å‡½æ•°åˆ†æå®Œäº†ï¼Œä½†æ˜¯é—®é¢˜ä¾æ—§åœ¨ã€‚æ¯”å¦‚ä¸‹é¢å‡ ä¸ªï¼š</p><blockquote><p><strong>ä¸åŒæ ¼å¼çš„å¤šåª’ä½“æ–‡ä»¶å¦‚ä½•æ¢æµ‹å¹¶è§£æçš„ï¼ŸéŸ³è§†é¢‘æ•°æ®ç¼“å†²åŒºåœ¨å“ªé‡Œï¼Ÿï¼ˆSourceï¼‰</strong><br><strong>è§†é¢‘å¦‚ä½•æ˜¾ç¤ºçš„ï¼ŸéŸ³é¢‘å¦‚ä½•æ’­æ”¾çš„ï¼ŸéŸ³è§†é¢‘åŒæ­¥åœ¨å“ªé‡Œï¼Ÿï¼ˆRendererï¼‰</strong><br><strong>éŸ³é¢‘è§£ç çº¿ç¨‹ã€è§†é¢‘è§£ç çº¿ç¨‹åœ¨å“ªé‡Œï¼Ÿ ï¼ˆDecoderBaseï¼‰</strong></p></blockquote><p>æˆ‘æƒ³æ¥ä¸‹æ¥çš„åˆ†æå°±æ˜¯è§£å†³è¿™äº›ç–‘é—®çš„ã€‚</p><h5 id="4-7ã€Codec-Encoder-ã€Decoderåˆ—è¡¨é™„å½•"><a href="#4-7ã€Codec-Encoder-ã€Decoderåˆ—è¡¨é™„å½•" class="headerlink" title="4.7ã€Codec Encoder ã€Decoderåˆ—è¡¨é™„å½•"></a>4.7ã€Codec Encoder ã€Decoderåˆ—è¡¨é™„å½•</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">[AOSP/device/qcom/msm8996/media_codecs.xml(system/etc/media_codecs.xml)]</span><br><span class="line">&lt;!--</span><br><span class="line"> <span class="number">8996</span> Decoder capabilities</span><br><span class="line"> __________________________________________________________________</span><br><span class="line"> | Codec    | W       H       fps     Mbps    MB/s    | Secure-dec |</span><br><span class="line"> |__________|_________________________________________|____________|</span><br><span class="line"> | h264     | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">60</span>      <span class="number">100</span>     <span class="number">1958400</span> |  Y         |</span><br><span class="line"> |          | (<span class="number">4096</span>)  (<span class="number">2160</span>)  (<span class="number">56</span>)    (<span class="number">100</span>)           |            |</span><br><span class="line"> | hevc     | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">60</span>      <span class="number">100</span>     <span class="number">1958400</span> |  Y         |</span><br><span class="line"> |          | (<span class="number">4096</span>)  (<span class="number">2160</span>)  (<span class="number">56</span>)    (<span class="number">100</span>)           |            |</span><br><span class="line"> | mpeg4    | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">60</span>      <span class="number">60</span>      <span class="number">489600</span>  |  N         |</span><br><span class="line"> | vc1      | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">60</span>      <span class="number">60</span>      <span class="number">489600</span>  |  Y         |</span><br><span class="line"> | vp8      | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |  N         |</span><br><span class="line"> | vp9      | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |  Y         |</span><br><span class="line"> | divx3    | <span class="number">720</span>     <span class="number">480</span>     <span class="number">30</span>      <span class="number">2</span>       <span class="number">40500</span>   |  N         |</span><br><span class="line"> | div4/<span class="number">5</span>/<span class="number">6</span> | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">30</span>      <span class="number">10</span>      <span class="number">244800</span>  |  N         |</span><br><span class="line"> | h263     | <span class="number">864</span>     <span class="number">480</span>     <span class="number">30</span>      <span class="number">2</span>       <span class="number">48600</span>   |  N         |</span><br><span class="line"> | mpeg2    | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">30</span>      <span class="number">40</span>      <span class="number">244800</span>  |  Y         |</span><br><span class="line"> |__________|_________________________________________|____________|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="number">8996</span> Encoder capabilities</span><br><span class="line"> ______________________________________________________</span><br><span class="line"> | Codec    | W       H       fps     Mbps    MB/s    |</span><br><span class="line"> |__________|_________________________________________|</span><br><span class="line"> | h264     | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |</span><br><span class="line"> | hevc     | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |</span><br><span class="line"> | mpeg4    | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">60</span>      <span class="number">60</span>      <span class="number">489600</span>  |</span><br><span class="line"> | vp8      | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |</span><br><span class="line"> | h263     | <span class="number">864</span>     <span class="number">480</span>     <span class="number">30</span>      <span class="number">2</span>       <span class="number">48600</span>   |</span><br><span class="line"> |__________|_________________________________________|</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line">&lt;MediaCodecs&gt;</span><br><span class="line">    &lt;Include href=<span class="string">"media_codecs_google_audio.xml"</span> /&gt;</span><br><span class="line">    &lt;Include href=<span class="string">"media_codecs_google_telephony.xml"</span> /&gt;</span><br><span class="line">    &lt;Settings&gt;</span><br><span class="line">        &lt;Setting name=<span class="string">"max-video-encoder-input-buffers"</span> value=<span class="string">"11"</span> /&gt;</span><br><span class="line">    &lt;/Settings&gt;</span><br><span class="line">    &lt;Encoders&gt;</span><br><span class="line">        &lt;!-- Audio Hardware  --&gt;</span><br><span class="line">        &lt;!-- Audio Software  --&gt;</span><br><span class="line">        &lt;!-- Video Hardware  --&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.avc"</span> type=<span class="string">"video/avc"</span> &gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-input-ports"</span> /&gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-output-ports"</span> /&gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-loaded-to-idle-after-allocation"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"size"</span> min=<span class="string">"96x64"</span> max=<span class="string">"4096x2160"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"alignment"</span> value=<span class="string">"2x2"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"block-size"</span> value=<span class="string">"16x16"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"blocks-per-second"</span> min=<span class="string">"1"</span> max=<span class="string">"979200"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"bitrate"</span> range=<span class="string">"1-100000000"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"frame-rate"</span> range=<span class="string">"1-240"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"concurrent-instances"</span> max=<span class="string">"16"</span> /&gt;</span><br><span class="line">          ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.mpeg4"</span> type=<span class="string">"video/mp4v-es"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.h263"</span> type=<span class="string">"video/3gpp"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.vp8"</span> type=<span class="string">"video/x-vnd.on2.vp8"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.hevc"</span> type=<span class="string">"video/hevc"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">    &lt;/Encoders&gt;</span><br><span class="line">    &lt;Decoders&gt;</span><br><span class="line">       &lt;!-- Video Hardware  --&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.avc"</span> type=<span class="string">"video/avc"</span> &gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-input-ports"</span> /&gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-output-ports"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"size"</span> min=<span class="string">"64x64"</span> max=<span class="string">"4096x2160"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"alignment"</span> value=<span class="string">"2x2"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"block-size"</span> value=<span class="string">"16x16"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"blocks-per-second"</span> min=<span class="string">"1"</span> max=<span class="string">"1958400"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"bitrate"</span> range=<span class="string">"1-100000000"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"frame-rate"</span> range=<span class="string">"1-240"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-version"</span> value=<span class="string">"65537"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-low-latency"</span> value=<span class="string">"1"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-macroblock-processing-rate"</span> value=<span class="string">"972000"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-level"</span> value=<span class="string">"52"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-instances"</span> value=<span class="string">"16"</span> /&gt;</span><br><span class="line">            &lt;Feature name=<span class="string">"adaptive-playback"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"concurrent-instances"</span> max=<span class="string">"16"</span> /&gt;</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.avc.secure"</span> type=<span class="string">"video/avc"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.mpeg4"</span> type=<span class="string">"video/mp4v-es"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.mpeg2"</span> type=<span class="string">"video/mpeg2"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.mpeg2.secure"</span> type=<span class="string">"video/mpeg2"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.h263"</span> type=<span class="string">"video/3gpp"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vc1"</span> type=<span class="string">"video/x-ms-wmv"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vc1.secure"</span> type=<span class="string">"video/x-ms-wmv"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx"</span> type=<span class="string">"video/divx"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx311"</span> type=<span class="string">"video/divx311"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx4"</span> type=<span class="string">"video/divx4"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp8"</span> type=<span class="string">"video/x-vnd.on2.vp8"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp9"</span> type=<span class="string">"video/x-vnd.on2.vp9"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp9.secure"</span> type=<span class="string">"video/x-vnd.on2.vp9"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.hevc"</span> type=<span class="string">"video/hevc"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.hevc.secure"</span> type=<span class="string">"video/hevc"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;!-- Audio Software  --&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qti.audio.decoder.flac"</span> type=<span class="string">"audio/flac"</span> /&gt;</span><br><span class="line">    &lt;/Decoders&gt;</span><br><span class="line">    &lt;Include href=<span class="string">"media_codecs_google_video.xml"</span> /&gt;</span><br><span class="line">&lt;/MediaCodecs&gt;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">Android NuPlayeræ’­æ”¾æ¡†æ¶ </a><br><a href="https://blog.csdn.net/column/details/12812.html" target="_blank" rel="noopener">ä¸“æ ï¼šMultiMediaæ¡†æ¶æ€»ç»“(åŸºäº6.0æºç ) - CSDNåšå®¢</a><br><a href="windrunnerlihuan.com">Androidå¤šåª’ä½“å¼€å‘-å½’æ¡£ | April is your lie</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57415505" target="_blank" rel="noopener">Android-7.0-Nuplayeræ¦‚è¿° - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57409783" target="_blank" rel="noopener">Android-7.0-MediaPlayerçŠ¶æ€æœº - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/56961370" target="_blank" rel="noopener">Android-7.0-Nuplayer-å¯åŠ¨æµç¨‹ - CSDNåšå®¢</a><br><a href="https://zh.wikipedia.org/wiki/YUV" target="_blank" rel="noopener">YUV - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53386010" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-Nuplayerï¼ˆ1ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53397945" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-AHandler AMessage ALooper - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/category/2135451/1?" target="_blank" rel="noopener">Android 4.2.2 stagefrightæ¶æ„ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/26849549" target="_blank" rel="noopener">android4.2.2çš„stagefrightæ¶æ„ä¸‹åŸºäºSurfaceFlingerçš„è§†é¢‘è§£ç è¾“å‡ºç¼“å­˜åˆ›å»ºæœºåˆ¶ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/category/7610722" target="_blank" rel="noopener">husanlim çš„ä¸“æ  å‚è€ƒ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">android ACodec MediaCodec NuPlayer flow - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">android MediaCodec ACodec - CSDNåšå®¢</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/05/25/Audio%20System%EF%BC%883%EF%BC%89%EF%BC%9AAndroid%20audio%20system%5B%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%5D%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/05/25/Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system[éŸ³é¢‘ç³»ç»Ÿ]åˆ†æ/</id>
    <published>2018-05-24T16:00:00.000Z</published>
    <updated>2018-05-09T15:03:52.335Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/audio.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="https://blog.csdn.net/xuesen_lin/article/category/1390680" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - æ—å­¦æ£®çš„Androidä¸“æ ã€‘</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Yangwen123 - æ·±å…¥å‰–æAndroidéŸ³é¢‘ç³»ç»Ÿã€‘</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Zyuanyun - Android éŸ³é¢‘ç³»ç»Ÿï¼šä» AudioTrack åˆ° AudioFlingerã€‘</a><br>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆKernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>æºç ï¼ˆä¸»è¦æºç è·¯å¾„ï¼‰ï¼š</p><blockquote><p>User space audio code æºç ï¼š</p></blockquote><p>â€¢ <strong>/hardware/qcom/audio/hal/ â€“ (Audio é«˜é€šHAL æºç )</strong> </p><p>â€¢ <strong>/libhardware/modules/audio/ â€“ (Audio åŸç”ŸHAL æºç )</strong> </p><p>â€¢ <strong>/external/tinyalsa/ â€“  (tinymix, tinyplay, tinycap æºç )</strong></p><p>â€¢ <strong>/vendor/qcom/proprietary/mm-audio/ â€“ (QTI OMX  audio encoder and decoders æºç ï¼Œæœªå…¬å¼€)</strong></p><p>â€¢ <strong>/frameworks/av/media/audioserver/ â€“ (Audioserver æºç )</strong></p><p>â€¢ <strong>/hardware/libhardware_legacy/audio â€“ (Audio legacy æºç )</strong></p><p>â€¢ <strong>/frameworks/av/media/libstagefright/ â€“ (Google Stagefright å¤šåª’ä½“æ¡†æ¶æºç )</strong></p><p>â€¢ <strong>/frameworks/av/services/audioflinger/ â€“ (Audioflinger ç›¸å…³æºç )</strong></p><p>â€¢ <strong>/external/bluetooth/bluedroid/ â€“ (A2DP audio HAL ç›¸å…³æºç )</strong>/</p><p>â€¢ <strong>/hardware/libhardware/modules/usbaudio/ â€“ (USB HAL æºç )</strong>/</p><p>â€¢ <strong>/vendor/qcom/proprietary/wfd/mm/source/framework/src/ â€“ (Wi-Fi Display (WFD)ã€ WFDMMSourceAudioSource.cppï¼Œæœªå…¬å¼€)</strong></p><p>â€¢ <strong>/system/core/include/system/ â€“ (audio.h)</strong>/</p><h4 id="ä¸€-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger"><a href="#ä¸€-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger" class="headerlink" title="(ä¸€)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger"></a>(ä¸€)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger</h4><h5 id="1-0ã€æ€»ä½“æ¡†æ¶å›¾"><a href="#1-0ã€æ€»ä½“æ¡†æ¶å›¾" class="headerlink" title="1.0ã€æ€»ä½“æ¡†æ¶å›¾"></a>1.0ã€æ€»ä½“æ¡†æ¶å›¾</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/31-Audio-system-Android-Linux-arc.png" alt="Alt text"></p><p>ç³»ç»Ÿå¯åŠ¨æ—¶å°†æ‰§è¡Œ /system/etc/init/audioserver.rc ï¼Œè¿è¡Œ /system/bin/ ç›®å½•ä¸‹çš„ audioserver æœåŠ¡ã€‚audioserver.rc å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\audioserver\audioserver.rc]</span><br><span class="line">service audioserver /system/bin/audioserver</span><br><span class="line">    class main</span><br><span class="line">    user audioserver</span><br><span class="line">    # media gid needed for /dev/fm (radio ) and for  /data/misc/media (tee)</span><br><span class="line">    group audio radio camera drmpc inet media mediarm net_bt net_bt_admin net_bw_acct</span><br><span class="line">    ioprio rt 4</span><br><span class="line">    writepid /dev/cpuset/forground/tasks /dev/stune/foreground/tasks</span><br></pre></td></tr></table></figure><p>audioserver æ˜¯ç”±åŒç›®å½•ä¸‹main_audioserverç¼–è¯‘ç”Ÿæˆçš„ã€‚</p><h5 id="1-1ã€AudioFlinger"><a href="#1-1ã€AudioFlinger" class="headerlink" title="1.1ã€AudioFlinger"></a>1.1ã€AudioFlinger</h5><p>AudioFlingeræ˜¯æ•´ä¸ªéŸ³é¢‘ç³»ç»Ÿçš„æ ¸å¿ƒä¸éš¾ç‚¹ã€‚ä½œä¸ºAndroidç³»ç»Ÿä¸­çš„éŸ³é¢‘ä¸­æ¢ï¼Œå®ƒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼Œå¯åˆ°æ‰¿ä¸Š(ä¸ºä¸Šå±‚æä¾›è®¿é—®æ¥å£)å¯ä¸‹(é€šè¿‡HALæ¥ç®¡ç†éŸ³é¢‘è®¾å¤‡)çš„ä½œç”¨ã€‚åªæœ‰ç†è§£äº†AudioFlingerï¼Œæ‰èƒ½ä»¥æ­¤ä¸ºåŸºç¡€æ›´å¥½åœ°æ·±å…¥åˆ°å…¶å®ƒæ¨¡å—ï¼Œå¹¶ä¸”Audioserveræœ€å…ˆå¯åŠ¨çš„ä¹Ÿæ˜¯AudioFlingerï¼Œå› è€Œæˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨å‰é¢è¿›è¡Œåˆ†æã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\audioserver\main_audioserver.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (doLog &amp;&amp; (childPid = fork()) != <span class="number">0</span>) &#123;</span><br><span class="line">    ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// all other services</span></span><br><span class="line">        <span class="keyword">if</span> (doLog) &#123;</span><br><span class="line">            prctl(PR_SET_PDEATHSIG, SIGKILL);   <span class="comment">// if parent media.log dies before me, kill me also</span></span><br><span class="line">            setpgid(<span class="number">0</span>, <span class="number">0</span>);                      <span class="comment">// but if I die first, don't kill my parent</span></span><br><span class="line">        &#125;</span><br><span class="line">        sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">        sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">        ALOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">        AudioFlinger::instantiate();</span><br><span class="line">        AudioPolicyService::instantiate();</span><br><span class="line">        RadioService::instantiate();</span><br><span class="line">        SoundTriggerHwService::instantiate();</span><br><span class="line">        ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AudioFlingerç»§æ‰¿äº†æ¨¡æ¿ç±»BinderServiceï¼Œè¯¥ç±»ç”¨äºæ³¨å†Œnative serviceã€‚<br>BinderServiceæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œè¯¥ç±»çš„publishå‡½æ•°å°±æ˜¯å®Œæˆå‘ServiceManageræ³¨å†ŒæœåŠ¡ã€‚<br>AudioFlingeræ³¨å†Œåä¸ºâ€media.audio_flingerâ€çš„æœåŠ¡ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">getServiceName</span><span class="params">()</span> ANDROID_API </span>&#123; <span class="keyword">return</span> <span class="string">"media.audio_flinger"</span>; &#125;</span><br></pre></td></tr></table></figure></p><h5 id="1-1-1-AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ"><a href="#1-1-1-AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ" class="headerlink" title="1.1.1 AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ"></a>1.1.1 AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ</h5><p>AudioFlingerçš„æ„é€ å‡½æ•°ï¼Œå‘ç°å®ƒåªæ˜¯ç®€å•åœ°ä¸ºå†…éƒ¨ä¸€äº›å˜é‡åšäº†åˆå§‹åŒ–ï¼Œé™¤æ­¤ä¹‹å¤–å°±æ²¡æœ‰ä»»ä½•ä»£ç äº†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">AudioFlinger::AudioFlinger()</span><br><span class="line">    : BnAudioFlinger(),</span><br><span class="line">      mPrimaryHardwareDev(<span class="literal">NULL</span>),</span><br><span class="line">      mAudioHwDevs(<span class="literal">NULL</span>),</span><br><span class="line">      mHardwareStatus(AUDIO_HW_IDLE),</span><br><span class="line">      mMasterVolume(<span class="number">1.0f</span>),</span><br><span class="line">      mMasterMute(<span class="literal">false</span>),</span><br><span class="line">      <span class="comment">// mNextUniqueId(AUDIO_UNIQUE_ID_USE_MAX),</span></span><br><span class="line">      mMode(AUDIO_MODE_INVALID),</span><br><span class="line">      mBtNrecIsOff(<span class="literal">false</span>),</span><br><span class="line">      mIsLowRamDevice(<span class="literal">true</span>),</span><br><span class="line">      mIsDeviceTypeKnown(<span class="literal">false</span>),</span><br><span class="line">      mGlobalEffectEnableTime(<span class="number">0</span>),</span><br><span class="line">      mSystemReady(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// unsigned instead of audio_unique_id_use_t, because ++ operator is unavailable for enum</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> use = AUDIO_UNIQUE_ID_USE_UNSPECIFIED; use &lt; AUDIO_UNIQUE_ID_USE_MAX; use++) &#123;</span><br><span class="line">        <span class="comment">// zero ID has a special meaning, so unavailable</span></span><br><span class="line">        mNextUniqueIds[use] = AUDIO_UNIQUE_ID_USE_MAX;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BnAudioFlingeræ˜¯ç”±RefBaseå±‚å±‚ç»§æ‰¿è€Œæ¥çš„ï¼Œå¹¶ä¸”IServiceManager::addServiceçš„ç¬¬äºŒä¸ªå‚æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¼ºæŒ‡é’ˆå¼•ç”¨(constsp<ibinder>&amp;),å› è€ŒAudioFlingerå…·å¤‡äº†å¼ºæŒ‡é’ˆè¢«ç¬¬ä¸€æ¬¡å¼•ç”¨æ—¶è°ƒç”¨onFirstRefçš„ç¨‹åºé€»è¾‘ã€‚</ibinder></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line"><span class="keyword">void</span> AudioFlinger::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> move all this work into an Init() function */</span></span><br><span class="line">    <span class="keyword">char</span> val_str[PROPERTY_VALUE_MAX] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (property_get(<span class="string">"ro.audio.flinger_standbytime_ms"</span>, val_str, <span class="literal">NULL</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> int_val;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == <span class="built_in">sscanf</span>(val_str, <span class="string">"%u"</span>, &amp;int_val)) &#123;</span><br><span class="line">            mStandbyTimeInNsecs = milliseconds(int_val);</span><br><span class="line">            ALOGI(<span class="string">"Using %u mSec as standby time."</span>, int_val);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mStandbyTimeInNsecs = kDefaultStandbyTimeInNsecs;</span><br><span class="line">            ALOGI(<span class="string">"Using default %u mSec as standby time."</span>,</span><br><span class="line">                    (<span class="keyword">uint32_t</span>)(mStandbyTimeInNsecs / <span class="number">1000000</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPatchPanel = <span class="keyword">new</span> PatchPanel(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    mMode = AUDIO_MODE_NORMAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™æ—¶å¼€å§‹ï¼ŒAudioFlingerå°±æ˜¯ä¸€ä¸ªâ€œæœ‰æ„ä¹‰â€çš„å®ä½“äº†</p><h5 id="1-2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†"><a href="#1-2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†" class="headerlink" title="1.2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†"></a>1.2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†</h5><p>è™½ç„¶AudioFlingerå®ä½“å·²ç»æˆåŠŸåˆ›å»ºå¹¶åˆå§‹åŒ–ï¼Œä½†åˆ°ç›®å‰ä¸ºæ­¢å®ƒè¿˜æ˜¯ä¸€å—é™æ€çš„å†…å­˜ç©ºé—´ï¼Œæ²¡æœ‰æ¶‰åŠåˆ°å…·ä½“çš„å·¥ä½œã€‚</p><p>ä»èŒèƒ½åˆ†å¸ƒä¸Šæ¥è®²ï¼ŒAudioPolicyServiceæ˜¯ç­–ç•¥çš„åˆ¶å®šè€…ï¼Œæ¯”å¦‚ä»€ä¹ˆæ—¶å€™æ‰“å¼€éŸ³é¢‘æ¥å£è®¾å¤‡ã€æŸç§Streamç±»å‹çš„éŸ³é¢‘å¯¹åº”ä»€ä¹ˆè®¾å¤‡ç­‰ç­‰ã€‚è€ŒAudioFlingeråˆ™æ˜¯ç­–ç•¥çš„æ‰§è¡Œè€…ï¼Œä¾‹å¦‚å…·ä½“å¦‚ä½•ä¸éŸ³é¢‘è®¾å¤‡é€šä¿¡ï¼Œå¦‚ä½•ç»´æŠ¤ç°æœ‰ç³»ç»Ÿä¸­çš„éŸ³é¢‘è®¾å¤‡ï¼Œä»¥åŠå¤šä¸ªéŸ³é¢‘æµçš„æ··éŸ³å¦‚ä½•å¤„ç†ç­‰ç­‰éƒ½å¾—ç”±å®ƒæ¥å®Œæˆã€‚</p><p>ç›®å‰Audioç³»ç»Ÿä¸­æ”¯æŒçš„éŸ³é¢‘è®¾å¤‡æ¥å£(Audio Interface)åˆ†ä¸ºä¸‰å¤§ç±»ï¼Œå³ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">static const char * const audio_interfaces[] = &#123;</span><br><span class="line">    AUDIO_HARDWARE_MODULE_ID_PRIMARY,</span><br><span class="line">    AUDIO_HARDWARE_MODULE_ID_A2DP,</span><br><span class="line">    AUDIO_HARDWARE_MODULE_ID_USB,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¯ç§éŸ³é¢‘è®¾å¤‡æ¥å£ç”±ä¸€ä¸ªå¯¹åº”çš„soåº“æä¾›æ”¯æŒã€‚é‚£ä¹ˆAudioFlingeræ€ä¹ˆä¼šçŸ¥é“å½“å‰è®¾å¤‡ä¸­æ”¯æŒä¸Šè¿°çš„å“ªäº›æ¥å£ï¼Œæ¯ç§æ¥å£åˆæ”¯æŒå“ªäº›å…·ä½“çš„éŸ³é¢‘è®¾å¤‡å‘¢ï¼Ÿè¿™æ˜¯AudioPolicyServiceçš„è´£ä»»ä¹‹ä¸€ï¼Œå³æ ¹æ®ç”¨æˆ·é…ç½®æ¥æŒ‡å¯¼AudioFlingeråŠ è½½è®¾å¤‡æ¥å£ã€‚</p><p>å½“AudioPolicyManagerBase(AudioPolicyServiceä¸­æŒæœ‰çš„Policyç®¡ç†è€…ï¼Œåé¢å°èŠ‚æœ‰è¯¦ç»†ä»‹ç»)æ„é€ æ—¶ï¼Œå®ƒä¼šè¯»å–å‚å•†å…³äºéŸ³é¢‘è®¾å¤‡çš„æè¿°æ–‡ä»¶(audio_policy.conf)ï¼Œç„¶åæ®æ­¤æ¥æ‰“å¼€ä»¥ä¸Šä¸‰ç±»éŸ³é¢‘æ¥å£(å¦‚æœå­˜åœ¨çš„è¯)ã€‚è¿™ä¸€è¿‡ç¨‹æœ€ç»ˆä¼šè°ƒç”¨loadHwModule@AudioFlingerï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><h5 id="1-2-1ã€åŠ è½½è®¾å¤‡loadHwModule"><a href="#1-2-1ã€åŠ è½½è®¾å¤‡loadHwModule" class="headerlink" title="1.2.1ã€åŠ è½½è®¾å¤‡loadHwModule()"></a>1.2.1ã€åŠ è½½è®¾å¤‡loadHwModule()</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">/*nameå°±æ˜¯å‰é¢audio_interfaces æ•°ç»„æˆå‘˜ä¸­çš„å­—ç¬¦ä¸²*/</span><br><span class="line">audio_module_handle_t AudioFlinger::loadHwModule(const char *name)</span><br><span class="line">&#123;</span><br><span class="line">    if (name == NULL) &#123;</span><br><span class="line">        return AUDIO_MODULE_HANDLE_NONE;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!settingsAllowed()) &#123;</span><br><span class="line">        return AUDIO_MODULE_HANDLE_NONE;</span><br><span class="line">    &#125;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    return loadHwModule_l(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ²¡æœ‰åšå®è´¨æ€§çš„å·¥ä½œï¼Œåªæ˜¯æ‰§è¡Œäº†åŠ é”åŠ¨ä½œï¼Œç„¶åæ¥ç€è°ƒç”¨ä¸‹é¢çš„å‡½æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">// loadHwModule_l() must be called with AudioFlinger::mLock held</span><br><span class="line">audio_module_handle_t AudioFlinger::loadHwModule_l(const char *name)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    /* Step 1. æ˜¯å¦å·²ç»æ·»åŠ äº†è¿™ä¸ªinterface ? */</span><br><span class="line">    for (size_t i = 0; i &lt; mAudioHwDevs.size(); i++) &#123;</span><br><span class="line">        if (strncmp(mAudioHwDevs.valueAt(i)-&gt;moduleName(), name, strlen(name)) == 0) &#123;</span><br><span class="line">            ALOGW(&quot;loadHwModule() module %s already loaded&quot;, name);</span><br><span class="line">            return mAudioHwDevs.keyAt(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    audio_hw_device_t *dev;</span><br><span class="line">    /* Step 2. åŠ è½½audio interface */</span><br><span class="line">    int rc = load_audio_interface(name, &amp;dev);</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    /* Step 3. åˆå§‹åŒ– */</span><br><span class="line">    mHardwareStatus = AUDIO_HW_INIT;</span><br><span class="line">    rc = dev-&gt;init_check(dev);</span><br><span class="line">    mHardwareStatus = AUDIO_HW_IDLE;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    /* Step 4. æ·»åŠ åˆ°å…¨å±€å˜é‡ä¸­ */</span><br><span class="line">    audio_module_handle_t handle = (audio_module_handle_t) nextUniqueId(AUDIO_UNIQUE_ID_USE_MODULE);</span><br><span class="line">    mAudioHwDevs.add(handle, new AudioHwDevice(handle, name, dev, flags));</span><br><span class="line"></span><br><span class="line">    return handle;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Step1@ loadHwModule_l. é¦–å…ˆæŸ¥æ‰¾mAudioHwDevsæ˜¯å¦å·²ç»æ·»åŠ äº†å˜é‡nameæ‰€æŒ‡ç¤ºçš„audio interfaceï¼Œå¦‚æœæ˜¯çš„è¯ç›´æ¥è¿”å›ã€‚ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶mAudioHwDevsçš„sizeä¸º0ï¼Œæ‰€ä»¥è¿˜ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p><p>Step2@ loadHwModule_l. åŠ è½½æŒ‡å®šçš„audiointerfaceï¼Œæ¯”å¦‚â€œprimaryâ€ã€â€œa2dpâ€æˆ–è€…â€œusbâ€ã€‚å‡½æ•°load_audio_interfaceç”¨æ¥åŠ è½½è®¾å¤‡æ‰€éœ€çš„åº“æ–‡ä»¶ï¼Œç„¶åæ‰“å¼€è®¾å¤‡å¹¶åˆ›å»ºä¸€ä¸ªaudio_hw_device_tå®ä¾‹ã€‚éŸ³é¢‘æ¥å£è®¾å¤‡æ‰€å¯¹åº”çš„åº“æ–‡ä»¶åç§°æ˜¯æœ‰ä¸€å®šæ ¼å¼çš„ï¼Œæ¯”å¦‚a2dpçš„æ¨¡å—åå¯èƒ½æ˜¯audio.a2dp.soæˆ–è€…audio.a2dp.default.soç­‰ç­‰ã€‚æŸ¥æ‰¾è·¯å¾„ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œå³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware\hardware.c]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH1 <span class="meta-string">"/system/lib64/hw"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH2 <span class="meta-string">"/vendor/lib64/hw"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH3 <span class="meta-string">"/odm/lib64/hw"</span></span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå› ä¸ºAndroidæ˜¯å®Œå…¨å¼€æºçš„ï¼Œå„å¼€å‘å•†å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¥è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ï¼Œæ¯”å¦‚ä¸‹é¢æ˜¯Google pixel è®¾å¤‡çš„éŸ³é¢‘åº“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">adb shell &amp;&amp; cd system/lib64/hw &amp;&amp; ls -l</span><br><span class="line">-rw-r--r-- 1 root root   30440 2009-01-01 00:00 audio.a2dp.default.so</span><br><span class="line">-rw-r--r-- 1 root root   18156 2009-01-01 00:00 audio.primary.default.so</span><br><span class="line">-rw-r--r-- 1 root root  275612 2009-01-01 00:00 audio.primary.msm8996.so</span><br><span class="line">-rw-r--r-- 1 root root   34540 2009-01-01 00:00 audio.r_submix.default.so</span><br><span class="line">-rw-r--r-- 1 root root   22248 2009-01-01 00:00 audio.usb.default.so</span><br><span class="line">-rw-r--r-- 1 root root   96096 2009-01-01 00:00 audio_policy.default.so</span><br><span class="line">-rw-r--r-- 1 root root 1637208 2009-01-01 00:00 bluetooth.default.so</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>Step3@ loadHwModule_lï¼Œè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚å…¶ä¸­init_checkæ˜¯ä¸ºäº†ç¡®å®šè¿™ä¸ªaudio interfaceæ˜¯å¦å·²ç»æˆåŠŸåˆå§‹åŒ–ï¼Œ0æ˜¯æˆåŠŸï¼Œå…¶å®ƒå€¼è¡¨ç¤ºå¤±è´¥ã€‚æ¥ä¸‹æ¥å¦‚æœè¿™ä¸ªdeviceæ”¯æŒä¸»éŸ³é‡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡set_master_volumeè¿›è¡Œè®¾ç½®ã€‚åœ¨æ¯æ¬¡æ“ä½œdeviceå‰ï¼Œéƒ½è¦å…ˆæ”¹å˜mHardwareStatusçš„çŠ¶æ€å€¼ï¼Œæ“ä½œç»“æŸåå°†å…¶å¤åŸä¸ºAUDIO_HW_IDLE(æ ¹æ®æºç ä¸­çš„æ³¨é‡Šï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿dumpæ—¶æ­£ç¡®è¾“å‡ºå†…éƒ¨çŠ¶æ€ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å»æ·±ç©¶äº†)ã€‚</p><p>Step4@ loadHwModule_l. æŠŠåŠ è½½åçš„è®¾å¤‡æ·»åŠ å…¥mAudioHwDevsé”®å€¼å¯¹ä¸­ï¼Œå…¶ä¸­keyçš„å€¼æ˜¯ç”±nextUniqueIdç”Ÿæˆçš„ï¼Œè¿™æ ·åšä¿è¯äº†è¿™ä¸ªaudiointerfaceæ‹¥æœ‰å…¨å±€å”¯ä¸€çš„idå·ã€‚</p><p>å®Œæˆäº†audiointerfaceçš„æ¨¡å—åŠ è½½åªæ˜¯ä¸‡é‡Œé•¿å¾çš„ç¬¬ä¸€æ­¥ã€‚å› ä¸ºæ¯ä¸€ä¸ªinterfaceåŒ…å«çš„è®¾å¤‡é€šå¸¸ä¸æ­¢ä¸€ä¸ªï¼ŒAndroidç³»ç»Ÿç›®å‰æ”¯æŒçš„éŸ³é¢‘è®¾å¤‡å¦‚ä¸‹åˆ—è¡¨æ‰€ç¤ºï¼š<br> Androidç³»ç»Ÿæ”¯æŒçš„éŸ³é¢‘è®¾å¤‡åˆ—è¡¨(è¾“å‡º)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware_legacy\audio\audio_hw_hal.cpp]</span><br><span class="line">static uint32_t audio_device_conv_table[][HAL_API_REV_NUM] =</span><br><span class="line">&#123;</span><br><span class="line">    /* output devices */</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_EARPIECE, AUDIO_DEVICE_OUT_EARPIECE &#125;,//</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_SPEAKER, AUDIO_DEVICE_OUT_SPEAKER &#125;,//SPEAKER</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_WIRED_HEADSET, AUDIO_DEVICE_OUT_WIRED_HEADSET &#125;,//HEADSET</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_WIRED_HEADPHONE, AUDIO_DEVICE_OUT_WIRED_HEADPHONE &#125;,//HEADPHONE</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_SCO, AUDIO_DEVICE_OUT_BLUETOOTH_SCO &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_SCO_HEADSET, AUDIO_DEVICE_OUT_BLUETOOTH_SCO_HEADSET &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_SCO_CARKIT, AUDIO_DEVICE_OUT_BLUETOOTH_SCO_CARKIT &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_A2DP, AUDIO_DEVICE_OUT_BLUETOOTH_A2DP &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES, AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_A2DP_SPEAKER, AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_SPEAKER &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_AUX_DIGITAL, AUDIO_DEVICE_OUT_AUX_DIGITAL &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_ANLG_DOCK_HEADSET, AUDIO_DEVICE_OUT_ANLG_DOCK_HEADSET &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_DGTL_DOCK_HEADSET, AUDIO_DEVICE_OUT_DGTL_DOCK_HEADSET &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_DEFAULT, AUDIO_DEVICE_OUT_DEFAULT &#125;,//é»˜è®¤è®¾å¤‡</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼š</p><p>Ã˜ è¿™ä¹ˆå¤šçš„è¾“å‡ºè®¾å¤‡ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å›æ”¾éŸ³é¢‘æµ(å½•éŸ³ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µ)æ—¶ï¼Œè¯¥é€‰æ‹©å“ªä¸€ç§å‘¢ï¼Ÿ</p><p>Ã˜ è€Œä¸”å½“å‰ç³»ç»Ÿä¸­audio interfaceä¹Ÿå¾ˆå¯èƒ½ä¸æ­¢ä¸€ä¸ªï¼Œåº”è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ</p><p>æ˜¾ç„¶è¿™äº›å†³ç­–å·¥ä½œå°†ç”±AudioPolicyServiceæ¥å®Œæˆï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€å°èŠ‚åšè¯¦ç»†é˜è¿°ã€‚è¿™é‡Œå…ˆç»™å¤§å®¶åˆ†æä¸‹ï¼ŒAudioFlingeræ˜¯å¦‚ä½•æ‰“å¼€ä¸€ä¸ªOutputé€šé“çš„(ä¸€ä¸ªaudiointerfaceå¯èƒ½åŒ…å«è‹¥å¹²ä¸ªoutput)ã€‚</p><h5 id="1-2-2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput"><a href="#1-2-2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput" class="headerlink" title="1.2.2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput()"></a>1.2.2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput()</h5><p>æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“(output)åœ¨AudioFlingerä¸­å¯¹åº”çš„æ¥å£æ˜¯openOutput()ï¼Œå³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line"><span class="keyword">status_t</span> AudioFlinger::openOutput(<span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span><br><span class="line">                                  <span class="keyword">audio_io_handle_t</span> *output,</span><br><span class="line">                                  <span class="keyword">audio_config_t</span> *config,</span><br><span class="line">                                  <span class="keyword">audio_devices_t</span> *devices,</span><br><span class="line">                                  <span class="keyword">const</span> String8&amp; address,</span><br><span class="line">                                  <span class="keyword">uint32_t</span> *latencyMs,</span><br><span class="line">                                  <span class="keyword">audio_output_flags_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">    sp&lt;PlaybackThread&gt; thread = openOutput_l(<span class="keyword">module</span>, output, config, *devices, address, flags);</span><br><span class="line">    <span class="keyword">if</span> (thread != <span class="number">0</span>) &#123;</span><br><span class="line">        *latencyMs = thread-&gt;latency();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// notify client processes of the new output creation</span></span><br><span class="line">        thread-&gt;ioConfigChanged(AUDIO_OUTPUT_OPENED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// the first primary output opened designates the primary hw device</span></span><br><span class="line">        <span class="keyword">if</span> ((mPrimaryHardwareDev == <span class="literal">NULL</span>) &amp;&amp; (flags &amp; AUDIO_OUTPUT_FLAG_PRIMARY)) &#123;</span><br><span class="line">            ALOGI(<span class="string">"Using module %d has the primary audio interface"</span>, <span class="keyword">module</span>);</span><br><span class="line">            mPrimaryHardwareDev = thread-&gt;getOutput()-&gt;audioHwDev;</span><br><span class="line"></span><br><span class="line">            <span class="function">AutoMutex <span class="title">lock</span><span class="params">(mHardwareLock)</span></span>;</span><br><span class="line">            mHardwareStatus = AUDIO_HW_SET_MODE;</span><br><span class="line">            mPrimaryHardwareDev-&gt;hwDevice()-&gt;set_mode(mPrimaryHardwareDev-&gt;hwDevice(), mMode);</span><br><span class="line">            mHardwareStatus = AUDIO_HW_IDLE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_INIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è°ƒç”¨ openOutput_l()å‡½æ•°ä»å¤„ç†ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">sp&lt;AudioFlinger::PlaybackThread&gt; AudioFlinger::openOutput_l(<span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span><br><span class="line">                                                            <span class="keyword">audio_io_handle_t</span> *output,</span><br><span class="line">                                                            <span class="keyword">audio_config_t</span> *config,</span><br><span class="line">                                                            <span class="keyword">audio_devices_t</span> devices,</span><br><span class="line">                                                            <span class="keyword">const</span> String8&amp; address,</span><br><span class="line">                                                            <span class="keyword">audio_output_flags_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*Step 1. æŸ¥æ‰¾ç›¸åº”çš„audio interface</span></span><br><span class="line"><span class="comment">    AudioHwDevice *outHwDev = findSuitableHwDev_l(module, devices);</span></span><br><span class="line"><span class="comment">    ......</span></span><br><span class="line"><span class="comment">    mHardwareStatus = AUDIO_HW_OUTPUT_OPEN;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     ......</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    AudioStreamOut *outputStream = NULL;</span></span><br><span class="line"><span class="comment">     /*Step 2. ä¸ºè®¾å¤‡æ‰“å¼€ä¸€ä¸ªè¾“å‡ºæµ*/</span></span><br><span class="line">    <span class="keyword">status_t</span> status = outHwDev-&gt;openOutputStream(</span><br><span class="line">            &amp;outputStream,</span><br><span class="line">            *output,</span><br><span class="line">            devices,</span><br><span class="line">            flags,</span><br><span class="line">            config,</span><br><span class="line">            address.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    mHardwareStatus = AUDIO_HW_IDLE;</span><br><span class="line">    <span class="comment">/*Step 3.åˆ›å»ºPlaybackThread*/</span></span><br><span class="line">    <span class="keyword">if</span> (status == NO_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">        PlaybackThread *thread;</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD) &#123;</span><br><span class="line">            thread = <span class="keyword">new</span> OffloadThread(<span class="keyword">this</span>, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(<span class="string">"openOutput_l() created offload output: ID %d thread %p"</span>, *output, thread);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flags &amp; AUDIO_OUTPUT_FLAG_DIRECT)</span><br><span class="line">                || !isValidPcmSinkFormat(config-&gt;format)</span><br><span class="line">                || !isValidPcmSinkChannelMask(config-&gt;channel_mask)) &#123;</span><br><span class="line">            thread = <span class="keyword">new</span> DirectOutputThread(<span class="keyword">this</span>, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(<span class="string">"openOutput_l() created direct output: ID %d thread %p"</span>, *output, thread);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            thread = <span class="keyword">new</span> MixerThread(<span class="keyword">this</span>, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(<span class="string">"openOutput_l() created mixer output: ID %d thread %p"</span>, *output, thread);</span><br><span class="line">        &#125;</span><br><span class="line">        mPlaybackThreads.add(*output, thread);</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œé¢œè‰²åŠ æ·±çš„éƒ¨åˆ†æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥åˆ†æçš„é‡ç‚¹ï¼Œä¸»è¦è¿˜æ˜¯å›´ç»•outHwDevè¿™ä¸ªå˜é‡æ‰€åšçš„ä¸€ç³»åˆ—æ“ä½œï¼Œå³ï¼š</p><p>Â·        æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡( findSuitableHwDev_l() )</p><p>Â·        åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµ( é€šè¿‡openOutputStream()åˆ›å»ºAudioStreamOut )</p><p>Â·        åˆ›å»ºæ’­æ”¾çº¿ç¨‹( PlaybackThread )</p><p>outHwDevç”¨äºè®°å½•ä¸€ä¸ªæ‰“å¼€çš„éŸ³é¢‘æ¥å£è®¾å¤‡ï¼Œå®ƒçš„æ•°æ®ç±»å‹æ˜¯audio_hw_device_tï¼Œæ˜¯ç”±HALè§„å®šçš„ä¸€ä¸ªéŸ³é¢‘æ¥å£è®¾å¤‡æ‰€åº”å…·æœ‰çš„å±æ€§é›†åˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioHwDevice.h]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AudioHwDevice</span> &#123;</span></span><br><span class="line">......</span><br><span class="line">    <span class="keyword">audio_module_handle_t</span> handle() <span class="keyword">const</span> &#123; <span class="keyword">return</span> mHandle; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">moduleName</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> mModuleName; &#125;</span><br><span class="line">    <span class="keyword">audio_hw_device_t</span> *hwDevice() <span class="keyword">const</span> &#123; <span class="keyword">return</span> mHwDevice; &#125;</span><br><span class="line">    <span class="keyword">uint32_t</span> version() <span class="keyword">const</span> &#123; <span class="keyword">return</span> mHwDevice-&gt;common.version; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">status_t</span> openOutputStream(</span><br><span class="line">            AudioStreamOut **ppStreamOut,</span><br><span class="line">            <span class="keyword">audio_io_handle_t</span> handle,</span><br><span class="line">            <span class="keyword">audio_devices_t</span> devices,</span><br><span class="line">            <span class="keyword">audio_output_flags_t</span> flags,</span><br><span class="line">            struct audio_config *config,</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *address);</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">audio_module_handle_t</span> mHandle;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span>          mModuleName;</span><br><span class="line">    <span class="keyword">audio_hw_device_t</span> * <span class="keyword">const</span>   mHwDevice;</span><br><span class="line">    <span class="keyword">const</span> Flags                 mFlags;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­commonä»£è¡¨äº†HALå±‚æ‰€æœ‰è®¾å¤‡çš„å…±æœ‰å±æ€§;set_master_volumeã€set_modeã€open_output_streamåˆ†åˆ«ä¸ºæˆ‘ä»¬è®¾ç½®audio interfaceçš„ä¸»éŸ³é‡ã€è®¾ç½®éŸ³é¢‘æ¨¡å¼ç±»å‹(æ¯”å¦‚AUDIO_MODE_RINGTONEã€AUDIO_MODE_IN_CALLç­‰ç­‰)ã€æ‰“å¼€è¾“å‡ºæ•°æ®æµæä¾›äº†æ¥å£ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æ­¥æ¥é˜è¿°ã€‚</p><h5 id="1-2-2-1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev-l"><a href="#1-2-2-1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev-l" class="headerlink" title="1.2.2.1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev_l()"></a>1.2.2.1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev_l()</h5><p>Step1@ AudioFlinger::openOutput. åœ¨openOutputä¸­ï¼Œè®¾å¤‡outHwDevæ˜¯é€šè¿‡æŸ¥æ‰¾å½“å‰ç³»ç»Ÿæ¥å¾—åˆ°çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">AudioHwDevice* AudioFlinger::findSuitableHwDev_l(</span><br><span class="line">        <span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span><br><span class="line">        <span class="keyword">audio_devices_t</span> devices)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// if module is 0, the request comes from an old policy manager and we should load</span></span><br><span class="line">    <span class="comment">// well known modules</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"findSuitableHwDev_l() loading well know audio hw modules"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; ARRAY_SIZE(audio_interfaces); i++) &#123;</span><br><span class="line">            loadHwModule_l(audio_interfaces[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// then try to find a module supporting the requested device.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mAudioHwDevs.size(); i++) &#123;</span><br><span class="line">            AudioHwDevice *audioHwDevice = mAudioHwDevs.valueAt(i);</span><br><span class="line">            <span class="keyword">audio_hw_device_t</span> *dev = audioHwDevice-&gt;hwDevice();</span><br><span class="line">            <span class="keyword">if</span> ((dev-&gt;get_supported_devices != <span class="literal">NULL</span>) &amp;&amp;</span><br><span class="line">                    (dev-&gt;get_supported_devices(dev) &amp; devices) == devices)</span><br><span class="line">                <span class="keyword">return</span> audioHwDevice;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// check a match for the requested module handle</span></span><br><span class="line">        AudioHwDevice *audioHwDevice = mAudioHwDevs.valueFor(<span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">if</span> (audioHwDevice != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> audioHwDevice;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å˜é‡moduleå€¼ä¸º0çš„æƒ…å†µï¼Œæ˜¯ä¸ºäº†å…¼å®¹ä¹‹å‰çš„Audio Policyè€Œç‰¹åˆ«åšçš„å¤„ç†ã€‚å½“moduleç­‰äº0æ—¶ï¼Œé¦–å…ˆåŠ è½½æ‰€æœ‰å·²çŸ¥çš„éŸ³é¢‘æ¥å£è®¾å¤‡ï¼Œç„¶åå†æ ¹æ®devicesæ¥ç¡®å®šå…¶ä¸­ç¬¦åˆè¦æ±‚çš„ã€‚å…¥å‚devicesçš„å€¼å®é™…ä¸Šæ¥æºäºâ€œ Androidç³»ç»Ÿæ”¯æŒçš„éŸ³é¢‘è®¾å¤‡åˆ—è¡¨(è¾“å‡º)â€æ‰€ç¤ºçš„è®¾å¤‡ã€‚å¯ä»¥çœ‹åˆ°ï¼Œenumä¸­æ¯ä¸ªè®¾å¤‡ç±»å‹éƒ½å¯¹åº”ä¸€ä¸ªç‰¹å®šçš„æ¯”ç‰¹ä½ï¼Œå› è€Œä¸Šè¿°ä»£ç æ®µä¸­å¯ä»¥é€šè¿‡â€œä¸è¿ç®—â€æ¥æ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡ã€‚</p><p>å½“modulesä¸ºé0å€¼æ—¶ï¼Œè¯´æ˜Audio PolicyæŒ‡å®šäº†å…·ä½“çš„è®¾å¤‡idå·ï¼Œè¿™æ—¶å°±é€šè¿‡æŸ¥æ‰¾å…¨å±€çš„mAudioHwDevså˜é‡æ¥ç¡®è®¤æ˜¯å¦å­˜åœ¨ç¬¦åˆè¦æ±‚çš„è®¾å¤‡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.h]</span><br><span class="line">DefaultKeyedVector&lt;audio_module_handle_t, AudioHwDevice*&gt;  mAudioHwDevs;</span><br></pre></td></tr></table></figure><p>å˜é‡mAudioHwDevsæ˜¯ä¸€ä¸ªVectorï¼Œä»¥audio_module_handle_tä¸ºkeyï¼Œæ¯ä¸€ä¸ªhandleå€¼å”¯ä¸€ç¡®å®šäº†å·²ç»æ·»åŠ çš„éŸ³é¢‘è®¾å¤‡ã€‚é‚£ä¹ˆåœ¨ä»€ä¹ˆæ—¶å€™æ·»åŠ è®¾å¤‡å‘¢ï¼Ÿ</p><p>ä¸€ç§æƒ…å†µå°±æ˜¯å‰é¢çœ‹åˆ°çš„modulesä¸º0æ—¶ï¼Œä¼šloadæ‰€æœ‰æ½œåœ¨è®¾å¤‡ï¼Œå¦ä¸€ç§æƒ…å†µå°±æ˜¯AudioPolicyManagerBaseåœ¨æ„é€ æ—¶ä¼šé¢„åŠ è½½æ‰€æœ‰audio_policy.confä¸­æ‰€æè¿°çš„outputã€‚ä¸ç®¡æ˜¯å“ªä¸€ç§æƒ…å†µï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨loadHwModuleÃ loadHwModule_lï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬å¼€å¤´å°±åˆ†æè¿‡äº†ã€‚</p><p>å¦‚æœmodulesä¸ºé0ï¼Œä¸”ä»mAudioHwDevsä¸­ä¹Ÿæ‰¾ä¸åˆ°ç¬¦åˆè¦æ±‚çš„è®¾å¤‡ï¼Œç¨‹åºå¹¶ä¸ä¼šå°±æ­¤ç»ˆç»“â€”â€”å®ƒä¼šé€€è€Œæ±‚å…¶æ¬¡ï¼Œéå†æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ å¯»æ‰¾æ”¯æŒdevicesçš„ä»»ä½•ä¸€ä¸ªaudio interfaceã€‚</p><h5 id="1-2-2-2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream"><a href="#1-2-2-2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream" class="headerlink" title="1.2.2.2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream()"></a>1.2.2.2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream()</h5><p>Step2@ AudioFlinger::openOutputï¼Œè°ƒç”¨openOutputStream()å‡½æ•°æ‰“å¼€ä¸€ä¸ªAudioStreamOut ã€‚æºç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioHwDevice.cpp]</span><br><span class="line">status_t AudioHwDevice::openOutputStream(</span><br><span class="line">        AudioStreamOut **ppStreamOut,</span><br><span class="line">        audio_io_handle_t handle,</span><br><span class="line">        audio_devices_t devices,</span><br><span class="line">        audio_output_flags_t flags,</span><br><span class="line">        struct audio_config *config,</span><br><span class="line">        const char *address)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    struct audio_config originalConfig = *config;</span><br><span class="line">    AudioStreamOut *outputStream = new AudioStreamOut(this, flags);</span><br><span class="line">    </span><br><span class="line">    status_t status = outputStream-&gt;open(handle, devices, config, address);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    *ppStreamOut = outputStream;</span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”ŸæˆAudioStreamOutå¯¹è±¡å¹¶èµ‹å€¼ç»™ppStreamOut ï¼Œè¿›ä¸€æ­¥è°ƒç”¨äº†AudioStreamOut-&gt;open()å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioStreamOut.cpp]</span><br><span class="line">status_t AudioStreamOut::open(</span><br><span class="line">        audio_io_handle_t handle,</span><br><span class="line">        audio_devices_t devices,</span><br><span class="line">        struct audio_config *config,</span><br><span class="line">        const char *address)</span><br><span class="line">&#123;</span><br><span class="line">    audio_stream_out_t *outStream;</span><br><span class="line">    .......</span><br><span class="line">    int status = hwDev()-&gt;open_output_stream(</span><br><span class="line">            hwDev(),</span><br><span class="line">            handle,</span><br><span class="line">            devices,</span><br><span class="line">            customFlags,</span><br><span class="line">            config,</span><br><span class="line">            &amp;outStream,</span><br><span class="line">            address);</span><br><span class="line">    ......</span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å³ä¼šé€šè¿‡audio_hw_device_t-&gt;-&gt;open_output_stream()åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµ</p><h5 id="1-2-2-2-1ã€audio-hw-device-t-gt-gt-open-output-stream"><a href="#1-2-2-2-1ã€audio-hw-device-t-gt-gt-open-output-stream" class="headerlink" title="1.2.2.2.1ã€audio_hw_device_t-&gt;-&gt;open_output_stream()"></a>1.2.2.2.1ã€audio_hw_device_t-&gt;-&gt;open_output_stream()</h5><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹HALå±‚ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\audio\hal\audio_hw.c]</span><br><span class="line">static int adev_open(const hw_module_t *module, const char *name,</span><br><span class="line">                     hw_device_t **device)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    adev = calloc(1, sizeof(struct audio_device));</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;adev-&gt;lock, (const pthread_mutexattr_t *) NULL);</span><br><span class="line"></span><br><span class="line">    adev-&gt;device.common.tag = HARDWARE_DEVICE_TAG;</span><br><span class="line">    adev-&gt;device.common.version = AUDIO_DEVICE_API_VERSION_2_0;</span><br><span class="line">    adev-&gt;device.common.module = (struct hw_module_t *)module;</span><br><span class="line">    adev-&gt;device.common.close = adev_close;</span><br><span class="line"></span><br><span class="line">    adev-&gt;device.init_check = adev_init_check;</span><br><span class="line">    adev-&gt;device.set_voice_volume = adev_set_voice_volume;</span><br><span class="line">    adev-&gt;device.set_master_volume = adev_set_master_volume;</span><br><span class="line">    adev-&gt;device.get_master_volume = adev_get_master_volume;</span><br><span class="line">    adev-&gt;device.set_master_mute = adev_set_master_mute;</span><br><span class="line">    adev-&gt;device.get_master_mute = adev_get_master_mute;</span><br><span class="line">    adev-&gt;device.set_mode = adev_set_mode;</span><br><span class="line">    adev-&gt;device.set_mic_mute = adev_set_mic_mute;</span><br><span class="line">    adev-&gt;device.get_mic_mute = adev_get_mic_mute;</span><br><span class="line">    adev-&gt;device.set_parameters = adev_set_parameters;</span><br><span class="line">    adev-&gt;device.get_parameters = adev_get_parameters;</span><br><span class="line">    adev-&gt;device.get_input_buffer_size = adev_get_input_buffer_size;</span><br><span class="line">    adev-&gt;device.open_output_stream = adev_open_output_stream;</span><br><span class="line">    adev-&gt;device.close_output_stream = adev_close_output_stream;</span><br><span class="line">    adev-&gt;device.open_input_stream = adev_open_input_stream;</span><br><span class="line">    adev-&gt;device.close_input_stream = adev_close_input_stream;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“è°ƒç”¨open_output_stream å°±ä¼šè°ƒç”¨adev_open_output_streamã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\audio\hal\audio_hw.c]</span><br><span class="line">static int adev_open_output_stream(struct audio_hw_device *dev,</span><br><span class="line">                                   audio_io_handle_t handle,</span><br><span class="line">                                   audio_devices_t devices,</span><br><span class="line">                                   audio_output_flags_t flags,</span><br><span class="line">                                   struct audio_config *config,</span><br><span class="line">                                   struct audio_stream_out **stream_out,</span><br><span class="line">                                   const char *address __unused)</span><br><span class="line">&#123;</span><br><span class="line">    struct audio_device *adev = (struct audio_device *)dev;</span><br><span class="line">    struct stream_out *out;</span><br><span class="line">    int i, ret;</span><br><span class="line">    </span><br><span class="line">    *stream_out = NULL;</span><br><span class="line">    out = (struct stream_out *)calloc(1, sizeof(struct stream_out));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    out-&gt;stream.common.get_sample_rate = out_get_sample_rate;</span><br><span class="line">    out-&gt;stream.common.set_sample_rate = out_set_sample_rate;</span><br><span class="line">    out-&gt;stream.common.get_buffer_size = out_get_buffer_size;</span><br><span class="line">    out-&gt;stream.common.get_channels = out_get_channels;</span><br><span class="line">    out-&gt;stream.common.get_format = out_get_format;</span><br><span class="line">    out-&gt;stream.common.set_format = out_set_format;</span><br><span class="line">    out-&gt;stream.common.standby = out_standby;</span><br><span class="line">    out-&gt;stream.common.dump = out_dump;</span><br><span class="line">    out-&gt;stream.common.set_parameters = out_set_parameters;</span><br><span class="line">    out-&gt;stream.common.get_parameters = out_get_parameters;</span><br><span class="line">    out-&gt;stream.common.add_audio_effect = out_add_audio_effect;</span><br><span class="line">    out-&gt;stream.common.remove_audio_effect = out_remove_audio_effect;</span><br><span class="line">    out-&gt;stream.get_latency = out_get_latency;</span><br><span class="line">    out-&gt;stream.set_volume = out_set_volume;</span><br><span class="line">#ifdef NO_AUDIO_OUT</span><br><span class="line">    out-&gt;stream.write = out_write_for_no_output;</span><br><span class="line">#else</span><br><span class="line">    out-&gt;stream.write = out_write;</span><br><span class="line">#endif</span><br><span class="line">    out-&gt;stream.get_render_position = out_get_render_position;</span><br><span class="line">    out-&gt;stream.get_next_write_timestamp = out_get_next_write_timestamp;</span><br><span class="line">    out-&gt;stream.get_presentation_position = out_get_presentation_position;</span><br><span class="line"></span><br><span class="line">    out-&gt;af_period_multiplier  = out-&gt;realtime ? af_period_multiplier : 1;</span><br><span class="line">    out-&gt;standby = 1;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    *stream_out = &amp;out-&gt;stream;</span><br><span class="line">    ALOGV(&quot;%s: exit&quot;, __func__);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®éŸ³é¢‘æµçš„ç†Ÿæ‚‰åšä¸€ç³»åˆ—åˆå§‹åŒ–æ“ä½œã€‚è½¬äº†ä¸€å¤§åœˆï¼Œç»§ç»­çœ‹çœ‹</p><h5 id="1-2-2-3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹-PlaybackThread"><a href="#1-2-2-3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹-PlaybackThread" class="headerlink" title="1.2.2.3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹(PlaybackThread)"></a>1.2.2.3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹(PlaybackThread)</h5><p>Step3@ AudioFlinger::openOutput. æ—¢ç„¶é€šé“å·²ç»æ‰“å¼€ï¼Œé‚£ä¹ˆç”±è°æ¥å¾€é€šé“é‡Œæ”¾ä¸œè¥¿å‘¢ï¼Ÿè¿™å°±æ˜¯PlaybackThreadã€‚è¿™é‡Œåˆ†ä¸‰ç§ä¸åŒçš„æƒ…å†µï¼š<br>Â·        OffloadThread</p><p>Â·        DirectOutput</p><p>å¦‚æœä¸éœ€è¦æ··éŸ³</p><p>Â·        Mixer</p><p>éœ€è¦æ··éŸ³</p><p>è¿™ä¸‰ç§æƒ…å†µåˆ†åˆ«å¯¹åº”DirectOutputThreadã€OffloadThreadå’ŒMixerThreadä¸¤ç§çº¿ç¨‹ã€‚æˆ‘ä»¬ä»¥åè€…ä¸ºä¾‹æ¥åˆ†æä¸‹PlaybackThreadçš„å·¥ä½œæ¨¡å¼ï¼Œä¹Ÿä¼šåé¢å°èŠ‚æ‰“ä¸‹åŸºç¡€ã€‚å›æ”¾çº¿ç¨‹ï¼ˆPlaybackThread åŠå…¶æ´¾ç”Ÿçš„å­ç±»ï¼‰å’Œå½•åˆ¶çº¿ç¨‹ï¼ˆRecordThreadï¼‰è¿›è¡Œçš„ï¼Œå…ˆç®€å•çœ‹çœ‹å›æ”¾çº¿ç¨‹å’Œå½•åˆ¶çº¿ç¨‹ç±»å…³ç³»ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/32-Audio-system-mixerthread.jpg" alt="Alt text"></p><p>Â·       ThreadBaseï¼šPlaybackThread å’Œ RecordThread çš„åŸºç±»<br>Â·       RecordThreadï¼šå½•åˆ¶çº¿ç¨‹ç±»ï¼Œç”± ThreadBase æ´¾ç”Ÿ<br>Â·       PlaybackThreadï¼šå›æ”¾çº¿ç¨‹åŸºç±»ï¼ŒåŒç”± ThreadBase æ´¾ç”Ÿ<br>Â·       MixerThreadï¼šæ··éŸ³å›æ”¾çº¿ç¨‹ç±»ï¼Œç”± PlaybackThread æ´¾ç”Ÿï¼Œè´Ÿè´£å¤„ç†æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_PRIMARYã€AUDIO_OUTPUT_FLAG_FASTã€AUDIO_OUTPUT_FLAG_DEEP_BUFFER çš„éŸ³é¢‘æµï¼ŒMixerThread å¯ä»¥æŠŠå¤šä¸ªéŸ³è½¨çš„æ•°æ®æ··éŸ³åå†è¾“å‡º<br>Â·       DirectOutputThreadï¼šç›´è¾“å›æ”¾çº¿ç¨‹ç±»ï¼Œç”± PlaybackThread æ´¾ç”Ÿï¼Œè´Ÿè´£å¤„ç†æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_DIRECT çš„éŸ³é¢‘æµï¼Œè¿™ç§éŸ³é¢‘æµæ•°æ®ä¸éœ€è¦è½¯ä»¶æ··éŸ³ï¼Œç›´æ¥è¾“å‡ºåˆ°éŸ³é¢‘è®¾å¤‡å³å¯<br>Â·       DuplicatingThreadï¼šå¤åˆ¶å›æ”¾çº¿ç¨‹ç±»ï¼Œç”± MixerThread æ´¾ç”Ÿï¼Œè´Ÿè´£å¤åˆ¶éŸ³é¢‘æµæ•°æ®åˆ°å…¶ä»–è¾“å‡ºè®¾å¤‡ï¼Œä½¿ç”¨åœºæ™¯å¦‚ä¸»å£°å¡è®¾å¤‡ã€è“ç‰™è€³æœºè®¾å¤‡ã€USB å£°å¡è®¾å¤‡åŒæ—¶è¾“å‡º<br>Â·       OffloadThreadï¼šç¡¬è§£å›æ”¾çº¿ç¨‹ç±»ï¼Œç”± DirectOutputThread æ´¾ç”Ÿï¼Œè´Ÿè´£å¤„ç†æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD çš„éŸ³é¢‘æµï¼Œè¿™ç§éŸ³é¢‘æµæœªç»è½¯ä»¶è§£ç çš„ï¼ˆä¸€èˆ¬æ˜¯ MP3ã€AAC ç­‰æ ¼å¼çš„æ•°æ®ï¼‰ï¼Œéœ€è¦è¾“å‡ºåˆ°ç¡¬ä»¶è§£ç å™¨ï¼Œç”±ç¡¬ä»¶è§£ç å™¨è§£ç æˆ PCM æ•°æ®</p><p>PlaybackThread ä¸­æœ‰ä¸ªæä¸ºé‡è¦çš„å‡½æ•° threadLoop()ï¼Œå½“ PlaybackThread è¢«å¼ºå¼•ç”¨æ—¶ï¼ŒthreadLoop() ä¼šçœŸæ­£è¿è¡Œèµ·æ¥è¿›å…¥å¾ªç¯ä¸»ä½“ï¼Œå¤„ç†éŸ³é¢‘æµæ•°æ®ç›¸å…³äº‹åŠ¡ï¼ŒthreadLoop() å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼ˆä»¥ MixerThread ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\Threads.cpp]</span><br><span class="line">bool AudioFlinger::PlaybackThread::threadLoop()</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    while (!exitPending())</span><br><span class="line">    &#123;</span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        &#123; // scope for mLock</span><br><span class="line"></span><br><span class="line">            Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">            processConfigEvents_l();</span><br><span class="line"></span><br><span class="line">            // ......</span><br><span class="line"></span><br><span class="line">            if ((!mActiveTracks.size() &amp;&amp; systemTime() &gt; mStandbyTimeNs) ||</span><br><span class="line">                                   isSuspended()) &#123;</span><br><span class="line">                // put audio hardware into standby after short delay</span><br><span class="line">                if (shouldStandby_l()) &#123;</span><br><span class="line"></span><br><span class="line">                    threadLoop_standby();</span><br><span class="line"></span><br><span class="line">                    mStandby = true;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // ......</span><br><span class="line">            &#125;</span><br><span class="line">            // mMixerStatusIgnoringFastTracks is also updated internally</span><br><span class="line">            mMixerStatus = prepareTracks_l(&amp;tracksToRemove);</span><br><span class="line"></span><br><span class="line">            // ......</span><br><span class="line">        &#125; // mLock scope ends</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        if (mBytesRemaining == 0) &#123;</span><br><span class="line">            mCurrentWriteLength = 0;</span><br><span class="line">            if (mMixerStatus == MIXER_TRACKS_READY) &#123;</span><br><span class="line">                // threadLoop_mix() sets mCurrentWriteLength</span><br><span class="line">                threadLoop_mix();</span><br><span class="line">            &#125;</span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        if (!waitingAsyncCallback()) &#123;</span><br><span class="line">            // mSleepTimeUs == 0 means we must write to audio hardware</span><br><span class="line">            if (mSleepTimeUs == 0) &#123;</span><br><span class="line">                // ......</span><br><span class="line">                if (mBytesRemaining) &#123;</span><br><span class="line">                    // FIXME rewrite to reduce number of system calls</span><br><span class="line">                    ret = threadLoop_write();</span><br><span class="line">                    lastWriteFinished = systemTime();</span><br><span class="line">                    delta = lastWriteFinished - mLastWriteTime;</span><br><span class="line">                    if (ret &lt; 0) &#123;</span><br><span class="line">                        mBytesRemaining = 0;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        mBytesWritten += ret;</span><br><span class="line">                        mBytesRemaining -= ret;</span><br><span class="line">                        mFramesWritten += ret / mFrameSize;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // ......</span><br><span class="line">            &#125;</span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Finally let go of removed track(s), without the lock held</span><br><span class="line">        // since we can&apos;t guarantee the destructors won&apos;t acquire that</span><br><span class="line">        // same lock.  This will also mutate and push a new fast mixer state.</span><br><span class="line">        threadLoop_removeTracks(tracksToRemove);</span><br><span class="line">        tracksToRemove.clear();</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    threadLoop_exit();</span><br><span class="line"></span><br><span class="line">    if (!mStandby) &#123;</span><br><span class="line">        threadLoop_standby();</span><br><span class="line">        mStandby = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ......</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>threadLoop() å¾ªç¯çš„æ¡ä»¶æ˜¯ exitPending() è¿”å› falseï¼Œå¦‚æœæƒ³è¦ PlaybackThread ç»“æŸå¾ªç¯ï¼Œåˆ™å¯ä»¥è°ƒç”¨ requestExit() æ¥è¯·æ±‚é€€å‡ºï¼›<br>processConfigEvents_l() ï¼šå¤„ç†é…ç½®äº‹ä»¶ï¼›å½“æœ‰é…ç½®æ”¹å˜çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œéœ€è¦è°ƒç”¨ sendConfigEvent_l() æ¥é€šçŸ¥ PlaybackThreadï¼Œè¿™æ · PlaybackThread æ‰èƒ½åŠæ—¶å¤„ç†é…ç½®äº‹ä»¶ï¼›å¸¸è§çš„é…ç½®äº‹ä»¶æ˜¯åˆ‡æ¢éŸ³é¢‘é€šè·¯ï¼›<br>æ£€æŸ¥æ­¤æ—¶æ­¤åˆ»æ˜¯å¦ç¬¦åˆ standby æ¡ä»¶ï¼Œæ¯”å¦‚å½“å‰å¹¶æ²¡æœ‰ ACTIVE çŠ¶æ€çš„ Trackï¼ˆmActiveTracks.size() = 0ï¼‰ï¼Œé‚£ä¹ˆè°ƒç”¨ threadLoop_standby() å…³é—­éŸ³é¢‘ç¡¬ä»¶è®¾å¤‡ä»¥èŠ‚çœèƒ½è€—ï¼›<br>prepareTracks_l()ï¼š å‡†å¤‡éŸ³é¢‘æµå’Œæ··éŸ³å™¨ï¼Œè¯¥å‡½æ•°éå¸¸å¤æ‚ï¼Œè¿™é‡Œä¸è¯¦ç»†åˆ†æäº†ï¼Œä»…åˆ—ä¸€ä¸‹æµç¨‹è¦ç‚¹ï¼š<br>éå† mActiveTracksï¼Œé€ä¸ªå¤„ç† mActiveTracks ä¸Šçš„ Trackï¼Œæ£€æŸ¥è¯¥ Track æ˜¯å¦ä¸º ACTIVE çŠ¶æ€ï¼›<br>å¦‚æœ Track è®¾ç½®æ˜¯ ACTIVE çŠ¶æ€ï¼Œåˆ™å†æ£€æŸ¥è¯¥ Track çš„æ•°æ®æ˜¯å¦å‡†å¤‡å°±ç»ªäº†ï¼›<br>æ ¹æ®éŸ³é¢‘æµçš„éŸ³é‡å€¼ã€æ ¼å¼ã€å£°é“æ•°ã€éŸ³è½¨çš„é‡‡æ ·ç‡ã€ç¡¬ä»¶è®¾å¤‡çš„é‡‡æ ·ç‡ï¼Œé…ç½®å¥½æ··éŸ³å™¨å‚æ•°ï¼›<br>å¦‚æœ Track çš„çŠ¶æ€æ˜¯ PAUSED æˆ– STOPPEDï¼Œåˆ™æŠŠè¯¥ Track æ·»åŠ åˆ° tracksToRemove å‘é‡ä¸­ï¼›<br>threadLoop_mix()ï¼šè¯»å–æ‰€æœ‰ç½®äº† ACTIVE çŠ¶æ€çš„éŸ³é¢‘æµæ•°æ®ï¼Œæ··éŸ³å™¨å¼€å§‹å¤„ç†è¿™äº›æ•°æ®ï¼›<br>threadLoop_write()ï¼š æŠŠæ··éŸ³å™¨å¤„ç†åçš„æ•°æ®å†™åˆ°è¾“å‡ºæµè®¾å¤‡ï¼›<br>threadLoop_removeTracks()ï¼š æŠŠ tracksToRemove ä¸Šçš„æ‰€æœ‰ Track ä» mActiveTracks ä¸­ç§»é™¤å‡ºæ¥ï¼›è¿™æ ·ä¸‹ä¸€æ¬¡å¾ªç¯æ—¶å°±ä¸ä¼šå¤„ç†è¿™äº› Track äº†ã€‚<br>è¿™é‡Œè¯´è¯´ PlaybackThread ä¸è¾“å‡ºæµè®¾å¤‡çš„å…³ç³»ï¼šPlaybackThread å®ä¾‹ä¸è¾“å‡ºæµè®¾å¤‡æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ¯”æ–¹è¯´ OffloadThread åªä¼šå°†éŸ³é¢‘æ•°æ®è¾“å‡ºåˆ° compress_offload è®¾å¤‡ä¸­ï¼ŒMixerThread(with FastMixer) åªä¼šå°†éŸ³é¢‘æ•°æ®è¾“å‡ºåˆ° low_latency è®¾å¤‡ä¸­ã€‚</p><p>ä» Audio HAL ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸çœ‹åˆ°å¦‚ä¸‹ 4 ç§è¾“å‡ºæµè®¾å¤‡ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¸åŒçš„æ’­æ”¾åœºæ™¯ï¼š</p><p>primary_outï¼šä¸»è¾“å‡ºæµè®¾å¤‡ï¼Œç”¨äºé“ƒå£°ç±»å£°éŸ³è¾“å‡ºï¼Œå¯¹åº”ç€æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_PRIMARY çš„éŸ³é¢‘æµå’Œä¸€ä¸ª MixerThread å›æ”¾çº¿ç¨‹å®ä¾‹<br>low_latencyï¼šä½å»¶è¿Ÿè¾“å‡ºæµè®¾å¤‡ï¼Œç”¨äºæŒ‰é”®éŸ³ã€æ¸¸æˆèƒŒæ™¯éŸ³ç­‰å¯¹æ—¶å»¶è¦æ±‚é«˜çš„å£°éŸ³è¾“å‡ºï¼Œå¯¹åº”ç€æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_FAST çš„éŸ³é¢‘æµå’Œä¸€ä¸ª MixerThread å›æ”¾çº¿ç¨‹å®ä¾‹<br>deep_bufferï¼šéŸ³ä¹éŸ³è½¨è¾“å‡ºæµè®¾å¤‡ï¼Œç”¨äºéŸ³ä¹ç­‰å¯¹æ—¶å»¶è¦æ±‚ä¸é«˜çš„å£°éŸ³è¾“å‡ºï¼Œå¯¹åº”ç€æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_DEEP_BUFFER çš„éŸ³é¢‘æµå’Œä¸€ä¸ª MixerThread å›æ”¾çº¿ç¨‹å®ä¾‹<br>compress_offloadï¼šç¡¬è§£è¾“å‡ºæµè®¾å¤‡ï¼Œç”¨äºéœ€è¦ç¡¬ä»¶è§£ç çš„æ•°æ®è¾“å‡ºï¼Œå¯¹åº”ç€æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD çš„éŸ³é¢‘æµå’Œä¸€ä¸ª OffloadThread å›æ”¾çº¿ç¨‹å®ä¾‹<br>å…¶ä¸­ primary_out è®¾å¤‡æ˜¯å¿…é¡»å£°æ˜æ”¯æŒçš„ï¼Œè€Œä¸”ç³»ç»Ÿå¯åŠ¨æ—¶å°±å·²ç»æ‰“å¼€ primary_out è®¾å¤‡å¹¶åˆ›å»ºå¥½å¯¹åº”çš„ MixerThread å®ä¾‹ã€‚å…¶ä»–ç±»å‹çš„è¾“å‡ºæµè®¾å¤‡å¹¶éå¿…é¡»å£°æ˜æ”¯æŒçš„ï¼Œä¸»è¦æ˜¯çœ‹ç¡¬ä»¶ä¸Šæœ‰æ— è¿™ä¸ªèƒ½åŠ›ã€‚</p><p>å¯èƒ½æœ‰äººäº§ç”Ÿè¿™æ ·çš„ç–‘é—®ï¼šæ—¢ç„¶ primary_out è®¾å¤‡ä¸€ç›´ä¿æŒæ‰“å¼€ï¼Œé‚£ä¹ˆèƒ½è€—å²‚ä¸æ˜¯å¾ˆå¤§ï¼Ÿè¿™é‡Œé˜é‡Šä¸€ä¸ªæ¦‚å¿µï¼šè¾“å‡ºæµè®¾å¤‡å±äºé€»è¾‘è®¾å¤‡ï¼Œå¹¶ä¸æ˜¯ç¡¬ä»¶è®¾å¤‡ã€‚æ‰€ä»¥å³ä½¿è¾“å‡ºæµè®¾å¤‡ä¸€ç›´ä¿æŒæ‰“å¼€ï¼Œåªè¦ç¡¬ä»¶è®¾å¤‡ä¸å·¥ä½œï¼Œé‚£ä¹ˆå°±ä¸ä¼šå½±å“èƒ½è€—ã€‚é‚£ä¹ˆç¡¬ä»¶è®¾å¤‡ä»€ä¹ˆæ—¶å€™æ‰ä¼šæ‰“å¼€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ PlaybackThread å°†éŸ³é¢‘æ•°æ®å†™å…¥åˆ°è¾“å‡ºæµè®¾å¤‡æ—¶ã€‚</p><p>ä¸‹å›¾ç®€å•æè¿° AudioTrackã€PlaybackThreadã€è¾“å‡ºæµè®¾å¤‡ä¸‰è€…çš„å¯¹åº”å…³ç³»ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/33-Audio-system-Audio-playback-.png" alt="Alt text"></p><p>æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆè¯´ï¼šè¾“å‡ºæµè®¾å¤‡å†³å®šäº†å®ƒå¯¹åº”çš„ PlaybackThread æ˜¯ä»€ä¹ˆç±»å‹ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿæ„æ€æ˜¯è¯´ï¼šåªæœ‰æ”¯æŒäº†è¯¥ç±»å‹çš„è¾“å‡ºæµè®¾å¤‡ï¼Œé‚£ä¹ˆè¯¥ç±»å‹çš„ PlaybackThread æ‰æœ‰å¯èƒ½è¢«åˆ›å»ºã€‚ä¸¾ä¸ªä¾‹å­ï¼šåªæœ‰ç¡¬ä»¶ä¸Šå…·å¤‡ç¡¬ä»¶è§£ç å™¨ï¼Œç³»ç»Ÿæ‰å»ºç«‹ compress_offload è®¾å¤‡ï¼Œç„¶åæ’­æ”¾ mp3 æ ¼å¼çš„éŸ³ä¹æ–‡ä»¶æ—¶ï¼Œæ‰ä¼šåˆ›å»º OffloadThread æŠŠæ•°æ®è¾“å‡ºåˆ° compress_offload è®¾å¤‡ä¸Šï¼›åä¹‹ï¼Œå¦‚æœç¡¬ä»¶ä¸Šå¹¶ä¸å…·å¤‡ç¡¬ä»¶è§£ç å™¨ï¼Œç³»ç»Ÿåˆ™ä¸åº”è¯¥å»ºç«‹ compress_offload è®¾å¤‡ï¼Œé‚£ä¹ˆæ’­æ”¾ mp3 æ ¼å¼çš„éŸ³ä¹æ–‡ä»¶æ—¶ï¼Œé€šè¿‡ MixerThread æŠŠæ•°æ®è¾“å‡ºåˆ°å…¶ä»–è¾“å‡ºæµè®¾å¤‡ä¸Šã€‚</p><p>é‚£ä¹ˆæœ‰æ— å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼šåº•å±‚å¹¶ä¸æ”¯æŒ compress_offload è®¾å¤‡ï¼Œä½†ååæœ‰ä¸ªæ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD çš„éŸ³é¢‘æµé€åˆ° AudioFlinger äº†å‘¢ï¼Ÿè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šæ£€æŸ¥å¹¶ä¿å­˜è¾“å…¥è¾“å‡ºæµè®¾å¤‡çš„æ”¯æŒä¿¡æ¯ï¼›æ’­æ”¾å™¨åœ¨æ’­æ”¾ mp3 æ–‡ä»¶æ—¶ï¼Œé¦–å…ˆçœ‹ compress_offload è®¾å¤‡æ˜¯å¦æ”¯æŒäº†ï¼Œå¦‚æœæ”¯æŒï¼Œé‚£ä¹ˆä¸è¿›è¡Œè½¯ä»¶è§£ç ï¼Œç›´æ¥æŠŠæ•°æ®æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOADï¼›å¦‚æœä¸æ”¯æŒï¼Œé‚£ä¹ˆå…ˆè¿›è¡Œè½¯ä»¶è§£ç ï¼Œç„¶åæŠŠè§£ç å¥½çš„æ•°æ®æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_DEEP_BUFFERï¼Œå‰ææ˜¯ deep_buffer è®¾å¤‡æ˜¯æ”¯æŒäº†çš„ï¼›å¦‚æœ deep_buffer è®¾å¤‡ä¹Ÿä¸æ”¯æŒï¼Œé‚£ä¹ˆæŠŠæ•°æ®æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_PRIMARYã€‚</p><p>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå°±å·²ç»æ‰“å¼€ primary_outã€low_latencyã€deep_buffer è¿™ä¸‰ç§è¾“å‡ºæµè®¾å¤‡ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ MixerThread äº†ï¼›è€Œæ­¤æ—¶ DirectOutputThread ä¸ OffloadThread ä¸ä¼šè¢«åˆ›å»ºï¼Œç›´åˆ°æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_DIRECT/AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD çš„éŸ³é¢‘æµéœ€è¦è¾“å‡ºæ—¶ï¼Œæ‰å¼€å§‹åˆ›å»º DirectOutputThread/OffloadThread å’Œæ‰“å¼€ direct_out/compress_offload è®¾å¤‡ã€‚è¿™ä¸€ç‚¹è¯·å‚è€ƒå¦‚ä¸‹ä»£ç ï¼Œæ³¨é‡Šéå¸¸æ¸…æ™°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\managerdefault\AudioPolicyManager.cpp]</span><br><span class="line">AudioPolicyManager::AudioPolicyManager(AudioPolicyClientInterface *clientInterface)</span><br><span class="line">    // ......</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    // mAvailableOutputDevices and mAvailableInputDevices now contain all attached devices</span><br><span class="line">    // open all output streams needed to access attached devices</span><br><span class="line">    // ......</span><br><span class="line">    for (size_t i = 0; i &lt; mHwModules.size(); i++) &#123;</span><br><span class="line">        // ......</span><br><span class="line">        // open all output streams needed to access attached devices</span><br><span class="line">        // except for direct output streams that are only opened when they are actually</span><br><span class="line">        // required by an app.</span><br><span class="line">        // This also validates mAvailableOutputDevices list</span><br><span class="line">        for (size_t j = 0; j &lt; mHwModules[i]-&gt;mOutputProfiles.size(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            // ......</span><br><span class="line">            if ((outProfile-&gt;getFlags() &amp; AUDIO_OUTPUT_FLAG_DIRECT) != 0) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            // ......</span><br><span class="line">            audio_io_handle_t output = AUDIO_IO_HANDLE_NONE;</span><br><span class="line">            status_t status = mpClientInterface-&gt;openOutput(outProfile-&gt;getModuleHandle(),</span><br><span class="line">                                                            &amp;output,</span><br><span class="line">                                                            &amp;config,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mDevice,</span><br><span class="line">                                                            address,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mLatency,</span><br><span class="line">                                                            outputDesc-&gt;mFlags);</span><br><span class="line"></span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line">        // open input streams needed to access attached devices to validate</span><br><span class="line">        // mAvailableInputDevices list</span><br><span class="line">        for (size_t j = 0; j &lt; mHwModules[i]-&gt;mInputProfiles.size(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            // ......</span><br><span class="line">            status_t status = mpClientInterface-&gt;openInput(inProfile-&gt;getModuleHandle(),</span><br><span class="line">                                                           &amp;input,</span><br><span class="line">                                                           &amp;config,</span><br><span class="line">                                                           &amp;inputDesc-&gt;mDevice,</span><br><span class="line">                                                           address,</span><br><span class="line">                                                           AUDIO_SOURCE_MIC,</span><br><span class="line">                                                           AUDIO_INPUT_FLAG_NONE);</span><br><span class="line"></span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    updateDevicesAndOutputs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ mpClientInterface-&gt;openOutput() æœ€ç»ˆä¼šè°ƒç”¨åˆ° AudioFlinger::openOutput()ï¼šæ‰“å¼€è¾“å‡ºæµè®¾å¤‡ï¼Œå¹¶åˆ›å»º PlaybackThread å¯¹è±¡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">status_t AudioFlinger::openOutput(audio_module_handle_t module,</span><br><span class="line">                                  audio_io_handle_t *output,</span><br><span class="line">                                  audio_config_t *config,</span><br><span class="line">                                  audio_devices_t *devices,</span><br><span class="line">                                  const String8&amp; address,</span><br><span class="line">                                  uint32_t *latencyMs,</span><br><span class="line">                                  audio_output_flags_t flags)</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">    sp&lt;PlaybackThread&gt; thread = openOutput_l(module, output, config, *devices, address, flags);</span><br><span class="line">    // ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;AudioFlinger::PlaybackThread&gt; AudioFlinger::openOutput_l(audio_module_handle_t module,</span><br><span class="line">                                                            audio_io_handle_t *output,</span><br><span class="line">                                                            audio_config_t *config,</span><br><span class="line">                                                            audio_devices_t devices,</span><br><span class="line">                                                            const String8&amp; address,</span><br><span class="line">                                                            audio_output_flags_t flags)</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line">    // åˆ†é…å…¨å±€å”¯ä¸€çš„ audio_io_handle_tï¼Œå¯ä»¥ç†è§£å®ƒæ˜¯å›æ”¾çº¿ç¨‹çš„ç´¢å¼•å·</span><br><span class="line">    if (*output == AUDIO_IO_HANDLE_NONE) &#123;</span><br><span class="line">        *output = nextUniqueId(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mHardwareStatus = AUDIO_HW_OUTPUT_OPEN;</span><br><span class="line"></span><br><span class="line">    //......</span><br><span class="line"></span><br><span class="line">    // æ‰“å¼€éŸ³é¢‘è¾“å‡ºæµè®¾å¤‡ï¼ŒHAL å±‚æ ¹æ® flags é€‰æ‹©æ‰“å¼€ç›¸å…³ç±»å‹çš„è¾“å‡ºæµè®¾å¤‡</span><br><span class="line">    AudioStreamOut *outputStream = NULL;</span><br><span class="line">    status_t status = outHwDev-&gt;openOutputStream(</span><br><span class="line">            &amp;outputStream,</span><br><span class="line">            *output,</span><br><span class="line">            devices,</span><br><span class="line">            flags,</span><br><span class="line">            config,</span><br><span class="line">            address.string());</span><br><span class="line"></span><br><span class="line">    mHardwareStatus = AUDIO_HW_IDLE;</span><br><span class="line"></span><br><span class="line">    if (status == NO_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">        PlaybackThread *thread;</span><br><span class="line">        if (flags &amp; AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD) &#123;</span><br><span class="line">            // AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD éŸ³é¢‘æµï¼Œåˆ›å»º OffloadThread å®ä¾‹</span><br><span class="line">            thread = new OffloadThread(this, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(&quot;openOutput_l() created offload output: ID %d thread %p&quot;, *output, thread);</span><br><span class="line">        &#125; else if ((flags &amp; AUDIO_OUTPUT_FLAG_DIRECT)</span><br><span class="line">                || !isValidPcmSinkFormat(config-&gt;format)</span><br><span class="line">                || !isValidPcmSinkChannelMask(config-&gt;channel_mask)) &#123;</span><br><span class="line">            // AUDIO_OUTPUT_FLAG_DIRECT éŸ³é¢‘æµï¼Œåˆ›å»º DirectOutputThread å®ä¾‹</span><br><span class="line">            thread = new DirectOutputThread(this, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(&quot;openOutput_l() created direct output: ID %d thread %p&quot;, *output, thread);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // å…¶ä»–æ ‡è¯†çš„éŸ³é¢‘æµï¼Œåˆ›å»º MixerThread å®ä¾‹</span><br><span class="line">            thread = new MixerThread(this, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(&quot;openOutput_l() created mixer output: ID %d thread %p&quot;, *output, thread);</span><br><span class="line">        &#125;</span><br><span class="line">        // æŠŠ audio_io_handle_t å’Œ PlaybackThread æ·»åŠ åˆ°é”®å€¼å¯¹å‘é‡ mPlaybackThreads ä¸­</span><br><span class="line">        // é”®å€¼å¯¹å‘é‡ mPlaybackThreads ä¸­ï¼Œç”±äº audio_io_handle_t å’Œ PlaybackThread æ˜¯ä¸€</span><br><span class="line">        // ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæ‰€ä»¥æ‹¿åˆ°ä¸€ä¸ª audio_io_handle_tï¼Œå°±èƒ½æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThread</span><br><span class="line">        // æ‰€ä»¥å¯ä»¥ç†è§£ audio_io_handle_t ä¸º PlaybackThread çš„ç´¢å¼•å·</span><br><span class="line">        mPlaybackThreads.add(*output, thread);</span><br><span class="line">        return thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="1-2-3ã€AudioFlinger-éŸ³é¢‘æµç®¡ç†"><a href="#1-2-3ã€AudioFlinger-éŸ³é¢‘æµç®¡ç†" class="headerlink" title="1.2.3ã€AudioFlinger éŸ³é¢‘æµç®¡ç†"></a>1.2.3ã€AudioFlinger éŸ³é¢‘æµç®¡ç†</h5><p>AudioFlinger éŸ³é¢‘æµç®¡ç†ç”± AudioFlinger::PlaybackThread::Track å®ç°ï¼ŒTrack ä¸ AudioTrack æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¸€ä¸ª AudioTrack åˆ›å»ºåï¼Œé‚£ä¹ˆ AudioFlinger ä¼šåˆ›å»ºä¸€ä¸ª Track ä¸ä¹‹å¯¹åº”ï¼›PlaybackThread ä¸ AudioTrack/Track æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¸€ä¸ª PlaybackThread å¯ä»¥æŒ‚ç€å¤šä¸ª Trackã€‚</p><p>å…·ä½“æ¥è¯´ï¼šAudioTrack åˆ›å»ºåï¼ŒAudioPolicyManager æ ¹æ® AudioTrack çš„è¾“å‡ºæ ‡è¯†å’Œæµç±»å‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„è¾“å‡ºæµè®¾å¤‡å’Œ PlaybackThreadï¼ˆå¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯ï¼Œåˆ™ç³»ç»Ÿä¼šæ‰“å¼€å¯¹åº”çš„è¾“å‡ºæµè®¾å¤‡å¹¶æ–°å»ºä¸€ä¸ª PlaybackThreadï¼‰ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Track å¹¶æŒ‚åˆ°è¿™ä¸ª PlaybackThread ä¸‹é¢ã€‚</p><p>PlaybackThread æœ‰ä¸¤ä¸ªç§æœ‰æˆå‘˜å‘é‡ä¸æ­¤å¼ºç›¸å…³ï¼š</p><p>Â·       mTracksï¼šè¯¥ PlaybackThread åˆ›å»ºçš„æ‰€æœ‰ Track å‡æ·»åŠ ä¿å­˜åˆ°è¿™ä¸ªå‘é‡ä¸­<br>Â·       mActiveTracksï¼šåªæœ‰éœ€è¦æ’­æ”¾ï¼ˆè®¾ç½®äº† ACTIVE çŠ¶æ€ï¼‰çš„ Track ä¼šæ·»åŠ åˆ°è¿™ä¸ªå‘é‡ä¸­ï¼›PlaybackThread ä¼šä»è¯¥å‘é‡ä¸Šæ‰¾åˆ°æ‰€æœ‰è®¾ç½®äº† ACTIVE çŠ¶æ€çš„ Trackï¼ŒæŠŠè¿™äº› Track æ•°æ®æ··éŸ³åå†™åˆ°è¾“å‡ºæµè®¾å¤‡<br>éŸ³é¢‘æµæ§åˆ¶æœ€å¸¸ç”¨çš„ä¸‰ä¸ªæ¥å£ï¼š</p><p>AudioFlinger::PlaybackThread::Track::startï¼šå¼€å§‹æ’­æ”¾ï¼šæŠŠè¯¥ Track ç½® ACTIVE çŠ¶æ€ï¼Œç„¶åæ·»åŠ åˆ° mActiveTracks å‘é‡ä¸­ï¼Œæœ€åè°ƒç”¨ AudioFlinger::PlaybackThread::broadcast_l() å‘ŠçŸ¥ PlaybackThread æƒ…å†µæœ‰å˜<br>Â·       AudioFlinger::PlaybackThread::Track::stopï¼šåœæ­¢æ’­æ”¾ï¼šæŠŠè¯¥ Track ç½® STOPPED çŠ¶æ€ï¼Œæœ€åè°ƒç”¨ AudioFlinger::PlaybackThread::broadcast_l() å‘ŠçŸ¥ PlaybackThread æƒ…å†µæœ‰å˜<br>Â·       AudioFlinger::PlaybackThread::Track::pauseï¼šæš‚åœæ’­æ”¾ï¼šæŠŠè¯¥ Track ç½® PAUSING çŠ¶æ€ï¼Œæœ€åè°ƒç”¨ AudioFlinger::PlaybackThread::broadcast_l() å‘ŠçŸ¥ PlaybackThread æƒ…å†µæœ‰å˜<br>Â·       AudioFlinger::PlaybackThread::threadLoop() å¾—æ‚‰æƒ…å†µæœ‰å˜åï¼Œè°ƒç”¨ prepareTracks_l() é‡æ–°å‡†å¤‡éŸ³é¢‘æµå’Œæ··éŸ³å™¨ï¼šACTIVE çŠ¶æ€çš„ Track ä¼šæ·»åŠ åˆ° mActiveTracksï¼Œæ­¤å¤–çš„ Track ä¼šä» mActiveTracks ä¸Šç§»é™¤å‡ºæ¥ï¼Œç„¶åé‡æ–°å‡†å¤‡ AudioMixerã€‚</p><p>å¯è§è¿™ä¸‰ä¸ªéŸ³é¢‘æµæ§åˆ¶æ¥å£æ˜¯éå¸¸ç®€å•çš„ï¼Œä¸»è¦æ˜¯è®¾ç½®ä¸€ä¸‹ Track çš„çŠ¶æ€ï¼Œç„¶åå‘ä¸ªäº‹ä»¶é€šçŸ¥ PlaybackThread å°±è¡Œï¼Œå¤æ‚çš„å¤„ç†éƒ½åœ¨ AudioFlinger::PlaybackThread::threadLoop() ä¸­äº†ã€‚</p><h4 id="äºŒ-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService"><a href="#äºŒ-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService" class="headerlink" title="(äºŒ)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService"></a>(äºŒ)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService</h4><p>AudioPolicyServiceæ˜¯ç­–ç•¥çš„åˆ¶å®šè€…ï¼Œæ¯”å¦‚ä»€ä¹ˆæ—¶å€™æ‰“å¼€éŸ³é¢‘æ¥å£è®¾å¤‡ã€æŸç§Streamç±»å‹çš„éŸ³é¢‘å¯¹åº”ä»€ä¹ˆè®¾å¤‡ç­‰ç­‰ã€‚è€ŒAudioFlingeråˆ™æ˜¯ç­–ç•¥çš„æ‰§è¡Œè€…ï¼Œä¾‹å¦‚å…·ä½“å¦‚ä½•ä¸éŸ³é¢‘è®¾å¤‡é€šä¿¡ï¼Œå¦‚ä½•ç»´æŠ¤ç°æœ‰ç³»ç»Ÿä¸­çš„éŸ³é¢‘è®¾å¤‡ï¼Œä»¥åŠå¤šä¸ªéŸ³é¢‘æµçš„æ··éŸ³å¦‚ä½•å¤„ç†ç­‰ç­‰éƒ½å¾—ç”±å®ƒæ¥å®Œæˆã€‚AudioPolicyServiceæ ¹æ®ç”¨æˆ·é…ç½®æ¥æŒ‡å¯¼AudioFlingeråŠ è½½è®¾å¤‡æ¥å£ï¼Œèµ·åˆ°è·¯ç”±åŠŸèƒ½</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\audioserver\main_audioserver.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (doLog &amp;&amp; (childPid = fork()) != <span class="number">0</span>) &#123;</span><br><span class="line">    ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// all other services</span></span><br><span class="line">        <span class="keyword">if</span> (doLog) &#123;</span><br><span class="line">            prctl(PR_SET_PDEATHSIG, SIGKILL);   <span class="comment">// if parent media.log dies before me, kill me also</span></span><br><span class="line">            setpgid(<span class="number">0</span>, <span class="number">0</span>);                      <span class="comment">// but if I die first, don't kill my parent</span></span><br><span class="line">        &#125;</span><br><span class="line">        sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">        sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">        ALOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">        AudioFlinger::instantiate();</span><br><span class="line">        AudioPolicyService::instantiate();</span><br><span class="line">        RadioService::instantiate();</span><br><span class="line">        SoundTriggerHwService::instantiate();</span><br><span class="line">        ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AudioPolicyServiceç»§æ‰¿äº†æ¨¡æ¿ç±»BinderServiceï¼Œè¯¥ç±»ç”¨äºæ³¨å†Œnative serviceã€‚<br>BinderServiceæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œè¯¥ç±»çš„publishå‡½æ•°å°±æ˜¯å®Œæˆå‘ServiceManageræ³¨å†ŒæœåŠ¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\service\AudioPolicyService.h]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">getServiceName</span><span class="params">()</span> ANDROID_API </span>&#123; <span class="keyword">return</span> <span class="string">"media.audio_policy"</span>; &#125;</span><br></pre></td></tr></table></figure><p>AudioPolicyServiceæ³¨å†Œåä¸ºâ€media.audio_policyâ€çš„æœåŠ¡ã€‚<br>é¦–å…ˆçœ‹çœ‹AudioPolicyServiceçš„onFirstRef()å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\service\AudioPolicyService.cpp]</span><br><span class="line"></span><br><span class="line">AudioPolicyService::AudioPolicyService()</span><br><span class="line">    : BnAudioPolicyService(), mpAudioPolicyDev(<span class="literal">NULL</span>), mpAudioPolicy(<span class="literal">NULL</span>),</span><br><span class="line">      mAudioPolicyManager(<span class="literal">NULL</span>), mAudioPolicyClient(<span class="literal">NULL</span>), mPhoneState(AUDIO_MODE_INVALID)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> AudioPolicyService::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        <span class="comment">/* Step 1:åˆ›å»ºAudioCommandThreadçº¿ç¨‹ */</span></span><br><span class="line">        <span class="comment">// start tone playback thread</span></span><br><span class="line">        mTonePlaybackThread = <span class="keyword">new</span> AudioCommandThread(String8(<span class="string">"ApmTone"</span>), <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// start audio commands thread</span></span><br><span class="line">        mAudioCommandThread = <span class="keyword">new</span> AudioCommandThread(String8(<span class="string">"ApmAudio"</span>), <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// start output activity command thread</span></span><br><span class="line">        mOutputCommandThread = <span class="keyword">new</span> AudioCommandThread(String8(<span class="string">"ApmOutput"</span>), <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_LEGACY_AUDIO_POLICY</span></span><br><span class="line">         <span class="comment">// ä½¿ç”¨è€ç‰ˆæœ¬çš„ audio policy åˆå§‹åŒ–æ–¹å¼</span></span><br><span class="line">        ....</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æœ€æ–°çš„ audio policy åˆå§‹åŒ–æ–¹å¼</span></span><br><span class="line">        ALOGI(<span class="string">"AudioPolicyService CSTOR in new mode"</span>);</span><br><span class="line">        <span class="comment">/* Step 2:åˆ›å»ºAudioPolicyClientã€ AudioPolicyManager */</span></span><br><span class="line">        mAudioPolicyClient = <span class="keyword">new</span> AudioPolicyClient(<span class="keyword">this</span>);</span><br><span class="line">        mAudioPolicyManager = createAudioPolicyManager(mAudioPolicyClient);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// load audio processing modules</span></span><br><span class="line">    sp&lt;AudioPolicyEffects&gt;audioPolicyEffects = <span class="keyword">new</span> AudioPolicyEffects();</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        mAudioPolicyEffects = audioPolicyEffects;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹çœ‹æ€»ä½“æ—¶åºå›¾ï¼š</p><h5 id="2-1ã€Step-1-åˆ›å»ºAudioCommandThreadçº¿ç¨‹"><a href="#2-1ã€Step-1-åˆ›å»ºAudioCommandThreadçº¿ç¨‹" class="headerlink" title="2.1ã€Step 1:åˆ›å»ºAudioCommandThreadçº¿ç¨‹"></a>2.1ã€Step 1:åˆ›å»ºAudioCommandThreadçº¿ç¨‹</h5><p>åœ¨AudioPolicyServiceå¯¹è±¡æ„é€ è¿‡ç¨‹ä¸­ï¼Œåˆ†åˆ«åˆ›å»ºäº†ApmToneã€ApmAudioã€ApmOutputä¸‰ä¸ªAudioCommandThreadçº¿ç¨‹ï¼š</p><p>1ã€ ApmToneç”¨äºæ’­æ”¾toneéŸ³ï¼›</p><p>2ã€ ApmAudioç”¨äºæ‰§è¡Œaudioå‘½ä»¤ï¼›</p><p>3ã€ApmOutputç”¨äºæ‰§è¡Œè¾“å‡ºå‘½ä»¤ï¼›</p><p>åœ¨ç¬¬ä¸€æ¬¡å¼ºå¼•ç”¨AudioCommandThreadçº¿ç¨‹å¯¹è±¡æ—¶ï¼ŒAudioCommandThreadçš„onFirstRefå‡½æ•°è¢«å›è°ƒï¼Œåœ¨æ­¤å¯åŠ¨çº¿ç¨‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\service\AudioPolicyService.cpp]</span><br><span class="line"><span class="keyword">void</span> AudioPolicyService::AudioCommandThread::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    run(mName.<span class="built_in">string</span>(), ANDROID_PRIORITY_AUDIO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡‡ç”¨å¼‚æ­¥æ–¹å¼æ¥æ‰§è¡Œaudio commandï¼Œå½“éœ€è¦æ‰§è¡Œä¸Šè¡¨ä¸­çš„å‘½ä»¤æ—¶ï¼Œé¦–å…ˆå°†å‘½ä»¤æŠ•é€’åˆ°AudioCommandThreadçš„mAudioCommandså‘½ä»¤å‘é‡è¡¨ä¸­ï¼Œç„¶åé€šè¿‡mWaitWorkCV.signal()å”¤é†’AudioCommandThreadçº¿ç¨‹ï¼Œè¢«å”¤é†’çš„AudioCommandThreadçº¿ç¨‹æ‰§è¡Œå®Œcommandåï¼Œåˆé€šè¿‡mWaitWorkCV.waitRelative(mLock, waitTime)ç¡çœ ç­‰å¾…å‘½ä»¤åˆ°æ¥ã€‚</p><h5 id="2-2ã€Step-2-åˆ›å»ºAudioPolicyClientã€-AudioPolicyManager"><a href="#2-2ã€Step-2-åˆ›å»ºAudioPolicyClientã€-AudioPolicyManager" class="headerlink" title="2.2ã€Step 2: åˆ›å»ºAudioPolicyClientã€ AudioPolicyManager"></a>2.2ã€Step 2: åˆ›å»ºAudioPolicyClientã€ AudioPolicyManager</h5><p>é¦–å…ˆåˆ›å»ºAudioPolicyClient </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\service\AudioPolicyService.h]</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AudioPolicyClient</span> :</span> <span class="keyword">public</span> AudioPolicyClientInterface</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="keyword">public</span>:</span><br><span class="line">        AudioPolicyClient(AudioPolicyService *service) : mAudioPolicyService(service) &#123;&#125;</span><br><span class="line">        <span class="keyword">virtual</span> ~AudioPolicyClient() &#123;&#125;</span><br><span class="line">        <span class="comment">// loads a HW module.</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> audio_module_handle_t <span class="title">loadHwModule</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> status_t <span class="title">openOutput</span><span class="params">(<span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">audio_io_handle_t</span> *output,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">audio_config_t</span> *config,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">audio_devices_t</span> *devices,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">const</span> String8&amp; address,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">uint32_t</span> *latencyMs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">audio_output_flags_t</span> flags)</span></span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// opens an audio input</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> audio_io_handle_t <span class="title">openInput</span><span class="params">(<span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_io_handle_t</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_config_t</span> *config,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_devices_t</span> *devices,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">const</span> String8&amp; address,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_source_t</span> source,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_input_flags_t</span> flags)</span></span>;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span>:</span><br><span class="line">        AudioPolicyService *mAudioPolicyService;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>createAudioPolicyManager() å‡½æ•°çš„å®ç°ä½äº frameworks/av/services/audiopolicy/manager/AudioPolicyFactory.cppæ–‡ä»¶ä¸­ã€‚æŸ¥çœ‹æºç åæˆ‘ä»¬ä¼šå‘ç°å®ƒå®é™…ä¸Šæ˜¯ç›´æ¥è°ƒç”¨äº† AudioPolicyManager çš„æ„é€ å‡½æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\manager\AudioPolicyFactory.cpp]</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">AudioPolicyInterface* <span class="title">createAudioPolicyManager</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        AudioPolicyClientInterface *clientInterface)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AudioPolicyManager(clientInterface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3ã€åˆ›å»ºAudioPolicyManager"><a href="#2-3ã€åˆ›å»ºAudioPolicyManager" class="headerlink" title="2.3ã€åˆ›å»ºAudioPolicyManager()"></a>2.3ã€åˆ›å»ºAudioPolicyManager()</h5><p>æ€»ä½“æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/34-Audio-system-CreateAudioPolicyManager.png" alt="Alt text"></p><p>AudioPolicyManager çš„æ„é€ å‡½æ•°å°†è§£æéŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶ï¼Œä»è€Œè·å–åˆ°è®¾å¤‡æ‰€æ”¯æŒçš„éŸ³é¢‘è®¾å¤‡ä¿¡æ¯ï¼ˆåŒ…æ‹¬è®¾å¤‡æ˜¯å¦æ”¯æŒ Offloadã€Direct æ¨¡å¼è¾“å‡ºï¼Œå„è¾“å…¥è¾“å‡º profile æ‰€æ”¯æŒçš„é‡‡æ ·ç‡ã€é€šé“æ•°ã€æ•°æ®æ ¼å¼ç­‰ï¼‰ï¼ŒåŠ è½½å…¨éƒ¨ HwModuleï¼Œä¸ºä¹‹åˆ›å»ºæ‰€æœ‰é direct è¾“å‡ºç±»å‹çš„ outputStream å’Œæ‰€æœ‰ inputStreamï¼Œå¹¶åˆ›å»ºç›¸åº”çš„ playbackThread æˆ– recordThread çº¿ç¨‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAndroid 7.0ä¸Šçš„éŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶å¼€å§‹ä½¿ç”¨ XML æ ¼å¼ï¼Œå…¶æ–‡ä»¶åä¸º audio_policy_configuration.xmlï¼Œ</p><p>è€Œåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸ŠéŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶ä¸º audio_policy.confã€‚frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp ä¸­ AudioPolicyManager æ„é€ å‡½æ•°çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\managerdefault\AudioPolicyManager.cpp]</span><br><span class="line">AudioPolicyManager::AudioPolicyManager(AudioPolicyClientInterface *clientInterface)</span><br><span class="line">    :</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> AUDIO_POLICY_TEST</span></span><br><span class="line">    Thread(<span class="literal">false</span>),</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//AUDIO_POLICY_TEST</span></span></span><br><span class="line">    mLimitRingtoneVolume(<span class="literal">false</span>), mLastVoiceVolume(<span class="number">-1.0f</span>),</span><br><span class="line">    mA2dpSuspended(<span class="literal">false</span>),</span><br><span class="line">    mAudioPortGeneration(<span class="number">1</span>),</span><br><span class="line">    mBeaconMuteRefCount(<span class="number">0</span>),</span><br><span class="line">    mBeaconPlayingRefCount(<span class="number">0</span>),</span><br><span class="line">    mBeaconMuted(<span class="literal">false</span>),</span><br><span class="line">    mTtsOutputAvailable(<span class="literal">false</span>),</span><br><span class="line">    mMasterMono(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_XML_AUDIO_POLICY_CONF</span></span><br><span class="line">    <span class="comment">// è®¾å¤‡ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ä¸º audio_policy_configuration.xml</span></span><br><span class="line">    mVolumeCurves = <span class="keyword">new</span> VolumeCurvesCollection();</span><br><span class="line">    <span class="function">AudioPolicyConfig <span class="title">config</span><span class="params">(mHwModules, mAvailableOutputDevices, mAvailableInputDevices,</span></span></span><br><span class="line"><span class="function"><span class="params">                             mDefaultOutputDevice, speakerDrcEnabled,</span></span></span><br><span class="line">                             static_cast&lt;VolumeCurvesCollection *&gt;(mVolumeCurves));</span><br><span class="line">    PolicySerializer serializer;</span><br><span class="line">    <span class="comment">// è§£æ xml é…ç½®æ–‡ä»¶ï¼Œå°†è®¾å¤‡æ”¯æŒçš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿å­˜åœ¨ mAvailableOutputDevices å˜é‡ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// å°†è®¾å¤‡æ”¯æŒçš„éŸ³é¢‘è¾“å…¥è®¾å¤‡ä¿å­˜åœ¨ mAvailableInputDevices å˜é‡ä¸­ï¼Œå°†è®¾å¤‡çš„é»˜è®¤éŸ³é¢‘è¾“å‡º</span></span><br><span class="line">    <span class="comment">// è®¾å¤‡ä¿å­˜åœ¨ mDefaultOutputDevice å˜é‡ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (serializer.deserialize(AUDIO_POLICY_XML_CONFIG_FILE, config) != NO_ERROR) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">// è®¾å¤‡ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ä¸º audio_policy.conf</span></span><br><span class="line">    mVolumeCurves = <span class="keyword">new</span> StreamDescriptorCollection();</span><br><span class="line">    <span class="function">AudioPolicyConfig <span class="title">config</span><span class="params">(mHwModules, mAvailableOutputDevices, mAvailableInputDevices,</span></span></span><br><span class="line"><span class="function"><span class="params">                             mDefaultOutputDevice, speakerDrcEnabled)</span></span>;</span><br><span class="line">    <span class="comment">// ä¼˜å…ˆè§£æ vendor ç›®å½•ä¸‹çš„ conf é…ç½®æ–‡ä»¶ï¼Œç„¶åè§£æ device ç›®å½•ä¸‹çš„ conf é…ç½®æ–‡ä»¶ã€‚</span></span><br><span class="line">    <span class="comment">// å°†è®¾å¤‡æ”¯æŒçš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿å­˜åœ¨ mAvailableOutputDevices å˜é‡ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// å°†è®¾å¤‡æ”¯æŒçš„éŸ³é¢‘è¾“å…¥è®¾å¤‡ä¿å­˜åœ¨ mAvailableInputDevices å˜é‡ä¸­ï¼Œå°†è®¾å¤‡çš„é»˜è®¤éŸ³é¢‘è¾“å‡º</span></span><br><span class="line">    <span class="comment">// è®¾å¤‡ä¿å­˜åœ¨ mDefaultOutputDevice å˜é‡ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> ((ConfigParsingUtils::loadConfig(AUDIO_POLICY_VENDOR_CONFIG_FILE, config) != NO_ERROR) &amp;&amp;</span><br><span class="line">            (ConfigParsingUtils::loadConfig(AUDIO_POLICY_CONFIG_FILE, config) != NO_ERROR)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        ALOGE(<span class="string">"could not load audio policy configuration file, setting defaults"</span>);</span><br><span class="line">        config.setDefault();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// must be done after reading the policy (since conditionned by Speaker Drc Enabling)</span></span><br><span class="line">    mVolumeCurves-&gt;initializeVolumeCurves(speakerDrcEnabled);    <span class="comment">// è®¾ç½®éŸ³é‡è°ƒèŠ‚æ›²çº¿</span></span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">// ä¾æ¬¡åŠ è½½ HwModule å¹¶æ‰“å¼€å…¶æ‰€å« profile çš„ outputStream åŠ inputStream</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mHwModules.size(); i++) &#123;</span><br><span class="line">        mHwModules[i]-&gt;mHandle = mpClientInterface-&gt;loadHwModule(mHwModules[i]-&gt;getName());</span><br><span class="line">        <span class="keyword">if</span> (mHwModules[i]-&gt;mHandle == <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGW(<span class="string">"could not open HW module %s"</span>, mHwModules[i]-&gt;getName());</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// open all output streams needed to access attached devices</span></span><br><span class="line">        <span class="comment">// except for direct output streams that are only opened when they are actually</span></span><br><span class="line">        <span class="comment">// required by an app.</span></span><br><span class="line">        <span class="comment">// This also validates mAvailableOutputDevices list</span></span><br><span class="line">        <span class="comment">// æ‰“å¼€å½“å‰ module ä¸‹æ‰€æœ‰é direct ç±»å‹ profile çš„ outputStream</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> j = <span class="number">0</span>; j &lt; mHwModules[i]-&gt;mOutputProfiles.size(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> sp&lt;IOProfile&gt; outProfile = mHwModules[i]-&gt;mOutputProfiles[j];</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰æ“ä½œçš„ module.profile æ˜¯ direct ç±»å‹ï¼Œåˆ™ä¸ä¸ºå…¶æ‰“å¼€ outputStream</span></span><br><span class="line">            <span class="keyword">if</span> ((outProfile-&gt;getFlags() &amp; AUDIO_OUTPUT_FLAG_DIRECT) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ....</span><br><span class="line">            <span class="comment">// è·å–é‡‡æ ·ç‡ã€é€šé“æ•°ã€æ•°æ®æ ¼å¼ç­‰å„éŸ³é¢‘å‚æ•°</span></span><br><span class="line">            sp&lt;SwAudioOutputDescriptor&gt; outputDesc = <span class="keyword">new</span> SwAudioOutputDescriptor(outProfile,</span><br><span class="line">                                                                                 mpClientInterface);</span><br><span class="line">            <span class="keyword">const</span> DeviceVector &amp;supportedDevices = outProfile-&gt;getSupportedDevices();</span><br><span class="line">            <span class="keyword">const</span> DeviceVector &amp;devicesForType = supportedDevices.getDevicesFromType(profileType);</span><br><span class="line">            String8 address = devicesForType.size() &gt; <span class="number">0</span> ? devicesForType.itemAt(<span class="number">0</span>)-&gt;mAddress</span><br><span class="line">                    : String8(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            outputDesc-&gt;mDevice = profileType;</span><br><span class="line">            <span class="keyword">audio_config_t</span> config = AUDIO_CONFIG_INITIALIZER;</span><br><span class="line">            config.sample_rate = outputDesc-&gt;mSamplingRate;</span><br><span class="line">            config.channel_mask = outputDesc-&gt;mChannelMask;</span><br><span class="line">            config.format = outputDesc-&gt;mFormat;</span><br><span class="line">            <span class="keyword">audio_io_handle_t</span> output = AUDIO_IO_HANDLE_NONE;</span><br><span class="line">            <span class="comment">// ä¸ºå½“å‰ module.profile æ‰“å¼€å¯¹åº”çš„ outputStream å¹¶åˆ›å»º playbackThread çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">status_t</span> status = mpClientInterface-&gt;openOutput(outProfile-&gt;getModuleHandle(),</span><br><span class="line">                                                            &amp;output,</span><br><span class="line">                                                            &amp;config,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mDevice,</span><br><span class="line">                                                            address,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mLatency,</span><br><span class="line">                                                            outputDesc-&gt;mFlags);</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// open input streams needed to access attached devices to validate</span></span><br><span class="line">        <span class="comment">// mAvailableInputDevices list</span></span><br><span class="line">        <span class="comment">// æ‰“å¼€å½“å‰ module ä¸‹æ‰€æœ‰ profile çš„ inputStream</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> j = <span class="number">0</span>; j &lt; mHwModules[i]-&gt;mInputProfiles.size(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> sp&lt;IOProfile&gt; inProfile = mHwModules[i]-&gt;mInputProfiles[j];</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">            sp&lt;AudioInputDescriptor&gt; inputDesc =</span><br><span class="line">                    <span class="keyword">new</span> AudioInputDescriptor(inProfile);</span><br><span class="line"></span><br><span class="line">            inputDesc-&gt;mDevice = profileType;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–é‡‡æ ·ç‡ã€é€šé“æ•°ã€æ•°æ®æ ¼å¼ç­‰å„éŸ³é¢‘å‚æ•°</span></span><br><span class="line">            <span class="comment">// find the address</span></span><br><span class="line">            DeviceVector inputDevices = mAvailableInputDevices.getDevicesFromType(profileType);</span><br><span class="line">            <span class="comment">//   the inputs vector must be of size 1, but we don't want to crash here</span></span><br><span class="line">            String8 address = inputDevices.size() &gt; <span class="number">0</span> ? inputDevices.itemAt(<span class="number">0</span>)-&gt;mAddress</span><br><span class="line">                    : String8(<span class="string">""</span>);</span><br><span class="line">            ALOGV(<span class="string">"  for input device 0x%x using address %s"</span>, profileType, address.<span class="built_in">string</span>());</span><br><span class="line">            ALOGE_IF(inputDevices.size() == <span class="number">0</span>, <span class="string">"Input device list is empty!"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">audio_config_t</span> config = AUDIO_CONFIG_INITIALIZER;</span><br><span class="line">            config.sample_rate = inputDesc-&gt;mSamplingRate;</span><br><span class="line">            config.channel_mask = inputDesc-&gt;mChannelMask;</span><br><span class="line">            config.format = inputDesc-&gt;mFormat;</span><br><span class="line">            <span class="keyword">audio_io_handle_t</span> input = AUDIO_IO_HANDLE_NONE;</span><br><span class="line">            <span class="comment">// ä¸ºå½“å‰ module.profile æ‰“å¼€å¯¹åº”çš„ inputStream å¹¶åˆ›å»º recordThread çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">status_t</span> status = mpClientInterface-&gt;openInput(inProfile-&gt;getModuleHandle(),</span><br><span class="line">                                                           &amp;input,</span><br><span class="line">                                                           &amp;config,</span><br><span class="line">                                                           &amp;inputDesc-&gt;mDevice,</span><br><span class="line">                                                           address,</span><br><span class="line">                                                           AUDIO_SOURCE_MIC,</span><br><span class="line">                                                           AUDIO_INPUT_FLAG_NONE);</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    updateDevicesAndOutputs();    <span class="comment">// æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯</span></span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AudioPolicyManagerå¯¹è±¡æ„é€ è¿‡ç¨‹ä¸­ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><p>1ã€  åŠ è½½audio_policy_configuration.xmlæˆ–è€…audio_policy.confé…ç½®æ–‡ä»¶</p><p>2ã€ åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves(speakerDrcEnabled)</p><p>3ã€  åŠ è½½audio policyç¡¬ä»¶æŠ½è±¡åº“ï¼šmpClientInterface-&gt;loadHwModule(mHwModules[i]-&gt;mName)</p><p>4ã€  æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream  ï¼š mpClientInterface-&gt;openOutput()ã€mpClientInterface-&gt;openInput</p><p>5ã€   æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs()</p><h5 id="2-3-1ã€åŠ è½½audio-policy-configuration-xmlæˆ–è€…audio-policy-confé…ç½®æ–‡ä»¶"><a href="#2-3-1ã€åŠ è½½audio-policy-configuration-xmlæˆ–è€…audio-policy-confé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.1ã€åŠ è½½audio_policy_configuration.xmlæˆ–è€…audio_policy.confé…ç½®æ–‡ä»¶"></a>2.3.1ã€åŠ è½½audio_policy_configuration.xmlæˆ–è€…audio_policy.confé…ç½®æ–‡ä»¶</h5><p><a href="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/audio_policy_configuration.xml" target="_blank" rel="noopener">audio_policy_configuration.xml</a><br>audio_policy.confåŒæ—¶å®šä¹‰äº†å¤šä¸ªaudio æ¥å£ï¼Œæ¯ä¸€ä¸ªaudio æ¥å£åŒ…å«è‹¥å¹²outputå’Œinputï¼Œè€Œæ¯ä¸ªoutputå’ŒinputåˆåŒæ—¶æ”¯æŒå¤šç§è¾“å…¥è¾“å‡ºæ¨¡å¼ï¼Œæ¯ç§è¾“å…¥è¾“å‡ºæ¨¡å¼åˆæ”¯æŒè‹¥å¹²ç§è®¾å¤‡ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/35-Audio-system-audio_policy.conf.png" alt="Alt text"></p><h5 id="2-3-2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves-speakerDrcEnabled"><a href="#2-3-2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves-speakerDrcEnabled" class="headerlink" title="2.3.2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves(speakerDrcEnabled)"></a>2.3.2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves(speakerDrcEnabled)</h5><p>åœ¨AudioPolicyManagerBaseä¸­å®šä¹‰äº†éŸ³é‡è°ƒèŠ‚å¯¹åº”çš„éŸ³é¢‘æµæè¿°ç¬¦æ•°ç»„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//audio_policy_volumes.xml</span><br><span class="line">const AudioPolicyManagerBase::VolumeCurvePoint</span><br><span class="line">            *AudioPolicyManagerBase::sVolumeProfiles[AudioSystem::NUM_STREAM_TYPES]</span><br><span class="line">                                                   [AudioPolicyManagerBase::DEVICE_CATEGORY_CNT] = &#123;</span><br><span class="line">    &#123; // AUDIO_STREAM_VOICE_CALL</span><br><span class="line">        sDefaultVoiceVolumeCurve, // DEVICE_CATEGORY_HEADSET</span><br><span class="line">        sSpeakerVoiceVolumeCurve, // DEVICE_CATEGORY_SPEAKER</span><br><span class="line">        sDefaultVoiceVolumeCurve  // DEVICE_CATEGORY_EARPIECE</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; // AUDIO_STREAM_SYSTEM</span><br><span class="line">        sHeadsetSystemVolumeCurve, // DEVICE_CATEGORY_HEADSET</span><br><span class="line">        sDefaultSystemVolumeCurve, // DEVICE_CATEGORY_SPEAKER</span><br><span class="line">        sDefaultSystemVolumeCurve  // DEVICE_CATEGORY_EARPIECE</span><br><span class="line">    &#125;,</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>initializeVolumeCurves()å‡½æ•°å°±æ˜¯åˆå§‹åŒ–è¯¥æ•°ç»„å…ƒç´ ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;]</span><br><span class="line"><span class="keyword">void</span> AudioPolicyManagerBase::initializeVolumeCurves()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; AudioSystem::NUM_STREAM_TYPES; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; DEVICE_CATEGORY_CNT; j++) &#123;</span><br><span class="line">            mStreams[i].mVolumeCurve[j] =</span><br><span class="line">                    sVolumeProfiles[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check availability of DRC on speaker path: if available, override some of the speaker curves</span></span><br><span class="line">    <span class="keyword">if</span> (mSpeakerDrcEnabled) &#123;</span><br><span class="line">        mStreams[AUDIO_STREAM_SYSTEM].mVolumeCurve[DEVICE_CATEGORY_SPEAKER] =</span><br><span class="line">                sDefaultSystemVolumeCurveDrc;</span><br><span class="line">        mStreams[AUDIO_STREAM_RING].mVolumeCurve[DEVICE_CATEGORY_SPEAKER] =</span><br><span class="line">                sSpeakerSonificationVolumeCurveDrc;</span><br><span class="line">        mStreams[AUDIO_STREAM_ALARM].mVolumeCurve[DEVICE_CATEGORY_SPEAKER] =</span><br><span class="line">                sSpeakerSonificationVolumeCurveDrc;</span><br><span class="line">        mStreams[AUDIO_STREAM_NOTIFICATION].mVolumeCurve[DEVICE_CATEGORY_SPEAKER] =</span><br><span class="line">                sSpeakerSonificationVolumeCurveDrc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-3ã€åŠ è½½audio-policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule"><a href="#2-3-3ã€åŠ è½½audio-policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule" class="headerlink" title="2.3.3ã€åŠ è½½audio policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule()"></a>2.3.3ã€åŠ è½½audio policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule()</h5><p>æˆ‘ä»¬ç›´æ¥åˆ†æAudioFlinger::loadHwModule_l()ä¸­çš„load_audio_interface()å‡½æ•°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static int load_audio_interface(const char *if_name, audio_hw_device_t **dev)</span><br><span class="line">&#123;</span><br><span class="line">    const hw_module_t *mod;</span><br><span class="line">    int rc;</span><br><span class="line">    //æ ¹æ®åå­—åŠ è½½audio_moduleæ¨¡å—  </span><br><span class="line">    rc = hw_get_module_by_class(AUDIO_HARDWARE_MODULE_ID, if_name, &amp;mod);</span><br><span class="line">    ALOGE_IF(rc, &quot;%s couldn&apos;t load audio hw module %s.%s (%s)&quot;, __func__,</span><br><span class="line">                 AUDIO_HARDWARE_MODULE_ID, if_name, strerror(-rc));</span><br><span class="line">    //æ‰“å¼€audio_deviceè®¾å¤‡</span><br><span class="line">    rc = audio_hw_device_open(mod, dev);</span><br><span class="line">    ALOGE_IF(rc, &quot;%s couldn&apos;t open audio hw device in %s.%s (%s)&quot;, __func__,</span><br><span class="line">                 AUDIO_HARDWARE_MODULE_ID, if_name, strerror(-rc));</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">audio_hw_device_open</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       struct audio_hw_device** device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">module</span>-&gt;methods-&gt;open(<span class="keyword">module</span>, AUDIO_HARDWARE_INTERFACE,</span><br><span class="line">                                 (struct <span class="keyword">hw_device_t</span>**)device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;\hardware\libhardware_legacy\audio\audio_hw_hal.cpp]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">static int legacy_adev_open(const hw_module_t* module, const char* name,</span><br><span class="line">                            hw_device_t** device)</span><br><span class="line">&#123;</span><br><span class="line">    struct legacy_audio_device *ladev;</span><br><span class="line">    int ret;</span><br><span class="line">    ladev = (struct legacy_audio_device *)calloc(1, sizeof(*ladev));</span><br><span class="line"></span><br><span class="line">    ladev-&gt;device.common.tag = HARDWARE_DEVICE_TAG;</span><br><span class="line">    ladev-&gt;device.common.version = AUDIO_DEVICE_API_VERSION_2_0;</span><br><span class="line">    ladev-&gt;device.common.module = const_cast&lt;hw_module_t*&gt;(module);</span><br><span class="line">    ladev-&gt;device.common.close = legacy_adev_close;</span><br><span class="line"></span><br><span class="line">    ladev-&gt;device.init_check = adev_init_check;</span><br><span class="line">    ladev-&gt;device.set_voice_volume = adev_set_voice_volume;</span><br><span class="line">    ladev-&gt;device.set_master_volume = adev_set_master_volume;</span><br><span class="line">    ladev-&gt;device.get_master_volume = adev_get_master_volume;</span><br><span class="line">    ladev-&gt;device.set_mode = adev_set_mode;</span><br><span class="line">    ladev-&gt;device.set_mic_mute = adev_set_mic_mute;</span><br><span class="line">    ladev-&gt;device.get_mic_mute = adev_get_mic_mute;</span><br><span class="line">    ladev-&gt;device.set_parameters = adev_set_parameters;</span><br><span class="line">    ladev-&gt;device.get_parameters = adev_get_parameters;</span><br><span class="line">    ladev-&gt;device.get_input_buffer_size = adev_get_input_buffer_size;</span><br><span class="line">    ladev-&gt;device.open_output_stream = adev_open_output_stream;</span><br><span class="line">    ladev-&gt;device.close_output_stream = adev_close_output_stream;</span><br><span class="line">    ladev-&gt;device.open_input_stream = adev_open_input_stream;</span><br><span class="line">    ladev-&gt;device.close_input_stream = adev_close_input_stream;</span><br><span class="line">    ladev-&gt;device.dump = adev_dump;</span><br><span class="line"></span><br><span class="line">    ladev-&gt;hwif = createAudioHardware();</span><br><span class="line"></span><br><span class="line">    *device = &amp;ladev-&gt;device.common;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤å°±åŠ è½½å®Œç³»ç»Ÿå®šä¹‰çš„æ‰€æœ‰éŸ³é¢‘æ¥å£ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„æ•°æ®å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šâ€™<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/36-Audio-system-audiohwdevice.png" alt="Alt text"></p><h5 id="2-3-4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream"><a href="#2-3-4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream" class="headerlink" title="2.3.4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream"></a>2.3.4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream</h5><p>å‰é¢ä¸€å°èŠ‚å·²ç»åˆ†æè¿‡outputStreamï¼Œè¿™é‡Œä¸å†åˆ†æäº†<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/37-Audio-system-AudioStreamOut.png" alt="Alt text"></p><p>æ‰“å¼€éŸ³é¢‘è¾“å‡ºåï¼Œåœ¨AudioFlingerä¸AudioPolicyServiceä¸­çš„è¡¨ç°å½¢å¼å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/38-Audio-system-audiohwdevice-openoutput.png" alt="Alt text"></p><p>æ‰“å¼€éŸ³é¢‘è¾“å…¥:<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/39-Audio-system-AudioStreamIn.png" alt="Alt text"><br>æ‰“å¼€éŸ³é¢‘è¾“å…¥åï¼Œåœ¨AudioFlingerä¸AudioPolicyServiceä¸­çš„è¡¨ç°å½¢å¼å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/310-Audio-system-audiohwdevice-openinput.png" alt="Alt text"></p><h5 id="2-3-5ã€-æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs"><a href="#2-3-5ã€-æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs" class="headerlink" title="2.3.5ã€ æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs()"></a>2.3.5ã€ æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\managerdefault\AudioPolicyManager.cpp]</span><br><span class="line"><span class="keyword">void</span> AudioPolicyManager::updateDevicesAndOutputs()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_STRATEGIES; i++) &#123;</span><br><span class="line">        mDeviceForStrategy[i] = getDeviceForStrategy((routing_strategy)i, <span class="literal">false</span> <span class="comment">/*fromCache*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mPreviousOutputs = mOutputs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-4ã€æ€»ç»“"><a href="#2-4ã€æ€»ç»“" class="headerlink" title="2.4ã€æ€»ç»“"></a>2.4ã€æ€»ç»“</h5><p>-&gt;æ‰“å¼€éŸ³é¢‘è¾“å‡ºæ—¶åˆ›å»ºä¸€ä¸ªaudio_stream_outé€šé“ï¼Œå¹¶åˆ›å»ºAudioStreamOutå¯¹è±¡ä»¥åŠæ–°å»ºPlaybackThreadæ’­æ”¾çº¿ç¨‹ã€‚</p><p>-&gt; æ‰“å¼€éŸ³é¢‘è¾“å…¥æ—¶åˆ›å»ºä¸€ä¸ªaudio_stream_iné€šé“ï¼Œå¹¶åˆ›å»ºAudioStreamInå¯¹è±¡ä»¥åŠåˆ›å»ºRecordThreadå½•éŸ³çº¿ç¨‹ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/311-Audio-system-audio_stream_in-out.png" alt="Alt text"></p><h4 id="ä¸‰-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack"><a href="#ä¸‰-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack" class="headerlink" title="(ä¸‰)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack"></a>(ä¸‰)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack</h4><p>ç°åœ¨æˆ‘ä»¬å¼€å§‹åˆ†æ AudioTrack çš„åˆ›å»ºè¿‡ç¨‹ï¼Œç‰¹åˆ«ç•™æ„ AudioTrack ä¸ AudioFlinger å¦‚ä½•å»ºç«‹è”ç³»ã€ç”¨äº AudioTrack ä¸ AudioFlinger äº¤æ¢æ•°æ®çš„åŒ¿åå…±äº«å†…å­˜å¦‚ä½•åˆ†é…ã€‚</p><h5 id="3-1-AudioTrack-amp-AudioFlinger-ç›¸å…³ç±»"><a href="#3-1-AudioTrack-amp-AudioFlinger-ç›¸å…³ç±»" class="headerlink" title="3.1. AudioTrack &amp; AudioFlinger ç›¸å…³ç±»"></a>3.1. AudioTrack &amp; AudioFlinger ç›¸å…³ç±»</h5><p>æ—¶åºå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/312-Audio-system-create_audiotrack-flow.png" alt="Alt text"></p><p>é¦–å…ˆçœ‹ä¸€ä¸‹ AudioTrack &amp; AudioFlinger çš„ç±»å›¾ï¼Œç†ä¸€ä¸‹ AudioFlinger çš„ä¸»è¦ç±»åŠå…¶å…³ç³»ã€AudioTrack ä¸ AudioFlinger ä¹‹é—´çš„è”ç³»ï¼Œåé¢å°†ä»¥è¯¥å›¾ä¸ºè„‰ç»œå±•å¼€åˆ†æã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/313-Audio-system-create_audiotrack.jpg" alt="Alt text"></p><p>â˜¯ AudioFlinger::PlaybackThreadï¼šå›æ”¾çº¿ç¨‹åŸºç±»ï¼Œä¸åŒè¾“å‡ºæ ‡è¯†çš„éŸ³é¢‘æµå¯¹åº”ä¸åŒç±»å‹çš„ PlaybackThread å®ä¾‹ï¼ˆåˆ†ä¸ºå››ç§ï¼šMixerThreadã€DirectOutputThreadã€DuplicatingThreadã€OffloadThreadï¼‰ï¼Œå…·ä½“è§ 3.4. AudioFlinger å›æ”¾å½•åˆ¶çº¿ç¨‹ å°èŠ‚ï¼Œæ‰€æœ‰çš„ PlaybackThread å®ä¾‹éƒ½ä¼šæ·»åŠ åˆ° AudioFlinger.mPlaybackThreads å‘é‡ä¸­ï¼›è¿™ä¸ªå‘é‡çš„å®šä¹‰ï¼š DefaultKeyedVector&lt; audio_io_handle_t, sp<playbackthread> &gt; mPlaybackThreads;ï¼Œå¯è§ audio_io_handle_t æ˜¯ä¸ PlaybackThread æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œç”±å·²çŸ¥çš„ audio_io_handle_t å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„ PlaybackThreadï¼›audio_io_handle_t åœ¨åˆ›å»º PlaybackThread æ—¶ç”±ç³»ç»Ÿåˆ†é…ï¼Œè¿™ä¸ªå€¼æ˜¯å…¨å±€å”¯ä¸€çš„<br>â˜¯ AudioFlinger::PlaybackThread::Trackï¼šéŸ³é¢‘æµç®¡ç†ç±»ï¼Œåˆ›å»ºä¸€å—åŒ¿åå…±äº«å†…å­˜ç”¨äº AudioTrack ä¸ AudioFlinger ä¹‹é—´çš„æ•°æ®äº¤æ¢ï¼ˆæ–¹ä¾¿èµ·è§ï¼Œè¿™å—åŒ¿åå…±äº«å†…å­˜ï¼Œä»¥åå‡ç®€å•ç§°ä¸º FIFOï¼‰ï¼ŒåŒæ—¶å®ç° start()ã€stop()ã€pause() ç­‰éŸ³é¢‘æµå¸¸ç”¨æ§åˆ¶æ‰‹æ®µï¼›æ³¨æ„ï¼Œå¤šä¸ª Track å¯¹è±¡å¯èƒ½éƒ½æ³¨å†Œåˆ°åŒä¸€ä¸ª PlaybackThread ä¸­ï¼ˆå°¤å…¶å¯¹äº MixerThread è€Œè¨€ï¼Œä¸€ä¸ª MixerThread å¾€å¾€æŒ‚ç€å¤šä¸ª Track å¯¹è±¡ï¼‰ï¼Œè¿™å¤šä¸ª Track å¯¹è±¡éƒ½ä¼šæ·»åŠ åˆ° PlaybackThread.mTracks å‘é‡ä¸­ç»Ÿä¸€ç®¡ç†<br>â˜¯ AudioFlinger::TrackHandleï¼šTrack å¯¹è±¡åªè´Ÿè´£éŸ³é¢‘æµç®¡ç†ä¸šåŠ¡ï¼Œå¯¹å¤–å¹¶æ²¡æœ‰æä¾›è·¨è¿›ç¨‹çš„ Binder è°ƒç”¨æ¥å£ï¼Œè€Œåº”ç”¨è¿›ç¨‹åˆéœ€è¦å¯¹éŸ³é¢‘æµè¿›è¡Œæ§åˆ¶ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå¯¹è±¡æ¥ä»£ç† Track çš„è·¨è¿›ç¨‹é€šè®¯ï¼Œè¿™ä¸ªè§’è‰²å°±æ˜¯ TrackHandleï¼ŒAudioTrack é€šè¿‡å®ƒä¸ Track äº¤äº’<br>â˜¯ AudioTrackï¼šAndroid éŸ³é¢‘ç³»ç»Ÿå¯¹å¤–æä¾›çš„ä¸€ä¸ª API ç±»ï¼Œè´Ÿè´£éŸ³é¢‘æµæ•°æ®è¾“å‡ºï¼›æ¯ä¸ªéŸ³é¢‘æµå¯¹åº”ç€ä¸€ä¸ª AudioTrack å®ä¾‹ï¼Œä¸åŒè¾“å‡ºæ ‡è¯†çš„ AudioTrack ä¼šåŒ¹é…åˆ°ä¸åŒçš„ AudioFlinger::PlaybackThreadï¼›AudioTrack ä¸ AudioFlinger::PlaybackThread ä¹‹é—´é€šè¿‡ FIFO æ¥äº¤æ¢éŸ³é¢‘æ•°æ®ï¼ŒAudioTrack æ˜¯ FIFO ç”Ÿäº§è€…ï¼ŒAudioFlinger::PlaybackThread æ˜¯ FIFO æ¶ˆè´¹è€…<br>â˜¯ AudioTrack::AudioTrackThreadï¼šæ•°æ®ä¼ è¾“æ¨¡å¼ä¸º TRANSFER_CALLBACK æ—¶ï¼Œéœ€è¦åˆ›å»ºè¯¥çº¿ç¨‹ï¼Œå®ƒé€šè¿‡è°ƒç”¨ audioCallback å›è°ƒå‡½æ•°ä¸»åŠ¨ä»ç”¨æˆ·è¿›ç¨‹å¤„ç´¢å–æ•°æ®å¹¶å¡«å……åˆ° FIFO ä¸Šï¼›æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º TRANSFER_SYNC æ—¶ï¼Œåˆ™ä¸éœ€è¦åˆ›å»ºè¿™ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºç”¨æˆ·è¿›ç¨‹ä¼šæŒç»­è°ƒç”¨ AudioTrack.write() å¡«å……æ•°æ®åˆ° FIFOï¼›æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º TRANSFER_SHARED æ—¶ï¼Œä¹Ÿä¸éœ€è¦åˆ›å»ºè¿™ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºç”¨æˆ·è¿›ç¨‹ä¼šåˆ›å»ºä¸€å—åŒ¿åå…±äº«å†…å­˜ï¼Œå¹¶æŠŠè¦æ’­æ”¾çš„éŸ³é¢‘æ•°æ®ä¸€æ¬¡æ€§æ‹·è´åˆ°è¿™å—åŒ¿åå…±äº«å†…å­˜ä¸Šäº†<br>â˜¯ IAudioTrackï¼šIAudioTrack æ˜¯é“¾ç»“ AudioTrack ä¸ AudioFlinger çš„æ¡¥æ¢ï¼›å®ƒåœ¨ AudioTrack ç«¯çš„å¯¹è±¡æ˜¯ BpAudioTrackï¼Œåœ¨ AudioFlinger ç«¯çš„å¯¹è±¡æ˜¯ BnAudioTrackï¼Œä»å›¾ä¸­ä¸éš¾çœ‹å‡ºï¼ŒAudioFlinger::TrackHandle ç»§æ‰¿è‡ª BnAudioTrackï¼Œè€Œ AudioFlinger::TrackHandle æ°æ°æ˜¯AudioFlinger::PlaybackThread::Track çš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ AudioTrack å¾—åˆ° IAudioTrack å®ä¾‹åï¼Œå°±å¯ä»¥è°ƒç”¨ IAudioTrack çš„æ¥å£ä¸ AudioFlinger::PlaybackThread::Track äº¤äº’</playbackthread></p><p><strong>audio_io_handle_tï¼š</strong></p><p>è¿™é‡Œå†è¯¦ç»†è¯´æ˜ä¸€ä¸‹ audio_io_handle_tï¼Œå®ƒæ˜¯ AudioTrack/AudioRecord/AudioSystemã€AudioFlingerã€AudioPolicyManager ä¹‹é—´ä¸€ä¸ªé‡è¦çš„é“¾ç»“ç‚¹ã€‚3.4. AudioFlinger å›æ”¾å½•åˆ¶çº¿ç¨‹ å°èŠ‚åœ¨ AudioFlinger::openOutput_l() æ³¨é‡Šä¸­å¤§è‡´è¯´æ˜äº†å®ƒçš„æ¥å†åŠå…¶ä½œç”¨ï¼Œç°åœ¨å›é¡¾ä¸‹ï¼šå½“æ‰“å¼€è¾“å‡ºæµè®¾å¤‡åŠåˆ›å»º PlaybackThread æ—¶ï¼Œç³»ç»Ÿä¼šåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å€¼ä½œä¸º audio_io_handle_tï¼Œå¹¶æŠŠ audio_io_handle_t å’Œ PlaybackThread æ·»åŠ åˆ°é”®å€¼å¯¹å‘é‡ mPlaybackThreads ä¸­ï¼Œç”±äº audio_io_handle_t å’Œ PlaybackThread æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œå› æ­¤æ‹¿åˆ°ä¸€ä¸ª audio_io_handle_tï¼Œå°±èƒ½éå†é”®å€¼å¯¹å‘é‡ mPlaybackThreads æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThreadï¼Œå¯ä»¥ç®€å•ç†è§£ audio_io_handle_t ä¸º PlaybackThread çš„ç´¢å¼•å·æˆ–çº¿ç¨‹ idã€‚ç”±äº audio_io_handle_t å…·æœ‰ PlaybackThread ç´¢å¼•ç‰¹æ€§ï¼Œæ‰€ä»¥åº”ç”¨è¿›ç¨‹æƒ³è·å– PlaybackThread æŸäº›ä¿¡æ¯çš„è¯ï¼Œåªéœ€è¦ä¼ å…¥å¯¹åº”çš„ audio_io_handle_t å³å¯ã€‚ä¾‹å¦‚ AudioFlinger::format(audio_io_handle_t output)ï¼Œè¿™æ˜¯ AudioFlinger çš„ä¸€ä¸ªæœåŠ¡æ¥å£ï¼Œç”¨æˆ·è¿›ç¨‹å¯ä»¥é€šè¿‡è¯¥æ¥å£è·å–æŸä¸ª PlaybackThread é…ç½®çš„éŸ³é¢‘æ ¼å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line"><span class="keyword">audio_format_t</span> AudioFlinger::format(<span class="keyword">audio_io_handle_t</span> output) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="comment">// checkPlaybackThread_l() æ ¹æ®ä¼ å…¥çš„ audio_io_handle_tï¼Œä»é”®å€¼å¯¹å‘é‡</span></span><br><span class="line">    <span class="comment">// mPlaybackThreads ä¸­æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThread</span></span><br><span class="line">    PlaybackThread *thread = checkPlaybackThread_l(output);</span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"format() unknown thread %d"</span>, output);</span><br><span class="line">        <span class="keyword">return</span> AUDIO_FORMAT_INVALID;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> thread-&gt;format();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AudioFlinger::PlaybackThread *AudioFlinger::checkPlaybackThread_l(<span class="keyword">audio_io_handle_t</span> output) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> mPlaybackThreads.valueFor(output).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-2-AudioTrack-æ„é€ è¿‡ç¨‹"><a href="#3-2-AudioTrack-æ„é€ è¿‡ç¨‹" class="headerlink" title="3.2. AudioTrack æ„é€ è¿‡ç¨‹"></a>3.2. AudioTrack æ„é€ è¿‡ç¨‹</h5><p>å½“æˆ‘ä»¬æ„é€ ä¸€ä¸ª AudioTrack å®ä¾‹æ—¶ï¼ˆä»¥ MODE_STREAM/TRANSFER_SYNC æ¨¡å¼ä¸ºä¾‹ï¼Œè¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ¨¡å¼äº†ï¼Œæ­¤æ—¶ sharedBuffer ä¸ºç©ºï¼‰ï¼Œç³»ç»Ÿéƒ½å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿé˜è¿°ä¸‹å¤§è‡´æµç¨‹ï¼š</p><p>å¦‚æœ cbfï¼ˆaudioCallback å›è°ƒå‡½æ•°ï¼‰éç©ºï¼Œé‚£ä¹ˆåˆ›å»º AudioTrackThread çº¿ç¨‹å¤„ç† audioCallback å›è°ƒå‡½æ•°ï¼ˆMODE_STREAM æ¨¡å¼æ—¶ï¼Œcbf ä¸ºç©ºï¼‰ï¼›<br>æ ¹æ® streamTypeï¼ˆæµç±»å‹ï¼‰ã€flagsï¼ˆè¾“å‡ºæ ‡è¯†ï¼‰ç­‰å‚æ•°è°ƒç”¨ AudioSystem::getOutputForAttr()ï¼›ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œè¿›å…¥ AudioPolicyManager::getOutputForDevice()ï¼š<br>å¦‚æœè¾“å‡ºæ ‡è¯†ç½®äº† AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD æˆ– AUDIO_OUTPUT_FLAG_DIRECTï¼Œé‚£ä¹ˆæœ€ç»ˆè°ƒç”¨ AudioFlinger::openOutput() æ‰“å¼€è¾“å‡ºæ ‡è¯†å¯¹åº”çš„è¾“å‡ºæµè®¾å¤‡å¹¶åˆ›å»ºç›¸åº”çš„ PlaybackThreadï¼Œä¿å­˜è¯¥ PlaybackThread å¯¹åº”çš„ audio_io_handle_t ç»™ AudioTrackï¼›<br>å¦‚æœè¾“å‡ºæ ‡è¯†æ˜¯å…¶ä»–ç±»å‹ï¼Œé‚£ä¹ˆæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸€ä¸ªè¾“å‡ºæµè®¾å¤‡å’Œ PlaybackThreadï¼Œå¹¶ä¿å­˜è¯¥ PlaybackThread å¯¹åº”çš„ audio_io_handle_t ç»™ AudioTrackï¼›åˆ«å¿˜äº†åœ¨ 3.4. AudioFlinger å›æ”¾å½•åˆ¶çº¿ç¨‹ å°èŠ‚ä¸­æåˆ°ï¼šç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå°±å·²ç»æ‰“å¼€ primary_outã€low_latencyã€deep_buffer è¿™ä¸‰ç§è¾“å‡ºæµè®¾å¤‡ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ PlaybackThread äº†ï¼›<br>é€šè¿‡ Binder æœºåˆ¶è°ƒç”¨ AudioFlinger::createTrack()ï¼ˆæ³¨æ„ step2 ä¸­ AudioTrack å·²ç»æ‹¿åˆ°ä¸€ä¸ª audio_io_handle_t äº†ï¼Œæ­¤æ—¶æŠŠè¿™ä¸ª audio_io_handle_t ä¼ å…¥ç»™ createTrack()ï¼‰ï¼š<br>æ ¹æ®ä¼ å…¥çš„ audio_io_handle_t æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThreadï¼›<br>PlaybackThread æ–°å»ºä¸€ä¸ªéŸ³é¢‘æµç®¡ç†å¯¹è±¡ Trackï¼›Track æ„é€ æ—¶ä¼šåˆ†é…ä¸€å—åŒ¿åå…±äº«å†…å­˜ç”¨äº AudioFlinger ä¸ AudioTrack çš„æ•°æ®äº¤æ¢ç¼“å†²åŒºï¼ˆFIFOï¼‰åŠå…¶æ§åˆ¶å—ï¼ˆaudio_track_cblk_tï¼‰ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª AudioTrackServerProxy å¯¹è±¡ï¼ˆPlaybackThread å°†ä½¿ç”¨å®ƒä» FIFO ä¸Šå–å¾—å¯è¯»æ•°æ®çš„ä½ç½®ï¼‰ï¼›<br>æœ€åæ–°å»ºä¸€ä¸ª Track çš„é€šè®¯ä»£ç† TrackHandleï¼Œå¹¶ä»¥ IAudioTrack ä½œä¸ºè¿”å›å€¼ç»™ AudioTrackï¼ˆTrackHandleã€BnAudioTrackã€BpAudioTrackã€IAudioTrack çš„å…³ç³»è§ä¸Šä¸€ä¸ªå°èŠ‚ï¼‰ï¼›<br>é€šè¿‡ IAudioTrack æ¥å£ï¼Œå–å¾— AudioFlinger ä¸­çš„ FIFO æ§åˆ¶å—ï¼ˆaudio_track_cblk_tï¼‰ï¼Œç”±æ­¤å†è®¡ç®—å¾—åˆ° FIFO çš„é¦–åœ°å€ï¼›<br>åˆ›å»ºä¸€ä¸ª AudioTrackClientProxy å¯¹è±¡ï¼ˆAudioTrack å°†ä½¿ç”¨å®ƒä» FIFO ä¸Šå–å¾—å¯ç”¨ç©ºé—´çš„ä½ç½®ï¼‰ï¼›<br>AudioTrack ç”±æ­¤å»ºç«‹äº†å’Œ AudioFlinger çš„å…¨éƒ¨è”ç³»å·¥ä½œï¼š</p><p>é€šè¿‡ IAudioTrack æ¥å£å¯ä»¥æ§åˆ¶è¯¥éŸ³è½¨çš„çŠ¶æ€ï¼Œä¾‹å¦‚ startã€stopã€pause<br>æŒç»­å†™å…¥æ•°æ®åˆ° FIFO ä¸Šï¼Œå®ç°éŸ³é¢‘è¿ç»­æ’­æ”¾<br>é€šè¿‡ audio_io_handle_tï¼Œå¯ä»¥æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThreadï¼Œä»è€ŒæŸ¥è¯¢è¯¥ PlaybackThread çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æ‰€è®¾ç½®çš„é‡‡æ ·ç‡ã€æ ¼å¼ç­‰ç­‰<br>æ„é€  1 ä¸ª AudioTrack å®ä¾‹æ—¶ï¼ŒAudioFlinger ä¼šæœ‰ 1 ä¸ª PlaybackThread å®ä¾‹ã€1 ä¸ª Track å®ä¾‹ã€1 ä¸ª TrackHandle å®ä¾‹ã€1 ä¸ª AudioTrackServerProxy å®ä¾‹ã€1 å— FIFO ä¸ä¹‹å¯¹åº”ã€‚</p><p>å½“åŒæ—¶æ„é€  1 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_PRIMARYã€1 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_FASTã€3 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_DEEP_BUFFERã€1 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOADã€1 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_DIRECT æ—¶ï¼ˆäº‹å®ä¸Šï¼ŒAndroid éŸ³é¢‘ç­–ç•¥ä¸å…è®¸å‡ºç°è¿™ç§æƒ…å½¢çš„ï¼‰ï¼ŒAudioFlinger æ‹¥æœ‰çš„ PlaybackThreadã€Trackã€TrackHandle å®ä¾‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/314-Audio-system-PlaybackThread-Track-TrackHandle.png" alt="Alt text"></p><p>æœ€åé™„ä¸Šç›¸å…³ä»£ç çš„æµç¨‹åˆ†æï¼Œæˆ‘æœ¬æ„æ˜¯ä¸å¤šè´´ä»£ç çš„ï¼Œä½†ä¸ä¸Šä»£ç æ€»è§‰å¾—ç¼ºç‚¹ä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘å°½é‡æŠŠä»£ç ç²¾ç®€ï¼Œæå–ä¸»å¹²ï¼Œå¿½ç•¥ç»†èŠ‚ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmedia\AudioTrack.cpp]</span><br><span class="line">AudioTrack::AudioTrack(</span><br><span class="line">        <span class="keyword">audio_stream_type_t</span> streamType,    <span class="comment">// éŸ³é¢‘æµç±»å‹ï¼šå¦‚ Musicã€Voice-Callã€DTMFã€Alarm ç­‰ç­‰</span></span><br><span class="line">        <span class="keyword">uint32_t</span> sampleRate,               <span class="comment">// é‡‡æ ·ç‡ï¼šå¦‚ 16KHzã€44.1KHzã€48KHz ç­‰ç­‰</span></span><br><span class="line">        <span class="keyword">audio_format_t</span> format,             <span class="comment">// éŸ³é¢‘æ ¼å¼ï¼šå¦‚ PCMã€MP3ã€AAC ç­‰ç­‰</span></span><br><span class="line">        <span class="keyword">audio_channel_mask_t</span> channelMask,  <span class="comment">// å£°é“æ•°ï¼šå¦‚ Monoï¼ˆå•å£°é“ï¼‰ã€Stereoï¼ˆåŒå£°é“ï¼‰</span></span><br><span class="line">        <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,   <span class="comment">// å…±äº«å†…å­˜ç¼“å†²åŒºï¼šæ•°æ®æ¨¡å¼æ˜¯ MODE_STATIC æ—¶ä½¿ç”¨ï¼Œæ•°æ®æ¨¡å¼æ˜¯ MODE_STREAM æ—¶ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">audio_output_flags_t</span> flags,        <span class="comment">// è¾“å‡ºæ ‡è¯†ä½ï¼Œè¯¦è§ AUDIO_OUTPUT_FLAG æè¿°</span></span><br><span class="line">        <span class="keyword">callback_t</span> cbf,                    <span class="comment">// å›è°ƒå‡½æ•°</span></span><br><span class="line">        <span class="keyword">void</span>* user,                        <span class="comment">// å›è°ƒå‡½æ•°çš„å‚æ•°</span></span><br><span class="line">        <span class="keyword">uint32_t</span> notificationFrames,</span><br><span class="line">        <span class="keyword">int</span> sessionId,</span><br><span class="line">        transfer_type transferType,        <span class="comment">// æ•°æ®ä¼ è¾“ç±»å‹</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">audio_offload_info_t</span> *offloadInfo,</span><br><span class="line">        <span class="keyword">int</span> uid,</span><br><span class="line">        <span class="keyword">pid_t</span> pid,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">audio_attributes_t</span>* pAttributes,</span><br><span class="line">        <span class="keyword">bool</span> doNotReconnect)</span><br><span class="line">    : mStatus(NO_INIT),</span><br><span class="line">      mIsTimed(<span class="literal">false</span>),</span><br><span class="line">      mPreviousPriority(ANDROID_PRIORITY_NORMAL),</span><br><span class="line">      mPreviousSchedulingGroup(SP_DEFAULT),</span><br><span class="line">      mPausedPosition(<span class="number">0</span>),</span><br><span class="line">      mSelectedDeviceId(AUDIO_PORT_HANDLE_NONE)</span><br><span class="line">&#123;</span><br><span class="line">    mStatus = <span class="built_in">set</span>(streamType, sampleRate, format, channelMask,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/*frameCount*/</span>, flags, cbf, user, notificationFrames,</span><br><span class="line">            sharedBuffer, <span class="literal">false</span> <span class="comment">/*threadCanCallJava*/</span>, sessionId, transferType, offloadInfo,</span><br><span class="line">            uid, pid, pAttributes, doNotReconnect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> AudioTrack::<span class="built_in">set</span>(</span><br><span class="line">        <span class="keyword">audio_stream_type_t</span> streamType,</span><br><span class="line">        <span class="keyword">uint32_t</span> sampleRate,</span><br><span class="line">        <span class="keyword">audio_format_t</span> format,</span><br><span class="line">        <span class="keyword">audio_channel_mask_t</span> channelMask,</span><br><span class="line">        <span class="keyword">size_t</span> frameCount,</span><br><span class="line">        <span class="keyword">audio_output_flags_t</span> flags,        </span><br><span class="line">        <span class="keyword">callback_t</span> cbf,</span><br><span class="line">        <span class="keyword">void</span>* user,</span><br><span class="line">        <span class="keyword">uint32_t</span> notificationFrames,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">        <span class="keyword">bool</span> threadCanCallJava,</span><br><span class="line">        <span class="keyword">int</span> sessionId,</span><br><span class="line">        transfer_type transferType,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">audio_offload_info_t</span> *offloadInfo,</span><br><span class="line">        <span class="keyword">int</span> uid,</span><br><span class="line">        <span class="keyword">pid_t</span> pid,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">audio_attributes_t</span>* pAttributes,</span><br><span class="line">        <span class="keyword">bool</span> doNotReconnect)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å‚æ•°æ ¼å¼åˆæ³•æ€§æ£€æŸ¥ã€éŸ³è½¨éŸ³é‡åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ cbf éç©ºï¼Œé‚£ä¹ˆåˆ›å»º AudioTrackThread çº¿ç¨‹å¤„ç† audioCallback å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (cbf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mAudioTrackThread = <span class="keyword">new</span> AudioTrackThread(*<span class="keyword">this</span>, threadCanCallJava);</span><br><span class="line">        mAudioTrackThread-&gt;run(<span class="string">"AudioTrack"</span>, ANDROID_PRIORITY_AUDIO, <span class="number">0</span> <span class="comment">/*stack*/</span>);</span><br><span class="line">        <span class="comment">// thread begins in paused state, and will not reference us until start()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the IAudioTrack</span></span><br><span class="line">    <span class="keyword">status_t</span> status = createTrack_l();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> AudioTrack::createTrack_l()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è·å– IAudioFlingerï¼Œé€šè¿‡ binder è¯·æ±‚ AudioFlinger æœåŠ¡</span></span><br><span class="line">    <span class="keyword">const</span> sp&lt;IAudioFlinger&gt;&amp; audioFlinger = AudioSystem::get_audio_flinger();</span><br><span class="line">    <span class="keyword">if</span> (audioFlinger == <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not get audioflinger"</span>);</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// AudioSystem::getOutputForAttr() ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œè¿›å…¥ AudioPolicyManager::getOutputForDevice()</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¾“å‡ºæ ‡è¯†ç½®äº† AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD æˆ– AUDIO_OUTPUT_FLAG_DIRECTï¼Œ</span></span><br><span class="line">    <span class="comment">// é‚£ä¹ˆæœ€ç»ˆè°ƒç”¨ AudioFlinger::openOutput() æ‰“å¼€è¾“å‡ºæ ‡è¯†å¯¹åº”çš„è¾“å‡ºæµè®¾å¤‡å¹¶åˆ›å»ºç›¸å…³çš„</span></span><br><span class="line">    <span class="comment">// PlaybackThreadï¼Œä¿å­˜è¯¥ PlaybackThread å¯¹åº”çš„ audio_io_handle_t ç»™ AudioTrackï¼›</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¾“å‡ºæ ‡è¯†æ˜¯å…¶ä»–ç±»å‹ï¼Œé‚£ä¹ˆæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸€ä¸ªè¾“å‡ºæµè®¾å¤‡å’Œ PlaybackThreadï¼Œå¹¶ä¿å­˜è¯¥</span></span><br><span class="line">    <span class="comment">// PlaybackThread å¯¹åº”çš„ audio_io_handle_t ç»™ AudioTrack</span></span><br><span class="line">    <span class="keyword">audio_io_handle_t</span> output;</span><br><span class="line">    status = AudioSystem::getOutputForAttr(attr, &amp;output,</span><br><span class="line">                                           (<span class="keyword">audio_session_t</span>)mSessionId, &amp;streamType, mClientUid,</span><br><span class="line">                                           mSampleRate, mFormat, mChannelMask,</span><br><span class="line">                                           mFlags, mSelectedDeviceId, mOffloadInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ AudioFlinger å‘å‡º createTrack è¯·æ±‚</span></span><br><span class="line">    sp&lt;IAudioTrack&gt; track = audioFlinger-&gt;createTrack(streamType,</span><br><span class="line">                                                      mSampleRate,</span><br><span class="line">                                                      mFormat,</span><br><span class="line">                                                      mChannelMask,</span><br><span class="line">                                                      &amp;temp,</span><br><span class="line">                                                      &amp;trackFlags,</span><br><span class="line">                                                      mSharedBuffer,</span><br><span class="line">                                                      output,</span><br><span class="line">                                                      tid,</span><br><span class="line">                                                      &amp;mSessionId,</span><br><span class="line">                                                      mClientUid,</span><br><span class="line">                                                      &amp;status);</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// AudioFlinger åˆ›å»º Track å¯¹è±¡æ—¶ä¼šåˆ†é…ä¸€ä¸ª FIFOï¼Œè¿™é‡Œè·å– FIFO çš„æ§åˆ¶å—</span></span><br><span class="line">    sp&lt;IMemory&gt; iMem = track-&gt;getCblk();</span><br><span class="line">    <span class="keyword">if</span> (iMem == <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not get control block"</span>);</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŒ¿åå…±äº«å†…å­˜é¦–åœ°å€</span></span><br><span class="line">    <span class="keyword">void</span> *iMemPointer = iMem-&gt;pointer();</span><br><span class="line">    <span class="keyword">if</span> (iMemPointer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not get control block pointer"</span>);</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line">    mAudioTrack = track; <span class="comment">// ä¿å­˜ AudioFlinger::PlaybackThread::Track çš„ä»£ç†å¯¹è±¡ IAudioTrack</span></span><br><span class="line">    mCblkMemory = iMem; <span class="comment">// ä¿å­˜åŒ¿åå…±äº«å†…å­˜é¦–åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ§åˆ¶å—ä½äº AudioFlinger åˆ†é…çš„åŒ¿åå…±äº«å†…å­˜çš„é¦–éƒ¨</span></span><br><span class="line">    <span class="keyword">audio_track_cblk_t</span>* cblk = <span class="keyword">static_cast</span>&lt;<span class="keyword">audio_track_cblk_t</span>*&gt;(iMemPointer);</span><br><span class="line">    mCblk = cblk;</span><br><span class="line">    mOutput = output; <span class="comment">// ä¿å­˜è¿”å›çš„ audio_io_handle_tï¼Œç”¨å®ƒå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ PlaybackThread</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// update proxy</span></span><br><span class="line">    <span class="keyword">if</span> (mSharedBuffer == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å½“ mSharedBuffer ä¸ºç©ºï¼Œæ„å‘³ç€éŸ³è½¨æ•°æ®æ¨¡å¼ä¸º MODE_STREAMï¼Œé‚£ä¹ˆåˆ›å»º AudioTrackClientProxy å¯¹è±¡</span></span><br><span class="line">        mStaticProxy.clear();</span><br><span class="line">        mProxy = <span class="keyword">new</span> AudioTrackClientProxy(cblk, buffers, frameCount, mFrameSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å½“ mSharedBuffer éç©ºï¼Œæ„å‘³ç€éŸ³è½¨æ•°æ®æ¨¡å¼ä¸º MODE_STATICï¼Œé‚£ä¹ˆåˆ›å»º StaticAudioTrackClientProxy å¯¹è±¡</span></span><br><span class="line">        mStaticProxy = <span class="keyword">new</span> StaticAudioTrackClientProxy(cblk, buffers, frameCount, mFrameSize);</span><br><span class="line">        mProxy = mStaticProxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AudioFlinger::createTrack()ï¼Œé¡¾åæ€ä¹‰ï¼Œåˆ›å»ºä¸€ä¸ª Track å¯¹è±¡ï¼Œå°†ç”¨äºéŸ³é¢‘æµçš„æ§åˆ¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">sp&lt;IAudioTrack&gt; AudioFlinger::createTrack(</span><br><span class="line">        audio_stream_type_t streamType,</span><br><span class="line">        uint32_t sampleRate,</span><br><span class="line">        audio_format_t format,</span><br><span class="line">        audio_channel_mask_t channelMask,</span><br><span class="line">        size_t *frameCount,</span><br><span class="line">        IAudioFlinger::track_flags_t *flags,</span><br><span class="line">        const sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">        audio_io_handle_t output,</span><br><span class="line">        pid_t tid,</span><br><span class="line">        int *sessionId,</span><br><span class="line">        int clientUid,</span><br><span class="line">        status_t *status)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;PlaybackThread::Track&gt; track;</span><br><span class="line">    sp&lt;TrackHandle&gt; trackHandle;</span><br><span class="line">    sp&lt;Client&gt; client;</span><br><span class="line">    status_t lStatus;</span><br><span class="line">    int lSessionId;</span><br><span class="line"></span><br><span class="line">    //......</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        // æ ¹æ®ä¼ å…¥æ¥çš„ audio_io_handle_tï¼Œæ‰¾åˆ°å¯¹åº”çš„ PlaybackThread</span><br><span class="line">        PlaybackThread *thread = checkPlaybackThread_l(output);</span><br><span class="line">        if (thread == NULL) &#123;</span><br><span class="line">            ALOGE(&quot;no playback thread found for output handle %d&quot;, output);</span><br><span class="line">            lStatus = BAD_VALUE;</span><br><span class="line">            goto Exit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //......</span><br><span class="line"></span><br><span class="line">        // åœ¨ PlaybackThread ä¸Šåˆ›å»ºä¸€ä¸ªéŸ³é¢‘æµç®¡ç†å¯¹è±¡ Track</span><br><span class="line">        track = thread-&gt;createTrack_l(client, streamType, sampleRate, format,</span><br><span class="line">                channelMask, frameCount, sharedBuffer, lSessionId, flags, tid, clientUid, &amp;lStatus);</span><br><span class="line">        //......</span><br><span class="line"></span><br><span class="line">        setAudioHwSyncForSession_l(thread, (audio_session_t)lSessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //......</span><br><span class="line"></span><br><span class="line">    // åˆ›å»º Track çš„é€šè®¯ä»£ç† TrackHandle å¹¶è¿”å›å®ƒ</span><br><span class="line">    trackHandle = new TrackHandle(track);</span><br><span class="line"></span><br><span class="line">Exit:</span><br><span class="line">    *status = lStatus;</span><br><span class="line">    return trackHandle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;AudioFlinger::PlaybackThread::Track&gt; AudioFlinger::PlaybackThread::createTrack_l(</span><br><span class="line">        const sp&lt;AudioFlinger::Client&gt;&amp; client,</span><br><span class="line">        audio_stream_type_t streamType,</span><br><span class="line">        uint32_t sampleRate,</span><br><span class="line">        audio_format_t format,</span><br><span class="line">        audio_channel_mask_t channelMask,</span><br><span class="line">        size_t *pFrameCount,</span><br><span class="line">        const sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">        int sessionId,</span><br><span class="line">        IAudioFlinger::track_flags_t *flags,</span><br><span class="line">        pid_t tid,</span><br><span class="line">        int uid,</span><br><span class="line">        status_t *status)</span><br><span class="line">&#123;</span><br><span class="line">    size_t frameCount = *pFrameCount;</span><br><span class="line">    sp&lt;Track&gt; track;</span><br><span class="line">    status_t lStatus;</span><br><span class="line"></span><br><span class="line">    bool isTimed = (*flags &amp; IAudioFlinger::TRACK_TIMED) != 0;</span><br><span class="line"></span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    &#123; // scope for mLock</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        if (!isTimed) &#123;</span><br><span class="line">            // åˆ›å»º Trackï¼Œç­‰ä¼šå†çœ‹çœ‹ Track æ„é€ å‡½æ•°å¹²äº›å•¥</span><br><span class="line">            track = new Track(this, client, streamType, sampleRate, format,</span><br><span class="line">                              channelMask, frameCount, NULL, sharedBuffer,</span><br><span class="line">                              sessionId, uid, *flags, TrackBase::TYPE_DEFAULT);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // åˆ›å»º TimedTrackï¼Œå¸¦æ—¶é—´æˆ³çš„ Trackï¼Ÿè¿™é‡Œä¸æ·±ç©¶</span><br><span class="line">            track = TimedTrack::create(this, client, streamType, sampleRate, format,</span><br><span class="line">                    channelMask, frameCount, sharedBuffer, sessionId, uid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        // æŠŠåˆ›å»ºçš„ Track æ·»åŠ åˆ° mTracks å‘é‡ä¸­ï¼Œæ–¹ä¾¿ PlaybackThread ç»Ÿä¸€ç®¡ç†</span><br><span class="line">        mTracks.add(track);</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lStatus = NO_ERROR;</span><br><span class="line"></span><br><span class="line">Exit:</span><br><span class="line">    *status = lStatus;</span><br><span class="line">    return track;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ----------------------------------------------------------------------------</span><br><span class="line">// å¦‚ä¸‹æ˜¯ TrackHandle çš„ç›¸å…³ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒTrackHandle å…¶å®å°±æ˜¯ä¸€ä¸ªå£³å­ï¼Œæ˜¯ Track çš„åŒ…è£…ç±»</span><br><span class="line">// æ‰€æœ‰ TrackHandle æ¥å£éƒ½æ˜¯è°ƒå‘ Track çš„</span><br><span class="line">// Google ä¸ºä»€ä¹ˆè¦æè¿™ä¹ˆä¸€åˆ™ï¼ŸTrack æ˜¯ PlaybackThread å†…éƒ¨ä½¿ç”¨çš„ï¼Œä¸é€‚å®œå¯¹å¤–æš´éœ²ï¼Œä½†åº”ç”¨è¿›ç¨‹</span><br><span class="line">// åˆç¡®å®éœ€è¦æ§åˆ¶éŸ³é¢‘æµçš„çŠ¶æ€ï¼ˆstartã€stopã€pauseï¼‰ï¼Œæ‰€ä»¥å°±é‡‡å–è¿™ä¹ˆä¸€ç§æ–¹å¼å®ç°</span><br><span class="line"></span><br><span class="line">AudioFlinger::TrackHandle::TrackHandle(const sp&lt;AudioFlinger::PlaybackThread::Track&gt;&amp; track)</span><br><span class="line">    : BnAudioTrack(),</span><br><span class="line">      mTrack(track)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AudioFlinger::TrackHandle::~TrackHandle() &#123;</span><br><span class="line">    // just stop the track on deletion, associated resources</span><br><span class="line">    // will be freed from the main thread once all pending buffers have</span><br><span class="line">    // been played. Unless it&apos;s not in the active track list, in which</span><br><span class="line">    // case we free everything now...</span><br><span class="line">    mTrack-&gt;destroy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;IMemory&gt; AudioFlinger::TrackHandle::getCblk() const &#123;</span><br><span class="line">    return mTrack-&gt;getCblk();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status_t AudioFlinger::TrackHandle::start() &#123;</span><br><span class="line">    return mTrack-&gt;start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void AudioFlinger::TrackHandle::stop() &#123;</span><br><span class="line">    mTrack-&gt;stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void AudioFlinger::TrackHandle::flush() &#123;</span><br><span class="line">    mTrack-&gt;flush();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void AudioFlinger::TrackHandle::pause() &#123;</span><br><span class="line">    mTrack-&gt;pause();</span><br><span class="line">&#125;</span><br><span class="line">// ----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬çœ‹çœ‹ Track çš„æ„é€ è¿‡ç¨‹ï¼Œä¸»è¦åˆ†ææ•°æ® FIFO åŠå®ƒçš„æ§åˆ¶å—æ˜¯å¦‚ä½•åˆ†é…çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">AudioFlinger::PlaybackThread::Track::Track(</span><br><span class="line">            PlaybackThread *thread,</span><br><span class="line">            <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">            <span class="keyword">audio_stream_type_t</span> streamType,</span><br><span class="line">            <span class="keyword">uint32_t</span> sampleRate,</span><br><span class="line">            <span class="keyword">audio_format_t</span> format,</span><br><span class="line">            <span class="keyword">audio_channel_mask_t</span> channelMask,</span><br><span class="line">            <span class="keyword">size_t</span> frameCount,</span><br><span class="line">            <span class="keyword">void</span> *buffer,</span><br><span class="line">            <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">            <span class="keyword">int</span> sessionId,</span><br><span class="line">            <span class="keyword">int</span> uid,</span><br><span class="line">            IAudioFlinger::<span class="keyword">track_flags_t</span> flags,</span><br><span class="line">            track_type type)</span><br><span class="line">    :   TrackBase(thread, client, sampleRate, format, channelMask, frameCount,</span><br><span class="line">                  (sharedBuffer != <span class="number">0</span>) ? sharedBuffer-&gt;pointer() : buffer,</span><br><span class="line">                  sessionId, uid, flags, <span class="literal">true</span> <span class="comment">/*isOut*/</span>,</span><br><span class="line">                  (type == TYPE_PATCH) ? ( buffer == <span class="literal">NULL</span> ? ALLOC_LOCAL : ALLOC_NONE) : ALLOC_CBLK,</span><br><span class="line">                  type),</span><br><span class="line">    mFillingUpStatus(FS_INVALID),</span><br><span class="line">    <span class="comment">// mRetryCount initialized later when needed</span></span><br><span class="line">    mSharedBuffer(sharedBuffer),</span><br><span class="line">    mStreamType(streamType),</span><br><span class="line">    mName(<span class="number">-1</span>),  <span class="comment">// see note below</span></span><br><span class="line">    mMainBuffer(thread-&gt;mixBuffer()),</span><br><span class="line">    mAuxBuffer(<span class="literal">NULL</span>),</span><br><span class="line">    mAuxEffectId(<span class="number">0</span>), mHasVolumeController(<span class="literal">false</span>),</span><br><span class="line">    mPresentationCompleteFrames(<span class="number">0</span>),</span><br><span class="line">    mFastIndex(<span class="number">-1</span>),</span><br><span class="line">    mCachedVolume(<span class="number">1.0</span>),</span><br><span class="line">    mIsInvalid(<span class="literal">false</span>),</span><br><span class="line">    mAudioTrackServerProxy(<span class="literal">NULL</span>),</span><br><span class="line">    mResumeToStopping(<span class="literal">false</span>),</span><br><span class="line">    mFlushHwPending(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// client == 0 implies sharedBuffer == 0</span></span><br><span class="line">    ALOG_ASSERT(!(client == <span class="number">0</span> &amp;&amp; sharedBuffer != <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    ALOGV_IF(sharedBuffer != <span class="number">0</span>, <span class="string">"sharedBuffer: %p, size: %d"</span>, sharedBuffer-&gt;pointer(),</span><br><span class="line">            sharedBuffer-&gt;size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥ FIFO æ§åˆ¶å—ï¼ˆaudio_track_cblk_tï¼‰æ˜¯å¦åˆ†é…å¥½äº†ï¼Œä¸Šé¢ä»£ç å¹¶æœªåˆ†é… audio_track_cblk_t</span></span><br><span class="line">    <span class="comment">// å› æ­¤åªå¯èƒ½æ˜¯æ„é€  TrackBase æ—¶åˆ†é…çš„ï¼Œç­‰ä¸‹å†çœ‹çœ‹ TrackBase çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (mCblk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sharedBuffer == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º MODE_STREAM æ¨¡å¼ï¼Œåˆ›å»ºä¸€ä¸ª AudioTrackServerProxy å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// PlaybackThread å°†æŒç»­ä½¿ç”¨å®ƒä» FIFO ä¸Šå–å¾—å¯è¯»æ•°æ®çš„ä½ç½®</span></span><br><span class="line">        mAudioTrackServerProxy = <span class="keyword">new</span> AudioTrackServerProxy(mCblk, mBuffer, frameCount,</span><br><span class="line">                mFrameSize, !isExternalTrack(), sampleRate);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º MODE_STATIC æ¨¡å¼ï¼Œåˆ›å»ºä¸€ä¸ª StaticAudioTrackServerProxy å¯¹è±¡</span></span><br><span class="line">        mAudioTrackServerProxy = <span class="keyword">new</span> StaticAudioTrackServerProxy(mCblk, mBuffer, frameCount,</span><br><span class="line">                mFrameSize);</span><br><span class="line">    &#125;</span><br><span class="line">    mServerProxy = mAudioTrackServerProxy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸º Track åˆ†é…ä¸€ä¸ªåç§°ï¼ŒAudioMixer ä¼šæ ¹æ® TrackName æ‰¾åˆ°å¯¹åº”çš„ Track</span></span><br><span class="line">    mName = thread-&gt;getTrackName_l(channelMask, format, sessionId);</span><br><span class="line">    <span class="keyword">if</span> (mName &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"no more track names available"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AudioFlinger::ThreadBase::TrackBase::TrackBase(</span><br><span class="line">            ThreadBase *thread,</span><br><span class="line">            <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">            <span class="keyword">uint32_t</span> sampleRate,</span><br><span class="line">            <span class="keyword">audio_format_t</span> format,</span><br><span class="line">            <span class="keyword">audio_channel_mask_t</span> channelMask,</span><br><span class="line">            <span class="keyword">size_t</span> frameCount,</span><br><span class="line">            <span class="keyword">void</span> *buffer,</span><br><span class="line">            <span class="keyword">int</span> sessionId,</span><br><span class="line">            <span class="keyword">int</span> clientUid,</span><br><span class="line">            IAudioFlinger::<span class="keyword">track_flags_t</span> flags,</span><br><span class="line">            <span class="keyword">bool</span> isOut,</span><br><span class="line">            alloc_type alloc,</span><br><span class="line">            track_type type)</span><br><span class="line">    :   RefBase(),</span><br><span class="line">        mThread(thread),</span><br><span class="line">        mClient(client),</span><br><span class="line">        mCblk(<span class="literal">NULL</span>),</span><br><span class="line">        <span class="comment">// mBuffer</span></span><br><span class="line">        mState(IDLE),</span><br><span class="line">        mSampleRate(sampleRate),</span><br><span class="line">        mFormat(format),</span><br><span class="line">        mChannelMask(channelMask),</span><br><span class="line">        mChannelCount(isOut ?</span><br><span class="line">                audio_channel_count_from_out_mask(channelMask) :</span><br><span class="line">                audio_channel_count_from_in_mask(channelMask)),</span><br><span class="line">        mFrameSize(audio_is_linear_pcm(format) ?</span><br><span class="line">                mChannelCount * audio_bytes_per_sample(format) : <span class="keyword">sizeof</span>(<span class="keyword">int8_t</span>)),</span><br><span class="line">        mFrameCount(frameCount),</span><br><span class="line">        mSessionId(sessionId),</span><br><span class="line">        mFlags(flags),</span><br><span class="line">        mIsOut(isOut),</span><br><span class="line">        mServerProxy(<span class="literal">NULL</span>),</span><br><span class="line">        mId(android_atomic_inc(&amp;nextTrackId)),</span><br><span class="line">        mTerminated(<span class="literal">false</span>),</span><br><span class="line">        mType(type),</span><br><span class="line">        mThreadIoHandle(thread-&gt;id())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGD("Creating track with %d buffers @ %d bytes", bufferCount, bufferSize);</span></span><br><span class="line">    <span class="keyword">size_t</span> size = <span class="keyword">sizeof</span>(<span class="keyword">audio_track_cblk_t</span>);</span><br><span class="line">    <span class="keyword">size_t</span> bufferSize = (buffer == <span class="literal">NULL</span> ? roundup(frameCount) : frameCount) * mFrameSize;</span><br><span class="line">    <span class="keyword">if</span> (buffer == <span class="literal">NULL</span> &amp;&amp; alloc == ALLOC_CBLK) &#123;</span><br><span class="line">        <span class="comment">// è¿™ä¸ª size å°†æ˜¯åˆ†é…çš„åŒ¿åå…±äº«å†…å­˜çš„å¤§å°</span></span><br><span class="line">        <span class="comment">// ç­‰äºæ§åˆ¶å—çš„å¤§å°ï¼ˆsizeof(audio_track_cblk_t)åŠ ä¸Šæ•°æ® FIFOçš„å¤§å°ï¼ˆbufferSizeï¼‰</span></span><br><span class="line">        <span class="comment">// å¾…ä¼šçœ‹åˆ°è¿™å—å†…å­˜çš„ç»“æ„ï¼Œå°±æ˜ç™½è¿™æ ·åˆ†é…çš„æ„ä¹‰äº†</span></span><br><span class="line">        size += bufferSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (client != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…ä¸€å—åŒ¿åå…±äº«å†…å­˜</span></span><br><span class="line">        mCblkMemory = client-&gt;heap()-&gt;allocate(size);</span><br><span class="line">        <span class="keyword">if</span> (mCblkMemory == <span class="number">0</span> ||</span><br><span class="line">                (mCblk = <span class="keyword">static_cast</span>&lt;<span class="keyword">audio_track_cblk_t</span> *&gt;(mCblkMemory-&gt;pointer())) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"not enough memory for AudioTrack size=%u"</span>, size);</span><br><span class="line">            client-&gt;heap()-&gt;dump(<span class="string">"AudioTrack"</span>);</span><br><span class="line">            mCblkMemory.clear();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// this syntax avoids calling the audio_track_cblk_t constructor twice</span></span><br><span class="line">        mCblk = (<span class="keyword">audio_track_cblk_t</span> *) <span class="keyword">new</span> <span class="keyword">uint8_t</span>[size];</span><br><span class="line">        <span class="comment">// assume mCblk != NULL</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// construct the shared structure in-place.</span></span><br><span class="line">    <span class="keyword">if</span> (mCblk != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿™æ˜¯ C++ çš„ placement newï¼ˆå®šä½åˆ›å»ºå¯¹è±¡ï¼‰è¯­æ³•ï¼šnew(@BUFFER) @CLASS();</span></span><br><span class="line">        <span class="comment">// å¯ä»¥åœ¨ç‰¹å®šå†…å­˜ä½ç½®ä¸Šæ„é€ ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œï¼Œåœ¨åŒ¿åå…±äº«å†…å­˜é¦–åœ°å€ä¸Šæ„é€ äº†ä¸€ä¸ª audio_track_cblk_t å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// è¿™æ · AudioTrack ä¸ AudioFlinger éƒ½èƒ½è®¿é—®è¿™ä¸ª audio_track_cblk_t å¯¹è±¡äº†</span></span><br><span class="line">        <span class="keyword">new</span>(mCblk) <span class="keyword">audio_track_cblk_t</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚ä¸‹åˆ†é…æ•°æ® FIFOï¼Œå°†ç”¨äº AudioTrack ä¸ AudioFlinger çš„æ•°æ®äº¤æ¢</span></span><br><span class="line">        <span class="keyword">switch</span> (alloc) &#123;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="keyword">case</span> ALLOC_CBLK:</span><br><span class="line">            <span class="comment">// clear all buffers</span></span><br><span class="line">            <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º MODE_STREAM/TRANSFER_SYNC æ—¶ï¼Œæ•°æ® FIFO çš„åˆ†é…</span></span><br><span class="line">                <span class="comment">// æ•°æ® FIFO çš„é¦–åœ°å€ç´§é æ§åˆ¶å—ï¼ˆaudio_track_cblk_tï¼‰ä¹‹å</span></span><br><span class="line">                <span class="comment">//   |                                                         |</span></span><br><span class="line">                <span class="comment">//   | -------------------&gt; mCblkMemory &lt;--------------------- |</span></span><br><span class="line">                <span class="comment">//   |                                                         |</span></span><br><span class="line">                <span class="comment">//   +--------------------+------------------------------------+</span></span><br><span class="line">                <span class="comment">//   | audio_track_cblk_t |             Buffer                 |</span></span><br><span class="line">                <span class="comment">//   +--------------------+------------------------------------+</span></span><br><span class="line">                <span class="comment">//   ^                    ^</span></span><br><span class="line">                <span class="comment">//   |                    |</span></span><br><span class="line">                <span class="comment">//   mCblk               mBuffer</span></span><br><span class="line">                mBuffer = (<span class="keyword">char</span>*)mCblk + <span class="keyword">sizeof</span>(<span class="keyword">audio_track_cblk_t</span>);</span><br><span class="line">                <span class="built_in">memset</span>(mBuffer, <span class="number">0</span>, bufferSize);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º MODE_STATIC/TRANSFER_SHARED æ—¶ï¼Œç›´æ¥æŒ‡å‘ sharedBuffer</span></span><br><span class="line">                <span class="comment">// sharedBuffer æ˜¯åº”ç”¨è¿›ç¨‹åˆ†é…çš„åŒ¿åå…±äº«å†…å­˜ï¼Œåº”ç”¨è¿›ç¨‹å·²ç»ä¸€æ¬¡æ€§æŠŠæ•°æ®</span></span><br><span class="line">                <span class="comment">// å†™åˆ° sharedBuffer æ¥äº†ï¼ŒAudioFlinger å¯ä»¥ç›´æ¥ä»è¿™é‡Œè¯»å–</span></span><br><span class="line">                <span class="comment">//   +--------------------+    +-----------------------------------+</span></span><br><span class="line">                <span class="comment">//   | audio_track_cblk_t |    |            sharedBuffer           |</span></span><br><span class="line">                <span class="comment">//   +--------------------+    +-----------------------------------+</span></span><br><span class="line">                <span class="comment">//   ^                         ^</span></span><br><span class="line">                <span class="comment">//   |                         |</span></span><br><span class="line">                <span class="comment">//   mCblk                    mBuffer</span></span><br><span class="line">                mBuffer = buffer;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-3-AudioTrack-æ•°æ®å†™å…¥"><a href="#3-3-AudioTrack-æ•°æ®å†™å…¥" class="headerlink" title="3.3. AudioTrack æ•°æ®å†™å…¥"></a>3.3. AudioTrack æ•°æ®å†™å…¥</h5><p>AudioTrack å®ä¾‹æ„é€ åï¼Œåº”ç”¨ç¨‹åºæ¥ç€å¯ä»¥å†™å…¥éŸ³é¢‘æ•°æ®äº†ã€‚å¦‚ä¹‹å‰æ‰€æè¿°ï¼šAudioTrack ä¸ AudioFlinger æ˜¯ ç”Ÿäº§è€…-æ¶ˆè´¹è€… çš„å…³ç³»ï¼š</p><p>â˜¯ AudioTrackï¼šAudioTrack åœ¨ FIFO ä¸­æ‰¾åˆ°ä¸€å—å¯ç”¨ç©ºé—´ï¼ŒæŠŠç”¨æˆ·ä¼ å…¥çš„éŸ³é¢‘æ•°æ®å†™å…¥åˆ°è¿™å—å¯ç”¨ç©ºé—´ä¸Šï¼Œç„¶åæ›´æ–°å†™ä½ç½®ï¼ˆå¯¹äº AudioFinger æ¥è¯´ï¼Œæ„å‘³ FIFO ä¸Šæœ‰æ›´å¤šçš„å¯è¯»æ•°æ®äº†ï¼‰ï¼›å¦‚æœç”¨æˆ·ä¼ å…¥çš„æ•°æ®é‡æ¯”å¯ç”¨ç©ºé—´è¦å¤§ï¼Œé‚£ä¹ˆè¦æŠŠç”¨æˆ·ä¼ å…¥çš„æ•°æ®æ‹†åˆ†å¤šæ¬¡å†™å…¥åˆ° FIFO ä¸­ï¼ˆAudioTrack å’Œ AudioFlinger æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼ŒAudioFlinger åŒæ—¶ä¹Ÿåœ¨ä¸åœåœ°è¯»å–æ•°æ®ï¼Œæ‰€ä»¥ FIFO å¯ç”¨ç©ºé—´æ˜¯åœ¨ä¸åœå˜åŒ–çš„ï¼‰<br>â˜¯ AudioFlingerï¼šAudioFlinger åœ¨ FIFO ä¸­æ‰¾åˆ°ä¸€å—å¯è¯»æ•°æ®å—ï¼ŒæŠŠå¯è¯»æ•°æ®æ‹·è´åˆ°ç›®çš„ç¼“å†²åŒºä¸Šï¼Œç„¶åæ›´æ–°è¯»ä½ç½®ï¼ˆå¯¹äº AudioTrack æ¥è¯´ï¼Œæ„å‘³ç€ FIFO ä¸Šæœ‰æ›´å¤šçš„å¯ç”¨ç©ºé—´äº†ï¼‰ï¼›å¦‚æœFIFO ä¸Šå¯è¯»æ•°æ®é‡æ¯”é¢„æœŸçš„è¦å°ï¼Œé‚£ä¹ˆè¦è¿›è¡Œå¤šæ¬¡çš„è¯»å–ï¼Œæ‰èƒ½ç§¯ç´¯åˆ°é¢„æœŸçš„æ•°æ®é‡ï¼ˆAudioTrack å’Œ AudioFlinger æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼ŒAudioTrack åŒæ—¶ä¹Ÿåœ¨ä¸åœåœ°å†™å…¥æ•°æ®ï¼Œæ‰€ä»¥ FIFO å¯è¯»çš„æ•°æ®é‡æ˜¯åœ¨ä¸åœå˜åŒ–çš„ï¼‰<br>ä¸Šé¢çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ AudioTrack æ€»èƒ½åŠæ—¶ç”Ÿäº§æ•°æ®ï¼Œå¹¶ä¸” AudioFlinger æ€»èƒ½åŠæ—¶æ¶ˆè€—æ‰è¿™äº›æ•°æ®ï¼Œé‚£ä¹ˆæ•´ä¸ªè¿‡ç¨‹å°†æ˜¯éå¸¸å’Œè°çš„ï¼›ä½†ç³»ç»Ÿå¯èƒ½ä¼šå‘ç”Ÿå¼‚å¸¸ï¼Œå‡ºç°å¦‚ä¸‹çš„çŠ¶æ€ï¼š</p><p>â˜¯ Blockï¼šAudioFlinger é•¿æ—¶é—´ä¸è¯»å– FIFO ä¸Šçš„å¯è¯»æ•°æ®ï¼Œä½¿å¾— AudioTrack é•¿æ—¶é—´è·å–ä¸åˆ°å¯ç”¨ç©ºé—´ï¼Œæ— æ³•å†™å…¥æ•°æ®ï¼›è¿™ç§æƒ…å†µçš„æ ¹æœ¬åŸå› å¤§å¤šæ˜¯åº•å±‚é©±åŠ¨å‘ç”Ÿé˜»å¡å¼‚å¸¸ï¼Œå¯¼è‡´ AudioFlinger æ— æ³•ç»§ç»­å†™æ•°æ®åˆ°ç¡¬ä»¶è®¾å¤‡ä¸­ï¼ŒAudioFlinger æœ¬èº«å¹¶æ²¡æœ‰é”™<br>â˜¯ Underrunï¼šAudioTrack å†™å…¥æ•°æ®çš„é€Ÿåº¦è·Ÿä¸ä¸Š AudioFlinger è¯»å–æ•°æ®çš„é€Ÿåº¦ï¼Œä½¿å¾— AudioFlinger ä¸èƒ½åŠæ—¶è·å–åˆ°é¢„æœŸçš„æ•°æ®é‡ï¼Œåæ˜ åˆ°ç°å®çš„åæœå°±æ˜¯å£°éŸ³æ–­ç»­ï¼›è¿™ç§æƒ…å†µçš„æ ¹æœ¬åŸå› å¤§å¤šæ˜¯åº”ç”¨ç¨‹åºä¸èƒ½åŠæ—¶å†™å…¥æ•°æ®æˆ–è€…ç¼“å†²åŒºåˆ†é…è¿‡å°ï¼ŒAudioTrack æœ¬èº«å¹¶æ²¡æœ‰é”™ï¼›AudioFlinger é’ˆå¯¹è¿™ç‚¹åšäº†å®¹é”™å¤„ç†ï¼šå½“å‘ç° underrun æ—¶ï¼Œå…ˆé™·å…¥çŸ­æ—¶é—´çš„ç¡çœ ï¼Œä¸æ€¥ç€è¯»å–æ•°æ®ï¼Œè®©åº”ç”¨ç¨‹åºå‡†å¤‡æ›´å¤šçš„æ•°æ®ï¼ˆå¦‚æœæŸä¸€å¤©åšåº”ç”¨çš„å“¥ä»¬æ„è¯†åˆ°è‡ªå·±çš„é”™è¯¯åŸæ¥ç”±åº•å±‚çš„å…„å¼Ÿé»˜é»˜åŸ‹å•äº†ï¼Œä¼šä¸ä¼šæ„ŸåŠ¨å¾—å“­äº†^_^ï¼‰</p><h5 id="3-3-1-AudioTrack-å†™æ•°æ®æµç¨‹"><a href="#3-3-1-AudioTrack-å†™æ•°æ®æµç¨‹" class="headerlink" title="3.3. 1. AudioTrack å†™æ•°æ®æµç¨‹"></a>3.3. 1. AudioTrack å†™æ•°æ®æµç¨‹</h5><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ AudioTrack å†™æ•°æ®çš„ä»£ç ï¼Œæµç¨‹å¾ˆç®€å•ï¼šobtainBuffer() åœ¨ FIFO ä¸­æ‰¾åˆ°ä¸€å—å¯ç”¨åŒºé—´ï¼Œmemcpy() æŠŠç”¨æˆ·ä¼ å…¥çš„éŸ³é¢‘æ•°æ®æ‹·è´åˆ°è¿™ä¸ªå¯ç”¨åŒºé—´ä¸Šï¼ŒreleaseBuffer() æ›´æ–°å†™ä½ç½®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmedia\AudioTrack.cpp]</span><br><span class="line">ssize_t AudioTrack::write(const void* buffer, size_t userSize, bool blocking)</span><br><span class="line">&#123;</span><br><span class="line">    if (mTransfer != TRANSFER_SYNC) &#123;</span><br><span class="line">        return INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isDirect()) &#123;</span><br><span class="line">        AutoMutex lock(mLock);</span><br><span class="line">        int32_t flags = android_atomic_and(</span><br><span class="line">                            ~(CBLK_UNDERRUN | CBLK_LOOP_CYCLE | CBLK_LOOP_FINAL | CBLK_BUFFER_END),</span><br><span class="line">                            &amp;mCblk-&gt;mFlags);</span><br><span class="line">        if (flags &amp; CBLK_INVALID) &#123;</span><br><span class="line">            return DEAD_OBJECT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ssize_t(userSize) &lt; 0 || (buffer == NULL &amp;&amp; userSize != 0)) &#123;</span><br><span class="line">        // Sanity-check: user is most-likely passing an error code, and it would</span><br><span class="line">        // make the return value ambiguous (actualSize vs error).</span><br><span class="line">        ALOGE(&quot;AudioTrack::write(buffer=%p, size=%zu (%zd)&quot;, buffer, userSize, userSize);</span><br><span class="line">        return BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size_t written = 0;</span><br><span class="line">    Buffer audioBuffer;</span><br><span class="line"></span><br><span class="line">    while (userSize &gt;= mFrameSize) &#123;</span><br><span class="line">        // å•å¸§æ•°æ®é‡ frameSize = channelCount * bytesPerSample</span><br><span class="line">        //   å¯¹äºåŒå£°é“ï¼Œ16ä½é‡‡æ ·çš„éŸ³é¢‘æ•°æ®æ¥è¯´ï¼ŒframeSize = 2 * 2 = 4(bytes)</span><br><span class="line">        // ç”¨æˆ·ä¼ å…¥çš„æ•°æ®å¸§æ•° frameCount = userSize / frameSize</span><br><span class="line">        audioBuffer.frameCount = userSize / mFrameSize;</span><br><span class="line"></span><br><span class="line">        // obtainBuffer() ä» FIFO ä¸Šå¾—åˆ°ä¸€å—å¯ç”¨åŒºé—´</span><br><span class="line">        status_t err = obtainBuffer(&amp;audioBuffer,</span><br><span class="line">                blocking ? &amp;ClientProxy::kForever : &amp;ClientProxy::kNonBlocking);</span><br><span class="line">        if (err &lt; 0) &#123;</span><br><span class="line">            if (written &gt; 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (err == TIMED_OUT || err == -EINTR) &#123;</span><br><span class="line">                err = WOULD_BLOCK;</span><br><span class="line">            &#125;</span><br><span class="line">            return ssize_t(err);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // toWrite æ˜¯ FIFO å¯ç”¨åŒºé—´çš„å¤§å°ï¼Œå¯èƒ½æ¯” userSizeï¼ˆç”¨æˆ·ä¼ å…¥æ•°æ®çš„å¤§å°ï¼‰è¦å°</span><br><span class="line">        //   å› æ­¤ç”¨æˆ·ä¼ å…¥çš„æ•°æ®å¯èƒ½è¦æ‹†åˆ†å¤šæ¬¡æ‹·è´åˆ° FIFO ä¸Š</span><br><span class="line">        // æ³¨æ„ï¼šAudioTrack å’Œ AudioFlinger æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼ŒAudioFlinger åŒæ—¶ä¹Ÿåœ¨ä¸åœåœ°</span><br><span class="line">        //   æ¶ˆè€—æ•°æ®ï¼Œæ‰€ä»¥ FIFO å¯ç”¨åŒºé—´æ˜¯åœ¨ä¸åœå˜åŒ–çš„</span><br><span class="line">        size_t toWrite = audioBuffer.size;</span><br><span class="line">        memcpy(audioBuffer.i8, buffer, toWrite); // æŠŠç”¨æˆ·æ•°æ®æ‹·è´åˆ° FIFO å¯ç”¨åŒºé—´</span><br><span class="line">        buffer = ((const char *) buffer) + toWrite; // æœªæ‹·è´æ•°æ®çš„ä½ç½®</span><br><span class="line">        userSize -= toWrite; // æœªæ‹·è´æ•°æ®çš„å¤§å°</span><br><span class="line">        written += toWrite; // å·²æ‹·è´æ•°æ®çš„å¤§å°</span><br><span class="line"></span><br><span class="line">        // releaseBuffer() æ›´æ–° FIFO å†™ä½ç½®</span><br><span class="line">        // å¯¹äº AudioFinger æ¥è¯´ï¼Œæ„å‘³ FIFO ä¸Šæœ‰æ›´å¤šçš„å¯è¯»æ•°æ®</span><br><span class="line">        releaseBuffer(&amp;audioBuffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (written &gt; 0) &#123;</span><br><span class="line">        mFramesWritten += written / mFrameSize;</span><br><span class="line">    &#125;</span><br><span class="line">    return written;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-3-2-AudioFlinger-è¯»æ•°æ®æµç¨‹"><a href="#3-3-2-AudioFlinger-è¯»æ•°æ®æµç¨‹" class="headerlink" title="3.3. 2. AudioFlinger è¯»æ•°æ®æµç¨‹"></a>3.3. 2. AudioFlinger è¯»æ•°æ®æµç¨‹</h5><p>AudioFlinger æ¶ˆè´¹æ•°æ®çš„æµç¨‹ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œ3.4. AudioFlinger å›æ”¾å½•åˆ¶çº¿ç¨‹ å°èŠ‚ä¸­æè¿°äº† AudioFlinger::PlaybackThread::threadLoop() å·¥ä½œæµç¨‹ï¼Œè¿™é‡Œä¸ç´¯è¿°äº†ï¼Œæˆ‘ä»¬æŠŠç„¦ç‚¹æ”¾åœ¨â€œå¦‚ä½•ä» FIFO è¯»å–æ•°æ®â€èŠ‚ç‚¹ä¸Šã€‚</p><p>æˆ‘ä»¬ä»¥ DirectOutputThread/OffloadThread ä¸ºä¾‹è¯´æ˜ï¼ˆMixerThread è¯»æ•°æ®ä¹Ÿæ˜¯ç±»ä¼¼çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡æ˜¯åœ¨ AudioMixer ä¸­è¿›è¡Œçš„ï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">void AudioFlinger::DirectOutputThread::threadLoop_mix()</span><br><span class="line">&#123;</span><br><span class="line">    // mFrameCount æ˜¯ç¡¬ä»¶è®¾å¤‡ï¼ˆPCM è®¾å¤‡ï¼‰å¤„ç†å•ä¸ªæ•°æ®å—çš„å¸§æ•°ï¼ˆå‘¨æœŸå¤§å°ï¼‰</span><br><span class="line">    //   ä¸Šå±‚å¿…é¡»ç§¯ç´¯äº†è¶³å¤Ÿå¤šï¼ˆmFrameCountï¼‰çš„æ•°æ®ï¼Œæ‰å†™å…¥åˆ° PCM è®¾å¤‡</span><br><span class="line">    //   æ‰€ä»¥ mFrameCount ä¹Ÿå°±æ˜¯ AudioFlinger é¢„æœŸçš„æ•°æ®é‡</span><br><span class="line">    size_t frameCount = mFrameCount;</span><br><span class="line">    // mSinkBuffer ç›®çš„ç¼“å†²åŒºï¼ŒthreadLoop_write() ä¼šæŠŠ mSinkBuffer ä¸Šçš„æ•°æ®å†™åˆ° PCM è®¾å¤‡</span><br><span class="line">    int8_t *curBuf = (int8_t *)mSinkBuffer;</span><br><span class="line">    // output audio to hardware</span><br><span class="line">    // FIFO ä¸Šå¯è¯»çš„æ•°æ®é‡å¯èƒ½è¦æ¯”é¢„æœŸçš„è¦å°ï¼Œå› æ­¤å¯èƒ½éœ€è¦å¤šæ¬¡è¯»å–æ‰èƒ½ç§¯ç´¯è¶³å¤Ÿçš„æ•°æ®é‡</span><br><span class="line">    // æ³¨æ„ï¼šAudioTrack å’Œ AudioFlinger æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼ŒAudioTrack åŒæ—¶ä¹Ÿåœ¨ä¸åœåœ°ç”Ÿäº§æ•°æ®</span><br><span class="line">    //   æ‰€ä»¥ FIFO å¯è¯»çš„æ•°æ®é‡æ˜¯åœ¨ä¸åœå˜åŒ–çš„</span><br><span class="line">    while (frameCount) &#123;</span><br><span class="line">        AudioBufferProvider::Buffer buffer;</span><br><span class="line">        buffer.frameCount = frameCount;</span><br><span class="line">        // getNextBuffer() ä» FIFO ä¸Šè·å–å¯è¯»æ•°æ®å—</span><br><span class="line">        status_t status = mActiveTrack-&gt;getNextBuffer(&amp;buffer);</span><br><span class="line">        if (status != NO_ERROR || buffer.raw == NULL) &#123;</span><br><span class="line">            memset(curBuf, 0, frameCount * mFrameSize);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        // memcpy() æŠŠ FIFO å¯è¯»æ•°æ®æ‹·è´åˆ° mSinkBuffer ç›®çš„ç¼“å†²åŒº</span><br><span class="line">        memcpy(curBuf, buffer.raw, buffer.frameCount * mFrameSize);</span><br><span class="line">        frameCount -= buffer.frameCount;</span><br><span class="line">        curBuf += buffer.frameCount * mFrameSize;</span><br><span class="line">        // releaseBuffer() æ›´æ–° FIFO è¯»ä½ç½®</span><br><span class="line">        // å¯¹äº AudioTrack æ¥è¯´ï¼Œæ„å‘³ç€ FIFO ä¸Šæœ‰æ›´å¤šçš„å¯ç”¨ç©ºé—´</span><br><span class="line">        mActiveTrack-&gt;releaseBuffer(&amp;buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    mCurrentWriteLength = curBuf - (int8_t *)mSinkBuffer;</span><br><span class="line">    mSleepTimeUs = 0;</span><br><span class="line">    mStandbyTimeNs = systemTime() + mStandbyDelayNs;</span><br><span class="line">    mActiveTrack.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-3-3-ç¯å½¢-FIFO-ç®¡ç†"><a href="#3-3-3-ç¯å½¢-FIFO-ç®¡ç†" class="headerlink" title="3.3. 3. ç¯å½¢ FIFO ç®¡ç†"></a>3.3. 3. ç¯å½¢ FIFO ç®¡ç†</h5><p>åœ¨ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œä¸çŸ¥å¤§å®¶æœ‰æ— æ„è¯†åˆ°ï¼šæ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ€éš¾çš„æ˜¯å¦‚ä½•åè°ƒç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´çš„æ­¥è°ƒã€‚ä¸Šæ–‡æ‰€è¯´çš„ FIFO æ˜¯ç¯å½¢ FIFOï¼ŒAudioTrack å†™æŒ‡é’ˆã€AudioFlinger è¯»æŒ‡é’ˆéƒ½æ˜¯åŸºäº FIFO å½“å‰çš„è¯»å†™ä½ç½®æ¥è®¡ç®—çš„ã€‚</p><p>â˜¯AudioTrack ä¸ AudioFlinger ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸Šï¼Œæ€ä¹ˆä¿è¯è¯»å†™æŒ‡é’ˆçš„çº¿ç¨‹å®‰å…¨<br>â˜¯è¯»å†™æŒ‡é’ˆè¶Šè¿‡ FIFO åï¼Œæ€ä¹ˆå¤„ç†<br>â˜¯AudioTrack å†™æ•°æ®å®Œæˆåï¼Œéœ€è¦åŒæ­¥çŠ¶æ€ç»™ AudioFlingerï¼Œè®© AudioFlinger çŸ¥é“å½“å‰æœ‰å¯è¯»æ•°æ®äº†ï¼Œè€Œ AudioFlinger è¯»æ•°æ®å®Œæˆåï¼Œä¹Ÿéœ€è¦åŒæ­¥çŠ¶æ€ç»™ AudioTrackï¼Œè®© AudioTrack çŸ¥é“å½“å‰æœ‰å¯ç”¨ç©ºé—´äº†ï¼›è¿™é‡Œé‡‡å–ä»€ä¹ˆåŒæ­¥æœºåˆ¶<br>æˆ‘ä»¬å›é¡¾ä¸‹åˆ›å»º AudioTrack å¯¹è±¡æ—¶ï¼ŒFIFO åŠå…¶æ§åˆ¶å—çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MODE_STREAM æ¨¡å¼ä¸‹çš„åŒ¿åå…±äº«å†…å­˜ç»“æ„ï¼š</span><br><span class="line">  |                                                         |</span><br><span class="line">  | -------------------&gt; mCblkMemory &lt;--------------------- |</span><br><span class="line">  |                                                         |</span><br><span class="line">  +--------------------+------------------------------------+</span><br><span class="line">  | audio_track_cblk_t |               FIFO                 |</span><br><span class="line">  +--------------------+------------------------------------+</span><br><span class="line">  ^                    ^</span><br><span class="line">  |                    |</span><br><span class="line">mCblk               mBuffer</span><br><span class="line"></span><br><span class="line">mCblk = static_cast&lt;audio_track_cblk_t *&gt;(mCblkMemory-&gt;pointer());</span><br><span class="line">new(mCblk) audio_track_cblk_t();</span><br><span class="line">mBuffer = (char*)mCblk + sizeof(audio_track_cblk_t);</span><br></pre></td></tr></table></figure><p>â˜¯MODE_STATIC æ¨¡å¼ä¸‹çš„åŒ¿åå…±äº«å†…å­˜ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  +--------------------+    +-----------------------------------+</span><br><span class="line">  | audio_track_cblk_t |    |         FIFO (sharedBuffer)       |</span><br><span class="line">  +--------------------+    +-----------------------------------+</span><br><span class="line">  ^                         ^</span><br><span class="line">  |                         |</span><br><span class="line">mCblk                    mBuffer</span><br><span class="line"></span><br><span class="line">mCblk = (audio_track_cblk_t *) new uint8_t[size];</span><br><span class="line">new(mCblk) audio_track_cblk_t();</span><br><span class="line">mBuffer = sharedBuffer-&gt;pointer()</span><br></pre></td></tr></table></figure><p>FIFO ç®¡ç†ç›¸å…³çš„ç±»å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/315-Audio-system-FIFO.jpg" alt="Alt text"></p><p>â˜¯AudioTrackClientProxyï¼šMODE_STREAM æ¨¡å¼ä¸‹ï¼Œç”Ÿäº§è€… AudioTrack ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯ç”¨ç©ºé—´çš„ä½ç½®<br>â˜¯AudioTrackServerProxyï¼šMODE_STREAM æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€… AudioFlinger::PlaybackThread ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯è¯»æ•°æ®çš„ä½ç½®<br>â˜¯StaticAudioTrackClientProxyï¼šMODE_STATIC æ¨¡å¼ä¸‹ï¼Œç”Ÿäº§è€… AudioTrack ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯ç”¨ç©ºé—´çš„ä½ç½®<br>â˜¯StaticAudioTrackServerProxyï¼šMODE_STATIC æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€… AudioFlinger::PlaybackThread ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯è¯»æ•°æ®çš„ä½ç½®<br>â˜¯AudioRecordClientProxyï¼šæ¶ˆè´¹è€… AudioRecord ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯è¯»æ•°æ®çš„ä½ç½®<br>â˜¯AudioTrackServerProxyï¼šç”Ÿäº§è€… AudioFlinger::RecordThread ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯ç”¨ç©ºé—´çš„ä½ç½®<br>åˆ°è¿™é‡Œï¼Œæˆ‘å†³å®šç»“æŸæœ¬æ–‡äº†ã€‚ç¯å½¢ FIFO ç®¡ç†æ˜¯ Android éŸ³é¢‘ç³»ç»Ÿçš„ç²¾é«“ï¼Œä¸€ä¸ªå°èŠ‚å¹¶ä¸è¶³ä»¥æè¿°å…¶åŸç†åŠå®ç°ç»†èŠ‚ï¼›Android ç¯å½¢ FIFO çš„å®ç°å¯è¯´å¾—ä¸Šç²¾å¦™ç»ä¼¦ï¼Œå…¶ä»–é¡¹ç›®å¦‚æœè¦ç”¨åˆ°ç¯å½¢ FIFOï¼Œä¸å¦¨å¤šå€Ÿé‰´å®ƒã€‚</p><h4 id="å››-ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹"><a href="#å››-ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹" class="headerlink" title="(å››)ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹"></a>(å››)ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹</h4><p>æ—¶åºå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/316-Audio-system-mediaplayer-playback.png" alt="Alt text"></p><h4 id="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://zhuanlan.zhihu.com/p/27480328" target="_blank" rel="noopener">AndroidéŸ³é¢‘æ¨¡å—å¯åŠ¨æµç¨‹åˆ†æ</a><br><a href="https://zhuanlan.zhihu.com/jhuster" target="_blank" rel="noopener">Jhusterçš„ä¸“æ â€‹ AndroidéŸ³é¢‘å¼€å‘</a><br><a href="http://thinks.me/2016/09/13/audio_qcom_offload/" target="_blank" rel="noopener">é«˜é€šaudio offloadå­¦ä¹  | Thinking</a><br><a href="https://blog.csdn.net/droidphone/article/category/1118446" target="_blank" rel="noopener">DroidPhoneçš„ä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8866071" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„1-CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8982771" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„2-ASoc - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8995163" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„3-Pcm - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8999364" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„4-å£°å¡æ§åˆ¶ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59180272" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šé€»è¾‘è®¾å¤‡ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59170418" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šç‰©ç†é“¾è·¯ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/12812.html" target="_blank" rel="noopener">ä¸“æ ï¼šMultiMediaæ¡†æ¶æ€»ç»“(åŸºäº6.0æºç ) - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/60890534" target="_blank" rel="noopener">Android éŸ³é¢‘ç³»ç»Ÿï¼šä» AudioTrack åˆ° AudioFlinger - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/azloong/article/category/778492" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ALSA-Android Audio</a><br><a href="https://blog.csdn.net/azloong/article/category/777239" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ANDROIDéŸ³é¢‘ç³»ç»Ÿ</a><br><a href="https://winddoing.github.io/2017/07/10/audio_alsa/" target="_blank" rel="noopener">Audioé©±åŠ¨æ€»ç»“â€“ALSA | Winddoingâ€™s Blog</a><br><a href="http://www.cnblogs.com/muhe221/articles/4461543.html" target="_blank" rel="noopener">audio HAL - ç‰§ å¤© - åšå®¢å›­</a><br><a href="https://blog.csdn.net/xuesen_lin/article/category/1390680" target="_blank" rel="noopener">æ—å­¦æ£®çš„Androidä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">æ·±å…¥å‰–æAndroidéŸ³é¢‘ - CSDNåšå®¢Yangwen123</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">æ’­æ”¾æ¡†æ¶ - æ ‡ç­¾ - Tocy - åšå®¢å›­</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57415505" target="_blank" rel="noopener">Android-7.0-Nuplayeræ¦‚è¿° - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/56961370" target="_blank" rel="noopener">Android-7.0-Nuplayer-å¯åŠ¨æµç¨‹ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53386010" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-Nuplayerï¼ˆ1ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53397945" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-AHandler AMessage ALooper - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/category/6344583" target="_blank" rel="noopener">Android N Audioæ’­æ”¾ startçœŸé¢ç›®- (å…­ç¯‡) CSDNåšå®¢</a><br><a href="https://blog.csdn.net/nonmarking/article/details/78746671" target="_blank" rel="noopener">æ·±å…¥ç†è§£AndroidéŸ³è§†é¢‘åŒæ­¥æœºåˆ¶ï¼ˆäº”ç¯‡ï¼‰NuPlayerçš„avsyncé€»è¾‘ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/u014310046/article/category/6571854" target="_blank" rel="noopener">wangyfçš„ä¸“æ  - CSDNåšå®¢-MT6737 Android N å¹³å° Audioç³»ç»Ÿå­¦ä¹ </a><br><a href="https://blog.csdn.net/xiashaohua/article/details/53638780" target="_blank" rel="noopener">Android 7.0 Audio: Mediaplayer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/xiashaohua/article/category/6549668" target="_blank" rel="noopener">Android 7.0 Audio-ç›¸å…³ç±»æµ…æ- CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/details/59119144" target="_blank" rel="noopener">Android N Audioæ’­æ”¾å…­ï¼šå¦‚ä½•è¯»å–buffer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/78007568" target="_blank" rel="noopener">Fuchsia OSä¸­çš„RPCæœºåˆ¶-FIDL - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/linhaostudy/category/1145404.html" target="_blank" rel="noopener">é«˜é€šAudioä¸­ASOCçš„codecé©±åŠ¨ - yooooooo - åšå®¢å›­</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/05/15/Audio%20System%EF%BC%882%EF%BC%89%EF%BC%9ALinux%20ALSA%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/05/15/Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ/</id>
    <published>2018-05-14T16:00:00.000Z</published>
    <updated>2018-05-09T15:03:49.790Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/audio.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p><a href="https://blog.csdn.net/zyuanyun" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - é›²å’Œå±±çš„å½¼ç«¯ - éŸ³é¢‘ç³»ç»Ÿåˆ†æã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆKernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆAndroid 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>æºç ï¼ˆä¸»è¦æºç è·¯å¾„ï¼‰ï¼š</p><blockquote><p>User space audio code æºç ï¼š</p></blockquote><p>â€¢ <strong>/hardware/qcom/audio/hal/ â€“ (Audio HAL æºç )</strong> </p><p>â€¢ <strong>/external/tinyalsa/ â€“  (tinymix, tinyplay, tinycap æºç )</strong></p><p>â€¢ <strong>/vendor/qcom/proprietary/mm-audio/ â€“ (QTI OMX  audio encoder and decoders æºç ï¼Œæœªå…¬å¼€)</strong></p><p>â€¢ <strong>/frameworks/av/media/audioserver/ â€“ (Audioserver æºç )</strong></p><p>â€¢ <strong>/frameworks/av/media/libstagefright/ â€“ (Google Stagefright å¤šåª’ä½“æ¡†æ¶æºç )</strong></p><p>â€¢ <strong>/frameworks/av/services/audioflinger/ â€“ (Audioflinger ç›¸å…³æºç )</strong></p><p>â€¢ <strong>/external/bluetooth/bluedroid/ â€“ (A2DP audio HAL ç›¸å…³æºç )</strong>/</p><p>â€¢ <strong>/hardware/libhardware/modules/usbaudio/ â€“ (USB HAL æºç )</strong>/</p><p>â€¢ <strong>/vendor/qcom/proprietary/wfd/mm/source/framework/src/ â€“ (Wi-Fi Display (WFD)ã€ WFDMMSourceAudioSource.cppï¼Œæœªå…¬å¼€)</strong></p><p>â€¢ <strong>/system/core/include/system/ â€“ (audio.h)</strong>/</p><blockquote><p>Kernel space audio code æºç ï¼š</p></blockquote><p>â€¢ <strong>/kernel/sound/soc/msm/ â€“  msm8996.c machine driver æºç  </strong></p><p>â€¢ <strong>/kernel/sound/soc/msm/qdsp6v2 â€“  platform drivers, front end (FE), and back-end (BE) DAI driver, Hexagon DSP drivers for AFE, ADM, and ASM, voice driver ç›¸å…³æºç </strong></p><p>â€¢ <strong>kernel/sound/soc/soc-<em>.c â€“ All the SoC-</em>.c  ALSA SoCs framework æºç </strong></p><p>â€¢ <strong>kernel/drivers/slimbus/ â€“  SLIMbus driver æºç  </strong></p><p>â€¢ <strong>kernel/arch/arm/mach-msm/ â€“ åŒ…å«æ¯”å¦‚ acpuclock-8996.c, board-8996-gpiomux.c, board-8996.c, and clock-8996.c related to the GPIO, clock, and board-specific information on the MSM8996 ç›¸å…³æºç </strong></p><p>â€¢ <strong>/kernel/arch/arm/mach-msm/qdsp6v2/ â€“ Contains the drivers for DSP-based encoders and decoders, code for the aDSP loader, APR driver, Ion memory driver, and other utility files</strong></p><p>â€¢ <strong>/kernel/arch/arm/boot/dts â€“ Contains MSM8996-<em>.its and MSM8996-</em>.Dtsi files that contain MSM8996-specific information; audio-related customization is available in files such as MSM8996.dtsi, msm8996-mtp.dtsi, and msm8996-cdp.dtsi</strong></p><p>â€¢ <strong>/kernel/sound/soc/codecs/ â€“ Contains the source code for the codec driver for WCD9335; codec driver-related source files are wcd9335.c, wcd9xxx-mbhc.c, wcd9xxx-resmgr.c, wcd9xxx-common.c, and so on.</strong></p><p>â€¢ <strong>/kernel/drivers/mfd/ â€“ Contains the source code for the codec driver; wcd9xxx-core.c, wcd9xxx-slimslave.c, and wcd9xxx-irq.c are the codec driverrelated files</strong></p><h4 id="ï¼ˆä¸€ï¼‰-Overview"><a href="#ï¼ˆä¸€ï¼‰-Overview" class="headerlink" title="ï¼ˆä¸€ï¼‰ Overview"></a>ï¼ˆä¸€ï¼‰ Overview</h4><p>ç¡¬ä»¶å¹³å°åŠè½¯ä»¶ç‰ˆæœ¬ï¼š<br>â˜ Kernel - 3.18<br>â˜ SoC - Qualcomm snapdragon<br>â˜ CODEC - WCD9335<br>â˜ Machine - msm8996<br>â˜ Userspace - tinyalsa</p><p>Linux ALSA éŸ³é¢‘ç³»ç»Ÿæ¶æ„å¤§è‡´å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/21-Audio-system-Android-Linux-ASoc-arc.png.png" alt="Alt text"></p><p>â€¢ Native ALSA Applicationï¼štinyplay/tinycap/tinymixï¼Œè¿™äº›ç”¨æˆ·ç¨‹åºç›´æ¥è°ƒç”¨ alsa ç”¨æˆ·åº“æ¥å£æ¥å®ç°æ”¾éŸ³ã€å½•éŸ³ã€æ§åˆ¶<br>â€¢ ALSA Library APIï¼šalsa ç”¨æˆ·åº“æ¥å£ï¼Œå¸¸è§æœ‰ tinyalsaã€alsa-lib<br>â€¢ ALSA COREï¼šalsa æ ¸å¿ƒå±‚ï¼Œå‘ä¸Šæä¾›é€»è¾‘è®¾å¤‡ï¼ˆPCM/CTL/MIDI/TIMER/â€¦ï¼‰ç³»ç»Ÿè°ƒç”¨ï¼Œå‘ä¸‹é©±åŠ¨ç¡¬ä»¶è®¾å¤‡ï¼ˆMachine/I2S/DMA/CODECï¼‰<br>â€¢ ASoC COREï¼šasoc æ˜¯å»ºç«‹åœ¨æ ‡å‡† alsa core åŸºç¡€ä¸Šï¼Œä¸ºäº†æ›´å¥½æ”¯æŒåµŒå…¥å¼ç³»ç»Ÿå’Œåº”ç”¨äºç§»åŠ¨è®¾å¤‡çš„éŸ³é¢‘ codec çš„ä¸€å¥—è½¯ä»¶ä½“ç³»<br>â€¢ Hardware Driverï¼šéŸ³é¢‘ç¡¬ä»¶è®¾å¤‡é©±åŠ¨ï¼Œç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ Machineã€Platformã€Codec</p><p>Platformï¼šæŒ‡æŸæ¬¾ SoC å¹³å°çš„éŸ³é¢‘æ¨¡å—ï¼Œå¦‚ exynosã€omapã€qcom ç­‰ç­‰ã€‚Platform åˆå¯ç»†åˆ†ä¸¤éƒ¨åˆ†ï¼š</p><p>  â€¢ cpu daiï¼šåœ¨åµŒå…¥å¼ç³»ç»Ÿé‡Œé¢é€šå¸¸æŒ‡ SoC çš„ I2Sã€PCM æ€»çº¿æ§åˆ¶å™¨ï¼Œè´Ÿè´£æŠŠéŸ³é¢‘æ•°æ®ä» I2S tx FIFO æ¬è¿åˆ° CODECï¼ˆè¿™æ˜¯å›æ”¾çš„æƒ…å½¢ï¼Œå½•åˆ¶åˆ™æ–¹å‘ç›¸åï¼‰ã€‚cpu_dai é€šè¿‡ <strong>snd_soc_register_dai()</strong> æ¥æ³¨å†Œã€‚æ³¨ï¼šDAI æ˜¯ Digital Audio Interface çš„ç®€ç§°ï¼Œåˆ†ä¸º cpu_dai å’Œ codec_daiï¼Œè¿™ä¸¤è€…é€šè¿‡ I2S/PCM æ€»çº¿è¿æ¥ï¼›AIF æ˜¯ Audio Interface çš„ç®€ç§°ï¼ŒåµŒå…¥å¼ç³»ç»Ÿä¸­ä¸€èˆ¬æ˜¯ I2S å’Œ PCM æ¥å£ã€‚<br>  â€¢ pcm dmaï¼šè´Ÿè´£æŠŠ dma buffer ä¸­çš„éŸ³é¢‘æ•°æ®æ¬è¿åˆ° I2S tx FIFOã€‚å€¼å¾—ç•™æ„çš„æ˜¯ï¼šæŸäº›æƒ…å½¢ä¸‹æ˜¯ä¸éœ€è¦ dma æ“ä½œçš„ï¼Œæ¯”å¦‚ Modem å’Œ CODEC ç›´è¿ï¼Œå› ä¸º Modem æœ¬èº«å·²ç»æŠŠæ•°æ®é€åˆ° FIFO äº†ï¼Œè¿™æ—¶åªéœ€å¯åŠ¨ codec_dai æ¥æ”¶æ•°æ®å³å¯ï¼›è¯¥æƒ…å½¢ä¸‹ï¼ŒMachine é©±åŠ¨ dai_link ä¸­éœ€è¦è®¾å®š .platform_name = â€œmsm-pcm-xxxâ€ã€‚</p><p>Codecï¼šå¯¹äºå›æ”¾æ¥è¯´ï¼Œuserspace é€è¿‡æ¥çš„éŸ³é¢‘æ•°æ®æ˜¯ç»è¿‡é‡‡æ ·é‡åŒ–çš„æ•°å­—ä¿¡å·ï¼Œåœ¨ codec ç»è¿‡ DAC è½¬æ¢æˆæ¨¡æ‹Ÿä¿¡å·ç„¶åè¾“å‡ºåˆ°å¤–æ”¾æˆ–è€³æœºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¬åˆ°å£°éŸ³äº†ã€‚Codec å­—é¢æ„æ€æ˜¯ç¼–è§£ç å™¨ï¼Œä½†èŠ¯ç‰‡é‡Œé¢çš„åŠŸèƒ½éƒ¨ä»¶å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ AIFã€DACã€ADCã€Mixerã€PGAã€Line-inã€Line-outï¼Œæœ‰äº›é«˜ç«¯çš„ codec èŠ¯ç‰‡è¿˜æœ‰ EQã€DSPã€SRCã€DRCã€AGCã€Echo-Cancellerã€Noise-Suppression ç­‰éƒ¨ä»¶ã€‚</p><p>Machineï¼šæŒ‡æŸæ¬¾æœºå™¨ï¼Œé€šè¿‡é…ç½® dai_link æŠŠ cpu_daiã€codec_daiã€modem_dai å„ä¸ªéŸ³é¢‘æ¥å£ç»™é“¾ç»“æˆä¸€æ¡æ¡éŸ³é¢‘é“¾è·¯ï¼Œç„¶åæ³¨å†Œ snd_soc_cardã€‚å’Œä¸Šé¢ä¸¤ä¸ªä¸ä¸€æ ·ï¼ŒPlatform å’Œ CODEC é©±åŠ¨ä¸€èˆ¬æ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œè€Œ Machine æœ‰å®ƒç‰¹å®šçš„ç¡¬ä»¶ç‰¹æ€§ï¼Œå‡ ä¹æ˜¯ä¸å¯é‡ç”¨çš„ã€‚æ‰€è°“çš„ç¡¬ä»¶ç‰¹æ€§æŒ‡ï¼šSoC Platform ä¸ Codec çš„å·®å¼‚ï¼›DAIs ä¹‹é—´çš„é“¾ç»“æ–¹å¼ï¼›é€šè¿‡æŸä¸ª GPIO æ‰“å¼€ Amplifierï¼›é€šè¿‡æŸä¸ª GPIO æ£€æµ‹è€³æœºæ’æ‹”ï¼›ä½¿ç”¨æŸä¸ªæ—¶é’Ÿå¦‚ MCLK/External-OSC ä½œä¸º I2Sã€CODEC çš„æ—¶é’Ÿæºç­‰ç­‰ã€‚</p><p>ä»ä¸Šé¢çš„æè¿°æ¥çœ‹ï¼Œå¯¹äºå›æ”¾çš„æƒ…å½¢ï¼ŒPCM æ•°æ®æµå‘å¤§è‡´æ˜¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        copy_from_user           DMA                 I2S           DAC</span><br><span class="line">              ^                   ^                   ^             ^</span><br><span class="line">+---------+   |    +----------+   |   +-----------+   |   +-----+   |   +------+</span><br><span class="line">|userspace+--------&gt;DMA Buffer+-------&gt;I2S TX FIFO+-------&gt;CODEC+-------&gt;SPK/HP|</span><br><span class="line">+---------+        +----------+       +-----------+       +-----+       +------+</span><br></pre></td></tr></table></figure><p>å‡ ä¸ªéŸ³é¢‘ç‰©ç†é“¾è·¯çš„æ¦‚å¿µï¼š</p><p>dai_linkï¼šmachine é©±åŠ¨ä¸­å®šä¹‰çš„éŸ³é¢‘æ•°æ®é“¾è·¯ï¼Œå®ƒæŒ‡å®šé“¾è·¯ç”¨åˆ°çš„ codecã€codec_daiã€cpu_daiã€platformã€‚æ¯”å¦‚å¯¹äº WCD9335 å¹³å°çš„ media é“¾è·¯ï¼š.codec_dai_name = â€œsnd-soc-dummy-daiâ€, .codec_name = â€œsnd-soc-dummyâ€, .cpu_dai_name = â€œMultiMediaXâ€, .platform_name = â€œmsm-pcm-dsp.0â€ï¼Œè¿™å››è€…å°±æ„æˆäº†ä¸€æ¡éŸ³é¢‘æ•°æ®é“¾è·¯ç”¨äºå¤šåª’ä½“å£°éŸ³çš„å›æ”¾å’Œå½•åˆ¶ã€‚ä¸€ä¸ªç³»ç»Ÿå¯èƒ½æœ‰å¤šä¸ªéŸ³é¢‘æ•°æ®é“¾è·¯ï¼Œæ¯”å¦‚ media å’Œ voiceï¼Œå› æ­¤å¯ä»¥å®šä¹‰å¤šä¸ª dai_link ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm8996.c]</span><br><span class="line"><span class="comment">/* Digital audio interface glue - connects codec &lt;---&gt; CPU */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> <span class="title">msm8996_common_dai_links</span>[] = &#123;</span></span><br><span class="line"><span class="comment">/* FrontEnd DAI Links */</span></span><br><span class="line">&#123;</span><br><span class="line">.name = <span class="string">"MSM8996 Media1"</span>,</span><br><span class="line">.stream_name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">.cpu_dai_name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">.platform_name = <span class="string">"msm-pcm-dsp.0"</span>,</span><br><span class="line">.dynamic = <span class="number">1</span>,</span><br><span class="line">.async_ops = ASYNC_DPCM_SND_SOC_PREPARE,</span><br><span class="line">.dpcm_playback = <span class="number">1</span>,</span><br><span class="line">.dpcm_capture = <span class="number">1</span>,</span><br><span class="line">.trigger = &#123;SND_SOC_DPCM_TRIGGER_POST,</span><br><span class="line">SND_SOC_DPCM_TRIGGER_POST&#125;,</span><br><span class="line">.codec_dai_name = <span class="string">"snd-soc-dummy-dai"</span>,</span><br><span class="line">.codec_name = <span class="string">"snd-soc-dummy"</span>,</span><br><span class="line">.ignore_suspend = <span class="number">1</span>,</span><br><span class="line"><span class="comment">/* this dainlink has playback support */</span></span><br><span class="line">.ignore_pmdown_time = <span class="number">1</span>,</span><br><span class="line">.be_id = MSM_FRONTEND_DAI_MULTIMEDIA1</span><br><span class="line">&#125;,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/22-MSM8996-Linux-Android-Audio-ASoc-Architectre.png" alt="Alt text"></p><p>é«˜é€šå¹³å°å› DSPè€Œå­˜åœ¨ç‰¹æ®Šæ€§ï¼Œå¦‚ä¸Šå›¾ï¼ŒFrontend é“¾æ¥ â€œPlatformâ€ï¼Œç»ç”± â€œPlatformâ€-&gt;Backendé“¾æ¥åˆ°Codecã€‚<br>Front-end DAIï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm-dai-fe.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> <span class="title">msm_fe_dais</span>[] = &#123;</span></span><br><span class="line">&#123;</span><br><span class="line">.playback = &#123;</span><br><span class="line">.stream_name = <span class="string">"MultiMedia1 Playback"</span>,</span><br><span class="line">.aif_name = <span class="string">"MM_DL1"</span>,</span><br><span class="line">.rates = (SNDRV_PCM_RATE_8000_192000|</span><br><span class="line">SNDRV_PCM_RATE_KNOT),</span><br><span class="line">.formats = (SNDRV_PCM_FMTBIT_S16_LE |</span><br><span class="line">SNDRV_PCM_FMTBIT_S24_LE |</span><br><span class="line">SNDRV_PCM_FMTBIT_S24_3LE),</span><br><span class="line">.channels_min = <span class="number">1</span>,</span><br><span class="line">.channels_max = <span class="number">8</span>,</span><br><span class="line">.rate_min =     <span class="number">8000</span>,</span><br><span class="line">.rate_max =<span class="number">192000</span>,</span><br><span class="line">&#125;,</span><br><span class="line">.capture = &#123;</span><br><span class="line">.stream_name = <span class="string">"MultiMedia1 Capture"</span>,</span><br><span class="line">.aif_name = <span class="string">"MM_UL1"</span>,</span><br><span class="line">.rates = (SNDRV_PCM_RATE_8000_192000|</span><br><span class="line">SNDRV_PCM_RATE_KNOT),</span><br><span class="line">.formats = (SNDRV_PCM_FMTBIT_S16_LE |</span><br><span class="line">    SNDRV_PCM_FMTBIT_S24_LE|</span><br><span class="line">    SNDRV_PCM_FMTBIT_S24_3LE),</span><br><span class="line">.channels_min = <span class="number">1</span>,</span><br><span class="line">.channels_max = <span class="number">4</span>,</span><br><span class="line">.rate_min =     <span class="number">8000</span>,</span><br><span class="line">.rate_max =<span class="number">48000</span>,</span><br><span class="line">&#125;,</span><br><span class="line">.ops = &amp;msm_fe_Multimedia_dai_ops,</span><br><span class="line">.name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">.probe = fe_dai_probe,</span><br><span class="line">&#125;,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Back-end DAIï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/msm/msm8996.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> <span class="title">msm8996_tasha_be_dai_links</span>[] = &#123;</span></span><br><span class="line"><span class="comment">/* Backend DAI Links */</span></span><br><span class="line">&#123;</span><br><span class="line">.name = LPASS_BE_SLIMBUS_0_RX,</span><br><span class="line">.stream_name = <span class="string">"Slimbus Playback"</span>,</span><br><span class="line">.cpu_dai_name = <span class="string">"msm-dai-q6-dev.16384"</span>,</span><br><span class="line">.platform_name = <span class="string">"msm-pcm-routing"</span>,</span><br><span class="line">.codec_name = <span class="string">"tasha_codec"</span>,</span><br><span class="line">.codec_dai_name = <span class="string">"tasha_mix_rx1"</span>,</span><br><span class="line">.no_pcm = <span class="number">1</span>,</span><br><span class="line">.dpcm_playback = <span class="number">1</span>,</span><br><span class="line">.be_id = MSM_BACKEND_DAI_SLIMBUS_0_RX,</span><br><span class="line">.init = &amp;msm_audrx_init,</span><br><span class="line">.be_hw_params_fixup = msm_slim_0_rx_be_hw_params_fixup,</span><br><span class="line"><span class="comment">/* this dainlink has playback support */</span></span><br><span class="line">.ignore_pmdown_time = <span class="number">1</span>,</span><br><span class="line">.ignore_suspend = <span class="number">1</span>,</span><br><span class="line">.ops = &amp;msm8996_be_ops,</span><br><span class="line">&#125;,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> struct snd_soc_dai_link msm8996_tasha_fe_dai_links[] = &#123;</span><br><span class="line">&#123;</span><br><span class="line">.name = LPASS_BE_SLIMBUS_4_TX,</span><br><span class="line">.stream_name = <span class="string">"Slimbus4 Capture"</span>,</span><br><span class="line">.cpu_dai_name = <span class="string">"msm-dai-q6-dev.16393"</span>,</span><br><span class="line">.platform_name = <span class="string">"msm-pcm-hostless"</span>,</span><br><span class="line">.codec_name = <span class="string">"tasha_codec"</span>,</span><br><span class="line">.codec_dai_name = <span class="string">"tasha_vifeedback"</span>,</span><br><span class="line">.be_id = MSM_BACKEND_DAI_SLIMBUS_4_TX,</span><br><span class="line">.be_hw_params_fixup = msm_slim_4_tx_be_hw_params_fixup,</span><br><span class="line">.ops = &amp;msm8996_be_ops,</span><br><span class="line">.no_host_mode = SND_SOC_DAI_LINK_NO_HOST,</span><br><span class="line">.ignore_suspend = <span class="number">1</span>,</span><br><span class="line">&#125;,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hw constraintsï¼šæŒ‡å¹³å°æœ¬èº«çš„ç¡¬ä»¶é™åˆ¶ï¼Œå¦‚æ‰€èƒ½æ”¯æŒçš„é€šé“æ•°/é‡‡æ ·ç‡/æ•°æ®æ ¼å¼ã€DMA æ”¯æŒçš„æ•°æ®å‘¨æœŸå¤§å°ï¼ˆperiod sizeï¼‰ã€å‘¨æœŸæ¬¡æ•°ï¼ˆperiod countï¼‰ç­‰ï¼Œé€šè¿‡ snd_pcm_hardware ç»“æ„ä½“æè¿°ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_hardware</span> <span class="title">msm_pcm_hardware_capture</span> = &#123;</span></span><br><span class="line">.info =                 (SNDRV_PCM_INFO_MMAP |</span><br><span class="line">SNDRV_PCM_INFO_BLOCK_TRANSFER |</span><br><span class="line">SNDRV_PCM_INFO_MMAP_VALID |</span><br><span class="line">SNDRV_PCM_INFO_INTERLEAVED |</span><br><span class="line">SNDRV_PCM_INFO_PAUSE | SNDRV_PCM_INFO_RESUME),</span><br><span class="line">.formats =              (SNDRV_PCM_FMTBIT_S16_LE |</span><br><span class="line">SNDRV_PCM_FMTBIT_S24_LE |</span><br><span class="line">SNDRV_PCM_FMTBIT_S24_3LE),</span><br><span class="line">.rates =                SNDRV_PCM_RATE_8000_48000,</span><br><span class="line">.rate_min =             <span class="number">8000</span>,</span><br><span class="line">.rate_max =             <span class="number">48000</span>,</span><br><span class="line">.channels_min =         <span class="number">1</span>,</span><br><span class="line">.channels_max =         <span class="number">4</span>,</span><br><span class="line">.buffer_bytes_max =     CAPTURE_MAX_NUM_PERIODS *</span><br><span class="line">CAPTURE_MAX_PERIOD_SIZE,</span><br><span class="line">.period_bytes_min =CAPTURE_MIN_PERIOD_SIZE,</span><br><span class="line">.period_bytes_max =     CAPTURE_MAX_PERIOD_SIZE,</span><br><span class="line">.periods_min =          CAPTURE_MIN_NUM_PERIODS,</span><br><span class="line">.periods_max =          CAPTURE_MAX_NUM_PERIODS,</span><br><span class="line">.fifo_size =            <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>hw paramsï¼šç”¨æˆ·å±‚è®¾ç½®çš„ç¡¬ä»¶å‚æ•°ï¼Œå¦‚ channelsã€sample rateã€pcm formatã€period sizeã€period countï¼›è¿™äº›å‚æ•°å— hw constraints çº¦æŸã€‚</p><p>sw paramsï¼šç”¨æˆ·å±‚è®¾ç½®çš„è½¯ä»¶å‚æ•°ï¼Œå¦‚ start thresholdã€stop thresholdã€silence thresholdã€‚</p><h4 id="ï¼ˆäºŒï¼‰ASoC-Core"><a href="#ï¼ˆäºŒï¼‰ASoC-Core" class="headerlink" title="ï¼ˆäºŒï¼‰ASoC Core"></a>ï¼ˆäºŒï¼‰ASoC Core</h4><p>ASoCï¼šALSA System on Chipï¼Œæ˜¯å»ºç«‹åœ¨æ ‡å‡† ALSA é©±åŠ¨ä¹‹ä¸Šï¼Œä¸ºäº†æ›´å¥½æ”¯æŒåµŒå…¥å¼ç³»ç»Ÿå’Œåº”ç”¨äºç§»åŠ¨è®¾å¤‡çš„éŸ³é¢‘ codec çš„ä¸€å¥—è½¯ä»¶ä½“ç³»ï¼Œå®ƒä¾èµ–äºæ ‡å‡† ALSA é©±åŠ¨æ¡†æ¶ã€‚å†…æ ¸æ–‡æ¡£ Documentation/alsa/soc/overview.txt ä¸­è¯¦ç»†ä»‹ç»äº† ASoC çš„è®¾è®¡åˆè¡·ï¼Œè¿™é‡Œä¸ä¸€ä¸€å¼•ç”¨ï¼Œç®€å•é™ˆè¿°å¦‚ä¸‹ï¼š</p><p>â€¢ ç‹¬ç«‹çš„ codec é©±åŠ¨ï¼Œæ ‡å‡†çš„ ALSA é©±åŠ¨æ¡†æ¶é‡Œé¢ codec é©±åŠ¨å¾€å¾€ä¸ SoC/CPU è€¦åˆè¿‡äºç´§å¯†ï¼Œä¸åˆ©äºåœ¨å¤šæ ·åŒ–çš„å¹³å°/æœºå™¨ä¸Šç§»æ¤å¤ç”¨<br>â€¢ æ–¹ä¾¿ codec ä¸ SoC é€šè¿‡ PCM/I2S æ€»çº¿å»ºç«‹é“¾æ¥<br>â€¢ åŠ¨æ€éŸ³é¢‘ç”µæºç®¡ç† DAPMï¼Œä½¿å¾— codec ä»»ä½•æ—¶å€™éƒ½å·¥ä½œåœ¨æœ€ä½åŠŸè€—çŠ¶æ€ï¼ŒåŒæ—¶è´Ÿè´£éŸ³é¢‘è·¯ç”±çš„åˆ›å»º<br>â€¢ POPs å’Œ click éŸ³æŠ‘åˆ¶å¼±åŒ–å¤„ç†ï¼Œåœ¨ ASoC ä¸­é€šè¿‡æ­£ç¡®çš„éŸ³é¢‘éƒ¨ä»¶ä¸Šä¸‹ç”µæ¬¡åºæ¥å®ç°<br>â€¢ Machine é©±åŠ¨çš„ç‰¹å®šæ§åˆ¶ï¼Œæ¯”å¦‚è€³æœºã€éº¦å…‹é£çš„æ’æ‹”æ£€æµ‹ï¼Œå¤–æ”¾åŠŸæ”¾çš„å¼€å…³<br>åœ¨æ¦‚è¿°ä¸­å·²ç»ä»‹ç»äº† ASoC ç¡¬ä»¶è®¾å¤‡é©±åŠ¨çš„ä¸‰å¤§æ„æˆï¼šCodecã€Platform å’Œ Machineï¼Œä¸‹é¢åˆ—ä¸¾å„é©±åŠ¨çš„åŠŸèƒ½æ„æˆï¼š</p><p>ASoC Codec Driverï¼š</p><p>â€¢ Codec DAI å’Œ PCM çš„é…ç½®ä¿¡æ¯<br>â€¢ Codec çš„æ§åˆ¶æ¥å£ï¼Œå¦‚ I2C/SPI<br>â€¢ Mixer å’Œå…¶ä»–éŸ³é¢‘æ§ä»¶<br>â€¢ Codec çš„éŸ³é¢‘æ¥å£å‡½æ•°ï¼Œè§ snd_soc_dai_ops ç»“æ„ä½“å®šä¹‰<br>â€¢ DAPM æè¿°ä¿¡æ¯<br>â€¢ DAPM äº‹ä»¶å¤„ç†å¥æŸ„<br>â€¢ DAC æ•°å­—é™éŸ³æ§åˆ¶</p><p>ASoC Platform Driverï¼š åŒ…æ‹¬ dma å’Œ cpu_dai ä¸¤éƒ¨åˆ†ï¼š</p><p>â€¢ dma é©±åŠ¨å®ç°éŸ³é¢‘ dma æ“ä½œï¼Œå…·ä½“è§ snd_pcm_ops ç»“æ„ä½“å®šä¹‰<br>â€¢ cpu_dai é©±åŠ¨å®ç°éŸ³é¢‘æ•°å­—æ¥å£æ§åˆ¶å™¨çš„æè¿°å’Œé…ç½®<br>â€¢ ASoC Machine Driverï¼š</p><p>ä½œä¸ºé“¾ç»“ Platform å’Œ Codec çš„è½½ä½“ï¼Œå®ƒå¿…é¡»é…ç½® dai_link ä¸ºéŸ³é¢‘æ•°æ®é“¾è·¯æŒ‡å®š Platform å’Œ Codec<br>å¤„ç†æœºå™¨ç‰¹æœ‰çš„éŸ³é¢‘æ§ä»¶å’ŒéŸ³é¢‘äº‹ä»¶ï¼Œä¾‹å¦‚å›æ”¾æ—¶æ‰“å¼€å¤–æ”¾åŠŸæ”¾<br>ç¡¬ä»¶è®¾å¤‡é©±åŠ¨ç›¸å…³ç»“æ„ä½“ï¼š</p><p>â€¢ snd_soc_codec_driverï¼šéŸ³é¢‘ç¼–è§£ç èŠ¯ç‰‡æè¿°åŠæ“ä½œå‡½æ•°ï¼Œå¦‚æ§ä»¶/å¾®ä»¶/éŸ³é¢‘è·¯ç”±çš„æè¿°ä¿¡æ¯ã€æ—¶é’Ÿé…ç½®ã€IO æ§åˆ¶ç­‰<br>â€¢ snd_soc_dai_driverï¼šéŸ³é¢‘æ•°æ®æ¥å£æè¿°åŠæ“ä½œå‡½æ•°ï¼Œæ ¹æ® codec ç«¯å’Œ soc ç«¯ï¼Œåˆ†ä¸º codec_dai å’Œ cpu_dai<br>â€¢ snd_soc_platform_driverï¼šéŸ³é¢‘ dma è®¾å¤‡æè¿°åŠæ“ä½œå‡½æ•°<br>â€¢ snd_soc_dai_linkï¼šéŸ³é¢‘é“¾è·¯æè¿°åŠæ¿çº§æ“ä½œå‡½æ•°</p><h4 id="ï¼ˆä¸‰ï¼‰Codec-Driver"><a href="#ï¼ˆä¸‰ï¼‰Codec-Driver" class="headerlink" title="ï¼ˆä¸‰ï¼‰Codec Driver"></a>ï¼ˆä¸‰ï¼‰Codec Driver</h4><p>åŸºæœ¬æ˜¯ä»¥å†…æ ¸æ–‡æ¡£ Documentation/sound/alsa/soc/codec.txt ä¸­çš„å†…å®¹ä¸ºè„‰ç»œæ¥åˆ†æçš„ã€‚Codec çš„ä½œç”¨ï¼Œä¹‹å‰å·²æœ‰æè¿°ï¼Œæœ¬ç« ä¸»è¦ç½—åˆ—ä¸‹ Codec driver ä¸­é‡è¦çš„æ•°æ®ç»“æ„åŠæ³¨å†Œæµç¨‹ã€‚<br>å…¶ä¸­æœ‰ç€å„ç§åŠŸèƒ½éƒ¨ä»¶ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº ï¼š</p><blockquote><p>ADC    æŠŠéº¦å…‹é£æ‹¾å–çš„æ¨¡æ‹Ÿä¿¡å·è½¬æ¢æˆæ•°å­—ä¿¡å·<br>DAC    æŠŠéŸ³é¢‘æ¥å£è¿‡æ¥çš„æ•°å­—ä¿¡å·è½¬æ¢æˆæ¨¡æ‹Ÿä¿¡å·<br>MIXER    æ··éŸ³å™¨ï¼ŒæŠŠå¤šè·¯è¾“å…¥ä¿¡å·æ··åˆæˆå•è·¯è¾“å‡º</p></blockquote><h5 id="3-1-Codec-DAI-and-PCM-configuration"><a href="#3-1-Codec-DAI-and-PCM-configuration" class="headerlink" title="3.1. Codec DAI and PCM configuration"></a>3.1. Codec DAI and PCM configuration</h5><p>codec_dai å’Œ pcm é…ç½®ä¿¡æ¯é€šè¿‡ç»“æ„ä½“ snd_soc_dai_driver æè¿°ï¼ŒåŒ…æ‹¬ dai çš„èƒ½åŠ›æè¿°å’Œæ“ä½œæ¥å£ï¼Œsnd_soc_dai_driver æœ€ç»ˆä¼šè¢«æ³¨å†Œåˆ° soc-core ä¸­ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/soc-dai.h]</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Digital Audio Interface Driver.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Describes the Digital Audio Interface in terms of its ALSA, DAI and AC97</span></span><br><span class="line"><span class="comment"> * operations and capabilities. Codec and platform drivers will register this</span></span><br><span class="line"><span class="comment"> * structure for every DAI they have.</span></span><br><span class="line"><span class="comment"> * This structure covers the clocking, formating and ALSA operations for each</span></span><br><span class="line"><span class="comment"> * interface.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> &#123;</span></span><br><span class="line">    <span class="comment">/* DAI description */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">int</span> ac97_control;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DAI driver callbacks */</span></span><br><span class="line">    <span class="keyword">int</span> (*probe)(struct snd_soc_dai *dai);</span><br><span class="line">    <span class="keyword">int</span> (*remove)(struct snd_soc_dai *dai);</span><br><span class="line">    <span class="keyword">int</span> (*suspend)(struct snd_soc_dai *dai);</span><br><span class="line">    <span class="keyword">int</span> (*resume)(struct snd_soc_dai *dai);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ops */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DAI capabilities */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> <span class="title">capture</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> <span class="title">playback</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_rates:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* probe ordering - for components with runtime dependencies */</span></span><br><span class="line">    <span class="keyword">int</span> probe_order;</span><br><span class="line">    <span class="keyword">int</span> remove_order;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>nameï¼šcodec_dai çš„åç§°æ ‡è¯†ï¼Œdai_link é€šè¿‡é…ç½® codec_dai_name æ¥æ‰¾åˆ°å¯¹åº”çš„ codec_daiï¼›<br>probeï¼šcodec_dai çš„åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œå£°å¡æ—¶å›è°ƒï¼›<br>playbackï¼šå›æ”¾èƒ½åŠ›æè¿°ï¼Œå¦‚å›æ”¾è®¾å¤‡æ‰€æ”¯æŒçš„å£°é“æ•°ã€é‡‡æ ·ç‡ã€éŸ³é¢‘æ ¼å¼ï¼›<br>captureï¼šå½•åˆ¶èƒ½åŠ›æè¿°ï¼Œå¦‚å½•åˆ¶è®¾å¤‡æ‰€æ”¯æŒå£°é“æ•°ã€é‡‡æ ·ç‡ã€éŸ³é¢‘æ ¼å¼ï¼›<br>opsï¼šcodec_dai çš„æ“ä½œå‡½æ•°é›†ï¼Œè¿™äº›å‡½æ•°é›†éå¸¸é‡è¦ï¼Œç”¨äº dai çš„æ—¶é’Ÿé…ç½®ã€æ ¼å¼é…ç½®ã€ç¡¬ä»¶å‚æ•°é…ç½®ã€‚</p><p>codec_daiï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> <span class="title">tasha_i2s_dai</span>[] = &#123;</span></span><br><span class="line">&#123;</span><br><span class="line">.name = <span class="string">"tasha_i2s_rx1"</span>,</span><br><span class="line">.id = AIF1_PB,</span><br><span class="line">.playback = &#123;</span><br><span class="line">.stream_name = <span class="string">"AIF1 Playback"</span>,</span><br><span class="line">.rates = WCD9335_RATES_MASK,</span><br><span class="line">.formats = TASHA_FORMATS_S16_S24_LE,</span><br><span class="line">.rate_max = <span class="number">192000</span>,</span><br><span class="line">.rate_min = <span class="number">8000</span>,</span><br><span class="line">.channels_min = <span class="number">1</span>,</span><br><span class="line">.channels_max = <span class="number">2</span>,</span><br><span class="line">&#125;,</span><br><span class="line">.ops = &amp;tasha_dai_ops,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">.name = <span class="string">"tasha_i2s_tx1"</span>,</span><br><span class="line">.id = AIF1_CAP,</span><br><span class="line">.capture = &#123;</span><br><span class="line">.stream_name = <span class="string">"AIF1 Capture"</span>,</span><br><span class="line">.rates = WCD9335_RATES_MASK,</span><br><span class="line">.formats = TASHA_FORMATS,</span><br><span class="line">.rate_max = <span class="number">192000</span>,</span><br><span class="line">.rate_min = <span class="number">8000</span>,</span><br><span class="line">.channels_min = <span class="number">1</span>,</span><br><span class="line">.channels_max = <span class="number">4</span>,</span><br><span class="line">&#125;,</span><br><span class="line">.ops = &amp;tasha_dai_ops,</span><br><span class="line">&#125;,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="3-2-Codec-control-IO"><a href="#3-2-Codec-control-IO" class="headerlink" title="3.2. Codec control IO"></a>3.2. Codec control IO</h5><p>ç§»åŠ¨è®¾å¤‡çš„éŸ³é¢‘ Codecï¼Œå…¶æ§åˆ¶æ¥å£ä¸€èˆ¬æ˜¯ I2C æˆ– SPIï¼Œæ§åˆ¶æ¥å£ç”¨äºè¯»å†™ codec çš„å¯„å­˜å™¨ã€‚åœ¨ snd_soc_codec_driver ç»“æ„ä½“ä¸­ï¼Œæœ‰å¦‚ä¸‹å­—æ®µæè¿° Codec çš„æ§åˆ¶æ¥å£ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/soc.h]</span><br><span class="line"><span class="comment">/* codec driver */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec_driver</span> &#123;</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">/* codec IO */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">regmap</span> *(*<span class="title">get_regmap</span>)(<span class="title">struct</span> <span class="title">device</span> *);</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*read)</span><span class="params">(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">int</span> (*write)(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">int</span> (*display_register)(struct snd_soc_codec *, <span class="keyword">char</span> *,</span><br><span class="line"><span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">int</span> (*volatile_register)(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">int</span> (*readable_register)(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">int</span> (*writable_register)(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> reg_cache_size;</span><br><span class="line"><span class="keyword">short</span> reg_cache_step;</span><br><span class="line"><span class="keyword">short</span> reg_word_size;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">void</span> *reg_cache_default;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>â€¢ readï¼šè¯»å¯„å­˜å™¨ï¼›<br>â€¢ writeï¼šå†™å¯„å­˜å™¨ï¼›<br>â€¢ volatile_registerï¼šåˆ¤æ–­æŒ‡å®šçš„å¯„å­˜å™¨æ˜¯å¦æ˜¯ volatile å±æ€§ï¼›å‡å¦‚æ˜¯ï¼Œåˆ™è¯»å–å¯„å­˜å™¨æ—¶ä¸æ˜¯è¯» cacheï¼Œè€Œç›´æ¥è®¿é—®ç¡¬ä»¶ï¼›<br>â€¢ readable_registerï¼šåˆ¤æ–­æŒ‡å®šçš„å¯„å­˜å™¨æ˜¯å¦å¯è¯»ï¼›<br>â€¢ reg_cache_defaultï¼šå¯„å­˜å™¨çš„ç¼ºçœå€¼ï¼›<br>â€¢ reg_cache_sizeï¼šç¼ºçœçš„å¯„å­˜å™¨å€¼æ•°ç»„å¤§å°ï¼›<br>â€¢ reg_word_sizeï¼šå¯„å­˜å™¨å®½åº¦ã€‚<br>åœ¨ Linux-3.4.5 ä¸­ï¼Œå¾ˆå¤š codec çš„æ§åˆ¶æ¥å£éƒ½æ”¹ç”¨ regmap äº†ã€‚soc-core ä¸­åˆ¤æ–­æ˜¯å¦ç”¨çš„æ˜¯ regmapï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ regmap æ¥å£ã€‚</p><h5 id="3-3-Mixers-and-audio-controls"><a href="#3-3-Mixers-and-audio-controls" class="headerlink" title="3.3. Mixers and audio controls"></a>3.3. Mixers and audio controls</h5><p>éŸ³é¢‘æ§ä»¶å¤šç”¨äºéƒ¨ä»¶å¼€å…³å’ŒéŸ³é‡çš„è®¾å®šï¼ŒéŸ³é¢‘æ§ä»¶å¯é€šè¿‡ soc.h ä¸­çš„å®æ¥å®šä¹‰ï¼Œä¾‹å¦‚å•ä¸€å‹æ§ä»¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/soc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE(xname, reg, shift, max, invert) \</span></span><br><span class="line">&#123;   .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span><br><span class="line">    .info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span><br><span class="line">    .put = snd_soc_put_volsw, \</span><br><span class="line">    .private_value =  SOC_SINGLE_VALUE(reg, shift, max, invert) &#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ§ä»¶åªæœ‰ä¸€ä¸ªè®¾ç½®é‡ï¼Œä¸€èˆ¬ç”¨äºéƒ¨ä»¶å¼€å…³ã€‚å®å®šä¹‰çš„å‚æ•°è¯´æ˜ï¼š</p><p>â€¢ xnameï¼šæ§ä»¶çš„åç§°æ ‡è¯†ï¼›<br>â€¢ regï¼šæ§ä»¶å¯¹åº”çš„å¯„å­˜å™¨åœ°å€ï¼›<br>â€¢ shiftï¼šæ§ä»¶æ§åˆ¶ä½åœ¨å¯„å­˜å™¨ä¸­çš„åç§»ï¼›<br>â€¢ maxï¼šæ§ä»¶è®¾ç½®å€¼èŒƒå›´ï¼›<br>â€¢ invertï¼šè®¾å®šå€¼æ˜¯å¦å–åã€‚<br>å…¶ä»–ç±»å‹æ§ä»¶ç±»ä¼¼ï¼Œä¸ä¸€ä¸€ä»‹ç»äº†ã€‚</p><p>ä¸Šè¿°åªæ˜¯å®å®šä¹‰ï¼ŒéŸ³é¢‘æ§ä»¶çœŸæ­£çš„ç»“æ„æ˜¯ snd_kcontrol_newï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/control.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> &#123;</span></span><br><span class="line">    <span class="keyword">snd_ctl_elem_iface_t</span> iface; <span class="comment">/* interface identifier */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> device;        <span class="comment">/* device/client number */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> subdevice;     <span class="comment">/* subdevice (substream) number */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *name;  <span class="comment">/* ASCII name of item */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index;     <span class="comment">/* index of item */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> access;        <span class="comment">/* access rights */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;     <span class="comment">/* count of same elements */</span></span><br><span class="line">    <span class="keyword">snd_kcontrol_info_t</span> *info;</span><br><span class="line">    <span class="keyword">snd_kcontrol_get_t</span> *get;</span><br><span class="line">    <span class="keyword">snd_kcontrol_put_t</span> *put;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">snd_kcontrol_tlv_rw_t</span> *c;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *p;</span><br><span class="line">    &#125; tlv;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> private_value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Codec åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡ snd_soc_add_codec_controls() æŠŠæ‰€æœ‰å®šä¹‰å¥½çš„éŸ³é¢‘æ§ä»¶æ³¨å†Œåˆ° alsa-core ï¼Œä¸Šå±‚å¯ä»¥é€šè¿‡ tinymixã€alsa_amixer ç­‰å·¥å…·æŸ¥çœ‹ä¿®æ”¹è¿™äº›æ§ä»¶çš„è®¾å®šã€‚</p><h5 id="3-6-Codec-audio-operations"><a href="#3-6-Codec-audio-operations" class="headerlink" title="3.6. Codec audio operations"></a>3.6. Codec audio operations</h5><p>Codec éŸ³é¢‘æ“ä½œæ¥å£é€šè¿‡ç»“æ„ä½“ snd_soc_dai_ops æè¿°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/soc-dai.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DAI clocking configuration, all optional.</span></span><br><span class="line"><span class="comment"> * Called by soc_card drivers, normally in their hw_params.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> (*set_sysclk)(struct snd_soc_dai *dai,</span><br><span class="line"><span class="keyword">int</span> clk_id, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq, <span class="keyword">int</span> dir);</span><br><span class="line"><span class="keyword">int</span> (*set_pll)(struct snd_soc_dai *dai, <span class="keyword">int</span> pll_id, <span class="keyword">int</span> source,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> freq_in, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq_out);</span><br><span class="line"><span class="keyword">int</span> (*set_clkdiv)(struct snd_soc_dai *dai, <span class="keyword">int</span> div_id, <span class="keyword">int</span> div);</span><br><span class="line"><span class="keyword">int</span> (*set_bclk_ratio)(struct snd_soc_dai *dai, <span class="keyword">unsigned</span> <span class="keyword">int</span> ratio);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DAI format configuration</span></span><br><span class="line"><span class="comment"> * Called by soc_card drivers, normally in their hw_params.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> (*set_fmt)(struct snd_soc_dai *dai, <span class="keyword">unsigned</span> <span class="keyword">int</span> fmt);</span><br><span class="line"><span class="keyword">int</span> (*xlate_tdm_slot_mask)(<span class="keyword">unsigned</span> <span class="keyword">int</span> slots,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_mask);</span><br><span class="line"><span class="keyword">int</span> (*set_tdm_slot)(struct snd_soc_dai *dai,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> tx_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> rx_mask,</span><br><span class="line"><span class="keyword">int</span> slots, <span class="keyword">int</span> slot_width);</span><br><span class="line"><span class="keyword">int</span> (*set_channel_map)(struct snd_soc_dai *dai,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> tx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_slot,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> rx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_slot);</span><br><span class="line"><span class="keyword">int</span> (*set_tristate)(struct snd_soc_dai *dai, <span class="keyword">int</span> tristate);</span><br><span class="line"><span class="keyword">int</span> (*get_channel_map)(struct snd_soc_dai *dai,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_slot,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_slot);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ³¨é‡Šæ¯”è¾ƒè¯¦ç»†çš„äº†ï¼ŒCodec éŸ³é¢‘æ“ä½œæ¥å£åˆ†ä¸º 5 å¤§éƒ¨åˆ†ï¼šæ—¶é’Ÿé…ç½®ã€æ ¼å¼é…ç½®ã€æ•°å­—é™éŸ³ã€PCM éŸ³é¢‘æ¥å£ã€FIFO å»¶è¿Ÿã€‚ç€é‡è¯´ä¸‹æ—¶é’Ÿé…ç½®åŠæ ¼å¼é…ç½®æ¥å£ï¼š</p><p>â€¢ set_sysclkï¼šcodec_dai ç³»ç»Ÿæ—¶é’Ÿè®¾ç½®ï¼Œå½“ä¸Šå±‚æ‰“å¼€ pcm è®¾å¤‡æ—¶ï¼Œéœ€è¦å›è°ƒè¯¥æ¥å£è®¾ç½® Codec çš„ç³»ç»Ÿæ—¶é’Ÿï¼ŒCodec æ‰èƒ½æ­£å¸¸å·¥ä½œï¼›<br>â€¢ set_pllï¼šCodec FLL è®¾ç½®ï¼ŒCodec ä¸€èˆ¬æ¥äº†ä¸€ä¸ª MCLK è¾“å…¥æ—¶é’Ÿï¼Œå›è°ƒè¯¥æ¥å£åŸºäº MCLK æ¥äº§ç”Ÿ Codec FLL æ—¶é’Ÿï¼Œæ¥ç€ codec_dai çš„ sysclkã€bclkã€lrclk å‡å¯ä» FLL åˆ†é¢‘å‡ºæ¥ï¼ˆå‡è®¾ Codec ä½œä¸º masterï¼‰ï¼›<br>â€¢ set_fmtï¼šcodec_dai æ ¼å¼è®¾ç½®ï¼Œå…·ä½“è§ soc-dai.hï¼›<br>  â€¢ SND_SOC_DAIFMT_I2Sï¼šéŸ³é¢‘æ•°æ®æ˜¯ I2S æ ¼å¼ï¼Œå¸¸ç”¨äºå¤šåª’ä½“éŸ³é¢‘ï¼›<br>  â€¢ SND_SOC_DAIFMT_DSP_Aï¼šéŸ³é¢‘æ•°æ®æ˜¯ PCM æ ¼å¼ï¼Œå¸¸ç”¨äºé€šè¯è¯­éŸ³ï¼›<br>  â€¢ SND_SOC_DAIFMT_CBM_CFMï¼šCodec ä½œä¸º masterï¼ŒBCLK å’Œ LRCLK ç”± Codec æä¾›ï¼›<br>  â€¢ SND_SOC_DAIFMT_CBS_CFSï¼šCodec ä½œä¸º slaveï¼ŒBCLK å’Œ LRCLK ç”± SoC/CPU æä¾›ï¼›<br>â€¢ hw_paramsï¼šcodec_dai ç¡¬ä»¶å‚æ•°è®¾ç½®ï¼Œæ ¹æ®ä¸Šå±‚è®¾å®šçš„å£°é“æ•°ã€é‡‡æ ·ç‡ã€æ•°æ®æ ¼å¼ï¼Œæ¥é…ç½® codec_dai ç›¸å…³å¯„å­˜å™¨ã€‚</p><p>WCD9335çš„snd_soc_dai_ops ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> <span class="title">tasha_dai_ops</span> = &#123;</span></span><br><span class="line">.startup = tasha_startup,</span><br><span class="line">.shutdown = tasha_shutdown,</span><br><span class="line">.hw_params = tasha_hw_params,</span><br><span class="line">.prepare = tasha_prepare,</span><br><span class="line">.set_sysclk = tasha_set_dai_sysclk,</span><br><span class="line">.set_fmt = tasha_set_dai_fmt,</span><br><span class="line">.set_channel_map = tasha_set_channel_map,</span><br><span class="line">.get_channel_map = tasha_get_channel_map,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h5 id="3-6-Codec-register"><a href="#3-6-Codec-register" class="headerlink" title="3.6. Codec register"></a>3.6. Codec register</h5><p>å½“ platform_driverï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">tasha_codec_driver</span> = &#123;</span></span><br><span class="line">.probe = tasha_probe,</span><br><span class="line">.remove = tasha_remove,</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = <span class="string">"tasha_codec"</span>,</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">#ifdef CONFIG_PM</span><br><span class="line">.pm = &amp;tasha_pm_ops,</span><br><span class="line">#endif</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸.name = â€œtasha_codecâ€  çš„ platform_deviceï¼ˆè¯¥ platform_device åœ¨ drivers/mfd/wcd9xxx-core.c ä¸­æ³¨å†Œwcd9xxx_device_init-&gt;wcd9xxx_check_codec_type-&gt;tasha_devsï¼‰åŒ¹é…åï¼Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;drivers/mfd/wcd9xxx-core.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mfd_cell</span> <span class="title">tasha_devs</span>[] = &#123;</span></span><br><span class="line">&#123;</span><br><span class="line">.name = <span class="string">"tasha_codec"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç«‹å³å›è°ƒ tasha_probe() æ³¨å†Œ Codecï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tasha_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasha_priv</span> *<span class="title">tasha</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">wcd_ext_clk</span>, *<span class="title">wcd_native_clk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wcd9xxx_resmgr_v2</span> *<span class="title">resmgr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wcd9xxx_power_region</span> *<span class="title">cdc_pwr</span>;</span></span><br><span class="line">......</span><br><span class="line">tasha = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(struct tasha_priv),</span><br><span class="line">    GFP_KERNEL);</span><br><span class="line">......</span><br><span class="line">    tasha-&gt;resmgr = resmgr;</span><br><span class="line">tasha-&gt;swr_plat_data.handle = (<span class="keyword">void</span> *) tasha;</span><br><span class="line">tasha-&gt;swr_plat_data.read = tasha_swrm_read;</span><br><span class="line">tasha-&gt;swr_plat_data.write = tasha_swrm_write;</span><br><span class="line">tasha-&gt;swr_plat_data.bulk_write = tasha_swrm_bulk_write;</span><br><span class="line">tasha-&gt;swr_plat_data.clk = tasha_swrm_clock;</span><br><span class="line">tasha-&gt;swr_plat_data.handle_irq = tasha_swrm_handle_irq;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Register for Clock */</span></span><br><span class="line">wcd_ext_clk = clk_get(tasha-&gt;wcd9xxx-&gt;dev, <span class="string">"wcd_clk"</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(wcd_ext_clk)) &#123;</span><br><span class="line">dev_err(tasha-&gt;wcd9xxx-&gt;dev, <span class="string">"%s: clk get %s failed\n"</span>,</span><br><span class="line">__func__, <span class="string">"wcd_ext_clk"</span>);</span><br><span class="line"><span class="keyword">goto</span> err_clk;</span><br><span class="line">&#125;</span><br><span class="line">tasha-&gt;wcd_ext_clk = wcd_ext_clk;</span><br><span class="line">tasha-&gt;sido_voltage = SIDO_VOLTAGE_NOMINAL_MV;</span><br><span class="line">set_bit(AUDIO_NOMINAL, &amp;tasha-&gt;status_mask);</span><br><span class="line">tasha-&gt;sido_ccl_cnt = <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> (wcd9xxx_get_intf_type() == WCD9XXX_INTERFACE_TYPE_SLIMBUS)</span><br><span class="line">ret = snd_soc_register_codec(&amp;pdev-&gt;dev, &amp;soc_codec_dev_tasha,</span><br><span class="line">     tasha_dai, ARRAY_SIZE(tasha_dai));</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (wcd9xxx_get_intf_type() == WCD9XXX_INTERFACE_TYPE_I2C)</span><br><span class="line">ret = snd_soc_register_codec(&amp;pdev-&gt;dev, &amp;soc_codec_dev_tasha,</span><br><span class="line">     tasha_i2s_dai,</span><br><span class="line">     ARRAY_SIZE(tasha_i2s_dai));</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = -EINVAL;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>snd_soc_register_codecï¼šå°† codec_driver å’Œ codec_dai_driver æ³¨å†Œåˆ° soc-coreã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * snd_soc_register_codec - Register a codec with the ASoC core</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @codec: codec to register</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_register_codec</span><span class="params">(struct device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">const</span> struct snd_soc_codec_driver *codec_drv,</span></span></span><br><span class="line"><span class="function"><span class="params">               struct snd_soc_dai_driver *dai_drv,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">int</span> num_dai)</span></span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ª snd_soc_codec å®ä¾‹ï¼ŒåŒ…å« codec_drvï¼ˆsnd_soc_dai_driverï¼‰ç›¸å…³ä¿¡æ¯ï¼Œå°è£…ç»™ soc-core ä½¿ç”¨ï¼Œç›¸å…³ä»£ç æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c: snd_soc_register_codec]</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec</span> *<span class="title">codec</span>;</span></span><br><span class="line"></span><br><span class="line">    dev_dbg(dev, <span class="string">"codec register %s\n"</span>, dev_name(dev));</span><br><span class="line"></span><br><span class="line">    codec = kzalloc(<span class="keyword">sizeof</span>(struct snd_soc_codec), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (codec == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create CODEC component name */</span></span><br><span class="line">    codec-&gt;name = fmt_single_name(dev, &amp;codec-&gt;id);</span><br><span class="line">    <span class="keyword">if</span> (codec-&gt;name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        kfree(codec);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– Codec çš„å¯„å­˜å™¨ç¼“å­˜é…ç½®åŠè¯»å†™æ¥å£</span></span><br><span class="line">    codec-&gt;write = codec_drv-&gt;write;</span><br><span class="line">    codec-&gt;read = codec_drv-&gt;read;</span><br><span class="line">    codec-&gt;volatile_register = codec_drv-&gt;volatile_register;</span><br><span class="line">    codec-&gt;readable_register = codec_drv-&gt;readable_register;</span><br><span class="line">    codec-&gt;writable_register = codec_drv-&gt;writable_register;</span><br><span class="line">    codec-&gt;ignore_pmdown_time = codec_drv-&gt;ignore_pmdown_time;</span><br><span class="line">    codec-&gt;dapm.bias_level = SND_SOC_BIAS_OFF;</span><br><span class="line">    codec-&gt;dapm.dev = dev;</span><br><span class="line">    codec-&gt;dapm.codec = codec;</span><br><span class="line">    codec-&gt;dapm.seq_notifier = codec_drv-&gt;seq_notifier;</span><br><span class="line">    codec-&gt;dapm.stream_event = codec_drv-&gt;stream_event;</span><br><span class="line">    codec-&gt;dev = dev;</span><br><span class="line">    codec-&gt;driver = codec_drv;</span><br><span class="line">    codec-&gt;num_dai = num_dai;</span><br><span class="line">    mutex_init(&amp;codec-&gt;mutex);</span><br></pre></td></tr></table></figure><p>æŠŠä»¥ä¸Š codec å®ä¾‹æ’å…¥åˆ° codec_listé“¾è¡¨ä¸­ï¼ˆå£°å¡æ³¨å†Œæ—¶ä¼šéå†è¯¥é“¾è¡¨ï¼Œæ‰¾åˆ° dai_link å£°æ˜çš„ codec å¹¶ç»‘å®šï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c: snd_soc_register_codec]</span><br><span class="line">list_add(&amp;codec-&gt;<span class="built_in">list</span>, &amp;codec_list);</span><br></pre></td></tr></table></figure><p>æŠŠ codec_drv ä¸­çš„ snd_soc_dai_driverï¼ˆtasha_dai æˆ–è€…tasha_i2s_dai ï¼‰æ³¨å†Œåˆ° soc-coreï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c: snd_soc_register_codec]</span><br><span class="line">snd_soc_register_dais(&amp;codec-&gt;component, dai_drv, num_dai, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>snd_soc_register_dais() ä¼šæŠŠ dai æ’å…¥åˆ° dai_list é“¾è¡¨ä¸­ï¼ˆå£°å¡æ³¨å†Œæ—¶ä¼šéå†è¯¥é“¾è¡¨ï¼Œæ‰¾åˆ° dai_link å£°æ˜çš„ codec_dai å¹¶ç»‘å®šï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c: snd_soc_register_codec]</span><br><span class="line">list_add(&amp;dai-&gt;<span class="built_in">list</span>, &amp;dai_list);</span><br></pre></td></tr></table></figure><p>æœ€åé¡ºä¾¿æä¸‹ codec å’Œ codec_dai çš„åŒºåˆ«ï¼šcodec æŒ‡éŸ³é¢‘èŠ¯ç‰‡å…±æœ‰çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬ codec åˆå§‹åŒ–å‡½æ•°ã€æ§åˆ¶æ¥å£ã€å¯„å­˜å™¨ç¼“å­˜ã€æ§ä»¶ã€dapm éƒ¨ä»¶ã€éŸ³é¢‘è·¯ç”±ã€åç½®ç”µå‹è®¾ç½®å‡½æ•°ç­‰æè¿°ä¿¡æ¯ï¼›è€Œ codec_dai æŒ‡ codec ä¸Šçš„éŸ³é¢‘æ¥å£é©±åŠ¨æè¿°ï¼ŒåŒ…æ‹¬æ—¶é’Ÿé…ç½®ã€æ ¼å¼é…ç½®ã€èƒ½åŠ›æè¿°ç­‰ç­‰ï¼Œå„ä¸ªæ¥å£çš„æè¿°ä¿¡æ¯ä¸ä¸€å®šéƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æ¯ä¸ªéŸ³é¢‘æ¥å£éƒ½æœ‰ç€å„è‡ªçš„é©±åŠ¨æè¿°ã€‚</p><h4 id="ï¼ˆå››ï¼‰Platform-Driver"><a href="#ï¼ˆå››ï¼‰Platform-Driver" class="headerlink" title="ï¼ˆå››ï¼‰Platform Driver"></a>ï¼ˆå››ï¼‰Platform Driver</h4><p>æ¦‚è¿°ä¸­æåˆ°éŸ³é¢‘ Platform é©±åŠ¨ä¸»è¦ç”¨äºéŸ³é¢‘æ•°æ®ä¼ è¾“ï¼Œè¿™é‡Œåˆç»†åˆ†ä¸ºä¸¤æ­¥ï¼š</p><p>å¯åŠ¨ dma è®¾å¤‡ï¼ŒæŠŠéŸ³é¢‘æ•°æ®ä» dma buffer æ¬è¿åˆ° cpu_dai FIFOï¼Œè¿™éƒ¨åˆ†é©±åŠ¨ç”¨ snd_soc_platform_driver æè¿°ï¼Œåé¢åˆ†æç”¨ pcm_dma æŒ‡ä»£å®ƒã€‚<br>å¯åŠ¨æ•°å­—éŸ³é¢‘æ¥å£æ§åˆ¶å™¨ï¼ˆI2S/PCM/AC97ï¼‰ï¼ŒæŠŠéŸ³é¢‘æ•°æ®ä» cpu_dai FIFO ä¼ é€åˆ° codec_daiï¼ˆé«˜é€šå¹³å°ä¼šå°†æ•°æ®ä¼ é€åˆ°ADSPï¼‰è¿™éƒ¨åˆ†é©±åŠ¨ç”¨ snd_soc_dai_driver æè¿°ï¼Œåé¢åˆ†æç”¨ cpu_dai æŒ‡ä»£å®ƒã€‚</p><blockquote><p>MSM8996 åŒ…å«ä¸‰ä¸ª Hexagon DSP ï¼šapplication, modem, and sensorã€‚<br>Application  DSPï¼šä¸ä»…å¯ä»¥å¤„ç†è¯­éŸ³å’ŒéŸ³é¢‘ï¼Œè¿˜å¯ä»¥å¤„ç†è®¡ç®—æœº è§†è§‰ã€è§†é¢‘ã€å›¾åƒå’ŒCameraã€‚<br> Sensor DSPï¼šä¹Ÿå«åšSLPIï¼Œæ‰€æœ‰çš„sensoréƒ½é“¾æ¥åˆ°SLPIä¸Šé¢ï¼Œå®ƒç®¡ç†æ‰€æœ‰çš„SensoråŠç›¸å…³ç®—æ³•ã€‚</p></blockquote><p>å¯¹äº cpu_dai é©±åŠ¨ï¼Œä»ä¸Šé¢çš„ç±»å›¾æˆ‘ä»¬å¯çŸ¥ï¼Œä¸»è¦å·¥ä½œæœ‰ï¼š</p><p>å®ç° dai æ“ä½œå‡½æ•°ï¼Œè§ snd_soc_dai_ops å®šä¹‰ï¼Œç”¨äºé…ç½®å’Œæ“ä½œéŸ³é¢‘æ•°å­—æ¥å£æ§åˆ¶å™¨ï¼Œå¦‚æ—¶é’Ÿé…ç½® set_sysclk()ã€æ ¼å¼é…ç½® set_fmt()ã€ç¡¬ä»¶å‚æ•°é…ç½® hw_params()ã€å¯åŠ¨/åœæ­¢æ•°æ®ä¼ è¾“ trigger() ç­‰ï¼›<br>å®ç° probe å‡½æ•°ï¼ˆåˆå§‹åŒ–ï¼‰ã€remove å‡½æ•°ï¼ˆå¸è½½ï¼‰ã€suspend/resume å‡½æ•°ï¼ˆç”µæºç®¡ç†ï¼‰ï¼›<br>åˆå§‹åŒ– snd_soc_dai_driver å®ä¾‹ï¼ŒåŒ…æ‹¬å›æ”¾å’Œå½•åˆ¶çš„èƒ½åŠ›æè¿°ã€dai æ“ä½œå‡½æ•°é›†ã€probe/remove å›è°ƒã€ç”µæºç®¡ç†ç›¸å…³çš„ suspend/resume å›è°ƒï¼›<br>é€šè¿‡ snd_soc_register_dai() æŠŠåˆå§‹åŒ–å®Œæˆçš„ snd_soc_dai_driver æ³¨å†Œåˆ° soc-coreï¼šé¦–å…ˆåˆ›å»ºä¸€ä¸ª snd_soc_dai å®ä¾‹ï¼Œç„¶åæŠŠè¯¥ snd_soc_dai å®ä¾‹æ’å…¥åˆ° dai_list é“¾è¡¨ï¼ˆå£°å¡æ³¨å†Œæ—¶ä¼šéå†è¯¥é“¾è¡¨ï¼Œæ‰¾åˆ° dai_link å£°æ˜çš„ cpu_dai å¹¶ç»‘å®šï¼‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_register_dais</span><span class="params">(struct snd_soc_component *component,</span></span></span><br><span class="line"><span class="function"><span class="params">struct snd_soc_dai_driver *dai_drv, <span class="keyword">size_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">bool</span> legacy_dai_naming)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> = <span class="title">component</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> *<span class="title">dai</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">dev_dbg(dev, <span class="string">"ASoC: dai register %s #%Zu\n"</span>, dev_name(dev), count);</span><br><span class="line"></span><br><span class="line">component-&gt;dai_drv = dai_drv;</span><br><span class="line">component-&gt;num_dai = count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line"></span><br><span class="line">dai = kzalloc(<span class="keyword">sizeof</span>(struct snd_soc_dai), GFP_KERNEL);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> (count == <span class="number">1</span> &amp;&amp; legacy_dai_naming) &#123;</span><br><span class="line">dai-&gt;name = fmt_single_name(dev, &amp;dai-&gt;id);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">dai-&gt;name = fmt_multiple_name(dev, &amp;dai_drv[i]);</span><br><span class="line"><span class="keyword">if</span> (dai_drv[i].id)</span><br><span class="line">dai-&gt;id = dai_drv[i].id;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dai-&gt;id = i;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">dai-&gt;component = component;</span><br><span class="line">dai-&gt;dev = dev;</span><br><span class="line">dai-&gt;driver = &amp;dai_drv[i];</span><br><span class="line"><span class="keyword">if</span> (!dai-&gt;driver-&gt;ops)</span><br><span class="line">dai-&gt;driver-&gt;ops = &amp;null_dai_ops;</span><br><span class="line"></span><br><span class="line">list_add(&amp;dai-&gt;<span class="built_in">list</span>, &amp;component-&gt;dai_list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dai æ“ä½œå‡½æ•°çš„å®ç°æ˜¯ cpu_dai é©±åŠ¨çš„ä¸»ä½“ï¼Œéœ€è¦é…ç½®å¥½ç›¸å…³å¯„å­˜å™¨è®© I2S/PCM æ€»çº¿æ§åˆ¶å™¨æ­£å¸¸è¿è½¬ï¼Œsnd_soc_dai_ops å­—æ®µçš„è¯¦ç»†è¯´æ˜è§ 3.6. Codec audio operations ç« èŠ‚ã€‚</p><p>cpu_dai é©±åŠ¨åº”è¯¥ç®—æ˜¯è¿™ä¸ªç³»åˆ—ä¸­æœ€ç®€å•çš„ä¸€ç¯ï¼Œå› æ­¤ä¸å¤šèŠ±è´¹ç¬”å¢¨åœ¨è¿™é‡Œäº†ã€‚å€’æ˜¯æŸäº›å¹³å°ä¸Šï¼Œdma è®¾å¤‡ä¿¡æ¯ï¼ˆæ€»çº¿åœ°å€ã€é€šé“å·ã€ä¼ è¾“å•å…ƒå¤§å°ï¼‰æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ï¼Œè¿™ç‚¹è¦ç•™æ„ï¼Œè¿™äº› dma è®¾å¤‡ä¿¡æ¯åœ¨ pcm_dma é©±åŠ¨ä¸­ç”¨åˆ°ã€‚</p><h5 id="4-1-pcm-operations"><a href="#4-1-pcm-operations" class="headerlink" title="4.1. pcm operations"></a>4.1. pcm operations</h5><p>æ“ä½œå‡½æ•°çš„å®ç°æ˜¯æœ¬æ¨¡å—çš„ä¸»ä½“ï¼Œè§ snd_pcm_ops ç»“æ„ä½“æè¿°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/pcm.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_ops</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> (*open)(struct snd_pcm_substream *substream);</span><br><span class="line"><span class="keyword">int</span> (*close)(struct snd_pcm_substream *substream);</span><br><span class="line"><span class="keyword">int</span> (*ioctl)(struct snd_pcm_substream * substream,</span><br><span class="line">     <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg);</span><br><span class="line"><span class="keyword">int</span> (*compat_ioctl)(struct snd_pcm_substream *substream,</span><br><span class="line">     <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg);</span><br><span class="line"><span class="keyword">int</span> (*hw_params)(struct snd_pcm_substream *substream,</span><br><span class="line"> struct snd_pcm_hw_params *params);</span><br><span class="line"><span class="keyword">int</span> (*hw_free)(struct snd_pcm_substream *substream);</span><br><span class="line"><span class="keyword">int</span> (*prepare)(struct snd_pcm_substream *substream);</span><br><span class="line"><span class="keyword">int</span> (*trigger)(struct snd_pcm_substream *substream, <span class="keyword">int</span> cmd);</span><br><span class="line"><span class="keyword">snd_pcm_uframes_t</span> (*pointer)(struct snd_pcm_substream *substream);</span><br><span class="line"><span class="keyword">int</span> (*delay_blk)(struct snd_pcm_substream *substream);</span><br><span class="line"><span class="keyword">int</span> (*wall_clock)(struct snd_pcm_substream *substream,</span><br><span class="line">  struct timespec *audio_ts);</span><br><span class="line"><span class="keyword">int</span> (*copy)(struct snd_pcm_substream *substream, <span class="keyword">int</span> channel,</span><br><span class="line">    <span class="keyword">snd_pcm_uframes_t</span> pos,</span><br><span class="line">    <span class="keyword">void</span> __user *buf, <span class="keyword">snd_pcm_uframes_t</span> count);</span><br><span class="line"><span class="keyword">int</span> (*silence)(struct snd_pcm_substream *substream, <span class="keyword">int</span> channel,</span><br><span class="line">       <span class="keyword">snd_pcm_uframes_t</span> pos, <span class="keyword">snd_pcm_uframes_t</span> count);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *(*<span class="title">page</span>)(<span class="title">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">substream</span>,</span></span><br><span class="line"><span class="class">     <span class="title">unsigned</span> <span class="title">long</span> <span class="title">offset</span>);</span></span><br><span class="line"><span class="keyword">int</span> (*mmap)(struct snd_pcm_substream *substream, struct vm_area_struct *vma);</span><br><span class="line"><span class="keyword">int</span> (*ack)(struct snd_pcm_substream *substream);</span><br><span class="line"><span class="keyword">int</span> (*restart)(struct snd_pcm_substream *substream);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="4-1-platform-driver-æ³¨å†Œ"><a href="#4-1-platform-driver-æ³¨å†Œ" class="headerlink" title="4.1. platform_driver æ³¨å†Œ"></a>4.1. platform_driver æ³¨å†Œ</h5><p>å½“ platform_driverï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">msm_pcm_driver</span> = &#123;</span></span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = <span class="string">"msm-pcm-dsp"</span>,</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.of_match_table = msm_pcm_dt_match,</span><br><span class="line">&#125;,</span><br><span class="line">.probe = msm_pcm_probe,</span><br><span class="line">.remove = msm_pcm_remove,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸ .name = â€œmsm-pcm-dspâ€ çš„ platform_device æ³¨å†Œ åŒ¹é…åï¼Œç³»ç»Ÿä¼šå›è°ƒ msm_pcm_probe() æ³¨å†Œ platformï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm_pcm_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> rc;</span><br><span class="line"><span class="keyword">int</span> id;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msm_plat_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *latency_level;</span><br><span class="line"></span><br><span class="line">rc = of_property_read_u32(pdev-&gt;dev.of_node,</span><br><span class="line"><span class="string">"qcom,msm-pcm-dsp-id"</span>, &amp;id);</span><br><span class="line">......</span><br><span class="line">pdata = kzalloc(<span class="keyword">sizeof</span>(struct msm_plat_data), GFP_KERNEL);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (of_property_read_bool(pdev-&gt;dev.of_node,</span><br><span class="line"><span class="string">"qcom,msm-pcm-low-latency"</span>)) &#123;</span><br><span class="line">pdata-&gt;perf_mode = LOW_LATENCY_PCM_MODE;</span><br><span class="line">rc = of_property_read_string(pdev-&gt;dev.of_node,</span><br><span class="line"><span class="string">"qcom,latency-level"</span>, &amp;latency_level);</span><br><span class="line"><span class="keyword">if</span> (!rc) &#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(latency_level, <span class="string">"ultra"</span>))</span><br><span class="line">pdata-&gt;perf_mode = ULTRA_LOW_LATENCY_PCM_MODE;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(latency_level, <span class="string">"ull-pp"</span>))</span><br><span class="line">pdata-&gt;perf_mode =</span><br><span class="line">ULL_POST_PROCESSING_PCM_MODE;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">pdata-&gt;perf_mode = LEGACY_PCM_MODE;</span><br><span class="line"></span><br><span class="line">dev_set_drvdata(&amp;pdev-&gt;dev, pdata);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> snd_soc_register_platform(&amp;pdev-&gt;dev,</span><br><span class="line">   &amp;msm_soc_platform);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>snd_soc_register_platformï¼šå°† platform_drv æ³¨å†Œåˆ° soc-coreã€‚<br>åˆ›å»ºä¸€ä¸ª snd_soc_platform å®ä¾‹ï¼ŒåŒ…å« platform_drvï¼ˆsnd_soc_platform_driverï¼‰çš„ç›¸å…³ä¿¡æ¯ï¼Œå°è£…ç»™ soc-core ä½¿ç”¨ï¼›<br>æŠŠä»¥ä¸Šåˆ›å»ºçš„ platform å®ä¾‹æ’å…¥åˆ° platform_list é“¾è¡¨ä¸Šï¼ˆå£°å¡æ³¨å†Œæ—¶ä¼šéå†è¯¥é“¾è¡¨ï¼Œæ‰¾åˆ° dai_link å£°æ˜çš„ platform å¹¶ç»‘å®šï¼‰ã€‚<br>ä»£ç å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int snd_soc_register_platform(struct device *dev,</span><br><span class="line">const struct snd_soc_platform_driver *platform_drv)</span><br><span class="line">&#123;</span><br><span class="line">struct snd_soc_platform *platform;</span><br><span class="line">int ret;</span><br><span class="line"></span><br><span class="line">platform = kzalloc(sizeof(struct snd_soc_platform), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">ret = snd_soc_add_platform(dev, platform, platform_drv);</span><br><span class="line"></span><br><span class="line">return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå®Œæˆäº† Platform é©±åŠ¨çš„å®ç°ã€‚å›æ”¾æƒ…å½¢ä¸‹ï¼Œpcm_dma è®¾å¤‡è´Ÿè´£æŠŠ dma buffer ä¸­çš„æ•°æ®æ¬è¿åˆ° I2S tx FIFOï¼ŒI2S æ€»çº¿æ§åˆ¶å™¨è´Ÿè´£æŠŠ I2S tx FIFO ä¸­çš„æ•°æ®ä¼ é€DSPï¼ŒDSPç»å¤„ç†åä¼ é€åˆ°åˆ° Codecã€‚</p><h4 id="ï¼ˆäº”ï¼‰-Machine-Driver"><a href="#ï¼ˆäº”ï¼‰-Machine-Driver" class="headerlink" title="ï¼ˆäº”ï¼‰  Machine Driver"></a>ï¼ˆäº”ï¼‰  Machine Driver</h4><p>ç« èŠ‚ 3. Codec å’Œ 4. Platform ä»‹ç»äº† Codecã€Platform é©±åŠ¨ï¼Œä½†ä»…æœ‰ Codecã€Platform é©±åŠ¨æ˜¯ä¸èƒ½å·¥ä½œçš„ï¼Œéœ€è¦ä¸€ä¸ªè§’è‰²æŠŠ codecã€codec_daiã€cpu_daiã€platform ç»™é“¾ç»“èµ·æ¥æ‰èƒ½æ„æˆä¸€ä¸ªå®Œæ•´çš„éŸ³é¢‘é“¾è·¯ï¼Œè¿™ä¸ªè§’è‰²å°±ç”± machine_drv æ‰¿æ‹…äº†ã€‚</p><p>snd_soc_dai_link ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;<span class="comment">/* Codec name */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *stream_name;<span class="comment">/* Stream name */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *cpu_name;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">cpu_of_node</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *cpu_dai_name;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *codec_name;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">codec_of_node</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *codec_dai_name;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">codecs</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_codecs;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *platform_name;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">platform_of_node</span>;</span></span><br><span class="line"><span class="keyword">int</span> be_id;<span class="comment">/* optional ID for machine driver BE identification */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> *<span class="title">params</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> dai_fmt;           <span class="comment">/* format to set on init */</span></span><br><span class="line"><span class="keyword">enum</span> snd_soc_dpcm_trigger trigger[<span class="number">2</span>]; <span class="comment">/* trigger type for DPCM */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ignore_suspend:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_rates:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_channels:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_samplebits:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> no_pcm:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> dynamic:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> no_host_mode:<span class="number">2</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_capture:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_playback:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ignore_pmdown_time:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> (*init)(struct snd_soc_pcm_runtime *rtd);</span><br><span class="line"><span class="keyword">int</span> (*be_hw_params_fixup)(struct snd_soc_pcm_runtime *rtd,</span><br><span class="line">struct snd_pcm_hw_params *params);</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_compr_ops</span> *<span class="title">compr_ops</span>;</span></span><br><span class="line"><span class="keyword">bool</span> playback_only;</span><br><span class="line"><span class="keyword">bool</span> capture_only;</span><br><span class="line"><span class="keyword">enum</span> snd_soc_async_ops async_ops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹ä»‹ç»å¦‚ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><p>â€¢ codec_nameï¼šéŸ³é¢‘é“¾è·¯éœ€è¦ç»‘å®šçš„ codec åç§°ï¼Œå£°å¡æ³¨å†Œæ—¶ä¼šéå† codec_listï¼Œæ‰¾åˆ°åŒåçš„ codec å¹¶ç»‘å®šï¼›<br>â€¢ platform_nameï¼šéŸ³é¢‘é“¾è·¯éœ€è¦ç»‘å®šçš„ platform åç§°ï¼Œå£°å¡æ³¨å†Œæ—¶ä¼šéå† platform_listï¼Œæ‰¾åˆ°åŒåçš„ platform å¹¶ç»‘å®šï¼›<br>â€¢ cpu_dai_nameï¼šéŸ³é¢‘é“¾è·¯éœ€è¦ç»‘å®šçš„ cpu_dai åç§°ï¼Œå£°å¡æ³¨å†Œæ—¶ä¼šéå† dai_listï¼Œæ‰¾åˆ°åŒåçš„ dai å¹¶ç»‘å®šï¼›<br>â€¢ codec_dai_nameï¼šéŸ³é¢‘é“¾è·¯éœ€è¦ç»‘å®šçš„ codec_dai åç§°ï¼Œå£°å¡æ³¨å†Œæ—¶ä¼šéå† dai_listï¼Œæ‰¾åˆ°åŒåçš„ dai å¹¶ç»‘å®šï¼›<br>opsï¼šé‡ç‚¹ç•™æ„ hw_params() å›è°ƒï¼Œä¸€èˆ¬æ¥è¯´è¿™ä¸ªå›è°ƒæ˜¯è¦å®ç°çš„ï¼Œç”¨äºé…ç½® codecã€codec_daiã€cpu_dai çš„æ•°æ®æ ¼å¼å’Œç³»ç»Ÿæ—¶é’Ÿã€‚åœ¨ 3.6. Codec audio operations å°èŠ‚ä¸­æœ‰æè¿°ã€‚<br>/sound/soc/msm/msm8996.c ä¸­çš„ dai_link å®šä¹‰ï¼Œä¸¤ä¸ªéŸ³é¢‘é“¾è·¯åˆ†åˆ«ç”¨äº Mediaå’Œ Voiceï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm8996.c]</span><br><span class="line"><span class="comment">/* Digital audio interface glue - connects codec &lt;---&gt; CPU */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> <span class="title">msm8996_common_dai_links</span>[] = &#123;</span></span><br><span class="line"><span class="comment">/* FrontEnd DAI Links */</span></span><br><span class="line">&#123;</span><br><span class="line">.name = <span class="string">"MSM8996 Media1"</span>,</span><br><span class="line">.stream_name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">.cpu_dai_name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">.platform_name = <span class="string">"msm-pcm-dsp.0"</span>,</span><br><span class="line">.dynamic = <span class="number">1</span>,</span><br><span class="line">.async_ops = ASYNC_DPCM_SND_SOC_PREPARE,</span><br><span class="line">.dpcm_playback = <span class="number">1</span>,</span><br><span class="line">.dpcm_capture = <span class="number">1</span>,</span><br><span class="line">.trigger = &#123;SND_SOC_DPCM_TRIGGER_POST,</span><br><span class="line">SND_SOC_DPCM_TRIGGER_POST&#125;,</span><br><span class="line">.codec_dai_name = <span class="string">"snd-soc-dummy-dai"</span>,</span><br><span class="line">.codec_name = <span class="string">"snd-soc-dummy"</span>,</span><br><span class="line">.ignore_suspend = <span class="number">1</span>,</span><br><span class="line"><span class="comment">/* this dainlink has playback support */</span></span><br><span class="line">.ignore_pmdown_time = <span class="number">1</span>,</span><br><span class="line">.be_id = MSM_FRONTEND_DAI_MULTIMEDIA1</span><br><span class="line">&#125;,</span><br><span class="line">......</span><br><span class="line">&#123;</span><br><span class="line">.name = <span class="string">"VoiceMMode1"</span>,</span><br><span class="line">.stream_name = <span class="string">"VoiceMMode1"</span>,</span><br><span class="line">.cpu_dai_name = <span class="string">"VoiceMMode1"</span>,</span><br><span class="line">.platform_name = <span class="string">"msm-pcm-voice"</span>,</span><br><span class="line">.dynamic = <span class="number">1</span>,</span><br><span class="line">.dpcm_playback = <span class="number">1</span>,</span><br><span class="line">.dpcm_capture = <span class="number">1</span>,</span><br><span class="line">.trigger = &#123;SND_SOC_DPCM_TRIGGER_POST,</span><br><span class="line">    SND_SOC_DPCM_TRIGGER_POST&#125;,</span><br><span class="line">.no_host_mode = SND_SOC_DAI_LINK_NO_HOST,</span><br><span class="line">.ignore_suspend = <span class="number">1</span>,</span><br><span class="line">.ignore_pmdown_time = <span class="number">1</span>,</span><br><span class="line">.codec_dai_name = <span class="string">"snd-soc-dummy-dai"</span>,</span><br><span class="line">.codec_name = <span class="string">"snd-soc-dummy"</span>,</span><br><span class="line">.be_id = MSM_FRONTEND_DAI_VOICEMMODE1,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº† dai_linkï¼Œæœºå™¨ä¸­ä¸€äº›ç‰¹å®šçš„éŸ³é¢‘æ§ä»¶å’ŒéŸ³é¢‘äº‹ä»¶ä¹Ÿå¯ä»¥åœ¨ machine_drv å®šä¹‰ï¼Œå¦‚è€³æœºæ’æ‹”æ£€æµ‹ã€å¤–éƒ¨åŠŸæ”¾æ‰“å¼€å…³é—­ç­‰ã€‚</p><p>æˆ‘ä»¬å†åˆ†æ machine_drv åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm8996.c]</span><br><span class="line">static struct platform_driver msm8996_asoc_machine_driver = &#123;</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = DRV_NAME,</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.pm = &amp;snd_soc_pm_ops,</span><br><span class="line">.of_match_table = msm8996_asoc_machine_of_match,</span><br><span class="line">&#125;,</span><br><span class="line">.probe = msm8996_asoc_machine_probe,</span><br><span class="line">.remove = msm8996_asoc_machine_remove,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm8996.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm8996_asoc_machine_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> *<span class="title">card</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msm8996_asoc_mach_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *mbhc_audio_jack_type = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span> *mclk_freq_prop_name;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">match</span>;</span></span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">    ......</span><br><span class="line">pdata = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line"><span class="keyword">sizeof</span>(struct msm8996_asoc_mach_data), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">card = populate_snd_card_dailinks(&amp;pdev-&gt;dev);</span><br><span class="line">......</span><br><span class="line">match = of_match_node(msm8996_asoc_machine_of_match,</span><br><span class="line">pdev-&gt;dev.of_node);</span><br><span class="line">ret = msm8996_populate_dai_link_component_of_node(card);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">ret = snd_soc_register_card(card);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®dailinksåï¼Œç»§è€Œè°ƒç”¨ snd_soc_register_card() æ³¨å†Œå£°å¡ã€‚ç”±äºè¯¥è¿‡ç¨‹å¾ˆå†—é•¿ï¼Œè¿™é‡Œä¸ä¸€ä¸€è´´ä»£ç åˆ†æäº†ï¼Œä½†æ•´ä¸ªæµç¨‹æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/23-Audio-system-msm8996-probe-snd-card-register.png" alt="Alt text"></p><p>â€¢ å–å‡º platform_device çš„ç§æœ‰æ•°æ®ï¼Œè¯¥ç§æœ‰æ•°æ®å°±æ˜¯ snd_soc_card ï¼›<br>â€¢ snd_soc_register_card() ä¸ºæ¯ä¸ª dai_link åˆ†é…ä¸€ä¸ª snd_soc_pcm_runtime å®ä¾‹ï¼Œåˆ«å¿˜äº†ä¹‹å‰æè¿‡ snd_soc_pcm_runtime æ˜¯ ASoC çš„æ¡¥æ¢ï¼Œä¿å­˜ç€ codecã€codec_daiã€cpu_daiã€platform ç­‰ç¡¬ä»¶è®¾å¤‡å®ä¾‹ã€‚<br>â€¢ éšåçš„å·¥ä½œéƒ½åœ¨ snd_soc_instantiate_card() è¿›è¡Œï¼š<br>â€¢ éå† dai_listã€codec_listã€platform_list é“¾è¡¨ï¼Œä¸ºæ¯ä¸ªéŸ³é¢‘é“¾è·¯æ‰¾åˆ°å¯¹åº”çš„ cpu_daiã€codec_daiã€codecã€platformï¼›æ‰¾åˆ°çš„ cpu_daiã€codec_daiã€codecã€platform ä¿å­˜åˆ° snd_soc_pcm_runtime ï¼Œå®ŒæˆéŸ³é¢‘é“¾è·¯çš„è®¾å¤‡ç»‘å®šï¼›<br>â€¢ è°ƒç”¨ snd_card_create() åˆ›å»ºå£°å¡ï¼›<br>â€¢ soc_probe_dai_link() ä¾æ¬¡å›è°ƒ cpu_daiã€codecã€platformã€codec_dai çš„ probe() å‡½æ•°ï¼Œå®Œæˆå„éŸ³é¢‘è®¾å¤‡çš„åˆå§‹åŒ–ï¼Œéšåè°ƒç”¨<br>â€¢ soc_new_pcm() åˆ›å»º pcm é€»è¾‘è®¾å¤‡ï¼ˆå› ä¸ºæ¶‰åŠåˆ°æœ¬ç³»åˆ—çš„é‡ç‚¹å†…å®¹ï¼Œåé¢å…·ä½“åˆ†æè¿™ä¸ªå‡½æ•°ï¼‰ï¼›<br>æœ€åè°ƒç”¨ snd_card_register() æ³¨å†Œå£°å¡ã€‚</p><p>[-&gt;sound/soc/soc-core.c]</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/24-Audio-system-msm8996-probe-snd-card.png" alt="Alt text"></p><p>soc_new_pcm æºç åˆ†æï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-pcm.c]</span><br><span class="line"><span class="comment">/* create a new pcm */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">soc_new_pcm</span><span class="params">(struct snd_soc_pcm_runtime *rtd, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_platform</span> *<span class="title">platform</span> = <span class="title">rtd</span>-&gt;<span class="title">platform</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> *<span class="title">codec_dai</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> *<span class="title">cpu_dai</span> = <span class="title">rtd</span>-&gt;<span class="title">cpu_dai</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line"><span class="keyword">char</span> new_name[<span class="number">64</span>];</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>, playback = <span class="number">0</span>, capture = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rtd-&gt;dai_link-&gt;dynamic || rtd-&gt;dai_link-&gt;no_pcm) &#123;</span><br><span class="line">playback = rtd-&gt;dai_link-&gt;dpcm_playback;</span><br><span class="line">capture = rtd-&gt;dai_link-&gt;dpcm_capture;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rtd-&gt;num_codecs; i++) &#123;</span><br><span class="line">codec_dai = rtd-&gt;codec_dais[i];</span><br><span class="line"><span class="keyword">if</span> (codec_dai-&gt;driver-&gt;playback.channels_min)</span><br><span class="line">playback = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (codec_dai-&gt;driver-&gt;capture.channels_min)</span><br><span class="line">capture = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">capture = capture &amp;&amp; cpu_dai-&gt;driver-&gt;capture.channels_min;</span><br><span class="line">playback = playback &amp;&amp; cpu_dai-&gt;driver-&gt;playback.channels_min;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rtd-&gt;dai_link-&gt;playback_only) &#123;</span><br><span class="line">playback = <span class="number">1</span>;</span><br><span class="line">capture = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rtd-&gt;dai_link-&gt;capture_only) &#123;</span><br><span class="line">playback = <span class="number">0</span>;</span><br><span class="line">capture = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* create the PCM */</span></span><br><span class="line"><span class="keyword">if</span> (rtd-&gt;dai_link-&gt;no_pcm) &#123;</span><br><span class="line"><span class="built_in">snprintf</span>(new_name, <span class="keyword">sizeof</span>(new_name), <span class="string">"(%s)"</span>,</span><br><span class="line">rtd-&gt;dai_link-&gt;stream_name);</span><br><span class="line"></span><br><span class="line">ret = snd_pcm_new_internal(rtd-&gt;card-&gt;snd_card, new_name, num,</span><br><span class="line">playback, capture, &amp;pcm);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (rtd-&gt;dai_link-&gt;dynamic)</span><br><span class="line"><span class="built_in">snprintf</span>(new_name, <span class="keyword">sizeof</span>(new_name), <span class="string">"%s (*)"</span>,</span><br><span class="line">rtd-&gt;dai_link-&gt;stream_name);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">snprintf</span>(new_name, <span class="keyword">sizeof</span>(new_name), <span class="string">"%s %s-%d"</span>,</span><br><span class="line">rtd-&gt;dai_link-&gt;stream_name,</span><br><span class="line">(rtd-&gt;num_codecs &gt; <span class="number">1</span>) ?</span><br><span class="line"><span class="string">"multicodec"</span> : rtd-&gt;codec_dai-&gt;name, num);</span><br><span class="line"></span><br><span class="line">ret = snd_pcm_new(rtd-&gt;card-&gt;snd_card, new_name, num, playback,</span><br><span class="line">capture, &amp;pcm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">dev_err(rtd-&gt;card-&gt;dev, <span class="string">"ASoC: can't create pcm for %s\n"</span>,</span><br><span class="line">rtd-&gt;dai_link-&gt;name);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">dev_dbg(rtd-&gt;card-&gt;dev, <span class="string">"ASoC: registered pcm #%d %s\n"</span>,num, new_name);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* DAPM dai link stream work */</span></span><br><span class="line">INIT_DELAYED_WORK(&amp;rtd-&gt;delayed_work, close_delayed_work);</span><br><span class="line"></span><br><span class="line">rtd-&gt;pcm = pcm;</span><br><span class="line">pcm-&gt;private_data = rtd;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rtd-&gt;dai_link-&gt;no_pcm) &#123;</span><br><span class="line"><span class="keyword">if</span> (playback)</span><br><span class="line">pcm-&gt;streams[SNDRV_PCM_STREAM_PLAYBACK].substream-&gt;private_data = rtd;</span><br><span class="line"><span class="keyword">if</span> (capture)</span><br><span class="line">pcm-&gt;streams[SNDRV_PCM_STREAM_CAPTURE].substream-&gt;private_data = rtd;</span><br><span class="line"><span class="keyword">if</span> (platform-&gt;driver-&gt;pcm_new)</span><br><span class="line">rtd-&gt;platform-&gt;driver-&gt;pcm_new(rtd);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* setup any hostless PCMs - i.e. no host IO is performed */</span></span><br><span class="line"><span class="keyword">if</span> (rtd-&gt;dai_link-&gt;no_host_mode) &#123;</span><br><span class="line"><span class="keyword">if</span> (pcm-&gt;streams[SNDRV_PCM_STREAM_PLAYBACK].substream) &#123;</span><br><span class="line">pcm-&gt;streams[SNDRV_PCM_STREAM_PLAYBACK].substream-&gt;hw_no_buffer = <span class="number">1</span>;</span><br><span class="line">snd_soc_set_runtime_hwparams(</span><br><span class="line">pcm-&gt;streams[SNDRV_PCM_STREAM_PLAYBACK].substream,</span><br><span class="line">&amp;no_host_hardware);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pcm-&gt;streams[SNDRV_PCM_STREAM_CAPTURE].substream) &#123;</span><br><span class="line">pcm-&gt;streams[SNDRV_PCM_STREAM_CAPTURE].substream-&gt;hw_no_buffer = <span class="number">1</span>;</span><br><span class="line">snd_soc_set_runtime_hwparams(</span><br><span class="line">pcm-&gt;streams[SNDRV_PCM_STREAM_CAPTURE].substream,</span><br><span class="line">&amp;no_host_hardware);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ASoC PCM operations */</span></span><br><span class="line"><span class="keyword">if</span> (rtd-&gt;dai_link-&gt;dynamic) &#123;</span><br><span class="line">rtd-&gt;ops.open= dpcm_fe_dai_open;</span><br><span class="line">rtd-&gt;ops.hw_params= dpcm_fe_dai_hw_params;</span><br><span class="line">rtd-&gt;ops.prepare= dpcm_fe_dai_prepare;</span><br><span class="line">rtd-&gt;ops.trigger= dpcm_fe_dai_trigger;</span><br><span class="line">rtd-&gt;ops.hw_free= dpcm_fe_dai_hw_free;</span><br><span class="line">rtd-&gt;ops.close= dpcm_fe_dai_close;</span><br><span class="line">rtd-&gt;ops.pointer= soc_pcm_pointer;</span><br><span class="line">rtd-&gt;ops.delay_blk= soc_pcm_delay_blk;</span><br><span class="line">rtd-&gt;ops.ioctl= soc_pcm_ioctl;</span><br><span class="line">rtd-&gt;ops.compat_ioctl   = soc_pcm_compat_ioctl;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">rtd-&gt;ops.open= soc_pcm_open;</span><br><span class="line">rtd-&gt;ops.hw_params= soc_pcm_hw_params;</span><br><span class="line">rtd-&gt;ops.prepare= soc_pcm_prepare;</span><br><span class="line">rtd-&gt;ops.trigger= soc_pcm_trigger;</span><br><span class="line">rtd-&gt;ops.hw_free= soc_pcm_hw_free;</span><br><span class="line">rtd-&gt;ops.close= soc_pcm_close;</span><br><span class="line">rtd-&gt;ops.pointer= soc_pcm_pointer;</span><br><span class="line">rtd-&gt;ops.delay_blk= soc_pcm_delay_blk;</span><br><span class="line">rtd-&gt;ops.ioctl= soc_pcm_ioctl;</span><br><span class="line">rtd-&gt;ops.compat_ioctl   = soc_pcm_compat_ioctl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (platform-&gt;driver-&gt;ops) &#123;</span><br><span class="line">rtd-&gt;ops.ack= platform-&gt;driver-&gt;ops-&gt;ack;</span><br><span class="line">rtd-&gt;ops.copy= platform-&gt;driver-&gt;ops-&gt;copy;</span><br><span class="line">rtd-&gt;ops.silence= platform-&gt;driver-&gt;ops-&gt;silence;</span><br><span class="line">rtd-&gt;ops.page= platform-&gt;driver-&gt;ops-&gt;page;</span><br><span class="line">rtd-&gt;ops.mmap= platform-&gt;driver-&gt;ops-&gt;mmap;</span><br><span class="line">rtd-&gt;ops.restart= platform-&gt;driver-&gt;ops-&gt;restart;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (playback)</span><br><span class="line">snd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK, &amp;rtd-&gt;ops);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (capture)</span><br><span class="line">snd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, &amp;rtd-&gt;ops);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (platform-&gt;driver-&gt;pcm_new) &#123;</span><br><span class="line">ret = platform-&gt;driver-&gt;pcm_new(rtd);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">dev_err(platform-&gt;dev,</span><br><span class="line"><span class="string">"ASoC: pcm constructor failed: %d\n"</span>,</span><br><span class="line">ret);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pcm-&gt;private_free = platform-&gt;driver-&gt;pcm_free;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§ soc_new_pcm() æœ€ä¸»è¦çš„å·¥ä½œæ˜¯åˆ›å»º pcm é€»è¾‘è®¾å¤‡ï¼Œåˆ›å»ºå›æ”¾å­æµå’Œå½•åˆ¶å­æµå®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–å›æ”¾å­æµå’Œå½•åˆ¶å­æµçš„ pcm æ“ä½œå‡½æ•°ï¼ˆæ•°æ®æ¬è¿æ—¶ï¼Œéœ€è¦è°ƒç”¨è¿™äº›å‡½æ•°æ¥é©±åŠ¨ codecã€codec_daiã€cpu_daiã€dma è®¾å¤‡å·¥ä½œï¼‰ã€‚</p><h4 id="ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ-PCM-è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹"><a href="#ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ-PCM-è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹" class="headerlink" title="ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ PCM è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹"></a>ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ PCM è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹</h4><p>å‰é¢å‡ ç« åˆ†æäº† Codecã€Platformã€Machine é©±åŠ¨çš„ç»„æˆéƒ¨åˆ†åŠå…¶æ³¨å†Œè¿‡ç¨‹ï¼Œè¿™ä¸‰è€…éƒ½æ˜¯ç‰©ç†è®¾å¤‡ç›¸å…³çš„ï¼Œå¤§å®¶åº”è¯¥å¯¹éŸ³é¢‘ç‰©ç†é“¾è·¯æœ‰äº†ä¸€å®šçš„è®¤çŸ¥ã€‚æ¥ç€åˆ†æéŸ³é¢‘é©±åŠ¨çš„ä¸­é—´å±‚ï¼Œç”±äºè¿™äº›å¹¶ä¸æ˜¯çœŸæ­£çš„ç‰©ç†è®¾å¤‡ï¼Œæ•…æˆ‘ä»¬ç§°ä¹‹ä¸ºé€»è¾‘è®¾å¤‡ã€‚</p><p>PCM é€»è¾‘è®¾å¤‡ï¼Œæˆ‘ä»¬åˆä¹ æƒ¯ç§°ä¹‹ä¸º PCM ä¸­é—´å±‚æˆ– pcm nativeï¼Œèµ·ç€æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼šå¾€ä¸Šæ˜¯ä¸ç”¨æˆ·æ€æ¥å£çš„äº¤äº’ï¼Œå®ç°éŸ³é¢‘æ•°æ®åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„æ‹·è´ï¼›å¾€ä¸‹æ˜¯è§¦å‘ codecã€platformã€machine çš„æ“ä½œå‡½æ•°ï¼Œå®ç°éŸ³é¢‘æ•°æ®åœ¨ dma_buffer &lt;-&gt; cpu_dai &lt;-&gt; codec ä¹‹é—´çš„ä¼ è¾“ã€‚åé¢ç« èŠ‚å°†ä¼šè¯¦ç»†åˆ†æè¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™é‡Œè¿˜æ˜¯å…ˆä»å£°å¡çš„æ³¨å†Œè°ˆèµ·ã€‚<br>å£°å¡é©±åŠ¨ä¸­ï¼Œä¸€èˆ¬æŒ‚è½½ç€å¤šä¸ªé€»è¾‘è®¾å¤‡ï¼Œçœ‹çœ‹æˆ‘ä»¬è®¡ç®—æœºçš„å£°å¡é©±åŠ¨æœ‰å‡ ä¸ªé€»è¾‘è®¾å¤‡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /proc/asound/devices </span><br><span class="line">  2: [ 0]   : control</span><br><span class="line">  3: [ 0- 0]: digital audio playback</span><br><span class="line">  4: [ 0- 0]: digital audio capture</span><br><span class="line">  5: [ 0- 1]: digital audio playback</span><br><span class="line">  6: [ 0- 1]: digital audio capture</span><br><span class="line"> ......</span><br><span class="line"> 27: [ 0-16]: digital audio playback</span><br><span class="line"> 28: [ 0-16]: digital audio capture</span><br><span class="line"> 29: [ 0-17]: digital audio playback</span><br><span class="line"> 30: [ 0-17]: digital audio capture</span><br><span class="line"> 33:        : timer</span><br></pre></td></tr></table></figure><blockquote><p>digital audio playback    ç”¨äºå›æ”¾çš„ PCM è®¾å¤‡<br>digital audio capture    ç”¨äºå½•åˆ¶çš„ PCM è®¾å¤‡<br>control    ç”¨äºå£°å¡æ§åˆ¶çš„ CTL è®¾å¤‡ï¼Œå¦‚é€šè·¯æ§åˆ¶ã€éŸ³é‡è°ƒæ•´ç­‰<br>timer    å®šæ—¶å™¨è®¾å¤‡<br>æ‰‹æœºç³»ç»Ÿä¸­ï¼Œé€šå¸¸æˆ‘ä»¬æ›´å…³å¿ƒ PCM å’Œ CTL è¿™ä¸¤ç§è®¾å¤‡ã€‚</p></blockquote><p>è®¾å¤‡èŠ‚ç‚¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">adb shell ls -l /dev/snd</span><br><span class="line">crw-rw---- 1 system audio 116,  51 1970-06-19 02:07 comprC0D24</span><br><span class="line">crw-rw---- 1 system audio 116,  52 1970-06-19 02:07 comprC0D27</span><br><span class="line">crw-rw---- 1 system audio 116,  53 1970-06-19 02:07 comprC0D28</span><br><span class="line">......</span><br><span class="line">crw-rw---- 1 system audio 116,   2 1970-06-19 02:07 controlC0</span><br><span class="line">crw-rw---- 1 system audio 116,  59 1970-06-19 02:07 hwC0D1000</span><br><span class="line">crw-rw---- 1 system audio 116,  66 1970-06-19 02:07 hwC0D11</span><br><span class="line">crw-rw---- 1 system audio 116,  67 1970-06-19 02:07 hwC0D12</span><br><span class="line">crw-rw---- 1 system audio 116,  76 1970-06-19 02:07 hwC0D13</span><br><span class="line">......</span><br><span class="line">crw-rw---- 1 system audio 116,  13 1970-06-19 02:07 pcmC0D6c</span><br><span class="line">crw-rw---- 1 system audio 116,  14 1970-06-19 02:07 pcmC0D7p</span><br><span class="line">crw-rw---- 1 system audio 116,  15 1970-06-19 02:07 pcmC0D8c</span><br><span class="line">crw-rw---- 1 system audio 116,  33 1970-06-19 02:07 timer</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™äº›è®¾å¤‡èŠ‚ç‚¹çš„ Major=116ï¼ŒMinor åˆ™ä¸ /proc/asound/devices æ‰€åˆ—çš„å¯¹åº”èµ·æ¥ï¼Œéƒ½æ˜¯å­—ç¬¦è®¾å¤‡ã€‚ä¸Šå±‚å¯ä»¥é€šè¿‡ open/close/read/write/ioctl ç­‰ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œå£°å¡è®¾å¤‡ï¼Œè¿™å’Œå…¶ä»–å­—ç¬¦è®¾å¤‡ç±»ä¼¼ï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šä½¿ç”¨å·²å°è£…å¥½çš„ç”¨æˆ·æ¥å£åº“å¦‚ tinyalsaã€alsa-libã€‚</p><h5 id="6-1-å£°å¡ç»“æ„æ¦‚è¿°"><a href="#6-1-å£°å¡ç»“æ„æ¦‚è¿°" class="headerlink" title="6.1. å£°å¡ç»“æ„æ¦‚è¿°"></a>6.1. å£°å¡ç»“æ„æ¦‚è¿°</h5><p>å›é¡¾ä¸‹ ASoC æ˜¯å¦‚ä½•æ³¨å†Œå£°å¡çš„ï¼Œè¯¦ç»†è¯·å‚è€ƒç« èŠ‚ 5. ASoC machine driverï¼Œè¿™é‡Œä»…ç®€å•é™ˆè¿°ä¸‹ï¼š</p><p>â€¢ Machine é©±åŠ¨åˆå§‹åŒ–æ—¶ï¼Œ.name = â€œsoc-audioâ€ çš„ platform_device ä¸ platform_driver åŒ¹é…æˆåŠŸï¼Œè§¦å‘ soc_probe() è°ƒç”¨ï¼›<br>â€¢ ç»§è€Œè°ƒç”¨ snd_soc_register_card()ï¼š<br>  ï¹‹â€¢ ä¸ºæ¯ä¸ªéŸ³é¢‘ç‰©ç†é“¾è·¯æ‰¾åˆ°å¯¹åº”çš„ codecã€codec_daiã€cpu_daiã€platform è®¾å¤‡å®ä¾‹ï¼Œå®Œæˆ dai_link çš„ç»‘å®šï¼›<br>  ï¹‹ â€¢ è°ƒç”¨ snd_card_create() åˆ›å»ºå£°å¡ï¼›<br>  ï¹‹ â€¢ ä¾æ¬¡å›è°ƒ cpu_daiã€codecã€platform çš„ probe() å‡½æ•°ï¼Œå®Œæˆç‰©ç†è®¾å¤‡çš„åˆå§‹åŒ–ï¼›<br>â€¢ éšåè°ƒç”¨ soc_new_pcm()ï¼š<br>  ï¹‹ â€¢ è®¾ç½® pcm native ä¸­è¦ä½¿ç”¨çš„ pcm æ“ä½œå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ç”¨äºé©±åŠ¨éŸ³é¢‘ç‰©ç†è®¾å¤‡ï¼ŒåŒ…æ‹¬ machineã€codec_daiã€cpu_daiã€platformï¼›<br>  ï¹‹ â€¢ è°ƒç”¨ snd_pcm_new() åˆ›å»º pcm é€»è¾‘è®¾å¤‡ï¼Œå›æ”¾å­æµå’Œå½•åˆ¶å­æµéƒ½åœ¨è¿™é‡Œåˆ›å»ºï¼›<br>  ï¹‹ â€¢ å›è°ƒ platform é©±åŠ¨çš„ pcm_new()ï¼Œå®ŒæˆéŸ³é¢‘ dma è®¾å¤‡åˆå§‹åŒ–å’Œ dma buffer å†…å­˜åˆ†é…ï¼›<br>â€¢ æœ€åè°ƒç”¨ snd_card_register() æ³¨å†Œå£°å¡ã€‚<br>å…³äºéŸ³é¢‘ç‰©ç†è®¾å¤‡éƒ¨åˆ†ï¼ˆCodec/Platform/Machineï¼‰ä¸å†ç´¯è¿°ï¼Œä¸‹é¢è¯¦ç»†åˆ†æå£°å¡å’Œ PCM é€»è¾‘è®¾å¤‡çš„æ³¨å†Œè¿‡ç¨‹ã€‚</p><p>ä¸Šé¢æåˆ°å£°å¡é©±åŠ¨ä¸ŠæŒ‚ç€å¤šä¸ªé€»è¾‘å­è®¾å¤‡ï¼Œæœ‰ pcm éŸ³é¢‘æ•°æ®æµã€control æ··éŸ³å™¨ã€midi è¿·ç¬›ã€timer å®šæ—¶å™¨ç­‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                  +-----------+</span><br><span class="line">                  | snd_card  |</span><br><span class="line">                  +-----------+</span><br><span class="line">                    |   |   |</span><br><span class="line">        +-----------+   |   +------------+</span><br><span class="line">        |               |                |</span><br><span class="line">+-----------+    +-----------+    +-----------+</span><br><span class="line"> |  snd_pcm  |    |snd_control|    | snd_timer |    ...</span><br><span class="line"> +-----------+    +-----------+    +-----------+</span><br></pre></td></tr></table></figure><p>è¿™äº›ä¸å£°éŸ³ç›¸å…³çš„é€»è¾‘è®¾å¤‡éƒ½åœ¨ç»“æ„ä½“ snd_card ç®¡ç†ä¹‹ä¸‹ï¼Œå¯ä»¥è¯´ snd_card æ˜¯ alsa ä¸­æœ€é¡¶å±‚çš„ç»“æ„ã€‚æˆ‘ä»¬å†çœ‹çœ‹ alsa å£°å¡é©±åŠ¨çš„å¤§è‡´ç»“æ„å›¾ï¼ˆä¸æ˜¯ä¸¥æ ¼çš„ UML ç±»å›¾ï¼Œæœ‰ç»“æ„ä½“å®šä¹‰ã€æ¨¡å—å…³ç³»ã€å‡½æ•°è°ƒç”¨ï¼Œæ–¹ä¾¿æ ‡ç¤ºç»“æ„æ¨¡å—çš„å±‚æ¬¡åŠå…³ç³»ï¼‰ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/25-Audio-system-snd-card-uml.png" alt="Alt text"></p><p>snd_cardsï¼šè®°å½•ç€æ‰€æ³¨å†Œçš„å£°å¡å®ä¾‹ï¼Œæ¯ä¸ªå£°å¡å®ä¾‹æœ‰ç€å„è‡ªçš„é€»è¾‘è®¾å¤‡ï¼Œå¦‚ PCM è®¾å¤‡ã€CTL è®¾å¤‡ã€MIDI è®¾å¤‡ç­‰ï¼Œå¹¶ä¸€ä¸€è®°å½•åˆ° snd_card çš„ devices é“¾è¡¨ä¸Š<br>snd_minorsï¼šè®°å½•ç€æ‰€æœ‰é€»è¾‘è®¾å¤‡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå®ƒæ˜¯å£°å¡é€»è¾‘è®¾å¤‡ä¸ç³»ç»Ÿè°ƒç”¨ API ä¹‹é—´çš„æ¡¥æ¢ï¼›æ¯ä¸ª snd_minor åœ¨é€»è¾‘è®¾å¤‡æ³¨å†Œæ—¶è¢«å¡«å……ï¼Œåœ¨é€»è¾‘è®¾å¤‡ä½¿ç”¨æ—¶å°±å¯ä»¥ä»è¯¥ç»“æ„ä½“ä¸­å¾—åˆ°ç›¸åº”çš„ä¿¡æ¯ï¼ˆä¸»è¦æ˜¯ç³»ç»Ÿè°ƒç”¨å‡½æ•°é›† file_operationsï¼‰</p><h5 id="6-2-å£°å¡çš„åˆ›å»ºsnd-card-create"><a href="#6-2-å£°å¡çš„åˆ›å»ºsnd-card-create" class="headerlink" title="6.2. å£°å¡çš„åˆ›å»ºsnd_card_create()"></a>6.2. å£°å¡çš„åˆ›å»ºsnd_card_create()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/core/init.c]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  snd_card_new - create and initialize a soundcard structure</span></span><br><span class="line"><span class="comment"> *  @parent: the parent device object</span></span><br><span class="line"><span class="comment"> *  @idx: card index (address) [0 ... (SNDRV_CARDS-1)]</span></span><br><span class="line"><span class="comment"> *  @xid: card identification (ASCII string)</span></span><br><span class="line"><span class="comment"> *  @module: top level module for locking</span></span><br><span class="line"><span class="comment"> *  @extra_size: allocate this extra size after the main soundcard structure</span></span><br><span class="line"><span class="comment"> *  @card_ret: the pointer to store the created card instance</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Creates and initializes a soundcard structure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  The function allocates snd_card instance via kzalloc with the given</span></span><br><span class="line"><span class="comment"> *  space for the driver to use freely.  The allocated struct is stored</span></span><br><span class="line"><span class="comment"> *  in the given card_ret pointer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Return: Zero if successful or a negative error code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_card_new</span><span class="params">(struct device *parent, <span class="keyword">int</span> idx, <span class="keyword">const</span> <span class="keyword">char</span> *xid,</span></span></span><br><span class="line"><span class="function"><span class="params">    struct <span class="keyword">module</span> *<span class="keyword">module</span>, <span class="keyword">int</span> extra_size,</span></span></span><br><span class="line"><span class="function"><span class="params">    struct snd_card **card_ret)</span></span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šéå¸¸è¯¦ç»†ï¼Œç®€å•è¯´ä¸‹ï¼š<br>idxï¼šå£°å¡çš„ç¼–å·ï¼Œå¦‚ä¸º -1ï¼Œåˆ™ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…<br>xidï¼šå£°å¡æ ‡è¯†ç¬¦ï¼Œå¦‚ä¸º NULLï¼Œåˆ™ä»¥ snd_card çš„ shortname æˆ– longname ä»£æ›¿<br>card_retï¼šè¿”å›æ‰€åˆ›å»ºçš„å£°å¡å®ä¾‹çš„æŒ‡é’ˆ<br>å¦‚ä¸‹æ˜¯Google Pixelæ‰‹æœºçš„å£°å¡ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">sailfish:/ $ cat /proc/asound/cards</span><br><span class="line"> 0 [msm8996tashamar]: msm8996-tasha-m - msm8996-tasha-marlin-snd-card</span><br><span class="line">                      msm8996-tasha-marlin-snd-card</span><br></pre></td></tr></table></figure></p><h5 id="6-3-é€»è¾‘è®¾å¤‡çš„åˆ›å»º"><a href="#6-3-é€»è¾‘è®¾å¤‡çš„åˆ›å»º" class="headerlink" title="6.3. é€»è¾‘è®¾å¤‡çš„åˆ›å»º"></a>6.3. é€»è¾‘è®¾å¤‡çš„åˆ›å»º</h5><p>å½“å£°å¡å®ä¾‹å»ºç«‹åï¼Œæ¥ç€å¯ä»¥åˆ›å»ºå£°å¡ä¸‹é¢çš„å„ä¸ªé€»è¾‘è®¾å¤‡äº†ã€‚æ¯ä¸ªé€»è¾‘è®¾å¤‡åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ snd_device_new() ç”Ÿæˆä¸€ä¸ª snd_device å®ä¾‹ï¼Œå¹¶æŠŠè¯¥å®ä¾‹æŒ‚åˆ°å£°å¡ snd_card çš„ devices é“¾è¡¨ä¸Šã€‚alsa é©±åŠ¨ä¸ºå„ç§é€»è¾‘è®¾å¤‡æä¾›äº†åˆ›å»ºæ¥å£ï¼Œå¦‚ä¸‹ï¼š</p><blockquote><p>PCM    snd_pcm_new()<br>CONTROL    snd_ctl_create()<br>MIDI    snd_rawmidi_new()<br>TIMER    snd_timer_new()<br>SEQUENCER    snd_seq_device_new()<br>JACK    snd_jack_new()</p></blockquote><p>è¿™äº›æ¥å£çš„ä¸€èˆ¬è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_xxx_new</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è¿™äº›æ¥å£ä¾›é€»è¾‘è®¾å¤‡æ³¨å†Œæ—¶å›è°ƒ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_device_ops</span> <span class="title">ops</span> = &#123;</span></span><br><span class="line">        .dev_free = snd_xxx_dev_free,</span><br><span class="line">        .dev_register = snd_xxx_dev_register,</span><br><span class="line">        .dev_disconnect = snd_xxx_dev_disconnect,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€»è¾‘è®¾å¤‡å®ä¾‹åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°å»ºä¸€ä¸ªè®¾å¤‡å®ä¾‹ snd_deviceï¼ŒæŒ‚åˆ° snd_card çš„ devices é“¾è¡¨ä¸Šï¼ŒæŠŠè¯¥é€»è¾‘è®¾å¤‡çº³å…¥å£°å¡çš„ç®¡ç†å½“ä¸­ï¼ŒSNDRV_DEV_xxx æ˜¯é€»è¾‘è®¾å¤‡çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> snd_device_new(card, SNDRV_DEV_xxx, card, &amp;ops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ snd_device_ops æ˜¯å£°å¡é€»è¾‘è®¾å¤‡çš„æ³¨å†Œå‡½æ•°é›†ï¼Œdev_register() å›è°ƒå°¤å…¶é‡è¦ï¼Œå®ƒåœ¨å£°å¡æ³¨å†Œæ—¶è¢«è°ƒç”¨ï¼Œç”¨äºå»ºç«‹ç³»ç»Ÿçš„è®¾å¤‡èŠ‚ç‚¹ï¼Œ/dev/snd/ ç›®å½•çš„è®¾å¤‡èŠ‚ç‚¹éƒ½æ˜¯åœ¨è¿™é‡Œåˆ›å»ºçš„ï¼Œé€šè¿‡è¿™äº›è®¾å¤‡èŠ‚ç‚¹å¯ç³»ç»Ÿè°ƒç”¨ open/release/read/write/ioctlâ€¦ è®¿é—®æ“ä½œè¯¥é€»è¾‘è®¾å¤‡ã€‚</p><p>ä¾‹å¦‚ snd_ctl_dev_register()ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/core/control.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">snd_ctl_f_ops</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">.owner =THIS_MODULE,</span><br><span class="line">.read =snd_ctl_read,</span><br><span class="line">.open =snd_ctl_open,</span><br><span class="line">.release =snd_ctl_release,</span><br><span class="line">.llseek =no_llseek,</span><br><span class="line">.poll =snd_ctl_poll,</span><br><span class="line">.unlocked_ioctl =snd_ctl_ioctl,</span><br><span class="line">.compat_ioctl =snd_ctl_ioctl_compat,</span><br><span class="line">.fasync =snd_ctl_fasync,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * registration of the control device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_ctl_dev_register</span><span class="params">(struct snd_device *device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span> = <span class="title">device</span>-&gt;<span class="title">device_data</span>;</span></span><br><span class="line"><span class="keyword">int</span> err, cardnum;</span><br><span class="line"><span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (snd_BUG_ON(!card))</span><br><span class="line"><span class="keyword">return</span> -ENXIO;</span><br><span class="line">cardnum = card-&gt;number;</span><br><span class="line"><span class="keyword">if</span> (snd_BUG_ON(cardnum &lt; <span class="number">0</span> || cardnum &gt;= SNDRV_CARDS))</span><br><span class="line"><span class="keyword">return</span> -ENXIO;</span><br><span class="line"><span class="built_in">sprintf</span>(name, <span class="string">"controlC%i"</span>, cardnum);</span><br><span class="line"><span class="keyword">if</span> ((err = snd_register_device(SNDRV_DEVICE_TYPE_CONTROL, card, <span class="number">-1</span>,</span><br><span class="line">       &amp;snd_ctl_f_ops, card, name)) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº‹å®æ˜¯è°ƒç”¨ snd_register_device_for_dev ()ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/core/sound.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_register_device_for_dev</span><span class="params">(<span class="keyword">int</span> type, struct snd_card *card, <span class="keyword">int</span> dev,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> struct file_operations *f_ops,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">void</span> *private_data,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> <span class="keyword">char</span> *name, struct device *device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> minor;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_minor</span> *<span class="title">preg</span>;</span></span><br><span class="line">preg = kmalloc(<span class="keyword">sizeof</span> *preg, GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">preg-&gt;type = type;</span><br><span class="line">preg-&gt;card = card ? card-&gt;number : <span class="number">-1</span>;</span><br><span class="line">preg-&gt;device = dev;</span><br><span class="line">preg-&gt;f_ops = f_ops;</span><br><span class="line">preg-&gt;private_data = private_data;</span><br><span class="line">preg-&gt;card_ptr = card;</span><br><span class="line">mutex_lock(&amp;sound_mutex);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SND_DYNAMIC_MINORS</span></span><br><span class="line">minor = snd_find_free_minor(type);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">minor = snd_kernel_minor(type, card, dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">......</span><br><span class="line">snd_minors[minor] = preg;</span><br><span class="line">preg-&gt;dev = device_create(sound_class, device, MKDEV(major, minor),</span><br><span class="line">  private_data, <span class="string">"%s"</span>, name);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">mutex_unlock(&amp;sound_mutex);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†é…å¹¶åˆå§‹åŒ–ä¸€ä¸ª snd_minor å®ä¾‹ï¼›<br>ä¿å­˜è¯¥ snd_minor å®ä¾‹åˆ° snd_minors æ•°ç»„ä¸­ï¼›<br>è°ƒç”¨ device_create() ç”Ÿæˆè®¾å¤‡æ–‡ä»¶èŠ‚ç‚¹ã€‚</p><p>ä¸Šé¢è¿‡ç¨‹æ˜¯å£°å¡æ³¨å†Œæ—¶æ‰è¢«å›è°ƒçš„ã€‚</p><h5 id="6-4-å£°å¡çš„æ³¨å†Œ"><a href="#6-4-å£°å¡çš„æ³¨å†Œ" class="headerlink" title="6.4. å£°å¡çš„æ³¨å†Œ"></a>6.4. å£°å¡çš„æ³¨å†Œ</h5><p>å½“å£°å¡ä¸‹çš„æ‰€æœ‰é€»è¾‘è®¾å¤‡éƒ½å·²ç»å‡†å¤‡å°±ç»ªåï¼Œå°±å¯ä»¥è°ƒç”¨ snd_card_register() æ³¨å†Œå£°å¡äº†ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/26-Audio-system-snd-card-register.png.png" alt="Alt text"></p><p>â€¢ åˆ›å»ºå£°å¡çš„ sysfs è®¾å¤‡ï¼›<br>â€¢ è°ƒç”¨ snd_device_register_all() æ³¨å†Œæ‰€æœ‰æŒ‚åœ¨è¯¥å£°å¡ä¸‹çš„é€»è¾‘è®¾å¤‡ï¼›<br>â€¢ å»ºç«‹ proc ä¿¡æ¯æ–‡ä»¶å’Œ sysfs å±æ€§æ–‡ä»¶ã€‚</p><h4 id="ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ"><a href="#ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ"></a>ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ</h4><h5 id="7-1ã€DAPMç®€ä»‹"><a href="#7-1ã€DAPMç®€ä»‹" class="headerlink" title="7.1ã€DAPMç®€ä»‹"></a>7.1ã€DAPMç®€ä»‹</h5><p> DAPMæ˜¯Dynamic Audio Power Managementçš„ç¼©å†™ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯åŠ¨æ€éŸ³é¢‘ç”µæºç®¡ç†çš„æ„æ€ï¼ŒDAPMæ˜¯ä¸ºäº†ä½¿åŸºäºlinuxçš„ç§»åŠ¨è®¾å¤‡ä¸Šçš„éŸ³é¢‘å­ç³»ç»Ÿï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å·¥ä½œåœ¨æœ€å°åŠŸè€—çŠ¶æ€ä¸‹ã€‚DAPMå¯¹ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯é€æ˜çš„ï¼Œæ‰€æœ‰ä¸ç”µæºç›¸å…³çš„å¼€å…³éƒ½åœ¨ASoc coreä¸­å®Œæˆã€‚ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºæ— éœ€å¯¹ä»£ç åšå‡ºä¿®æ”¹ï¼Œä¹Ÿæ— éœ€é‡æ–°ç¼–è¯‘ï¼ŒDAPMæ ¹æ®å½“å‰æ¿€æ´»çš„éŸ³é¢‘æµï¼ˆplayback/captureï¼‰å’Œå£°å¡ä¸­çš„mixerç­‰çš„é…ç½®æ¥å†³å®šé‚£äº›éŸ³é¢‘æ§ä»¶çš„ç”µæºå¼€å…³è¢«æ‰“å¼€æˆ–å…³é—­ã€‚</p><p>DAPMæ˜¯åŸºäºkcontrolæ”¹è¿›è¿‡åçš„ç›¸åº”æ¡†æ¶ï¼Œå¢åŠ äº†ç›¸åº”çš„ç”µæºç®¡ç†æœºåˆ¶ï¼Œå…¶ç”µæºç®¡ç†æœºåˆ¶å…¶å®å°±æ˜¯æŒ‰ç…§ç›¸åº”çš„éŸ³é¢‘è·¯å¾„ï¼Œå®Œç¾çš„å¯¹å„ç§éƒ¨ä»¶çš„ç”µæºè¿›è¡Œæ§åˆ¶ï¼Œè€Œä¸”æŒ‰ç…§æŸç§é¡ºåºè¿›è¡Œã€‚</p><h5 id="7-1ã€kcontrol"><a href="#7-1ã€kcontrol" class="headerlink" title="7.1ã€kcontrol"></a>7.1ã€kcontrol</h5><p>é€šå¸¸ï¼Œä¸€ä¸ªkcontrolä»£è¡¨ç€ä¸€ä¸ªmixerï¼ˆæ··éŸ³å™¨ï¼‰ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªmuxï¼ˆå¤šè·¯å¼€å…³ï¼‰ï¼Œåˆæˆ–è€…æ˜¯ä¸€ä¸ªéŸ³é‡æ§åˆ¶å™¨ç­‰ç­‰ã€‚ ä»ä¸Šè¿°æ–‡ç« ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œå®šä¹‰ä¸€ä¸ªkcontrolä¸»è¦å°±æ˜¯å®šä¹‰ä¸€ä¸ªsnd_kcontrol_new ç»“æ„ï¼Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/control.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> &#123;</span></span><br><span class="line"><span class="keyword">snd_ctl_elem_iface_t</span> iface;<span class="comment">/* interface identifier */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> device;<span class="comment">/* device/client number */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> subdevice;<span class="comment">/* subdevice (substream) number */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *name;<span class="comment">/* ASCII name of item */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index;<span class="comment">/* index of item */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> access;<span class="comment">/* access rights */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count;<span class="comment">/* count of same elements */</span></span><br><span class="line"><span class="keyword">snd_kcontrol_info_t</span> *info;</span><br><span class="line"><span class="keyword">snd_kcontrol_get_t</span> *get;</span><br><span class="line"><span class="keyword">snd_kcontrol_put_t</span> *put;</span><br><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line"><span class="keyword">snd_kcontrol_tlv_rw_t</span> *c;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *p;</span><br><span class="line">&#125; tlv;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> private_value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ¯ä¸ªæ§ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå’Œä»–å¯¹åº”çš„snd_kcontrol_newç»“æ„ï¼Œè¿™äº›snd_kcontrol_newç»“æ„ä¼šåœ¨å£°å¡çš„åˆå§‹åŒ–é˜¶æ®µï¼Œé€šè¿‡snd_soc_dapm_new_controls()å‡½æ•°æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´å°±å¯ä»¥é€šè¿‡tinymixæŸ¥çœ‹å’Œè®¾å®šè¿™äº›æ§ä»¶çš„çŠ¶æ€ã€‚<br>ç¼–è¯‘/external/tinyalsa/å¾—åˆ°tinymix, tinyplay, tinycapï¼ŒPushåˆ°æ‰‹æœºæ‰§è¡Œtinymixå¯å¾—åˆ°å¦‚ä¸‹ç±»ä¼¼ä¿¡æ¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">990BOOL1QUAT_MI2S_RX Audio Mixer MultiMedia10    Off</span><br><span class="line">991BOOL1QUAT_MI2S_RX Audio Mixer MultiMedia11    Off</span><br><span class="line">992BOOL1QUAT_MI2S_RX Audio Mixer MultiMedia12    Off</span><br><span class="line">993BOOL1QUAT_MI2S_RX Audio Mixer MultiMedia13    Off</span><br><span class="line">994BOOL1QUAT_MI2S_RX Audio Mixer MultiMedia14    Off</span><br><span class="line">995BOOL1QUAT_MI2S_RX Audio Mixer MultiMedia15    Off</span><br><span class="line">996BOOL1QUAT_MI2S_RX Audio Mixer MultiMedia16    Off</span><br><span class="line">997BOOL1MI2S_RX Audio Mixer MultiMedia1          Off</span><br><span class="line">998BOOL1MI2S_RX Audio Mixer MultiMedia2          Off</span><br><span class="line">999BOOL1MI2S_RX Audio Mixer MultiMedia3          Off</span><br><span class="line">1000BOOL1MI2S_RX Audio Mixer MultiMedia4          Off</span><br><span class="line">1001BOOL1MI2S_RX Audio Mixer MultiMedia5          Off</span><br><span class="line">1002BOOL1MI2S_RX Audio Mixer MultiMedia6          Off</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>snd_kcontrol_newç»“æ„ä¸­ï¼Œå‡ ä¸ªä¸»è¦çš„å­—æ®µæ˜¯getï¼Œputï¼Œprivate_valueï¼Œgetå›è°ƒå‡½æ•°ç”¨äºè·å–è¯¥æ§ä»¶å½“å‰çš„çŠ¶æ€å€¼ï¼Œè€Œputå›è°ƒå‡½æ•°åˆ™ç”¨äºè®¾ç½®æ§ä»¶çš„çŠ¶æ€å€¼ï¼Œè€Œprivate_valueå­—æ®µåˆ™æ ¹æ®ä¸åŒçš„æ§ä»¶ç±»å‹æœ‰ä¸åŒçš„æ„ä¹‰ï¼Œæ¯”å¦‚å¯¹äºæ™®é€šçš„æ§ä»¶ï¼Œprivate_valueå­—æ®µå¯ä»¥ç”¨æ¥å®šä¹‰è¯¥æ§ä»¶æ‰€å¯¹åº”çš„å¯„å­˜å™¨çš„åœ°å€ä»¥åŠå¯¹åº”çš„æ§åˆ¶ä½åœ¨å¯„å­˜å™¨ä¸­çš„ä½ç½®ä¿¡æ¯ã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼ŒASocç³»ç»Ÿå·²ç»ä¸ºæˆ‘ä»¬å‡†å¤‡äº†å¤§é‡çš„å®å®šä¹‰ï¼Œç”¨äºå®šä¹‰å¸¸ç”¨çš„æ§ä»¶ï¼Œè¿™äº›å®å®šä¹‰ä½äºinclude/sound/soc.hä¸­ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«è®¨è®ºä¸€ä¸‹å¦‚ä½•ç”¨è¿™äº›é¢„è®¾çš„å®å®šä¹‰æ¥å®šä¹‰ä¸€äº›å¸¸ç”¨çš„æ§ä»¶ã€‚</p><h5 id="7-1-1ã€ç®€å•å‹çš„æ§ä»¶"><a href="#7-1-1ã€ç®€å•å‹çš„æ§ä»¶" class="headerlink" title="7.1.1ã€ç®€å•å‹çš„æ§ä»¶"></a>7.1.1ã€ç®€å•å‹çš„æ§ä»¶</h5><p>SOC_SINGLE    SOC_SINGLEåº”è¯¥ç®—æ˜¯æœ€ç®€å•çš„æ§ä»¶äº†ï¼Œè¿™ç§æ§ä»¶åªæœ‰ä¸€ä¸ªæ§åˆ¶é‡ï¼Œæ¯”å¦‚ä¸€ä¸ªå¼€å…³ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ•°å€¼å˜é‡ï¼ˆæ¯”å¦‚Codecä¸­æŸä¸ªé¢‘ç‡ï¼ŒFIFOå¤§å°ç­‰ç­‰ï¼‰ã€‚æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå®æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE(xname, reg, shift, max, invert) \</span></span><br><span class="line">&#123;.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span><br><span class="line">.info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span><br><span class="line">.put = snd_soc_put_volsw, \</span><br><span class="line">.private_value = SOC_SINGLE_VALUE(reg, shift, max, invert, <span class="number">0</span>) &#125;</span><br></pre></td></tr></table></figure></p><p>å®å®šä¹‰çš„å‚æ•°åˆ†åˆ«æ˜¯ï¼šxnameï¼ˆè¯¥æ§ä»¶çš„åå­—ï¼‰ï¼Œregï¼ˆè¯¥æ§ä»¶å¯¹åº”çš„å¯„å­˜å™¨çš„åœ°å€ï¼‰ï¼Œshiftï¼ˆæ§åˆ¶ä½åœ¨å¯„å­˜å™¨ä¸­çš„ä½ç§»ï¼‰ï¼Œmaxï¼ˆæ§ä»¶å¯è®¾ç½®çš„æœ€å¤§å€¼ï¼‰ï¼Œinvertï¼ˆè®¾å®šå€¼æ˜¯å¦é€»è¾‘å–åï¼‰ã€‚è¿™é‡Œåˆä½¿ç”¨äº†ä¸€ä¸ªå®æ¥å®šä¹‰private_valueå­—æ®µï¼šSOC_SINGLE_VALUEï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_DOUBLE_VALUE(xreg, shift_left, shift_right, xmax, xinvert, xautodisable) \</span></span><br><span class="line">((<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;(struct soc_mixer_control) \</span><br><span class="line">&#123;.reg = xreg, .rreg = xreg, .shift = shift_left, \</span><br><span class="line">.rshift = shift_right, .max = xmax, .platform_max = xmax, \</span><br><span class="line">.invert = xinvert, .autodisable = xautodisable&#125;)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE_VALUE(xreg, xshift, xmax, xinvert, xautodisable) \</span></span><br><span class="line">SOC_DOUBLE_VALUE(xreg, xshift, xshift, xmax, xinvert, xautodisable)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®é™…ä¸Šæ˜¯å®šä¹‰äº†ä¸€ä¸ªsoc_mixer_controlç»“æ„ï¼Œç„¶åæŠŠè¯¥ç»“æ„çš„åœ°å€èµ‹å€¼ç»™äº†private_valueå­—æ®µï¼Œsoc_mixer_controlç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="comment">/* mixer control */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">soc_mixer_control</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> min, max, platform_max;</span><br><span class="line"><span class="keyword">int</span> reg, rreg;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> shift, rshift;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> sign_bit;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> invert:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> autodisable:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹æ¥soc_mixer_controlæ˜¯æ§ä»¶ç‰¹å¾çš„çœŸæ­£æè¿°è€…ï¼Œå®ƒç¡®å®šäº†è¯¥æ§ä»¶å¯¹åº”å¯„å­˜å™¨çš„åœ°å€ï¼Œä½ç§»å€¼ï¼Œæœ€å¤§å€¼å’Œæ˜¯å¦é€»è¾‘å–åç­‰ç‰¹æ€§ï¼Œæ§ä»¶çš„putå›è°ƒå‡½æ•°å’Œgetå›è°ƒå‡½æ•°éœ€è¦å€ŸåŠ©è¯¥ç»“æ„æ¥è®¿é—®å®é™…çš„å¯„å­˜å™¨ã€‚<br><strong>SOC_SINGLE_TLV</strong>    <strong>SOC_SINGLE_TLV</strong>æ˜¯SOC_SINGLEçš„ä¸€ç§æ‰©å±•ï¼Œä¸»è¦ç”¨äºå®šä¹‰é‚£äº›æœ‰å¢ç›Šæ§åˆ¶çš„æ§ä»¶ï¼Œä¾‹å¦‚éŸ³é‡æ§åˆ¶å™¨ï¼ŒEQå‡è¡¡å™¨ç­‰ç­‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE_TLV(xname, reg, shift, max, invert, tlv_array) \</span></span><br><span class="line">&#123;.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span><br><span class="line">.access = SNDRV_CTL_ELEM_ACCESS_TLV_READ |\</span><br><span class="line"> SNDRV_CTL_ELEM_ACCESS_READWRITE,\</span><br><span class="line">.tlv.p = (tlv_array), \</span><br><span class="line">.info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span><br><span class="line">.put = snd_soc_put_volsw, \</span><br><span class="line">.private_value = SOC_SINGLE_VALUE(reg, shift, max, invert, <span class="number">0</span>) &#125;</span><br></pre></td></tr></table></figure><p>ä»ä»–çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œç”¨äºè®¾å®šå¯„å­˜å™¨ä¿¡æ¯çš„private_valueå­—æ®µçš„å®šä¹‰å’ŒSOC_SINGLEæ˜¯ä¸€æ ·çš„ï¼Œç”šè‡³putã€getå›è°ƒå‡½æ•°ä¹Ÿæ˜¯ä½¿ç”¨åŒä¸€å¥—ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¢åŠ äº†ä¸€ä¸ªtlv_arrayå‚æ•°ï¼Œå¹¶æŠŠå®ƒèµ‹å€¼ç»™äº†tlv.på­—æ®µã€‚ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡å¯¹å£°å¡çš„controlè®¾å¤‡å‘èµ·ä»¥ä¸‹ä¸¤ç§ioctlæ¥è®¿é—®tlvå­—æ®µæ‰€æŒ‡å‘çš„æ•°ç»„ï¼š<br>  â€¢  SNDRV_CTL_IOCTL_TLV_READ<br>  â€¢  SNDRV_CTL_IOCTL_TLV_WRITE<br>  â€¢  SNDRV_CTL_IOCTL_TLV_COMMAND</p><p>SOC_DOUBLE    ä¸SOC_SINGLEç›¸å¯¹åº”ï¼ŒåŒºåˆ«æ˜¯SOC_SINGLEåªæ§åˆ¶ä¸€ä¸ªå˜é‡ï¼Œè€ŒSOC_DOUBLEåˆ™å¯ä»¥åŒæ—¶åœ¨ä¸€ä¸ªå¯„å­˜å™¨ä¸­æ§åˆ¶ä¸¤ä¸ªç›¸ä¼¼çš„å˜é‡ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯ç”¨äºä¸€äº›ç«‹ä½“å£°çš„æ§ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åŒæ—¶å¯¹å·¦å³å£°é“è¿›è¡Œæ§åˆ¶ï¼Œå› ä¸ºå¤šäº†ä¸€ä¸ªå£°é“ï¼Œå‚æ•°ä¹Ÿå°±ç›¸åº”åœ°å¤šäº†ä¸€ä¸ªshiftä½ç§»å€¼</p><p>SOC_DOUBLE_R    ä¸SOC_DOUBLEç±»ä¼¼ï¼Œå¯¹äºå·¦å³å£°é“çš„æ§åˆ¶å¯„å­˜å™¨ä¸ä¸€æ ·çš„æƒ…å†µï¼Œä½¿ç”¨SOC_DOUBLE_Ræ¥å®šä¹‰ï¼Œå‚æ•°ä¸­éœ€è¦æŒ‡å®šä¸¤ä¸ªå¯„å­˜å™¨åœ°å€ã€‚<br>SOC_DOUBLE_TLV    ä¸SOC_SINGLE_TLVå¯¹åº”çš„ç«‹ä½“å£°ç‰ˆæœ¬ï¼Œé€šå¸¸ç”¨äºç«‹ä½“å£°éŸ³é‡æ§ä»¶çš„å®šä¹‰ã€‚</p><p>SOC_DOUBLE_R_TLV    å·¦å³å£°é“æœ‰ç‹¬ç«‹å¯„å­˜å™¨æ§åˆ¶çš„SOC_DOUBLE_TLVç‰ˆæœ¬</p><h5 id="7-1-2ã€Mixeræ§ä»¶"><a href="#7-1-2ã€Mixeræ§ä»¶" class="headerlink" title="7.1.2ã€Mixeræ§ä»¶"></a>7.1.2ã€Mixeræ§ä»¶</h5><p>Mixeræ§ä»¶ç”¨äºéŸ³é¢‘é€šé“çš„è·¯ç”±æ§åˆ¶ï¼Œç”±å¤šä¸ªè¾“å…¥å’Œä¸€ä¸ªè¾“å‡ºç»„æˆï¼Œå¤šä¸ªè¾“å…¥å¯ä»¥è‡ªç”±åœ°æ··åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆæ··åˆåçš„è¾“å‡ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/27-Audio-system-mixer-1525417497024.png" alt="Alt text"></p><p>å¯¹äºMixeræ§ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯å¤šä¸ªç®€å•æ§ä»¶çš„ç»„åˆï¼Œé€šå¸¸ï¼Œæˆ‘ä»¬ä¼šä¸ºmixerçš„æ¯ä¸ªè¾“å…¥ç«¯éƒ½å•ç‹¬å®šä¹‰ä¸€ä¸ªç®€å•æ§ä»¶æ¥æ§åˆ¶è¯¥è·¯è¾“å…¥çš„å¼€å¯å’Œå…³é—­ï¼Œååº”åœ¨ä»£ç ä¸Šï¼Œå°±æ˜¯å®šä¹‰ä¸€ä¸ªsoc_kcontrol_newæ•°ç»„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">aif4_vi_mixer</span>[] = &#123;</span></span><br><span class="line">SOC_SINGLE_EXT(<span class="string">"SPKR_VI_1"</span>, SND_SOC_NOPM, TASHA_TX14, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">tasha_vi_feed_mixer_get, tasha_vi_feed_mixer_put),</span><br><span class="line">SOC_SINGLE_EXT(<span class="string">"SPKR_VI_2"</span>, SND_SOC_NOPM, TASHA_TX15, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">tasha_vi_feed_mixer_get, tasha_vi_feed_mixer_put),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="7-1-3ã€Muxæ§ä»¶"><a href="#7-1-3ã€Muxæ§ä»¶" class="headerlink" title="7.1.3ã€Muxæ§ä»¶"></a>7.1.3ã€Muxæ§ä»¶</h5><p>muxæ§ä»¶ä¸mixeræ§ä»¶ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å¤šä¸ªè¾“å…¥ç«¯å’Œä¸€ä¸ªè¾“å‡ºç«¯çš„ç»„åˆæ§ä»¶ï¼Œä¸mixeræ§ä»¶ä¸åŒçš„æ˜¯ï¼Œmuxæ§ä»¶çš„å¤šä¸ªè¾“å…¥ç«¯åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªè¢«é€‰ä¸­ã€‚å› æ­¤ï¼Œmuxæ§ä»¶æ‰€å¯¹åº”çš„å¯„å­˜å™¨ï¼Œé€šå¸¸å¯ä»¥è®¾å®šä¸€æ®µè¿ç»­çš„æ•°å€¼ï¼Œæ¯ä¸ªä¸åŒçš„æ•°å€¼å¯¹åº”ä¸åŒçš„è¾“å…¥ç«¯è¢«æ‰“å¼€ï¼Œä¸ä¸Šè¿°çš„mixeræ§ä»¶ä¸åŒï¼ŒASocç”¨soc_enumç»“æ„æ¥æè¿°muxæ§ä»¶çš„å¯„å­˜å™¨ä¿¡æ¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="comment">/* enumerated kcontrol */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">soc_enum</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> reg;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shift_l;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shift_r;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> items;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> mask;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> *texts;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *values;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªå¯„å­˜å™¨åœ°å€å’Œä½ç§»å­—æ®µï¼šregï¼Œreg2ï¼Œshift_lï¼Œshift_rï¼Œç”¨äºæè¿°å·¦å³å£°é“çš„æ§åˆ¶å¯„å­˜å™¨ä¿¡æ¯ã€‚å­—ç¬¦ä¸²æ•°ç»„æŒ‡é’ˆç”¨äºæè¿°æ¯ä¸ªè¾“å…¥ç«¯å¯¹åº”çš„åå­—ï¼Œvalueå­—æ®µåˆ™æŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥æ•°ç»„å®šä¹‰äº†å¯„å­˜å™¨å¯ä»¥é€‰æ‹©çš„å€¼ï¼Œæ¯ä¸ªå€¼å¯¹åº”ä¸€ä¸ªè¾“å…¥ç«¯ï¼Œå¦‚æœvalueæ˜¯ä¸€ç»„è¿ç»­çš„å€¼ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥å¿½ç•¥valueså‚æ•°ã€‚</p><h5 id="7-2ã€widgetã€pathã€route"><a href="#7-2ã€widgetã€pathã€route" class="headerlink" title="7.2ã€widgetã€pathã€route"></a>7.2ã€widgetã€pathã€route</h5><p>å‰é¢ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†éŸ³é¢‘é©±åŠ¨ä¸­å¯¹åŸºæœ¬æ§åˆ¶å•å…ƒçš„å°è£…ï¼škcontrolã€‚åˆ©ç”¨kcontrolï¼Œæˆ‘ä»¬å¯ä»¥å®Œæˆå¯¹éŸ³é¢‘ç³»ç»Ÿä¸­çš„mixerï¼Œmuxï¼ŒéŸ³é‡æ§åˆ¶ï¼ŒéŸ³æ•ˆæ§åˆ¶ï¼Œä»¥åŠå„ç§å¼€å…³é‡çš„æ§åˆ¶ï¼Œé€šè¿‡å¯¹å„ç§kcontrolçš„æ§åˆ¶ï¼Œä½¿å¾—éŸ³é¢‘ç¡¬ä»¶èƒ½å¤ŸæŒ‰ç…§æˆ‘ä»¬é¢„æƒ³çš„ç»“æœè¿›è¡Œå·¥ä½œã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œkcontrolè¿˜æ˜¯æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸è¶³ï¼š<br>åªèƒ½æè¿°è‡ªèº«ï¼Œæ— æ³•æè¿°å„ä¸ªkcontrolä¹‹é—´çš„è¿æ¥å…³ç³»ï¼›<br>æ²¡æœ‰ç›¸åº”çš„ç”µæºç®¡ç†æœºåˆ¶ï¼›<br>æ²¡æœ‰ç›¸åº”çš„æ—¶é—´å¤„ç†æœºåˆ¶æ¥å“åº”æ’­æ”¾ã€åœæ­¢ã€ä¸Šç”µã€ä¸‹ç”µç­‰éŸ³é¢‘äº‹ä»¶ï¼›<br>ä¸ºäº†é˜²æ­¢pop-popå£°ï¼Œéœ€è¦ç”¨æˆ·ç¨‹åºå…³æ³¨å„ä¸ªkcontrolä¸Šç”µå’Œä¸‹ç”µçš„é¡ºåºï¼›<br>å½“ä¸€ä¸ªéŸ³é¢‘è·¯å¾„ä¸å†æœ‰æ•ˆæ—¶ï¼Œä¸èƒ½è‡ªåŠ¨å…³é—­è¯¥è·¯å¾„ä¸Šçš„æ‰€æœ‰çš„kcontrolï¼›<br>ä¸ºæ­¤ï¼ŒDAPMæ¡†æ¶æ­£æ˜¯ä¸ºäº†è¦è§£å†³ä»¥ä¸Šè¿™äº›é—®é¢˜è€Œè¯ç”Ÿçš„ï¼ŒDAPMç›®å‰å·²ç»æ˜¯ASocä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè®©æˆ‘ä»¬å…ˆä»DAPMçš„æ•°æ®ç»“æ„å¼€å§‹ï¼Œäº†è§£å®ƒçš„è®¾è®¡æ€æƒ³å’Œå·¥ä½œåŸç†ã€‚</p><h5 id="7-2-1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget"><a href="#7-2-1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget" class="headerlink" title="7.2.1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget"></a>7.2.1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget</h5><p>æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬è¯´æ˜äº†ä¸€ä¸‹ç›®å‰kcontrolçš„ä¸€äº›ä¸è¶³ï¼Œè€ŒDAPMæ¡†æ¶ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼•å…¥äº†widgetè¿™ä¸€æ¦‚å¿µï¼Œæ‰€è°“widgetï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºæ˜¯kcontrolçš„è¿›ä¸€æ­¥å‡çº§å’Œå°è£…ï¼Œå¥¹åŒæ ·æ˜¯æŒ‡éŸ³é¢‘ç³»ç»Ÿä¸­çš„æŸä¸ªéƒ¨ä»¶ï¼Œæ¯”å¦‚mixerï¼Œmuxï¼Œè¾“å…¥è¾“å‡ºå¼•è„šï¼Œç”µæºä¾›åº”å™¨ç­‰ç­‰ï¼Œç”šè‡³ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰è™šæ‹Ÿçš„widgetï¼Œä¾‹å¦‚playback stream widgetã€‚widgetæŠŠkcontrolå’ŒåŠ¨æ€ç”µæºç®¡ç†è¿›è¡Œäº†æœ‰æœºçš„ç»“åˆï¼ŒåŒæ—¶è¿˜å…·å¤‡éŸ³é¢‘è·¯å¾„çš„è¿ç»“åŠŸèƒ½ï¼Œä¸€ä¸ªwidgetå¯ä»¥ä¸å®ƒç›¸é‚»çš„widgetæœ‰æŸç§åŠ¨æ€çš„è¿ç»“å…³ç³»ã€‚åœ¨DAPMæ¡†æ¶ä¸­ï¼Œwidgetç”¨ç»“æ„ä½“snd_soc_dapm_widgetæ¥æè¿°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc-dapm.h]</span><br><span class="line"><span class="comment">/* dapm widget */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> &#123;</span></span><br><span class="line"><span class="keyword">enum</span> snd_soc_dapm_type id;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;<span class="comment">/* widget name */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *sname;<span class="comment">/* stream name */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec</span> *<span class="title">codec</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *priv;<span class="comment">/* widget specific data */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">regulator</span> *<span class="title">regulator</span>;</span><span class="comment">/* attached regulator */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> *<span class="title">params</span>;</span> <span class="comment">/* params for dai links */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* dapm control */</span></span><br><span class="line"><span class="keyword">int</span> reg;<span class="comment">/* negative reg = no direct dapm */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shift;<span class="comment">/* bits to shift */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> mask;<span class="comment">/* non-shifted mask */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> on_val;<span class="comment">/* on state value */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> off_val;<span class="comment">/* off state value */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> power:<span class="number">1</span>;<span class="comment">/* block power status */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> active:<span class="number">1</span>;<span class="comment">/* active stream on DAC, ADC's */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> connected:<span class="number">1</span>;<span class="comment">/* connected codec pin */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">new</span>:<span class="number">1</span>;<span class="comment">/* cnew complete */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> ext:<span class="number">1</span>;<span class="comment">/* has external widgets */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> force:<span class="number">1</span>;<span class="comment">/* force state */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> ignore_suspend:<span class="number">1</span>;         <span class="comment">/* kept enabled over suspend */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> new_power:<span class="number">1</span>;<span class="comment">/* power from this run */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> power_checked:<span class="number">1</span>;<span class="comment">/* power checked this run */</span></span><br><span class="line"><span class="keyword">int</span> subseq;<span class="comment">/* sort within widget type */</span></span><br><span class="line">......</span><br><span class="line"><span class="comment">/* widget input and outputs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">sources</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">sinks</span>;</span></span><br><span class="line">......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>snd_soc_dapm_widgetç»“æ„æ¯”è¾ƒå¤§ï¼Œä¸ºäº†ç®€æ´ä¸€äº›ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰åˆ—å‡ºè¯¥ç»“æ„ä½“çš„å®Œæ•´å­—æ®µï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¸‹é¢æˆ‘ä¼šè¯´æ˜æ¯ä¸ªå­—æ®µçš„æ„ä¹‰ï¼š<br>id    è¯¥widgetçš„ç±»å‹å€¼ï¼Œæ¯”å¦‚snd_soc_dapm_outputï¼Œsnd_soc_dapm_mixerç­‰ç­‰ã€‚</p><p>*name    è¯¥widgetçš„åå­—</p><p>*sname    ä»£è¡¨è¯¥widgetæ‰€åœ¨streamçš„åå­—ï¼Œæ¯”å¦‚å¯¹äºsnd_soc_dapm_dai_inç±»å‹çš„widgetï¼Œä¼šä½¿ç”¨è¯¥å­—æ®µã€‚</p><p><em>codec </em>platform    æŒ‡å‘è¯¥widgetæ‰€å±çš„codecå’Œplatformã€‚</p><p>list    æ‰€æœ‰æ³¨å†Œåˆ°ç³»ç»Ÿä¸­çš„widgetéƒ½ä¼šé€šè¿‡è¯¥listï¼Œé“¾æ¥åˆ°ä»£è¡¨å£°å¡çš„snd_soc_cardç»“æ„çš„widgetsé“¾è¡¨å¤´å­—æ®µä¸­ã€‚</p><p>*dapm    snd_soc_dapm_contextç»“æ„æŒ‡é’ˆï¼ŒASocæŠŠç³»ç»Ÿåˆ’åˆ†ä¸ºå¤šä¸ªdapmåŸŸï¼Œæ¯ä¸ªwidgetå±äºæŸä¸ªdapmåŸŸï¼ŒåŒä¸€ä¸ªåŸŸä»£è¡¨ç€åŒæ ·çš„åç½®ç”µå‹ä¾›ç”µç­–ç•¥ï¼Œæ¯”å¦‚ï¼ŒåŒä¸€ä¸ªcodecä¸­çš„widgeté€šå¸¸ä½äºåŒä¸€ä¸ªdapmåŸŸï¼Œè€Œå¹³å°ä¸Šçš„widgetå¯èƒ½åˆä¼šä½äºå¦å¤–ä¸€ä¸ªplatformåŸŸä¸­ã€‚</p><p>*priv    æœ‰äº›widgetå¯èƒ½éœ€è¦ä¸€äº›ä¸“æœ‰çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å­—æ®µæ¥ä¿å­˜ï¼Œåƒsnd_soc_dapm_dai_inç±»å‹çš„widgetï¼Œä¼šä½¿ç”¨è¯¥å­—æ®µæ¥è®°ä½ä¸ä¹‹ç›¸å…³è”çš„snd_soc_daiç»“æ„æŒ‡é’ˆã€‚</p><p>*regulator    å¯¹äºsnd_soc_dapm_regulator_supplyç±»å‹çš„widgetï¼Œè¯¥å­—æ®µæŒ‡å‘ä¸ä¹‹ç›¸å…³çš„regulatorç»“æ„æŒ‡é’ˆã€‚</p><p>*params    ç›®å‰å¯¹äºsnd_soc_dapm_dai_linkç±»å‹çš„widgetï¼ŒæŒ‡å‘è¯¥daiçš„é…ç½®ä¿¡æ¯çš„snd_soc_pcm_streamç»“æ„ã€‚</p><p>reg shift mask     è¿™3ä¸ªå­—æ®µç”¨æ¥æ§åˆ¶è¯¥widgetçš„ç”µæºçŠ¶æ€ï¼Œåˆ†åˆ«å¯¹åº”æ§åˆ¶ä¿¡æ¯æ‰€åœ¨çš„å¯„å­˜å™¨åœ°å€ï¼Œä½ç§»å€¼å’Œå±è”½å€¼ã€‚</p><p>value  on_val  off_val    ç”µæºçŠ¶æ€çš„å½“å‰åªï¼Œå¼€å¯æ—¶å’Œå…³é—­æ—¶æ‰€å¯¹åº”çš„å€¼ã€‚</p><p>power invert    ç”¨äºæŒ‡ç¤ºè¯¥widgetå½“å‰æ˜¯å¦å¤„äºä¸Šç”µçŠ¶æ€ï¼Œinvertåˆ™ç”¨äºè¡¨æ˜powerå­—æ®µæ˜¯å¦éœ€è¦é€»è¾‘åè½¬ã€‚</p><p>active connected    åˆ†åˆ«è¡¨ç¤ºè¯¥widgetæ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€å’Œè¿æ¥çŠ¶æ€ï¼Œå½“å’Œç›¸é‚»çš„widgetæœ‰è¿æ¥å…³ç³»æ—¶ï¼Œconnectedä½ä¼šè¢«ç½®1ï¼Œå¦åˆ™ç½®0ã€‚</p><p>new   æˆ‘ä»¬å®šä¹‰å¥½çš„widgetï¼ˆsnd_soc_dapm_widgetç»“æ„ï¼‰ï¼Œåœ¨æ³¨å†Œåˆ°å£°å¡ä¸­æ—¶éœ€è¦è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¯¥å­—æ®µç”¨æ¥è¡¨ç¤ºè¯¥widgetæ˜¯å¦å·²ç»è¢«å®ä¾‹åŒ–ã€‚</p><p>ext    è¡¨ç¤ºè¯¥widgetå½“å‰æ˜¯å¦æœ‰å¤–éƒ¨è¿æ¥ï¼Œæ¯”å¦‚è¿æ¥micï¼Œè€³æœºï¼Œå–‡å­ç­‰ç­‰ã€‚</p><p>force    è¯¥ä½è¢«è®¾ç½®åï¼Œå°†ä¼šä¸ç®¡widgetå½“å‰çš„çŠ¶æ€ï¼Œå¼ºåˆ¶æ›´æ–°è‡³æ–°çš„ç”µæºçŠ¶æ€ã€‚</p><p>ignore_suspend new_power power_checked    è¿™äº›ç”µæºç®¡ç†ç›¸å…³çš„å­—æ®µã€‚</p><p>subseq    è¯¥widgetç›®å‰åœ¨ä¸Šç”µæˆ–ä¸‹ç”µé˜Ÿåˆ—ä¸­çš„æ’åºç¼–å·ï¼Œä¸ºäº†é˜²æ­¢åœ¨ä¸Šä¸‹ç”µçš„è¿‡ç¨‹ä¸­å‡ºç°pop-popå£°ï¼ŒDAPMä¼šç»™æ¯ä¸ªwidgetåˆ†é…åˆç†çš„ä¸Šä¸‹ç”µé¡ºåºã€‚</p><p>*power_check    ç”¨äºæ£€æŸ¥è¯¥widgetæ˜¯å¦åº”è¯¥ä¸Šç”µæˆ–ä¸‹ç”µçš„å›è°ƒå‡½æ•°æŒ‡é’ˆã€‚<br>event_flags    è¯¥å­—æ®µæ˜¯ä¸€ä¸ªä½æˆ–å­—æ®µï¼Œæ¯ä¸ªä½ä»£è¡¨è¯¥widgetä¼šå…³æ³¨æŸä¸ªDAPMäº‹ä»¶é€šçŸ¥ã€‚åªæœ‰è¢«å…³æ³¨çš„é€šçŸ¥äº‹ä»¶ä¼šè¢«å‘é€åˆ°widgetçš„äº‹ä»¶å¤„ç†å›è°ƒå‡½æ•°ä¸­ã€‚</p><p>*event    DAPMäº‹ä»¶å¤„ç†å›è°ƒå‡½æ•°æŒ‡é’ˆã€‚</p><p>num_kcontrols <em>kcontrol_news *</em>kcontrols    è¿™3ä¸ªå­—æ®µç”¨æ¥æè¿°ä¸è¯¥widgetæ‰€åŒ…å«çš„kcontrolæ§ä»¶ï¼Œä¾‹å¦‚ä¸€ä¸ªmixeræ§ä»¶æˆ–è€…æ˜¯ä¸€ä¸ªmuxæ§ä»¶ã€‚</p><p>sources sinks    ä¸¤ä¸ªé“¾è¡¨å­—æ®µï¼Œä¸¤ä¸ªwidgetå¦‚æœæœ‰è¿æ¥å…³ç³»ï¼Œä¼šé€šè¿‡ä¸€ä¸ªsnd_soc_dapm_pathç»“æ„è¿›è¡Œè¿æ¥ï¼Œsourcesé“¾è¡¨ç”¨äºé“¾æ¥æ‰€æœ‰çš„è¾“å…¥pathï¼Œsinksé“¾è¡¨ç”¨äºé“¾æ¥æ‰€æœ‰çš„è¾“å‡ºpathã€‚</p><p>power_list    æ¯æ¬¡æ›´æ–°æ•´ä¸ªdapmçš„ç”µæºçŠ¶æ€æ—¶ï¼Œä¼šæ ¹æ®ä¸€å®šçš„ç®—æ³•æ‰«ææ‰€æœ‰çš„widgetï¼Œç„¶åæŠŠéœ€è¦å˜æ›´ç”µæºçŠ¶æ€çš„widgetåˆ©ç”¨è¯¥å­—æ®µé“¾æ¥åˆ°ä¸€ä¸ªä¸Šç”µæˆ–ä¸‹ç”µçš„é“¾è¡¨ä¸­ï¼Œæ‰«æå®Œæ¯•åï¼Œdapmç³»ç»Ÿä¼šéå†è¿™ä¸¤ä¸ªé“¾è¡¨æ‰§è¡Œç›¸åº”çš„ä¸Šç”µæˆ–ä¸‹ç”µæ“ä½œã€‚</p><p>dirty    é“¾è¡¨å­—æ®µï¼Œwidgetçš„çŠ¶æ€å˜æ›´åï¼Œdapmç³»ç»Ÿä¼šåˆ©ç”¨è¯¥å­—æ®µï¼ŒæŠŠè¯¥widgetåŠ å…¥åˆ°ä¸€ä¸ªdirtyé“¾è¡¨ä¸­ï¼Œç¨åä¼šå¯¹dirtyé“¾è¡¨è¿›è¡Œæ‰«æï¼Œä»¥æ‰§è¡Œæ•´ä¸ªè·¯å¾„çš„æ›´æ–°ã€‚</p><p>inputs    è¯¥widgetçš„æ‰€æœ‰æœ‰æ•ˆè·¯å¾„ä¸­ï¼Œè¿æ¥åˆ°è¾“å…¥ç«¯çš„è·¯å¾„æ•°é‡ã€‚</p><p>outputs    è¯¥widgetçš„æ‰€æœ‰æœ‰æ•ˆè·¯å¾„ä¸­ï¼Œè¿æ¥åˆ°è¾“å‡ºç«¯çš„è·¯å¾„æ•°é‡ã€‚</p><p>*clk    å¯¹äºsnd_soc_dapm_clock_supplyç±»å‹çš„widgetï¼ŒæŒ‡å‘ç›¸å…³è”çš„clkç»“æ„æŒ‡é’ˆã€‚</p><p>ä»¥ä¸Šæˆ‘ä»¬å¯¹snd_soc_dapm_widgetç»“æ„çš„å„ä¸ªå­—æ®µæ‰€ä»£è¡¨çš„æ„ä¹‰ä¸€ä¸€åšå‡ºäº†è¯´æ˜ï¼Œè¿™é‡Œåªæ˜¯è®©å¤§å®¶ç°æœ‰ä¸ªæ¦‚å¿µ</p><h5 id="7-2-2ã€widgetçš„ç§ç±»"><a href="#7-2-2ã€widgetçš„ç§ç±»" class="headerlink" title="7.2.2ã€widgetçš„ç§ç±»"></a>7.2.2ã€widgetçš„ç§ç±»</h5><p>åœ¨DAPMæ¡†æ¶ä¸­ï¼ŒæŠŠå„ç§ä¸åŒçš„widgetåˆ’åˆ†ä¸ºä¸åŒçš„ç§ç±»ï¼Œsnd_soc_dapm_widgetç»“æ„ä¸­çš„idå­—æ®µç”¨æ¥è¡¨ç¤ºè¯¥widgetçš„ç§ç±»ï¼Œå¯é€‰çš„ç§ç±»éƒ½å®šä¹‰åœ¨ä¸€ä¸ªæšä¸¾ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc-dapm.h]</span><br><span class="line"><span class="comment">/* dapm widget types */</span></span><br><span class="line"><span class="keyword">enum</span> snd_soc_dapm_type &#123;</span><br><span class="line">snd_soc_dapm_input = <span class="number">0</span>,<span class="comment">/* input pin */</span></span><br><span class="line">snd_soc_dapm_output,<span class="comment">/* output pin */</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬é€ä¸ªè§£é‡Šä¸€ä¸‹è¿™äº›widgetçš„ç§ç±»ï¼š<br>snd_soc_dapm_input     è¯¥widgetå¯¹åº”ä¸€ä¸ªè¾“å…¥å¼•è„šã€‚<br>snd_soc_dapm_output    è¯¥widgetå¯¹åº”ä¸€ä¸ªè¾“å‡ºå¼•è„šã€‚<br>snd_soc_dapm_mux    è¯¥widgetå¯¹åº”ä¸€ä¸ªmuxæ§ä»¶ã€‚<br>snd_soc_dapm_virt_mux    è¯¥widgetå¯¹åº”ä¸€ä¸ªè™šæ‹Ÿçš„muxæ§ä»¶ã€‚<br>snd_soc_dapm_value_mux    è¯¥widgetå¯¹åº”ä¸€ä¸ªvalueç±»å‹çš„muxæ§ä»¶ã€‚<br>snd_soc_dapm_mixer    è¯¥widgetå¯¹åº”ä¸€ä¸ªmixeræ§ä»¶ã€‚<br>snd_soc_dapm_mixer_named_ctl    è¯¥widgetå¯¹åº”ä¸€ä¸ªmixeræ§ä»¶ï¼Œä½†æ˜¯å¯¹åº”çš„kcontrolçš„åå­—ä¸ä¼šåŠ å…¥widgetçš„åå­—ä½œä¸ºå‰ç¼€ã€‚<br>snd_soc_dapm_pga    è¯¥widgetå¯¹åº”ä¸€ä¸ªpgaæ§ä»¶ï¼ˆå¯ç¼–ç¨‹å¢ç›Šæ§ä»¶ï¼‰ã€‚<br>snd_soc_dapm_out_drv    è¯¥widgetå¯¹åº”ä¸€ä¸ªè¾“å‡ºé©±åŠ¨æ§ä»¶<br>snd_soc_dapm_adc    è¯¥widgetå¯¹åº”ä¸€ä¸ªADC<br>snd_soc_dapm_dac    è¯¥widgetå¯¹åº”ä¸€ä¸ªDAC<br>snd_soc_dapm_micbias    è¯¥widgetå¯¹åº”ä¸€ä¸ªéº¦å…‹é£åç½®ç”µå‹æ§ä»¶<br>snd_soc_dapm_mic    è¯¥widgetå¯¹åº”ä¸€ä¸ªéº¦å…‹é£ã€‚<br>snd_soc_dapm_hp    è¯¥widgetå¯¹åº”ä¸€ä¸ªè€³æœºã€‚<br>snd_soc_dapm_spk    è¯¥widgetå¯¹åº”ä¸€ä¸ªæ‰¬å£°å™¨ã€‚<br>snd_soc_dapm_line     è¯¥widgetå¯¹åº”ä¸€ä¸ªçº¿è·¯è¾“å…¥ã€‚<br>snd_soc_dapm_switch       è¯¥widgetå¯¹åº”ä¸€ä¸ªæ¨¡æ‹Ÿå¼€å…³ã€‚<br>snd_soc_dapm_vmid      è¯¥widgetå¯¹åº”ä¸€ä¸ªcodecçš„vmidåç½®ç”µå‹ã€‚<br>snd_soc_dapm_pre      machineçº§åˆ«çš„ä¸“ç”¨widgetï¼Œä¼šå…ˆäºå…¶å®ƒwidgetæ‰§è¡Œæ£€æŸ¥æ“ä½œã€‚<br>snd_soc_dapm_post    machineçº§åˆ«çš„ä¸“ç”¨widgetï¼Œä¼šåäºå…¶å®ƒwidgetæ‰§è¡Œæ£€æŸ¥æ“ä½œã€‚<br>snd_soc_dapm_supply           å¯¹åº”ä¸€ä¸ªç”µæºæˆ–æ˜¯æ—¶é’Ÿæºã€‚<br>snd_soc_dapm_regulator_supply  å¯¹åº”ä¸€ä¸ªå¤–éƒ¨regulatorç¨³å‹å™¨ã€‚<br>snd_soc_dapm_clock_supply      å¯¹åº”ä¸€ä¸ªå¤–éƒ¨æ—¶é’Ÿæºã€‚<br>snd_soc_dapm_aif_in            å¯¹åº”ä¸€ä¸ªæ•°å­—éŸ³é¢‘è¾“å…¥æ¥å£ï¼Œæ¯”å¦‚I2Sæ¥å£çš„è¾“å…¥ç«¯ã€‚<br>snd_soc_dapm_aif_out          å¯¹åº”ä¸€ä¸ªæ•°å­—éŸ³é¢‘è¾“å‡ºæ¥å£ï¼Œæ¯”å¦‚I2Sæ¥å£çš„è¾“å‡ºç«¯ã€‚<br>snd_soc_dapm_siggen            å¯¹åº”ä¸€ä¸ªä¿¡å·å‘ç”Ÿå™¨ã€‚<br>snd_soc_dapm_dai_in           å¯¹åº”ä¸€ä¸ªplatformæˆ–codecåŸŸçš„è¾“å…¥DAIç»“æ„ã€‚<br>snd_soc_dapm_dai_out        å¯¹åº”ä¸€ä¸ªplatformæˆ–codecåŸŸçš„è¾“å‡ºDAIç»“æ„ã€‚<br>snd_soc_dapm_dai_link         ç”¨äºé“¾æ¥ä¸€å¯¹è¾“å…¥/è¾“å‡ºDAIç»“æ„ã€‚</p><h5 id="7-2-3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath"><a href="#7-2-3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath" class="headerlink" title="7.2.3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath"></a>7.2.3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath</h5><p>ä¹‹å‰å·²ç»æåˆ°ï¼Œä¸€ä¸ªwidgetæ˜¯æœ‰è¾“å…¥å’Œè¾“å‡ºçš„ï¼Œè€Œä¸”widgetä¹‹é—´æ˜¯å¯ä»¥åŠ¨æ€åœ°è¿›è¡Œè¿æ¥çš„ï¼Œé‚£å®ƒä»¬æ˜¯ç”¨ä»€ä¹ˆæ¥è¿æ¥ä¸¤ä¸ªwidgetçš„å‘¢ï¼ŸDAPMä¸ºæˆ‘ä»¬æå‡ºäº†pathè¿™ä¸€æ¦‚å¿µï¼Œpathç›¸å½“äºç”µè·¯ä¸­çš„ä¸€æ ¹è·³çº¿ï¼Œå®ƒæŠŠä¸€ä¸ªwidgetçš„è¾“å‡ºç«¯å’Œå¦ä¸€ä¸ªwidgetçš„è¾“å…¥ç«¯è¿æ¥åœ¨ä¸€èµ·ï¼Œpathç”¨snd_soc_dapm_pathç»“æ„æ¥æè¿°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc-dapm.h]</span><br><span class="line"><span class="comment">/* dapm audio path between two widgets */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* source (input) and sink (output) widgets */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">source</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">sink</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* status */</span></span><br><span class="line">u32 connect:<span class="number">1</span>;<span class="comment">/* source and sink widgets are connected */</span></span><br><span class="line">u32 walked:<span class="number">1</span>;<span class="comment">/* path has been walked */</span></span><br><span class="line">u32 walking:<span class="number">1</span>;  <span class="comment">/* path is in the process of being walked */</span></span><br><span class="line">u32 weak:<span class="number">1</span>;<span class="comment">/* path ignored for power management */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> (*connected)(struct snd_soc_dapm_widget *source,</span><br><span class="line"> struct snd_soc_dapm_widget *sink);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_source</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_sink</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_kcontrol</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“widgetä¹‹é—´å‘ç”Ÿè¿æ¥å…³ç³»æ—¶ï¼Œsnd_soc_dapm_pathä½œä¸ºè¿æ¥è€…ï¼Œå®ƒçš„sourceå­—æ®µä¼šæŒ‡å‘è¯¥è¿æ¥çš„èµ·å§‹ç«¯widgetï¼Œè€Œå®ƒçš„sinkå­—æ®µä¼šæŒ‡å‘è¯¥è¿æ¥çš„åˆ°è¾¾ç«¯widgetï¼Œè¿˜è®°å¾—å‰é¢snd_soc_dapm_widgetç»“æ„ä¸­çš„ä¸¤ä¸ªé“¾è¡¨å¤´å­—æ®µï¼šsourceså’Œsinksä¹ˆï¼Ÿwidgetçš„è¾“å…¥ç«¯å’Œè¾“å‡ºç«¯å¯èƒ½è¿æ¥ç€å¤šä¸ªpathï¼Œæ‰€æœ‰è¾“å…¥ç«¯çš„snd_soc_dapm_pathç»“æ„é€šè¿‡list_sinkå­—æ®µæŒ‚åœ¨widgetçš„soucesé“¾è¡¨ä¸­ï¼ŒåŒæ ·ï¼Œæ‰€æœ‰è¾“å‡ºç«¯çš„snd_soc_dapm_pathç»“æ„é€šè¿‡list_sourceå­—æ®µæŒ‚åœ¨widgetçš„sinksé“¾è¡¨ä¸­ã€‚è¿™é‡Œå¯èƒ½å¤§å®¶ä¼šè¢«æå¾—æ™•å‘¼å‘¼çš„ï¼Œä¸€ä¼šsourceï¼Œä¸€ä¼šsinkï¼Œä¸è¦ç´§ï¼Œåªè¦è®°ä½ï¼Œè¿æ¥çš„è·¯å¾„æ˜¯è¿™æ ·çš„ï¼šèµ·å§‹ç«¯widgetçš„è¾“å‡ºâ€“&gt;pathçš„è¾“å…¥â€“&gt;pathçš„è¾“å‡ºâ€“&gt;åˆ°è¾¾ç«¯widgetè¾“å…¥ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/28-Audio-system-snd_soc_dapm_path.png" alt="Alt text"><br>å¦å¤–ï¼Œsnd_soc_dapm_pathç»“æ„çš„listå­—æ®µç”¨äºæŠŠæ‰€æœ‰çš„pathæ³¨å†Œåˆ°å£°å¡ä¸­ï¼Œå…¶å®å°±æ˜¯æŒ‚åœ¨snd_soc_cardç»“æ„çš„pathsé“¾è¡¨å¤´å­—æ®µä¸­ã€‚å¦‚æœä½ è¦è‡ªå·±å®šä¹‰æ–¹æ³•æ¥æ£€æŸ¥pathçš„å½“å‰è¿æ¥çŠ¶æ€ï¼Œä½ å¯ä»¥æä¾›è‡ªå·±çš„connectedå›è°ƒå‡½æ•°æŒ‡é’ˆã€‚</p><p>connectï¼Œwalkedï¼Œwalkingï¼Œweakæ˜¯å‡ ä¸ªè¾…åŠ©å­—æ®µï¼Œç”¨äºå¸®åŠ©æ‰€æœ‰pathçš„éå†ã€‚</p><h5 id="7-2-4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute"><a href="#7-2-4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute" class="headerlink" title="7.2.4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute"></a>7.2.4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute</h5><p>é€šè¿‡ä¸Šä¸€èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªè·¯å¾„çš„è¿æ¥è‡³å°‘åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼šèµ·å§‹ç«¯widgetï¼Œè·³çº¿pathï¼Œåˆ°è¾¾ç«¯widgetï¼Œåœ¨DAPMä¸­ï¼Œç”¨snd_soc_dapm_routeç»“æ„æ¥æè¿°è¿™æ ·ä¸€ä¸ªè¿æ¥å…³ç³»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc-dapm.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *sink;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *control;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *source;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Note: currently only supported for links where source is a supply */</span></span><br><span class="line"><span class="keyword">int</span> (*connected)(struct snd_soc_dapm_widget *source,</span><br><span class="line"> struct snd_soc_dapm_widget *sink);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>sinkæŒ‡å‘åˆ°è¾¾ç«¯widgetçš„åå­—å­—ç¬¦ä¸²ï¼ŒsourceæŒ‡å‘èµ·å§‹ç«¯widgetçš„åå­—å­—ç¬¦ä¸²ï¼ŒcontrolæŒ‡å‘è´Ÿè´£æ§åˆ¶è¯¥è¿æ¥æ‰€å¯¹åº”çš„kcontrolåå­—å­—ç¬¦ä¸²ï¼Œconnectedå›è°ƒåˆ™å®šä¹‰äº†ä¸Šä¸€èŠ‚æ‰€æåˆ°çš„è‡ªå®šä¹‰è¿æ¥æ£€æŸ¥å›è°ƒå‡½æ•°ã€‚è¯¥ç»“æ„çš„æ„ä¹‰å¾ˆæ˜æ˜¾å°±æ˜¯ï¼šsourceé€šè¿‡ä¸€ä¸ªkcontrolï¼Œå’Œsinkè¿æ¥åœ¨ä¸€èµ·ï¼Œç°åœ¨æ˜¯å¦å¤„äºè¿æ¥çŠ¶æ€ï¼Œè¯·è°ƒç”¨connectedå›è°ƒå‡½æ•°æ£€æŸ¥ã€‚<br>è¿™é‡Œç›´æ¥ä½¿ç”¨åå­—å­—ç¬¦ä¸²æ¥æè¿°è¿æ¥å…³ç³»ï¼Œæ‰€æœ‰å®šä¹‰å¥½çš„routeï¼Œæœ€åéƒ½è¦æ³¨å†Œåˆ°dapmç³»ç»Ÿä¸­ï¼Œdapmä¼šæ ¹æ®è¿™äº›åå­—æ‰¾å‡ºç›¸åº”çš„widgetï¼Œå¹¶åŠ¨æ€åœ°ç”Ÿæˆæ‰€éœ€è¦çš„snd_soc_dapm_pathç»“æ„ï¼Œæ­£ç¡®åœ°å¤„ç†å„ä¸ªé“¾è¡¨å’ŒæŒ‡é’ˆçš„å…³ç³»ï¼Œå®ç°ä¸¤ä¸ªwidgetä¹‹é—´çš„è¿æ¥</p><h5 id="7-3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»"><a href="#7-3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»" class="headerlink" title="7.3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»"></a>7.3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»</h5><p>å‰é¢æˆ‘ä»¬ä¸»è¦ç€é‡äºcodecã€platformã€machineé©±åŠ¨ç¨‹åºä¸­å¦‚ä½•ä½¿ç”¨å’Œå»ºç«‹dapmæ‰€éœ€è¦çš„widgetï¼Œrouteï¼Œè¿™äº›æ˜¯éŸ³é¢‘é©±åŠ¨å¼€å‘äººå‘˜å¿…é¡»è¦äº†è§£çš„å†…å®¹ï¼Œç»è¿‡å‰å‡ ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬åº”è¯¥çŸ¥é“å¦‚ä½•åœ¨alsaéŸ³é¢‘é©±åŠ¨çš„3å¤§éƒ¨åˆ†ï¼ˆcodecã€platformã€machineï¼‰ä¸­ï¼ŒæŒ‰ç…§æ‰€ä½¿ç”¨çš„éŸ³é¢‘ç¡¬ä»¶ç»“æ„ï¼Œå®šä¹‰å‡ºç›¸åº”çš„widgetï¼Œkcontrolï¼Œä»¥åŠå¿…è¦çš„éŸ³é¢‘è·¯å¾„ï¼Œè€Œåœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šæ·±å…¥dapmçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œçœ‹çœ‹å„ä¸ªwidgetä¹‹é—´æ˜¯å¦‚ä½•å»ºç«‹è¿æ¥å…³ç³»ï¼Œå½¢æˆä¸€æ¡å®Œæ•´çš„éŸ³é¢‘è·¯å¾„ã€‚</p><p>å‰é¢æˆ‘ä»¬å·²ç»ç®€å•åœ°ä»‹ç»è¿‡ï¼Œé©±åŠ¨ç¨‹åºéœ€è¦ä½¿ç”¨ä»¥ä¸‹apiå‡½æ•°åˆ›å»ºwidgetï¼š</p><p>â€¢ snd_soc_dapm_new_controls()<br>å®é™…ä¸Šï¼Œè¿™ä¸ªå‡½æ•°åªæ˜¯åˆ›å»ºwidgetçš„ç¬¬ä¸€æ­¥ï¼Œå®ƒä¸ºæ¯ä¸ªwidgetåˆ†é…å†…å­˜ï¼Œåˆå§‹åŒ–å¿…è¦çš„å­—æ®µï¼Œç„¶åæŠŠè¿™äº›widgetæŒ‚åœ¨ä»£è¡¨å£°å¡çš„snd_soc_cardçš„widgetsé“¾è¡¨å­—æ®µä¸­ã€‚è¦ä½¿widgetä¹‹é—´å…·å¤‡è¿æ¥èƒ½åŠ›ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¬¬äºŒä¸ªå‡½æ•°ï¼š<br>â€¢ snd_soc_dapm_new_widgets()<br>è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®widgetçš„ä¿¡æ¯ï¼Œåˆ›å»ºwidgetæ‰€éœ€è¦çš„dapm kcontrolï¼Œè¿™äº›dapm kcontolçš„çŠ¶æ€å˜åŒ–ï¼Œä»£è¡¨ç€éŸ³é¢‘è·¯å¾„çš„å˜åŒ–ï¼Œä»è€Œå½±å“ç€å„ä¸ªwidgetçš„ç”µæºçŠ¶æ€ã€‚çœ‹åˆ°å‡½æ•°çš„åç§°å¯èƒ½ä¼šè¿·æƒ‘ä¸€ä¸‹ï¼Œå®é™…ä¸Šï¼Œsnd_soc_dapm_new_controlsçš„ä½œç”¨æ›´å¤šåœ°æ˜¯åˆ›å»ºwidgetï¼Œè€Œsnd_soc_dapm_new_widgetçš„ä½œç”¨åˆ™æ›´å¤šåœ°æ˜¯åˆ›å»ºwidgetæ‰€åŒ…å«çš„kcontrolï¼Œæ‰€ä»¥åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åç§°åº”è¯¥æ¢è¿‡æ¥å«æ›´å¥½ï¼ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><h5 id="7-3-1ã€åˆ›å»ºwidget"><a href="#7-3-1ã€åˆ›å»ºwidget" class="headerlink" title="7.3.1ã€åˆ›å»ºwidget"></a>7.3.1ã€åˆ›å»ºwidget</h5><p>snd_soc_dapm_new_controls()å‡½æ•°å®Œæˆwidgetçš„åˆ›å»ºå·¥ä½œï¼Œå¹¶æŠŠè¿™äº›åˆ›å»ºå¥½çš„widgetæ³¨å†Œåœ¨å£°å¡çš„widgetsé“¾è¡¨ä¸­ï¼Œæˆ‘ä»¬çœ‹çœ‹ä»–çš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_controls</span><span class="params">(struct snd_soc_dapm_context *dapm,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> struct snd_soc_dapm_widget *widget,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">w</span>;</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mutex_lock_nested(&amp;dapm-&gt;card-&gt;dapm_mutex, SND_SOC_DAPM_CLASS_INIT);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">w = snd_soc_dapm_new_control(dapm, widget);</span><br><span class="line"><span class="keyword">if</span> (!w) &#123;</span><br><span class="line">dev_err(dapm-&gt;dev,</span><br><span class="line"><span class="string">"ASoC: Failed to create DAPM control %s\n"</span>,</span><br><span class="line">widget-&gt;name);</span><br><span class="line">ret = -ENOMEM;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">widget++;</span><br><span class="line">&#125;</span><br><span class="line">mutex_unlock(&amp;dapm-&gt;card-&gt;dapm_mutex);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°åªæ˜¯ç®€å•çš„ä¸€ä¸ªå¾ªç¯ï¼Œä¸ºä¼ å…¥çš„widgetæ¨¡æ¿æ•°ç»„ä¾æ¬¡è°ƒç”¨snd_soc_dapm_new_controlå‡½æ•°ï¼Œå®é™…çš„å·¥ä½œç”±snd_soc_dapm_new_controlå®Œæˆï¼Œç»§ç»­è¿›å…¥è¯¥å‡½æ•°ï¼Œçœ‹çœ‹å®ƒåšäº†é‚£äº›å·¥ä½œã€‚<br>æˆ‘ä»¬ä¹‹å‰å·²ç»è¯´è¿‡ï¼Œé©±åŠ¨ä¸­å®šä¹‰çš„snd_soc_dapm_widgetæ•°ç»„ï¼Œåªæ˜¯ä½œä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œæ‰€ä»¥ï¼Œsnd_soc_dapm_new_controlæ‰€åšçš„ç¬¬ä¸€ä»¶äº‹ï¼Œå°±æ˜¯ä¸ºè¯¥widgeté‡æ–°åˆ†é…å†…å­˜ï¼Œå¹¶æŠŠæ¨¡æ¿çš„å†…å®¹æ‹·è´è¿‡æ¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *</span></span><br><span class="line"><span class="class"><span class="title">snd_soc_dapm_new_control</span>(<span class="title">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span>,</span></span><br><span class="line"><span class="class"> <span class="title">const</span> <span class="title">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">widget</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">w</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *prefix;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((w = dapm_cnew_widget(widget)) == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//ç”±dapm_cnew_widgetå®Œæˆå†…å­˜ç”³è¯·å’Œæ‹·è´æ¨¡æ¿çš„åŠ¨ä½œã€‚æ¥ä¸‹æ¥ï¼Œæ ¹æ®widgetçš„ç±»å‹åšä¸åŒçš„å¤„ç†ï¼š</span></span><br><span class="line"><span class="keyword">switch</span> (w-&gt;id) &#123;</span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_regulator_supply:</span><br><span class="line">......</span><br><span class="line">    &#125;</span><br><span class="line">prefix = soc_dapm_prefix(dapm);</span><br><span class="line"><span class="comment">//å¯¹äºsnd_soc_dapm_regulator_supplyç±»å‹çš„widgetï¼Œæ ¹æ®widgetçš„åç§°è·å–å¯¹åº”çš„regulatorç»“æ„ï¼Œå¯¹äºsnd_soc_dapm_clock_supplyç±»å‹çš„widgetï¼Œæ ¹æ®widgetçš„åç§°ï¼Œè·å–å¯¹åº”çš„clockç»“æ„ã€‚æ¥ä¸‹æ¥ï¼Œæ ¹æ®éœ€è¦ï¼Œåœ¨widgetçš„åç§°å‰åŠ å…¥å¿…è¦çš„å‰ç¼€ï¼š</span></span><br><span class="line"><span class="keyword">if</span> (prefix) &#123;</span><br><span class="line">w-&gt;name = kasprintf(GFP_KERNEL, <span class="string">"%s %s"</span>, prefix, widget-&gt;name);</span><br><span class="line"><span class="keyword">if</span> (widget-&gt;sname)</span><br><span class="line">w-&gt;sname = kasprintf(GFP_KERNEL, <span class="string">"%s %s"</span>, prefix,</span><br><span class="line">     widget-&gt;sname);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">w-&gt;name = kasprintf(GFP_KERNEL, <span class="string">"%s"</span>, widget-&gt;name);</span><br><span class="line"><span class="keyword">if</span> (widget-&gt;sname)</span><br><span class="line">w-&gt;sname = kasprintf(GFP_KERNEL, <span class="string">"%s"</span>, widget-&gt;sname);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/29-Audio-system-widget-1525420992983.png" alt="Alt text"><br>å½“éŸ³é¢‘è·¯å¾„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œpower_checkå›è°ƒä¼šè¢«è°ƒç”¨ï¼Œç”¨äºæ£€æŸ¥è¯¥widgetçš„ç”µæºçŠ¶æ€æ˜¯å¦éœ€è¦æ›´æ–°ã€‚power_checkè®¾ç½®å®Œæˆåï¼Œéœ€è¦è®¾ç½®widgetæ‰€å±çš„codecã€platformå’Œdapm contextï¼Œå‡ ä¸ªç”¨äºéŸ³é¢‘è·¯å¾„çš„é“¾è¡¨ä¹Ÿéœ€è¦åˆå§‹åŒ–ï¼Œç„¶åï¼ŒæŠŠè¯¥widgetåŠ å…¥åˆ°å£°å¡çš„widgetsé“¾è¡¨ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.cï¼šsnd_soc_dapm_new_control()</span><br><span class="line">w-&gt;dapm = dapm;  </span><br><span class="line">w-&gt;codec = dapm-&gt;codec;  </span><br><span class="line">w-&gt;platform = dapm-&gt;platform;  </span><br><span class="line">INIT_LIST_HEAD(&amp;w-&gt;sources);  </span><br><span class="line">INIT_LIST_HEAD(&amp;w-&gt;sinks);  </span><br><span class="line">INIT_LIST_HEAD(&amp;w-&gt;<span class="built_in">list</span>);  </span><br><span class="line">INIT_LIST_HEAD(&amp;w-&gt;dirty);  </span><br><span class="line">list_add(&amp;w-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;widgets);</span><br></pre></td></tr></table></figure><p>å‡ ä¸ªé“¾è¡¨çš„ä½œç”¨å¦‚ä¸‹ï¼š<br>sources    ç”¨äºé“¾æ¥æ‰€æœ‰è¿æ¥åˆ°è¯¥widgetè¾“å…¥ç«¯çš„snd_soc_pathç»“æ„<br>sinks    ç”¨äºé“¾æ¥æ‰€æœ‰è¿æ¥åˆ°è¯¥widgetè¾“å‡ºç«¯çš„snd_soc_pathç»“æ„<br>list    ç”¨äºé“¾æ¥åˆ°å£°å¡çš„widgetsé“¾è¡¨<br>dirty    ç”¨äºé“¾æ¥åˆ°å£°å¡çš„dapm_dirtyé“¾è¡¨<br>æœ€åï¼ŒæŠŠwidgetè®¾ç½®ä¸ºconnectçŠ¶æ€ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.cï¼šsnd_soc_dapm_new_control()</span><br><span class="line"><span class="comment">/* machine layer set ups unconnected pins and insertions */</span>  </span><br><span class="line">w-&gt;connected = <span class="number">1</span>;  </span><br><span class="line"><span class="keyword">return</span> w;</span><br></pre></td></tr></table></figure><p>connectedå­—æ®µä»£è¡¨ç€å¼•è„šçš„è¿æ¥çŠ¶æ€ï¼Œç›®å‰ï¼Œåªæœ‰ä»¥ä¸‹è¿™äº›widgetä½¿ç”¨connectedå­—æ®µï¼š<br>snd_soc_dapm_output<br>snd_soc_dapm_input<br>snd_soc_dapm_hp<br>snd_soc_dapm_spk<br>snd_soc_dapm_line<br>snd_soc_dapm_vmid<br>snd_soc_dapm_mic<br>snd_soc_dapm_siggen<br>é©±åŠ¨ç¨‹åºå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¿™äº›apiæ¥è®¾ç½®å¼•è„šçš„è¿æ¥çŠ¶æ€ï¼š<br>snd_soc_dapm_enable_pin<br>snd_soc_dapm_force_enable_pin<br>snd_soc_dapm_disable_pin<br>snd_soc_dapm_nc_pin<br>åˆ°æ­¤ï¼Œwidgetå·²ç»è¢«æ­£ç¡®åœ°åˆ›å»ºå¹¶åˆå§‹åŒ–ï¼Œè€Œä¸”è¢«æŒ‚åœ¨å£°å¡çš„widgetsé“¾è¡¨ä¸­ï¼Œä»¥åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å£°å¡çš„widgetsé“¾è¡¨æ¥éå†æ‰€æœ‰çš„widgetï¼Œå†æ¬¡å¼ºè°ƒä¸€ä¸‹snd_soc_dapm_new_controlså‡½æ•°æ‰€å®Œæˆçš„ä¸»è¦åŠŸèƒ½ï¼š<br>ä¸ºwidgetåˆ†é…å†…å­˜ï¼Œå¹¶æ‹·è´å‚æ•°ä¸­ä¼ å…¥çš„åœ¨é©±åŠ¨ä¸­å®šä¹‰å¥½çš„æ¨¡æ¿<br>è®¾ç½®power_checkå›è°ƒå‡½æ•°<br>æŠŠwidgetæŒ‚åœ¨å£°å¡çš„widgetsé“¾è¡¨ä¸­</p><h5 id="7-3-2ã€ä¸ºwidgetå»ºç«‹dapm-kcontrol"><a href="#7-3-2ã€ä¸ºwidgetå»ºç«‹dapm-kcontrol" class="headerlink" title="7.3.2ã€ä¸ºwidgetå»ºç«‹dapm kcontrol"></a>7.3.2ã€ä¸ºwidgetå»ºç«‹dapm kcontrol</h5><p>å®šä¹‰ä¸€ä¸ªwidgetï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šä¸¤ä¸ªå¾ˆé‡è¦çš„å†…å®¹ï¼šä¸€ä¸ªæ˜¯ç”¨äºæ§åˆ¶widgetçš„ç”µæºçŠ¶æ€çš„reg/shiftç­‰å¯„å­˜å™¨ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªæ˜¯ç”¨äºæ§åˆ¶éŸ³é¢‘è·¯å¾„åˆ‡æ¢çš„dapm kcontrolä¿¡æ¯ï¼Œè¿™äº›dapm kcontrolæœ‰å®ƒä»¬è‡ªå·±çš„reg/shiftå¯„å­˜å™¨ä¿¡æ¯ç”¨äºåˆ‡æ¢widgetçš„è·¯å¾„è¿æ¥æ–¹å¼ã€‚å‰ä¸€èŠ‚çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯åˆ›å»ºäº†widgetçš„å®ä¾‹ï¼Œå¹¶æŠŠå®ƒä»¬æ³¨å†Œåˆ°å£°å¡çš„widgtsé“¾è¡¨ä¸­ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒåŒ…å«åœ¨widgetä¸­çš„dapm kcontrolå¹¶æ²¡æœ‰å»ºç«‹èµ·æ¥ï¼Œdapmæ¡†æ¶åœ¨å£°å¡çš„åˆå§‹åŒ–é˜¶æ®µï¼Œç­‰æ‰€æœ‰çš„widgetï¼ˆåŒ…æ‹¬machineã€platformã€codecï¼‰éƒ½åˆ›å»ºå¥½ä¹‹åï¼Œé€šè¿‡snd_soc_dapm_new_widgetså‡½æ•°ï¼Œåˆ›å»ºwidgetå†…åŒ…å«çš„dapm kcontrolï¼Œå¹¶åˆå§‹åŒ–widgetçš„åˆå§‹ç”µæºçŠ¶æ€å’ŒéŸ³é¢‘è·¯å¾„çš„åˆå§‹è¿æ¥çŠ¶æ€ã€‚æˆ‘ä»¬çœ‹çœ‹å£°å¡çš„åˆå§‹åŒ–å‡½æ•°ï¼Œéƒ½æœ‰é‚£äº›åˆå§‹åŒ–ä¸dapmæœ‰å…³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_instantiate_card</span><span class="params">(struct snd_soc_card *card)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        ......  </span><br><span class="line">        <span class="comment">/* card bind complete so register a sound card */</span>  </span><br><span class="line">        ret = snd_card_create(SNDRV_DEFAULT_IDX1, SNDRV_DEFAULT_STR1,  </span><br><span class="line">                        card-&gt;owner, <span class="number">0</span>, &amp;card-&gt;snd_card);  </span><br><span class="line">        ......  </span><br><span class="line">   </span><br><span class="line">        card-&gt;dapm.bias_level = SND_SOC_BIAS_OFF;  </span><br><span class="line">        card-&gt;dapm.dev = card-&gt;dev;  </span><br><span class="line">        card-&gt;dapm.card = card;  </span><br><span class="line">        list_add(&amp;card-&gt;dapm.<span class="built_in">list</span>, &amp;card-&gt;dapm_list);  </span><br><span class="line">        ......  </span><br><span class="line">        <span class="keyword">if</span> (card-&gt;dapm_widgets)    <span class="comment">/* åˆ›å»ºmachineçº§åˆ«çš„widget  */</span>  </span><br><span class="line">                snd_soc_dapm_new_controls(&amp;card-&gt;dapm, card-&gt;dapm_widgets,  </span><br><span class="line">                                          card-&gt;num_dapm_widgets);  </span><br><span class="line">        ......  </span><br><span class="line">        snd_soc_dapm_link_dai_widgets(card);  <span class="comment">/*  è¿æ¥dai widget  */</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (card-&gt;controls)    <span class="comment">/*  å»ºç«‹machineçº§åˆ«çš„æ™®é€škcontrolæ§ä»¶  */</span>  </span><br><span class="line">                snd_soc_add_card_controls(card, card-&gt;controls, card-&gt;num_controls);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (card-&gt;dapm_routes)    <span class="comment">/*  æ³¨å†Œmachineçº§åˆ«çš„è·¯å¾„è¿æ¥ä¿¡æ¯  */</span>  </span><br><span class="line">                snd_soc_dapm_add_routes(&amp;card-&gt;dapm, card-&gt;dapm_routes,  </span><br><span class="line">                                        card-&gt;num_dapm_routes);  </span><br><span class="line">        ......  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (card-&gt;fully_routed)    <span class="comment">/*  å¦‚æœè¯¥æ ‡å¿—è¢«ç½®ä½ï¼Œè‡ªåŠ¨æŠŠcodecä¸­æ²¡æœ‰è·¯å¾„è¿æ¥ä¿¡æ¯çš„å¼•è„šè®¾ç½®ä¸ºæ— ç”¨widget  */</span>  </span><br><span class="line">                list_for_each_entry(codec, &amp;card-&gt;codec_dev_list, card_list)  </span><br><span class="line">                        snd_soc_dapm_auto_nc_codec_pins(codec);  </span><br><span class="line">  </span><br><span class="line">        snd_soc_dapm_new_widgets(card);    <span class="comment">/*åˆå§‹åŒ–widgetåŒ…å«çš„dapm kcontrolã€ç”µæºçŠ¶æ€å’Œè¿æ¥çŠ¶æ€*/</span>  </span><br><span class="line">  </span><br><span class="line">        ret = snd_card_register(card-&gt;snd_card);  </span><br><span class="line">        ......  </span><br><span class="line">        card-&gt;instantiated = <span class="number">1</span>;  </span><br><span class="line">        snd_soc_dapm_sync(&amp;card-&gt;dapm);  </span><br><span class="line">        ......  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£å¦‚æˆ‘æ·»åŠ çš„æ³¨é‡Šä¸­æ‰€ç¤ºï¼Œåœ¨å®Œæˆmachineçº§åˆ«çš„widgetå’Œrouteå¤„ç†ä¹‹åï¼Œè°ƒç”¨çš„snd_soc_dapm_new_widgetså‡½æ•°ï¼Œæ¥ä¸ºæ‰€æœ‰å·²ç»æ³¨å†Œçš„widgetåˆå§‹åŒ–ä»–ä»¬æ‰€åŒ…å«çš„dapm kcontrolï¼Œå¹¶åˆå§‹åŒ–widgetçš„ç”µæºçŠ¶æ€å’Œè·¯å¾„è¿æ¥çŠ¶æ€ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹snd_soc_dapm_new_widgetså‡½æ•°çš„å·¥ä½œè¿‡ç¨‹ã€‚</p><h5 id="7-3-2-1ã€snd-soc-dapm-new-widgetså‡½æ•°"><a href="#7-3-2-1ã€snd-soc-dapm-new-widgetså‡½æ•°" class="headerlink" title="7.3.2.1ã€snd_soc_dapm_new_widgetså‡½æ•°"></a>7.3.2.1ã€snd_soc_dapm_new_widgetså‡½æ•°</h5><p>è¯¥å‡½æ•°é€šè¿‡å£°å¡çš„widgetsé“¾è¡¨ï¼Œéå†æ‰€æœ‰å·²ç»æ³¨å†Œäº†çš„widgetï¼Œå…¶ä¸­çš„newå­—æ®µç”¨äºåˆ¤æ–­è¯¥widgetæ˜¯å¦å·²ç»æ‰§è¡Œè¿‡snd_soc_dapm_new_widgetså‡½æ•°ï¼Œå¦‚æœnum_kcontrolså­—æ®µæœ‰æ•°å€¼ï¼Œè¡¨æ˜è¯¥widgetåŒ…å«æœ‰è‹¥å¹²ä¸ªdapm kcontrolï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸ºè¿™äº›kcontrolåˆ†é…ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œå¹¶æŠŠæ•°ç»„çš„é¦–åœ°å€èµ‹å€¼ç»™widgetçš„kcontrolså­—æ®µï¼Œè¯¥æ•°ç»„å­˜æ”¾ç€æŒ‡å‘è¿™äº›kcontrolçš„æŒ‡é’ˆï¼Œå½“ç„¶ç°åœ¨è¿™äº›éƒ½æ˜¯ç©ºæŒ‡é’ˆï¼Œå› ä¸ºå®é™…çš„kcontrolç°åœ¨è¿˜æ²¡æœ‰è¢«åˆ›å»ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_widgets</span><span class="params">(struct snd_soc_card *card)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        ......  </span><br><span class="line">        list_for_each_entry(w, &amp;card-&gt;widgets, <span class="built_in">list</span>)  </span><br><span class="line">        &#123;                 </span><br><span class="line">                <span class="keyword">if</span> (w-&gt;<span class="keyword">new</span>) <span class="keyword">continue</span>;  </span><br><span class="line">                                  </span><br><span class="line">                <span class="keyword">if</span> (w-&gt;num_kcontrols) &#123;  </span><br><span class="line">                        w-&gt;kcontrols = kzalloc(w-&gt;num_kcontrols *  </span><br><span class="line">                                                <span class="keyword">sizeof</span>(struct snd_kcontrol *),  </span><br><span class="line">                                                GFP_KERNEL);  </span><br><span class="line">                        ......  </span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œå¯¹å‡ ç§èƒ½å½±å“éŸ³é¢‘è·¯å¾„çš„widgetï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–å®ƒä»¬æ‰€åŒ…å«çš„dapm kcontrolï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_new_widgets()]</span><br><span class="line"><span class="keyword">switch</span>(w-&gt;id) &#123;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_switch:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mixer:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mixer_named_ctl:  </span><br><span class="line">        dapm_new_mixer(w);  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mux:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_virt_mux:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_value_mux:  </span><br><span class="line">        dapm_new_mux(w);  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_pga:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_out_drv:  </span><br><span class="line">        dapm_new_pga(w);  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">default</span>:  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦ç”¨åˆ°çš„åˆ›å»ºå‡½æ•°åˆ†åˆ«æ˜¯ï¼š<br>dapm_new_mixer()    å¯¹äºmixerç±»å‹ï¼Œç”¨è¯¥å‡½æ•°åˆ›å»ºdapm kcontrolï¼›<br>dapm_new_mux()   å¯¹äºmuxç±»å‹ï¼Œç”¨è¯¥å‡½æ•°åˆ›å»ºdapm kcontrolï¼›<br>dapm_new_pga()   å¯¹äºpgaç±»å‹ï¼Œç”¨è¯¥å‡½æ•°åˆ›å»ºdapm kcontrolï¼›<br>ç„¶åï¼Œæ ¹æ®widgetå¯„å­˜å™¨çš„å½“å‰å€¼ï¼Œåˆå§‹åŒ–widgetçš„ç”µæºçŠ¶æ€ï¼Œå¹¶è®¾ç½®åˆ°powerå­—æ®µä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_new_widgets()]</span><br><span class="line"><span class="comment">/* Read the initial power state from the device */</span>  </span><br><span class="line"><span class="keyword">if</span> (w-&gt;reg &gt;= <span class="number">0</span>) &#123;  </span><br><span class="line">        val = soc_widget_read(w, w-&gt;reg) &gt;&gt; w-&gt;shift;  </span><br><span class="line">        val &amp;= w-&gt;mask;  </span><br><span class="line">        <span class="keyword">if</span> (val == w-&gt;on_val)  </span><br><span class="line">                w-&gt;power = <span class="number">1</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œè®¾ç½®newå­—æ®µï¼Œè¡¨æ˜è¯¥widgetå·²ç»åˆå§‹åŒ–å®Œæˆï¼Œæˆ‘ä»¬è¿˜è¦å§è¯¥widgetåŠ å…¥åˆ°å£°å¡çš„dapm_dirtyé“¾è¡¨ä¸­ï¼Œè¡¨æ˜è¯¥widgetçš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œç¨ååœ¨åˆé€‚çš„æ—¶åˆ»ï¼Œdapmæ¡†æ¶ä¼šæ‰«ædapm_dirtyé“¾è¡¨ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰å·²ç»å˜åŒ–çš„widgetã€‚ä¸ºä»€ä¹ˆè¦ç»Ÿä¸€å¤„ç†ï¼Ÿå› ä¸ºdapmè¦æ§åˆ¶å„ç§widgetçš„ä¸Šä¸‹ç”µé¡ºåºï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†å‡å°‘å¯„å­˜å™¨çš„è¯»å†™æ¬¡æ•°ï¼ˆå¤šä¸ªwidgetå¯èƒ½ä½¿ç”¨åŒä¸€ä¸ªå¯„å­˜å™¨ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_new_widgets()]</span><br><span class="line">w-&gt;<span class="keyword">new</span> = <span class="number">1</span>;  </span><br><span class="line">  </span><br><span class="line">dapm_mark_dirty(w, <span class="string">"new widget"</span>);  </span><br><span class="line">dapm_debugfs_add_widget(w);</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œé€šè¿‡dapm_power_widgetså‡½æ•°ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰ä½äºdapm_dirtyé“¾è¡¨ä¸Šçš„widgetçš„çŠ¶æ€æ”¹å˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_new_widgets()]</span><br><span class="line">dapm_power_widgets(card, SND_SOC_DAPM_STREAM_NOP);  </span><br><span class="line">......  </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h5 id="7-3-2-2ã€dapm-mixer-kcontrol"><a href="#7-3-2-2ã€dapm-mixer-kcontrol" class="headerlink" title="7.3.2.2ã€dapm mixer kcontrol"></a>7.3.2.2ã€dapm mixer kcontrol</h5><p>ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œå¯¹äºmixerç±»å‹çš„dapm kcontrolï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨dapm_new_mixeræ¥å®Œæˆå…·ä½“çš„åˆ›å»ºå·¥ä½œï¼Œå…ˆçœ‹ä»£ç ååˆ†æï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_new_mixer</span><span class="params">(struct snd_soc_dapm_widget *w)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> i, ret;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> *<span class="title">path</span>;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">/* add kcontrol */</span>  </span><br><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; w-&gt;num_kcontrols; i++) &#123;                                  </span><br><span class="line">                <span class="comment">/* match name */</span>  </span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰                list_for_each_entry(path, &amp;w-&gt;sources, list_sink) &#123;               </span><br><span class="line">                        <span class="comment">/* mixer/mux paths name must match control name */</span>  </span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰                        <span class="keyword">if</span> (path-&gt;name != (<span class="keyword">char</span> *)w-&gt;kcontrol_news[i].name)       </span><br><span class="line">                                <span class="keyword">continue</span>;  </span><br><span class="line">  </span><br><span class="line">ï¼ˆ<span class="number">4</span>ï¼‰                        <span class="keyword">if</span> (w-&gt;kcontrols[i]) &#123;                                   </span><br><span class="line">                                dapm_kcontrol_add_path(w-&gt;kcontrols[i], path);  </span><br><span class="line">                                <span class="keyword">continue</span>;  </span><br><span class="line">                        &#125;  </span><br><span class="line">  </span><br><span class="line">ï¼ˆ<span class="number">5</span>ï¼‰                        ret = dapm_create_or_share_mixmux_kcontrol(w, i);        </span><br><span class="line">                        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)  </span><br><span class="line">                                <span class="keyword">return</span> ret;  </span><br><span class="line">  </span><br><span class="line">ï¼ˆ<span class="number">6</span>ï¼‰                        dapm_kcontrol_add_path(w-&gt;kcontrols[i], path);           </span><br><span class="line">                &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰  å› ä¸ºä¸€ä¸ªmixeræ˜¯ç”±å¤šä¸ªkcontrolç»„æˆçš„ï¼Œæ¯ä¸ªkcontrolæ§åˆ¶ç€mixerçš„ä¸€ä¸ªè¾“å…¥ç«¯çš„å¼€å¯å’Œå…³é—­ï¼Œæ‰€ä»¥ï¼Œè¯¥å‡½æ•°ä¼šæ ¹æ®kcontrolçš„æ•°é‡åšå¾ªç¯ï¼Œé€ä¸ªå»ºç«‹å¯¹åº”çš„kcontrolã€‚<br>ï¼ˆ2ï¼‰ï¼ˆ3ï¼‰  ä¹‹å‰å¤šæ¬¡æåˆ°ï¼Œwidgetä¹‹é—´ä½¿ç”¨snd_soc_pathè¿›è¡Œè¿æ¥ï¼Œwidgetçš„sourcesé“¾è¡¨ä¿å­˜ç€æ‰€æœ‰å’Œè¾“å…¥ç«¯è¿æ¥çš„snd_soc_pathç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨kcontrolæ¨¡æ¿ä¸­æŒ‡å®šçš„åå­—æ¥åŒ¹é…å¯¹åº”çš„snd_soc_pathç»“æ„ã€‚<br>ï¼ˆ4ï¼‰  å› ä¸ºä¸€ä¸ªè¾“å…¥è„šå¯èƒ½ä¼šè¿æ¥å¤šä¸ªè¾“å…¥æºï¼Œæ‰€ä»¥å¯èƒ½åœ¨ä¸Šä¸€ä¸ªè¾“å…¥æºçš„pathå…³è”æ—¶å·²ç»åˆ›å»ºäº†è¿™ä¸ªkcontrolï¼Œæ‰€ä»¥è¿™é‡Œåˆ¤æ–­kcontrolsæŒ‡é’ˆæ•°ç»„ä¸­å¯¹åº”ç´¢å¼•ä¸­çš„æŒ‡é’ˆå€¼ï¼Œå¦‚æœå·²ç»èµ‹å€¼ï¼Œè¯´æ˜kcontrolå·²ç»åœ¨ä¹‹å‰åˆ›å»ºå¥½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦ç®€å•åœ°æŠŠè¿æ¥è¯¥è¾“å…¥ç«¯çš„pathåŠ å…¥åˆ°kcontrolçš„path_listé“¾è¡¨ä¸­ï¼Œå¹¶ä¸”å¢åŠ ä¸€ä¸ªè™šæ‹Ÿçš„å½±å­widgetï¼Œè¯¥å½±å­widgetè¿æ¥å’Œè¾“å…¥ç«¯å¯¹åº”çš„æºwidgetï¼Œå› ä¸ºä½¿ç”¨äº†kcontrolæœ¬èº«çš„reg/shiftç­‰å¯„å­˜å™¨ä¿¡æ¯ï¼Œæ‰€ä»¥å®é™…ä¸Šæ§åˆ¶çš„æ˜¯è¯¥kcontrolçš„å¼€å’Œå…³ï¼Œè¿™ä¸ªå½±å­widgetåªæœ‰åœ¨kcontrolçš„autodisableå­—æ®µè¢«è®¾ç½®çš„æƒ…å†µä¸‹æ‰ä¼šè¢«åˆ›å»ºï¼Œè¯¥ç‰¹æ€§ä½¿å¾—sourceçš„å…³é—­æ—¶ï¼Œä¸ä¹‹è¿æ¥çš„mixerçš„è¾“å…¥ç«¯ä¹Ÿå¯ä»¥è‡ªåŠ¨å…³é—­ï¼Œè¿™ä¸ªç‰¹æ€§é€šè¿‡dapm_kcontrol_add_pathæ¥å®ç°è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dapm_kcontrol_add_path</span><span class="params">(<span class="keyword">const</span> struct snd_kcontrol *kcontrol,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_path *path)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dapm_kcontrol_data</span> *<span class="title">data</span> = <span class="title">snd_kcontrol_chip</span>(<span class="title">kcontrol</span>);</span>  </span><br><span class="line">        <span class="comment">/*  æŠŠkcontrolè¿æ¥çš„pathåŠ å…¥åˆ°pathsé“¾è¡¨ä¸­  */</span>  </span><br><span class="line">        <span class="comment">/*  pathsé“¾è¡¨æ‰€åœ¨çš„dapm_kcontrol_dataç»“æ„ä¼šä¿å­˜åœ¨kcontrolçš„private_dataå­—æ®µä¸­  */</span>  </span><br><span class="line">        list_add_tail(&amp;path-&gt;list_kcontrol, &amp;data-&gt;paths);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (data-&gt;widget) &#123;  </span><br><span class="line">                snd_soc_dapm_add_path(data-&gt;widget-&gt;dapm, data-&gt;widget,  </span><br><span class="line">                    path-&gt;source, <span class="literal">NULL</span>, <span class="literal">NULL</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰  å¦‚æœkcontrolä¹‹å‰æ²¡æœ‰è¢«åˆ›å»ºï¼Œåˆ™é€šè¿‡dapm_create_or_share_mixmux_kcontrolåˆ›å»ºè¿™ä¸ªè¾“å…¥ç«¯çš„kcontrolï¼ŒåŒç†ï¼Œkcontrolå¯¹åº”çš„å½±å­widgetä¹Ÿä¼šé€šè¿‡dapm_kcontrol_add_pathåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºã€‚</p><h5 id="7-3-2-3ã€dapm-mux-kcontrol"><a href="#7-3-2-3ã€dapm-mux-kcontrol" class="headerlink" title="7.3.2.3ã€dapm mux kcontrol"></a>7.3.2.3ã€dapm mux kcontrol</h5><p>å› ä¸ºä¸€ä¸ªwidgetæœ€å¤šåªä¼šåŒ…å«ä¸€ä¸ªmuxç±»å‹çš„damp kcontrolï¼Œæ‰€ä»¥ä»–çš„åˆ›å»ºæ–¹æ³•ç¨æœ‰ä¸åŒï¼Œdapmæ¡†æ¶ä½¿ç”¨dapm_new_muxå‡½æ•°æ¥åˆ›å»ºmuxç±»å‹çš„dapm kcontrolï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_new_mux</span><span class="params">(struct snd_soc_dapm_widget *w)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;         </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span> = <span class="title">w</span>-&gt;<span class="title">dapm</span>;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> *<span class="title">path</span>;</span>  </span><br><span class="line">        <span class="keyword">int</span> ret;  </span><br><span class="line">          </span><br><span class="line">(<span class="number">1</span>)     <span class="keyword">if</span> (w-&gt;num_kcontrols != <span class="number">1</span>) &#123;  </span><br><span class="line">                dev_err(dapm-&gt;dev,  </span><br><span class="line">                        <span class="string">"ASoC: mux %s has incorrect number of controls\n"</span>,  </span><br><span class="line">                        w-&gt;name);  </span><br><span class="line">                <span class="keyword">return</span> -EINVAL;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (list_empty(&amp;w-&gt;sources)) &#123;  </span><br><span class="line">                dev_err(dapm-&gt;dev, <span class="string">"ASoC: mux %s has no paths\n"</span>, w-&gt;name);  </span><br><span class="line">                <span class="keyword">return</span> -EINVAL;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">(<span class="number">2</span>)     ret = dapm_create_or_share_mixmux_kcontrol(w, <span class="number">0</span>);  </span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)  </span><br><span class="line">                <span class="keyword">return</span> ret;  </span><br><span class="line">(<span class="number">3</span>)       list_for_each_entry(path, &amp;w-&gt;sources, list_sink)  </span><br><span class="line">                dapm_kcontrol_add_path(w-&gt;kcontrols[<span class="number">0</span>], path);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰  å¯¹äºmuxç±»å‹çš„widgetï¼Œå› ä¸ºåªä¼šæœ‰ä¸€ä¸ªkcontrolï¼Œæ‰€ä»¥åœ¨è¿™é‡Œåšä¸€ä¸‹åˆ¤æ–­ã€‚<br>ï¼ˆ2ï¼‰  åŒæ ·åœ°ï¼Œå’Œmixerç±»å‹ä¸€æ ·ï¼Œä¹Ÿä½¿ç”¨dapm_create_or_share_mixmux_kcontrolæ¥åˆ›å»ºè¿™ä¸ªkcontrolã€‚<br>ï¼ˆ3ï¼‰  å¯¹æ¯ä¸ªè¾“å…¥ç«¯æ‰€è¿æ¥çš„pathéƒ½åŠ å…¥dapm_kcontrol_dataç»“æ„çš„pathsé“¾è¡¨ä¸­ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªå½±å­widgetï¼Œç”¨äºæ”¯æŒautodisableç‰¹æ€§ã€‚</p><h5 id="7-3-2-4ã€dapm-pga-kcontrol"><a href="#7-3-2-4ã€dapm-pga-kcontrol" class="headerlink" title="7.3.2.4ã€dapm pga kcontrol"></a>7.3.2.4ã€dapm pga kcontrol</h5><p>ç›®å‰å¯¹äºpgaç±»å‹çš„widgetï¼Œkcontrolçš„åˆ›å»ºå‡½æ•°æ˜¯ä¸ªç©ºå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ç”¨å¤ªå…³æ³¨å®ƒï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_new_pga</span><span class="params">(struct snd_soc_dapm_widget *w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (w-&gt;num_kcontrols)</span><br><span class="line">dev_err(w-&gt;dapm-&gt;dev,</span><br><span class="line"><span class="string">"ASoC: PGA controls not supported: '%s'\n"</span>, w-&gt;name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dapm_create_or_share_mixmux_kcontrolå‡½æ•°<br>ä¸Šé¢æ‰€è¯´çš„mixerç±»å‹å’Œmuxç±»å‹çš„widgetï¼Œåœ¨åˆ›å»ºä»–ä»¬æ‰€åŒ…å«çš„dapm kcontrolæ—¶ï¼Œæœ€åå…¶å®éƒ½æ˜¯ä½¿ç”¨äº†dapm_create_or_share_mixmux_kcontrolå‡½æ•°æ¥å®Œæˆåˆ›å»ºå·¥ä½œçš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬æœ‰å¿…è¦åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å·¥ä½œåŸç†ã€‚è¿™ä¸ªå‡½æ•°ä¸­æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ä»£ç å®åœ¨å¤„ç†kcontrolçš„åå­—æ˜¯å¦è¦åŠ å…¥codecçš„å‰ç¼€ï¼Œæˆ‘ä»¬ä¼šå¿½ç•¥è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±æŸ¥çœ‹å†…æ ¸çš„ä»£ç ï¼Œè·¯å¾„åœ¨ï¼šsound/soc/soc-dapm.cä¸­ï¼Œç®€åŒ–åçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_create_or_share_mixmux_kcontrol</span><span class="params">(struct snd_soc_dapm_widget *w,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> kci)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">          ......  </span><br><span class="line">(<span class="number">1</span>)       shared = dapm_is_shared_kcontrol(dapm, w, &amp;w-&gt;kcontrol_news[kci],  </span><br><span class="line">                                         &amp;kcontrol);  </span><br><span class="line">     </span><br><span class="line">(<span class="number">2</span>)       <span class="keyword">if</span> (!kcontrol) &#123;  </span><br><span class="line">(<span class="number">3</span>)            kcontrol = snd_soc_cnew(&amp;w-&gt;kcontrol_news[kci], <span class="literal">NULL</span>, name,prefixï¼‰;  </span><br><span class="line">               ......  </span><br><span class="line">               kcontrol-&gt;private_free = dapm_kcontrol_free;  </span><br><span class="line">(<span class="number">4</span>)            ret = dapm_kcontrol_data_alloc(w, kcontrol);  </span><br><span class="line">                ......  </span><br><span class="line">(<span class="number">5</span>)            ret = snd_ctl_add(card, kcontrol);  </span><br><span class="line">                ......  </span><br><span class="line">        &#125;  </span><br><span class="line">(<span class="number">6</span>)     ret = dapm_kcontrol_add_widget(kcontrol, w);  </span><br><span class="line">        ......  </span><br><span class="line">(<span class="number">7</span>)     w-&gt;kcontrols[kci] = kcontrol;  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰  ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œé€šè¿‡kcontrolåå­—çš„åŒ¹é…æŸ¥æ‰¾ï¼Œå¦‚æœè¿™ä¸ªkcontrolå·²ç»åœ¨å…¶ä»–widgetä¸­å·²ç»åˆ›å»ºå¥½äº†ï¼Œé‚£æˆ‘ä»¬ä¸å†åˆ›å»ºï¼Œdapm_is_shared_kcontrolçš„å‚æ•°kcontrolä¼šè¿”å›å·²ç»åˆ›å»ºå¥½çš„kcontrolçš„æŒ‡é’ˆã€‚<br>ï¼ˆ2ï¼‰  å¦‚æœkcontrolæŒ‡é’ˆè¢«èµ‹å€¼ï¼Œè¯´æ˜åœ¨ï¼ˆ1ï¼‰ä¸­æŸ¥æ‰¾åˆ°äº†å…¶ä»–widgetä¸­åŒåçš„kcontrolï¼Œæˆ‘ä»¬ä¸ç”¨å†æ¬¡åˆ›å»ºï¼Œåªè¦å…±äº«è¯¥kcontrolå³å¯ã€‚<br>ï¼ˆ3ï¼‰  æ ‡å‡†çš„kcontrolåˆ›å»ºå‡½æ•°ï¼Œ<br>ï¼ˆ4ï¼‰  å¦‚æœwidgetæ”¯æŒautodisableç‰¹æ€§ï¼Œåˆ›å»ºä¸è¯¥kcontrolæ‰€å¯¹åº”çš„å½±å­widgetï¼Œè¯¥å½±å­widgetçš„ç±»å‹æ˜¯ï¼šsnd_soc_dapm_kcontrolã€‚<br>ï¼ˆ5ï¼‰  æ ‡å‡†çš„kcontrolåˆ›å»ºå‡½æ•°ï¼Œ<br>ï¼ˆ6ï¼‰  æŠŠæ‰€æœ‰å…±äº«è¯¥kcontrolçš„å½±å­widgetï¼ˆsnd_soc_dapm_kcontrolï¼‰ï¼ŒåŠ å…¥åˆ°kcontrolçš„private_dataå­—æ®µæ‰€æŒ‡å‘çš„dapm_kcontrol_dataç»“æ„ä¸­ã€‚<br>ï¼ˆ7ï¼‰  æŠŠåˆ›å»ºå¥½çš„kcontrolæŒ‡é’ˆèµ‹å€¼åˆ°widgetçš„kcontrolsæ•°ç»„ä¸­ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœkcontolæ”¯æŒautodisableç‰¹æ€§ï¼Œä¸€æ—¦kcontrolç”±äºsourceçš„å…³é—­è€Œè¢«è‡ªåŠ¨å…³é—­ï¼Œåˆ™ç”¨æˆ·ç©ºé—´åªèƒ½æ“ä½œè¯¥kcontrolçš„cacheå€¼ï¼Œåªæœ‰è¯¥kcontrolå†æ¬¡æ‰“å¼€æ—¶ï¼Œè¯¥cacheå€¼æ‰ä¼šè¢«çœŸæ­£åœ°æ›´æ–°åˆ°å¯„å­˜å™¨ä¸­ã€‚<br>ç°åœ¨ã€‚æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªwidgetæ‰€åŒ…å«çš„kcontrolæ‰€åšçš„å·¥ä½œï¼š<br>â€¢ å¾ªç¯æ¯ä¸€ä¸ªè¾“å…¥ç«¯ï¼Œä¸ºæ¯ä¸ªè¾“å…¥ç«¯ä¾æ¬¡æ‰§è¡Œä¸‹é¢çš„ä¸€ç³»åˆ—æ“ä½œ<br>â€¢ ä¸ºæ¯ä¸ªè¾“å…¥ç«¯åˆ›å»ºä¸€ä¸ªkcontrolï¼Œèƒ½å…±äº«çš„åˆ™ç›´æ¥ä½¿ç”¨åˆ›å»ºå¥½çš„kcontrol<br>â€¢ kcontrolçš„private_dataå­—æ®µä¿å­˜ç€è¿™äº›å…±äº«widgetçš„ä¿¡æ¯<br>â€¢ å¦‚æœæ”¯æŒautodisableç‰¹æ€§ï¼Œæ¯ä¸ªè¾“å…¥ç«¯è¿˜è¦é¢å¤–åœ°åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„snd_soc_dapm_kcontrolç±»å‹çš„å½±å­widgetï¼Œè¯¥å½±å­widgetä¹Ÿè®°å½•åœ¨private_dataå­—æ®µä¸­<br>â€¢ åˆ›å»ºå¥½çš„kcontrolä¼šä¾æ¬¡å­˜æ”¾åœ¨widgetçš„kcontrolsæ•°ç»„ä¸­ï¼Œä¾›è·¯å¾„çš„æ§åˆ¶å’ŒåŒ¹é…ä¹‹ç”¨ã€‚</p><h5 id="7-3-2-5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»"><a href="#7-3-2-5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»" class="headerlink" title="7.3.2.5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»"></a>7.3.2.5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»</h5><p>å¦‚æœwidgetä¹‹é—´æ²¡æœ‰è¿æ¥å…³ç³»ï¼Œdapmå°±æ— æ³•å®ç°åŠ¨æ€çš„ç”µæºç®¡ç†å·¥ä½œï¼Œæ­£æ˜¯widgetä¹‹é—´æœ‰äº†è¿ç»“å…³ç³»ï¼Œè¿™äº›è¿æ¥å…³ç³»å½¢æˆäº†ä¸€æ¡æ‰€è°“çš„å®Œæˆçš„éŸ³é¢‘è·¯å¾„ï¼Œdapmå¯ä»¥é¡ºç€è¿™æ¡è·¯å¾„ï¼Œç»Ÿä¸€æ§åˆ¶è·¯å¾„ä¸Šæ‰€æœ‰widgetçš„ç”µæºçŠ¶æ€ï¼Œå‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œwidgetä¹‹é—´æ˜¯ä½¿ç”¨snd_soc_pathç»“æ„è¿›è¡Œè¿æ¥çš„ï¼Œé©±åŠ¨è¦åšçš„æ˜¯å®šä¹‰ä¸€ä¸ªsnd_soc_routeç»“æ„æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„æ¯ä¸ªæ¡ç›®æè¿°äº†ç›®çš„widgetçš„å’Œæºwidgetçš„åç§°ï¼Œä»¥åŠæ§åˆ¶è¿™ä¸ªè¿æ¥çš„kcontrolçš„åç§°ï¼Œæœ€ç»ˆï¼Œé©±åŠ¨ç¨‹åºä½¿ç”¨apiå‡½æ•°snd_soc_dapm_add_routesæ¥æ³¨å†Œè¿™äº›è¿æ¥ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯è¦åˆ†æè¯¥å‡½æ•°çš„å…·ä½“å®ç°æ–¹å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_add_routes</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> struct snd_soc_dapm_route *route, <span class="keyword">int</span> num)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> i, r, ret = <span class="number">0</span>;  </span><br><span class="line">  </span><br><span class="line">        mutex_lock_nested(&amp;dapm-&gt;card-&gt;dapm_mutex, SND_SOC_DAPM_CLASS_INIT);  </span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;  </span><br><span class="line">                r = snd_soc_dapm_add_route(dapm, route);  </span><br><span class="line">                ......  </span><br><span class="line">                route++;  </span><br><span class="line">        &#125;  </span><br><span class="line">        mutex_unlock(&amp;dapm-&gt;card-&gt;dapm_mutex);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> ret;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°åªæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¾æ¬¡å¯¹å‚æ•°ä¼ å…¥çš„æ•°ç»„è°ƒç”¨snd_soc_dapm_add_routeï¼Œä¸»è¦çš„å·¥ä½œç”±snd_soc_dapm_add_routeå®Œæˆã€‚æˆ‘ä»¬è¿›å…¥snd_soc_dapm_add_routeå‡½æ•°çœ‹çœ‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_dapm_add_route</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">const</span> struct snd_soc_dapm_route *route)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">wsource</span> = <span class="title">NULL</span>, *<span class="title">wsink</span> = <span class="title">NULL</span>, *<span class="title">w</span>;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">wtsource</span> = <span class="title">NULL</span>, *<span class="title">wtsink</span> = <span class="title">NULL</span>;</span>  </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *sink;  </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *source;  </span><br><span class="line">        ......  </span><br><span class="line">        list_for_each_entry(w, &amp;dapm-&gt;card-&gt;widgets, <span class="built_in">list</span>) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (!wsink &amp;&amp; !(<span class="built_in">strcmp</span>(w-&gt;name, sink))) &#123;  </span><br><span class="line">                        wtsink = w;  </span><br><span class="line">                        <span class="keyword">if</span> (w-&gt;dapm == dapm)  </span><br><span class="line">                                wsink = w;  </span><br><span class="line">                        <span class="keyword">continue</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">if</span> (!wsource &amp;&amp; !(<span class="built_in">strcmp</span>(w-&gt;name, source))) &#123;  </span><br><span class="line">                        wtsource = w;  </span><br><span class="line">                        <span class="keyword">if</span> (w-&gt;dapm == dapm)  </span><br><span class="line">                                wsource = w;  </span><br><span class="line">                &#125;  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æˆ‘å†æ¬¡çœç•¥äº†å…³äºåç§°å‰ç¼€çš„å¤„ç†éƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨widgetçš„åå­—æ¥æ¯”è¾ƒï¼Œéå†å£°å¡çš„widgetsé“¾è¡¨ï¼Œæ‰¾å‡ºæºwidgetå’Œç›®çš„widgetçš„æŒ‡é’ˆï¼Œè¿™æ®µä»£ç è™½ç„¶æ­£ç¡®ï¼Œä½†æˆ‘æ€»æ„Ÿè§‰å°‘äº†ä¸€ä¸ªåˆ¤æ–­é€€å‡ºå¾ªç¯çš„æ¡ä»¶ï¼Œå¦‚æœé“¾è¡¨çš„å¼€å¤´å°±æ‰¾åˆ°äº†ä¸¤ä¸ªwidgetï¼Œè¿˜æ˜¯è¦éå†æ•´ä¸ªé“¾è¡¨æ‰ç»“æŸå¾ªç¯ï¼Œå¥½æµªè´¹æ—¶é—´ã€‚<br>ä¸‹é¢ï¼Œå¦‚æœåœ¨æœ¬dapm contextä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä½¿ç”¨åˆ«çš„dapm contextä¸­æ‰¾åˆ°çš„widgetï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_route()]</span><br><span class="line"><span class="keyword">if</span> (!wsink)  </span><br><span class="line">        wsink = wtsink;  </span><br><span class="line"><span class="keyword">if</span> (!wsource)  </span><br><span class="line">        wsource = wtsource;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œä½¿ç”¨æ¥å¢åŠ ä¸€æ¡è¿æ¥ä¿¡æ¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_route()]</span><br><span class="line">        ret = snd_soc_dapm_add_path(dapm, wsource, wsink, route-&gt;control,  </span><br><span class="line">                route-&gt;connected);  </span><br><span class="line">        ......  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>snd_soc_dapm_add_pathå‡½æ•°æ˜¯æ•´ä¸ªè°ƒç”¨é“¾æ¡ä¸­çš„å…³é”®ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_dapm_add_path</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_widget *wsource, struct snd_soc_dapm_widget *wsink,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">char</span> *control,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> (*connected)</span><span class="params">(struct snd_soc_dapm_widget *source,  </span></span></span><br><span class="line">                         struct snd_soc_dapm_widget *sink))  </span><br><span class="line">&#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> *<span class="title">path</span>;</span>  </span><br><span class="line">        <span class="keyword">int</span> ret;  </span><br><span class="line">  </span><br><span class="line">        path = kzalloc(<span class="keyword">sizeof</span>(struct snd_soc_dapm_path), GFP_KERNEL);  </span><br><span class="line">        <span class="keyword">if</span> (!path)  </span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;  </span><br><span class="line">  </span><br><span class="line">        path-&gt;source = wsource;  </span><br><span class="line">        path-&gt;sink = wsink;  </span><br><span class="line">        path-&gt;connected = connected;  </span><br><span class="line">        INIT_LIST_HEAD(&amp;path-&gt;<span class="built_in">list</span>);  </span><br><span class="line">        INIT_LIST_HEAD(&amp;path-&gt;list_kcontrol);  </span><br><span class="line">        INIT_LIST_HEAD(&amp;path-&gt;list_source);  </span><br><span class="line">        INIT_LIST_HEAD(&amp;path-&gt;list_sink);</span><br></pre></td></tr></table></figure><p>å‡½æ•°çš„ä¸€å¼€å§‹ï¼Œé¦–å…ˆä¸ºè¿™ä¸ªè¿æ¥åˆ†é…äº†ä¸€ä¸ªsnd_soc_pathç»“æ„ï¼Œpathçš„sourceå’Œsinkå­—æ®µåˆ†åˆ«æŒ‡å‘æºwidgetå’Œç›®çš„widgetï¼Œconnectedå­—æ®µä¿å­˜connectedå›è°ƒå‡½æ•°ï¼Œåˆå§‹åŒ–å‡ ä¸ªsnd_soc_pathç»“æ„ä¸­çš„å‡ ä¸ªé“¾è¡¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line"><span class="comment">/* check for external widgets */</span>  </span><br><span class="line">        <span class="keyword">if</span> (wsink-&gt;id == snd_soc_dapm_input) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (wsource-&gt;id == snd_soc_dapm_micbias ||  </span><br><span class="line">                        wsource-&gt;id == snd_soc_dapm_mic ||  </span><br><span class="line">                        wsource-&gt;id == snd_soc_dapm_line ||  </span><br><span class="line">                        wsource-&gt;id == snd_soc_dapm_output)  </span><br><span class="line">                        wsink-&gt;ext = <span class="number">1</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (wsource-&gt;id == snd_soc_dapm_output) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (wsink-&gt;id == snd_soc_dapm_spk ||  </span><br><span class="line">                        wsink-&gt;id == snd_soc_dapm_hp ||  </span><br><span class="line">                        wsink-&gt;id == snd_soc_dapm_line ||  </span><br><span class="line">                        wsink-&gt;id == snd_soc_dapm_input)  </span><br><span class="line">                        wsource-&gt;ext = <span class="number">1</span>;  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰å¤–éƒ¨è¿æ¥å…³ç³»ï¼Œå¦‚æœæœ‰ï¼Œç½®ä½widgetçš„extå­—æ®µã€‚åˆ¤æ–­æ–¹æ³•ä»ä»£ç ä¸­å¯ä»¥æ–¹ä¾¿åœ°çœ‹å‡ºï¼š<br>ç›®çš„widgetæ˜¯ä¸€ä¸ªè¾“å…¥è„šï¼Œå¦‚æœæºwidgetæ˜¯micã€lineã€micbiasæˆ–outputï¼Œåˆ™è®¤ä¸ºç›®çš„widgetå…·æœ‰å¤–éƒ¨è¿æ¥å…³ç³»ã€‚<br>æºwidgetæ˜¯ä¸€ä¸ªè¾“å‡ºè„šï¼Œå¦‚æœç›®çš„widgetæ˜¯spkã€hpã€lineæˆ–inputï¼Œåˆ™è®¤ä¸ºæºwidgetå…·æœ‰å¤–éƒ¨è¿æ¥å…³ç³»ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line">dapm_mark_dirty(wsource, <span class="string">"Route added"</span>);  </span><br><span class="line">dapm_mark_dirty(wsink, <span class="string">"Route added"</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/* connect static paths */</span>  </span><br><span class="line"><span class="keyword">if</span> (control == <span class="literal">NULL</span>) &#123;  </span><br><span class="line">        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">        list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);  </span><br><span class="line">        list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);  </span><br><span class="line">        path-&gt;connect = <span class="number">1</span>;  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºå¢åŠ äº†è¿ç»“å…³ç³»ï¼Œæ‰€ä»¥æŠŠæºwidgetå’Œç›®çš„widgetåŠ å…¥åˆ°dapm_dirtyé“¾è¡¨ä¸­ã€‚å¦‚æœæ²¡æœ‰kcontrolæ¥æ§åˆ¶è¯¥è¿æ¥å…³ç³»ï¼Œåˆ™è¿™æ˜¯ä¸€ä¸ªé™æ€è¿æ¥ï¼Œç›´æ¥ç”¨pathæŠŠå®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ã€‚åœ¨æ¥ç€å¾€ä¸‹çœ‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line"><span class="comment">/* connect dynamic paths */</span>  </span><br><span class="line"><span class="keyword">switch</span> (wsink-&gt;id) &#123;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_adc:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_dac:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_pga:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_out_drv:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_input:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_output:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_siggen:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_micbias:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_vmid:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_pre:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_post:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_supply:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_regulator_supply:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_clock_supply:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_aif_in:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_aif_out:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_dai_in:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_dai_out:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_dai_link:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_kcontrol:  </span><br><span class="line">        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">        list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);  </span><br><span class="line">        list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);  </span><br><span class="line">        path-&gt;connect = <span class="number">1</span>;  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ç›®çš„widgetæ¥åˆ¤æ–­ï¼Œå¦‚æœå±äºä»¥ä¸Šè¿™äº›ç±»å‹ï¼Œç›´æ¥æŠŠå®ƒä»¬è¿æ¥åœ¨ä¸€èµ·å³å¯ï¼Œè¿™æ®µæ„Ÿè§‰æœ‰ç‚¹å¤šä½™ï¼Œå› ä¸ºé€šå¸¸ä»¥ä¸Šè¿™äº›ç±»å‹çš„widgetæœ¬æ¥ä¹Ÿæ²¡æœ‰kcontrolï¼Œç›´æ¥ç”¨ä¸Šä¸€æ®µä»£ç å°±å¯ä»¥äº†ï¼Œä¹Ÿè®¸æ˜¯dapmçš„ä½œè€…ä»¬æƒ³ç€ä»¥åå¯èƒ½ä¼šæœ‰æ‰€æ‰©å±•å§ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mux:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_virt_mux:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_value_mux:  </span><br><span class="line">        ret = dapm_connect_mux(dapm, wsource, wsink, path, control,  </span><br><span class="line">                &amp;wsink-&gt;kcontrol_news[<span class="number">0</span>]);  </span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)  </span><br><span class="line">                <span class="keyword">goto</span> err;  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_switch:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mixer:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mixer_named_ctl:  </span><br><span class="line">        ret = dapm_connect_mixer(dapm, wsource, wsink, path, control);  </span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)  </span><br><span class="line">                <span class="keyword">goto</span> err;  </span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>ç›®çš„widgetå¦‚æœæ˜¯mixerå’Œmuxç±»å‹ï¼Œåˆ†åˆ«ç”¨dapm_connect_mixerå’Œdapm_connect_muxå‡½æ•°å®Œæˆè¿æ¥å·¥ä½œï¼Œè¿™ä¸¤ä¸ªå‡½æ•°æˆ‘ä»¬åé¢å†è®²ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_hp:  </span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_mic:  </span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_line:  </span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_spk:  </span><br><span class="line">                list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">                list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);  </span><br><span class="line">                list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);  </span><br><span class="line">                path-&gt;connect = <span class="number">0</span>;  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">err:  </span><br><span class="line">        kfree(path);  </span><br><span class="line">        <span class="keyword">return</span> ret;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hpã€micã€lineå’Œspkè¿™å‡ ç§widgetå±äºå¤–éƒ¨å™¨ä»¶ï¼Œä¹Ÿåªæ˜¯ç®€å•åœ°è¿æ¥åœ¨ä¸€èµ·ï¼Œä¸è¿‡connectå­—æ®µé»˜è®¤ä¸ºæ˜¯æœªè¿æ¥çŠ¶æ€ã€‚<br>ç°åœ¨ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹ç›®çš„widgetæ˜¯mixerå’Œmuxè¿™ä¸¤ç§ç±»å‹æ—¶çš„è¿æ¥æ–¹å¼ï¼š<br>dapm_connect_mixer  ç”¨è¯¥å‡½æ•°è¿æ¥ä¸€ä¸ªç›®çš„widgetä¸ºmixerç±»å‹çš„æ‰€æœ‰è¾“å…¥ç«¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_connect_mixer</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_widget *src, struct snd_soc_dapm_widget *dest,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_path *path, <span class="keyword">const</span> <span class="keyword">char</span> *control_name)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> i;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">/* search for mixer kcontrol */</span>  </span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dest-&gt;num_kcontrols; i++) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(control_name, dest-&gt;kcontrol_news[i].name)) &#123;  </span><br><span class="line">                        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">                        list_add(&amp;path-&gt;list_sink, &amp;dest-&gt;sources);  </span><br><span class="line">                        list_add(&amp;path-&gt;list_source, &amp;src-&gt;sinks);  </span><br><span class="line">                        path-&gt;name = dest-&gt;kcontrol_news[i].name;  </span><br><span class="line">                        dapm_set_path_status(dest, path, i);  </span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> -ENODEV;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨éœ€è¦ç”¨æ¥è¿æ¥çš„kcontrolçš„åå­—ï¼Œå’Œç›®çš„widgetä¸­çš„kcontrolæ¨¡æ¿æ•°ç»„ä¸­çš„åå­—ç›¸æ¯”è¾ƒï¼Œæ‰¾å‡ºè¯¥kcontrolåœ¨widgetä¸­çš„ç¼–å·ï¼Œpathçš„åå­—è®¾ç½®ä¸ºè¯¥kcontrolçš„åå­—ï¼Œç„¶åç”¨dapm_set_path_statuså‡½æ•°æ¥åˆå§‹åŒ–è¯¥è¾“å…¥ç«¯çš„è¿æ¥çŠ¶æ€ã€‚è¿æ¥ä¸¤ä¸ªwidgetçš„é“¾è¡¨æ“ä½œå’Œå…¶ä»–widgetæ˜¯ä¸€æ ·çš„ã€‚</p><p>dapm_connect_mux ç”¨è¯¥å‡½æ•°è¿æ¥ä¸€ä¸ªç›®çš„widgetæ˜¯muxç±»å‹çš„æ‰€æœ‰è¾“å…¥ç«¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_connect_mux</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_widget *src, struct snd_soc_dapm_widget *dest,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_path *path, <span class="keyword">const</span> <span class="keyword">char</span> *control_name,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> struct snd_kcontrol_new *kcontrol)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">soc_enum</span> *<span class="title">e</span> = (<span class="title">struct</span> <span class="title">soc_enum</span> *)<span class="title">kcontrol</span>-&gt;<span class="title">private_value</span>;</span>  </span><br><span class="line">        <span class="keyword">int</span> i;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; e-&gt;max; i++) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (!(<span class="built_in">strcmp</span>(control_name, e-&gt;texts[i]))) &#123;  </span><br><span class="line">                        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">                        list_add(&amp;path-&gt;list_sink, &amp;dest-&gt;sources);  </span><br><span class="line">                        list_add(&amp;path-&gt;list_source, &amp;src-&gt;sinks);  </span><br><span class="line">                        path-&gt;name = (<span class="keyword">char</span>*)e-&gt;texts[i];  </span><br><span class="line">                        dapm_set_path_status(dest, path, <span class="number">0</span>);  </span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> -ENODEV;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œmixerç±»å‹ä¸€æ ·ç”¨åå­—è¿›è¡ŒåŒ¹é…ï¼Œåªä¸è¿‡muxç±»å‹çš„kcontrolåªéœ€ä¸€ä¸ªï¼Œæ‰€ä»¥è¦é€šè¿‡private_valueå­—æ®µæ‰€æŒ‡å‘çš„soc_enumç»“æ„æ‰¾å‡ºåŒ¹é…çš„è¾“å…¥è„šç¼–å·ï¼Œæœ€åä¹Ÿæ˜¯é€šè¿‡dapm_set_path_statuså‡½æ•°æ¥åˆå§‹åŒ–è¯¥è¾“å…¥ç«¯çš„è¿æ¥çŠ¶æ€ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªkcontrolï¼Œæ‰€ä»¥ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯0ã€‚è¿æ¥ä¸¤ä¸ªwidgetçš„é“¾è¡¨æ“ä½œå’Œå…¶ä»–widgetä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚<br>dapm_set_path_status    è¯¥å‡½æ•°æ ¹æ®ä¼ å…¥widgetä¸­çš„kcontrolç¼–å·ï¼Œè¯»å–å®é™…å¯„å­˜å™¨çš„å€¼ï¼Œæ ¹æ®å¯„å­˜å™¨çš„å€¼æ¥åˆå§‹åŒ–è¿™ä¸ªpathæ˜¯å¦å¤„äºè¿æ¥çŠ¶æ€ï¼Œè¯¦ç»†çš„ä»£ç è¿™é‡Œå°±ä¸è´´äº†ã€‚<br>å½“widgetä¹‹é—´é€šè¿‡pathè¿›è¡Œè¿æ¥ä¹‹åï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/210-Audio-system-snd_soc_dapm_path.png" alt="Alt text"></p><p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸ºå£°å¡åˆ›å»ºå¹¶åˆå§‹åŒ–å¥½äº†æ‰€éœ€çš„widgetï¼Œå„ä¸ªwidgetä¹Ÿé€šè¿‡pathè¿æ¥åœ¨äº†ä¸€èµ·ï¼Œæ¥ä¸‹æ¥ï¼Œdapmç­‰å¾…ç”¨æˆ·çš„æŒ‡ä»¤ï¼Œä¸€æ—¦æŸä¸ªdapm kcontrolè¢«ç”¨æˆ·ç©ºé—´æ”¹å˜ï¼Œåˆ©ç”¨è¿™äº›è¿æ¥å…³ç³»ï¼Œdapmä¼šé‡æ–°åˆ›å»ºéŸ³é¢‘è·¯å¾„ï¼Œè„±ç¦»éŸ³é¢‘è·¯å¾„çš„widgetä¼šè¢«ä¸‹ç”µï¼ŒåŠ å…¥éŸ³é¢‘è·¯å¾„çš„widgetä¼šè¢«ä¸Šç”µï¼Œæ‰€æœ‰çš„ä¸Šä¸‹ç”µåŠ¨ä½œéƒ½ä¼šè‡ªåŠ¨å®Œæˆï¼Œç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºæ— éœ€å…³æ³¨è¿™äº›å˜åŒ–ï¼Œå®ƒåªç®¡æŒ‰éœ€è¦æ”¹å˜æŸä¸ªdapm kcontrolå³å¯ã€‚</p><h4 id="ï¼ˆå…«ï¼‰ã€tinyplay-playbackã€capture"><a href="#ï¼ˆå…«ï¼‰ã€tinyplay-playbackã€capture" class="headerlink" title="ï¼ˆå…«ï¼‰ã€tinyplay playbackã€capture"></a>ï¼ˆå…«ï¼‰ã€tinyplay playbackã€capture</h4><h5 id="8-1ã€tinyplay-playback"><a href="#8-1ã€tinyplay-playback" class="headerlink" title="8.1ã€tinyplay playback"></a>8.1ã€tinyplay playback</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/211-tiny-capture.png" alt="Alt text"></p><p>æœ‰æ—¶åºå›¾å¯çŸ¥ï¼šä¸»è¦æ¶‰åŠpcm_open()ã€pcm_write()ã€pcm_prepare()ã€pcm_start()ã€‚</p><h5 id="8-1-1ã€ä½¿ç”¨è€³æœºæ’­æ”¾"><a href="#8-1-1ã€ä½¿ç”¨è€³æœºæ’­æ”¾" class="headerlink" title="8.1.1ã€ä½¿ç”¨è€³æœºæ’­æ”¾"></a>8.1.1ã€ä½¿ç”¨è€³æœºæ’­æ”¾</h5><ol><li>å¯åŠ¨éŸ³é¢‘æ’­æ”¾</li><li>å¯ç”¨ Rx codec è·¯å¾„<br>tinymix â€˜RX1 MIX1 INP1â€™ â€˜RX1â€™<br>tinymix â€˜RX2 MIX1 INP1â€™ â€˜RX2â€™<br>tinymix â€˜RDAC2 MUXâ€™ â€˜RX2â€™<br>tinymix â€˜HPHLâ€™ â€˜Switchâ€™<br>tinymix â€˜HPHRâ€™ â€˜Switchâ€™<br>tinymix â€˜MI2S_RX Channelsâ€™ â€˜Two</li><li>å¯ç”¨ç”¨äºé€šè¿‡ MI2S æ¥å£è¿›è¡Œæ’­æ”¾çš„ DSP AFE<br>tinymix â€˜PRI_MI2S_RX Audio Mixer MultiMedia1â€™ 1</li><li>æ’­æ”¾ PCM éŸ³é¢‘<br>tinyplay <filename.wav> </filename.wav></li><li>åœæ­¢éŸ³é¢‘æ’­æ”¾</li><li>ç¦ç”¨æ¥æ”¶ Rx codec è·¯å¾„<br>tinymix â€˜RX1 MIX1 INP1â€™ â€˜ZEROâ€™<br>tinymix â€˜RX2 MIX1 INP1â€™ â€˜ZEROâ€™<br>tinymix â€˜RDAC2 MUXâ€™ â€˜ZEROâ€™<br>tinymix â€˜HPHLâ€™ â€˜ZEROâ€™<br>tinymix â€˜HPHRâ€™ â€˜ZEROâ€™<br>tinymix â€˜MI2S_RX Channelsâ€™ â€˜Oneâ€™</li><li>ç¦ç”¨ç”¨äºé€šè¿‡ I2S æ¥å£è¿›è¡ŒéŸ³é¢‘æ’­æ”¾çš„ DSP AFE<br>tinymix â€˜PRI_MI2S_RX Audio Mixer MultiMedia1â€™ 0</li></ol><h5 id="8-2ã€tinyplay-capture"><a href="#8-2ã€tinyplay-capture" class="headerlink" title="8.2ã€tinyplay capture"></a>8.2ã€tinyplay capture</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/212-tiny-playback.png" alt="Alt text"></p><p>æœ‰æ—¶åºå›¾å¯çŸ¥ï¼šä¸»è¦æ¶‰åŠpcm_open()ã€pcm_read()ã€pcm_start()ã€‚</p><h5 id="8-2-1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶"><a href="#8-2-1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶" class="headerlink" title="8.2.1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶"></a>8.2.1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶</h5><ol><li>è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š<br>//Enable DSP AFE for Audio Recording over I2S<br>tinymix â€˜MultiMedia1 Mixer TERT_MI2S_TXâ€™ 1<br>//Enable Codec TX Path<br>tinymix â€˜DEC1 MUXâ€™ â€˜ADC2â€™<br>tinymix â€˜ADC2 MUXâ€™ â€˜INP2â€™</li><li>å¯åŠ¨å½•éŸ³åŠŸèƒ½ï¼š<br>tinycap /data/rec.wav</li><li>ç¦ç”¨ HeadsetX è®¾å¤‡ (AMIC2)ï¼š<br>tinymix â€˜MultiMedia1 Mixer TERT_MI2S_TXâ€™ 0<br>tinymix â€˜DEC1 MUXâ€™ â€˜ZEROâ€™<br>tinymix â€˜ADC2 MUXâ€™ â€˜ZEROâ€™</li></ol><h4 id="ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://zhuanlan.zhihu.com/p/27480328" target="_blank" rel="noopener">AndroidéŸ³é¢‘æ¨¡å—å¯åŠ¨æµç¨‹åˆ†æ</a><br><a href="https://zhuanlan.zhihu.com/jhuster" target="_blank" rel="noopener">Jhusterçš„ä¸“æ â€‹ AndroidéŸ³é¢‘å¼€å‘</a><br><a href="http://thinks.me/2016/09/13/audio_qcom_offload/" target="_blank" rel="noopener">é«˜é€šaudio offloadå­¦ä¹  | Thinking</a><br><a href="https://blog.csdn.net/droidphone/article/category/1118446" target="_blank" rel="noopener">DroidPhoneçš„ä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8866071" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„1-CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8982771" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„2-ASoc - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8995163" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„3-Pcm - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8999364" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„4-å£°å¡æ§åˆ¶ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59180272" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šé€»è¾‘è®¾å¤‡ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59170418" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šç‰©ç†é“¾è·¯ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/12812.html" target="_blank" rel="noopener">ä¸“æ ï¼šMultiMediaæ¡†æ¶æ€»ç»“(åŸºäº6.0æºç ) - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/60890534" target="_blank" rel="noopener">Android éŸ³é¢‘ç³»ç»Ÿï¼šä» AudioTrack åˆ° AudioFlinger - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/azloong/article/category/778492" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ALSA-Android Audio</a><br><a href="https://blog.csdn.net/azloong/article/category/777239" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ANDROIDéŸ³é¢‘ç³»ç»Ÿ</a><br><a href="https://winddoing.github.io/2017/07/10/audio_alsa/" target="_blank" rel="noopener">Audioé©±åŠ¨æ€»ç»“â€“ALSA | Winddoingâ€™s Blog</a><br><a href="http://www.cnblogs.com/muhe221/articles/4461543.html" target="_blank" rel="noopener">audio HAL - ç‰§ å¤© - åšå®¢å›­</a><br><a href="https://blog.csdn.net/xuesen_lin/article/category/1390680" target="_blank" rel="noopener">æ—å­¦æ£®çš„Androidä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">æ·±å…¥å‰–æAndroidéŸ³é¢‘ - CSDNåšå®¢Yangwen123</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">æ’­æ”¾æ¡†æ¶ - æ ‡ç­¾ - Tocy - åšå®¢å›­</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57415505" target="_blank" rel="noopener">Android-7.0-Nuplayeræ¦‚è¿° - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/56961370" target="_blank" rel="noopener">Android-7.0-Nuplayer-å¯åŠ¨æµç¨‹ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53386010" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-Nuplayerï¼ˆ1ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53397945" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-AHandler AMessage ALooper - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/category/6344583" target="_blank" rel="noopener">Android N Audioæ’­æ”¾ startçœŸé¢ç›®- (å…­ç¯‡) CSDNåšå®¢</a><br><a href="https://blog.csdn.net/nonmarking/article/details/78746671" target="_blank" rel="noopener">æ·±å…¥ç†è§£AndroidéŸ³è§†é¢‘åŒæ­¥æœºåˆ¶ï¼ˆäº”ç¯‡ï¼‰NuPlayerçš„avsyncé€»è¾‘ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/u014310046/article/category/6571854" target="_blank" rel="noopener">wangyfçš„ä¸“æ  - CSDNåšå®¢-MT6737 Android N å¹³å° Audioç³»ç»Ÿå­¦ä¹ </a><br><a href="https://blog.csdn.net/xiashaohua/article/details/53638780" target="_blank" rel="noopener">Android 7.0 Audio: Mediaplayer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/xiashaohua/article/category/6549668" target="_blank" rel="noopener">Android 7.0 Audio-ç›¸å…³ç±»æµ…æ- CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/details/59119144" target="_blank" rel="noopener">Android N Audioæ’­æ”¾å…­ï¼šå¦‚ä½•è¯»å–buffer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/78007568" target="_blank" rel="noopener">Fuchsia OSä¸­çš„RPCæœºåˆ¶-FIDL - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/linhaostudy/category/1145404.html" target="_blank" rel="noopener">é«˜é€šAudioä¸­ASOCçš„codecé©±åŠ¨ - yooooooo - åšå®¢å›­</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Audio Systemï¼ˆ1ï¼‰ï¼šLinux &amp;&amp; Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ</title>
    <link href="http://zhoujinjian.cc/2018/05/01/Audio%20System%EF%BC%881%EF%BC%89%EF%BC%9ALinux%20&amp;&amp;%20Android%20Audio%20%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/05/01/Audio Systemï¼ˆ1ï¼‰ï¼šLinux &amp;&amp; Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ/</id>
    <published>2018-04-30T16:00:00.000Z</published>
    <updated>2018-05-09T15:03:51.779Z</updated>
    
    <content type="html"><![CDATA[<hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/audio.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆKernel-3.18ï¼‰ï¼š<br> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆAndroid 7.1.2ï¼‰ï¼š<br> <a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><h4 id="ï¼ˆä¸€ï¼‰ã€éŸ³é¢‘åŸºç¡€çŸ¥è¯†"><a href="#ï¼ˆä¸€ï¼‰ã€éŸ³é¢‘åŸºç¡€çŸ¥è¯†" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€éŸ³é¢‘åŸºç¡€çŸ¥è¯†"></a>ï¼ˆä¸€ï¼‰ã€éŸ³é¢‘åŸºç¡€çŸ¥è¯†</h4><p>ç†è§£éŸ³é¢‘çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œå¯¹äºæˆ‘ä»¬åˆ†ææ•´ä¸ªéŸ³é¢‘ç³»ç»Ÿæ˜¯å¤§æœ‰è£¨ç›Šçš„ã€‚å®ƒå¯ä»¥è®©æˆ‘ä»¬ä»å®ç°çš„å±‚é¢å»æ€è€ƒï¼ŒéŸ³é¢‘ç³»ç»Ÿçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Œç„¶åæ‰æ˜¯æ€ä¹ˆæ ·å»å®Œæˆè¿™ä¸ªç›®çš„</p><p>#####ï¼ˆ1ï¼‰å£°éŸ³æœ‰å“ªäº›é‡è¦å±æ€§å‘¢ï¼Ÿ</p><h5 id="1-1ã€å“åº¦-Loudness"><a href="#1-1ã€å“åº¦-Loudness" class="headerlink" title="1.1ã€å“åº¦(Loudness)"></a>1.1ã€å“åº¦(Loudness)</h5><p>å“åº¦å°±æ˜¯äººç±»å¯ä»¥æ„ŸçŸ¥åˆ°çš„å„ç§å£°éŸ³çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯éŸ³ï¥¾ã€‚å“åº¦ä¸å£°æ³¢çš„æŒ¯å¹…æœ‰ç›´æ¥å…³ç³»ã€‚</p><h5 id="1-2ã€éŸ³è°ƒ-Pitch"><a href="#1-2ã€éŸ³è°ƒ-Pitch" class="headerlink" title="1.2ã€éŸ³è°ƒ(Pitch)"></a>1.2ã€éŸ³è°ƒ(Pitch)</h5><p>éŸ³è°ƒä¸å£°éŸ³çš„é¢‘ç‡æœ‰å…³ç³»ï¼Œå½“å£°éŸ³çš„é¢‘ç‡è¶Šå¤§æ—¶ï¼Œäººè€³æ‰€æ„ŸçŸ¥åˆ°çš„éŸ³è°ƒå°±è¶Šé«˜ï¼Œå¦åˆ™å°±è¶Šä½ã€‚</p><h5 id="1-3ã€éŸ³è‰²-Quality"><a href="#1-3ã€éŸ³è‰²-Quality" class="headerlink" title="1.3ã€éŸ³è‰²(Quality)"></a>1.3ã€éŸ³è‰²(Quality)</h5><p>åŒä¸€ç§ä¹å™¨ï¼Œä½¿ç”¨ï¥§åŒçš„æè´¨æ¥åˆ¶ä½œï¼Œæ‰€è¡¨ç°å‡ºæ¥çš„éŸ³è‰²æ•ˆæœæ˜¯ï¥§ä¸€æ ·çš„ï¼Œè¿™æ˜¯ç”±ç‰©ä½“æœ¬èº«çš„ç»“æ„ç‰¹æ€§æ‰€å†³å®šçš„ã€‚</p><p>å¦‚ä½•å°†å„ç§åª’ä½“æºæ•°å­—åŒ–å‘¢ï¼Ÿ<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/11-Audio-system-1024px-A-D-A_Flow.svg.png" alt="Alt text"></p><p>å°†å£°æ³¢æ³¢å½¢ä¿¡å·é€šè¿‡ADCè½¬æ¢æˆè®¡ç®—æœºæ”¯æŒçš„äºŒè¿›åˆ¶çš„è¿‡ç¨‹å«åšéŸ³é¢‘é‡‡æ ·(Audio Sampling)ã€‚é‡‡æ ·(Sampling)çš„æ ¸å¿ƒæ˜¯æŠŠè¿ç»­çš„æ¨¡æ‹Ÿä¿¡å·è½¬æ¢æˆç¦»æ•£çš„æ•°å­—ä¿¡å·ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/12-Audio-system-sampling.png" alt="Alt text"></p><h5 id="1-4ã€æ ·æœ¬-Sample"><a href="#1-4ã€æ ·æœ¬-Sample" class="headerlink" title="1.4ã€æ ·æœ¬(Sample)"></a>1.4ã€æ ·æœ¬(Sample)</h5><p>è¿™æ˜¯æˆ‘ä»¬è¿›è¡Œé‡‡æ ·çš„åˆå§‹èµ„æ–™ï¼Œæ¯”å¦‚ä¸€æ®µè¿ç»­çš„å£°éŸ³æ³¢å½¢ã€‚</p><h5 id="1-5ã€é‡‡æ ·å™¨-Sampler"><a href="#1-5ã€é‡‡æ ·å™¨-Sampler" class="headerlink" title="1.5ã€é‡‡æ ·å™¨(Sampler)"></a>1.5ã€é‡‡æ ·å™¨(Sampler)</h5><p>é‡‡æ ·å™¨æ˜¯å°†æ ·æœ¬è½¬æ¢æˆç»ˆæ€ä¿¡å·çš„å…³é”®ã€‚å®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå­ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥æŒ‡ä¸€ä¸ªæ“ä½œè¿‡ç¨‹ï¼Œç”šè‡³æ˜¯ä¸€ä¸ªç®—æ³•ï¼Œå–å†³äºä¸åŒçš„ä¿¡å·å¤„ç†åœºæ™¯ã€‚ç†æƒ³çš„é‡‡æ ·å™¨è¦æ±‚å°½å¯èƒ½ä¸äº§ç”Ÿä¿¡å·å¤±çœŸã€‚</p><h5 id="1-6ã€é‡åŒ–-Quantization"><a href="#1-6ã€é‡åŒ–-Quantization" class="headerlink" title="1.6ã€é‡åŒ–(Quantization)"></a>1.6ã€é‡åŒ–(Quantization)</h5><p>é‡‡æ ·åçš„å€¼è¿˜éœ€è¦é€šè¿‡é‡åŒ–ï¼Œä¹Ÿå°±æ˜¯å°†è¿ç»­å€¼è¿‘ä¼¼ä¸ºæŸä¸ªèŒƒå›´å†…æœ‰é™å¤šä¸ªç¦»æ•£å€¼çš„å¤„ç†è¿‡ç¨‹ã€‚å› ä¸ºåŸå§‹æ•°æ®æ˜¯æ¨¡æ‹Ÿçš„è¿ç»­ä¿¡å·ï¼Œè€Œæ•°å­—ä¿¡å·åˆ™æ˜¯ç¦»æ•£çš„ï¼Œå®ƒçš„è¡¨è¾¾èŒƒå›´æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥é‡åŒ–æ˜¯å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ã€‚</p><h5 id="1-7ã€ç¼–ç -Coding"><a href="#1-7ã€ç¼–ç -Coding" class="headerlink" title="1.7ã€ç¼–ç (Coding)"></a>1.7ã€ç¼–ç (Coding)</h5><p>è®¡ç®—æœºçš„ä¸–ç•Œé‡Œï¼Œæ‰€æœ‰æ•°å€¼éƒ½æ˜¯ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºçš„ï¼Œå› è€Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠé‡åŒ–å€¼è¿›è¡ŒäºŒè¿›åˆ¶ç¼–ç ã€‚è¿™ä¸€æ­¥é€šå¸¸ä¸é‡åŒ–åŒæ—¶è¿›è¡Œã€‚</p><h5 id="1-8ã€é‡‡æ ·ç‡ï¼ˆsamplerateï¼‰"><a href="#1-8ã€é‡‡æ ·ç‡ï¼ˆsamplerateï¼‰" class="headerlink" title="1.8ã€é‡‡æ ·ç‡ï¼ˆsamplerateï¼‰"></a>1.8ã€é‡‡æ ·ç‡ï¼ˆsamplerateï¼‰</h5><p>é‡‡æ ·å°±æ˜¯æŠŠæ¨¡æ‹Ÿä¿¡å·æ•°å­—åŒ–çš„è¿‡ç¨‹ï¼Œä¸ä»…ä»…æ˜¯éŸ³é¢‘éœ€è¦é‡‡æ ·ï¼Œæ‰€æœ‰çš„æ¨¡æ‹Ÿä¿¡å·éƒ½éœ€è¦é€šè¿‡é‡‡æ ·è½¬æ¢ä¸ºå¯ä»¥ç”¨0101æ¥è¡¨ç¤ºçš„æ•°å­—ä¿¡å·ï¼Œç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/13-Audio-system-sampling-rate.png.png" alt="Alt text"></p><p>è“è‰²ä»£è¡¨æ¨¡æ‹ŸéŸ³é¢‘ä¿¡å·ï¼Œçº¢è‰²çš„ç‚¹ä»£è¡¨é‡‡æ ·å¾—åˆ°çš„é‡åŒ–æ•°å€¼ã€‚</p><p>é‡‡æ ·é¢‘ç‡è¶Šé«˜ï¼Œçº¢è‰²çš„é—´éš”å°±è¶Šå¯†é›†ï¼Œè®°å½•è¿™ä¸€æ®µéŸ³é¢‘ä¿¡å·æ‰€ç”¨çš„æ•°æ®é‡å°±è¶Šå¤§ï¼ŒåŒæ—¶éŸ³é¢‘è´¨é‡ä¹Ÿå°±è¶Šé«˜ã€‚</p><p>æ ¹æ®å¥ˆå¥æ–¯ç‰¹ç†è®ºï¼Œé‡‡æ ·é¢‘ç‡åªè¦ä¸ä½äºéŸ³é¢‘ä¿¡å·æœ€é«˜é¢‘ç‡çš„ä¸¤å€ï¼Œå°±å¯ä»¥æ— æŸå¤±åœ°è¿˜åŸåŸå§‹çš„å£°éŸ³ã€‚</p><p>é€šå¸¸äººè€³èƒ½å¬åˆ°é¢‘ç‡èŒƒå›´å¤§çº¦åœ¨20Hzï½20kHzä¹‹é—´çš„å£°éŸ³ï¼Œä¸ºäº†ä¿è¯å£°éŸ³ä¸å¤±çœŸï¼Œé‡‡æ ·é¢‘ç‡åº”åœ¨40kHzä»¥ä¸Šã€‚å¸¸ç”¨çš„éŸ³é¢‘é‡‡æ ·é¢‘ç‡æœ‰ï¼š8kHzã€11.025kHzã€22.05kHzã€16kHzã€37.8kHzã€44.1kHzã€48kHzã€96kHzã€192kHzç­‰ã€‚</p><h5 id="1-9ã€é‡åŒ–ç²¾åº¦ï¼ˆä½å®½ï¼‰"><a href="#1-9ã€é‡åŒ–ç²¾åº¦ï¼ˆä½å®½ï¼‰" class="headerlink" title="1.9ã€é‡åŒ–ç²¾åº¦ï¼ˆä½å®½ï¼‰"></a>1.9ã€é‡åŒ–ç²¾åº¦ï¼ˆä½å®½ï¼‰</h5><p>ä¸Šå›¾ï¼ˆ1.8ï¼‰ä¸­ï¼Œæ¯ä¸€ä¸ªçº¢è‰²çš„é‡‡æ ·ç‚¹ï¼Œéƒ½éœ€è¦ç”¨ä¸€ä¸ªæ•°å€¼æ¥è¡¨ç¤ºå¤§å°ï¼Œè¿™ä¸ªæ•°å€¼çš„æ•°æ®ç±»å‹å¤§å°å¯ä»¥æ˜¯ï¼š4bitã€8bitã€16bitã€32bitç­‰ç­‰ï¼Œä½æ•°è¶Šå¤šï¼Œè¡¨ç¤ºå¾—å°±è¶Šç²¾ç»†ï¼Œå£°éŸ³è´¨é‡è‡ªç„¶å°±è¶Šå¥½ï¼Œå½“ç„¶ï¼Œæ•°æ®é‡ä¹Ÿä¼šæˆå€å¢å¤§ã€‚</p><p>å¸¸è§çš„ä½å®½æ˜¯ï¼š8bit æˆ–è€… 16bit</p><h5 id="1-10ã€-å£°é“æ•°ï¼ˆchannelsï¼‰"><a href="#1-10ã€-å£°é“æ•°ï¼ˆchannelsï¼‰" class="headerlink" title="1.10ã€ å£°é“æ•°ï¼ˆchannelsï¼‰"></a>1.10ã€ å£°é“æ•°ï¼ˆchannelsï¼‰</h5><p>ç”±äºéŸ³é¢‘çš„é‡‡é›†å’Œæ’­æ”¾æ˜¯å¯ä»¥å åŠ çš„ï¼Œå› æ­¤ï¼Œå¯ä»¥åŒæ—¶ä»å¤šä¸ªéŸ³é¢‘æºé‡‡é›†å£°éŸ³ï¼Œå¹¶åˆ†åˆ«è¾“å‡ºåˆ°ä¸åŒçš„æ‰¬å£°å™¨ï¼Œæ•…å£°é“æ•°ä¸€èˆ¬è¡¨ç¤ºå£°éŸ³å½•åˆ¶æ—¶çš„éŸ³æºæ•°é‡æˆ–å›æ”¾æ—¶ç›¸åº”çš„æ‰¬å£°å™¨æ•°é‡ã€‚</p><p>å•å£°é“ï¼ˆMonoï¼‰å’ŒåŒå£°é“ï¼ˆStereoï¼‰æ¯”è¾ƒå¸¸è§ï¼Œé¡¾åæ€ä¹‰ï¼Œå‰è€…çš„å£°é“æ•°ä¸º1ï¼Œåè€…ä¸º2</p><h5 id="1-11ã€éŸ³é¢‘å¸§ï¼ˆframeï¼‰"><a href="#1-11ã€éŸ³é¢‘å¸§ï¼ˆframeï¼‰" class="headerlink" title="1.11ã€éŸ³é¢‘å¸§ï¼ˆframeï¼‰"></a>1.11ã€éŸ³é¢‘å¸§ï¼ˆframeï¼‰</h5><p>è¿™ä¸ªæ¦‚å¿µåœ¨åº”ç”¨å¼€å‘ä¸­éå¸¸é‡è¦ï¼Œç½‘ä¸Šå¾ˆå¤šæ–‡ç« éƒ½æ²¡æœ‰ä¸“é—¨ä»‹ç»è¿™ä¸ªæ¦‚å¿µã€‚</p><p>éŸ³é¢‘è·Ÿè§†é¢‘å¾ˆä¸ä¸€æ ·ï¼Œè§†é¢‘æ¯ä¸€å¸§å°±æ˜¯ä¸€å¼ å›¾åƒï¼Œè€Œä»ä¸Šé¢çš„æ­£ç„æ³¢å¯ä»¥çœ‹å‡ºï¼ŒéŸ³é¢‘æ•°æ®æ˜¯æµå¼çš„ï¼Œæœ¬èº«æ²¡æœ‰æ˜ç¡®çš„ä¸€å¸§å¸§çš„æ¦‚å¿µï¼Œåœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œä¸ºäº†éŸ³é¢‘ç®—æ³•å¤„ç†/ä¼ è¾“çš„æ–¹ä¾¿ï¼Œä¸€èˆ¬çº¦å®šä¿—æˆå–2.5ms~60msä¸ºå•ä½çš„æ•°æ®é‡ä¸ºä¸€å¸§éŸ³é¢‘ã€‚</p><p>è¿™ä¸ªæ—¶é—´è¢«ç§°ä¹‹ä¸ºâ€œé‡‡æ ·æ—¶é—´â€ï¼Œå…¶é•¿åº¦æ²¡æœ‰ç‰¹åˆ«çš„æ ‡å‡†ï¼Œå®ƒæ˜¯æ ¹æ®ç¼–è§£ç å™¨å’Œå…·ä½“åº”ç”¨çš„éœ€æ±‚æ¥å†³å®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—ä¸€ä¸‹ä¸€å¸§éŸ³é¢‘å¸§çš„å¤§å°ï¼š</p><p>å‡è®¾æŸéŸ³é¢‘ä¿¡å·æ˜¯é‡‡æ ·ç‡ä¸º8kHzã€åŒé€šé“ã€ä½å®½ä¸º16bitï¼Œ20msä¸€å¸§ï¼Œåˆ™ä¸€å¸§éŸ³é¢‘æ•°æ®çš„å¤§å°ä¸ºï¼š</p><p>int size = 8000 x 2 x 16bit x 0.02s = 5120 bit = 640 byte</p><h5 id="1-12ã€å¸¸è§çš„éŸ³é¢‘ç¼–ç æ–¹å¼æœ‰å“ªäº›ï¼Ÿ"><a href="#1-12ã€å¸¸è§çš„éŸ³é¢‘ç¼–ç æ–¹å¼æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="1.12ã€å¸¸è§çš„éŸ³é¢‘ç¼–ç æ–¹å¼æœ‰å“ªäº›ï¼Ÿ"></a>1.12ã€å¸¸è§çš„éŸ³é¢‘ç¼–ç æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</h5><p>ä¸Šé¢æåˆ°è¿‡ï¼Œæ¨¡æ‹Ÿçš„éŸ³é¢‘ä¿¡å·è½¬æ¢ä¸ºæ•°å­—ä¿¡å·éœ€è¦ç»è¿‡é‡‡æ ·å’Œé‡åŒ–ï¼Œé‡åŒ–çš„è¿‡ç¨‹è¢«ç§°ä¹‹ä¸ºç¼–ç ï¼Œæ ¹æ®ä¸åŒçš„é‡åŒ–ç­–ç•¥ï¼Œäº§ç”Ÿäº†è®¸å¤šä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œå¸¸è§çš„ç¼–ç æ–¹å¼æœ‰ï¼šPCM å’Œ ADPCMï¼Œè¿™äº›æ•°æ®ä»£è¡¨ç€æ— æŸçš„åŸå§‹æ•°å­—éŸ³é¢‘ä¿¡å·ï¼Œæ·»åŠ ä¸€äº›æ–‡ä»¶å¤´ä¿¡æ¯ï¼Œå°±å¯ä»¥å­˜å‚¨ä¸ºWAVæ–‡ä»¶äº†ï¼Œå®ƒæ˜¯ä¸€ç§ç”±å¾®è½¯å’ŒIBMè”åˆå¼€å‘çš„ç”¨äºéŸ³é¢‘æ•°å­—å­˜å‚¨çš„æ ‡å‡†ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°è¢«è§£æå’Œæ’­æ”¾ã€‚</p><p>æˆ‘ä»¬åœ¨éŸ³é¢‘å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼šç»å¸¸æ¶‰åŠåˆ°WAVæ–‡ä»¶çš„è¯»å†™ï¼Œä»¥éªŒè¯é‡‡é›†ã€ä¼ è¾“ã€æ¥æ”¶çš„éŸ³é¢‘æ•°æ®çš„æ­£ç¡®æ€§ã€‚</p><h5 id="1-13ã€å¸¸è§çš„éŸ³é¢‘å‹ç¼©æ ¼å¼æœ‰å“ªäº›ï¼Ÿ"><a href="#1-13ã€å¸¸è§çš„éŸ³é¢‘å‹ç¼©æ ¼å¼æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="1.13ã€å¸¸è§çš„éŸ³é¢‘å‹ç¼©æ ¼å¼æœ‰å“ªäº›ï¼Ÿ"></a>1.13ã€å¸¸è§çš„éŸ³é¢‘å‹ç¼©æ ¼å¼æœ‰å“ªäº›ï¼Ÿ</h5><p>é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹éŸ³é¢‘æ•°æ®å‹ç¼©çš„æœ€åŸºæœ¬çš„åŸç†ï¼šå› ä¸ºæœ‰å†—ä½™ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥å‹ç¼©ã€‚</p><p>ï¼ˆ1ï¼‰ é¢‘è°±æ©è”½æ•ˆåº”ï¼š äººè€³æ‰€èƒ½å¯Ÿè§‰çš„å£°éŸ³ä¿¡å·çš„é¢‘ç‡èŒƒå›´ä¸º20Hzï½20KHzï¼Œåœ¨è¿™ä¸ªé¢‘ç‡èŒƒå›´ä»¥å¤–çš„éŸ³é¢‘ä¿¡å·å±äºå†—ä½™ä¿¡å·ã€‚</p><p>ï¼ˆ2ï¼‰ æ—¶åŸŸæ©è”½æ•ˆåº”ï¼š å½“å¼ºéŸ³ä¿¡å·å’Œå¼±éŸ³ä¿¡å·åŒæ—¶å‡ºç°æ—¶ï¼Œå¼±ä¿¡å·ä¼šå¬ä¸åˆ°ï¼Œå› æ­¤ï¼Œå¼±éŸ³ä¿¡å·ä¹Ÿå±äºå†—ä½™ä¿¡å·ã€‚</p><p>ä¸‹é¢ç®€å•åˆ—å‡ºå¸¸è§çš„éŸ³é¢‘å‹ç¼©æ ¼å¼ï¼š</p><p>MP3ï¼ŒAACï¼ŒOGGï¼ŒWMAï¼ŒOpusï¼ŒFLACï¼ŒAPEï¼ŒM4Aï¼ŒAMRï¼Œç­‰ç­‰</p><h5 id="1-14ã€å¥ˆå¥æ–¯ç‰¹é‡‡æ ·ç†è®º"><a href="#1-14ã€å¥ˆå¥æ–¯ç‰¹é‡‡æ ·ç†è®º" class="headerlink" title="1.14ã€å¥ˆå¥æ–¯ç‰¹é‡‡æ ·ç†è®º"></a>1.14ã€å¥ˆå¥æ–¯ç‰¹é‡‡æ ·ç†è®º</h5><p>â€œå½“å¯¹è¢«é‡‡æ ·çš„æ¨¡æ‹Ÿä¿¡å·è¿›è¡Œè¿˜åŸæ—¶ï¼Œå…¶æœ€é«˜é¢‘ç‡åªæœ‰é‡‡æ ·é¢‘ç‡çš„ä¸€åŠâ€ã€‚<br>æ¢å¥è¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬è¦å®Œæ•´é‡æ„åŸå§‹çš„æ¨¡æ‹Ÿä¿¡å·ï¼Œåˆ™é‡‡æ ·é¢‘ç‡å°±å¿…é¡»æ˜¯å®ƒçš„ä¸¤å€ä»¥ä¸Šã€‚æ¯”å¦‚äººçš„å£°éŸ³èŒƒå›´æ˜¯2~ 20kHZ,é‚£ä¹ˆé€‰æ‹©çš„é‡‡æ ·é¢‘ç‡å°±åº”è¯¥åœ¨40kHZå·¦å³ï¼Œæ•°å€¼å¤ªå°åˆ™å£°éŸ³å°†äº§ç”Ÿå¤±çœŸç°è±¡ï¼Œè€Œæ•°å€¼å¤ªå¤§ä¹Ÿæ— æ³•æ˜æ˜¾æå‡äººè€³æ‰€èƒ½æ„ŸçŸ¥çš„éŸ³è´¨ã€‚</p><h5 id="1-15ã€æ€»ç»“ï¼ˆéŸ³é¢‘å¤„ç†å’Œæ’­æ”¾è¿‡ç¨‹ï¼‰ï¼š"><a href="#1-15ã€æ€»ç»“ï¼ˆéŸ³é¢‘å¤„ç†å’Œæ’­æ”¾è¿‡ç¨‹ï¼‰ï¼š" class="headerlink" title="1.15ã€æ€»ç»“ï¼ˆéŸ³é¢‘å¤„ç†å’Œæ’­æ”¾è¿‡ç¨‹ï¼‰ï¼š"></a>1.15ã€æ€»ç»“ï¼ˆéŸ³é¢‘å¤„ç†å’Œæ’­æ”¾è¿‡ç¨‹ï¼‰ï¼š</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/14-Audio-system-how-audio-works.png" alt="Alt text"></p><h4 id="ï¼ˆäºŒï¼‰ã€Audio-ç³»ç»Ÿæ¡†æ¶"><a href="#ï¼ˆäºŒï¼‰ã€Audio-ç³»ç»Ÿæ¡†æ¶" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Audio ç³»ç»Ÿæ¡†æ¶"></a>ï¼ˆäºŒï¼‰ã€Audio ç³»ç»Ÿæ¡†æ¶</h4><h5 id="æ€»ä½“Audioæ¡†æ¶å›¾"><a href="#æ€»ä½“Audioæ¡†æ¶å›¾" class="headerlink" title="æ€»ä½“Audioæ¡†æ¶å›¾"></a>æ€»ä½“Audioæ¡†æ¶å›¾</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/15-Audio-system-Android-Linux-arc.png" alt="Alt text"></p><h5 id="2-1ã€APP"><a href="#2-1ã€APP" class="headerlink" title="2.1ã€APP"></a>2.1ã€APP</h5><p>éŸ³ä¹æ’­æ”¾å™¨è½¯ä»¶ç­‰ç­‰ã€‚</p><h5 id="2-2ã€Framework"><a href="#2-2ã€Framework" class="headerlink" title="2.2ã€Framework"></a>2.2ã€Framework</h5><p>Androidä¹Ÿæä¾›äº†å¦ä¸¤ä¸ªç›¸ä¼¼åŠŸèƒ½çš„ç±»ï¼Œå³AudioTrackå’ŒAudioRecorderï¼ŒMediaPlayerServiceå†…éƒ¨çš„å®ç°å°±æ˜¯é€šè¿‡å®ƒä»¬æ¥å®Œæˆçš„,åªä¸è¿‡MediaPlayer/MediaRecorderæä¾›äº†æ›´å¼ºå¤§çš„æ§åˆ¶åŠŸèƒ½ï¼Œç›¸æ¯”å‰è€…ä¹Ÿæ›´æ˜“äºä½¿ç”¨ã€‚é™¤æ­¤ä»¥å¤–ï¼ŒAndroidç³»ç»Ÿè¿˜ä¸ºæˆ‘ä»¬æ§åˆ¶éŸ³é¢‘ç³»ç»Ÿæä¾›äº†AudioManagerã€AudioServiceåŠAudioSystemç±»ã€‚è¿™äº›éƒ½æ˜¯frameworkä¸ºä¾¿åˆ©ä¸Šå±‚åº”ç”¨å¼€å‘æ‰€è®¾è®¡çš„ã€‚</p><h5 id="2-3ã€Libraries"><a href="#2-3ã€Libraries" class="headerlink" title="2.3ã€Libraries"></a>2.3ã€Libraries</h5><p>frameworkåªæ˜¯å‘åº”ç”¨ç¨‹åºæä¾›è®¿é—®Androidåº“çš„æ¡¥æ¢ï¼Œå…·ä½“åŠŸèƒ½å®ç°æ”¾åœ¨åº“ä¸­å®Œæˆã€‚æ¯”å¦‚ä¸Šé¢çš„AudioTrackã€AudioRecorderã€MediaPlayerå’ŒMediaRecorderç­‰ç­‰åœ¨åº“ä¸­éƒ½èƒ½æ‰¾åˆ°ç›¸å¯¹åº”çš„ç±»ã€‚</p><p>1ã€frameworks/av/media/libmediaã€libmedia.soã€‘<br>2ã€frameworks/av/services/audioflingerã€libaudioflinger.soã€‘<br>3ã€frameworks/av/media/libmediaplayerserviceã€libmediaplayerservice.soã€‘</p><h5 id="2-4ã€HAL"><a href="#2-4ã€HAL" class="headerlink" title="2.4ã€HAL"></a>2.4ã€HAL</h5><p>ä»è®¾è®¡ä¸Šæ¥çœ‹ï¼Œç¡¬ä»¶æŠ½è±¡å±‚æ˜¯AudioFlingerç›´æ¥è®¿é—®çš„å¯¹è±¡ã€‚è¿™è¯´æ˜äº†ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€æ–¹é¢AudioFlingerå¹¶ä¸ç›´æ¥è°ƒç”¨åº•å±‚çš„é©±åŠ¨ç¨‹åº;å¦ä¸€æ–¹é¢ï¼ŒAudioFlingerä¸Šå±‚æ¨¡å—åªéœ€è¦ä¸å®ƒè¿›è¡Œäº¤äº’å°±å¯ä»¥å®ç°éŸ³é¢‘ç›¸å…³çš„åŠŸèƒ½äº†ã€‚å› è€Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºAudioFlingeræ˜¯AndroidéŸ³é¢‘ç³»ç»Ÿä¸­çœŸæ­£çš„â€œéš”ç¦»æ¿â€ï¼Œæ— è®ºä¸‹é¢å¦‚ä½•å˜åŒ–ï¼Œä¸Šå±‚çš„å®ç°éƒ½å¯ä»¥ä¿æŒå…¼å®¹ã€‚</p><p>éŸ³é¢‘æ–¹é¢çš„ç¡¬ä»¶æŠ½è±¡å±‚ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå³AudioFlingerå’ŒAudioPolicyServiceã€‚å®é™…ä¸Šåè€…å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸå®çš„è®¾å¤‡ï¼Œåªæ˜¯é‡‡ç”¨è™šæ‹Ÿè®¾å¤‡çš„æ–¹å¼æ¥è®©å‚å•†å¯ä»¥æ–¹ä¾¿åœ°å®šåˆ¶å‡ºè‡ªå·±çš„ç­–ç•¥ã€‚æŠ½è±¡å±‚çš„ä»»åŠ¡æ˜¯å°†AudioFlinger/AudioPolicyServiceçœŸæ­£åœ°ä¸ç¡¬ä»¶è®¾å¤‡å…³è”èµ·æ¥ï¼Œä½†åˆå¿…é¡»æä¾›çµæ´»çš„ç»“æ„æ¥åº”å¯¹å˜åŒ–â€”â€”ç‰¹åˆ«æ˜¯å¯¹äºAndroidè¿™ä¸ªæ›´æ–°ç›¸å½“é¢‘ç¹çš„ç³»ç»Ÿã€‚æ¯”å¦‚ä»¥å‰Androidç³»ç»Ÿä¸­çš„Audioç³»ç»Ÿä¾èµ–äºALSA-libï¼Œä½†åæœŸå°±å˜ä¸ºäº†tinyalsaï¼Œè¿™æ ·çš„è½¬å˜ä¸åº”è¯¥å¯¹ä¸Šå±‚é€ æˆç ´åã€‚å› è€ŒAudio HALæä¾›äº†ç»Ÿä¸€çš„æ¥å£æ¥å®šä¹‰å®ƒä¸AudioFlinger/AudioPolicyServiceä¹‹é—´çš„é€šä¿¡æ–¹å¼ï¼Œè¿™å°±æ˜¯audio_hw_deviceã€audio_stream_inåŠaudio_stream_outç­‰ç­‰å­˜åœ¨çš„ç›®çš„ï¼Œè¿™äº›Structæ•°æ®ç±»å‹å†…éƒ¨å¤§å¤šåªæ˜¯å‡½æ•°æŒ‡é’ˆçš„å®šä¹‰ï¼Œæ˜¯ä¸€äº›â€œå£³â€ã€‚å½“AudioFlinger/AudioPolicyServiceåˆå§‹åŒ–æ—¶ï¼Œå®ƒä»¬ä¼šå»å¯»æ‰¾ç³»ç»Ÿä¸­æœ€åŒ¹é…çš„å®ç°(è¿™äº›å®ç°é©»ç•™åœ¨ä»¥audio.primary.<em>,audio.a2dp.</em>ä¸ºåçš„å„ç§åº“ä¸­)æ¥å¡«å……è¿™äº›â€œå£³â€ã€‚æ ¹æ®äº§å“çš„ä¸åŒï¼ŒéŸ³é¢‘è®¾å¤‡å­˜åœ¨å¾ˆå¤§å·®å¼‚ï¼Œåœ¨Androidçš„éŸ³é¢‘æ¶æ„ä¸­ï¼Œè¿™äº›é—®é¢˜éƒ½æ˜¯ç”±HALå±‚çš„audio.primaryç­‰ç­‰åº“æ¥è§£å†³çš„ï¼Œè€Œä¸éœ€è¦å¤§è§„æ¨¡åœ°ä¿®æ”¹ä¸Šå±‚å®ç°ã€‚æ¢å¥è¯è¯´ï¼Œå‚å•†åœ¨å®šåˆ¶æ—¶çš„é‡ç‚¹å°±æ˜¯å¦‚ä½•æä¾›è¿™éƒ¨åˆ†åº“çš„é«˜æ•ˆå®ç°äº†ã€‚</p><h5 id="2-5ã€Tinyalsa"><a href="#2-5ã€Tinyalsa" class="headerlink" title="2.5ã€Tinyalsa"></a>2.5ã€Tinyalsa</h5><p>æºç åœ¨external/tinyalsaç›®å½•ä¸‹<br>Tinyalsaï¼štinyplay/tinycap/tinymixï¼Œè¿™äº›ç”¨æˆ·ç¨‹åºç›´æ¥è°ƒç”¨ alsa ç”¨æˆ·åº“æ¥å£æ¥å®ç°æ”¾éŸ³ã€å½•éŸ³ã€æ§åˆ¶</p><h5 id="2-6ã€Kerneléƒ¨åˆ†"><a href="#2-6ã€Kerneléƒ¨åˆ†" class="headerlink" title="2.6ã€Kerneléƒ¨åˆ†"></a>2.6ã€Kerneléƒ¨åˆ†</h5><h5 id="2-6-1ã€ALSA-å’Œ-ASoC"><a href="#2-6-1ã€ALSA-å’Œ-ASoC" class="headerlink" title="2.6.1ã€ALSA å’Œ ASoC"></a>2.6.1ã€ALSA å’Œ ASoC</h5><p>Native ALSA Applicationï¼štinyplay/tinycap/tinymixï¼Œè¿™äº›ç”¨æˆ·ç¨‹åºç›´æ¥è°ƒç”¨ alsa ç”¨æˆ·åº“æ¥å£æ¥å®ç°æ”¾éŸ³ã€å½•éŸ³ã€æ§åˆ¶<br>ALSA Library APIï¼šalsa ç”¨æˆ·åº“æ¥å£ï¼Œå¸¸è§æœ‰ tinyalsaã€alsa-lib<br>ALSA COREï¼šalsa æ ¸å¿ƒå±‚ï¼Œå‘ä¸Šæä¾›é€»è¾‘è®¾å¤‡ï¼ˆPCM/CTL/MIDI/TIMER/â€¦ï¼‰ç³»ç»Ÿè°ƒç”¨ï¼Œå‘ä¸‹é©±åŠ¨ç¡¬ä»¶è®¾å¤‡ï¼ˆMachine/I2S/DMA/CODECï¼‰<br>ASoC COREï¼šasoc æ˜¯å»ºç«‹åœ¨æ ‡å‡† alsa core åŸºç¡€ä¸Šï¼Œä¸ºäº†æ›´å¥½æ”¯æŒåµŒå…¥å¼ç³»ç»Ÿå’Œåº”ç”¨äºç§»åŠ¨è®¾å¤‡çš„éŸ³é¢‘ codec çš„ä¸€å¥—è½¯ä»¶ä½“ç³»<br>Hardware Driverï¼šéŸ³é¢‘ç¡¬ä»¶è®¾å¤‡é©±åŠ¨ï¼Œç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ Machineã€Platformã€Codec</p><h5 id="2-6-2ã€ASoC"><a href="#2-6-2ã€ASoC" class="headerlink" title="2.6.2ã€ASoC"></a>2.6.2ã€ASoC</h5><p>ASoCè¢«åˆ†ä¸ºMachineã€Platformå’ŒCodecä¸‰å¤§éƒ¨åˆ†ã€‚å…¶ä¸­çš„Machineé©±åŠ¨è´Ÿè´£Platformå’ŒCodecä¹‹é—´çš„è€¦åˆå’Œè®¾å¤‡æˆ–æ¿å­ç‰¹å®šçš„ä»£ç ã€‚Platformé©±åŠ¨çš„ä¸»è¦ä½œç”¨æ˜¯å®ŒæˆéŸ³é¢‘æ•°æ®çš„ç®¡ç†ï¼Œæœ€ç»ˆé€šè¿‡CPUçš„æ•°å­—éŸ³é¢‘æ¥å£ï¼ˆDAIï¼‰æŠŠéŸ³é¢‘æ•°æ®ä¼ é€ç»™Codecè¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆç”±Codecè¾“å‡ºé©±åŠ¨è€³æœºæˆ–è€…æ˜¯å–‡å­çš„éŸ³ä¿¡ä¿¡å·ã€‚</p><h5 id="2-6-2-1ã€Machine"><a href="#2-6-2-1ã€Machine" class="headerlink" title="2.6.2.1ã€Machine"></a>2.6.2.1ã€<strong>Machine</strong></h5><p>ç”¨äºæè¿°è®¾å¤‡ç»„ä»¶ä¿¡æ¯å’Œç‰¹å®šçš„æ§åˆ¶å¦‚è€³æœº/å¤–æ”¾ç­‰ã€‚</p><blockquote><p>æ˜¯æŒ‡æŸä¸€æ¬¾æœºå™¨ï¼Œå¯ä»¥æ˜¯æŸæ¬¾è®¾å¤‡ï¼ŒæŸæ¬¾å¼€å‘æ¿ï¼Œåˆæˆ–è€…æ˜¯æŸæ¬¾æ™ºèƒ½æ‰‹æœºï¼Œç”±æ­¤å¯ä»¥çœ‹å‡ºMachineå‡ ä¹æ˜¯ä¸å¯é‡ç”¨çš„ï¼Œæ¯ä¸ªMachineä¸Šçš„ç¡¬ä»¶å®ç°å¯èƒ½éƒ½ä¸ä¸€æ ·ï¼ŒCPUä¸ä¸€æ ·ï¼ŒCodecä¸ä¸€æ ·ï¼ŒéŸ³é¢‘çš„è¾“å…¥ã€è¾“å‡ºè®¾å¤‡ä¹Ÿä¸ä¸€æ ·ï¼ŒMachineä¸ºCPUã€Codecã€è¾“å…¥è¾“å‡ºè®¾å¤‡æä¾›äº†ä¸€ä¸ªè½½ä½“ã€‚</p></blockquote><p>è¿™ä¸€éƒ¨åˆ†å°†å¹³å°é©±åŠ¨å’ŒCodecé©±åŠ¨ç»‘å®šåœ¨ä¸€èµ·ï¼Œæè¿°äº†æ¿çº§çš„ç¡¬ä»¶ç‰¹å¾ã€‚ä¸»è¦è´Ÿè´£Platformå’ŒCodecä¹‹é—´çš„è€¦åˆä»¥åŠéƒ¨åˆ†å’Œè®¾å¤‡æˆ–æ¿å­ç‰¹å®šçš„ä»£ç ã€‚Machineé©±åŠ¨è´Ÿè´£å¤„ç†æœºå™¨ç‰¹æœ‰çš„ä¸€äº›æ§ä»¶å’ŒéŸ³é¢‘äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼Œå½“æ’­æ”¾éŸ³é¢‘æ—¶ï¼Œéœ€è¦å…ˆè¡Œæ‰“å¼€ä¸€ä¸ªæ”¾å¤§å™¨ï¼‰ï¼›å•ç‹¬çš„Platformå’ŒCodecé©±åŠ¨æ˜¯ä¸èƒ½å·¥ä½œçš„ï¼Œå®ƒå¿…é¡»ç”±Machineé©±åŠ¨æŠŠå®ƒä»¬ç»“åˆåœ¨ä¸€èµ·æ‰èƒ½å®Œæˆæ•´ä¸ªè®¾å¤‡çš„éŸ³é¢‘å¤„ç†å·¥ä½œã€‚ASoCçš„ä¸€åˆ‡éƒ½ä»Machineé©±åŠ¨å¼€å§‹ï¼ŒåŒ…æ‹¬å£°å¡çš„æ³¨å†Œï¼Œç»‘å®šPlatformå’ŒCodecé©±åŠ¨ç­‰ç­‰</p><h5 id="2-6-2-2ã€Platform"><a href="#2-6-2-2ã€Platform" class="headerlink" title="2.6.2.2ã€Platform"></a>2.6.2.2ã€<strong>Platform</strong></h5><p>ç”¨äºå®ç°å¹³å°ç›¸å…³çš„DMAé©±åŠ¨å’ŒéŸ³é¢‘æ¥å£ç­‰ã€‚</p><blockquote><p>ä¸€èˆ¬æ˜¯æŒ‡æŸä¸€ä¸ªSoCå¹³å°ï¼Œæ¯”å¦‚pxaxxx,s3cxxxx,omapxxxç­‰ç­‰ï¼Œä¸éŸ³é¢‘ç›¸å…³çš„é€šå¸¸åŒ…å«è¯¥SoCä¸­çš„æ—¶é’Ÿã€DMAã€I2Sã€PCMç­‰ç­‰ï¼Œåªè¦æŒ‡å®šäº†SoCï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®¤ä¸ºå®ƒä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„Platformï¼Œå®ƒåªä¸SoCç›¸å…³ï¼Œä¸Machineæ— å…³ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŠŠPlatformæŠ½è±¡å‡ºæ¥ï¼Œä½¿å¾—åŒä¸€æ¬¾SoCä¸ç”¨åšä»»ä½•çš„æ”¹åŠ¨ï¼Œå°±å¯ä»¥ç”¨åœ¨ä¸åŒçš„Machineä¸­ã€‚å®é™…ä¸Šï¼ŒæŠŠPlatformè®¤ä¸ºæ˜¯æŸä¸ªSoCæ›´å¥½ç†è§£ã€‚</p></blockquote><p>è¿™ä¸€éƒ¨åˆ†åªå…³å¿ƒCPUæœ¬èº«ï¼Œä¸å…³å¿ƒCodecã€‚ä¸»è¦å¤„ç†ä¸¤ä¸ªé—®é¢˜ï¼šDMAå¼•æ“å’ŒSoCé›†æˆçš„PCMã€I2Sæˆ–AC â€˜97æ•°å­—æ¥å£æ§åˆ¶ã€‚ä¸»è¦ä½œç”¨æ˜¯å®ŒæˆéŸ³é¢‘æ•°æ®çš„ç®¡ç†ï¼Œæœ€ç»ˆé€šè¿‡CPUçš„æ•°å­—éŸ³é¢‘æ¥å£ï¼ˆDAIï¼‰æŠŠéŸ³é¢‘æ•°æ®ä¼ é€ç»™Codecè¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆç”±Codecè¾“å‡ºé©±åŠ¨è€³æœºæˆ–è€…æ˜¯å–‡å­çš„éŸ³ä¿¡ä¿¡å·ã€‚åœ¨å…·ä½“å®ç°ä¸Šï¼ŒASoCæœ‰æŠŠPlatformé©±åŠ¨åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šsnd_soc_platform_driverå’Œsnd_soc_dai_driverã€‚å…¶ä¸­ï¼Œplatform_driverè´Ÿè´£ç®¡ç†éŸ³é¢‘æ•°æ®ï¼ŒæŠŠéŸ³é¢‘æ•°æ®é€šè¿‡dmaæˆ–å…¶ä»–æ“ä½œä¼ é€è‡³cpu daiä¸­ï¼Œdai_driveråˆ™ä¸»è¦å®Œæˆcpuä¸€ä¾§çš„daiçš„å‚æ•°é…ç½®ï¼ŒåŒæ—¶ä¹Ÿä¼šé€šè¿‡ä¸€å®šçš„é€”å¾„æŠŠå¿…è¦çš„dmaç­‰å‚æ•°ä¸snd_soc_platform_driverè¿›è¡Œäº¤äº’ã€‚</p><h5 id="2-6-2-3ã€Codec"><a href="#2-6-2-3ã€Codec" class="headerlink" title="2.6.2.3ã€Codec"></a>2.6.2.3ã€<strong>Codec</strong></h5><p>ç”¨äºå®ç°å¹³å°æ— å…³çš„åŠŸèƒ½ï¼Œå¦‚å¯„å­˜å™¨è¯»å†™æ¥å£ï¼ŒéŸ³é¢‘æ¥å£ï¼Œå„widgetsçš„æ§åˆ¶æ¥å£å’ŒDAPMçš„å®ç°ç­‰</p><blockquote><p>å­—é¢ä¸Šçš„æ„æ€å°±æ˜¯ç¼–è§£ç å™¨ï¼ŒCodecé‡Œé¢åŒ…å«äº†I2Sæ¥å£ã€D/Aã€A/Dã€Mixerã€PAï¼ˆåŠŸæ”¾ï¼‰ï¼Œé€šå¸¸åŒ…å«å¤šç§è¾“å…¥ï¼ˆMicã€Line-inã€I2Sã€PCMï¼‰å’Œå¤šä¸ªè¾“å‡ºï¼ˆè€³æœºã€å–‡å­ã€å¬ç­’ï¼ŒLine-outï¼‰ï¼ŒCodecå’ŒPlatformä¸€æ ·ï¼Œæ˜¯å¯é‡ç”¨çš„éƒ¨ä»¶ï¼ŒåŒä¸€ä¸ªCodecå¯ä»¥è¢«ä¸åŒçš„Machineä½¿ç”¨ã€‚åµŒå…¥å¼Codecé€šå¸¸é€šè¿‡I2Cå¯¹å†…éƒ¨çš„å¯„å­˜å™¨è¿›è¡Œæ§åˆ¶ã€‚</p></blockquote><p>è¿™ä¸€éƒ¨åˆ†åªå…³å¿ƒCodecæœ¬èº«ï¼Œä¸CPUå¹³å°ç›¸å…³çš„ç‰¹æ€§ä¸ç”±æ­¤éƒ¨åˆ†æ“ä½œã€‚åœ¨ç§»åŠ¨è®¾å¤‡ä¸­ï¼ŒCodecçš„ä½œç”¨å¯ä»¥å½’ç»“ä¸º4ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><p>1ã€å¯¹PCMç­‰ä¿¡å·è¿›è¡ŒD/Aè½¬æ¢ï¼ŒæŠŠæ•°å­—çš„éŸ³é¢‘ä¿¡å·è½¬æ¢ä¸ºæ¨¡æ‹Ÿä¿¡å·ã€‚<br>2ã€å¯¹Micã€Lineinæˆ–è€…å…¶ä»–è¾“å…¥æºçš„æ¨¡æ‹Ÿä¿¡å·è¿›è¡ŒA/Dè½¬æ¢ï¼ŒæŠŠæ¨¡æ‹Ÿçš„å£°éŸ³ä¿¡å·è½¬å˜CPUèƒ½å¤Ÿå¤„ç†çš„æ•°å­—ä¿¡å·ã€‚<br>3ã€å¯¹éŸ³é¢‘é€šè·¯è¿›è¡Œæ§åˆ¶ï¼Œæ¯”å¦‚æ’­æ”¾éŸ³ä¹ï¼Œæ”¶å¬è°ƒé¢‘æ”¶éŸ³æœºï¼Œåˆæˆ–è€…æ¥å¬ç”µè¯æ—¶ï¼ŒéŸ³é¢‘ä¿¡å·åœ¨codecå†…çš„æµé€šè·¯çº¿æ˜¯ä¸ä¸€æ ·çš„ã€‚<br>4ã€å¯¹éŸ³é¢‘ä¿¡å·åšå‡ºç›¸åº”çš„å¤„ç†ï¼Œä¾‹å¦‚éŸ³é‡æ§åˆ¶ï¼ŒåŠŸç‡æ”¾å¤§ï¼ŒEQæ§åˆ¶ç­‰ç­‰ã€‚</p><p>ASoCå¯¹Codecçš„è¿™äº›åŠŸèƒ½éƒ½å®šä¹‰å¥½äº†ä¸€äº›åˆ—ç›¸åº”çš„æ¥å£ï¼Œä»¥æ–¹ä¾¿åœ°å¯¹Codecè¿›è¡Œæ§åˆ¶ã€‚ASoCå¯¹Codecé©±åŠ¨çš„ä¸€ä¸ªåŸºæœ¬è¦æ±‚æ˜¯ï¼šé©±åŠ¨ç¨‹åºçš„ä»£ç å¿…é¡»è¦åšåˆ°å¹³å°æ— å…³æ€§ï¼Œä»¥æ–¹ä¾¿åŒä¸€ä¸ªCodecçš„ä»£ç ä¸ç»ä¿®æ”¹å³å¯ç”¨åœ¨ä¸åŒçš„å¹³å°ä¸Šã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/16-Audio-system-asoc-pcm-control.png" alt="Alt text"></p><p>ASoCå¯¹äºAlsaæ¥è¯´ï¼Œå°±æ˜¯åˆ†åˆ«æ³¨å†ŒPCM/CONTROLç±»å‹çš„snd_deviceè®¾å¤‡ï¼Œå¹¶å®ç°ç›¸åº”çš„æ“ä½œæ–¹æ³•é›†ã€‚å›¾ä¸­DAIæ˜¯æ•°å­—éŸ³é¢‘æ¥å£ï¼Œç”¨äºé…ç½®éŸ³é¢‘æ•°æ®æ ¼å¼ç­‰ã€‚</p><p>â˜ Codecé©±åŠ¨å‘ASoCæ³¨å†Œsnd_soc_codecå’Œsnd_soc_daiè®¾å¤‡ã€‚<br>â˜ Platformé©±åŠ¨å‘ASoCæ³¨å†Œsnd_soc_platformå’Œsnd_soc_daiè®¾å¤‡ã€‚<br>â˜ Machineé©±åŠ¨é€šè¿‡snd_soc_dai_linkç»‘å®šcodec/dai/platformã€‚</p><p>Widgetæ˜¯å„ä¸ªç»„ä»¶å†…éƒ¨çš„å°å•å…ƒã€‚å¤„åœ¨æ´»åŠ¨é€šè·¯ä¸Šç”µï¼Œä¸åœ¨æ´»åŠ¨é€šè·¯ä¸‹ç”µã€‚ASoCçš„DAPMæ­£æ˜¯é€šè¿‡æ§åˆ¶è¿™äº›Widgetçš„ä¸Šä¸‹ç”µè¾¾åˆ°åŠ¨æ€ç”µæºç®¡ç†çš„æ•ˆæœã€‚</p><p>â˜ pathæè¿°ä¸å…¶å®ƒwidgetçš„è¿æ¥å…³ç³»ã€‚<br>â˜ eventç”¨äºé€šçŸ¥è¯¥widgetçš„ä¸Šä¸‹ç”µçŠ¶æ€ã€‚<br>â˜ poweræŒ‡ç¤ºå½“å‰çš„ä¸Šç”µçŠ¶æ€ã€‚<br>â˜ controlå®ç°ç©ºé—´ç”¨æˆ·æ¥å£ç”¨äºæ§åˆ¶widgetçš„éŸ³é‡/é€šè·¯åˆ‡æ¢ç­‰ã€‚</p><p>å¯¹é©±åŠ¨å¼€è€…æ¥è¯´ï¼Œå°±å¯ä»¥å¾ˆå¥½çš„è§£è€¦äº†ï¼š</p><p>â˜ codecé©±åŠ¨çš„å¼€å‘è€…ï¼Œå®ç°codecçš„IOè¯»å†™æ–¹æ³•ï¼Œæè¿°DAIæ”¯æŒçš„æ•°æ®æ ¼å¼/æ“ä½œæ–¹æ³•å’ŒWidgetçš„è¿æ¥å…³ç³»å°±å¯ä»¥äº†;<br>â˜ socèŠ¯ç‰‡çš„é©±åŠ¨å¼€å‘è€…ï¼ŒPlatformå®ç°snd_pcmçš„æ“ä½œæ–¹æ³•é›†å’ŒDAIçš„é…ç½®å¦‚æ“ä½œ DMAï¼ŒI2S/AC97/PCMçš„è®¾å®šç­‰;<br>â˜ æ¿çº§çš„å¼€å‘è€…ï¼Œæè¿°Machineä¸Šcodecä¸platformä¹‹é—´çš„æ€»çº¿è¿æ¥ï¼Œ earphone/Speakerçš„å¸ƒçº¿æƒ…å†µå°±å¯ä»¥äº†ã€‚</p><h5 id="2-6-3ã€DAPM"><a href="#2-6-3ã€DAPM" class="headerlink" title="2.6.3ã€DAPM"></a>2.6.3ã€<strong>DAPM</strong></h5><p> DAPMæ˜¯Dynamic Audio Power Managementçš„ç¼©å†™ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯åŠ¨æ€éŸ³é¢‘ç”µæºç®¡ç†çš„æ„æ€ï¼ŒDAPMæ˜¯ä¸ºäº†ä½¿åŸºäºlinuxçš„ç§»åŠ¨è®¾å¤‡ä¸Šçš„éŸ³é¢‘å­ç³»ç»Ÿï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å·¥ä½œåœ¨æœ€å°åŠŸè€—çŠ¶æ€ä¸‹ã€‚DAPMå¯¹ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯é€æ˜çš„ï¼Œæ‰€æœ‰ä¸ç”µæºç›¸å…³çš„å¼€å…³éƒ½åœ¨ASoc coreä¸­å®Œæˆã€‚ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºæ— éœ€å¯¹ä»£ç åšå‡ºä¿®æ”¹ï¼Œä¹Ÿæ— éœ€é‡æ–°ç¼–è¯‘ï¼ŒDAPMæ ¹æ®å½“å‰æ¿€æ´»çš„éŸ³é¢‘æµï¼ˆplayback/captureï¼‰å’Œå£°å¡ä¸­çš„mixerç­‰çš„é…ç½®æ¥å†³å®šé‚£äº›éŸ³é¢‘æ§ä»¶çš„ç”µæºå¼€å…³è¢«æ‰“å¼€æˆ–å…³é—­ã€‚</p><h5 id="2-6-4ã€DPCM"><a href="#2-6-4ã€DPCM" class="headerlink" title="2.6.4ã€DPCM"></a>2.6.4ã€<strong>DPCM</strong></h5><p><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/Documentation/sound/soc/dpcm.rst?h=v4.16-rc5" target="_blank" rel="noopener">Dynamic PCM</a></p><h5 id="2-7ã€Audio-devices"><a href="#2-7ã€Audio-devices" class="headerlink" title="2.7ã€Audio devices"></a>2.7ã€Audio devices</h5><p>å…·ä½“çš„Audioç¡¬ä»¶è®¾å¤‡ã€‚</p><h4 id="ï¼ˆä¸‰ï¼‰ã€Qualcommå¹³å°-Audioç³»ç»Ÿæ¡†æ¶"><a href="#ï¼ˆä¸‰ï¼‰ã€Qualcommå¹³å°-Audioç³»ç»Ÿæ¡†æ¶" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Qualcommå¹³å° - Audioç³»ç»Ÿæ¡†æ¶"></a>ï¼ˆä¸‰ï¼‰ã€Qualcommå¹³å° - Audioç³»ç»Ÿæ¡†æ¶</h4><p>ç”±äºæ¥ä¸‹æ¥çš„ä¸€ç³»åˆ—Android &amp;&amp; kernel æºç åˆ†æéƒ½æ˜¯åŸºäºQualcomm å¹³å°çš„ï¼Œååˆ†æœ‰å¿…è¦ä»‹ç»Qualcomm å¹³å°çš„Audio ç³»ç»Ÿæ¡†æ¶ã€‚ç¡¬ä»¶å¹³å°åŠè½¯ä»¶ç‰ˆæœ¬ï¼š<br>â˜ Kernel - 3.18<br>â˜ SoC - Qualcomm snapdragon<br>â˜ CODEC - WCD9335<br>â˜ Machine - msm8996<br>â˜ Userspace - tinyalsa</p><h5 id="3-1ã€Qualcomm-Audioç³»ç»Ÿæ€»ä½“æ¡†æ¶å›¾"><a href="#3-1ã€Qualcomm-Audioç³»ç»Ÿæ€»ä½“æ¡†æ¶å›¾" class="headerlink" title="3.1ã€Qualcomm Audioç³»ç»Ÿæ€»ä½“æ¡†æ¶å›¾"></a>3.1ã€Qualcomm Audioç³»ç»Ÿæ€»ä½“æ¡†æ¶å›¾</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/17-MSM8996-Linux-Android-Audio-Software-Overview-Architecture.png" alt="Alt text"></p><h5 id="3-2ã€ASoC-driver"><a href="#3-2ã€ASoC-driver" class="headerlink" title="3.2ã€ASoC driver"></a>3.2ã€ASoC driver</h5><p>ALSA ç‰‡ä¸Šç³»ç»Ÿ (ASoC) é©±åŠ¨ç¨‹åºå°†éŸ³é¢‘ç³»ç»Ÿåˆ†ä¸ºå››ä¸ªç»„æˆéƒ¨åˆ†Machine driverã€Platform driverã€CPU driverã€Codec driverã€‚</p><h5 id="3-2-1ã€Machine-driver"><a href="#3-2-1ã€Machine-driver" class="headerlink" title="3.2.1ã€Machine driver"></a>3.2.1ã€Machine driver</h5><p>å°†å¹³å°ã€CPU å’Œç¼–è§£ç é©±åŠ¨ç¨‹åºæ•´åˆåœ¨ä¸€èµ·<br>kernel/sound/soc/msm/<chipset>.c<br>å®šä¹‰Frontend (FE) and Backend (BE), Digital Audio Interface (DAI) links</chipset></p><h5 id="3-2-2ã€Platform-driver"><a href="#3-2-2ã€Platform-driver" class="headerlink" title="3.2.2ã€Platform driver"></a>3.2.2ã€Platform driver</h5><p>åŒ…å«ç”¨äºæµæ•°æ®ä¼ è¾“ä¸è·¯ç”±çš„å¹³å°ç‰¹å®šçš„æ§ä»¶ï¼ˆcontrolï¼‰ï¼Œ ç»†åˆ†ä¸º FE å’Œ BE å¹³å°é©±åŠ¨ç¨‹åº<br><strong>FE</strong><br>ï‚§ Audio â€“ å®ä¾‹åŒ– PCM æ’­æ”¾å’Œå½•åˆ¶ä¼šè¯ï¼›å€ŸåŠ© ASM æ¥å£ï¼Œå°† PCM æ•°æ®ä»ç”¨æˆ·ç©ºé—´ä¼ è¾“åˆ° DSP è¿›è¡Œæ’­æ”¾<br>ä»¥åŠä» DSP ä¼ è¾“åˆ°ç”¨æˆ·ç©ºé—´è¿›è¡Œå½•åˆ¶ â€“ åœ¨ kernel/sound/soc/msm-pcm-q6-v2.c ä¸­å®ç°<br>ï‚§ Voice â€“ åˆå§‹åŒ–/å–æ¶ˆåˆå§‹åŒ–è¯­éŸ³å‘¼å«è®¾ç½® â€“ åœ¨ kernel/sound/soc/msm-pcm-voice-v2.c ä¸­å®ç°<br>ï‚§ VoIP â€“ åˆå§‹åŒ–/å–æ¶ˆåˆå§‹åŒ– MVS æ¥å£ä»¥ä¼ è¾“è‡ª/è‡³ DSP çš„ PCM æ•°æ® â€“ åœ¨kernel/sound/soc/msm-pcmvoip-v2.c<br>ä¸­å®ç°<br>ï‚§ Compressed offload â€“ æ”¯æŒå°†å‹ç¼©æ•°æ®å‘é€åˆ° DSP è¿›è¡Œå‹ç¼©åˆ†æµæ’­æ”¾ â€“ åœ¨ kernel/sound/soc/msm-compress-q6-<br>v2.c ä¸­å®ç°<br><strong>BE</strong><br>ï‚§ è·¯ç”± â€“ æ‰§è¡ŒéŸ³é¢‘è·¯ç”±ä»»åŠ¡ â€“ åœ¨ /kernel/sound/soc/msm-pcm-routing-v2.c ä¸­å®ç°</p><h5 id="3-2-3ã€CPU-driver"><a href="#3-2-3ã€CPU-driver" class="headerlink" title="3.2.3ã€CPU driver"></a>3.2.3ã€CPU driver</h5><p><strong>FE</strong><br>ï‚§ å‘ ASoC æ¡†æ¶æä¾›å…³äº FE PCM è®¾å¤‡çš„ä¿¡æ¯<br>ï‚§ ASoC æ¡†æ¶ä¸å¹³å°é©±åŠ¨ç¨‹åºæä¾›çš„è·¯ç”±è¡¨å…±åŒå°† PCM æ’­æ”¾/æ•è·ä» FE ä¼ é€’è‡³ BE<br>ï‚§ æ²¡æœ‰é’ˆå¯¹æ’­æ”¾å’Œå½•åˆ¶çš„å†…ç½®é€»è¾‘<br>ï‚§ å®šä¹‰ FE CPU DAI â€“ åœ¨ kernel/sound/soc/msm/msm-dai-fe.c ä¸­å®ç°<br><strong>BE</strong><br>ï‚§ è¦åœ¨åˆå§‹åŒ– PCM æ’­æ”¾/æ•è·æ—¶æ¿€æ´»æ‰€éœ€éŸ³é¢‘ç¡¬ä»¶ç«¯å£ï¼Œåˆ™é…ç½® DSP AFE æ¨¡å—<br>ï‚§ å®šä¹‰ BE CPU DAI â€“ åœ¨ kernel/sound/soc/msm/qdsp6v2/msm-dai-q6-v2.c ä¸­å®ç°</p><h5 id="3-2-4ã€Codec-driver"><a href="#3-2-4ã€Codec-driver" class="headerlink" title="3.2.4ã€Codec driver"></a>3.2.4ã€Codec driver</h5><p>ä¸å¹³å°æ— å…³ï¼Œå…¶ä¸­åŒ…å«éŸ³é¢‘æ§åˆ¶ã€éŸ³é¢‘æ¥å£åŠŸèƒ½ã€ç¼–è§£ç å™¨ DAPM å®šä¹‰ä»¥åŠç¼–è§£<br>ç å™¨è¾“å…¥è¾“å‡ºåŠŸèƒ½<br>ï‚§ æ­¤å¤–ï¼Œå®ç° MBHC çŠ¶æ€æœºï¼Œç”¨äºæ£€æµ‹æœ‰çº¿è€³æœºæ’å…¥/æ‹”å‡ºã€é™„ä»¶ç±»å‹ã€è¿æ¥å™¨ç±»å‹<br>å’Œå¤šæŒ‰é’®æ£€æµ‹</p><h5 id="3-3ã€DSP-driver"><a href="#3-3ã€DSP-driver" class="headerlink" title="3.3ã€DSP driver"></a>3.3ã€DSP driver</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/18-MSM8996-Linux-Android-Audio-ADSP-Architecture.png" alt="Alt text"></p><p><strong>ASMï¼ˆAudio Stream Managerï¼‰</strong><br>ï‚§ ç”¨äºä¸ DSP ASM æ¨¡å—é€šä¿¡çš„æ¥å£<br>ï‚§ æä¾›å°† PCM æ•°æ®è·¯ç”±è‡³ DSP çš„æœºåˆ¶ï¼Œæ”¯æŒæŒ‰æ•°æ®æµè¿›è¡ŒåæœŸå¤„ç†/é¢„å¤„ç†<br><strong>ADMï¼ˆAudio Device Managerï¼‰</strong><br>ï‚§ å…è®¸åœ¨ DSP ä¸­ä½¿ç”¨ ADM æœåŠ¡<br>ï‚§ é…ç½® COPP å’Œè·¯ç”±çŸ©é˜µ<br>ï‚§ ä¸éŸ³é¢‘æ ¡å‡†æ•°æ®åº“ (ACDB) è¿›è¡Œé€šä¿¡ï¼Œä½¿ç”¨æ­£ç¡®çš„æ ¡å‡†æ•°æ®é…ç½® COPP<br>ï‚§ å°† ASM ä¼šè¯ ID è·¯ç”±è‡³ ADM ä¼šè¯<br><strong>AFEï¼ˆAudio Front-Endï¼‰</strong><br>ï‚§ å…è®¸åœ¨ DSP ä¸­ä½¿ç”¨ AFE æœåŠ¡<br>ï‚§ æ¿€æ´»/ç¦ç”¨éŸ³é¢‘ç¡¬ä»¶ç«¯å£<br>ï‚§ å­ç³»ç»Ÿç®¡ç†å™¨ â€“ å‘ç”Ÿ MDSP å¤ä½äº‹ä»¶æ—¶ï¼Œé€šçŸ¥éŸ³é¢‘å’Œè¯­éŸ³é©±åŠ¨ç¨‹åºå…³é—­å¾…å¤„ç†<br>ä¼šè¯ã€æ‰§è¡Œæ¸…ç†æ“ä½œå¹¶ç­‰å¾…ä¸€ä¸ªæŒ‡ç¤º MDSP å·²å¯åŠ¨çš„äº‹ä»¶<br><strong>APRï¼ˆAsynchronous Packet Routerï¼‰</strong><br>ï‚§ ä¸ºå¤„ç†å™¨é—´é€šä¿¡æä¾›å¼‚æ­¥æ¡†æ¶<br>ï‚§ ç”¨äºä¸ Hexagon å’Œè°ƒåˆ¶è§£è°ƒå™¨å¤„ç†å™¨è¿›è¡Œé€šä¿¡<br>ï‚§ Image loader PIL  â€“ è½½å…¥ MDSP å›¾åƒ</p><h5 id="3-4ã€User-Space"><a href="#3-4ã€User-Space" class="headerlink" title="3.4ã€User Space"></a>3.4ã€User Space</h5><p>ï‚§ Audio Hardware Abstraction Layer (AHAL) â€“ é€šè¿‡ tinyALSA å°† AudioFlinger<br> è°ƒç”¨æ˜ å°„è‡³ASoC é©±åŠ¨ç¨‹åºçš„ç¡¬ä»¶æŠ½è±¡å±‚ã€‚<br>ï‚§ ACDB loader â€“ æ£€ç´¢ç‰¹å®šè®¾å¤‡çš„æ ¡å‡†ä¿¡æ¯ï¼Œå¹¶å†™å…¥ PMEMã€‚ACDB é©±åŠ¨ç¨‹<br>åºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­åˆ†é…è¯¥ PMEMã€‚åœ¨è®¾å¤‡åˆ‡æ¢æ—¶ï¼Œæ­¤æ ¡å‡†å°†è¢«å‘é€åˆ° DSPã€‚<br>ï‚§ tinyALSA â€“ è¿æ¥è‡³å†…æ ¸ ASoC é©±åŠ¨ç¨‹åºçš„æ¥å£ï¼Œä¾›éŸ³é¢‘ HAL ä½¿ç”¨ã€‚æä¾›ç”¨<br>äºéŸ³é¢‘æµå’Œè®¾å¤‡ç®¡ç†çš„åŸºæœ¬ PCM å’Œæ··éŸ³æ§ä»¶ APIã€‚<br>ï‚§ Audio route â€“ æ­¤æ¨¡å—ä¼šä»ä¸€ä¸ª .xml æ–‡ä»¶è¯»å– ALSA æ··éŸ³æ§ä»¶ï¼Œå¹¶æ ¹æ®éŸ³é¢‘<br>HAL æ‰€é€‰çš„è®¾å¤‡è®¾ç½®æ··éŸ³æ§ä»¶ã€‚<br>ï‚§ Concurrency Manager - åœ¨MSM8x10ä¸­ï¼Œè§†é¢‘è§£ç å’Œç¼–ç åœ¨DSPä¸­å®Œæˆ; å› æ­¤ï¼Œæœ‰<br>å¯¹å¯æ”¯æŒçš„å¹¶å‘æ€§æœ‰ä¸€äº›é™åˆ¶ã€‚MSM8x10ä¸­å¼•å…¥çš„å¹¶å‘ç®¡ç†å™¨ç®¡ç†å¹¶å‘æ€§<br>å¯ä»¥æ”¯æŒæ¶‰åŠè¯­éŸ³å’ŒéŸ³é¢‘çš„ä¸åŒç”¨ä¾‹</p><p>Multimedia framework â€“ Stagefright<br>ï‚§ æ”¯æŒæ ‡å‡†éŸ³é¢‘æ ¼å¼çš„æ’­æ”¾/å½•åˆ¶<br>ï‚§ ä¸è§£ç å™¨/ç¼–ç å™¨åº“ä»¥åŠ OpenMAX IL ç»„ä»¶é€šä¿¡ï¼Œä»¥ä¾¿è¿›è¡Œè§£ç å’Œç¼–ç </p><p>Audio service<br>ï‚§ ç”±ç³»ç»ŸæœåŠ¡å™¨å¯åŠ¨å¹¶ç”±æœåŠ¡ç®¡ç†å™¨ç®¡ç†çš„è¿è¡Œæ—¶æœåŠ¡ä¹‹ä¸€<br>ï‚§ æ„å›¾æ³¨å†Œï¼›å½“ä»å„ç§åº”ç”¨ç¨‹åºï¼ˆHDMIã€è“ç‰™ç­‰ï¼‰æ¥æ”¶åˆ°è¿™äº›æ„å›¾æ—¶ï¼Œé€šçŸ¥éŸ³é¢‘<br>ç³»ç»Ÿ</p><p>AudioFlinger<br>ï‚§ é€šè¿‡ libaudio æ¥å£ã€è“ç‰™ A2DP æ¥å£ç®¡ç†æ‰€æœ‰éŸ³é¢‘è¾“å‡º/è¾“å…¥è®¾å¤‡<br>ï‚§ å°†å¤šä¸ªéŸ³é¢‘æµå¤„ç†ä¸ºå•ä¸€çš„ PCM éŸ³é¢‘ï¼›æ··åˆåçš„è¾“å‡ºè¢«ä¼ é€åˆ°è¾“å‡ºè®¾å¤‡<br>ï‚§ æ’­æ”¾éŸ³ä¹æµæ—¶çš„éŸ³é‡</p><p>Audio Policy Manager (APM)<br>ï‚§ å®šä¹‰å¤šä¸ªéŸ³é¢‘ç”¨ä¾‹ä¹‹é—´çš„å¹¶å‘è§„åˆ™<br>ï‚§ ç”¨ä¾‹ç¤ºä¾‹ â€“ ç”µè¯é€šè¯ã€éŸ³ä¹æ’­æ”¾ã€ç³»ç»Ÿå£°éŸ³å’Œé€šçŸ¥<br>ï‚§ å®šä¹‰æ’­æ”¾çš„éŸ³é¢‘ï¼ˆä¾‹å¦‚ï¼šè¯­éŸ³ã€æ’­æ”¾ã€é“ƒå£°ï¼‰ä»¥åŠæ’­æ”¾çš„è®¾å¤‡ï¼ˆè“ç‰™ã€æ‰¬å£°å™¨<br>å’Œè€³æœºï¼‰<br>APM ç”¨é€”ï¼š<br>ï‚§ ç®¡ç†å„ç§è¾“å…¥è¾“å‡ºè®¾å¤‡æ¥å£<br>ï‚§ ç®¡ç†å„ç§è¾“å…¥è¾“å‡ºè®¾å¤‡ï¼Œä¾‹å¦‚ï¼šéº¦å…‹é£ã€æ‰¬å£°å™¨ã€è€³æœºã€å¬ç­’ã€A2DPã€è“ç‰™ SCO<br>ï‚§ åŸºäºéŸ³é¢‘æµã€æ¨¡å¼å’Œæ–¹æ³•é€‰æ‹©å’Œå®šä¹‰é€‚å½“çš„è·¯ç”±ç­–ç•¥<br>ï‚§ ç®¡ç†æ¯ä¸ªéŸ³é¢‘æµçš„éŸ³é‡/é™éŸ³è®¾ç½®ï¼ˆåœ¨å®ƒä»¬æ¿€æ´»æˆ–ç¦ç”¨æ—¶ï¼‰</p><h4 id="ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://zhuanlan.zhihu.com/p/27480328" target="_blank" rel="noopener">AndroidéŸ³é¢‘æ¨¡å—å¯åŠ¨æµç¨‹åˆ†æ</a><br><a href="https://zhuanlan.zhihu.com/jhuster" target="_blank" rel="noopener">Jhusterçš„ä¸“æ â€‹ AndroidéŸ³é¢‘å¼€å‘</a><br><a href="http://thinks.me/2016/09/13/audio_qcom_offload/" target="_blank" rel="noopener">é«˜é€šaudio offloadå­¦ä¹  | Thinking</a><br><a href="https://blog.csdn.net/droidphone/article/category/1118446" target="_blank" rel="noopener">DroidPhoneçš„ä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8866071" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„1-CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8982771" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„2-ASoc - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8995163" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„3-Pcm - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8999364" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„4-å£°å¡æ§åˆ¶ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59180272" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šé€»è¾‘è®¾å¤‡ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59170418" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šç‰©ç†é“¾è·¯ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/12812.html" target="_blank" rel="noopener">ä¸“æ ï¼šMultiMediaæ¡†æ¶æ€»ç»“(åŸºäº6.0æºç ) - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/60890534" target="_blank" rel="noopener">Android éŸ³é¢‘ç³»ç»Ÿï¼šä» AudioTrack åˆ° AudioFlinger - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/azloong/article/category/778492" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ALSA-Android Audio</a><br><a href="https://blog.csdn.net/azloong/article/category/777239" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ANDROIDéŸ³é¢‘ç³»ç»Ÿ</a><br><a href="https://winddoing.github.io/2017/07/10/audio_alsa/" target="_blank" rel="noopener">Audioé©±åŠ¨æ€»ç»“â€“ALSA | Winddoingâ€™s Blog</a><br><a href="http://www.cnblogs.com/muhe221/articles/4461543.html" target="_blank" rel="noopener">audio HAL - ç‰§ å¤© - åšå®¢å›­</a><br><a href="https://blog.csdn.net/xuesen_lin/article/category/1390680" target="_blank" rel="noopener">æ—å­¦æ£®çš„Androidä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">æ·±å…¥å‰–æAndroidéŸ³é¢‘ - CSDNåšå®¢Yangwen123</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">æ’­æ”¾æ¡†æ¶ - æ ‡ç­¾ - Tocy - åšå®¢å›­</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57415505" target="_blank" rel="noopener">Android-7.0-Nuplayeræ¦‚è¿° - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/56961370" target="_blank" rel="noopener">Android-7.0-Nuplayer-å¯åŠ¨æµç¨‹ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53386010" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-Nuplayerï¼ˆ1ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53397945" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-AHandler AMessage ALooper - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/category/6344583" target="_blank" rel="noopener">Android N Audioæ’­æ”¾ startçœŸé¢ç›®- (å…­ç¯‡) CSDNåšå®¢</a><br><a href="https://blog.csdn.net/nonmarking/article/details/78746671" target="_blank" rel="noopener">æ·±å…¥ç†è§£AndroidéŸ³è§†é¢‘åŒæ­¥æœºåˆ¶ï¼ˆäº”ç¯‡ï¼‰NuPlayerçš„avsyncé€»è¾‘ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/u014310046/article/category/6571854" target="_blank" rel="noopener">wangyfçš„ä¸“æ  - CSDNåšå®¢-MT6737 Android N å¹³å° Audioç³»ç»Ÿå­¦ä¹ </a><br><a href="https://blog.csdn.net/xiashaohua/article/details/53638780" target="_blank" rel="noopener">Android 7.0 Audio: Mediaplayer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/xiashaohua/article/category/6549668" target="_blank" rel="noopener">Android 7.0 Audio-ç›¸å…³ç±»æµ…æ- CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/details/59119144" target="_blank" rel="noopener">Android N Audioæ’­æ”¾å…­ï¼šå¦‚ä½•è¯»å–buffer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/78007568" target="_blank" rel="noopener">Fuchsia OSä¸­çš„RPCæœºåˆ¶-FIDL - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/linhaostudy/category/1145404.html" target="_blank" rel="noopener">é«˜é€šAudioä¸­ASOCçš„codecé©±åŠ¨ - yooooooo - åšå®¢å›­</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;amp;&amp;amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Google Pixel Oreo 8.1 OPM2.171019.029 Root äº²æµ‹æˆåŠŸ [i.wonder~]</title>
    <link href="http://zhoujinjian.cc/2018/04/20/Google%20Pixel%20Oreo%208.1%20OPM2.171019.029%20Root%20%E4%BA%B2%E6%B5%8B%E6%88%90%E5%8A%9F/"/>
    <id>http://zhoujinjian.cc/2018/04/20/Google Pixel Oreo 8.1 OPM2.171019.029 Root äº²æµ‹æˆåŠŸ/</id>
    <published>2018-04-19T16:00:00.000Z</published>
    <updated>2018-04-21T06:06:04.591Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.androidinfotech.com/2018/04/root-google-pixel-oreo-8-1-opm2-171019-029.html" target="_blank" rel="noopener">Rootæ•™ç¨‹åŸæ–‡ Root Google Pixel Oreo 8.1 OPM2.171019.029 Install TWRP</a></p><h4 id="æ³¨æ„ï¼š"><a href="#æ³¨æ„ï¼š" class="headerlink" title="æ³¨æ„ï¼š"></a>æ³¨æ„ï¼š</h4><p>âœ¢ ç”µæ± ç”µé‡é«˜äº80ï¼…ã€‚<br>âœ¢ æ•°æ®ä¼šå®Œå…¨ä¸¢å¤±ä¸å¯æ¢å¤ï¼Œè¯·æå‰å¤‡ä»½æ‚¨çš„æ•°æ®ã€‚<br>âœ¢ è§£é”ä½ çš„Bootloaderã€‚<br>âœ¢ ä»…é™Google Pixel Oreo 8.1ã€‚<br>âœ¢ ä»…é™å¥¥åˆ©å¥¥ç‰ˆæœ¬ã€‚<br>âœ¢ ç¬”è€…æ‰‹æœºå¦‚å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/others/google-pixel.jpg" alt="enter image description here"></p><h4 id="ä¸€ã€è§£é”Bootloader"><a href="#ä¸€ã€è§£é”Bootloader" class="headerlink" title="ä¸€ã€è§£é”Bootloader"></a>ä¸€ã€è§£é”Bootloader</h4><p>åœ¨Google Pixel Oreo 8.1 OPM2.171019.029ä¸­è§£é”å¼•å¯¼åŠ è½½ç¨‹åºbootloader</p><h5 id="1-1ã€OEMè§£é”"><a href="#1-1ã€OEMè§£é”" class="headerlink" title="1.1ã€OEMè§£é”"></a>1.1ã€OEMè§£é”</h5><p><a href="https://www.androidinfotech.com/2018/04/root-google-pixel-oreo-8-1-opm2-171019-029.html" target="_blank" rel="noopener">è§£é”BootLoaderæ•™ç¨‹ Unlocking Bootloader in Google Pixel and Pixel XL</a><br>âœ¢ <a href="https://bitbucket.org/Serverbee/downloadbee/downloads/adb-setup-1.4.3.exe" target="_blank" rel="noopener">ä¸‹è½½</a>ï¼ˆWindowsï¼‰/<a href="https://bitbucket.org/Serverbee/downloadbee/downloads/adb-mac.zip" target="_blank" rel="noopener">ä¸‹è½½</a>ï¼ˆMacï¼‰ç›¸åº”çš„ADBã€Fastbootã€é©±åŠ¨ç¨‹åºå¹¶å°†å…¶å®‰è£…åˆ°æ‚¨çš„ç³»ç»Ÿä¸­ã€‚<br>âœ¢ è¿›å…¥ è®¾ç½®-&gt;å…³äºæ‰‹æœº è¿ç»­ç‚¹å‡»5æ¬¡ç‰ˆæœ¬å·ï¼Œç›´åˆ°æç¤ºâ€ä½ å·²å¤„äºå¼€å‘è€…æ¨¡å¼ï¼Œæ— éœ€è¿›è¡Œæ­¤æ“ä½œâ€<br>âœ¢ ç‚¹å‡»è¿”å›è¿›å…¥ â€œå¼€å‘è€…æ¨¡å¼â€ æ‰“å¼€ â€œOEMè§£é”â€ å’Œ â€œUSBè°ƒè¯•â€<br>âœ¢ è¿æ¥æ‰‹æœºï¼Œè‹¥å¼¹å‡ºæç¤ºæ¡†è¯·é€‰æ‹©æ˜¯/å…è®¸ï¼Œå‘½ä»¤è¡Œæ‰§è¡Œï¼šadb devicesï¼ŒæˆåŠŸä¼šæœ‰ä»¥ä¸‹ç±»ä¼¼æç¤º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List of devices attached</span><br><span class="line">* daemon not running; starting now at tcp:5037</span><br><span class="line">* daemon started successfully</span><br><span class="line">FA7240301112    device</span><br></pre></td></tr></table></figure><p>âœ¢ å‘½ä»¤è¡Œæ‰§è¡Œï¼šadb reboot bootloader<br>âœ¢ æ‰§è¡Œï¼šfastboot oem unlock<br>âœ¢ æ‚¨éœ€è¦é€šè¿‡å¢å¤§éŸ³é‡æŒ‰é’®æ¥ç¡®è®¤æ‰‹æœºä¸­çš„æ“ä½œã€‚æ‚¨å°†æˆåŠŸè§£é™¤æˆåŠŸæ¶ˆæ¯ã€‚å½“æ‚¨æ”¶åˆ°æ­¤æ¶ˆæ¯æ—¶ï¼Œè¯·æŒ‰éŸ³é‡é”®å¹¶å¯¼èˆªå¼€å§‹ï¼Œç„¶åæŒ‰ç”µæºæŒ‰é’®ã€‚æ‰‹æœºå°†é‡æ–°å¯åŠ¨ã€‚å¯åŠ¨ç¬¬ä¸€æ¬¡å¯åŠ¨éœ€è¦ä¸€äº›æ—¶é—´ã€‚<br>âœ¢ è§£é”æˆåŠŸåœ¨å¼€æœºç•Œé¢ä¼šæœ‰ä¸€ä¸ªæ‰“å¼€çš„å°é”å›¾æ ‡</p><h5 id="1-2ã€å°†ç³»ç»Ÿå‡çº§åˆ°Oreo-8-1-OPM2-171019-029ç¨³å®šç‰ˆ"><a href="#1-2ã€å°†ç³»ç»Ÿå‡çº§åˆ°Oreo-8-1-OPM2-171019-029ç¨³å®šç‰ˆ" class="headerlink" title="1.2ã€å°†ç³»ç»Ÿå‡çº§åˆ°Oreo 8.1 OPM2.171019.029ç¨³å®šç‰ˆ"></a>1.2ã€å°†ç³»ç»Ÿå‡çº§åˆ°Oreo 8.1 OPM2.171019.029ç¨³å®šç‰ˆ</h5><p>Root Google Pixel Oreo 8.1 OPM2.171019.029ç¨³å®šçš„ç‰ˆæœ¬äº2018å¹´4æœˆå‘å¸ƒã€‚<br>1ã€<a href="https://developers.google.cn/android/images#sailfish" target="_blank" rel="noopener">Sailfish-OPM2.171019.029ä¸‹è½½åœ°å€</a><br>2ã€è§£å‹è¿è¡Œupdate-all.batï¼ˆWindowsï¼‰/ update-all.batï¼ˆMacï¼‰</p><h5 id="1-3ã€Root-Pixel-Oreo-8-1-OPM2-171019-029æœ‰å››ä¸ªæ­¥éª¤"><a href="#1-3ã€Root-Pixel-Oreo-8-1-OPM2-171019-029æœ‰å››ä¸ªæ­¥éª¤" class="headerlink" title="1.3ã€Root Pixel Oreo 8.1 OPM2.171019.029æœ‰å››ä¸ªæ­¥éª¤"></a>1.3ã€Root Pixel Oreo 8.1 OPM2.171019.029æœ‰å››ä¸ªæ­¥éª¤</h5><p>âœ¢ Install TWRP Recovery Officially in Google Pixel Oreo 8.1 OPM2.171019.029<br>âœ¢ Install Root Files in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0<br>âœ¢ Install SuperSu in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0<br>âœ¢ Install SuperSu in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0</p><h4 id="äºŒã€Install-TWRP-Recovery-Officially-in-Google-Pixel-Oreo-8-1-OPM2-171019-029"><a href="#äºŒã€Install-TWRP-Recovery-Officially-in-Google-Pixel-Oreo-8-1-OPM2-171019-029" class="headerlink" title="äºŒã€Install TWRP Recovery Officially in Google Pixel Oreo 8.1 OPM2.171019.029"></a>äºŒã€Install TWRP Recovery Officially in Google Pixel Oreo 8.1 OPM2.171019.029</h4><p><strong>æ­¥éª¤ï¼š</strong><br>1ã€ç¡®ä¿ ç³»ç»ŸOEMè§£é”æˆåŠŸã€æ‰‹æœºç‰ˆæœ¬ä¸ºOreo 8.1 OPM2.171019.029ï¼Œç„¶åæ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œ<br>2ã€<a href="https://www.firmwares.androidinfotech.com/google-pixel-official-twrp-3-2-0-0-sailfish-img/" target="_blank" rel="noopener">ä¸‹è½½ twrp-3.2.1-2-sailfish.img</a> Google Pixel Oreo 8.1 OPM2.171019.029çš„TWRPæ¢å¤é•œåƒ<br>3ã€é€šè¿‡USBè¿æ¥æ‚¨çš„æ‰‹æœºï¼Œæ‰§è¡Œï¼šadb reboot bootloaderè¿›å…¥BootLoaderæ¨¡å¼ï¼ˆæˆ–è€…å…³æœºçŠ¶æ€ Poweré”®+éŸ³é‡ä¸‹é”®è¿›å…¥ï¼‰<br>4ã€ç¡®ä¿æ‚¨çš„æ‰‹æœºå·²è¢«ç³»ç»Ÿæ£€æµ‹åˆ°ï¼Œæ‰§è¡Œï¼šfastboot devices ä¼šçœ‹åˆ°è®¾å¤‡å·<br>5ã€fastboot boot twrp-3.2.1-2-sailfish.img<br>6ã€é‡å¯è¿›å…¥ä¸‹ä¸€æ­¥æ“ä½œ</p><h4 id="ä¸‰ã€Install-Root-Files-in-Google-Pixel-Oreo-8-1-OPM2-171019-029-Using-TWRP-Recovery-3-2-0"><a href="#ä¸‰ã€Install-Root-Files-in-Google-Pixel-Oreo-8-1-OPM2-171019-029-Using-TWRP-Recovery-3-2-0" class="headerlink" title="ä¸‰ã€Install Root Files in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0"></a>ä¸‰ã€Install Root Files in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0</h4><p><strong>æ­¥éª¤ï¼š</strong><br>1ã€<a href="https://www.firmwares.androidinfotech.com/twrp-pixel-installer-sailfish-3-1-1-0-zip/" target="_blank" rel="noopener">ä¸‹è½½ twrp-pixel-installer-sailfish-3.1.1-0.zip</a>ï¼Œå°†æ‰‹æœºUSBä½¿ç”¨æ–¹å¼åˆ‡æ¢ä¸ºä¼ è¾“æ–‡ä»¶æ¨¡å¼ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°æ‰‹æœºå­˜å‚¨æ ¹ç›®å½•<br>2ã€å…³æ‰ä½ çš„æ‰‹æœº<br>3ã€Poweré”®+éŸ³é‡ä¸‹é”®è¿›å…¥BootLoaderæ¨¡å¼æ¨¡å¼ ï¼Œç„¶åéŸ³é‡é”®é€‰æ‹© recovery modeï¼ŒæŒ‰poweré”®è¿›å…¥Recoveryæ¨¡å¼<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/others/twrp-3-0.jpg" alt="enter image description here"><br>4ã€Select Wipe-&gt;Advance Wipe-&gt;Select  Data<br>5ã€è¿”å›åˆ°TWRPä¸»ç•Œé¢ï¼šselect Install<br>6ã€Select twrp-pixel-installer-sailfish-3.1.1-0.zip<br>å®‰è£…åé‡æ–°å¯åŠ¨æ‚¨çš„æ‰‹æœºã€‚</p><h4 id="å››ã€Install-SuperSu-in-Google-Pixel-Oreo-8-1-OPM2-171019-029-Using-TWRP-Recovery-3-2-0"><a href="#å››ã€Install-SuperSu-in-Google-Pixel-Oreo-8-1-OPM2-171019-029-Using-TWRP-Recovery-3-2-0" class="headerlink" title="å››ã€Install SuperSu in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0"></a>å››ã€Install SuperSu in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0</h4><p><strong>æ­¥éª¤ï¼š</strong><br>1ã€<a href="https://www.firmwares.androidinfotech.com/sr5-supersu-v2-82-sr5-20171001224502-zip/" target="_blank" rel="noopener">ä¸‹è½½ SR5-SuperSU-v2.82-SR5-20171001224502.zip</a> å°†æ‰‹æœºUSBä½¿ç”¨æ–¹å¼åˆ‡æ¢ä¸ºä¼ è¾“æ–‡ä»¶æ¨¡å¼ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°æ‰‹æœºå­˜å‚¨æ ¹ç›®å½•<br>2ã€å…³æ‰ä½ çš„æ‰‹æœº<br>3ã€Poweré”®+éŸ³é‡ä¸‹é”®è¿›å…¥BootLoaderæ¨¡å¼æ¨¡å¼ ï¼Œç„¶åéŸ³é‡é”®é€‰æ‹© recovery modeï¼ŒæŒ‰poweré”®è¿›å…¥Recoveryæ¨¡å¼<br>4ã€Select Wipe-&gt;Advance Wipe-&gt;Select  Data<br>5ã€è¿”å›åˆ°TWRPä¸»ç•Œé¢ï¼šselect Install<br>6ã€Select SR5-SuperSU-v2.82-SR5-20171001224502.zip<br>å®‰è£…åé‡æ–°å¯åŠ¨æ‚¨çš„æ‰‹æœºã€‚</p><h4 id="äº”ã€Install-Magisk-in-Google-Pixel-Oreo-8-1-OPM2-171019-029-Using-TWRP-Recovery-3-2-0"><a href="#äº”ã€Install-Magisk-in-Google-Pixel-Oreo-8-1-OPM2-171019-029-Using-TWRP-Recovery-3-2-0" class="headerlink" title="äº”ã€Install Magisk in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0"></a>äº”ã€Install Magisk in Google Pixel Oreo 8.1 OPM2.171019.029 Using TWRP Recovery 3.2.0</h4><p><strong>æ­¥éª¤ï¼š</strong><br>1ã€<a href="https://www.androidinfotech.com/2017/07/magisk-versions-download.html" target="_blank" rel="noopener">ä¸‹è½½ Magisk-v16.1(1610).zip</a> å°†æ‰‹æœºUSBä½¿ç”¨æ–¹å¼åˆ‡æ¢ä¸ºä¼ è¾“æ–‡ä»¶æ¨¡å¼ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°æ‰‹æœºå­˜å‚¨æ ¹ç›®å½•<br>2ã€å…³æ‰ä½ çš„æ‰‹æœº<br>3ã€Poweré”®+éŸ³é‡ä¸‹é”®è¿›å…¥BootLoaderæ¨¡å¼æ¨¡å¼ ï¼Œç„¶åéŸ³é‡é”®é€‰æ‹© recovery modeï¼ŒæŒ‰poweré”®è¿›å…¥Recoveryæ¨¡å¼<br>4ã€Select Wipe-&gt;Advance Wipe-&gt;Select  Data<br>5ã€è¿”å›åˆ°TWRPä¸»ç•Œé¢ï¼šselect Install<br>6ã€Select Magisk-v16.1(1610).zip<br>å®‰è£…åé‡æ–°å¯åŠ¨æ‚¨çš„æ‰‹æœºã€‚</p><h4 id="å…­ã€å‡ºç°çš„é—®é¢˜"><a href="#å…­ã€å‡ºç°çš„é—®é¢˜" class="headerlink" title="å…­ã€å‡ºç°çš„é—®é¢˜"></a>å…­ã€å‡ºç°çš„é—®é¢˜</h4><p>ï¼ˆä¸€ï¼‰é—®é¢˜ï¼šadb å‡ºç° device offlineï¼Œæ›´æ–°adbç‰ˆæœ¬åˆ°1.0.39<br>ï¼ˆäºŒï¼‰é—®é¢˜ï¼šç¬”è€…Pixelæ‰‹æœºæ‰§è¡Œä¸Šè¿°æ­¥éª¤åï¼Œæ— æ³•å¼€æœºï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤å°±å¯ä»¥å¼€æœºäº†ï¼š<br>1ã€å…³æ‰ä½ çš„æ‰‹æœº<br>2ã€Poweré”®+éŸ³é‡ä¸‹é”®è¿›å…¥BootLoaderæ¨¡å¼æ¨¡å¼ï¼Œç„¶åéŸ³é‡é”®é€‰æ‹© recovery modeï¼ŒæŒ‰poweré”®è¿›å…¥Recoveryæ¨¡å¼<br>3ã€Select Wipe-&gt;Advance Wipe-&gt;Select  Data<br>4ã€æ»‘åŠ¨æ¸…é™¤Data</p><p>RootæˆåŠŸï¼Œ(oã‚œâ–½ã‚œ)oâ˜†[BINGO!]</p><h4 id="ä¸ƒã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„è¾›è‹¦å¥‰çŒ®-ï¼š"><a href="#ä¸ƒã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„è¾›è‹¦å¥‰çŒ®-ï¼š" class="headerlink" title="ä¸ƒã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„è¾›è‹¦å¥‰çŒ®)ï¼š"></a>ä¸ƒã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„è¾›è‹¦å¥‰çŒ®)ï¼š</h4><p><a href="https://www.androidinfotech.com/2018/04/root-google-pixel-oreo-8-1-opm2-171019-029.html" target="_blank" rel="noopener">è§£é”BootLoaderæ•™ç¨‹ Unlocking Bootloader in Google Pixel and Pixel XL</a><br><a href="https://www.androidinfotech.com/2018/04/root-google-pixel-oreo-8-1-opm2-171019-029.html" target="_blank" rel="noopener">Rootæ•™ç¨‹åŸæ–‡ Root Google Pixel Oreo 8.1 OPM2.171019.029 Install TWRP</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://www.androidinfotech.com/2018/04/root-google-pixel-oreo-8-1-opm2-171019-029.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Rootæ•™ç¨‹åŸæ–‡
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]</title>
    <link href="http://zhoujinjian.cc/2018/04/03/%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99(%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%9C%89%E8%B6%A3%E7%9A%84%E7%9A%84Loading%20gif)/"/>
    <id>http://zhoujinjian.cc/2018/04/03/ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif)/</id>
    <published>2018-04-02T16:00:00.000Z</published>
    <updated>2018-04-19T14:30:15.322Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ï¼ˆä¸€ï¼‰ã€-Loading-gifï¼š"><a href="#ï¼ˆä¸€ï¼‰ã€-Loading-gifï¼š" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€ Loading gifï¼š"></a>ï¼ˆä¸€ï¼‰ã€ Loading gifï¼š</h4><p>èŒ¶ä¸æ€é¥­ä¸æƒ³ã€ä¸çœ ä¸å¤œæŠ˜è…¾è¿‘ä¸¤å‘¨ï¼Œæ€»ç®—æŠŠä¸ªäººç½‘ç«™æ­å»ºå¥½äº†(à¹‘ä¹›â—¡ä¹›à¹‘)ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/personal.website/01-zhoujinjian.home.loading.gif" alt="Markdown"></p><h4 id="ï¼ˆäºŒï¼‰ã€ä¸ªäººç½‘ç«™ï¼ˆzhoujinjian-ccï¼‰"><a href="#ï¼ˆäºŒï¼‰ã€ä¸ªäººç½‘ç«™ï¼ˆzhoujinjian-ccï¼‰" class="headerlink" title="ï¼ˆäºŒï¼‰ã€ä¸ªäººç½‘ç«™ï¼ˆzhoujinjian.ccï¼‰"></a>ï¼ˆäºŒï¼‰ã€ä¸ªäººç½‘ç«™ï¼ˆzhoujinjian.ccï¼‰</h4><p>é—·éªšçš„ä¸»é¢˜ï¼Œæˆ‘æƒ³åŸºæœ¬ä¹Ÿä¸ä¼šæœ‰äººæ¥æµè§ˆæˆ‘çš„ä¸ªäººç½‘ç«™ï¼Œé—·éªšå°±é—·éªšç‚¹å§(à¹‘ä¹›â—¡ä¹›à¹‘)ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/personal.website/02-zhoujinjian.home.png" alt="Markdown"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/personal.website/03-zhoujinjian.home-2.png" alt="Markdown"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/personal.website/04-zhoujinjian.home-404.png" alt="Markdown"></p><h4 id="ï¼ˆä¸‰ï¼‰ã€æ€»ç»“"><a href="#ï¼ˆä¸‰ï¼‰ã€æ€»ç»“" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€æ€»ç»“"></a>ï¼ˆä¸‰ï¼‰ã€æ€»ç»“</h4><p>ä¸ªäººç½‘ç«™å…ˆæš‚æ—¶å‘Šä¸€æ®µè½äº†ï¼Œæ¥ä¸‹æ¥è¿˜æ˜¯ç»§ç»­è€æœ¬è¡Œåˆ†æAndroid æºä»£ç ï¼Œä¹‹å‰åˆ†æè™½å·²å¤§è‡´æ‰“é€š Appå±‚ -&gt; Frameworkå±‚ -&gt; Nativeå±‚ -&gt; Kernelå±‚ï¼Œå†’ä¼¼æœ‰ä¸€å®šç»éªŒäº†ç„¶å¹¶åµï¼Œè·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œç”Ÿå‘½ä¸æ¯ï¼Œå­¦æ— æ­¢å¢ƒï¼ˆå…¶å®å˜›å°±æ˜¯ -&gt; äººä¸‘å°±è¦å¤šè¯»ä¹¦à¹‘ä¹›â—¡ä¹›à¹‘ï¼‰ã€‚å¥½æƒ³è¯»è¯»ä¹¦å»çœ‹çœ‹å¤–é¢çš„ä¸–ç•Œå•Šã€‚</p><p>where you want to go-&gt;(Castelluccio di Norciaå¡æ–¯ç‰¹é²å¥‡å¥¥å…¬å›­,æ„å¤§åˆ©):</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/personal.website/05-zhoujinjian.home-norcaia.png" alt="Markdown"></p><p>Or-&gt;(Lofoten, Reinebringen(é›·è¨¥),æŒªå¨):</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/personal.website/06-zhoujinjian.home-lofoten.png" alt="Markdown"></p><p>PSï¼šå“‡å“¦ï¼Œå¥½ç¾ï¼Œç®—äº†æˆ‘å°±æƒ³æƒ³<strong>ï¼ˆà²¡Ï‰à²¡ï¼‰</strong>ã€‚</p><h4 id="ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„è¾›è‹¦å¥‰çŒ®-ï¼š"><a href="#ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„è¾›è‹¦å¥‰çŒ®-ï¼š" class="headerlink" title="ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„è¾›è‹¦å¥‰çŒ®)ï¼š"></a>ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„è¾›è‹¦å¥‰çŒ®)ï¼š</h4><p><a href="https://bing.ioliu.cn/v1?p=1&amp;d=0&amp;w=1280&amp;h=768" target="_blank" rel="noopener">Bing å£çº¸ API</a><br><a href="https://api.lylares.com/bing/image/?w=1920&amp;h=1080" target="_blank" rel="noopener">Api-bing-wallpaper</a><br><a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank" rel="noopener">Mrminfive - Hexo-theme-skapp</a><br><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener">Molunerfinn - Hexo-theme-melody</a><br><a href="https://github.com/stkevintan/canoe-blog" target="_blank" rel="noopener">Stkevintan - canoe-blog</a><br><a href="https://www.designernews.co/404" target="_blank" rel="noopener">(404) The page you were looking for doesnâ€™t exist</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ï¼ˆä¸€ï¼‰ã€-Loading-gifï¼š&quot;&gt;&lt;a href=&quot;#ï¼ˆä¸€ï¼‰ã€-Loading-gifï¼š&quot; class=&quot;headerlink&quot; title=&quot;ï¼ˆä¸€ï¼‰ã€ Loading gifï¼š&quot;&gt;&lt;/a&gt;ï¼ˆä¸€ï¼‰ã€ Loading gifï¼š&lt;/h4&gt;&lt;p&gt;èŒ¶ä¸æ€é¥­ä¸æƒ³ã€ä¸çœ ä¸
      
    
    </summary>
    
      <category term="Hexo" scheme="http://zhoujinjian.cc/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="http://zhoujinjian.cc/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]</title>
    <link href="http://zhoujinjian.cc/2018/04/01/Linux%E5%86%85%E6%A0%B8%EF%BC%88Kernel-3-18%EF%BC%89-Input-%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90-i-wonder/"/>
    <id>http://zhoujinjian.cc/2018/04/01/Linuxå†…æ ¸ï¼ˆKernel-3-18ï¼‰-Input-å­ç³»ç»Ÿåˆ†æ-i-wonder/</id>
    <published>2018-03-31T16:00:00.000Z</published>
    <updated>2018-04-19T14:30:10.486Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/linux.input" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p>æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</p><p><strong>kernel/msm-3.18/include/linux</strong></p><ul><li>Input.h</li><li>evdev.h</li></ul><p><strong>kernel/msm-3.18/drivers/input</strong></p><ul><li>Input.c</li><li>evdev.c</li><li>gpio_keys.c</li></ul><p><strong>kernel/msm-3.18/drivers/input/touchscreen/synaptics_dsx_htc_2.6</strong></p><ul><li>Makefile</li><li>Kconfig</li><li>synaptics_dsx_core.c</li></ul><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/linux.input" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆKernel-3.18ï¼‰ï¼š</p><p><a href="https://android.googlesource.com/kernel/msm/+/android-msm-marlin-3.18-nougat-mr2-pixel" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - Google</a> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><hr><h2 id="ï¼ˆä¸€ï¼‰ã€Linux-Input-å­ç³»ç»Ÿæ¡†æ¶"><a href="#ï¼ˆä¸€ï¼‰ã€Linux-Input-å­ç³»ç»Ÿæ¡†æ¶" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Linux Input å­ç³»ç»Ÿæ¡†æ¶"></a>ï¼ˆä¸€ï¼‰ã€Linux Input å­ç³»ç»Ÿæ¡†æ¶</h2><p>è¾“å…¥(Input)å­ç³»ç»Ÿæ˜¯åˆ†å±‚æ¶æ„çš„ï¼Œæ€»å…±åˆ†ä¸º5 å±‚ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯ï¼šç”¨æˆ·ç©ºé—´å±‚ï¼ˆUser Spaceï¼‰äº‹ä»¶å¤„ç†å±‚(Event Handler)ã€è¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒå±‚(Input Core)ã€ç¡¬ä»¶é©±åŠ¨å±‚(Input Driver) ã€ç¡¬ä»¶è®¾å¤‡å±‚ï¼ˆHardwareï¼‰ã€‚</p><p>é©±åŠ¨æ ¹æ®COREæä¾›çš„æ¥å£ï¼Œå‘ä¸ŠæŠ¥å‘Šå‘ç”Ÿçš„æŒ‰é”®åŠ¨ä½œã€‚ç„¶åCOREæ ¹æ®é©±åŠ¨çš„ç±»å‹ï¼Œåˆ†æ´¾è¿™ä¸ªæŠ¥å‘Šç»™å¯¹åº”çš„äº‹ä»¶å¤„ç†å±‚è¿›è¡Œå¤„ç†ã€‚äº‹ä»¶å¤„ç†å±‚æŠŠæ•°æ®å˜åŒ–ååº”åˆ°è®¾å¤‡æ¨¡å‹çš„æ–‡ä»¶ä¸­ï¼ˆäº‹ä»¶ç¼“å†²åŒºï¼‰ã€‚å¹¶é€šçŸ¥åœ¨è¿™äº›è®¾å¤‡æ¨¡å‹æ–‡ä»¶ä¸Šç­‰å¾…çš„è¿›ç¨‹ã€‚</p><p>inputå­ç³»ç»Ÿæ¡†æ¶ï¼š </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/01-Linux-kernel-input-subsystem-framework.png" alt="Markdown"></p><p>(1) â€œç¡¬ä»¶é©±åŠ¨å±‚â€è´Ÿè´£æ“ä½œå…·ä½“çš„ç¡¬ä»¶è®¾å¤‡ï¼Œè¿™å±‚çš„ä»£ç æ˜¯é’ˆå¯¹å…·ä½“çš„é©±åŠ¨ç¨‹åºçš„ï¼Œæ¯”å¦‚ä½ çš„è®¾å¤‡æ˜¯è§¦æ‘¸è¾“å…¥è®¾å¤‡ï¼Œè¿˜æ˜¯é¼ æ ‡è¾“å…¥è®¾å¤‡ï¼Œè¿˜æ˜¯é”®ç›˜è¾“å…¥è®¾å¤‡ï¼Œè¿™äº›ä¸åŒçš„è®¾å¤‡ï¼Œè‡ªç„¶æœ‰ä¸åŒçš„ç¡¬ä»¶æ“ä½œï¼Œé©±åŠ¨å·¥ç¨‹å¸ˆå¾€å¾€åªéœ€è¦å®Œæˆè¿™å±‚çš„ä»£ç ç¼–å†™ã€‚</p><p>(2) â€œè¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒå±‚â€æ˜¯é“¾æ¥å…¶ä»–ä¸¤å±‚ä¹‹é—´çš„çº½å¸¦ä¸æ¡¥æ¢ï¼Œå‘ä¸‹æä¾›ç¡¬ä»¶é©±åŠ¨å±‚çš„æ¥å£ï¼Œå‘ä¸Šæä¾›äº‹ä»¶å¤„ç†å±‚çš„æ¥å£ã€‚</p><p>(3) â€œäº‹ä»¶å¤„ç†å±‚â€ è´Ÿè´£ä¸ç”¨æˆ·ç¨‹åºæ‰“äº¤é“ï¼Œå°†ç¡¬ä»¶é©±åŠ¨å±‚ä¼ æ¥çš„äº‹ä»¶æŠ¥å‘Šç»™ç”¨æˆ·ç¨‹åºã€‚</p><p>å„å±‚ä¹‹é—´é€šä¿¡çš„åŸºæœ¬å•ä½å°±æ˜¯äº‹ä»¶ï¼Œä»»ä½•ä¸€ä¸ªè¾“å…¥è®¾å¤‡çš„åŠ¨ä½œéƒ½å¯ä»¥æŠ½è±¡æˆä¸€ç§äº‹ä»¶ï¼Œå¦‚é”®ç›˜çš„æŒ‰ä¸‹ï¼Œè§¦æ‘¸å±çš„æŒ‰ä¸‹ï¼Œé¼ æ ‡çš„ç§»åŠ¨ç­‰ã€‚äº‹ä»¶æœ‰ä¸‰ç§å±æ€§ï¼šç±»å‹ï¼ˆtypeï¼‰ï¼Œç¼–ç (code)ï¼Œå€¼(value)ï¼Œ Input å­ç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰äº‹ä»¶éƒ½å®šä¹‰åœ¨ input.hä¸­ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ”¯æŒçš„ç±»å‹ï¼Œæ‰€å±ç±»å‹æ”¯æŒçš„ç¼–ç ç­‰ã€‚äº‹ä»¶ä¼ é€çš„æ–¹å‘æ˜¯ ç¡¬ä»¶é©±åŠ¨å±‚â€“&gt;å­ç³»ç»Ÿæ ¸å¿ƒâ€“&gt;äº‹ä»¶å¤„ç†å±‚â€“&gt;ç”¨æˆ·ç©ºé—´ã€‚</p><h2 id="ï¼ˆäºŒï¼‰ã€Input-ä¸»è¦é€šç”¨æ•°æ®ç»“æ„"><a href="#ï¼ˆäºŒï¼‰ã€Input-ä¸»è¦é€šç”¨æ•°æ®ç»“æ„" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Input ä¸»è¦é€šç”¨æ•°æ®ç»“æ„"></a>ï¼ˆäºŒï¼‰ã€Input ä¸»è¦é€šç”¨æ•°æ®ç»“æ„</h2><h2 id="2-1ã€input-dev"><a href="#2-1ã€input-dev" class="headerlink" title="2.1ã€input_dev"></a>2.1ã€input_dev</h2><p>è¾“å…¥è®¾å¤‡ input_devï¼Œè¿™æ˜¯inputè®¾å¤‡åŸºæœ¬çš„è®¾å¤‡ç»“æ„ï¼Œæ¯ä¸ªinputé©±åŠ¨ç¨‹åºä¸­éƒ½å¿…é¡»åˆ†é…åˆå§‹åŒ–è¿™æ ·ä¸€ä¸ªç»“æ„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;    <span class="comment">//è¾“å…¥è®¾å¤‡çš„åç§°  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *phys;    <span class="comment">//è¾“å…¥è®¾å¤‡èŠ‚ç‚¹åç§°  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *uniq;    <span class="comment">//æŒ‡å®šå”¯ä¸€çš„IDå·ï¼Œå°±åƒMACåœ°å€ä¸€æ ·</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_id</span> <span class="title">id</span>;</span>    <span class="comment">//è¾“å…¥è®¾å¤‡æ ‡è¯†IDï¼Œç”¨äºå’Œäº‹ä»¶å¤„ç†å±‚è¿›è¡ŒåŒ¹é…</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> propbit[BITS_TO_LONGS(INPUT_PROP_CNT)];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> evbit[BITS_TO_LONGS(EV_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> keybit[BITS_TO_LONGS(KEY_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„æŒ‰é”®ç±»å‹      </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> relbit[BITS_TO_LONGS(REL_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„ç›¸å¯¹åæ ‡  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> absbit[BITS_TO_LONGS(ABS_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„ç»å¯¹åæ ‡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> mscbit[BITS_TO_LONGS(MSC_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„å…¶ä»–åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ledbit[BITS_TO_LONGS(LED_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„æŒ‡ç¤ºç¯</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sndbit[BITS_TO_LONGS(SND_CNT)];   <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„å£°éŸ³æˆ–è­¦æŠ¥</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ffbit[BITS_TO_LONGS(FF_CNT)];     <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„ä½œç”¨åŠ›åŠŸèƒ½  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> swbit[BITS_TO_LONGS(SW_CNT)];     <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„å¼€å…³åŠŸèƒ½</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hint_events_per_packet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> keycodemax;      <span class="comment">//è®¾å¤‡æ”¯æŒçš„æœ€å¤§æŒ‰é”®å€¼ä¸ªæ•°  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> keycodesize;    <span class="comment">//æ¯ä¸ªæŒ‰é”®çš„å­—èŠ‚å¤§å°</span></span><br><span class="line">    <span class="keyword">void</span> *keycode;      <span class="comment">//æŒ‡å‘æŒ‰é”®æ± ï¼Œå³æŒ‡å‘æŒ‰é”®å€¼æ•°ç»„é¦–åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*setkeycode)(struct input_dev *dev,</span><br><span class="line">              <span class="keyword">const</span> struct input_keymap_entry *ke,</span><br><span class="line">              <span class="keyword">unsigned</span> <span class="keyword">int</span> *old_keycode);    <span class="comment">//ä¿®æ”¹æŒ‰é”®å€¼</span></span><br><span class="line">    <span class="keyword">int</span> (*getkeycode)(struct input_dev *dev,</span><br><span class="line">              struct input_keymap_entry *ke);   <span class="comment">//è·å–æŒ‰é”®å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ff_device</span> *<span class="title">ff</span>;</span>     <span class="comment">//ç”¨äºå¼ºåˆ¶æ›´æ–°è¾“å…¥è®¾å¤‡çš„éƒ¨åˆ†å†…å®¹  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> repeat_key;    <span class="comment">//é‡å¤æŒ‰é”®çš„é”®å€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">timer</span>;</span>   <span class="comment">//è®¾ç½®å½“æœ‰è¿å‡»æ—¶çš„å»¶æ—¶å®šæ—¶å™¨  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rep[REP_CNT];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_mt</span> *<span class="title">mt</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_absinfo</span> *<span class="title">absinfo</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> key[BITS_TO_LONGS(KEY_CNT)];    <span class="comment">//ä½å›¾ï¼ŒæŒ‰é”®çš„çŠ¶æ€  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> led[BITS_TO_LONGS(LED_CNT)];    <span class="comment">//ä½å›¾ï¼Œledçš„çŠ¶æ€  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> snd[BITS_TO_LONGS(SND_CNT)];    <span class="comment">//ä½å›¾ï¼Œå£°éŸ³çš„çŠ¶æ€  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sw[BITS_TO_LONGS(SW_CNT)];   <span class="comment">//ä½å›¾ï¼Œå¼€å…³çš„çŠ¶æ€  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*open)(struct input_dev *dev);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct input_dev *dev);</span><br><span class="line">    <span class="keyword">int</span> (*flush)(struct input_dev *dev, struct file *file);</span><br><span class="line">    <span class="keyword">int</span> (*event)(struct input_dev *dev, <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> __<span class="title">rcu</span> *<span class="title">grab</span>;</span> <span class="comment">//ç±»ä¼¼ç§æœ‰æŒ‡é’ˆï¼Œå¯ä»¥ç›´æ¥è®¿é—®åˆ°äº‹ä»¶å¤„ç†æ¥å£event  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">spinlock_t</span> event_lock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> users;</span><br><span class="line">    <span class="keyword">bool</span> going_away;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">h_list</span>;</span> <span class="comment">//è¯¥é“¾è¡¨å¤´ç”¨äºé“¾æ¥æ­¤è®¾å¤‡æ‰€å…³è”çš„input_handle   </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">node</span>;</span> <span class="comment">//ç”¨äºå°†æ­¤è®¾å¤‡é“¾æ¥åˆ°input_dev_list(é“¾æ¥äº†æ‰€æœ‰æ³¨å†Œåˆ°å†…æ ¸çš„äº‹ä»¶å¤„ç†å™¨)  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_vals;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> max_vals;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">vals</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> devres_managed;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2-1ã€input-handler"><a href="#2-1ã€input-handler" class="headerlink" title="2.1ã€input_handler"></a>2.1ã€input_handler</h2><p>input_handler è¿™æ˜¯äº‹ä»¶å¤„ç†å™¨çš„æ•°æ®ç»“æ„ï¼Œä»£è¡¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line">    <span class="comment">/* å½“äº‹ä»¶å¤„ç†å™¨æ¥æ”¶åˆ°æ¥è‡ªInputè®¾å¤‡ä¼ æ¥çš„äº‹ä»¶æ—¶è°ƒç”¨çš„å¤„ç†å‡½æ•°,</span></span><br><span class="line"><span class="comment">        eventã€eventsç”¨äºå¤„ç†äº‹ä»¶ */</span>  </span><br><span class="line">    <span class="keyword">void</span> (*event)(struct input_handle *handle, <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value);</span><br><span class="line">    <span class="keyword">void</span> (*events)(struct input_handle *handle,</span><br><span class="line">               <span class="keyword">const</span> struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">bool</span> (*filter)(struct input_handle *handle, <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value);</span><br><span class="line">    <span class="comment">/* æ¯”è¾ƒ device's id with handler's id_table ï¼ŒåŒ¹é…device and handler*/</span></span><br><span class="line">    <span class="keyword">bool</span> (*match)(struct input_handler *handler, struct input_dev *dev);</span><br><span class="line">    <span class="comment">/* connectç”¨äºå»ºç«‹intput_handlerå’Œinput_devçš„è”ç³»,</span></span><br><span class="line"><span class="comment">       å½“ä¸€ä¸ªInputè®¾å¤‡æ³¨å†Œåˆ°å†…æ ¸çš„æ—¶å€™è¢«è°ƒç”¨,å°†è¾“å…¥è®¾å¤‡ä¸äº‹ä»¶å¤„ç†å™¨è”ç»“èµ·æ¥ */</span></span><br><span class="line">    <span class="keyword">int</span> (*connect)(struct input_handler *handler, struct input_dev *dev, <span class="keyword">const</span> struct input_device_id *id);</span><br><span class="line">    <span class="comment">/* disconnectç”¨äºè§£é™¤handlerå’Œdeviceçš„è”ç³» */</span></span><br><span class="line">    <span class="keyword">void</span> (*disconnect)(struct input_handle *handle);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct input_handle *handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> legacy_minors;</span><br><span class="line">    <span class="keyword">int</span> minor;    <span class="comment">//æ¬¡è®¾å¤‡å·</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;    <span class="comment">//æ¬¡è®¾å¤‡å·</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id_table</span>;</span>    <span class="comment">//ç”¨äºå’ŒdeviceåŒ¹é… ,è¿™ä¸ªæ˜¯äº‹ä»¶å¤„ç†å™¨æ‰€æ”¯æŒçš„inputè®¾å¤‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ä¸ªé“¾è¡¨ç”¨æ¥é“¾æ¥ä»–æ‰€æ”¯æŒçš„input_handleç»“æ„,input_devä¸input_handleré…å¯¹ä¹‹åå°±ä¼šç”Ÿæˆä¸€ä¸ªinput_handleç»“æ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">h_list</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//é“¾æ¥åˆ°input_handler_listï¼Œè¿™ä¸ªé“¾è¡¨é“¾æ¥äº†æ‰€æœ‰æ³¨å†Œåˆ°å†…æ ¸çš„äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2-3ã€input-handle"><a href="#2-3ã€input-handle" class="headerlink" title="2.3ã€input_handle"></a>2.3ã€input_handle</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    æ¯ä¸ªé…å¯¹çš„äº‹ä»¶å¤„ç†å™¨éƒ½ä¼šåˆ†é…ä¸€ä¸ªå¯¹åº”çš„è®¾å¤‡ç»“æ„ï¼Œå¦‚evdeväº‹ä»¶å¤„ç†å™¨çš„evdevç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment">    æ³¨æ„è¿™ä¸ªç»“æ„ä¸è®¾å¤‡é©±åŠ¨å±‚çš„input_devä¸åŒï¼Œåˆå§‹åŒ–handleæ—¶ï¼Œä¿å­˜åˆ°è¿™é‡Œã€‚   </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    æ‰“å¼€æ ‡å¿—ï¼Œæ¯ä¸ªinput_handle æ‰“å¼€åæ‰èƒ½æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment">    è¿™ä¸ªä¸€èˆ¬é€šè¿‡äº‹ä»¶å¤„ç†å™¨çš„openæ–¹æ³•é—´æ¥è®¾ç½®  </span></span><br><span class="line"><span class="comment">    */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> open;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="comment">/* æŒ‡å‘Input_devç»“æ„å®ä½“ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="comment">/* æŒ‡å‘Input_Handerç»“æ„å®ä½“ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span>;</span></span><br><span class="line">    <span class="comment">/* input_handleé€šè¿‡d_nodeè¿æ¥åˆ°äº†input_devä¸Šçš„h_listé“¾è¡¨ä¸Š */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">d_node</span>;</span></span><br><span class="line">    <span class="comment">/* input_handleé€šè¿‡h_nodeè¿æ¥åˆ°äº†input_handlerçš„h_listé“¾è¡¨ä¸Š */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">h_node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2-4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»"><a href="#2-4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»" class="headerlink" title="2.4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»"></a>2.4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»</h2><blockquote><p>input_dev: æ˜¯ç¡¬ä»¶é©±åŠ¨å±‚ï¼Œä»£è¡¨ä¸€ä¸ªinputè®¾å¤‡ã€‚ input_handler: æ˜¯äº‹ä»¶å¤„ç†å±‚ï¼Œä»£è¡¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ã€‚ input_handle: å±äºæ ¸å¿ƒå±‚ï¼Œä»£è¡¨ä¸€ä¸ªé…å¯¹çš„input_devä¸input_handler</p></blockquote><p>input_dev é€šè¿‡å…¨å±€çš„input_dev_listé“¾æ¥åœ¨ä¸€èµ·ã€‚è®¾å¤‡æ³¨å†Œçš„æ—¶å€™å®ç°è¿™ä¸ªæ“ä½œã€‚æ³¨ï¼šï¼ˆç¨åè¯¦ç»†åˆ†æï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(input_dev_list)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(input_handler_list)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_device</span><span class="params">(struct input_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_devres</span> *<span class="title">devres</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> packet_size;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">    list_add_tail(&amp;dev-&gt;node, &amp;input_dev_list);</span><br><span class="line"></span><br><span class="line">    list_for_each_entry(handler, &amp;input_handler_list, node)</span><br><span class="line">        input_attach_handler(dev, handler);</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>input_handler é€šè¿‡å…¨å±€çš„input_handler_listé“¾æ¥åœ¨ä¸€èµ·ã€‚äº‹ä»¶å¤„ç†å™¨æ³¨å†Œçš„æ—¶å€™å®ç°è¿™ä¸ªæ“ä½œï¼ˆäº‹ä»¶å¤„ç†å™¨ä¸€èˆ¬å†…æ ¸è‡ªå¸¦ï¼Œä¸€èˆ¬ä¸éœ€è¦æˆ‘ä»¬æ¥å†™ï¼‰æ³¨ï¼šï¼ˆç¨åè¯¦ç»†åˆ†æï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(input_dev_list)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(input_handler_list)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_handler</span><span class="params">(struct input_handler *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    ......</span><br><span class="line">    list_add_tail(&amp;handler-&gt;node, &amp;input_handler_list);</span><br><span class="line"></span><br><span class="line">    list_for_each_entry(dev, &amp;input_dev_list, node)</span><br><span class="line">        input_attach_handler(dev, handler);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>input_hande æ²¡æœ‰ä¸€ä¸ªå…¨å±€çš„é“¾è¡¨ï¼Œå®ƒæ³¨å†Œçš„æ—¶å€™å°†è‡ªå·±åˆ†åˆ«æŒ‚åœ¨äº†input_dev å’Œ input_handler çš„h_listä¸Šäº†ã€‚é€šè¿‡input_dev å’Œinput_handlerå°±å¯ä»¥æ‰¾åˆ°input_handleåœ¨è®¾å¤‡æ³¨å†Œå’Œäº‹ä»¶å¤„ç†å™¨ï¼Œæ³¨å†Œçš„æ—¶å€™éƒ½è¦è¿›è¡Œé…å¯¹å·¥ä½œ<strong>(input_match_device)</strong>ï¼Œé…å¯¹åå°±ä¼šå®ç°é“¾æ¥<strong>(handler-&gt;connect)</strong>é€šè¿‡input_handleä¹Ÿå¯ä»¥æ‰¾åˆ°input_devå’Œinput_handlerã€‚æ³¨ï¼šï¼ˆç¨åè¯¦ç»†åˆ†æï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">input_attach_handler</span><span class="params">(struct input_dev *dev, struct input_handler *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    id = input_match_device(handler, dev);</span><br><span class="line">    ......</span><br><span class="line">    error = handler-&gt;connect(handler, dev, id);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œinput_deviceå’Œinput_handlerä¸­éƒ½æœ‰ä¸€ä¸ªh_list,è€Œinput_handleæ‹¥æœ‰æŒ‡å‘input_devå’Œinput_handlerçš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´input_handleæ˜¯ç”¨æ¥å…³è”input_devå’Œinput_handlerçš„ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆä¸€ä¸ªinput_deviceå’Œinput_handlerä¸­æ‹¥æœ‰çš„æ˜¯h_listè€Œä¸æ˜¯ä¸€ä¸ªhandleå‘¢ï¼Ÿå› ä¸ºä¸€ä¸ªdeviceå¯èƒ½å¯¹åº”å¤šä¸ªhandler,è€Œä¸€ä¸ªhandlerä¹Ÿä¸èƒ½åªå¤„ç†ä¸€ä¸ªdevice,æ¯”å¦‚è¯´ä¸€ä¸ªé¼ æ ‡ï¼Œå®ƒå¯ä»¥å¯¹åº”even handlerï¼Œä¹Ÿå¯ä»¥å¯¹åº”mouse handler,å› æ­¤å½“å…¶æ³¨å†Œæ—¶ä¸ç³»ç»Ÿä¸­çš„handlerè¿›è¡ŒåŒ¹é…ï¼Œå°±æœ‰å¯èƒ½äº§ç”Ÿä¸¤ä¸ªå®ä¾‹ï¼Œä¸€ä¸ªæ˜¯evdev,å¦ä¸€ä¸ªæ˜¯mousedev,è€Œä»»ä½•ä¸€ä¸ªå®ä¾‹ä¸­éƒ½åªæœ‰ä¸€ä¸ªhandleã€‚è‡³äºä»¥ä½•ç§æ–¹å¼æ¥ä¼ é€’äº‹ä»¶ï¼Œå°±ç”±ç”¨æˆ·ç¨‹åºæ‰“å¼€å“ªä¸ªå®ä¾‹æ¥å†³å®šã€‚åé¢ä¸€ä¸ªæƒ…å†µå¾ˆå®¹æ˜“ç†è§£ï¼Œä¸€ä¸ªäº‹ä»¶é©±åŠ¨ä¸èƒ½åªä¸ºä¸€ä¸ªç”šè‡³ä¸€ç§è®¾å¤‡æœåŠ¡ï¼Œç³»ç»Ÿä¸­å¯èƒ½æœ‰å¤šç§è®¾å¤‡éƒ½èƒ½ä½¿ç”¨è¿™ç±»handler,æ¯”å¦‚event handlerå°±å¯ä»¥åŒ¹é…æ‰€æœ‰çš„è®¾å¤‡ã€‚åœ¨inputå­ç³»ç»Ÿä¸­ï¼Œæœ‰8ç§äº‹ä»¶é©±åŠ¨ï¼Œæ¯ç§äº‹ä»¶é©±åŠ¨æœ€å¤šå¯ä»¥å¯¹åº”32ä¸ªè®¾å¤‡ï¼Œå› æ­¤devå®ä¾‹æ€»æ•°æœ€å¤šå¯ä»¥è¾¾åˆ°256ä¸ªã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/02-Linux-kernel-input-dev-handler.png" alt="Markdown"></p><h2 id="ï¼ˆä¸‰ï¼‰ã€Input-æ ¸å¿ƒå±‚ï¼ˆInput-cï¼‰"><a href="#ï¼ˆä¸‰ï¼‰ã€Input-æ ¸å¿ƒå±‚ï¼ˆInput-cï¼‰" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Input æ ¸å¿ƒå±‚ï¼ˆInput.cï¼‰"></a>ï¼ˆä¸‰ï¼‰ã€Input æ ¸å¿ƒå±‚ï¼ˆInput.cï¼‰</h2><p>è¿™ä¸€èŠ‚ä¸»è¦ä»‹ç»æ ¸å¿ƒå±‚çš„åˆå§‹åŒ–ï¼Œinput_deviceã€input_handleã€input_handlerä¹‹é—´çš„å…³ç³»(ç¨åå›å¤´çœ‹æ›´ä½³)ã€‚ æ€»ä½“æ¦‚è§ˆå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/03-Linux-kernel-input-core-h_list.png" alt="Markdown"></p><h2 id="3-1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–"><a href="#3-1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–" class="headerlink" title="3.1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–"></a>3.1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–</h2><p>é¦–å…ˆä»é©±åŠ¨â€å…¥å£å‡½æ•°â€å¼€å§‹æŸ¥çœ‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">input_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="comment">//æ³¨å†Œinputç±»ï¼Œå¯åœ¨/sys/classä¸‹çœ‹åˆ°å¯¹åº”èŠ‚ç‚¹æ–‡ä»¶</span></span><br><span class="line">    err = class_register(&amp;input_class);</span><br><span class="line">    ......</span><br><span class="line">    err = input_proc_init();<span class="comment">/*åˆ›å»º/procä¸­çš„é¡¹ï¼ŒæŸ¥çœ‹/proc/bus/input  */</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/*æ³¨å†Œè®¾å¤‡/dev/inputï¼Œä¸»è®¾å¤‡å·ä¸ºINPUT_MAJORï¼Œå°±æ˜¯13ï¼Œåé¢æ³¨å†Œçš„è¾“å…¥è®¾å¤‡éƒ½ä½¿ç”¨è¯¥ä¸»è®¾å¤‡å·*/</span></span><br><span class="line">    err = register_chrdev_region(MKDEV(INPUT_MAJOR, <span class="number">0</span>),</span><br><span class="line">                     INPUT_MAX_CHAR_DEVICES, <span class="string">"input"</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å…¥å£å‡½æ•°é‡Œé¢åˆ›å»ºäº†ä¸€ä¸ªinput_classç±»ï¼Œå…¶å®å°±åœ¨/sys/classä¸‹åˆ›å»ºäº†ä¸€ä¸ªç›®å½•input.å½“ç„¶å¯¹äºä¸€ä¸ªæ–°è®¾å¤‡ï¼Œå¯ä»¥æ³¨å†Œè¿›ä¸€ä¸ªclassä¹Ÿå¯ä»¥ä¸æ³¨å†Œè¿›å»ï¼Œå¦‚æœå­˜åœ¨å¯¹åº”classçš„è¯æ³¨å†Œè¿›å»æ›´å¥½ï¼Œå¦å¤–åœ¨/procåˆ›å»ºäº†å…¥å£é¡¹,è¿™æ ·å°±å¯ä»¥/procç›®å½•çœ‹åˆ°inputçš„ä¿¡æ¯ï¼Œç„¶åå°±æ³¨å†Œè®¾å¤‡ï¼Œå¯ä»¥çœ‹å‡ºè¾“å…¥å­ç³»ç»Ÿçš„ä¸»è®¾å¤‡å·æ˜¯13ï¼Œåœ¨è¿™é‡Œå¹¶æ²¡æœ‰ç”Ÿæˆè®¾å¤‡æ–‡ä»¶ã€‚åªæ˜¯åœ¨/dev/ç›®å½•ä¸‹åˆ›å»ºäº†inputç›®å½•ï¼Œä»¥åæ‰€æœ‰æ³¨å†Œè¿›ç³»ç»Ÿçš„è¾“å…¥è®¾å¤‡æ–‡ä»¶éƒ½æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚</p><p>ç›¸åº”çš„å¯¹åº”å…³ç³»å¯ä»¥ä½¿ç”¨adb å‘½ä»¤è¿›å…¥æ–‡ä»¶ç³»ç»Ÿä¹‹åï¼Œcat /proc/bus/input/devices ï¼ŒæŸ¥çœ‹å„ä¸ªè®¾å¤‡å¯¹åº”çš„eventå¤šå°‘ï¼Œæ¯”å¦‚Google Pixel æ‰‹æœºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">I: Bus=<span class="number">0000</span> Vendor=<span class="number">0000</span> Product=<span class="number">0003</span> Version=<span class="number">2066</span></span><br><span class="line">N: Name=<span class="string">"synaptics_dsxv26"</span></span><br><span class="line">P: Phys=synaptics_dsx/touch_input</span><br><span class="line">S: Sysfs=/devices/soc/<span class="number">7577000.</span>i2c/i2c<span class="number">-3</span>/<span class="number">3</span><span class="number">-0020</span>/input/input3</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=mdss_fb kgsl event3</span><br><span class="line">B: PROP=<span class="number">2</span></span><br><span class="line">B: EV=b</span><br><span class="line">B: KEY=<span class="number">8000</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">B: ABS=<span class="number">663800000000000</span></span><br></pre></td></tr></table></figure><p>event3 å°±æ˜¯äº‹ä»¶åºå·ï¼Œ æˆ‘ä»¬åœ¨è°ƒè¯•çš„æ—¶å€™ç›´æ¥ adb shell getevent /dev/input/event3ï¼Œæ¥å®æ—¶æ•æ‰ event3 ä¸­å‚¨å­˜çš„æ•°æ®ã€‚</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥çœ‹çœ‹æ€ä¹ˆæ³¨å†Œinputè®¾å¤‡çš„.æˆ‘ä»¬éœ€è¦åœ¨è®¾å¤‡é©±åŠ¨å±‚ä¸­å®Œæˆè¾“å…¥è®¾å¤‡çš„æ³¨å†Œï¼Œé€šè¿‡è°ƒç”¨input_register_device()å‡½æ•°æ¥å®Œæˆï¼Œè¯¥å‡½æ•°çš„ä¸€ä¸ªé‡è¦ä»»åŠ¡å°±æ˜¯å®Œæˆè®¾å¤‡ä¸äº‹ä»¶é©±åŠ¨çš„åŒ¹é…</p><h2 id="3-2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input-dev"><a href="#3-2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input-dev" class="headerlink" title="3.2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input_dev"></a>3.2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input_dev</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_device</span><span class="params">(struct input_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_devres</span> *<span class="title">devres</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> packet_size;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;devres_managed) &#123;</span><br><span class="line">        devres = devres_alloc(devm_input_device_unregister,</span><br><span class="line">                      <span class="keyword">sizeof</span>(struct input_devres), GFP_KERNEL);</span><br><span class="line">        ......</span><br><span class="line">        devres-&gt;input = dev;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//EN_SYNè¿™ä¸ªæ˜¯è®¾å¤‡éƒ½è¦æ”¯æŒçš„äº‹ä»¶ç±»å‹ï¼Œæ‰€ä»¥è¦è®¾ç½®   </span></span><br><span class="line">    <span class="comment">/* Every input device generates EV_SYN/SYN_REPORT events. */</span></span><br><span class="line">    __set_bit(EV_SYN, dev-&gt;evbit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* KEY_RESERVED is not supposed to be transmitted to userspace. */</span></span><br><span class="line">    __clear_bit(KEY_RESERVED, dev-&gt;keybit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Make sure that bitmasks not mentioned in dev-&gt;evbit are clean. */</span></span><br><span class="line">    input_cleanse_bitmasks(dev);</span><br><span class="line"></span><br><span class="line">    packet_size = input_estimate_events_per_packet(dev);</span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;hint_events_per_packet &lt; packet_size)</span><br><span class="line">        dev-&gt;hint_events_per_packet = packet_size;</span><br><span class="line"></span><br><span class="line">    dev-&gt;max_vals = dev-&gt;hint_events_per_packet + <span class="number">2</span>;</span><br><span class="line">    dev-&gt;vals = kcalloc(dev-&gt;max_vals, <span class="keyword">sizeof</span>(*dev-&gt;vals), GFP_KERNEL);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If delay and period are pre-set by the driver, then autorepeating</span></span><br><span class="line"><span class="comment">     * is handled by the driver itself and we don't do it in input.c.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// è¿™ä¸ªå®šæ—¶å™¨æ˜¯ä¸ºäº†é‡å¤æŒ‰é”®è€Œè®¾ç½®çš„</span></span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;rep[REP_DELAY] &amp;&amp; !dev-&gt;rep[REP_PERIOD]) &#123;</span><br><span class="line">        dev-&gt;timer.data = (<span class="keyword">long</span>) dev;</span><br><span class="line">        dev-&gt;timer.function = input_repeat_key;</span><br><span class="line">        dev-&gt;rep[REP_DELAY] = <span class="number">250</span>;</span><br><span class="line">        dev-&gt;rep[REP_PERIOD] = <span class="number">33</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¦‚æœè®¾å¤‡é©±åŠ¨æ²¡æœ‰è®¾ç½®è‡ªå·±çš„è·å–é”®å€¼çš„å‡½æ•°ï¼Œç³»ç»Ÿé»˜è®¤ */</span>  </span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;getkeycode)</span><br><span class="line">        dev-&gt;getkeycode = input_default_getkeycode;</span><br><span class="line">    <span class="comment">/* å¦‚æœè®¾å¤‡é©±åŠ¨æ²¡æœ‰æŒ‡å®šæŒ‰é”®é‡ç½®å‡½æ•°ï¼Œç³»ç»Ÿé»˜è®¤ */</span>  </span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;setkeycode)</span><br><span class="line">        dev-&gt;setkeycode = input_default_setkeycode;</span><br><span class="line"></span><br><span class="line">    error = device_add(&amp;dev-&gt;dev);</span><br><span class="line">    ......</span><br><span class="line">    path = kobject_get_path(&amp;dev-&gt;dev.kobj, GFP_KERNEL);</span><br><span class="line">    pr_info(<span class="string">"%s as %s\n"</span>,</span><br><span class="line">        dev-&gt;name ? dev-&gt;name : <span class="string">"Unspecified device"</span>,</span><br><span class="line">        path ? path : <span class="string">"N/A"</span>);</span><br><span class="line">    kfree(path);</span><br><span class="line"></span><br><span class="line">    error = mutex_lock_interruptible(&amp;input_mutex);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// å°†æ–°åˆ†é…çš„inputè®¾å¤‡è¿æ¥åˆ°input_dev_listé“¾è¡¨ä¸Š  </span></span><br><span class="line">    list_add_tail(&amp;dev-&gt;node, &amp;input_dev_list);</span><br><span class="line">    <span class="comment">/* æ ¸å¿ƒé‡ç‚¹ï¼Œinputè®¾å¤‡åœ¨å¢åŠ åˆ°input_dev_listé“¾è¡¨ä¸Šä¹‹åï¼Œä¼šæŸ¥æ‰¾</span></span><br><span class="line"><span class="comment">     * input_handler_listäº‹ä»¶å¤„ç†é“¾è¡¨ä¸Šçš„handlerè¿›è¡ŒåŒ¹é…ï¼Œè¿™é‡Œçš„åŒ¹é…</span></span><br><span class="line"><span class="comment">     * æ–¹å¼ä¸è®¾å¤‡æ¨¡å‹çš„deviceå’ŒdriveråŒ¹é…è¿‡ç¨‹å¾ˆç›¸ä¼¼ï¼Œæ‰€æœ‰çš„input</span></span><br><span class="line"><span class="comment">     * éƒ½æŒ‚åœ¨input_dev_listä¸Šï¼Œæ‰€æœ‰ç±»å‹çš„äº‹ä»¶éƒ½æŒ‚åœ¨input_handler_list</span></span><br><span class="line"><span class="comment">     * ä¸Šï¼Œè¿›è¡Œâ€œåŒ¹é…ç›¸äº²â€ï¼Œlist_for_each_entryå°±æ˜¯ä¸ªforå¾ªç¯ï¼Œè·³å‡ºæ¡ä»¶éå†äº†ä¸€éï¼Œåˆå›åˆ°é“¾è¡¨å¤´ */</span>  </span><br><span class="line">    list_for_each_entry(handler, &amp;input_handler_list, node)</span><br><span class="line">        input_attach_handler(dev, handler);</span><br><span class="line"></span><br><span class="line">    input_wakeup_procfs_readers();</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;input_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;devres_managed) &#123;</span><br><span class="line">        dev_dbg(dev-&gt;dev.parent, <span class="string">"%s: registering %s with devres.\n"</span>,</span><br><span class="line">            __func__, dev_name(&amp;dev-&gt;dev));</span><br><span class="line">        devres_add(dev-&gt;dev.parent, devres);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¸»è¦çš„åŠŸèƒ½æœ‰ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼Œä¹Ÿæ˜¯è®¾å¤‡é©±åŠ¨æ³¨å†Œä¸ºè¾“å…¥è®¾å¤‡å§”æ‰˜å†…æ ¸åšçš„äº‹æƒ…ï¼š</p><p>1ã€è¿›ä¸€æ­¥åˆå§‹åŒ–è¾“å…¥è®¾å¤‡ï¼Œä¾‹å¦‚è¿å‡»äº‹ä»¶ 2ã€æ³¨å†Œè¾“å…¥è®¾å¤‡åˆ°inputç±»ä¸­ï¼ŒæŠŠè¾“å…¥è®¾å¤‡æŒ‚åˆ°è¾“å…¥è®¾å¤‡é“¾è¡¨input_dev_listä¸­ 3ã€æŸ¥æ‰¾å¹¶åŒ¹é…è¾“å…¥è®¾å¤‡å¯¹åº”çš„äº‹ä»¶å¤„ç†å±‚ï¼Œé€šè¿‡input_handler_listé“¾è¡¨</p><p>æˆ‘ä»¬éœ€è¦å†åˆ†æä¸‹è¿™ä¸ªåŒ¹é…çš„è¿‡ç¨‹ï¼Œinput_attach_handler()åŒ¹é…è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">input_attach_handler</span><span class="params">(struct input_dev *dev, struct input_handler *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    <span class="comment">/* input_dev å’Œ input_handler è¿›è¡ŒåŒ¹é…,è¿”å›åŒ¹é…çš„idï¼Œç±»å‹æ˜¯struct input_device_id  */</span>  </span><br><span class="line">    id = input_match_device(handler, dev);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* åŒ¹é…æˆåŠŸï¼Œè°ƒç”¨handleré‡Œé¢çš„connectå‡½æ•°,è¿™ä¸ªå‡½æ•°åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­å®šä¹‰ï¼Œä¸»è¦ç”Ÿæˆä¸€ä¸ªinput_handleç»“æ„ï¼Œå¹¶åˆå§‹åŒ–ï¼Œè¿˜ç”Ÿæˆä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ç›¸å…³çš„è®¾å¤‡ç»“æ„ */</span>  </span><br><span class="line">    error = handler-&gt;connect(handler, dev, id);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹input_match_deviceï¼ˆï¼‰å‡½æ•°ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªåŒ¹é…çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•åŒ¹é…çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼ŒåŒ¹é…çš„ç»“æœä¼šæ˜¯ä»€ä¹ˆ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> struct input_device_id *<span class="title">input_match_device</span><span class="params">(struct input_handler *handler,</span></span></span><br><span class="line"><span class="function"><span class="params">                            struct input_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (id = handler-&gt;id_table; id-&gt;flags || id-&gt;driver_info; id++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id-&gt;flags &amp; INPUT_DEVICE_ID_MATCH_BUS)</span><br><span class="line">            <span class="keyword">if</span> (id-&gt;bustype != dev-&gt;id.bustype) <span class="comment">//åŒ¹é…æ€»çº¿id</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id-&gt;flags &amp; INPUT_DEVICE_ID_MATCH_VENDOR)</span><br><span class="line">            <span class="keyword">if</span> (id-&gt;vendor != dev-&gt;id.vendor)  <span class="comment">//åŒ¹é…ç”Ÿäº§å•†id</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id-&gt;flags &amp; INPUT_DEVICE_ID_MATCH_PRODUCT)</span><br><span class="line">            <span class="keyword">if</span> (id-&gt;product != dev-&gt;id.product)  <span class="comment">//åŒ¹é…äº§å“id  </span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id-&gt;flags &amp; INPUT_DEVICE_ID_MATCH_VERSION)</span><br><span class="line">            <span class="keyword">if</span> (id-&gt;version != dev-&gt;id.version) <span class="comment">//åŒ¹é…ç‰ˆæœ¬  </span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åŒ¹é…idçš„evbitå’Œinput_devä¸­evbitçš„å„ä¸ªä½ï¼Œå¦‚æœä¸åŒ¹é…åˆ™continueï¼Œæ•°ç»„ä¸­ä¸‹ä¸€ä¸ªè®¾å¤‡  </span></span><br><span class="line">        <span class="keyword">if</span> (!bitmap_subset(id-&gt;evbit, dev-&gt;evbit, EV_MAX))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (!bitmap_subset(id-&gt;swbit, dev-&gt;swbit, SW_MAX))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!handler-&gt;match || handler-&gt;match(handler, dev))</span><br><span class="line">            <span class="keyword">return</span> id;<span class="comment">//åŒ¹é…æˆåŠŸ,è¿”å›id</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>input_match_device() åˆ°æœ€åˆé€‚çš„äº‹ä»¶å¤„ç†å±‚é©±åŠ¨æ—¶ï¼Œä¾¿æ‰§è¡Œhandler-&gt;connect() å‡½æ•°è¿›è¡Œè¿æ¥äº†ï¼Œçœ‹ä¸‹é¢è¿™éƒ¨åˆ†ä»£ç ï¼ˆä»¥evdevç±»å‹é©±åŠ¨ä¸ºä¾‹ï¼Œåœ¨input/evdev.cä¸­ï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">evdev_connect</span><span class="params">(struct input_handler *handler, struct input_dev *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">const</span> struct input_device_id *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> minor;</span><br><span class="line">    <span class="keyword">int</span> dev_no;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    <span class="comment">/* EVDEV_MINORSä¸º32ï¼Œä»£è¡¨å…±èƒ½å®¹çº³32ä¸ªevdeväº‹ä»¶å±‚è®¾å¤‡ï¼Œä¸‹é¢ä»£ç åœ¨æ‰¾åˆ°ç©ºçš„åœ°æ–¹ï¼Œç”¨äºä¿å­˜evdeväº‹ä»¶å±‚çš„æ•°æ®ï¼Œå³ä¸Šé¢å®šä¹‰çš„evdev */</span></span><br><span class="line">    minor = input_get_new_minor(EVDEV_MINOR_BASE, EVDEV_MINORS, <span class="literal">true</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* å¼€å§‹ç»™evdeväº‹ä»¶å±‚é©±åŠ¨åˆ†é…ç©ºé—´äº† */</span></span><br><span class="line">    evdev = kzalloc(<span class="keyword">sizeof</span>(struct evdev), GFP_KERNEL);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–client_liståˆ—è¡¨å’Œevdev_waité˜Ÿåˆ—ï¼Œåé¢ä»‹ç» */</span></span><br><span class="line">    INIT_LIST_HEAD(&amp;evdev-&gt;client_list);</span><br><span class="line">    spin_lock_init(&amp;evdev-&gt;client_lock);</span><br><span class="line">    mutex_init(&amp;evdev-&gt;mutex);</span><br><span class="line">    init_waitqueue_head(&amp;evdev-&gt;wait);</span><br><span class="line">    evdev-&gt;exist = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–evdevç»“æ„ä½“ï¼Œå…¶ä¸­handleä¸ºè¾“å…¥è®¾å¤‡å’Œäº‹ä»¶å¤„ç†çš„å…³è”æ¥å£ */</span></span><br><span class="line">    dev_no = minor;</span><br><span class="line">    <span class="comment">/* Normalize device number if it falls into legacy range */</span></span><br><span class="line">    <span class="keyword">if</span> (dev_no &lt; EVDEV_MINOR_BASE + EVDEV_MINORS)</span><br><span class="line">        dev_no -= EVDEV_MINOR_BASE;</span><br><span class="line">    dev_set_name(&amp;evdev-&gt;dev, <span class="string">"event%d"</span>, dev_no);</span><br><span class="line">    <span class="comment">/*è¿™é‡Œå°±å°†handleçš„devæŒ‡é’ˆæŒ‡å‘äº†input_dev*/</span></span><br><span class="line">    evdev-&gt;handle.dev = input_get_device(dev);</span><br><span class="line">    evdev-&gt;handle.name = dev_name(&amp;evdev-&gt;dev);</span><br><span class="line">    evdev-&gt;handle.handler = handler;<span class="comment">/*è¿™é‡Œå°†handleçš„handleræŒ‡å‘äº†å½“å‰çš„input_handler.æ³¨æ„æœ¬å‡½æ•°evdev_connect,å¯èƒ½æ˜¯åœ¨åœ¨è¾“å…¥è®¾å¤‡æ³¨å†Œçš„æ—¶å€™</span></span><br><span class="line"><span class="comment">38     åœ¨input_register_deviceå‡½æ•°ä¸­è°ƒç”¨input_attach_handlerçš„æ—¶å€™è°ƒç”¨;ä¹Ÿå¯èƒ½æ˜¯åœ¨è¾“å…¥è®¾å¤‡çš„å¤„ç†æ–¹æ³•input_handleræ—¶åœ¨input_register_handler</span></span><br><span class="line"><span class="comment">39     å‡½æ•°ä¸­ä¹Ÿä¼šç”¨åˆ°input_attach_handlerå‡½æ•°,å°±ä¼šè°ƒç”¨æœ¬å‡½æ•°.è¿™é‡Œå°±å¾ˆæ˜æ˜¾äº†,æœ¬å‡½æ•°å°±å°†input_handlerå’Œinput_devéƒ½æ”¾åœ¨input_handleä¸­ç»Ÿä¸€ç®¡ç†*/</span></span><br><span class="line">    evdev-&gt;handle.<span class="keyword">private</span> = evdev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*åˆå§‹åŒ–evdevä¸­çš„å†…åµŒdevice*/</span></span><br><span class="line">    evdev-&gt;dev.devt = MKDEV(INPUT_MAJOR, minor);</span><br><span class="line">    evdev-&gt;dev.class = &amp;input_class;</span><br><span class="line">    evdev-&gt;dev.parent = &amp;dev-&gt;dev;</span><br><span class="line">    evdev-&gt;dev.release = evdev_free;</span><br><span class="line">    device_initialize(&amp;evdev-&gt;dev);</span><br><span class="line">   <span class="comment">/* input_devè®¾å¤‡é©±åŠ¨å±‚å’Œinput_handleräº‹ä»¶å¤„ç†å±‚çš„å…³è”ï¼Œç”±input_handleå®Œæˆ(ä¸è¦å’Œhandlerææ··æ·†äº†ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½) */</span>  </span><br><span class="line">    error = input_register_handle(&amp;evdev-&gt;handle);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;evdev-&gt;cdev, &amp;evdev_fops);</span><br><span class="line">    evdev-&gt;cdev.kobj.parent = &amp;evdev-&gt;dev.kobj;</span><br><span class="line">    error = cdev_add(&amp;evdev-&gt;cdev, evdev-&gt;dev.devt, <span class="number">1</span>);</span><br><span class="line">    ......</span><br><span class="line">    error = device_add(&amp;evdev-&gt;dev);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handler"><a href="#3-3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handler" class="headerlink" title="3.3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handler"></a>3.3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handler</h2><p>ä¸ºäº†é€»è¾‘æ›´æ¸…æ–°ï¼Œæˆ‘ä»¬ç¨åå†æ¥çœ‹input_register_handle() ç¨‹ï¼Œå…ˆæ¥äº†è§£input_handlerçš„æ³¨å†Œè¿‡ç¨‹ã€‚ è¦äº†è§£input_handlerçš„æ³¨å†Œè¿‡ç¨‹ï¼Œåˆéœ€è¦å…ˆäº†è§£evdevåˆå§‹åŒ–è¿‡ç¨‹ï¼ˆä»¥evdevä¸ºä¾‹ï¼‰ï¼š /kernel/drivers/inputä¸‹ä¼—å¤šäº‹ä»¶å¤„ç†å™¨handlerå…¶ä¸­çš„ä¸€ä¸ªï¼Œå¯ä»¥çœ‹ä¸‹æºç /kernel/drivers/input/evdev.cä¸­çš„æ¨¡å—init</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;edev.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">evdev_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> input_register_handler(&amp;evdev_handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåˆå§‹åŒ–å°±æ˜¯å¾€inputæ ¸å¿ƒä¸­æ³¨å†Œä¸€ä¸ªinput_handlerç±»å‹çš„evdev_handlerï¼Œè°ƒç”¨çš„æ˜¯input.cæä¾›çš„æ¥å£ï¼Œinput_handlerç»“æ„å‰é¢æœ‰ä»‹ç»ï¼Œçœ‹ä¸‹evdev_handlerçš„èµ‹å€¼ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;edev.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> <span class="title">evdev_handler</span> = &#123;</span></span><br><span class="line">    .event        = evdev_event,</span><br><span class="line">    .events        = evdev_events,</span><br><span class="line">    .connect    = evdev_connect,</span><br><span class="line">    .disconnect    = evdev_disconnect,</span><br><span class="line">    .legacy_minors    = <span class="literal">true</span>,</span><br><span class="line">    .minor        = EVDEV_MINOR_BASE,</span><br><span class="line">    .name        = <span class="string">"evdev"</span>,</span><br><span class="line">    .id_table    = evdev_ids,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„çš„æ˜¯evdevæ˜¯åŒ¹é…æ‰€æœ‰è®¾å¤‡çš„ï¼Œå› ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;edev.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> <span class="title">evdev_ids</span>[] = &#123;</span></span><br><span class="line">    &#123; .driver_info = <span class="number">1</span> &#125;,    <span class="comment">/* Matches all devices */</span></span><br><span class="line">    &#123; &#125;,            <span class="comment">/* Terminating zero entry */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_handler</span><span class="params">(struct input_handler *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    error = mutex_lock_interruptible(&amp;input_mutex);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    INIT_LIST_HEAD(&amp;handler-&gt;h_list);</span><br><span class="line">    <span class="comment">//æ·»åŠ è¿›input_handler_listå…¨å±€é“¾è¡¨</span></span><br><span class="line">    list_add_tail(&amp;handler-&gt;node, &amp;input_handler_list);</span><br><span class="line">    <span class="comment">//åŒæ ·éå†input_devè¿™ä¸ªé“¾è¡¨ï¼Œä¾æ¬¡è°ƒç”¨ä¸‹é¢çš„input_attach_handlerå»åŒ¹é…input_dev,è¿™ä¸ªè·Ÿinput_devæ³¨å†Œçš„æ—¶å€™çš„æƒ…å½¢ç±»ä¼¼  </span></span><br><span class="line">    list_for_each_entry(dev, &amp;input_dev_list, node)</span><br><span class="line">        input_attach_handler(dev, handler);</span><br><span class="line"></span><br><span class="line">    input_wakeup_procfs_readers();</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;input_mutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰"><a href="#3-4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰" class="headerlink" title="3.4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰"></a>3.4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰</h2><p>input_handleå…³è”åŒ¹é…input_devå’Œinput_handler ç»§ç»­åˆ†æinput_devå’Œinput_handler æ˜¯å¦‚ä½•å…³è”ä¸Šçš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_handle</span><span class="params">(struct input_handle *handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span> = <span class="title">handle</span>-&gt;<span class="title">handler</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span> = <span class="title">handle</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    error = mutex_lock_interruptible(&amp;dev-&gt;mutex);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†d_nodeé“¾æ¥åˆ°è¾“å…¥è®¾å¤‡çš„h_listï¼Œh_nodeé“¾æ¥åˆ°äº‹ä»¶å±‚çš„h_listé“¾è¡¨ä¸Š</span></span><br><span class="line"><span class="comment">    * å› æ­¤ï¼Œåœ¨handleä¸­æ˜¯è¾“å…¥è®¾å¤‡å’Œäº‹ä»¶å±‚çš„å…³è”ç»“æ„ä½“ï¼Œé€šè¿‡è¾“å…¥è®¾å¤‡å¯ä»¥</span></span><br><span class="line"><span class="comment">    * æ‰¾åˆ°å¯¹åº”çš„äº‹ä»¶å¤„ç†å±‚æ¥å£ï¼Œé€šè¿‡äº‹ä»¶å¤„ç†å±‚ä¹Ÿå¯æ‰¾åˆ°åŒ¹é…çš„è¾“å…¥è®¾å¤‡</span></span><br><span class="line"><span class="comment">    */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŠŠè¿™ä¸ªhandleçš„d_node åŠ åˆ°å¯¹åº”input_devçš„h_listé“¾è¡¨é‡Œé¢  </span></span><br><span class="line">    <span class="keyword">if</span> (handler-&gt;filter)</span><br><span class="line">        list_add_rcu(&amp;handle-&gt;d_node, &amp;dev-&gt;h_list);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        list_add_tail_rcu(&amp;handle-&gt;d_node, &amp;dev-&gt;h_list);</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//æŠŠè¿™ä¸ªhandleçš„h_node åŠ åˆ°å¯¹åº”input_handlerçš„h_listé“¾è¡¨é‡Œé¢</span></span><br><span class="line">    list_add_tail_rcu(&amp;handle-&gt;h_node, &amp;handler-&gt;h_list);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler-&gt;start)</span><br><span class="line">        handler-&gt;start(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ³¨å†Œæ˜¯æŠŠhandle æœ¬èº«çš„é“¾è¡¨åŠ å…¥åˆ°å®ƒè‡ªå·±çš„input_dev ä»¥åŠ input_handlerçš„h_listé“¾è¡¨ä¸­ï¼Œè¿™æ ·ä»¥åå°±å¯ä»¥é€šè¿‡h_listéå†åˆ°è¿™ä¸ªhandleï¼Œè¿™æ ·å°±å®ç°äº†ä¸‰è€…çš„ç»‘å®šè”ç³»ã€‚</p><p>ä»¥ä¸Šæ˜¯è¾“å…¥è®¾å¤‡é©±åŠ¨æ³¨å†Œçš„å…¨è¿‡ç¨‹ï¼Œçºµè§‚æ•´ä¸ªè¿‡ç¨‹ï¼Œè¾“å…¥è®¾å¤‡é©±åŠ¨æœ€ç»ˆçš„ç›®çš„å°±æ˜¯èƒ½å¤Ÿä¸äº‹ä»¶å¤„ç†å±‚çš„äº‹ä»¶é©±åŠ¨ç›¸äº’åŒ¹é…ï¼Œä½†æ˜¯åœ¨drivers/inputç›®å½•ä¸‹æœ‰evdev.cäº‹ä»¶é©±åŠ¨ã€mousedev.cäº‹ä»¶é©±åŠ¨ã€joydev.cäº‹ä»¶é©±åŠ¨ç­‰ç­‰ï¼Œæˆ‘ä»¬çš„è¾“å…¥è®¾å¤‡äº§ç”Ÿçš„äº‹ä»¶åº”è¯¥æœ€ç»ˆä¸ŠæŠ¥ç»™è°ï¼Œç„¶åè®©äº‹ä»¶è¢«è°å»å¤„ç†å‘¢ï¼ŸçŸ¥é“äº†è¿™ä¹ˆä¸ªåŸå› å†çœ‹ä¸Šé¢ä»£ç å°±ä¼šæ˜ç™½ï¼Œå…¶å®evdev.cã€mousedev.cç­‰æ ¹æ®ç¡¬ä»¶è¾“å…¥è®¾å¤‡çš„å¤„ç†æ–¹å¼çš„ä¸åŒæŠ½è±¡å‡ºäº†ä¸åŒçš„äº‹ä»¶å¤„ç†æ¥å£å¸®åŠ©ä¸Šå±‚å»è°ƒç”¨ï¼Œè€Œæˆ‘ä»¬å†™çš„è®¾å¤‡é©±åŠ¨ç¨‹åºåªä¸è¿‡æ˜¯å®Œæˆäº†ç¡¬ä»¶å¯„å­˜å™¨ä¸­æ•°æ®çš„è¯»å†™ï¼Œä½†æäº¤ç»™ç”¨æˆ·çš„äº‹ä»¶å¿…é¡»æ˜¯ç»è¿‡äº‹ä»¶å¤„ç†å±‚çš„å°è£…å’ŒåŒæ­¥æ‰èƒ½å¤Ÿå®Œæˆçš„ï¼Œäº‹ä»¶å¤„ç†å±‚æä¾›ç»™ç”¨æˆ·ä¸€ä¸ªç»Ÿä¸€çš„ç•Œé¢æ¥æ“ä½œã€‚ æ•´ä¸ªå…³è”æ³¨å†Œçš„è¿‡ç¨‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/04-Linux-kernel-input-reg-device.png" alt="Markdown"></p><h2 id="ï¼ˆå››ï¼‰ã€Input-äº‹ä»¶å¤„ç†å±‚-Event-handler-ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰"><a href="#ï¼ˆå››ï¼‰ã€Input-äº‹ä»¶å¤„ç†å±‚-Event-handler-ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰" class="headerlink" title="ï¼ˆå››ï¼‰ã€Input äº‹ä»¶å¤„ç†å±‚ Event handler ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰"></a>ï¼ˆå››ï¼‰ã€Input äº‹ä»¶å¤„ç†å±‚ Event handler ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰</h2><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/05-Linux-kernel-input-event-hardware.png" alt="Markdown"></p><h2 id="4-1ã€ä¸»è¦æ•°æ®ç»“æ„"><a href="#4-1ã€ä¸»è¦æ•°æ®ç»“æ„" class="headerlink" title="4.1ã€ä¸»è¦æ•°æ®ç»“æ„"></a>4.1ã€ä¸»è¦æ•°æ®ç»“æ„</h2><p><strong>ï¼ˆ1ï¼‰ evdevè®¾å¤‡ç»“æ„</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[evdev.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> &#123;</span>   </span><br><span class="line">    <span class="keyword">int</span> exist;   </span><br><span class="line">    <span class="keyword">int</span> open;                     <span class="comment">//æ‰“å¼€æ ‡å¿—   </span></span><br><span class="line">    <span class="keyword">int</span> minor;                    <span class="comment">//æ¬¡è®¾å¤‡å·   </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> <span class="title">handle</span>;</span>   <span class="comment">//å…³è”çš„input_handle   </span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> wait;       <span class="comment">//ç­‰å¾…é˜Ÿåˆ—ï¼Œå½“è¿›ç¨‹è¯»å–è®¾å¤‡ï¼Œè€Œæ²¡æœ‰äº‹ä»¶äº§ç”Ÿçš„æ—¶å€™ï¼Œè¿›ç¨‹å°±ä¼šç¡åœ¨å…¶ä¸Šé¢   </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> *<span class="title">grab</span>;</span>    <span class="comment">//å¼ºåˆ¶ç»‘å®šçš„evdev_clientç»“æ„ï¼Œè¿™ä¸ªç»“æ„åé¢å†åˆ†æ   </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">client_list</span>;</span> <span class="comment">//evdev_client é“¾è¡¨ï¼Œè¿™è¯´æ˜ä¸€ä¸ªevdevè®¾å¤‡å¯ä»¥å¤„ç†å¤šä¸ªevdev_clientï¼Œå¯ä»¥æœ‰å¤šä¸ªè¿›ç¨‹è®¿é—®evdevè®¾å¤‡   </span></span><br><span class="line">    <span class="keyword">spinlock_t</span> client_lock;       <span class="comment">/* protects client_list */</span>   </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span>   </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span>            <span class="comment">//deviceç»“æ„ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªè®¾å¤‡ç»“æ„   </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>evdevç»“æ„ä½“åœ¨é…å¯¹æˆåŠŸçš„æ—¶å€™ç”Ÿæˆï¼Œç”±handler-&gt;connectç”Ÿæˆï¼Œå¯¹åº”è®¾å¤‡æ–‡ä»¶ä¸º/class/input/event(n)ï¼Œå¦‚è§¦æ‘¸å±é©±åŠ¨çš„event3ï¼Œè¿™ä¸ªè®¾å¤‡æ˜¯ç”¨æˆ·ç©ºé—´è¦è®¿é—®çš„è®¾å¤‡ï¼Œå¯ä»¥ç†è§£å®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ï¼Œå› ä¸ºæ²¡æœ‰å¯¹åº”çš„ç¡¬ä»¶ï¼Œä½†æ˜¯é€šè¿‡handle-&gt;dev å°±å¯ä»¥æ‰¾åˆ°input_devç»“æ„ï¼Œè€Œå®ƒå¯¹åº”ç€è§¦æ‘¸å±ï¼Œè®¾å¤‡æ–‡ä»¶ä¸º/class/input/input3ã€‚è¿™ä¸ªè®¾å¤‡ç»“æ„ç”Ÿæˆä¹‹åä¿å­˜åœ¨evdev_tableä¸­ï¼Œç´¢å¼•å€¼æ˜¯minorã€‚ <strong>ï¼ˆ2ï¼‰evdevç”¨æˆ·ç«¯ç»“æ„</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[evdev.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> head;  <span class="comment">//bufferæ•°ç»„çš„ç´¢å¼•å¤´  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tail;   <span class="comment">//bufferæ•°ç»„çš„ç´¢å¼•å°¾  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> packet_head; <span class="comment">/* [future] position of the first element of next packet */</span>  </span><br><span class="line">    <span class="keyword">spinlock_t</span> buffer_lock; <span class="comment">/* protects access to buffer, head and tail */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">wake_lock</span> <span class="title">wake_lock</span>;</span>  </span><br><span class="line">    <span class="keyword">bool</span> use_wake_lock;  </span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">28</span>];  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span>    <span class="comment">//å¼‚æ­¥é€šçŸ¥å‡½æ•°  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span>;</span>  <span class="comment">//åŒ…å«ä¸€ä¸ªevdevå˜é‡  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>  <span class="comment">//é“¾è¡¨  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bufsize;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">buffer</span>[];</span>   <span class="comment">//input_eventæ•°æ®ç»“æ„çš„æ•°ç»„ï¼Œinput_eventä»£è¡¨ä¸€ä¸ªäº‹ä»¶ï¼ŒåŸºæœ¬æˆå‘˜ï¼šç±»å‹ï¼ˆtypeï¼‰ï¼Œç¼–ç ï¼ˆcodeï¼‰ï¼Œå€¼ï¼ˆvalueï¼‰  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„åœ¨è¿›ç¨‹æ‰“å¼€event3è®¾å¤‡çš„æ—¶å€™è°ƒç”¨evdevçš„openæ–¹æ³•ï¼Œåœ¨openä¸­åˆ›å»ºè¿™ä¸ªç»“æ„ï¼Œå¹¶åˆå§‹åŒ–ã€‚åœ¨å…³é—­è®¾å¤‡æ–‡ä»¶çš„æ—¶å€™é‡Šæ”¾è¿™ä¸ªç»“æ„ã€‚ <strong>ï¼ˆ3ï¼‰input_eventç»“æ„</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[input.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">time</span>;</span>    <span class="comment">//äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´   </span></span><br><span class="line">    __u16 type;             <span class="comment">//äº‹ä»¶ç±»å‹   </span></span><br><span class="line">    __u16 code;             <span class="comment">//å­äº‹ä»¶   </span></span><br><span class="line">    __s32 value;            <span class="comment">//äº‹ä»¶çš„value  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="4-2ã€äº‹ä»¶å¤„ç†å±‚evdev"><a href="#4-2ã€äº‹ä»¶å¤„ç†å±‚evdev" class="headerlink" title="4.2ã€äº‹ä»¶å¤„ç†å±‚evdev"></a>4.2ã€äº‹ä»¶å¤„ç†å±‚evdev</h2><p>äº‹ä»¶å¤„ç†å±‚ä¸ç”¨æˆ·ç¨‹åºå’Œè¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒæ‰“äº¤é“ï¼Œæ˜¯ä»–ä»¬ä¸¤å±‚çš„æ¡¥æ¢ã€‚ä¸€èˆ¬å†…æ ¸æœ‰å¥½å‡ ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œåƒevdev mousedev jotdevã€‚evdeväº‹ä»¶å¤„ç†å™¨å¯ä»¥å¤„ç†æ‰€æœ‰çš„äº‹ä»¶ï¼Œè§¦æ‘¸å±é©±åŠ¨å°±æ˜¯ç”¨çš„è¿™ä¸ªï¼Œæ‰€ä»¥ä¸‹é¢åˆ†æè¿™ä¸ªäº‹ä»¶å¤„ç†å™¨çš„å®ç°ã€‚å®ƒä¹Ÿæ˜¯ä½œä¸ºæ¨¡å—æ³¨å†Œåˆ°å†…æ ¸ä¸­çš„,å‰é¢å·²ç»åˆ†æè¿‡å®ƒçš„æ¨¡å—åˆå§‹åŒ–å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">evdev_fops</span> = &#123;</span></span><br><span class="line">    .owner        = THIS_MODULE,</span><br><span class="line">    .read        = evdev_read,</span><br><span class="line">    .write        = evdev_write,</span><br><span class="line">    .poll        = evdev_poll,</span><br><span class="line">    .open        = evdev_open,</span><br><span class="line">    .release    = evdev_release,</span><br><span class="line">    .unlocked_ioctl    = evdev_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">    .compat_ioctl    = evdev_ioctl_compat,</span><br><span class="line">#endif</span><br><span class="line">    .fasync        = evdev_fasync,</span><br><span class="line">    .flush        = evdev_flush,</span><br><span class="line">    .llseek        = no_llseek,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœåŒ¹é…ä¸Šäº†å°±ä¼šåˆ›å»ºä¸€ä¸ªevdevï¼Œå®ƒé‡Œè¾¹å°è£…äº†ä¸€ä¸ªhandleï¼Œä¼šæŠŠinput_devå’Œinput_handlerå…³è”åˆ°ä¸€èµ·ã€‚å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/06-Linux-kernel-input-evdev-connect.png" alt="Markdown"></p><h2 id="4-3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open-æ“ä½œ"><a href="#4-3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open-æ“ä½œ" class="headerlink" title="4.3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open()æ“ä½œ"></a>4.3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open()æ“ä½œ</h2><p>æˆ‘ä»¬çŸ¥é“.å¯¹ä¸»è®¾å¤‡å·ä¸ºINPUT_MAJORçš„è®¾å¤‡èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œä¼šå°†æ“ä½œé›†è½¬æ¢æˆhandlerçš„æ“ä½œé›†ã€‚åœ¨evdevä¸­ï¼Œè¿™ä¸ªæ“ä½œé›†å°±æ˜¯evdev_fopsã€‚å¯¹åº”çš„openå‡½æ•°å¦‚ä¸‹ç¤ºï¼š</p><p>é¦–å…ˆæ¥çœ‹æ‰“å¼€event(x)è®¾å¤‡æ–‡ä»¶ï¼Œevdev_openå‡½æ•°.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">evdev_open</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span> = <span class="title">container_of</span>(<span class="title">inode</span>-&gt;<span class="title">i_cdev</span>, <span class="title">struct</span> <span class="title">evdev</span>, <span class="title">cdev</span>);</span></span><br><span class="line">    <span class="comment">//evdev_clientçš„bufferå¤§å°  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bufsize = evdev_compute_buffer_size(evdev-&gt;handle.dev);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size = <span class="keyword">sizeof</span>(struct evdev_client) +</span><br><span class="line">                    bufsize * <span class="keyword">sizeof</span>(struct input_event);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> *<span class="title">client</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    <span class="comment">//æ‰“å¼€çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªevdev_client</span></span><br><span class="line">    client = kzalloc(size, GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    client-&gt;bufsize = bufsize;</span><br><span class="line">    spin_lock_init(&amp;client-&gt;buffer_lock);</span><br><span class="line">    <span class="built_in">snprintf</span>(client-&gt;name, <span class="keyword">sizeof</span>(client-&gt;name), <span class="string">"%s-%d"</span>,</span><br><span class="line">            dev_name(&amp;evdev-&gt;dev), task_tgid_vnr(current));</span><br><span class="line">    client-&gt;evdev = evdev;</span><br><span class="line">    evdev_attach_client(evdev, client);</span><br><span class="line">    <span class="comment">//è°ƒç”¨æ‰“å¼€çœŸæ­£çš„åº•å±‚è®¾å¤‡å‡½æ•°  </span></span><br><span class="line">    error = evdev_open_device(evdev);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    file-&gt;private_data = client;</span><br><span class="line">    nonseekable_open(inode, file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">evdev_open_device</span><span class="params">(struct evdev *evdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = mutex_lock_interruptible(&amp;evdev-&gt;mutex);</span><br><span class="line">    <span class="keyword">if</span> (retval)<span class="comment">/*å¦‚æœè®¾å¤‡ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯*/</span>  </span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!evdev-&gt;exist)</span><br><span class="line">        retval = -ENODEV;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!evdev-&gt;open++) &#123;<span class="comment">//é€’å¢æ‰“å¼€è®¡æ•°  </span></span><br><span class="line">        retval = input_open_device(&amp;evdev-&gt;handle);<span class="comment">//å¦‚æœæ˜¯è¢«ç¬¬ä¸€æ¬¡æ‰“å¼€ï¼Œåˆ™è°ƒç”¨input_open_device</span></span><br><span class="line">        <span class="keyword">if</span> (retval)</span><br><span class="line">            evdev-&gt;open--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;evdev-&gt;mutex);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_open_device</span><span class="params">(struct input_handle *handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span> = <span class="title">handle</span>-&gt;<span class="title">dev</span>;</span><span class="comment">//æ ¹æ®input_handleæ‰¾åˆ°å¯¹åº”çš„input_devè®¾å¤‡  </span></span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = mutex_lock_interruptible(&amp;dev-&gt;mutex);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    handle-&gt;open++;<span class="comment">//é€’å¢handleçš„æ‰“å¼€è®¡æ•°  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;users++ &amp;&amp; dev-&gt;open)</span><br><span class="line">        retval = dev-&gt;open(dev);<span class="comment">//å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€.åˆ™è°ƒç”¨input deviceçš„open()å‡½æ•°  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (retval) &#123;</span><br><span class="line">        dev-&gt;users--;</span><br><span class="line">        <span class="keyword">if</span> (!--handle-&gt;open) &#123;</span><br><span class="line">            synchronize_rcu();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">    mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°"><a href="#4-4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°" class="headerlink" title="4.4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°"></a>4.4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°</h2><p>è‡³äºå…·ä½“çš„å¦‚ä½•åˆå§‹åŒ–input_devï¼Œè¿™ä¸ªæ˜¯å…·ä½“çš„è¾“å…¥è®¾å¤‡å»å®ç°çš„ï¼Œç¨åå…·ä½“å®ä¾‹å†åˆ†æï¼Œç°åœ¨æ¥çœ‹çœ‹ï¼Œå¯¹äºä¸€ä¸ªevent(x)è®¾å¤‡æ–‡ä»¶çš„ï¼Œåº”ç”¨ç¨‹åºæ¥è¯»ï¼Œæœ€ç»ˆä¼šå¯¼è‡´â€handlerâ€é‡Œé¢çš„çš„â€è¯»å‡½æ•°â€è¢«è°ƒç”¨ã€‚</p><p>evdev_fops ç»“ æ„ ä½“ æ˜¯ ä¸€ ä¸ª file_operations çš„ ç±» å‹ ã€‚ å½“ ç”¨ æˆ· å±‚ è°ƒ ç”¨ ç±» ä¼¼ ä»£ ç open(â€œ/dev/input/event3â€ , O_RDONLY) å‡½ æ•° æ‰“ å¼€ è®¾ å¤‡ ç»“ ç‚¹ æ—¶ , ä¼š è°ƒ ç”¨ evdev_fops ä¸­ çš„evdev_read()å‡½æ•°,è¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">evdev_read</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> *<span class="title">client</span> = <span class="title">file</span>-&gt;<span class="title">private_data</span>;</span><span class="comment">//å°±æ˜¯åˆšæ‰åœ¨openå‡½æ•°ä¸­ä¿å­˜çš„evdev_client  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span> = <span class="title">client</span>-&gt;<span class="title">evdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">event</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> read = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//å¦‚æœè·å¾—äº†æ•°æ®åˆ™å–å‡ºæ¥ï¼Œè°ƒç”¨evdev_fetch_next_event  </span></span><br><span class="line">        <span class="keyword">while</span> (read + input_event_size() &lt;= count &amp;&amp;</span><br><span class="line">               evdev_fetch_next_event(client, &amp;event)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//input_event_to_userè°ƒç”¨copy_to_userä¼ å…¥ç”¨æˆ·ç¨‹åºä¸­ï¼Œè¿™æ ·è¯»å–å®Œæˆ  </span></span><br><span class="line">            <span class="keyword">if</span> (input_event_to_user(buffer + read, &amp;event))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">            read += input_event_size();</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">/*å¦‚æœæ˜¯å¯é˜»å¡çŠ¶æ€çš„è¯,åˆ™ç­‰å¾…åœ¨waité˜Ÿåˆ—ä¸Š.ç›´åˆ°æœ‰æ•°æ®è¦è¢«å¤„ç†,å½“å‰è¿›ç¨‹æ‰è¢«å”¤é†’.è¿™å¾ˆå¥½ç†è§£,æ—¢ç„¶æ˜¯</span></span><br><span class="line"><span class="comment">         è¾“å…¥è®¾å¤‡,è¯»çš„è¯æ¯”å¦‚è¯»æŒ‰é”®,é‚£ä¹ˆå¿…é¡»è¦æœ‰ç¡¬ä»¶è®¾å¤‡æœ‰æŒ‰é”®æŒ‰ä¸‹æ‰ä¼šè¿”å›æŒ‰é”®å€¼,è¿™é‡Œè¿˜æ˜¯å¤„äºäº‹ä»¶å¤„ç†å±‚,åº”ç”¨ç¨‹åºåœ¨è¿™é‡Œä¼‘çœ ,é‚£ä¹ˆè°æ¥å”¤é†’?</span></span><br><span class="line"><span class="comment">         å½“ç„¶æ˜¯æœ‰æŒ‰é”®æŒ‰ä¸‹æ‰å»å”¤é†’,å› æ­¤è¿™ä¸ªå·¥ä½œå°±äº¤ç»™äº†è®¾å¤‡é©±åŠ¨å±‚,é‚£ä¹ˆæ‰¾åˆ°è¿™ä¸ªå”¤é†’å‘¢,ç›´æ¥å»æ‰¾ä¸å¥½æ‰¾,é‚£ä¹ˆå¯ä»¥ç›´æ¥æœç´¢evdev-&gt;wait,æœç´¢ç»“æœ</span></span><br><span class="line"><span class="comment">         å¯çŸ¥evdev-&gt;waitåœ¨evdev_event()å‡½æ•°ä¸­è¢«å”¤é†’*/</span></span><br><span class="line">        <span class="keyword">if</span> (!(file-&gt;f_flags &amp; O_NONBLOCK)) &#123;</span><br><span class="line">            error = wait_event_interruptible(evdev-&gt;wait,</span><br><span class="line">                    client-&gt;packet_head != client-&gt;tail ||</span><br><span class="line">                    !evdev-&gt;exist || client-&gt;revoked);</span><br><span class="line">            <span class="keyword">if</span> (error)</span><br><span class="line">                <span class="keyword">return</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> read;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">evdev_fetch_next_event</span><span class="params">(struct evdev_client *client,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct input_event *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> have_event;</span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;client-&gt;buffer_lock);</span><br><span class="line">    <span class="comment">/*å…ˆåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æœ‰æ•°æ®*/</span>   </span><br><span class="line">    have_event = client-&gt;packet_head != client-&gt;tail;</span><br><span class="line">    <span class="comment">/*å¦‚æœæœ‰å°±ä»ç¯å½¢ç¼“å†²åŒºçš„å–å‡ºæ¥ï¼Œè®°å¾—æ˜¯ä»headå­˜å‚¨ï¼Œtailå–å‡º*/</span></span><br><span class="line">    <span class="keyword">if</span> (have_event) &#123;</span><br><span class="line">        *event = client-&gt;buffer[client-&gt;tail++];</span><br><span class="line">        client-&gt;tail &amp;= client-&gt;bufsize - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (client-&gt;use_wake_lock &amp;&amp;</span><br><span class="line">            client-&gt;packet_head == client-&gt;tail)</span><br><span class="line">            wake_unlock(&amp;client-&gt;wake_lock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spin_unlock_irq(&amp;client-&gt;buffer_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> have_event;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_event_to_user</span><span class="params">(<span class="keyword">char</span> __user *buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> struct input_event *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*å¦‚æœè®¾ç½®äº†æ ‡å¿—INPUT_COMPAT_TESTå°±å°†äº‹ä»¶eventåŒ…è£…æˆç»“æ„ä½“compat_event*/</span></span><br><span class="line">    <span class="keyword">if</span> (INPUT_COMPAT_TEST &amp;&amp; !COMPAT_USE_64BIT_TIME) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">input_event_compat</span> <span class="title">compat_event</span>;</span></span><br><span class="line"></span><br><span class="line">        compat_event.time.tv_sec = event-&gt;time.tv_sec;</span><br><span class="line">        compat_event.time.tv_usec = event-&gt;time.tv_usec;</span><br><span class="line">        compat_event.type = event-&gt;type;</span><br><span class="line">        compat_event.code = event-&gt;code;</span><br><span class="line">        compat_event.value = event-&gt;value;</span><br><span class="line">         <span class="comment">/*å°†åŒ…è£…æˆçš„compat_eventæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´*/</span>  </span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(buffer, &amp;compat_event,</span><br><span class="line">                 <span class="keyword">sizeof</span>(struct input_event_compat)))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">/*å¦åˆ™ï¼Œå°†eventæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´*/</span>   </span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(buffer, event, <span class="keyword">sizeof</span>(struct input_event)))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯å¯é˜»å¡çŠ¶æ€çš„è¯ï¼Œåˆ™ç­‰å¾…åœ¨waité˜Ÿåˆ—ä¸Šã€‚ç›´åˆ°æœ‰æ•°æ®è¦è¢«å¤„ç†ï¼Œå½“å‰è¿›ç¨‹æ‰è¢«å”¤é†’ã€‚è¿™å¾ˆå¥½ç†è§£ï¼Œæ—¢ç„¶æ˜¯è¾“å…¥è®¾å¤‡ï¼Œè¯»çš„è¯æ¯”å¦‚è¯»æŒ‰é”®ï¼Œé‚£ä¹ˆå¿…é¡»è¦æœ‰ç¡¬ä»¶è®¾å¤‡æœ‰æŒ‰é”®æŒ‰ä¸‹æ‰ä¼šè¿”å›æŒ‰é”®å€¼ï¼Œè¿™é‡Œè¿˜æ˜¯å¤„äºäº‹ä»¶å¤„ç†å±‚ï¼Œåº”ç”¨ç¨‹åºåœ¨è¿™é‡Œä¼‘çœ ï¼Œé‚£ä¹ˆè°æ¥å”¤é†’?</p><p>å½“ç„¶æ˜¯æœ‰æŒ‰é”®æŒ‰ä¸‹æ‰å»å”¤é†’ï¼Œå› æ­¤è¿™ä¸ªå·¥ä½œå°±äº¤ç»™äº†è®¾å¤‡é©±åŠ¨å±‚ã€‚é‚£ä¹ˆæ‰¾åˆ°è¿™ä¸ªå”¤é†’å‘¢ï¼Œç›´æ¥å»æ‰¾ä¸å¥½æ‰¾ã€‚é‚£ä¹ˆå¯ä»¥ç›´æ¥æœç´¢evdev-&gt;waitï¼Œæœç´¢ç»“æœå¯çŸ¥evdev-&gt;waitåœ¨evdev_event()å‡½æ•°ä¸­è¢«å”¤é†’</p><p>æ³¨é‡Šä¸­è¯´çš„å¾ˆæ¸…æ¥šï¼Œevdev_event()ä¼šå”¤é†’æ­¤å¤„çš„è¯»æŒ‰é”®è¿›ç¨‹ã€‚é‚£ä¹ˆevdev_event()åˆæ˜¯è¢«è°è°ƒç”¨?æ˜¾ç„¶æ˜¯è®¾å¤‡é©±åŠ¨å±‚ï¼Œç°åœ¨çœ‹ä¸€ä¸ªè®¾å¤‡å±‚ä¾‹å­ï¼Œå†…æ ¸ä¸­æœ‰ä¸ªæŒ‰é”®çš„ä¾‹å­ï¼Œgpiokey.cï¼Œè¿™åªæ˜¯ä¸ªä¾‹å­ä¸é’ˆå¯¹ä»»ä½•è®¾å¤‡ï¼Œåœ¨gpio_keys.cç»ˆç«¯å¤„ç†å‡½æ•°é‡Œé¢</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;gpio_keys.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> irqreturn_t <span class="title">gpio_keys_irq_isr</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (!bdata-&gt;key_pressed) &#123;</span><br><span class="line">        ......</span><br><span class="line">        input_event(input, EV_KEY, button-&gt;code, <span class="number">1</span>);</span><br><span class="line">        input_sync(input);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤å¯ä»¥çœ‹å‡º åœ¨è®¾å¤‡çš„ä¸­æ–­æœåŠ¡ç¨‹åºé‡Œé¢ï¼Œç¡®å®šäº‹ä»¶æ˜¯ä»€ä¹ˆï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„input_handlerçš„eventå¤„ç†å‡½æ•° å®é™…ä¸Šè¿™å°±æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒ input_event()æ˜¯ç”¨æ¥ä¸ŠæŠ¥äº‹ä»¶çš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">input_event</span><span class="params">(struct input_dev *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_event_supported(type, dev-&gt;evbit, EV_MAX)) &#123;</span><br><span class="line"></span><br><span class="line">        spin_lock_irqsave(&amp;dev-&gt;event_lock, flags);</span><br><span class="line">        input_handle_event(dev, type, code, value);</span><br><span class="line">        spin_unlock_irqrestore(&amp;dev-&gt;event_lock, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">input_handle_event</span><span class="params">(struct input_dev *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (disposition &amp; INPUT_FLUSH) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dev-&gt;num_vals &gt;= <span class="number">2</span>)</span><br><span class="line">            input_pass_values(dev, dev-&gt;vals, dev-&gt;num_vals);</span><br><span class="line">        dev-&gt;num_vals = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dev-&gt;num_vals &gt;= dev-&gt;max_vals - <span class="number">2</span>) &#123;</span><br><span class="line">        dev-&gt;vals[dev-&gt;num_vals++] = input_value_sync;</span><br><span class="line">        input_pass_values(dev, dev-&gt;vals, dev-&gt;num_vals);</span><br><span class="line">        dev-&gt;num_vals = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">input_pass_values</span><span class="params">(struct input_dev *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> *<span class="title">handle</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">v</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    handle = rcu_dereference(dev-&gt;grab);</span><br><span class="line">    <span class="keyword">if</span> (handle) &#123;</span><br><span class="line">        count = input_to_handler(handle, vals, count);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        list_for_each_entry_rcu(handle, &amp;dev-&gt;h_list, d_node)</span><br><span class="line">            <span class="keyword">if</span> (handle-&gt;open)</span><br><span class="line">                count = input_to_handler(handle, vals, count);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">input_to_handler</span><span class="params">(struct input_handle *handle,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span> = <span class="title">handle</span>-&gt;<span class="title">handler</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">end</span> = <span class="title">vals</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">v</span>;</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler-&gt;events)</span><br><span class="line">        handler-&gt;events(handle, vals, count);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (handler-&gt;event)</span><br><span class="line">        <span class="keyword">for</span> (v = vals; v != end; v++)</span><br><span class="line">            handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨handler-&gt;event()æ¥å¤„ç†ï¼Œæ­¤å¤„handlerå³å¯¹åº”evdevã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line">handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¼šè°ƒç”¨evdev_event()å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">evdev_pass_values</span><span class="params">(struct evdev_client *client,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">ktime_t</span> mono, <span class="keyword">ktime_t</span> real)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span> = <span class="title">client</span>-&gt;<span class="title">evdev</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">v</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">event</span>;</span></span><br><span class="line">    <span class="keyword">bool</span> wakeup = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (client-&gt;revoked)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    event.time = ktime_to_timeval(client-&gt;clkid == CLOCK_MONOTONIC ?</span><br><span class="line">                      mono : real);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Interrupts are disabled, just acquire the lock. */</span></span><br><span class="line">    spin_lock(&amp;client-&gt;buffer_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (v = vals; v != vals + count; v++) &#123;</span><br><span class="line">        event.type = v-&gt;type;</span><br><span class="line">        event.code = v-&gt;code;</span><br><span class="line">        event.value = v-&gt;value;</span><br><span class="line">        __pass_event(client, &amp;event);</span><br><span class="line">        <span class="keyword">if</span> (v-&gt;type == EV_SYN &amp;&amp; v-&gt;code == SYN_REPORT)</span><br><span class="line">            wakeup = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spin_unlock(&amp;client-&gt;buffer_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wakeup)</span><br><span class="line">        wake_up_interruptible(&amp;evdev-&gt;wait);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">evdev_events</span><span class="params">(struct input_handle *handle,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">const</span> struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span> = <span class="title">handle</span>-&gt;<span class="title">private</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> *<span class="title">client</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (client)</span><br><span class="line">        evdev_pass_values(client, vals, count, time_mono, time_real);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        list_for_each_entry_rcu(client, &amp;evdev-&gt;client_list, node)</span><br><span class="line">            evdev_pass_values(client, vals, count,</span><br><span class="line">                      time_mono, time_real);</span><br><span class="line"></span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">evdev_event</span><span class="params">(struct input_handle *handle,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> <span class="title">vals</span>[] = &#123;</span> &#123; type, code, value &#125; &#125;;</span><br><span class="line">    evdev_events(handle, vals, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå”¤é†’evdev_read()å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p><h2 id="ï¼ˆäº”ï¼‰ã€Input-äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹"><a href="#ï¼ˆäº”ï¼‰ã€Input-äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹" class="headerlink" title="ï¼ˆäº”ï¼‰ã€Input äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹"></a>ï¼ˆäº”ï¼‰ã€Input äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹</h2><h2 id="5-1ã€Input-äº‹ä»¶äº§ç”Ÿ"><a href="#5-1ã€Input-äº‹ä»¶äº§ç”Ÿ" class="headerlink" title="5.1ã€Input äº‹ä»¶äº§ç”Ÿ"></a>5.1ã€Input äº‹ä»¶äº§ç”Ÿ</h2><p>å½“æŒ‰ä¸‹è§¦æ‘¸å±æ—¶ï¼Œè¿›å…¥è§¦æ‘¸å±æŒ‰ä¸‹ä¸­æ–­ï¼Œå¼€å§‹adè½¬æ¢ï¼Œadè½¬æ¢å®Œæˆè¿›å…¥adå®Œæˆä¸­æ–­ï¼Œåœ¨è¿™ä¸ªç»ˆç«¯ä¸­å°†äº‹ä»¶å‘é€å‡ºå»ï¼Œä¼šè°ƒç”¨ä»¥ä¸‹å‡½æ•°ä¸ŠæŠ¥äº‹ä»¶:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> input_report_key(input_dev,</span><br><span class="line">         BTN_TOUCH, 1);</span><br><span class="line"></span><br><span class="line"> input_report_abs(input_dev,</span><br><span class="line">         ABS_POSITION_X, x);</span><br><span class="line"></span><br><span class="line"> input_report_abs(input_dev,</span><br><span class="line">         ABS_POSITION_Y, y);</span><br><span class="line"></span><br><span class="line">input_sync(input_dev);</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°è°ƒç”¨äº† input_event(dev, EV_ABS, code, value) æ‰€æœ‰çš„äº‹ä»¶æŠ¥å‘Šå‡½æ•°éƒ½è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.h]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">input_report_key</span><span class="params">(struct input_dev *dev, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    input_event(dev, EV_KEY, code, !!value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">input_report_abs</span><span class="params">(struct input_dev *dev, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    input_event(dev, EV_ABS, code, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">input_sync</span><span class="params">(struct input_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    input_event(dev, EV_SYN, SYN_REPORT, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-2ã€Input-äº‹ä»¶æŠ¥å‘Š"><a href="#5-2ã€Input-äº‹ä»¶æŠ¥å‘Š" class="headerlink" title="5.2ã€Input äº‹ä»¶æŠ¥å‘Š"></a>5.2ã€Input äº‹ä»¶æŠ¥å‘Š</h2><p>input_event å‡½æ•°å‰é¢å·²ç»åˆ†æè¿‡ï¼Œè¿™é‡Œä¸å†åˆ†æã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c:input_pass_values]</span><br><span class="line"><span class="keyword">for</span> (v = vals; v != end; v++)</span><br><span class="line">    handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¼šè°ƒç”¨handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value) æ¥å°†æ•°æ® ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ç­‰å¾…è¯»å–æ•°æ®çš„è¿›ç¨‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_to_user(buffer, event, <span class="keyword">sizeof</span>(struct input_event))</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆå…­ï¼‰ã€Android-Inputå­ç³»ç»Ÿ"><a href="#ï¼ˆå…­ï¼‰ã€Android-Inputå­ç³»ç»Ÿ" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Android Inputå­ç³»ç»Ÿ"></a>ï¼ˆå…­ï¼‰ã€Android Inputå­ç³»ç»Ÿ</h2><p>è¾“å…¥å­ç³»ç»Ÿçš„ç³»ç»Ÿæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/07-Linux-kernel-android-input-system.png" alt="Markdown"></p><p>è¯¦ç»†åˆ†æè¯·å‚è€ƒï¼šAndroid 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ-Input System åˆ†æ</p><h2 id="ï¼ˆä¸ƒï¼‰ã€Input-è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰"><a href="#ï¼ˆä¸ƒï¼‰ã€Input-è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€Input è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰"></a>ï¼ˆä¸ƒï¼‰ã€Input è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰</h2><p>è§¦æ‘¸å±ä¹Ÿæ˜¯ç”¨ä¸Šé¢è¿™ä¸€å¥—æ¡†æ¶æ¥æ“ä½œçš„ã€‚å³è¾¹éœ€è¦ä¸€ä¸ªâ€evdev.câ€æ–‡ä»¶ã€‚å·¦è¾¹è¦åˆ†é…ä¸€ä¸ªâ€input_devâ€ç»“æ„ã€‚æ¥ç€å°±çœ‹ä¸Šå›¾çš„ç¡¬ä»¶è®¾å¤‡å·¦è¾¹çš„è¿‡ç¨‹ï¼šåˆ†é…ä¸€ä¸ªâ€input_devâ€ç»“æ„ä½“ â€“&gt; è®¾ç½®è¿™ä¸ªâ€input_devâ€ç»“æ„ä½“ â€“&gt; æ³¨å†Œè¿™ä¸ªâ€input_devâ€ç»“æ„ä½“ â€“&gt; ç¡¬ä»¶ç›¸å…³çš„æ“ä½œã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/08-Linux-kernel-input-drivers-fw.png" alt="Markdown"></p><p>ç¼–å†™Inputé©±åŠ¨ä¸€èˆ¬æ¡†æ¶:</p><p>Google Pixelã€Pixel XL è§¦æ§é©±åŠ¨æ¨¡å—å‹å·ä¸ºSynapticsï¼ˆClearPad S3708ï¼‰ï¼Œæºç ï¼š<a href="https://github.com/matthewdalex/marlin/tree/2f567606935d601f1391ad9575b103f35737a438/drivers/input/touchscreen/synaptics_dsx_htc_2.6" target="_blank" rel="noopener">Synaptics è§¦æ‘¸å±é©±åŠ¨æºç </a></p><p>Makefileï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;drivers/input/touchscreen/synaptics_dsx_htc_2<span class="number">.6</span>/Makefile]</span><br><span class="line">#</span><br><span class="line"># Makefile <span class="keyword">for</span> the Synaptics DSX touchscreen driver.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Each configuration option enables a <span class="built_in">list</span> of files.</span><br><span class="line"></span><br><span class="line">obj-$(CONFIG_TOUCHSCREEN_SYNAPTICS_DSX_I2C_HTC_v26) += synaptics_dsx_i2c.o</span><br><span class="line">obj-$(CONFIG_TOUCHSCREEN_SYNAPTICS_DSX_SPI_HTC_v26) += synaptics_dsx_spi.o</span><br><span class="line">obj-$(CONFIG_TOUCHSCREEN_SYNAPTICS_DSX_CORE_HTC_v26) += synaptics_dsx_core.o</span><br><span class="line">obj-$(CONFIG_TOUCHSCREEN_SYNAPTICS_DSX_RMI_DEV_HTC_v26) += synaptics_dsx_rmi_dev.o</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>æŠ“å–kernel logï¼šå¯çŸ¥input é©±åŠ¨åä¸ºsynaptics_dsxv26ï¼Œå…¨å±€æœç´¢å¯çŸ¥synaptics_rmi4_f12_initåœ¨[-&gt;synaptics_dsx_core.c]ä¸­ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">1.362728</span>] c3      <span class="number">1</span> [TP]:synaptics_rmi4_f12_init: Function <span class="number">12</span> max x = <span class="number">1079</span> max y = <span class="number">1919</span> Rx: <span class="number">16</span> Tx: <span class="number">28</span></span><br><span class="line">[    <span class="number">1.363344</span>] c3      <span class="number">1</span> [TP]synaptics_rmi4_f12_init:Wakeup Gesture range (<span class="number">0</span>,<span class="number">0</span>) -&gt; (<span class="number">1079</span>,<span class="number">1919</span>)</span><br><span class="line">[    <span class="number">1.363623</span>] c3      <span class="number">1</span> [TP]:synaptics_rmi4_f12_init report data init done</span><br><span class="line">[    <span class="number">1.371945</span>] c3      <span class="number">1</span> [TP]:synaptics_rmi4_query_device: chip_id:<span class="number">3708</span>, firmware_id:<span class="number">2433782</span></span><br><span class="line">[    <span class="number">1.372865</span>] c3      <span class="number">1</span> [TP]:synaptics_rmi4_query_device: config_version: <span class="number">5331763200190000000000000000000000000000000000000000000000000000</span></span><br><span class="line">[    <span class="number">1.373249</span>] c3      <span class="number">1</span> input: synaptics_dsxv26 as /devices/soc/<span class="number">7577000.</span>i2c/i2c<span class="number">-3</span>/<span class="number">3</span><span class="number">-0020</span>/input/input3</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹inputè®¾å¤‡ï¼šadb shell cat /proc/bus/input/devices</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">I: Bus=0000 Vendor=0000 Product=0003 Version=2066</span><br><span class="line">N: Name=&quot;synaptics_dsxv26&quot;</span><br><span class="line">P: Phys=synaptics_dsx/touch_input</span><br><span class="line">S: Sysfs=/devices/soc/7577000.i2c/i2c-3/3-0020/input/input3</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=mdss_fb kgsl event3</span><br><span class="line">B: PROP=2</span><br><span class="line">B: EV=b</span><br><span class="line">B: KEY=8000 0 0</span><br><span class="line">B: ABS=663800000000000</span><br><span class="line"></span><br><span class="line">å¯¹åº”ï¼š/dev/input/event3</span><br></pre></td></tr></table></figure><h2 id="7-1ã€åˆ†é…Input-devç»“æ„ä½“"><a href="#7-1ã€åˆ†é…Input-devç»“æ„ä½“" class="headerlink" title="7.1ã€åˆ†é…Input_devç»“æ„ä½“"></a>7.1ã€åˆ†é…Input_devç»“æ„ä½“</h2><h2 id="7-1-1ã€synaptics-rmi4-f12-init"><a href="#7-1-1ã€synaptics-rmi4-f12-init" class="headerlink" title="7.1.1ã€synaptics_rmi4_f12_init()"></a>7.1.1ã€synaptics_rmi4_f12_init()</h2><p>é¦–å…ˆçœ‹ä¸€ä¸‹åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">synaptics_rmi4_driver</span> = &#123;</span></span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = PLATFORM_DRIVER_NAME,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">#ifdef CONFIG_PM</span><br><span class="line">        .pm = &amp;synaptics_rmi4_dev_pm_ops,</span><br><span class="line">#endif</span><br><span class="line">    &#125;,</span><br><span class="line">    .probe = synaptics_rmi4_probe,</span><br><span class="line">    .remove = synaptics_rmi4_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">synaptics_rmi4_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = synaptics_rmi4_bus_init();</span><br><span class="line">    <span class="keyword">if</span> (retval)</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;synaptics_rmi4_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_init(synaptics_rmi4_init);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ³¨å†Œå¹³å°é©±åŠ¨ï¼Œå½“é©±åŠ¨å’Œè®¾å¤‡åŒ¹é…æˆåŠŸï¼Œç»§ç»­çœ‹ä¸€ä¸‹synaptics_rmi4_probe()å‡½æ•°</p><h2 id="7-1-2ã€synaptics-rmi4-probe"><a href="#7-1-2ã€synaptics-rmi4-probe" class="headerlink" title="7.1.2ã€synaptics_rmi4_probe()"></a>7.1.2ã€synaptics_rmi4_probe()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval, len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> attr_count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_data</span> *<span class="title">rmi4_data</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_hw_interface</span> *<span class="title">hw_if</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">temp</span>;</span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–platform_dataã€board_dataã€rmi4_data</span></span><br><span class="line">    hw_if = pdev-&gt;dev.platform_data;</span><br><span class="line">    bdata = hw_if-&gt;board_data;</span><br><span class="line">    rmi4_data = kzalloc(<span class="keyword">sizeof</span>(*rmi4_data), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;pdev = pdev;</span><br><span class="line">    rmi4_data-&gt;current_page = MASK_8BIT;</span><br><span class="line">    rmi4_data-&gt;hw_if = hw_if;</span><br><span class="line">    rmi4_data-&gt;touch_stopped = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;sensor_sleep = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;irq_enabled = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;fw_updating = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;fingers_on_2d = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;update_coords = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;write_buf = devm_kzalloc(&amp;pdev-&gt;dev, I2C_WRITE_BUF_MAX_LEN,</span><br><span class="line">                    GFP_KERNEL);</span><br><span class="line">    rmi4_data-&gt;write_buf_len = I2C_WRITE_BUF_MAX_LEN;</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;irq_enable = synaptics_rmi4_irq_enable;</span><br><span class="line">    rmi4_data-&gt;reset_device = synaptics_rmi4_reset_device;</span><br><span class="line"></span><br><span class="line">    mutex_init(&amp;(rmi4_data-&gt;rmi4_io_ctrl_mutex));</span><br><span class="line">    mutex_init(&amp;(rmi4_data-&gt;rmi4_reset_mutex));</span><br><span class="line"></span><br><span class="line">    retval = synaptics_dsx_regulator_configure(rmi4_data);</span><br><span class="line">    retval = synaptics_dsx_regulator_enable(rmi4_data, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    platform_set_drvdata(pdev, rmi4_data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bdata-&gt;gpio_config) &#123;</span><br><span class="line">        retval = synaptics_rmi4_set_gpio(rmi4_data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        retval = synaptics_dsx_pinctrl_init(rmi4_data);</span><br><span class="line">        <span class="keyword">if</span> (!retval &amp;&amp; rmi4_data-&gt;ts_pinctrl) &#123;</span><br><span class="line">            retval = pinctrl_select_state(rmi4_data-&gt;ts_pinctrl,</span><br><span class="line">                    rmi4_data-&gt;pinctrl_state_active);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        retval = synaptics_dsx_gpio_configure(rmi4_data, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bdata-&gt;fw_name) &#123;</span><br><span class="line">        len = <span class="built_in">strlen</span>(bdata-&gt;fw_name);</span><br><span class="line"></span><br><span class="line">        strlcpy(rmi4_data-&gt;fw_name, bdata-&gt;fw_name, len + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ†é…Input_devç»“æ„ä½“ï¼Œè®¾ç½®ï¼Œæ³¨å†Œ</span></span><br><span class="line">    retval = synaptics_rmi4_set_input_dev(rmi4_data);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;irq = gpio_to_irq(bdata-&gt;irq_gpio);</span><br><span class="line">    <span class="comment">//è¯·æ±‚ä¸­æ–­ï¼Œå¹¶è®¾ç½®ä¸­æ–­å¤„ç†å‡½æ•°synaptics_rmi4_irq</span></span><br><span class="line">    retval = synaptics_rmi4_irq_enable(rmi4_data, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!exp_data.initialized) &#123;</span><br><span class="line">        mutex_init(&amp;exp_data.mutex);</span><br><span class="line">        INIT_LIST_HEAD(&amp;exp_data.<span class="built_in">list</span>);</span><br><span class="line">        exp_data.initialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    exp_data.workqueue = create_singlethread_workqueue(<span class="string">"dsx_exp_workqueue"</span>);</span><br><span class="line">    INIT_DELAYED_WORK(&amp;exp_data.work, synaptics_rmi4_exp_fn_work);</span><br><span class="line">    exp_data.rmi4_data = rmi4_data;</span><br><span class="line">    exp_data.queue_work = <span class="literal">true</span>;</span><br><span class="line">    queue_delayed_work(exp_data.workqueue,</span><br><span class="line">            &amp;exp_data.work,</span><br><span class="line">            msecs_to_jiffies(EXP_FN_WORK_DELAY_MS));</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;dir = debugfs_create_dir(DEBUGFS_DIR_NAME, <span class="literal">NULL</span>);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (attr_count = <span class="number">0</span>; attr_count &lt; ARRAY_SIZE(attrs); attr_count++) &#123;</span><br><span class="line">        retval = sysfs_create_file(&amp;rmi4_data-&gt;input_dev-&gt;dev.kobj,</span><br><span class="line">                &amp;attrs[attr_count].attr);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synaptics_secure_touch_init(rmi4_data);</span><br><span class="line">    synaptics_secure_touch_stop(rmi4_data, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-1-3ã€åˆ†é…Input-devç»“æ„ä½“"><a href="#7-1-3ã€åˆ†é…Input-devç»“æ„ä½“" class="headerlink" title="7.1.3ã€åˆ†é…Input_devç»“æ„ä½“"></a>7.1.3ã€åˆ†é…Input_devç»“æ„ä½“</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_set_input_dev</span><span class="params">(struct synaptics_rmi4_data *rmi4_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span> =</span></span><br><span class="line"><span class="class">                <span class="title">rmi4_data</span>-&gt;<span class="title">hw_if</span>-&gt;<span class="title">board_data</span>;</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev = input_allocate_device();</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹-set-bit-EV-SYN-evbit-ã€set-bit-EV-KEY-evbit-ã€set-bit-EV-ABS-evbit-â€¦â€¦"><a href="#7-2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹-set-bit-EV-SYN-evbit-ã€set-bit-EV-KEY-evbit-ã€set-bit-EV-ABS-evbit-â€¦â€¦" class="headerlink" title="7.2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹ set_bit(EV_SYN, evbit)ã€set_bit(EV_KEY, evbit)ã€set_bit(EV_ABS,evbit) â€¦â€¦"></a>7.2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹ set_bit(EV_SYN, evbit)ã€set_bit(EV_KEY, evbit)ã€set_bit(EV_ABS,evbit) â€¦â€¦</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_set_input_dev</span><span class="params">(struct synaptics_rmi4_data *rmi4_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span> =</span></span><br><span class="line"><span class="class">                <span class="title">rmi4_data</span>-&gt;<span class="title">hw_if</span>-&gt;<span class="title">board_data</span>;</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev = input_allocate_device();</span><br><span class="line">    ......</span><br><span class="line">    retval = synaptics_rmi4_query_device(rmi4_data);</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//#define PLATFORM_DRIVER_NAME "synaptics_dsxv26"(synaptics_dsx_v2_6.h)</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;name = PLATFORM_DRIVER_NAME;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;phys = INPUT_PHYS_NAME;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;id.product = SYNAPTICS_DSX_DRIVER_PRODUCT;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;id.version = SYNAPTICS_DSX_DRIVER_VERSION;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;dev.parent = rmi4_data-&gt;pdev-&gt;dev.parent;</span><br><span class="line">    input_set_drvdata(rmi4_data-&gt;input_dev, rmi4_data);</span><br><span class="line"></span><br><span class="line">    set_bit(EV_SYN, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(EV_KEY, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(EV_ABS, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(BTN_TOUCH, rmi4_data-&gt;input_dev-&gt;keybit);</span><br><span class="line">    set_bit(BTN_TOOL_FINGER, rmi4_data-&gt;input_dev-&gt;keybit);</span><br><span class="line"></span><br><span class="line">    synaptics_rmi4_set_params(rmi4_data);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-3ã€æ³¨å†Œè®¾å¤‡input-register-device"><a href="#7-3ã€æ³¨å†Œè®¾å¤‡input-register-device" class="headerlink" title="7.3ã€æ³¨å†Œè®¾å¤‡input_register_device()"></a>7.3ã€æ³¨å†Œè®¾å¤‡input_register_device()</h2><p>æ­¤å¤„å³ä¸å‰é¢kernel logå‘¼åº”ï¼šæ³¨å†Œåä¸º synaptics_dsxv26 çš„è¾“å…¥è®¾å¤‡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_set_input_dev</span><span class="params">(struct synaptics_rmi4_data *rmi4_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span> =</span></span><br><span class="line"><span class="class">                <span class="title">rmi4_data</span>-&gt;<span class="title">hw_if</span>-&gt;<span class="title">board_data</span>;</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev = input_allocate_device();</span><br><span class="line">    ......</span><br><span class="line">    retval = synaptics_rmi4_query_device(rmi4_data);</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//#define PLATFORM_DRIVER_NAME "synaptics_dsxv26"(synaptics_dsx_v2_6.h)</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;name = PLATFORM_DRIVER_NAME;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;phys = INPUT_PHYS_NAME;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;id.product = SYNAPTICS_DSX_DRIVER_PRODUCT;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;id.version = SYNAPTICS_DSX_DRIVER_VERSION;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;dev.parent = rmi4_data-&gt;pdev-&gt;dev.parent;</span><br><span class="line">    input_set_drvdata(rmi4_data-&gt;input_dev, rmi4_data);</span><br><span class="line"></span><br><span class="line">    set_bit(EV_SYN, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(EV_KEY, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(EV_ABS, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(BTN_TOUCH, rmi4_data-&gt;input_dev-&gt;keybit);</span><br><span class="line">    set_bit(BTN_TOOL_FINGER, rmi4_data-&gt;input_dev-&gt;keybit);</span><br><span class="line"></span><br><span class="line">    synaptics_rmi4_set_params(rmi4_data);</span><br><span class="line">    ......</span><br><span class="line">    retval = input_register_device(rmi4_data-&gt;input_dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ"><a href="#7-4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ" class="headerlink" title="7.4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ"></a>7.4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ</h2><p>å½“è§¦æ‘¸å±æŒ‰ä¸‹ï¼Œä¼šäº§ç”Ÿä¸­æ–­ï¼Œè¿›è€Œè°ƒç”¨ä¸­æ–­å¤„ç†å‡½æ•°synaptics_rmi4_irq():</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> irqreturn_t <span class="title">synaptics_rmi4_irq</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_data</span> *<span class="title">rmi4_data</span> = <span class="title">data</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span> =</span></span><br><span class="line"><span class="class">            <span class="title">rmi4_data</span>-&gt;<span class="title">hw_if</span>-&gt;<span class="title">board_data</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IRQ_HANDLED == synaptics_filter_interrupt(data))</span><br><span class="line">        <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gpio_get_value(bdata-&gt;irq_gpio) != bdata-&gt;irq_on_state)</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line"></span><br><span class="line">    synaptics_rmi4_sensor_report(rmi4_data, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥è°ƒç”¨synaptics_rmi4_sensor_report(rmi4_data, true)å¤„ç†æ•°æ®ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synaptics_rmi4_sensor_report</span><span class="params">(struct synaptics_rmi4_data *rmi4_data,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">bool</span> report)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> data[MAX_INTR_REGISTERS + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *intr = &amp;data[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">bool</span> was_in_bl_mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_f01_device_status</span> <span class="title">status</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_fn</span> *<span class="title">fhandler</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_exp_fhandler</span> *<span class="title">exp_fhandler</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_device_info</span> *<span class="title">rmi</span>;</span></span><br><span class="line"></span><br><span class="line">    rmi = &amp;(rmi4_data-&gt;rmi4_mod_info);</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    retval = synaptics_rmi4_reg_read(rmi4_data,</span><br><span class="line">            rmi4_data-&gt;f01_data_base_addr,</span><br><span class="line">            data,</span><br><span class="line">            rmi4_data-&gt;num_of_intr_regs + <span class="number">1</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//è¯»å–å¯„å­˜å™¨æ•°æ®</span></span><br><span class="line">    status.data[<span class="number">0</span>] = data[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (status.status_code == STATUS_CRC_IN_PROGRESS) &#123;</span><br><span class="line">        retval = synaptics_rmi4_check_status(rmi4_data,</span><br><span class="line">                &amp;was_in_bl_mode);</span><br><span class="line">        ....</span><br><span class="line">        retval = synaptics_rmi4_reg_read(rmi4_data,</span><br><span class="line">                rmi4_data-&gt;f01_data_base_addr,</span><br><span class="line">                status.data,</span><br><span class="line">                <span class="keyword">sizeof</span>(status.data));</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status.unconfigured &amp;&amp; !status.flash_prog) &#123;</span><br><span class="line">        pr_notice(<span class="string">"%s: spontaneous reset detected\n"</span>, __func__);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//synaptics_rmi4_report_touch()ä¸ŠæŠ¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (!list_empty(&amp;rmi-&gt;support_fn_list)) &#123;</span><br><span class="line">        list_for_each_entry(fhandler, &amp;rmi-&gt;support_fn_list, link) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fhandler-&gt;num_of_data_sources) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fhandler-&gt;intr_mask &amp;</span><br><span class="line">                        intr[fhandler-&gt;intr_reg_num]) &#123;</span><br><span class="line">                    synaptics_rmi4_report_touch(rmi4_data,</span><br><span class="line">                            fhandler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;exp_data.mutex);</span><br><span class="line">    <span class="keyword">if</span> (!list_empty(&amp;exp_data.<span class="built_in">list</span>)) &#123;</span><br><span class="line">        list_for_each_entry(exp_fhandler, &amp;exp_data.<span class="built_in">list</span>, link) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!exp_fhandler-&gt;insert &amp;&amp;</span><br><span class="line">                    !exp_fhandler-&gt;remove &amp;&amp;</span><br><span class="line">                    (exp_fhandler-&gt;exp_fn-&gt;attn != <span class="literal">NULL</span>))</span><br><span class="line">                exp_fhandler-&gt;exp_fn-&gt;attn(rmi4_data, intr[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;exp_data.mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-4-1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š"><a href="#7-4-1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š" class="headerlink" title="7.4.1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š"></a>7.4.1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synaptics_rmi4_report_touch</span><span class="params">(struct synaptics_rmi4_data *rmi4_data,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct synaptics_rmi4_fn *fhandler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">switch</span> (fhandler-&gt;fn_number) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> SYNAPTICS_RMI4_F12:</span><br><span class="line">        touch_count_2d = synaptics_rmi4_f12_abs_report(rmi4_data,</span><br><span class="line">                fhandler);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (touch_count_2d)</span><br><span class="line">            rmi4_data-&gt;fingers_on_2d = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            rmi4_data-&gt;fingers_on_2d = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_f12_abs_report</span><span class="params">(struct synaptics_rmi4_data *rmi4_data,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct synaptics_rmi4_fn *fhandler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> touch_count = <span class="number">0</span>; <span class="comment">/* number of touch points */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> finger;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> fingers_to_process;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> finger_status;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> size_of_2d_data;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> gesture_type;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> data_addr;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line">    <span class="keyword">int</span> wx;</span><br><span class="line">    <span class="keyword">int</span> wy;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_f12_extra_data</span> *<span class="title">extra_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_f12_finger_data</span> *<span class="title">data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_f12_finger_data</span> *<span class="title">finger_data</span>;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> finger_presence;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> stylus_presence;</span><br><span class="line"></span><br><span class="line">    fingers_to_process = fhandler-&gt;num_of_data_points;</span><br><span class="line">    data_addr = fhandler-&gt;full_addr.data_base;</span><br><span class="line">    extra_data = (struct synaptics_rmi4_f12_extra_data *)fhandler-&gt;extra;</span><br><span class="line">    size_of_2d_data = <span class="keyword">sizeof</span>(struct synaptics_rmi4_f12_finger_data);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    retval = synaptics_rmi4_reg_read(rmi4_data,</span><br><span class="line">            data_addr + extra_data-&gt;data1_offset,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)fhandler-&gt;data,</span><br><span class="line">            fingers_to_process * size_of_2d_data);</span><br><span class="line">    <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    data = (struct synaptics_rmi4_f12_finger_data *)fhandler-&gt;data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;(rmi4_data-&gt;rmi4_report_mutex));</span><br><span class="line">    <span class="comment">//æ ¹æ®è§¦æ‘¸ç‚¹æ•°é‡å¾ªç¯ä¸ŠæŠ¥inputæ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span> (finger = <span class="number">0</span>; finger &lt; fingers_to_process; finger++) &#123;</span><br><span class="line">        finger_data = data + finger;</span><br><span class="line">        finger_status = finger_data-&gt;object_type_and_status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        x = (finger_data-&gt;x_msb &lt;&lt; <span class="number">8</span>) | (finger_data-&gt;x_lsb);</span><br><span class="line">        y = (finger_data-&gt;y_msb &lt;&lt; <span class="number">8</span>) | (finger_data-&gt;y_lsb);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rmi4_data-&gt;hw_if-&gt;board_data-&gt;swap_axes) &#123;</span><br><span class="line">            temp = x;</span><br><span class="line">            x = y;</span><br><span class="line">            y = temp;</span><br><span class="line">            temp = wx;</span><br><span class="line">            wx = wy;</span><br><span class="line">            wy = temp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rmi4_data-&gt;hw_if-&gt;board_data-&gt;x_flip)</span><br><span class="line">            x = rmi4_data-&gt;sensor_max_x - x;</span><br><span class="line">        <span class="keyword">if</span> (rmi4_data-&gt;hw_if-&gt;board_data-&gt;y_flip)</span><br><span class="line">            y = rmi4_data-&gt;sensor_max_y - y;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (finger_status) &#123;</span><br><span class="line">        <span class="keyword">case</span> F12_FINGER_STATUS:</span><br><span class="line">        <span class="keyword">case</span> F12_GLOVED_FINGER_STATUS:</span><br><span class="line"></span><br><span class="line">            input_report_key(rmi4_data-&gt;input_dev,</span><br><span class="line">                    BTN_TOUCH, <span class="number">1</span>);</span><br><span class="line">            input_report_key(rmi4_data-&gt;input_dev,</span><br><span class="line">                    BTN_TOOL_FINGER, <span class="number">1</span>);</span><br><span class="line">            input_report_abs(rmi4_data-&gt;input_dev,</span><br><span class="line">                    ABS_MT_POSITION_X, x);</span><br><span class="line">            input_report_abs(rmi4_data-&gt;input_dev,</span><br><span class="line">                    ABS_MT_POSITION_Y, y);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    input_sync(rmi4_data-&gt;input_dev);</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;(rmi4_data-&gt;rmi4_report_mutex));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> touch_count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨input_report_key()ã€input_report_abs()ã€input_sync() ä¸ŠæŠ¥ã€åŒæ­¥æ•°æ®ã€‚</p><h2 id="ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h2><p><a href="https://blog.csdn.net/column/details/input.html" target="_blank" rel="noopener">Linux/Androidâ€”-Inputç³»ç»Ÿ</a><br><a href="https://blog.csdn.net/tiantangniaochao/article/details/50497353" target="_blank" rel="noopener">Android Inputå­ç³»ç»Ÿæµ…è°ˆ</a><br><a href="http://huaqianlee.github.io/2017/11/23/Android/Android-Linux-input-system-analysis/" target="_blank" rel="noopener">Android(Linux) è¾“å…¥å­ç³»ç»Ÿè§£æ</a><br><a href="http://www.cnblogs.com/jason-lu/p/3156411.html" target="_blank" rel="noopener">inputå­ç³»ç»Ÿåˆ†æä¹‹ä¸‰:é©±åŠ¨æ¨¡å—</a><br><a href="https://blog.csdn.net/fanwenjieok/article/details/38503027" target="_blank" rel="noopener">Linuxé©±åŠ¨æ¡†æ¶ä¹‹â€”-Inputå­ç³»ç»Ÿ</a><br><a href="https://www.zybuluo.com/zifehng/note/718523" target="_blank" rel="noopener">inputå­ç³»ç»Ÿäº‹ä»¶å¤„ç†å±‚(evdev)çš„ç¯å½¢ç¼“å†²åŒº</a><br><a href="https://blog.csdn.net/ielife/article/details/7814108" target="_blank" rel="noopener">linux inputè¾“å…¥å­ç³»ç»Ÿåˆ†æã€Šå››ã€‹ï¼šinputå­ç³»ç»Ÿæ•´ä½“æµç¨‹å…¨é¢åˆ†æ</a><br><a href="https://blog.csdn.net/yueqian_scut/article/details/48792939" target="_blank" rel="noopener">Linux inputå­ç³»ç»Ÿåˆ†æä¹‹äºŒï¼šæ·±å…¥å‰–æinput_handlerã€input_coreã€input_device</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/linux.input&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€åšå®¢åŸå›¾é“¾æ¥ã€‘&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æºç ï¼ˆéƒ¨åˆ†
      
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]</title>
    <link href="http://zhoujinjian.cc/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-%E7%AA%97%E5%8F%A3%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%88%86%E6%9E%90-i-wonder/"/>
    <id>http://zhoujinjian.cc/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-çª—å£ç®¡ç†æœåŠ¡åˆ†æ-i-wonder/</id>
    <published>2018-02-28T16:00:00.000Z</published>
    <updated>2018-04-19T14:30:05.646Z</updated>
    
    <content type="html"><![CDATA[<p>çª—å£ç®¡ç†ç³»ç»ŸWMSæ˜¯Androidä¸­çš„ä¸»è¦å­ç³»ç»Ÿä¹‹ä¸€ï¼Œå®ƒæ¶‰åŠåˆ°Appä¸­ç»„ä»¶çš„ç®¡ç†ï¼Œç³»ç»Ÿå’Œåº”ç”¨çª—å£çš„ç®¡ç†å’Œç»˜åˆ¶ç­‰å·¥ä½œã€‚ç”±äºå…¶æ¶‰åŠæ¨¡å—ä¼—å¤šï¼Œä¸”ä¸ç”¨æˆ·ä½“éªŒå¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯Androidå½“ä¸­æœ€ä¸ºå¤æ‚çš„å­ç³»ç»Ÿä¹‹ä¸€ã€‚ä¸€ä¸ªAppä»å¯åŠ¨åˆ°ä¸»çª—å£æ˜¾ç¤ºå‡ºæ¥ï¼Œéœ€è¦Appï¼ŒActivityManagerServiceï¼ˆAMSï¼‰ï¼ŒWindowManagerServiceï¼ˆWMSï¼‰ï¼ŒSurfaceFlingerï¼ˆSFï¼‰ç­‰å‡ ä¸ªæ¨¡å—ç›¸äº’åˆä½œã€‚Appè´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œç»˜åˆ¶è‡ªå·±çš„è§†å›¾ï¼›AMSç®¡ç†ç»„ä»¶ã€è¿›ç¨‹ä¿¡æ¯å’ŒActivityçš„å †æ ˆåŠçŠ¶æ€ç­‰ç­‰ï¼›WMSç®¡ç†Activityå¯¹åº”çš„çª—å£åŠå­çª—å£ï¼Œè¿˜æœ‰ç³»ç»Ÿçª—å£ç­‰ï¼›SFç”¨äºç®¡ç†å›¾å½¢ç¼“å†²åŒºï¼Œå°†Appç»˜åˆ¶çš„ä¸œè¥¿åˆæˆæ¸²æŸ“åœ¨å±å¹•ä¸Šã€‚</p><a id="more"></a><h2 id="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"><a href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘" class="headerlink" title="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.wms" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></h2><h2 id="æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"><a href="#æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š" class="headerlink" title="æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"></a>æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</h2><p><strong>/frameworks/base/services/core/java/com/android/server/am/</strong></p><ul><li>ActivityStack.java</li><li>ActivityManagerService.java</li><li>ActivityStackSupervisor.java</li><li>ActivityStarter.java</li><li>ActivityRecord.java</li></ul><p><strong>/frameworks/base/core/java/android/view/</strong></p><ul><li>WindowManagerImpl.java</li><li>ViewManager.java</li><li>WindowManagerGlobal.java</li><li>ViewRootImpl.java</li><li>Choreographer.java</li><li>IWindowSession.aidl</li><li>DisplayEventReceiver.java</li><li>SurfaceControl.java</li><li>Surface.java</li><li>SurfaceSession.java</li></ul><p><strong>/frameworks/base/services/core/java/com/android/server/wm/</strong></p><ul><li>WindowManagerService.java</li><li>AppWindowAnimator.java</li><li>AppTransition.java</li><li>AppWindowToken.java</li><li>Session.java</li><li>WindowState.java</li><li>WindowAnimator.java</li><li>WindowStateAnimator.java</li><li>WindowSurfacePlacer.java</li><li>WindowSurfaceController.java</li></ul><h2 id="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1"><a href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1" class="headerlink" title="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.wms" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></h2><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹çª—å£å¯åŠ¨ã€é€€å‡ºè¿‡ç¨‹åŠ¨æ€å›¾ï¼Œä¹‹åå†è¯¦ç»†åˆ†æï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/01-Android-WMS-ezgif.com-gif-maker-WindowManagerService-resize.gif" alt="Markdown"></p><h2 id="ï¼ˆä¸€ï¼‰ã€Window-ç»„ç»‡æ–¹å¼"><a href="#ï¼ˆä¸€ï¼‰ã€Window-ç»„ç»‡æ–¹å¼" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Window ç»„ç»‡æ–¹å¼"></a>ï¼ˆä¸€ï¼‰ã€Window ç»„ç»‡æ–¹å¼</h2><p>ActivityManagerServiceï¼ˆAMSï¼‰ï¼ŒWindowManagerServiceï¼ˆWMSï¼‰ï¼ŒSurfaceFlingerï¼ˆSFï¼‰ç­‰å‡ ä¸ªæ¨¡å—ç›¸äº’åˆä½œã€‚Appè´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œç»˜åˆ¶è‡ªå·±çš„è§†å›¾ï¼›AMSç®¡ç†ç»„ä»¶ã€è¿›ç¨‹ä¿¡æ¯å’ŒActivityçš„å †æ ˆåŠçŠ¶æ€ç­‰ç­‰ï¼›WMSç®¡ç†Activityå¯¹åº”çš„çª—å£åŠå­çª—å£ï¼Œè¿˜æœ‰ç³»ç»Ÿçª—å£ç­‰ï¼›SFç”¨äºç®¡ç†å›¾å½¢ç¼“å†²åŒºï¼Œå°†Appç»˜åˆ¶çš„ä¸œè¥¿åˆæˆæ¸²æŸ“åœ¨å±å¹•ä¸Šã€‚ çª—å£ç®¡ç†ç³»ç»Ÿä¸»è¦æ¡†æ¶ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/02-Android-WMS-AMS-SurfaceFlinger-Conn.png" alt="Markdown"></p><blockquote><p>ä¸»è¦å¯¹è±¡åŠŸèƒ½ä»‹ç»ï¼š</p><p>WindowManagerServiceè´Ÿè´£å®Œæˆçª—å£çš„ç®¡ç†å·¥ä½œ</p><p>WindowStateå’Œåº”ç”¨ç«¯çª—å£ä¸€ä¸€å¯¹åº”ï¼Œåº”ç”¨è°ƒç”¨WMSæ·»åŠ çª—å£æ—¶ï¼Œæœ€ç»ˆä¼šåœ¨WindowManagerService.addWindow()åˆ›å»ºä¸€ä¸ªWindowStateä¸ä¹‹ä¸€ä¸€å¯¹åº”</p><p>WindowTokenæ˜¯ä¸€ä¸ªå¥æŸ„ï¼Œä¿å­˜äº†æ‰€æœ‰å…·æœ‰åŒä¸€ä¸ªtokençš„WindowStateã€‚åº”ç”¨è¯·æ±‚WindowManagerServiceæ·»åŠ çª—å£çš„æ—¶å€™ï¼Œæä¾›äº†ä¸€ä¸ªtokenï¼Œè¯¥tokenæ ‡è¯†äº†è¢«æ·»åŠ çª—å£çš„å½’å±ï¼ŒWindowManagerServiceä¸ºè¯¥tokenç”Ÿæˆä¸€ä¸ªWindowTokenå¯¹è±¡ï¼Œæ‰€æœ‰tokenç›¸åŒçš„WindowStateè¢«å…³è”åˆ°åŒä¸€ä¸ªWindowTokenï¼Œå¦‚è¾“å…¥æ³•æ·»åŠ çª—å£æ—¶ï¼Œä¼šä¼ é€’ä¸€ä¸ªIBinder mCurTokenï¼Œå¢™çº¸æœåŠ¡æ·»åŠ çª—å£æ—¶ï¼Œä¼šä¼ é€’ä¸€ä¸ªWallpaperConnection::final Binder mTokenã€‚</p><p>AppWindowTokenç»§æ‰¿äºWindowTokenï¼Œä¸“é—¨ç”¨äºæ ‡è¯†ä¸€ä¸ªActivityã€‚AppWindowTokené‡Œçš„tokenå®é™…ä¸Šå°±æ˜¯æŒ‡å‘äº†ä¸€ä¸ªActivityã€‚ActivityManagerServiceé€šçŸ¥åº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œåœ¨æœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªtokenç”¨äºæ ‡è¯†è¯¥Activityï¼Œå¹¶ä¸”æŠŠè¯¥tokenä¼ é€’åˆ°åº”ç”¨å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯çš„Activityåœ¨ç”³è¯·æ·»åŠ çª—å£æ—¶ï¼Œä»¥è¯¥tokenä½œä¸ºæ ‡è¯†ä¼ é€’åˆ°WindowManagerServiceã€‚åŒä¸€ä¸ªActivityä¸­çš„ä¸»çª—å£ã€å¯¹è¯æ¡†çª—å£ã€èœå•çª—å£éƒ½å…³è”åˆ°åŒä¸€ä¸ªAppWindowTokenã€‚</p><p>Sessionè¡¨ç¤ºä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„äº¤äº’ä¼šè¯ã€‚ä¸€èˆ¬æ¥è¯´ä¸åŒçš„åº”ç”¨é€šè¿‡ä¸åŒçš„ä¼šè¯æ¥å’ŒWindowManagerServiceäº¤äº’ï¼Œä½†æ˜¯å¤„äºåŒä¸€ä¸ªè¿›ç¨‹çš„ä¸åŒåº”ç”¨é€šè¿‡åŒä¸€ä¸ªSessionæ¥äº¤äº’ã€‚</p></blockquote><h3 id="1-1ã€Android-Tokenä»‹ç»"><a href="#1-1ã€Android-Tokenä»‹ç»" class="headerlink" title="1.1ã€Android Tokenä»‹ç»"></a>1.1ã€Android Tokenä»‹ç»</h3><p>Tokenæ˜¯ActivityRecordçš„å†…éƒ¨é™æ€ç±»ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹Tokençš„ç»§æ‰¿å…³ç³»ï¼ŒToken extends IApplicationToken.Stubï¼Œä»IApplicationToken.Stubç±»è¿›è¡Œç»§æ‰¿ï¼Œæ ¹æ®Binderçš„æœºåˆ¶å¯ä»¥çŸ¥é“Tokenæ˜¯ä¸€ä¸ªåŒ¿åBinderå®ä½“ç±»ï¼Œè¿™ä¸ªåŒ¿åBinderå®ä½“ä¼šä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹ä¼šæ‹¿åˆ°Tokençš„ä»£ç†ç«¯ã€‚ æˆ‘ä»¬çŸ¥é“åŒ¿åBinderæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ç”¨é€”ï¼Œä¸€ä¸ªæ˜¯æ‹¿åˆ°Binderä»£ç†ç«¯åå¯è·¨Binderè°ƒç”¨å®ä½“ç«¯çš„å‡½æ•°æ¥å£ï¼Œå¦ä¸€ä¸ªä½œç”¨ä¾¿æ˜¯åœ¨å¤šä¸ªè¿›ç¨‹ä¸­æ ‡è¯†åŒä¸€ä¸ªå¯¹è±¡ã€‚å¾€å¾€è¿™ä¸¤ä¸ªä½œç”¨æ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œç ”ç©¶çš„Tokenå°±åŒæ—¶å­˜åœ¨è¿™ä¸¤ä¸ªä½œç”¨ï¼Œä½†æœ€é‡è¦çš„ä¾¿æ˜¯åè€…ï¼ŒTokenæ ‡è¯†äº†ä¸€ä¸ªActivityRecordå¯¹è±¡ï¼Œå³é—´æ¥æ ‡è¯†äº†ä¸€ä¸ªActivityã€‚</p><p>Tokenæ¢³ç†ï¼š åˆ†ææºç ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå¤§å¤šæ•° token çš„å¯¹è±¡ï¼Œéƒ½è¡¨ç¤ºä¸€ä¸ª IBinder å¯¹è±¡ã€‚æåˆ° IBinderï¼Œå¤§å®¶ä¸€ç‚¹ä¹Ÿä¸é™Œç”Ÿï¼Œå°±æ˜¯ Android çš„ IPC é€šä¿¡æœºåˆ¶ã€‚åœ¨åˆ›å»ºçª—å£è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°çš„ IPC é€šä¿¡ï¼Œæ— éåŒ…å«ä¸¤æ–¹é¢ï¼Œä¸€ä¸ªæ˜¯ WmS ç”¨æ¥è·Ÿåº”ç”¨æ‰€åœ¨çš„è¿›ç¨‹è¿›è¡Œé€šä¿¡çš„ ViewRootImpl.W ç±»çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªæ˜¯æŒ‡å‘ä¸€ä¸ª ActivityRecord çš„å¯¹è±¡ï¼Œè‡ªç„¶åº”è¯¥æ˜¯WMSç”¨æ¥è·Ÿ AMSè¿›è¡Œé€šä¿¡çš„äº†ã€‚æˆ‘ä»¬æ¢³ç†äº†ä¸€ä¸‹ï¼Œtoken ä»¥ä¸‹å‡ å¤„çš„å®šä¹‰ï¼Œåˆ†åˆ«æ¥è®²è®²è¿™é‡Œçš„ token ä»£è¡¨ä»€ä¹ˆã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/03-Android-WMS-Token-Detail.png" alt="Markdown"></p><p>åˆ†æä¸€ä¸‹ View çš„ AttachInfo çš„èµ‹å€¼ã€‚ViewRootImpl åœ¨æ„å»ºæ–¹æ³•é‡Œï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ª AttachInfo å®ä¾‹ï¼ŒæŠŠå®ƒçš„ Sessionï¼Œä»¥åŠ Wç±»å¯¹è±¡èµ‹å€¼ç»™ AttachInfoã€‚åˆ†æå¯ä»¥çœ‹åˆ°ï¼ŒAttachInfo ä¸­çš„ mWindowTokenï¼Œä¸mWindow éƒ½æ˜¯æŒ‡å‘ ViewRootImpl ä¸­çš„ mWindow(Wç±»å®ä¾‹)ã€‚å½“ä¸€ä¸ª View attach åˆ°çª—å£åï¼ŒViewRootImplä¼šæ‰§è¡ŒperformTraversalsï¼Œå¦‚æœå‘ç°æ˜¯é¦–æ¬¡è°ƒç”¨ä¼šï¼Œä¼šæŠŠè‡ªå·±çš„ mAttachInfo ä¼ é€’ç»™æ ¹ Viewï¼ˆé€šè¿‡dispatchAttachedToWindowï¼‰ï¼Œå‘Šè¯‰ View æ ‘ç°åœ¨å·²ç» attch to Window äº†ï¼Œé©¬ä¸Šå¯ä»¥æ˜¾ç¤ºäº†ã€‚æ ¹ Viewï¼ˆä¸€èˆ¬æ˜¯ ViewGroupï¼‰ä¼šæŠŠè¿™ä¸ªä¿¡æ¯ï¼Œéå†åœ°ä¼ é€’ç»™ View æ ‘ä¸­çš„æ¯ä¸€ä¸ªå­ Viewï¼Œè¿™æ ·æ¯ä¸ª View çš„ mAttachInfo éƒ½è¢«èµ‹å€¼ä¸º ViewRootImp çš„ mAttachInfoäº†ã€‚</p><h3 id="1-1-1ã€Tokenå¯¹è±¡çš„åˆ›å»º"><a href="#1-1-1ã€Tokenå¯¹è±¡çš„åˆ›å»º" class="headerlink" title="1.1.1ã€Tokenå¯¹è±¡çš„åˆ›å»º"></a>1.1.1ã€Tokenå¯¹è±¡çš„åˆ›å»º</h3><p>ä¸‹é¢è¿™ä¸ªå›¾æ˜¯Tokençš„ä¼ é€’ï¼Œé¦–å…ˆä¼šä¼ é€’åˆ°WMSä¸­ï¼Œæ¥ç€ä¼šä¼ é€’åˆ°åº”ç”¨è¿›ç¨‹ActivityThreadä¸­ï¼Œä¸‹é¢æ¥å…·ä½“åˆ†æè¿™ä¸ªä¼ é€’æµç¨‹ã€‚ æ€»ä½“æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/04-Android-WMS-Token.png" alt="Markdown"></p><p>æˆ‘ä»¬ä¹‹å‰åˆ†æï¼šã€Android 7.1.2 (Android N) Activityå¯åŠ¨æµç¨‹åˆ†æã€‘ åœ¨å¯åŠ¨Activityè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ActivityStarter.startActivityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params">        TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ActivityRecord sourceRecord = <span class="keyword">null</span>;</span><br><span class="line">    ActivityRecord resultRecord = <span class="keyword">null</span>;</span><br><span class="line">    ......</span><br><span class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">            intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">            requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, mSupervisor, container,</span><br><span class="line">            options, sourceRecord);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        err = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                <span class="keyword">true</span>, options, inTask);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨startActivityLocked()ä¸­åˆ›å»ºäº†ä¸€ä¸ªActivityRecordå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityRecord.java]</span><br><span class="line"><span class="keyword">final</span> IApplicationToken.Stub appToken; <span class="comment">// window manager token</span></span><br><span class="line"></span><br><span class="line">ActivityRecord(ActivityManagerService _service, ProcessRecord _caller,</span><br><span class="line">        <span class="keyword">int</span> _launchedFromUid, String _launchedFromPackage, Intent _intent, String _resolvedType,</span><br><span class="line">        ActivityInfo aInfo, Configuration _configuration,</span><br><span class="line">        ActivityRecord _resultTo, String _resultWho, <span class="keyword">int</span> _reqCode,</span><br><span class="line">        <span class="keyword">boolean</span> _componentSpecified, <span class="keyword">boolean</span> _rootVoiceInteraction,</span><br><span class="line">        ActivityStackSupervisor supervisor,</span><br><span class="line">        ActivityContainer container, ActivityOptions options, ActivityRecord sourceRecord) &#123;</span><br><span class="line">    service = _service;</span><br><span class="line">    appToken = <span class="keyword">new</span> Token(<span class="keyword">this</span>, service);</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨ActivityRecordçš„æ„é€ å‡½æ•°ä¸­åˆ›å»ºï¼Œæ ‡è¯†ç€å½“å‰è¿™ä¸ªActivityRecordï¼Œå³é—´æ¥ä»£è¡¨ç€ä¸€ä¸ªActivityã€‚</p><h3 id="1-1-2ã€AMSè°ƒç”¨WMSçš„addAPPToken-æ¥å£"><a href="#1-1-2ã€AMSè°ƒç”¨WMSçš„addAPPToken-æ¥å£" class="headerlink" title="1.1.2ã€AMSè°ƒç”¨WMSçš„addAPPToken()æ¥å£"></a>1.1.2ã€AMSè°ƒç”¨WMSçš„addAPPToken()æ¥å£</h3><p>åœ¨å¯åŠ¨ä¸€ä¸ªActivityæ—¶ï¼Œä¼šè°ƒç”¨startActivityLocked()æ¥åœ¨WMSä¸­æ·»åŠ ä¸€ä¸ªAppWindowTokenå¯¹è±¡ startActivityLocked()åˆ›å»ºActivityRecordå¯¹è±¡åä¼šç»§ç»­è°ƒç”¨startActivityUnchecked()æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mTargetStack.startActivityLocked(mStartActivity, newTask, mKeepCurTransition, mOptions);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStack.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> keepCurTransition,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityOptions options)</span> </span>&#123;</span><br><span class="line">            ......</span><br><span class="line">            addConfigOverride(r, task);</span><br><span class="line">            ......</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addConfigOverride</span><span class="params">(ActivityRecord r, TaskRecord task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Rect bounds = task.updateOverrideConfigurationFromLaunchBounds();</span><br><span class="line">        <span class="comment">// è·³è½¬åˆ°WMS</span></span><br><span class="line">        mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</span><br><span class="line">                r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</span><br><span class="line">                (r.info.flags &amp; FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId, r.info.configChanges,</span><br><span class="line">                task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind, bounds, task.mOverrideConfig,</span><br><span class="line">                task.mResizeMode, r.isAlwaysFocusable(), task.isHomeTask(),</span><br><span class="line">                r.appInfo.targetSdkVersion, r.mRotationAnimationHint);</span><br><span class="line">        r.taskConfigOverride = task.mOverrideConfig;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»§ç»­çœ‹ä¸‹WindowManager.addAppToken()æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAppToken</span><span class="params">(<span class="keyword">int</span> addPos, IApplicationToken token, <span class="keyword">int</span> taskId, <span class="keyword">int</span> stackId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> requestedOrientation, <span class="keyword">boolean</span> fullscreen, <span class="keyword">boolean</span> showForAllUsers, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> voiceInteraction, <span class="keyword">boolean</span> launchTaskBehind,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect taskBounds, Configuration config, <span class="keyword">int</span> taskResizeMode, <span class="keyword">boolean</span> alwaysFocusable,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> homeTask, <span class="keyword">int</span> targetSdkVersion, <span class="keyword">int</span> rotationAnimationHint)</span> </span>&#123;</span><br><span class="line">      ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            AppWindowToken atoken = findAppWindowToken(token.asBinder());</span><br><span class="line">            <span class="keyword">if</span> (atoken != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG_WM, <span class="string">"Attempted to add existing app token: "</span> + token);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ ¹æ®ActivityRecordä¸­IApplicationToken.Stubçš„ä»£ç†ï¼Œåˆ›å»ºAppWindowToken</span></span><br><span class="line">            atoken = <span class="keyword">new</span> AppWindowToken(<span class="keyword">this</span>, token, voiceInteraction);</span><br><span class="line">            atoken.inputDispatchingTimeoutNanos = inputDispatchingTimeoutNanos;</span><br><span class="line">            atoken.appFullscreen = fullscreen;</span><br><span class="line">            atoken.showForAllUsers = showForAllUsers;</span><br><span class="line">            atoken.targetSdk = targetSdkVersion;</span><br><span class="line">            atoken.requestedOrientation = requestedOrientation;</span><br><span class="line">            atoken.layoutConfigChanges = (configChanges &amp;</span><br><span class="line">                    (ActivityInfo.CONFIG_SCREEN_SIZE | ActivityInfo.CONFIG_ORIENTATION)) != <span class="number">0</span>;</span><br><span class="line">            atoken.mLaunchTaskBehind = launchTaskBehind;</span><br><span class="line">            atoken.mAlwaysFocusable = alwaysFocusable;</span><br><span class="line">            atoken.mRotationAnimationHint = rotationAnimationHint;</span><br><span class="line"></span><br><span class="line">            Task task = mTaskIdToTask.get(taskId);</span><br><span class="line">            <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</span><br><span class="line">                task = createTaskLocked(taskId, stackId, userId, atoken, taskBounds, config);</span><br><span class="line">            &#125;</span><br><span class="line">            task.addAppToken(addPos, atoken, taskResizeMode, homeTask);</span><br><span class="line">            <span class="comment">//å°†atokenæ”¾å…¥åˆ°mTokenMapä¸­ï¼Œç­‰åº”ç”¨ç¨‹åºaddWindowæ—¶ï¼Œè¿›è¡Œèº«ä»½éªŒè¯</span></span><br><span class="line">            <span class="comment">//å…¶ä¸­token.asBinder()æ˜¯IApplicationToken.Stubçš„ä»£ç†ï¼Œatokenå°±æ˜¯æ ¹æ®ä»£ç†ï¼Œå¾—åˆ°å¯¹åº”AppWindowToken</span></span><br><span class="line">            mTokenMap.put(token.asBinder(), atoken);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Application tokens start out hidden.</span></span><br><span class="line">            atoken.hidden = <span class="keyword">true</span>;</span><br><span class="line">            atoken.hiddenRequested = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="1-1-3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity-å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹"><a href="#1-1-3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity-å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹" class="headerlink" title="1.1.3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity()å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹"></a>1.1.3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity()å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹</h3><p>å½“æ¡†æ¶é€šè¿‡ApplicationThreadçš„ä»£ç†å›è°ƒåˆ°ActivityThreadçš„æ—¶å€™ï¼Œå°†å¯¹åº”çš„æ­¥éª¤ä¸€ç§ç”Ÿæˆçš„tokenä»£ç†ä¼ å…¥ã€‚ ActivityStackSupervisor.realStartActivityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStackSupervisor.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">      ......</span><br><span class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡è°ƒç”¨IApplicationThreadçš„æ–¹æ³•å®ç°çš„ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯scheduleLaunchActivity()æ–¹æ³•ï¼Œæ‰€ä»¥çœŸæ­£æ‰§è¡Œçš„æ˜¯ActivityThreadä¸­çš„scheduleLaunchActivity()ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java :ApplicationThread]</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">                ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">                CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">                List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line">            <span class="comment">//ä¼ é€’ç»™äº†ActivityThreadçš„tokenï¼Œè¿™ä¸ªtokenå°±æ˜¯IApplicationToken.Stubçš„ä»£ç†</span></span><br><span class="line">            r.token = token;</span><br><span class="line">            ......</span><br><span class="line">            updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">            sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="1-1-4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹"><a href="#1-1-4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹" class="headerlink" title="1.1.4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹"></a>1.1.4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹</h3><p>è¯¦ç»†è¿‡ç¨‹è¯·æŸ¥çœ‹ï¼šã€Android 7.1.2 (Android N) Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹åˆ†æã€‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityThread.java]</span><br><span class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    ......</span><br><span class="line">    r = performResumeActivity(token, clearHide, reason);</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            <span class="comment">//è·å¾—ä¸ºå½“å‰Activityåˆ›å»ºçš„çª—å£PhoneWindowå¯¹è±¡</span></span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            <span class="comment">//è·å–ä¸ºçª—å£åˆ›å»ºçš„è§†å›¾DecorViewå¯¹è±¡</span></span><br><span class="line">            View decor = r.window.getDecorView();</span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            <span class="comment">//åœ¨attachå‡½æ•°ä¸­å°±ä¸ºå½“å‰Activityåˆ›å»ºäº†WindowManagerå¯¹è±¡  </span></span><br><span class="line">            ViewManager wm = a.getWindowManager();</span><br><span class="line">            <span class="comment">//å¾—åˆ°è¯¥è§†å›¾å¯¹è±¡çš„å¸ƒå±€å‚æ•°  </span></span><br><span class="line">            WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">            <span class="comment">//å°†è§†å›¾å¯¹è±¡ä¿å­˜åˆ°Activityçš„æˆå‘˜å˜é‡mDecorä¸­  </span></span><br><span class="line">            a.mDecor = decor;</span><br><span class="line">            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">            l.softInputMode |= forwardBit;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//å°†åˆ›å»ºçš„è§†å›¾å¯¹è±¡DecorViewæ·»åŠ åˆ°Activityçš„çª—å£ç®¡ç†å™¨ä¸­  </span></span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125;</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                r.activity.makeVisible();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›è€Œå±‚å±‚è°ƒç”¨åˆ°ï¼šViewRootImpl.setView()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line">WindowManager.LayoutParams l = r.window.getAttributes();</span><br></pre></td></tr></table></figure><p>ViewRootImpl.setView()å‡½æ•°ä¸­æ·»åŠ Activityçª—å£æ—¶åœ¨å‚æ•°mWindowAttributesä¸­æºå¸¦Tokenä»£ç†å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewManager.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,  </span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,  </span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outContentInsets, Rect outStableInsets, InputChannel outInputChannel)</span> </span>&#123;  </span><br><span class="line">        ......  </span><br><span class="line">        <span class="keyword">boolean</span> addToken = <span class="keyword">false</span>;  </span><br><span class="line">        <span class="comment">//attrsè¿™ä¸ªæ˜¯åº”ç”¨ç¨‹åºActivityClientRecordä¸­ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œå…¶ä¸­çš„attrs.tokenå°±æ˜¯æ­¥éª¤ä¸‰ç§çš„r.token</span></span><br><span class="line">        WindowToken token = mTokenMap.get(attrs.token);  </span><br><span class="line">        ......  </span><br><span class="line">        win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,  </span><br><span class="line">                attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);  </span><br><span class="line"></span><br><span class="line">        mWindowMap.put(client.asBinder(), win);  </span><br><span class="line">        ......  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®Binderæœºåˆ¶å¯ä»¥çŸ¥é“ä»ä¸Šå±‚åº”ç”¨ä¼ é€’è¿‡æ¥çš„Tokenä»£ç†å¯¹è±¡ä¼šè½¬æ¢æˆSystemServerè¿›ç¨‹ä¸­çš„Tokenæœ¬åœ°å¯¹è±¡ï¼Œåè€…ä¸ç¬¬2æ­¥ä¸­ä»Tokenå¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ä¸Šé¢è°ƒç”¨mTokenMap.get(attrs.token)æ—¶ä¾¿èƒ½è¿”å›æ­£ç¡®è¿”å›ä¸€ä¸ªWindowTokenï¼ˆè¿™ä¸ªWindowTokenå…¶å®æ˜¯ä¸€ä¸ªAPPWindowTokenï¼‰ï¼Œè¿™æ ·æ·»åŠ çš„çª—å£ä¹Ÿå°±è·ŸActivityå…³è”ä¸Šäº†ã€‚</p><h3 id="1-2ã€WMSç»„ç»‡æ–¹å¼"><a href="#1-2ã€WMSç»„ç»‡æ–¹å¼" class="headerlink" title="1.2ã€WMSç»„ç»‡æ–¹å¼"></a>1.2ã€WMSç»„ç»‡æ–¹å¼</h3><p>Activityç®¡ç†æœåŠ¡ActivityManagerServiceä¸­æ¯ä¸€ä¸ªActivityRecordå¯¹è±¡åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¸­éƒ½å¯¹åº”æœ‰ä¸€ä¸ªAppWindowTokenå¯¹è±¡ã€‚</p><p>æ­¤å¤–ï¼Œåœ¨è¾“å…¥æ³•ç®¡ç†æœåŠ¡InputMethodManagerServiceä¸­ï¼Œæ¯ä¸€ä¸ªè¾“å…¥æ³•çª—å£éƒ½å¯¹åº”æœ‰ä¸€ä¸ªBinderå¯¹è±¡ï¼Œè¿™ä¸ªBinderå¯¹è±¡åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceåˆå¯¹åº”æœ‰ä¸€ä¸ªWindowTokenå¯¹è±¡ã€‚</p><p>ä¸è¾“å…¥æ³•çª—å£ç±»ä¼¼ï¼Œåœ¨å£çº¸ç®¡ç†æœåŠ¡WallpaperManagerServiceä¸­ï¼Œæ¯ä¸€ä¸ªå£çº¸çª—å£éƒ½å¯¹åº”æœ‰ä¸€ä¸ªBinderå¯¹è±¡ï¼Œè¿™ä¸ªBinderå¯¹è±¡åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¹Ÿå¯¹åº”æœ‰ä¸€ä¸ªWindowTokenå¯¹è±¡ã€‚</p><p>åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¸­ï¼Œæ— è®ºæ˜¯AppWindowTokenå¯¹è±¡ï¼Œè¿˜æ˜¯WindowTokenå¯¹è±¡ï¼Œå®ƒä»¬éƒ½æ˜¯ç”¨æ¥æè¿°ä¸€ç»„æœ‰ç€ç›¸åŒä»¤ç‰Œçš„çª—å£çš„ï¼Œæ¯ä¸€ä¸ªçª—å£éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªWindowStateå¯¹è±¡æ¥æè¿°çš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªActivityç»„ä»¶çª—å£å¯èƒ½æœ‰ä¸€ä¸ªå¯åŠ¨çª—å£ï¼ˆStarting Windowï¼‰ï¼Œè¿˜æœ‰è‹¥å¹²ä¸ªå­çª—å£ï¼Œé‚£ä¹ˆè¿™äº›çª—å£å°±ä¼šç»„æˆä¸€ç»„ï¼Œå¹¶ä¸”éƒ½æ˜¯ä»¥Activityç»„ä»¶åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¸­æ‰€å¯¹åº”çš„AppWindowTokenå¯¹è±¡ä¸ºä»¤ç‰Œçš„ã€‚ä»æŠ½è±¡çš„è§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¸­ï¼Œæ¯ä¸€ä¸ªä»¤ç‰Œï¼ˆAppWindowTokenæˆ–è€…WindowTokenï¼‰éƒ½æ˜¯ç”¨æ¥æè¿°ä¸€ç»„çª—å£ï¼ˆWindowStateï¼‰çš„ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªçª—å£çš„å­çª—å£ä¹Ÿæ˜¯ä¸å®ƒåŒå±äºä¸€ä¸ªç»„ï¼Œå³éƒ½æœ‰ç€ç›¸åŒçš„ä»¤ç‰Œã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/05-Android-WMS-AppWindowToken.png" alt="Markdown"><br>å…¶ä¸­ï¼ŒActivity Stackæ˜¯åœ¨ActivityManagerServiceæœåŠ¡ä¸­åˆ›å»ºçš„ï¼ŒToken Listå’ŒWindow Stackæ˜¯åœ¨WindowManagerServiceä¸­åˆ›å»ºçš„ï¼Œè€ŒBinder for IMå’ŒBinder for WPåˆ†åˆ«æ˜¯åœ¨InputMethodManagerServiceæœåŠ¡å’ŒWallpaperManagerServiceæœåŠ¡ä¸­åˆ›å»ºçš„ï¼Œç”¨æ¥æè¿°ä¸€ä¸ªè¾“å…¥æ³•çª—å£å’Œä¸€ä¸ªå£çº¸çª—å£ã€‚</p><h3 id="1-3ã€WMSçª—å£ç±»å‹"><a href="#1-3ã€WMSçª—å£ç±»å‹" class="headerlink" title="1.3ã€WMSçª—å£ç±»å‹"></a>1.3ã€WMSçª—å£ç±»å‹</h3><p>æ·»åŠ ä¸€ä¸ªçª—å£æ˜¯é€šè¿‡ WindowManagerGlobal.addView()æ¥å®Œæˆçš„ï¼Œåˆ†æ addView æ–¹æ³•çš„å‚æ•°ï¼Œæœ‰ä¸‰ä¸ªå‚æ•°æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œviewï¼Œparamsï¼Œä»¥åŠ displayã€‚è€Œ display ä¸€èˆ¬ç›´æ¥å– WindowMnagerImpl ä¸­çš„ mDisplayï¼Œè¡¨ç¤ºè¦è¾“å‡ºçš„æ˜¾ç¤ºè®¾å¤‡ã€‚view è‡ªç„¶è¡¨ç¤ºè¦æ˜¾ç¤ºçš„ Viewï¼Œè€Œ params æ˜¯ WindowManager.LayoutParamsï¼Œç”¨æ¥æè¿°è¿™ä¸ª view çš„äº›çª—å£å±æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„å‚æ•° typeï¼Œç”¨æ¥æè¿°çª—å£çš„ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerGlobal]</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">            Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (display == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"display must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(params <span class="keyword">instanceof</span> WindowManager.LayoutParams)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Params must be WindowManager.LayoutParams"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ```</span><br></pre></td></tr></table></figure><p>}</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æ‰“å¼€WindowManagerç±»ï¼Œçœ‹åˆ°é™æ€å†…éƒ¨ç±»ã€‚</span><br><span class="line"></span><br><span class="line">``` java</span><br><span class="line">[-&gt;WindowManager]</span><br><span class="line">public static class LayoutParams extends ViewGroup.LayoutParams implements Parcelable &#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨LayoutParamsä¸­ï¼Œæœ‰2ä¸ªæ¯”è¾ƒé‡è¦çš„å‚æ•°: flags,typeã€‚ æˆ‘ä»¬ç®€è¦çš„åˆ†æä¸€ä¸‹flags,è¯¥å‚æ•°è¡¨ç¤ºWindowçš„å±æ€§ï¼Œå®ƒæœ‰å¾ˆå¤šé€‰é¡¹ï¼Œé€šè¿‡è¿™äº›é€‰é¡¹å¯ä»¥æ§åˆ¶Windowçš„æ˜¾ç¤ºç‰¹æ€§ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»å‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„é€‰é¡¹ã€‚</p><p>FLAG_NOT_FOCUSABLE è¡¨ç¤ºWindowä¸éœ€è¦è·å–ç„¦ç‚¹ï¼Œä¹Ÿä¸éœ€è¦æ¥æ”¶å„ç§è¾“å…¥äº‹ä»¶ï¼Œæ­¤æ ‡è®°ä¼šåŒæ—¶å¯ç”¨FLAG_NOT_TOUCH_MODALï¼Œæœ€ç»ˆäº‹ä»¶ä¼šç›´æ¥ä¼ é€’ç»™ä¸‹å±‚å…·æœ‰ç„¦ç‚¹çš„Windowã€‚</p><p>FLAG_NOT_TOUCH_MODAL ç³»ç»Ÿä¼šå°†å½“å‰WindowåŒºåŸŸä»¥å¤–çš„å•å‡»äº‹ä»¶ä¼ é€’ç»™åº•å±‚çš„Windowï¼Œå½“å‰WindowåŒºåŸŸä»¥å†…çš„å•å‡»äº‹ä»¶åˆ™è‡ªå·±å¤„ç†ï¼Œè¿™ä¸ªæ ‡è®°å¾ˆé‡è¦ï¼Œä¸€èˆ¬æ¥è¯´éƒ½éœ€è¦å¼€å¯æ­¤æ ‡è®°ï¼Œå¦åˆ™å…¶ä»–Windowå°†æ— æ³•æ¥æ”¶åˆ°å•å‡»äº‹ä»¶ã€‚</p><p>FLAG_SHOW_WHEN_LOCKED å¼€å¯æ­¤æ¨¡å¼å¯ä»¥è®©Windowæ˜¾ç¤ºåœ¨é”å±çš„ç•Œé¢ä¸Šã€‚</p><blockquote><p>Typeå‚æ•°è¡¨ç¤ºWindowçš„ç±»å‹ï¼ŒWindowæœ‰ä¸‰ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯åº”ç”¨Windowã€å­Windowã€ç³»ç»ŸWindowã€‚åº”ç”¨ç±»Windowå¯¹åº”ç€ä¸€ä¸ªActivityã€‚å­Windowä¸èƒ½å•ç‹¬å­˜åœ¨ï¼Œå®ƒéœ€è¦é™„å±åœ¨ç‰¹å®šçš„çˆ¶Windowä¹‹ä¸­ï¼Œæ¯”å¦‚å¸¸è§çš„PopupWindowå°±æ˜¯ä¸€ä¸ªå­Windowã€‚æœ‰äº›ç³»ç»ŸWindowæ˜¯éœ€è¦å£°æ˜æƒé™æ‰èƒ½åˆ›å»ºçš„Windowï¼Œæ¯”å¦‚Toastå’Œç³»ç»ŸçŠ¶æ€æ è¿™äº›éƒ½æ˜¯ç³»ç»ŸWindowã€‚</p></blockquote><h3 id="1-3-1ã€åº”ç”¨çª—å£"><a href="#1-3-1ã€åº”ç”¨çª—å£" class="headerlink" title="1.3.1ã€åº”ç”¨çª—å£"></a>1.3.1ã€åº”ç”¨çª—å£</h3><p>Activity å¯¹åº”çš„çª—å£ç±»å‹æ˜¯åº”ç”¨çª—å£ï¼Œ æ‰€æœ‰ Activity é»˜è®¤çš„çª—å£ç±»å‹æ˜¯ TYPE_BASE_APPLICATIONã€‚ WindowManager çš„ LayoutParams çš„é»˜è®¤ç±»å‹æ˜¯ TYPE_APPLICATIONã€‚ Dialog å¹¶æ²¡æœ‰è®¾ç½®typeï¼Œæ‰€ä»¥ä¹Ÿæ˜¯é»˜è®¤çš„çª—å£ç±»å‹å³ TYPE_APPLICATIONã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManager.LayoutParams]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</span><br><span class="line">    type = TYPE_APPLICATION;</span><br><span class="line">    format = PixelFormat.OPAQUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">typeå±‚çº§</th><th style="text-align:left">ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">FIRST_APPLICATION_WINDOW=1</td><td style="text-align:left">å¼€å§‹åº”ç”¨ç¨‹åºçª—å£ï¼Œç¬¬ä¸€ä¸ªæ™®é€šåº”ç”¨çª—å£</td></tr><tr><td style="text-align:left">TYPE_BASE_APPLICATION=1</td><td style="text-align:left">æ‰€æœ‰ç¨‹åºçª—å£çš„baseçª—å£ï¼Œå…¶ä»–åº”ç”¨ç¨‹åºçª—å£éƒ½æ˜¾ç¤ºåœ¨å®ƒä¸Šé¢</td></tr><tr><td style="text-align:left">TYPE_APPLICATION=2</td><td style="text-align:left">æ™®é€šåº”ç”¨ç¨‹åºçª—å£ï¼Œtokenå¿…é¡»è®¾ç½®ä¸ºActivityçš„tokenæ¥æŒ‡å®šçª—å£å±äºè°</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_STARTING=3</td><td style="text-align:left">åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å…ˆæ˜¾ç¤ºæ­¤çª—å£ï¼Œå½“çœŸæ­£çš„çª—å£é…ç½®å®Œæˆåï¼Œå…³é—­æ­¤çª—å£</td></tr><tr><td style="text-align:left">LAST_APPLICATION_WINDOW=99</td><td style="text-align:left">æœ€åä¸€ä¸ªåº”ç”¨çª—å£</td></tr></tbody></table><h3 id="1-3-2ã€å­çª—å£"><a href="#1-3-2ã€å­çª—å£" class="headerlink" title="1.3.2ã€å­çª—å£"></a>1.3.2ã€å­çª—å£</h3><p>å­çª—å£ä¸èƒ½å•ç‹¬å­˜åœ¨ï¼Œå®ƒéœ€è¦é™„å±åœ¨ç‰¹å®šçš„çˆ¶Windowä¹‹ä¸­ï¼Œä¾‹å¦‚å¼€ç¯‡ç¬¬ä¸€å¼ å›¾ï¼Œç»¿è‰²æ¡†æ¡†å³ä¸ºpopupWindowï¼Œå®ƒå°±æ˜¯å­çª—å£ï¼Œç±»å‹ä¸€èˆ¬ä¸ºTYPE_APPLICATION_PANELã€‚ä¹‹æ‰€ä»¥ç§°ä¸ºå­çª—å£ï¼Œå³å®ƒçš„çˆ¶çª—å£æ˜¾ç¤ºæ—¶ï¼Œå­çª—å£æ‰æ˜¾ç¤ºã€‚çˆ¶çª—å£ä¸æ˜¾ç¤ºï¼Œå®ƒä¹Ÿä¸æ˜¾ç¤ºã€‚è¿½éšçˆ¶çª—å£ã€‚</p><table><thead><tr><th style="text-align:left">typeå±‚çº§</th><th style="text-align:left">ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">FIRST_SUB_WINDOW=1000</td><td style="text-align:left">ç¬¬ä¸€ä¸ªå­çª—å£</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_PANEL=1000</td><td style="text-align:left">åº”ç”¨çª—å£çš„å­çª—å£,popupWindowçš„é»˜è®¤ç±»å‹</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_MEDIA=1001</td><td style="text-align:left">åª’ä½“çª—å£</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_SUB_PANEL=1002</td><td style="text-align:left">TYPE_APPLICATION_PANEçš„å­çª—å£</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_ATTACHED_DIALOG=1003</td><td style="text-align:left">å¯¹è¯æ¡†ï¼Œç±»ä¼¼äºé¢æ¿çª—å£(OptionMenu,ContextMenu)</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_MEDIA_OVERLAY=1004</td><td style="text-align:left">åª’ä½“ä¿¡æ¯ï¼Œæ˜¾ç¤ºåœ¨åª’ä½“å±‚å’Œç¨‹åºçª—å£ä¹‹é—´ï¼Œéœ€è¦å®ç°åŠé€æ˜æ•ˆæœ</td></tr><tr><td style="text-align:left">LAST_SUB_WINDOW=1999</td><td style="text-align:left">æœ€åä¸€ä¸ªå­çª—å£</td></tr></tbody></table><h3 id="1-3-3ã€ç³»ç»Ÿçª—å£"><a href="#1-3-3ã€ç³»ç»Ÿçª—å£" class="headerlink" title="1.3.3ã€ç³»ç»Ÿçª—å£"></a>1.3.3ã€ç³»ç»Ÿçª—å£</h3><p>ç³»ç»Ÿçª—å£è·Ÿåº”ç”¨çª—å£ä¸åŒï¼Œä¸éœ€è¦å¯¹åº” Activityã€‚è·Ÿå­çª—å£ä¸åŒï¼Œä¸éœ€è¦æœ‰çˆ¶çª—å£ã€‚ä¸€èˆ¬æ¥è®²ï¼Œç³»ç»Ÿçª—å£åº”è¯¥ç”±ç³»ç»Ÿæ¥åˆ›å»ºçš„ï¼Œä¾‹å¦‚å‘ç”Ÿå¼‚å¸¸ï¼ŒANRæ—¶çš„æç¤ºæ¡†ï¼Œåˆå¦‚ç³»ç»ŸçŠ¶æ€æ ï¼Œå±ä¿ç­‰ã€‚ä½†æ˜¯ï¼ŒFramework è¿˜æ˜¯å®šä¹‰äº†ä¸€äº›ï¼Œå¯ä»¥è¢«åº”ç”¨æ‰€åˆ›å»ºçš„ç³»ç»Ÿçª—å£ï¼Œå¦‚ TYPE _TOASTï¼ŒTYPE <em>INPUT</em> METHODï¼ŒTYPE _WALLPAPTER ç­‰ç­‰ã€‚</p><table><thead><tr><th style="text-align:left">typeå±‚çº§</th><th style="text-align:left">ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">FIRST_SYSTEM_WINDOW=2000</td><td style="text-align:left">ç¬¬ä¸€ä¸ªç³»ç»Ÿçª—å£</td></tr><tr><td style="text-align:left">TYPE_STATUS_BAR=2000</td><td style="text-align:left">çŠ¶æ€æ ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçŠ¶æ€æ ï¼Œä½äºå±å¹•é¡¶ç«¯</td></tr><tr><td style="text-align:left">TYPE_SEARCH_BAR =2001</td><td style="text-align:left">æœç´¢æ </td></tr><tr><td style="text-align:left">TYPE_PHONE=2002</td><td style="text-align:left">ç”µè¯çª—å£ï¼Œå®ƒç”¨äºç”µè¯äº¤äº’</td></tr><tr><td style="text-align:left">TYPE_SYSTEM_ALERT=2003</td><td style="text-align:left">ç³»ç»Ÿè­¦å‘Šï¼Œå‡ºç°åœ¨åº”ç”¨ç¨‹åºçª—å£ä¹‹ä¸Š</td></tr><tr><td style="text-align:left">TYPE_KEYGUARD=2004</td><td style="text-align:left">é”å±çª—å£</td></tr><tr><td style="text-align:left">TYPE_TOAST=2005</td><td style="text-align:left">ä¿¡æ¯çª—å£ï¼Œç”¨äºæ˜¾ç¤ºToast</td></tr><tr><td style="text-align:left">TYPE_SYSTEM_OVERLAY=2006</td><td style="text-align:left">ç³»ç»Ÿé¡¶å±‚çª—å£ï¼Œæ˜¾ç¤ºåœ¨å…¶ä»–å†…å®¹ä¹‹ä¸Šï¼Œæ­¤çª—å£ä¸èƒ½è·å¾—è¾“å…¥ç„¦ç‚¹ï¼Œå¦åˆ™å½±å“é”å±</td></tr><tr><td style="text-align:left">TYPE_PRIORITY_PHONE=2007</td><td style="text-align:left">å½“é”å±æ—¶æ˜¾ç¤ºçš„æ¥ç”µæ˜¾ç¤ºçª—å£</td></tr><tr><td style="text-align:left">TYPE_SYSTEM_DIALOG=2008</td><td style="text-align:left">ç³»ç»Ÿå¯¹è¯æ¡†</td></tr><tr><td style="text-align:left">TYPE_KEYGUARD_DIALOG=2009</td><td style="text-align:left">é”å±æ—¶æ˜¾ç¤ºçš„å¯¹è¯æ¡†</td></tr><tr><td style="text-align:left">TYPE_SYSTEM_ERROR=2010</td><td style="text-align:left">ç³»ç»Ÿå†…éƒ¨é”™è¯¯æç¤º</td></tr><tr><td style="text-align:left">TYPE_INPUT_METHOD=2011</td><td style="text-align:left">è¾“å…¥æ³•çª—å£ï¼Œæ˜¾ç¤ºäºæ™®é€šåº”ç”¨/å­çª—å£ä¹‹ä¸Š</td></tr><tr><td style="text-align:left">TYPE_INPUT_METHOD_DIALOG=2012</td><td style="text-align:left">è¾“å…¥æ³•ä¸­å¤‡é€‰æ¡†å¯¹åº”çš„çª—å£</td></tr><tr><td style="text-align:left">TYPE_WALLPAPER=2013</td><td style="text-align:left">å¢™çº¸çª—å£</td></tr><tr><td style="text-align:left">TYPE_STATUS_BAR_PANEL=2014</td><td style="text-align:left">æ»‘åŠ¨çŠ¶æ€æ¡åå‡ºç°çš„çª—å£</td></tr><tr><td style="text-align:left">TYPE_SECURE_SYSTEM_OVERLAY=2015</td><td style="text-align:left">å®‰å…¨ç³»ç»Ÿè¦†ç›–çª—å£</td></tr><tr><td style="text-align:left">â€¦â€¦</td><td style="text-align:left">â€¦â€¦</td></tr><tr><td style="text-align:left">LAST_SYSTEM_WINDOW=2999</td><td style="text-align:left">æœ€åä¸€ä¸ªç³»ç»Ÿçª—å£</td></tr></tbody></table><p>é‚£ä¹ˆï¼Œè¿™ä¸ªtypeå±‚çº§åˆ°åº•æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ Windowæ˜¯åˆ†å±‚çš„ï¼Œæ¯ä¸ªWindowéƒ½æœ‰å¯¹åº”çš„z-orderedï¼Œï¼ˆzè½´ï¼Œä»1å±‚å±‚å åŠ åˆ°2999ï¼Œä½ å¯ä»¥å°†å±å¹•æƒ³æˆä¸‰ç»´åæ ‡æ¨¡å¼ï¼‰å±‚çº§å¤§çš„ä¼šè¦†ç›–åœ¨å±‚çº§å°çš„Windowä¸Šé¢ã€‚</p><p>åœ¨ä¸‰ç±»Windowä¸­ï¼Œåº”ç”¨Windowçš„å±‚çº§èŒƒå›´æ˜¯1~99ã€‚å­Windowçš„å±‚çº§èŒƒå›´æ˜¯1000~1999ï¼Œç³»ç»ŸWindowçš„å±‚çº§èŒƒå›´æ˜¯2000~2999ï¼Œè¿™äº›å±‚çº§èŒƒå›´å¯¹åº”ç€WindowManager.LayoutParamsçš„typeå‚æ•°ã€‚å¦‚æœæƒ³è¦Windowä½äºæ‰€æœ‰Windowçš„æœ€é¡¶å±‚ï¼Œé‚£ä¹ˆé‡‡ç”¨è¾ƒå¤§çš„å±‚çº§å³å¯ã€‚å¦å¤–æœ‰äº›ç³»ç»Ÿå±‚çº§çš„ä½¿ç”¨æ˜¯éœ€è¦å£°æ˜æƒé™çš„ã€‚</p><h2 id="ï¼ˆäºŒï¼‰ã€Window-Sizeï¼ˆå¤§å°ï¼‰å’Œ-Window-Positionï¼ˆä½ç½®ï¼‰-è®¡ç®—è¿‡ç¨‹"><a href="#ï¼ˆäºŒï¼‰ã€Window-Sizeï¼ˆå¤§å°ï¼‰å’Œ-Window-Positionï¼ˆä½ç½®ï¼‰-è®¡ç®—è¿‡ç¨‹" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Window Sizeï¼ˆå¤§å°ï¼‰å’Œ Window Positionï¼ˆä½ç½®ï¼‰ è®¡ç®—è¿‡ç¨‹"></a>ï¼ˆäºŒï¼‰ã€Window Sizeï¼ˆå¤§å°ï¼‰å’Œ Window Positionï¼ˆä½ç½®ï¼‰ è®¡ç®—è¿‡ç¨‹</h2><p>ä¹‹å‰åœ¨ã€Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿåˆ†æ [i.wonder~]ã€‘åˆ†æè¿‡ï¼Œå½“Vsyncäº‹ä»¶åˆ°æ¥æ—¶ï¼Œå°±ä¼šé€šè¿‡Choreographerçš„postCallback()ï¼Œæ¥ç€æ‰§è¡ŒmTraversalRunnableå¯¹è±¡çš„run()æ–¹æ³•ã€‚ mTraversalRunnableå¯¹è±¡çš„ç±»å‹ä¸ºTraversalRunnableï¼Œè¯¥ç±»å®ç°äº†Runnableæ¥å£ï¼Œåœ¨å…¶run()å‡½æ•°ä¸­è°ƒç”¨äº†doTraversal()å‡½æ•°æ¥å®Œæˆçª—å£å¸ƒå±€ã€‚ä¸ºäº†åˆ†æçš„è¿è´¯æ€§ï¼Œè¿™é‡Œé‡æ–°è´´ä¸€ä¸‹æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> TraversalRunnable mTraversalRunnable = <span class="keyword">new</span> TraversalRunnable();</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line">        ......</span><br><span class="line">        performTraversals();</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>performTraversals()å‡½æ•°ç›¸å½“å¤æ‚ï¼Œå…¶ä¸»è¦å®ç°ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š</p><p>1.æ‰§è¡Œçª—å£æµ‹é‡ï¼›</p><p>2.æ‰§è¡Œçª—å£æ³¨å†Œï¼›</p><p>3.æ‰§è¡Œçª—å£å¸ƒå±€ï¼›</p><p>4.æ‰§è¡Œçª—å£ç»˜å›¾ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£æµ‹é‡******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">        windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************å‘WMSæœåŠ¡æ·»åŠ çª—å£******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">            viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£å¸ƒå±€******************/</span></span><br><span class="line">    <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">        performLayout(lp, mWidth, mHeight);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£ç»˜åˆ¶******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">        ......</span><br><span class="line">        performDraw();</span><br><span class="line">    &#125; ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1ã€-Android-å±å¹•åŒºåŸŸä»‹ç»"><a href="#2-1ã€-Android-å±å¹•åŒºåŸŸä»‹ç»" class="headerlink" title="2.1ã€ Android å±å¹•åŒºåŸŸä»‹ç»"></a>2.1ã€ Android å±å¹•åŒºåŸŸä»‹ç»</h3><p>é¦–å…ˆæ¥çœ‹relayoutWindow()ã€‚relayoutWindow() æ˜¯Window Manager Service é‡è¦å·¥ä½œä¹‹ä¸€ï¼Œå®ƒçš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/06-Android-WMS-relayoutWindow-flow.png.png" alt="Markdown"></p><p>æ¯ä¸ªViewå°†æœŸæœ›çª—å£å°ºå¯¸äº¤ç»™WMSï¼ˆWindowManager Service). WMS å°†æ‰€æœ‰çš„çª—å£å¤§å°ä»¥åŠå½“å‰çš„OverscanåŒºåŸŸä¼ ç»™WPM ï¼ˆWindowManager Policy). WPMæ ¹æ®ç”¨æˆ·é…ç½®ç¡®å®šæ¯ä¸ªWindowåœ¨æœ€ç»ˆDisplayè¾“å‡ºä¸Šçš„ä½ç½®ä»¥åŠéœ€è¦åˆ†é…çš„Surfaceå¤§å°ã€‚ è¿”å›è¿™äº›ä¿¡æ¯ç»™æ¯ä¸ªViewï¼Œä»–ä»¬å°†åœ¨ç»™ä¼šçš„åŒºåŸŸç©ºé—´é‡Œç»˜å›¾ã€‚ Androidé‡Œå®šä¹‰äº†å¾ˆå¤šåŒºåŸŸ,å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/07-Android-WMS-OverSan-area.png" alt="Markdown"></p><p><strong>Overscan:</strong> Overscan æ˜¯ç”µè§†ç‰¹æœ‰çš„æ¦‚å¿µï¼Œä¸Šå›¾ä¸­é»„è‰²éƒ¨åˆ†å°±æ˜¯OverscanåŒºåŸŸï¼ŒæŒ‡çš„æ˜¯ç”µè§†æœºå±å¹•å››å‘¨æŸäº›ä¸å¯è§çš„åŒºåŸŸï¼ˆå› ä¸ºç”µè§†ç‰¹æ€§ï¼Œè¿™éƒ¨åˆ†åŒºåŸŸçš„bufferå†…å®¹æ˜¾ç¤ºæ—¶è¢«ä¸¢å¼ƒï¼‰ï¼Œä¹Ÿæ„å‘³ç€å¦‚æœçª—å£çš„æŸäº›å†…å®¹ç”»åœ¨è¿™ä¸ªåŒºåŸŸé‡Œï¼Œå®ƒåœ¨æŸäº›ç”µè§†ä¸Šå°±ä¼šçœ‹ä¸åˆ°ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œé€šå¸¸è¦æ±‚UIä¸è¦ç”»åœ¨å±å¹•çš„è¾¹è§’ä¸Šï¼Œè€Œæ˜¯é¢„ç•™ä¸€å®šçš„ç©ºé—´ã€‚å› ä¸ºOverscançš„åŒºåŸŸå¤§å°éšç€ç”µè§†ä¸ åŒè€Œä¸åŒï¼Œå®ƒä¸€èˆ¬ç”±ç»ˆç«¯ç”¨æˆ·é€šè¿‡UIæŒ‡å®šï¼Œï¼ˆæ¯”å¦‚è¯´GoogleTVé‡Œå°±æœ‰ç¡®å®šOverscanå¤§å°çš„åº”ç”¨ï¼‰ã€‚</p><p><strong>OverscanScreen, Screen:</strong> OverscanScreen æ˜¯åŒ…å«OverscanåŒºåŸŸçš„å±å¹•å¤§å°,è€ŒScreenåˆ™ä¸ºå»é™¤OverscanåŒºåŸŸåçš„å±å¹•åŒºåŸŸ, OverscanScreen &gt; Screen.</p><p><strong>Restricted and Unrestricted:</strong> æŸäº›åŒºåŸŸæ˜¯è¢«ç³»ç»Ÿä¿ç•™çš„ï¼Œæ¯”å¦‚è¯´æ‰‹æœºå±å¹•ä¸Šæ–¹çš„çŠ¶æ€æ (å¦‚å›¾çº¸ç»¿è‰²åŒºåŸŸï¼‰å’Œä¸‹æ–¹çš„å¯¼èˆªæ ï¼Œæ ¹æ®æ˜¯å¦åŒ…æ‹¬è¿™äº›é¢„ç•™çš„åŒºåŸŸï¼ŒAndroidæŠŠåŒºåŸŸåˆ†ä¸ºUnrestricted Area å’Œ Resctrited Aread, å‰è€…åŒ…æ‹¬è¿™éƒ¨åˆ†é¢„ç•™åŒºåŸŸï¼Œåè€…åˆ™ä¸åŒ…å«, Unrestricted area &gt; Rectricted areaã€‚</p><p><strong>mFrame, mDisplayFrame, mContainingFrame</strong> FrameæŒ‡çš„æ˜¯ä¸€ç‰‡å†…å­˜åŒºåŸŸ, å¯¹åº”äºå±å¹•ä¸Šçš„ä¸€å—çŸ©å½¢åŒºåŸŸ. mFrameçš„å¤§å°å°±æ˜¯Surfaceçš„å¤§å°, å¦‚ä¸Šä¸Šå›¾ä¸­çš„è“è‰²åŒºåŸŸ. mDisplayFrame å’Œ mContainingFrame ä¸€èˆ¬å’ŒmFrame å¤§å°ä¸€è‡´. mXXX æ˜¯Window(ViewRootImpl, Windowstate) é‡Œé¢å®šä¹‰çš„æˆå‘˜å˜é‡.</p><p><strong>mContentFrame, mVisibleFrame</strong> ä¸€ä¸ªSurfaceçš„æ‰€æœ‰å†…å®¹ä¸ä¸€å®šåœ¨å±å¹•ä¸Šéƒ½å¾—åˆ°æ˜¾ç¤º, ä¸Overscané‡å çš„éƒ¨åˆ†ä¼šè¢«æˆªæ‰, ç³»ç»Ÿçš„å…¶ä»–çª—å£ä¹Ÿä¼šé®æŒ¡æ‰éƒ¨åˆ†åŒºåŸŸ (æ¯”å¦‚çŸ­ä¿¡çª—å£ï¼ŒContentFrameæ˜¯800x600(æ²¡æœ‰Status Bar), ä½†å½“è¾“å…¥æ³•çª—å£å¼¹å‡ºæ˜¯ï¼Œå˜æˆäº†800x352), å‰©ä¸‹çš„åŒºåŸŸç§°ä¸ºVisible Frame, UIå†…å®¹åªæœ‰ç”»åœ¨è¿™ä¸ªåŒºåŸŸé‡Œæ‰èƒ½ç¡®ä¿å¯è§. æ‰€ä»¥ä¹Ÿç§°ä¸ºContent Frame. mXXXä¹Ÿæ˜¯Window(ViewRootImpl, WindowState) é‡Œé¢å®šä¹‰çš„æˆå‘˜å˜é‡.<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/08-Android-WMS-Content-Insets.png" alt="Markdown"></p><p><strong>Insets</strong> insetsçš„å®šä¹‰å¦‚ä¸Šå›¾æ‰€ç¤º, ç”¨äº†è¡¨ç¤ºæŸä¸ªFrameçš„è¾¹ç¼˜å¤§å°.</p><h3 id="2-2ã€-Window-å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹"><a href="#2-2ã€-Window-å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹" class="headerlink" title="2.2ã€ Window å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹"></a>2.2ã€ Window å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹</h3><p>åœ¨Androidç³»ç»Ÿä¸­ï¼ŒActivityçª—å£çš„å¤§å°æ˜¯ç”±WindowManagerServiceæœåŠ¡æ¥è®¡ç®—çš„ã€‚WindowManagerServiceæœåŠ¡ä¼šæ ¹æ®å±å¹•åŠå…¶è£…é¥°åŒºçš„å¤§å°æ¥å†³å®šActivityçª—å£çš„å¤§å°ã€‚ä¸€ä¸ªActivityçª—å£åªæœ‰çŸ¥é“è‡ªå·±çš„å¤§å°ä¹‹åï¼Œæ‰èƒ½å¯¹å®ƒé‡Œé¢çš„UIå…ƒç´ è¿›è¡Œæµ‹é‡ã€å¸ƒå±€ä»¥åŠç»˜åˆ¶ã€‚ ä¸€èˆ¬æ¥è¯´ï¼ŒActivityçª—å£çš„å¤§å°ç­‰äºæ•´ä¸ªå±å¹•çš„å¤§å°ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å æ®ç€æ•´å—å±å¹•ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æä¸€ä¸‹Activityçª—å£çš„åŒºåŸŸæ˜¯å¦‚ä½•åˆ’åˆ†çš„ã€‚ æˆ‘ä»¬çŸ¥é“ï¼ŒActivityçª—å£çš„ä¸Šæ–¹ä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ªçŠ¶æ€æ ï¼Œç”¨æ¥æ˜¾ç¤º3Gä¿¡å·ã€ç”µé‡ä½¿ç”¨ç­‰å›¾æ ‡ï¼Œå¦‚å›¾<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/09-Android-WMS-Content-Visible-Frame.png" alt="Markdown"></p><p>ä»Activityçª—å£å‰”é™¤æ‰çŠ¶æ€æ æ‰€å ç”¨çš„åŒºåŸŸä¹‹åï¼Œæ‰€å¾—åˆ°çš„åŒºåŸŸå°±ç§°ä¸ºå†…å®¹åŒºåŸŸï¼ˆContent Regionï¼‰ã€‚é¡¾åæ€ä¹‰ï¼Œå†…å®¹åŒºåŸŸå°±æ˜¯ç”¨æ¥æ˜¾ç¤ºActivityçª—å£çš„å†…å®¹çš„ã€‚æˆ‘ä»¬å†æŠ½è±¡ä¸€ä¸‹ï¼Œå‡è®¾Activityçª—å£çš„å››å‘¨éƒ½æœ‰ä¸€å—ç±»ä¼¼çŠ¶æ€æ çš„åŒºåŸŸï¼Œé‚£ä¹ˆå°†è¿™äº›åŒºåŸŸå‰”é™¤ä¹‹åï¼Œå¾—åˆ°ä¸­é—´çš„é‚£ä¸€å—åŒºåŸŸå°±ç§°ä¸ºå†…å®¹åŒºåŸŸï¼Œè€Œè¢«å‰”é™¤å‡ºæ¥çš„åŒºåŸŸæ‰€ç»„æˆçš„åŒºåŸŸå°±ç§°ä¸ºå†…å®¹è¾¹è¡¬åŒºåŸŸï¼ˆContent Insetsï¼‰ã€‚Activityçª—å£çš„å†…å®¹è¾¹è¡¬åŒºåŸŸå¯ä»¥ç”¨ä¸€ä¸ªå››å…ƒç»„ï¼ˆcontent-left, content-top, content-right, content-bottomï¼‰æ¥æè¿°ï¼Œå…¶ä¸­ï¼Œcontent-leftã€content-rightã€content-topã€content-bottomåˆ†åˆ«ç”¨æ¥æè¿°å†…å®¹åŒºåŸŸä¸çª—å£åŒºåŸŸçš„å·¦å³ä¸Šä¸‹è¾¹ç•Œè·ç¦»ã€‚ æˆ‘ä»¬è¿˜çŸ¥é“ï¼ŒActivityçª—å£æœ‰æ—¶å€™éœ€è¦æ˜¾ç¤ºè¾“å…¥æ³•çª—å£ï¼Œå¦‚å›¾ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/10-Android-WMS-InputMethod-Content-Frame.png" alt="Markdown"></p><p>è¿™æ—¶å€™Activityçª—å£çš„å†…å®¹åŒºåŸŸçš„å¤§å°æœ‰å¯èƒ½æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè¿™å–å†³äºå®ƒçš„Soft Input Modeã€‚æˆ‘ä»¬å‡è®¾Activityçª—å£çš„å†…å®¹åŒºåŸŸæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®ƒåœ¨åº•éƒ¨çš„ä¸€äº›åŒºåŸŸè¢«è¾“å…¥æ³•çª—å£é®æŒ¡äº†ï¼Œå³å®ƒåœ¨åº•éƒ¨çš„ä¸€äº›å†…å®¹æ˜¯ä¸å¯è§çš„ã€‚ä»Activityçª—å£å‰”é™¤æ‰çŠ¶æ€æ å’Œè¾“å…¥æ³•çª—å£æ‰€å ç”¨çš„åŒºåŸŸä¹‹åï¼Œæ‰€å¾—åˆ°çš„åŒºåŸŸå°±ç§°ä¸ºå¯è§åŒºåŸŸï¼ˆVisible Regionï¼‰ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å†æŠ½è±¡ä¸€ä¸‹ï¼Œå‡è®¾Activityçª—å£çš„å››å‘¨éƒ½æœ‰ä¸€å—ç±»ä¼¼çŠ¶æ€æ å’Œè¾“å…¥æ³•çª—å£çš„åŒºåŸŸï¼Œé‚£ä¹ˆå°†è¿™äº›åŒºåŸŸå‰”é™¤ä¹‹åï¼Œå¾—åˆ°ä¸­é—´çš„é‚£ä¸€å—åŒºåŸŸå°±ç§°ä¸ºå¯è§åŒºåŸŸï¼Œè€Œè¢«å‰”é™¤å‡ºæ¥çš„åŒºåŸŸæ‰€ç»„æˆçš„åŒºåŸŸå°±ç§°ä¸ºå¯è§è¾¹è¡¬åŒºåŸŸï¼ˆVisible Insetsï¼‰ã€‚Activityçª—å£çš„å¯è§è¾¹è¡¬åŒºåŸŸå¯ä»¥ç”¨ä¸€ä¸ªå››å…ƒç»„ï¼ˆvisible-left, visible-top, visible-right, visible-bottomï¼‰æ¥æè¿°ï¼Œå…¶ä¸­ï¼Œvisible-leftã€visible-rightã€visible-topã€visible-bottomåˆ†åˆ«ç”¨æ¥æè¿°å¯è§åŒºåŸŸä¸çª—å£åŒºåŸŸçš„å·¦å³ä¸Šä¸‹è¾¹ç•Œè·ç¦»ã€‚</p><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒActivityçª—å£çš„å†…å®¹åŒºåŸŸå’Œå¯è§åŒºåŸŸçš„å¤§å°æ˜¯ä¸€è‡´çš„ï¼Œè€ŒçŠ¶æ€æ å’Œè¾“å…¥æ³•çª—å£æ‰€å ç”¨çš„åŒºåŸŸåˆç§°ä¸ºå±å¹•è£…é¥°åŒºã€‚ç†è§£äº†è¿™äº›æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¨æ–­ï¼ŒWindowManagerServiceæœåŠ¡å®é™…ä¸Šå°±æ˜¯éœ€è¦æ ¹æ®å±å¹•ä»¥åŠå¯èƒ½å‡ºç°çš„çŠ¶æ€æ å’Œè¾“å…¥æ³•çª—å£çš„å¤§å°æ¥è®¡ç®—å‡ºActivityçª—å£çš„æ•´ä½“å¤§å°åŠå…¶å†…å®¹åŒºåŸŸè¾¹è¡¬å’Œå¯è§åŒºåŸŸè¾¹è¡¬çš„å¤§å°ã€‚æœ‰äº†è¿™ä¸‰ä¸ªæ•°æ®ä¹‹åï¼ŒActivityçª—å£å°±å¯ä»¥å¯¹å®ƒé‡Œé¢çš„UIå…ƒç´ è¿›è¡Œæµ‹é‡ã€å¸ƒå±€ä»¥åŠç»˜åˆ¶ç­‰æ“ä½œäº†ã€‚ æ€»ä½“æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/11-Android-WMS-relayoutWindow-time-diagram.png" alt="Markdown"></p><p>è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸º13ä¸ªæ­¥éª¤ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¯¦ç»†åˆ†ææ¯ä¸€ä¸ªæ­¥éª¤ã€‚</p><h3 id="2-2-1ã€ViewRootImpl-performTraversals"><a href="#2-2-1ã€ViewRootImpl-performTraversals" class="headerlink" title="2.2.1ã€ViewRootImpl.performTraversals()"></a>2.2.1ã€ViewRootImpl.performTraversals()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// cache mView since it is used so much below...</span></span><br><span class="line">    <span class="keyword">final</span> View host = mView;</span><br><span class="line">    ......</span><br><span class="line">    WindowManager.LayoutParams lp = mWindowAttributes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> desiredWindowWidth;</span><br><span class="line">    <span class="keyword">int</span> desiredWindowHeight;</span><br><span class="line">    ......</span><br><span class="line">    Rect frame = mWinFrame;</span><br><span class="line">    <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">        mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€æ¬¡è¢«è¯·æ±‚æ‰§è¡Œæµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶æ“ä½œï¼ŒdesiredWindowWidthå’ŒdesiredWindowHeightç­‰äºDisplay Sizeï¼Œå¦åˆ™mWinFrameä¿å­˜çš„å®½åº¦å’Œé«˜åº¦å€¼ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">            Point size = <span class="keyword">new</span> Point();</span><br><span class="line">            mDisplay.getRealSize(size);</span><br><span class="line">            desiredWindowWidth = size.x;</span><br><span class="line">            desiredWindowHeight = size.y;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Configuration config = mContext.getResources().getConfiguration();</span><br><span class="line">            desiredWindowWidth = dipToPx(config.screenWidthDp);</span><br><span class="line">            desiredWindowHeight = dipToPx(config.screenHeightDp);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        host.dispatchAttachedToWindow(mAttachInfo, <span class="number">0</span>);</span><br><span class="line">        mAttachInfo.mTreeObserver.dispatchOnWindowAttachedChange(<span class="keyword">true</span>);</span><br><span class="line">        dispatchApplyInsets(host);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œå½“desiredWindowWidth != mWidth || desiredWindowHeight != mHeightï¼Œè¯´æ˜Activityçª—å£çš„å¤§å°å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ—¶å€™windowSizeMayChange = trueï¼Œä»¥ä¾¿æ¥ä¸‹æ¥å¯¹Activityçª—å£å¤§å°å˜åŒ–è¿›è¡Œå¤„ç†</span></span><br><span class="line">        desiredWindowWidth = frame.width();</span><br><span class="line">        desiredWindowHeight = frame.height();</span><br><span class="line">        <span class="keyword">if</span> (desiredWindowWidth != mWidth || desiredWindowHeight != mHeight) &#123;</span><br><span class="line">            mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">            windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨æ¥è·å¾—Activityçª—å£çš„å½“å‰å®½åº¦desiredWindowWidthå’Œå½“å‰é«˜åº¦desiredWindowHeightã€‚</p><p>ç»§ç»­é˜…è¯»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java::performTraversals()]</span><br><span class="line"><span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line"><span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Resources res = mView.getContext().getResources();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//AttachInfoå¯¹è±¡ç”¨æ¥æè¿°Activityçª—å£çš„å±æ€§,mContentInsetså’ŒmVisibleInsetsåˆ†åˆ«ç”¨æ¥æè¿°Activityçª—å£çš„å½“å‰å†…å®¹è¾¹è¡¬å¤§å°å’Œå¯è§è¾¹è¡¬å¤§å°ã€‚</span></span><br><span class="line">        <span class="comment">//åˆ¤æ–­Activityçª—å£çš„OverscanInsetsã€ContentInsetsã€StableInsetsã€VisibleInsetså¤§å°æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (!mPendingOverscanInsets.equals(mAttachInfo.mOverscanInsets)) &#123;</span><br><span class="line">            insetsChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//WRAP_CONTENTè¡¨æ˜Activityçª—å£çš„å¤§å°è¦ç­‰äºå†…å®¹åŒºåŸŸçš„å¤§å°ï¼ŒåŒæ—¶ç­‰äºDisplay size</span></span><br><span class="line">        <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT</span><br><span class="line">                || lp.height == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">                Point size = <span class="keyword">new</span> Point();</span><br><span class="line">                mDisplay.getRealSize(size);</span><br><span class="line">                desiredWindowWidth = size.x;</span><br><span class="line">                desiredWindowHeight = size.y;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Configuration config = res.getConfiguration();</span><br><span class="line">                desiredWindowWidth = dipToPx(config.screenWidthDp);</span><br><span class="line">                desiredWindowHeight = dipToPx(config.screenHeightDp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Ask host how big it wants to be</span></span><br><span class="line">    <span class="comment">//çŸ¥é“äº†é¡¶å±‚Activityçª—å£å¤§å°ä»è€Œè®¡ç®—Activityå†…å„ä¸ªå­Viewçš„å¤§å°</span></span><br><span class="line">    windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">            desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨æ¥åœ¨Activityçª—å£ä¸»åŠ¨è¯·æ±‚WindowManagerServiceæœåŠ¡è®¡ç®—å¤§å°ä¹‹å‰ï¼Œå¯¹å®ƒçš„é¡¶å±‚è§†å›¾è¿›è¡Œä¸€æ¬¡æµ‹é‡æ“ä½œã€‚</p><p>ç»§ç»­é˜…è¯»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java::performTraversals()]</span><br><span class="line"> <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">        viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//relayoutWindowæ¥è¯·æ±‚WMSè®¡ç®—Activityçª—å£çš„å¤§å°ä»¥åŠxxxInsetså¤§å°ï¼Œå¹¶ä¿å­˜åœ¨PendingxxxInsetsä¸­</span></span><br><span class="line">        relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (contentInsetsChanged) &#123;</span><br><span class="line">            mAttachInfo.mContentInsets.set(mPendingContentInsets);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (visibleInsetsChanged) &#123;</span><br><span class="line">            mAttachInfo.mVisibleInsets.set(mPendingVisibleInsets);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//å°†è®¡ç®—å¾—åˆ°çš„Activityçª—å£çš„å·¦ä¸Šè§’åæ ‡ä¿å­˜åœ¨å˜é‡attachInfoæ‰€æŒ‡å‘çš„ä¸€ä¸ªAttachInfoå¯¹è±¡çš„æˆå‘˜å˜é‡mWindowLeftå’ŒmWindowTop</span></span><br><span class="line">    mAttachInfo.mWindowLeft = frame.left;</span><br><span class="line">    mAttachInfo.mWindowTop = frame.top;</span><br><span class="line">    <span class="comment">//å°†è®¡ç®—å¾—åˆ°çš„Activityçª—å£çš„å®½åº¦å’Œé«˜åº¦ä¿å­˜åœ¨ViewRootImplç±»çš„æˆå‘˜å˜é‡mWidthå’ŒmHeightä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (mWidth != frame.width() || mHeight != frame.height()) &#123;</span><br><span class="line">        mWidth = frame.width();</span><br><span class="line">        mHeight = frame.height();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸»è¦è°ƒç”¨relayoutWindow()æ¥è¯·æ±‚WMSè®¡ç®—Activityçª—å£çš„å¤§å°ä»¥åŠè¾¹å¿–xxxInsetså¤§å°ã€‚è®¡ç®—å®Œæ¯•ä¹‹åï¼Œåˆ†åˆ«ä¿å­˜åœ¨mPendingXXXInsetsä¸­ã€‚</p><p>ç»§ç»­é˜…è¯»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java::performTraversals()]</span><br><span class="line"> <span class="keyword">if</span> (!mStopped || mReportNextDraw) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</span><br><span class="line">                    (relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</span><br><span class="line">                    || mHeight != host.getMeasuredHeight() || contentInsetsChanged ||</span><br><span class="line">                    updatedConfiguration) &#123;</span><br><span class="line">                <span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</span><br><span class="line">                <span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</span><br><span class="line">                ......</span><br><span class="line">                 <span class="comment">// Ask host how big it wants to be</span></span><br><span class="line">                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">int</span> width = host.getMeasuredWidth();</span><br><span class="line">                <span class="keyword">int</span> height = host.getMeasuredHeight();</span><br><span class="line">                <span class="keyword">boolean</span> measureAgain = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (lp.horizontalWeight &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">                    width += (<span class="keyword">int</span>) ((mWidth - width) * lp.horizontalWeight);</span><br><span class="line">                    childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width,</span><br><span class="line">                            MeasureSpec.EXACTLY);</span><br><span class="line">                    measureAgain = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (lp.verticalWeight &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">                    height += (<span class="keyword">int</span>) ((mHeight - height) * lp.verticalWeight);</span><br><span class="line">                    childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height,</span><br><span class="line">                            MeasureSpec.EXACTLY);</span><br><span class="line">                    measureAgain = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (measureAgain) &#123;</span><br><span class="line">                    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                layoutRequested = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨æ¥æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æµ‹é‡Activityçª—å£çš„å¤§å°ã€‚</p><p>ç»è¿‡å‰é¢æ¼«é•¿çš„æ“ä½œåï¼ŒActivityçª—å£çš„å¤§å°æµ‹é‡å·¥ä½œç»ˆäºå°˜åŸƒè½å®šï¼Œè¿™æ—¶å€™å°±å¯ä»¥å¯¹Activityçª—å£çš„å†…å®¹è¿›è¡Œå¸ƒå±€ performLayout(lp, mWidth, mHeight)å’Œè¿›è¡Œç»˜ç”»äº†ï¼ŒperformDraw()ï¼Œç”±äºä¸»è¦å…³æ³¨Activityçª—å£å¤§å°è®¡ç®—è¿‡ç¨‹ï¼Œåœ¨æ­¤ä¸åšç»§ç»­åˆ†æã€‚</p><h3 id="2-2-2ã€ViewRootImpl-relayoutWindow"><a href="#2-2-2ã€ViewRootImpl-relayoutWindow" class="headerlink" title="2.2.2ã€ViewRootImpl.relayoutWindow()"></a>2.2.2ã€ViewRootImpl.relayoutWindow()</h3><p>é€šè¿‡è°ƒç”¨è¿™ä¸ªSessionå¯¹è±¡çš„æˆå‘˜å‡½æ•°relayout()æ¥è¯·æ±‚WindowManagerServiceæœåŠ¡è®¡ç®—Activityçª—å£çš„å¤§å°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(WindowManager.LayoutParams params, <span class="keyword">int</span> viewVisibility,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> insetsPending)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">int</span> relayoutResult = mWindowSession.relayout(</span><br><span class="line">            mWindow, mSeq, params,</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredWidth() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredHeight() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            viewVisibility, insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="number">0</span>,</span><br><span class="line">            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</span><br><span class="line">            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingConfiguration,</span><br><span class="line">            mSurface);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> relayoutResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š 1ã€mWindow ç”¨æ¥æ ‡å¿—è¦è®¡ç®—çš„æ˜¯å“ªä¸€ä¸ªActivityçª—å£çš„å¤§å°p 2ã€Activityçª—å£çš„é¡¶å±‚è§†å›¾ç»è¿‡æµ‹é‡åå¾—åˆ°çš„å®½åº¦å’Œé«˜åº¦ 3ã€Activityçª—å£çš„å¯è§çŠ¶æ€ï¼Œå³viewVisibility 4ã€Activityçª—å£æ˜¯å¦æœ‰é¢å¤–çš„å†…å®¹åŒºåŸŸè¾¹è¡¬å’Œå¯è§åŒºåŸŸè¾¹è¡¬ç­‰å¾…å‘Šè¯‰ç»™WindowManagerServiceæœåŠ¡ï¼Œå³å‚æ•°insetsPending 5ã€mWinFrameï¼Œè¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥ä¿å­˜WindowManagerServiceæœåŠ¡è®¡ç®—åå¾—åˆ°çš„Activityçª—å£çš„å¤§å° 6ã€mPendingOverscanInsetsç”¨æ¥ä¿å­˜Overscanè¾¹è¡¬ï¼ŒmPendingContentInsetsç”¨æ¥ä¿å­˜å†…å®¹åŒºåŸŸè¾¹è¡¬ï¼ŒmPendingVisibleInsetsç”¨æ¥ä¿å­˜å¯è§åŒºåŸŸè¾¹è¡¬ï¼ŒmPendingStableInsetsç”¨æ¥ä¿å­˜å¯èƒ½è¢«ç³»ç»ŸUIå…ƒç´ éƒ¨åˆ†æˆ–å®Œå…¨é®è”½çš„å…¨å±çª—å£åŒºåŸŸ 7ã€mPendingConfigurationï¼Œè¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥ä¿å­˜WindowManagerServiceæœåŠ¡è¿”å›æ¥çš„Activityçª—å£çš„é…ç½®ä¿¡æ¯ 8ã€mSurfaceï¼Œè¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥ä¿å­˜WindowManagerServiceæœåŠ¡è¿”å›æ¥çš„Activityçª—å£çš„ç»˜å›¾è¡¨é¢</p><h3 id="2-2-3ã€Session-relayout"><a href="#2-2-3ã€Session-relayout" class="headerlink" title="2.2.3ã€Session.relayout()"></a>2.2.3ã€Session.relayout()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Session.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = mService.relayoutWindow(<span class="keyword">this</span>, window, seq, attrs,</span><br><span class="line">            requestedWidth, requestedHeight, viewFlags, flags,</span><br><span class="line">            outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</span><br><span class="line">            outStableInsets, outsets, outBackdropFrame, outConfig, outSurface);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªæ˜¯è°ƒç”¨äº†WindowManagerServiceç±»çš„æˆå‘˜å‡½æ•°relayoutWindowæ¥è¿›ä¸€æ­¥è®¡ç®—å‚æ•°windowæ‰€æè¿°çš„ä¸€ä¸ªActivityçª—å“çš„å¤§å°</p><h3 id="2-2-4ã€WindowManagerService-relayoutWindow"><a href="#2-2-4ã€WindowManagerService-relayoutWindow" class="headerlink" title="2.2.4ã€WindowManagerService.relayoutWindow()"></a>2.2.4ã€WindowManagerService.relayoutWindow()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        WindowState win = windowForClientLocked(session, client, <span class="keyword">false</span>);</span><br><span class="line">        WindowStateAnimator winAnimator = win.mWinAnimator;</span><br><span class="line">        <span class="keyword">if</span> (viewVisibility != View.GONE) &#123;</span><br><span class="line">            win.setRequestedSize(requestedWidth, requestedHeight);</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">        <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPolicy.adjustWindowParamsLw(attrs);</span><br><span class="line">                ......</span><br><span class="line">        &#125;</span><br><span class="line">        win.setWindowScale(win.mRequestedWidth, win.mRequestedHeight);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (viewVisibility == View.VISIBLE &amp;&amp;</span><br><span class="line">                (win.mAppToken == <span class="keyword">null</span> || !win.mAppToken.clientHidden)) &#123;</span><br><span class="line">            result = relayoutVisibleWindow(outConfig, result, win, winAnimator, attrChanges,</span><br><span class="line">                    oldVisibility);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = createSurfaceControl(outSurface, result, win, winAnimator);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">            win.adjustStartingWindowFlags();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        mWindowPlacerLocked.performSurfacePlacement();</span><br><span class="line">        ......</span><br><span class="line">        outFrame.set(win.mCompatFrame);</span><br><span class="line">        outOverscanInsets.set(win.mOverscanInsets);</span><br><span class="line">        outContentInsets.set(win.mContentInsets);</span><br><span class="line">        outVisibleInsets.set(win.mVisibleInsets);</span><br><span class="line">        outStableInsets.set(win.mStableInsets);</span><br><span class="line">        outOutsets.set(win.mOutsets);</span><br><span class="line">        outBackdropFrame.set(win.getBackdropFrame(win.mFrame));</span><br><span class="line">        ......</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªå…³æ³¨relayoutWindowä¸­ä¸çª—å£å¤§å°è®¡ç®—æœ‰å…³çš„é€»è¾‘ï¼Œè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š 1ã€å‚æ•°requestedWidthå’ŒrequestedHeightæè¿°çš„æ˜¯åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚è®¾ç½®Activityçª—å£ä¸­çš„å®½åº¦å’Œé«˜åº¦ï¼Œå®ƒä»¬ä¼šè¢«è®°å½•åœ¨WindowStateå¯¹è±¡winçš„æˆå‘˜å˜é‡mRequestedWidthå’ŒmRequestedHeightä¸­ 2ã€WindowStateå¯¹è±¡winçš„æˆå‘˜å˜é‡mAttrsï¼Œå®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªWindowManager.LayoutParamså¯¹è±¡ï¼Œç”¨æ¥æè¿°Activityçª—å£çš„å¸ƒå±€å‚æ•° 3ã€è°ƒç”¨WindowSurfacePlacer.performSurfacePlacement()æ¥è®¡ç®—Activityçª—å£çš„å¤§å°ã€‚è®¡ç®—å®Œæˆä¹‹åï¼Œå‚æ•°clientæ‰€æè¿°çš„Activityçª—å£çš„å¤§å°ã€å†…å®¹åŒºåŸŸè¾¹è¡¬å¤§å°å’Œå¯è§åŒºåŸŸè¾¹è¾¹è¡¬å¤§å°å°±ä¼šåˆ†åˆ«ä¿å­˜åœ¨WindowStateå¯¹è±¡winçš„æˆå‘˜å˜é‡mCompatFrameã€mOverscanInsetsã€mContentInsetsã€mVisibleInsetsã€mStableInsetsã€mOutsetsä¸­ 4ã€ å°†WindowStateå¯¹è±¡winçš„æˆå‘˜å˜é‡mCompatFrameã€mOverscanInsetsã€mContentInsetsã€mVisibleInsetsã€mStableInsetsã€mOutsetsæ‹·è´èµ‹å€¼å¯¹åº”å˜é‡ä¸­ï¼Œä»¥ä¾¿å¯ä»¥è¿”å›ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹</p><p>ç»è¿‡ä¸Šè¿°4ä¸ªæ“ä½œåï¼ŒActivityçª—å£çš„å¤§å°è®¡ç®—è¿‡ç¨‹å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åˆ†æWindowSurfacePlacer.performSurfacePlacement()çš„å®ç°ï¼Œä»¥ä¾¿å¯ä»¥è¯¦ç»†äº†è§£Activityçª—å£çš„å¤§å°è®¡ç®—è¿‡ç¨‹</p><h3 id="2-2-5ã€WindowSurfacePlacer-performSurfacePlacement"><a href="#2-2-5ã€WindowSurfacePlacer-performSurfacePlacement" class="headerlink" title="2.2.5ã€WindowSurfacePlacer.performSurfacePlacement()"></a>2.2.5ã€WindowSurfacePlacer.performSurfacePlacement()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performSurfacePlacement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDeferDepth &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> loopCount = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">        performSurfacePlacementLoop();</span><br><span class="line">        mService.mH.removeMessages(DO_TRAVERSAL);</span><br><span class="line">        loopCount--;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mTraversalScheduled &amp;&amp; loopCount &gt; <span class="number">0</span>);</span><br><span class="line">    mWallpaperActionPending = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-6-WindowSurfacePlacer-performSurfacePlacementLoop"><a href="#2-2-6-WindowSurfacePlacer-performSurfacePlacementLoop" class="headerlink" title="2.2.6.WindowSurfacePlacer.performSurfacePlacementLoop()"></a>2.2.6.WindowSurfacePlacer.performSurfacePlacementLoop()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performSurfacePlacementLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       mInLayout = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">boolean</span> recoveringMemory = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mService.mForceRemoves.isEmpty()) &#123;</span><br><span class="line">            recoveringMemory = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (!mService.mForceRemoves.isEmpty()) &#123;</span><br><span class="line">                WindowState ws = mService.mForceRemoves.remove(<span class="number">0</span>);</span><br><span class="line">                mService.removeWindowInnerLocked(ws);</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        performSurfacePlacementInner(recoveringMemory);</span><br><span class="line"></span><br><span class="line">        mInLayout = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mService.needsLayout()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (++mLayoutRepeatCount &lt; <span class="number">6</span>) &#123;</span><br><span class="line">                requestTraversal();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Performed 6 layouts in a row. Skipping"</span>);</span><br><span class="line">                mLayoutRepeatCount = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mLayoutRepeatCount = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mService.mWindowsChanged &amp;&amp; !mService.mWindowChangeListeners.isEmpty()) &#123;</span><br><span class="line">            mService.mH.removeMessages(REPORT_WINDOWS_CHANGE);</span><br><span class="line">            mService.mH.sendEmptyMessage(REPORT_WINDOWS_CHANGE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        mInLayout = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨æˆå‘˜å‡½æ•°performSurfacePlacementInner()åˆ·æ–°ç³»ç»ŸUIçš„å‰å 1ã€æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨å¼ºåˆ¶åˆ é™¤çš„çª—å£ 2ã€æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦æœ‰çª—å£éœ€è¦ç§»é™¤</p><h3 id="2-2-7ã€WindowSurfacePlacer-performSurfacePlacementInner"><a href="#2-2-7ã€WindowSurfacePlacer-performSurfacePlacementInner" class="headerlink" title="2.2.7ã€WindowSurfacePlacer.performSurfacePlacementInner()"></a>2.2.7ã€WindowSurfacePlacer.performSurfacePlacementInner()</h3><p>ç»§ç»­åˆ†æçš„performSurfacePlacementInner()å®ç°ï¼Œä»¥ä¾¿å¯ä»¥äº†è§£Activityçª—å£çš„å¤§å°è®¡ç®—è¿‡ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performSurfacePlacementInner</span><span class="params">(<span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_WINDOW_TRACE) Slog.v(TAG, <span class="string">"performSurfacePlacementInner: entry. Called by "</span></span><br><span class="line">            + Debug.getCallers(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayContent defaultDisplay = mService.getDefaultDisplayContentLocked();</span><br><span class="line">    <span class="keyword">final</span> DisplayInfo defaultInfo = defaultDisplay.getDisplayInfo();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> defaultDw = defaultInfo.logicalWidth;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> defaultDh = defaultInfo.logicalHeight;</span><br><span class="line">    SurfaceControl.openTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        applySurfaceChangesTransaction(recoveringMemory, numDisplays, defaultDw, defaultDh);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Unhandled exception in Window Manager"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SurfaceControl.closeTransaction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> WindowList defaultWindows = defaultDisplay.getWindowList();</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mService.mPendingRemove.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mService.mPendingRemoveTmp.length &lt; N) &#123;</span><br><span class="line">                mService.mPendingRemoveTmp = <span class="keyword">new</span> WindowState[N+<span class="number">10</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            mService.mPendingRemove.toArray(mService.mPendingRemoveTmp);</span><br><span class="line">            mService.mPendingRemove.clear();</span><br><span class="line">            DisplayContentList displayList = <span class="keyword">new</span> DisplayContentList();</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                WindowState w = mService.mPendingRemoveTmp[i];</span><br><span class="line">                mService.removeWindowInnerLocked(w);</span><br><span class="line">                <span class="keyword">final</span> DisplayContent displayContent = w.getDisplayContent();</span><br><span class="line">                <span class="keyword">if</span> (displayContent != <span class="keyword">null</span> &amp;&amp; !displayList.contains(displayContent)) &#123;</span><br><span class="line">                    displayList.add(displayContent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (DisplayContent displayContent : displayList) &#123;</span><br><span class="line">                mService.mLayersController.assignLayersLocked(displayContent.getWindowList());</span><br><span class="line">                displayContent.layoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        mService.scheduleAnimationLocked();</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿›ä¸€æ­¥è°ƒç”¨applySurfaceChangesTransaction()æ–¹æ³•è¿›è¡Œè¿›ä¸€æ­¥è®¡ç®—</p><h3 id="2-2-8ã€WindowSurfacePlacer-applySurfaceChangesTransaction"><a href="#2-2-8ã€WindowSurfacePlacer-applySurfaceChangesTransaction" class="headerlink" title="2.2.8ã€WindowSurfacePlacer.applySurfaceChangesTransaction()"></a>2.2.8ã€WindowSurfacePlacer.applySurfaceChangesTransaction()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applySurfaceChangesTransaction</span><span class="params">(<span class="keyword">boolean</span> recoveringMemory, <span class="keyword">int</span> numDisplays,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> defaultDw, <span class="keyword">int</span> defaultDh)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">boolean</span> focusDisplayed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = <span class="number">0</span>; displayNdx &lt; numDisplays; ++displayNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> DisplayContent displayContent = mService.mDisplayContents.valueAt(displayNdx);</span><br><span class="line">        <span class="keyword">boolean</span> updateAllDrawn = <span class="keyword">false</span>;</span><br><span class="line">        WindowList windows = displayContent.getWindowList();</span><br><span class="line">        DisplayInfo displayInfo = displayContent.getDisplayInfo();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> displayId = displayContent.getDisplayId();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dw = displayInfo.logicalWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dh = displayInfo.logicalHeight;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> innerDw = displayInfo.appWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> innerDh = displayInfo.appHeight;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isDefaultDisplay = (displayId == Display.DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset for each display.</span></span><br><span class="line">        mDisplayHasContent = <span class="keyword">false</span>;</span><br><span class="line">        mPreferredRefreshRate = <span class="number">0</span>;</span><br><span class="line">        mPreferredModeId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> repeats = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            repeats++;</span><br><span class="line">            <span class="keyword">if</span> (repeats &gt; <span class="number">6</span>) &#123;<span class="comment">//æœ€å¤šæ‰§è¡Œ7æ¬¡çš„whileå¾ªç¯</span></span><br><span class="line">                displayContent.layoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é€šçŸ¥SurfaceFlingeræœåŠ¡äº†ï¼Œä¹Ÿå°±æ˜¯è®©SurfaceFlingeræœåŠ¡æ›´æ–°å®ƒé‡Œé¢çš„å„ä¸ªLayerçš„å±æ€§å€¼ï¼Œä»¥ä¾¿å¯ä»¥å¯¹è¿™äº›Layeræ‰§è¡Œå¯è§æ€§è®¡ç®—ã€åˆæˆç­‰æ“ä½œï¼Œæœ€åæ¸²æŸ“åˆ°ç¡¬ä»¶å¸§ç¼“å†²åŒºä¸­å»</span></span><br><span class="line">            <span class="keyword">if</span> ((displayContent.pendingLayoutChanges &amp; FINISH_LAYOUT_REDO_WALLPAPER) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    mWallpaperControllerLocked.adjustWallpaperWindows()) &#123;</span><br><span class="line">                mService.mLayersController.assignLayersLocked(windows);</span><br><span class="line">                displayContent.layoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">           ......</span><br><span class="line">            <span class="keyword">if</span> ((displayContent.pendingLayoutChanges &amp; FINISH_LAYOUT_REDO_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">                displayContent.layoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// FIRST LOOP: Perform a layout, if needed.</span></span><br><span class="line">            <span class="comment">//è®¡ç®—å„ä¸ªçª—å“çš„å¤§å°</span></span><br><span class="line">            <span class="keyword">if</span> (repeats &lt; LAYOUT_REPEAT_THRESHOLD) &#123;</span><br><span class="line">                performLayoutLockedInner(displayContent, repeats == <span class="number">1</span>,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* updateInputWindows */</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// FIRST AND ONE HALF LOOP: Make WindowManagerPolicy think</span></span><br><span class="line">            <span class="comment">// it is animating.</span></span><br><span class="line">            displayContent.pendingLayoutChanges = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">                mService.mPolicy.beginPostLayoutPolicyLw(dw, dh);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = windows.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                    WindowState w = windows.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (w.mHasSurface) &#123;</span><br><span class="line">                        mService.mPolicy.applyPostLayoutPolicyLw(w, w.mAttrs,</span><br><span class="line">                                w.mAttachedWindow);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                displayContent.pendingLayoutChanges |=</span><br><span class="line">                        mService.mPolicy.finishPostLayoutPolicyLw();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (displayContent.pendingLayoutChanges != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-9ã€WindowSurfacePlacer-applySurfaceChangesTransaction"><a href="#2-2-9ã€WindowSurfacePlacer-applySurfaceChangesTransaction" class="headerlink" title="2.2.9ã€WindowSurfacePlacer.applySurfaceChangesTransaction()"></a>2.2.9ã€WindowSurfacePlacer.applySurfaceChangesTransaction()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performLayoutLockedInner</span><span class="params">(<span class="keyword">final</span> DisplayContent displayContent,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> initial, <span class="keyword">boolean</span> updateInputWindows)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    displayContent.layoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">    WindowList windows = displayContent.getWindowList();</span><br><span class="line">    <span class="keyword">boolean</span> isDefaultDisplay = displayContent.isDefaultDisplay;</span><br><span class="line"></span><br><span class="line">    DisplayInfo displayInfo = displayContent.getDisplayInfo();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> dw = displayInfo.logicalWidth;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> dh = displayInfo.logicalHeight;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = windows.size();</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    mService.mPolicy.beginLayoutLw(isDefaultDisplay, dw, dh, mService.mRotation,</span><br><span class="line">            mService.mCurConfiguration.uiMode);</span><br><span class="line">    ......</span><br><span class="line">    displayContent.resize(mTmpContentRect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> seq = mService.mLayoutSeq+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (seq &lt; <span class="number">0</span>) seq = <span class="number">0</span>;</span><br><span class="line">    mService.mLayoutSeq = seq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> behindDream = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> topAttached = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = N-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState win = windows.get(i);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> gone = (behindDream &amp;&amp; mService.mPolicy.canBeForceHidden(win, win.mAttrs))</span><br><span class="line">                || win.isGoneForLayoutLw();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (!gone || !win.mHaveFrame || win.mLayoutNeeded</span><br><span class="line">                || ((win.isConfigChanged() || win.setReportResizeHints())</span><br><span class="line">                        &amp;&amp; !win.isGoneForLayoutLw() &amp;&amp;</span><br><span class="line">                        ((win.mAttrs.privateFlags &amp; PRIVATE_FLAG_KEYGUARD) != <span class="number">0</span> ||</span><br><span class="line">                        (win.mHasSurface &amp;&amp; win.mAppToken != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        win.mAppToken.layoutConfigChanges)))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!win.mLayoutAttached) &#123;</span><br><span class="line">                ......</span><br><span class="line">                win.mLayoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">                win.prelayout();</span><br><span class="line">                mService.mPolicy.layoutWindowLw(win, <span class="keyword">null</span>);</span><br><span class="line">                win.mLayoutSeq = seq;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Window frames may have changed. Update dim layer with the new bounds.</span></span><br><span class="line">                <span class="keyword">final</span> Task task = win.getTask();</span><br><span class="line">                <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    displayContent.mDimLayerController.updateDimLayer(task);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> attachedBehindDream = <span class="keyword">false</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (i = topAttached; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState win = windows.get(i);</span><br><span class="line">        <span class="keyword">if</span> (win.mLayoutAttached) &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> ((win.mViewVisibility != View.GONE &amp;&amp; win.mRelayoutCalled)</span><br><span class="line">                    || !win.mHaveFrame || win.mLayoutNeeded) &#123;</span><br><span class="line">                ......</span><br><span class="line">                win.mLayoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">                win.prelayout();</span><br><span class="line">                mService.mPolicy.layoutWindowLw(win, win.mAttachedWindow);</span><br><span class="line">                win.mLayoutSeq = seq;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (win.mAttrs.type == TYPE_DREAM) &#123;</span><br><span class="line">            attachedBehindDream = behindDream;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Window frames may have changed. Tell the input dispatcher about it.</span></span><br><span class="line">    mService.mInputMonitor.setUpdateInputWindowsNeededLw();</span><br><span class="line">    <span class="keyword">if</span> (updateInputWindows) &#123;</span><br><span class="line">        mService.mInputMonitor.updateInputWindowsLw(<span class="keyword">false</span> <span class="comment">/*force*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.mPolicy.finishLayoutLw();</span><br><span class="line">    mService.mH.sendEmptyMessage(UPDATE_DOCKED_STACK_DIVIDER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€mPolicyæŒ‡å‘çš„æ˜¯ä¸€ä¸ªçª—å£ç®¡ç†ç­–ç•¥ç±»ï¼Œå³PhoneWindowManagerå¯¹è±¡ï¼Œä¸»è¦æ˜¯ç”¨æ¥åˆ¶å®šçª—å£çš„å¤§å°è®¡ç®—ç­–ç•¥ 2ã€å‡†å¤‡é˜¶æ®µï¼šè°ƒç”¨PhoneWindowManager.beginLayoutLw()æ¥è®¾ç½®å±å¹•çš„å¤§å°ã€‚åŒ…æ‹¬NavigationBarã€StatusBarå¤§å°è®¡ç®— 3ã€è®¡ç®—é˜¶æ®µï¼šè°ƒç”¨PhoneWindowManager.layoutWindowLw()æ¥è®¡ç®—å„ä¸ªçª—å£çš„å¤§å°ã€å†…å®¹åŒºåŸŸè¾¹è¡¬å¤§å°ä»¥åŠå¯è§åŒºåŸŸè¾¹è¡¬å¤§å°ã€‚ 4ã€ç»“æŸé˜¶æ®µï¼šè°ƒç”¨PhoneWindowManagerç±»çš„æˆå‘˜å‡½æ•°finishLayoutLw()æ¥æ‰§è¡Œä¸€äº›æ¸…ç†å·¥ä½œã€‚</p><h3 id="2-2-10ã€PhoneWindowManager-beginLayoutLw"><a href="#2-2-10ã€PhoneWindowManager-beginLayoutLw" class="headerlink" title="2.2.10ã€PhoneWindowManager.beginLayoutLw()"></a>2.2.10ã€PhoneWindowManager.beginLayoutLw()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;PhoneWindowManager.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginLayoutLw</span><span class="params">(<span class="keyword">boolean</span> isDefaultDisplay, <span class="keyword">int</span> displayWidth, <span class="keyword">int</span> displayHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> displayRotation, <span class="keyword">int</span> uiMode)</span> </span>&#123;</span><br><span class="line">    mDisplayRotation = displayRotation;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> overscanLeft, overscanTop, overscanRight, overscanBottom;</span><br><span class="line">    <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (displayRotation) &#123;</span><br><span class="line">            <span class="keyword">case</span> Surface.ROTATION_90:</span><br><span class="line">                overscanLeft = mOverscanTop;</span><br><span class="line">                overscanTop = mOverscanRight;</span><br><span class="line">                overscanRight = mOverscanBottom;</span><br><span class="line">                overscanBottom = mOverscanLeft;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        overscanLeft = <span class="number">0</span>;</span><br><span class="line">        overscanTop = <span class="number">0</span>;</span><br><span class="line">        overscanRight = <span class="number">0</span>;</span><br><span class="line">        overscanBottom = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mOverscanScreenLeft = mRestrictedOverscanScreenLeft = <span class="number">0</span>;</span><br><span class="line">    mOverscanScreenTop = mRestrictedOverscanScreenTop = <span class="number">0</span>;</span><br><span class="line">    mOverscanScreenWidth = mRestrictedOverscanScreenWidth = displayWidth;</span><br><span class="line">    mOverscanScreenHeight = mRestrictedOverscanScreenHeight = displayHeight;</span><br><span class="line">    mSystemLeft = <span class="number">0</span>;</span><br><span class="line">    mSystemTop = <span class="number">0</span>;</span><br><span class="line">    mSystemRight = displayWidth;</span><br><span class="line">    mSystemBottom = displayHeight;</span><br><span class="line">    mUnrestrictedScreenLeft = overscanLeft;</span><br><span class="line">    mUnrestrictedScreenTop = overscanTop;</span><br><span class="line">    mUnrestrictedScreenWidth = displayWidth - overscanLeft - overscanRight;</span><br><span class="line">    mUnrestrictedScreenHeight = displayHeight - overscanTop - overscanBottom;</span><br><span class="line">    mRestrictedScreenLeft = mUnrestrictedScreenLeft;</span><br><span class="line">    mRestrictedScreenTop = mUnrestrictedScreenTop;</span><br><span class="line">    mRestrictedScreenWidth = mSystemGestures.screenWidth = mUnrestrictedScreenWidth;</span><br><span class="line">    mRestrictedScreenHeight = mSystemGestures.screenHeight = mUnrestrictedScreenHeight;</span><br><span class="line">    mDockLeft = mContentLeft = mVoiceContentLeft = mStableLeft = mStableFullscreenLeft</span><br><span class="line">            = mCurLeft = mUnrestrictedScreenLeft;</span><br><span class="line">    mDockTop = mContentTop = mVoiceContentTop = mStableTop = mStableFullscreenTop</span><br><span class="line">            = mCurTop = mUnrestrictedScreenTop;</span><br><span class="line">    mDockRight = mContentRight = mVoiceContentRight = mStableRight = mStableFullscreenRight</span><br><span class="line">            = mCurRight = displayWidth - overscanRight;</span><br><span class="line">    mDockBottom = mContentBottom = mVoiceContentBottom = mStableBottom = mStableFullscreenBottom</span><br><span class="line">            = mCurBottom = displayHeight - overscanBottom;</span><br><span class="line">    mDockLayer = <span class="number">0x10000000</span>;</span><br><span class="line">    mStatusBarLayer = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start with the current dock rect, which will be (0,0,displayWidth,displayHeight)</span></span><br><span class="line">    <span class="keyword">final</span> Rect pf = mTmpParentFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect df = mTmpDisplayFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect of = mTmpOverscanFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect vf = mTmpVisibleFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect dcf = mTmpDecorFrame;</span><br><span class="line">    pf.left = df.left = of.left = vf.left = mDockLeft;</span><br><span class="line">    pf.top = df.top = of.top = vf.top = mDockTop;</span><br><span class="line">    pf.right = df.right = of.right = vf.right = mDockRight;</span><br><span class="line">    pf.bottom = df.bottom = of.bottom = vf.bottom = mDockBottom;</span><br><span class="line">    dcf.setEmpty();  <span class="comment">// Decor frame N/A for system bars.</span></span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">        navVisible |= !canHideNavigationBar();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> updateSysUiVisibility = layoutNavigationBar(displayWidth, displayHeight,</span><br><span class="line">                displayRotation, uiMode, overscanLeft, overscanRight, overscanBottom, dcf, navVisible, navTranslucent,navAllowedHidden, statusBarExpandedNotKeyguard);</span><br><span class="line">        updateSysUiVisibility |= layoutStatusBar(pf, df, of, vf, dcf, sysui, isKeyguardShowing);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (updateSysUiVisibility) &#123;</span><br><span class="line">            updateSystemUiVisibilityLw();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€åˆå§‹åŒ–Overscanã€UnrestrictedScreenã€RestrictedScreenç­‰å±å¹•åŒºåŸŸå˜é‡ 2ã€è®¡ç®—NavigationBarå’ŒStatusBarå¤§å°</p><h3 id="2-2-11ã€PhoneWindowManager-layoutWindowLw"><a href="#2-2-11ã€PhoneWindowManager-layoutWindowLw" class="headerlink" title="2.2.11ã€PhoneWindowManager.layoutWindowLw()"></a>2.2.11ã€PhoneWindowManager.layoutWindowLw()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;PhoneWindowManager.java]</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layoutWindowLw</span><span class="params">(WindowState win, WindowState attached)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> fl = PolicyControl.getWindowFlags(win, attrs);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pfl = attrs.privateFlags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sim = attrs.softInputMode;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sysUiFl = PolicyControl.getSystemUiVisibility(win, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Rect pf = mTmpParentFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect df = mTmpDisplayFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect of = mTmpOverscanFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect cf = mTmpContentFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect vf = mTmpVisibleFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect dcf = mTmpDecorFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect sf = mTmpStableFrame;</span><br><span class="line">    Rect osf = <span class="keyword">null</span>;</span><br><span class="line">    dcf.setEmpty();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasNavBar = (isDefaultDisplay &amp;&amp; mHasNavigationBar</span><br><span class="line">            &amp;&amp; mNavigationBar != <span class="keyword">null</span> &amp;&amp; mNavigationBar.isVisibleLw());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> adjust = sim &amp; SOFT_INPUT_MASK_ADJUST;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">        sf.set(mStableLeft, mStableTop, mStableRight, mStableBottom);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sf.set(mOverscanLeft, mOverscanTop, mOverscanRight, mOverscanBottom);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isDefaultDisplay) &#123;</span><br><span class="line">        <span class="keyword">if</span> (attached != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If this window is attached to another, our display</span></span><br><span class="line">            <span class="comment">// frame is the same as the one we are attached to.</span></span><br><span class="line">            setAttachedWindowFrames(win, fl, adjust, attached, <span class="keyword">true</span>, pf, df, of, cf, vf);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Give the window full screen.</span></span><br><span class="line">            pf.left = df.left = of.left = cf.left = mOverscanScreenLeft;</span><br><span class="line">            pf.top = df.top = of.top = cf.top = mOverscanScreenTop;</span><br><span class="line">            pf.right = df.right = of.right = cf.right</span><br><span class="line">                    = mOverscanScreenLeft + mOverscanScreenWidth;</span><br><span class="line">            pf.bottom = df.bottom = of.bottom = cf.bottom</span><br><span class="line">                    = mOverscanScreenTop + mOverscanScreenHeight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; ......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    win.computeFrameLw(pf, df, of, cf, vf, dcf, sf, osf);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨WindowState.computeFrameLwæ¥è®¡ç®—çª—å£winçš„å…·ä½“å¤§å°äº†ã€‚è®¡ç®—çš„ç»“æœä¾¿å¾—åˆ°äº†çª—å£winçš„å¤§å°ï¼Œä»¥åŠå®ƒçš„å†…å®¹åŒºåŸŸè¾¹è¡¬å¤§å°å’Œå¯è§åŒºåŸŸè¾¹è¡¬å¤§å°ã€‚</p><h3 id="2-2-12ã€WindowState-computeFrameLw"><a href="#2-2-12ã€WindowState-computeFrameLw" class="headerlink" title="2.2.12ã€WindowState.computeFrameLw()"></a>2.2.12ã€WindowState.computeFrameLw()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowState.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeFrameLw</span><span class="params">(Rect pf, Rect df, Rect of, Rect cf, Rect vf, Rect dcf, Rect sf,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect osf)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> Task task = getTask();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> fullscreenTask = !isInMultiWindowMode();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> windowsAreFloating = task != <span class="keyword">null</span> &amp;&amp; task.isFloating();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> Rect layoutContainingFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect layoutDisplayFrame;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The offset from the layout containing frame to the actual containing frame.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> layoutXDiff;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> layoutYDiff;</span><br><span class="line">    <span class="keyword">if</span> (fullscreenTask || layoutInParentFrame()) &#123;</span><br><span class="line">        <span class="comment">// We use the parent frame as the containing frame for fullscreen and child windows</span></span><br><span class="line">        mContainingFrame.set(pf);</span><br><span class="line">        mDisplayFrame.set(df);</span><br><span class="line">        layoutDisplayFrame = df;</span><br><span class="line">        layoutContainingFrame = pf;</span><br><span class="line">        layoutXDiff = <span class="number">0</span>;</span><br><span class="line">        layoutYDiff = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        task.getBounds(mContainingFrame);</span><br><span class="line">        ......</span><br><span class="line">        mDisplayFrame.set(mContainingFrame);</span><br><span class="line">        layoutXDiff = !mInsetFrame.isEmpty() ? mInsetFrame.left - mContainingFrame.left : <span class="number">0</span>;</span><br><span class="line">        layoutYDiff = !mInsetFrame.isEmpty() ? mInsetFrame.top - mContainingFrame.top : <span class="number">0</span>;</span><br><span class="line">        layoutContainingFrame = !mInsetFrame.isEmpty() ? mInsetFrame : mContainingFrame;</span><br><span class="line">        mTmpRect.set(<span class="number">0</span>, <span class="number">0</span>, mDisplayContent.getDisplayInfo().logicalWidth,</span><br><span class="line">                mDisplayContent.getDisplayInfo().logicalHeight);</span><br><span class="line">        subtractInsets(mDisplayFrame, layoutContainingFrame, df, mTmpRect);</span><br><span class="line">        ......</span><br><span class="line">        layoutDisplayFrame = df;</span><br><span class="line">        layoutDisplayFrame.intersect(layoutContainingFrame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pw = mContainingFrame.width();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> ph = mContainingFrame.height();</span><br><span class="line">    ......</span><br><span class="line">    mOverscanFrame.set(of);</span><br><span class="line">    mContentFrame.set(cf);</span><br><span class="line">    mVisibleFrame.set(vf);</span><br><span class="line">    mDecorFrame.set(dcf);</span><br><span class="line">    mStableFrame.set(sf);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasOutsets = osf != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> fw = mFrame.width();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> fh = mFrame.height();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (windowsAreFloating &amp;&amp; !mFrame.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> height = Math.min(mFrame.height(), mContentFrame.height());</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> width = Math.min(mContentFrame.width(), mFrame.width());</span><br><span class="line">        <span class="keyword">final</span> DisplayMetrics displayMetrics = getDisplayContent().getDisplayMetrics();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> minVisibleHeight = Math.min(height, WindowManagerService.dipToPixel(</span><br><span class="line">                MINIMUM_VISIBLE_HEIGHT_IN_DP, displayMetrics));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> minVisibleWidth = Math.min(width, WindowManagerService.dipToPixel(</span><br><span class="line">                MINIMUM_VISIBLE_WIDTH_IN_DP, displayMetrics));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> top = Math.max(mContentFrame.top,</span><br><span class="line">                Math.min(mFrame.top, mContentFrame.bottom - minVisibleHeight));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> left = Math.max(mContentFrame.left + minVisibleWidth - width,</span><br><span class="line">                Math.min(mFrame.left, mContentFrame.right - minVisibleWidth));</span><br><span class="line">        mFrame.set(left, top, left + width, top + height);</span><br><span class="line">        mContentFrame.set(mFrame);</span><br><span class="line">        mVisibleFrame.set(mContentFrame);</span><br><span class="line">        mStableFrame.set(mContentFrame);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mAttrs.type == TYPE_DOCK_DIVIDER) &#123;</span><br><span class="line">        mDisplayContent.getDockedDividerController().positionDockedStackedDivider(mFrame);</span><br><span class="line">        mContentFrame.set(mFrame);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mContentFrame.set(......);</span><br><span class="line"></span><br><span class="line">        mVisibleFrame.set(......);</span><br><span class="line"></span><br><span class="line">        mStableFrame.set(......);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fullscreenTask &amp;&amp; !windowsAreFloating) &#123;</span><br><span class="line">        <span class="comment">// Windows that are not fullscreen can be positioned outside of the display frame,</span></span><br><span class="line">        mOverscanInsets.set(......);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAttrs.type == TYPE_DOCK_DIVIDER) &#123;</span><br><span class="line">        mStableInsets.set(......);</span><br><span class="line">        mContentInsets.setEmpty();</span><br><span class="line">        mVisibleInsets.setEmpty();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        getDisplayContent().getLogicalDisplayRect(mTmpRect);</span><br><span class="line">        <span class="keyword">boolean</span> overrideRightInset = !fullscreenTask &amp;&amp; mFrame.right &gt; mTmpRect.right;</span><br><span class="line">        <span class="keyword">boolean</span> overrideBottomInset = !fullscreenTask &amp;&amp; mFrame.bottom &gt; mTmpRect.bottom;</span><br><span class="line">        mContentInsets.set(......);</span><br><span class="line"></span><br><span class="line">        mVisibleInsets.set(......);</span><br><span class="line"></span><br><span class="line">        mStableInsets.set(......);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Offset the actual frame by the amount layout frame is off.</span></span><br><span class="line">    mFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">    mCompatFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">    mContentFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">    mVisibleFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">    mStableFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line"></span><br><span class="line">    mCompatFrame.set(mFrame);</span><br><span class="line">    <span class="keyword">if</span> (mEnforceSizeCompat) &#123;</span><br><span class="line">        mOverscanInsets.scale(mInvGlobalScale);</span><br><span class="line">        mContentInsets.scale(mInvGlobalScale);</span><br><span class="line">        mVisibleInsets.scale(mInvGlobalScale);</span><br><span class="line">        mStableInsets.scale(mInvGlobalScale);</span><br><span class="line">        mOutsets.scale(mInvGlobalScale);</span><br><span class="line">        mCompatFrame.scale(mInvGlobalScale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªçª—å£å¤§å°ä¿å­˜åœ¨WindowStateç±»çš„æˆå‘˜å˜é‡mFrameä¸­ï¼Œè€Œçª—å“çš„å†…å®¹åŒºåŸŸè¾¹è¡¬å¤§å°å’Œå¯è§åŒºåŸŸè¾¹è¡¬å¤§å°åˆ†åˆ«ä¿åœ¨WindowStateç±»çš„æˆå‘˜å˜é‡mContentInsetså’ŒmVisibleInsetsä¸­</p><h3 id="2-2-13ã€PhoneWindowManager-finishLayoutLw"><a href="#2-2-13ã€PhoneWindowManager-finishLayoutLw" class="headerlink" title="2.2.13ã€PhoneWindowManager.finishLayoutLw()"></a>2.2.13ã€PhoneWindowManager.finishLayoutLw()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[WindowState.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishLayoutLw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆä¸‰ï¼‰ã€Window-Z-Order-è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹"><a href="#ï¼ˆä¸‰ï¼‰ã€Window-Z-Order-è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Window Z-Order è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹"></a>ï¼ˆä¸‰ï¼‰ã€Window Z-Order è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹</h2><p>å£çš„UIæœ€ç»ˆæ˜¯éœ€è¦é€šè¿‡SurfaceFlingeræœåŠ¡æ¥ç»Ÿä¸€æ¸²æŸ“çš„ï¼Œè€ŒSurfaceFlingeræœåŠ¡åœ¨æ¸²æŸ“çª—å£çš„UIä¹‹å‰ï¼Œéœ€è¦è®¡ç®—åŸºäºå„ä¸ªçª—å£çš„Zè½´ä½ç½®æ¥è®¡ç®—å®ƒä»¬çš„å¯è§åŒºåŸŸã€‚å› æ­¤ï¼ŒWindowManagerServiceæœåŠ¡è®¡ç®—å¥½æ¯ä¸€ä¸ªçª—å£çš„Zè½´ä½ç½®ä¹‹åï¼Œè¿˜éœ€è¦å°†å®ƒä»¬è®¾ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»ï¼Œä»¥ä¾¿SurfaceFlingeræœåŠ¡å¯ä»¥æ­£ç¡®åœ°æ¸²æŸ“æ¯ä¸€ä¸ªçª—å£çš„UIã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/12-Android-WMS-Z-Order.png" alt="Markdown"></p><h3 id="3-1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯"><a href="#3-1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯" class="headerlink" title="3.1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯"></a>3.1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯</h3><p>åœ¨ã€Android 7.1.2 (Android N) Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹åˆ†æã€‘ä¸­å·²ç»è¯¦ç»†ä»‹ç»Windowæ·»åŠ è¿‡ç¨‹ï¼Œè¿™é‡Œç›´æ¥ä» WMS.addWindowå¼€å§‹åˆ†æã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> addToken = <span class="keyword">false</span>;</span><br><span class="line">        WindowToken token = mTokenMap.get(attrs.token);</span><br><span class="line">        AppWindowToken atoken = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> addToastWindowRequiresToken = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        WindowState win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,</span><br><span class="line">                attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (addToken) &#123;</span><br><span class="line">            mTokenMap.put(attrs.token, token);</span><br><span class="line">        &#125;</span><br><span class="line">        win.attach();</span><br><span class="line">        mWindowMap.put(client.asBinder(), win);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> imMayMove = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type == TYPE_INPUT_METHOD) &#123;</span><br><span class="line">            win.mGivenInsetsPending = <span class="keyword">true</span>;</span><br><span class="line">            mInputMethodWindow = win;</span><br><span class="line">            addInputMethodWindowToListLocked(win);</span><br><span class="line">            imMayMove = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TYPE_INPUT_METHOD_DIALOG) &#123;</span><br><span class="line">            mInputMethodDialogs.add(win);</span><br><span class="line">            addWindowToListInOrderLocked(win, <span class="keyword">true</span>);</span><br><span class="line">            moveInputMethodDialogsLocked(findDesiredInputMethodWindowIndexLocked(<span class="keyword">true</span>));</span><br><span class="line">            imMayMove = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addWindowToListInOrderLocked(win, <span class="keyword">true</span>);</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//é‡æ–°è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®</span></span><br><span class="line">        mLayersController.assignLayersLocked(displayContent.getWindowList());</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WMS.relayoutWindow()ä¹Ÿä¼šè°ƒç”¨WindowLayersController.assignLayersLocked()é‡æ–°è®¡ç®—ã€è°ƒæ•´ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®ï¼Œç”±äºåŸç†ç±»ä¼¼è¿™é‡Œä¸åšè§£é‡Šã€‚</p><h3 id="3-2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®"><a href="#3-2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®" class="headerlink" title="3.2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®"></a>3.2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡WindowStateç±»çš„æ„é€ å‡½æ•°æ¥åˆ†æä¸€ä¸ªçª—å£çš„BaseLayerå€¼æ˜¯å¦‚ä½•ç¡®å®š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[WindowState.java]</span><br><span class="line">WindowState(WindowManagerService service, Session s, IWindow c, WindowToken token,</span><br><span class="line">       WindowState attachedWindow, <span class="keyword">int</span> appOp, <span class="keyword">int</span> seq, WindowManager.LayoutParams a,</span><br><span class="line">       <span class="keyword">int</span> viewVisibility, <span class="keyword">final</span> DisplayContent displayContent) &#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((mAttrs.type &gt;= FIRST_SUB_WINDOW &amp;&amp;</span><br><span class="line">            mAttrs.type &lt;= LAST_SUB_WINDOW)) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//windowTypeToLayerLwçš„è¿”å›å€¼å¹¶ä¸”ä¸æ˜¯ä¸€ä¸ªçª—å£çš„æœ€ç»ˆçš„BaseLayerå€¼ï¼Œè€Œæ˜¯è¦å°†å®ƒçš„è¿”å›å€¼ä¹˜ä»¥ä¸€ä¸ªå¸¸é‡TYPE_LAYER_MULTIPLIERï¼Œå†åŠ ä¸Šå¦å¤–ä¸€ä¸ªå¸¸é‡TYPE_LAYER_OFFSETä¹‹åï¼Œæ‰å¾—åˆ°æœ€ç»ˆçš„BaseLayerå€¼</span></span><br><span class="line">        mBaseLayer = mPolicy.windowTypeToLayerLw(</span><br><span class="line">                attachedWindow.mAttrs.type) * WindowManagerService.TYPE_LAYER_MULTIPLIER</span><br><span class="line">                + WindowManagerService.TYPE_LAYER_OFFSET;</span><br><span class="line">        mSubLayer = mPolicy.subWindowTypeToLayerLw(a.type);</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªçª—å£é™¤äº†æœ‰ä¸€ä¸ªBaseLayerå€¼ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªSubLayerå€¼ï¼Œåˆ†åˆ«ä¿å­˜åœ¨ä¸€ä¸ªå¯¹åº”çš„WindowStateå¯¹è±¡çš„æˆå‘˜å˜é‡mBaseLayerå’ŒmSubLayerã€‚SubLayerå€¼æ˜¯ç”¨æ¥æè¿°ä¸€ä¸ªçª—å£æ˜¯å¦æ˜¯å¦å¤–ä¸€ä¸ªçª—å£çš„å­çª—å£çš„ã€‚ åœ¨ç»§ç»­åˆ†æWindowLayersController.assignLayersLocked()ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æPhoneWindowManager.windowTypeToLayerLw()å’ŒsubWindowTypeToLayerLw()çš„å®ç°ï¼Œä»¥ä¾¿å¯ä»¥äº†è§£ä¸€ä¸ªçª—å£çš„BaseLayerå€¼å’ŒSubLayerå€¼æ˜¯å¦‚ä½•ç¡®å®šçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;PhoneWindowManager.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">windowTypeToLayerLw</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (type &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; type &lt;= LAST_APPLICATION_WINDOW) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">   ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_SYSTEM_DIALOG:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_TOAST:</span><br><span class="line">        <span class="comment">// toasts and the plugged-in battery thing</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">   ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_SYSTEM_ALERT:</span><br><span class="line">        <span class="comment">// like the ANR / app crashed dialogs</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_STATUS_BAR_SUB_PANEL:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_STATUS_BAR:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_STATUS_BAR_PANEL:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">17</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_KEYGUARD_DIALOG:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">18</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_NAVIGATION_BAR:</span><br><span class="line">        <span class="comment">// the navigation bar, if available, shows atop most things</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">21</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_NAVIGATION_BAR_PANEL:</span><br><span class="line">        <span class="comment">// some panels (e.g. search) need to show on top of the navigation bar</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">22</span>;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** &#123;<span class="doctag">@inheritDoc</span>&#125; */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">subWindowTypeToLayerLw</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> TYPE_APPLICATION_PANEL:</span><br><span class="line">    <span class="keyword">case</span> TYPE_APPLICATION_ATTACHED_DIALOG:</span><br><span class="line">        <span class="keyword">return</span> APPLICATION_PANEL_SUBLAYER;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_APPLICATION_ABOVE_SUB_PANEL:</span><br><span class="line">        <span class="keyword">return</span> APPLICATION_ABOVE_SUB_PANEL_SUBLAYER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ ¹æ®ä¸åŒçš„Window Typeè¿”å›ä¸ä¸€æ ·çš„æ•°å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_LAYER_MULTIPLIER = <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_LAYER_OFFSET = <span class="number">1000</span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç”¨adb shell dumpsys window -a å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹Layerçš„æ•°å€¼ï¼Œå¯ä»¥çœ‹åˆ°StatusBarçš„æ•°å€¼è®¡ç®—ï¼š mBaseLayer = 16 _WindowManagerService.TYPE_LAYER_MULTIPLIER+ WindowManagerService.TYPE_LAYER<em>OFFSET StatusBar.mBaseLayer = 16</em> 10000 + 1000 = 161000 ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Window #4 Window&#123;3c1f1fb u0 StatusBar&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">161000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">161000</span>+<span class="number">0</span>=<span class="number">161000</span> mLastLayer=<span class="number">161000</span></span><br><span class="line">Window #3 Window&#123;fe4aae2 u0 KeyguardScrim&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">141000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">141000</span>+<span class="number">0</span>=<span class="number">141000</span> mLastLayer=<span class="number">141000</span></span><br><span class="line">Window #2 Window&#123;173ee76 u0 DockedStackDivider&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">21000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">21010</span>+<span class="number">0</span>=<span class="number">21010</span> mLastLayer=<span class="number">0</span></span><br><span class="line">Window #1 Window&#123;3a83a4a u0 com.android.launcher&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">21000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">21005</span>+<span class="number">0</span>=<span class="number">21005</span> mLastLayer=<span class="number">21005</span></span><br><span class="line">Window #0 Window&#123;aefb7bc u0 com.android.systemui.ImageWallpaper&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">21000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">21000</span>+<span class="number">0</span>=<span class="number">21000</span> mLastLayer=<span class="number">21000</span></span><br></pre></td></tr></table></figure><p>ç†è§£äº†çª—å£çš„BaseLayerå€¼å’ŒSubLayerå€¼çš„è®¡ç®—è¿‡ç¨‹ä¹‹å¤–ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥åˆ†æWindowManagerServiceç±»çš„æˆå‘˜å‡½æ•°assignLayersLocked()çš„å®ç°äº†</p><h3 id="3-2-1ã€WindowLayersController-assignLayersLocked"><a href="#3-2-1ã€WindowLayersController-assignLayersLocked" class="headerlink" title="3.2.1ã€WindowLayersController.assignLayersLocked()"></a>3.2.1ã€WindowLayersController.assignLayersLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowLayersController.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">assignLayersLocked</span><span class="params">(WindowList windows)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_LAYERS) Slog.v(TAG_WM, <span class="string">"Assigning layers based on windows="</span> + windows,</span><br><span class="line">            <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</span><br><span class="line">    clear();</span><br><span class="line">    <span class="keyword">int</span> curBaseLayer = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> curLayer = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> anyLayerChanged = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, windowCount = windows.size(); i &lt; windowCount; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState w = windows.get(i);</span><br><span class="line">        <span class="keyword">boolean</span> layerChanged = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> oldLayer = w.mLayer;</span><br><span class="line">        <span class="keyword">if</span> (w.mBaseLayer == curBaseLayer || w.mIsImWindow || (i &gt; <span class="number">0</span> &amp;&amp; w.mIsWallpaper)) &#123;</span><br><span class="line">            curLayer += WINDOW_LAYER_MULTIPLIER;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            curBaseLayer = curLayer = w.mBaseLayer;</span><br><span class="line">        &#125;</span><br><span class="line">        assignAnimLayer(w, curLayer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Preserved old behavior of code here but not sure comparing</span></span><br><span class="line">        <span class="comment">// oldLayer to mAnimLayer and mLayer makes sense...though the</span></span><br><span class="line">        <span class="comment">// worst case would be unintentionalp layer reassignment.</span></span><br><span class="line">        <span class="keyword">if</span> (w.mLayer != oldLayer || w.mWinAnimator.mAnimLayer != oldLayer) &#123;</span><br><span class="line">            layerChanged = <span class="keyword">true</span>;</span><br><span class="line">            anyLayerChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (w.mAppToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mHighestApplicationLayer = Math.max(mHighestApplicationLayer,</span><br><span class="line">                    w.mWinAnimator.mAnimLayer);</span><br><span class="line">        &#125;</span><br><span class="line">        collectSpecialWindows(w);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (layerChanged) &#123;</span><br><span class="line">            w.scheduleAnimationIfDimming();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    adjustSpecialWindows();</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ assignAnimLayer() è¿›è¡ŒLayerè°ƒæ•´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowLayersController.java]</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assignAnimLayer</span><span class="params">(WindowState w, <span class="keyword">int</span> layer)</span> </span>&#123;</span><br><span class="line">        w.mLayer = layer;</span><br><span class="line">        w.mWinAnimator.mAnimLayer = w.mLayer + w.getAnimLayerAdjustment() +</span><br><span class="line">                    getSpecialWindowAnimLayerAdjustment(w);</span><br><span class="line">        <span class="keyword">if</span> (w.mAppToken != <span class="keyword">null</span> &amp;&amp; w.mAppToken.mAppAnimator.thumbnailForceAboveLayer &gt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; w.mWinAnimator.mAnimLayer &gt; w.mAppToken.mAppAnimator.thumbnailForceAboveLayer) &#123;</span><br><span class="line">            w.mAppToken.mAppAnimator.thumbnailForceAboveLayer = w.mWinAnimator.mAnimLayer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="3-3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»"><a href="#3-3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»" class="headerlink" title="3.3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»"></a>3.3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»</h3><p>WindowManagerServiceæœåŠ¡åœ¨åˆ·æ–°ç³»ç»Ÿçš„UIçš„æ—¶å€™ï¼Œå°±ä¼šå°†ç³»ç»Ÿä¸­å·²ç»è®¡ç®—å¥½äº†çš„çª—å£Zè½´ä½ç½®è®¾ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»ï¼Œä»¥ä¾¿SurfaceFlingeræœåŠ¡å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„çª—å£è¿›è¡Œå¯è§æ€§è®¡ç®—ä»¥åŠåˆæˆå’Œæ¸²æŸ“ç­‰æ“ä½œ é¦–å…ˆçœ‹ä¸€ä¸‹å †æ ˆä¿¡æ¯ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">WindowSurfaceController.showSurface()æ·»åŠ æ‰“å°Log</span><br><span class="line">Slog.i(<span class="string">"zhoujinjian"</span>, <span class="string">"zhoujinjian"</span>,<span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>): zhoujinjian</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>): java.lang.RuntimeException: here</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowSurfaceController.showSurface(WindowSurfaceController.java:<span class="number">414</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowSurfaceController.updateVisibility(WindowSurfaceController.java:<span class="number">402</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowSurfaceController.showRobustlyInTransaction(WindowSurfaceController.java:<span class="number">391</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowStateAnimator.showSurfaceRobustlyLocked(WindowStateAnimator.java:<span class="number">1814</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowStateAnimator.prepareSurfaceLocked(WindowStateAnimator.java:<span class="number">1609</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowAnimator.animateLocked(WindowAnimator.java:<span class="number">791</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowAnimator.-wrap0(WindowAnimator.java)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowAnimator$<span class="number">1.</span>doFrame(WindowAnimator.java:<span class="number">166</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.view.Choreographer$CallbackRecord.run(Choreographer.java:<span class="number">879</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.view.Choreographer.doCallbacks(Choreographer.java:<span class="number">693</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.view.Choreographer.doFrame(Choreographer.java:<span class="number">625</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:<span class="number">867</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.os.Handler.handleCallback(Handler.java:<span class="number">751</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">95</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.os.Looper.loop(Looper.java:<span class="number">154</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.os.HandlerThread.run(HandlerThread.java:<span class="number">61</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.ServiceThread.run(ServiceThread.java:<span class="number">46</span>)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†äº†è§£WMSæ˜¯å¦‚ä½•å°†Zè½´ä½ç½®è®¾ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹WMSæ„é€ æ–¹æ³•ä¸­å…³é”®å¯¹è±¡WindowAnimatorçš„åˆ›å»º</p><h3 id="3-3-1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹"><a href="#3-3-1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹" class="headerlink" title="3.3.1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹"></a>3.3.1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹</h3><p>å¼€æœºå¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–WMSã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">WindowManagerService</span><span class="params">(Context context, InputManagerService inputManager,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> haveInputMethods, <span class="keyword">boolean</span> showBootMsgs, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mAnimator = <span class="keyword">new</span> WindowAnimator(<span class="keyword">this</span>);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨WindowAnimatoræ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line">WindowAnimator(<span class="keyword">final</span> WindowManagerService service) &#123;</span><br><span class="line">    mService = service;</span><br><span class="line">    mContext = service.mContext;</span><br><span class="line">    mPolicy = service.mPolicy;</span><br><span class="line">    mWindowPlacerLocked = service.mWindowPlacerLocked;</span><br><span class="line"></span><br><span class="line">    mAnimationFrameCallback = <span class="keyword">new</span> Choreographer.FrameCallback() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNs)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mService.mWindowMap) &#123;</span><br><span class="line">                mService.mAnimationScheduled = <span class="keyword">false</span>;</span><br><span class="line">                animateLocked(frameTimeNs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆ›å»ºäº†Choreographer.FrameCallback()ï¼Œå‰é¢åœ¨ã€Android-7-1-2-Android-N-Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹ã€‘åˆ†æè¿‡ï¼ŒFrameDisplayEventReceiverï¼ˆåœ¨Choreographeræ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ï¼‰å¯¹è±¡ç”¨äºè¯·æ±‚å¹¶æ¥æ”¶Vsyncä¿¡å·ï¼Œå½“Vsyncä¿¡å·åˆ°æ¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨å…¶onVsync()å‡½æ•°ï¼Œåé¢ä¼šå›è°ƒåˆ°FrameDisplayEventReceiver.run()æ–¹æ³•ï¼Œå†å›è°ƒå‡½æ•°ä¸­æ‰§è¡ŒdoFrame()å®ç°å±å¹•åˆ·æ–°ï¼ŒdoFrame()ä¼šé¡ºåºæ‰§è¡ŒCALLBACK_INPUTã€CALLBACK_ANIMATIONã€CALLBACK_TRAVERSAL å’ŒCALLBACK_COMMIT å¯¹åº”CallbackQueueé˜Ÿåˆ—ä¸­æ³¨å†Œçš„å›è°ƒï¼Œä»è€Œä¼šæ‰§è¡ŒCallbackRecord.run()ï¼Œåœ¨æ‰§è¡Œå…¶å›è°ƒå‡½æ•°æ—¶ï¼Œå°±éœ€è¦åŒºåˆ«è¿™ä¸¤ç§å¯¹è±¡ç±»å‹ï¼Œå¦‚æœæ³¨å†Œçš„æ˜¯Runnableå¯¹è±¡ï¼Œåˆ™è°ƒç”¨å…¶run()å‡½æ•°ï¼Œå¦‚æœæ³¨å†Œçš„æ˜¯FrameCallbackå¯¹è±¡ï¼Œåˆ™è°ƒç”¨å®ƒçš„doFrame()å‡½æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Choreographer.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackRecord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> CallbackRecord next;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> dueTime;</span><br><span class="line">    <span class="keyword">public</span> Object action; <span class="comment">// Runnable or FrameCallback</span></span><br><span class="line">    <span class="keyword">public</span> Object token;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (token == FRAME_CALLBACK_TOKEN) &#123;</span><br><span class="line">            ((FrameCallback)action).doFrame(frameTimeNanos);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ((Runnable)action).run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ç§æƒ…å†µä¸‹ä¼šæ‰§è¡ŒFrameCallbackå¯¹è±¡çš„doFrame()å‡½æ•°ï¼ˆåŸå› ç¨åå†åˆ†æåŠ¨ç”»æ—¶è¯¦ç»†åˆ†æï¼‰ï¼Œç”±WindowAnimatoræ„é€ å‡½æ•°ä¸­å¯çŸ¥æ¥ç€å°±ä¼šæ‰§è¡ŒWindowAnimator.animateLocked()</p><h3 id="3-3-2ã€å‡†å¤‡åˆ·æ–°UI"><a href="#3-3-2ã€å‡†å¤‡åˆ·æ–°UI" class="headerlink" title="3.3.2ã€å‡†å¤‡åˆ·æ–°UI"></a>3.3.2ã€å‡†å¤‡åˆ·æ–°UI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">animateLocked</span><span class="params">(<span class="keyword">long</span> frameTimeNs)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">                TAG, <span class="string">"&gt;&gt;&gt; OPEN TRANSACTION animateLocked"</span>);</span><br><span class="line">        SurfaceControl.openTransaction();</span><br><span class="line">        SurfaceControl.setAnimationTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mDisplayContentsAnimators.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDisplays; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplayContentsAnimators.keyAt(i);</span><br><span class="line">                updateAppWindowsLocked(displayId);</span><br><span class="line">                DisplayContentsAnimator displayAnimator = mDisplayContentsAnimators.valueAt(i);</span><br><span class="line">                ......</span><br><span class="line">                updateWindowsLocked(displayId);</span><br><span class="line">                updateWallpaperLocked(displayId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> WindowList windows = mService.getWindowListLocked(displayId);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = windows.size();</span><br><span class="line">                <span class="comment">//é€šè¿‡ä¸€ä¸ªforå¾ªç¯æ¥éå†ä¿å­˜åœ¨çª—å£å †æ ˆçš„æ¯ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªçª—å£çš„ç»˜å›¾è¡¨é¢è¿›è¡Œæ›´æ–°</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++) &#123;</span><br><span class="line">                    windows.get(j).mWinAnimator.prepareSurfaceLocked(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            SurfaceControl.closeTransaction();</span><br><span class="line">            <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">                    TAG, <span class="string">"&lt;&lt;&lt; CLOSE TRANSACTION animateLocked"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–windowsåˆ—è¡¨ï¼Œç„¶åå¾ªç¯è°ƒç”¨windows.get(j).mWinAnimator.prepareSurfaceLocked(true)ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepareSurfaceLocked</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WindowState w = mWin;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> displayed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯</span></span><br><span class="line">    computeShownFrameLocked();</span><br><span class="line"></span><br><span class="line">    setSurfaceBoundariesLocked(recoveringMemory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsWallpaper &amp;&amp; !mWin.mWallpaperVisible) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (w.mAttachedHidden || !w.isOnScreen()) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLastLayer != mAnimLayer</span><br><span class="line">            || mLastAlpha != mShownAlpha</span><br><span class="line">            || mLastDsDx != mDsDx</span><br><span class="line">            || mLastDtDx != mDtDx</span><br><span class="line">            || mLastDsDy != mDsDy</span><br><span class="line">            || mLastDtDy != mDtDy</span><br><span class="line">            || w.mLastHScale != w.mHScale</span><br><span class="line">            || w.mLastVScale != w.mVScale</span><br><span class="line">            || mLastHidden) &#123;</span><br><span class="line">        displayed = <span class="keyword">true</span>;</span><br><span class="line">        mLastAlpha = mShownAlpha;</span><br><span class="line">        mLastLayer = mAnimLayer;</span><br><span class="line">        mLastDsDx = mDsDx;</span><br><span class="line">        mLastDtDx = mDtDx;</span><br><span class="line">        mLastDsDy = mDsDy;</span><br><span class="line">        mLastDtDy = mDtDy;</span><br><span class="line">        w.mLastHScale = w.mHScale;</span><br><span class="line">        w.mLastVScale = w.mVScale;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">boolean</span> prepared =</span><br><span class="line">            mSurfaceController.prepareToShowInTransaction(mShownAlpha, mAnimLayer,</span><br><span class="line">                    mDsDx * w.mHScale * mExtraHScale,</span><br><span class="line">                    mDtDx * w.mVScale * mExtraVScale,</span><br><span class="line">                    mDsDy * w.mHScale * mExtraHScale,</span><br><span class="line">                    mDtDy * w.mVScale * mExtraVScale,</span><br><span class="line">                    recoveringMemory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prepared &amp;&amp; mLastHidden &amp;&amp; mDrawState == HAS_DRAWN) &#123;</span><br><span class="line">            <span class="keyword">if</span> (showSurfaceRobustlyLocked()) &#123;</span><br><span class="line">                markPreservedSurfaceForDestroy();</span><br><span class="line">                mAnimator.requestRemovalOfReplacedWindows(w);</span><br><span class="line">                mLastHidden = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (mIsWallpaper) &#123;</span><br><span class="line">                    mWallpaperControllerLocked.dispatchWallpaperVisibility(w, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                mAnimator.setPendingLayoutChanges(w.getDisplayId(),</span><br><span class="line">                        WindowManagerPolicy.FINISH_LAYOUT_REDO_ANIM);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                w.mOrientationChanging = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasSurface()) &#123;</span><br><span class="line">            w.mToken.hasVisible = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        displayed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨prepareToShowInTransaction()å°†alphã€alayerã€setMatrixè®¾ç½®åˆ°mSurfaceControlä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">boolean prepareToShowInTransaction(float alpha, int layer, float dsdx, float dtdx, float dsdy,</span><br><span class="line">           float dtdy, boolean recoveringMemory) &#123;</span><br><span class="line">       if (mSurfaceControl != null) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               mSurfaceAlpha = alpha;</span><br><span class="line">               mSurfaceControl.setAlpha(alpha);</span><br><span class="line">               mSurfaceLayer = layer;</span><br><span class="line">               mSurfaceControl.setLayer(layer);</span><br><span class="line">               mSurfaceControl.setMatrix(</span><br><span class="line">                       dsdx, dtdx, dsdy, dtdy);</span><br><span class="line"></span><br><span class="line">           &#125; catch (RuntimeException e) &#123;</span><br><span class="line">               .......</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>setSurfaceBoundariesLocked()æ–¹æ³•ä¸­ä¼šè°ƒç”¨SurfaceControl.setPosition()ç­‰ç­‰æ–¹æ³•å°†è®¡ç®—å¥½çš„æ•°å€¼è®¾ç½®åˆ°mSurfaceControlä¸­ã€‚ è¯´æ˜ï¼šä¸€ä¸ªçª—å£çš„æ˜¾ç¤ºå’Œéšè—ï¼Œä»¥åŠå¤§å°ã€Xè½´å’ŒYè½´ä½ç½®ã€Zè½´ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µè®¾ç½®ï¼Œæ˜¯é€šè¿‡è°ƒç”¨Javaå±‚çš„SurfaceControlç±»çš„æˆå‘˜å‡½æ•°showã€hideã€setSizeã€setPositionã€setLayerã€setAlphaå’ŒsetMatrixæ¥å®ç°çš„ï¼Œå®ƒä»¬æœ€ç»ˆéƒ½æ˜¯é€šè¿‡è°ƒç”¨JNIæ–¹æ³•å®ç°çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SurfaceControl.java</span><br><span class="line">......</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlpha</span><span class="params">(<span class="keyword">float</span> alpha)</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    nativeSetAlpha(mNativeObject, alpha);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMatrix</span><span class="params">(<span class="keyword">float</span> dsdx, <span class="keyword">float</span> dtdx, <span class="keyword">float</span> dsdy, <span class="keyword">float</span> dtdy)</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    nativeSetMatrix(mNativeObject, dsdx, dtdx, dsdy, dtdy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowCrop</span><span class="params">(Rect crop)</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    <span class="keyword">if</span> (crop != <span class="keyword">null</span>) &#123;</span><br><span class="line">        nativeSetWindowCrop(mNativeObject,</span><br><span class="line">            crop.left, crop.top, crop.right, crop.bottom);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeSetWindowCrop(mNativeObject, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFinalCrop</span><span class="params">(Rect crop)</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    <span class="keyword">if</span> (crop != <span class="keyword">null</span>) &#123;</span><br><span class="line">        nativeSetFinalCrop(mNativeObject,</span><br><span class="line">            crop.left, crop.top, crop.right, crop.bottom);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeSetFinalCrop(mNativeObject, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure><h3 id="3-3-3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI"><a href="#3-3-3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI" class="headerlink" title="3.3.3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI"></a>3.3.3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI</h3><p>å¦‚æœWindowStateå¯¹è±¡wæ‰€æè¿°çš„çª—å£æ»¡è¶³æ¡ä»¶ï¼šprepared &amp;&amp; mLastHidden &amp;&amp; mDrawState == HAS_DRAWN é‚£ä¹ˆå°±è¯´æ˜ç°åœ¨æ˜¯æ—¶å€™è¦å°†WindowStateå¯¹è±¡wæ‰€æè¿°çš„çª—å£æ˜¾ç¤ºå‡ºæ¥äº†ï¼Œé€šè¿‡è°ƒç”¨showSurfaceRobustlyLockedå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">showSurfaceRobustlyLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Task task = mWin.getTask();</span><br><span class="line">    <span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; StackId.windowsAreScaleable(task.mStack.mStackId)) &#123;</span><br><span class="line">        mSurfaceController.forceScaleableInTransaction(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> shown = mSurfaceController.showRobustlyInTransaction();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mWin.mTurnOnScreen) &#123;</span><br><span class="line">        ......</span><br><span class="line">        mWin.mTurnOnScreen = <span class="keyword">false</span>;</span><br><span class="line">        mAnimator.mBulkUpdateParams |= SET_TURN_ON_SCREEN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨WindowSurfaceController.showRobustlyInTransaction() â€“&gt; updateVisibility()â€“&gt;showSurface()-&gt;SurfaceControl.show()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfaceController.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">showRobustlyInTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mHiddenForOtherReasons = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> updateVisibility();</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateVisibility</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mHiddenForCrop || mHiddenForOtherReasons) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSurfaceShown) &#123;hideSurface();&#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSurfaceShown) &#123;<span class="keyword">return</span> showSurface();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">showSurface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mSurfaceShown = <span class="keyword">true</span>;</span><br><span class="line">            mSurfaceControl.show();</span><br><span class="line">             Slog.i(<span class="string">"zhoujinjian"</span>, <span class="string">"zhoujinjian"</span>,<span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‡ºç°å¼‚å¸¸,å›æ”¶ç³»ç»Ÿå†…å­˜èµ„æº</span></span><br><span class="line">        mAnimator.reclaimSomeSurfaceMemory(<span class="string">"show"</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;SurfaceControl.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    nativeSetFlags(mNativeObject, <span class="number">0</span>, SURFACE_HIDDEN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡JNIè°ƒç”¨android_view_SurfaceControl.cppçš„nativeSetFlagså‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°flags == 0ï¼›</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;android_view_SurfaceControl.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeSetFlags</span><span class="params">(JNIEnv* env, jclass clazz, jlong nativeObject, jint flags, jint mask)</span> </span>&#123;</span><br><span class="line">    SurfaceControl* <span class="keyword">const</span> ctrl = <span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(nativeObject);</span><br><span class="line">    <span class="keyword">status_t</span> err = ctrl-&gt;setFlags(flags, mask);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span> &amp;&amp; err != NO_INIT) &#123;</span><br><span class="line">        doThrowIAE(env);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨SurfaceControl.cppçš„setFlags()å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;SurfaceControl.cpp]</span><br><span class="line"><span class="keyword">status_t</span> SurfaceControl::setFlags(<span class="keyword">uint32_t</span> flags, <span class="keyword">uint32_t</span> mask) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> err = validate();</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) <span class="keyword">return</span> err;</span><br><span class="line">    <span class="keyword">return</span> mClient-&gt;setFlags(mHandle, flags, mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥é€šè¿‡Binder IPCæœºåˆ¶ï¼ŒSurfaceComposerClient.cpp-&gt;Composer::setFlags()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;SurfaceComposerClient.cpp]</span><br><span class="line"><span class="keyword">status_t</span> Composer::setFlags(<span class="keyword">const</span> sp&lt;SurfaceComposerClient&gt;&amp; client,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; id, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">        <span class="keyword">uint32_t</span> mask) &#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="keyword">layer_state_t</span>* s = getLayerStateLocked(client, id);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ((mask &amp; <span class="keyword">layer_state_t</span>::eLayerOpaque) ||</span><br><span class="line">            (mask &amp; <span class="keyword">layer_state_t</span>::eLayerHidden) ||</span><br><span class="line">            (mask &amp; <span class="keyword">layer_state_t</span>::eLayerSecure)) &#123;</span><br><span class="line">        s-&gt;what |= <span class="keyword">layer_state_t</span>::eFlagsChanged;</span><br><span class="line">    &#125;</span><br><span class="line">    s-&gt;flags &amp;= ~mask;</span><br><span class="line">    s-&gt;flags |= (flags &amp; mask);</span><br><span class="line">    s-&gt;mask |= mask;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“æ•°å€¼å°±ä¸è¯¦ç»†è®¡ç®—äº†ï¼Œå‰é¢åˆ†æã€Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿåˆ†æ [i.wonder~]ã€‘å¯çŸ¥ï¼ŒSurfaceFlingeræ¥æ”¶Vsyncä¿¡å·ä¸Appæœ‰ä¸€ä¸ªoffseté—´éš”æ—¶é—´ï¼Œå½“SurfaceFlingeræ¥æ”¶Vsyncä¿¡å·æ—¶ï¼Œå°±å¯ä»¥æ ¹æ®flagsæ˜¯å¦æ˜¾ç¤º å’Œ ä¸Šé¢è®¾ç½®çš„ä¸€ç³»åˆ—æ•°å€¼è¿›è¡Œæ¸²æŸ“åˆæˆï¼Œæœ€ç»ˆæ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚</p><h2 id="ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£-Starting-Window-æ·»åŠ è¿‡ç¨‹"><a href="#ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£-Starting-Window-æ·»åŠ è¿‡ç¨‹" class="headerlink" title="ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£(Starting Window)æ·»åŠ è¿‡ç¨‹"></a>ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£(Starting Window)æ·»åŠ è¿‡ç¨‹</h2><h3 id="4-1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£-Starting-Window-çš„æ·»åŠ è¿‡ç¨‹"><a href="#4-1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£-Starting-Window-çš„æ·»åŠ è¿‡ç¨‹" class="headerlink" title="4.1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£(Starting Window)çš„æ·»åŠ è¿‡ç¨‹"></a>4.1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£(Starting Window)çš„æ·»åŠ è¿‡ç¨‹</h3><p>æ—¶åºå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/13-Android-WMS-Starting-Window-addview.png" alt="Markdown"></p><h3 id="4-1-1ã€-ActivityStack-startActivityLocked"><a href="#4-1-1ã€-ActivityStack-startActivityLocked" class="headerlink" title="4.1.1ã€ ActivityStack.startActivityLocked()"></a>4.1.1ã€ ActivityStack.startActivityLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStack.java]</span><br><span class="line">   <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> keepCurTransition,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityOptions options)</span> </span>&#123;</span><br><span class="line">            ......</span><br><span class="line">                    <span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</span><br><span class="line">                mWindowManager.prepareAppTransition(TRANSIT_NONE, keepCurTransition);</span><br><span class="line">                mNoAnimActivities.add(r);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mWindowManager.prepareAppTransition(newTask</span><br><span class="line">                        ? r.mLaunchTaskBehind</span><br><span class="line">                                ? TRANSIT_TASK_OPEN_BEHIND</span><br><span class="line">                                : TRANSIT_TASK_OPEN</span><br><span class="line">                        : TRANSIT_ACTIVITY_OPEN, keepCurTransition);</span><br><span class="line">                mNoAnimActivities.remove(r);</span><br><span class="line">            &#125;</span><br><span class="line">            addConfigOverride(r, task);</span><br><span class="line">            <span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class="line">                .......</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class="line">                ActivityRecord prev = r.task.topRunningActivityWithStartingWindowLocked();</span><br><span class="line">                <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// We don't want to reuse the previous starting preview if:</span></span><br><span class="line">                    <span class="comment">// (1) The current activity is in a different task.</span></span><br><span class="line">                    <span class="keyword">if</span> (prev.task != r.task) &#123;</span><br><span class="line">                        prev = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// (2) The current activity is already displayed.</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</span><br><span class="line">                        prev = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                r.showStartingWindow(prev, showStartingIcon);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç›´æ¥è°ƒç”¨ActivityRecord.showStartingWindow()è¿›ä¸€æ­¥æ·»åŠ å¯åŠ¨çª—å£</p><h3 id="4-1-2ã€-ActivityRecord-showStartingWindow"><a href="#4-1-2ã€-ActivityRecord-showStartingWindow" class="headerlink" title="4.1.2ã€ ActivityRecord.showStartingWindow()"></a>4.1.2ã€ ActivityRecord.showStartingWindow()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityRecord.java]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showStartingWindow</span><span class="params">(ActivityRecord prev, <span class="keyword">boolean</span> createIfNeeded)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> CompatibilityInfo compatInfo =</span><br><span class="line">            service.compatibilityInfoForPackageLocked(info.applicationInfo);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> shown = service.mWindowManager.setAppStartingWindow(</span><br><span class="line">            appToken, packageName, theme, compatInfo, nonLocalizedLabel, labelRes, icon,</span><br><span class="line">            logo, windowFlags, prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, createIfNeeded);</span><br><span class="line">    <span class="keyword">if</span> (shown) &#123;</span><br><span class="line">        mStartingWindowState = STARTING_WINDOW_SHOWN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-2ã€ActivityRecord-setAppStartingWindow"><a href="#4-1-2ã€ActivityRecord-setAppStartingWindow" class="headerlink" title="4.1.2ã€ActivityRecord.setAppStartingWindow()"></a>4.1.2ã€ActivityRecord.setAppStartingWindow()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityRecord.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setAppStartingWindow</span><span class="params">(IBinder token, String pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> theme, CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence nonLocalizedLabel, <span class="keyword">int</span> labelRes, <span class="keyword">int</span> icon, <span class="keyword">int</span> logo,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> windowFlags, IBinder transferFrom, <span class="keyword">boolean</span> createIfNeeded)</span> </span>&#123;</span><br><span class="line">   ......</span><br><span class="line">  <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">   AppWindowToken wtoken = findAppWindowToken(token);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (transferStartingWindow(transferFrom, wtoken)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        wtoken.startingData = <span class="keyword">new</span> StartingData(pkg, theme, compatInfo, nonLocalizedLabel,</span><br><span class="line">                labelRes, icon, logo, windowFlags);</span><br><span class="line">        Message m = mH.obtainMessage(H.ADD_STARTING, wtoken);</span><br><span class="line">        mH.sendMessageAtFrontOfQueue(m);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå‚æ•°transferFromæ‰€æè¿°çš„Activityç»„ä»¶æ²¡æœ‰å¯åŠ¨çª—å£æˆ–è€…å¯åŠ¨çª—å£æ•°æ®è½¬ç§»ç»™å‚æ•°tokenæ‰€æè¿°çš„Activityç»„ä»¶ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¯èƒ½éœ€è¦ä¸ºå‚æ•°tokenæ‰€æè¿°çš„Activityç»„ä»¶åˆ›å»ºä¸€ä¸ªæ–°çš„å¯åŠ¨çª—å£</p><h3 id="4-1-3ã€-H-handleMessage"><a href="#4-1-3ã€-H-handleMessage" class="headerlink" title="4.1.3ã€ H.handleMessage()"></a>4.1.3ã€ H.handleMessage()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java::H]</span><br><span class="line"><span class="keyword">case</span> ADD_STARTING: &#123;</span><br><span class="line">    <span class="keyword">final</span> AppWindowToken wtoken = (AppWindowToken)msg.obj;</span><br><span class="line">    <span class="keyword">final</span> StartingData sd = wtoken.startingData;</span><br><span class="line">    ......</span><br><span class="line">    View view = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Configuration overrideConfig = wtoken != <span class="keyword">null</span> &amp;&amp; wtoken.mTask != <span class="keyword">null</span></span><br><span class="line">                ? wtoken.mTask.mOverrideConfig : <span class="keyword">null</span>;</span><br><span class="line">        view = mPolicy.addStartingWindow(wtoken.token, sd.pkg, sd.theme,</span><br><span class="line">            sd.compatInfo, sd.nonLocalizedLabel, sd.labelRes, sd.icon, sd.logo,</span><br><span class="line">            sd.windowFlags, overrideConfig);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> abort = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            <span class="keyword">if</span> (wtoken.removed || wtoken.startingData == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    wtoken.startingWindow = <span class="keyword">null</span>;</span><br><span class="line">                    wtoken.startingData = <span class="keyword">null</span>;</span><br><span class="line">                    abort = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                wtoken.startingView = view;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (abort) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mPolicy.removeStartingWindow(wtoken.token, view);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>PhoneWindowManagerå®ç°WindowManagerPolicyï¼Œæ‰€ä»¥ä¼šè°ƒç”¨PhoneWindowManagerä¸­çš„æ–¹æ³• ç»§ç»­åˆ†æPhoneWindowManager.addStartingWindow()</p><h3 id="4-1-4ã€PhoneWindowManager-addStartingWindow"><a href="#4-1-4ã€PhoneWindowManager-addStartingWindow" class="headerlink" title="4.1.4ã€PhoneWindowManager.addStartingWindow()"></a>4.1.4ã€PhoneWindowManager.addStartingWindow()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;PhoneWindowManager.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">addStartingWindow</span><span class="params">(IBinder appToken, String packageName, <span class="keyword">int</span> theme,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, CharSequence nonLocalizedLabel, <span class="keyword">int</span> labelRes,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> icon, <span class="keyword">int</span> logo, <span class="keyword">int</span> windowFlags, Configuration overrideConfig)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    WindowManager wm = <span class="keyword">null</span>;</span><br><span class="line">    View view = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Context context = mContext;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> PhoneWindow win = <span class="keyword">new</span> PhoneWindow(context);</span><br><span class="line">        win.setIsStartingWindow(<span class="keyword">true</span>);</span><br><span class="line">        ......</span><br><span class="line">        win.setType(</span><br><span class="line">            WindowManager.LayoutParams.TYPE_APPLICATION_STARTING);</span><br><span class="line">        ......</span><br><span class="line">        win.setLayout(WindowManager.LayoutParams.MATCH_PARENT,</span><br><span class="line">                WindowManager.LayoutParams.MATCH_PARENT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WindowManager.LayoutParams params = win.getAttributes();</span><br><span class="line">        params.token = appToken;</span><br><span class="line">        params.packageName = packageName;</span><br><span class="line">        params.windowAnimations = win.getWindowStyle().getResourceId(</span><br><span class="line">                com.android.internal.R.styleable.Window_windowAnimationStyle, <span class="number">0</span>);</span><br><span class="line">        ......</span><br><span class="line">        params.setTitle(<span class="string">"Starting "</span> + packageName);</span><br><span class="line">        wm = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">        view = win.getDecorView();</span><br><span class="line">       ......</span><br><span class="line">        wm.addView(view, params);</span><br><span class="line">        <span class="keyword">return</span> view.getParent() != <span class="keyword">null</span> ? view : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (WindowManager.BadTokenException e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (view != <span class="keyword">null</span> &amp;&amp; view.getParent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            wm.removeViewImmediate(view);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºPhoneWindowå¯¹è±¡ï¼Œæ¥ä¸‹æ¥ç»§ç»­è®¾ç½®æ‰€åˆ›å»ºçš„çª—å£winçš„ä»¥ä¸‹å±æ€§ï¼š 1ã€çª—å£ç±»å‹ï¼šè®¾ç½®ä¸ºWindowManager.LayoutParams.TYPE_APPLICATION_STARTINGï¼Œå³è®¾ç½®ä¸ºå¯åŠ¨çª—å£ç±»å‹ï¼›</p><p>2ã€çª—å£æ ‡é¢˜ï¼šç”±å‚æ•°labelResã€nonLocalizedLabelï¼Œä»¥åŠçª—å£çš„è¿è¡Œä¸Šä¸‹æ–‡contextæ¥ç¡®å®šï¼›</p><p>3ã€çª—å£æ ‡å¿—ï¼šåˆ†åˆ«å°†indowManager.LayoutParams.FLAG_NOT_TOUCHABLEã€WindowManager.LayoutParams.FLAG_NOT_FOCUSABLEå’ŒWindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IMä½è®¾ç½®ä¸º1ï¼Œå³ä¸å¯æ¥å—è§¦æ‘¸äº‹ä»¶å’Œä¸å¯è·å¾—ç„¦ç‚¹ï¼Œä½†æ˜¯å¯ä»¥æ¥å—è¾“å…¥æ³•çª—å£ï¼›</p><p>4ã€çª—å£å¤§å°ï¼šè®¾ç½®ä¸ºWindowManager.LayoutParams.MATCH_PARENTï¼Œå³ä¸çˆ¶çª—å£ä¸€æ ·å¤§ï¼Œä½†æ˜¯ç”±äºè¿™æ˜¯ä¸€ä¸ªé¡¶å±‚çª—å£ï¼Œå› æ­¤å®é™…ä¸Šæ˜¯æŒ‡ä¸å±å¹•ä¸€æ ·å¤§ï¼›</p><p>5ã€å¸ƒå±€å‚æ•°ï¼šåŒ…æ‹¬çª—å£æ‰€å¯¹åº”çš„çª—å£ä»¤ç‰Œï¼ˆtokenï¼‰å’ŒåŒ…åï¼ˆpackageNameï¼‰ï¼Œä»¥åŠçª—å£æ‰€ä½¿ç”¨çš„åŠ¨ç”»ç±»å‹ï¼ˆwindowAnimationsï¼‰å’Œæ ‡é¢˜ï¼ˆtitleï¼‰ã€‚</p><p>wm.addView(view, params)ï¼Œä¸€ä¸ªæ–°åˆ›å»ºçš„Activityç»„ä»¶çš„å¯åŠ¨çª—å£å°±å¢åŠ åˆ°WindowManagerServiceæœåŠ¡ä¸­å»äº†ï¼Œè¿™æ ·ï¼ŒWindowManagerServiceæœåŠ¡å°±å¯ä»¥ä¸‹æ¬¡åˆ·æ–°ç³»ç»ŸUIæ—¶ï¼Œå°†è¯¥å¯åŠ¨çª—å£æ˜¾ç¤ºå‡ºæ¥</p><h2 id="ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp-Transitionï¼‰è¿‡ç¨‹"><a href="#ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp-Transitionï¼‰è¿‡ç¨‹" class="headerlink" title="ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp Transitionï¼‰è¿‡ç¨‹"></a>ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp Transitionï¼‰è¿‡ç¨‹</h2><p>WindowManagerServiceæœåŠ¡åœ¨æ‰§è¡ŒActivityçª—å£çš„åˆ‡æ¢æ“ä½œçš„æ—¶å€™ï¼Œä¼šç»™å‚ä¸åˆ‡æ¢æ“ä½œçš„Activityç»„ä»¶çš„è®¾ç½®ä¸€ä¸ªåŠ¨ç”»ï¼Œä»¥ä¾¿å¯ä»¥å‘ç”¨æˆ·å±•ç°ä¸€ä¸ªActivityç»„ä»¶åˆ‡æ¢æ•ˆæœï¼Œä»è€Œæé«˜ç”¨æˆ·ä½“éªŒã€‚ é¦–å…ˆçœ‹ä¸€ä¸‹App TransitionåŠ¨æ€å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/14-Android-WMS-ezgif.com-video-to-gif-WMS-App-Transition.gif" alt="Markdown"></p><p>æ—¶åºå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/15-Android-WMS-executeAppTransition.png" alt="Markdown"></p><p>æˆ‘ä»¬ç›´æ¥åˆ†æApp Transitionè¿‡ç¨‹çš„prepareAppTransitionã€executeAppTransition å…³äºActivityå¯åŠ¨è¿‡ç¨‹è¯·å‚è€ƒï¼šã€Android-7-1-2-Android-N-Activityå¯åŠ¨æµç¨‹åˆ†æã€‘</p><h3 id="5-1ã€prepareAppTransition-è¿‡ç¨‹"><a href="#5-1ã€prepareAppTransition-è¿‡ç¨‹" class="headerlink" title="5.1ã€prepareAppTransition()è¿‡ç¨‹"></a>5.1ã€prepareAppTransition()è¿‡ç¨‹</h3><h3 id="5-1-1ã€ActivityStack-startActivityLocked"><a href="#5-1-1ã€ActivityStack-startActivityLocked" class="headerlink" title="5.1.1ã€ActivityStack.startActivityLocked()"></a>5.1.1ã€ActivityStack.startActivityLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStack.java]</span><br><span class="line">......</span><br><span class="line">mWindowManager.prepareAppTransition(newTask</span><br><span class="line">        ? r.mLaunchTaskBehind</span><br><span class="line">                ? TRANSIT_TASK_OPEN_BEHIND</span><br><span class="line">                : TRANSIT_TASK_OPEN</span><br><span class="line">        : TRANSIT_ACTIVITY_OPEN, keepCurTransition);</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h3 id="5-1-2ã€WindowManagerService-prepareAppTransition"><a href="#5-1-2ã€WindowManagerService-prepareAppTransition" class="headerlink" title="5.1.2ã€WindowManagerService.prepareAppTransition()"></a>5.1.2ã€WindowManagerService.prepareAppTransition()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareAppTransition</span><span class="params">(<span class="keyword">int</span> transit, <span class="keyword">boolean</span> alwaysKeepCurrent)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> prepared = mAppTransition.prepareAppTransitionLocked(</span><br><span class="line">                transit, alwaysKeepCurrent);</span><br><span class="line">        <span class="keyword">if</span> (prepared &amp;&amp; okToDisplay()) &#123;</span><br><span class="line">            mSkipAppTransitionAnimation = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ˜¯ç›´æ¥è°ƒç”¨AppTransition.prepareAppTransitionLocked()å®ç°çš„ã€‚</p><h3 id="5-1-3ã€AppTransition-prepareAppTransitionLocked"><a href="#5-1-3ã€AppTransition-prepareAppTransitionLocked" class="headerlink" title="5.1.3ã€AppTransition.prepareAppTransitionLocked()"></a>5.1.3ã€AppTransition.prepareAppTransitionLocked()</h3><p>è¿›ä¸€æ­¥è°ƒç”¨setAppTransition()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setAppTransition</span><span class="params">(<span class="keyword">int</span> transit)</span> </span>&#123;</span><br><span class="line">    mNextAppTransition = transit;</span><br><span class="line">    setLastAppTransition(TRANSIT_UNSET, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°åªæ˜¯å°†transitï¼ˆå³AppTransitionåŠ¨ç”»ç±»å‹ï¼‰èµ‹å€¼ç»™å˜é‡mNextAppTransition</p><h3 id="5-2ã€AppTransition-animationè®¾ç½®è¿‡ç¨‹"><a href="#5-2ã€AppTransition-animationè®¾ç½®è¿‡ç¨‹" class="headerlink" title="5.2ã€AppTransition animationè®¾ç½®è¿‡ç¨‹"></a>5.2ã€AppTransition animationè®¾ç½®è¿‡ç¨‹</h3><p>ç»§ç»­åˆ†æActivityStackSupervisor.realStartActivityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStackSupervisor.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        r.startFreezingScreenLocked(app, <span class="number">0</span>);</span><br><span class="line">        mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line">        r.startLaunchTickingLocked();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šé€šçŸ¥WindowManagerServiceæœåŠ¡å°†å‚æ•°r.appTokenæ‰€æè¿°çš„Activityç»„ä»¶çš„å¯è§æ€§è®¾ç½®ä¸ºtrue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppVisibility</span><span class="params">(IBinder token, <span class="keyword">boolean</span> visible)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    AppWindowToken wtoken;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        wtoken = findAppWindowToken(token);</span><br><span class="line">        ......</span><br><span class="line">        mOpeningApps.remove(wtoken);</span><br><span class="line">        mClosingApps.remove(wtoken);</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">            wtoken.inPendingTransaction = <span class="keyword">false</span>;</span><br><span class="line">            setTokenVisibilityLocked(wtoken, <span class="keyword">null</span>, visible, AppTransition.TRANSIT_UNSET,</span><br><span class="line">                    <span class="keyword">true</span>, wtoken.voiceInteraction);</span><br><span class="line">            wtoken.updateReportedVisibilityLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨WindowManagerService.setTokenVisibilityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setTokenVisibilityLocked</span><span class="params">(AppWindowToken wtoken, WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> visible, <span class="keyword">int</span> transit, <span class="keyword">boolean</span> performLayout, <span class="keyword">boolean</span> isVoiceInteraction)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (wtoken.hidden == visible || (wtoken.hidden &amp;&amp; wtoken.mIsExiting) ||</span><br><span class="line">                (visible &amp;&amp; wtoken.waitingForReplacement())) &#123;</span><br><span class="line">           ......</span><br><span class="line">            <span class="keyword">if</span> (transit != AppTransition.TRANSIT_UNSET) &#123;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (applyAnimationLocked(wtoken, lp, transit, visible, isVoiceInteraction)) &#123;</span><br><span class="line">                    delayed = runningAppAnimation = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨WindowManagerService.applyAnimationLocked()è®¾ç½®AppTransitionåŠ¨ç”»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">applyAnimationLocked</span><span class="params">(AppWindowToken atoken, WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> transit, <span class="keyword">boolean</span> enter, <span class="keyword">boolean</span> isVoiceInteraction)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (okToDisplay()) &#123;</span><br><span class="line">        Animation a = mAppTransition.loadAnimation(lp, transit, enter, mCurConfiguration.uiMode,</span><br><span class="line">        mCurConfiguration.orientation, frame, displayFrame, insets, surfaceInsets,</span><br><span class="line">        isVoiceInteraction, freeform, atoken.mTask.mTaskId);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»ˆäºåˆ°äº†AppTransitionçœŸæ­£è®¾ç½®è¿‡ç¨‹äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;AppTransition.java]</span><br><span class="line">Animation loadAnimation(WindowManager.LayoutParams lp, int transit, boolean enter, int uiMode,</span><br><span class="line">            int orientation, Rect frame, Rect displayFrame, Rect insets,</span><br><span class="line">            @Nullable Rect surfaceInsets, boolean isVoiceInteraction, boolean freeform,</span><br><span class="line">            int taskId) &#123;</span><br><span class="line">        Animation a;</span><br><span class="line">      if()&#123;&#125;</span><br><span class="line">      ......</span><br><span class="line">      &#125; else if()&#123;</span><br><span class="line">      ......</span><br><span class="line">      &#125;else &#123;</span><br><span class="line">        int animAttr = 0;</span><br><span class="line">        switch (transit) &#123;</span><br><span class="line">            case TRANSIT_ACTIVITY_OPEN:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_activityOpenEnterAnimation</span><br><span class="line">                        : WindowAnimation_activityOpenExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_ACTIVITY_CLOSE:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_activityCloseEnterAnimation</span><br><span class="line">                        : WindowAnimation_activityCloseExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_DOCK_TASK_FROM_RECENTS:</span><br><span class="line">            case TRANSIT_TASK_OPEN:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_taskOpenEnterAnimation</span><br><span class="line">                        : WindowAnimation_taskOpenExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_TASK_CLOSE:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_taskCloseEnterAnimation</span><br><span class="line">                        : WindowAnimation_taskCloseExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_TASK_TO_FRONT:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_taskToFrontEnterAnimation</span><br><span class="line">                        : WindowAnimation_taskToFrontExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_TASK_TO_BACK:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_taskToBackEnterAnimation</span><br><span class="line">                        : WindowAnimation_taskToBackExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        a = animAttr != 0 ? loadAnimationAttr(lp, animAttr) : null;</span><br><span class="line">    &#125;</span><br><span class="line">    return a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åé€šè¿‡<strong>loadAnimationAttr</strong>åŠ è½½xmlæ–‡ä»¶åŠ è½½åŠ¨ç”»ï¼ŒåŠ¨ç”»xmlæ–‡ä»¶çš„å­˜æ”¾è·¯å¾„ï¼ˆ/frameworks/base/core/res/res/anim/ï¼‰<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/16-Android-WMS-executeAppTransition-xml.png" alt="Markdown"></p><h3 id="5-3ã€executeAppTransitionè¿‡ç¨‹"><a href="#5-3ã€executeAppTransitionè¿‡ç¨‹" class="headerlink" title="5.3ã€executeAppTransitionè¿‡ç¨‹"></a>5.3ã€executeAppTransitionè¿‡ç¨‹</h3><blockquote><p>ActivityStackSupervisor.realStartActivityLocked()</p><blockquote><p>ActivityStack.minimalResumeActivityLocked() ActivityStack.completeResumeLocked() ActivityStackSupervisor.reportResumedActivityLocked()</p></blockquote></blockquote><p>ç»§ç»­åˆ†æActivityStackSupervisor.reportResumedActivityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStackSupervisor.java]</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">reportResumedActivityLocked</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = r.task.stack;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (allResumedActivitiesComplete()) &#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">        mWindowManager.executeAppTransition();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯Activityç»„ä»¶çš„å¯è§æ€§è®¾ç½®ï¼Œç„¶åæ‰§è¡ŒexecuteAppTransition()</p><h3 id="5-3-1-WindowManagerService-executeAppTransition"><a href="#5-3-1-WindowManagerService-executeAppTransition" class="headerlink" title="5.3.1.WindowManagerService.executeAppTransition()"></a>5.3.1.WindowManagerService.executeAppTransition()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeAppTransition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ......</span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAppTransition.isTransitionSet()) &#123;</span><br><span class="line">                mAppTransition.setReady();</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mWindowPlacerLocked.performSurfacePlacement();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è€ŒWindowSurfacePlacer.performSurfacePlacement()è¯·çœ‹å‰é¢ç¬¬äºŒèŠ‚åˆ†æ</p><h2 id="ï¼ˆå…­ï¼‰ã€Activity-Window-åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹"><a href="#ï¼ˆå…­ï¼‰ã€Activity-Window-åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Activity Window åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹"></a>ï¼ˆå…­ï¼‰ã€Activity Window åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹</h2><h3 id="6-1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"><a href="#6-1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹" class="headerlink" title="6.1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"></a>6.1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹</h3><p>åœ¨Androidç³»ç»Ÿä¸­ï¼Œçª—å£åŠ¨ç”»çš„æœ¬è´¨å°±æ˜¯å¯¹åŸå§‹çª—å£æ–½åŠ ä¸€ä¸ªå˜æ¢ï¼ˆTransformationï¼‰ã€‚åœ¨çº¿æ€§æ•°å­¦ä¸­ï¼Œå¯¹ç‰©ä½“çš„å½¢çŠ¶è¿›è¡Œå˜æ¢æ˜¯é€šè¿‡ä¹˜ä»¥ä¸€ä¸ªçŸ©é˜µï¼ˆMatrixï¼‰æ¥å®ç°ï¼Œç›®çš„å°±æ˜¯å¯¹ç‰©ä½“è¿›è¡Œåç§»ã€æ—‹è½¬ã€ç¼©æ”¾ã€åˆ‡å˜ã€åå°„å’ŒæŠ•å½±ç­‰ã€‚å› æ­¤ï¼Œç»™çª—å£è®¾ç½®åŠ¨ç”»å®é™…ä¸Šå°±ç»™çª—å£è®¾ç½®ä¸€ä¸ªå˜æ¢çŸ©é˜µï¼ˆTransformation Matrixï¼‰ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/17-Android-WMS-Transformation-matrix.png" alt="Markdown"></p><p>çª—å£è¢«è®¾ç½®çš„åŠ¨ç”»è™½ç„¶å¯ä»¥è¾¾åˆ°ä¸‰ä¸ªï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªåŠ¨ç”»å¯ä»¥å½’ç»“ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æ™®é€šåŠ¨ç”»ï¼Œä¾‹å¦‚ï¼Œçª—å£åœ¨æ‰“å¼€è¿‡ç¨‹ä¸­è¢«è®¾ç½®çš„è¿›å…¥åŠ¨ç”»å’Œåœ¨å…³é—­è¿‡ç¨‹ä¸­è¢«è®¾ç½®çš„é€€å‡ºåŠ¨ç”»ï¼Œå¦ä¸€ç±»æ˜¯åˆ‡æ¢åŠ¨ç”»ã€‚å…¶ä¸­ï¼ŒSelf Transformationå’ŒAttached Transformationéƒ½æ˜¯å±äºæ™®é€šåŠ¨ç”»ï¼Œè€ŒApp Transformationå±äºåˆ‡æ¢åŠ¨ç”»ã€‚å‰é¢å·²ç»åˆ†æè¿‡App Transformationçš„è®¾ç½®è¿‡ç¨‹ æ¥ä¸‹æ¥åˆ†ææ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹ã€‚</p><h3 id="6-1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"><a href="#6-1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹" class="headerlink" title="6.1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"></a>6.1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹</h3><p>æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹ä¹Ÿæ˜¯é€šè¿‡setTokenVisibilityLocked()è®¾ç½®çš„</p><h3 id="6-1-1ã€WindowManagerService-setTokenVisibilityLocked"><a href="#6-1-1ã€WindowManagerService-setTokenVisibilityLocked" class="headerlink" title="6.1.1ã€WindowManagerService.setTokenVisibilityLocked()"></a>6.1.1ã€WindowManagerService.setTokenVisibilityLocked()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    boolean setTokenVisibilityLocked(AppWindowToken wtoken, WindowManager.LayoutParams lp,</span><br><span class="line">            boolean visible, int transit, boolean performLayout, boolean isVoiceInteraction) &#123;</span><br><span class="line">        ......</span><br><span class="line">        if (wtoken.hidden == visible || (wtoken.hidden &amp;&amp; wtoken.mIsExiting) ||</span><br><span class="line">                (visible &amp;&amp; wtoken.waitingForReplacement())) &#123;</span><br><span class="line">           ......</span><br><span class="line">            if (transit != AppTransition.TRANSIT_UNSET) &#123;</span><br><span class="line">                ......</span><br><span class="line">                if (applyAnimationLocked(wtoken, lp, transit, visible, isVoiceInteraction)) &#123;</span><br><span class="line">                    delayed = runningAppAnimation = true;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                changed = true;</span><br><span class="line">            &#125;</span><br><span class="line">            final int windowsCount = wtoken.allAppWindows.size();</span><br><span class="line">            for (int i = 0; i &lt; windowsCount; i++) &#123;</span><br><span class="line">                WindowState win = wtoken.allAppWindows.get(i);</span><br><span class="line">                ......</span><br><span class="line">                if (visible) &#123;</span><br><span class="line">                    if (!win.isVisibleNow()) &#123;</span><br><span class="line">                        if (!runningAppAnimation) &#123;</span><br><span class="line">                            win.mWinAnimator.applyAnimationLocked(</span><br><span class="line">                                    WindowManagerPolicy.TRANSIT_ENTER, true);</span><br><span class="line">                            ......</span><br><span class="line">                        &#125;</span><br><span class="line">                        changed = true;</span><br><span class="line">                        win.setDisplayLayoutNeeded();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (win.isVisibleNow()) &#123;</span><br><span class="line">                    if (!runningAppAnimation) &#123;</span><br><span class="line">                        win.mWinAnimator.applyAnimationLocked(</span><br><span class="line">                                WindowManagerPolicy.TRANSIT_EXIT, false);</span><br><span class="line">                        ......</span><br><span class="line">                    &#125;</span><br><span class="line">                    changed = true;</span><br><span class="line">                    win.setDisplayLayoutNeeded();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            wtoken.hidden = wtoken.hiddenRequested = !visible;</span><br><span class="line">            visibilityChanged = true;</span><br><span class="line">            ......</span><br><span class="line">            if (changed) &#123;</span><br><span class="line">                mInputMonitor.setUpdateInputWindowsNeededLw();</span><br><span class="line">                if (performLayout) &#123;</span><br><span class="line">                    updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,</span><br><span class="line">                            false /*updateInputWindows*/);</span><br><span class="line">                    mWindowPlacerLocked.performSurfacePlacement();</span><br><span class="line">                &#125;</span><br><span class="line">                mInputMonitor.updateInputWindowsLw(false /*force*/);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ™®é€šåŠ¨ç”»æ˜¯é€šè¿‡win.mWinAnimator.applyAnimationLocked(WindowManagerPolicy.TRANSIT_ENTER, true)</p><h3 id="6-1-1-WindowStateAnimator-applyAnimationLocked"><a href="#6-1-1-WindowStateAnimator-applyAnimationLocked" class="headerlink" title="6.1.1.WindowStateAnimator.applyAnimationLocked()"></a>6.1.1.WindowStateAnimator.applyAnimationLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">applyAnimationLocked</span><span class="params">(<span class="keyword">int</span> transit, <span class="keyword">boolean</span> isEntrance)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mService.okToDisplay()) &#123;</span><br><span class="line">        <span class="keyword">int</span> anim = mPolicy.selectAnimationLw(mWin, transit);</span><br><span class="line">        <span class="keyword">int</span> attr = -<span class="number">1</span>;</span><br><span class="line">        Animation a = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (anim != <span class="number">0</span>) &#123;</span><br><span class="line">            a = anim != -<span class="number">1</span> ? AnimationUtils.loadAnimation(mContext, anim) : <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (transit) &#123;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerPolicy.TRANSIT_ENTER:</span><br><span class="line">                    attr = com.android.internal.R.styleable.WindowAnimation_windowEnterAnimation;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerPolicy.TRANSIT_EXIT:</span><br><span class="line">                    attr = com.android.internal.R.styleable.WindowAnimation_windowExitAnimation;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerPolicy.TRANSIT_SHOW:</span><br><span class="line">                    attr = com.android.internal.R.styleable.WindowAnimation_windowShowAnimation;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerPolicy.TRANSIT_HIDE:</span><br><span class="line">                    attr = com.android.internal.R.styleable.WindowAnimation_windowHideAnimation;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (attr &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                a = mService.mAppTransition.loadAnimationAttr(mWin.mAttrs, attr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">            setAnimation(a);</span><br><span class="line">            mAnimationIsEntrance = isEntrance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clearAnimation();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> mAnimation != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯æ ¹æ®åŠ¨ç”»ç±»å‹ä»è€Œé€šè¿‡AppTransition.loadAnimationAttr(mWin.mAttrs, attr)åŠ è½½ä¸åŒçš„anim xmlæ–‡ä»¶ã€‚</p><h3 id="6-2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶"><a href="#6-2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶" class="headerlink" title="6.2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶"></a>6.2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/19-Android-WMS-animationLocked.png" alt="Markdown"><br>é€šè¿‡å †æ ˆä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œç”±Vsyncä¿¡å·é©±åŠ¨ï¼Œç„¶åè°ƒç”¨Choreographer.doFrameå®ŒæˆåŠ¨ç”»çš„ç›¸å…³æ“ä½œï¼Œå…³äºVsyncè¿™éƒ¨åˆ†ä¹‹å‰æ–‡ç« å·²ç»åˆ†æè¿‡ï¼Œè¿™é‡Œä¸å†åˆ†æäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line"><span class="comment">/** Locked on mService.mWindowMap. */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">animateLocked</span><span class="params">(<span class="keyword">long</span> frameTimeNs)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mCurrentTime = frameTimeNs / TimeUtils.NANOS_PER_MS;</span><br><span class="line">    mBulkUpdateParams = SET_ORIENTATION_CHANGE_COMPLETE;</span><br><span class="line">    <span class="keyword">boolean</span> wasAnimating = mAnimating;</span><br><span class="line">    setAnimating(<span class="keyword">false</span>);</span><br><span class="line">    mAppWindowAnimating = <span class="keyword">false</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">            TAG, <span class="string">"&gt;&gt;&gt; OPEN TRANSACTION animateLocked"</span>);</span><br><span class="line">    SurfaceControl.openTransaction();</span><br><span class="line">    SurfaceControl.setAnimationTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mDisplayContentsAnimators.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDisplays; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplayContentsAnimators.keyAt(i);</span><br><span class="line">            <span class="comment">//1ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</span></span><br><span class="line">            updateAppWindowsLocked(displayId);</span><br><span class="line">            DisplayContentsAnimator displayAnimator = mDisplayContentsAnimators.valueAt(i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ScreenRotationAnimation screenRotationAnimation =</span><br><span class="line">                    displayAnimator.mScreenRotationAnimation;</span><br><span class="line">            <span class="keyword">if</span> (screenRotationAnimation != <span class="keyword">null</span> &amp;&amp; screenRotationAnimation.isAnimating()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (screenRotationAnimation.stepAnimationLocked(mCurrentTime)) &#123;</span><br><span class="line">                    setAnimating(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mBulkUpdateParams |= SET_UPDATE_ROTATION;</span><br><span class="line">                    screenRotationAnimation.kill();</span><br><span class="line">                    displayAnimator.mScreenRotationAnimation = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//TODO (multidisplay): Accessibility supported only for the default display.</span></span><br><span class="line">                    <span class="keyword">if</span> (mService.mAccessibilityController != <span class="keyword">null</span></span><br><span class="line">                            &amp;&amp; displayId == Display.DEFAULT_DISPLAY) &#123;</span><br><span class="line">                        <span class="comment">// We just finished rotation animation which means we did not</span></span><br><span class="line">                        <span class="comment">// anounce the rotation and waited for it to end, announce now.</span></span><br><span class="line">                        mService.mAccessibilityController.onRotationChangedLocked(</span><br><span class="line">                                mService.getDefaultDisplayContentLocked(), mService.mRotation);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update animations of all applications, including those</span></span><br><span class="line">            <span class="comment">// associated with exiting/removed apps</span></span><br><span class="line">            <span class="comment">//2ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</span></span><br><span class="line">            updateWindowsLocked(displayId);</span><br><span class="line">            <span class="comment">//å£çº¸åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</span></span><br><span class="line">            updateWallpaperLocked(displayId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> WindowList windows = mService.getWindowListLocked(displayId);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = windows.size();</span><br><span class="line">            <span class="comment">//3ã€é€šè¿‡ä¸€ä¸ªforå¾ªç¯æ¥éå†ä¿å­˜åœ¨çª—å£å †æ ˆçš„æ¯ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªçª—å£çš„ç»˜å›¾è¡¨é¢è¿›è¡Œæ›´æ–°</span></span><br><span class="line">            <span class="comment">//ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++) &#123;</span><br><span class="line">                windows.get(j).mWinAnimator.prepareSurfaceLocked(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDisplays; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplayContentsAnimators.keyAt(i);</span><br><span class="line"></span><br><span class="line">            testTokenMayBeDrawnLocked(displayId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ScreenRotationAnimation screenRotationAnimation =</span><br><span class="line">                    mDisplayContentsAnimators.valueAt(i).mScreenRotationAnimation;</span><br><span class="line">            <span class="keyword">if</span> (screenRotationAnimation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                screenRotationAnimation.updateSurfacesInTransaction();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            orAnimating(mService.getDisplayContentLocked(displayId).animateDimLayers());</span><br><span class="line">            orAnimating(mService.getDisplayContentLocked(displayId).getDockedDividerController()</span><br><span class="line">                    .animate(mCurrentTime));</span><br><span class="line">            <span class="comment">//TODO (multidisplay): Magnification is supported only for the default display.</span></span><br><span class="line">            <span class="keyword">if</span> (mService.mAccessibilityController != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; displayId == Display.DEFAULT_DISPLAY) &#123;</span><br><span class="line">                mService.mAccessibilityController.drawMagnifiedRegionBorderIfNeededLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//4ã€è§¦å‘ä¸‹ä¸€å¸§åŠ¨ç”»é€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> (mAnimating) &#123;</span><br><span class="line">            mService.scheduleAnimationLocked();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mService.mWatermark != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mService.mWatermark.drawIfNeeded();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SurfaceControl.closeTransaction();</span><br><span class="line">        <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">                TAG, <span class="string">"&lt;&lt;&lt; CLOSE TRANSACTION animateLocked"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasPendingLayoutChanges = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mService.mDisplayContents.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = <span class="number">0</span>; displayNdx &lt; numDisplays; ++displayNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> DisplayContent displayContent = mService.mDisplayContents.valueAt(displayNdx);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pendingChanges = getPendingLayoutChanges(displayContent.getDisplayId());</span><br><span class="line">        <span class="keyword">if</span> ((pendingChanges &amp; WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER) != <span class="number">0</span>) &#123;</span><br><span class="line">            mBulkUpdateParams |= SET_WALLPAPER_ACTION_PENDING;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pendingChanges != <span class="number">0</span>) &#123;</span><br><span class="line">            hasPendingLayoutChanges = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> doRequest = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mBulkUpdateParams != <span class="number">0</span>) &#123;</span><br><span class="line">        doRequest = mWindowPlacerLocked.copyAnimToLayoutParamsLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5ã€åˆ·æ–°ç³»ç»ŸUI</span></span><br><span class="line">    <span class="keyword">if</span> (hasPendingLayoutChanges || doRequest) &#123;</span><br><span class="line">        mWindowPlacerLocked.requestTraversal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mRemoveReplacedWindows) &#123;</span><br><span class="line">        removeReplacedWindowsLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.stopUsingSavedSurfaceLocked();</span><br><span class="line">    mService.destroyPreservedSurfaceLocked();</span><br><span class="line">    mService.mWindowPlacerLocked.destroyPendingSurfaces();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»çš„æ¨è¿›ã€ 2ã€çª—å£åŠ¨ç”»çš„æ¨è¿›ã€å£çº¸åŠ¨ç”»æ¨è¿› 3ã€å¾ªç¯éå†ä¿å­˜åœ¨çª—å£å †æ ˆçš„æ¯ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªçª—å£çš„ç»˜å›¾è¡¨é¢è¿›è¡Œæ›´æ–° ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯ 4ã€è§¦å‘ä¸‹ä¸€å¸§åŠ¨ç”»é€»è¾‘ 5ã€åˆ·æ–°ç³»ç»ŸUI å…¶ä¸­ç¬¬3ç‚¹ prepareSurfaceLockedåœ¨3.3.å°èŠ‚å·²ç»åˆ†æè¿‡äº†ã€ç¬¬5ç‚¹æœ€ç»ˆä¼šè°ƒç”¨mWindowPlacerLocked.performSurfacePlacementæ¥åˆ·æ–°UIï¼Œä¹Ÿå·²ç»åˆ†æè¿‡äº†ã€‚ æ¥ä¸‹æ¥åˆ†æActivityç»„ä»¶åˆ‡æ¢åŠ¨ç”»ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹ã€‚</p><h3 id="6-3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»"><a href="#6-3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»" class="headerlink" title="6.3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»"></a>6.3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»</h3><p>AppWindowAnimator:å±äºAppWindowTokenï¼Œå®ƒçš„æˆå‘˜å˜é‡mAppAnimatorä»£è¡¨äº†æ­¤åº”ç”¨ç¨‹åºæ‰€å±çš„AppWindowAnimator WindowStateAnimator:WMSè®°å½•äº†æ‰€æœ‰çª—å£çš„WindowStateï¼Œå…¶ä¸­WindowState.mWinAnimatoræ˜¯ä¸€ä¸ªWindowStateAnimatorå¯¹è±¡ï¼Œå®ƒå’Œä¸Šé¢AppWindowAnimatorä¸€æ ·å¯ä»¥ç”±å¼€å‘äººå‘˜å®šåˆ¶</p><p>WindowAnimator.updateAppWindowsLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateAppWindowsLocked</span><span class="params">(<span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;TaskStack&gt; stacks = mService.getDisplayContentLocked(displayId).getStacks();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> TaskStack stack = stacks.get(stackNdx);</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;Task&gt; tasks = stack.getTasks();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = tasks.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> AppTokenList tokens = tasks.get(taskNdx).mAppTokens;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> tokenNdx = tokens.size() - <span class="number">1</span>; tokenNdx &gt;= <span class="number">0</span>; --tokenNdx) &#123;</span><br><span class="line">                <span class="keyword">final</span> AppWindowAnimator appAnimator = tokens.get(tokenNdx).mAppAnimator;</span><br><span class="line">                appAnimator.wasAnimating = appAnimator.animating;</span><br><span class="line">                <span class="keyword">if</span> (appAnimator.stepAnimationLocked(mCurrentTime, displayId)) &#123;</span><br><span class="line">                    appAnimator.animating = <span class="keyword">true</span>;</span><br><span class="line">                    setAnimating(<span class="keyword">true</span>);</span><br><span class="line">                    mAppWindowAnimating = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (appAnimator.wasAnimating) &#123;</span><br><span class="line">                    <span class="comment">// stopped animating, do one more pass through the layout</span></span><br><span class="line">                    setAppLayoutChanges(appAnimator,</span><br><span class="line">                            WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER,</span><br><span class="line">                            <span class="string">"appToken "</span> + appAnimator.mAppToken + <span class="string">" done"</span>, displayId);</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨stepAnimationLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;AppWindowAnimator.java]</span><br><span class="line">    <span class="comment">// This must be called while inside a transaction.</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">stepAnimationLocked</span><span class="params">(<span class="keyword">long</span> currentTime, <span class="keyword">final</span> <span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mService.okToDisplay()) &#123;</span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((mAppToken.allDrawn || animating || mAppToken.startingDisplayed)</span><br><span class="line">                    &amp;&amp; animation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (stepAnimation(currentTime)) &#123;</span><br><span class="line">                    <span class="comment">// animation isn't over, step any thumbnail and that's</span></span><br><span class="line">                    <span class="comment">// it for now.</span></span><br><span class="line">                    <span class="keyword">if</span> (thumbnail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        stepThumbnailAnimation(currentTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            animating = <span class="keyword">true</span>;</span><br><span class="line">            animation = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨stepAnimation()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;AppWindowAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stepAnimation</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (animation == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    transformation.clear();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> animationFrameTime = getAnimationFrameTime(animation, currentTime);</span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="keyword">boolean</span> hasMoreFrames = animation.getTransformation(animationFrameTime, transformation);</span><br><span class="line">    <span class="keyword">if</span> (!hasMoreFrames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deferThumbnailDestruction &amp;&amp; !deferFinalFrameCleanup) &#123;</span><br><span class="line">            deferFinalFrameCleanup = <span class="keyword">true</span>;</span><br><span class="line">            hasMoreFrames = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            deferFinalFrameCleanup = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mProlongAnimation == PROLONG_ANIMATION_AT_END) &#123;</span><br><span class="line">                hasMoreFrames = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setNullAnimation();</span><br><span class="line">                clearThumbnail();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    hasTransformation = hasMoreFrames;</span><br><span class="line">    <span class="keyword">return</span> hasMoreFrames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1.å°†æˆå‘˜å˜é‡transformationæ‰€æè¿°çš„å˜æ¢çŸ©é˜µçš„æ•°æ®æ¸…ç©º 2.è°ƒç”¨Animation.getTransformation()æ¥è®¡ç®—Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»ä¸‹ä¸€æ­¥æ‰€å¯¹åº”çš„å˜æ¢çŸ©é˜µï¼Œå¹¶ä¸”å°†è¿™ä¸ªå˜æ¢çŸ©é˜µçš„æ•°æ®ä¿å­˜åœ¨æˆå‘˜å˜é‡transformation</p><h3 id="6-4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹"><a href="#6-4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹" class="headerlink" title="6.4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹"></a>6.4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</h3><p>ç»§ç»­åˆ†æWindowAnimator.animateLocked()çš„updateWindowsLocked()</p><h3 id="6-4-1ã€WindowAnimator-updateWindowsLocked"><a href="#6-4-1ã€WindowAnimator-updateWindowsLocked" class="headerlink" title="6.4.1ã€WindowAnimator.updateWindowsLocked()"></a>6.4.1ã€WindowAnimator.updateWindowsLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateWindowsLocked</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">    ++mAnimTransactionSequence;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> WindowList windows = mService.getWindowListLocked(displayId);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = windows.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        WindowState win = windows.get(i);</span><br><span class="line">        WindowStateAnimator winAnimator = win.mWinAnimator;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = win.mAttrs.flags;</span><br><span class="line">        <span class="keyword">boolean</span> canBeForceHidden = mPolicy.canBeForceHidden(win, win.mAttrs);</span><br><span class="line">        <span class="keyword">boolean</span> shouldBeForceHidden = shouldForceHide(win);</span><br><span class="line">        <span class="keyword">if</span> (winAnimator.hasSurface()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> wasAnimating = winAnimator.mWasAnimating;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> nowAnimating = winAnimator.stepAnimationLocked(mCurrentTime);</span><br><span class="line">            winAnimator.mWasAnimating = nowAnimating;</span><br><span class="line">            orAnimating(nowAnimating);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WindowStateAnimator.stepAnimationLocked() å¦‚æœçª—å£çš„åŠ¨ç”»å°šæœªç»“æŸæ˜¾ç¤ºï¼Œé‚£ä¹ˆstepAnimationLocked()ä¼šè¿”å›ä¸€ä¸ªtrueå€¼ç»™è°ƒç”¨è€…ï¼Œå¦åˆ™çš„è¯ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªfalseå€¼ç»™è°ƒç”¨è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">stepAnimationLocked</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Save the animation state as it was before this step so WindowManagerService can tell if</span></span><br><span class="line">        <span class="comment">// we just started or just stopped animating by comparing mWasAnimating with isAnimationSet().</span></span><br><span class="line">        mWasAnimating = mAnimating;</span><br><span class="line">        <span class="keyword">final</span> DisplayContent displayContent = mWin.getDisplayContent();</span><br><span class="line">        <span class="keyword">if</span> (displayContent != <span class="keyword">null</span> &amp;&amp; mService.okToDisplay()) &#123;</span><br><span class="line">            <span class="comment">// We will run animations as long as the display isn't frozen.</span></span><br><span class="line">            <span class="keyword">if</span> (mWin.isDrawnLw() &amp;&amp; mAnimation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mHasTransformation = <span class="keyword">true</span>;</span><br><span class="line">                mHasLocalTransformation = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (!mLocalAnimating) &#123;</span><br><span class="line">                    <span class="keyword">final</span> DisplayInfo displayInfo = displayContent.getDisplayInfo();</span><br><span class="line">                    <span class="keyword">if</span> (mAnimateMove) &#123;</span><br><span class="line">                        mAnimateMove = <span class="keyword">false</span>;</span><br><span class="line">                        mAnimation.initialize(mWin.mFrame.width(), mWin.mFrame.height(),</span><br><span class="line">                                mAnimDx, mAnimDy);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mAnimation.initialize(mWin.mFrame.width(), mWin.mFrame.height(),</span><br><span class="line">                                displayInfo.appWidth, displayInfo.appHeight);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mAnimDx = displayInfo.appWidth;</span><br><span class="line">                    mAnimDy = displayInfo.appHeight;</span><br><span class="line">                    mAnimation.setStartTime(mAnimationStartTime != -<span class="number">1</span></span><br><span class="line">                            ? mAnimationStartTime</span><br><span class="line">                            : currentTime);</span><br><span class="line">                    mLocalAnimating = <span class="keyword">true</span>;</span><br><span class="line">                    mAnimating = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((mAnimation != <span class="keyword">null</span>) &amp;&amp; mLocalAnimating) &#123;</span><br><span class="line">                    mLastAnimationTime = currentTime;</span><br><span class="line">                    <span class="keyword">if</span> (stepAnimation(currentTime)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stepAnimation</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    currentTime = getAnimationFrameTime(mAnimation, currentTime);</span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    mTransformation.clear();</span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> more = mAnimation.getTransformation(currentTime, mTransformation);</span><br><span class="line">    <span class="keyword">if</span> (mAnimationStartDelayed &amp;&amp; mAnimationIsEntrance) &#123;</span><br><span class="line">        mTransformation.setAlpha(<span class="number">0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> more;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€å°†æˆå‘˜å˜é‡mTransformationæ‰€æè¿°çš„å˜æ¢çŸ©é˜µçš„æ•°æ®æ¸…ç©ºã€‚ 2ã€è°ƒç”¨mAnimation.getTransformation()æ¥è®¡ç®—çª—å£åŠ¨ç”»ä¸‹ä¸€æ­¥æ‰€å¯¹åº”çš„å˜æ¢çŸ©é˜µï¼Œå¹¶ä¸”å°†è¿™ä¸ªå˜æ¢çŸ©é˜µçš„æ•°æ®ä¿å­˜åœ¨æˆå‘˜å˜é‡mTransformationã€‚</p><p>ç„¶åå°±æ˜¯åŠ¨ç”»è¿‡åï¼Œçª—å£å¤§å°è®¡ç®—ã€æ¸²æŸ“åˆæˆç­‰ç­‰æ˜¾ç¤ºæ­¥éª¤äº†ï¼Œç”±äºä¹‹å‰å·²ç»åˆ†æè¿‡äº†ï¼Œä¸å†åˆ†æäº†ï¼š 3ã€å¾ªç¯éå†ä¿å­˜åœ¨çª—å£å †æ ˆçš„æ¯ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªçª—å£çš„ç»˜å›¾è¡¨é¢è¿›è¡Œæ›´æ–° ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java::animateLocked()]</span><br><span class="line"><span class="comment">//ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++) &#123;</span><br><span class="line">    windows.get(j).mWinAnimator.prepareSurfaceLocked(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4ã€è§¦å‘ä¸‹ä¸€å¸§åŠ¨ç”»é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java::animateLocked()]</span><br><span class="line"><span class="keyword">if</span> (mAnimating) &#123;</span><br><span class="line">    mService.scheduleAnimationLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5ã€åˆ·æ–°ç³»ç»ŸUI</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java::animateLocked()]</span><br><span class="line"><span class="keyword">if</span> (hasPendingLayoutChanges || doRequest) &#123;</span><br><span class="line">    mWindowPlacerLocked.requestTraversal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç»è¿‡SurfaceFlingeråˆæˆæ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚ æ€»ä½“æµç¨‹å›¾(â€¦)ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/20-Android-WMS-animation_Locked-time-diagram.png" alt="Markdown"></p><h2 id="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h2><p><a href="https://www.bbsmax.com/A/n2d9gjgJDv/" target="_blank" rel="noopener">æµ…æ Android çš„çª—å£</a><br><a href="https://www.jianshu.com/p/2faedc664d11" target="_blank" rel="noopener">WMS:çª—å£å¤§å°çš„è®¡ç®—</a><br><a href="http://blog.csdn.net/luozirong/article/details/70256809" target="_blank" rel="noopener">Android çª—å£çš„è®¡ç®—è¿‡ç¨‹</a><br><a href="http://blog.csdn.net/qian520ao/article/details/78555397" target="_blank" rel="noopener">Android Window æœºåˆ¶æ¢ç´¢</a><br><a href="https://calvinlee.github.io/blog/2012/04/21/android-window-management-architecture/" target="_blank" rel="noopener">Android çª—å£ç®¡ç† - ä¸”å¬é£åŸ</a><br><a href="http://www.cnblogs.com/all-for-fiona/p/4054527.html" target="_blank" rel="noopener">Android å…³äºWindow Overscan</a><br><a href="http://blog.csdn.net/guoqifa29/article/details/49273065" target="_blank" rel="noopener">WindowManagerServiceåŠ¨ç”»åˆ†æ</a><br><a href="http://blog.csdn.net/guoqifa29/article/details/46819377" target="_blank" rel="noopener">æ·±å…¥ç†è§£Activityâ€”-Tokenä¹‹æ—… - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/37737439" target="_blank" rel="noopener">Android 4.4(KitKat)çª—å£ç®¡ç†å­ç³»ç»Ÿ - ä½“ç³»æ¡†æ¶</a><br><a href="https://www.jianshu.com/p/c2e48b3e33a0" target="_blank" rel="noopener">Androidçª—å£ç³»ç»Ÿç¬¬å››ç¯‡â€”ActivityåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹</a><br><a href="http://blog.csdn.net/lin20044140410/article/details/78798048" target="_blank" rel="noopener">Android 7.1 GUIç³»ç»Ÿ-çª—å£ç®¡ç†WMS-Surfaceç®¡ç†ï¼ˆå››ï¼‰</a><br><a href="http://www.cnblogs.com/samchen2009/p/3367496.html" target="_blank" rel="noopener">Android çš„çª—å£ç®¡ç†ç³»ç»Ÿ (View, Canvas, WindowManager)</a><br><a href="http://gityuan.com/2017/01/15/wms_starting_window/" target="_blank" rel="noopener">WMSâ€“å¯åŠ¨çª—å£(StartingWindow) - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢</a><br><a href="https://www.jianshu.com/p/a65861e946cb" target="_blank" rel="noopener">Viewç»˜åˆ¶æµç¨‹åŠæºç è§£æ(ä¸€)â€”-performTraversals()æºç åˆ†æ</a><br><a href="http://blog.csdn.net/u013263323/article/details/78482141" target="_blank" rel="noopener">Androidçª—å£ç³»ç»Ÿç¬¬ä¸‰ç¯‡â€”WindowManagerServiceä¸­çª—å£çš„ç»„ç»‡æ–¹å¼</a><br><a href="https://juejin.im/entry/58c899bea22b9d006411241c" target="_blank" rel="noopener">google è¿›å…¥åˆ†å±ååœ¨æ¨ªå±æ¨¡å¼æŒ‰ home é”®ç•Œé¢é”™ä¹± (äºŒ) - Android - æ˜é‡‘</a><br><a href="http://blog.csdn.net/yanbober/article/details/46361191" target="_blank" rel="noopener">Androidåº”ç”¨Activityã€Dialogã€PopWindowã€Toastçª—å£æ·»åŠ æœºåˆ¶åŠæºç åˆ†æ</a><br><a href="http://blog.csdn.net/luoshengyang/article/details/8462738" target="_blank" rel="noopener">Androidçª—å£ç®¡ç†æœåŠ¡WindowManagerServiceçš„ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ - CSDNåšå®¢</a><br><a href="https://www.jianshu.com/p/40776c123adb" target="_blank" rel="noopener">Androidçª—å£ç®¡ç†åˆ†æï¼ˆ2ï¼‰ï¼šWindowManagerServiceçª—å£ç®¡ç†ä¹‹Windowæ·»åŠ æµç¨‹</a><br><a href="http://blog.csdn.net/luoshengyang/article/details/8611754" target="_blank" rel="noopener">Androidçª—å£ç®¡ç†æœåŠ¡WindowManagerServiceæ˜¾ç¤ºçª—å£åŠ¨ç”»çš„åŸç†åˆ†æ - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/kc58236582/article/details/53782138" target="_blank" rel="noopener">Android6.0 WMSï¼ˆäº”ï¼‰ WMSè®¡ç®—Activityçª—å£å¤§å°çš„è¿‡ç¨‹åˆ†æï¼ˆäºŒï¼‰WMSçš„relayoutWindow</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;çª—å£ç®¡ç†ç³»ç»ŸWMSæ˜¯Androidä¸­çš„ä¸»è¦å­ç³»ç»Ÿä¹‹ä¸€ï¼Œå®ƒæ¶‰åŠåˆ°Appä¸­ç»„ä»¶çš„ç®¡ç†ï¼Œç³»ç»Ÿå’Œåº”ç”¨çª—å£çš„ç®¡ç†å’Œç»˜åˆ¶ç­‰å·¥ä½œã€‚ç”±äºå…¶æ¶‰åŠæ¨¡å—ä¼—å¤šï¼Œä¸”ä¸ç”¨æˆ·ä½“éªŒå¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯Androidå½“ä¸­æœ€ä¸ºå¤æ‚çš„å­ç³»ç»Ÿä¹‹ä¸€ã€‚ä¸€ä¸ªAppä»å¯åŠ¨åˆ°ä¸»çª—å£æ˜¾ç¤ºå‡ºæ¥ï¼Œéœ€è¦Appï¼ŒActivityManagerServiceï¼ˆAMSï¼‰ï¼ŒWindowManagerServiceï¼ˆWMSï¼‰ï¼ŒSurfaceFlingerï¼ˆSFï¼‰ç­‰å‡ ä¸ªæ¨¡å—ç›¸äº’åˆä½œã€‚Appè´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œç»˜åˆ¶è‡ªå·±çš„è§†å›¾ï¼›AMSç®¡ç†ç»„ä»¶ã€è¿›ç¨‹ä¿¡æ¯å’ŒActivityçš„å †æ ˆåŠçŠ¶æ€ç­‰ç­‰ï¼›WMSç®¡ç†Activityå¯¹åº”çš„çª—å£åŠå­çª—å£ï¼Œè¿˜æœ‰ç³»ç»Ÿçª—å£ç­‰ï¼›SFç”¨äºç®¡ç†å›¾å½¢ç¼“å†²åŒºï¼Œå°†Appç»˜åˆ¶çš„ä¸œè¥¿åˆæˆæ¸²æŸ“åœ¨å±å¹•ä¸Šã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]</title>
    <link href="http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/"/>
    <id>http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-ç³»ç»Ÿåˆ†æ/</id>
    <published>2018-01-31T16:00:00.000Z</published>
    <updated>2018-04-19T14:30:01.581Z</updated>
    
    <content type="html"><![CDATA[<p>Androidç³»ç»Ÿå›¾å½¢æ¡†æ¶ç”±ä¸‹å¾€ä¸Šä¸»è¦çš„åŒ…æ‹¬HAL(HWComposerå’ŒGrallocä¸¤ä¸ªmoudle)ï¼ŒSurfaceFlingerï¼ˆBufferQueueçš„æ¶ˆè´¹è€…ï¼‰ï¼ŒWindowManagerServiceï¼ˆçª—å£ç®¡ç†è€…ï¼‰ï¼ŒViewï¼ˆBufferQueueçš„ç”Ÿäº§è€…ï¼‰å››å¤§æ¨¡å—ã€‚<br>â— HAL: åŒ…æ‹¬HWComposerå’ŒGrallocä¸¤ä¸ªmoudleï¼ŒAndroid Nä¸Šç”±SurfaceFlingeræ‰“å¼€ï¼Œå› æ­¤åœ¨åŒä¸€è¿›ç¨‹ã€‚ gralloc ç”¨äºBufferQueueçš„å†…å­˜åˆ†é…ï¼ŒåŒæ—¶ä¹Ÿæœ‰fbçš„æ˜¾ç¤ºæ¥å£ï¼ŒHWComposerä½œä¸ºåˆæˆSurfaceFlingeré‡Œé¢çš„Layerï¼Œå¹¶æ˜¾ç¤ºï¼ˆé€šè¿‡grallocçš„postå‡½æ•°ï¼‰<br>â— SurfaceFlingerå¯ä»¥å«åšLayerFlingerï¼Œä½œä¸ºLayerçš„ç®¡ç†è€…ï¼ŒåŒæ˜¯ä¹Ÿæ˜¯BufferQueueçš„æ¶ˆè´¹è€…ï¼Œå½“æ¯ä¸ªLayerçš„ç”Ÿäº§è€…drawå®Œå®Œæ•´çš„ä¸€å¸§æ—¶ï¼Œä¼šé€šçŸ¥SurfaceFlingerï¼Œé€šçŸ¥çš„æ–¹å¼é‡‡ç”¨BufferQueueã€‚<br>â— WindowManagerService: ä½œä¸ºWindowçš„ç®¡ç†è€…ï¼ŒæŒç®¡ç€è®¡ç®—çª—å£å¤§å°ï¼Œçª—å£åˆ‡æ¢ç­‰ä»»åŠ¡ï¼ŒåŒæ—¶ä¹Ÿä¼šå°†ç›¸åº”çš„å‚æ•°è®¾ç½®ç»™SurfaceFlingerï¼Œæ¯”å¦‚Windowçš„åœ¨z-orderï¼Œå’Œçª—å£çš„å¤§å°ã€‚<br>â— View: ä½œä¸ºBufferQueueçš„ç”Ÿäº§è€…ï¼Œæ¯å½“æ‰§è¡ŒlockCanvas-&gt;draw-&gt;unlockCanvasï¼Œä¹‹åä¼šå­˜å…¥ä¸€å¸§æ•°æ®è¿›å…¥BufferQueueä¸­ã€‚ å˜¿å˜¿(<em>^â–½^</em>),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚ <a id="more"></a></p><h2 id="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"><a href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘" class="headerlink" title="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.graphics" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></h2><h2 id="æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"><a href="#æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š" class="headerlink" title="æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"></a>æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</h2><p><strong>/frameworks/native/services/surfaceflinger/</strong></p><ul><li>tests/Transaction_test.cpp</li><li>tests/vsync/vsync.cpp</li></ul><p><strong>/frameworks/native/include/gui/</strong></p><ul><li>BitTube.h</li><li>BufferSlot.h</li><li>BufferQueueCore.h</li><li>BufferQueueProducer.h</li></ul><p><strong>/frameworks/base/core/java/android/app/</strong></p><ul><li>Activity.java</li><li>ActivityThread.java</li><li>Instrumentation.java</li></ul><p><strong>/frameworks/base/core/jni/</strong></p><ul><li>android_view_DisplayEventReceiver.cpp</li><li>android_view_SurfaceControl.cpp</li><li>android_view_Surface.cpp</li><li>android_view_SurfaceSession.cpp</li></ul><p><strong>/frameworks/native/include/gui/</strong></p><ul><li>SurfaceComposerClient.h</li><li>IDisplayEventConnection.h</li><li>SurfaceComposerClient.h</li></ul><p><strong>/frameworks/native/services/surfaceflinger/</strong></p><ul><li>SurfaceFlinger.cpp</li><li>Client.cpp</li><li>main_surfaceflinger.cpp</li><li>DisplayDevice.cpp</li><li>DispSync.cpp</li><li>EventControlThread.cpp</li><li>EventThread.cpp</li><li>Layer.cpp</li><li>MonitoredProducer.cpp</li></ul><p><strong>/frameworks/base/core/java/android/view/</strong></p><ul><li>WindowManagerImpl.java</li><li>ViewManager.java</li><li>WindowManagerGlobal.java</li><li>ViewRootImpl.java</li><li>Choreographer.java</li><li>IWindowSession.aidl</li><li>DisplayEventReceiver.java</li><li>SurfaceControl.java</li><li>Surface.java</li><li>SurfaceSession.java</li></ul><p><strong>/frameworks/native/include/ui/</strong></p><ul><li>GraphicBuffer.h</li><li>GraphicBufferAllocator.h</li></ul><p><strong>/frameworks/base/services/core/java/com/android/server/wm/</strong></p><ul><li>WindowManagerService.java</li><li>Session.java</li><li>WindowState.java</li><li>WindowStateAnimator.java</li><li>WindowSurfaceController.java</li></ul><h2 id="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1"><a href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1" class="headerlink" title="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.graphics" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></h2><h2 id="ï¼ˆä¸€ï¼‰ã€Android-Graphics-ç³»ç»Ÿæ¡†æ¶"><a href="#ï¼ˆä¸€ï¼‰ã€Android-Graphics-ç³»ç»Ÿæ¡†æ¶" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Android Graphics ç³»ç»Ÿæ¡†æ¶"></a>ï¼ˆä¸€ï¼‰ã€Android Graphics ç³»ç»Ÿæ¡†æ¶</h2><p>ï¼ˆè¯•ç”¨é™åˆ¶ï¼Ÿï¼Ÿï¼Ÿä¸‡æ¶çš„äº¿å›¾(EDraw)å¼ºåŠ æ°´å°~ç«~ï¼‰<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/01-Android-Graphics-Architecture.png" alt="Markdown"></p><p><strong>App</strong> åŸºäºAndroidç³»ç»Ÿçš„GUIæ¡†æ¶å¼€å‘å®Œæ•´çš„Apkåº”ç”¨ã€‚</p><p><strong>Android Graphics Stack Client(SurfaceFlinger Client)</strong><br>Androidåœ¨å®¢æˆ·ç«¯çš„ç»˜å›¾å †æ ˆé€šå¸¸åŒ…æ‹¬ï¼š OpenGL ESï¼šä½¿ç”¨GPUè¿›è¡Œ3Då’Œ2Dçš„ç»˜å›¾çš„API EGLï¼šè¡”æ¥GLESå’Œç³»ç»Ÿçš„Native Windowç³»ç»Ÿçš„é€‚é…å±‚ Vulkanï¼šVulkanä¸ºKhronos Groupæ¨å‡ºçš„ä¸‹ä¸€ä»£è·¨å¹³å°å›¾å½¢å¼€å‘æ¥å£ï¼Œç”¨äºæ›¿ä»£å†å²æ‚ ä¹…çš„OpenGLã€‚Androidä»7.0(Nougat)å¼€å§‹åŠ å…¥äº†å¯¹å…¶çš„æ”¯æŒã€‚Vulkanä¸OpenGLç›¸æ¯”ï¼Œæ¥å£æ›´åº•å±‚ï¼Œä»è€Œä½¿å¼€å‘è€…èƒ½æ›´ç›´æ¥åœ°æ§åˆ¶GPUã€‚ç”±äºæ›´å¥½çš„å¹¶è¡Œæ”¯æŒï¼ŒåŠæ›´å°çš„å¼€é”€ï¼Œæ€§èƒ½ä¸Šä¹Ÿæœ‰ä¸€å®šçš„æå‡ã€‚<br><strong>Android Graphics Stack Serverï¼ˆSurfaceFlinger Serverï¼‰</strong><br>SurfaceFlingeræ˜¯Androidç”¨äºç®¡ç†Displayå’Œè´Ÿè´£Window Compositeï¼ˆçª—å£æ··åˆï¼‰ï¼ŒæŠŠåº”ç”¨çš„æ˜¾ç¤ºçª—å£è¾“å‡ºåˆ°Displayçš„ç³»ç»ŸæœåŠ¡ã€‚</p><p><strong>Android Driversï¼ˆHALï¼‰</strong><br>Androidçš„é©±åŠ¨å±‚ï¼Œé€šè¿‡Androidæœ¬èº«çš„HALï¼ˆç¡¬ä»¶æŠ½è±¡å±‚ï¼‰æœºåˆ¶ï¼Œè¿è¡ŒäºUser Spaceï¼Œè·Ÿæ¸²æŸ“ç›¸å…³çš„åŒ…æ‹¬ï¼š</p><p>Hwcomposerï¼šå¦‚æœç¡¬ä»¶æ”¯æŒï¼ŒSurfaceFlingerå¯ä»¥è¯·æ±‚hwcomposerå»åšçª—å£æ··åˆè€Œä¸éœ€è¦è‡ªå·±æ¥åšï¼Œè¿™æ ·çš„æ•ˆç‡ä¹Ÿä¼šæ›´é«˜ï¼Œå‡å°‘å¯¹GPUèµ„æºçš„å ç”¨ Grallocï¼šç”¨æ¥ç®¡ç†Graphics Bufferçš„åˆ†é…å’Œç®¡ç†ç³»ç»Ÿçš„framebuffer OpenGL ES/EGL</p><p><strong>Linux Kernel and Drivers</strong><br>é™¤äº†æ ‡å‡†çš„Linuxå†…æ ¸å’Œé©±åŠ¨ï¼ˆä¾‹å¦‚fbæ˜¯framebufferé©±åŠ¨ï¼‰ï¼Œç¡¬ä»¶å‚å•†è‡ªå·±çš„é©±åŠ¨å¤–ï¼ŒAndroidè‡ªå·±çš„ä¸€äº›Patchesï¼š</p><p>Ashmemï¼šå¼‚æ­¥å…±äº«å†…å­˜ï¼Œç”¨äºåœ¨è¿›ç¨‹é—´å…±äº«ä¸€å—å†…å­˜åŒºåŸŸï¼Œå¹¶å…è®¸ç³»ç»Ÿåœ¨èµ„æºç´§å¼ æ—¶å›æ”¶ä¸åŠ é”çš„å†…å­˜å— IONï¼šå†…å­˜ç®¡ç†å™¨ IONæ˜¯googleåœ¨Android4.0 ä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡ç®¡ç†è€Œå¼•å…¥çš„é€šç”¨å†…å­˜ç®¡ç†å™¨,åœ¨é¢å‘ç¨‹åºå‘˜ç¼–ç¨‹æ–¹é¢ï¼Œå®ƒå’Œashmemå¾ˆç›¸ä¼¼ã€‚ä½†IONæ¯”ashmemæ›´å¼ºå¤§ Binderï¼šé«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ Vsyncï¼šAndroid 4.1å¼•å…¥äº†Vsync(Vertical Syncronization)ç”¨äºæ¸²æŸ“åŒæ­¥ï¼Œä½¿å¾—App UIå’ŒSurfaceFlingerå¯ä»¥æŒ‰ç¡¬ä»¶äº§ç”Ÿçš„VSyncèŠ‚å¥æ¥è¿›è¡Œå·¥ä½œ <strong>Hardware</strong> Displayï¼ˆæ˜¾ç¤ºå™¨ï¼‰ã€CPUã€GPUã€VPUï¼ˆVideo Process Unitï¼‰ã€å’Œå†…å­˜ç­‰ç­‰</p><h2 id="ï¼ˆäºŒï¼‰ã€Android-Graphics-æµ‹è¯•ç¨‹åºï¼ˆC-ï¼‰"><a href="#ï¼ˆäºŒï¼‰ã€Android-Graphics-æµ‹è¯•ç¨‹åºï¼ˆC-ï¼‰" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Android Graphics æµ‹è¯•ç¨‹åºï¼ˆC++ï¼‰"></a>ï¼ˆäºŒï¼‰ã€Android Graphics æµ‹è¯•ç¨‹åºï¼ˆC++ï¼‰</h2><p>ä¸ºäº†ä¾¿äºè§‚å¯Ÿå¯¹åŸç”Ÿæµ‹è¯•ç¨‹åºæ˜¾ç¤ºå›¾åƒå¤§å°åšäº†å¦‚ä¸‹ä¿®æ”¹ï¼š</p><blockquote><p>frameworks/native/services/surfaceflinger/tests/Transaction_test.cpp</p></blockquote><p><a href="https://github.com/izhoujinjian/izhoujinjian.github.io.doc/blob/master/Android-7.1.2-Qualcomm-MSM89XX-Disable_HWUI_GPU_HWC.patch" target="_blank" rel="noopener">Disable_HWUI_GPU_HWC.patch</a></p><p>åŸç”ŸSurfaceFlingeræµ‹è¯•ç¨‹åºç¼–è¯‘ï¼š<br>1ã€ç¼–è¯‘Android 7.1.2æºç -userdebugç‰ˆæœ¬ï¼Œçƒ§å½•é‡å¯<br>2ã€ç¼–è¯‘/frameworks/native/services/surfaceflinger/tests/ä¼šç”ŸæˆSurfaceFlinger_test<br>3ã€è¿æ¥æ‰‹æœºæ‰§è¡Œå‘½ä»¤ adb rootã€adb remountã€adb push SurfaceFlinger_test /system/bin/<br>4ã€adb shell setenforce 0(æš‚æ—¶å…³é—­SELinuxæƒé™)<br>5ã€adb shellã€cd system/bin/ã€chmod 0777 SurfaceFlinger_test<br>6ã€è¿è¡Œæµ‹è¯•ç¨‹åºï¼š./SurfaceFlinger_test</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/02-Android-graphics-SurfaceFlinger-Test-00.gif" alt="Markdown"></p><p>å¯ä»¥çœ‹åˆ°åœ¨Android æ˜¾ç¤ºå±æ¥æ›¿ç»˜åˆ¶äº†å¤šä¸ªå›¾åƒï¼Œå¹¶ä¸”ä¼šå˜æ¢å½¢çŠ¶ã€ä½ç½®ã€é¢œè‰²ã€é€æ˜åº¦ç­‰ã€‚ æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸»è¦æ­¥éª¤ï¼š 1ã€ åˆ›å»ºSurfaceComposerClient</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceComposerClient&gt; mComposerClient;</span><br><span class="line">mComposerClient = <span class="keyword">new</span> SurfaceComposerClient;</span><br></pre></td></tr></table></figure><p>2ã€ å®¢æˆ·ç«¯SurfaceComposerClientè¯·æ±‚SurfaceFlingeråˆ›å»ºSurface æ³¨ï¼šAppç«¯å¯¹åº”SurfaceControl&lt;â€”&gt;SurfaceFlingerå¯¹åº”Layer</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceControl&gt; mBGSurfaceControl;</span><br><span class="line">sp&lt;SurfaceControl&gt; mFGSurfaceControl;</span><br><span class="line">       <span class="comment">// Background surface</span></span><br><span class="line">mBGSurfaceControl = mComposerClient-&gt;createSurface(</span><br><span class="line">                String8(<span class="string">"BG Test Surface"</span>), displayWidth, displayHeight,</span><br><span class="line">                PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">fillSurfaceRGBA8(mBGSurfaceControl, <span class="number">63</span>, <span class="number">63</span>, <span class="number">195</span>);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/03-Android-Graphics-SF-test-color-blue.png" alt="Markdown"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Foreground surface</span></span><br><span class="line">mFGSurfaceControl = mComposerClient-&gt;createSurface(</span><br><span class="line">        String8(<span class="string">"FG Test Surface"</span>), <span class="number">64</span>, <span class="number">64</span>, PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line">fillSurfaceRGBA8(mFGSurfaceControl, <span class="number">195</span>, <span class="number">63</span>, <span class="number">63</span>);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/04-Android-Graphics-SF-test-color-red.png" alt="Markdown"></p><p>3ã€å¤„ç†äº‹åŠ¡ï¼Œå°†SurfaceControlï¼ˆAppï¼‰çš„å˜åŒ–æ›´æ–°åˆ°Layerï¼ˆSurfaceFlingerï¼‰å›¾å±‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SurfaceComposerClient::openGlobalTransaction();</span><br><span class="line"></span><br><span class="line">   mComposerClient-&gt;setDisplayLayerStack(display, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">   ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-2</span>));</span><br><span class="line">   ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;show());</span><br><span class="line"></span><br><span class="line">   ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-1</span>));</span><br><span class="line">   ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setPosition(<span class="number">64</span>, <span class="number">64</span>));</span><br><span class="line">   ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;show());</span><br><span class="line"></span><br><span class="line">   SurfaceComposerClient::closeGlobalTransaction(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>4ã€æ¥å—VsyncåŒæ­¥ä¿¡å·ï¼Œæ¸²æŸ“åˆæˆï¼Œæ¨é€åˆ°æ˜¾ç¤ºå±æ˜¾ç¤º<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/05-Android-Graphics-SF-test-frame_01_delay-1s.gif" alt="Markdown"></p><p>æ¥ä¸‹æ¥å¼€å§‹Android Graphicsç³»ç»Ÿç¥ç§˜æ¢ç´¢ä¹‹è°œã€‚</p><h2 id="ï¼ˆä¸‰ï¼‰ã€Android-Graphics-ç¦ç”¨hwcå’ŒGPU"><a href="#ï¼ˆä¸‰ï¼‰ã€Android-Graphics-ç¦ç”¨hwcå’ŒGPU" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Android Graphics ç¦ç”¨hwcå’ŒGPU"></a>ï¼ˆä¸‰ï¼‰ã€Android Graphics ç¦ç”¨hwcå’ŒGPU</h2><h3 id="3-1ã€Disable-HWUI-GPU-HWC"><a href="#3-1ã€Disable-HWUI-GPU-HWC" class="headerlink" title="3.1ã€Disable_HWUI_GPU_HWC"></a>3.1ã€Disable_HWUI_GPU_HWC</h3><p>æ³¨ï¼šåŸºäºAndroid 7.1.2 Qualcomm MSM89XXæºç ï¼Œç”±äºä»£ç æ®µè¾ƒé•¿ï¼Œå·²æ”¾åˆ°GitHub <a href="https://github.com/izhoujinjian/izhoujinjian.github.io.doc/blob/master/Android-7.1.2-Qualcomm-MSM89XX-Disable_HWUI_GPU_HWC.patch" target="_blank" rel="noopener">Disable_HWUI_GPU_HWC.patch</a></p><p>ç¼–è¯‘userdebugç‰ˆæœ¬ï¼Œçƒ§å½•å¼€æœº: è¿è¡Œæµ‹è¯•ç¨‹åºï¼š./SurfaceFlinger_test ç»“æœè·Ÿä¸Šè¿°ä¸€è‡´ï¼Œè¿™é‡Œä¸å†è´´å›¾äº†ã€‚</p><h3 id="3-2ã€Vsyncæµ‹è¯•ç¨‹åº"><a href="#3-2ã€Vsyncæµ‹è¯•ç¨‹åº" class="headerlink" title="3.2ã€Vsyncæµ‹è¯•ç¨‹åº"></a>3.2ã€Vsyncæµ‹è¯•ç¨‹åº</h3><p>Vsync(Vertical Syncronization)ç”¨äºæ¸²æŸ“åŒæ­¥ï¼Œä½¿å¾—App UIå’ŒSurfaceFlingerå¯ä»¥æŒ‰ç¡¬ä»¶äº§ç”Ÿçš„VSyncèŠ‚å¥æ¥è¿›è¡Œå·¥ä½œã€‚</p><p>æŸ¥çœ‹frameworks/native/services/surfaceflinger/tests/ä¸‹è¿˜æœ‰vsyncæµ‹è¯•ç¨‹åº</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/looper.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gui/DisplayEventReceiver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Looper.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">receiver</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DisplayEventReceiver* q = (DisplayEventReceiver*)data;</span><br><span class="line">    <span class="keyword">ssize_t</span> n;</span><br><span class="line">    DisplayEventReceiver::Event buffer[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">nsecs_t</span> oldTimeStamp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((n = q-&gt;getEvents(buffer, <span class="number">1</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ; i&lt;n ; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (buffer[i].header.type == DisplayEventReceiver::DISPLAY_EVENT_VSYNC) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"event vsync: count=%d\t"</span>, buffer[i].vsync.count);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (oldTimeStamp) &#123;</span><br><span class="line">                <span class="keyword">float</span> t = <span class="keyword">float</span>(buffer[i].header.timestamp - oldTimeStamp) / s2ns(<span class="number">1</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%f ms (%f Hz)\n"</span>, t*<span class="number">1000</span>, <span class="number">1.0</span>/t);</span><br><span class="line">            &#125;</span><br><span class="line">            oldTimeStamp = buffer[i].header.timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n&lt;<span class="number">0</span>) &#123;<span class="built_in">printf</span>(<span class="string">"error reading events (%s)\n"</span>, strerror(-n));&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DisplayEventReceiver myDisplayEvent;</span><br><span class="line">    sp&lt;Looper&gt; loop = <span class="keyword">new</span> Looper(<span class="literal">false</span>);</span><br><span class="line">    loop-&gt;addFd(myDisplayEvent.getFd(), <span class="number">0</span>, ALOOPER_EVENT_INPUT, receiver,</span><br><span class="line">            &amp;myDisplayEvent);</span><br><span class="line">    myDisplayEvent.setVsyncRate(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//printf("about to poll...\n");</span></span><br><span class="line">        <span class="keyword">int32_t</span> ret = loop-&gt;pollOnce(<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">            <span class="keyword">case</span> ALOOPER_POLL_WAKE:</span><br><span class="line">                <span class="comment">//("ALOOPER_POLL_WAKE\n");</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ALOOPER_POLL_CALLBACK:</span><br><span class="line">                <span class="comment">//("ALOOPER_POLL_CALLBACK\n");</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ALOOPER_POLL_TIMEOUT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"ALOOPER_POLL_TIMEOUT\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ALOOPER_POLL_ERROR:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"ALOOPER_POLL_TIMEOUT\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"ugh? poll returned %d\n"</span>, ret);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘è¿è¡Œçœ‹çœ‹ï¼šå¯ä»¥çœ‹åˆ°vsyncä¿¡å·æ¯éš”16 msä¸€æ¬¡ï¼Œå…³äºvsyncçŸ¥è¯†ç¨åå†åˆ†æã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">event vsync: count=<span class="number">2631</span> <span class="number">16.168612</span> ms (<span class="number">61.848231</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2632</span> <span class="number">16.168613</span> ms (<span class="number">61.848224</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2633</span> <span class="number">16.168312</span> ms (<span class="number">61.849378</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2634</span> <span class="number">16.168682</span> ms (<span class="number">61.847961</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2635</span> <span class="number">16.168596</span> ms (<span class="number">61.848288</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2636</span> <span class="number">16.168867</span> ms (<span class="number">61.847255</span> Hz)</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆå››ï¼‰ã€Android-SurfaceFlinger-å†…éƒ¨æœºåˆ¶"><a href="#ï¼ˆå››ï¼‰ã€Android-SurfaceFlinger-å†…éƒ¨æœºåˆ¶" class="headerlink" title="ï¼ˆå››ï¼‰ã€Android SurfaceFlinger å†…éƒ¨æœºåˆ¶"></a>ï¼ˆå››ï¼‰ã€Android SurfaceFlinger å†…éƒ¨æœºåˆ¶</h2><h3 id="4-1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„"><a href="#4-1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„" class="headerlink" title="4.1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„"></a>4.1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/06-Android-Graphics-App-SurfaceFlinger.png" alt="Markdown"></p><h4 id="4-1-1ã€BufferQueueä»‹ç»"><a href="#4-1-1ã€BufferQueueä»‹ç»" class="headerlink" title="4.1.1ã€BufferQueueä»‹ç»"></a>4.1.1ã€BufferQueueä»‹ç»</h4><p>BufferQueue ç±»æ˜¯ Android ä¸­æ‰€æœ‰å›¾å½¢å¤„ç†æ“ä½œçš„æ ¸å¿ƒã€‚å®ƒçš„æ˜¯å°†ç”Ÿæˆå›¾å½¢æ•°æ®ç¼“å†²åŒºçš„ä¸€æ–¹ï¼ˆç”Ÿäº§è€…Producerï¼‰è¿æ¥åˆ°æ¥å—æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤ºæˆ–è¿›ä¸€æ­¥å¤„ç†çš„ä¸€æ–¹ï¼ˆæ¶ˆè´¹è€…Consumerï¼‰ã€‚å‡ ä¹æ‰€æœ‰åœ¨ç³»ç»Ÿä¸­ç§»åŠ¨å›¾å½¢æ•°æ®ç¼“å†²åŒºçš„å†…å®¹éƒ½ä¾èµ–äº BufferQueueã€‚ ä»ä¸Šå›¾APPä¸SurfaceFlingeräº¤äº’ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBufferQueueå†…éƒ¨ç»´æŒç€64ä¸ªBufferSlotï¼Œæ¯ä¸€ä¸ªBufferSlotå†…éƒ¨æœ‰ä¸€ä¸ªGraphicBufferæŒ‡å‘åˆ†é…çš„Graphic Bufferã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/07-Android-Graphics-SurfaceFlinger-BufferQueue.png.png" alt="Markdown"><br>å…ˆæ¥çœ‹ä¸€ä¸‹å›¾ä¸­å‡ ä¸ªçŠ¶æ€ä»£è¡¨çš„å«ä¹‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frameworks/native/include/gui/BufferSlot.h</span><br><span class="line"></span><br><span class="line"><span class="comment">// A buffer can be in one of five states, represented as below:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//         | mShared | mDequeueCount | mQueueCount | mAcquireCount |</span></span><br><span class="line"><span class="comment">// --------|---------|---------------|-------------|---------------|</span></span><br><span class="line"><span class="comment">// FREE    |  false  |       0       |      0      |       0       |</span></span><br><span class="line"><span class="comment">// DEQUEUED|  false  |       1       |      0      |       0       |</span></span><br><span class="line"><span class="comment">// QUEUED  |  false  |       0       |      1      |       0       |</span></span><br><span class="line"><span class="comment">// ACQUIRED|  false  |       0       |      0      |       1       |</span></span><br><span class="line"><span class="comment">// SHARED  |  true   |      any      |     any     |      any      |</span></span><br></pre></td></tr></table></figure><p><strong>FREE :</strong> FREEè¡¨ç¤ºç¼“å†²åŒºå¯ç”±ç”Ÿäº§è€…ï¼ˆProducerï¼‰DEQUEUEDå‡ºåˆ—ã€‚ è¯¥BufferSlotç”±BufferQueueâ€æ‹¥æœ‰â€ã€‚ å®ƒè½¬æ¢åˆ°DEQUEUED å½“è°ƒç”¨dequeueBufferæ—¶ã€‚</p><p><strong>DEQUEUEDï¼š</strong> DEQUEUEDè¡¨ç¤ºç¼“å†²åŒºå·²ç»è¢«ç”Ÿäº§è€…ï¼ˆProducerï¼‰å‡ºåˆ—ï¼Œä½†æ˜¯å°šæœªqueued æˆ–canceledã€‚ç”Ÿäº§è€…ï¼ˆProducerï¼‰å¯ä»¥ä¿®æ”¹ç¼“å†²åŒºçš„å†…å®¹ä¸€æ—¦ç›¸å…³çš„é‡Šæ”¾å›´æ è¢«å‘ä¿¡å·é€šçŸ¥ã€‚BufferSlotç”±Producerâ€æ‹¥æœ‰â€ã€‚ å®ƒå¯ä»¥è½¬æ¢åˆ°QUEUEDï¼ˆé€šè¿‡ queueBufferæˆ–è€…attachBufferï¼‰æˆ–è€…è¿”å›FREEï¼ˆé€šè¿‡cancelBufferæˆ–è€…detachBufferï¼‰ã€‚</p><p><strong>QUEUEDï¼š</strong> QUEUEDè¡¨ç¤ºç¼“å†²åŒºå·²ç»è¢«ç”Ÿäº§è€…ï¼ˆProducerï¼‰å¡«å……æ’é˜Ÿç­‰å¾…æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ä½¿ç”¨ã€‚ ç¼“å†²åŒºå†…å®¹å¯èƒ½è¢«ç»§ç»­ ä¿®æ”¹åœ¨æœ‰é™çš„æ—¶é—´å†…ï¼Œæ‰€ä»¥å†…å®¹ä¸èƒ½è¢«è®¿é—®ï¼Œç›´åˆ°å…³è”çš„æ …æ fenceå‘ä¿¡å·ã€‚ è¯¥BufferSlotç”±BufferQueueâ€æ‹¥æœ‰â€ã€‚ å®ƒ å¯ä»¥è½¬æ¢ä¸ºACQUIREDï¼ˆé€šè¿‡acquireBufferï¼‰æˆ–FREEï¼ˆå¦‚æœæ˜¯å¦ä¸€ä¸ªç¼“å†²åŒºä»¥å¼‚æ­¥æ¨¡å¼æ’é˜Ÿï¼‰ã€‚</p><p><strong>ACQUIREDï¼š</strong> ACQUIREDè¡¨ç¤ºç¼“å†²åŒºå·²è¢«æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰è·å–ã€‚ å¦‚ä¸QUEUEDï¼Œå†…å®¹ä¸èƒ½è¢«æ¶ˆè´¹è€…è®¿é—®ï¼Œç›´åˆ° è·å¾—æ …æ fenceä¿¡å·ã€‚ BufferSlotç”±Consumerâ€æ‹¥æœ‰â€ã€‚ å®ƒå½“releaseBufferï¼ˆæˆ–detachBufferï¼‰è¢«è°ƒç”¨æ—¶è½¬æ¢ä¸ºFREEã€‚ ä¸€ä¸ª åˆ†ç¦»çš„ç¼“å†²åŒºä¹Ÿå¯ä»¥é€šè¿‡attachBufferè¿›å…¥ACQUIREDçŠ¶æ€ã€‚</p><p><strong>SHAREDï¼š</strong> SHAREDè¡¨ç¤ºæ­¤ç¼“å†²åŒºæ­£åœ¨å…±äº«ç¼“å†²åŒºä¸­ä½¿ç”¨æ¨¡å¼ã€‚ å®ƒå¯ä»¥åŒæ—¶åœ¨å…¶ä»–Stateçš„ä»»ä½•ç»„åˆï¼Œ é™¤äº†FREE ï¼ˆå› ä¸ºè¿™ä¸åŒ…æ‹¬åœ¨ä»»ä½•å…¶ä»–Stateï¼‰ã€‚ å®ƒå¯ä»¥ä¹Ÿå¯ä»¥å‡ºåˆ—ï¼Œæ’é˜Ÿæˆ–å¤šæ¬¡è·å¾—ã€‚</p><p><strong>ç®€å•æè¿°ä¸€ä¸‹çŠ¶æ€è½¬æ¢è¿‡ç¨‹ï¼š</strong></p><p>1ã€é¦–å…ˆç”Ÿäº§è€…dequeueè¿‡æ¥ä¸€å—Bufferï¼Œæ­¤æ—¶è¯¥bufferçš„çŠ¶æ€ä¸ºDEQUEUEDï¼Œæ‰€æœ‰è€…ä¸ºPRODUCERï¼Œç”Ÿäº§è€…å¯ä»¥å¡«å……æ•°æ®äº†ã€‚åœ¨æ²¡æœ‰dequeueæ“ä½œæ—¶ï¼Œbufferçš„çŠ¶æ€ä¸ºfree,æ‰€æœ‰è€…ä¸ºBUFFERQUEUEã€‚</p><p>2ã€ç”Ÿäº§è€…å¡«å……å®Œæ•°æ®å,è¿›è¡Œqueueæ“ä½œï¼Œæ­¤æ—¶bufferçš„çŠ¶æ€ç”±DEQUEUED-&gt;QUEUEDçš„è½¬å˜ï¼Œbufferæ‰€æœ‰è€…ä¹Ÿå˜æˆäº†BufferQueueäº†ã€‚</p><p>3ã€ä¸Šé¢å·²ç»é€šçŸ¥æ¶ˆè´¹è€…å»æ‹¿bufferäº†ï¼Œè¿™ä¸ªæ—¶å€™æ¶ˆè´¹è€…å°±è¿›è¡Œacquireæ“ä½œå°†bufferæ‹¿è¿‡æ¥ï¼Œæ­¤æ—¶bufferçš„çŠ¶æ€ç”±QUEUED-&gt;ACQUIREDè½¬å˜ï¼Œbufferçš„æ‹¥æœ‰è€…ç”±BufferQueueå˜æˆConsumerã€‚</p><p>4ã€å½“æ¶ˆè´¹è€…å·²ç»æ¶ˆè´¹äº†è¿™å—buffer(å·²ç»åˆæˆï¼Œå·²ç»ç¼–ç ç­‰)ï¼Œå°±è¿›è¡Œreleaseæ“ä½œé‡Šæ”¾buffer,å°†bufferå½’è¿˜ç»™BufferQueue,bufferçŠ¶æ€ç”±ACQUIREDå˜æˆFREE.bufferæ‹¥æœ‰è€…ç”±Consumerå˜æˆBufferQueue.</p><h4 id="4-1-2ã€ç”Ÿäº§è€…Producer"><a href="#4-1-2ã€ç”Ÿäº§è€…Producer" class="headerlink" title="4.1.2ã€ç”Ÿäº§è€…Producer"></a>4.1.2ã€ç”Ÿäº§è€…Producer</h4><p>ç”Ÿäº§è€…Producerå®ç°IGraphicBufferProducerçš„æ¥å£ï¼Œåœ¨å®é™…è¿ä½œè¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ï¼ˆClientç«¯ï¼‰å­˜åœ¨ä»£ç†ç«¯BpGraphicBufferProducerï¼ŒSurfaceFlingerï¼ˆServerç«¯ï¼‰å­˜åœ¨Nativeç«¯BnGraphicBufferProducerã€‚ç”Ÿäº§è€…ä»£ç†ç«¯Bpé€šè¿‡Binderé€šä¿¡ï¼Œä¸æ–­çš„dequeueBufferå’ŒqueueBufferæ“ä½œï¼ŒNativeç«¯åŒæ ·å“åº”è¿™äº›æ“ä½œè¯·æ±‚ï¼Œè¿™æ ·bufferå°±è½¬äº†èµ·æ¥äº†ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/08-Android-Graphics-SurfaceFlinger-IGraphicsBufferProducer.png" alt="Markdown"></p><p>è¿™é‡Œä»‹ç»å‡ ä¸ªéå¸¸é‡è¦çš„å‡½æ•°ï¼š <strong>1ã€requestBuffer</strong> requestBufferä¸ºç»™å®šçš„ç´¢å¼•è¯·æ±‚ä¸€ä¸ªæ–°çš„Bufferã€‚ æœåŠ¡å™¨ï¼ˆå³IGraphicBufferProducerå®ç°ï¼‰åˆ†é…æ–°åˆ›å»ºçš„Bufferåˆ°ç»™å®šçš„BufferSlotæ§½ç´¢å¼•ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯å¯ä»¥é•œåƒslot-&gt;Bufferæ˜ å°„ï¼Œè¿™æ ·å°±æ²¡æœ‰å¿…è¦ä¼ è¾“ä¸€ä¸ªGraphicBufferç”¨äºæ¯ä¸ªå‡ºé˜Ÿæ“ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// requestBuffer requests a new buffer for the given index. The server (i.e.</span><br><span class="line">// the IGraphicBufferProducer implementation) assigns the newly created</span><br><span class="line">// buffer to the given slot index, and the client is expected to mirror the</span><br><span class="line">// slot-&gt;buffer mapping so that it&apos;s not necessary to transfer a</span><br><span class="line">// GraphicBuffer for every dequeue operation.</span><br><span class="line">//</span><br><span class="line">// The slot must be in the range of [0, NUM_BUFFER_SLOTS).</span><br><span class="line">virtual status_t requestBuffer(int slot, sp&lt;GraphicBuffer&gt;* buf) = 0;</span><br></pre></td></tr></table></figure><p><strong>2ã€dequeueBuffer</strong> dequeueBufferè¯·æ±‚ä¸€ä¸ªæ–°çš„Buffer Slotä¾›å®¢æˆ·ç«¯ä½¿ç”¨ã€‚ æ’æ§½çš„æ‰€æœ‰æƒè¢«è½¬ç§»åˆ°å®¢æˆ·ç«¯ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨ä¸ä¼šä½¿ç”¨ä¸è¯¥æ’æ§½å…³è”çš„ç¼“å†²åŒºçš„å†…å®¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// dequeueBuffer requests a new buffer slot for the client to use. Ownership</span><br><span class="line">// of the slot is transfered to the client, meaning that the server will not</span><br><span class="line">// use the contents of the buffer associated with that slot.</span><br><span class="line">//</span><br><span class="line">virtual status_t dequeueBuffer(int* slot, sp&lt;Fence&gt;* fence, uint32_t w,</span><br><span class="line">        uint32_t h, PixelFormat format, uint32_t usage) = 0;</span><br></pre></td></tr></table></figure><p><strong>3ã€detachBuffer</strong> detachBufferå°è¯•åˆ é™¤ç»™å®šbuffer çš„æ‰€æœ‰æƒæ’æ§½ä»buffer queueã€‚ å¦‚æœè¿™ä¸ªè¯·æ±‚æˆåŠŸï¼Œè¯¥slotå°†ä¼šè¢«freeï¼Œå¹¶ä¸”å°†æ— æ³•ä»è¿™ä¸ªæ¥å£è·å¾—ç¼“å†²åŒºã€‚é‡Šæ”¾çš„æ’æ§½å°†ä¿æŒæœªåˆ†é…çŠ¶æ€ï¼Œç›´åˆ°è¢«é€‰ä¸­ä¸ºæ­¢åœ¨dequeueBufferä¸­ä¿å­˜ä¸€ä¸ªæ–°åˆ†é…çš„ç¼“å†²åŒºï¼Œæˆ–è€…é™„åŠ ä¸€ä¸ªç¼“å†²åŒºåˆ°æ’æ§½ã€‚ ç¼“å†²åŒºå¿…é¡»å·²ç»è¢«å–å‡ºï¼Œå¹¶ä¸”è°ƒç”¨è€…å¿…é¡»å·²ç»æ‹¥æœ‰sp</p><graphicbuffer>ï¼ˆå³å¿…é¡»è°ƒç”¨requestBufferï¼‰</graphicbuffer><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// detachBuffer attempts to remove all ownership of the buffer in the given</span><br><span class="line">// slot from the buffer queue. If this call succeeds, the slot will be</span><br><span class="line">// freed, and there will be no way to obtain the buffer from this interface.</span><br><span class="line">// The freed slot will remain unallocated until either it is selected to</span><br><span class="line">// hold a freshly allocated buffer in dequeueBuffer or a buffer is attached</span><br><span class="line">// to the slot. The buffer must have already been dequeued, and the caller</span><br><span class="line">// must already possesses the sp&lt;GraphicBuffer&gt; (i.e., must have called</span><br><span class="line">// requestBuffer).</span><br><span class="line">//</span><br><span class="line">virtual status_t detachBuffer(int slot) = 0;</span><br></pre></td></tr></table></figure><p><strong>4ã€attachBuffer</strong> attachBufferå°è¯•å°†ç¼“å†²åŒºçš„æ‰€æœ‰æƒè½¬ç§»ç»™ç¼“å†²åŒºé˜Ÿåˆ—ã€‚ å¦‚æœè¿™ä¸ªè°ƒç”¨æˆåŠŸï¼Œå°±å¥½åƒè¿™ä¸ªç¼“å†²åŒºå·²ç»å‡ºé˜Ÿä¸€æ ·ä»è¿”å›çš„æ’æ§½å·ç ã€‚ å› æ­¤ï¼Œå¦‚æœè¿æ¥ï¼Œè¿™ä¸ªè°ƒç”¨å°†å¤±è´¥è¿™ä¸ªç¼“å†²åŒºä¼šå¯¼è‡´å¾ˆå¤šçš„ç¼“å†²åŒºåŒæ—¶å‡ºé˜Ÿã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// attachBuffer attempts to transfer ownership of a buffer to the buffer</span><br><span class="line">// queue. If this call succeeds, it will be as if this buffer was dequeued</span><br><span class="line">// from the returned slot number. As such, this call will fail if attaching</span><br><span class="line">// this buffer would cause too many buffers to be simultaneously dequeued.</span><br><span class="line">//</span><br><span class="line">virtual status_t attachBuffer(int* outSlot,</span><br><span class="line">        const sp&lt;GraphicBuffer&gt;&amp; buffer) = 0;</span><br></pre></td></tr></table></figure><h4 id="4-1-3ã€æ¶ˆè´¹è€…Consumer"><a href="#4-1-3ã€æ¶ˆè´¹è€…Consumer" class="headerlink" title="4.1.3ã€æ¶ˆè´¹è€…Consumer"></a>4.1.3ã€æ¶ˆè´¹è€…Consumer</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/09-Android-Graphics-SurfaceFlinger-IGraphicsBufferConsumer.png" alt="Markdown"><br>è¿™é‡Œä»‹ç»å‡ ä¸ªéå¸¸é‡è¦çš„å‡½æ•°ï¼š <strong>1ã€acquireBuffer</strong> acquireBufferå°è¯•è·å–ä¸‹ä¸€ä¸ªæœªå†³ç¼“å†²åŒºçš„æ‰€æœ‰æƒBufferQueueã€‚ å¦‚æœæ²¡æœ‰ç¼“å†²åŒºç­‰å¾…ï¼Œåˆ™è¿”å›NO_BUFFER_AVAILABLEã€‚ å¦‚æœç¼“å†²åŒºè¢«æˆåŠŸè·å–ï¼Œæœ‰å…³ç¼“å†²åŒºçš„ä¿¡æ¯å°†åœ¨BufferItemä¸­è¿”å›ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// acquireBuffer attempts to acquire ownership of the next pending buffer in</span><br><span class="line">// the BufferQueue.  If no buffer is pending then it returns</span><br><span class="line">// NO_BUFFER_AVAILABLE.  If a buffer is successfully acquired, the</span><br><span class="line">// information about the buffer is returned in BufferItem.</span><br><span class="line">//</span><br><span class="line">virtual status_t acquireBuffer(BufferItem* buffer, nsecs_t presentWhen,</span><br><span class="line">        uint64_t maxFrameNumber = 0) = 0;</span><br></pre></td></tr></table></figure><p><strong>2ã€releaseBuffer</strong> releaseBufferä»æ¶ˆè´¹è€…é‡Šæ”¾ä¸€ä¸ªBufferSlotå›åˆ°BufferQueueã€‚ è¿™å¯ä»¥åœ¨ç¼“å†²åŒºçš„å†…å®¹ä»ç„¶å­˜åœ¨æ—¶å®Œæˆè¢«è®¿é—®ã€‚ æ …æ å°†åœ¨ç¼“å†²åŒºä¸å†æ­£åœ¨ä½¿ç”¨æ—¶å‘å‡ºä¿¡å·ã€‚ frameNumberç”¨äºæ ‡è¯†è¿”å›çš„ç¡®åˆ‡ç¼“å†²åŒºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// releaseBuffer releases a buffer slot from the consumer back to the</span><br><span class="line">// BufferQueue.  This may be done while the buffer&apos;s contents are still</span><br><span class="line">// being accessed.  The fence will signal when the buffer is no longer</span><br><span class="line">// in use. frameNumber is used to indentify the exact buffer returned.</span><br><span class="line">//</span><br><span class="line">virtual status_t releaseBuffer(int buf, uint64_t frameNumber,</span><br><span class="line">        EGLDisplay display, EGLSyncKHR fence,</span><br><span class="line">        const sp&lt;Fence&gt;&amp; releaseFence) = 0;</span><br></pre></td></tr></table></figure><p><strong>3ã€detachBuffer</strong> detachBufferå°è¯•åˆ é™¤ç»™å®šç¼“å†²åŒºçš„æ‰€æœ‰æƒæ’æ§½ä»ç¼“å†²åŒºé˜Ÿåˆ—ã€‚ å¦‚æœè¿™ä¸ªè¯·æ±‚æˆåŠŸï¼Œè¯¥æ’æ§½å°†ä¼šæ˜¯é‡Šæ”¾ï¼Œå¹¶ä¸”å°†æ— æ³•ä»è¿™ä¸ªæ¥å£è·å¾—ç¼“å†²åŒºã€‚é‡Šæ”¾çš„æ’æ§½å°†ä¿æŒæœªåˆ†é…çŠ¶æ€ï¼Œç›´åˆ°è¢«é€‰ä¸­ä¸ºæ­¢åœ¨dequeueBufferä¸­ä¿å­˜ä¸€ä¸ªæ–°åˆ†é…çš„ç¼“å†²åŒºï¼Œæˆ–è€…é™„åŠ ä¸€ä¸ªç¼“å†²åŒºåˆ°slotã€‚ ç¼“å†²åŒºå¿…é¡»å·²è¢«acquiredã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// detachBuffer attempts to remove all ownership of the buffer in the given</span></span><br><span class="line"><span class="comment">// slot from the buffer queue. If this call succeeds, the slot will be</span></span><br><span class="line"><span class="comment">// freed, and there will be no way to obtain the buffer from this interface.</span></span><br><span class="line"><span class="comment">// The freed slot will remain unallocated until either it is selected to</span></span><br><span class="line"><span class="comment">// hold a freshly allocated buffer in dequeueBuffer or a buffer is attached</span></span><br><span class="line"><span class="comment">// to the slot. The buffer must have already been acquired.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">detachBuffer</span><span class="params">(<span class="keyword">int</span> slot)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p><strong>4ã€attachBuffer</strong> attachBufferå°è¯•å°†ç¼“å†²åŒºçš„æ‰€æœ‰æƒè½¬ç§»ç»™ç¼“å†²åŒºé˜Ÿåˆ—ã€‚ å¦‚æœè¿™ä¸ªè°ƒç”¨æˆåŠŸï¼Œå°±å¥½åƒè¿™ä¸ªç¼“å†²åŒºè¢«è·å–äº†ä¸€æ ·ä»è¿”å›çš„æ’æ§½å·ç ã€‚ å› æ­¤ï¼Œå¦‚æœè¿æ¥ï¼Œè¿™ä¸ªè°ƒç”¨å°†å¤±è´¥è¿™ä¸ªç¼“å†²åŒºä¼šå¯¼è‡´å¤ªå¤šçš„ç¼“å†²åŒºè¢«åŒæ—¶acquiredã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// attachBuffer attempts to transfer ownership of a buffer to the buffer</span></span><br><span class="line"><span class="comment">// queue. If this call succeeds, it will be as if this buffer was acquired</span></span><br><span class="line"><span class="comment">// from the returned slot number. As such, this call will fail if attaching</span></span><br><span class="line"><span class="comment">// this buffer would cause too many buffers to be simultaneously acquired.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">attachBuffer</span><span class="params">(<span class="keyword">int</span> *outSlot,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;GraphicBuffer&gt;&amp; buffer)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h2 id="4-2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹"><a href="#4-2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹" class="headerlink" title="4.2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹"></a>4.2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹</h2><h3 id="4-2-1ã€Activityå¯åŠ¨æµç¨‹"><a href="#4-2-1ã€Activityå¯åŠ¨æµç¨‹" class="headerlink" title="4.2.1ã€Activityå¯åŠ¨æµç¨‹"></a>4.2.1ã€Activityå¯åŠ¨æµç¨‹</h3><p>Activityåˆ›å»ºè¿‡ç¨‹è¿™é‡Œä¸å†å™è¿°ã€‚ è¯·å‚è€ƒ<a href="https://izhoujinjian.github.io/2017/12/29/Android-7-1-2-Android-N-Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#%E4%B8%89%E3%80%81-ActivityManagerService%E6%8E%A5%E6%94%B6%E5%90%AF%E5%8A%A8Activity%E7%9A%84%E8%AF%B7%E6%B1%82" target="_blank" rel="noopener">ã€Android 7.1.2 (Android N) Activityå¯åŠ¨æµç¨‹åˆ†æã€‘</a> &amp;&amp; <a href="https://izhoujinjian.github.io/2018/01/02/Android-7-1-2-Android-N-Activity-Window%E5%8A%A0%E8%BD%BD%E6%98%BE%E7%A4%BA%E6%B5%81%E7%A8%8B/#%E5%8D%9A%E5%AE%A2%E5%8E%9F%E5%9B%BE%E9%93%BE%E6%8E%A5" target="_blank" rel="noopener">ã€Android 7.1.2 (Android N) Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹åˆ†æã€‘</a></p><blockquote><p>â— ActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚</p><p>Activity.startActivity()<br>Activity.startActivityForResult()<br>Instrumentation.execStartActivity()<br>ActivityManagerProxy.startActivity()<br>ActivityManagerNative.onTransact()<br>ActivityManagerService.startActivity()<br>ActivityStarter.startActivityMayWait()<br>ActivityStarter.startActivityLocked()<br>ActivityStarter.startActivityUnchecked()<br>ActivityStackSupervisor.resumeFocusedStackTopActivityLocked() ActivityStack.resumeTopActivityUncheckedLocked()<br>ActivityStack.resumeTopActivityInnerLocked()<br>ActivityStackSupervisor.startSpecificActivityLocked()</p><p>â—â— åˆ›å»ºActivityæ‰€å±çš„åº”ç”¨è¿›ç¨‹ ActivityManagerService.startProcessLocked()</p><p>â—â—â— Zygoteé€šè¿‡socketé€šä¿¡forkä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶æ ¹æ®â€android.app.ActivityThreadâ€å­—ç¬¦ä¸²<br>  â—â—â— åå°„å‡ºè¯¥å¯¹è±¡å¹¶æ‰§è¡ŒActivityThreadçš„mainæ–¹æ³•<br>  ActivityThread.main()<br>  ActivityThread.attach()<br>  ActivityManagerProxy.attachApplication()<br>  ActivityManagerNative.onTransact()<br>  ActivityManagerService.attachApplication()<br>  ActivityManagerService.attachApplicationLocked()<br>  ActivityStackSupervisor.attachApplicationLocked()<br>  ActivityStackSupervisor.realStartActivityLocked()</p><p>â—â—â—â— æ‰§è¡Œå¯åŠ¨Acitivity<br>IApplicationThread.scheduleLaunchActivity()<br>ActivityThread.ApplicationThread.scheduleLaunchActivity()<br>ActivityThread.sendMessage() ActivityThread.H.handleMessage()<br>ActivityThread.handleLauncherActivity()<br>ActivityThread.performLauncherActivity()<br>ActivityThread.handleResumeActivity()</p><h5 id="4-2-2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹"><a href="#4-2-2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹" class="headerlink" title="4.2.2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹"></a>4.2.2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹</h5><p>ç”»å›¾ï¼Œéœ€è¦é‡æ–°åˆ†æä¸€ä¸‹ä¸‹ï¼Œå˜¿å˜¿(<em>^â–½^</em>)~</p><h5 id="4-2-2-1ã€ActivityThread-handleLaunchActivity"><a href="#4-2-2-1ã€ActivityThread-handleLaunchActivity" class="headerlink" title="4.2.2.1ã€ActivityThread.handleLaunchActivity()"></a>4.2.2.1ã€ActivityThread.handleLaunchActivity()</h5><p>æ¥ç€ä»ActivityThreadçš„handleLaunchActivityæ–¹æ³•ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//åˆ›å»ºActivity  </span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//å¯åŠ¨Activity  </span></span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-2-2ã€ActivityThread-handleResumeActivity"><a href="#4-2-2-2ã€ActivityThread-handleResumeActivity" class="headerlink" title="4.2.2.2ã€ActivityThread.handleResumeActivity()"></a>4.2.2.2ã€ActivityThread.handleResumeActivity()</h3><p>å›åˆ°æˆ‘ä»¬åˆšåˆšçš„handleLaunchActivity()æ–¹æ³•ï¼Œåœ¨è°ƒç”¨å®ŒperformLaunchActivity()æ–¹æ³•ä¹‹åï¼Œå…¶æœ‰æ‰ç”¨äº†handleResumeActivity()æ³•ã€‚performLaunchActivity()æ–¹æ³•å®Œæˆäº†ä¸¤ä»¶äº‹ï¼š 1) Activityçª—å£å¯¹è±¡çš„åˆ›å»ºï¼Œé€šè¿‡attachå‡½æ•°æ¥å®Œæˆï¼› 2) Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºï¼Œé€šè¿‡setContentViewå‡½æ•°æ¥å®Œæˆï¼› è¿™äº›å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œå°±å¯ä»¥æ˜¾ç¤ºè¯¥Activityäº†ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹é€šè¿‡è°ƒç”¨handleResumeActivityå‡½æ•°æ¥å¯åŠ¨Activityçš„æ˜¾ç¤ºè¿‡ç¨‹ã€‚ [-&gt;ActivityThread.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    ......</span><br><span class="line">    r = performResumeActivity(token, clearHide, reason);</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            <span class="comment">//è·å¾—ä¸ºå½“å‰Activityåˆ›å»ºçš„çª—å£PhoneWindowå¯¹è±¡</span></span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            <span class="comment">//è·å–ä¸ºçª—å£åˆ›å»ºçš„è§†å›¾DecorViewå¯¹è±¡</span></span><br><span class="line">            View decor = r.window.getDecorView();</span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            <span class="comment">//åœ¨attachå‡½æ•°ä¸­å°±ä¸ºå½“å‰Activityåˆ›å»ºäº†WindowManagerå¯¹è±¡  </span></span><br><span class="line">            ViewManager wm = a.getWindowManager();</span><br><span class="line">            <span class="comment">//å¾—åˆ°è¯¥è§†å›¾å¯¹è±¡çš„å¸ƒå±€å‚æ•°  </span></span><br><span class="line">            WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">            <span class="comment">//å°†è§†å›¾å¯¹è±¡ä¿å­˜åˆ°Activityçš„æˆå‘˜å˜é‡mDecorä¸­  </span></span><br><span class="line">            a.mDecor = decor;</span><br><span class="line">            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">            l.softInputMode |= forwardBit;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//å°†åˆ›å»ºçš„è§†å›¾å¯¹è±¡DecorViewæ·»åŠ åˆ°Activityçš„çª—å£ç®¡ç†å™¨ä¸­  </span></span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‰é¢çš„performLaunchActivityå‡½æ•°ä¸­å®ŒæˆActivityçš„åˆ›å»ºåï¼Œä¼šå°†å½“å‰å½“å‰åˆ›å»ºçš„Activityåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ç«¯çš„æè¿°ç¬¦ActivityClientRecordä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åˆ°ActivityThreadçš„æˆå‘˜å˜é‡mActivitiesä¸­ï¼šmActivities.put(r.token, r)ï¼Œr.tokenå°±æ˜¯Activityçš„èº«ä»½è¯ï¼Œå³æ˜¯IApplicationToken.Proxyä»£ç†å¯¹è±¡ï¼Œä¹Ÿç”¨äºä¸AMSé€šä¿¡ã€‚ä¸Šé¢çš„å‡½æ•°é¦–å…ˆé€šè¿‡performResumeActivityä»mActivitieså˜é‡ä¸­å–å‡ºActivityçš„åº”ç”¨ç¨‹åºç«¯æè¿°ç¬¦ActivityClientRecordï¼Œç„¶åå–å‡ºå‰é¢ä¸ºActivityåˆ›å»ºçš„è§†å›¾å¯¹è±¡DecorViewå’Œçª—å£ç®¡ç†å™¨WindowManagerï¼Œæœ€åå°†è§†å›¾å¯¹è±¡æ·»åŠ åˆ°çª—å£ç®¡ç†å™¨ä¸­ã€‚ ViewManager.addView()çœŸæ­£å®ç°çš„çš„åœ°æ–¹åœ¨WindowManagerImpl.javaä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerGlobal.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">        Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        ......</span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">        mParams.add(wparams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        root.setView(view, wparams, panelParentView);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-2-3ã€ViewRootImpl-æ„é€ è¿‡ç¨‹ï¼š"><a href="#4-2-2-3ã€ViewRootImpl-æ„é€ è¿‡ç¨‹ï¼š" class="headerlink" title="4.2.2.3ã€ViewRootImpl()æ„é€ è¿‡ç¨‹ï¼š"></a>4.2.2.3ã€ViewRootImpl()æ„é€ è¿‡ç¨‹ï¼š</h3><p>[ViewRootImpl.java # ViewRootImpl()]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">final</span> W mWindow;</span><br><span class="line">    <span class="keyword">final</span> Surface mSurface = <span class="keyword">new</span> Surface();</span><br><span class="line">    <span class="keyword">final</span> ViewRootHandler mHandler = <span class="keyword">new</span> ViewRootHandler();</span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mWindowSession = WindowManagerGlobal.getWindowSession();<span class="comment">//IWindowSessionçš„ä»£ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºå’ŒWMSé€šä¿¡ã€‚</span></span><br><span class="line">    mDisplay = display;</span><br><span class="line">    ......</span><br><span class="line">    mWindow = <span class="keyword">new</span> W(<span class="keyword">this</span>);<span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªWæœ¬åœ°Binderå¯¹è±¡ï¼Œç”¨äºWMSé€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹</span></span><br><span class="line">    ......</span><br><span class="line">    mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler, <span class="keyword">this</span>);</span><br><span class="line">    ......</span><br><span class="line">    mViewConfiguration = ViewConfiguration.get(context);</span><br><span class="line">    mDensity = context.getResources().getDisplayMetrics().densityDpi;</span><br><span class="line">    mNoncompatDensity = context.getResources().getDisplayMetrics().noncompatDensityDpi;</span><br><span class="line">    mFallbackEventHandler = <span class="keyword">new</span> PhoneFallbackEventHandler(context);</span><br><span class="line">    mChoreographer = Choreographer.getInstance();<span class="comment">//Choreographerå¯¹è±¡</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ViewRootImplçš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–äº†ä¸€äº›æˆå‘˜å˜é‡ï¼ŒViewRootImplåˆ›å»ºäº†ä»¥ä¸‹å‡ ä¸ªä¸»è¦å¯¹è±¡ï¼š</p><p>(1) é€šè¿‡WindowManagerGlobal.getWindowSession()å¾—åˆ°IWindowSessionçš„ä»£ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºå’ŒWMSé€šä¿¡ã€‚</p><p>(2) åˆ›å»ºäº†ä¸€ä¸ªWæœ¬åœ°Binderå¯¹è±¡ï¼Œç”¨äºWMSé€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</p><p>(3) é‡‡ç”¨å•ä¾‹æ¨¡å¼åˆ›å»ºäº†ä¸€ä¸ªChoreographerå¯¹è±¡ï¼Œç”¨äºç»Ÿä¸€è°ƒåº¦çª—å£ç»˜å›¾ã€‚</p><p>(4) åˆ›å»ºViewRootHandlerå¯¹è±¡ï¼Œç”¨äºå¤„ç†å½“å‰è§†å›¾æ¶ˆæ¯ã€‚</p><p>(5) æ„é€ ä¸€ä¸ªAttachInfoå¯¹è±¡ï¼›</p><p>â—â—â—(6) åˆ›å»ºSurfaceå¯¹è±¡ï¼Œç”¨äºç»˜åˆ¶å½“å‰è§†å›¾ï¼Œå½“ç„¶è¯¥Surfaceå¯¹è±¡çš„çœŸæ­£åˆ›å»ºæ˜¯ç”±WMSæ¥å®Œæˆçš„ï¼Œåªä¸è¿‡æ˜¯WMSä¼ é€’ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹çš„ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/10-Android-Graphics-App-WMS-Surface.png.png" alt="Markdown"></p><h3 id="4-2-2-4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹"><a href="#4-2-2-4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹" class="headerlink" title="4.2.2.4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹"></a>4.2.2.4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹</h3><p>[-&gt;WindowManagerGlobal.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> IWindowSession sWindowSession;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title">getWindowSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWindowSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">                <span class="comment">//å¾—åˆ°IWindowSessionä»£ç†å¯¹è±¡</span></span><br><span class="line">                sWindowSession = windowManager.openSession(</span><br><span class="line">                        <span class="keyword">new</span> IWindowSessionCallback.Stub() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimatorScaleChanged</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">                                ValueAnimator.setDurationScale(scale);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        imm.getClient(), imm.getInputContext());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWindowSession;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå‡½æ•°é€šè¿‡WMSçš„openSessionå‡½æ•°åˆ›å»ºåº”ç”¨ç¨‹åºä¸WMSä¹‹é—´çš„è¿æ¥é€šé“ï¼Œå³è·å–IWindowSessionä»£ç†å¯¹è±¡ï¼Œå¹¶å°†è¯¥ä»£ç†å¯¹è±¡ä¿å­˜åˆ°ViewRootImplçš„é™æ€æˆå‘˜å˜é‡sWindowSessionä¸­,å› æ­¤åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªIWindowSessionä»£ç†å¯¹è±¡ã€‚ [-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> IWindowSession <span class="title">openSession</span><span class="params">(IWindowSessionCallback callback, IInputMethodClient client,</span></span></span><br><span class="line"><span class="function"><span class="params">        IInputContext inputContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (client == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null client"</span>);</span><br><span class="line">    <span class="keyword">if</span> (inputContext == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null inputContext"</span>);</span><br><span class="line">    Session session = <span class="keyword">new</span> Session(<span class="keyword">this</span>, callback, client, inputContext);</span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨WMSæœåŠ¡ç«¯æ„é€ äº†ä¸€ä¸ªSessionå®ä¾‹å¯¹è±¡ã€‚ViewRootImpl æ˜¯ä¸€å¾ˆé‡è¦çš„ç±»ï¼Œç±»ä¼¼ ActivityThread è´Ÿè´£è·ŸAmSé€šä¿¡ä¸€æ ·ï¼ŒViewRootImpl çš„ä¸€ä¸ªé‡è¦èŒè´£å°±æ˜¯è·Ÿ WmS é€šä¿¡ï¼Œå®ƒé€šé™æ€å˜é‡ sWindowSessionï¼ˆIWindowSessionå®ä¾‹ï¼‰ä¸ WmS è¿›è¡Œé€šä¿¡ã€‚æ¯ä¸ªåº”ç”¨è¿›ç¨‹ï¼Œä»…æœ‰ä¸€ä¸ª sWindowSession å¯¹è±¡ï¼Œå®ƒå¯¹åº”äº† WmS ä¸­çš„ Session å­ç±»ï¼ŒWmS ä¸ºæ¯ä¸€ä¸ªåº”ç”¨è¿›ç¨‹åˆ†é…ä¸€ä¸ª Session å¯¹è±¡ã€‚WindowState ç±»æœ‰ä¸€ä¸ª IWindow mClient å‚æ•°ï¼Œæ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­èµ‹å€¼çš„ï¼Œæ˜¯ç”± Session è°ƒç”¨ addWindow ä¼ é€’è¿‡æ¥äº†ï¼Œå¯¹åº”äº† ViewRootImpl ä¸­çš„ W ç±»çš„å®ä¾‹ã€‚</p><h3 id="4-2-2-5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl-setView"><a href="#4-2-2-5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl-setView" class="headerlink" title="4.2.2.5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl.setView()"></a>4.2.2.5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl.setView()</h3><p>çª—å£ç®¡ç†å™¨WindowManagerImplä¸ºå½“å‰æ·»åŠ çš„çª—å£åˆ›å»ºå¥½å„ç§å¯¹è±¡åï¼Œè°ƒç”¨ViewRootImplçš„setViewå‡½æ•°å‘WMSæœåŠ¡æ·»åŠ ä¸€ä¸ªçª—å£å¯¹è±¡ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">////å°†DecorViewä¿å­˜åˆ°ViewRootImplçš„æˆå‘˜å˜é‡mViewä¸­</span></span><br><span class="line">            mView = view;</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">//1ï¼‰åœ¨æ·»åŠ çª—å£å‰è¿›è¡ŒUIå¸ƒå±€  </span></span><br><span class="line">            requestLayout();</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ......</span><br><span class="line">                 <span class="comment">//2)å°†çª—å£æ·»åŠ åˆ°WMSæœåŠ¡ä¸­ï¼ŒmWindowä¸ºWæœ¬åœ°Binderå¯¹è±¡ï¼Œé€šè¿‡Binderä¼ è¾“åˆ°WMSæœåŠ¡ç«¯åï¼Œå˜ä¸ºIWindowä»£ç†å¯¹è±¡  </span></span><br><span class="line">                res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                        getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                        mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                        mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">            &#125; ......</span><br><span class="line">            <span class="comment">//3)å»ºç«‹çª—å£æ¶ˆæ¯é€šé“  </span></span><br><span class="line">            <span class="keyword">if</span> (mInputChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mInputQueueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mInputQueue = <span class="keyword">new</span> InputQueue();</span><br><span class="line">                    mInputQueueCallback.onInputQueueCreated(mInputQueue);</span><br><span class="line">                &#125;</span><br><span class="line">                mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</span><br><span class="line">                        Looper.myLooper());</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„UIä½œä¸ºä¸€ä¸ªå­Viewè¢«æ·»åŠ åˆ°DecorViewä¸­ï¼Œç„¶åå°†é¡¶çº§è§†å›¾DecorViewæ·»åŠ åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹çš„çª—å£ç®¡ç†å™¨ä¸­ï¼Œçª—å£ç®¡ç†å™¨é¦–å…ˆä¸ºå½“å‰æ·»åŠ çš„Viewåˆ›å»ºä¸€ä¸ªViewRootImplå¯¹è±¡ã€ä¸€ä¸ªå¸ƒå±€å‚æ•°å¯¹è±¡ViewGroup.LayoutParamsï¼Œç„¶åå°†è¿™ä¸‰ä¸ªå¯¹è±¡åˆ†åˆ«ä¿å­˜åˆ°å½“å‰åº”ç”¨ç¨‹åºè¿›ç¨‹çš„çª—å£ç®¡ç†å™¨WindowManagerImplä¸­ï¼Œæœ€åé€šè¿‡ViewRootImplå¯¹è±¡å°†å½“å‰è§†å›¾å¯¹è±¡æ³¨å†Œåˆ°WMSæœåŠ¡ä¸­ã€‚</p><p>ViewRootImplçš„setViewå‡½æ•°å‘WMSæœåŠ¡æ·»åŠ ä¸€ä¸ªçª—å£å¯¹è±¡è¿‡ç¨‹ï¼š (1) requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼› (2) WindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼› (3) æ³¨å†Œåº”ç”¨ç¨‹åºè¿›ç¨‹ç«¯çš„æ¶ˆæ¯æ¥æ”¶é€šé“ï¼›</p><h3 id="4-2-2-6ã€requestLayout-åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›"><a href="#4-2-2-6ã€requestLayout-åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›" class="headerlink" title="4.2.2.6ã€requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›"></a>4.2.2.6ã€requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›</h3><p>2.10ã€çª—å£UIå¸ƒå±€è¿‡ç¨‹ requestLayoutå‡½æ•°è°ƒç”¨é‡Œé¢ä½¿ç”¨äº†Hanlderçš„ä¸€ä¸ªå°æ‰‹æ®µï¼Œé‚£å°±æ˜¯åˆ©ç”¨postSyncBarrieræ·»åŠ äº†ä¸€ä¸ªBarrierï¼ˆæŒ¡æ¿ï¼‰ï¼Œè¿™ä¸ªæŒ¡æ¿çš„ä½œç”¨æ˜¯é˜»å¡æ™®é€šçš„åŒæ­¥æ¶ˆæ¯çš„æ‰§è¡Œï¼Œåœ¨æŒ¡æ¿è¢«æ’¤é”€ä¹‹å‰ï¼Œåªä¼šæ‰§è¡Œå¼‚æ­¥æ¶ˆæ¯ï¼Œè€ŒrequestLayoutå…ˆæ·»åŠ äº†ä¸€ä¸ªæŒ¡æ¿Barrierï¼Œä¹‹åè‡ªå·±æ’å…¥äº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡mTraversalRunnableï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯ä¿è¯mTraversalRunnableåœ¨æ‰€æœ‰åŒæ­¥Messageä¹‹å‰è¢«æ‰§è¡Œï¼Œä¿è¯Viewç»˜åˆ¶çš„æœ€é«˜ä¼˜å…ˆçº§ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæš‚æ—¶ä¸è®¨è®ºChoreographerå’ŒVsyncçŸ¥è¯†ï¼Œç¨åå†è¯¦ç»†åˆ†æã€‚ ç°åœ¨å…ˆè¯´å‡ºç»“è®ºï¼šChoreographeræ„é€ å‡½æ•°ä¸­ï¼Œæ„é€ äº†ä¸€ä¸ªFrameDisplayEventReceiverå¯¹è±¡ï¼Œç”¨äºè¯·æ±‚å¹¶æ¥æ”¶Vsyncä¿¡å·ã€‚ æ­¤æ—¶FrameDisplayEventReceiverä¼šCall requestNextVsync()æ¥å‘Šè¯‰ç³»ç»Ÿæˆ‘è¦åœ¨ä¸‹ä¸€ä¸ªVSYNCéœ€è¦è¢«triggerã€‚Vsyncä¿¡å·æ¯éš”16msä¸€æ¬¡ï¼Œæ­¤æ—¶Vsyncä¿¡å·è¿˜æœªæ¥åˆ°ï¼Œç»§ç»­åˆ†æmWindowSession.addToDisplay()ã€‚</p><h3 id="4-2-2-7ã€mWindowSession-addToDisplay-å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›"><a href="#4-2-2-7ã€mWindowSession-addToDisplay-å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›" class="headerlink" title="4.2.2.7ã€mWindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›"></a>4.2.2.7ã€mWindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›</h3><p>[Session.java]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line">public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs,</span><br><span class="line">        int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets,</span><br><span class="line">        Rect outOutsets, InputChannel outInputChannel) &#123;</span><br><span class="line">    return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId,</span><br><span class="line">            outContentInsets, outStableInsets, outOutsets, outInputChannel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        ......</span><br><span class="line">        WindowState win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,</span><br><span class="line">                attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> WindowManagerGlobal.ADD_APP_EXITING;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (addToken) &#123;</span><br><span class="line">            mTokenMap.put(attrs.token, token);</span><br><span class="line">        &#125;</span><br><span class="line">        win.attach();</span><br><span class="line">        mWindowMap.put(client.asBinder(), win);</span><br><span class="line">        ......</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œå¹¶å°†æ·»åŠ çš„çª—å£ä¿¡æ¯è®°å½•åˆ°mTokenMapå’ŒmWindowMapå“ˆå¸Œè¡¨ä¸­ã€‚ åœ¨WMSæœåŠ¡ç«¯åˆ›å»ºäº†æ‰€éœ€å¯¹è±¡åï¼Œæ¥ç€è°ƒç”¨äº†WindowStateçš„attach()æ¥è¿›ä¸€æ­¥å®Œæˆçª—å£æ·»åŠ ã€‚ [WindowState.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(TAG, <span class="string">"Attaching "</span> + <span class="keyword">this</span> + <span class="string">" token="</span> + mToken</span><br><span class="line">        + <span class="string">", list="</span> + mToken.windows);</span><br><span class="line">    mSession.windowAddedLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Session.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">windowAddedLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mSurfaceSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(</span><br><span class="line">            TAG_WM, <span class="string">"First window added to "</span> + <span class="keyword">this</span> + <span class="string">", creating SurfaceSession"</span>);</span><br><span class="line">        mSurfaceSession = <span class="keyword">new</span> SurfaceSession();</span><br><span class="line">        <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(TAG_WM, <span class="string">"  NEW SURFACE SESSION "</span> + mSurfaceSession);</span><br><span class="line">        mService.mSessions.add(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) &#123;</span><br><span class="line">            mService.dispatchNewAnimatorScaleLocked(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mNumWindow++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-2-8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹"><a href="#4-2-2-8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹" class="headerlink" title="4.2.2.8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹"></a>4.2.2.8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹</h3><p>SurfaceSessionå¯¹è±¡æ‰¿æ‹…äº†åº”ç”¨ç¨‹åºä¸SurfaceFlingerä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹ï¼Œæ¯ä¸€ä¸ªéœ€è¦ä¸SurfaceFlingerè¿›ç¨‹äº¤äº’çš„åº”ç”¨ç¨‹åºç«¯éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªSurfaceSessionå¯¹è±¡ã€‚</p><p>å®¢æˆ·ç«¯è¯·æ±‚ [SurfaceSession.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SurfaceSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mNativeClient = nativeCreate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaå±‚çš„SurfaceSessionå¯¹è±¡æ„é€ è¿‡ç¨‹ä¼šé€šè¿‡JNIåœ¨nativeå±‚åˆ›å»ºä¸€ä¸ªSurfaceComposerClientå¯¹è±¡ã€‚ [android_view_SurfaceSession.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz)</span> </span>&#123;</span><br><span class="line">SurfaceComposerClient* client = <span class="keyword">new</span> SurfaceComposerClient();</span><br><span class="line">client-&gt;incStrong((<span class="keyword">void</span>*)nativeCreate);</span><br><span class="line"><span class="keyword">return</span> reinterpret_cast&lt;jlong&gt;(client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaå±‚çš„SurfaceSessionå¯¹è±¡ä¸C++å±‚çš„SurfaceComposerClientå¯¹è±¡ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€å…³ç³»ã€‚ æ˜¯å¦ä¼¼æ›¾ç›¸è¯†ï¼Œå°±æ˜¯å‰é¢æœ€å¼€å§‹SurfaceFlinger_Testç¨‹åºç¬¬ä¸€æ­¥ï¼šnew SurfaceComposerClientçš„è¿‡ç¨‹ã€‚ [SurfaceComposerClient.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SurfaceComposerClient::SurfaceComposerClient()</span><br><span class="line">: mStatus(NO_INIT), mComposer(Composer::getInstance())&#123;&#125;</span><br><span class="line"><span class="keyword">void</span> SurfaceComposerClient::onFirstRef() &#123;</span><br><span class="line"><span class="comment">//å¾—åˆ°SurfaceFlingerçš„ä»£ç†å¯¹è±¡BpSurfaceComposer  </span></span><br><span class="line"><span class="function">sp&lt;ISurfaceComposer&gt; <span class="title">sm</span><span class="params">(ComposerService::getComposerService()</span>)</span>;</span><br><span class="line"><span class="keyword">if</span> (sm != <span class="number">0</span>) &#123;</span><br><span class="line">    sp&lt;ISurfaceComposerClient&gt; conn = sm-&gt;createConnection();</span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="number">0</span>) &#123;</span><br><span class="line">        mClient = conn;</span><br><span class="line">        mStatus = NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceComposerClientç»§æ‰¿äºRefBaseç±»ï¼Œå½“ç¬¬ä¸€æ¬¡è¢«å¼ºå¼•ç”¨æ—¶ï¼ŒonFirstRefå‡½æ•°è¢«å›è°ƒï¼Œåœ¨è¯¥å‡½æ•°ä¸­SurfaceComposerClientä¼šè¯·æ±‚SurfaceFlingerä¸ºå½“å‰åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªClientå¯¹è±¡ï¼Œä¸“é—¨æ¥æ”¶è¯¥åº”ç”¨ç¨‹åºçš„è¯·æ±‚ï¼Œåœ¨SurfaceFlingerç«¯åˆ›å»ºå¥½Clientæœ¬åœ°Binderå¯¹è±¡åï¼Œå°†è¯¥Binderä»£ç†å¯¹è±¡è¿”å›ç»™åº”ç”¨ç¨‹åºç«¯ï¼Œå¹¶ä¿å­˜åœ¨SurfaceComposerClientçš„æˆå‘˜å˜é‡mClientä¸­ã€‚</p><p>æœåŠ¡ç«¯å¤„ç† åœ¨SurfaceFlingeræœåŠ¡ç«¯ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºäº¤äº’çš„Clientå¯¹è±¡ [SurfaceFlinger.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ISurfaceComposerClient&gt; SurfaceFlinger::createConnection()</span><br><span class="line">&#123;</span><br><span class="line">sp&lt;ISurfaceComposerClient&gt; bclient;</span><br><span class="line"><span class="function">sp&lt;Client&gt; <span class="title">client</span><span class="params">(new Client(<span class="keyword">this</span>)</span>)</span>;</span><br><span class="line">status_t err = client-&gt;initCheck();</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    bclient = client;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> bclient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-3ã€Appï¼ˆC-å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯-client-çš„è¿‡ç¨‹"><a href="#4-2-3ã€Appï¼ˆC-å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯-client-çš„è¿‡ç¨‹" class="headerlink" title="4.2.3ã€Appï¼ˆC++å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯(client)çš„è¿‡ç¨‹"></a>4.2.3ã€Appï¼ˆC++å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯(client)çš„è¿‡ç¨‹</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/11-Android-Graphics-App-Ask-SurfaceFlinger-Create-Client.png.png" alt="Markdown"></p><p>ç»§ç»­è¯¦ç»†åˆ†æAppAppï¼ˆC++å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯(client)çš„è¿‡ç¨‹</p><p>SurfaceComposerClientç¬¬ä¸€æ¬¡å¼ºå¼•ç”¨æ—¶ï¼Œä¼šæ‰§è¡ŒonFirstRef() [SurfaceComposerClient.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SurfaceComposerClient::SurfaceComposerClient()</span><br><span class="line">: mStatus(NO_INIT), mComposer(Composer::getInstance())&#123;&#125;</span><br><span class="line"><span class="keyword">void</span> SurfaceComposerClient::onFirstRef() &#123;</span><br><span class="line"><span class="comment">//å¾—åˆ°SurfaceFlingerçš„ä»£ç†å¯¹è±¡BpSurfaceComposer  </span></span><br><span class="line">sp&lt;ISurfaceComposer&gt; sm(ComposerService::getComposerService());</span><br><span class="line"><span class="keyword">if</span> (sm != <span class="number">0</span>) &#123;</span><br><span class="line">    sp&lt;ISurfaceComposerClient&gt; conn = sm-&gt;createConnection();</span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="number">0</span>) &#123;</span><br><span class="line">        mClient = conn;</span><br><span class="line">        mStatus = NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ­¥ï¼šè·å–â€SurfaceFlingerâ€æœåŠ¡ ComposerService::getComposerService()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*static*/</span> sp&lt;ISurfaceComposer&gt; ComposerService::getComposerService() &#123;</span><br><span class="line">    ComposerService&amp; instance = ComposerService::getInstance();</span><br><span class="line">    Mutex::Autolock _l(instance.mLock);</span><br><span class="line">    <span class="keyword">if</span> (instance.mComposerService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ComposerService::getInstance().connectLocked();</span><br><span class="line">        assert(instance.mComposerService != <span class="literal">NULL</span>);</span><br><span class="line">        ALOGD(<span class="string">"ComposerService reconnected"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance.mComposerService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ComposerService::getInstance()ä¼šè°ƒç”¨connectLocked()è·å–â€SurfaceFlingerâ€æœåŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ComposerService::ComposerService()</span><br><span class="line">: Singleton&lt;ComposerService&gt;() &#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    connectLocked();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void ComposerService::connectLocked() &#123;</span><br><span class="line">    const String16 name(&quot;SurfaceFlinger&quot;);</span><br><span class="line">    while (getService(name, &amp;mComposerService) != NO_ERROR) &#123;</span><br><span class="line">        usleep(250000);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å‰é¢instance.mComposerServiceå…¶å®è¿”å›çš„æ˜¯â€SurfaceFlingerâ€æœåŠ¡ã€‚ ç¬¬äºŒæ­¥ï¼šcreateConnection() æ¥ä¸‹æ¥å°±ä¼šè°ƒç”¨â€SurfaceFlingerâ€æœåŠ¡çš„createConnection()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ISurfaceComposerClient&gt; SurfaceFlinger::createConnection()</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;ISurfaceComposerClient&gt; bclient;</span><br><span class="line">    sp&lt;Client&gt; client(<span class="keyword">new</span> Client(<span class="keyword">this</span>));</span><br><span class="line">    <span class="keyword">status_t</span> err = client-&gt;initCheck();</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        bclient = client;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bclient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹"><a href="#4-2-4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹" class="headerlink" title="4.2.4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹"></a>4.2.4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹</h3><p>å‰é¢è®²ViewRootImpl.setViewæ—¶ï¼ŒrequestLayout()éœ€è¦Vsync triggerï¼ŒåŠ å…¥ç°åœ¨Vsyncä¿¡å·æ¥åˆ°ï¼Œäºæ˜¯ä¼šç»§ç»­æ‰§è¡Œã€‚Appç”³è¯·åˆ›å»ºSurfaceçš„è¿‡ç¨‹å°±åœ¨å…¶ä¸­ã€‚</p><p>å½“Vsyncäº‹ä»¶åˆ°æ¥æ—¶ï¼Œå°±ä¼šé€šè¿‡Choreographerçš„postCallback()ï¼Œæ¥ç€æ‰§è¡ŒmTraversalRunnableå¯¹è±¡çš„run()æ–¹æ³•ã€‚ mTraversalRunnableå¯¹è±¡çš„ç±»å‹ä¸ºTraversalRunnableï¼Œè¯¥ç±»å®ç°äº†Runnableæ¥å£ï¼Œåœ¨å…¶run()å‡½æ•°ä¸­è°ƒç”¨äº†doTraversal()å‡½æ•°æ¥å®Œæˆçª—å£å¸ƒå±€ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> TraversalRunnable mTraversalRunnable = <span class="keyword">new</span> TraversalRunnable();</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line">        ......</span><br><span class="line">        performTraversals();</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>performTraversalså‡½æ•°ç›¸å½“å¤æ‚ï¼Œå…¶ä¸»è¦å®ç°ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š</p><p>1.æ‰§è¡Œçª—å£æµ‹é‡ï¼›</p><p>2.æ‰§è¡Œçª—å£æ³¨å†Œï¼›</p><p>3.æ‰§è¡Œçª—å£å¸ƒå±€ï¼›</p><p>4.æ‰§è¡Œçª—å£ç»˜å›¾ï¼›</p><p>[-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£æµ‹é‡******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">        windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************å‘WMSæœåŠ¡æ·»åŠ çª—å£******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">            viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£å¸ƒå±€******************/</span></span><br><span class="line">    <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">        performLayout(lp, mWidth, mHeight);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£ç»˜åˆ¶******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">        ......</span><br><span class="line">        performDraw();</span><br><span class="line">    &#125; ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€æ‰§è¡Œçª—å£æµ‹é‡performMeasure() [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    &#125; ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-Javaå±‚"><a href="#4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-Javaå±‚" class="headerlink" title="4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(Javaå±‚)"></a>4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(Javaå±‚)</h4><p>2ã€æ‰§è¡Œçª—å£æ³¨å†ŒrelayoutWindowï¼› [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(WindowManager.LayoutParams params, <span class="keyword">int</span> viewVisibility,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> insetsPending)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">int</span> relayoutResult = mWindowSession.relayout(</span><br><span class="line">            mWindow, mSeq, params,</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredWidth() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredHeight() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            viewVisibility, insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="number">0</span>,</span><br><span class="line">            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</span><br><span class="line">            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingConfiguration,</span><br><span class="line">            mSurface);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> relayoutResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡å‰é¢è·å–çš„IWindowSessionä»£ç†å¯¹è±¡è¯·æ±‚WMSæœåŠ¡æ‰§è¡Œçª—å£å¸ƒå±€ï¼ŒmSurfaceæ˜¯ViewRootImplçš„æˆå‘˜å˜é‡ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Surface mSurface = <span class="keyword">new</span> Surface();</span><br></pre></td></tr></table></figure><p>[-&gt;Surface.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create an empty surface, which will later be filled in by readFromParcel().</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Surface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥Surfaceæ„é€ å‡½æ•°ä»…ä»…åˆ›å»ºäº†ä¸€ä¸ªç©ºSurfaceå¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å¯¹è¯¥Surfaceè¿›ç¨‹nativeå±‚çš„åˆå§‹åŒ–ï¼Œåˆ°æ­¤æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸ºæ¯ä¸ªçª—å£å¯¹è±¡éƒ½åˆ›å»ºäº†ä¸€ä¸ªSurfaceå¯¹è±¡ã€‚å¹¶ä¸”å°†è¯¥Surfaceé€šè¿‡è·¨è¿›ç¨‹æ–¹å¼ä¼ è¾“ç»™WMSæœåŠ¡è¿›ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Androidç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡éœ€è¦åœ¨ä¸åŒè¿›ç¨‹é—´ä¼ è¾“ï¼Œå¿…é¡»å®ç°Parcelableæ¥å£ï¼ŒSurfaceç±»æ­£å¥½å®ç°äº†Parcelableæ¥å£ã€‚ViewRootImplé€šè¿‡IWindowSessionæ¥å£è¯·æ±‚WMSçš„å®Œæ•´è¿‡ç¨‹å¦‚ä¸‹ï¼š [-&gt;IWindowSession.java$ Proxy]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* This file is auto-generated.  DO NOT MODIFY</span></span><br><span class="line"><span class="comment">*  * Original file: frameworks/base/core/java/android/view/IWindowSession.aidl</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(android.view.IWindow window, <span class="keyword">int</span> seq, android.view.WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags, android.graphics.Rect outFrame, android.graphics.Rect outOverscanInsets, android.graphics.Rect outContentInsets, android.graphics.Rect outVisibleInsets, android.graphics.Rect outStableInsets, android.graphics.Rect outOutsets, android.graphics.Rect outBackdropFrame, android.content.res.Configuration outConfig, android.view.Surface outSurface)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line"><span class="keyword">int</span> _result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    mRemote.transact(Stub.TRANSACTION_relayout, _data, _reply, <span class="number">0</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ((<span class="number">0</span> != _reply.readInt())) &#123;</span><br><span class="line">        outSurface.readFromParcel(_reply);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¯¥å‡½æ•°çš„å®ç°å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­åˆ›å»ºçš„Surfaceå¯¹è±¡å¹¶æ²¡æœ‰ä¼ é€’åˆ°WMSæœåŠ¡è¿›ç¨‹ï¼Œåªæ˜¯è¯»å–WMSæœåŠ¡è¿›ç¨‹è¿”å›æ¥çš„Surfaceã€‚é‚£ä¹ˆWMSæœåŠ¡è¿›ç¨‹æ˜¯å¦‚ä½•å“åº”åº”ç”¨ç¨‹åºè¿›ç¨‹å¸ƒå±€è¯·æ±‚çš„å‘¢ï¼Ÿ</p><p>[-&gt;IWindowSession.java$ Stub]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">switch</span> (code)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> TRANSACTION_relayout:</span><br><span class="line">  &#123;</span><br><span class="line">    ......</span><br><span class="line">    android.view.Surface _arg15;</span><br><span class="line">    _arg15 = <span class="keyword">new</span> android.view.Surface();</span><br><span class="line">    <span class="keyword">int</span> _result = <span class="keyword">this</span>.relayout(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7, _arg8, _arg9, _arg10, _arg11, _arg12, _arg13, _arg14, _arg15);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(_result);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ((_arg15!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">    reply.writeInt(<span class="number">1</span>);</span><br><span class="line">    _arg15.writeToParcel(reply, android.os.Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å¯ä»¥çœ‹å‡ºï¼ŒWMSæœåŠ¡åœ¨å“åº”åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚æ·»åŠ çª—å£æ—¶ï¼Œé¦–å…ˆåœ¨å½“å‰è¿›ç¨‹ç©ºé—´åˆ›å»ºä¸€ä¸ªSurfaceå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android.view.Surface _arg15;</span><br><span class="line">_arg15 = <span class="keyword">new</span> android.view.Surface();</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨Sessionçš„relayout()å‡½æ•°è¿›ä¸€æ­¥å®Œæˆçª—å£æ·»åŠ è¿‡ç¨‹ï¼Œæœ€åå°†WMSæœåŠ¡ä¸­åˆ›å»ºçš„Surfaceè¿”å›ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹å’ŒWMSæœåŠ¡è¿›ç¨‹åˆ†åˆ«åˆ›å»ºäº†ä¸€ä¸ªSurfaceå¯¹è±¡ï¼Œä½†æ˜¯ä»–ä»¬è°ƒç”¨çš„éƒ½æ˜¯Surfaceçš„æ— å‚æ„é€ å‡½æ•°ï¼Œåœ¨è¯¥æ„é€ å‡½æ•°ä¸­å¹¶æœªçœŸæ­£åˆå§‹åŒ–nativeå±‚çš„Surfaceï¼Œé‚£nativeå±‚çš„Surfaceæ˜¯åœ¨é‚£é‡Œåˆ›å»ºçš„å‘¢ï¼Ÿ [-&gt;Session.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = mService.relayoutWindow(<span class="keyword">this</span>, window, seq, attrs,</span><br><span class="line">            requestedWidth, requestedHeight, viewFlags, flags,</span><br><span class="line">            outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</span><br><span class="line">            outStableInsets, outsets, outBackdropFrame, outConfig, outSurface);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (viewVisibility == View.VISIBLE &amp;&amp;</span><br><span class="line">                (win.mAppToken == <span class="keyword">null</span> || !win.mAppToken.clientHidden)) &#123;</span><br><span class="line">            result = relayoutVisibleWindow(outConfig, result, win, winAnimator, attrChanges,</span><br><span class="line">                    oldVisibility);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = createSurfaceControl(outSurface, result, win, winAnimator);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               ......</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createSurfaceControl</span><span class="params">(Surface outSurface, <span class="keyword">int</span> result, WindowState win,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowStateAnimator winAnimator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!win.mHasSurface) &#123;</span><br><span class="line">        result |= RELAYOUT_RES_SURFACE_CHANGED;</span><br><span class="line">    &#125;</span><br><span class="line">    WindowSurfaceController surfaceController = winAnimator.createSurfaceLocked();</span><br><span class="line">    <span class="keyword">if</span> (surfaceController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        surfaceController.getSurface(outSurface);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        outSurface.release();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowSurfaceController.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getSurface</span><span class="params">(Surface outSurface)</span> </span>&#123;</span><br><span class="line">    outSurface.copyFrom(mSurfaceControl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowStateAnimator.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function">WindowSurfaceController <span class="title">createSurfaceLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        mSurfaceController = <span class="keyword">new</span> WindowSurfaceController(mSession.mSurfaceSession,</span><br><span class="line">                attrs.getTitle().toString(),</span><br><span class="line">                width, height, format, flags, <span class="keyword">this</span>);</span><br><span class="line">        w.setHasSurface(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> mSurfaceController;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowSurfaceController.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WindowSurfaceController</span><span class="params">(SurfaceSession s,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> flags, WindowStateAnimator animator)</span> </span>&#123;</span><br><span class="line">    mAnimator = animator;</span><br><span class="line">    mSurfaceW = w;</span><br><span class="line">    mSurfaceH = h;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (animator.mWin.isChildWindow() &amp;&amp;</span><br><span class="line">            animator.mWin.mSubLayer &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            animator.mWin.mAppToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mSurfaceControl = <span class="keyword">new</span> SurfaceControl(</span><br><span class="line">                s, name, w, h, format, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-C-å±‚"><a href="#4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-C-å±‚" class="headerlink" title="4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(C++å±‚)"></a>4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(C++å±‚)</h4><p>SurfaceControlåˆ›å»ºè¿‡ç¨‹ [-&gt;SurfaceControl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SurfaceControl</span><span class="params">(SurfaceSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> OutOfResourcesException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mNativeObject = nativeCreate(session, name, w, h, format, flags);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_SurfaceControl.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz, jobject sessionObj,</span></span></span><br><span class="line"><span class="function"><span class="params">    jstring nameStr, jint w, jint h, jint format, jint flags)</span> </span>&#123;</span><br><span class="line"><span class="function">ScopedUtfChars <span class="title">name</span><span class="params">(env, nameStr)</span></span>;</span><br><span class="line">sp&lt;SurfaceComposerClient&gt; client(android_view_SurfaceSession_getClient(env, sessionObj));</span><br><span class="line">sp&lt;SurfaceControl&gt; surface = client-&gt;createSurface(</span><br><span class="line">        String8(name.c_str()), w, h, format, flags);</span><br><span class="line"><span class="keyword">if</span> (surface == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    jniThrowException(env, OutOfResourcesException, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">surface-&gt;incStrong((<span class="keyword">void</span> *)nativeCreate);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°é¦–å…ˆå¾—åˆ°å‰é¢åˆ›å»ºå¥½çš„SurfaceComposerClientå¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡å‘SurfaceFlingerç«¯çš„Clientå¯¹è±¡å‘é€åˆ›å»ºSurfaceçš„è¯·æ±‚ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ªSurfaceControlå¯¹è±¡ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/12-Android-Graphics-App-Ask-SurfaceFlinger-CreateSurface.png" alt="Markdown"></p><p>[-&gt;SurfaceComposerClient.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceControl&gt; SurfaceComposerClient::createSurface(</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">    <span class="keyword">uint32_t</span> w,</span><br><span class="line">    <span class="keyword">uint32_t</span> h,</span><br><span class="line">    PixelFormat format,</span><br><span class="line">    <span class="keyword">uint32_t</span> flags)</span><br><span class="line">    &#123;</span><br><span class="line">sp&lt;SurfaceControl&gt; sur;</span><br><span class="line"><span class="keyword">if</span> (mStatus == NO_ERROR) &#123;</span><br><span class="line">    sp&lt;IBinder&gt; handle;</span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; gbp;</span><br><span class="line">    <span class="keyword">status_t</span> err = mClient-&gt;createSurface(name, w, h, format, flags,</span><br><span class="line">            &amp;handle, &amp;gbp);</span><br><span class="line">    ALOGE_IF(err, <span class="string">"SurfaceComposerClient::createSurface error %s"</span>, strerror(-err));</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        sur = <span class="keyword">new</span> SurfaceControl(<span class="keyword">this</span>, handle, gbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceComposerClientå°†Surfaceåˆ›å»ºè¯·æ±‚è½¬äº¤ç»™ä¿å­˜åœ¨å…¶æˆå‘˜å˜é‡ä¸­çš„Bp SurfaceComposerClientå¯¹è±¡æ¥å®Œæˆï¼Œåœ¨SurfaceFlingerç«¯çš„Clientæœ¬åœ°å¯¹è±¡ä¼šè¿”å›ä¸€ä¸ªISurfaceä»£ç†å¯¹è±¡ç»™åº”ç”¨ç¨‹åºï¼Œé€šè¿‡è¯¥ä»£ç†å¯¹è±¡ä¸ºåº”ç”¨ç¨‹åºå½“å‰åˆ›å»ºçš„Surfaceåˆ›å»ºä¸€ä¸ªSurfaceControlå¯¹è±¡ã€‚ [ISurfaceComposerClient.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">createSurface</span><span class="params">(<span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> height, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IBinder&gt;* handle,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IGraphicBufferProducer&gt;* gbp)</span> </span>&#123;</span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    ......</span><br><span class="line">    remote()-&gt;transact(CREATE_SURFACE, data, &amp;reply);</span><br><span class="line">    *handle = reply.readStrongBinder();</span><br><span class="line">    *gbp = interface_cast&lt;IGraphicBufferProducer&gt;(reply.readStrongBinder());</span><br><span class="line">    <span class="keyword">return</span> reply.readInt32();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Client.cpp] MessageCreateSurfaceæ¶ˆæ¯æ˜¯ä¸“é—¨ä¸ºåº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceè€Œå®šä¹‰çš„ä¸€ç§æ¶ˆæ¯ç±»å‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">status_t</span> Client::createSurface(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">        sp&lt;IBinder&gt;* handle,</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp)&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * createSurface must be called from the GL thread so that it can</span></span><br><span class="line"><span class="comment">     * have access to the GL context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MessageCreateLayer</span> :</span> <span class="keyword">public</span> MessageBase &#123;</span><br><span class="line">        SurfaceFlinger* flinger;</span><br><span class="line">        Client* client;</span><br><span class="line">        sp&lt;IBinder&gt;* handle;</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp;</span><br><span class="line">        <span class="keyword">status_t</span> result;</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name;</span><br><span class="line">        <span class="keyword">uint32_t</span> w, h;</span><br><span class="line">        PixelFormat format;</span><br><span class="line">        <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        MessageCreateLayer(SurfaceFlinger* flinger,</span><br><span class="line">                <span class="keyword">const</span> String8&amp; name, Client* client,</span><br><span class="line">                <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">                sp&lt;IBinder&gt;* handle,</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt;* gbp)</span><br><span class="line">            : flinger(flinger), client(client),</span><br><span class="line">              handle(handle), gbp(gbp), result(NO_ERROR),</span><br><span class="line">              name(name), w(w), h(h), format(format), flags(flags) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">status_t</span> getResult() <span class="keyword">const</span> &#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">handler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            result = flinger-&gt;createLayer(name, client, w, h, format, flags,</span><br><span class="line">                    handle, gbp);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sp&lt;MessageBase&gt; msg = <span class="keyword">new</span> MessageCreateLayer(mFlinger.get(),</span><br><span class="line">            name, <span class="keyword">this</span>, w, h, format, flags, handle, gbp);</span><br><span class="line">    mFlinger-&gt;postMessageSync(msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;MessageCreateLayer*&gt;( msg.get() )-&gt;getResult();</span><br><span class="line">    &#125;</span><br><span class="line">Clientå°†åº”ç”¨ç¨‹åºåˆ›å»ºSurfaceçš„è¯·æ±‚è½¬æ¢ä¸ºå¼‚æ­¥æ¶ˆæ¯æŠ•é€’åˆ°SurfaceFlingerçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå°†åˆ›å»ºSurfaceçš„ä»»åŠ¡è½¬äº¤ç»™SurfaceFlingerã€‚</span><br><span class="line">[-&gt;SurfaceFlinger.cpp]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> SurfaceFlinger::createLayer(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">        <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">        sp&lt;IBinder&gt;* handle, sp&lt;IGraphicBufferProducer&gt;* gbp)&#123;</span><br><span class="line">    <span class="comment">//ALOGD("createLayer for (%d x %d), name=%s", w, h, name.string());</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    sp&lt;Layer&gt; layer;</span><br><span class="line">    <span class="comment">////æ ¹æ®flagsåˆ›å»ºä¸åŒç±»å‹çš„layer</span></span><br><span class="line">    <span class="keyword">switch</span> (flags &amp; ISurfaceComposerClient::eFXSurfaceMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceNormal:</span><br><span class="line">            result = createNormalLayer(client,</span><br><span class="line">                    name, w, h, flags, format,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceDim:</span><br><span class="line">            result = createDimLayer(client,</span><br><span class="line">                    name, w, h, flags,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            result = BAD_VALUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†åˆ›å»ºå¥½çš„Layerå¯¹è±¡ä¿å­˜åœ¨Clientä¸­  </span></span><br><span class="line">    result = addClientLayer(client, *handle, *gbp, layer);</span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setTransactionFlags(eTransactionNeeded);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>SurfaceFlingeræ ¹æ®æ ‡å¿—ä½åˆ›å»ºå¯¹åº”ç±»å‹çš„Surfaceï¼Œå½“å‰ç³»ç»Ÿå®šä¹‰äº†3ç§ç±»å‹çš„Layer: [-&gt;ISurfaceComposerClient.h]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eFXSurfaceNormal    = <span class="number">0x00000000</span>,</span><br><span class="line">eFXSurfaceDim       = <span class="number">0x00020000</span>,</span><br><span class="line">eFXSurfaceMask      = <span class="number">0x000F0000</span></span><br></pre></td></tr></table></figure><p>[-&gt;SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> SurfaceFlinger::createNormalLayer(<span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, <span class="keyword">uint32_t</span> flags, PixelFormat&amp; format,</span><br><span class="line">    sp&lt;IBinder&gt;* handle, sp&lt;IGraphicBufferProducer&gt;* gbp, sp&lt;Layer&gt;* outLayer)&#123;</span><br><span class="line"><span class="comment">// initialize the surfaces</span></span><br><span class="line"><span class="keyword">switch</span> (format) &#123;</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_TRANSPARENT:</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_TRANSLUCENT:</span><br><span class="line">    format = PIXEL_FORMAT_RGBA_8888;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_OPAQUE:</span><br><span class="line">    format = PIXEL_FORMAT_RGBX_8888;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åœ¨SurfaceFlingerç«¯ä¸ºåº”ç”¨ç¨‹åºçš„Surfaceåˆ›å»ºå¯¹åº”çš„Layerå¯¹è±¡  </span></span><br><span class="line">*outLayer = <span class="keyword">new</span> Layer(<span class="keyword">this</span>, client, name, w, h, flags);</span><br><span class="line"><span class="keyword">status_t</span> err = (*outLayer)-&gt;setBuffers(w, h, format, flags);</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    *handle = (*outLayer)-&gt;getHandle();</span><br><span class="line">    *gbp = (*outLayer)-&gt;getProducer();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALOGE_IF(err, <span class="string">"createNormalLayer() failed (%s)"</span>, strerror(-err));</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨SurfaceFlingeræœåŠ¡ç«¯ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºçš„Surfaceåˆ›å»ºå¯¹åº”çš„Layerå¯¹è±¡ã€‚åº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/13-Android-Graphics-App-Ask-SurfaceFlinger-Create-Layer.png.png.png" alt="Markdown"><br>ç¬¬ä¸€æ¬¡å¼ºå¼•ç”¨Layerå¯¹è±¡æ—¶ï¼ŒonFirstRef()å‡½æ•°è¢«å›è°ƒ [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::onFirstRef() &#123;</span><br><span class="line"><span class="comment">// Creates a custom BufferQueue for SurfaceFlingerConsumer to use</span></span><br><span class="line">sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer;</span><br><span class="line"><span class="comment">//åˆ›å»ºBufferQueueå¯¹è±¡</span></span><br><span class="line">BufferQueue::createBufferQueue(&amp;producer, &amp;consumer);</span><br><span class="line">mProducer = <span class="keyword">new</span> MonitoredProducer(producer, mFlinger);</span><br><span class="line">mSurfaceFlingerConsumer = <span class="keyword">new</span> SurfaceFlingerConsumer(consumer, mTextureName,</span><br><span class="line">        <span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(<span class="number">0</span>));</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setContentsChangedListener(<span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setName(mName);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TARGET_DISABLE_TRIPLE_BUFFERING</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">warning</span> <span class="meta-string">"disabling triple buffering"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">mProducer-&gt;setMaxDequeuedBufferCount(<span class="number">2</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mFlinger-&gt;getDefaultDisplayDevice());</span><br><span class="line">updateTransformHint(hw);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®bufferå¯ç”¨ç›‘å¬å™¨çš„æ³¨å†Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå½“ç”Ÿäº§è€…ä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºå¡«å……å¥½å›¾å½¢bufferæ•°æ®åï¼Œé€šè¿‡å›è°ƒæ–¹å¼é€šçŸ¥æ¶ˆè´¹è€…çš„</p><h4 id="4-2-4-2ã€BufferQueueæ„é€ è¿‡ç¨‹"><a href="#4-2-4-2ã€BufferQueueæ„é€ è¿‡ç¨‹" class="headerlink" title="4.2.4.2ã€BufferQueueæ„é€ è¿‡ç¨‹"></a>4.2.4.2ã€BufferQueueæ„é€ è¿‡ç¨‹</h4><p>[-&gt;BufferQueue.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> BufferQueue::createBufferQueue(sp&lt;IGraphicBufferProducer&gt;* outProducer,</span><br><span class="line">    sp&lt;IGraphicBufferConsumer&gt;* outConsumer,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferAlloc&gt;&amp; allocator) &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">sp&lt;BufferQueueCore&gt; core(<span class="keyword">new</span> BufferQueueCore(allocator));</span><br><span class="line">sp&lt;IGraphicBufferProducer&gt; producer(<span class="keyword">new</span> BufferQueueProducer(core));</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer(<span class="keyword">new</span> BufferQueueConsumer(core));</span><br><span class="line">*outProducer = producer;</span><br><span class="line">*outConsumer = consumer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;BufferQueueCore.cpp] æ‰€ä»¥æ ¸å¿ƒéƒ½æ˜¯è¿™ä¸ªBufferQueueCoreï¼Œä»–æ˜¯ç®¡ç†å›¾å½¢ç¼“å†²åŒºçš„ä¸­æ¢ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BufferQueueCore::BufferQueueCore(<span class="keyword">const</span> sp&lt;IGraphicBufferAlloc&gt;&amp; allocator) :</span><br><span class="line">mAllocator(allocator),</span><br><span class="line">......</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (allocator == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    sp&lt;ISurfaceComposer&gt; composer(ComposerService::getComposerService());</span><br><span class="line">    mAllocator = composer-&gt;createGraphicBufferAlloc();</span><br><span class="line">    <span class="keyword">if</span> (mAllocator == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        BQ_LOGE(<span class="string">"createGraphicBufferAlloc failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> numStartingBuffers = getMaxBufferCountLocked();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> s = <span class="number">0</span>; s &lt; numStartingBuffers; s++) &#123;</span><br><span class="line">    mFreeSlots.insert(s);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> s = numStartingBuffers; s &lt; BufferQueueDefs::NUM_BUFFER_SLOTS;</span><br><span class="line">        s++) &#123;</span><br><span class="line">    mUnusedSlots.push_front(s);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BufferQueueCoreç±»ä¸­å®šä¹‰äº†ä¸€ä¸ª64é¡¹çš„æ•°æ®mSlotsï¼Œæ˜¯ä¸€ä¸ªå®¹é‡å¤§å°ä¸º64çš„æ•°ç»„ï¼Œå› æ­¤BufferQueueCoreå¯ä»¥ç®¡ç†æœ€å¤š64å—çš„GraphicBufferã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/14-Android-Graphics-App-SurfaceFlinger-BufferSlot.png.png" alt="Markdown"></p><p>[-&gt;ISurfaceComposer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">virtual</span> sp&lt;IGraphicBufferAlloc&gt; createGraphicBufferAlloc()</span><br><span class="line">&#123;</span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    data.writeInterfaceToken(ISurfaceComposer::getInterfaceDescriptor());</span><br><span class="line">    remote()-&gt;transact(BnSurfaceComposer::CREATE_GRAPHIC_BUFFER_ALLOC, data, &amp;reply);</span><br><span class="line">    <span class="keyword">return</span> interface_cast&lt;IGraphicBufferAlloc&gt;(reply.readStrongBinder());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IGraphicBufferAlloc&gt; SurfaceFlinger::createGraphicBufferAlloc()</span><br><span class="line">&#123;</span><br><span class="line">sp&lt;GraphicBufferAlloc&gt; gba(<span class="keyword">new</span> GraphicBufferAlloc());</span><br><span class="line"><span class="keyword">return</span> gba;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>GraphicBufferAllocæ„é€ è¿‡ç¨‹</strong></p><p>[-&gt;GraphicBufferAlloc.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;GraphicBuffer&gt; GraphicBufferAlloc::createGraphicBuffer(<span class="keyword">uint32_t</span> width,</span><br><span class="line">    <span class="keyword">uint32_t</span> height, PixelFormat format, <span class="keyword">uint32_t</span> usage,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> requestorName, <span class="keyword">status_t</span>* error) &#123;</span><br><span class="line">sp&lt;GraphicBuffer&gt; graphicBuffer(<span class="keyword">new</span> GraphicBuffer(</span><br><span class="line">        width, height, format, usage, <span class="built_in">std</span>::move(requestorName)));</span><br><span class="line"><span class="keyword">status_t</span> err = graphicBuffer-&gt;initCheck();</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> graphicBuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹</strong> [-&gt;GraphicBuffer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GraphicBuffer::GraphicBuffer(<span class="keyword">uint32_t</span> inWidth, <span class="keyword">uint32_t</span> inHeight,</span><br><span class="line">    PixelFormat inFormat, <span class="keyword">uint32_t</span> inUsage, <span class="built_in">std</span>::<span class="built_in">string</span> requestorName)</span><br><span class="line">: BASE(), mOwner(ownData), mBufferMapper(GraphicBufferMapper::get()),</span><br><span class="line">  mInitCheck(NO_ERROR), mId(getUniqueId()), mGenerationNumber(<span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">width  =</span><br><span class="line">height =</span><br><span class="line">stride =</span><br><span class="line">format =</span><br><span class="line">usage  = <span class="number">0</span>;</span><br><span class="line">handle = <span class="literal">NULL</span>;</span><br><span class="line">mInitCheck = initSize(inWidth, inHeight, inFormat, inUsage,</span><br><span class="line">        <span class="built_in">std</span>::move(requestorName));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å›¾å½¢bufferçš„å®½é«˜ã€æ ¼å¼ç­‰ä¿¡æ¯ä¸ºå›¾å½¢ç¼“å†²åŒºåˆ†é…å­˜å‚¨ç©ºé—´ã€‚</p><p>ä½¿ç”¨GraphicBufferAllocatorå¯¹è±¡æ¥ä¸ºå›¾å½¢ç¼“å†²åŒºåˆ†é…å†…å­˜ç©ºé—´ï¼ŒGraphicBufferAllocatoræ˜¯å¯¹Grallocæ¨¡å—ä¸­çš„gpuè®¾å¤‡çš„å°è£…ç±»ã€‚å…³äºGraphicBufferAllocatorå†…å­˜åˆ†é…è¿‡ç¨‹è¯·ä»¥åä½œåˆ†æï¼Œå›¾å½¢ç¼“å†²åŒºåˆ†é…å®Œæˆåï¼Œè¿˜ä¼šæ˜ å°„åˆ°SurfaceFlingeræœåŠ¡è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p><p><strong>Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ</strong></p><p>[-&gt;Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Layer::Layer(SurfaceFlinger* flinger, <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">:   contentDirty(<span class="literal">false</span>),</span><br><span class="line">    sequence(<span class="keyword">uint32_t</span>(android_atomic_inc(&amp;sSequence))),</span><br><span class="line">    mFlinger(flinger),</span><br><span class="line">    mTextureName(<span class="number">-1U</span>),</span><br><span class="line">    mPremultipliedAlpha(<span class="literal">true</span>),</span><br><span class="line">    mName(<span class="string">"unnamed"</span>),</span><br><span class="line">    mFormat(PIXEL_FORMAT_NONE),</span><br><span class="line">    ......&#123;</span><br><span class="line">mCurrentCrop.makeInvalid();</span><br><span class="line">mFlinger-&gt;getRenderEngine().genTextures(<span class="number">1</span>, &amp;mTextureName);</span><br><span class="line">mTexture.init(Texture::TEXTURE_EXTERNAL, mTextureName);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤æ‰ç®—çœŸæ­£åˆ›å»ºäº†ä¸€ä¸ªå¯ç”¨äºç»˜å›¾çš„Surface (Layer)ï¼Œä»ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨WMSæœåŠ¡è¿›ç¨‹ç«¯ï¼Œå…¶å®åˆ›å»ºäº†ä¸¤ä¸ªJavaå±‚çš„Surfaceå¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªSurfaceä½¿ç”¨äº†æ— å‚æ„é€ å‡½æ•°ï¼Œä»…ä»…æ„é€ ä¸€ä¸ªSurfaceå¯¹è±¡è€Œå·²ï¼Œè€Œç¬¬äºŒä¸ªSurfaceå´ä½¿ç”¨äº†æœ‰å‚æ„é€ å‡½æ•°ï¼Œå‚æ•°æŒ‡å®šäº†å›¾è±¡å®½é«˜ç­‰ä¿¡æ¯ï¼Œè¿™ä¸ªJavaå±‚Surfaceå¯¹è±¡è¿˜ä¼šåœ¨nativeå±‚è¯·æ±‚SurfaceFlingeråˆ›å»ºä¸€ä¸ªçœŸæ­£èƒ½ç”¨äºç»˜åˆ¶å›¾è±¡çš„nativeå±‚Surfaceã€‚æœ€åé€šè¿‡æµ…æ‹·è´çš„æ–¹å¼å°†ç¬¬äºŒä¸ªSurfaceå¤åˆ¶åˆ°ç¬¬ä¸€ä¸ªSurfaceä¸­ï¼Œæœ€åé€šè¿‡writeToParcelæ–¹å¼å†™å›åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/15-Android-Graphics-App-WMS-SurfaceFlinger-Surface-SurfaceControl.png" alt="Markdown"></p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåº”ç”¨ç¨‹åºå’ŒWMSä¸€å…±åˆ›å»ºäº†3ä¸ªJavaå±‚Surfaceï¼ˆSurfaceControlï¼‰å¯¹è±¡ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè€ŒçœŸæ­£èƒ½ç”¨äºç»˜å›¾çš„Surfaceåªæœ‰3å·ï¼Œé‚£ä¹ˆ3å·Surfaceä¸2å·Surfaceä¹‹é—´æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼ŸoutSurface.copyFrom(surface)</p><p>[Surface.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyFrom</span><span class="params">(SurfaceControl other)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">long</span> surfaceControlPtr = other.mNativeObject;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">long</span> newNativeObject = nativeCreateFromSurfaceControl(surfaceControlPtr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNativeObject != <span class="number">0</span>) &#123;</span><br><span class="line">            nativeRelease(mNativeObject);</span><br><span class="line">        &#125;</span><br><span class="line">        setNativeObjectLocked(newNativeObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreateFromSurfaceControl</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong surfaceControlNativeObj)</span> </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is used by the WindowManagerService just after constructing</span></span><br><span class="line"><span class="comment"> * a Surface and is necessary for returning the Surface reference to</span></span><br><span class="line"><span class="comment"> * the caller. At this point, we should only have a SurfaceControl.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">sp&lt;SurfaceControl&gt; ctrl(<span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(surfaceControlNativeObj));</span><br><span class="line">sp&lt;Surface&gt; surface(ctrl-&gt;getSurface());</span><br><span class="line"><span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    surface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2å·Surfaceå¼•ç”¨åˆ°äº†3å·Surfaceçš„SurfaceControlå¯¹è±¡åï¼Œé€šè¿‡writeToParcel()å‡½æ•°å†™ä¼šåˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚ [Surface.java]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">        @Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dest == null) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"dest must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This must be kept synchronized with the native parceling code</span></span><br><span class="line">        <span class="comment">// in frameworks/native/libs/Surface.cpp</span></span><br><span class="line">        dest.writeString(mName);</span><br><span class="line">        dest.writeInt(mIsSingleBuffered ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        nativeWriteToParcel(mNativeObject, dest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; Parcelable.PARCELABLE_WRITE_RETURN_VALUE) != <span class="number">0</span>) &#123;</span><br><span class="line">        release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeWriteToParcel</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject parcelObj)</span> </span>&#123;</span><br><span class="line">Parcel* parcel = parcelForJavaObject(env, parcelObj);</span><br><span class="line"><span class="keyword">if</span> (parcel == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    doThrowNPE(env);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">sp&lt;Surface&gt; self(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line">android::view::Surface surfaceShim;</span><br><span class="line"><span class="keyword">if</span> (self != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    surfaceShim.graphicBufferProducer = self-&gt;getIGraphicBufferProducer();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Calling code in Surface.java has already written the name of the Surface</span></span><br><span class="line"><span class="comment">// to the Parcel</span></span><br><span class="line">surfaceShim.writeToParcel(parcel, <span class="comment">/*nameAlreadyWritten*/</span><span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„1å·SurfaceæŒ‰ç›¸åé¡ºåºè¯»å–WMSæœåŠ¡ç«¯è¿”å›è¿‡æ¥çš„Binderå¯¹è±¡ç­‰æ•°æ®ï¼Œå¹¶æ„é€ ä¸€ä¸ªnativeå±‚çš„Surfaceå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span><span class="params">(Parcel source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (source == null) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"source must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        <span class="comment">// nativeReadFromParcel() will either return mNativeObject, or</span></span><br><span class="line">        <span class="comment">// create a new native Surface and return it after reducing</span></span><br><span class="line">        <span class="comment">// the reference count on mNativeObject.  Either way, it is</span></span><br><span class="line">        <span class="comment">// not necessary to call nativeRelease() here.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This must be kept synchronized with the native parceling code</span></span><br><span class="line">        <span class="comment">// in frameworks/native/libs/Surface.cpp</span></span><br><span class="line">        mName = source.readString();</span><br><span class="line">        mIsSingleBuffered = source.readInt() != <span class="number">0</span>;</span><br><span class="line">        setNativeObjectLocked(nativeReadFromParcel(mNativeObject, source));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„1å·SurfaceæŒ‰ç›¸åé¡ºåºè¯»å–WMSæœåŠ¡ç«¯è¿”å›è¿‡æ¥çš„Binderå¯¹è±¡ç­‰æ•°æ®ï¼Œå¹¶æ„é€ ä¸€ä¸ªnativeå±‚çš„Surfaceå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreateFromSurfaceControl</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong surfaceControlNativeObj)</span> </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is used by the WindowManagerService just after constructing</span></span><br><span class="line"><span class="comment"> * a Surface and is necessary for returning the Surface reference to</span></span><br><span class="line"><span class="comment"> * the caller. At this point, we should only have a SurfaceControl.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">sp&lt;SurfaceControl&gt; ctrl(<span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(surfaceControlNativeObj));</span><br><span class="line">sp&lt;Surface&gt; surface(ctrl-&gt;getSurface());</span><br><span class="line"><span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    surface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªActivityå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªSurfaceï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªActivityåªæœ‰ä¸€ä¸ªSurfaceï¼Œå½“Activityä¸­ä½¿ç”¨SurfaceViewæ—¶ï¼Œå°±å­˜åœ¨å¤šä¸ªSurfaceã€‚Activityé»˜è®¤surfaceæ˜¯åœ¨relayoutWindowè¿‡ç¨‹ä¸­ç”±WMSæœåŠ¡åˆ›å»ºçš„ï¼Œç„¶åå›ä¼ ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªSurfaceå…¶å®å°±æ˜¯åº”ç”¨ç¨‹åºç«¯çš„æœ¬åœ°çª—å£ï¼Œå…³äºSurfaceçš„åˆå§‹åŒ–è¿‡ç¨‹è¿™é‡Œå°±ä¸åœ¨ä»‹ç»ã€‚</p><h4 id="4-2-4-2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹"><a href="#4-2-4-2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹" class="headerlink" title="4.2.4.2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹"></a>4.2.4.2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IGraphicBufferProducer&gt; producer(<span class="keyword">new</span> BufferQueueProducer(core));</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer(<span class="keyword">new</span> BufferQueueConsumer(core));</span><br></pre></td></tr></table></figure><p>å®ä¾‹åŒ–BufferQueueProducerï¼Œè¿™é‡Œåˆå§‹åŒ–äº†mCore(core) å’Œ mSlots(core-&gt;mSlots)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">BufferQueueProducer::BufferQueueProducer(<span class="keyword">const</span> sp&lt;BufferQueueCore&gt;&amp; core) :</span><br><span class="line">    mCore(core),</span><br><span class="line">    mSlots(core-&gt;mSlots),</span><br><span class="line">    mConsumerName(),</span><br><span class="line">    mStickyTransform(<span class="number">0</span>),</span><br><span class="line">    mLastQueueBufferFence(Fence::NO_FENCE),</span><br><span class="line">    mCallbackMutex(),</span><br><span class="line">    mNextCallbackTicket(<span class="number">0</span>),</span><br><span class="line">    mCurrentCallbackTicket(<span class="number">0</span>),</span><br><span class="line">    mCallbackCondition(),</span><br><span class="line">    mDequeueTimeout(<span class="number">-1</span>) &#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹"><a href="#4-2-4-3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹" class="headerlink" title="4.2.4.3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹"></a>4.2.4.3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IGraphicBufferProducer&gt; producer(<span class="keyword">new</span> BufferQueueProducer(core));</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer(<span class="keyword">new</span> BufferQueueConsumer(core));</span><br></pre></td></tr></table></figure><p>å®ä¾‹åŒ–BufferQueueConsumerï¼Œè¿™é‡Œåˆå§‹åŒ–äº†mCore(core) å’Œ mSlots(core-&gt;mSlots)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BufferQueueConsumer::BufferQueueConsumer(<span class="keyword">const</span> sp&lt;BufferQueueCore&gt;&amp; core) :</span><br><span class="line">    mCore(core),</span><br><span class="line">    mSlots(core-&gt;mSlots),</span><br><span class="line">    mConsumerName() &#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-4ã€SurfaceFlingerè®¾ç½®ç›‘å¬"><a href="#4-2-4-4ã€SurfaceFlingerè®¾ç½®ç›‘å¬" class="headerlink" title="4.2.4.4ã€SurfaceFlingerè®¾ç½®ç›‘å¬"></a>4.2.4.4ã€SurfaceFlingerè®¾ç½®ç›‘å¬</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mSurfaceFlingerConsumer = <span class="keyword">new</span> SurfaceFlingerConsumer(consumer, mTextureName,</span><br><span class="line">        <span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(<span class="number">0</span>));</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setContentsChangedListener(<span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setName(mName);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/16-Android-Graphics-App-Ask-SurfaceFlinger-ConsumeLisener-onFrameAvailable.png" alt="Markdown"></p><h4 id="4-2-4-5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹"><a href="#4-2-4-5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹" class="headerlink" title="4.2.4.5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹"></a>4.2.4.5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹</h4><p>ä»å‰é¢åˆ†æå¯çŸ¥ï¼ŒSurfaceFlingeråœ¨å¤„ç†åº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceä¸­ï¼Œåœ¨SurfaceFlingeræœåŠ¡ç«¯ä»…ä»…åˆ›å»ºäº†Layerå¯¹è±¡ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåœ¨ä»€ä¹ˆæ—¶å€™ã€ä»€ä¹ˆåœ°æ–¹åˆ›å»ºå‘¢ï¼Ÿ</p><p>ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºå¥½äº†Layerå¯¹è±¡å¹¶è¿”å›ISurfaceçš„ä»£ç†å¯¹è±¡ç»™åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºé€šè¿‡è¯¥ä»£ç†å¯¹è±¡åˆ›å»ºäº†ä¸€ä¸ªSurfaceControlå¯¹è±¡ï¼ŒJavaå±‚Surfaceéœ€è¦é€šè¿‡android_view_Surface.cppä¸­çš„JNIå‡½æ•°æ¥æ“ä½œnativeå±‚çš„Surfaceï¼Œåœ¨æ“ä½œnativeå±‚Surfaceå‰ï¼Œé¦–å…ˆéœ€è¦è·å–åˆ°nativeçš„Surfaceï¼Œåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceå°±æ˜¯åœ¨è¿™ä¸ªæ—¶å€™åˆ›å»ºçš„ã€‚ [-&gt;SurfaceControl.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;Surface&gt; SurfaceControl::getSurface() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">Mutex::Autolock _l(mLock);</span><br><span class="line"><span class="keyword">if</span> (mSurfaceData == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// This surface is always consumed by SurfaceFlinger, so the</span></span><br><span class="line">    <span class="comment">// producerControlledByApp value doesn't matter; using false.</span></span><br><span class="line">    mSurfaceData = <span class="keyword">new</span> Surface(mGraphicBufferProducer, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> mSurfaceData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Surface::Surface(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; bufferProducer,</span><br><span class="line">    <span class="keyword">bool</span> controlledByApp)</span><br><span class="line">: mGraphicBufferProducer(bufferProducer),</span><br><span class="line">  mCrop(Rect::EMPTY_RECT),</span><br><span class="line">  mGenerationNumber(<span class="number">0</span>),</span><br><span class="line">  mSharedBufferMode(<span class="literal">false</span>),</span><br><span class="line">  mAutoRefresh(<span class="literal">false</span>),</span><br><span class="line">  mSharedBufferSlot(BufferItem::INVALID_BUFFER_SLOT),</span><br><span class="line">  mSharedBufferHasBeenQueued(<span class="literal">false</span>),</span><br><span class="line">  mNextFrameNumber(<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line"><span class="comment">// Initialize the ANativeWindow function pointers.</span></span><br><span class="line">ANativeWindow::setSwapInterval  = hook_setSwapInterval;</span><br><span class="line">ANativeWindow::dequeueBuffer    = hook_dequeueBuffer;</span><br><span class="line">ANativeWindow::cancelBuffer     = hook_cancelBuffer;</span><br><span class="line">ANativeWindow::queueBuffer      = hook_queueBuffer;</span><br><span class="line">ANativeWindow::query            = hook_query;</span><br><span class="line">ANativeWindow::perform          = hook_perform;</span><br><span class="line"></span><br><span class="line">ANativeWindow::dequeueBuffer_DEPRECATED = hook_dequeueBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::cancelBuffer_DEPRECATED  = hook_cancelBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::lockBuffer_DEPRECATED    = hook_lockBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::queueBuffer_DEPRECATED   = hook_queueBuffer_DEPRECATED;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(ANativeWindow::minSwapInterval) = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(ANativeWindow::maxSwapInterval) = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">mReqWidth = <span class="number">0</span>;</span><br><span class="line">mReqHeight = <span class="number">0</span>;</span><br><span class="line">mReqFormat = <span class="number">0</span>;</span><br><span class="line">mReqUsage = <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line">mSwapIntervalZero = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºå®Œåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåï¼Œæƒ³è¦åœ¨è¯¥Surfaceä¸Šç»˜å›¾ï¼Œé¦–å…ˆéœ€è¦ä¸ºè¯¥Surfaceåˆ†é…å›¾å½¢bufferã€‚æˆ‘ä»¬å‰é¢ä»‹ç»äº†Androidåº”ç”¨ç¨‹åºå›¾å½¢ç¼“å†²åŒºçš„åˆ†é…éƒ½æ˜¯ç”±SurfaceFlingeræœåŠ¡è¿›ç¨‹æ¥å®Œæˆï¼Œåœ¨è¯·æ±‚åˆ›å»ºSurfaceæ—¶ï¼Œåœ¨æœåŠ¡ç«¯åˆ›å»ºäº†ä¸€ä¸ªBufferQueueæœ¬åœ°Binderå¯¹è±¡ï¼Œè¯¥å¯¹è±¡è´Ÿè´£ç®¡ç†åº”ç”¨ç¨‹åºä¸€ä¸ªæœ¬åœ°çª—å£Surfaceçš„å›¾å½¢ç¼“å†²åŒºã€‚</p><h4 id="4-2-4-5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout"><a href="#4-2-4-5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout" class="headerlink" title="4.2.4.5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout()"></a>4.2.4.5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout()</h4><p>[-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">    mLayoutRequested = <span class="keyword">false</span>;</span><br><span class="line">    mScrollMayChange = <span class="keyword">true</span>;</span><br><span class="line">    mInLayout = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> View host = mView;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">        mInLayout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> numViewsRequestingLayout = mLayoutRequesters.size();</span><br><span class="line">        <span class="keyword">if</span> (numViewsRequestingLayout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ......</span><br><span class="line">                measureHierarchy(host, lp, mView.getContext().getResources(),</span><br><span class="line">                        desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">                mInLayout = <span class="keyword">true</span>;</span><br><span class="line">                host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">                ......</span><br><span class="line">    &#125;</span><br><span class="line">    mInLayout = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw"><a href="#4-2-4-7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw" class="headerlink" title="4.2.4.7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw()"></a>4.2.4.7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            draw(fullRedrawNeeded);</span><br><span class="line">        &#125;  ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Androidæ˜¯æ€æ ·å°†Viewç”»å‡ºæ¥çš„ï¼Ÿç”±äºä¹‹å‰æˆ‘ä»¬å·²ç»å…³é—­äº†HWCã€GPUã€HWUIï¼Œè¿™é‡Œåªå…³æ³¨è½¯ä»¶ç»˜åˆ¶ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</span><br><span class="line">    Surface surface = mSurface;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºæ¸²æŸ“è¿™ä¸ªæµç¨‹å¾ˆå¤æ‚ï¼Œæˆ‘ä»¬åç»­ç« èŠ‚å†åˆ†æã€‚</p><h2 id="4-3ã€APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹"><a href="#4-3ã€APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹" class="headerlink" title="4.3ã€APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹"></a>4.3ã€APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹</h2><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/17-Android-Graphics-App-SurfaceFlinger-lock-unlockpost.png" alt="Markdown"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> scalingRequired, Rect dirty)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw with software renderer.</span></span><br><span class="line">    <span class="keyword">final</span> Canvas canvas;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        canvas = mSurface.lockCanvas(dirty);</span><br><span class="line">        ......</span><br><span class="line">    &#125; ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            canvas.translate(-xoff, -yoff);</span><br><span class="line">            <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mTranslator.translateCanvas(canvas);</span><br><span class="line">            &#125;</span><br><span class="line">            canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</span><br><span class="line">            attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            mView.draw(canvas);</span><br><span class="line"></span><br><span class="line">            drawAccessibilityFocusedDrawableIfNeeded(canvas);</span><br><span class="line">        &#125;......</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            surface.unlockCanvasAndPost(canvas);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">           ......</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹çœ‹Surfaceçš„lockCanvasæ–¹æ³•ï¼š [-&gt;Surface.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mCanvas å˜é‡ç›´æ¥èµ‹å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Canvas mCanvas = <span class="keyword">new</span> CompatibleCanvas();</span><br><span class="line"><span class="function"><span class="keyword">public</span> Canvas <span class="title">lockCanvas</span><span class="params">(Rect inOutDirty)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Surface.OutOfResourcesException, IllegalArgumentException </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">    checkNotReleasedLocked();</span><br><span class="line">    ......</span><br><span class="line">    mLockedObject = nativeLockCanvas(mNativeObject, mCanvas, inOutDirty);</span><br><span class="line">    <span class="keyword">return</span> mCanvas;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeLockCanvas</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject canvasObj, jobject dirtyRectObj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–javaå±‚çš„Surfaceä¿å­˜çš„longå‹å¥æŸ„</span></span><br><span class="line">sp&lt;Surface&gt; surface(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isSurfaceValid(surface)) &#123;</span><br><span class="line">    doThrowIAE(env);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Rect <span class="title">dirtyRect</span><span class="params">(Rect::EMPTY_RECT)</span></span>;</span><br><span class="line">Rect* dirtyRectPtr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//è·å–javaå±‚dirty Rectçš„ä½ç½®å¤§å°ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">if</span> (dirtyRectObj) &#123;</span><br><span class="line">    dirtyRect.left   = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.left);</span><br><span class="line">    dirtyRect.top    = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.top);</span><br><span class="line">    dirtyRect.right  = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.right);</span><br><span class="line">    dirtyRect.bottom = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.bottom);</span><br><span class="line">    dirtyRectPtr = &amp;dirtyRect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ANativeWindow_Buffer outBuffer;</span><br><span class="line"> <span class="comment">//è°ƒç”¨Surfaceçš„lockæ–¹æ³•,å°†ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºèµ‹ç»™outBuffer</span></span><br><span class="line"><span class="keyword">status_t</span> err = surface-&gt;lock(&amp;outBuffer, dirtyRectPtr);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">SkImageInfo info = SkImageInfo::Make(outBuffer.width, outBuffer.height,</span><br><span class="line">                                     convertPixelFormat(outBuffer.format),</span><br><span class="line">                                     outBuffer.format == PIXEL_FORMAT_RGBX_8888 ?</span><br><span class="line">                                     kOpaque_SkAlphaType : kPremul_SkAlphaType);</span><br><span class="line"></span><br><span class="line">SkBitmap bitmap;</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªSkBitmap</span></span><br><span class="line"><span class="comment">//å›¾å½¢ç¼“å†²åŒºæ¯ä¸€è¡Œåƒç´ å¤§å°</span></span><br><span class="line"><span class="keyword">ssize_t</span> bpr = outBuffer.stride * bytesPerPixel(outBuffer.format);</span><br><span class="line">bitmap.setInfo(info, bpr);</span><br><span class="line"><span class="keyword">if</span> (outBuffer.width &gt; <span class="number">0</span> &amp;&amp; outBuffer.height &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    bitmap.setPixels(outBuffer.bits);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// be safe with an empty bitmap.</span></span><br><span class="line">    bitmap.setPixels(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Canvas* nativeCanvas = GraphicsJNI::getNativeCanvas(env, canvasObj);</span><br><span class="line">nativeCanvas-&gt;setBitmap(bitmap);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dirtyRectPtr) &#123;</span><br><span class="line">    nativeCanvas-&gt;clipRect(dirtyRect.left, dirtyRect.top,</span><br><span class="line">            dirtyRect.right, dirtyRect.bottom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dirtyRectObj) &#123;</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.left,   dirtyRect.left);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.top,    dirtyRect.top);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.right,  dirtyRect.right);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.bottom, dirtyRect.bottom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">sp&lt;Surface&gt; lockedSurface(surface);</span><br><span class="line">lockedSurface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line"><span class="keyword">return</span> (jlong) lockedSurface.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç é€»è¾‘ä¸»è¦å¦‚ä¸‹ï¼š 1ï¼‰è·å–javaå±‚dirty çš„Rectå¤§å°å’Œä½ç½®ä¿¡æ¯ï¼› 2ï¼‰è°ƒç”¨Surfaceçš„lockæ–¹æ³•,å°†ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºèµ‹ç»™outBufferï¼› 3ï¼‰åˆ›å»ºä¸€ä¸ªSkbitmapï¼Œå¡«å……å®ƒç”¨æ¥ä¿å­˜ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºï¼Œå¹¶èµ‹å€¼ç»™Javaå±‚çš„Canvaså¯¹è±¡ï¼› 4ï¼‰å°†å‰ªè£ä½ç½®å¤§å°ä¿¡æ¯èµ‹ç»™javaå±‚Canvaså¯¹è±¡ã€‚</p><h3 id="4-3-1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹"><a href="#4-3-1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹" class="headerlink" title="4.3.1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹"></a>4.3.1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹</h3><p>æˆ‘ä»¬ä¸Šè¾¹åˆ†æåˆ°äº†ç”³è¯·å›¾å½¢ç¼“å†²åŒºï¼Œç”¨åˆ°äº†Surfaceçš„lockå‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­æŸ¥çœ‹ã€‚ [-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Surface::lock(</span><br><span class="line">    ANativeWindow_Buffer* outBuffer, ARect* inOutDirtyBounds)</span><br><span class="line">    &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">ANativeWindowBuffer* out;</span><br><span class="line"><span class="keyword">int</span> fenceFd = <span class="number">-1</span>;</span><br><span class="line"><span class="comment">//è°ƒç”¨dequeueBufferå‡½æ•°ï¼Œç”³è¯·å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">status_t</span> err = dequeueBuffer(&amp;out, &amp;fenceFd);</span><br><span class="line">ALOGE_IF(err, <span class="string">"dequeueBuffer failed (%s)"</span>, strerror(-err));</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    <span class="comment">//è·å–å›¾å½¢ç¼“å†²åŒºåŒºåŸŸå¤§å°,èµ‹ç»™åå¤‡ç¼“å†²åŒºå˜é‡backBuffer</span></span><br><span class="line">    sp&lt;GraphicBuffer&gt; backBuffer(GraphicBuffer::getSelf(out));</span><br><span class="line">    <span class="function"><span class="keyword">const</span> Rect <span class="title">bounds</span><span class="params">(backBuffer-&gt;width, backBuffer-&gt;height)</span></span>;</span><br><span class="line">    Region newDirtyRegion;</span><br><span class="line">    <span class="keyword">if</span> (inOutDirtyBounds) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸Šå±‚æŒ‡å®šä¹åˆ·æ–°è„çŸ©å½¢åŒºåŸŸï¼Œåˆ™ç”¨è¿™ä¸ªåŒºåŸŸå’Œç¼“å†²åŒºåŒºåŸŸæ±‚äº¤é›†ï¼Œ</span></span><br><span class="line">        <span class="comment">//ç„¶åå°†äº¤é›†çš„ç»“æœè®¾ç»™éœ€è¦å»åˆ·æ–°çš„æ–°åŒºåŸŸ</span></span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(<span class="keyword">static_cast</span>&lt;Rect <span class="keyword">const</span>&amp;&gt;(*inOutDirtyBounds));</span><br><span class="line">        newDirtyRegion.andSelf(bounds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        /å¦‚æœä¸Šå±‚æ²¡æœ‰æŒ‡å®šè„çŸ©å½¢åŒºåŸŸï¼Œæ‰€ä»¥åˆ·æ–°æ•´ä¸ªå›¾å½¢ç¼“å†²åŒº</span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// figure out if we can copy the frontbuffer back</span></span><br><span class="line">    <span class="comment">//ä¸Šä¸€æ¬¡ç»˜åˆ¶çš„ä¿¡æ¯ä¿å­˜åœ¨mPostedBufferä¸­ï¼Œè€Œè¿™ä¸ªmPostedBufferåˆ™è¦åœ¨unLockAndPostå‡½æ•°ä¸­è®¾ç½®</span></span><br><span class="line">    int backBufferSlot(getSlotFromBufferLocked(backBuffer.get()));</span><br><span class="line">    <span class="keyword">const</span> sp&lt;GraphicBuffer&gt;&amp; frontBuffer(mPostedBuffer);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> canCopyBack = (frontBuffer != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            backBuffer-&gt;width  == frontBuffer-&gt;width &amp;&amp;</span><br><span class="line">            backBuffer-&gt;height == frontBuffer-&gt;height &amp;&amp;</span><br><span class="line">            backBuffer-&gt;format == frontBuffer-&gt;format);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (canCopyBack) &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        Region oldDirtyRegion;</span><br><span class="line">        <span class="keyword">if</span>(mSlots[backBufferSlot].dirtyRegion.isEmpty()) &#123;</span><br><span class="line">            oldDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; NUM_BUFFER_SLOTS; i++ ) &#123;</span><br><span class="line">                <span class="keyword">if</span>(i != backBufferSlot &amp;&amp; !mSlots[i].dirtyRegion.isEmpty())</span><br><span class="line">                    oldDirtyRegion.orSelf(mSlots[i].dirtyRegion);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        const Region copyback(oldDirtyRegion.subtract(newDirtyRegion));</span><br><span class="line">        <span class="keyword">if</span> (!copyback.isEmpty())</span><br><span class="line">        <span class="comment">//è¿™é‡ŒæŠŠmPostedBufferä¸­çš„æ—§æ•°æ®æ‹·è´åˆ°BackBufferä¸­ã€‚</span></span><br><span class="line">            <span class="comment">//åç»­çš„ç»˜ç”»åªè¦æ›´æ–°è„åŒºåŸŸå°±å¯ä»¥äº†ï¼Œè¿™ä¼šèŠ‚çº¦ä¸å°‘èµ„æº</span></span><br><span class="line">            copyBlt(backBuffer, frontBuffer, copyback);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// if we can't copy-back anything, modify the user's dirty</span></span><br><span class="line">        <span class="comment">// region to make sure they redraw the whole buffer</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸¤æ¬¡å›¾å½¢ç¼“å†²åŒºå¤§å°ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬å°±è¦ä¿®æ”¹ç”¨æˆ·æŒ‡å®šçš„dirtyåŒºåŸŸå¤§å°ä¸ºæ•´ä¸ªç¼“å†²åŒºå¤§å°ï¼Œ</span></span><br><span class="line">        <span class="comment">//ç„¶åå»æ›´æ–°æ•´ä¸ªç¼“å†²åŒº</span></span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;NUM_BUFFER_SLOTS ; i++) &#123;</span><br><span class="line">            mSlots[i].dirtyRegion.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// scope for the lock</span></span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="comment">//å°†æ–°çš„dirtyèµ‹ç»™è¿™ä¸ªbufferslot</span></span><br><span class="line">        mSlots[backBufferSlot].dirtyRegion = newDirtyRegion;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inOutDirtyBounds) &#123;</span><br><span class="line">        *inOutDirtyBounds = newDirtyRegion.getBounds();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* vaddr;</span><br><span class="line">     <span class="comment">//lockå’Œunlockåˆ†åˆ«ç”¨æ¥é”å®šå’Œè§£é”ä¸€ä¸ªæŒ‡å®šçš„å›¾å½¢ç¼“å†²åŒºï¼Œåœ¨è®¿é—®ä¸€å—å›¾å½¢ç¼“å†²åŒºçš„æ—¶å€™ï¼Œ</span></span><br><span class="line">    <span class="comment">//ä¾‹å¦‚ï¼Œå‘ä¸€å—å›¾å½¢ç¼“å†²å†™å…¥å†…å®¹çš„æ—¶å€™ï¼Œéœ€è¦å°†è¯¥å›¾å½¢ç¼“å†²åŒºé”å®šï¼Œç”¨æ¥é¿å…è®¿é—®å†²çª,</span></span><br><span class="line">    <span class="comment">//é”å®šä¹‹åï¼Œå°±å¯ä»¥è·å¾—ç”±å‚æ•°å‚æ•°lã€tã€wå’Œhæ‰€åœˆå®šçš„ä¸€å—ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼Œä¿å­˜åœ¨è¾“å‡ºå‚æ•°vaddrä¸­</span></span><br><span class="line">    <span class="keyword">status_t</span> res = backBuffer-&gt;lockAsync(</span><br><span class="line">            GRALLOC_USAGE_SW_READ_OFTEN | GRALLOC_USAGE_SW_WRITE_OFTEN,</span><br><span class="line">            newDirtyRegion.bounds(), &amp;vaddr, fenceFd);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Surfaceçš„lockå‡½æ•°ç”¨æ¥ç”³è¯·å›¾å½¢ç¼“å†²åŒºå’Œä¸€äº›æ“ä½œï¼Œæ–¹æ³•ä¸é•¿ï¼Œå¤§æ¦‚å·¥ä½œæœ‰ï¼š 1ï¼‰è°ƒç”¨connectå‡½æ•°å®Œæˆä¸€äº›åˆå§‹åŒ–ï¼› 2ï¼‰è°ƒç”¨dequeueBufferå‡½æ•°ï¼Œç”³è¯·å›¾å½¢ç¼“å†²åŒºï¼› 3ï¼‰è®¡ç®—éœ€è¦ç»˜åˆ¶çš„æ–°çš„dirtyåŒºåŸŸï¼Œæ—§çš„åŒºåŸŸåŸæ ·copyæ•°æ®ã€‚ [-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Surface::dequeueBuffer(<span class="keyword">android_native_buffer_t</span>** buffer, <span class="keyword">int</span>* fenceFd) &#123;</span><br><span class="line"><span class="keyword">uint32_t</span> reqWidth;</span><br><span class="line"><span class="keyword">uint32_t</span> reqHeight;</span><br><span class="line">PixelFormat reqFormat;</span><br><span class="line"><span class="keyword">uint32_t</span> reqUsage;</span><br><span class="line">&#123;</span><br><span class="line"> ......</span><br><span class="line"><span class="comment">//ç”³è¯·å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">status_t</span> result = mGraphicBufferProducer-&gt;dequeueBuffer(&amp;buf, &amp;fence,</span><br><span class="line">        reqWidth, reqHeight, reqFormat, reqUsage);</span><br><span class="line">......</span><br><span class="line"><span class="comment">//æ ¹æ®indexè·å–ç¼“å†²åŒº</span></span><br><span class="line">sp&lt;GraphicBuffer&gt;&amp; gbuf(mSlots[buf].buffer);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> ((result &amp; IGraphicBufferProducer::BUFFER_NEEDS_REALLOCATION) || gbuf == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//ç”±äºç”³è¯·çš„å†…å­˜æ˜¯åœ¨surfaceflingerè¿›ç¨‹ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">//BufferQueueä¸­çš„å›¾å½¢ç¼“å†²åŒºä¹Ÿæ˜¯é€šè¿‡åŒ¿åå…±äº«å†…å­˜å’Œbinderä¼ é€’æè¿°ç¬¦æ˜ å°„è¿‡å»çš„ï¼Œ</span></span><br><span class="line">    <span class="comment">//Surfaceé€šè¿‡è°ƒç”¨requestBufferå°†å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°Surfaceæ‰€åœ¨è¿›ç¨‹</span></span><br><span class="line">    result = mGraphicBufferProducer-&gt;requestBuffer(buf, &amp;gbuf);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="comment">//è·å–è¿™ä¸ªè¿™ä¸ªbufferå¯¹è±¡çš„æŒ‡é’ˆå†…å®¹</span></span><br><span class="line">*buffer = gbuf.get();</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> BufferQueueProducer::requestBuffer(<span class="keyword">int</span> slot, sp&lt;GraphicBuffer&gt;* buf) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line">Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mCore-&gt;mMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">mSlots[slot].mRequestBufferCalled = <span class="literal">true</span>;</span><br><span class="line">*buf = mSlots[slot].mGraphicBuffer;</span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„é¢ï¼Œå°±æ˜¯æ ¹æ®æŒ‡å®šindexå–å‡ºmSlotsä¸­çš„slotä¸­çš„bufferã€‚</p><h2 id="4-4ã€APPæäº¤-unlockAndPost-Bufferçš„è¿‡ç¨‹"><a href="#4-4ã€APPæäº¤-unlockAndPost-Bufferçš„è¿‡ç¨‹" class="headerlink" title="4.4ã€APPæäº¤(unlockAndPost)Bufferçš„è¿‡ç¨‹"></a>4.4ã€APPæäº¤(unlockAndPost)Bufferçš„è¿‡ç¨‹</h2><p>Surfaceç»˜åˆ¶å®Œæ¯•åï¼ŒunlockCanvasAndPostæ“ä½œã€‚ [-&gt;android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeUnlockCanvasAndPost</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject canvasObj)</span> </span>&#123;</span><br><span class="line">sp&lt;Surface&gt; surface(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line"><span class="keyword">if</span> (!isSurfaceValid(surface)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// detach the canvas from the surface</span></span><br><span class="line">Canvas* nativeCanvas = GraphicsJNI::getNativeCanvas(env, canvasObj);</span><br><span class="line">nativeCanvas-&gt;setBitmap(SkBitmap());</span><br><span class="line"></span><br><span class="line"><span class="comment">// unlock surface</span></span><br><span class="line"><span class="keyword">status_t</span> err = surface-&gt;unlockAndPost();</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    doThrowIAE(env);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Surface::unlockAndPost()</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"><span class="comment">//è§£é”å›¾å½¢ç¼“å†²åŒºï¼Œå’Œå‰é¢çš„lockAsyncæˆå¯¹å‡ºç°</span></span><br><span class="line"><span class="keyword">status_t</span> err = mLockedBuffer-&gt;unlockAsync(&amp;fd);</span><br><span class="line"><span class="comment">//queueBufferå»å½’è¿˜å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line">err = queueBuffer(mLockedBuffer.get(), fd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mPostedBuffer = mLockedBuffer;</span><br><span class="line">mLockedBuffer = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ ¸å¿ƒä¹Ÿæ˜¯åˆ†ä¸¤æ­¥ï¼š 1ï¼‰è§£é”å›¾å½¢ç¼“å†²åŒºï¼Œå’Œå‰é¢çš„lockAsyncæˆå¯¹å‡ºç°ï¼› 2ï¼‰queueBufferå»å½’è¿˜å›¾å½¢ç¼“å†²åŒºï¼› æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯é‡ç‚¹åˆ†æç¬¬äºŒæ­¥ï¼ŒæŸ¥çœ‹queueBufferçš„å®ç°ï¼š [-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Surface::queueBuffer(<span class="keyword">android_native_buffer_t</span>* buffer, <span class="keyword">int</span> fenceFd) &#123;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">status_t</span> err = mGraphicBufferProducer-&gt;queueBuffer(i, input, &amp;output);</span><br><span class="line">mLastQueueDuration = systemTime() - now;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨BufferQueueProducerçš„queueBufferå½’è¿˜ç¼“å†²åŒºï¼Œå°†ç»˜åˆ¶åçš„å›¾å½¢ç¼“å†²åŒºqueueå›å»ã€‚ [-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> BufferQueueProducer::queueBuffer(<span class="keyword">int</span> slot,</span><br><span class="line">    <span class="keyword">const</span> QueueBufferInput &amp;input, QueueBufferOutput *output) &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&#123; <span class="comment">// scope for the lock</span></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mCallbackMutex)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (callbackTicket != mCurrentCallbackTicket) &#123;</span><br><span class="line">        mCallbackCondition.wait(mCallbackMutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (frameAvailableListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        frameAvailableListener-&gt;onFrameAvailable(item);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frameReplacedListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        frameReplacedListener-&gt;onFrameReplaced(item);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š 1ï¼‰ä»ä¼ å…¥çš„QueueBufferInput ï¼Œè§£æå¡«å……ä¸€äº›å˜é‡ï¼› 2ï¼‰æ”¹å˜å…¥é˜ŸSlotçš„çŠ¶æ€ä¸ºQUEUEDï¼Œæ¯æ¬¡æ¨è¿›æ¥ï¼ŒmFrameCounteréƒ½åŠ 1ã€‚è¿™é‡Œçš„slotï¼Œä¸Šä¸€ç¯‡è®²åˆ†é…ç¼“å†²åŒºè¿”å›æœ€è€çš„FREEçŠ¶æ€bufferï¼Œå°±æ˜¯ç”¨è¿™ä¸ªmFrameCounteræœ€å°å€¼åˆ¤æ–­ï¼Œå°±æ˜¯ä¸Šä¸€ç¯‡LRUç®—æ³•çš„åˆ¤æ–­ï¼› 3ï¼‰åˆ›å»ºä¸€ä¸ªBufferItemæ¥æè¿°GraphicBufferï¼Œç”¨mSlots[slot]ä¸­çš„slotå¡«å……BufferItemï¼› 4ï¼‰å°†BufferItemå¡è¿›mCoreçš„mQueueé˜Ÿåˆ—ï¼Œä¾ç…§æŒ‡å®šè§„åˆ™ï¼› 5ï¼‰ç„¶åé€šçŸ¥SurfaceFlingerå»æ¶ˆè´¹ã€‚ Folwï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/18-Android-Graphics-App-WMS-SurfaceFlinger-All-Flow.png" alt="Markdown"></p><h2 id="ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ"><a href="#ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ" class="headerlink" title="ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ"></a>ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ</h2><p>å½“ç»˜åˆ¶å®Œæ¯•çš„GraphicBufferå…¥é˜Ÿä¹‹åï¼Œä¼šé€šçŸ¥SurfaceFlingerå»æ¶ˆè´¹ï¼Œå°±æ˜¯BufferQueueProducerçš„queueBufferå‡½æ•°çš„æœ€åå‡ è¡Œï¼Œlistener-&gt;onFrameAvailable()ã€‚ listeneræœ€ç»ˆé€šè¿‡å›è°ƒï¼Œä¼šå›åˆ°Layerå½“ä¸­ï¼Œæ‰€ä»¥æœ€ç»ˆè°ƒç”¨Layerçš„onFrameAvailableæ¥å£ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®ç°ï¼š [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::onFrameAvailable(<span class="keyword">const</span> BufferItem&amp; item) &#123;</span><br><span class="line"><span class="comment">// Add this buffer from our internal queue tracker</span></span><br><span class="line">&#123; <span class="comment">// Autolock scope</span></span><br><span class="line">    ......</span><br><span class="line">    mQueueItems.push_back(item);</span><br><span class="line">    android_atomic_inc(&amp;mQueuedFrames);</span><br><span class="line">    <span class="comment">// Wake up any pending callbacks</span></span><br><span class="line">    mLastFrameNumberReceived = item.mFrameNumber;</span><br><span class="line">    mQueueItemCondition.broadcast();</span><br><span class="line">&#125;</span><br><span class="line">mFlinger-&gt;signalLayerUpdate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆè°ƒç”¨SurfaceFlingerçš„signalLayerUpdateå‡½æ•°ï¼Œç»§ç»­æŸ¥çœ‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::signalLayerUpdate() &#123;</span><br><span class="line">mEventQueue.invalidate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆè°ƒç”¨MessageQueueçš„invalidateå‡½æ•°ï¼š [MessageQueue.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MessageQueue::invalidate() &#123;</span><br><span class="line">mEvents-&gt;requestNextVsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è´´ä¸€ä¸‹SurfaceFlingerçš„åˆå§‹åŒ–è¯·æ±‚vsyncä¿¡å·æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/19-Android-Graphics-vsync-surfaceflinger.png" alt="Markdown"></p><p>æœ€ç»ˆç»“æœä¼šèµ°åˆ°SurfaceFlingerçš„vsyncä¿¡å·æ¥æ”¶é€»è¾‘ï¼Œå³SurfaceFlingerçš„onMessageReceivedå‡½æ•°ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::onMessageReceived(<span class="keyword">int32_t</span> what) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"><span class="keyword">switch</span> (what) &#123;</span><br><span class="line">    <span class="keyword">case</span> MessageQueue::INVALIDATE: &#123;</span><br><span class="line">        <span class="keyword">bool</span> frameMissed = !mHadClientComposition &amp;&amp;</span><br><span class="line">                mPreviousPresentFence != Fence::NO_FENCE &amp;&amp;</span><br><span class="line">                mPreviousPresentFence-&gt;getSignalTime() == INT64_MAX;</span><br><span class="line">        ATRACE_INT(<span class="string">"FrameMissed"</span>, <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(frameMissed));</span><br><span class="line">        <span class="keyword">if</span> (mPropagateBackpressure &amp;&amp; frameMissed) &#123;</span><br><span class="line">            signalLayerUpdate();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> refreshNeeded = handleMessageTransaction();</span><br><span class="line">        refreshNeeded |= handleMessageInvalidate();</span><br><span class="line">        refreshNeeded |= mRepaintEverything;</span><br><span class="line">        <span class="keyword">if</span> (refreshNeeded) &#123;</span><br><span class="line">            <span class="comment">// Signal a refresh if a transaction modified the window state,</span></span><br><span class="line">            <span class="comment">// a new buffer was latched, or if HWC has requested a full</span></span><br><span class="line">            <span class="comment">// repaint</span></span><br><span class="line">            signalRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> MessageQueue::REFRESH: &#123;</span><br><span class="line">        handleMessageRefresh();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceFlingeræ”¶åˆ°äº†VSyncä¿¡å·åï¼Œè°ƒç”¨äº†handleMessageRefreshå‡½æ•° [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleMessageRefresh() &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line"><span class="keyword">nsecs_t</span> refreshStartTime = systemTime(SYSTEM_TIME_MONOTONIC);</span><br><span class="line"></span><br><span class="line">preComposition();</span><br><span class="line">rebuildLayerStacks();</span><br><span class="line">setUpHWComposer();</span><br><span class="line">doDebugFlashRegions();</span><br><span class="line">doComposition();</span><br><span class="line">postComposition(refreshStartTime);</span><br><span class="line"></span><br><span class="line">mPreviousPresentFence = mHwc-&gt;getRetireFence(HWC_DISPLAY_PRIMARY);</span><br><span class="line"></span><br><span class="line">mHadClientComposition = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> displayId = <span class="number">0</span>; displayId &lt; mDisplays.size(); ++displayId) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; displayDevice = mDisplays[displayId];</span><br><span class="line">    mHadClientComposition = mHadClientComposition ||</span><br><span class="line">            mHwc-&gt;hasClientComposition(displayDevice-&gt;getHwcDisplayId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Release any buffers which were replaced this frame</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; layer : mLayersWithQueuedFrames) &#123;</span><br><span class="line">    layer-&gt;releasePendingBuffer();</span><br><span class="line">&#125;</span><br><span class="line">mLayersWithQueuedFrames.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦çœ‹ä¸‹ä¸‹é¢å‡ ä¸ªå‡½æ•°ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">preComposition();</span><br><span class="line">rebuildLayerStacks();</span><br><span class="line">setUpHWComposer();</span><br><span class="line">doDebugFlashRegions();</span><br><span class="line">doComposition();</span><br><span class="line">postComposition(refreshStartTime);</span><br></pre></td></tr></table></figure><h3 id="ä¸€ã€preComposition-å‡½æ•°"><a href="#ä¸€ã€preComposition-å‡½æ•°" class="headerlink" title="ä¸€ã€preComposition()å‡½æ•°"></a>ä¸€ã€preComposition()å‡½æ•°</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªå‡½æ•°preComposition() [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::preComposition()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">bool</span> needExtraInvalidate = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (layers[i]-&gt;onPreComposition()) &#123;</span><br><span class="line">        needExtraInvalidate = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (needExtraInvalidate) &#123;</span><br><span class="line">    signalLayerUpdate();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‡½æ•°å…ˆæ˜¯è°ƒç”¨äº†mDrawingStateçš„layersSortedByZæ¥å¾—åˆ°ä¸Šæ¬¡ç»˜å›¾çš„Layerå±‚åˆ—è¡¨ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„Layeréƒ½ä¼šå‚ä¸å±å¹•å›¾åƒçš„ç»˜åˆ¶ï¼Œå› æ­¤SurfaceFlingerç”¨stateå¯¹è±¡æ¥è®°å½•å‚ä¸ç»˜åˆ¶çš„Layerå¯¹è±¡ã€‚ è®°å¾—æˆ‘ä»¬ä¹‹å‰åˆ†æè¿‡createLayerå‡½æ•°æ¥åˆ›å»ºLayerï¼Œåˆ›å»ºä¹‹åä¼šè°ƒç”¨addClientLayerå‡½æ•°ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> SurfaceFlinger::addClientLayer(<span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; handle,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; gbc,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;Layer&gt;&amp; lbc)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">// add this layer to the current state list</span></span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mStateLock);</span><br><span class="line">    <span class="keyword">if</span> (mCurrentState.layersSortedByZ.size() &gt;= MAX_LAYERS) &#123;</span><br><span class="line">        <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line">    mCurrentState.layersSortedByZ.add(lbc);</span><br><span class="line">    mGraphicBufferProducerList.add(IInterface::asBinder(gbc));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// attach this layer to the client</span></span><br><span class="line">client-&gt;attachLayer(handle, lbc);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹ä¸‹addClientLayerå‡½æ•°ï¼Œè¿™é‡Œä¼šæŠŠLayerå¯¹è±¡æ”¾åœ¨mCurrentStateçš„layersSortedByZå¯¹è±¡ä¸­ã€‚è€ŒmDrawingStateå’ŒmCurrentStateä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿåœ¨åé¢æˆ‘ä»¬ä¼šä»‹ç»ï¼ŒmDrawingStateä»£è¡¨ä¸Šä¸€æ¬¡ç»˜å›¾æ—¶çš„çŠ¶æ€ï¼Œå¤„ç†å®Œä¹‹åä¼šæŠŠmCurrentStateèµ‹ç»™mDrawingStateã€‚ å›åˆ°preCompositionå‡½æ•°ï¼Œéå†æ‰€æœ‰çš„Layerå¯¹è±¡ï¼Œè°ƒç”¨å…¶onPreCompositionå‡½æ•°æ¥æ£€æµ‹Layerå±‚ä¸­çš„å›¾åƒæ˜¯å¦æœ‰å˜åŒ–ã€‚</p><h2 id="1-1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°"><a href="#1-1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°" class="headerlink" title="1.1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°"></a>1.1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°</h2><p>onPreCompositionå‡½æ•°æ¥æ ¹æ®mQueuedFramesæ¥åˆ¤æ–­å›¾åƒæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œæˆ–è€…æ˜¯mSidebandStreamChangedã€mAutoRefreshã€‚ [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Layer::onPreComposition() &#123;</span><br><span class="line">mRefreshPending = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">return</span> mQueuedFrames &gt; <span class="number">0</span> || mSidebandStreamChanged || mAutoRefresh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“Layeræ‰€å¯¹åº”çš„Surfaceæ›´æ–°å›¾åƒåï¼Œå®ƒæ‰€å¯¹åº”çš„Layerå¯¹è±¡çš„onFrameAvailableå‡½æ•°ä¼šè¢«è°ƒç”¨æ¥é€šçŸ¥è¿™ç§å˜åŒ–ã€‚ åœ¨SurfaceFlingerçš„preCompositionå‡½æ•°ä¸­å½“æœ‰Layerçš„å›¾åƒæ”¹å˜äº†ï¼Œæœ€åä¹Ÿä¼šè°ƒç”¨SurfaceFlingerçš„signalLayerUpdateå‡½æ•°ã€‚ SurfaceFlinger::signalLayerUpdateæ˜¯è°ƒç”¨äº†MessageQueueçš„invalidateå‡½æ•° æœ€åå¤„ç†è¿˜æ˜¯è°ƒç”¨äº†SurfaceFlingerçš„onMessageReceivedå‡½æ•°ã€‚çœ‹çœ‹SurfaceFlingerçš„onMessageReceivedå‡½æ•°å¯¹NVALIDATEçš„å¤„ç† handleMessageInvalidateå‡½æ•°ä¸­è°ƒç”¨äº†handlePageFlipå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†ä¼šå¤„ç†Layerä¸­çš„ç¼“å†²åŒºï¼ŒæŠŠæ›´æ–°è¿‡çš„å›¾åƒç¼“å†²åŒºåˆ‡æ¢åˆ°å‰å°ï¼Œç­‰å¾…VSyncä¿¡å·æ›´æ–°åˆ°FrameBufferã€‚</p><h2 id="1-2ã€ç»˜åˆ¶æµç¨‹"><a href="#1-2ã€ç»˜åˆ¶æµç¨‹" class="headerlink" title="1.2ã€ç»˜åˆ¶æµç¨‹"></a>1.2ã€ç»˜åˆ¶æµç¨‹</h2><p>ç”¨æˆ·è¿›ç¨‹æ›´æ–°Surfaceå›¾åƒï¼Œå°†å¯¼è‡´SurfaceFlingerä¸­çš„Layerå‘é€invalidateæ¶ˆæ¯ï¼Œå¤„ç†è¯¥æ¶ˆæ¯ä¼šè°ƒç”¨handleTransactionå‡½æ•°å’ŒhandlePageFilpå‡½æ•°æ¥æ›´æ–°Layerå¯¹è±¡ã€‚ä¸€æ—¦VSyncä¿¡å·åˆ°æ¥ï¼Œå†è°ƒç”¨rebuildlayerStacks setUpHWComposer doComposition postCompositionå‡½æ•°å°†æ‰€æœ‰Layerçš„å›¾åƒæ··åˆåæ›´æ–°åˆ°æ˜¾ç¤ºè®¾å¤‡ä¸Šå»ã€‚</p><h3 id="äºŒã€handleTransaction-handPageFlipæ›´æ–°Layerå¯¹è±¡"><a href="#äºŒã€handleTransaction-handPageFlipæ›´æ–°Layerå¯¹è±¡" class="headerlink" title="äºŒã€handleTransaction handPageFlipæ›´æ–°Layerå¯¹è±¡"></a>äºŒã€handleTransaction handPageFlipæ›´æ–°Layerå¯¹è±¡</h3><p>åœ¨ä¸Šä¸€èŠ‚ä¸­çš„ç»˜å›¾çš„æµç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†handleTransactionå’ŒhandPageFlipè¿™ä¸¤ä¸ªå‡½æ•°é€šå¸¸æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹æ›´æ–°Surfaceå›¾åƒæ—¶ä¼šè°ƒç”¨ï¼Œæ¥æ›´æ–°Layerå¯¹è±¡ã€‚è¿™èŠ‚å°±ä¸»è¦è®²è§£è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p><h2 id="2-1ã€handleTransactionå‡½æ•°"><a href="#2-1ã€handleTransactionå‡½æ•°" class="headerlink" title="2.1ã€handleTransactionå‡½æ•°"></a>2.1ã€handleTransactionå‡½æ•°</h2><p>handleTransactionå‡½æ•°çš„å‚æ•°æ˜¯transactionFlagsï¼Œä¸è¿‡å‡½æ•°ä¸­æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œè€Œæ˜¯é€šè¿‡getTransactionFlags(eTransactionMask)æ¥é‡æ–°å¯¹transactionFlagsèµ‹å€¼ï¼Œç„¶åä½¿ç”¨å®ƒä½œä¸ºå‚æ•°æ¥è°ƒç”¨å‡½æ•° handleTransactionLockedã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleTransaction(<span class="keyword">uint32_t</span> transactionFlags)</span><br><span class="line">&#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line">Mutex::Autolock _l(mStateLock);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">nsecs_t</span> now = systemTime();</span><br><span class="line">mDebugInTransaction = now;</span><br><span class="line"></span><br><span class="line">transactionFlags = getTransactionFlags(eTransactionMask);</span><br><span class="line">handleTransactionLocked(transactionFlags);</span><br><span class="line"></span><br><span class="line">mLastTransactionTime = systemTime() - now;</span><br><span class="line">mDebugInTransaction = <span class="number">0</span>;</span><br><span class="line">invalidateHwcGeometry();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getTransactionFlagså‡½æ•°çš„å‚æ•°æ˜¯eTransactionMaskåªæ˜¯å±è”½å…¶ä»–ä½ã€‚ handleTransactionLockedå‡½æ•°ä¼šè°ƒç”¨æ¯ä¸ªLayerç±»çš„doTransactionå‡½æ•°ï¼Œåœ¨åˆ†æhandleTransactionLockedå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹Layerç±» çš„doTransactionå‡½æ•°ã€‚</p><h2 id="2-2ã€Layerçš„doTransactionå‡½æ•°"><a href="#2-2ã€Layerçš„doTransactionå‡½æ•°" class="headerlink" title="2.2ã€Layerçš„doTransactionå‡½æ•°"></a>2.2ã€Layerçš„doTransactionå‡½æ•°</h2><p>ä¸‹é¢æ˜¯Layerçš„doTransactionå‡½æ•°ä»£ç  [Layer.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">uint32_t Layer::doTransaction(uint32_t flags) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line">pushPendingState();<span class="comment">//ä¸Šæ¬¡ç»˜åˆ¶çš„Stateå¯¹è±¡  </span></span><br><span class="line">Layer::State c = getCurrentState();<span class="comment">//å½“å‰ä½¿ç”¨çš„Stateå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Layer::State&amp; s(getDrawingState());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bool sizeChanged = (c.requested.w != s.requested.w) ||</span><br><span class="line">                         (c.requested.h != s.requested.h);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sizeChanged) &#123;</span><br><span class="line">    <span class="comment">// the size changed, we need to ask our client to request a new buffer</span></span><br><span class="line">    <span class="comment">//å¦‚æœLayerçš„å°ºå¯¸å‘ç”Ÿå˜åŒ–ï¼Œå°±è¦æ”¹å˜Surfaceçš„ç¼“å†²åŒºçš„å°ºå¯¸</span></span><br><span class="line">    <span class="comment">// record the new size, form this point on, when the client request</span></span><br><span class="line">    <span class="comment">// a buffer, it'll get the new size.</span></span><br><span class="line">    mSurfaceFlingerConsumer-&gt;setDefaultBufferSize(</span><br><span class="line">            c.requested.w, c.requested.h);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bool resizePending = (c.requested.w != c.active.w) ||</span><br><span class="line">        (c.requested.h != c.active.h);</span><br><span class="line"><span class="keyword">if</span> (!isFixedSize()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (resizePending &amp;&amp; mSidebandStream == NULL) &#123;</span><br><span class="line">    <span class="comment">//å¦‚æœLayerä¸æ˜¯å›ºå®šå°ºå¯¸çš„ç±»å‹ï¼Œæ¯”è¾ƒå®ƒçš„å®é™…å¤§å°å’Œè¦æ±‚çš„æ”¹å˜å¤§å°  </span></span><br><span class="line">        flags |= eDontUpdateGeometryState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰eDontUpdateGeometryStateæ ‡å¿—ï¼Œæ›´æ–°activeçš„å€¼ä¸ºrequest  </span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; eDontUpdateGeometryState)  &#123;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Layer::State&amp; editCurrentState(getCurrentState());</span><br><span class="line">    <span class="keyword">if</span> (mFreezePositionUpdates) &#123;</span><br><span class="line">        <span class="keyword">float</span> tx = c.active.transform.tx();</span><br><span class="line">        <span class="keyword">float</span> ty = c.active.transform.ty();</span><br><span class="line">        c.active = c.requested;</span><br><span class="line">        c.active.transform.set(tx, ty);</span><br><span class="line">        editCurrentState.active = c.active;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        editCurrentState.active = editCurrentState.requested;</span><br><span class="line">        c.active = c.requested;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰stateçš„activeå’Œä»¥å‰çš„Stateçš„activeä¸ç­‰ï¼Œè®¾ç½®æ›´æ–°æ ‡å¿—  </span></span><br><span class="line"><span class="keyword">if</span> (s.active != c.active) &#123;</span><br><span class="line">    <span class="comment">// invalidate and recompute the visible regions if needed</span></span><br><span class="line">    flags |= Layer::eVisibleRegion;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœå½“å‰stateçš„sequenceå’Œä»¥å‰stateçš„sequenceä¸ç­‰ï¼Œè®¾ç½®æ›´æ–°æ ‡å¿—</span></span><br><span class="line"><span class="keyword">if</span> (c.sequence != s.sequence) &#123;</span><br><span class="line">    <span class="comment">// invalidate and recompute the visible regions if needed</span></span><br><span class="line">    flags |= eVisibleRegion;</span><br><span class="line">    <span class="keyword">this</span>-&gt;contentDirty = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we may use linear filtering, if the matrix scales us</span></span><br><span class="line">    <span class="keyword">const</span> uint8_t type = c.active.transform.getType();</span><br><span class="line">    mNeedsFiltering = (!c.active.transform.preserveRects() ||</span><br><span class="line">            (type &gt;= Transform::SCALE));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the layer is hidden, signal and clear out all local sync points so</span></span><br><span class="line"><span class="comment">// that transactions for layers depending on this layer's frames becoming</span></span><br><span class="line"><span class="comment">// visible are not blocked</span></span><br><span class="line"><span class="keyword">if</span> (c.flags &amp; layer_state_t::eLayerHidden) &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mLocalSyncPointMutex)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (auto&amp; point : mLocalSyncPoints) &#123;</span><br><span class="line">        point-&gt;setFrameAvailable();</span><br><span class="line">    &#125;</span><br><span class="line">    mLocalSyncPoints.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Commit the transaction</span></span><br><span class="line">commitTransaction(c);</span><br><span class="line"><span class="keyword">return</span> flags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Layerç±»ä¸­çš„ä¸¤ä¸ªç±»å‹ä¸ºLayer::Stateçš„æˆå‘˜å˜é‡mDrawingStateã€mCurrentStateï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªå¯¹è±¡å‘¢ï¼ŸLayerå¯¹è±¡åœ¨ç»˜åˆ¶å›¾å½¢æ—¶ï¼Œä½¿ç”¨çš„æ˜¯mDrawingStateå˜é‡ï¼Œç”¨æˆ·è°ƒç”¨æ¥å£è®¾ç½®Layerå¯¹è±¡å±æ€§æ˜¯ï¼Œè®¾ç½®çš„å€¼ä¿å­˜åœ¨mCurrentStateå¯¹è±¡ä¸­ï¼Œè¿™æ ·å°±ä¸ä¼šå› ä¸ºç”¨æˆ·çš„æ“ä½œè€Œå¹²æ‰°Layerå¯¹è±¡çš„ç»˜åˆ¶äº†ã€‚ Layerçš„doTransactionå‡½æ•°æ®ä½ æ˜¯æ¯”è¾ƒè¿™ä¸¤ä¸ªå˜é‡ï¼Œå¦‚æœæœ‰ä¸åŒçš„åœ°æ–¹ï¼Œè¯´æ˜åœ¨ä¸Šæ¬¡ç»˜åˆ¶ä»¥åï¼Œç”¨æˆ·æ”¹å˜çš„Layerçš„è®¾ç½®ï¼Œè¦æŠŠè¿™ç§å˜åŒ–é€šè¿‡flagsè¿”å›ã€‚ Stateçš„ç»“æ„ä¸­æœ‰ä¸¤ä¸ªGeometryå­—æ®µï¼Œactiveå’Œrequestedã€‚ä»–ä»¬è¡¨ç¤ºlayerçš„å°ºå¯¸ï¼Œå…¶ä¸­requestedä¿å­˜æ˜¯ç”¨æˆ·è®¾ç½®çš„å°ºå¯¸ï¼Œè€Œactiveä¿å­˜çš„å€¼é€šè¿‡è®¡ç®—åçš„å®é™…å°ºå¯¸ã€‚ Stateä¸­çš„zå­—æ®µçš„å€¼å°±æ˜¯Layeråœ¨æ˜¾ç¤ºè½´çš„ä½ç½®ï¼Œå€¼è¶Šå°ä½ç½®è¶Šé ä¸‹ã€‚ layerStackå­—æ®µæ˜¯ç”¨æˆ·æŒ‡å®šçš„ä¸€ä¸ªå€¼ï¼Œç”¨æˆ·å¯ä»¥ç»™DisplayDeviceä¹ŸæŒ‡å®šä¸€ä¸ªlayerStackå€¼ï¼Œåªæœ‰Layerå¯¹è±¡å’ŒDisplayDeviceå¯¹è±¡çš„layerStackç›¸ç­‰ï¼Œè¿™ä¸ªLayeræ‰èƒ½åœ¨è¿™ä¸ªæ˜¾ç¤ºè®¾å¤‡ä¸Šè¾“å‡ºï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥è®©æ˜¾ç¤ºè®¾å¤‡åªæ˜¾ç¤ºæŸä¸ªSurfaceçš„å†…å®¹ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥è®©HDMIæ˜¾ç¤ºè®¾å¤‡åªæ˜¾ç¤ºæ‰‹æœºä¸Šæ’­æ”¾è§†é¢‘çš„Surfaceçª—å£ï¼Œä½†ä¸æ˜¾ç¤ºActivityçª—å£ã€‚ sequenceå­—æ®µæ˜¯ä¸ªåºåˆ—å€¼ï¼Œæ¯å½“ç”¨æˆ·è°ƒç”¨äº†Layerçš„æ¥å£ï¼Œä¾‹å¦‚setAlphaã€setSizeæˆ–è€…setLayerç­‰æ”¹å˜Layerå¯¹è±¡å±æ€§çš„å“ˆæ•°ï¼Œè¿™ä¸ªå€¼éƒ½ä¼šåŠ 1ã€‚å› æ­¤åœ¨doTransactionå‡½æ•°ä¸­èƒ½é€šè¿‡æ¯”è¾ƒsequenceå€¼æ¥åˆ¤æ–­Layerçš„å±æ€§å€¼æœ‰æ²¡æœ‰å˜åŒ–ã€‚ doTransactionå‡½æ•°æœ€åä¼šè°ƒç”¨commitTransactionå‡½æ•°ï¼Œå°±æ˜¯æŠŠmCurrentStateèµ‹å€¼ç»™mDrawingState [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::commitTransaction(<span class="keyword">const</span> State&amp; stateToCommit) &#123;</span><br><span class="line">mDrawingState = stateToCommit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3ã€handleTransactionLockedå‡½æ•°"><a href="#2-3ã€handleTransactionLockedå‡½æ•°" class="headerlink" title="2.3ã€handleTransactionLockedå‡½æ•°"></a>2.3ã€handleTransactionLockedå‡½æ•°</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æhandleTransactionLockedå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬åˆ†æ®µåˆ†æ</p><p>2.3.1 å¤„ç†Layerçš„äº‹åŠ¡ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleTransactionLocked(<span class="keyword">uint32_t</span> transactionFlags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">currentLayers</span><span class="params">(mCurrentState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notify all layers of available frames</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">    currentLayers[i]-&gt;notifyAvailableFrames();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (transactionFlags &amp; eTraversalNeeded) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">        <span class="keyword">uint32_t</span> trFlags = layer-&gt;getTransactionFlags(eTransactionNeeded);</span><br><span class="line">        <span class="keyword">if</span> (!trFlags) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint32_t</span> flags = layer-&gt;doTransaction(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; Layer::eVisibleRegion)</span><br><span class="line">            mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨SurfaceFlingerä¸­ä¹Ÿæœ‰ä¸¤ä¸ªç±»å‹ä¸ºStateçš„å˜é‡mCurrentStateå’ŒmDrawingStateï¼Œä½†æ˜¯å’ŒLayerä¸­çš„ä¸è¦æ··èµ·æ¥ã€‚å®ƒçš„åå­—ç›¸åŒè€Œå·²</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">State</span> &#123;</span></span><br><span class="line">    LayerVector layersSortedByZ;</span><br><span class="line">    DefaultKeyedVector&lt; wp&lt;IBinder&gt;, DisplayDeviceState&gt; displays;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“æ„layersSortedByZå­—æ®µä¿å­˜æ‰€æœ‰å‚ä¸ç»˜åˆ¶çš„Layerå¯¹è±¡ï¼Œè€Œå­—æ®µdisplaysä¿å­˜çš„æ˜¯æ‰€æœ‰è¾“å‡ºè®¾å¤‡çš„DisplayDeviceStateå¯¹è±¡ è¿™é‡Œç”¨ä¸¤ä¸ªå˜é‡çš„ç›®çš„æ˜¯å’ŒLayerä¸­ä½¿ç”¨ä¸¤ä¸ªå˜é‡æ˜¯ä¸€æ ·çš„ã€‚ ä¸Šé¢ä»£ç æ ¹æ®eTraversalNeededæ ‡å¿—æ¥å†³å®šæ˜¯å¦è¦æ£€æŸ¥æ‰€æœ‰çš„Layerå¯¹è±¡ã€‚å¦‚æœæŸä¸ªLayerå¯¹è±¡ä¸­æœ‰eTransactionNeededæ ‡å¿—ï¼Œå°†è°ƒç”¨å®ƒçš„doTransactionå‡½æ•°ã€‚Layerçš„doTransactionå‡½æ•°è¿”å›çš„flagså¦‚æœæœ‰eVisibleRegionï¼Œè¯´æ˜è¿™ä¸ªLayeréœ€è¦æ›´æ–°ï¼Œå°±æŠŠmVisibleRegionsDirtyè®¾ç½®ä¸ºtrue</p><h3 id="2-3-2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–"><a href="#2-3-2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–" class="headerlink" title="2.3.2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–"></a>2.3.2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (transactionFlags &amp; eDisplayTransactionNeeded) &#123;</span><br><span class="line">    <span class="comment">// here we take advantage of Vector's copy-on-write semantics to</span></span><br><span class="line">    <span class="comment">// improve performance by skipping the transaction entirely when</span></span><br><span class="line">    <span class="comment">// know that the lists are identical</span></span><br><span class="line">    <span class="keyword">const</span> KeyedVector&lt;  wp&lt;IBinder&gt;, DisplayDeviceState&gt;&amp; curr(mCurrentState.displays);</span><br><span class="line">    <span class="keyword">const</span> KeyedVector&lt;  wp&lt;IBinder&gt;, DisplayDeviceState&gt;&amp; draw(mDrawingState.displays);</span><br><span class="line">    <span class="keyword">if</span> (!curr.isIdenticalTo(draw)) &#123;</span><br><span class="line">        mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> cc = curr.size();</span><br><span class="line">              <span class="keyword">size_t</span> dc = draw.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// find the displays that were removed</span></span><br><span class="line">        <span class="comment">// (ie: in drawing state but not in current state)</span></span><br><span class="line">        <span class="comment">// also handle displays that changed</span></span><br><span class="line">        <span class="comment">// (ie: displays that are in both lists)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;dc ; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">ssize_t</span> j = curr.indexOfKey(draw.keyAt(i));</span><br><span class="line">            <span class="keyword">if</span> (j &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// in drawing state but not in current state</span></span><br><span class="line">                <span class="keyword">if</span> (!draw[i].isMainDisplay()) &#123;</span><br><span class="line">                    <span class="comment">// Call makeCurrent() on the primary display so we can</span></span><br><span class="line">                    <span class="comment">// be sure that nothing associated with this display</span></span><br><span class="line">                    <span class="comment">// is current.</span></span><br><span class="line">                    <span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt; defaultDisplay(getDefaultDisplayDevice());</span><br><span class="line">                    defaultDisplay-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw(getDisplayDevice(draw.keyAt(i)));</span><br><span class="line">                    <span class="keyword">if</span> (hw != <span class="literal">NULL</span>)</span><br><span class="line">                        hw-&gt;disconnect(getHwComposer());</span><br><span class="line">                    <span class="keyword">if</span> (draw[i].type &lt; DisplayDevice::NUM_BUILTIN_DISPLAY_TYPES)</span><br><span class="line">                        mEventThread-&gt;onHotplugReceived(draw[i].type, <span class="literal">false</span>);</span><br><span class="line">                    mDisplays.removeItem(draw.keyAt(i));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGW(<span class="string">"trying to remove the main display"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// this display is in both lists. see if something changed.</span></span><br><span class="line">                <span class="keyword">const</span> DisplayDeviceState&amp; state(curr[j]);</span><br><span class="line">                <span class="keyword">const</span> wp&lt;IBinder&gt;&amp; display(curr.keyAt(j));</span><br><span class="line">                <span class="keyword">const</span> sp&lt;IBinder&gt; state_binder = IInterface::asBinder(state.surface);</span><br><span class="line">                <span class="keyword">const</span> sp&lt;IBinder&gt; draw_binder = IInterface::asBinder(draw[i].surface);</span><br><span class="line">                <span class="keyword">if</span> (state_binder != draw_binder) &#123;</span><br><span class="line">                    <span class="comment">// changing the surface is like destroying and</span></span><br><span class="line">                    <span class="comment">// recreating the DisplayDevice, so we just remove it</span></span><br><span class="line">                    <span class="comment">// from the drawing state, so that it get re-added</span></span><br><span class="line">                    <span class="comment">// below.</span></span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw(getDisplayDevice(display));</span><br><span class="line">                    <span class="keyword">if</span> (hw != <span class="literal">NULL</span>)</span><br><span class="line">                        hw-&gt;disconnect(getHwComposer());</span><br><span class="line">                    mDisplays.removeItem(display);</span><br><span class="line">                    mDrawingState.displays.removeItemsAt(i);</span><br><span class="line">                    dc--; i--;</span><br><span class="line">                    <span class="comment">// at this point we must loop to the next item</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> sp&lt;DisplayDevice&gt; disp(getDisplayDevice(display));</span><br><span class="line">                <span class="keyword">if</span> (disp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (state.layerStack != draw[i].layerStack) &#123;</span><br><span class="line">                        disp-&gt;setLayerStack(state.layerStack);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((state.orientation != draw[i].orientation)</span><br><span class="line">                            || (state.viewport != draw[i].viewport)</span><br><span class="line">                            || (state.frame != draw[i].frame))</span><br><span class="line">                    &#123;</span><br><span class="line">                        disp-&gt;setProjection(state.orientation,</span><br><span class="line">                                state.viewport, state.frame);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (state.width != draw[i].width || state.height != draw[i].height) &#123;</span><br><span class="line">                        disp-&gt;setDisplaySize(state.width, state.height);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// find displays that were added</span></span><br><span class="line">        <span class="comment">// (ie: in current state but not in drawing state)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;cc ; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (draw.indexOfKey(curr.keyAt(i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="function"><span class="keyword">const</span> DisplayDeviceState&amp; <span class="title">state</span><span class="params">(curr[i])</span></span>;</span><br><span class="line"></span><br><span class="line">                sp&lt;DisplaySurface&gt; dispSurface;</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt; bqProducer;</span><br><span class="line">                sp&lt;IGraphicBufferConsumer&gt; bqConsumer;</span><br><span class="line">                BufferQueue::createBufferQueue(&amp;bqProducer, &amp;bqConsumer,</span><br><span class="line">                        <span class="keyword">new</span> GraphicBufferAlloc());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int32_t</span> hwcDisplayId = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">if</span> (state.isVirtualDisplay()) &#123;</span><br><span class="line">                    <span class="comment">// Virtual displays without a surface are dormant:</span></span><br><span class="line">                    <span class="comment">// they have external state (layer stack, projection,</span></span><br><span class="line">                    <span class="comment">// etc.) but no internal state (i.e. a DisplayDevice).</span></span><br><span class="line">                    <span class="keyword">if</span> (state.surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">int</span> width = <span class="number">0</span>;</span><br><span class="line">                        DisplayUtils* displayUtils = DisplayUtils::getInstance();</span><br><span class="line">                        <span class="keyword">int</span> status = state.surface-&gt;query(</span><br><span class="line">                                NATIVE_WINDOW_WIDTH, &amp;width);</span><br><span class="line">                        ALOGE_IF(status != NO_ERROR,</span><br><span class="line">                                <span class="string">"Unable to query width (%d)"</span>, status);</span><br><span class="line">                        <span class="keyword">int</span> height = <span class="number">0</span>;</span><br><span class="line">                        status = state.surface-&gt;query(</span><br><span class="line">                            NATIVE_WINDOW_HEIGHT, &amp;height);</span><br><span class="line">                        ALOGE_IF(status != NO_ERROR,</span><br><span class="line">                            <span class="string">"Unable to query height (%d)"</span>, status);</span><br><span class="line">                        <span class="keyword">if</span> (MAX_VIRTUAL_DISPLAY_DIMENSION == <span class="number">0</span> ||</span><br><span class="line">                            (width &lt;= MAX_VIRTUAL_DISPLAY_DIMENSION &amp;&amp;</span><br><span class="line">                             height &lt;= MAX_VIRTUAL_DISPLAY_DIMENSION)) &#123;</span><br><span class="line">                            <span class="keyword">int</span> usage = <span class="number">0</span>;</span><br><span class="line">                            status = state.surface-&gt;query(</span><br><span class="line">                                NATIVE_WINDOW_CONSUMER_USAGE_BITS, &amp;usage);</span><br><span class="line">                            ALOGW_IF(status != NO_ERROR,</span><br><span class="line">                                <span class="string">"Unable to query usage (%d)"</span>, status);</span><br><span class="line">                            <span class="keyword">if</span> ( (status == NO_ERROR) &amp;&amp;</span><br><span class="line">                                  displayUtils-&gt;canAllocateHwcDisplayIdForVDS(usage)) &#123;</span><br><span class="line">                                hwcDisplayId = allocateHwcDisplayId(state.type);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        displayUtils-&gt;initVDSInstance(mHwc, hwcDisplayId, state.surface,</span><br><span class="line">                                dispSurface, producer, bqProducer, bqConsumer,</span><br><span class="line">                                state.displayName, state.isSecure, state.type);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGE_IF(state.surface!=<span class="literal">NULL</span>,</span><br><span class="line">                            <span class="string">"adding a supported display, but rendering "</span></span><br><span class="line">                            <span class="string">"surface is provided (%p), ignoring it"</span>,</span><br><span class="line">                            state.surface.get());</span><br><span class="line">                    hwcDisplayId = allocateHwcDisplayId(state.type);</span><br><span class="line">                    <span class="comment">// for supported (by hwc) displays we provide our</span></span><br><span class="line">                    <span class="comment">// own rendering surface</span></span><br><span class="line">                    dispSurface = <span class="keyword">new</span> FramebufferSurface(*mHwc, state.type,</span><br><span class="line">                            bqConsumer);</span><br><span class="line">                    producer = bqProducer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> wp&lt;IBinder&gt;&amp; display(curr.keyAt(i));</span><br><span class="line">                <span class="keyword">if</span> (dispSurface != <span class="literal">NULL</span> &amp;&amp; producer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw = <span class="keyword">new</span> DisplayDevice(<span class="keyword">this</span>,</span><br><span class="line">                            state.type, hwcDisplayId,</span><br><span class="line">                            mHwc-&gt;getFormat(hwcDisplayId), state.isSecure,</span><br><span class="line">                            display, dispSurface, producer,</span><br><span class="line">                            mRenderEngine-&gt;getEGLConfig());</span><br><span class="line">                    hw-&gt;setLayerStack(state.layerStack);</span><br><span class="line">                    hw-&gt;setProjection(state.orientation,</span><br><span class="line">                            state.viewport, state.frame);</span><br><span class="line">                    hw-&gt;setDisplayName(state.displayName);</span><br><span class="line">                    <span class="comment">// When a new display device is added update the active</span></span><br><span class="line">                    <span class="comment">// config by querying HWC otherwise the default config</span></span><br><span class="line">                    <span class="comment">// (config 0) will be used.</span></span><br><span class="line">                    <span class="keyword">if</span> (hwcDisplayId &gt;= DisplayDevice::DISPLAY_PRIMARY &amp;&amp;</span><br><span class="line">                            hwcDisplayId &lt; DisplayDevice::NUM_BUILTIN_DISPLAY_TYPES) &#123;</span><br><span class="line">                        <span class="keyword">int</span> activeConfig = mHwc-&gt;getActiveConfig(hwcDisplayId);</span><br><span class="line">                        <span class="keyword">if</span> (activeConfig &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            hw-&gt;setActiveConfig(activeConfig);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mDisplays.add(display, hw);</span><br><span class="line">                    <span class="keyword">if</span> (state.isVirtualDisplay()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (hwcDisplayId &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            mHwc-&gt;setVirtualDisplayProperties(hwcDisplayId,</span><br><span class="line">                                    hw-&gt;getWidth(), hw-&gt;getHeight(),</span><br><span class="line">                                    hw-&gt;getFormat());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mEventThread-&gt;onHotplugReceived(state.type, <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–ï¼Œåˆ†æˆ3ç§æƒ…å†µï¼š 1.æ˜¾ç¤ºè®¾å¤‡å‡å°‘äº†ï¼Œéœ€è¦æŠŠæ˜¾ç¤ºè®¾å¤‡å¯¹åº”çš„DisplayDeviceç§»é™¤ 2.æ˜¾ç¤ºè®¾å¤‡å‘ç”Ÿäº†å˜åŒ–ï¼Œä¾‹å¦‚ç”¨æˆ·è®¾ç½®äº†Surfaceã€é‡æ–°è®¾ç½®äº†layerStackã€æ—‹è½¬äº†å±å¹•ç­‰ï¼Œè¿™å°±éœ€è¦é‡æ–°è®¾ç½®æ˜¾ç¤ºå¯¹è±¡çš„å±æ€§ 3.æ˜¾ç¤ºè®¾å¤‡å¢åŠ äº†ï¼Œåˆ›å»ºæ–°çš„DisplayDeviceåŠ å…¥ç³»ç»Ÿä¸­ã€‚</p><h3 id="2-3-3ã€è®¾ç½®TransfromHit"><a href="#2-3-3ã€è®¾ç½®TransfromHit" class="headerlink" title="2.3.3ã€è®¾ç½®TransfromHit"></a>2.3.3ã€è®¾ç½®TransfromHit</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (transactionFlags &amp; (eTraversalNeeded|eDisplayTransactionNeeded)) &#123;</span><br><span class="line">    ......</span><br><span class="line">    sp&lt;<span class="keyword">const</span> DisplayDevice&gt; disp;</span><br><span class="line">    <span class="keyword">uint32_t</span> currentlayerStack = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> we rely on the fact that layers are sorted by</span></span><br><span class="line">        <span class="comment">// layerStack first (so we don't have to traverse the list</span></span><br><span class="line">        <span class="comment">// of displays for every layer).</span></span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">        <span class="keyword">uint32_t</span> layerStack = layer-&gt;getDrawingState().layerStack;</span><br><span class="line">        <span class="keyword">if</span> (i==<span class="number">0</span> || currentlayerStack != layerStack) &#123;</span><br><span class="line">            currentlayerStack = layerStack;</span><br><span class="line">            <span class="comment">// figure out if this layerstack is mirrored</span></span><br><span class="line">            <span class="comment">// (more than one display) if so, pick the default display,</span></span><br><span class="line">            <span class="comment">// if not, pick the only display it's on.</span></span><br><span class="line">            disp.clear();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">                sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">                <span class="keyword">if</span> (hw-&gt;getLayerStack() == currentlayerStack) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (disp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        disp = hw;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        disp = <span class="literal">NULL</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (disp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> TEMPORARY FIX ONLY. Real fix should cause layers to</span></span><br><span class="line">            <span class="comment">// redraw after transform hint changes. See bug 8508397.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// could be null when this layer is using a layerStack</span></span><br><span class="line">            <span class="comment">// that is not visible on any display. Also can occur at</span></span><br><span class="line">            <span class="comment">// screen off/on times.</span></span><br><span class="line">            disp = getDefaultDisplayDevice();</span><br><span class="line">        &#125;</span><br><span class="line">        layer-&gt;updateTransformHint(disp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯æ ¹æ®æ¯ç§æ˜¾ç¤ºè®¾å¤‡çš„ä¸åŒï¼Œè®¾ç½®å’Œæ˜¾ç¤ºè®¾å¤‡å…³è”åœ¨ä¸€èµ·çš„Layerï¼ˆä¸»è¦çœ‹Layerçš„layerStackæ˜¯å¦å’ŒDisplayDeviceçš„layerStackï¼‰çš„TransformHintï¼ˆä¸»è¦æŒ‡è®¾å¤‡çš„æ˜¾ç¤ºæ–¹å‘orientationï¼‰ã€‚</p><h3 id="2-3-4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ"><a href="#2-3-4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ" class="headerlink" title="2.3.4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ"></a>2.3.4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Perform our own transaction if needed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">if</span> (currentLayers.size() &gt; layers.size()) &#123;</span><br><span class="line">    <span class="comment">// layers have been added</span></span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// some layers might have been removed, so</span></span><br><span class="line"><span class="comment">// we need to update the regions they're exposing.</span></span><br><span class="line"><span class="keyword">if</span> (mLayersRemoved) &#123;</span><br><span class="line">    mLayersRemoved = <span class="literal">false</span>;</span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">        <span class="keyword">if</span> (currentLayers.indexOf(layer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// this layer is not visible anymore</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> we could traverse the tree from front to back and</span></span><br><span class="line">            <span class="comment">//       compute the actual visible region</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> we could cache the transformed region</span></span><br><span class="line">            const Layer::State&amp; s(layer-&gt;getDrawingState());</span><br><span class="line">            Region visibleReg = s.active.transform.transform(</span><br><span class="line">                    Region(Rect(s.active.w, s.active.h)));</span><br><span class="line">            invalidateLayerStack(s.layerStack, visibleReg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¤„ç†Layerçš„å¢åŠ æƒ…å†µï¼Œå¦‚æœLayerå¢åŠ äº†ï¼Œéœ€è¦é‡æ–°è®¡ç®—è®¾å¤‡çš„æ›´æ–°åŒºåŸŸï¼Œå› æ­¤æŠŠmVisibleRegionsDirtyè®¾ä¸ºtrueï¼Œå¦‚æœLayeråˆ é™¤äº†ï¼Œéœ€è¦æŠŠLayerçš„å¯è§åŒºåŸŸåŠ å…¥åˆ°ç³»ç»Ÿéœ€è¦æ›´æ–°çš„åŒºåŸŸä¸­ã€‚</p><h3 id="2-3-5ã€è®¾ç½®mDrawingState"><a href="#2-3-5ã€è®¾ç½®mDrawingState" class="headerlink" title="2.3.5ã€è®¾ç½®mDrawingState"></a>2.3.5ã€è®¾ç½®mDrawingState</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">commitTransaction();</span><br><span class="line">updateCursorAsync();</span><br></pre></td></tr></table></figure><p>è°ƒç”¨commitTransactionå’ŒupdateCursorAsyncå‡½æ•° commitTransactionå‡½æ•°ä½œç”¨æ˜¯æŠŠmDrawingStateçš„å€¼è®¾ç½®æˆmCurrentStateçš„å€¼ã€‚è€ŒupdateCursorAsyncå‡½æ•°ä¼šæ›´æ–°æ‰€æœ‰æ˜¾ç¤ºè®¾å¤‡ä¸­å…‰æ ‡çš„ä½ç½®ã€‚</p><p>2.3.6 å°ç»“ handleTransactionå‡½æ•°çš„ä½œç”¨çš„å°±æ˜¯å¤„ç†ç³»ç»Ÿåœ¨ä¸¤æ¬¡åˆ·æ–°æœŸé—´çš„å„ç§å˜åŒ–ã€‚SurfaceFlingeræ¨¡å—ä¸­ä¸ç®¡æ˜¯SurfaceFlingerç±»è¿˜æ˜¯Layerç±»ï¼Œéƒ½é‡‡ç”¨äº†åŒç¼“å†²çš„æ–¹å¼æ¥ä¿å­˜ä»–ä»¬çš„å±æ€§ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯åˆšæ”¹å˜SurfaceFlingerå¯¹è±¡æˆ–è€…Layerç±»å¯¹è±¡çš„å±æ€§æ˜¯ï¼Œä¸éœ€è¦ä¸Šé”ï¼Œå¤§å¤§çš„æé«˜äº†ç³»ç»Ÿæ•ˆç‡ã€‚åªæœ‰åœ¨æœ€åçš„å›¾åƒè¾“å‡ºæ˜¯ï¼Œæ‰è¿›è¡Œä¸€æ¬¡ä¸Šé”ï¼Œå¹¶è¿›è¡Œå†…å­˜çš„å±æ€§å˜åŒ–å¤„ç†ã€‚æ­£å› æ­¤ï¼Œåº”ç”¨è¿›ç¨‹å¿…é¡»æ”¶åˆ°VSyncä¿¡å·æ‰å¼€å§‹æ”¹å˜Surfaceçš„å†…å®¹ã€‚</p><h2 id="2-4ã€handlePageFlipå‡½æ•°"><a href="#2-4ã€handlePageFlipå‡½æ•°" class="headerlink" title="2.4ã€handlePageFlipå‡½æ•°"></a>2.4ã€handlePageFlipå‡½æ•°</h2><p>handlePageFlipå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> SurfaceFlinger::handlePageFlip()</span><br><span class="line">&#123;</span><br><span class="line">Region dirtyRegion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> visibleRegions = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">bool</span> frameQueued = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store the set of layers that need updates. This set must not change as</span></span><br><span class="line"><span class="comment">// buffers are being latched, as this could result in a deadlock.</span></span><br><span class="line"><span class="comment">// Example: Two producers share the same command stream and:</span></span><br><span class="line"><span class="comment">// 1.) Layer 0 is latched</span></span><br><span class="line"><span class="comment">// 2.) Layer 0 gets a new frame</span></span><br><span class="line"><span class="comment">// 2.) Layer 1 gets a new frame</span></span><br><span class="line"><span class="comment">// 3.) Layer 1 is latched.</span></span><br><span class="line"><span class="comment">// Display is now waiting on Layer 1's frame, which is behind layer 0's</span></span><br><span class="line"><span class="comment">// second frame. But layer 0's second frame could be waiting on display.</span></span><br><span class="line">Vector&lt;Layer*&gt; layersWithQueuedFrames;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, count = layers.size(); i&lt;count ; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">    <span class="keyword">if</span> (layer-&gt;hasQueuedFrame()) &#123;</span><br><span class="line">        frameQueued = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (layer-&gt;shouldPresentNow(mPrimaryDispSync)) &#123;</span><br><span class="line">            layersWithQueuedFrames.push_back(layer.get());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            layer-&gt;useEmptyDamage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        layer-&gt;useEmptyDamage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, count = layersWithQueuedFrames.size() ; i&lt;count ; i++) &#123;</span><br><span class="line">    Layer* layer = layersWithQueuedFrames[i];</span><br><span class="line">    const Region dirty(layer-&gt;latchBuffer(visibleRegions));</span><br><span class="line">    layer-&gt;useSurfaceDamage();</span><br><span class="line">    const Layer::State&amp; s(layer-&gt;getDrawingState());</span><br><span class="line">    invalidateLayerStack(s.layerStack, dirty);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mVisibleRegionsDirty |= visibleRegions;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we will need to wake up at some time in the future to deal with a</span></span><br><span class="line"><span class="comment">// queued frame that shouldn't be displayed during this vsync period, wake</span></span><br><span class="line"><span class="comment">// up during the next vsync period to check again.</span></span><br><span class="line"><span class="keyword">if</span> (frameQueued &amp;&amp; layersWithQueuedFrames.empty()) &#123;</span><br><span class="line">    signalLayerUpdate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only continue with the refresh if there is actually new work to do</span></span><br><span class="line"><span class="keyword">return</span> !layersWithQueuedFrames.empty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handlePageFlipå‡½æ•°å…ˆè°ƒç”¨æ¯ä¸ªLayerå¯¹è±¡çš„hasQueuedFrameå‡½æ•°ï¼Œç¡®å®šè¿™ä¸ªLayerå¯¹è±¡æ˜¯å¦æœ‰éœ€è¦æ›´æ–°çš„å›¾å±‚ï¼Œç„¶åæŠŠéœ€è¦æ›´æ–°çš„Layerå¯¹è±¡æ”¾åˆ°layersWithQueuedFramesä¸­ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹Layerçš„hasQueuedFrameæ–¹æ³•å°±æ˜¯çœ‹å…¶mQueuedFramesæ˜¯å¦å¤§äº0 å’ŒmSidebandStreamChangedã€‚å‰é¢å°èŠ‚åˆ†æåªè¦Surfaceæœ‰æ•°æ®å†™å…¥ï¼Œå°±ä¼šè°ƒç”¨Layerçš„onFrameAvailableå‡½æ•°ï¼Œç„¶åmQueuedFrameså€¼åŠ 1. ç»§ç»­çœ‹handlePageFlipå‡½æ•°ï¼Œæ¥ç€è°ƒç”¨éœ€è¦æ›´æ–°çš„Layerå¯¹è±¡çš„latchBufferå‡½æ•°ï¼Œç„¶åæ ¹æ®è¿”å›çš„æ›´æ–°åŒºåŸŸè°ƒç”¨invalidateLayerStackå‡½æ•°æ¥è®¾ç½®æ›´æ–°è®¾å¤‡å¯¹è±¡çš„æ›´æ–°åŒºåŸŸã€‚ ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹latchBufferå‡½æ•°</p><p>LatchBufferå‡½æ•°è°ƒç”¨updateTextImageæ¥å¾—åˆ°éœ€è¦çš„å›¾åƒã€‚è¿™é‡Œå‚æ•°ræ˜¯Rejectå¯¹è±¡ï¼Œå…¶ä½œç”¨æ˜¯åˆ¤æ–­åœ¨ç¼“å†²åŒºçš„å°ºå¯¸æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚è°ƒç”¨updateTextImageå‡½æ•°å¦‚æœå¾—åˆ°çš„ç»“æœæ˜¯PRESENT_LATER,è¡¨ç¤ºæ¨è¿Ÿå¤„ç†ï¼Œç„¶åè°ƒç”¨signalLayerUpdateå‡½æ•°æ¥å‘é€invalidateæ¶ˆæ¯ï¼Œè¿™æ¬¡ç»˜åˆ¶è¿‡ç¨‹å°±ä¸å¤„ç†è¿™ä¸ªSurfaceçš„å›¾åƒäº†ã€‚ å¦‚æœä¸éœ€è¦æ¨è¿Ÿå¤„ç†ï¼ŒæŠŠmQueuedFramesçš„å€¼å‡1. æœ€åLatchBufferå‡½æ•°è°ƒç”¨mSurfaceFlingerConsumerçš„getCurrentBufferæ¥å–å›å½“å‰çš„å›¾åƒç¼“å†²åŒºæŒ‡é’ˆï¼Œä¿å­˜åœ¨mActiveBufferä¸­ã€‚</p><h3 id="2-5-å°ç»“"><a href="#2-5-å°ç»“" class="headerlink" title="2.5 å°ç»“"></a>2.5 å°ç»“</h3><p>è¿™æ ·ç»è¿‡handleTransaction handlePageFlipä¸¤ä¸ªå‡½æ•°å¤„ç†ï¼ŒSurfaceFlingerä¸­æ— è®ºæ˜¯Layerå±æ€§çš„å˜åŒ–è¿˜æ˜¯å›¾åƒçš„å˜åŒ–éƒ½å¤„ç†å¥½äº†ï¼Œåªç­‰VSyncä¿¡å·åˆ°æ¥å°±å¯ä»¥è¾“å‡ºäº†ã€‚</p><h2 id="ä¸‰ã€rebuildLayerStackså‡½æ•°"><a href="#ä¸‰ã€rebuildLayerStackså‡½æ•°" class="headerlink" title="ä¸‰ã€rebuildLayerStackså‡½æ•°"></a>ä¸‰ã€rebuildLayerStackså‡½æ•°</h2><p>å‰é¢ä»‹ç»ï¼ŒVSyncä¿¡å·åˆ°æ¥åï¼Œå…ˆæ˜¯è°ƒç”¨äº†rebuildLayerStackså‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::rebuildLayerStacks() &#123;</span><br><span class="line">updateExtendedMode();</span><br><span class="line"><span class="comment">// rebuild the visible layer list per screen</span></span><br><span class="line"><span class="keyword">if</span> (CC_UNLIKELY(mVisibleRegionsDirty)) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">false</span>;</span><br><span class="line">    invalidateHwcGeometry();</span><br><span class="line">    <span class="comment">//è®¡ç®—æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡ä¸Šå¯è§çš„Layer  </span></span><br><span class="line">    <span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        Region opaqueRegion;</span><br><span class="line">        Region dirtyRegion;</span><br><span class="line">        Vector&lt; sp&lt;Layer&gt; &gt; layersSortedByZ;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; hw(mDisplays[dpy]);</span><br><span class="line">        const Transform&amp; tr(hw-&gt;getTransform());</span><br><span class="line">        const Rect bounds(hw-&gt;getBounds());</span><br><span class="line">        <span class="keyword">if</span> (hw-&gt;isDisplayOn()) &#123;</span><br><span class="line">            <span class="comment">//è®¡ç®—æ¯ä¸ªlayerçš„å¯è§åŒºåŸŸï¼Œç¡®å®šè®¾å¤‡éœ€è¦é‡æ–°ç»˜åˆ¶çš„åŒºåŸŸ  </span></span><br><span class="line">            computeVisibleRegions(hw-&gt;getHwcDisplayId(), layers,</span><br><span class="line">                    hw-&gt;getLayerStack(), dirtyRegion, opaqueRegion);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//åªéœ€è¦å’Œæ˜¾ç¤ºè®¾å¤‡çš„LayerStackç›¸åŒçš„layer  </span></span><br><span class="line">                    <span class="function">Region <span class="title">drawRegion</span><span class="params">(tr.transform(</span></span></span><br><span class="line">                            layer-&gt;visibleNonTransparentRegion));</span><br><span class="line">                    drawRegion.andSelf(bounds);</span><br><span class="line">                    <span class="keyword">if</span> (!drawRegion.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœLayerçš„æ˜¾ç¤ºåŒºåŸŸå’Œæ˜¾ç¤ºè®¾å¤‡çš„çª—å£æœ‰äº¤é›†  </span></span><br><span class="line">                        <span class="comment">//æŠŠLayeråŠ å…¥åˆ—è¡¨ä¸­</span></span><br><span class="line">                        layersSortedByZ.add(layer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è®¾ç½®æ˜¾ç¤ºè®¾å¤‡çš„å¯è§Layeråˆ—è¡¨  </span></span><br><span class="line">        hw-&gt;setVisibleLayersSortedByZ(layersSortedByZ);</span><br><span class="line">        hw-&gt;undefinedRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        hw-&gt;undefinedRegion.subtractSelf(tr.transform(opaqueRegion));</span><br><span class="line">        hw-&gt;dirtyRegion.orSelf(dirtyRegion);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>rebuildLayerStackså‡½æ•°çš„ä½œç”¨æ˜¯é‡å»ºæ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„å¯è§layerå¯¹è±¡åˆ—è¡¨ã€‚å¯¹äºæŒ‰æ˜¾ç¤ºè½´ï¼ˆZè½´ï¼‰æ’åˆ—çš„Layerå¯¹è±¡ï¼Œæ’åœ¨æœ€å‰é¢çš„å½“ç„¶ä¼šä¼˜å…ˆæ˜¾ç¤ºï¼Œä½†æ˜¯Layerå›¾åƒå¯èƒ½æœ‰é€æ˜åŸŸï¼Œä¹Ÿå¯èƒ½æœ‰å°ºå¯¸æ²¡æœ‰è¦†ç›–æ•´ä¸ªå±å¹•ï¼Œå› æ­¤ä¸‹é¢çš„layerä¹Ÿæœ‰æ˜¾ç¤ºçš„æœºä¼šã€‚rebuildLayerStackså‡½æ•°å¯¹æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡ï¼Œå…ˆè®¡ç®—å’Œæ˜¾ç¤ºè®¾å¤‡å…·æœ‰ç›¸åŒlayerStackå€¼çš„Layerå¯¹è±¡åœ¨è¯¥æ˜¾ç¤ºè®¾å¤‡ä¸Šçš„å¯è§åŒºåŸŸã€‚ç„¶åå°†å¯è§åŒºåŸŸå’Œæ˜¾ç¤ºè®¾å¤‡çš„çª—å£åŒºåŸŸæœ‰äº¤é›†çš„layerç»„æˆä¸€ä¸ªæ–°çš„åˆ—è¡¨ï¼Œæœ€åæŠŠè¿™ä¸ªåˆ—è¡¨è®¾ç½®åˆ°æ˜¾ç¤ºè®¾å¤‡å¯¹è±¡ä¸­ã€‚ computeVisibleRegionså‡½æ•°é¦–å…ˆè®¡ç®—æ¯ä¸ªLayeråœ¨è®¾å¤‡ä¸Šçš„å¯è§åŒºåŸŸvisibleRegionã€‚è®¡ç®—æ–¹æ³•å°±æ˜¯ç”¨æ•´ä¸ªLayerçš„åŒºåŸŸå‡å»ä¸Šå±‚æ‰€æœ‰ä¸é€æ˜åŒºåŸŸaboveOpaqueLayersã€‚è€Œä¸Šå±‚æ‰€æœ‰ä¸é€æ˜åŒºåŸŸå€¼æ˜¯ä¸€ä¸ªé€å±‚ç´¯è®¡çš„è¿‡ç¨‹ï¼Œæ¯å±‚éƒ½éœ€è¦æŠŠè‡ªå·±çš„ä¸é€æ˜åŒºåŸŸç´¯åŠ åˆ°aboveOpaqueLayersä¸­ã€‚ è€Œæ¯å±‚çš„ä¸é€æ˜åŒºåŸŸçš„è®¡ç®—æ–¹æ³•ï¼šå¦‚æœLayerçš„alphaçš„å€¼ä¸º255ï¼Œå¹¶ä¸”layerçš„isOpaqueå‡½æ•°ä¸ºtrueï¼Œåˆ™æœ¬å±‚çš„ä¸é€æ˜åŒºåŸŸç­‰äºLayeræ‰€åœ¨åŒºåŸŸï¼Œå¦åˆ™ä¸º0.è¿™æ ·ä¸€å±‚å±‚ç®—ä¸‹æ¥ï¼Œå°±å¾ˆå®¹æ˜“å¾—åˆ°æ¯å±‚çš„å¯è§åŒºåŸŸå¤§å°äº†ã€‚ å…¶æ¬¡ï¼Œè®¡ç®—æ•´ä¸ªæ˜¾ç¤ºè®¾å¤‡éœ€è¦æ›´æ–°çš„åŒºåŸŸoutDirtyRegionã€‚outDirtyRegionçš„å€¼ä¹Ÿæ˜¯ç´¯è®¡æ‰€æœ‰å±‚çš„éœ€è¦é‡å›çš„åŒºåŸŸå¾—åˆ°çš„ã€‚å¦‚æœLayerä¸­çš„æ˜¾ç¤ºå†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™æ•´ä¸ªå¯è§åŒºåŸŸvisibleRegionéƒ½éœ€è¦æ›´æ–°ï¼ŒåŒæ—¶è¿˜è¦åŒ…æ‹¬ä¸Šä¸€æ¬¡çš„å¯è§åŒºåŸŸï¼Œç„¶ååœ¨å»æ‰è¢«ä¸Šå±‚è¦†ç›–åçš„åŒºåŸŸå¾—åˆ°çš„å°±æ˜¯Layeréœ€è¦æ›´æ–°çš„åŒºåŸŸã€‚å¦‚æœLayeræ˜¾ç¤ºçš„å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯è€ƒè™‘åˆ°çª—å£å¤§å°çš„å˜åŒ–æˆ–è€…ä¸Šå±‚çª—å£çš„å˜åŒ–ï¼Œå› æ­¤Layerä¸­è¿˜æ˜¯æœ‰åŒºåŸŸå¯ä»¥éœ€è¦é‡ç»˜çš„åœ°æ–¹ã€‚è¿™ç§æƒ…å†µä¸‹æœ€ç®€å•çš„ç®—æ³•æ˜¯ç”¨Layerè®¡ç®—å‡ºå¯è§åŒºåŸŸå‡å»ä»¥å‰çš„å¯è§åŒºåŸŸå°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨computeVisibleRegionså‡½æ•°è¿˜å¼•å…¥äº†è¢«è¦†ç›–åŒºåŸŸï¼Œé€šå¸¸è¢«è¦†ç›–åŒºåŸŸå’Œå¯è§åŒºåŸŸå¹¶ä¸é‡å¤ï¼Œå› æ­¤å‡½æ•°ä¸­è®¡ç®—æš´éœ²åŒºåŸŸæ˜¯ç”¨å¯è§åŒºåŸŸå‡å»è¢«è¦†ç›–åŒºåŸŸçš„ã€‚</p><h3 id="å››ã€setUpHWComposerå‡½æ•°"><a href="#å››ã€setUpHWComposerå‡½æ•°" class="headerlink" title="å››ã€setUpHWComposerå‡½æ•°"></a>å››ã€setUpHWComposerå‡½æ•°</h3><p>setUpHWComposerå‡½æ•°çš„ä½œç”¨æ˜¯æ›´æ–°HWComposerå¯¹è±¡ä¸­å›¾å±‚å¯¹è±¡åˆ—è¡¨ä»¥åŠå›¾å±‚å±æ€§ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::setUpHWComposer() &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    <span class="keyword">bool</span> dirty = !mDisplays[dpy]-&gt;getDirtyRegion(<span class="literal">false</span>).isEmpty();</span><br><span class="line">    <span class="keyword">bool</span> empty = mDisplays[dpy]-&gt;getVisibleLayersSortedByZ().size() == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> wasEmpty = !mDisplays[dpy]-&gt;lastCompositionHadVisibleLayers;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">bool</span> mustRecompose = dirty &amp;&amp; !(empty &amp;&amp; wasEmpty);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    mDisplays[dpy]-&gt;beginFrame(mustRecompose);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mustRecompose) &#123;</span><br><span class="line">        mDisplays[dpy]-&gt;lastCompositionHadVisibleLayers = !empty;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¾—åˆ°ç³»ç»ŸHWComposerå¯¹è±¡  </span></span><br><span class="line">HWComposer&amp; hwc(getHwComposer());</span><br><span class="line"><span class="keyword">if</span> (hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">    <span class="comment">// build the h/w work list</span></span><br><span class="line">    <span class="keyword">if</span> (CC_UNLIKELY(mHwWorkListDirty)) &#123;</span><br><span class="line">        mHwWorkListDirty = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">            sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">            <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                    hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">                <span class="comment">//æ ¹æ®Layeræ•°é‡åœ¨HWComposerä¸­åˆ›å»ºhwc_layer_list_tåˆ—è¡¨  </span></span><br><span class="line">                <span class="keyword">if</span> (hwc.createWorkList(id, count) == NO_ERROR) &#123;</span><br><span class="line">                    HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">                    <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                        layer-&gt;setGeometry(hw, *cur);</span><br><span class="line">                        <span class="keyword">if</span> (mDebugDisableHWC || mDebugRegion || mDaltonize || mHasColorMatrix) &#123;</span><br><span class="line">                            cur-&gt;setSkip(<span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the per-frame data</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">        <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">bool</span> freezeSurfacePresent = <span class="literal">false</span>;</span><br><span class="line">            isfreezeSurfacePresent(freezeSurfacePresent, hw, id);</span><br><span class="line">            <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">            HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">            <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * update the per-frame h/w composer data for each layer</span></span><br><span class="line"><span class="comment">                 * and build the transparent region of the FB</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                <span class="comment">//å°†Layerçš„mActiveBufferè®¾ç½®åˆ°HWComposerä¸­</span></span><br><span class="line">                layer-&gt;setPerFrameData(hw, *cur);</span><br><span class="line">                setOrientationEventControl(freezeSurfacePresent,id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If possible, attempt to use the cursor overlay on each display.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">        <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">            HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">            <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                <span class="keyword">if</span> (layer-&gt;isPotentialCursor()) &#123;</span><br><span class="line">                    cur-&gt;setIsCursorLayerHint();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dumpDrawCycle(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = hwc.prepare();</span><br><span class="line">    ALOGE_IF(err, <span class="string">"HWComposer::prepare failed (%s)"</span>, strerror(-err));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        hw-&gt;prepareFrame(hwc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HWComposerä¸­æœ‰ä¸€ä¸ªç±»å‹ä¸ºDisplayDataç»“æ„çš„æ•°ç»„mDisplayDataï¼Œå®ƒç»´æŠ¤ç€æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„ä¿¡æ¯ã€‚DisplayDataç»“æ„ä¸­æœ‰ä¸€ä¸ªç±»å‹ä¸ºhwc_display_contents_lå­—æ®µlistï¼Œè¿™ä¸ªå­—æ®µåˆæœ‰ä¸€ä¸ªhwc_layer_lç±»å‹çš„æ•°ç»„hwLayersï¼Œè®°å½•è¯¥æ˜¾ç¤ºè®¾å¤‡æ‰€æœ‰éœ€è¦è¾“å‡ºçš„Layerä¿¡æ¯ã€‚ setUpHWComposerå‡½æ•°è°ƒç”¨HWComposerçš„createWorkListå‡½æ•°å°±æ˜¯æ ¹æ®æ¯ç§æ˜¾ç¤ºè®¾å¤‡çš„Layeræ•°é‡ï¼Œåˆ›å»ºå’Œåˆå§‹åŒ–hwc_display_contents_lå¯¹è±¡å’Œhwc_layer_læ•°ç»„ åˆ›å»ºå®ŒHWComposerä¸­çš„åˆ—è¡¨åï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹æ¯ä¸ªLayerå¯¹è±¡è°ƒç”¨å®ƒçš„setPerFrameDataå‡½æ•°ï¼Œå‚æ•°æ˜¯HWComposerå’ŒHWCLayerInterfaceã€‚setPerFrameDataå‡½æ•°å°†Layerå¯¹è±¡çš„å½“å‰å›¾åƒç¼“å†²åŒºmActiveBufferè®¾ç½®åˆ°HWCLayerInterfaceå¯¹è±¡å¯¹åº”çš„hwc_layer_lå¯¹è±¡ä¸­ã€‚ HWComposerç±»ä¸­é™¤äº†å‰é¢ä»‹ç»çš„Grallocè¿˜ç®¡ç†ç€Composeræ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—å®ç°äº†ç¡¬ä»¶çš„å›¾åƒåˆæˆåŠŸèƒ½ã€‚setUpHWComposerå‡½æ•°æ¥ä¸‹æ¥è°ƒç”¨HWComposerç±»çš„prepareå‡½æ•°ï¼Œè€Œprepareå‡½æ•°ä¼šè°ƒç”¨Composeræ¨¡å—çš„prepareæ¥å£ã€‚æœ€ååˆ°å„ä¸ªå‚å®¶çš„å®ç°hwc_prepareå‡½æ•°å°†æ¯ç§HWComposerä¸­çš„æ‰€æœ‰å›¾å±‚çš„ç±»å‹éƒ½è®¾ç½®ä¸ºHWC_FRAMEBUFFERå°±ç»“æŸäº†ã€‚</p><h3 id="äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ-ï¼ˆdoComposition-å‡½æ•°ï¼‰"><a href="#äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ-ï¼ˆdoComposition-å‡½æ•°ï¼‰" class="headerlink" title="äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ ï¼ˆdoComposition()å‡½æ•°ï¼‰"></a>äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ ï¼ˆdoComposition()å‡½æ•°ï¼‰</h3><p>doCompositionå‡½æ•°æ˜¯åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒï¼Œä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::doComposition() &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> repaintEverything = android_atomic_and(<span class="number">0</span>, &amp;mRepaintEverything);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; hw(mDisplays[dpy]);</span><br><span class="line">    <span class="keyword">if</span> (hw-&gt;isDisplayOn()) &#123;</span><br><span class="line">        <span class="comment">// transform the dirty region into this screen's coordinate space</span></span><br><span class="line">        const Region dirtyRegion(hw-&gt;getDirtyRegion(repaintEverything));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// repaint the framebuffer (if needed)</span></span><br><span class="line">        doDisplayComposition(hw, dirtyRegion);</span><br><span class="line"></span><br><span class="line">        hw-&gt;dirtyRegion.clear();</span><br><span class="line">        hw-&gt;flip(hw-&gt;swapRegion);</span><br><span class="line">        hw-&gt;swapRegion.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// inform the h/w that we're done compositing</span></span><br><span class="line">    hw-&gt;compositionComplete();</span><br><span class="line">&#125;</span><br><span class="line">postFramebuffer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doCompositionå‡½æ•°é’ˆå¯¹æ¯ç§æ˜¾ç¤ºè®¾å¤‡è°ƒç”¨doDisplayCompositionå‡½æ•°æ¥åˆæˆï¼Œåˆæˆåè°ƒç”¨postFramebufferå‡½æ•°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹doDisplayCompositionå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::doDisplayComposition(<span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt;&amp; hw,</span><br><span class="line">    <span class="keyword">const</span> Region&amp; inDirtyRegion)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">// We only need to actually compose the display if:</span></span><br><span class="line"><span class="comment">// 1) It is being handled by hardware composer, which may need this to</span></span><br><span class="line"><span class="comment">//    keep its virtual display state machine in sync, or</span></span><br><span class="line"><span class="comment">// 2) There is work to be done (the dirty region isn't empty)</span></span><br><span class="line"><span class="keyword">bool</span> isHwcDisplay = hw-&gt;getHwcDisplayId() &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!isHwcDisplay &amp;&amp; inDirtyRegion.isEmpty()) &#123;</span><br><span class="line">    ALOGV(<span class="string">"Skipping display composition"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALOGV(<span class="string">"doDisplayComposition"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function">Region <span class="title">dirtyRegion</span><span class="params">(inDirtyRegion)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compute the invalid region</span></span><br><span class="line"><span class="comment">//swapRegionè®¾ç½®ä¸ºéœ€è¦æ›´æ–°çš„åŒºåŸŸ  </span></span><br><span class="line">hw-&gt;swapRegion.orSelf(dirtyRegion);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> flags = hw-&gt;getFlags();<span class="comment">//è·å¾—æ˜¾ç¤ºè®¾å¤‡æ”¯æŒçš„æ›´æ–°æ–¹å¼æ ‡å¿—  </span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; DisplayDevice::SWAP_RECTANGLE) &#123;</span><br><span class="line">    <span class="comment">// we can redraw only what's dirty, but since SWAP_RECTANGLE only</span></span><br><span class="line">    <span class="comment">// takes a rectangle, we must make sure to update that whole</span></span><br><span class="line">    <span class="comment">// rectangle in that case</span></span><br><span class="line">    dirtyRegion.<span class="built_in">set</span>(hw-&gt;swapRegion.bounds());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; DisplayDevice::PARTIAL_UPDATES) &#123;<span class="comment">//æ”¯æŒéƒ¨åˆ†æ›´æ–°  </span></span><br><span class="line">        <span class="comment">// We need to redraw the rectangle that will be updated</span></span><br><span class="line">        <span class="comment">// (pushed to the framebuffer).</span></span><br><span class="line">        <span class="comment">// This is needed because PARTIAL_UPDATES only takes one</span></span><br><span class="line">        <span class="comment">// rectangle instead of a region (see DisplayDevice::flip())</span></span><br><span class="line">        <span class="comment">//å°†æ›´æ–°åŒºåŸŸè°ƒæ•´ä¸ºæ•´ä¸ªçª—å£å¤§å°  </span></span><br><span class="line">        dirtyRegion.<span class="built_in">set</span>(hw-&gt;swapRegion.bounds());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// we need to redraw everything (the whole screen)</span></span><br><span class="line">        dirtyRegion.<span class="built_in">set</span>(hw-&gt;bounds());</span><br><span class="line">        hw-&gt;swapRegion = dirtyRegion;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆæˆ  </span></span><br><span class="line"><span class="keyword">if</span> (!doComposeSurfaces(hw, dirtyRegion)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update the swap region and clear the dirty region</span></span><br><span class="line">hw-&gt;swapRegion.orSelf(dirtyRegion);</span><br><span class="line"><span class="comment">//æ²¡æœ‰ç¡¬ä»¶composerçš„æƒ…å†µï¼Œè¾“å‡ºå›¾åƒ</span></span><br><span class="line"><span class="comment">// swap buffers (presentation)</span></span><br><span class="line">hw-&gt;swapBuffers(getHwComposer());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doDisplayCompositionå‡½æ•°æ ¹æ®æ˜¾ç¤ºè®¾å¤‡æ”¯æŒçš„æ›´æ–°æ–¹å¼ï¼Œé‡æ–°è®¾ç½®éœ€è¦æ›´æ–°åŒºåŸŸçš„å¤§å°ã€‚ çœŸæ­£çš„åˆæˆå·¥ä½œæ˜¯åœ¨doComposerSurfaceså‡½æ•°ä¸­å®Œæˆï¼Œè¿™ä¸ªå‡½æ•°åœ¨layerçš„ç±»å‹ä¸ºHWC_FRAMEBUFFER,æˆ–è€…ä¸æ”¯æŒç¡¬ä»¶çš„composerçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨layerçš„drawå‡½æ•°æ¥ä¸€å±‚ä¸€å±‚ä½åˆæˆæœ€åçš„å›¾åƒã€‚ åˆæˆå®Œåï¼ŒdoDisplayCompositionå‡½æ•°è°ƒç”¨äº†hwçš„swapBufferså‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å‰é¢ä»‹ç»è¿‡äº†ï¼Œå®ƒå°†åœ¨ç³»ç»Ÿä¸æ”¯æŒç¡¬ä»¶çš„composeræƒ…å†µä¸‹è°ƒç”¨eglSwapBuffersæ¥è¾“å‡ºå›¾åƒåˆ°æ˜¾ç¤ºè®¾å¤‡ã€‚</p><h3 id="å…­ã€postFramebuffer-å‡½æ•°"><a href="#å…­ã€postFramebuffer-å‡½æ•°" class="headerlink" title="å…­ã€postFramebuffer()å‡½æ•°"></a>å…­ã€postFramebuffer()å‡½æ•°</h3><p>ä¸Šä¸€èŠ‚çš„doCompositionå‡½æ•°æœ€åè°ƒç”¨äº†postFramebufferå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::postFramebuffer()</span><br><span class="line">&#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">nsecs_t</span> now = systemTime();</span><br><span class="line">mDebugInSwapBuffers = now;</span><br><span class="line"></span><br><span class="line">HWComposer&amp; hwc(getHwComposer());</span><br><span class="line"><span class="keyword">if</span> (hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hwc.supportsFramebufferTarget()) &#123;</span><br><span class="line">        <span class="comment">// EGL spec says:</span></span><br><span class="line">        <span class="comment">//   "surface must be bound to the calling thread's current context,</span></span><br><span class="line">        <span class="comment">//    for the current rendering API."</span></span><br><span class="line">        getDefaultDisplayDevice()-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line">    &#125;</span><br><span class="line">    hwc.commit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// make the default display current because the VirtualDisplayDevice code cannot</span></span><br><span class="line"><span class="comment">// deal with dequeueBuffer() being called outside of the composition loop; however</span></span><br><span class="line"><span class="comment">// the code below can call glFlush() which is allowed (and does in some case) call</span></span><br><span class="line"><span class="comment">// dequeueBuffer().</span></span><br><span class="line">getDefaultDisplayDevice()-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">    <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">    hw-&gt;onSwapBuffersCompleted(hwc);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">    <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">    <span class="keyword">if</span> (id &gt;=<span class="number">0</span> &amp;&amp; hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">        HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">        <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; cur != end &amp;&amp; i &lt; count; ++i, ++cur) &#123;</span><br><span class="line">            currentLayers[i]-&gt;onLayerDisplayed(hw, &amp;*cur);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            currentLayers[i]-&gt;onLayerDisplayed(hw, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mLastSwapBufferTime = systemTime() - now;</span><br><span class="line">mDebugInSwapBuffers = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> flipCount = getDefaultDisplayDevice()-&gt;getPageFlipCount();</span><br><span class="line"><span class="keyword">if</span> (flipCount % LOG_FRAME_STATS_PERIOD == <span class="number">0</span>) &#123;</span><br><span class="line">    logFrameStats();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>postFramebufferå…ˆåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦æ”¯æŒcomposerï¼Œå¦‚æœä¸æ”¯æŒï¼Œæˆ‘ä»¬çŸ¥é“å›¾åƒå·²ç»åœ¨doCompositionå‡½æ•°æ—¶è°ƒç”¨hw-&gt;swapBuffersè¾“å‡ºäº†ï¼Œå°±è¿”å›äº†ã€‚å¦‚æœæ”¯æŒç¡¬ä»¶composerï¼ŒpostFramebufferå‡½æ•°å°†è°ƒç”¨HWComposerçš„commitå‡½æ•°ç»§ç»­æ‰§è¡Œã€‚ [HWComposer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> HWComposer::commit() &#123;</span><br><span class="line"><span class="keyword">int</span> err = NO_ERROR;</span><br><span class="line"><span class="keyword">if</span> (mHwc) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1)) &#123;</span><br><span class="line">        <span class="comment">// On version 1.0, the OpenGL ES target surface is communicated</span></span><br><span class="line">        <span class="comment">// by the (dpy, sur) fields and we are guaranteed to have only</span></span><br><span class="line">        <span class="comment">// a single display.</span></span><br><span class="line">        mLists[<span class="number">0</span>]-&gt;dpy = eglGetCurrentDisplay();</span><br><span class="line">        mLists[<span class="number">0</span>]-&gt;sur = eglGetCurrentSurface(EGL_DRAW);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=VIRTUAL_DISPLAY_ID_BASE; i&lt;mNumDisplays; i++) &#123;</span><br><span class="line">        <span class="function">DisplayData&amp; <span class="title">disp</span><span class="params">(mDisplayData[i])</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (disp.outbufHandle) &#123;</span><br><span class="line">            mLists[i]-&gt;outbuf = disp.outbufHandle;</span><br><span class="line">            mLists[i]-&gt;outbufAcquireFenceFd =</span><br><span class="line">                    disp.outbufAcquireFence-&gt;dup();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = mHwc-&gt;<span class="built_in">set</span>(mHwc, mNumDisplays, mLists);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;mNumDisplays ; i++) &#123;</span><br><span class="line">        <span class="function">DisplayData&amp; <span class="title">disp</span><span class="params">(mDisplayData[i])</span></span>;</span><br><span class="line">        disp.lastDisplayFence = disp.lastRetireFence;</span><br><span class="line">        disp.lastRetireFence = Fence::NO_FENCE;</span><br><span class="line">        <span class="keyword">if</span> (disp.<span class="built_in">list</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (disp.<span class="built_in">list</span>-&gt;retireFenceFd != <span class="number">-1</span>) &#123;</span><br><span class="line">                disp.lastRetireFence = <span class="keyword">new</span> Fence(disp.<span class="built_in">list</span>-&gt;retireFenceFd);</span><br><span class="line">                disp.<span class="built_in">list</span>-&gt;retireFenceFd = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            disp.<span class="built_in">list</span>-&gt;flags &amp;= ~HWC_GEOMETRY_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">status_t</span>)err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆæˆæ•ˆæœå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/20-Android-Graphics-SurfaceFlinger-composition.png" alt="Markdown"></p><h2 id="ï¼ˆå…­ï¼‰ã€Android-SurfaceFlinger-VSyncå·¥ä½œåŸç†"><a href="#ï¼ˆå…­ï¼‰ã€Android-SurfaceFlinger-VSyncå·¥ä½œåŸç†" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Android SurfaceFlinger - VSyncå·¥ä½œåŸç†"></a>ï¼ˆå…­ï¼‰ã€Android SurfaceFlinger - VSyncå·¥ä½œåŸç†</h2><h3 id="ä¸€ã€VSYNC-æ€»ä½“æ¦‚å¿µ"><a href="#ä¸€ã€VSYNC-æ€»ä½“æ¦‚å¿µ" class="headerlink" title="ä¸€ã€VSYNC æ€»ä½“æ¦‚å¿µ"></a>ä¸€ã€VSYNC æ€»ä½“æ¦‚å¿µ</h3><h3 id="6-1-1ã€VSYNC-æ¦‚å¿µ"><a href="#6-1-1ã€VSYNC-æ¦‚å¿µ" class="headerlink" title="6.1.1ã€VSYNC æ¦‚å¿µ"></a>6.1.1ã€VSYNC æ¦‚å¿µ</h3><p>VSYNCï¼ˆVertical Synchronizationï¼‰æ˜¯ä¸€ä¸ªç›¸å½“å¤è€çš„æ¦‚å¿µï¼Œå¯¹äºæ¸¸æˆç©å®¶ï¼Œå®ƒæœ‰ä¸€ä¸ªæ›´åŠ å¤§åé¼é¼çš„ä¸­æ–‡åå­—â€”å‚ç›´åŒæ­¥ã€‚ â€œå‚ç›´åŒæ­¥(vsync)â€æŒ‡çš„æ˜¯æ˜¾å¡çš„è¾“å‡ºå¸§æ•°å’Œå±å¹•çš„å‚ç›´åˆ·æ–°ç‡ç›¸åŒï¼Œè¿™å®Œå…¨æ˜¯ä¸€ä¸ªCRTæ˜¾ç¤ºå™¨ä¸Šçš„æ¦‚å¿µã€‚å…¶å®æ— è®ºæ˜¯VSYNCè¿˜æ˜¯å‚ç›´åŒæ­¥è¿™ä¸ªåå­—ï¼Œå› ä¸ºLCDæ ¹æœ¬å°±æ²¡æœ‰å‚ç›´æ‰«æçš„è¿™ç§ä¸œè¥¿ï¼Œå› æ­¤è¿™ä¸ªåå­—æœ¬èº«å·²ç»æ²¡æœ‰æ„ä¹‰ã€‚ä½†æ˜¯åŸºäºå†å²çš„åŸå› ï¼Œè¿™ä¸ªåç§°åœ¨å›¾å½¢å›¾åƒé¢†åŸŸè¢«æ²¿è¢­ä¸‹æ¥ã€‚ åœ¨å½“ä¸‹ï¼Œå‚ç›´åŒæ­¥çš„å«ä¹‰æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºï¼Œä½¿å¾—æ˜¾å¡ç”Ÿæˆå¸§çš„é€Ÿåº¦å’Œå±å¹•åˆ·æ–°çš„é€Ÿåº¦çš„ä¿æŒä¸€è‡´ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœå±å¹•çš„åˆ·æ–°ç‡ä¸º60Hzï¼Œé‚£ä¹ˆç”Ÿæˆå¸§çš„é€Ÿåº¦å°±åº”è¯¥è¢«å›ºå®šåœ¨1/60 sã€‚</p><h3 id="6-1-2ã€Android-VSYNC-â€“-é»„æ²¹è®¡åˆ’"><a href="#6-1-2ã€Android-VSYNC-â€“-é»„æ²¹è®¡åˆ’" class="headerlink" title="6.1.2ã€Android VSYNC â€“ é»„æ²¹è®¡åˆ’"></a>6.1.2ã€Android VSYNC â€“ é»„æ²¹è®¡åˆ’</h3><p>è°·æ­Œä¸ºè§£å†³Androidç³»ç»Ÿæµç•…æ€§é—®é¢˜ã€‚åœ¨4.1ç‰ˆæœ¬å¼•å…¥äº†ä¸€ä¸ªé‡å¤§çš„æ”¹è¿›â€“Project Butteré»„æ²¹è®¡åˆ’ã€‚ Project Butterå¯¹Android Displayç³»ç»Ÿè¿›è¡Œäº†é‡æ„ï¼Œå¼•å…¥äº†ä¸‰ä¸ªæ ¸å¿ƒå…ƒç´ ï¼Œå³VSYNCã€Triple Bufferå’ŒChoreographerã€‚ VSYNCæœ€é‡è¦çš„ä½œç”¨æ˜¯é˜²æ­¢å‡ºç°ç”»é¢æ’•è£‚ï¼ˆscreentearingï¼‰ã€‚æ‰€è°“ç”»é¢æ’•è£‚ï¼Œå°±æ˜¯æŒ‡ä¸€ä¸ªç”»é¢ä¸Šå‡ºç°äº†ä¸¤å¸§ç”»é¢çš„å†…å®¹ï¼Œå¦‚ä¸‹å›¾ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/21-Android-graphics-view-teaning.png" alt="Markdown"></p><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿè¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯å› ä¸ºæ˜¾å¡è¾“å‡ºå¸§çš„é€Ÿåº¦é«˜äºæ˜¾ç¤ºå™¨çš„åˆ·æ–°é€Ÿåº¦ï¼Œå¯¼è‡´æ˜¾ç¤ºå™¨å¹¶ä¸èƒ½åŠæ—¶å¤„ç†è¾“å‡ºçš„å¸§ï¼Œè€Œæœ€ç»ˆå‡ºç°äº†å¤šä¸ªå¸§çš„ç”»é¢éƒ½ç•™åœ¨äº†æ˜¾ç¤ºå™¨ä¸Šçš„é—®é¢˜ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç”»é¢æ’•è£‚ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/22-Android-Graphics-Draw-whithout-vsync.png" alt="Markdown"></p><p>è¿™ä¸ªå›¾ä¸­æœ‰ä¸‰ä¸ªå…ƒç´ ï¼ŒDisplayæ˜¯æ˜¾ç¤ºå±å¹•ï¼ŒGPUå’ŒCPUè´Ÿè´£æ¸²æŸ“å¸§æ•°æ®ï¼Œæ¯ä¸ªå¸§ä»¥æ–¹æ¡†è¡¨ç¤ºï¼Œå¹¶ä»¥æ•°å­—è¿›è¡Œç¼–å·ï¼Œå¦‚0ã€1ã€2ç­‰ç­‰ã€‚VSyncç”¨äºæŒ‡å¯¼åŒç¼“å†²åŒºçš„äº¤æ¢ã€‚ ä»¥æ—¶é—´çš„é¡ºåºæ¥çœ‹ä¸‹å°†ä¼šå‘ç”Ÿçš„å¼‚å¸¸ï¼š Step1. Displayæ˜¾ç¤ºç¬¬0å¸§æ•°æ®ï¼Œæ­¤æ—¶CPUå’ŒGPUæ¸²æŸ“ç¬¬1å¸§ç”»é¢ï¼Œè€Œä¸”èµ¶åœ¨Displayæ˜¾ç¤ºä¸‹ä¸€å¸§å‰å®Œæˆ Step2. å› ä¸ºæ¸²æŸ“åŠæ—¶ï¼ŒDisplayåœ¨ç¬¬0å¸§æ˜¾ç¤ºå®Œæˆåï¼Œä¹Ÿå°±æ˜¯ç¬¬1ä¸ªVSyncåï¼Œæ­£å¸¸æ˜¾ç¤ºç¬¬1å¸§ Step3. ç”±äºæŸäº›åŸå› ï¼Œæ¯”å¦‚CPUèµ„æºè¢«å ç”¨ï¼Œç³»ç»Ÿæ²¡æœ‰åŠæ—¶åœ°å¼€å§‹å¤„ç†ç¬¬2å¸§ï¼Œç›´åˆ°ç¬¬2ä¸ªVSyncå¿«æ¥å‰æ‰å¼€å§‹å¤„ç† Step4. ç¬¬2ä¸ªVSyncæ¥æ—¶ï¼Œç”±äºç¬¬2å¸§æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å°±ç»ªï¼Œæ˜¾ç¤ºçš„è¿˜æ˜¯ç¬¬1å¸§ã€‚è¿™ç§æƒ…å†µè¢«Androidå¼€å‘ç»„å‘½åä¸ºâ€Jankâ€ã€‚ Step5. å½“ç¬¬2å¸§æ•°æ®å‡†å¤‡å®Œæˆåï¼Œå®ƒå¹¶ä¸ä¼šé©¬ä¸Šè¢«æ˜¾ç¤ºï¼Œè€Œæ˜¯è¦ç­‰å¾…ä¸‹ä¸€ä¸ªVSyncã€‚ æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯å±å¹•å¹³ç™½æ— æ•…åœ°å¤šæ˜¾ç¤ºäº†ä¸€æ¬¡ç¬¬1å¸§ã€‚åŸå› å¤§å®¶åº”è¯¥éƒ½çœ‹åˆ°äº†ï¼Œå°±æ˜¯CPUæ²¡æœ‰åŠæ—¶åœ°å¼€å§‹ç€æ‰‹å¤„ç†ç¬¬2å¸§çš„æ¸²æŸ“å·¥ä½œï¼Œä»¥è‡´â€å»¶è¯¯å†›æœºâ€ã€‚</p><p>å…¶å®æ€»ç»“ä¸Šé¢çš„è¿™ä¸ªæƒ…å†µä¹‹æ‰€ä»¥å‘ç”Ÿï¼Œé¦–å…ˆçš„åŸå› å°±åœ¨äºç¬¬äºŒå¸§æ²¡æœ‰åŠæ—¶çš„ç»˜åˆ¶ï¼ˆå½“ç„¶å³ä½¿ç¬¬äºŒå¸§åŠæ—¶ç»˜åˆ¶ï¼Œä¹Ÿä¾ç„¶å¯èƒ½å‡ºç°Jankï¼Œè¿™å°±æ˜¯åŒæ—¶å¼•å…¥ä¸‰é‡ç¼“å†²çš„ä½œç”¨ã€‚æˆ‘ä»¬å°†åœ¨ä¸‰é‡ç¼“å†²ä¸€èŠ‚ä¸­å†è®²è§£è¿™ç§æƒ…å†µï¼‰ã€‚é‚£ä¹ˆå¦‚ä½•ä½¿å¾—ç¬¬äºŒå¸§å³ä½¿è¢«ç»˜åˆ¶å‘¢ï¼Ÿ è¿™å°±æ˜¯æˆ‘ä»¬åœ¨Graphicç³»ç»Ÿä¸­å¼•å…¥VSYNCçš„åŸå› ï¼Œè€ƒè™‘ä¸‹é¢è¿™å¼ å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/23-Android-Graphics-Draw-whit-vsync.png" alt="Markdown"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€æ—¦VSyncå‡ºç°åï¼Œç«‹åˆ»å°±å¼€å§‹æ‰§è¡Œä¸‹ä¸€å¸§çš„ç»˜åˆ¶å·¥ä½œã€‚è¿™æ ·å°±å¯ä»¥å¤§å¤§é™ä½Jankå‡ºç°çš„æ¦‚ç‡ã€‚å¦å¤–ï¼ŒVSYNCå¼•å…¥åï¼Œè¦æ±‚ç»˜åˆ¶ä¹Ÿåªèƒ½åœ¨æ”¶åˆ°VSYNCæ¶ˆæ¯ä¹‹åæ‰èƒ½è¿›è¡Œï¼Œå› æ­¤ï¼Œä¹Ÿå°±æœç»äº†å¦å¤–ä¸€ç§æç«¯æƒ…å†µçš„å‡ºç°â€”CPUï¼ˆGPUï¼‰ä¸€ç›´ä¸åœçš„è¿›è¡Œç»˜åˆ¶ï¼Œå¸§çš„ç”Ÿæˆé€Ÿåº¦é«˜äºå±å¹•çš„åˆ·æ–°é€Ÿåº¦ï¼Œå¯¼è‡´ç”Ÿæˆçš„å¸§ä¸èƒ½è¢«æ˜¾ç¤ºï¼Œåªèƒ½ä¸¢å¼ƒï¼Œè¿™æ ·å°±å‡ºç°äº†ä¸¢å¸§çš„æƒ…å†µâ€”å¼•å…¥VSYNCåï¼Œç»˜åˆ¶çš„é€Ÿåº¦å°±å’Œå±å¹•åˆ·æ–°çš„é€Ÿåº¦ä¿æŒä¸€è‡´äº†ã€‚</p><h3 id="äºŒã€VSyncä¿¡å·äº§ç”Ÿ"><a href="#äºŒã€VSyncä¿¡å·äº§ç”Ÿ" class="headerlink" title="äºŒã€VSyncä¿¡å·äº§ç”Ÿ"></a>äºŒã€VSyncä¿¡å·äº§ç”Ÿ</h3><p>é‚£ä¹ˆVSYNCä¿¡å·æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿ Androidç³»ç»Ÿä¸­VSYNCä¿¡å·åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ç¡¬ä»¶ç”Ÿæˆçš„ä¿¡å·ï¼Œä¸€ç§æ˜¯è½¯ä»¶æ¨¡æ‹Ÿçš„ä¿¡å·ã€‚ ç¡¬ä»¶ä¿¡å·æ˜¯ç”±HardwareComposeræä¾›çš„ï¼ŒHWCå°è£…äº†ç›¸å…³çš„HALå±‚ï¼Œå¦‚æœç¡¬ä»¶å‚å•†æä¾›çš„HALå±‚å®ç°èƒ½å®šæ—¶äº§ç”ŸVSYNCä¸­æ–­ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ç¡¬ä»¶çš„VSYNCä¸­æ–­ï¼Œå¦åˆ™HardwareComposerå†…éƒ¨ä¼šé€šè¿‡VSyncThreadæ¥æ¨¡æ‹Ÿäº§ç”ŸVSYNCä¸­æ–­ï¼ˆå…¶å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯sleepå›ºå®šæ—¶é—´ï¼Œç„¶åå”¤é†’ï¼‰ã€‚</p><p>SurfaceFlingerçš„å¯åŠ¨è¿‡ç¨‹ä¸­inti()ä¼šåˆ›å»ºä¸€ä¸ªHWComposerå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">HWComposer::HWComposer(  </span><br><span class="line">        <span class="keyword">const</span> sp&lt;SurfaceFlinger&gt;&amp; flinger,  </span><br><span class="line">        EventHandler&amp; handler)  </span><br><span class="line">    : mFlinger(flinger),  </span><br><span class="line">      mFbDev(<span class="number">0</span>), mHwc(<span class="number">0</span>), mNumDisplays(<span class="number">1</span>),  </span><br><span class="line">      mCBContext(<span class="keyword">new</span> cb_context),  </span><br><span class="line">      mEventHandler(handler),  </span><br><span class="line">      mDebugForceFakeVSync(<span class="literal">false</span>)  </span><br><span class="line">&#123;  </span><br><span class="line">...  </span><br><span class="line">    <span class="comment">//é¦–å…ˆæ˜¯ä¸€äº›å’ŒVSYNCæœ‰å…³çš„ä¿¡æ¯çš„åˆå§‹åŒ–  </span></span><br><span class="line">    <span class="comment">//å› ä¸ºåœ¨ç¡¬ä»¶æ”¯æŒçš„æƒ…å†µä¸‹ï¼ŒVSYNCçš„åŠŸèƒ½å°±æ˜¯ç”±HWCæä¾›çš„  </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;HWC_NUM_PHYSICAL_DISPLAY_TYPES ; i++) &#123;  </span><br><span class="line">        mLastHwVSync[i] = <span class="number">0</span>;  </span><br><span class="line">        mVSyncCounts[i] = <span class="number">0</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//æ ¹æ®é…ç½®æ¥çœ‹æ˜¯å¦éœ€è¦æ¨¡æ‹ŸVSYNCæ¶ˆæ¯  </span></span><br><span class="line">    <span class="keyword">char</span> value[PROPERTY_VALUE_MAX];  </span><br><span class="line">    property_get(<span class="string">"debug.sf.no_hw_vsync"</span>, value, <span class="string">"0"</span>);  </span><br><span class="line">    mDebugForceFakeVSync = atoi(value);  </span><br><span class="line">    ...  </span><br><span class="line">    <span class="comment">// don't need a vsync thread if we have a hardware composer  </span></span><br><span class="line">    needVSyncThread = <span class="literal">false</span>;  </span><br><span class="line">    <span class="comment">// always turn vsync off when we start,åªæ˜¯æš‚æ—¶å…³é—­ä¿¡å·ï¼Œåé¢ä¼šå†å¼€å¯  </span></span><br><span class="line">    eventControl(HWC_DISPLAY_PRIMARY, HWC_EVENT_VSYNC, <span class="number">0</span>);      </span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ˜¾ç„¶ï¼Œå¦‚æœéœ€è¦æ¨¡æ‹ŸVSyncä¿¡å·çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦çº¿ç¨‹æ¥åšè¿™ä¸ªå·¥ä½œ  </span></span><br><span class="line">    <span class="keyword">if</span> (needVSyncThread) &#123;  </span><br><span class="line">        <span class="comment">// we don't have VSYNC support, we need to fake it  </span></span><br><span class="line">        <span class="comment">//VSyncThreadç±»çš„å®ç°å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯ä¸€ä¸ªè®¡æ—¶å™¨è€Œå·²ï¼Œå®šæ—¶å‘é€æ¶ˆæ¯è€Œå·²  </span></span><br><span class="line">        <span class="comment">//TODO VSYNCä¸“é¢˜  </span></span><br><span class="line">        mVSyncThread = <span class="keyword">new</span> VSyncThread(*<span class="keyword">this</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">...  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">HWComposer::HWComposer(  </span><br><span class="line">        <span class="keyword">const</span> sp&lt;SurfaceFlinger&gt;&amp; flinger,  </span><br><span class="line">        EventHandler&amp; handler)  </span><br><span class="line">    : mFlinger(flinger),  </span><br><span class="line">      mFbDev(<span class="number">0</span>), mHwc(<span class="number">0</span>), mNumDisplays(<span class="number">1</span>),  </span><br><span class="line">      mCBContext(<span class="keyword">new</span> cb_context),  </span><br><span class="line">      mEventHandler(handler),  </span><br><span class="line">      mDebugForceFakeVSync(<span class="literal">false</span>)  </span><br><span class="line">&#123;  </span><br><span class="line">...  </span><br><span class="line">    <span class="comment">//é¦–å…ˆæ˜¯ä¸€äº›å’ŒVSYNCæœ‰å…³çš„ä¿¡æ¯çš„åˆå§‹åŒ–  </span></span><br><span class="line">    <span class="comment">//å› ä¸ºåœ¨ç¡¬ä»¶æ”¯æŒçš„æƒ…å†µä¸‹ï¼ŒVSYNCçš„åŠŸèƒ½å°±æ˜¯ç”±HWCæä¾›çš„  </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;HWC_NUM_PHYSICAL_DISPLAY_TYPES ; i++) &#123;  </span><br><span class="line">        mLastHwVSync[i] = <span class="number">0</span>;  </span><br><span class="line">        mVSyncCounts[i] = <span class="number">0</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//æ ¹æ®é…ç½®æ¥çœ‹æ˜¯å¦éœ€è¦æ¨¡æ‹ŸVSYNCæ¶ˆæ¯  </span></span><br><span class="line">    <span class="keyword">char</span> value[PROPERTY_VALUE_MAX];  </span><br><span class="line">    property_get(<span class="string">"debug.sf.no_hw_vsync"</span>, value, <span class="string">"0"</span>);  </span><br><span class="line">    mDebugForceFakeVSync = atoi(value);  </span><br><span class="line">    ...  </span><br><span class="line">    <span class="comment">// don't need a vsync thread if we have a hardware composer  </span></span><br><span class="line">    needVSyncThread = <span class="literal">false</span>;  </span><br><span class="line">    <span class="comment">// always turn vsync off when we start,åªæ˜¯æš‚æ—¶å…³é—­ä¿¡å·ï¼Œåé¢ä¼šå†å¼€å¯  </span></span><br><span class="line">    eventControl(HWC_DISPLAY_PRIMARY, HWC_EVENT_VSYNC, <span class="number">0</span>);      </span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ˜¾ç„¶ï¼Œå¦‚æœéœ€è¦æ¨¡æ‹ŸVSyncä¿¡å·çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦çº¿ç¨‹æ¥åšè¿™ä¸ªå·¥ä½œ  </span></span><br><span class="line">    <span class="keyword">if</span> (needVSyncThread) &#123;  </span><br><span class="line">        <span class="comment">// we don't have VSYNC support, we need to fake it  </span></span><br><span class="line">        <span class="comment">//VSyncThreadç±»çš„å®ç°å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯ä¸€ä¸ªè®¡æ—¶å™¨è€Œå·²ï¼Œå®šæ—¶å‘é€æ¶ˆæ¯è€Œå·²  </span></span><br><span class="line">        <span class="comment">//TODO VSYNCä¸“é¢˜  </span></span><br><span class="line">        mVSyncThread = <span class="keyword">new</span> VSyncThread(*<span class="keyword">this</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸Šé¢è¿™æ®µä»£ç ã€‚ é¦–å…ˆmDebugForceFakeVSyncæ˜¯ä¸ºäº†è°ƒåˆ¶ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå˜é‡è®¾ç½®å¼ºåˆ¶ä½¿ç”¨è½¯ä»¶VSYNCæ¨¡æ‹Ÿã€‚ ç„¶åé’ˆå¯¹ä¸åŒçš„å±å¹•ï¼Œåˆå§‹åŒ–äº†ä»–ä»¬çš„mLastHwVSyncå’ŒmVSyncCountså€¼ã€‚ å¦‚æœç¡¬ä»¶æ”¯æŒï¼Œé‚£ä¹ˆå°±æŠŠneedVSyncThreadè®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºä¸éœ€è¦è½¯ä»¶æ¨¡æ‹Ÿã€‚ æ¥ç€é€šè¿‡eventControlæ¥æš‚æ—¶çš„å…³é—­äº†VSYNCä¿¡å·ï¼Œè¿™ä¸€ç‚¹å°†åœ¨ä¸‹é¢è®²è§£eventControlæ—¶ä¸€å¹¶è®²è§£ã€‚ æœ€åï¼Œå¦‚æœéœ€è¦è½¯ä»¶æ¨¡æ‹ŸVsyncä¿¡å·çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„VSyncThreadçº¿ç¨‹æ¥åšè¿™ä¸ªå·¥ä½œ(fake VSYNCæ˜¯è¿™ä¸ªçº¿ç¨‹å”¯ä¸€çš„ä½œç”¨)ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªçº¿ç¨‹ã€‚</p><p><strong>è½¯ä»¶æ¨¡æ‹Ÿ</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> HWComposer::VSyncThread::threadLoop() &#123;  </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">nsecs_t</span> period = mRefreshPeriod;  </span><br><span class="line">    <span class="comment">//å½“å‰çš„æ—¶é—´  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">nsecs_t</span> now = systemTime(CLOCK_MONOTONIC);  </span><br><span class="line">    <span class="comment">//ä¸‹ä¸€æ¬¡VSYNCåˆ°æ¥çš„æ—¶é—´  </span></span><br><span class="line">    <span class="keyword">nsecs_t</span> next_vsync = mNextFakeVSync;  </span><br><span class="line">    <span class="comment">//ä¸ºäº†ç­‰å¾…ä¸‹ä¸ªæ—¶é—´åˆ°æ¥åº”è¯¥ä¼‘çœ çš„æ—¶é—´  </span></span><br><span class="line">    <span class="keyword">nsecs_t</span> sleep = next_vsync - now;  </span><br><span class="line">    <span class="comment">//é”™è¿‡äº†VSYNCçš„æ—¶é—´  </span></span><br><span class="line">    <span class="keyword">if</span> (sleep &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="comment">// we missed, find where the next vsync should be  </span></span><br><span class="line">        <span class="comment">//é‡æ–°è®¡ç®—ä¸‹åº”è¯¥ä¼‘æ¯çš„æ—¶é—´  </span></span><br><span class="line">        sleep = (period - ((now - next_vsync) % period));  </span><br><span class="line">        <span class="comment">//æ›´æ–°ä¸‹æ¬¡VSYNCçš„æ—¶é—´  </span></span><br><span class="line">        next_vsync = now + sleep;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//æ›´æ–°ä¸‹ä¸‹æ¬¡VSYNCçš„æ—¶é—´  </span></span><br><span class="line">    mNextFakeVSync = next_vsync + period;  </span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">spec</span>;</span>  </span><br><span class="line">    spec.tv_sec  = next_vsync / <span class="number">1000000000</span>;  </span><br><span class="line">    spec.tv_nsec = next_vsync % <span class="number">1000000000</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> err;  </span><br><span class="line">    <span class="keyword">do</span> &#123;  </span><br><span class="line">        <span class="comment">//çº³ç§’ç²¾åº¦çº§çš„ä¼‘çœ   </span></span><br><span class="line">        err = clock_nanosleep(CLOCK_MONOTONIC, TIMER_ABSTIME, &amp;spec, <span class="literal">NULL</span>);  </span><br><span class="line">    &#125; <span class="keyword">while</span> (err&lt;<span class="number">0</span> &amp;&amp; errno == EINTR);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="comment">//ä¼‘çœ ä¹‹åï¼Œåˆ°äº†è¯¥å‘ç”ŸVSYNCçš„æ—¶é—´äº†  </span></span><br><span class="line">        mHwc.mEventHandler.onVSyncReceived(<span class="number">0</span>, next_vsync);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å…¶å®å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯ä¸€ä¸ªç®€å•çš„æ—¶é—´è®¡ç®—ï¼Œè®¡ç®—è¿‡ç¨‹æˆ‘å·²ç»å†™åœ¨äº†ç¨‹åºæ³¨é‡Šé‡Œé¢ã€‚æ€»ä¹‹åˆ°äº†åº”è¯¥å‘ç”ŸVSYNCä¿¡å·çš„æ—¶å€™ï¼Œå°±è°ƒç”¨äº†mHwc.mEventHandler.onVSyncReceived(0, next_vsync)å‡½æ•°æ¥é€šçŸ¥VSYNCçš„åˆ°æ¥ã€‚</p><p>æˆ‘ä»¬æ³¨æ„åˆ°mEventHandlerå®é™…ä¸Šæ˜¯åœ¨HWCåˆ›å»ºæ—¶è¢«ä¼ å…¥çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹HWCåˆ›å»ºæ—¶çš„ä»£ç .</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mHwc = new HWComposer(this,  </span><br><span class="line">        *static_cast&lt;HWComposer::EventHandler *&gt;(this));  </span><br><span class="line"></span><br><span class="line">class SurfaceFlinger : public BnSurfaceComposer,  </span><br><span class="line">                   private IBinder::DeathRecipient,  </span><br><span class="line">                   private HWComposer::EventHandler</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªmEventHandlerå®é™…ä¸Šå°±æ˜¯SurfaceFlingerã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒVSYNCä¿¡å·åˆ°æ¥æ—¶ï¼ŒSurfaceFlingerçš„onVSyncReceivedå‡½æ•°å¤„ç†äº†è¿™ä¸ªæ¶ˆæ¯ã€‚ è¿™é‡Œæˆ‘ä»¬æš‚æ—¶å…ˆä¸å±•å¼€SurfaceFlingerå†…çš„é€»è¾‘å¤„ç†ï¼Œç­‰æˆ‘ä»¬ä¸‹é¢åˆ†æå®Œç¡¬ä»¶å®ç°åï¼Œä¸€å¹¶è¿›è¡Œåˆ†æ</p><p><strong>ç¡¬ä»¶å®ç°</strong> ä¸Šé¢æˆ‘ä»¬è®²äº†è½¯ä»¶å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªVSYNCä¿¡å·å¹¶é€šçŸ¥SurfaceFlinger,é‚£ä¹ˆç¡¬ä»¶åˆæ˜¯å¦‚ä½•å®ç°è¿™ä¸€ç‚¹çš„å‘¢ï¼Ÿ æˆ‘ä»¬å†ä¸€æ¬¡å›åˆ°HWCçš„åˆ›å»ºè¿‡ç¨‹ä¸­æ¥ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mHwc) &#123;  </span><br><span class="line">       ALOGE(<span class="string">"Lee Using %s version %u.%u"</span>, HWC_HARDWARE_COMPOSER,  </span><br><span class="line">             (hwcApiVersion(mHwc) &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>,  </span><br><span class="line">             (hwcApiVersion(mHwc) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);  </span><br><span class="line">       <span class="keyword">if</span> (mHwc-&gt;registerProcs) &#123;  </span><br><span class="line">           mCBContext-&gt;hwc = <span class="keyword">this</span>;  </span><br><span class="line">           mCBContext-&gt;procs.invalidate = &amp;hook_invalidate;  </span><br><span class="line">           mCBContext-&gt;procs.vsync = &amp;hook_vsync;  </span><br><span class="line">           <span class="keyword">if</span> (hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1))  </span><br><span class="line">               mCBContext-&gt;procs.hotplug = &amp;hook_hotplug;  </span><br><span class="line">           <span class="keyword">else</span>  </span><br><span class="line">               mCBContext-&gt;procs.hotplug = <span class="literal">NULL</span>;  </span><br><span class="line">           <span class="built_in">memset</span>(mCBContext-&gt;procs.zero, <span class="number">0</span>, <span class="keyword">sizeof</span>(mCBContext-&gt;procs.zero));  </span><br><span class="line">           mHwc-&gt;registerProcs(mHwc, &amp;mCBContext-&gt;procs);  </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹ä¸‹ä¸Šé¢è¿™æ®µå®ç°ã€‚ å½“HWCæœ‰vsyncä¿¡å·ç”Ÿæˆæ—¶ï¼Œç¡¬ä»¶æ¨¡å—ä¼šé€šè¿‡procs.vsyncæ¥é€šçŸ¥è½¯ä»¶éƒ¨åˆ†ï¼Œå› æ­¤ä¹Ÿå°±æ˜¯è°ƒç”¨äº†hook_vsyncå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> HWComposer::hook_vsync(<span class="keyword">const</span> struct hwc_procs* procs, <span class="keyword">int</span> disp,  </span><br><span class="line">        <span class="keyword">int64_t</span> timestamp) &#123;  </span><br><span class="line">    cb_context* ctx = <span class="keyword">reinterpret_cast</span>&lt;cb_context*&gt;(  </span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">hwc_procs_t</span>*&gt;(procs));  </span><br><span class="line">    ctx-&gt;hwc-&gt;vsync(disp, timestamp);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> HWComposer::vsync(<span class="keyword">int</span> disp, <span class="keyword">int64_t</span> timestamp) &#123;  </span><br><span class="line">    <span class="comment">//åªæœ‰çœŸå®çš„ç¡¬ä»¶è®¾å¤‡æ‰ä¼šäº§ç”ŸVSYNC  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">uint32_t</span>(disp) &lt; HWC_NUM_PHYSICAL_DISPLAY_TYPES) &#123;  </span><br><span class="line">        &#123;  </span><br><span class="line">            mLastHwVSync[disp] = timestamp;  </span><br><span class="line">        &#125;  </span><br><span class="line">        mEventHandler.onVSyncReceived(disp, timestamp);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°æœ€åæ®Šé€”åŒå½’ï¼Œç¡¬ä»¶ä¿¡å·æœ€ç»ˆä¹Ÿé€šè¿‡onVSyncReceivedå‡½æ•°é€šçŸ¥åˆ°äº†SurfaceFlingeräº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸‹SurfaceFlingerçš„å¤„ç†è¿‡ç¨‹ã€‚</p><h3 id="ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†"><a href="#ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†" class="headerlink" title="ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†"></a>ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†</h3><p>å…ˆæ¥ç›´æ¥çœ‹ä¸‹Surfaceflingerçš„onVSyncReceivedå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::onVSyncReceived(<span class="keyword">int32_t</span> type, <span class="keyword">nsecs_t</span> timestamp) &#123;</span><br><span class="line">    <span class="keyword">bool</span> needsHwVsync = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// Scope for the lock</span></span><br><span class="line">        Mutex::Autolock _l(mHWVsyncLock);</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="number">0</span> &amp;&amp; mPrimaryHWVsyncEnabled) &#123;</span><br><span class="line">            needsHwVsync = mPrimaryDispSync.addResyncSample(timestamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needsHwVsync) &#123;</span><br><span class="line">        enableHardwareVsync();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        disableHardwareVsync(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mPrimaryDispSyncæ˜¯ä»€ä¹ˆï¼ŸaddResyncSampleæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ è¦å›ç­”è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè¿˜æ˜¯å¾—å›åˆ°SurfaceFlingerçš„initå‡½æ•°ä¸­æ¥ã€‚</p><h3 id="6-3-1ã€Surfaceflinger-init"><a href="#6-3-1ã€Surfaceflinger-init" class="headerlink" title="6.3.1ã€Surfaceflinger.init()"></a>6.3.1ã€Surfaceflinger.init()</h3><p>å…ˆçœ‹ä¸€ä¸‹æ€»ä½“flowï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/24-Android-Graphics-Vsync-surfaceflinger.init.png" alt="Markdown"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void SurfaceFlinger::init() &#123;</span><br><span class="line">    ALOGI(  &quot;SurfaceFlinger&apos;s main thread ready to run. &quot;</span><br><span class="line">            &quot;Initializing graphics H/W...&quot;);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">        // start the EventThread</span><br><span class="line">        sp&lt;VSyncSource&gt; vsyncSrc = new DispSyncSource(&amp;mPrimaryDispSync,</span><br><span class="line">                vsyncPhaseOffsetNs, true, &quot;app&quot;);</span><br><span class="line">        mEventThread = new EventThread(vsyncSrc, *this);</span><br><span class="line">        sp&lt;VSyncSource&gt; sfVsyncSrc = new DispSyncSource(&amp;mPrimaryDispSync,</span><br><span class="line">                sfVsyncPhaseOffsetNs, true, &quot;sf&quot;);</span><br><span class="line">        mSFEventThread = new EventThread(sfVsyncSrc, *this);</span><br><span class="line">        mEventQueue.setEventThread(mSFEventThread);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    mEventControlThread = new EventControlThread(this);</span><br><span class="line">    mEventControlThread-&gt;run(&quot;EventControl&quot;, PRIORITY_URGENT_DISPLAY);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ä¸ªEventThreadå¯¹è±¡åˆ†åˆ«æ˜¯mEventThreadï¼Œç»™appç”¨ï¼ŒmSFEventThreadï¼Œç»™surfaceflingerè‡ªå·±ç”¨ã€‚ ä¸‹é¢ç»™å‡ºè¿™4ä¸ªThreadå…³ç³»å›¾ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/25-Android-Graphics-SurfaceFlinger.init.DispSyncThread.png.png" alt="Markdown"></p><p>è¿™ä¸¤ä¸ªDispSyncSourceå°±æ˜¯KKå¼•å…¥çš„é‡å¤§å˜åŒ–ã€‚Android 4.4(KitKat)å¼•å…¥äº†VSyncçš„è™šæ‹ŸåŒ–ï¼Œå³æŠŠç¡¬ä»¶çš„VSyncä¿¡å·å…ˆåŒæ­¥åˆ°ä¸€ä¸ªæœ¬åœ°VSyncæ¨¡å‹ä¸­ï¼Œå†ä»ä¸­ä¸€åˆ†ä¸ºäºŒï¼Œå¼•å‡ºä¸¤æ¡VSyncæ—¶é—´ä¸ä¹‹æœ‰å›ºå®šåç§»çš„çº¿ç¨‹ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/26-Android-Graphics-SurfaceFlinger-App-Vsync-offset.png.png" alt="Markdown"></p><p>Googleè¿™æ ·ä¿®æ”¹çš„ç›®çš„åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ =åœ¨å½“å‰ä¸‰é‡ç¼“å†²åŒºçš„æ¶æ„ä¸‹ï¼Œå³å¯¹äºä¸€å¸§å†…å®¹ï¼Œå…ˆç­‰App UIç”»å®Œäº†ï¼ŒSurfaceFlingerå†å‡ºåœºå¯¹å…¶è¿›è¡Œåˆå¹¶æ¸²æŸ“åæ”¾å…¥framebufferï¼Œæœ€åæ•´åˆ°å±å¹•ä¸Šã€‚è€Œç°æœ‰çš„VSyncæ¨¡å‹æ˜¯è®©å¤§å®¶ä¸€èµ·å¼€å§‹å¹²æ´»ã€‚ è¿™ä¸ªæ¶æ„å…¶å®ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºAppå’ŒSurfaceFlingerè¢«åŒæ—¶å”¤é†’ï¼Œå¯¼è‡´ä»–ä»¬äºŒè€…æ€»æ˜¯ä¸€èµ·å·¥ä½œï¼Œå¿…ç„¶å¯¼è‡´VSyncæ¥ä¸´çš„æ—¶åˆ»ï¼Œè¿™äºŒè€…ä¹‹é—´äº§ç”Ÿäº†CPUèµ„æºçš„æŠ¢å ã€‚å› æ­¤ï¼Œè°·æ­Œç»™è¿™ä¸¤ä¸ªå·¥ä½œéƒ½åŠ ä¸Šä¸€ä¸ªå°å°çš„å»¶è¿Ÿï¼Œè®©è¿™ä¸¤ä¸ªå·¥ä½œå¹¶ä¸æ˜¯åŒæ—¶è¢«å”¤é†’ï¼Œè¿™æ ·å¤§å®¶å°±å¯ä»¥é”™å¼€ä½¿ç”¨èµ„æºçš„é«˜å³°æœŸï¼Œæé«˜å·¥ä½œçš„æ•ˆç‡ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/27-Android-graphics-SurfaceFlinger-Vsync-app-sf.png" alt="Markdown"></p><p>è¿™ä¸¤ä¸ªå»¶è¿Ÿï¼Œå…¶å®å°±åˆ†åˆ«å¯¹åº”ä¸Šé¢ä»£ç ä¸­çš„vsyncSrcï¼ˆç»˜åˆ¶å»¶è¿Ÿï¼‰å’ŒsfVsyncSrcï¼ˆåˆæˆå»¶è¿Ÿï¼‰ã€‚ åœ¨åˆ›å»ºäº†ä¸¤ä¸ªDispSyncSourceå˜é‡åï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒä»¬æ¥åˆå§‹åŒ–äº†ä¸¤ä¸ªEventThreadã€‚ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹EventThreadçš„åˆ›å»ºæµç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">EventThread::EventThread(<span class="keyword">const</span> sp&lt;VSyncSource&gt;&amp; src, SurfaceFlinger&amp; flinger)</span><br><span class="line">    : mVSyncSource(src),</span><br><span class="line">      mFlinger(flinger),</span><br><span class="line">      mUseSoftwareVSync(<span class="literal">false</span>),</span><br><span class="line">      mVsyncEnabled(<span class="literal">false</span>),</span><br><span class="line">      mDebugVsyncEnabled(<span class="literal">false</span>),</span><br><span class="line">      mVsyncHintSent(<span class="literal">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int32_t</span> i=<span class="number">0</span> ; i&lt;DisplayDevice::NUM_BUILTIN_DISPLAY_TYPES ; i++) &#123;</span><br><span class="line">        mVSyncEvent[i].header.type = DisplayEventReceiver::DISPLAY_EVENT_VSYNC;</span><br><span class="line">        mVSyncEvent[i].header.id = <span class="number">0</span>;</span><br><span class="line">        mVSyncEvent[i].header.timestamp = <span class="number">0</span>;</span><br><span class="line">        mVSyncEvent[i].vsync.count =  <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigevent</span> <span class="title">se</span>;</span></span><br><span class="line">    se.sigev_notify = SIGEV_THREAD;</span><br><span class="line">    se.sigev_value.sival_ptr = <span class="keyword">this</span>;</span><br><span class="line">    se.sigev_notify_function = vsyncOffCallback;</span><br><span class="line">    se.sigev_notify_attributes = <span class="literal">NULL</span>;</span><br><span class="line">    timer_create(CLOCK_MONOTONIC, &amp;se, &amp;mTimerId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> EventThread::onFirstRef() &#123;</span><br><span class="line">    run(<span class="string">"EventThread"</span>, PRIORITY_URGENT_DISPLAY + PRIORITY_MORE_FAVORABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EventThreadçš„æ„é€ å‡½æ•°å¾ˆç®€å•ã€‚é‡ç‚¹æ˜¯å®ƒçš„onFirstRefå‡½æ•°å¯åŠ¨äº†ä¸€ä¸ªEventThreadçº¿ç¨‹ï¼Œäºæ˜¯ä¸‹é¢çš„ä»£ç æ‰æ˜¯é‡ç‚¹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> EventThread::threadLoop() &#123;</span><br><span class="line">    DisplayEventReceiver::Event event;</span><br><span class="line">    Vector&lt; sp&lt;EventThread::Connection&gt; &gt; signalConnections;</span><br><span class="line">    signalConnections = waitForEvent(&amp;event);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dispatch events to listeners...</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> count = signalConnections.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Connection&gt;&amp; conn(signalConnections[i]);</span><br><span class="line">        <span class="comment">// now see if we still need to report this event</span></span><br><span class="line">        <span class="keyword">status_t</span> err = conn-&gt;postEvent(event);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‡½æ•°æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œå…¶ä¸­è°ƒç”¨äº†ä¸€ä¸ªwaitForEventçš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ç›¸å½“ä¹‹é•¿ï¼Œä¸ºäº†é˜²æ­¢ä»£ç å±•å¼€å¤ªå¤šï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶ä¸å†è¯¦ç»†åˆ†æè¿™ä¸ªå‡½æ•°ã€‚æˆ‘ä»¬ç›®å‰åªéœ€è¦çŸ¥é“è¿™ä¸ªå‡½æ•°çš„æœ€é‡è¦çš„ä½œç”¨æ˜¯ç­‰å¾…Eventçš„åˆ°æ¥ï¼Œå¹¶ä¸”æŸ¥æ‰¾å¯¹eventæ„Ÿå…´è¶£çš„ç›‘å¬è€…ï¼Œè€Œåœ¨æ²¡æœ‰eventåˆ°æ¥æ—¶ï¼Œçº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…eventçš„å”¤é†’ï¼ˆæˆ‘ä»¬å°†ä¸‹ä¸€ç¯‡VSYNCçš„æ¥æ”¶å’Œå¤„ç†ä¸­å±•å¼€åˆ†æè¿™ä¸ªå‡½æ•°ï¼‰ã€‚ è¿™æ ·ï¼ŒEventThreadçº¿ç¨‹å°±è¿è¡Œèµ·æ¥ï¼Œå¤„åœ¨ç­‰å¾…è¢«eventå”¤é†’çš„çŠ¶æ€ä¸‹ã€‚ <strong>MessageQueueå’ŒEventThreadå»ºç«‹è¿æ¥</strong> ç®€å•è¯´æ˜å®ŒEventThreadä¹‹åï¼Œæˆ‘ä»¬å†æ¬¡å›åˆ°SurfaceFlingerçš„initè¿‡ç¨‹ä¸­æ¥ã€‚å›åˆ°init()å‡½æ•°ä»£ç ä¸­æ¥ï¼š å°†SurfaceFlingerçš„MessageQueueçœŸæ­£å’Œæˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„EventThreadå»ºç«‹èµ·äº†è¿æ¥ï¼Œè¿™æ ·SurfaceFlingeræ‰èƒ½çœŸæ­£æ¥æ”¶åˆ°æ¥è‡ªHWCçš„VSYNCä¿¡å·ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™æ®µä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MessageQueue::setEventThread(<span class="keyword">const</span> sp&lt;EventThread&gt;&amp; eventThread)  </span><br><span class="line">&#123;  </span><br><span class="line">    mEventThread = eventThread;  </span><br><span class="line">    mEvents = eventThread-&gt;createEventConnection();  </span><br><span class="line">    mEventTube = mEvents-&gt;getDataChannel();  </span><br><span class="line">    mLooper-&gt;addFd(mEventTube-&gt;getFd(), <span class="number">0</span>, ALOOPER_EVENT_INPUT,  </span><br><span class="line">            MessageQueue::cb_eventReceiver, <span class="keyword">this</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»£ç é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªåˆ°EventThreadçš„è¿æ¥ï¼Œå¾—åˆ°äº†å‘é€VSYNCäº‹ä»¶é€šçŸ¥çš„BitTubeï¼Œç„¶åç›‘æ§è¿™ä¸ªBitTubeä¸­çš„å¥—æ¥å­—ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ”¶åˆ°é€šçŸ¥åçš„å›è°ƒå‡½æ•°ï¼ŒMessageQueue::cb_eventReceiverã€‚è¿™æ ·ä¸€æ—¦VSyncä¿¡å·ä¼ æ¥ï¼Œå‡½æ•°cb_eventReceiverå°†è¢«è°ƒç”¨ã€‚ <strong>å‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€”-createEventConnection</strong> åœ¨SurfaceFlingerçš„initå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†mEventQueue.setEventThread(mSFEventThread)å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨å‰é¢ä¸€ç« ä¸­å·²ç»æåˆ°è¿‡ï¼Œè¿™ä¸ªå‡½æ•°å°†SurfaceFlingerçš„MessageQueueçœŸæ­£å’Œæˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„EventThreadå»ºç«‹èµ·äº†è¿æ¥ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™æ®µä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;EventThread::Connection&gt; EventThread::createEventConnection() <span class="keyword">const</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Connection(<span class="keyword">const_cast</span>&lt;EventThread*&gt;(<span class="keyword">this</span>));  </span><br><span class="line">&#125;  </span><br><span class="line">EventThread::Connection::Connection(  </span><br><span class="line">        <span class="keyword">const</span> sp&lt;EventThread&gt;&amp; eventThread)  </span><br><span class="line">    : count(<span class="number">-1</span>), mEventThread(eventThread), mChannel(<span class="keyword">new</span> BitTube())  </span><br><span class="line">&#123;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">void</span> EventThread::Connection::onFirstRef() &#123;  </span><br><span class="line">    mEventThread-&gt;registerDisplayEventConnection(<span class="keyword">this</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">status_t</span> EventThread::registerDisplayEventConnection(  </span><br><span class="line">        <span class="keyword">const</span> sp&lt;EventThread::Connection&gt;&amp; connection) &#123;  </span><br><span class="line">    mDisplayEventConnections.add(connection);  </span><br><span class="line">    mCondition.broadcast();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼šå¯¼è‡´ä¸€ä¸ªConnectionç±»çš„åˆ›å»ºï¼Œè€Œè¿™ä¸ªconnectionç±»ä¼šè¢«ä¿å­˜åœ¨EventThreadä¸‹çš„ä¸€ä¸ªå®¹å™¨å†…ã€‚ é€šè¿‡createEventConnectionè¿™æ ·ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å…¶å®å°±æ³¨å†Œäº†ä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…ï¼Œå¾—åˆ°äº†å‘é€VSYNCäº‹ä»¶é€šçŸ¥çš„BitTubeï¼Œç„¶åç›‘æ§è¿™ä¸ªBitTubeä¸­çš„å¥—æ¥å­—ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ”¶åˆ°é€šçŸ¥åçš„å›è°ƒå‡½æ•°ï¼ŒMessageQueue::cb_eventReceiverã€‚è¿™æ ·ä¸€æ—¦VSyncä¿¡å·ä¼ æ¥ï¼Œå‡½æ•°cb_eventReceiverå°†è¢«è°ƒç”¨ã€‚</p><h3 id="6-3-2ã€VSyncä¿¡å·çš„å¤„ç†"><a href="#6-3-2ã€VSyncä¿¡å·çš„å¤„ç†" class="headerlink" title="6.3.2ã€VSyncä¿¡å·çš„å¤„ç†"></a>6.3.2ã€VSyncä¿¡å·çš„å¤„ç†</h3><p>æˆ‘ä»¬åœ¨å‰é¢ä¸€ç« ä¹Ÿæåˆ°äº†æ— è®ºæ˜¯è½¯ä»¶æ–¹å¼è¿˜æ˜¯ç¡¬ä»¶æ–¹å¼ï¼ŒSurfaceFlingeræ”¶åˆ°VSyncä¿¡å·åï¼Œå¤„ç†å‡½æ•°éƒ½æ˜¯onVSyncReceivedå‡½æ•°ï¼š</p><p><strong>VSyncæ¶ˆæ¯å¤„ç†â€”-addResyncSample</strong><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/28-Android-Graphics-SF-Vsync-addResyncSample.png.png" alt="Markdown"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> DispSync::addResyncSample(<span class="keyword">nsecs_t</span> timestamp) &#123;  </span><br><span class="line">    <span class="keyword">size_t</span> idx = (mFirstResyncSample + mNumResyncSamples) % MAX_RESYNC_SAMPLES;  </span><br><span class="line">    mResyncSamples[idx] = timestamp;  </span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    updateModelLocked();  </span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç²—ç•¥æµè§ˆä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°å‰åŠéƒ¨åˆ†å…¶å®åœ¨åšä¸€äº›ç®€å•çš„è®¡æ•°ç»Ÿè®¡ï¼Œé‡ç‚¹å®ç°æ˜¾ç„¶æ˜¯updateModelLockedå‡½æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">void DispSync::updateModelLocked() &#123;  </span><br><span class="line">    if (mNumResyncSamples &gt;= MIN_RESYNC_SAMPLES_FOR_UPDATE) &#123;  </span><br><span class="line">        nsecs_t durationSum = 0;  </span><br><span class="line">        for (size_t i = 1; i &lt; mNumResyncSamples; i++) &#123;  </span><br><span class="line">            size_t idx = (mFirstResyncSample + i) % MAX_RESYNC_SAMPLES;  </span><br><span class="line">            size_t prev = (idx + MAX_RESYNC_SAMPLES - 1) % MAX_RESYNC_SAMPLES;  </span><br><span class="line">            durationSum += mResyncSamples[idx] - mResyncSamples[prev];  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        mPeriod = durationSum / (mNumResyncSamples - 1);  </span><br><span class="line"></span><br><span class="line">        double sampleAvgX = 0;  </span><br><span class="line">        double sampleAvgY = 0;  </span><br><span class="line">        double scale = 2.0 * M_PI / double(mPeriod);  </span><br><span class="line">        for (size_t i = 0; i &lt; mNumResyncSamples; i++) &#123;  </span><br><span class="line">            size_t idx = (mFirstResyncSample + i) % MAX_RESYNC_SAMPLES;  </span><br><span class="line">            nsecs_t sample = mResyncSamples[idx];  </span><br><span class="line">            double samplePhase = double(sample % mPeriod) * scale;  </span><br><span class="line">            sampleAvgX += cos(samplePhase);  </span><br><span class="line">            sampleAvgY += sin(samplePhase);  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        sampleAvgX /= double(mNumResyncSamples);  </span><br><span class="line">        sampleAvgY /= double(mNumResyncSamples);  </span><br><span class="line"></span><br><span class="line">        mPhase = nsecs_t(atan2(sampleAvgY, sampleAvgX) / scale);  </span><br><span class="line">        ......</span><br><span class="line">        mThread-&gt;updateModel(mPeriod, mPhase);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸å¾—ä¸è¯´ï¼Œå‰é¢å¤§æ®µçš„æ•°å­¦è®¡ç®—è®©äººæœ‰äº›å›°æƒ‘ï¼Œæˆ‘ä»¬æš‚ä¸”è·³è¿‡ï¼Œå…ˆåˆ†æä¸‹ä¸»çº¿æµç¨‹ï¼Œä¹Ÿå°±æ˜¯mThread-&gt;updateModel(mPeriod, mPhase)è¿™ä¸ªè°ƒç”¨ï¼š</p><p><strong>DispSyncThread.updateModelçš„ç”¨é€”</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateModel</span><span class="params">(<span class="keyword">nsecs_t</span> period, <span class="keyword">nsecs_t</span> phase)</span> </span>&#123;  </span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;  </span><br><span class="line">    mPeriod = period;  </span><br><span class="line">    mPhase = phase;  </span><br><span class="line">    mCond.signal();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>updateModelæ˜¯DispSyncThreadç±»çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ¬èº«ä»£ç å¾ˆçŸ­ï¼Œå…¶å®å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯mCond.signalå‘é€ä¸€ä¸ªä¿¡å·ç»™ç­‰å¾…ä¸­çš„çº¿ç¨‹ã€‚é‚£ä¹ˆç©¶ç«Ÿæ˜¯è°åœ¨ç­‰å¾…è¿™ä¸ªæ¡ä»¶å‘¢ï¼Ÿ å…¶å®ç­‰å¾…è¿™ä¸ªæ¡ä»¶çš„æ­£æ˜¯DispSyncThreadçš„å¾ªç¯å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">threadLoop</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">      <span class="keyword">status_t</span> err;  </span><br><span class="line">      <span class="keyword">nsecs_t</span> now = systemTime(SYSTEM_TIME_MONOTONIC);  </span><br><span class="line">      <span class="keyword">nsecs_t</span> nextEventTime = <span class="number">0</span>;  </span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">          Vector&lt;CallbackInvocation&gt; callbackInvocations;  </span><br><span class="line">          <span class="keyword">nsecs_t</span> targetTime = <span class="number">0</span>;  </span><br><span class="line">          &#123; <span class="comment">// Scope for lock  </span></span><br><span class="line">              Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;  </span><br><span class="line">              ......</span><br><span class="line">              <span class="keyword">if</span> (mPeriod == <span class="number">0</span>) &#123;  </span><br><span class="line">                  err = mCond.wait(mMutex);  </span><br><span class="line">                  ......</span><br><span class="line">              &#125;  </span><br><span class="line">              nextEventTime = computeNextEventTimeLocked(now);  </span><br><span class="line">              targetTime = nextEventTime;  </span><br><span class="line">              ......</span><br><span class="line">              &#125;  </span><br><span class="line">              now = systemTime(SYSTEM_TIME_MONOTONIC);  </span><br><span class="line">              ......</span><br><span class="line">              callbackInvocations = gatherCallbackInvocationsLocked(now);  </span><br><span class="line">          &#125;  </span><br><span class="line">          <span class="keyword">if</span> (callbackInvocations.size() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">              fireCallbackInvocations(callbackInvocations);  </span><br><span class="line">          &#125;  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¤§é‡çš„æ—¶é—´ç›¸å…³çš„è®¡ç®—å’ŒçŠ¶æ€çš„è½¬å˜æˆ‘ä»¬ä¸å†æ·±å…¥ç ”ç©¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªçº¿ç¨‹è¢«é€šçŸ¥å”¤é†’ä¹‹ååšçš„ä¸¤ä¸ªä¸»è¦çš„å‡½æ•°çš„å¤„ç†ï¼ŒgatherCallbackInvocationsLocked()å’ŒfireCallbackInvocations()ã€‚</p><p>gatherCallbackInvocationsLocked()çš„ä»£ç å…¶å®å¾ˆç®€å•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Vector&lt;CallbackInvocation&gt; gatherCallbackInvocationsLocked(<span class="keyword">nsecs_t</span> now) &#123;  </span><br><span class="line">    Vector&lt;CallbackInvocation&gt; callbackInvocations;  </span><br><span class="line">    <span class="keyword">nsecs_t</span> ref = now - mPeriod;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mEventListeners.size(); i++) &#123;  </span><br><span class="line">        <span class="keyword">nsecs_t</span> t = computeListenerNextEventTimeLocked(mEventListeners[i],  </span><br><span class="line">                ref);  </span><br><span class="line">        <span class="keyword">if</span> (t &lt; now) &#123;  </span><br><span class="line">            CallbackInvocation ci;  </span><br><span class="line">            ci.mCallback = mEventListeners[i].mCallback;  </span><br><span class="line">            ci.mEventTime = t;  </span><br><span class="line">            callbackInvocations.push(ci);  </span><br><span class="line">            mEventListeners.editItemAt(i).mLastEventTime = t;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> callbackInvocations;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ä»mEventListenerså–å‡ºä¹‹å‰æ³¨å†Œçš„äº‹ä»¶ç›‘å¬è€…ï¼Œæ”¾å…¥callbackInvocationsä¸­ï¼Œç­‰å¾…åé¢çš„è°ƒç”¨ã€‚è‡³äºç›‘å¬è€…ä»ä½•å¤„è€Œæ¥ï¼Ÿåœ¨waitforeventæ—¶é€šè¿‡enableVSyncLockedæ³¨å†Œçš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹fireCallbackInvocations()å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fireCallbackInvocations</span><span class="params">(<span class="keyword">const</span> Vector&lt;CallbackInvocation&gt;&amp; callbacks)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; callbacks.size(); i++) &#123;  </span><br><span class="line">        callbacks[i].mCallback-&gt;onDispSyncEvent(callbacks[i].mEventTime);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;`</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç›®å‰åªåˆ†æä¸»çº¿çš„èµ°å‘,æ¥ä¸‹æ¥è°ƒç”¨äº†DispSyncSourceçš„onDispSyncEventåœ¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onDispSyncEvent</span><span class="params">(<span class="keyword">nsecs_t</span> when)</span> </span>&#123;  </span><br><span class="line">        sp&lt;VSyncSource::Callback&gt; callback;  </span><br><span class="line">        &#123;  </span><br><span class="line">            callback = mCallback;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">NULL</span>) &#123;  </span><br><span class="line">            callback-&gt;onVSyncEvent(when);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="keyword">void</span> EventThread::onVSyncEvent(<span class="keyword">nsecs_t</span> timestamp) &#123;  </span><br><span class="line">    Mutex::Autolock _l(mLock);  </span><br><span class="line">    mVSyncEvent[<span class="number">0</span>].header.type = DisplayEventReceiver::DISPLAY_EVENT_VSYNC;  </span><br><span class="line">    mVSyncEvent[<span class="number">0</span>].header.id = <span class="number">0</span>;  </span><br><span class="line">    mVSyncEvent[<span class="number">0</span>].header.timestamp = timestamp;  </span><br><span class="line">    mVSyncEvent[<span class="number">0</span>].vsync.count++;  </span><br><span class="line">    mCondition.broadcast();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°è¿™é‡ŒmCondition.broadcaså‘å‡ºäº†å‘½ä»¤ï¼Œé‚£ä¹ˆEventThreadä¸­waitforEventçš„ç­‰å¾…å°±ä¼šè¢«å”¤é†’ã€‚è€Œä¸€æ—¦å”¤é†’ï¼Œæˆ‘ä»¬å°±å›åˆ°äº†EventThreadçš„loopä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bool EventThread::threadLoop() &#123;  </span><br><span class="line">    DisplayEventReceiver::Event event;  </span><br><span class="line">    Vector&lt; sp&lt;EventThread::Connection&gt; &gt; signalConnections;  </span><br><span class="line">    signalConnections = waitForEvent(&amp;event);  </span><br><span class="line"></span><br><span class="line">    // dispatch events to listeners...  </span><br><span class="line">    const size_t count = signalConnections.size();  </span><br><span class="line">    for (size_t i=0 ; i&lt;count ; i++) &#123;  </span><br><span class="line">        const sp&lt;Connection&gt;&amp; conn(signalConnections[i]);  </span><br><span class="line">        // now see if we still need to report this event  </span><br><span class="line">        status_t err = conn-&gt;postEvent(event);  </span><br><span class="line">        ......</span><br><span class="line">    &#125;  </span><br><span class="line">    return true;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦å°±æ˜¯é€šè¿‡conn-&gt;postEventæ¥åˆ†å‘äº‹ä»¶ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> EventThread::Connection::postEvent(  </span><br><span class="line">        <span class="keyword">const</span> DisplayEventReceiver::Event&amp; event) &#123;  </span><br><span class="line">    <span class="keyword">ssize_t</span> size = DisplayEventReceiver::sendEvents(mChannel, &amp;event, <span class="number">1</span>);  </span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? <span class="keyword">status_t</span>(size) : <span class="keyword">status_t</span>(NO_ERROR);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">ssize_t</span> DisplayEventReceiver::sendEvents(<span class="keyword">const</span> sp&lt;BitTube&gt;&amp; dataChannel,  </span><br><span class="line">        Event <span class="keyword">const</span>* events, <span class="keyword">size_t</span> count)  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">return</span> BitTube::sendObjects(dataChannel, events, count);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/29-Android-Graphics-App-SurfaceFlinger-Vsync-postEvent.png.png" alt="Markdown"></p><p>å…¶å®çœ‹åˆ°è¿™é‡Œçš„BitTubeæˆ‘ä»¬å°±æ˜ç™½äº†ï¼Œåœ¨æœ¬æ–‡å¼€å§‹æ—¶å€™æˆ‘ä»¬æåˆ°ï¼š</p><p>é€šè¿‡createEventConnectionè¿™æ ·ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å…¶å®å°±æ³¨å†Œäº†ä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…ï¼Œå¾—åˆ°äº†å‘é€VSYNCäº‹ä»¶é€šçŸ¥çš„BitTubeï¼Œç„¶åç›‘æ§è¿™ä¸ªBitTubeä¸­çš„å¥—æ¥å­—ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ”¶åˆ°é€šçŸ¥åçš„å›è°ƒå‡½æ•°ï¼ŒMessageQueue::cb_eventReceiverã€‚è¿™æ ·ä¸€æ—¦VSyncä¿¡å·ä¼ æ¥ï¼Œå‡½æ•°cb_eventReceiverå°†è¢«è°ƒç”¨ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¯ä»¥æ¥çœ‹çœ‹MessageQueue::cb_eventReceiverå‡½æ•°äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> MessageQueue::cb_eventReceiver(<span class="keyword">int</span> fd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data) &#123;  </span><br><span class="line">    MessageQueue* <span class="built_in">queue</span> = <span class="keyword">reinterpret_cast</span>&lt;MessageQueue *&gt;(data);  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">queue</span>-&gt;eventReceiver(fd, events);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> MessageQueue::eventReceiver(<span class="keyword">int</span> fd, <span class="keyword">int</span> events) &#123;  </span><br><span class="line">    <span class="keyword">ssize_t</span> n;  </span><br><span class="line">    DisplayEventReceiver::Event buffer[<span class="number">8</span>];  </span><br><span class="line">    <span class="keyword">while</span> ((n = DisplayEventReceiver::getEvents(mEventTube, buffer, <span class="number">8</span>)) &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ; i&lt;n ; i++) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (buffer[i].header.type == DisplayEventReceiver::DISPLAY_EVENT_VSYNC) &#123;  </span><br><span class="line">                mHandler-&gt;dispatchInvalidate();  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°æ”¶åˆ°æ¶ˆæ¯ä¹‹åMessageQueueå¯¹æ¶ˆæ¯è¿›è¡Œäº†åˆ†å‘ï¼Œæˆ‘ä»¬ç›®å‰èµ°çš„æ˜¯dispatchInvalidate()ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MessageQueue::Handler::dispatchInvalidate() &#123;  </span><br><span class="line">    <span class="keyword">if</span> ((android_atomic_or(eventMaskInvalidate, &amp;mEventMask) &amp; eventMaskInvalidate) == <span class="number">0</span>) &#123;  </span><br><span class="line">        mQueue.mLooper-&gt;sendMessage(<span class="keyword">this</span>, Message(MessageQueue::INVALIDATE));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> MessageQueue::Handler::handleMessage(<span class="keyword">const</span> Message&amp; message) &#123;  </span><br><span class="line">    <span class="keyword">switch</span> (message.what) &#123;  </span><br><span class="line">        <span class="keyword">case</span> INVALIDATE:  </span><br><span class="line">            android_atomic_and(~eventMaskInvalidate, &amp;mEventMask);  </span><br><span class="line">            mQueue.mFlinger-&gt;onMessageReceived(message.what);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> REFRESH:  </span><br><span class="line">            android_atomic_and(~eventMaskRefresh, &amp;mEventMask);  </span><br><span class="line">            mQueue.mFlinger-&gt;onMessageReceived(message.what);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> TRANSACTION:  </span><br><span class="line">            android_atomic_and(~eventMaskTransaction, &amp;mEventMask);  </span><br><span class="line">            mQueue.mFlinger-&gt;onMessageReceived(message.what);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> SurfaceFlinger::onMessageReceived(<span class="keyword">int32_t</span> what) &#123;  </span><br><span class="line">    ATRACE_CALL();  </span><br><span class="line">    <span class="keyword">switch</span> (what) &#123;  </span><br><span class="line">    <span class="keyword">case</span> MessageQueue::TRANSACTION:  </span><br><span class="line">        handleMessageTransaction();  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">case</span> MessageQueue::INVALIDATE:  </span><br><span class="line">        handleMessageTransaction();  </span><br><span class="line">        handleMessageInvalidate();  </span><br><span class="line">        signalRefresh();  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">case</span> MessageQueue::REFRESH:  </span><br><span class="line">        handleMessageRefresh();  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°äº†è¿™é‡Œï¼Œå°±è¿›å…¥äº†SurfaceFlingerçš„å¤„ç†æµç¨‹ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯¹äºINVALIDATEçš„æ¶ˆæ¯ï¼Œå®é™…ä¸Šç³»ç»Ÿåœ¨å¤„ç†è¿‡ç¨‹ä¸­å®é™…è¿˜æ˜¯ä¼šå‘é€ä¸€ä¸ªRefreshæ¶ˆæ¯ã€‚</p><h3 id="6-4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection"><a href="#6-4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection" class="headerlink" title="6.4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection()"></a>6.4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection()</h3><p>åœ¨ViewRootImplçš„æ„é€ å‡½æ•°ä¸­ä¼šå®ä¾‹åŒ–Choreographerå¯¹è±¡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">                . . . . .</span><br><span class="line">        mChoreographer = Choreographer.getInstance();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨mChoreographer çš„æ„é€ å‡½æ•°ä¸­å®ä¾‹åŒ–FrameDisplayEventReceiverå¯¹è±¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private Choreographer(Looper looper) &#123;</span><br><span class="line">               . . . . . .</span><br><span class="line">               mDisplayEventReceiver = USE_VSYNC ? new FrameDisplayEventReceiver(looper) : null;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨FrameDisplayEventReceiverçš„çˆ¶ç±»æ„é€ å‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°ï¼Œandroid_view_DisplayEventReceiver.cppä¸­çš„nativeInitæ–¹æ³•,åœ¨nativeInitæ–¹æ³•ä¸­æœ‰å¦‚ä¸‹è¿‡ç¨‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeInit</span><span class="params">(JNIEnv* env, jclass clazz, jobject receiverWeak,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobject messageQueueObj)</span> </span>&#123;</span><br><span class="line">        . . . . . .</span><br><span class="line">    sp&lt;NativeDisplayEventReceiver&gt; receiver = <span class="keyword">new</span> NativeDisplayEventReceiver(env,</span><br><span class="line">            receiverWeak, messageQueue);</span><br><span class="line">    <span class="keyword">status_t</span> status = receiver-&gt;initialize();</span><br><span class="line">    . . . . . .</span><br></pre></td></tr></table></figure><p>åˆ›å»ºNativeDisplayEventReceiverç±» ç±»å‹æŒ‡é’ˆ åœ¨NativeDisplayEventReceiverçš„æ„é€ å‡½æ•°ä¸­ä¼šè°ƒç”¨DisplayEventReceiverç±»çš„æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–æˆå‘˜mReceiverï¼›</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DisplayEventReceiver::DisplayEventReceiver() &#123;</span><br><span class="line">    sp&lt;ISurfaceComposer&gt; sf(ComposerService::getComposerService());</span><br><span class="line">    <span class="keyword">if</span> (sf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mEventConnection = sf-&gt;createDisplayEventConnection();</span><br><span class="line">        <span class="keyword">if</span> (mEventConnection != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mDataChannel = mEventConnection-&gt;getDataChannel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­è·å–SurfaceflingeræœåŠ¡çš„ä»£ç†å¯¹è±¡ï¼Œç„¶åé€šè¿‡Binder IPCåˆ›å»ºBpDisplayEventConnectionå¯¹è±¡ è¯¥å‡½æ•°ç»ç”±BnSurfaceComposer.onTransactå‡½æ•°è¾—è½¬è°ƒç”¨åˆ°SurfaceFlinger.createDisplayEventConnectionå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IDisplayEventConnection&gt; SurfaceFlinger::createDisplayEventConnection() &#123;</span><br><span class="line">    <span class="keyword">return</span> mEventThread-&gt;createEventConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡ºç°äº†ç†Ÿæ‚‰çš„é¢å­”mEventThreadï¼Œè¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªEventThreadå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åœ¨SurfaceFlinger.initå‡½æ•°é‡Œé¢åˆ›å»ºï¼Œä½†æ˜¯åˆ›å»ºè¿è¡Œä»¥åï¼Œè²Œä¼¼è¿˜æ²¡æœ‰è¿›è¡Œä»»ä½•çš„åŠ¨ä½œï¼Œè¿™é‡Œè°ƒç”¨createEventConnectionå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;EventThread::Connection&gt; EventThread::createEventConnection() <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Connection(<span class="keyword">const_cast</span>&lt;EventThread*&gt;(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åmEventConnection-&gt;getDataChannel()æ–¹æ³•å†æ¬¡é€šè¿‡Binder IPCåˆ›å»º BitTubeå¯¹è±¡mDataChannel ï¼Œåœ¨Binder IPCåˆ›å»ºmDataChannel è¿‡ç¨‹ä¸­ä¼šä»æœåŠ¡ç«¯EventThread::Connection::Connectionä¸­ï¼ˆåœ¨EventThreadç±»ä¸­å®šä¹‰ï¼‰æ¥æ”¶ä¸€ä¸ªsocketpairåˆ›å»ºçš„FIFOæ–‡ä»¶æè¿°ç¬¦ï¼›</p><p>EventThread::Connection::Connectionåˆ›å»ºæè¿°ç¬¦çš„ä»£ç ï¼š Connectionæ„é€ å‡½æ•°è°ƒç”¨BitTubeçš„æ— å‚æ„é€ å‡½æ•°ï¼Œåœ¨BitTubeçš„æ„é€ å‡½æ•°ä¸­è°ƒç”¨initå‡½æ•°ï¼›</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> BitTube::init(<span class="keyword">size_t</span> rcvbuf, <span class="keyword">size_t</span> sndbuf) &#123;</span><br><span class="line">    <span class="keyword">int</span> sockets[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_SEQPACKET, <span class="number">0</span>, sockets) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> size = DEFAULT_SOCKET_BUFFER_SIZE;</span><br><span class="line">        setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_RCVBUF, &amp;rcvbuf, <span class="keyword">sizeof</span>(rcvbuf));</span><br><span class="line">        setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUF, &amp;sndbuf, <span class="keyword">sizeof</span>(sndbuf));</span><br><span class="line">        <span class="comment">// sine we don't use the "return channel", we keep it small...</span></span><br><span class="line">        setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_SNDBUF, &amp;size, <span class="keyword">sizeof</span>(size));</span><br><span class="line">        setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_RCVBUF, &amp;size, <span class="keyword">sizeof</span>(size));</span><br><span class="line">        fcntl(sockets[<span class="number">0</span>], F_SETFL, O_NONBLOCK);</span><br><span class="line">        fcntl(sockets[<span class="number">1</span>], F_SETFL, O_NONBLOCK);</span><br><span class="line">        mReceiveFd = sockets[<span class="number">0</span>];</span><br><span class="line">        mSendFd = sockets[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mReceiveFd = -errno;</span><br><span class="line">        ALOGE(<span class="string">"BitTube: pipe creation failed (%s)"</span>, strerror(-mReceiveFd));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨åˆ°NativeDisplayEventReceiverç±»çš„çˆ¶ç±»DisplayEventDispatcherä¸­çš„initialize()æ–¹æ³•ï¼Œ å°†BpDisplayEventConnectionå¯¹è±¡è·å–åˆ°çš„mDataChannel ï¼ˆBitTubeç±»å‹ï¼‰ä¸­çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°UIä¸»çº¿ç¨‹Looperçš„epollä¸­ï¼Œ å½“æ–‡ä»¶æè¿°ç¬¦ä¸­è¢«å†™å…¥æ•°æ®æ—¶ï¼Œè¯¥epoll_waitä¼šè¢«å”¤é†’ï¼› ç›´æ¥çœ‹ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> NativeDisplayEventReceiver::initialize() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> result = mReceiver.initCheck();</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        ALOGW(<span class="string">"Failed to initialize display event receiver, status=%d"</span>, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> rc = mMessageQueue-&gt;getLooper()-&gt;addFd(mReceiver.getFd(), <span class="number">0</span>, Looper::EVENT_INPUT, <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä¸»è¦ä»£ç æ˜¯mMessageQueue-&gt;getLooper()-&gt;addFd()è¿™ä¸€è¡Œï¼Œå…¶ä¸­çš„å‚æ•°mReceiver.getFd()è¿”å›çš„æ˜¯åœ¨åˆ›å»ºNativeDisplayEventReceiveræ—¶ä»SurfaceFlingeræœåŠ¡ç«¯æ¥æ”¶å›æ¥çš„socketæ¥æ”¶ç«¯æè¿°ç¬¦ï¼Œå‰é¢åˆ†æåˆ° mMessageQueueæ˜¯ä¸å½“å‰åº”ç”¨çº¿ç¨‹å…³è”çš„javaå±‚çš„MessageQueueå¯¹åº”çš„nativeå±‚çš„MessageQueueå¯¹è±¡ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹Looper.addFdè¿™ä¸ªå‡½æ•°ï¼Œä¸Šé¢è°ƒç”¨æ—¶ä¼ è¿›æ¥çš„thisæŒ‡é’ˆå¯¹åº”çš„æ˜¯ä¸€ä¸ªNativeDisplayEventReceiverå¯¹è±¡ï¼Œè¯¥ç±»ç»§æ‰¿äº†LooperCallbackï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Looper::addFd(<span class="keyword">int</span> fd, <span class="keyword">int</span> ident, <span class="keyword">int</span> events, Looper_callbackFunc callback, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">return</span> addFd(fd, ident, events, callback ? <span class="keyword">new</span> SimpleLooperCallback(callback) : <span class="literal">NULL</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> Looper::addFd(<span class="keyword">int</span> fd, <span class="keyword">int</span> ident, <span class="keyword">int</span> events, <span class="keyword">const</span> sp&lt;LooperCallback&gt;&amp; callback, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">int</span> epollEvents = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; EVENT_INPUT) epollEvents |= EPOLLIN;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; EVENT_OUTPUT) epollEvents |= EPOLLOUT;</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">        Request request;</span><br><span class="line">        request.fd = fd;</span><br><span class="line">        request.ident = ident;</span><br><span class="line">        request.callback = callback;</span><br><span class="line">        request.data = data;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">eventItem</span>;</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp; eventItem, <span class="number">0</span>, <span class="keyword">sizeof</span>(epoll_event)); <span class="comment">// zero out unused members of data field union</span></span><br><span class="line">        eventItem.events = epollEvents;</span><br><span class="line">        eventItem.data.fd = fd;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">ssize_t</span> requestIndex = mRequests.indexOfKey(fd);</span><br><span class="line">        <span class="keyword">if</span> (requestIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp; eventItem);</span><br><span class="line">            <span class="keyword">if</span> (epollResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            mRequests.add(fd, request);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_MOD, fd, &amp; eventItem);</span><br><span class="line">            <span class="keyword">if</span> (epollResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mRequests.replaceValueAt(requestIndex, request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå°†ä¸Šé¢ä¼ è¿›æ¥çš„NativeDisplayEventReceiverå¯¹è±¡å°è£…æˆä¸€ä¸ªSimpleLooperCallbackå¯¹è±¡ï¼Œè°ƒç”¨ä¸‹é¢çš„addFdå‡½æ•°çš„æ—¶å€™ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ªstruct epoll_eventç»“æ„ä½“å¯¹è±¡ï¼Œå°†å¯¹åº”çš„å†…å­˜å…¨éƒ¨ç”¨æ¸…0ï¼Œå¹¶ä½œå¯¹åº”çš„åˆå§‹åŒ–ï¼› ï¼ˆ2ï¼‰æŸ¥è¯¢é€šè¿‡addFdæ–¹æ³•å·²ç»æ·»åŠ åˆ°epollä¸­ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼› ï¼ˆ3ï¼‰æŸ¥è¯¢ä¸åˆ°çš„è¯ï¼Œåˆ™è°ƒç”¨epoll_ctlæ–¹æ³•è®¾ç½®EPOLL_CTL_ADDå±æ€§å°†å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°epollç›‘å¬çš„æè¿°ç¬¦ä¸­ï¼› ï¼ˆ4ï¼‰æ ¹æ®å‰é¢addFdä¼ å…¥çš„å‚æ•°EVENT_INPUTï¼Œè¯´æ˜å½“å‰åº”ç”¨çº¿ç¨‹çš„nativeå±‚çš„Looperå¯¹è±¡ä¸­çš„epollæœºåˆ¶å·²ç»å¼€å§‹ç›‘å¬æ¥è‡ªäºSurfaceFlingeræœåŠ¡ç«¯socketç«¯çš„å†™å…¥äº‹ä»¶ã€‚</p><h3 id="6-5ã€Appè¯·æ±‚Vsyncä¿¡å·"><a href="#6-5ã€Appè¯·æ±‚Vsyncä¿¡å·" class="headerlink" title="6.5ã€Appè¯·æ±‚Vsyncä¿¡å·"></a>6.5ã€Appè¯·æ±‚Vsyncä¿¡å·</h3><p>å‰é¢è®²è§£ViewRootImpl.setView()çš„æ—¶å€™ï¼Œå› æ¶‰åŠåˆ°Vsyncä¿¡å·çŸ¥è¯†ï¼ŒrequestLayout()æ²¡æœ‰å…·ä½“è®²è§£ï¼Œç°åœ¨ç»§ç»­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;Choreographer.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallback</span><span class="params">(<span class="keyword">int</span> callbackType, Runnable action, Object token)</span> </span>&#123;</span><br><span class="line">    postCallbackDelayed(callbackType, action, token, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallbackDelayed</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">        Runnable action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    postCallbackDelayedInternal(callbackType, action, token, delayMillis);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postCallbackDelayedInternal</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> dueTime = now + delayMillis;</span><br><span class="line">        <span class="comment">//å°†è¦æ‰§è¡Œçš„å›è°ƒå°è£…æˆCallbackRecordå¯¹è±¡ï¼Œä¿å­˜åˆ°mCallbackQueuesæ•°ç»„ä¸­</span></span><br><span class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">            scheduleFrameLocked(now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">            msg.arg1 = callbackType;</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleFrameLocked</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mFrameScheduled) &#123;</span><br><span class="line">        mFrameScheduled = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (USE_VSYNC) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isRunningOnLooperThreadLocked()) &#123;</span><br><span class="line">                scheduleVsyncLocked();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_VSYNC);</span><br><span class="line">                msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">                mHandler.sendMessageAtFrontOfQueue(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> nextFrameTime = Math.max(</span><br><span class="line">                    mLastFrameTimeNanos / TimeUtils.NANOS_PER_MS + sFrameDelay, now);</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_FRAME);</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, nextFrameTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆæ¯å¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FrameHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FrameHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_DO_SCHEDULE_VSYNC:</span><br><span class="line">                doScheduleVsync();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doScheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFrameScheduled) &#123;</span><br><span class="line">            scheduleVsyncLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleVsyncLocked</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="comment">//ç”³è¯·Vsyncä¿¡å·  </span></span><br><span class="line">mDisplayEventReceiver.scheduleVsync();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°ä¸­è€ƒè™‘äº†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ç³»ç»Ÿæ²¡æœ‰ä½¿ç”¨Vsyncæœºåˆ¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆæ ¹æ®å±å¹•åˆ·æ–°é¢‘ç‡è®¡ç®—ä¸‹ä¸€æ¬¡åˆ·æ–°æ—¶é—´ï¼Œé€šè¿‡å¼‚æ­¥æ¶ˆæ¯æ–¹å¼å»¶æ—¶æ‰§è¡ŒdoFrame()å‡½æ•°å®ç°å±å¹•åˆ·æ–°ã€‚å¦‚æœç³»ç»Ÿä½¿ç”¨äº†Vsyncæœºåˆ¶ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹å…·å¤‡æ¶ˆæ¯å¾ªç¯ï¼Œåˆ™ç›´æ¥è¯·æ±‚Vsyncä¿¡å·ï¼Œå¦åˆ™å°±é€šè¿‡ä¸»çº¿ç¨‹æ¥è¯·æ±‚Vsyncä¿¡å·ã€‚</p><h3 id="6-5-1ã€Vsyncè¯·æ±‚è¿‡ç¨‹"><a href="#6-5-1ã€Vsyncè¯·æ±‚è¿‡ç¨‹" class="headerlink" title="6.5.1ã€Vsyncè¯·æ±‚è¿‡ç¨‹"></a>6.5.1ã€Vsyncè¯·æ±‚è¿‡ç¨‹</h3><p>æˆ‘ä»¬çŸ¥é“åœ¨Choreographeræ„é€ å‡½æ•°ä¸­ï¼Œæ„é€ äº†ä¸€ä¸ªFrameDisplayEventReceiverå¯¹è±¡ï¼Œç”¨äºè¯·æ±‚å¹¶æ¥æ”¶Vsyncä¿¡å·ï¼ŒVsyncä¿¡å·è¯·æ±‚è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleVsyncLocked</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="comment">//ç”³è¯·Vsyncä¿¡å·  </span></span><br><span class="line">mDisplayEventReceiver.scheduleVsync();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;DisplayEventReceiver.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mReceiverPtr == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Attempted to schedule a vertical sync pulse but the display event "</span></span><br><span class="line">                + <span class="string">"receiver has already been disposed."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeScheduleVsync(mReceiverPtr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_DisplayEventReceiver.cpp ]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeScheduleVsync</span><span class="params">(JNIEnv* env, jclass clazz, jlong receiverPtr)</span> </span>&#123;</span><br><span class="line">sp&lt;NativeDisplayEventReceiver&gt; receiver =</span><br><span class="line">        reinterpret_cast&lt;NativeDisplayEventReceiver*&gt;(receiverPtr);</span><br><span class="line">status_t status = receiver-&gt;scheduleVsync();</span><br><span class="line"><span class="keyword">if</span> (status) &#123;</span><br><span class="line">    String8 message;</span><br><span class="line">    message.appendFormat(<span class="string">"Failed to schedule next vertical sync pulse.  status=%d"</span>, status);</span><br><span class="line">    jniThrowRuntimeException(env, message.string());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VSyncè¯·æ±‚è¿‡ç¨‹åˆè½¬äº¤ç»™äº†DisplayEventReceiverï¼š [-&gt;DisplayEventReceiver.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">status_t DisplayEventReceiver::requestNextVsync() &#123;</span><br><span class="line"><span class="keyword">if</span> (mEventConnection != NULL) &#123;</span><br><span class="line">    mEventConnection-&gt;requestNextVsync();</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> NO_INIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„mEventConnectionä¹Ÿæ˜¯å‰é¢åˆ›å»ºnativeå±‚å¯¹è±¡NativeDisplayEventReceiveræ—¶åˆ›å»ºçš„ï¼Œå®é™…å¯¹è±¡æ˜¯ä¸€ä¸ªBpDisplayEventConnectionå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªBinderå®¢æˆ·ç«¯ï¼Œå¯¹åº”çš„BinderæœåŠ¡ç«¯BnDisplayEventConnectionæ˜¯ä¸€ä¸ªEventThread::Connectionå¯¹è±¡ï¼Œå¯¹åº”çš„BpDisplayEventConnection.requestNextVsyncå‡½æ•°å’ŒBnDisplayEventConnection.onTransact(REQUEST_NEXT_VSYNC)å‡½æ•°æ²¡æœ‰è¿›è¡Œç‰¹åˆ«çš„å¤„ç†ï¼Œä¸‹é¢å°±è°ƒç”¨åˆ°EventThread::Connection.requestNextVsyncå‡½æ•°ï¼Œä»BnDisplayEventConnection.onTransact(REQUEST_NEXT_VSYNC)å¼€å§‹å·²ç»ä»ç”¨æˆ·è¿›ç¨‹å°†éœ€è¦å‚ç›´åŒæ­¥ä¿¡å·çš„è¯·æ±‚å‘é€åˆ°äº†SurfaceFlingerè¿›ç¨‹ï¼Œä¸‹é¢çš„å‡½æ•°è°ƒç”¨å¼€å§‹è¿›å…¥SFè¿›ç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> EventThread::Connection::requestNextVsync() &#123;</span><br><span class="line">    mEventThread-&gt;requestNextVsync(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¾—è½¬è°ƒç”¨åˆ°EventThread.requestNextVsyncå‡½æ•°ï¼Œæ³¨æ„é‡Œé¢ä¼ äº†å‚æ•°thisï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„EventThread::Connectionå¯¹è±¡ï¼Œéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œè¿™é‡Œçš„mEventThreadå¯¹è±¡æ˜¯åˆ›å»ºEventThread::Connectionå¯¹è±¡çš„æ—¶å€™ä¿å­˜çš„ï¼Œå¯¹åº”çš„æ˜¯SurfaceFlingerå¯¹è±¡çš„é‡Œé¢çš„mEventThreadæˆå‘˜ï¼Œè¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªåœ¨SurfaceFlinger.inité‡Œé¢åˆ›å»ºå¹¶å¯åŠ¨çš„çº¿ç¨‹å¯¹è±¡ï¼Œå¯è§è®¾è®¡çš„æ—¶å€™å°±ä¸“é—¨ç”¨è¿™ä¸ªSurfaceFlinger.mEventThreadçº¿ç¨‹æ¥æ¥æ”¶æ¥è‡ªåº”ç”¨è¿›ç¨‹çš„åŒæ­¥ä¿¡å·è¯·æ±‚ï¼Œæ¯æ¥ä¸€ä¸ªåº”ç”¨è¿›ç¨‹åŒæ­¥ä¿¡å·è¯·æ±‚ï¼Œå°±é€šè¿‡SurfaceFlinger.mEventThreadåˆ›å»ºä¸€ä¸ªEventThread::Connectionå¯¹è±¡ï¼Œå¹¶é€šè¿‡EventThread.registerDisplayEventConnectionå‡½æ•°å°†åˆ›å»ºçš„EventThread::Connectionå¯¹è±¡ä¿å­˜åˆ°EventThread.mDisplayEventConnectionsé‡Œé¢ï¼Œä¸Šé¢æœ‰è°ƒç”¨åˆ°äº†EventThread.requestNextVsyncå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> EventThread::requestNextVsync(<span class="keyword">const</span> sp&lt;EventThread::Connection&gt;&amp; connection) &#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="keyword">if</span> (connection-&gt;count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        connection-&gt;count = <span class="number">0</span>;</span><br><span class="line">        mCondition.broadcast();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼ è¿›æ¥çš„æ˜¯ä¸€ä¸ªå‰é¢åˆ›å»ºçš„EventThread::Connectionå¯¹è±¡ï¼Œé‡Œé¢åˆ¤æ–­åˆ°äº†EventThread::Connection.countæˆå‘˜å˜é‡ï¼Œçœ‹ä¸€ä¸‹EventThread::Connectionæ„é€ å‡½æ•°ä¸­åˆå§‹å˜é‡çš„å€¼ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EventThread::Connection::Connection(<span class="keyword">const</span> sp&lt;EventThread&gt;&amp; eventThread)</span><br><span class="line">    : count(<span class="number">-1</span>), mEventThread(eventThread), mChannel(<span class="keyword">new</span> BitTube())&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆå§‹å€¼æ˜¯-1ï¼Œè¿™ä¸ªå€¼å°±æ˜¯å‰é¢é‚£ä¸ªé—®é¢˜çš„å…³é”®ï¼ŒEventThread::Connection.countæ ‡ç¤ºäº†è¿™æ¬¡åº”ç”¨è¿›ç¨‹çš„å‚ç›´åŒæ­¥ä¿¡å·çš„è¯·æ±‚æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè¿˜æ˜¯å¤šæ¬¡é‡å¤çš„ï¼Œçœ‹ä¸€ä¸‹æ³¨é‡Šé‡Œé¢å¯¹äºè¿™ä¸ªå˜é‡çš„è¯´æ˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// count &gt;= 1 : continuous event. count is the vsync rate</span></span><br><span class="line"><span class="comment">// count == 0 : one-shot event that has not fired</span></span><br><span class="line"><span class="comment">// count ==-1 : one-shot event that fired this round / disabled</span></span><br><span class="line"><span class="keyword">int32_t</span> count;</span><br></pre></td></tr></table></figure><p>å¾ˆæ¸…æ¥šçš„è¯´æ˜äº†ï¼Œcount = 0è¯´æ˜å½“å‰çš„å‚ç›´åŒæ­¥ä¿¡å·è¯·æ±‚æ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§çš„è¯·æ±‚ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰è¢«å¤„ç†ã€‚ä¸Šé¢EventThread::requestNextVsyncé‡Œé¢å°†countè®¾ç½®æˆ0ï¼ŒåŒæ—¶è°ƒç”¨äº†mCondition.broadcast()å”¤é†’æ‰€æœ‰æ­£åœ¨ç­‰å¾…mConditionçš„çº¿ç¨‹ï¼Œè¿™ä¸ªä¼šè§¦å‘EventThread.waitForEventå‡½æ•°ä»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mCondition.wait(mLock);</span><br></pre></td></tr></table></figure><p>ä¸­é†’æ¥ï¼Œé†’æ¥ä¹‹åç»è¿‡ä¸€è½®doâ€¦whileå¾ªç¯å°±ä¼šè¿”å›ï¼Œè¿”å›ä»¥åè°ƒç”¨åºåˆ—å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰EventThread::Connection.postEvent(event) ï¼ˆ2ï¼‰DisplayEventReceiver::sendEvents(mChannel, &amp;event, 1)ï¼ŒmChannelå‚æ•°å°±æ˜¯å‰é¢åˆ›å»ºDisplayEventReceiveræ˜¯åˆ›å»ºçš„BitTubeå¯¹è±¡ ï¼ˆ3ï¼‰BitTube::sendObjects(dataChannel, events, count)ï¼Œstaticå‡½æ•°ï¼Œé€šè¿‡dataChannelæŒ‡å‘BitTubeå¯¹è±¡ æœ€ç»ˆè°ƒç”¨åˆ°BitTube::sendObjectså‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> BitTube::sendObjects(<span class="keyword">const</span> sp&lt;BitTube&gt;&amp; tube, <span class="keyword">void</span> <span class="keyword">const</span>* events, <span class="keyword">size_t</span> count, <span class="keyword">size_t</span> objSize)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* vaddr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(events);</span><br><span class="line">    <span class="keyword">ssize_t</span> size = tube-&gt;write(vaddr, count*objSize);</span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? size : size / <span class="keyword">static_cast</span>&lt;<span class="keyword">ssize_t</span>&gt;(objSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è°ƒç”¨åˆ°BitTube::writeå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> BitTube::write(<span class="keyword">void</span> <span class="keyword">const</span>* vaddr, <span class="keyword">size_t</span> size)&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> err, len;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        len = ::send(mSendFd, vaddr, size, MSG_DONTWAIT | MSG_NOSIGNAL);</span><br><span class="line">        <span class="comment">// cannot return less than size, since we're using SOCK_SEQPACKET</span></span><br><span class="line">        err = len &lt; <span class="number">0</span> ? errno : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (err == EINTR);</span><br><span class="line">    <span class="keyword">return</span> err == <span class="number">0</span> ? len : -err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨åˆ°äº†::sendå‡½æ•°ï¼Œ::æ˜¯ä½œç”¨åŸŸæè¿°ç¬¦ï¼Œå¦‚æœå‰é¢æ²¡æœ‰ç±»åä¹‹ç±»çš„ï¼Œä»£è¡¨çš„å°±æ˜¯å…¨å±€çš„ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨å…¨å±€å‡½æ•°sendï¼Œè¿™é‡Œå¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°è¿™æ˜¯ä¸€ä¸ªsocketçš„å†™å…¥å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å°†eventäº‹ä»¶æ•°æ®å†™å…¥åˆ°BitTubeä¸­äº’è”çš„socketä¸­ï¼Œè¿™æ ·åœ¨å¦ä¸€ç«¯é©¬ä¸Šå°±èƒ½æ”¶åˆ°å†™å…¥çš„æ•°æ®ï¼Œå‰é¢åˆ†æåˆ°è¿™ä¸ªBitTubeçš„socketçš„ä¸¤ç«¯è¿æ¥ç€SurfaceFlingerè¿›ç¨‹å’Œåº”ç”¨è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡è°ƒç”¨BitTube::writeå‡½æ•°ï¼Œå°†æœ€åˆç”±SurfaceFlingeræ•è·åˆ°çš„å‚ç›´ä¿¡å·äº‹ä»¶ç»ç”±BitTubeä¸­äº’è”çš„socketä»SurfaceFlingerè¿›ç¨‹å‘é€åˆ°äº†åº”ç”¨è¿›ç¨‹ä¸­BitTubeçš„socketæ¥æ”¶ç«¯ã€‚ ä¸‹é¢å°±è¦åˆ†æåº”ç”¨è¿›ç¨‹æ˜¯å¦‚ä½•æ¥æ”¶å¹¶ä½¿ç”¨è¿™ä¸ªå‚ç›´åŒæ­¥ä¿¡å·äº‹ä»¶çš„ã€‚</p><h3 id="6-5-2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync"><a href="#6-5-2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync" class="headerlink" title="6.5.2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync"></a>6.5.2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync</h3><h4 id="6-5-2-1ã€è§£æVSyncäº‹ä»¶"><a href="#6-5-2-1ã€è§£æVSyncäº‹ä»¶" class="headerlink" title="6.5.2.1ã€è§£æVSyncäº‹ä»¶"></a>6.5.2.1ã€è§£æVSyncäº‹ä»¶</h4><p>VSyncåŒæ­¥ä¿¡å·äº‹ä»¶å·²ç»å‘é€åˆ°ç”¨æˆ·è¿›ç¨‹ä¸­çš„socketæ¥æ”¶ç«¯ï¼Œåœ¨å‰é¢NativeDisplayEventReceiver.initializeä¸­åˆ†æåˆ°åº”ç”¨è¿›ç¨‹ç«¯çš„socketæ¥æ”¶æè¿°ç¬¦å·²ç»è¢«æ·»åŠ åˆ°Choreographeræ‰€åœ¨çº¿ç¨‹çš„nativeå±‚çš„Looperæœºåˆ¶ä¸­ï¼Œåœ¨epollä¸­ç›‘å¬EPOLLINäº‹ä»¶ï¼Œå½“socketæ”¶åˆ°æ•°æ®åï¼Œepollä¼šé©¬ä¸Šè¿”å›ï¼Œä¸‹é¢åˆ†æ­¥éª¤çœ‹ä¸€ä¸‹Looper.pollInner()æ•°ï¼š ï¼ˆ1ï¼‰epoll_wait</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">eventItems</span>[<span class="title">EPOLL_MAX_EVENTS</span>];</span></span><br><span class="line"><span class="keyword">int</span> eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</span><br></pre></td></tr></table></figure><p>åœ¨ç›‘å¬åˆ°æè¿°ç¬¦å¯¹åº”çš„äº‹ä»¶åï¼Œepoll_waitä¼šé©¬ä¸Šè¿”å›ï¼Œå¹¶å°†äº§ç”Ÿçš„å…·ä½“äº‹ä»¶ç±»å‹å†™å…¥åˆ°å‚æ•°eventItemsé‡Œé¢ï¼Œæœ€ç»ˆè¿”å›çš„eventCountæ˜¯ç›‘å¬åˆ°çš„äº‹ä»¶çš„ä¸ªæ•° ï¼ˆ2ï¼‰äº‹ä»¶åˆ†æ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; eventCount; i++) &#123;</span><br><span class="line">     <span class="keyword">int</span> fd = eventItems[i].data.fd;</span><br><span class="line">     <span class="keyword">uint32_t</span> epollEvents = eventItems[i].events;</span><br><span class="line">     <span class="keyword">if</span> (fd == mWakeReadPipeFd) &#123;   <span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯pipeè¯»ç®¡é“çš„äº‹ä»¶   è¿™é‡Œå¦‚æœæ˜¯EventThread,è¿™é‡Œå°±æ˜¯ä¸€ä¸ªsocketçš„æè¿°ç¬¦,è€Œä¸æ˜¯mWakeReadPipeFd</span></span><br><span class="line">         <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) &#123;</span><br><span class="line">             awoken(); <span class="comment">// æ¸…ç©ºè¯»ç®¡é“ä¸­çš„æ•°æ®</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ALOGW(<span class="string">"Ignoring unexpected epoll events 0x%x on wake read pipe."</span>, epollEvents);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//EventThreadæ¥æ”¶åˆ°åŒæ­¥ä¿¡å·èµ°çš„è¿™é‡Œ</span></span><br><span class="line">         <span class="keyword">ssize_t</span> requestIndex = mRequests.indexOfKey(fd);</span><br><span class="line">         <span class="keyword">if</span> (requestIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">int</span> events = <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT;</span><br><span class="line">             <span class="keyword">if</span> (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT;</span><br><span class="line">             <span class="keyword">if</span> (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR;</span><br><span class="line">             <span class="keyword">if</span> (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP;</span><br><span class="line">             pushResponse(events, mRequests.valueAt(requestIndex));</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ALOGW(<span class="string">"Ignoring unexpected epoll events 0x%x on fd %d that is "</span></span><br><span class="line">                     <span class="string">"no longer registered."</span>, epollEvents, fd);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>Looperç›®å‰äº†è§£åˆ°çš„ä¸»è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ç§ç±»æœ‰ä¸¤ç§ï¼š 1ï¼‰æ¶ˆæ¯äº‹ä»¶ï¼Œepoll_waitç›‘å¬pipeç®¡é“çš„æ¥æ”¶ç«¯æè¿°ç¬¦mWakeReadPipeFd 2ï¼‰ä¸VSyncä¿¡å·ï¼Œepoll_waitç›‘å¬socketæ¥æ”¶ç«¯æè¿°ç¬¦ï¼Œå¹¶åœ¨addFdçš„è¿‡ç¨‹ä¸­å°†ç›¸å…³çš„ä¿¡æ¯å°è£…åœ¨ä¸€ä¸ªRequestç»“æ„ä¸­ï¼Œå¹¶ä»¥fdä¸ºkeyå­˜å‚¨åˆ°äº†mRequestsä¸­ï¼Œå…·ä½“å¯ä»¥å›è¿‡å¤´çœ‹3.1.2å…³äºaddFdçš„åˆ†æï¼› å› æ­¤ï¼Œä¸Šé¢èµ°çš„æ˜¯elseçš„åˆ†æ”¯ï¼Œè¾¨åˆ«å‡ºå½“å‰çš„äº‹ä»¶ç±»å‹åï¼Œè°ƒç”¨pushResponseï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Looper::pushResponse(<span class="keyword">int</span> events, <span class="keyword">const</span> Request&amp; request) &#123;</span><br><span class="line">    Response response;</span><br><span class="line">    response.events = events;</span><br><span class="line">    response.request = request;  <span class="comment">//å¤åˆ¶ä¸æ˜¯å¼•ç”¨ï¼Œè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">    mResponses.push(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å°†Requestå’Œeventså°è£…åœ¨ä¸€ä¸ªResponseå¯¹è±¡é‡Œé¢ï¼Œå­˜å‚¨åˆ°äº†mResponsesé‡Œé¢ï¼Œä¹Ÿå°±æ˜¯mResponsesé‡Œé¢æ”¾çš„æ˜¯â€æŸæŸfdä¸Šæ¥æ”¶åˆ°äº†ç±»åˆ«ä¸ºeventsçš„æ—¶é—´â€è®°å½•ï¼Œç»§ç»­å‘ä¸‹çœ‹Looper.pollInnerå‡½æ•° ï¼ˆ3ï¼‰äº‹ä»¶åˆ†å‘å¤„ç†</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invoke all response callbacks.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mResponses.size(); i++) &#123;</span><br><span class="line">    Response&amp; response = mResponses.editItemAt(i);</span><br><span class="line">    <span class="keyword">if</span> (response.request.ident == POLL_CALLBACK) &#123;</span><br><span class="line">        <span class="keyword">int</span> fd = response.request.fd;</span><br><span class="line">        <span class="keyword">int</span> events = response.events;</span><br><span class="line">        <span class="keyword">void</span>* data = response.request.data;</span><br><span class="line">        <span class="keyword">int</span> callbackResult = response.request.callback-&gt;handleEvent(fd, events, data);</span><br><span class="line">        <span class="keyword">if</span> (callbackResult == <span class="number">0</span>) &#123;</span><br><span class="line">            removeFd(fd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Clear the callback reference in the response structure promptly because we</span></span><br><span class="line">        <span class="comment">// will not clear the response vector itself until the next poll.</span></span><br><span class="line">        response.request.callback.clear();</span><br><span class="line">        result = POLL_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„response.requestæ˜¯ä»pushResponseé‡Œé¢å¤åˆ¶è¿‡æ¥çš„ï¼Œé‡Œé¢çš„requestå¯¹åº”çš„Requestå¯¹è±¡æ˜¯åœ¨addFdçš„æ—¶å€™åˆ›å»ºçš„ï¼Œidentæˆå‘˜å°±æ˜¯POLL_CALLBACKï¼Œæ‰€ä»¥ç»§ç»­èµ°åˆ°response.request.callback-&gt;handleEventè¿™ä¸ªå‡½æ•°ï¼Œå›å¿†ä¸€ä¸‹3.1.2é‡Œé¢çš„addFdå‡½æ•°ï¼Œè¿™é‡Œçš„callbackå®é™…ä¸Šæ˜¯ä¸€ä¸ªSimpleLooperCallbackï¼ˆå®šä¹‰åœ¨Looper.cppä¸­ï¼‰å¯¹è±¡ï¼Œçœ‹ä¸€ä¸‹é‡Œé¢çš„handleEventå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> SimpleLooperCallback::handleEvent(<span class="keyword">int</span> fd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">return</span> mCallback(fd, events, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„mCallbackå°±æ˜¯å½“æ—¶åœ¨addFdçš„æ—¶å€™ä¼ è¿›æ¥çš„callBackå‚æ•°ï¼Œå®é™…ä¸Šå¯¹åº”çš„å°±æ˜¯NativeDisplayEventReceiverå¯¹è±¡æœ¬èº«ï¼Œå› æ­¤æœ€ç»ˆå°±å°†å‚ç›´åŒæ­¥ä¿¡å·äº‹ä»¶åˆ†å‘åˆ°äº†NativeDisplayEventReceiver.handleEventå‡½æ•°ä¸­ã€‚</p><h3 id="6-5-3ã€VSyncäº‹ä»¶åˆ†å‘"><a href="#6-5-3ã€VSyncäº‹ä»¶åˆ†å‘" class="headerlink" title="6.5.3ã€VSyncäº‹ä»¶åˆ†å‘"></a>6.5.3ã€<strong>VSyncäº‹ä»¶åˆ†å‘</strong></h3><p>è°ƒç”¨åˆ°NativeDisplayEventReceiver.handleEventå‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰åœ¨android_view_DisplayEventReceiver.cppä¸­ï¼Œç›´æ¥åˆ—å‡ºè¯¥å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> NativeDisplayEventReceiver::handleEvent(<span class="keyword">int</span> receiveFd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; (Looper::EVENT_ERROR | Looper::EVENT_HANGUP)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Display event receiver pipe was closed or an error occurred.  "</span></span><br><span class="line">                <span class="string">"events=0x%x"</span>, events);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// remove the callback</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(events &amp; Looper::EVENT_INPUT)) &#123;</span><br><span class="line">        ALOGW(<span class="string">"Received spurious callback for unhandled poll event.  "</span></span><br><span class="line">                <span class="string">"events=0x%x"</span>, events);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// keep the callback</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Drain all pending events, keep the last vsync.</span></span><br><span class="line">    <span class="keyword">nsecs_t</span> vsyncTimestamp;</span><br><span class="line">    <span class="keyword">int32_t</span> vsyncDisplayId;</span><br><span class="line">    <span class="keyword">uint32_t</span> vsyncCount;</span><br><span class="line">    <span class="keyword">if</span> (processPendingEvents(&amp;vsyncTimestamp, &amp;vsyncDisplayId, &amp;vsyncCount)) &#123;</span><br><span class="line">        ALOGV(<span class="string">"receiver %p ~ Vsync pulse: timestamp=%"</span> PRId64 <span class="string">", id=%d, count=%d"</span>,</span><br><span class="line">                <span class="keyword">this</span>, vsyncTimestamp, vsyncDisplayId, vsyncCount);</span><br><span class="line">        mWaitingForVsync = <span class="literal">false</span>;</span><br><span class="line">        dispatchVsync(vsyncTimestamp, vsyncDisplayId, vsyncCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// keep the callback</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­äº‹ä»¶æ˜¯ä¸æ˜¯æ­£ç¡®çš„Looper::EVENT_INPUTäº‹ä»¶ï¼Œç„¶åè°ƒç”¨åˆ°NativeDisplayEventReceiver.processPendingEventså‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> NativeDisplayEventReceiver::processPendingEvents(<span class="keyword">nsecs_t</span>* outTimestamp, <span class="keyword">int32_t</span>* outId, <span class="keyword">uint32_t</span>* outCount) &#123;</span><br><span class="line">    <span class="keyword">bool</span> gotVsync = <span class="literal">false</span>;</span><br><span class="line">    DisplayEventReceiver::Event buf[EVENT_BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">ssize_t</span> n;</span><br><span class="line">    <span class="keyword">while</span> ((n = mReceiver.getEvents(buf, EVENT_BUFFER_SIZE)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">ssize_t</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> DisplayEventReceiver::Event&amp; ev = buf[i];</span><br><span class="line">            <span class="keyword">switch</span> (ev.header.type) &#123;</span><br><span class="line">            <span class="keyword">case</span> DisplayEventReceiver::DISPLAY_EVENT_VSYNC:</span><br><span class="line">                <span class="comment">// Later vsync events will just overwrite the info from earlier</span></span><br><span class="line">                <span class="comment">// ones. That's fine, we only care about the most recent.</span></span><br><span class="line">                gotVsync = <span class="literal">true</span>;</span><br><span class="line">                *outTimestamp = ev.header.timestamp;</span><br><span class="line">                *outId = ev.header.id;</span><br><span class="line">                *outCount = ev.vsync.count;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DisplayEventReceiver::DISPLAY_EVENT_HOTPLUG:</span><br><span class="line">                dispatchHotplug(ev.header.timestamp, ev.header.id, ev.hotplug.connected);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                ALOGW(<span class="string">"receiver %p ~ ignoring unknown event type %#x"</span>, <span class="keyword">this</span>, ev.header.type);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"Failed to get events from display event receiver, status=%d"</span>, <span class="keyword">status_t</span>(n));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> gotVsync;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„mReceiverä¹Ÿå°±æ˜¯å‰é¢åˆ›å»ºNativeDisplayEventReceiverå¯¹è±¡æ˜¯åˆ›å»ºçš„æˆå‘˜å˜é‡å¯¹è±¡DisplayEventReceiverï¼Œä¸‹é¢è°ƒç”¨åˆ°DisplayEventReceiver.getEventså‡½æ•°ï¼Œåº”è¯¥æ˜¯è¦ä»å‡ºç°åŒæ­¥ä¿¡å·äº‹ä»¶çš„socketä¸­è¯»å–æ•°æ®ï¼Œä¸Šé¢Looperæœºåˆ¶ä¸­epollä¸­ç›‘å¬åˆ°socketä»¥åï¼Œè¿”å›åˆ°NativeDisplayEventReceiver.handleEventé‡Œé¢ï¼Œä½†æ˜¯socketé‡Œé¢çš„æ•°æ®è¿˜æ²¡æœ‰è¯»å–ï¼Œä¸‹é¢çš„è°ƒç”¨æµç¨‹ä¸ºï¼š ï¼ˆ1ï¼‰mReceiver.getEvents(buf, EVENT_BUFFER_SIZE) â€”&gt; DisplayEventReceiver::getEvents(DisplayEventReceiver::Event _events, size<em>t count) ï¼ˆ2ï¼‰BitTube::recvObjects(dataChannel, events, count) â€”&gt; BitTube::recvObjects(const sp&amp; tube, void</em> events, size_t count, size_t objSize) çœ‹ä¸€ä¸‹è¿™ä¸ªrecvObjectså‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> BitTube::recvObjects(<span class="keyword">const</span> sp&lt;BitTube&gt;&amp; tube, <span class="keyword">void</span>* events, <span class="keyword">size_t</span> count, <span class="keyword">size_t</span> objSize)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>* vaddr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(events);</span><br><span class="line">    <span class="keyword">ssize_t</span> size = tube-&gt;read(vaddr, count*objSize);</span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? size : size / <span class="keyword">static_cast</span>&lt;<span class="keyword">ssize_t</span>&gt;(objSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨NativeDisplayEventReceiverä¸­åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶åœ¨recvObjectsä¸­å°†socketä¸­çš„Eventæ•°æ®è¯»åˆ°è¿™ä¸ªç¼“å†²åŒºä¸­ï¼Œè¿™ä¸ªEvent.header.typeä¸€èˆ¬éƒ½æ˜¯DISPLAY_EVENT_VSYNCï¼Œå› æ­¤åœ¨ä¸Šé¢çš„processPendingEventså‡½æ•°ä¸­ä¼šå°†Eventæ•°æ®ä¿å­˜åœ¨outCountæ‰€æŒ‡å‘çš„å†…å­˜ä¸­ï¼Œå¹¶è¿”å›trueã€‚ æ¥ä¸‹æ¥è¿”å›åˆ°NativeDisplayEventReceiver.handleEventåä¼šè°ƒç”¨åˆ°dispatchVsyncå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NativeDisplayEventReceiver::dispatchVsync(<span class="keyword">nsecs_t</span> timestamp, <span class="keyword">int32_t</span> id, <span class="keyword">uint32_t</span> count) &#123;</span><br><span class="line">    JNIEnv* env = AndroidRuntime::getJNIEnv();</span><br><span class="line">    env-&gt;CallVoidMethod(mReceiverObjGlobal, gDisplayEventReceiverClassInfo.dispatchVsync, timestamp, id, count);</span><br><span class="line">    mMessageQueue-&gt;raiseAndClearException(env, <span class="string">"dispatchVsync"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å¤„ç†å¾ˆç›´æ¥ï¼Œç›´æ¥è°ƒç”¨mReceiverObjGlobalå¯¹è±¡åœ¨gDisplayEventReceiverClassInfo.dispatchVsyncä¸­æŒ‡å®šçš„å‡½æ•°ï¼Œå°†åé¢çš„timestampï¼ˆæ—¶é—´æˆ³ï¼‰ idï¼ˆè®¾å¤‡IDï¼‰ countï¼ˆç»è¿‡çš„åŒæ­¥ä¿¡å·çš„æ•°é‡ï¼Œä¸€èˆ¬æ²¡æœ‰è®¾ç½®é‡‡æ ·é¢‘ç‡åº”è¯¥éƒ½æ˜¯1ï¼‰ï¼Œä¸‹é¢åˆ†åˆ«çœ‹ä¸€ä¸‹mReceiverObjGlobalä»¥åŠgDisplayEventReceiverClassInfo.dispatchVsyncä»£è¡¨çš„æ˜¯ä»€ä¹ˆï¼Ÿ ï¼ˆ1ï¼‰mReceiverObjGlobal</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NativeDisplayEventReceiver::NativeDisplayEventReceiver(JNIEnv* env, jobject receiverObj, <span class="keyword">const</span> sp&lt;MessageQueue&gt;&amp; messageQueue) :</span><br><span class="line">        mReceiverObjGlobal(env-&gt;NewGlobalRef(receiverObj)), mMessageQueue(messageQueue), mWaitingForVsync(<span class="literal">false</span>) &#123;</span><br><span class="line">    ALOGV(<span class="string">"receiver %p ~ Initializing input event receiver."</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°mReceiverObjGlobalæ˜¯åˆ›å»ºNativeDisplayEventReceiverå¯¹è±¡æ—¶ä¼ è¿›æ¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¯¥å¯¹è±¡æ˜¯åœ¨nativeInitå‡½æ•°ä¸­åˆ›å»ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp receiver = <span class="keyword">new</span> NativeDisplayEventReceiver(env, receiverObj, messageQueue);</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥çš„ï¼ŒreceiverObjæ˜¯è°ƒç”¨nativeInitå‡½æ•°æ—¶ä¼ è¿›æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°envæ˜¯ç³»ç»Ÿç”¨äºè¿æ¥è™šæ‹Ÿæœºæ—¶è‡ªåŠ¨åŠ ä¸Šçš„ï¼‰ï¼ŒnativeInitå‡½æ•°åˆæ˜¯åœ¨Choreographerä¸­åˆ›å»ºFrameDisplayEventReceiverå¯¹è±¡æ—¶ï¼Œåœ¨åŸºç±»DisplayEventReceiveræ„é€ å™¨ä¸­è°ƒç”¨çš„ï¼Œå› æ­¤è¿™é‡Œçš„mReceiverObjGlobalå¯¹åº”çš„å°±æ˜¯Choreographerä¸­çš„FrameDisplayEventReceiveræˆå‘˜mDisplayEventReceiverã€‚ ï¼ˆ2ï¼‰gDisplayEventReceiverClassInfo.dispatchVsync åœ¨JNIä¸­æœ‰å¾ˆå¤šè¿™æ ·çš„ç±»ä¼¼çš„ç»“æ„ä½“å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡éƒ½æ˜¯å…¨å±€ç»“æ„ä½“å¯¹è±¡ï¼Œè¿™é‡Œçš„gDisplayEventReceiverClassInfoå°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æè¿°äº†ä¸€äº›åœ¨æ•´ä¸ªæ–‡ä»¶å†…å¯èƒ½ä¼šè°ƒç”¨åˆ°çš„javaå±‚çš„ç›¸å…³ç±»ä»¥åŠæˆå‘˜å‡½æ•°çš„ç›¸å…³ä¿¡æ¯ï¼Œçœ‹ä¸€ä¸‹gDisplayEventReceiverClassInfoï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    jclass clazz;</span><br><span class="line">    jmethodID dispatchVsync;</span><br><span class="line">    jmethodID dispatchHotplug;</span><br><span class="line">&#125; gDisplayEventReceiverClassInfo;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹é‡Œé¢çš„å˜é‡åç§°å°±èƒ½çŸ¥é“å¤§è‡´çš„å«ä¹‰ï¼Œclazzæˆå‘˜ä»£è¡¨çš„æ˜¯æŸä¸ªjavaå±‚çš„ç±»çš„classä¿¡æ¯ï¼ŒdispatchVsyncå’ŒdispatchHotplugä»£è¡¨çš„æ˜¯javaå±‚ç±»çš„æ–¹æ³•çš„æ–¹æ³•ä¿¡æ¯ï¼Œçœ‹ä¸€ä¸‹è¯¥æ–‡ä»¶ä¸­æ³¨å†ŒJNIå‡½æ•°çš„æ–¹æ³•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_view_DisplayEventReceiver</span><span class="params">(JNIEnv* env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = RegisterMethodsOrDie(env, <span class="string">"android/view/DisplayEventReceiver"</span>, gMethods, NELEM(gMethods));</span><br><span class="line">    jclass clazz = FindClassOrDie(env, <span class="string">"android/view/DisplayEventReceiver"</span>);</span><br><span class="line">    gDisplayEventReceiverClassInfo.clazz = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    gDisplayEventReceiverClassInfo.dispatchVsync = GetMethodIDOrDie(env, gDisplayEventReceiverClassInfo.clazz, <span class="string">"dispatchVsync"</span>, <span class="string">"(JII)V"</span>);</span><br><span class="line">    gDisplayEventReceiverClassInfo.dispatchHotplug = GetMethodIDOrDie(env, gDisplayEventReceiverClassInfo.clazz, <span class="string">"dispatchHotplug"</span>, <span class="string">"(JIZ)V"</span>);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RegisterMethodsOrDieè°ƒç”¨æ³¨å†Œäº†javaå±‚è°ƒç”¨nativeæ–¹æ³•æ—¶é“¾æ¥åˆ°çš„å‡½æ•°çš„å…¥å£ï¼Œä¸‹é¢clazzå¯¹åº”çš„å°±æ˜¯javaå±‚çš„â€android/view/DisplayEventReceiver.javaâ€ç±»ï¼ŒgDisplayEventReceiverClassInfo.dispatchVsyncé‡Œé¢ä¿å­˜çš„å°±æ˜¯clazzç±»ä¿¡æ¯ä¸­ä¸dispatchVsyncæ–¹æ³•ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒæ ·dispatchHotplugä¹Ÿæ˜¯ã€‚ åˆ†æåˆ°è¿™é‡Œï¼Œå°±çŸ¥é“åº”ç”¨è¿›ç¨‹nativeæ¥æ”¶åˆ°åŒæ­¥ä¿¡å·äº‹ä»¶åï¼Œä¼šè°ƒç”¨Choreographerä¸­çš„FrameDisplayEventReceiveræˆå‘˜mDisplayEventReceiverçš„dispatchVsyncæ–¹æ³•ã€‚</p><h3 id="6-5-4ã€åº”ç”¨æ¥æ”¶Vsync"><a href="#6-5-4ã€åº”ç”¨æ¥æ”¶Vsync" class="headerlink" title="6.5.4ã€åº”ç”¨æ¥æ”¶Vsync"></a>6.5.4ã€åº”ç”¨æ¥æ”¶Vsync</h3><p>çœ‹ä¸€ä¸‹FrameDisplayEventReceiver.dispatchVsyncæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯DisplayEventReceiver.dispatchVsyncæ–¹æ³•(Choreographer.java)ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// Called from native code.   </span><br><span class="line"> @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line"> private void dispatchVsync(long timestampNanos, int builtInDisplayId, int frame) &#123;</span><br><span class="line">     onVsync(timestampNanos, builtInDisplayId, frame);</span><br><span class="line"> &#125;</span><br><span class="line"> æ³¨é‡Šè¡¨æ˜è¿™ä¸ªæ–¹æ³•æ˜¯ä»nativeä»£ç è°ƒç”¨çš„ï¼Œè¯¥å‡½æ•°ç„¶åä¼šè°ƒç”¨FrameDisplayEventReceiver.onVsyncæ–¹æ³•ï¼š</span><br><span class="line">     @Override</span><br><span class="line">     public void onVsync(long timestampNanos, int builtInDisplayId, int frame) &#123;</span><br><span class="line">         // Ignore vsync from secondary display.</span><br><span class="line">         // This can be problematic because the call to scheduleVsync() is a one-shot.</span><br><span class="line">         // We need to ensure that we will still receive the vsync from the primary</span><br><span class="line">         // display which is the one we really care about.  Ideally we should schedule</span><br><span class="line">         // vsync for a particular display.</span><br><span class="line">         // At this time Surface Flinger won&apos;t send us vsyncs for secondary displays</span><br><span class="line">         // but that could change in the future so let&apos;s log a message to help us remember</span><br><span class="line">         // that we need to fix this.</span><br><span class="line">         //æ³¨é‡Šï¼šå¿½ç•¥æ¥è‡ªéä¸»æ˜¾ç¤ºå™¨çš„Vsyncä¿¡å·ï¼Œä½†æ˜¯æˆ‘ä»¬å‰é¢è°ƒç”¨çš„scheduleVsyncå‡½æ•°åªèƒ½è¯·æ±‚åˆ°ä¸€æ¬¡Vsyncä¿¡å·ï¼Œå› æ­¤éœ€è¦é‡æ–°è°ƒç”¨scheduleVsyncå‡½æ•°</span><br><span class="line">         //è¯·æ±‚æ¥è‡ªä¸»æ˜¾ç¤ºè®¾å¤‡çš„Vsyncä¿¡å·</span><br><span class="line">         if (builtInDisplayId != SurfaceControl.BUILT_IN_DISPLAY_ID_MAIN) &#123;</span><br><span class="line">             Log.d(TAG, &quot;Received vsync from secondary display, but we don&apos;t support &quot;</span><br><span class="line">                     + &quot;this case yet.  Choreographer needs a way to explicitly request &quot;</span><br><span class="line">                     + &quot;vsync for a specific display to ensure it doesn&apos;t lose track &quot;</span><br><span class="line">                     + &quot;of its scheduled vsync.&quot;);</span><br><span class="line">             scheduleVsync();</span><br><span class="line">             return;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         // Post the vsync event to the Handler.</span><br><span class="line">         // The idea is to prevent incoming vsync events from completely starving</span><br><span class="line">         // the message queue.  If there are no messages in the queue with timestamps</span><br><span class="line">         // earlier than the frame time, then the vsync event will be processed immediately.</span><br><span class="line">         // Otherwise, messages that predate the vsync event will be handled first.</span><br><span class="line">         long now = System.nanoTime();</span><br><span class="line">         if (timestampNanos &gt; now) &#123;</span><br><span class="line">             Log.w(TAG, &quot;Frame time is &quot; + ((timestampNanos - now) * 0.000001f)</span><br><span class="line">                     + &quot; ms in the future!  Check that graphics HAL is generating vsync &quot;</span><br><span class="line">                     + &quot;timestamps using the correct timebase.&quot;);</span><br><span class="line">             timestampNanos = now;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (mHavePendingVsync) &#123;</span><br><span class="line">             Log.w(TAG, &quot;Already have a pending vsync event.  There should only be &quot;</span><br><span class="line">                     + &quot;one at a time.&quot;);</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             mHavePendingVsync = true;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         mTimestampNanos = timestampNanos;  //åŒæ­¥ä¿¡å·æ—¶é—´æˆ³</span><br><span class="line">         mFrame = frame;                //åŒæ­¥ä¿¡å·çš„ä¸ªæ•°ï¼Œç†è§£å°±æ˜¯ä»è°ƒç”¨scheduleVsyncåˆ°onVsyncæ¥æ”¶åˆ°ä¿¡å·ä¹‹é—´ç»å†çš„åŒæ­¥ä¿¡å·çš„ä¸ªæ•°ï¼Œä¸€èˆ¬éƒ½æ˜¯1</span><br><span class="line">         Message msg = Message.obtain(mHandler, this);</span><br><span class="line">         msg.setAsynchronous(true);</span><br><span class="line">         mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>è²Œä¼¼è¿™é‡Œçš„å¤„ç†åªæ˜¯å¾€Choreographerå¯¹è±¡ä¸­çš„mHandlerå¯¹åº”çš„çº¿ç¨‹Looperä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œæ¶ˆæ¯çš„å†…å®¹æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š ï¼ˆ1ï¼‰å°†thisï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„FrameDisplayEventReceiverå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œåé¢ä¼šå›è°ƒåˆ°FrameDisplayEventReceiver.runæ–¹æ³•ï¼› ï¼ˆ2ï¼‰ä¸ºMessageè®¾ç½®FLAG_ASYNCHRONOUSå±æ€§ï¼› å‘é€è¿™ä¸ªFLAG_ASYNCHRONOUSæ¶ˆæ¯åï¼Œåé¢ä¼šå›è°ƒåˆ°FrameDisplayEventReceiver.runæ–¹æ³•ï¼Œè‡³äºä¸ºä»€ä¹ˆï¼Œåé¢å†å†™æ–‡ç« ç»“åˆView.invalidateæ–¹æ³•çš„è¿‡ç¨‹åˆ†æï¼Œçœ‹ä¸€ä¸‹FrameDisplayEventReceiver.runæ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    mHavePendingVsync = false;</span><br><span class="line">    doFrame(mTimestampNanos, mFrame);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨Choreographer.doFrameæ–¹æ³•ï¼Œå¦‚æœæ˜¯é‡ç»˜äº‹ä»¶doFrameæ–¹æ³•ä¼šæœ€ç»ˆè°ƒç”¨åˆ°ViewRootImpl.performTraversalsæ–¹æ³•è¿›å…¥å®é™…çš„ç»˜åˆ¶æµç¨‹ã€‚ç»è¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œè°ƒç”¨ä¸€æ¬¡Choreographer.scheduleVsyncLockedåªä¼šè¯·æ±‚ä¸€æ¬¡åŒæ­¥ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯å›è°ƒä¸€æ¬¡FrameDisplayEventReceiver.onVsyncæ–¹æ³•ï¼Œåœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªåº”ç”¨è¿›ç¨‹éœ€è¦å¤šæ¬¡è¯·æ±‚VsyncåŒæ­¥ä¿¡å·ä¼šä¸ä¼šä½¿ç”¨åŒæ ·çš„ä¸€ä¸²å¯¹è±¡ï¼Ÿå¤šä¸ªçº¿ç¨‹åˆæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ ç­”ï¼šä¸€èˆ¬ç»˜åˆ¶æ“ä½œåªèƒ½åœ¨ä¸»çº¿ç¨‹é‡Œé¢è¿›è¡Œï¼Œå› æ­¤ä¸€èˆ¬æ¥è¯´åªä¼šåœ¨ä¸»çº¿ç¨‹é‡Œé¢å»è¯·æ±‚åŒæ­¥ä¿¡å·ï¼Œå¯ä»¥è®¤ä¸ºä¸ä¼šå­˜åœ¨åŒä¸€ä¸ªåº”ç”¨çš„å¤šä¸ªçº¿ç¨‹è¯·æ±‚SFçš„Vsyncä¿¡å·ï¼ŒChoreographeræ˜¯ä¸€ä¸ªçº¿ç¨‹å†…çš„å•ä¾‹æ¨¡å¼ï¼Œå­˜å‚¨åœ¨äº† ThreadLocal sThreadInstanceå¯¹è±¡é‡Œé¢ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹å¤šæ¬¡è¯·æ±‚ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªChoreographerå¯¹è±¡ï¼Œæ‰€ä»¥åé¢çš„ä¸€ä¸²å¯¹è±¡åº”è¯¥éƒ½æ˜¯å¯ä»¥å¤ç”¨çš„ã€‚</p><p>æ€»ä½“æ¶æ„ï¼š ä¼æœ¨ç´¯:::ç»ˆäºå®Œäº†ï¼Œç”±äºAndroid Graphicsç³»ç»Ÿæ¶‰åŠæ¨¡å—ä»£ç çºµæ¨ªäº¤å‰å¤æ‚ï¼Œå…¶ä¸­ä»£ç å›¾ç¤ºæœ‰è¯¯çš„åœ°æ–¹è¯·è§è°…ï¼Œä¹Ÿæ²¡æœ‰ç²¾åŠ›ä¸€ä¸€æ ¸å¯¹äº†ï¼Œè¿˜è¯·æµ·æ¶µ~~~ä¸»è¦æ˜¯åˆ†æAndroid Graphicsæ€»ä½“çš„ä¸€ä¸ªæµç¨‹æ€æƒ³ï¼Œæœ‰éœ€è¦å†ä¸€ç‚¹ç‚¹æ·±æŒ–ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/30-Android-Graphics-Arc-flow.png" alt="Markdown"></p><h2 id="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h2><p><a href="http://www.10tiao.com/html/431/201601/401709603/1.html" target="_blank" rel="noopener">Android Vsync åŸç†</a><br><a href="http://blog.csdn.net/uiop78uiop78/article/category/1390680" target="_blank" rel="noopener">æ—å­¦æ£®çš„Androidä¸“æ </a><br><a href="http://coderprof.com/android_tutorials_pdf_examples_PDF.php?q=android+graphics+pdf" target="_blank" rel="noopener">Android Graphics</a><br><a href="https://source.android.com/devices/tech/debug/systrace" target="_blank" rel="noopener">äº†è§£ Systrace</a><br><a href="http://www.cnblogs.com/samchen2009/category/524173.html" target="_blank" rel="noopener">å›¾è§£Android - Android GUI ç³»ç»Ÿ</a><br><a href="http://windrunnerlihuan.com/" target="_blank" rel="noopener">Android SurfaceFlinger å­¦ä¹ ä¹‹è·¯&amp;Androidå¤šåª’ä½“å¼€å‘</a><br><a href="http://blog.csdn.net/Gaugamela/article/category/6383486" target="_blank" rel="noopener">Android7.0 åŸºç¡€ä¸šåŠ¡AMSã€æ•°æ®ä¸šåŠ¡ã€ç”µæºç®¡ç†ä¸šåŠ¡ æºç åˆ†æ</a><br><a href="http://blog.csdn.net/yangwen123/article/category/1647761" target="_blank" rel="noopener">ã€Android æ˜¾ç¤ºæ¨¡å—ã€‘ - æ·±å…¥å‰–æAndroidç³»ç»Ÿ - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/innost/article/details/47208337" target="_blank" rel="noopener">æ·±å…¥ç†è§£Androidå·ä¸€å…¨æ–‡-ç¬¬å…«ç« (æ·±å…¥ç†è§£Surfaceç³»ç»Ÿ)</a><br><a href="http://blog.csdn.net/armwind/article/category/6282972" target="_blank" rel="noopener">androidç³»ç»Ÿ - armwindçš„ä¸“æ  - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/kc58236582/article/category/6436488" target="_blank" rel="noopener">androidæ˜¾ç¤ºç³»ç»Ÿ - kc58236582çš„åšå®¢ - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/wytiger/p/5693569.html" target="_blank" rel="noopener">SurfaceView, TextureView, SurfaceTextureç­‰çš„åŒºåˆ«</a><br><a href="http://blog.csdn.net/armwind/article/details/73436532" target="_blank" rel="noopener">ã€Demoã€‘Android graphics å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»</a><br><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0421/2765.html" target="_blank" rel="noopener">æ·±å…¥Android Graphics Pipelineï¼šä»æŒ‰é’®åˆ°å¸§ç¼“å†²ï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼‰</a><br><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0421/2766.html" target="_blank" rel="noopener">æ·±å…¥Android Graphics Pipelineï¼šä»æŒ‰é’®åˆ°å¸§ç¼“å†²ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰</a><br><a href="https://software.intel.com/en-us/node/713326" target="_blank" rel="noopener">çª—å£ï¼šProfiling è§†å›¾ï¼ˆOpenGL/OpenGL ES* å·¥ä½œè´Ÿè½½ï¼‰</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/54234354" target="_blank" rel="noopener">Android Nä¸­UIç¡¬ä»¶æ¸²æŸ“ï¼ˆhwuiï¼‰çš„HWUI_NEW_OPS(åŸºäºAndroid 7.1)</a><br><a href="https://netaz.blogspot.jp/search/label/gralloc" target="_blank" rel="noopener">Androidâ€™s Graphics Buffer Management System (Part I: gralloc)</a><br><a href="https://netaz.blogspot.jp/search/label/Graphics" target="_blank" rel="noopener">Androidâ€™s Graphics Buffer Management System (Part II: BufferQueue)</a><br><a href="https://www.kancloud.cn/digest/androidcore/149097" target="_blank" rel="noopener">Android GDIä¹‹SurfaceFlinger</a><br><a href="http://windrunnerlihuan.com/" target="_blank" rel="noopener">Android SurfaceFlinger å­¦ä¹ ä¹‹è·¯(äº”)â€”-VSync å·¥ä½œåŸç†</a><br><a href="http://blog.csdn.net/michaelcao1980/article/details/43233765" target="_blank" rel="noopener">Android 5.1 SurfaceFlinger VSYNCè¯¦è§£</a><br><a href="http://blog.csdn.net/newchenxf/article/details/49131167" target="_blank" rel="noopener">Android 5.1 SurfaceFlinger VSYNCè¯¦è§£</a><br><a href="http://blog.csdn.net/houliang120/article/details/50958212" target="_blank" rel="noopener">Androidæ¶ˆæ¯æœºåˆ¶Looperä¸VSyncçš„ä¼ æ’­</a><br><a href="http://blog.csdn.net/houliang120/article/details/50908098" target="_blank" rel="noopener">Androidå‚ç›´åŒæ­¥ä¿¡å·VSyncçš„äº§ç”ŸåŠä¼ æ’­ç»“æ„è¯¦è§£</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/17293325" target="_blank" rel="noopener">Android 4.4(KitKat)ä¸­VSyncä¿¡å·çš„è™šæ‹ŸåŒ–</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/37737439" target="_blank" rel="noopener">Android 4.4(KitKat)çª—å£ç®¡ç†å­ç³»ç»Ÿ - ä½“ç³»æ¡†æ¶</a><br><a href="http://blog.csdn.net/ariesjzj/article/category/1087829/2" target="_blank" rel="noopener">Androidä¸­ç”¨OpenGL ES Traceråˆ†æç»˜åˆ¶è¿‡ç¨‹</a><br><a href="https://www.zhihu.com/question/30372696?sort=created" target="_blank" rel="noopener">android viewçš„ç»˜åˆ¶ä¸­ï¼ŒViewç»˜åˆ¶çš„æ—¶é—´å¦‚ä½•å’Œvsyncå±å¹•åˆ·æ–°é¢‘ç‡ä¿æŒåŒæ­¥çš„ï¼Ÿ</a><br><a href="http://blog.csdn.net/innost/article/details/47208337" target="_blank" rel="noopener">ã€æ·±å…¥ç†è§£Androidå·ä¸€å…¨æ–‡-ç¬¬å…«ç« ã€‘å…¥ç†è§£Surfaceç³»ç»Ÿ</a><br><a href="http://blog.csdn.net/april_12345/article/details/52933316" target="_blank" rel="noopener">Android çª—å£ç®¡ç†ï¼šZ-Orderç®¡ç†</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Androidç³»ç»Ÿå›¾å½¢æ¡†æ¶ç”±ä¸‹å¾€ä¸Šä¸»è¦çš„åŒ…æ‹¬HAL(HWComposerå’ŒGrallocä¸¤ä¸ªmoudle)ï¼ŒSurfaceFlingerï¼ˆBufferQueueçš„æ¶ˆè´¹è€…ï¼‰ï¼ŒWindowManagerServiceï¼ˆçª—å£ç®¡ç†è€…ï¼‰ï¼ŒViewï¼ˆBufferQueueçš„ç”Ÿäº§è€…ï¼‰å››å¤§æ¨¡å—ã€‚&lt;br&gt;â— HAL: åŒ…æ‹¬HWComposerå’ŒGrallocä¸¤ä¸ªmoudleï¼ŒAndroid Nä¸Šç”±SurfaceFlingeræ‰“å¼€ï¼Œå› æ­¤åœ¨åŒä¸€è¿›ç¨‹ã€‚ gralloc ç”¨äºBufferQueueçš„å†…å­˜åˆ†é…ï¼ŒåŒæ—¶ä¹Ÿæœ‰fbçš„æ˜¾ç¤ºæ¥å£ï¼ŒHWComposerä½œä¸ºåˆæˆSurfaceFlingeré‡Œé¢çš„Layerï¼Œå¹¶æ˜¾ç¤ºï¼ˆé€šè¿‡grallocçš„postå‡½æ•°ï¼‰&lt;br&gt;â— SurfaceFlingerå¯ä»¥å«åšLayerFlingerï¼Œä½œä¸ºLayerçš„ç®¡ç†è€…ï¼ŒåŒæ˜¯ä¹Ÿæ˜¯BufferQueueçš„æ¶ˆè´¹è€…ï¼Œå½“æ¯ä¸ªLayerçš„ç”Ÿäº§è€…drawå®Œå®Œæ•´çš„ä¸€å¸§æ—¶ï¼Œä¼šé€šçŸ¥SurfaceFlingerï¼Œé€šçŸ¥çš„æ–¹å¼é‡‡ç”¨BufferQueueã€‚&lt;br&gt;â— WindowManagerService: ä½œä¸ºWindowçš„ç®¡ç†è€…ï¼ŒæŒç®¡ç€è®¡ç®—çª—å£å¤§å°ï¼Œçª—å£åˆ‡æ¢ç­‰ä»»åŠ¡ï¼ŒåŒæ—¶ä¹Ÿä¼šå°†ç›¸åº”çš„å‚æ•°è®¾ç½®ç»™SurfaceFlingerï¼Œæ¯”å¦‚Windowçš„åœ¨z-orderï¼Œå’Œçª—å£çš„å¤§å°ã€‚&lt;br&gt;â— View: ä½œä¸ºBufferQueueçš„ç”Ÿäº§è€…ï¼Œæ¯å½“æ‰§è¡ŒlockCanvas-&amp;gt;draw-&amp;gt;unlockCanvasï¼Œä¹‹åä¼šå­˜å…¥ä¸€å¸§æ•°æ®è¿›å…¥BufferQueueä¸­ã€‚ å˜¿å˜¿(&lt;em&gt;^â–½^&lt;/em&gt;),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚
    
    </summary>
    
      <category term="Android" scheme="http://zhoujinjian.cc/categories/Android/"/>
    
    
      <category term="Android" scheme="http://zhoujinjian.cc/tags/Android/"/>
    
  </entry>
  
</feed>
