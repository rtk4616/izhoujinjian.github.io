<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/06/01/Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.16.jpg" alt="Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ"></div><header class="post__info"><h1 class="post__title">Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://www.github.com/izhoujinjian">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-06-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¸€-ã€Android-Video-Overview"><span class="toc-text">(ä¸€)ã€Android Video Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#äºŒ-ã€Android-MediaPlayer-amp-Nuplayer-æ¡†æ¶åˆ†æ"><span class="toc-text">(äºŒ)ã€Android MediaPlayer &amp; Nuplayer æ¡†æ¶åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1ã€MediaPlayer"><span class="toc-text">2.1ã€MediaPlayer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1ã€MediaPlayerçŠ¶æ€å›¾"><span class="toc-text">2.1.1ã€MediaPlayerçŠ¶æ€å›¾:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2ã€MediaPlayerå’ŒMediaPlayerService"><span class="toc-text">2.1.2ã€MediaPlayerå’ŒMediaPlayerService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-3ã€åˆ›å»ºMediaPlayer"><span class="toc-text">2.1.3ã€åˆ›å»ºMediaPlayer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-4ã€setDataSource-è®¾ç½®æ’­æ”¾èµ„æº"><span class="toc-text">2.1.4ã€setDataSource()è®¾ç½®æ’­æ”¾èµ„æº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-5ã€setDisplay"><span class="toc-text">2.1.5ã€setDisplay()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹"><span class="toc-text">2.1.6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2ã€NuPlayeråˆ†æ"><span class="toc-text">2.2ã€NuPlayeråˆ†æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-0ã€NuPlayerç®€ä»‹"><span class="toc-text">2.2.0ã€NuPlayerç®€ä»‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾"><span class="toc-text">2.2.1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹"><span class="toc-text">2.2.2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¸‰-ã€Android-MediaPlayeræ¡†æ¶åˆ†æ-AHandler-AMessage-ALooper"><span class="toc-text">(ä¸‰)ã€Android MediaPlayeræ¡†æ¶åˆ†æ - AHandler AMessage ALooper</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰"><span class="toc-text">3.1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰"><span class="toc-text">3.2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰"><span class="toc-text">3.3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹"><span class="toc-text">3.4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å››-ã€NuPlayeræºç åˆ†æ"><span class="toc-text">(å››)ã€NuPlayeræºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜"><span class="toc-text">4.1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2ã€setDataSourceAsync-ç°åˆ†æ"><span class="toc-text">4.2ã€setDataSourceAsync()ç°åˆ†æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3ã€prepareAsync"><span class="toc-text">4.3ã€prepareAsync()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4ã€setVideoSurfaceTextureAsync"><span class="toc-text">4.4ã€setVideoSurfaceTextureAsync()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5ã€start-pause"><span class="toc-text">4.5ã€start()/pause()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-6ã€å°ç»“ç»“å’Œç–‘é—®"><span class="toc-text">4.6ã€å°ç»“ç»“å’Œç–‘é—®</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-7ã€Codec-Encoder-ã€Decoderåˆ—è¡¨é™„å½•"><span class="toc-text">4.7ã€Codec Encoder ã€Decoderåˆ—è¡¨é™„å½•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div><hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/video.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android NuPlayeræ’­æ”¾æ¡†æ¶ã€‘</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - android ACodec MediaCodec NuPlayer flowã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br><a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br><a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener">Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>â˜¯ V4l2 æ¡†æ¶ä»£ç <br>â˜¯ kernel/drivers/media/v4l2-core/ï¼ˆæ–‡ä»¶å‰ç¼€ä¸º videobuf2ï¼‰</p><p>â˜¯ MSM è§†é¢‘é©±åŠ¨ç¨‹åºæ–‡ä»¶<br>â˜¯ kernel/drivers/media/platform/msm/vidc/</p><p>â˜¯ è®¾å¤‡æ ‘<br>â˜¯ /kernel/arch/arm/boot/dts/qcomï¼ˆVenus çš„å¯„å­˜å™¨åŸºå€ï¼Œæ—¶é’Ÿé¢‘ç‡ï¼‰</p><p>â˜¯ Stagefrightã€libmediaã€libmediaplayerserviceã€mediaserver<br>â˜¯ /frameworks/av/media/</p><p>â˜¯ OMX<br>â˜¯ /hardware/qcom/media/mam8996/mm-video-v4l2/vidc/</p><p>â˜¯ OMX æ ¸å¿ƒ<br>â˜¯ /hardware/qcom/media/mm-core</p><p>â˜¯ è½¯ä»¶ç¼–è§£ç å™¨è·¯å¾„<br>â˜¯ /vendor/qcom/proprietary/mm-video/omx_vpp(?)â†’ è§£ç å™¨ä»£ç <br>â˜¯ /vendor/qcom/proprietary/mm-video/omx_vpp(?) â†’ ç¼–ç å™¨ä»£ç </p><hr><h4 id="ä¸€-ã€Android-Video-Overview"><a href="#ä¸€-ã€Android-Video-Overview" class="headerlink" title="(ä¸€)ã€Android Video Overview"></a>(ä¸€)ã€Android Video Overview</h4><p>åŸºäº OpenMAX çš„è§†é¢‘è§£ç  â€“ æ•°æ®æµ<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-01-OpenMax-Based video decode - data flow.png" alt="Alt text"></p><blockquote><p>YUVï¼Œæ˜¯ä¸€ç§é¢œè‰²ç¼–ç æ–¹æ³•ã€‚å¸¸ä½¿ç”¨åœ¨å„ä¸ªè§†é¢‘å¤„ç†ç»„ä»¶ä¸­ã€‚ YUVåœ¨å¯¹ç…§ç‰‡æˆ–è§†é¢‘ç¼–ç æ—¶ï¼Œè€ƒè™‘åˆ°äººç±»çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œå…è®¸é™ä½è‰²åº¦çš„å¸¦å®½ã€‚<a href="https://zh.wikipedia.org/wiki/YUV" target="_blank" rel="noopener">YUV</a><br>VPUï¼ŒVideo processing unit</p></blockquote><p>åŸºäº OpenMAX çš„è§†é¢‘ç¼–ç  â€“ æ•°æ®æµ<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-02-OpenMax-Based video encode - data flow.png.png" alt="Alt text"></p><p>è§†é¢‘æ¡†æ¶ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-03-Video Architecture Software Stack.png" alt="Alt text"></p><p>ç»„ä»¶æè¿°ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-04-Q Component Description.png" alt="Alt text"></p><p>æ€»ç»“ï¼š<br>ä»è§†é¢‘æ¡†æ¶å¯ä»¥äº†è§£åˆ°ã€‚è§†é¢‘æ–‡ä»¶å…ˆç»Stagefrightä¼ åˆ°OMX decoderè§£ç ï¼ˆè½¯è§£æˆ–ç¡¬è§£ï¼‰ã€OMX decoderå°†è§£ç åçš„YUVæ•°æ®å›ä¼ åˆ°Stagefrightï¼Œä¸æ–­å¾ªç¯æ’­æ”¾åŒæ—¶ç»ç”±SurfaceFlingeræ¸²æŸ“åˆ°LCDå±å¹•ä¸Šã€‚</p><h4 id="äºŒ-ã€Android-MediaPlayer-amp-Nuplayer-æ¡†æ¶åˆ†æ"><a href="#äºŒ-ã€Android-MediaPlayer-amp-Nuplayer-æ¡†æ¶åˆ†æ" class="headerlink" title="(äºŒ)ã€Android MediaPlayer &amp; Nuplayer æ¡†æ¶åˆ†æ"></a>(äºŒ)ã€Android MediaPlayer &amp; Nuplayer æ¡†æ¶åˆ†æ</h4><h5 id="2-1ã€MediaPlayer"><a href="#2-1ã€MediaPlayer" class="headerlink" title="2.1ã€MediaPlayer"></a>2.1ã€MediaPlayer</h5><p>Androidåœ¨Javaå±‚ä¸­æä¾›äº†ä¸€ä¸ªMediaPlayerçš„ç±»æ¥ä½œä¸ºæ’­æ”¾åª’ä½“èµ„æºçš„æ¥å£ï¼Œåœ¨ä½¿ç”¨ä¸­æˆ‘ä»¬é€šå¸¸ä¼šç¼–å†™ä»¥ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mMediaPlayer = <span class="keyword">new</span> MediaPlayer();</span><br><span class="line">mMediaPlayer.setDataSource(Environment.getExternalStorageDirectory()+<span class="string">"/test_video.mp4"</span>);</span><br><span class="line">mMediaPlayer.setDisplay(...);</span><br><span class="line">mMediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);</span><br><span class="line">mMediaPlayer.prepareAsync();</span><br><span class="line">mMediaPlayer.start();</span><br><span class="line">mediaPlayer.pause(); </span><br><span class="line">mediaPlayer.stop();</span><br><span class="line">mediaPlayer.reset();</span><br><span class="line">mediaPlayer.release();</span><br></pre></td></tr></table></figure><p>é€šå¸¸MediaPlayerçš„è°ƒç”¨é€»è¾‘æ˜¯ï¼Œæ„é€ å‡½æ•°-&gt; setDataSource -&gt; SetVideoSurfaceTexture-&gt; prepare/prepareAsync -&gt; start-&gt; stop-&gt; reset-&gt; ææ„å‡½æ•°ï¼ŒæŒ‰ç…§å®é™…éœ€æ±‚è¿˜ä¼šè°ƒç”¨pauseã€isPlayingã€getDurationã€getCurrentPositionã€setLoopingã€seekToç­‰æ–¹æ³•ã€‚</p><h5 id="2-1-1ã€MediaPlayerçŠ¶æ€å›¾"><a href="#2-1-1ã€MediaPlayerçŠ¶æ€å›¾" class="headerlink" title="2.1.1ã€MediaPlayerçŠ¶æ€å›¾:"></a>2.1.1ã€MediaPlayerçŠ¶æ€å›¾:</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-05-MediaPlayer-status-turn-.png" alt="Alt text"></p><p>â˜¯ IdleçŠ¶æ€<br>è°ƒç”¨newæˆ–reset()æ–¹æ³•åˆ›å»ºMediaPlayeråè¿›å…¥ç©ºé—²<br>â˜¯ EndçŠ¶æ€<br>è°ƒç”¨release()åå°±ç»“æŸ<br>â˜¯ ErrorçŠ¶æ€<br>æ’­æ”¾æ§åˆ¶æ“ä½œå‡ºé”™æˆ–æ— æ•ˆçŠ¶æ€ä¸‹è°ƒç”¨æ’­æ”¾æ§åˆ¶æ“ä½œ<br>â˜¯ InitializedçŠ¶æ€</p><p>è°ƒç”¨setDataSourceä¹‹åå®Œæˆåˆå§‹åŒ–<br>â˜¯ PreparedçŠ¶æ€<br>åŒæ­¥prepare()æˆ–å¼‚æ­¥prepareAsync()å®Œæˆå‡†å¤‡<br>â˜¯ PreparingçŠ¶æ€<br>æ˜¯ä¸€ç§ç¬æ—¶çŠ¶æ€ï¼Œè°ƒç”¨prepareAsync()æ—¶ä¼šå…ˆè¿›å…¥æ­¤çŠ¶æ€<br>â˜¯ Started çŠ¶æ€<br>è¦å¼€å§‹æ’­æ”¾å¿…é¡»è°ƒç”¨start()<br>â˜¯ Paused çŠ¶æ€<br>è°ƒç”¨pause()å¹¶æˆåŠŸè¿”å›åæ’­æ”¾å¯ä»¥è¢«æš‚åœ<br>â˜¯ StoppedçŠ¶æ€<br>è°ƒç”¨stop()ä¼šåœæ­¢æ’­æ”¾<br>â˜¯ PlaybackCompletedçŠ¶æ€<br>å½“æ’­æ”¾åˆ°è¾¾æµæœ«ç«¯æ—¶ï¼Œæ’­æ”¾å®Œæˆ</p><h5 id="2-1-2ã€MediaPlayerå’ŒMediaPlayerService"><a href="#2-1-2ã€MediaPlayerå’ŒMediaPlayerService" class="headerlink" title="2.1.2ã€MediaPlayerå’ŒMediaPlayerService"></a>2.1.2ã€MediaPlayerå’ŒMediaPlayerService</h5><p>mediaserver å¯åŠ¨åä¼šæŠŠmediaç›¸å…³ä¸€äº›æœåŠ¡æ·»åŠ åˆ°servicemanagerä¸­ï¼Œå…¶ä¸­å°±æœ‰mediaPlayerServiceã€‚è¿™æ ·åº”ç”¨å¯åŠ¨å‰ï¼Œç³»ç»Ÿå°±æœ‰äº†mediaPlayerServiceè¿™ä¸ªæœåŠ¡ç¨‹åºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\mediaserver\main_mediaserver.cpp]</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-06-Main_mediaserver.png" alt="Alt text"></p><h5 id="2-1-3ã€åˆ›å»ºMediaPlayer"><a href="#2-1-3ã€åˆ›å»ºMediaPlayer" class="headerlink" title="2.1.3ã€åˆ›å»ºMediaPlayer"></a>2.1.3ã€åˆ›å»ºMediaPlayer</h5><p>â˜¯ Javaåº”ç”¨ç¨‹åºä¸­åˆ›å»ºMediaPlayerå¯¹è±¡<br>MediaPlayer mediaPlayer = new MediaPlayer();<br>â˜¯ MediaPlayerçš„æ„é€ å‡½æ•°ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯æœ¬åœ°çš„nativeå‡½æ•°ï¼šnative_setup()å…¶å¯¹åº”çš„JNIå‡½æ•°ä¸º<br>android_media_MediaPlayer_native_setup()</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\jni\android_media_MediaPlayer.cpp]</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-07-android_media_MediaPlayer_native_setup.png" alt="Alt text"></p><p>æ„é€ Nativeå±‚çš„MediaPlayerå¯¹è±¡çš„æ—¶å€™ã€MediaPlayer.cppã€‘ï¼Œä¹Ÿä¼šæ„é€ å…¶çˆ¶ç±»çš„å¯¹è±¡ã€‚åœ¨MediaPlayerçš„çˆ¶ç±»IMediaDeathNotifierä¸­æœ‰ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•getMediaPlayerService()æ¥è·å–MediaPlayerServiceï¼Œå…¶å…³ç³»åˆ°MediaPlayerå’ŒMediaPlayerServiceä¹‹é—´çš„é€šä¿¡ã€‚</p><h5 id="2-1-4ã€setDataSource-è®¾ç½®æ’­æ”¾èµ„æº"><a href="#2-1-4ã€setDataSource-è®¾ç½®æ’­æ”¾èµ„æº" class="headerlink" title="2.1.4ã€setDataSource()è®¾ç½®æ’­æ”¾èµ„æº"></a>2.1.4ã€setDataSource()è®¾ç½®æ’­æ”¾èµ„æº</h5><p>åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„è¿›ç¨‹ä¸­ï¼ŒMediaplayer.cpp ä¸­ setDataSourceä¼šä»service managerä¸­è·å¾—mediaPlayerService æœåŠ¡ï¼Œç„¶åé€šè¿‡æœåŠ¡æ¥åˆ›å»ºplayerï¼Œè¿™ä¸ªplayerå°±æ˜¯æ’­æ”¾å™¨çš„çœŸå®å®ä¾‹ï¼ŒåŒæ—¶ä¹Ÿä½¿MediaPlayerå’ŒMediaPlayerServiceå»ºç«‹äº†è”ç³»ã€‚<br>åœ¨javaå±‚MediaPlayer.javaä¸­çš„setDataSourceæœ€ç»ˆä¼šè°ƒç”¨_setDataSourceæ–¹æ³•ï¼Œå¯¹åº”nativeå±‚MediaPlayer.cppä¸­çš„setDataSourceæ–¹æ³•ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-08-mp_setDataSource.png" alt="Alt text"></p><p>é€šè¿‡ getMediaPlayerService å¾—åˆ°çš„BpMediaPlayerServiceç±»å‹çš„serviceï¼Œå’ŒmediaPlayerServiceè¿›ç¨‹ä¸­çš„BnMediaPlayerService ç›¸å¯¹åº”è´Ÿè´£binderé€šè®¯ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-09-MediaPlayerService_Create.png" alt="Alt text"></p><p>åœ¨createå‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªMediaPlayerService::Clientçš„å®ä¾‹ï¼Œæ˜¯MediaPlayerServiceçš„å†…éƒ¨ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´MediaPlayerServiceä¼šä¸ºæ¯ä¸ªclientåº”ç”¨è¿›ç¨‹åˆ›å»ºä¸€ä¸ªç›¸åº”çš„MediaPlayerService::Clientçš„å®ä¾‹ï¼Œæ¥å®ç°æ’­æ”¾ä»¥åŠæ’­æ”¾è¿‡ç¨‹çš„æ§åˆ¶ï¼Œå‘MediaPlayerå‘äº‹ä»¶é€šçŸ¥ã€‚åˆ°è¿™é‡Œï¼Œåœ¨Serverç«¯çš„å¯¹è±¡å°±åˆ›å»ºå®Œæˆäº†ã€‚</p><p>ç„¶ååœ¨MediaPlayer.cppä¸­å°±å¾—åˆ°äº†ä¸€ä¸ªseverç«¯çš„playerå®ä¾‹ï¼Œå®ƒå’Œæœ¬åœ°å…¶ä»–ç±»çš„å®ä¾‹æ²¡ä»€ä¹ˆç”¨æ³•ä¸Šçš„åŒºåˆ«ï¼Œè€Œå®é™…ä¸Šåˆ™æ˜¯é€šè¿‡binderæœºåˆ¶è¿è¡Œåœ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ã€‚è·å¾—æ­¤å®ä¾‹åç»§ç»­player-&gt;setDataSourceæ“ä½œã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-10-player-setDataSource.png" alt="Alt text"></p><p>å°ç»“ï¼š<br>Javaåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨MediaPlayer.javaçš„setDataSource()ä¼šä¼ é€’åˆ°Nativeå±‚ä¸­MediaPlayer.cppçš„setDataSource()å»æ‰§è¡Œï¼Œè€ŒMediaPlayer.cppåˆä¼šæŠŠè¿™ä¸ªæ–¹æ³•äº¤ç»™MediaPlayerserviceå»æ‰§è¡Œã€‚MediaPlayerServiceåˆ™æ˜¯ä½¿ç”¨NuPlayerå®ç°çš„ï¼Œæœ€åï¼Œ setDataSourceè¿˜æ˜¯äº¤ç»™äº†NuPlayerå»æ‰§è¡Œäº†ã€‚è¿™ä¸ªè¿‡ç¨‹æŠŠMediaPlayerå’ŒMediaPlayerServiceä¹‹é—´çš„è”ç³»å»ºç«‹èµ·æ¥ï¼ŒåŒæ—¶åˆæŠŠMediaPlayerServiceå’ŒNuPlayerçš„å…³ç³»å»ºç«‹äº†èµ·æ¥ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-11-GenericSource-setDataSource.png" alt="Alt text"></p><h5 id="2-1-5ã€setDisplay"><a href="#2-1-5ã€setDisplay" class="headerlink" title="2.1.5ã€setDisplay()"></a>2.1.5ã€setDisplay()</h5><p>ä¸‹ä¸€æ­¥å°±æ˜¯javaå±‚çš„setDisplayï¼Œä¾ç„¶æŸ¥çœ‹javaå±‚MediaPlayerï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\java\android\media\MediaPlayer.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplay</span><span class="params">(SurfaceHolder sh)</span> </span>&#123;</span><br><span class="line">        mSurfaceHolder = sh;</span><br><span class="line">        Surface surface;</span><br><span class="line">        <span class="keyword">if</span> (sh != null) &#123;</span><br><span class="line">            surface = sh.getSurface();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            surface = null;</span><br><span class="line">        &#125;</span><br><span class="line">        _setVideoSurface(surface);</span><br><span class="line">        updateSurfaceScreenOn();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¼šè°ƒç”¨æœ¬åœ°æ–¹æ³•_setVideoSurfaceï¼Œæˆ‘ä»¬ç»§ç»­æ‰¾åˆ°å®ƒçš„jniå®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\media\jni\android_media_MediaPlayer.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_media_MediaPlayer_setVideoSurface</span><span class="params">(JNIEnv *env, jobject thiz, jobject jsurface)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setVideoSurface(env, thiz, jsurface, <span class="literal">true</span> <span class="comment">/* mediaPlayerMustBeAlive */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setVideoSurface</span><span class="params">(JNIEnv *env, jobject thiz, jobject jsurface, jboolean mediaPlayerMustBeAlive)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;MediaPlayer&gt; mp = getMediaPlayer(env, thiz);<span class="comment">//è·å–C++çš„MediaPlayer</span></span><br><span class="line">    <span class="keyword">if</span> (mp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mediaPlayerMustBeAlive) &#123;</span><br><span class="line">            jniThrowException(env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//å°†æ—§çš„IGraphicBufferProducerçš„å¼ºå¼•ç”¨å‡ä¸€</span></span><br><span class="line">    decVideoSurfaceRef(env, thiz);</span><br><span class="line">	<span class="comment">//IGraphicBufferProducerå›¾å±‚ç¼“å†²åŒºåˆæˆå™¨</span></span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; new_st;</span><br><span class="line">    <span class="keyword">if</span> (jsurface) &#123;</span><br><span class="line">	    <span class="comment">//å¾—åˆ°javaå±‚çš„surface</span></span><br><span class="line">        sp&lt;Surface&gt; surface(android_view_Surface_getSurface(env, jsurface));</span><br><span class="line">        <span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">	        <span class="comment">//è·å–IGraphicBufferProducer</span></span><br><span class="line">            new_st = surface-&gt;getIGraphicBufferProducer();</span><br><span class="line">            <span class="keyword">if</span> (new_st == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                jniThrowException(env, <span class="string">"java/lang/IllegalArgumentException"</span>,</span><br><span class="line">                    <span class="string">"The surface does not have a binding SurfaceTexture!"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¢åŠ IGraphicBufferProducerçš„å¼ºå¼•ç”¨+1</span></span><br><span class="line">            new_st-&gt;incStrong((<span class="keyword">void</span>*)decVideoSurfaceRef);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            jniThrowException(env, <span class="string">"java/lang/IllegalArgumentException"</span>,</span><br><span class="line">                    <span class="string">"The surface has been released"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//ä¸Šé¢æˆ‘ä»¬åœ¨native_initæ–¹æ³•ä¸­å°†javaå±‚mNativeSurfaceTextureæŸ¥æ‰¾ç»™äº†jniå±‚ï¼Œæ­£å¥½ï¼Œåœ¨è¿™é‡Œå°†IGraphicBufferProducerèµ‹ç»™å®ƒ</span></span><br><span class="line">    env-&gt;SetLongField(thiz, fields.surface_texture, (jlong)new_st.get());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This will fail if the media player has not been initialized yet. This</span></span><br><span class="line">    <span class="comment">// can be the case if setDisplay() on MediaPlayer.java has been called</span></span><br><span class="line">    <span class="comment">// before setDataSource(). The redundant call to setVideoSurfaceTexture()</span></span><br><span class="line">    <span class="comment">// in prepare/prepareAsync covers for this case.</span></span><br><span class="line">    <span class="comment">//å¦‚æœMediaPlayeræ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿™ä¸€æ­¥ä¼šå¤±è´¥ã€‚åŸå› å¯èƒ½æ˜¯setDisplayåœ¨setDataSourceä¹‹å‰ã€‚å¦‚æœåœ¨prepare/prepareAsync æ—¶æƒ³è§„é¿è¿™ä¸ªé”™è¯¯è€Œå»è°ƒç”¨setVideoSurfaceTextureæ˜¯å¤šä½™çš„ã€‚</span></span><br><span class="line">    <span class="comment">//æœ€ç»ˆä¼šè°ƒç”¨C++å±‚çš„setVideoSurfaceTextureæ–¹æ³•ï¼Œä¸‹ä¸€èŠ‚åœ¨åˆ†æ</span></span><br><span class="line">    mp-&gt;setVideoSurfaceTexture(new_st);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å°†æ—§çš„IGraphicBufferProducerçš„å¼ºå¼•ç”¨å‡ä¸€</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decVideoSurfaceRef</span><span class="params">(JNIEnv *env, jobject thiz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;MediaPlayer&gt; mp = getMediaPlayer(env, thiz);</span><br><span class="line">    <span class="keyword">if</span> (mp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; old_st = getVideoSurfaceTexture(env, thiz);</span><br><span class="line">    <span class="keyword">if</span> (old_st != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        old_st-&gt;decStrong((<span class="keyword">void</span>*)decVideoSurfaceRef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯å¯¹å›¾åƒæ˜¾ç¤ºçš„surfaceçš„ä¿å­˜ï¼Œç„¶åå°†æ—§çš„IGraphicBufferProducerå¼ºå¼•ç”¨å‡ä¸€ï¼Œå†è·å¾—æ–°çš„IGraphicBufferProducerï¼Œæœ€åä¼šè°ƒç”¨C++çš„MediaPlayerçš„setVideoSurfaceTextureå°†å®ƒæŠ˜çº¸è¿›å»ã€‚</p><p>IGraphicBufferProduceræ˜¯SurfaceFlingerçš„å†…å®¹ï¼Œä¸€ä¸ªUIå®Œå…¨æ˜¾ç¤ºåˆ°diplayçš„è¿‡ç¨‹ï¼ŒSurfaceFlingeræ‰®æ¼”ç€é‡è¦çš„è§’è‰²ä½†æ˜¯å®ƒçš„èŒè´£æ˜¯â€œFlingerâ€ï¼Œå³æŠŠç³»ç»Ÿä¸­æ‰€æœ‰åº”ç”¨ç¨‹åºçš„æœ€ç»ˆçš„â€œç»˜å›¾ç»“æœâ€è¿›è¡Œâ€œæ··åˆâ€ï¼Œç„¶åç»Ÿä¸€æ˜¾ç¤ºåˆ°ç‰©ç†å±å¹•ä¸Šï¼Œè€Œå…¶ä»–æ–¹é¢æ¯”å¦‚å„ä¸ªç¨‹åºçš„ç»˜ç”»è¿‡ç¨‹ï¼Œå°±ç”±å…¶ä»–ä¸œè¥¿æ¥æ‹…ä»»äº†ã€‚è¿™ä¸ªå…‰è£çš„ä»»åŠ¡è‡ªç„¶è€Œç„¶åœ°è½åœ¨äº†BufferQueueçš„è‚©è†€ä¸Šï¼Œå®ƒæ˜¯æ¯ä¸ªåº”ç”¨ç¨‹åºâ€œä¸€å¯¹ä¸€â€çš„è¾…å¯¼è€å¸ˆï¼ŒæŒ‡å¯¼ç€UIç¨‹åºçš„â€œç”»æ¿ç”³è¯·â€ã€â€œä½œç”»æµç¨‹â€ç­‰ä¸€ç³»åˆ—ç»†èŠ‚ã€‚ä¸‹é¢çš„å›¾æè¿°äº†è¿™ä¸‰è€…çš„å…³ç³»ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-12-IGraphicBufferProducer.png" alt="Alt text"></p><p>è™½è¯´æ˜¯ä¸‰è€…çš„å…³ç³»ï¼Œä½†æ˜¯ä»–ä»¬æ‰€å±çš„å±‚å´åªæœ‰ä¸¤ä¸ªï¼Œappå±äºJavaå±‚ï¼ŒBufferQueue/SurfaceFlingerå±äºnativeå±‚ã€‚ä¹Ÿå°±æ˜¯è¯´BufferQueueä¹Ÿæ˜¯éš¶å±SurfaceFlingerï¼Œæ‰€æœ‰å·¥ä½œå›´ç»•SurfaceFlingerå±•å¼€ã€‚<br>è¿™é‡ŒIGraphicBufferProducerå°±æ˜¯appå’ŒBufferQueueé‡è¦æ¡¥æ¢ï¼ŒGraphicBufferProduceræ‰¿æ‹…ç€å•ä¸ªåº”ç”¨è¿›ç¨‹ä¸­çš„UIæ˜¾ç¤ºéœ€æ±‚ï¼Œä¸BufferQueueæ‰“äº¤é“çš„å°±æ˜¯å®ƒã€‚</p><h5 id="2-1-6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹"><a href="#2-1-6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹" class="headerlink" title="2.1.6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹"></a>2.1.6ã€æ’­æ”¾å™¨åŸºæœ¬æ¨¡å‹</h5><p>NuPlayerä¸ç®¡æœ‰å¤šä¹ˆç¥ç§˜ï¼Œè¯´åˆ°åº•è¿˜æ˜¯ä¸ªæ’­æ”¾å™¨ã€‚åœ¨æ’­æ”¾å™¨çš„åŸºæœ¬æ¨¡å‹ä¸Šï¼Œä»–ä¸VCLã€mplayerã€ffmpegç­‰å¼€æºçš„ç»“æ„æ˜¯ä¸€è‡´çš„ã€‚åªæ˜¯ç»„ç»‡å®ç°çš„æ–¹å¼ä¸åŒã€‚<br>æ·±å…¥äº†è§£NuPlayerä¹‹å‰ï¼ŒæŠŠæ’­æ”¾å™¨çš„åŸºæœ¬æ¨¡å‹æ€»ç»“ä¸€ä¸‹ï¼Œç„¶åæŒ‰ç…§æ¨¡å‹çš„å„ä¸ªéƒ¨åˆ†æ¥æ·±å…¥ç ”ç©¶NuPlayerçš„å®ç°æ–¹å¼ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-13-source-demux-decoder-output.jpg" alt="Alt text"></p><p>â˜¯ datasourceæ•°æ®æºï¼šæ•°æ®æºï¼Œæ•°æ®çš„æ¥æºä¸ä¸€å®šéƒ½æ˜¯æœ¬åœ°fileï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç½‘è·¯ä¸Šçš„å„ç§åè®®ä¾‹å¦‚ï¼šhttpã€rtspã€HLSç­‰ã€‚sourceçš„ä»»åŠ¡å°±æ˜¯æŠŠæ•°æ®æºæŠ½è±¡å‡ºæ¥ï¼Œä¸ºä¸‹ä¸€ä¸ªdemuxæ¨¡å—æä¾›å®ƒéœ€è¦çš„ç¨³å®šçš„æ•°æ®æµã€‚demuxä¸ç”¨å…³ä¿¡æ•°æ®åˆ°åº•æ˜¯ä»ä»€ä¹ˆåœ°æ–¹æ¥çš„ã€‚</p><p>â˜¯ demuxerè§£å¤ç”¨ï¼šè§†é¢‘æ–‡ä»¶ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯æŠŠéŸ³è§†é¢‘çš„ESæµäº¤ç»‡çš„é€šè¿‡æŸç§è§„åˆ™æ”¾åœ¨ä¸€èµ·ã€‚è¿™ç§è§„åˆ™å°±æ˜¯å®¹å™¨è§„åˆ™ã€‚ç°åœ¨æœ‰å¾ˆå¤šä¸åŒçš„å®¹å™¨æ ¼å¼ã€‚å¦‚tsã€mp4ã€flvã€mkvã€aviã€rmvbç­‰ç­‰ã€‚demuxçš„åŠŸèƒ½å°±æ˜¯æŠŠéŸ³è§†é¢‘çš„ESæµä»å®¹å™¨ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œç„¶ååˆ†åˆ«é€åˆ°ä¸åŒçš„è§£ç å™¨ä¸­ã€‚å…¶å®éŸ³é¢‘å’Œè§†é¢‘æœ¬èº«å°±æ˜¯2ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿã€‚å®¹å™¨æŠŠå®ƒä»¬åŒ…åœ¨äº†ä¸€èµ·ã€‚ä½†æ˜¯ä»–ä»¬éƒ½æ˜¯ç‹¬ç«‹è§£ç çš„ï¼Œæ‰€ä»¥è§£ç ä¹‹å‰ï¼Œéœ€è¦æŠŠå®ƒåˆ†åˆ« ç‹¬ç«‹å‡ºæ¥ã€‚demuxå°±æ˜¯å¹²è¿™æ´»çš„ï¼Œä»–ä¸ºä¸‹ä¸€æ­¥decoderè§£ç æä¾›äº†æ•°æ®æµã€‚</p><p>â˜¯ decoderè§£ç ï¼šè§£ç å™¨â€”-æ’­æ”¾å™¨çš„æ ¸å¿ƒæ¨¡å—ã€‚åˆ†ä¸ºéŸ³é¢‘å’Œè§†é¢‘è§£ç å™¨ã€‚å½±åƒåœ¨å½•åˆ¶å, åŸå§‹çš„éŸ³è§†é¢‘éƒ½æ˜¯å ç”¨å¤§é‡ç©ºé—´, è€Œä¸”æ˜¯å†—ä½™åº¦è¾ƒé«˜çš„æ•°æ®. å› æ­¤, é€šå¸¸ä¼šåœ¨åˆ¶ä½œçš„æ—¶å€™å°±ä¼šè¿›è¡ŒæŸç§å‹ç¼© ( å‹ç¼©æŠ€æœ¯å°±æ˜¯å°†æ•°æ®ä¸­çš„å†—ä½™ä¿¡æ¯å»é™¤æ•°æ®ä¹‹é—´çš„ç›¸å…³æ€§ ). è¿™å°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„éŸ³è§†é¢‘ç¼–ç æ ¼å¼, åŒ…æ‹¬MPEG1ï¼ˆVCDï¼‰\ MPEG2ï¼ˆDVDï¼‰\ MPEG4 \ H.264 ç­‰ç­‰. éŸ³è§†é¢‘è§£ç å™¨çš„ä½œç”¨å°±æ˜¯æŠŠè¿™äº›å‹ç¼©äº†çš„æ•°æ®è¿˜åŸæˆåŸå§‹çš„éŸ³è§†é¢‘æ•°æ®. å½“ç„¶, ç¼–ç è§£ç è¿‡ç¨‹åŸºæœ¬ä¸Šéƒ½æ˜¯æœ‰æŸçš„ .è§£ç å™¨çš„ä½œç”¨å°±æ˜¯æŠŠç¼–ç åçš„æ•°æ®è¿˜åŸæˆåŸå§‹æ•°æ®ã€‚</p><p>â˜¯ outputè¾“å‡ºï¼šè¾“å‡ºéƒ¨åˆ†åˆ†ä¸ºéŸ³é¢‘å’Œè§†é¢‘è¾“å‡ºã€‚è§£ç åçš„éŸ³é¢‘ï¼ˆpcmï¼‰å’Œè§†é¢‘ï¼ˆyuvï¼‰çš„åŸå§‹æ•°æ®éœ€è¦å¾—åˆ°éŸ³è§†é¢‘çš„outputæ¨¡å—çš„æ”¯æŒæ‰èƒ½çœŸæ­£çš„è®©äººçš„æ„Ÿå®˜ç³»ç»Ÿï¼ˆçœ¼å’Œè€³ï¼‰è¾¨è¯†åˆ°ã€‚</p><p>æ‰€ä»¥ï¼Œæ’­æ”¾å™¨å¤§è‡´åˆ†æˆä¸Šè¿°4éƒ¨åˆ†ã€‚æ€ä¹ˆæŠ½è±¡çš„å®ç°è¿™4å¤§éƒ¨åˆ†ã€ä»¥åŠæ‰¾åˆ°ä¸€ç§åˆç†çš„æ–¹å¼å°†è¿™å‡ éƒ¨åˆ†ç»„ç»‡å¹¶è¿åŠ¨èµ·æ¥ã€‚æ˜¯æ¯ä¸ªæ’­æ”¾å™¨ä¸åŒçš„å®ç°æ–¹å¼è€Œå·²ã€‚æ¥ä¸‹æ¥å°±å›´ç»•è¿™4å¤§éƒ¨åˆ†åšæ·±å…¥å­¦ä¹ ï¼Œçœ‹çœ‹NuPlayerçš„å·¥ä½œåŸç†ã€‚</p><h5 id="2-2ã€NuPlayeråˆ†æ"><a href="#2-2ã€NuPlayeråˆ†æ" class="headerlink" title="2.2ã€NuPlayeråˆ†æ"></a>2.2ã€NuPlayeråˆ†æ</h5><h5 id="2-2-0ã€NuPlayerç®€ä»‹"><a href="#2-2-0ã€NuPlayerç®€ä»‹" class="headerlink" title="2.2.0ã€NuPlayerç®€ä»‹"></a>2.2.0ã€NuPlayerç®€ä»‹</h5><p>Android2.3æ—¶å¼•å…¥æµåª’ä½“æ¡†æ¶ï¼Œè€Œæµåª’ä½“æ¡†æ¶çš„æ ¸å¿ƒæ˜¯NuPlayerã€‚åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¸€èˆ¬è®¤ä¸ºLocal Playbackå°±ç”¨Stagefrightplayer+Awesomeplayerï¼Œæµåª’ä½“ç”¨NuPlayerã€‚Android4.0ä¹‹åHttpLiveå’ŒRTSPåè®®å¼€å§‹ä½¿ç”¨NuPlayeræ’­æ”¾å™¨ï¼ŒAndroid5.0ï¼ˆLç‰ˆæœ¬ï¼‰ä¹‹åæœ¬åœ°æ’­æ”¾ä¹Ÿå¼€å§‹ä½¿ç”¨NuPlayeræ’­æ”¾å™¨ã€‚ Android7.0(Nç‰ˆæœ¬)åˆ™å®Œå…¨å»æ‰äº†Awesomeplayerã€‚<br>é€šä¿—ç‚¹è¯´ï¼ŒNuPlayeræ˜¯AOSPä¸­æä¾›çš„å¤šåª’ä½“æ’­æ”¾æ¡†æ¶ï¼Œèƒ½å¤Ÿæ”¯æŒæœ¬åœ°æ–‡ä»¶ã€HTTPï¼ˆHLSï¼‰ã€RTSPç­‰åè®®çš„æ’­æ”¾ï¼Œé€šå¸¸æ”¯æŒH.264ã€H.265/HEVCã€AACç¼–ç æ ¼å¼ï¼Œæ”¯æŒMP4ã€MPEG-TSå°è£…ã€‚<br>åœ¨å®ç°ä¸ŠNuPlayerå’ŒAwesomeplayerä¸åŒï¼ŒNuPlayeråŸºäºStagefrightPlayerçš„åŸºç¡€ç±»æ„å»ºï¼Œåˆ©ç”¨äº†æ›´åº•å±‚çš„ALooper/AHandleræœºåˆ¶æ¥å¼‚æ­¥åœ°å¤„ç†è¯·æ±‚ï¼ŒALooperåˆ—é˜Ÿæ¶ˆæ¯è¯·æ±‚ï¼ŒAHandlerä¸­å»å¤„ç†ï¼Œæ‰€ä»¥æœ‰æ›´å°‘çš„Mutex/Lockåœ¨NuPlayerä¸­ã€‚Awesomeplayerä¸­åˆ©ç”¨äº†omxcodecè€ŒNuPlayerä¸­åˆ©ç”¨äº†Acodecã€‚</p><h5 id="2-2-1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾"><a href="#2-2-1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾" class="headerlink" title="2.2.1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾"></a>2.2.1ã€NuPlayeræ•´ä½“ç±»å…³ç³»å›¾</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-14-NuPlayer-arc.jpg" alt="Alt text"></p><p>NuPlayerç”±NuPlayerDriverå°è£…ï¼Œåˆ©ç”¨äº†åº•å±‚çš„ALooper/AHandleræœºåˆ¶æ¥å¼‚æ­¥åœ°å¤„ç†è¯·æ±‚ï¼ŒALooperä¿å­˜æ¶ˆæ¯è¯·æ±‚ï¼Œç„¶ååœ¨AHandlerä¸­å¤„ç†ã€‚å¦å¤–ï¼ŒNuPlayerä¸­åˆ©ç”¨åˆ°äº†Acodecã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-15-NuPlayer-class.jpg" alt="Alt text"></p><p>â˜¯ NuPlayer::Source<br>è§£ææ¨¡å—ï¼ˆparserï¼ŒåŠŸèƒ½ç±»ä¼¼FFmpegçš„avformatï¼‰ã€‚å…¶æ¥å£ä¸MediaExtractorå’Œ<br>MediaSourceç»„åˆçš„æ¥å£å·®ä¸å¤šï¼ŒåŒæ—¶æä¾›äº†ç”¨äºå¿«é€Ÿå®šä½çš„seekToæ¥å£ã€‚</p><p>â˜¯ NuPlayer::Decoder<br>è§£ç æ¨¡å—ï¼ˆdecoderï¼ŒåŠŸèƒ½ç±»ä¼¼FFmpegçš„avcodecï¼‰ï¼Œå°è£…äº†ç”¨äºAVCã€AACè§£ç çš„æ¥å£ï¼Œ<br>é€šè¿‡ACodecå®ç°è§£ç ï¼ˆåŒ…å«OMXç¡¬è§£ç å’Œè½¯è§£ç ï¼‰ã€‚</p><p>â˜¯ NuPlayer::Render<br>æ¸²æŸ“æ¨¡å—ï¼ˆrenderï¼ŒåŠŸèƒ½ç±»ä¼¼å£°å¡é©±åŠ¨å’Œæ˜¾å¡é©±åŠ¨ï¼‰ï¼Œä¸»è¦ç”¨äºéŸ³è§†é¢‘æ¸²æŸ“å’ŒåŒæ­¥ï¼Œä¸<br>NativeWindowæœ‰å…³ã€‚</p><p>â˜¯ NuPlayer æ˜¯æ’­æ”¾æ¡†æ¶ä¸­è¿æ¥Sourceã€Decoderã€Rendererçš„çº½å¸¦</p><p>â˜¯ NuPlayerDriver<br>ä½œä¸ºNuPlayerç±»çš„å°è£…ï¼Œç›´æ¥è°ƒç”¨NuPlayerã€‚</p><p>NuPlayeræ¡†æ¶ä¸­æœ€é¡¶å±‚çš„ç±»æ˜¯NuPlayerDriverï¼Œç»§æ‰¿è‡ªMediaPlayerInterfaceï¼Œä¸»è¦æä¾›ä¸€ä¸ªçŠ¶æ€è½¬æ¢æœºåˆ¶ï¼Œä½œä¸ºNuPlayerç±»çš„Wrapperã€‚NuPlayerDriverç±»ä¸­æœ€é‡è¦çš„æˆå‘˜æ˜¯ä»¥ä¸‹å‡ ä¸ªï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; State mState æ’­æ”¾å™¨çŠ¶ä½“æ ‡å¿— </span><br><span class="line">&gt; sp &lt;ALooper&gt; mLooper å†…éƒ¨æ¶ˆæ¯é©±åŠ¨æœºåˆ¶ </span><br><span class="line">&gt; sp &lt;NuPlayer&gt;  mPlayer çœŸæ­£å®Œæˆæ’­æ”¾å™¨çš„ç±»</span><br></pre></td></tr></table></figure><p>NuPlayerDriverä¸»è¦æ˜¯ æ„é€ å‡½æ•°-&gt; setDataSource -&gt; SetVideoSurfaceTexture-&gt; prepare/prepareAsync -&gt; start-&gt; stop-&gt; reset-&gt; ææ„å‡½æ•°ï¼Œå®é™…éœ€æ±‚pauseã€isPlayingã€getDurationã€getCurrentPositionã€setLoopingã€seekToç­‰æ–¹æ³•</p><h5 id="2-2-2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹"><a href="#2-2-2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹" class="headerlink" title="2.2.2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹"></a>2.2.2ã€NuPlayeræ¡†æ¶éœ€è¦å…³æ³¨çŸ¥è¯†ç‚¹</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NuPlayerçš„æ¡†æ¶ï¼Œå…¶å†…éƒ¨å®ç°é€»è¾‘ã€‚é‚£ä¹ˆæœ€ç»ˆå°±è½å®åˆ°å¦‚ä½•ä»ä¸€ä¸ªç±»ä¸­æå–å‡ºéœ€è¦çš„æ¡†æ¶åŠçŸ¥è¯†ç‚¹ã€‚é‚£ä¹ˆä¸€ä¸ªç±»çš„å¯¹å¤–æ¥å£éƒ¨åˆ†é€šå¸¸åŒ…æ‹¬ï¼š</span><br><span class="line">--- æ„é€ å‡½æ•°å’Œææ„å‡½æ•°</span><br><span class="line">--- å¿…é¡»è°ƒç”¨çš„æ¥å£</span><br><span class="line">--- å¯é€‰çš„è°ƒç”¨æ¥å£</span><br><span class="line"></span><br><span class="line">åœ¨å¤šåª’ä½“æ’­æ”¾ä¸­ï¼Œé€šè¿‡å…³æ³¨çš„ç‚¹æœ‰ï¼š</span><br><span class="line">--- å¦‚ä½•å®ç°è§£å¤ç”¨ï¼Œå¾—åˆ°éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ç­‰æ•°æ®</span><br><span class="line">--- å¦‚ä½•å®ç°è§£ç </span><br><span class="line">--- å¦‚ä½•å®ç°éŸ³è§†é¢‘åŒæ­¥</span><br><span class="line">--- å¦‚ä½•æ¸²æŸ“è§†é¢‘</span><br><span class="line">--- å¦‚ä½•æ’­æ”¾éŸ³é¢‘</span><br><span class="line">--- å¦‚ä½•å®ç°å¿«é€Ÿå®šä½</span><br></pre></td></tr></table></figure><h4 id="ä¸‰-ã€Android-MediaPlayeræ¡†æ¶åˆ†æ-AHandler-AMessage-ALooper"><a href="#ä¸‰-ã€Android-MediaPlayeræ¡†æ¶åˆ†æ-AHandler-AMessage-ALooper" class="headerlink" title="(ä¸‰)ã€Android MediaPlayeræ¡†æ¶åˆ†æ - AHandler AMessage ALooper"></a>(ä¸‰)ã€Android MediaPlayeræ¡†æ¶åˆ†æ - AHandler AMessage ALooper</h4><p>å‰æ–‡ä¸­æåˆ°è¿‡NuPlayeråŸºäºStagefrightPlayerçš„åŸºç¡€ç±»æ„å»ºï¼Œåˆ©ç”¨äº†æ›´åº•å±‚çš„ALooper/AHandleræœºåˆ¶æ¥<strong>å¼‚æ­¥åœ°å¤„ç†è¯·æ±‚</strong>ï¼ŒALooperä¿å­˜æ¶ˆæ¯è¯·æ±‚ï¼Œç„¶åè°ƒç”¨AHandleræ¥å£å»å¤„ç†ã€‚<br>å®é™…ä¸Šåœ¨ä»£ç ä¸­NuPlayeræœ¬èº«ç»§æ‰¿è‡ªAHandlerç±»ï¼Œè€ŒALooperå¯¹è±¡ä¿å­˜åœ¨NuPlayerDriverä¸­ã€‚<br>ALooper/AHandleræœºåˆ¶æ˜¯æ¨¡æ‹Ÿçš„æ¶ˆæ¯å¾ªç¯å¤„ç†æ–¹å¼ï¼Œé€šå¸¸æœ‰ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼šæ¶ˆæ¯ï¼ˆmessageï¼Œé€šå¸¸åŒ…å«Handlerï¼‰ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆqueueï¼‰ã€æ¶ˆæ¯å¤„ç†çº¿ç¨‹ï¼ˆlooper threadï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/01-16-AHandler-ALooper-AMessage.png" alt="Alt text"></p><p>å¯¹äºhandleræ¶ˆæ¯æœºåˆ¶ï¼Œæ„æˆå°±å¿…é¡»åŒ…æ‹¬ä¸€ä¸ªLoopï¼Œmessageã€‚é‚£ä¹ˆå¯¹åº”çš„AHandlerï¼Œä¹Ÿåº”è¯¥æœ‰å¯¹åº”çš„ALooperã€AMessageã€‚<br>å› æ­¤æœ¬å°èŠ‚ä¸»è¦æ¶‰åŠåˆ°ä¸‰ä¸ªç±»ALooperã€AHandlerã€AMessageã€‚</p><h5 id="3-1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰"><a href="#3-1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰" class="headerlink" title="3.1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰"></a>3.1ã€AHandleræ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†ç±»ï¼‰</h5><p>ä¸‹é¢ä»£ç æ˜¯AHandleræ¥å£:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"./frameworks/av/include/media/stagefright/AHandler.h"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AHandler</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">    AHandler();</span><br><span class="line"></span><br><span class="line">    ALooper::<span class="function">handler_id <span class="title">id</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    sp&lt;ALooper&gt; looper() <span class="keyword">const</span>;</span><br><span class="line">    wp&lt;ALooper&gt; getLooper() <span class="keyword">const</span>;</span><br><span class="line">    wp&lt;AHandler&gt; getHandler() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onMessageReceived</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">AMessage</span>;</span>      <span class="comment">// deliverMessage()</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">ALooperRoster</span>;</span> <span class="comment">// setID()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> mMessageCounter;</span><br><span class="line">    KeyedVector&lt;<span class="keyword">uint32_t</span>, <span class="keyword">uint32_t</span>&gt; mMessages;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setID</span><span class="params">(ALooper::handler_id id, wp&lt;ALooper&gt; looper)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deliverMessage</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šé¢æ¥å£ï¼Œåˆæ­¥å°è±¡æ˜¯AHandleræ²¡æœ‰ç›´æ¥å¯¹å¤–çš„æ¥å£ï¼ˆåªæœ‰è·å–æˆå‘˜å˜é‡çš„æ¥å£ï¼‰ï¼ŒåŸºæœ¬ä¸Šåªæœ‰ä¸€ä¸ªonMessageReceivedç”¨äºå­ç±»ç»§æ‰¿ï¼ŒdeliverMessageç”¨äºç»™ç±»AMessageä½¿ç”¨ï¼ŒsetIDç”¨äºç»™å‹å…ƒç±»ALooperRosterä½¿ç”¨ã€‚ä»è¿™ç‚¹æ¥è¯´ï¼ŒçœŸæ­£ä»£ç åº”è¯¥åœ¨AMessageé‡Œè¾¹ã€‚</p><h5 id="3-2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰"><a href="#3-2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰" class="headerlink" title="3.2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰"></a>3.2ã€AMessageæ¥å£åˆ†æï¼ˆæ¶ˆæ¯è½½ä½“ï¼‰</h5><p>ä¸‹é¢ä»£ç æ˜¯AMessageçš„å£°æ˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"./frameworks/av/include/media/stagefright/AMessage.h"</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AMessage</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">    AMessage();</span><br><span class="line">    AMessage(<span class="keyword">uint32_t</span> what, <span class="keyword">const</span> sp&lt;<span class="keyword">const</span> AHandler&gt; &amp;handler); <span class="comment">// ä»£ç ä¸­å¸¸ç”¨çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">static</span> sp&lt;AMessage&gt; FromParcel(<span class="keyword">const</span> Parcel &amp;parcel, <span class="keyword">size_t</span> maxNestingLevel = <span class="number">255</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write this AMessage to a parcel.</span></span><br><span class="line">    <span class="comment">// All items in the AMessage must have types that are recognized by</span></span><br><span class="line">    <span class="comment">// FromParcel(); otherwise, TRESPASS error will occur.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel *parcel)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setWhat</span><span class="params">(<span class="keyword">uint32_t</span> what)</span></span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> what() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™æ˜¯ä¸€ä¸ªAHandlerï¼Œé€šè¿‡è¿™ä¸ªå¯ä»¥è·å¾—ALooperå¯¹è±¡å¼•ç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTarget</span><span class="params">(<span class="keyword">const</span> sp&lt;<span class="keyword">const</span> AHandler&gt; &amp;handler)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤æ‰€æœ‰è®¾ç½®çš„æ¶ˆæ¯å±æ€§å‚æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸€ç³»åˆ—è®¾ç½®/è·å– Message å±æ€§çš„å‡½æ•°ã€‚ã€‚ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> setInt32/setInt64/setSize/setFloat/setDouble/setPointer/setPointer/setString/setRect/setObject/setBuffer/setMessage(...);</span><br><span class="line">    <span class="keyword">bool</span> findInt32/findInt64/findSize/findFloat/findDouble/findPointer/findString/findObject/findBuffer/findMessage/findRect(...) <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡è¿™ä¸ªå‡½æ•°æ£€ç´¢ä¸‹æŒ‡å®šåç§°çš„æ¶ˆæ¯å±æ€§æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">contains</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ•é€’æ¶ˆæ¯çš„æ¥å£ï¼Œé¡¾åæ€ä¹‰ç›´æ¥æŠ•é€’ç»™æ„é€ å‡½æ•°çš„ALooperï¼Œæ³¨æ„æ”¯æŒå»¶æ—¶æ¶ˆæ¯ï¼Œä½†ä¸æ”¯æŒæå‰æ¶ˆæ¯ï¼ŒdelayUS &gt; 0</span></span><br><span class="line">    <span class="keyword">status_t</span> post(<span class="keyword">int64_t</span> delayUs = <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ•é€’æ¶ˆæ¯å¹¶ç­‰å¾…æ‰§è¡Œç»“æŸåå‘é€responseæ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">status_t</span> postAndAwaitResponse(sp&lt;AMessage&gt; *response);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this returns true, the sender of this message is synchronously</span></span><br><span class="line">    <span class="comment">// awaiting a response and the reply token is consumed from the message</span></span><br><span class="line">    <span class="comment">// and stored into replyID. The reply token must be used to send the response</span></span><br><span class="line">    <span class="comment">// using "postReply" below.</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">senderAwaitsResponse</span><span class="params">(sp&lt;AReplyToken&gt; *replyID)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Posts the message as a response to a reply token.  A reply token can</span></span><br><span class="line">    <span class="comment">// only be used once. Returns OK if the response could be posted; otherwise,</span></span><br><span class="line">    <span class="comment">// an error.</span></span><br><span class="line">    <span class="keyword">status_t</span> postReply(<span class="keyword">const</span> sp&lt;AReplyToken&gt; &amp;replyID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·±æ‹·è´</span></span><br><span class="line">    sp&lt;AMessage&gt; dup() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯”è¾ƒä¸¤ä¸ªæ¶ˆæ¯ï¼Œå¹¶è¿”å›å·®å¼‚</span></span><br><span class="line">    sp&lt;AMessage&gt; changesFrom(<span class="keyword">const</span> sp&lt;<span class="keyword">const</span> AMessage&gt; &amp;other, <span class="keyword">bool</span> deep = <span class="literal">false</span>) <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ¶ˆæ¯å±æ€§å­˜å‚¨çš„ä¸ªæ•°åŠç‰¹å®šç´¢å¼•ä¸Šçš„æ¶ˆæ¯å±æ€§å‚æ•°</span></span><br><span class="line">    <span class="keyword">size_t</span> countEntries() <span class="keyword">const</span>;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">getEntryNameAt</span><span class="params">(<span class="keyword">size_t</span> index, Type *type)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~AMessage();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">ALooper</span>;</span> <span class="comment">// deliver()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> mWhat;</span><br><span class="line"></span><br><span class="line">    wp&lt;AHandler&gt; mHandler;</span><br><span class="line">    wp&lt;ALooper&gt; mLooper;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºALooperè°ƒç”¨çš„ï¼Œå‘é€æ¶ˆæ¯çš„æ¥å£</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deliver</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ¥å£å¯ä»¥çœ‹å‡ºåœ¨ä½¿ç”¨AMessageæ˜¯åªéœ€è¦æŒ‡å®šæ¶ˆæ¯çš„idå’Œè¦å¤„ç†è¯¥æ¶ˆæ¯çš„AHandlerå³å¯ï¼Œå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ï¼Œä¹Ÿå¯ä»¥å•ç‹¬è°ƒç”¨setWhatå’ŒsetTargetæ¥å£ã€‚AMessageæ„é€ å®Œæˆä¹‹åï¼Œå¯ä»¥è°ƒç”¨setXXXè®¾ç½®å¯¹åº”çš„å‚æ•°ï¼Œé€šè¿‡findXXXè·å–ä¼ é€’çš„å‚æ•°ã€‚æœ€åé€šè¿‡postå³å¯å°†æ¶ˆæ¯æŠ•é€’åˆ°AHandlerçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</p><h5 id="3-3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰"><a href="#3-3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰" class="headerlink" title="3.3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰"></a>3.3ã€ALooperæ¥å£åˆ†æï¼ˆæ¶ˆæ¯å¤„ç†å¾ªç¯åŠåå°çº¿ç¨‹ï¼‰</h5><p>å…¶ç®€åŒ–çš„å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"./frameworks/av/include/media/stagefright/ALooper.h"</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ALooper</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">    ALooper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Takes effect in a subsequent call to start().</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setName</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">getName</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">handler_id <span class="title">registerHandler</span><span class="params">(<span class="keyword">const</span> sp&lt;AHandler&gt; &amp;handler)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregisterHandler</span><span class="params">(handler_id handlerID)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> start(<span class="keyword">bool</span> runOnCallingThread = <span class="literal">false</span>,</span><br><span class="line">            <span class="keyword">bool</span> canCallJava = <span class="literal">false</span>, <span class="keyword">int32_t</span> priority = PRIORITY_DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> stop();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> int64_t <span class="title">GetNowUs</span><span class="params">()</span></span>;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~ALooper();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">AMessage</span>;</span>       <span class="comment">// post()</span></span><br><span class="line"></span><br><span class="line">    AString mName;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Event</span> &#123;</span></span><br><span class="line">        <span class="keyword">int64_t</span> mWhenUs;</span><br><span class="line">        sp&lt;AMessage&gt; mMessage;</span><br><span class="line">    &#125;;</span><br><span class="line">    List&lt;Event&gt; mEventQueue;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">LooperThread</span>;</span></span><br><span class="line">    sp&lt;LooperThread&gt; mThread;</span><br><span class="line">    <span class="keyword">bool</span> mRunningLocally;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// START --- methods used only by AMessage</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// posts a message on this looper with the given timeout</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg, <span class="keyword">int64_t</span> delayUs)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// creates a reply token to be used with this looper</span></span><br><span class="line">    sp&lt;AReplyToken&gt; createReplyToken();</span><br><span class="line">    <span class="comment">// waits for a response for the reply token.  If status is OK, the response</span></span><br><span class="line">    <span class="comment">// is stored into the supplied variable.  Otherwise, it is unchanged.</span></span><br><span class="line">    <span class="keyword">status_t</span> awaitResponse(<span class="keyword">const</span> sp&lt;AReplyToken&gt; &amp;replyToken, sp&lt;AMessage&gt; *response);</span><br><span class="line">    <span class="comment">// posts a reply for a reply token.  If the reply could be successfully posted,</span></span><br><span class="line">    <span class="comment">// it returns OK. Otherwise, it returns an error value.</span></span><br><span class="line">    <span class="keyword">status_t</span> postReply(<span class="keyword">const</span> sp&lt;AReplyToken&gt; &amp;replyToken, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// END --- methods used only by AMessage</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">loop</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ALooperå¯¹å¤–æ¥å£æ¯”è¾ƒç®€å•ï¼Œé€šå¸¸å°±æ˜¯NuPlayerDriveræ„é€ å‡½æ•°ä¸­çš„è°ƒç”¨é€»è¾‘ã€‚å…ˆåˆ›å»ºä¸€ä¸ªALooperå¯¹è±¡ï¼Œç„¶åè°ƒç”¨setNameå’Œstartæ¥å£ï¼Œä¹‹åè°ƒç”¨registerHandlerè®¾ç½®ä¸€ä¸ªAHandlerï¼Œè¿™æ ·å°±å®Œæˆäº†åˆå§‹åŒ–ã€‚åœ¨ææ„ä¹‹å‰éœ€è¦è°ƒç”¨stopæ¥å£ã€‚<br>è¿™é‡Œéœ€è¦è¯´æ˜ä¸‹ï¼ŒALooper::startæ¥å£ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶è°ƒç”¨ALooper::loopå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦å®ç°æ¶ˆæ¯çš„å®é™…æ‰§è¡Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ALooper::loop() &#123;</span><br><span class="line">    Event event;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (mThread == <span class="literal">NULL</span> &amp;&amp; !mRunningLocally) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»mEventQueueå–å‡ºæ¶ˆæ¯ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œï¼Œä¸éœ€è¦çš„è¯å°±ç­‰å¾…</span></span><br><span class="line">        <span class="comment">// éœ€è¦çš„è¯å°±è°ƒç”¨handleræ‰§è¡Œï¼Œå¹¶åˆ é™¤å¯¹åº”æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">if</span> (mEventQueue.empty()) &#123;</span><br><span class="line">            mQueueChangedCondition.wait(mLock);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int64_t</span> whenUs = (*mEventQueue.begin()).mWhenUs;</span><br><span class="line">        <span class="keyword">int64_t</span> nowUs = GetNowUs();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (whenUs &gt; nowUs) &#123;</span><br><span class="line">            <span class="keyword">int64_t</span> delayUs = whenUs - nowUs;</span><br><span class="line">            mQueueChangedCondition.waitRelative(mLock, delayUs * <span class="number">1000l</span>l);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        event = *mEventQueue.begin();</span><br><span class="line">        mEventQueue.erase(mEventQueue.begin());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event.mMessage-&gt;deliver();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ¶ˆæ¯æ˜¯é€šè¿‡é‚£ä¸ªå‡½æ•°æ·»åŠ è¿›æ¥çš„å‘¢ï¼Ÿ è¿™å°±æ˜¯å‹å…ƒç±»AMessageçš„ä½œç”¨ï¼Œé€šè¿‡è°ƒç”¨ALooper::postæ¥å£ï¼Œå°†AMessageæ·»åŠ åˆ°mEventQueueä¸­ã€‚</p><h5 id="3-4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹"><a href="#3-4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹" class="headerlink" title="3.4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹"></a>3.4ã€ä¸€ä¸ªè°ƒç”¨å®ä¾‹</h5><p>ä»¥NuPlayer::setVideoSurfaceTextureAsyncä¸ºç¤ºä¾‹åˆ†æä¸‹ALooper/AHandleræœºåˆ¶ã€‚<br>è¿™é‡Œä¸è§£é‡ŠALooperçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒèµ„æ–™Android Nativeå±‚å¼‚æ­¥æ¶ˆæ¯å¤„ç†æ¡†æ¶çš„å†…å®¹ã€‚<br>ä¸‹é¢æ˜¯setVideoSurfaceTextureAsyncçš„ä»£ç ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::setVideoSurfaceTextureAsync(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt; &amp;bufferProducer) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetVideoSurface, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufferProducer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="keyword">new</span> Surface(bufferProducer, <span class="literal">true</span> <span class="comment">/* controlledByApp */</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åŠŸèƒ½å¾ˆç®€å•ï¼Œåˆ›å»ºä¸€ä¸ªAMessageå¯¹è±¡ï¼Œå¹¶è®¾ç½®ä¸‹å‚æ•°ï¼Œå‚æ•°ç±»å‹ä¸ºObjectï¼Œåç§°æ˜¯â€surfaceâ€ï¼Œç„¶åé€šè¿‡AMessage::postæ¥å£ï¼Œé—´æ¥è°ƒç”¨ALooper::postæ¥å£ï¼Œå°†æ¶ˆæ¯å‘é€ç»™ALooper-NuPlayerDriver::mLooperï¼›ALooperçš„æ¶ˆæ¯å¾ªç¯çº¿ç¨‹æ£€æµ‹åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œåœ¨ALooper::loopå‡½æ•°ä¸­é€šè¿‡AMessageçš„deliveræ¥å£ï¼Œè°ƒç”¨AHandler::deliverMessageæ¥å£ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒåŠ¨NuPlayer::onMessageReceivedï¼ˆé€šè¿‡ç»§æ‰¿æœºåˆ¶å®ç°ï¼‰æ¥å£ã€‚è¿™æ ·ç»•äº†ä¸€åœˆã€‚æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ALooper/AHandleræœºåˆ¶å¤„ç†æ¶ˆæ¯äº†ã€‚<br>å…·ä½“å¤„ç†ä»£ç å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="keyword">case</span> kWhatSetVideoSurface:</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            sp&lt;RefBase&gt; obj;</span><br><span class="line">            CHECK(msg-&gt;findObject(<span class="string">"surface"</span>, &amp;obj));</span><br><span class="line">            sp&lt;Surface&gt; surface = <span class="keyword">static_cast</span>&lt;Surface *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">            ALOGD(<span class="string">"onSetVideoSurface(%p video decoder)"</span>, surface.get());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Need to check mStarted before calling mSource-&gt;getFormat because NuPlayer might</span></span><br><span class="line">            <span class="comment">// be in preparing state and it could take long time.</span></span><br><span class="line">            <span class="comment">// When mStarted is true, mSource must have been set.</span></span><br><span class="line">            <span class="keyword">if</span> (mSource == <span class="literal">NULL</span> || !mStarted || mSource-&gt;getFormat(<span class="literal">false</span> <span class="comment">/* audio */</span>) == <span class="literal">NULL</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">NOTE:</span> mVideoDecoder's mSurface is always non-null</span></span><br><span class="line">                    || (mVideoDecoder != <span class="literal">NULL</span> &amp;&amp; mVideoDecoder-&gt;setVideoSurface(surface) == OK)) &#123;</span><br><span class="line">                performSetSurface(surface);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å››-ã€NuPlayeræºç åˆ†æ"><a href="#å››-ã€NuPlayeræºç åˆ†æ" class="headerlink" title="(å››)ã€NuPlayeræºç åˆ†æ"></a>(å››)ã€NuPlayeræºç åˆ†æ</h4><p>è¿™æ¬¡æˆ‘ä»¬éœ€è¦æ·±å…¥åˆ†æçš„æ˜¯NuPlayerç±»ï¼Œç›¸æ¯”äºNuPlayerDriverçš„æ¥å£åŠŸèƒ½ï¼ŒNuPlayerç»§æ‰¿è‡ªAHandlerç±»ï¼Œæ˜¯AOSPæ’­æ”¾æ¡†æ¶ä¸­è¿æ¥Sourceã€Decoderã€Renderçš„çº½å¸¦ã€‚</p><h5 id="4-1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜"><a href="#4-1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜" class="headerlink" title="4.1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜"></a>4.1ã€ä¸»è¦æ¥å£å’Œæ ¸å¿ƒçš„ç±»æˆå‘˜</h5><p>NuPlayerç±»è¢«NuPlayerDriverç›´æ¥è°ƒç”¨ï¼Œå…¶ä¸»è¦æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// code from NuPlayer.h (~/frameworks/av/media/libmediaplayerservice/nuplayer/)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NuPlayer</span> :</span> <span class="keyword">public</span> AHandler &#123;</span><br><span class="line">    NuPlayer(<span class="keyword">pid_t</span> pid);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setUID</span><span class="params">(<span class="keyword">uid_t</span> uid)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDriver</span><span class="params">(<span class="keyword">const</span> wp&lt;NuPlayerDriver&gt; &amp;driver)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareAsync</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setVideoSurfaceTextureAsync</span><span class="params">(<span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt; &amp;bufferProducer)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will notify the driver through "notifyResetComplete" once finished.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">resetAsync</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will notify the driver through "notifySeekComplete" once finished</span></span><br><span class="line">    <span class="comment">// and needNotify is true.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">seekToAsync</span><span class="params">(<span class="keyword">int64_t</span> seekTimeUs, <span class="keyword">bool</span> needNotify = <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> setVideoScalingMode(<span class="keyword">int32_t</span> mode);</span><br><span class="line">    <span class="keyword">status_t</span> getTrackInfo(Parcel* reply) <span class="keyword">const</span>;</span><br><span class="line">    <span class="keyword">status_t</span> getSelectedTrack(<span class="keyword">int32_t</span> type, Parcel* reply) <span class="keyword">const</span>;</span><br><span class="line">    <span class="keyword">status_t</span> selectTrack(<span class="keyword">size_t</span> trackIndex, <span class="keyword">bool</span> select, <span class="keyword">int64_t</span> timeUs);</span><br><span class="line">    <span class="keyword">status_t</span> getCurrentPosition(<span class="keyword">int64_t</span> *mediaUs);</span><br><span class="line"></span><br><span class="line">    sp&lt;MetaData&gt; getFileMeta();</span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">getFrameRate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~NuPlayer();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onMessageReceived</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£åˆ†ç±»ä¸‹ï¼Œæ— å¤–ä¹å‡ ä¸ªåˆ†ç±»ï¼š</p><p>â˜¯ ç”¨äºåˆå§‹åŒ–çš„ï¼ˆæ¯”å¦‚æ„é€ å‡½æ•°ã€setDriver/setDataSourceAsync/prepareAsync/setVideoSurfaceTextureAsyncï¼‰<br>â˜¯ ç”¨äºé”€æ¯çš„ï¼ˆæ¯”å¦‚ææ„å‡½æ•°ã€resetAsyncï¼‰<br>â˜¯ ç”¨äºæ’­æ”¾æ§åˆ¶çš„ï¼ˆæ¯”å¦‚start/pause/seekToAsyncï¼‰<br>â˜¯ ç”¨äºçŠ¶æ€è·å–çš„ï¼ˆæ¯”å¦‚getCurrentPosition/getFileMetaï¼‰<br>ä¸‹é¢æ˜¯ä¸»è¦çš„ç±»æˆå‘˜éƒ¨åˆ†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.h]</span><br><span class="line">wp&lt;NuPlayerDriver&gt; mDriver; <span class="comment">// æ¥å£è°ƒç”¨æ–¹</span></span><br><span class="line">sp&lt;Source&gt; mSource; <span class="comment">// ç›¸å½“äºFFmpegä¸­çš„demuxer</span></span><br><span class="line">sp&lt;Surface&gt; mSurface; <span class="comment">// æ˜¾ç¤ºç”¨çš„Surface</span></span><br><span class="line">sp&lt;DecoderBase&gt; mVideoDecoder; <span class="comment">// è§†é¢‘è§£ç å™¨</span></span><br><span class="line">sp&lt;DecoderBase&gt; mAudioDecoder; <span class="comment">// éŸ³é¢‘è§£ç å™¨</span></span><br><span class="line">sp&lt;CCDecoder&gt; mCCDecoder; </span><br><span class="line">sp&lt;Renderer&gt; mRenderer; <span class="comment">// æ¸²æŸ“å™¨</span></span><br><span class="line">sp&lt;ALooper&gt; mRendererLooper;</span><br></pre></td></tr></table></figure><h5 id="4-2ã€setDataSourceAsync-ç°åˆ†æ"><a href="#4-2ã€setDataSourceAsync-ç°åˆ†æ" class="headerlink" title="4.2ã€setDataSourceAsync()ç°åˆ†æ"></a>4.2ã€setDataSourceAsync()ç°åˆ†æ</h5><p>è¿™ä¸ªå‡½æ•°æœ‰å¤šé‡ä¸åŒçš„é‡è½½å½¢å¼ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.h]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(<span class="keyword">const</span> sp&lt;IStreamSource&gt; &amp;source)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(<span class="keyword">const</span> sp&lt;IMediaHTTPService&gt; &amp;httpService, <span class="keyword">const</span> <span class="keyword">char</span> *url,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> KeyedVector&lt;String8, String8&gt; *headers)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int64_t</span> offset, <span class="keyword">int64_t</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSourceAsync</span><span class="params">(<span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source)</span></span>;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ï¼Œè¿™é‡Œä»¥ç¬¬ä¸‰ä¸ªæ¥å£ä¸ºä¾‹ï¼Œè¯´æ˜ä¸‹å¤šæœ¬åœ°åª’ä½“æ–‡ä»¶æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚<br>ä¸‹é¢æ˜¯è¿™ä¸ªå‡½æ•°çš„å®ç°ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::setDataSourceAsync(<span class="keyword">int</span> fd, <span class="keyword">int64_t</span> offset, <span class="keyword">int64_t</span> length) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetDataSource, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSourceNotify, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå¯¹è±¡ç”¨äºè¯»å–æœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    sp&lt;GenericSource&gt; source =</span><br><span class="line">            <span class="keyword">new</span> GenericSource(notify, mUIDValid, mUID);</span><br><span class="line">    <span class="comment">// å®é™…å¹²æ´»çš„çš„ä»£ç </span></span><br><span class="line">    <span class="keyword">status_t</span> err = source-&gt;setDataSource(fd, offset, length);</span><br><span class="line">    </span><br><span class="line">    msg-&gt;setObject(<span class="string">"source"</span>, source);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹å®ç°å¾ˆç®€å•ï¼Œåˆ›å»ºGenericSourceå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶setDataSourceæ¥å£ï¼Œç„¶åå‘é€kWhatSetDataSourceæ¶ˆæ¯ã€‚<br>æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å¤„ç†ç„¶åå‘é€kWhatSetDataSourceæ¶ˆæ¯å‘¢ï¼Ÿä»£ç å¦‚ä¸‹ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">case</span> kWhatSetDataSource:</span><br><span class="line">&#123;</span><br><span class="line">    CHECK(mSource == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = OK;</span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    CHECK(msg-&gt;findObject(<span class="string">"source"</span>, &amp;obj));</span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mSourceLock)</span></span>;</span><br><span class="line">        mSource = <span class="keyword">static_cast</span>&lt;Source *&gt;(obj.get());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šçŸ¥Driverå‡½æ•°è°ƒç”¨å®Œæˆ</span></span><br><span class="line">    CHECK(mDriver != <span class="literal">NULL</span>);</span><br><span class="line">    sp&lt;NuPlayerDriver&gt; driver = mDriver.promote();</span><br><span class="line">    <span class="keyword">if</span> (driver != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        driver-&gt;notifySetDataSourceCompleted(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>çœ‹åˆ°è¿™é‡Œå‘ç°ï¼Œå…¶å®æ²¡åšä»€ä¹ˆå°±æ˜¯ç›´æ¥é€šçŸ¥NuPlayerDriverã€‚æˆ‘ä»¬è¿˜æ³¨æ„åˆ°è¿™é‡Œæ„å»ºäº†ä¸€ä¸ªç‰¹æ®Šæ¶ˆæ¯ï¼ˆAMessageï¼‰notifyï¼Œè¿™ä¸ªæ¶ˆæ¯ç”¨äºåœ¨Sourceå’ŒNuPlayerç›´æ¥ä¼ é€’ã€‚ä¸‹é¢è¿™æ˜¯æ¶ˆæ¯å¾ªç¯ä¸­çš„å¤„ç†å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">case</span> kWhatSourceNotify:</span><br><span class="line">&#123;</span><br><span class="line">    onSourceNotify(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åç»­è®¨è®ºSourceçš„æ—¶å€™è¯¦ç»†è¯´æ˜è¿™ä¸ªæ¶ˆæ¯é€šçŸ¥çš„æ„ä¹‰ã€‚</p><h5 id="4-3ã€prepareAsync"><a href="#4-3ã€prepareAsync" class="headerlink" title="4.3ã€prepareAsync()"></a>4.3ã€prepareAsync()</h5><p>è¿™ä¸ªå‡½æ•°å®ç°çš„åŠŸèƒ½å¯¹åº”äºMediaPlayerBase::prepare/prepareAsyncæ¥å£ï¼Œå®ç°å¼‚æ­¥çš„prepareåŠŸèƒ½ï¼Œä¸€èˆ¬å°±æ˜¯åšä¸€äº›é¢å¤–çš„åˆå§‹åŒ–å·¥ä½œã€‚é‚£ä¹ˆç›´æ¥çœ‹ä¸€ä¸‹å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayer.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::prepareAsync() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatPrepare, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç å°±æ˜¯å‘äº†ä¸€ä¸ªkWhatPrepareçš„æ¶ˆæ¯ã€‚æ¥ä¸‹æ¥æ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ªæ¶ˆæ¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatPrepare:</span><br><span class="line">&#123;</span><br><span class="line">    mSource-&gt;prepareAsync();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†Source::prepareAsyncæ¥å£ã€‚åé¢ä¼šè§£é‡Šå…¶åŠŸèƒ½ã€‚ï¼ˆè¿™é‡Œé¢å¯èƒ½ä¼šè§£æä¸‹ç æµï¼Œè¯»å–éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•æµä¿¡æ¯ï¼Œè¯»å–æ—¶é•¿ã€å…ƒæ•°æ®ç­‰ï¼‰ã€‚</p><h5 id="4-4ã€setVideoSurfaceTextureAsync"><a href="#4-4ã€setVideoSurfaceTextureAsync" class="headerlink" title="4.4ã€setVideoSurfaceTextureAsync()"></a>4.4ã€setVideoSurfaceTextureAsync()</h5><p>è°ƒç”¨è¿™ä¸ªæ¥å£ä¸»è¦ä¸ºäº†è®¾ç½®è§†é¢‘æ¸²æŸ“çª—å£ã€‚å…¶å®ç°ç›¸å¯¹ç®€å•ï¼Œåˆ›å»ºä¸€ä¸ªSurfaceï¼Œç„¶åå‘é€å¼‚æ­¥çš„kWhatSetVideoSurfaceæ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::setVideoSurfaceTextureAsync( <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt; &amp;bufferProducer) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetVideoSurface, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufferProducer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg-&gt;setObject(<span class="string">"surface"</span>, <span class="keyword">new</span> Surface(bufferProducer, <span class="literal">true</span> <span class="comment">/* controlledByApp */</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆçœ‹çœ‹å¦‚ä½•å¤„ç†kWhatSetVideoSurfaceæ¶ˆæ¯å‘¢ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatSetVideoSurface: &#123;</span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    CHECK(msg-&gt;findObject(<span class="string">"surface"</span>, &amp;obj));</span><br><span class="line">    sp&lt;Surface&gt; surface = <span class="keyword">static_cast</span>&lt;Surface *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Need to check mStarted before calling mSource-&gt;getFormat because NuPlayer might</span></span><br><span class="line">    <span class="comment">// be in preparing state and it could take long time.</span></span><br><span class="line">    <span class="comment">// When mStarted is true, mSource must have been set.</span></span><br><span class="line">    <span class="keyword">if</span> (mSource == <span class="literal">NULL</span> || !mStarted || mSource-&gt;getFormat(<span class="literal">false</span> <span class="comment">/* audio */</span>) == <span class="literal">NULL</span></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> mVideoDecoder's mSurface is always non-null</span></span><br><span class="line">            || (mVideoDecoder != <span class="literal">NULL</span> &amp;&amp; mVideoDecoder-&gt;setVideoSurface(surface) == OK)) &#123;</span><br><span class="line">        performSetSurface(surface); <span class="comment">// é€šçŸ¥NuPlayerDriverè®¾ç½®å®Œæˆ</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¸…ç©ºéŸ³é¢‘ã€è§†é¢‘ç¼“å†²</span></span><br><span class="line">    mDeferredActions.push_back(</span><br><span class="line">            <span class="keyword">new</span> FlushDecoderAction(FLUSH_CMD_FLUSH <span class="comment">/* audio */</span>,FLUSH_CMD_SHUTDOWN <span class="comment">/* video */</span>));</span><br><span class="line">    <span class="comment">// æœ€ç»ˆè°ƒç”¨NuPlayer::performSetSurfaceæ¥å£</span></span><br><span class="line">    mDeferredActions.push_back(<span class="keyword">new</span> SetSurfaceAction(surface));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="literal">NULL</span> || mAudioDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">            <span class="comment">// Issue a seek to refresh the video screen only if started otherwise</span></span><br><span class="line">            <span class="comment">// the extractor may not yet be started and will assert.</span></span><br><span class="line">            <span class="comment">// If the video decoder is not set (perhaps audio only in this case)</span></span><br><span class="line">            <span class="comment">// do not perform a seek as it is not needed.</span></span><br><span class="line">            <span class="keyword">int64_t</span> currentPositionUs = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (getCurrentPosition(&amp;currentPositionUs) == OK) &#123;</span><br><span class="line">                mDeferredActions.push_back(</span><br><span class="line">                        <span class="keyword">new</span> SeekAction(currentPositionUs));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯¹äºæ–°çš„surfaceè®¾ç½®ï¼Œé‡ç½®ä¸‹è§£ç å™¨</span></span><br><span class="line">        mDeferredActions.push_back(<span class="keyword">new</span> SimpleAction(&amp;NuPlayer::performScanSources));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After a flush without shutdown, decoder is paused.</span></span><br><span class="line">    <span class="comment">// Don't resume it until source seek is done, otherwise it could</span></span><br><span class="line">    <span class="comment">// start pulling stale data too soon.</span></span><br><span class="line">    mDeferredActions.push_back(</span><br><span class="line">            <span class="keyword">new</span> ResumeDecoderAction(<span class="literal">false</span> <span class="comment">/* needNotify */</span>));</span><br><span class="line">    <span class="comment">// æŠŠä¸Šé¢mDeferredActionsä¸­ç¼“å­˜çš„æ‰€æœ‰Actionå¤„ç†ä¸‹ï¼Œå¹¶æ¸…ç©º</span></span><br><span class="line">    processDeferredActions();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä»£ç ç›¸å¯¹å¤æ‚ç‚¹ï¼Œæ¶‰åŠåˆ°å¾ˆå¤šï¼Œå…¶å®ä¸»è¦æ˜¯ä¸ºäº†è®¾ç½®Surfaceä¹‹åï¼Œå¯ä»¥æ­£å¸¸è§£ç æ˜¾ç¤ºï¼Œå› ä¸ºæŸäº›æƒ…å†µä¸‹è§£ç å™¨åˆå§‹åŒ–éœ€è¦ä¾èµ–äºå…·ä½“çš„Surfaceã€‚å½“ç„¶ï¼Œé‡Œè¾¹è¿˜æ¶‰åŠåˆ°NuPlayerçŠ¶æ€åŠåˆå§‹åŒ–åˆ¤æ–­ã€‚</p><h5 id="4-5ã€start-pause"><a href="#4-5ã€start-pause" class="headerlink" title="4.5ã€start()/pause()"></a>4.5ã€start()/pause()</h5><p>startå‡½æ•°å®ç°å¾ˆç®€å•ï¼Œå®é™…å°±å‘é€äº†kWhatStartæ¶ˆæ¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::start() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatStart, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ¶ˆæ¯å¤„ç†å‡½æ•°ä¸­çš„å¤„ç†å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatStart:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">        <span class="comment">// do not resume yet if the source is still buffering</span></span><br><span class="line">        <span class="keyword">if</span> (!mPausedForBuffering) &#123;</span><br><span class="line">            onResume();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onStart();</span><br><span class="line">    &#125;</span><br><span class="line">    mPausedByClient = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨äº†OnStart/OnResumeå‡½æ•°ã€‚<br>pauseå‡½æ•°å®ç°ç±»ä¼¼ï¼Œåªæ˜¯å‘é€çš„æ˜¯kWhatPauseæ¶ˆæ¯ã€‚åœ¨æ¶ˆæ¯å¤„ç†å‡½æ•°ä¸­çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatPause:</span><br><span class="line">&#123;</span><br><span class="line">    onPause();</span><br><span class="line">    mPausedByClient = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨çš„onPauseå‡½æ•°ã€‚ä¸‹é¢å•ç‹¬åˆ†æä¸‹è¿™ä¸‰ä¸ªå‡½æ•°ã€‚å…ˆä»ç®€å•çš„å‡½æ•°å¼€å§‹OnPause/onResume</p><p>NuPlayer::onPause<br>è¿™ä¸ªå‡½æ•°å®ç°æš‚åœåŠŸèƒ½ï¼Œæ€»ä½“æ¥è¯´å°±æ˜¯æŠŠSourceå’ŒRenderæš‚åœå°±å¯ä»¥äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::onPause() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPaused) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mPaused = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (mSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mSource-&gt;pause();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mRenderer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mRenderer-&gt;pause();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NuPlayer::onResume<br>è¿™ä¸ªå‡½æ•°å®ç°æ¢å¤åŠŸèƒ½ï¼Œä»£ç é€»è¾‘è·ŸonPauseå·®ä¸å¤šï¼ŒæŠŠSourceå’ŒRenderæ¢å¤ï¼Œè¿˜å¯èƒ½æ¶‰åŠå…¶å®ƒæ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::onResume() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mPaused || mResetting) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mPaused = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mSource-&gt;resume();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// |mAudioDecoder| may have been released due to the pause timeout, so re-create it if</span></span><br><span class="line">    <span class="comment">// needed.</span></span><br><span class="line">    <span class="keyword">if</span> (audioDecoderStillNeeded() &amp;&amp; mAudioDecoder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        instantiateDecoder(<span class="literal">true</span> <span class="comment">/* audio */</span>, &amp;mAudioDecoder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mRenderer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mRenderer-&gt;resume();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NuPlayer::onStart<br>è¿™ä¸ªæ¥å£å®ç°å¯åŠ¨çš„æ“ä½œï¼Œç›¸å¯¹å¤æ‚ç‚¹ï¼Œéœ€è¦åˆå§‹åŒ–è§£ç å™¨ã€åˆå§‹åŒ–Renderã€è®¾ç½®SourceçŠ¶æ€ï¼Œå¹¶å°†ä¸‰è€…å…³è”èµ·æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::onStart(<span class="keyword">int64_t</span> startPositionUs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mSourceStarted) &#123;</span><br><span class="line">        mSourceStarted = <span class="literal">true</span>;</span><br><span class="line">        mSource-&gt;start(); <span class="comment">// è®¾ç½®SourceçŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... (çœç•¥éƒ¨åˆ†ä»£ç )</span></span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatRendererNotify, <span class="keyword">this</span>);</span><br><span class="line">    ++mRendererGeneration; <span class="comment">// åˆ›å»ºRenderå’ŒRenderLooperï¼Œå±æ€§è®¾ç½®ã€ä¸è§£ç å™¨å…³è”</span></span><br><span class="line">    notify-&gt;setInt32(<span class="string">"generation"</span>, mRendererGeneration);</span><br><span class="line">    mRenderer = <span class="keyword">new</span> Renderer(mAudioSink, notify, flags);</span><br><span class="line">    mRendererLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">    mRendererLooper-&gt;setName(<span class="string">"NuPlayerRenderer"</span>);</span><br><span class="line">    mRendererLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">    mRendererLooper-&gt;registerHandler(mRenderer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = mRenderer-&gt;setPlaybackSettings(mPlaybackSettings);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> rate = getFrameRate();</span><br><span class="line">    <span class="keyword">if</span> (rate &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        mRenderer-&gt;setVideoFrameRate(rate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mVideoDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mVideoDecoder-&gt;setRenderer(mRenderer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mAudioDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mAudioDecoder-&gt;setRenderer(mRenderer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    postScanSources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­æ²¡æœ‰è§£ç å™¨çš„åˆå§‹åŒ–ï¼Œé‚£åªèƒ½ç»§ç»­çœ‹çœ‹postScanSourcesä»£ç äº†ã€‚çœ‹å®ç°å‘ç°å°±æ˜¯å‘é€äº†kWhatScanSourcesæ¶ˆæ¯ã€‚é‚£ä¹ˆæ¶ˆæ¯å¾ªç¯é‡Œè¾¹æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatScanSources:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> generation;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"generation"</span>, &amp;generation));</span><br><span class="line">    <span class="keyword">if</span> (generation != mScanSourcesGeneration) &#123;</span><br><span class="line">        <span class="comment">// Drop obsolete msg.</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mScanSourcesPending = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> mHadAnySourcesBefore = (mAudioDecoder != <span class="literal">NULL</span>) || (mVideoDecoder != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">bool</span> rescan = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize video before audio because successful initialization of</span></span><br><span class="line">    <span class="comment">// video may change deep buffer mode of audio.</span></span><br><span class="line">    <span class="keyword">if</span> (mSurface != <span class="literal">NULL</span>) &#123; <span class="comment">// åˆå§‹åŒ–è§†é¢‘è§£ç å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (instantiateDecoder(<span class="literal">false</span>, &amp;mVideoDecoder) == -EWOULDBLOCK) &#123;</span><br><span class="line">            rescan = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don't try to re-open audio sink if there's an existing decoder.</span></span><br><span class="line">    <span class="keyword">if</span> (mAudioSink != <span class="literal">NULL</span> &amp;&amp; mAudioDecoder == <span class="literal">NULL</span>) &#123; <span class="comment">// åˆå§‹åŒ–éŸ³é¢‘è§£ç å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (instantiateDecoder(<span class="literal">true</span>, &amp;mAudioDecoder) == -EWOULDBLOCK) &#123;</span><br><span class="line">            rescan = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mHadAnySourcesBefore &amp;&amp; (mAudioDecoder != <span class="literal">NULL</span> || mVideoDecoder != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="comment">// This is the first time we've found anything playable.</span></span><br><span class="line">        <span class="comment">// è®¾ç½®å®šæœŸæŸ¥è¯¢æ—¶é•¿</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceFlags &amp; Source::FLAG_DYNAMIC_DURATION) &#123;</span><br><span class="line">            schedulePollDuration();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err; <span class="comment">// ä¸€äº›å¼‚å¸¸å¤„ç†é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> ((err = mSource-&gt;feedMoreTSData()) != OK) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAudioDecoder == <span class="literal">NULL</span> &amp;&amp; mVideoDecoder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// We're not currently decoding anything (no audio or</span></span><br><span class="line">            <span class="comment">// video tracks found) and we just ran out of input data.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == ERROR_END_OF_STREAM) &#123;</span><br><span class="line">                notifyListener(MEDIA_PLAYBACK_COMPLETE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                notifyListener(MEDIA_ERROR, MEDIA_ERROR_UNKNOWN, err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦çš„è¯ï¼Œé‡æ–°æ‰«æSource</span></span><br><span class="line">    <span class="keyword">if</span> (rescan) &#123;</span><br><span class="line">        msg-&gt;post(<span class="number">100000l</span>l);</span><br><span class="line">        mScanSourcesPending = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜æœ‰seekToAsync()ã€resetAsync()ã€getCurrentPosition()ã€getFileMeta()ã€‚ç”±äºå®ç°ç±»ä¼¼ï¼Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚</p><h5 id="4-6ã€å°ç»“ç»“å’Œç–‘é—®"><a href="#4-6ã€å°ç»“ç»“å’Œç–‘é—®" class="headerlink" title="4.6ã€å°ç»“ç»“å’Œç–‘é—®"></a>4.6ã€å°ç»“ç»“å’Œç–‘é—®</h5><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æŠŠNuPlayerä¸»è¦çš„å‡½æ•°åˆ†æå®Œäº†ï¼Œä½†æ˜¯é—®é¢˜ä¾æ—§åœ¨ã€‚æ¯”å¦‚ä¸‹é¢å‡ ä¸ªï¼š</p><blockquote><p><strong>ä¸åŒæ ¼å¼çš„å¤šåª’ä½“æ–‡ä»¶å¦‚ä½•æ¢æµ‹å¹¶è§£æçš„ï¼ŸéŸ³è§†é¢‘æ•°æ®ç¼“å†²åŒºåœ¨å“ªé‡Œï¼Ÿï¼ˆSourceï¼‰</strong><br><strong>è§†é¢‘å¦‚ä½•æ˜¾ç¤ºçš„ï¼ŸéŸ³é¢‘å¦‚ä½•æ’­æ”¾çš„ï¼ŸéŸ³è§†é¢‘åŒæ­¥åœ¨å“ªé‡Œï¼Ÿï¼ˆRendererï¼‰</strong><br><strong>éŸ³é¢‘è§£ç çº¿ç¨‹ã€è§†é¢‘è§£ç çº¿ç¨‹åœ¨å“ªé‡Œï¼Ÿ ï¼ˆDecoderBaseï¼‰</strong></p></blockquote><p>æˆ‘æƒ³æ¥ä¸‹æ¥çš„åˆ†æå°±æ˜¯è§£å†³è¿™äº›ç–‘é—®çš„ã€‚</p><h5 id="4-7ã€Codec-Encoder-ã€Decoderåˆ—è¡¨é™„å½•"><a href="#4-7ã€Codec-Encoder-ã€Decoderåˆ—è¡¨é™„å½•" class="headerlink" title="4.7ã€Codec Encoder ã€Decoderåˆ—è¡¨é™„å½•"></a>4.7ã€Codec Encoder ã€Decoderåˆ—è¡¨é™„å½•</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">[AOSP/device/qcom/msm8996/media_codecs.xml(system/etc/media_codecs.xml)]</span><br><span class="line">&lt;!--</span><br><span class="line"> <span class="number">8996</span> Decoder capabilities</span><br><span class="line"> __________________________________________________________________</span><br><span class="line"> | Codec    | W       H       fps     Mbps    MB/s    | Secure-dec |</span><br><span class="line"> |__________|_________________________________________|____________|</span><br><span class="line"> | h264     | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">60</span>      <span class="number">100</span>     <span class="number">1958400</span> |  Y         |</span><br><span class="line"> |          | (<span class="number">4096</span>)  (<span class="number">2160</span>)  (<span class="number">56</span>)    (<span class="number">100</span>)           |            |</span><br><span class="line"> | hevc     | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">60</span>      <span class="number">100</span>     <span class="number">1958400</span> |  Y         |</span><br><span class="line"> |          | (<span class="number">4096</span>)  (<span class="number">2160</span>)  (<span class="number">56</span>)    (<span class="number">100</span>)           |            |</span><br><span class="line"> | mpeg4    | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">60</span>      <span class="number">60</span>      <span class="number">489600</span>  |  N         |</span><br><span class="line"> | vc1      | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">60</span>      <span class="number">60</span>      <span class="number">489600</span>  |  Y         |</span><br><span class="line"> | vp8      | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |  N         |</span><br><span class="line"> | vp9      | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |  Y         |</span><br><span class="line"> | divx3    | <span class="number">720</span>     <span class="number">480</span>     <span class="number">30</span>      <span class="number">2</span>       <span class="number">40500</span>   |  N         |</span><br><span class="line"> | div4/<span class="number">5</span>/<span class="number">6</span> | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">30</span>      <span class="number">10</span>      <span class="number">244800</span>  |  N         |</span><br><span class="line"> | h263     | <span class="number">864</span>     <span class="number">480</span>     <span class="number">30</span>      <span class="number">2</span>       <span class="number">48600</span>   |  N         |</span><br><span class="line"> | mpeg2    | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">30</span>      <span class="number">40</span>      <span class="number">244800</span>  |  Y         |</span><br><span class="line"> |__________|_________________________________________|____________|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="number">8996</span> Encoder capabilities</span><br><span class="line"> ______________________________________________________</span><br><span class="line"> | Codec    | W       H       fps     Mbps    MB/s    |</span><br><span class="line"> |__________|_________________________________________|</span><br><span class="line"> | h264     | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |</span><br><span class="line"> | hevc     | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |</span><br><span class="line"> | mpeg4    | <span class="number">1920</span>    <span class="number">1088</span>    <span class="number">60</span>      <span class="number">60</span>      <span class="number">489600</span>  |</span><br><span class="line"> | vp8      | <span class="number">3840</span>    <span class="number">2160</span>    <span class="number">30</span>      <span class="number">100</span>     <span class="number">979200</span>  |</span><br><span class="line"> | h263     | <span class="number">864</span>     <span class="number">480</span>     <span class="number">30</span>      <span class="number">2</span>       <span class="number">48600</span>   |</span><br><span class="line"> |__________|_________________________________________|</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line">&lt;MediaCodecs&gt;</span><br><span class="line">    &lt;Include href=<span class="string">"media_codecs_google_audio.xml"</span> /&gt;</span><br><span class="line">    &lt;Include href=<span class="string">"media_codecs_google_telephony.xml"</span> /&gt;</span><br><span class="line">    &lt;Settings&gt;</span><br><span class="line">        &lt;Setting name=<span class="string">"max-video-encoder-input-buffers"</span> value=<span class="string">"11"</span> /&gt;</span><br><span class="line">    &lt;/Settings&gt;</span><br><span class="line">    &lt;Encoders&gt;</span><br><span class="line">        &lt;!-- Audio Hardware  --&gt;</span><br><span class="line">        &lt;!-- Audio Software  --&gt;</span><br><span class="line">        &lt;!-- Video Hardware  --&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.avc"</span> type=<span class="string">"video/avc"</span> &gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-input-ports"</span> /&gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-output-ports"</span> /&gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-loaded-to-idle-after-allocation"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"size"</span> min=<span class="string">"96x64"</span> max=<span class="string">"4096x2160"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"alignment"</span> value=<span class="string">"2x2"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"block-size"</span> value=<span class="string">"16x16"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"blocks-per-second"</span> min=<span class="string">"1"</span> max=<span class="string">"979200"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"bitrate"</span> range=<span class="string">"1-100000000"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"frame-rate"</span> range=<span class="string">"1-240"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"concurrent-instances"</span> max=<span class="string">"16"</span> /&gt;</span><br><span class="line">          ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.mpeg4"</span> type=<span class="string">"video/mp4v-es"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.h263"</span> type=<span class="string">"video/3gpp"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.vp8"</span> type=<span class="string">"video/x-vnd.on2.vp8"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.encoder.hevc"</span> type=<span class="string">"video/hevc"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">    &lt;/Encoders&gt;</span><br><span class="line">    &lt;Decoders&gt;</span><br><span class="line">       &lt;!-- Video Hardware  --&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.avc"</span> type=<span class="string">"video/avc"</span> &gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-input-ports"</span> /&gt;</span><br><span class="line">            &lt;Quirk name=<span class="string">"requires-allocate-on-output-ports"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"size"</span> min=<span class="string">"64x64"</span> max=<span class="string">"4096x2160"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"alignment"</span> value=<span class="string">"2x2"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"block-size"</span> value=<span class="string">"16x16"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"blocks-per-second"</span> min=<span class="string">"1"</span> max=<span class="string">"1958400"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"bitrate"</span> range=<span class="string">"1-100000000"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"frame-rate"</span> range=<span class="string">"1-240"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-version"</span> value=<span class="string">"65537"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-low-latency"</span> value=<span class="string">"1"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-macroblock-processing-rate"</span> value=<span class="string">"972000"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-level"</span> value=<span class="string">"52"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"vt-max-instances"</span> value=<span class="string">"16"</span> /&gt;</span><br><span class="line">            &lt;Feature name=<span class="string">"adaptive-playback"</span> /&gt;</span><br><span class="line">            &lt;Limit name=<span class="string">"concurrent-instances"</span> max=<span class="string">"16"</span> /&gt;</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.avc.secure"</span> type=<span class="string">"video/avc"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.mpeg4"</span> type=<span class="string">"video/mp4v-es"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.mpeg2"</span> type=<span class="string">"video/mpeg2"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.mpeg2.secure"</span> type=<span class="string">"video/mpeg2"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.h263"</span> type=<span class="string">"video/3gpp"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vc1"</span> type=<span class="string">"video/x-ms-wmv"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vc1.secure"</span> type=<span class="string">"video/x-ms-wmv"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx"</span> type=<span class="string">"video/divx"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx311"</span> type=<span class="string">"video/divx311"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.divx4"</span> type=<span class="string">"video/divx4"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp8"</span> type=<span class="string">"video/x-vnd.on2.vp8"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp9"</span> type=<span class="string">"video/x-vnd.on2.vp9"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.vp9.secure"</span> type=<span class="string">"video/x-vnd.on2.vp9"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.hevc"</span> type=<span class="string">"video/hevc"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qcom.video.decoder.hevc.secure"</span> type=<span class="string">"video/hevc"</span> &gt;</span><br><span class="line">            ......</span><br><span class="line">        &lt;/MediaCodec&gt;</span><br><span class="line">        &lt;!-- Audio Software  --&gt;</span><br><span class="line">        &lt;MediaCodec name=<span class="string">"OMX.qti.audio.decoder.flac"</span> type=<span class="string">"audio/flac"</span> /&gt;</span><br><span class="line">    &lt;/Decoders&gt;</span><br><span class="line">    &lt;Include href=<span class="string">"media_codecs_google_video.xml"</span> /&gt;</span><br><span class="line">&lt;/MediaCodecs&gt;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">Android NuPlayeræ’­æ”¾æ¡†æ¶</a><br><a href="https://blog.csdn.net/column/details/12812.html" target="_blank" rel="noopener">ä¸“æ ï¼šMultiMediaæ¡†æ¶æ€»ç»“(åŸºäº6.0æºç ) - CSDNåšå®¢</a><br><a href="windrunnerlihuan.com">Androidå¤šåª’ä½“å¼€å‘-å½’æ¡£ | April is your lie</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57415505" target="_blank" rel="noopener">Android-7.0-Nuplayeræ¦‚è¿° - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57409783" target="_blank" rel="noopener">Android-7.0-MediaPlayerçŠ¶æ€æœº - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/56961370" target="_blank" rel="noopener">Android-7.0-Nuplayer-å¯åŠ¨æµç¨‹ - CSDNåšå®¢</a><br><a href="https://zh.wikipedia.org/wiki/YUV" target="_blank" rel="noopener">YUV - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53386010" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-Nuplayerï¼ˆ1ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53397945" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-AHandler AMessage ALooper - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/category/2135451/1?" target="_blank" rel="noopener">Android 4.2.2 stagefrightæ¶æ„ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/gzzaigcnforever/article/details/26849549" target="_blank" rel="noopener">android4.2.2çš„stagefrightæ¶æ„ä¸‹åŸºäºSurfaceFlingerçš„è§†é¢‘è§£ç è¾“å‡ºç¼“å­˜åˆ›å»ºæœºåˆ¶ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/category/7610722" target="_blank" rel="noopener">husanlim çš„ä¸“æ  å‚è€ƒ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">android ACodec MediaCodec NuPlayer flow - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">android MediaCodec ACodec - CSDNåšå®¢</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/06/01/Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ/">http://zhoujinjian.cc/2018/06/01/Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/05/25/Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ/" title="Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ"><i class="iconfont icon-prev"></i>Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2018/06/06/Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ/" title="Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ">Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">24</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/android/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€âºç½®é¡¶âºã€‘"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.88.jpg" alt="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€âºç½®é¡¶âºã€‘"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€âºç½®é¡¶âºã€‘</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/" title="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.25.jpg" alt="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</h3><span class="item__text">2018-09-06</span></div></a></li><li class="latest-post-item"><a href="/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/" title="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" alt="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</h3><span class="item__text">2018-08-30</span></div></a></li><li class="latest-post-item"><a href="/2018/08/16/Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ/" title="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.22.jpg" alt="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ</h3><span class="item__text">2018-08-16</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">350.8k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>