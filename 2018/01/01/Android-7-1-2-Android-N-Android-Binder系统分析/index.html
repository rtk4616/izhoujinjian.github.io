<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android 7.1.2 (Android N) Android Binder ç³»ç»Ÿ åˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/01/01/Android-7-1-2-Android-N-Android-Binderç³»ç»Ÿåˆ†æ/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.06.jpg" alt="Android 7.1.2 (Android N) Android Binder ç³»ç»Ÿ åˆ†æ"></div><header class="post__info"><h1 class="post__title">Android 7.1.2 (Android N) Android Binder ç³»ç»Ÿ åˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="http://zhoujinjian.cc/">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘.</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-01-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#åšå®¢åŸå›¾é“¾æ¥"><span class="toc-text">åšå®¢åŸå›¾é“¾æ¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸€ã€Android-Binderç³»ç»ŸCç¨‹åºç¤ºä¾‹"><span class="toc-text">ä¸€ã€Android Binderç³»ç»ŸCç¨‹åºç¤ºä¾‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ1ï¼‰ã€ç®€è¿°Binderè·¨è¿›ç¨‹æœºåˆ¶"><span class="toc-text">ï¼ˆ1ï¼‰ã€ç®€è¿°Binderè·¨è¿›ç¨‹æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1ã€Serverè¿›ç¨‹å‘ServiceManageræ³¨å†ŒæœåŠ¡"><span class="toc-text">1.1ã€Serverè¿›ç¨‹å‘ServiceManageræ³¨å†ŒæœåŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2ã€åˆ†æAndroid-binderåŸç”Ÿç¤ºä¾‹ç¨‹åºbctest-cï¼š"><span class="toc-text">1.2ã€åˆ†æAndroid binderåŸç”Ÿç¤ºä¾‹ç¨‹åºbctest.cï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3ã€ç¤ºä¾‹ç¨‹åºï¼ˆbctest-cï¼‰æ³¨å†ŒæœåŠ¡ã€è·å–æœåŠ¡è¿‡ç¨‹"><span class="toc-text">1.3ã€ç¤ºä¾‹ç¨‹åºï¼ˆbctest.cï¼‰æ³¨å†ŒæœåŠ¡ã€è·å–æœåŠ¡è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ2ï¼‰ã€Android-Binderç³»ç»Ÿ-ServiceManager"><span class="toc-text">ï¼ˆ2ï¼‰ã€Android Binderç³»ç»Ÿ_ServiceManager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1ã€ServiceManagerä¸­serviceå¥æŸ„å¦‚ä½•ç®¡ç†"><span class="toc-text">2.1ã€ServiceManagerä¸­serviceå¥æŸ„å¦‚ä½•ç®¡ç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2ã€è§£æBinderä¸Šä¼ æ•°æ®-binder-parseå‡½æ•°"><span class="toc-text">2.2ã€è§£æBinderä¸Šä¼ æ•°æ®-(binder_parseå‡½æ•°)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3ã€æ•°æ®è½¬æ¢binder-transaction-data-gt-binder-io"><span class="toc-text">2.3ã€æ•°æ®è½¬æ¢binder_transaction_data-&gt;binder_io</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4ã€å¦‚ä½•æ·»åŠ æœåŠ¡SVC-MGR-ADD-SERVICE"><span class="toc-text">2.4ã€å¦‚ä½•æ·»åŠ æœåŠ¡SVC_MGR_ADD_SERVICE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5ã€å¦‚ä½•è·å–æœåŠ¡SVC-MGR-CHECK-SERVICE"><span class="toc-text">2.5ã€å¦‚ä½•è·å–æœåŠ¡SVC_MGR_CHECK_SERVICE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6ã€ServiceManagerå›å¤æ•°æ®"><span class="toc-text">2.6ã€ServiceManagerå›å¤æ•°æ®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7ã€æ€»ç»“ï¼š"><span class="toc-text">2.7ã€æ€»ç»“ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ3ï¼‰ã€Android-Binderç³»ç»ŸCç¨‹åº"><span class="toc-text">ï¼ˆ3ï¼‰ã€Android Binderç³»ç»ŸCç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1ã€Android-Binderç³»ç»ŸCç¨‹åº-æ¡†æ¶"><span class="toc-text">3.1ã€Android Binderç³»ç»ŸCç¨‹åº_æ¡†æ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2ã€Android-Binderç³»ç»ŸCç¨‹åº-ç¼–ç "><span class="toc-text">3.2ã€Android Binderç³»ç»ŸCç¨‹åº_ç¼–ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3ã€Android-Binderç³»ç»ŸCç¨‹åº-æµ‹è¯•"><span class="toc-text">3.3ã€Android Binderç³»ç»ŸCç¨‹åº_æµ‹è¯•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#äºŒã€Android-Binderç³»ç»Ÿ-Driverå±‚"><span class="toc-text">äºŒã€Android Binderç³»ç»Ÿ-Driverå±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ1ï¼‰ã€Binderé©±åŠ¨æ¦‚è¿°"><span class="toc-text">ï¼ˆ1ï¼‰ã€Binderé©±åŠ¨æ¦‚è¿°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-æ¦‚è¿°"><span class="toc-text">1.1 æ¦‚è¿°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-ç³»ç»Ÿè°ƒç”¨"><span class="toc-text">1.2 ç³»ç»Ÿè°ƒç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ2ï¼‰ã€Binderæ ¸å¿ƒæ–¹æ³•"><span class="toc-text">ï¼ˆ2ï¼‰ã€Binderæ ¸å¿ƒæ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1ã€binder-init"><span class="toc-text">2.1ã€binder_init()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2ã€ä¸»è¦ç»“æ„"><span class="toc-text">2.2ã€ä¸»è¦ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3ã€Binderåè®®"><span class="toc-text">2.3ã€Binderåè®®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4ã€binder-open"><span class="toc-text">2.4ã€binder_open()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5ã€binder-mmap"><span class="toc-text">2.5ã€binder_mmap()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6ã€binder-ioctl-å†…å­˜ç®¡ç†"><span class="toc-text">2.6ã€binder_ioctl()å†…å­˜ç®¡ç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7ã€Binderä¸­çš„â€é¢å‘å¯¹è±¡â€"><span class="toc-text">2.7ã€Binderä¸­çš„â€é¢å‘å¯¹è±¡â€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8ã€é©±åŠ¨å±‚çš„çº¿ç¨‹ç®¡ç†"><span class="toc-text">2.8ã€é©±åŠ¨å±‚çš„çº¿ç¨‹ç®¡ç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9ã€å†èŠServiceManager"><span class="toc-text">2.9ã€å†èŠServiceManager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10ã€binder-nodeç­‰é‡è¦ç»“æ„ä½“"><span class="toc-text">2.10ã€binder_nodeç­‰é‡è¦ç»“æ„ä½“</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸‰ã€Android-Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æ"><span class="toc-text">ä¸‰ã€Android Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ1ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“æœåŠ¡â€Helloâ€æ³¨å†Œè¿‡ç¨‹"><span class="toc-text">ï¼ˆ1ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“æœåŠ¡â€Helloâ€æ³¨å†Œè¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1ã€ServiceManagerä¼‘çœ ç­‰å¾…"><span class="toc-text">1.1ã€ServiceManagerä¼‘çœ ç­‰å¾…</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2ã€Clentï¼ˆæ­¤å¤„ä¸ºTest-serverï¼‰è¯·æ±‚SMæ·»åŠ æœåŠ¡"><span class="toc-text">1.2ã€Clentï¼ˆæ­¤å¤„ä¸ºTest_serverï¼‰è¯·æ±‚SMæ·»åŠ æœåŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3ã€å”¤é†’ServiceManageræ‰§è¡Œæ·»åŠ â€helloâ€æœåŠ¡"><span class="toc-text">1.3ã€å”¤é†’ServiceManageræ‰§è¡Œæ·»åŠ â€helloâ€æœåŠ¡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ2ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentè·å–â€Helloâ€æœåŠ¡è¿‡ç¨‹"><span class="toc-text">ï¼ˆ2ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentè·å–â€Helloâ€æœåŠ¡è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-0ã€æ„é€ æ•°æ®"><span class="toc-text">2.0ã€æ„é€ æ•°æ®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1ã€å‘é€æ•°æ®ç»™ServiceManager"><span class="toc-text">2.1ã€å‘é€æ•°æ®ç»™ServiceManager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2ã€binder-thread-write-å¤„ç†æ•°æ®"><span class="toc-text">2.2ã€binder_thread_write()å¤„ç†æ•°æ®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3ã€Binderé©±åŠ¨ä¸­binder-transaction-çš„æºç "><span class="toc-text">2.3ã€Binderé©±åŠ¨ä¸­binder_transaction()çš„æºç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4ã€Binderé©±åŠ¨ä¸­binder-thread-read-çš„æºç "><span class="toc-text">2.4ã€Binderé©±åŠ¨ä¸­binder_thread_read()çš„æºç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5ã€ServiceManagerå¤„ç†getServiceè¯·æ±‚"><span class="toc-text">2.5ã€ServiceManagerå¤„ç†getServiceè¯·æ±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-6ã€Binderé©±åŠ¨ä¸­å¤„ç†ServiceManagerè¿”å›æ•°æ®"><span class="toc-text">2.6ã€Binderé©±åŠ¨ä¸­å¤„ç†ServiceManagerè¿”å›æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-Testclientè·å–handle"><span class="toc-text">2.7. Testclientè·å–handle</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ3ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentä½¿ç”¨â€Helloâ€æœåŠ¡è¿‡ç¨‹"><span class="toc-text">ï¼ˆ3ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentä½¿ç”¨â€Helloâ€æœåŠ¡è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å››ã€Android-Binderç³»ç»Ÿ-Nativeå±‚"><span class="toc-text">å››ã€Android Binderç³»ç»Ÿ-Nativeå±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ã€ServiceManagerç±»å›¾-Nativeå±‚"><span class="toc-text">(1)ã€ServiceManagerç±»å›¾(Nativeå±‚)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ã€Binderæ¡†æ¶Nativeå±‚"><span class="toc-text">(2)ã€Binderæ¡†æ¶Nativeå±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1ã€Binderçš„åˆå§‹åŒ–ProcessState"><span class="toc-text">2.1ã€Binderçš„åˆå§‹åŒ–ProcessState</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2ã€å…³äºBinderä¼ é€’æ•°æ®çš„å¤§å°é™åˆ¶"><span class="toc-text">2.2ã€å…³äºBinderä¼ é€’æ•°æ®çš„å¤§å°é™åˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3ã€ä¸é©±åŠ¨çš„é€šä¿¡IPCThreadState"><span class="toc-text">2.3ã€ä¸é©±åŠ¨çš„é€šä¿¡IPCThreadState</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4ã€Frameworkå±‚çš„çº¿ç¨‹ç®¡ç†"><span class="toc-text">2.4ã€Frameworkå±‚çš„çº¿ç¨‹ç®¡ç†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ3ï¼‰ã€Android-Binderç³»ç»Ÿ-Nativeå±‚æ·»åŠ helloæœåŠ¡"><span class="toc-text">ï¼ˆ3ï¼‰ã€Android Binderç³»ç»Ÿ-Nativeå±‚æ·»åŠ helloæœåŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1ã€Clientæ„é€ æ•°æ®ï¼Œå‘é€æ•°æ®ç»™é©±åŠ¨"><span class="toc-text">3.1ã€Clientæ„é€ æ•°æ®ï¼Œå‘é€æ•°æ®ç»™é©±åŠ¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1ã€-writeStrongBinder"><span class="toc-text">3.2.1ã€* writeStrongBinder()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2ã€flatten-binder"><span class="toc-text">3.2.2ã€flatten_binder()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3ã€finish-flatten-binder"><span class="toc-text">3.2.3ã€finish_flatten_binder()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-ã€waitForResponse"><span class="toc-text">3.2.4 ã€waitForResponse()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5ã€-IPCThreadState-talkWithDriver"><span class="toc-text">3.2.5ã€ IPCThreadState::talkWithDriver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-6ã€Clientè·å–æœåŠ¡ã€å¤„ç†å›å¤æ•°æ®è¿‡ç¨‹"><span class="toc-text">3.2.6ã€Clientè·å–æœåŠ¡ã€å¤„ç†å›å¤æ•°æ®è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-7ã€Parcel-ipcSetDataReference"><span class="toc-text">3.2.7ã€Parcel::ipcSetDataReference</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-8ã€readStrongBinder"><span class="toc-text">3.2.8ã€readStrongBinder()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-9ã€readStrongBinder-C"><span class="toc-text">3.2.9ã€readStrongBinder(C++)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-10ã€unflatten-binder"><span class="toc-text">3.2.10ã€unflatten_binder()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-11ã€getStrongProxyForHandle"><span class="toc-text">3.2.11ã€getStrongProxyForHandle()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ4ï¼‰ã€Android-Binderç³»ç»Ÿ-Nativeå±‚è·å–helloæœåŠ¡"><span class="toc-text">ï¼ˆ4ï¼‰ã€Android Binderç³»ç»Ÿ-Nativeå±‚è·å–helloæœåŠ¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#äº”ã€Android-Binderç³»ç»Ÿ-Framwork-Javaå±‚"><span class="toc-text">äº”ã€Android Binderç³»ç»Ÿ-Framwork-Javaå±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ1ï¼‰ã€Android-Binderç³»ç»ŸJavaå±‚"><span class="toc-text">ï¼ˆ1ï¼‰ã€Android Binderç³»ç»ŸJavaå±‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ2ï¼‰ã€JNIçš„è¡”æ¥"><span class="toc-text">ï¼ˆ2ï¼‰ã€JNIçš„è¡”æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ3ï¼‰ã€Javaå±‚çš„ServiceManager"><span class="toc-text">ï¼ˆ3ï¼‰ã€Javaå±‚çš„ServiceManager</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å…­ã€Android-Binderç³»ç»Ÿ-AIDL"><span class="toc-text">å…­ã€Android Binderç³»ç»Ÿ-AIDL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸ƒã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ä¸ƒã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div><p>Android Binderç³»ç»Ÿæ¦‚è¿°ï¼š Binderæ˜¯Androidç³»ç»Ÿä¸­å¤§é‡ä½¿ç”¨çš„IPCï¼ˆInter-process communicationï¼Œè¿›ç¨‹é—´é€šè®¯ï¼‰æœºåˆ¶ã€‚æ— è®ºæ˜¯åº”ç”¨ç¨‹åºå¯¹ç³»ç»ŸæœåŠ¡çš„è¯·æ±‚ï¼Œè¿˜æ˜¯åº”ç”¨ç¨‹åºè‡ªèº«æä¾›å¯¹å¤–æœåŠ¡ï¼Œéƒ½éœ€è¦ä½¿ç”¨åˆ°Binderã€‚å› æ­¤ï¼ŒBinderæœºåˆ¶åœ¨Androidç³»ç»Ÿä¸­çš„åœ°ä½éå¸¸é‡è¦ï¼Œå¯ä»¥è¯´ï¼Œç†è§£Binderæ˜¯ç†è§£Androidç³»ç»Ÿçš„ç»å¯¹å¿…è¦å‰æã€‚</p><a id="more"></a><blockquote><p><strong>framework/base/core/java/ (Java)</strong><br><strong>framework/base/core/jni/ (JNI)</strong><br><strong>framework/native/libs/binder (Native)</strong><br><strong>framework/native/cmds/servicemanager/ (Native)</strong><br><strong>kernel/drivers/staging/android (Driver)</strong></p></blockquote><hr><blockquote><p><strong>Java framework</strong></p></blockquote><p><strong>framework/base/core/java/android/os/</strong><br>â— IInterface.java<br>â— IBinder.java<br>â— Parcel.java<br>â— IServiceManager.java<br>â— ServiceManager.java<br>â— ServiceManagerNative.java<br>â— Binder.java</p><p><strong>framework/base/core/jni/</strong><br>â— android_os_Parcel.cpp<br>â— AndroidRuntime.cpp<br>â— android_util_Binder.cpp (æ ¸å¿ƒç±»)</p><hr><blockquote><p><strong>Native framework</strong></p></blockquote><p><strong>framework/native/libs/binder</strong><br><br>â— IServiceManager.cpp<br>â— BpBinder.cpp<br>â— Binder.cpp<br>â— IPCThreadState.cpp (æ ¸å¿ƒç±»)<br>â— ProcessState.cpp (æ ¸å¿ƒç±»)</p><p><strong>framework/native/include/binder/</strong><br>â— IServiceManager.h<br>â— IInterface.h</p><p><strong>framework/native/cmds/servicemanager/</strong><br>â— bctest.c<br>â— binder.h<br>â— binder.c<br>â— service_manager.c<br>â— servicemanager.rc</p><hr><blockquote><p><strong>Kernel</strong></p></blockquote><p><strong>kernel/drivers/staging/android/</strong></p><p>â— binder.c<br>â— binder.h</p><h2 id="åšå®¢åŸå›¾é“¾æ¥"><a href="#åšå®¢åŸå›¾é“¾æ¥" class="headerlink" title="åšå®¢åŸå›¾é“¾æ¥"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.binder" target="_blank" rel="noopener">åšå®¢åŸå›¾é“¾æ¥</a></h2><h2 id="ä¸€ã€Android-Binderç³»ç»ŸCç¨‹åºç¤ºä¾‹"><a href="#ä¸€ã€Android-Binderç³»ç»ŸCç¨‹åºç¤ºä¾‹" class="headerlink" title="ä¸€ã€Android Binderç³»ç»ŸCç¨‹åºç¤ºä¾‹"></a>ä¸€ã€Android Binderç³»ç»ŸCç¨‹åºç¤ºä¾‹</h2><h3 id="ï¼ˆ1ï¼‰ã€ç®€è¿°Binderè·¨è¿›ç¨‹æœºåˆ¶"><a href="#ï¼ˆ1ï¼‰ã€ç®€è¿°Binderè·¨è¿›ç¨‹æœºåˆ¶" class="headerlink" title="ï¼ˆ1ï¼‰ã€ç®€è¿°Binderè·¨è¿›ç¨‹æœºåˆ¶"></a>ï¼ˆ1ï¼‰ã€ç®€è¿°Binderè·¨è¿›ç¨‹æœºåˆ¶</h3><p>Androidç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºæ˜¯ç”±Androidçš„Activityï¼ŒServiceï¼ŒBroadcastï¼ŒContentProviderè¿™å››ç»„ä»¶çš„ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªç»„åˆè€Œæˆï¼Œè¿™å››ç»„ä»¶æ‰€æ¶‰åŠçš„å¤šè¿›ç¨‹é—´çš„é€šä¿¡åº•å±‚éƒ½æ˜¯ä¾èµ–äºBinder IPCæœºåˆ¶ã€‚</p><p>ä»è¿›ç¨‹è§’åº¦æ¥çœ‹IPCæœºåˆ¶<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/01-Android-binder-binder_interprocess_communication.png" alt="Markdown"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/02-Android-binder-IPC-Binder.jpg" alt="Markdown"></p><p>ç°åœ¨Clientè¿›ç¨‹éœ€è¦è®¿é—®Serverè¿›ç¨‹ä¸­çš„æœåŠ¡ï¼Œä¼šç»è¿‡ä»¥ä¸‹æ­¥éª¤ï¼š<br>1ã€Serverè¿›ç¨‹é¦–å…ˆå‘ServiceManageræ³¨å†ŒæœåŠ¡ï¼ˆServiceManagerå…ˆäºServerå¯åŠ¨ï¼‰<br>2ã€Clientè¿›ç¨‹å‘ServiceManageræŸ¥è¯¢æœåŠ¡å¾—åˆ°ä¸€ä¸ªå¥æŸ„Handleï¼ˆServerè¿›ç¨‹å¯èƒ½ä¸æ­¢ä¸€ä¸ªæœåŠ¡ï¼Œç”¨HandleåŒºåˆ†æ˜¯å“ªä¸€ä¸ªæœåŠ¡ï¼‰<br>3ã€Clientè¿›ç¨‹ å°è£…æ•°æ®Bufferé€šè¿‡Binderé©±åŠ¨å‘é€ç»™Serverè¿›ç¨‹ï¼ŒServerè¿›ç¨‹å–å¾—æ•°æ®åè§£ææ•°æ®ï¼Œä½¿ç”¨Serverè¿›ç¨‹çš„HandleæœåŠ¡å¯¹åº”çš„å‡½æ•°å¤„ç†æ•°æ®ï¼Œå¤„ç†å®Œæˆåé€šè¿‡Binderé©±åŠ¨ä¼ è¾“ç»™Clientè¿›ç¨‹</p><h4 id="1-1ã€Serverè¿›ç¨‹å‘ServiceManageræ³¨å†ŒæœåŠ¡"><a href="#1-1ã€Serverè¿›ç¨‹å‘ServiceManageræ³¨å†ŒæœåŠ¡" class="headerlink" title="1.1ã€Serverè¿›ç¨‹å‘ServiceManageræ³¨å†ŒæœåŠ¡"></a>1.1ã€Serverè¿›ç¨‹å‘ServiceManageræ³¨å†ŒæœåŠ¡</h4><p>ServiceManageræ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ã€‚å®ƒçš„main()å‡½æ•°æºç å¦‚ä¸‹ï¼š</p><blockquote><p>ServiceManageræ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿ è¿™é‡Œç®€è¦ä»‹ç»ä¸€ä¸‹ServiceManagerçš„å¯åŠ¨æ–¹å¼ã€‚å½“Kernelå¯åŠ¨åŠ è½½å®Œé©±åŠ¨ä¹‹åï¼Œä¼šå¯åŠ¨Androidçš„initè¿›ç¨‹ï¼Œinitè¿›ç¨‹ä¼šè§£æservicemanager.rcï¼Œè¿›è€Œå¯åŠ¨servicemanager.rcä¸­å®šä¹‰çš„å®ˆæŠ¤è¿›ç¨‹ã€‚</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ServiceManager.c]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span> *<span class="title">bs</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *svcmgr = BINDER_SERVICE_MANAGER;</span><br><span class="line"></span><br><span class="line">    bs = binder_open(<span class="number">128</span>*<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (binder_become_context_manager(bs)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    svcmgr_handle = svcmgr;</span><br><span class="line">    binder_loop(bs, svcmgr_handler);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">binder_loop</span><span class="params">(struct binder_state *bs, binder_handler func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> readbuf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    bwr.write_size = <span class="number">0</span>;</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘Šè¯‰Kernelï¼ŒServiceManagerè¿›ç¨‹è¿›å…¥äº†æ¶ˆæ¯å¾ªç¯çŠ¶æ€ã€‚</span></span><br><span class="line">    readbuf[<span class="number">0</span>] = BC_ENTER_LOOPER;</span><br><span class="line">    binder_write(bs, readbuf, <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        bwr.read_size = <span class="keyword">sizeof</span>(readbuf);</span><br><span class="line">        bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = (<span class="keyword">unsigned</span>) readbuf;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘Kernelä¸­å‘é€æ¶ˆæ¯(å…ˆå†™åè¯»)ã€‚</span></span><br><span class="line">        <span class="comment">// å…ˆå°†æ¶ˆæ¯ä¼ é€’ç»™Kernelï¼Œç„¶åå†ä»Kernelè¯»å–æ¶ˆæ¯åé¦ˆ</span></span><br><span class="line">        res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£æè¯»å–çš„æ¶ˆæ¯åé¦ˆ</span></span><br><span class="line">        res = binder_parse(bs, <span class="number">0</span>, readbuf, bwr.read_consumed, func);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>binder_loop()ä¸»è¦å·¥ä½œï¼š (1)ã€é€šè¿‡ioctl(,BINDER_WRITE_READ,)è¿›å…¥æ¶ˆæ¯å¾ªç¯ï¼Œä¼‘çœ ç­‰å¾…Clientè¯·æ±‚ (2)ã€å½“Clienté€šè¿‡é©±åŠ¨è¯·æ±‚æœåŠ¡æ—¶ï¼Œbinderé©±åŠ¨ä¼šå”¤é†’ServiceManagerï¼Œé€šè¿‡binder_parse()è§£æå¤„ç†æ•°æ®ï¼Œå›å¤ä¿¡æ¯</p><p>ä»£ç è°ƒç”¨å…³ç³»å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/03-Android-binder-ServiceManager-main.jpg" alt="Markdown"></p><p>æ—¶åºæµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/04-Android-binder-ServiceManager-main-flow.jpg" alt="Markdown"></p><p>main()ä¸»è¦è¿›è¡Œäº†ä¸‰é¡¹å·¥ä½œï¼š (1) ã€é€šè¿‡binder_open()æ‰“å¼€â€/dev/binderâ€æ–‡ä»¶ï¼Œå³æ‰“å¼€Binderè®¾å¤‡æ–‡ä»¶ã€‚ (2) ã€è°ƒç”¨binder_become_context_manager()ï¼Œé€šè¿‡ioctl()å‘Šè¯‰Binderé©±åŠ¨ç¨‹åºè‡ªå·±æ˜¯Binderä¸Šä¸‹æ–‡ç®¡ç†è€…ã€‚ (3) ã€è°ƒç”¨binder_loop()è¿›å…¥æ¶ˆæ¯å¾ªç¯ï¼Œç­‰å¾…Clientçš„è¯·æ±‚ã€‚å¦‚æœæ²¡æœ‰Clientè¯·æ±‚ï¼Œåˆ™è¿›å…¥ç¡çœ ç­‰å¾…çŠ¶æ€ï¼›å½“æœ‰Clientè¯·æ±‚æ—¶ï¼Œå°±è¢«å”¤é†’ï¼Œç„¶åè¯»å–å¹¶å¤„ç†Clientè¯·æ±‚ã€‚</p><h4 id="1-2ã€åˆ†æAndroid-binderåŸç”Ÿç¤ºä¾‹ç¨‹åºbctest-cï¼š"><a href="#1-2ã€åˆ†æAndroid-binderåŸç”Ÿç¤ºä¾‹ç¨‹åºbctest-cï¼š" class="headerlink" title="1.2ã€åˆ†æAndroid binderåŸç”Ÿç¤ºä¾‹ç¨‹åºbctest.cï¼š"></a>1.2ã€åˆ†æAndroid binderåŸç”Ÿç¤ºä¾‹ç¨‹åºbctest.cï¼š</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span> *<span class="title">bs</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> svcmgr = BINDER_SERVICE_MANAGER;</span><br><span class="line">    <span class="keyword">uint32_t</span> handle;</span><br><span class="line"></span><br><span class="line">    bs = binder_open(<span class="number">128</span>*<span class="number">1024</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (argc &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//svcmgr_lookupæ–¹æ³•è°ƒç”¨binder_call(bs, &amp;msg, &amp;reply, 0, SVC_MGR_ADD_SERVICE)</span></span><br><span class="line">            handle = svcmgr_lookup(bs, svcmgr, <span class="string">"alt_svc_mgr"</span>);</span><br><span class="line">            <span class="comment">//svcmgr_publishæ–¹æ³•è°ƒç”¨binder_call(bs, &amp;msg, &amp;reply, 0, SVC_MGR_CHECK_SERVICE)</span></span><br><span class="line">            svcmgr_publish(bs, svcmgr, argv[<span class="number">1</span>], &amp;token);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-3ã€ç¤ºä¾‹ç¨‹åºï¼ˆbctest-cï¼‰æ³¨å†ŒæœåŠ¡ã€è·å–æœåŠ¡è¿‡ç¨‹"><a href="#1-3ã€ç¤ºä¾‹ç¨‹åºï¼ˆbctest-cï¼‰æ³¨å†ŒæœåŠ¡ã€è·å–æœåŠ¡è¿‡ç¨‹" class="headerlink" title="1.3ã€ç¤ºä¾‹ç¨‹åºï¼ˆbctest.cï¼‰æ³¨å†ŒæœåŠ¡ã€è·å–æœåŠ¡è¿‡ç¨‹"></a>1.3ã€ç¤ºä¾‹ç¨‹åºï¼ˆbctest.cï¼‰æ³¨å†ŒæœåŠ¡ã€è·å–æœåŠ¡è¿‡ç¨‹</h4><p>æ³¨å†ŒæœåŠ¡çš„è¿‡ç¨‹ï¼ˆbctest.cï¼‰:<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/06-Android-binder-ServiceManager-main-SM-Publish.png" alt="Markdown"></p><p>(1) ã€bs = binder_open(128*1024) (2) ã€binder_call(bs, &amp;msg, &amp;reply, 0, SVC_MGR_ADD_SERVICE) å‚æ•°è¯´æ˜ï¼š // msgå«æœ‰æœåŠ¡çš„åå­— // replyå®ƒä¼šå«æœ‰servicemanagerå›å¤çš„æ•°æ® // targetä¸º0è¡¨ç¤ºservicemanager // code: è¡¨ç¤ºè¦è°ƒç”¨servicemanagerä¸­çš„â€addserviceå‡½æ•°â€</p><p>è·å–æœåŠ¡çš„è¿‡ç¨‹ï¼ˆbctest.cï¼‰:<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/05-Android-binder-ServiceManager-LookUp.png" alt="Markdown"></p><p>(1) ã€bs = binder_open(128*1024) (2) ã€binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_CHECK_SERVICE) å‚æ•°è¯´æ˜ï¼š // msgå«æœ‰æœåŠ¡çš„åå­— // replyå®ƒä¼šå«æœ‰servicemanagerå›å¤çš„æ•°æ®, è¡¨ç¤ºæä¾›æœåŠ¡çš„è¿›ç¨‹ // targetä¸º0è¡¨ç¤ºservicemanager // code: è¡¨ç¤ºè¦è°ƒç”¨servicemanagerä¸­çš„â€getserviceå‡½æ•°â€</p><p>binder_callè¿œç¨‹å®ç°ï¼š æ ¹æ®msgã€targetã€codeå°±çŸ¥é“éœ€è¦è°ƒç”¨å“ªä¸ªæœåŠ¡çš„å“ªä¸€ä¸ªå‡½æ•°ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/07-Android-binder-Binder_call.png" alt="Markdown"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_call</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct binder_io *msg, struct binder_io *reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">uint32_t</span> target, <span class="keyword">uint32_t</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">txn</span>;</span></span><br><span class="line">    &#125; __attribute__((packed)) writebuf;</span><br><span class="line">    <span class="keyword">unsigned</span> readbuf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    writebuf.cmd = BC_TRANSACTION;</span><br><span class="line">    writebuf.txn.target.handle = target;</span><br><span class="line">    writebuf.txn.code = code;</span><br><span class="line">    writebuf.txn.flags = <span class="number">0</span>;</span><br><span class="line">    writebuf.txn.data_size = msg-&gt;data - msg-&gt;data0;</span><br><span class="line">    writebuf.txn.offsets_size = ((<span class="keyword">char</span>*) msg-&gt;offs) - ((<span class="keyword">char</span>*) msg-&gt;offs0);</span><br><span class="line">    writebuf.txn.data.ptr.buffer = (<span class="keyword">uintptr_t</span>)msg-&gt;data0;</span><br><span class="line">    writebuf.txn.data.ptr.offsets = (<span class="keyword">uintptr_t</span>)msg-&gt;offs0;</span><br><span class="line"></span><br><span class="line">    bwr.write_size = <span class="keyword">sizeof</span>(writebuf);</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">uintptr_t</span>) &amp;writebuf;</span><br><span class="line"></span><br><span class="line">    hexdump(msg-&gt;data0, msg-&gt;data - msg-&gt;data0);</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        bwr.read_size = <span class="keyword">sizeof</span>(readbuf);</span><br><span class="line">        bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = (<span class="keyword">uintptr_t</span>) readbuf;</span><br><span class="line"></span><br><span class="line">        res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line"></span><br><span class="line">        res = binder_parse(bs, reply, (<span class="keyword">uintptr_t</span>) readbuf, bwr.read_consumed, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼š ç»“æ„ä½“ç®€ä»‹ binder_io å°è£…ä¸€æ¬¡å‘é€çš„æ•°æ® binder_write_read å­˜å‚¨ä¸€æ¬¡è¯»å†™æ“ä½œçš„æ•°æ® binder_transaction_data å­˜å‚¨ä¸€æ¬¡äº‹åŠ¡çš„æ•°æ®<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/08-Android-binder-binder_io_struct.png" alt="Markdown"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/09-Android-binder-binder_write_read.png" alt="Markdown"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/10-Android-binder-binder_transaction_data.jpg" alt="Markdown"></p></blockquote><p>ï¼ˆ1ï¼‰æ„é€ å‚æ•°ï¼Œä½¿ç”¨binder_io æè¿°<br>ï¼ˆ2ï¼‰æ•°æ®è½¬æ¢binder_io -&gt; binder_write_readï¼›é¦–å…ˆæ ¹æ®binder_io ã€targetã€codeä¸‰è€…æ„é€ binder_transaction_dataï¼Œç„¶åå°†binder_write_read.write_bufferæŒ‡å‘binder_transaction_data<br>ï¼ˆ3ï¼‰è°ƒç”¨ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);å‘é€æ•°æ®<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/11-Android-Binder-binder_call.png" alt="Markdown"></p><h3 id="ï¼ˆ2ï¼‰ã€Android-Binderç³»ç»Ÿ-ServiceManager"><a href="#ï¼ˆ2ï¼‰ã€Android-Binderç³»ç»Ÿ-ServiceManager" class="headerlink" title="ï¼ˆ2ï¼‰ã€Android Binderç³»ç»Ÿ_ServiceManager"></a>ï¼ˆ2ï¼‰ã€Android Binderç³»ç»Ÿ_ServiceManager</h3><p>æˆ‘ä»¬å…ˆè·³è¿‡ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr)æ‰€æ¶‰åŠçš„å†…æ ¸çŸ¥è¯†å’Œæµç¨‹ï¼Œç¨åå†Android Binderç³»ç»Ÿ-Driverå±‚è¯¦ç»†ä»‹ç»ã€‚</p><h4 id="2-1ã€ServiceManagerä¸­serviceå¥æŸ„å¦‚ä½•ç®¡ç†"><a href="#2-1ã€ServiceManagerä¸­serviceå¥æŸ„å¦‚ä½•ç®¡ç†" class="headerlink" title="2.1ã€ServiceManagerä¸­serviceå¥æŸ„å¦‚ä½•ç®¡ç†"></a>2.1ã€ServiceManagerä¸­serviceå¥æŸ„å¦‚ä½•ç®¡ç†</h4><p>å‰é¢åˆ†æè¿‡ï¼ŒServiceManagerå¼€æœºåˆå§‹ä¼šå¯åŠ¨æˆä¸ºä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œ ServiceManageræ˜¯å¦‚ä½•ç®¡ç†serviceå¥æŸ„çš„ï¼Ÿ è¿›ç¨‹é‡Œæœ‰ä¸€ä¸ªå…¨å±€æ€§çš„svclistå˜é‡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">svclist</span> = 0;</span></span><br></pre></td></tr></table></figure><p>å®ƒè®°å½•ç€æ‰€æœ‰æ·»åŠ è¿›ç³»ç»Ÿçš„â€Serviceâ€ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«ç»„ç»‡æˆä¸€æ¡å•å‘é“¾è¡¨ï¼Œæˆ‘ä»¬ä¸å¦¨ç§°è¿™æ¡é“¾è¡¨ä¸ºâ€Serviceå‘é‡è¡¨â€ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/12-Android-Binder-SM-svclist.jpg" alt="Markdown"></p><p>é“¾è¡¨èŠ‚ç‚¹ç±»å‹ä¸ºsvcinfo</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/13-Android-Binder-SM-svcinfo.png" alt="Markdown"></p><p>æ·»åŠ æœåŠ¡ç®€å•ç†è§£å°±æ˜¯ æ–°å»ºsvcinfoèŠ‚ç‚¹æ’å…¥åˆ°å•é“¾è¡¨ä¸­ï¼ŒæŸ¥è¯¢æœåŠ¡å°±æ˜¯çœ‹å•é“¾è¡¨æ˜¯å¦æœ‰æ­¤æœåŠ¡ã€‚</p><h4 id="2-2ã€è§£æBinderä¸Šä¼ æ•°æ®-binder-parseå‡½æ•°"><a href="#2-2ã€è§£æBinderä¸Šä¼ æ•°æ®-binder-parseå‡½æ•°" class="headerlink" title="2.2ã€è§£æBinderä¸Šä¼ æ•°æ®-(binder_parseå‡½æ•°)"></a>2.2ã€è§£æBinderä¸Šä¼ æ•°æ®-(binder_parseå‡½æ•°)</h4><p>å›åˆ°ServiceManagerçš„main()å‡½æ•°ã€‚binder_loop()ä¼šå…ˆå‘binderé©±åŠ¨å‘å‡ºäº†BC_ENTER_LOOPERå‘½ä»¤ï¼Œæ¥ç€è¿›å…¥ä¸€ä¸ªforå¾ªç¯ä¸æ–­è°ƒç”¨ioctl()è¯»å–å‘æ¥çš„æ•°æ®ï¼Œæ¥ç€è§£æè¿™äº›æ•°æ®ã€‚å‡è®¾ç°åœ¨Clientæœ‰è¯·æ±‚ï¼ŒBinderé©±åŠ¨å°±é€šè¿‡ä¼šä¸Šä¼ æ•°æ®ã€‚è¯»å–æ•°æ®åä¼šäº¤ç”±binder_parse()è§£æã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binder_loop(bs, svcmgr_handler);</span><br></pre></td></tr></table></figure><p>æ³¨æ„binder_loop()çš„å‚æ•°svcmgr_handler()å‡½æ•°æŒ‡é’ˆã€‚è€Œä¸”è¿™ä¸ªå‚æ•°ä¼šè¿›ä¸€æ­¥ä¼ é€’ç»™binder_parse()ã€‚binder_parse()è´Ÿè´£è§£æä»binderé©±åŠ¨è¯»æ¥çš„æ•°æ®ï¼Œå…¶ä»£ç æˆªé€‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_parse</span><span class="params">(struct binder_state *bs, struct binder_io *bio,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">uintptr_t</span> ptr, <span class="keyword">size_t</span> size, binder_handler func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> end = ptr + (<span class="keyword">uintptr_t</span>) size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd = *(<span class="keyword">uint32_t</span> *) ptr;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">        <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//é©±åŠ¨æœ‰æ•°æ®åä¼šè¿”å›æ¬¡cmd</span></span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> *<span class="title">txn</span> = (<span class="title">struct</span> <span class="title">binder_transaction_data</span> *) <span class="title">ptr</span>;</span></span><br><span class="line">            binder_dump_txn(txn);</span><br><span class="line">            <span class="keyword">if</span> (func) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> rdata[<span class="number">256</span>/<span class="number">4</span>];</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">msg</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">reply</span>;</span></span><br><span class="line">                <span class="keyword">int</span> res;</span><br><span class="line"></span><br><span class="line">                bio_init(&amp;reply, rdata, <span class="keyword">sizeof</span>(rdata), <span class="number">4</span>);</span><br><span class="line">                bio_init_from_txn(&amp;msg, txn);</span><br><span class="line">                res = func(bs, txn, &amp;msg, &amp;reply);</span><br><span class="line">                <span class="keyword">if</span> (txn-&gt;flags &amp; TF_ONE_WAY) &#123;</span><br><span class="line">                    binder_free_buffer(bs, txn-&gt;data.ptr.buffer);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    binder_send_reply(bs, &amp;reply, txn-&gt;data.ptr.buffer, res);</span><br><span class="line">                &#125;              </span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(*txn);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»å‰æ–‡çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œbinder_loop()å£°æ˜äº†ä¸€ä¸ª128èŠ‚çš„bufferï¼ˆå³uint32_t readbuf[32]ï¼‰ï¼Œæ¯æ¬¡ç”¨BINDER_WRITE_READå‘½ä»¤ä»é©±åŠ¨è¯»å–ä¸€äº›å†…å®¹ï¼Œå¹¶ä¼ å…¥binder_parse()ã€‚ binder_parse()åœ¨åˆé€‚çš„æ—¶æœºï¼Œä¼šå›è°ƒå…¶funcå‚æ•°ï¼ˆbinder_handler funcï¼‰æŒ‡ä»£çš„å›è°ƒå‡½æ•°ï¼Œå³å‰æ–‡è¯´åˆ°çš„svcmgr_handler()å‡½æ•°ã€‚</p><p>binder_loop()å°±è¿™æ ·ä¸€ç›´å¾ªç¯ä¸‹å»ï¼Œå®Œæˆäº†æ•´ä¸ªServiceManagerçš„å·¥ä½œã€‚</p><h4 id="2-3ã€æ•°æ®è½¬æ¢binder-transaction-data-gt-binder-io"><a href="#2-3ã€æ•°æ®è½¬æ¢binder-transaction-data-gt-binder-io" class="headerlink" title="2.3ã€æ•°æ®è½¬æ¢binder_transaction_data-&gt;binder_io"></a>2.3ã€æ•°æ®è½¬æ¢binder_transaction_data-&gt;binder_io</h4><p>åˆå§‹åŒ–replyï¼›æ ¹æ®txt(Binderé©±åŠ¨åé¦ˆçš„ä¿¡æ¯)åˆå§‹åŒ–msg</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bio_init(&amp;reply, rdata, <span class="keyword">sizeof</span>(rdata), <span class="number">4</span>);</span><br><span class="line">bio_init_from_txn(&amp;msg, txn);</span><br></pre></td></tr></table></figure><h4 id="2-4ã€å¦‚ä½•æ·»åŠ æœåŠ¡SVC-MGR-ADD-SERVICE"><a href="#2-4ã€å¦‚ä½•æ·»åŠ æœåŠ¡SVC-MGR-ADD-SERVICE" class="headerlink" title="2.4ã€å¦‚ä½•æ·»åŠ æœåŠ¡SVC_MGR_ADD_SERVICE"></a>2.4ã€å¦‚ä½•æ·»åŠ æœåŠ¡SVC_MGR_ADD_SERVICE</h4><p>å‰é¢è®²è¿‡ binder_parse()åœ¨åˆé€‚çš„æ—¶æœºï¼Œä¼šå›è°ƒå…¶funcå‚æ•°ï¼ˆbinder_handler funcï¼‰æŒ‡ä»£çš„å›è°ƒå‡½æ•°ï¼Œå³å‰æ–‡è¯´åˆ°çš„svcmgr_handler()å‡½æ•°ã€‚å¹¶ä¸”ä¼šæ ¹æ®binder_transaction_dataçš„codeåˆ¤æ–­å…·ä½“è°ƒç”¨å“ªä¸€ä¸ªå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">svcmgr_handler</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_transaction_data *txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_io *msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_io *reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> *s;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">uint32_t</span> handle;</span><br><span class="line">    <span class="keyword">uint32_t</span> strict_policy;</span><br><span class="line">    <span class="keyword">int</span> allow_isolated;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">switch</span>(txn-&gt;code) &#123;</span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_GET_SERVICE:</span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_CHECK_SERVICE:</span><br><span class="line">        s = bio_get_string16(msg, &amp;len);</span><br><span class="line">        handle = do_find_service(s, len, txn-&gt;sender_euid, txn-&gt;sender_pid);</span><br><span class="line">        bio_put_ref(reply, handle);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_ADD_SERVICE:</span><br><span class="line">        s = bio_get_string16(msg, &amp;len);</span><br><span class="line">        handle = bio_get_ref(msg);</span><br><span class="line">        allow_isolated = bio_get_uint32(msg) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (do_add_service(bs, s, len, handle, txn-&gt;sender_euid,</span><br><span class="line">            allow_isolated, txn-&gt;sender_pid))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">    bio_put_uint32(reply, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥code = SVC_MGR_ADD_SERVICE ä¼šè°ƒç”¨do_add_service()å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_add_service</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">uint16_t</span> *s, <span class="keyword">size_t</span> len,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">uint32_t</span> handle, <span class="keyword">uid_t</span> uid, <span class="keyword">int</span> allow_isolated,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">pid_t</span> spid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    si = find_svc(s, len);</span><br><span class="line">    <span class="keyword">if</span> (si) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        si = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*si) + (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        ...</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">        si-&gt;len = len;</span><br><span class="line">        <span class="built_in">memcpy</span>(si-&gt;name, s, (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        si-&gt;name[len] = <span class="string">'\0'</span>;</span><br><span class="line">        si-&gt;death.func = (<span class="keyword">void</span>*) svcinfo_death;</span><br><span class="line">        si-&gt;death.ptr = si;</span><br><span class="line">        si-&gt;allow_isolated = allow_isolated;</span><br><span class="line">        si-&gt;next = svclist;</span><br><span class="line">        svclist = si;</span><br><span class="line">    &#125;</span><br><span class="line">    binder_acquire(bs, handle);</span><br><span class="line">    binder_link_to_death(bs, handle, &amp;si-&gt;death);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§æ·»åŠ Serviceåªæ˜¯æ–°å»ºäº†ä¸€ä¸ªsvcinfoç„¶åæ’å…¥åˆ°å‰é¢æ‰€è¯´çš„â€Serviceå‘é‡è¡¨â€ä¸­ã€‚</p><h4 id="2-5ã€å¦‚ä½•è·å–æœåŠ¡SVC-MGR-CHECK-SERVICE"><a href="#2-5ã€å¦‚ä½•è·å–æœåŠ¡SVC-MGR-CHECK-SERVICE" class="headerlink" title="2.5ã€å¦‚ä½•è·å–æœåŠ¡SVC_MGR_CHECK_SERVICE"></a>2.5ã€å¦‚ä½•è·å–æœåŠ¡SVC_MGR_CHECK_SERVICE</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> do_find_service(<span class="keyword">const</span> <span class="keyword">uint16_t</span> *s, <span class="keyword">size_t</span> len, <span class="keyword">uid_t</span> uid, <span class="keyword">pid_t</span> spid)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span> = <span class="title">find_svc</span>(<span class="title">s</span>, <span class="title">len</span>);</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> si-&gt;handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–æœåŠ¡ä¼šæŸ¥è¯¢â€Serviceå‘é‡è¡¨â€æ˜¯å¦æœ‰æ­¤æœåŠ¡ï¼Œç„¶åè¿”å›Serviceçš„å¥æŸ„handleã€‚</p><h4 id="2-6ã€ServiceManagerå›å¤æ•°æ®"><a href="#2-6ã€ServiceManagerå›å¤æ•°æ®" class="headerlink" title="2.6ã€ServiceManagerå›å¤æ•°æ®"></a>2.6ã€ServiceManagerå›å¤æ•°æ®</h4><p>å‰é¢åˆ†æå›è°ƒsvcmgr_handler()å‡½æ•°å¤„ç†æ•°æ®åï¼Œä¼šè°ƒç”¨binder_send_reply()å‡½æ•° å›å¤æ¶ˆæ¯ç»™é©±åŠ¨ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binder_send_reply(bs, &amp;reply, txn-&gt;data.ptr.buffer, res)</span><br></pre></td></tr></table></figure><h4 id="2-7ã€æ€»ç»“ï¼š"><a href="#2-7ã€æ€»ç»“ï¼š" class="headerlink" title="2.7ã€æ€»ç»“ï¼š"></a>2.7ã€æ€»ç»“ï¼š</h4><p>ç¤ºä¾‹ç¨‹åºï¼ˆbctest.cï¼‰æ³¨å†Œã€è·å–æœåŠ¡ä¸€èˆ¬åˆ†ä»¥ä¸‹æ­¥éª¤ï¼š ï¼ˆ1ï¼‰æºè¿›ç¨‹é€šè¿‡binder_open()æ‰“å¼€â€/dev/binderâ€æ–‡ä»¶ï¼Œå³æ‰“å¼€Binderè®¾å¤‡æ–‡ä»¶ã€‚ ï¼ˆ2ï¼‰æºè¿›ç¨‹æ„é€ æ•°æ®ï¼š[a].æ„é€ binder_io [b].è½¬ä¸ºbinder_transaction_data [c].æ”¾å…¥binder_write_read ï¼ˆ3ï¼‰æºè¿›ç¨‹è°ƒç”¨ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);å‘é€æ•°æ®ç»™é©±åŠ¨ ï¼ˆ4ï¼‰é©±åŠ¨ä¸ŠæŠ¥æ•°æ®åˆ°ç›®çš„è¿›ç¨‹ServiceManager ï¼ˆ5ï¼‰ç›®çš„è¿›ç¨‹ServiceManagerå¤„ç†å®Œæ•°æ®ï¼Œé‡æ–°æ„é€ æ•°æ®ï¼Œé€šè¿‡è°ƒç”¨ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);å‘é€æ•°æ®ç»™é©±åŠ¨ ï¼ˆ6ï¼‰é©±åŠ¨ç„¶åå°†æ•°æ®åé¦ˆåˆ°æºè¿›ç¨‹</p><h3 id="ï¼ˆ3ï¼‰ã€Android-Binderç³»ç»ŸCç¨‹åº"><a href="#ï¼ˆ3ï¼‰ã€Android-Binderç³»ç»ŸCç¨‹åº" class="headerlink" title="ï¼ˆ3ï¼‰ã€Android Binderç³»ç»ŸCç¨‹åº"></a>ï¼ˆ3ï¼‰ã€Android Binderç³»ç»ŸCç¨‹åº</h3><h4 id="3-1ã€Android-Binderç³»ç»ŸCç¨‹åº-æ¡†æ¶"><a href="#3-1ã€Android-Binderç³»ç»ŸCç¨‹åº-æ¡†æ¶" class="headerlink" title="3.1ã€Android Binderç³»ç»ŸCç¨‹åº_æ¡†æ¶"></a>3.1ã€Android Binderç³»ç»ŸCç¨‹åº_æ¡†æ¶</h4><p>æ€»ç»“bctest.cæ³¨å†ŒæœåŠ¡è·å–æœåŠ¡çš„ä¸€èˆ¬æµç¨‹æ¡†æ¶ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/14-Android-Binder-binder_C_app_client_server_Arc.png" alt="Markdown"></p><h4 id="3-2ã€Android-Binderç³»ç»ŸCç¨‹åº-ç¼–ç "><a href="#3-2ã€Android-Binderç³»ç»ŸCç¨‹åº-ç¼–ç " class="headerlink" title="3.2ã€Android Binderç³»ç»ŸCç¨‹åº_ç¼–ç "></a>3.2ã€Android Binderç³»ç»ŸCç¨‹åº_ç¼–ç </h4><p>å‚è€ƒbctest.cç¼–ç ï¼š test_serverï¼šå‘ServiceManageræ·»åŠ æœåŠ¡â€helloâ€ &amp;&amp; â€œgoodbyeâ€ Service test_client ï¼šæŸ¥è¯¢è·å–æœåŠ¡(ServiceManager) <a href="https://github.com/weidongshan/APP_0003_Binder_C_App" target="_blank" rel="noopener">é“¾æ¥ï¼šBinder_C_App</a><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/15-Android-binder-C-Test-App.png" alt="Markdown"></p><h4 id="3-3ã€Android-Binderç³»ç»ŸCç¨‹åº-æµ‹è¯•"><a href="#3-3ã€Android-Binderç³»ç»ŸCç¨‹åº-æµ‹è¯•" class="headerlink" title="3.3ã€Android Binderç³»ç»ŸCç¨‹åº_æµ‹è¯•"></a>3.3ã€Android Binderç³»ç»ŸCç¨‹åº_æµ‹è¯•</h4><p>./test_server &amp; ./test_client hello ./test_client hello 100ask.taobao.com ./test_client goodbye ./test_client goodbye 100ask.taobao.com</p><h2 id="äºŒã€Android-Binderç³»ç»Ÿ-Driverå±‚"><a href="#äºŒã€Android-Binderç³»ç»Ÿ-Driverå±‚" class="headerlink" title="äºŒã€Android Binderç³»ç»Ÿ-Driverå±‚"></a>äºŒã€Android Binderç³»ç»Ÿ-Driverå±‚</h2><p>å‰é¢æ‰“å¼€é©±åŠ¨binder_open(128*1024)ã€ServiceManagerå¯åŠ¨æ˜¯å¦‚ä½•ä¸é©±åŠ¨äº¤äº’æˆä¸ºç®¡ç†è€…çš„ï¼Œä»¥åŠæ·»åŠ æœåŠ¡è·å–æœåŠ¡ é©±åŠ¨éƒ¨åˆ†éƒ½æ²¡æœ‰è¯¦ç»†è®²è§£ï¼Œç°åœ¨ä¸€èµ·æ¥çœ‹ä¸‹ã€‚</p><h3 id="ï¼ˆ1ï¼‰ã€Binderé©±åŠ¨æ¦‚è¿°"><a href="#ï¼ˆ1ï¼‰ã€Binderé©±åŠ¨æ¦‚è¿°" class="headerlink" title="ï¼ˆ1ï¼‰ã€Binderé©±åŠ¨æ¦‚è¿°"></a>ï¼ˆ1ï¼‰ã€Binderé©±åŠ¨æ¦‚è¿°</h3><h4 id="1-1-æ¦‚è¿°"><a href="#1-1-æ¦‚è¿°" class="headerlink" title="1.1 æ¦‚è¿°"></a>1.1 æ¦‚è¿°</h4><p>Binderé©±åŠ¨æ˜¯Androidä¸“ç”¨çš„ï¼Œä½†åº•å±‚çš„é©±åŠ¨æ¶æ„ä¸Linuxé©±åŠ¨ä¸€æ ·ã€‚binderé©±åŠ¨åœ¨ä»¥miscè®¾å¤‡è¿›è¡Œæ³¨å†Œï¼Œä½œä¸ºè™šæ‹Ÿå­—ç¬¦è®¾å¤‡ï¼Œæ²¡æœ‰ç›´æ¥æ“ä½œç¡¬ä»¶ï¼Œåªæ˜¯å¯¹è®¾å¤‡å†…å­˜çš„å¤„ç†ã€‚ä¸»è¦æ˜¯é©±åŠ¨è®¾å¤‡çš„åˆå§‹åŒ–(binder_init)ï¼Œæ‰“å¼€ (binder_open)ï¼Œæ˜ å°„(binder_mmap)ï¼Œæ•°æ®æ“ä½œ(binder_ioctl)ã€‚å¦‚å¯åŠ¨ServiceManagerè°ƒç”¨:<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/16-Android-Binder-start_service_manager.jpg" alt="Markdown"></p><h4 id="1-2-ç³»ç»Ÿè°ƒç”¨"><a href="#1-2-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="1.2 ç³»ç»Ÿè°ƒç”¨"></a>1.2 ç³»ç»Ÿè°ƒç”¨</h4><p>ç”¨æˆ·æ€çš„ç¨‹åºè°ƒç”¨Kernelå±‚é©±åŠ¨æ˜¯éœ€è¦é™·å…¥å†…æ ¸æ€ï¼Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨(syscall)ï¼Œæ¯”å¦‚æ‰“å¼€Binderé©±åŠ¨æ–¹æ³•çš„è°ƒç”¨é“¾ä¸ºï¼š open-&gt; <strong>open() -&gt; binder_open()ã€‚ open()ä¸ºç”¨æˆ·ç©ºé—´çš„æ–¹æ³•ï¼Œ</strong>open()ä¾¿æ˜¯ç³»ç»Ÿè°ƒç”¨ä¸­ç›¸åº”çš„å¤„ç†æ–¹æ³•ï¼Œé€šè¿‡æŸ¥æ‰¾ï¼Œå¯¹åº”è°ƒç”¨åˆ°å†…æ ¸binderé©±åŠ¨çš„binder_open()æ–¹æ³•ï¼Œè‡³äºå…¶ä»–çš„ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€çš„æµç¨‹ä¹ŸåŸºæœ¬ä¸€è‡´ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/17-Android-binder_driver_interface.png" alt="Markdown"></p><h3 id="ï¼ˆ2ï¼‰ã€Binderæ ¸å¿ƒæ–¹æ³•"><a href="#ï¼ˆ2ï¼‰ã€Binderæ ¸å¿ƒæ–¹æ³•" class="headerlink" title="ï¼ˆ2ï¼‰ã€Binderæ ¸å¿ƒæ–¹æ³•"></a>ï¼ˆ2ï¼‰ã€Binderæ ¸å¿ƒæ–¹æ³•</h3><h4 id="2-1ã€binder-init"><a href="#2-1ã€binder-init" class="headerlink" title="2.1ã€binder_init()"></a>2.1ã€binder_init()</h4><p>ä¸»è¦å·¥ä½œæ˜¯ä¸ºäº†æ³¨å†Œmiscè®¾å¤‡ binder_initå‡½æ•°ä¸­æœ€ä¸»è¦çš„å·¥ä½œå…¶å®ä¸‹é¢è¿™è¡Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = misc_register(&amp;binder_miscdev);</span><br></pre></td></tr></table></figure><p>è¯¥è¡Œä»£ç çœŸæ­£å‘å†…æ ¸ä¸­æ³¨å†Œäº†Binderè®¾å¤‡ã€‚binder_miscdevçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">binder_miscdev</span> = &#123;</span></span><br><span class="line">    .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">    .name = <span class="string">"binder"</span>,</span><br><span class="line">    .fops = &amp;binder_fops</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŒ‡å®šäº†Binderè®¾å¤‡çš„åç§°æ˜¯â€binderâ€ã€‚è¿™æ ·ï¼Œåœ¨ç”¨æˆ·ç©ºé—´ä¾¿å¯ä»¥é€šè¿‡å¯¹/dev/binderæ–‡ä»¶è¿›è¡Œæ“ä½œæ¥ä½¿ç”¨Binderã€‚ binder_miscdevåŒæ—¶ä¹ŸæŒ‡å®šäº†è¯¥è®¾å¤‡çš„fopsã€‚fopsæ˜¯å¦å¤–ä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä¸­åŒ…å«äº†ä¸€ç³»åˆ—çš„å‡½æ•°æŒ‡é’ˆï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">binder_fops</span> = &#123;</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .poll = binder_poll,</span><br><span class="line">    .unlocked_ioctl = binder_ioctl,</span><br><span class="line">    .compat_ioctl = binder_ioctl,</span><br><span class="line">    .mmap = binder_mmap,</span><br><span class="line">    .open = binder_open,</span><br><span class="line">    .flush = binder_flush,</span><br><span class="line">    .release = binder_release,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="2-2ã€ä¸»è¦ç»“æ„"><a href="#2-2ã€ä¸»è¦ç»“æ„" class="headerlink" title="2.2ã€ä¸»è¦ç»“æ„"></a>2.2ã€<strong>ä¸»è¦ç»“æ„</strong></h4><p>Binderé©±åŠ¨ä¸­åŒ…å«äº†å¾ˆå¤šçš„ç»“æ„ä½“ã€‚ä¸ºäº†ä¾¿äºä¸‹æ–‡è®²è§£ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆå¯¹è¿™äº›ç»“æ„ä½“åšä¸€äº›ä»‹ç»ã€‚</p><p>é©±åŠ¨ä¸­çš„ç»“æ„ä½“å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><p>ä¸€ç±»æ˜¯ä¸ç”¨æˆ·ç©ºé—´å…±ç”¨çš„ï¼Œè¿™äº›ç»“æ„ä½“åœ¨Binderé€šä¿¡åè®®è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°ã€‚å› æ­¤ï¼Œè¿™äº›ç»“æ„ä½“å®šä¹‰åœ¨binder.hä¸­ï¼ŒåŒ…æ‹¬ï¼š</p><table><thead><tr><th style="text-align:left">ç»“æ„ä½“åç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">flat_binder_object</td><td>æè¿°åœ¨Binder IPCä¸­ä¼ é€’çš„å¯¹è±¡ï¼Œè§ä¸‹æ–‡</td></tr><tr><td style="text-align:left"><strong>binder_write_read</strong></td><td>å­˜å‚¨ä¸€æ¬¡è¯»å†™æ“ä½œçš„æ•°æ®</td></tr><tr><td style="text-align:left">binder_version</td><td>å­˜å‚¨Binderçš„ç‰ˆæœ¬å·</td></tr><tr><td style="text-align:left">transaction_flags</td><td>æè¿°äº‹åŠ¡çš„flagï¼Œä¾‹å¦‚æ˜¯å¦æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ˜¯å¦æ”¯æŒfd</td></tr><tr><td style="text-align:left"><strong>binder_transaction_data</strong></td><td>å­˜å‚¨ä¸€æ¬¡äº‹åŠ¡çš„æ•°æ®</td></tr><tr><td style="text-align:left">binder_ptr_cookie</td><td>åŒ…å«äº†ä¸€ä¸ªæŒ‡é’ˆå’Œä¸€ä¸ªcookie</td></tr><tr><td style="text-align:left">binder_handle_cookie</td><td>åŒ…å«äº†ä¸€ä¸ªå¥æŸ„å’Œä¸€ä¸ªcookie</td></tr><tr><td style="text-align:left">binder_pri_desc</td><td>æš‚æœªç”¨åˆ°</td></tr><tr><td style="text-align:left">binder_pri_ptr_cookie</td><td>æš‚æœªç”¨åˆ°</td></tr></tbody></table><p>ä»å‰é¢Binderç³»ç»ŸCç¨‹åºæ¡†æ¶åˆ†æï¼Œè¿™å…¶ä¸­ï¼Œ<strong>binder_write_read</strong>å’Œ<strong>binder_transaction_data</strong>è¿™ä¸¤ä¸ªç»“æ„ä½“æœ€ä¸ºé‡è¦ï¼Œå®ƒä»¬å­˜å‚¨äº†IPCè°ƒç”¨è¿‡ç¨‹ä¸­çš„æ•°æ®ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨ä¸‹æ–‡ä¸­ä¼šè®²è§£ã€‚</p><p>Binderé©±åŠ¨ä¸­ï¼Œè¿˜æœ‰ä¸€ç±»ç»“æ„ä½“æ˜¯ä»…ä»…Binderé©±åŠ¨å†…éƒ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦çš„ï¼Œå®ƒä»¬å®šä¹‰åœ¨binder.cä¸­ï¼ŒåŒ…æ‹¬ï¼š</p><table><thead><tr><th style="text-align:left">ç»“æ„ä½“åç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><strong>binder_node</strong></td><td>æè¿°Binderå®ä½“èŠ‚ç‚¹ï¼Œå³ï¼šå¯¹åº”äº†ä¸€ä¸ªServer</td></tr><tr><td style="text-align:left"><strong>binder_ref</strong></td><td>æè¿°å¯¹äºBinderå®ä½“çš„å¼•ç”¨</td></tr><tr><td style="text-align:left"><strong>binder_buffer</strong></td><td>æè¿°Binderé€šä¿¡è¿‡ç¨‹ä¸­å­˜å‚¨æ•°æ®çš„Buffer</td></tr><tr><td style="text-align:left"><strong>binder_proc</strong></td><td>æè¿°ä½¿ç”¨Binderçš„è¿›ç¨‹</td></tr><tr><td style="text-align:left"><strong>binder_thread</strong></td><td>æè¿°ä½¿ç”¨Binderçš„çº¿ç¨‹</td></tr><tr><td style="text-align:left">binder_work</td><td>æè¿°é€šä¿¡è¿‡ç¨‹ä¸­çš„ä¸€é¡¹ä»»åŠ¡</td></tr><tr><td style="text-align:left">binder_transaction</td><td>æè¿°ä¸€æ¬¡äº‹åŠ¡çš„ç›¸å…³ä¿¡æ¯</td></tr><tr><td style="text-align:left">binder_deferred_state</td><td>æè¿°å»¶è¿Ÿä»»åŠ¡</td></tr><tr><td style="text-align:left">binder_ref_death</td><td>æè¿°Binderå®ä½“æ­»äº¡çš„ä¿¡æ¯</td></tr><tr><td style="text-align:left">binder_transaction_log</td><td>debugfsæ—¥å¿—</td></tr><tr><td style="text-align:left">binder_transaction_log_entry</td><td>debugfsæ—¥å¿—æ¡ç›®</td></tr></tbody></table><p>è¿™é‡Œéœ€è¦è¯»è€…å…³æ³¨çš„ç»“æ„ä½“å·²ç»ç”¨åŠ ç²—åšäº†æ ‡æ³¨ã€‚</p><h4 id="2-3ã€Binderåè®®"><a href="#2-3ã€Binderåè®®" class="headerlink" title="2.3ã€Binderåè®®"></a>2.3ã€<strong>Binderåè®®</strong></h4><p>Binderåè®®å¯ä»¥åˆ†ä¸ºæ§åˆ¶åè®®å’Œé©±åŠ¨åè®®ä¸¤ç±»ã€‚</p><p>æ§åˆ¶åè®®æ˜¯è¿›ç¨‹é€šè¿‡ioctl(â€œ/dev/binderâ€) ä¸Binderè®¾å¤‡è¿›è¡Œé€šè®¯çš„åè®®ï¼Œè¯¥åè®®åŒ…å«ä»¥ä¸‹å‡ ç§å‘½ä»¤ï¼š</p><table><thead><tr><th style="text-align:left">ç»“æ„ä½“åç§°</th><th>è¯´æ˜</th><th style="text-align:center">å‚æ•°ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left"><strong>BINDER_WRITE_READ</strong></td><td>è¯»å†™æ“ä½œï¼Œæœ€å¸¸ç”¨çš„å‘½ä»¤ã€‚IPCè¿‡ç¨‹å°±æ˜¯é€šè¿‡è¿™ä¸ªå‘½ä»¤è¿›è¡Œæ•°æ®ä¼ é€’</td><td style="text-align:center">binder_write_read</td></tr><tr><td style="text-align:left">BINDER_SET_MAX_THREADS</td><td>è®¾ç½®è¿›ç¨‹æ”¯æŒçš„æœ€å¤§çº¿ç¨‹æ•°é‡</td><td style="text-align:center">size_t</td></tr><tr><td style="text-align:left">BINDER_SET_CONTEXT_MGR</td><td>è®¾ç½®è‡ªèº«ä¸ºServiceManager</td><td style="text-align:center">æ— </td></tr><tr><td style="text-align:left">BINDER_THREAD_EXIT</td><td>é€šçŸ¥é©±åŠ¨Binderçº¿ç¨‹é€€å‡º</td><td style="text-align:center">æ— </td></tr><tr><td style="text-align:left">BINDER_VERSION</td><td>è·å–Binderé©±åŠ¨çš„ç‰ˆæœ¬å·</td><td style="text-align:center">binder_version</td></tr><tr><td style="text-align:left">BINDER_SET_IDLE_PRIORITY</td><td>æš‚æœªç”¨åˆ°</td><td style="text-align:center">-</td></tr><tr><td style="text-align:left">BINDER_SET_IDLE_TIMEOUT</td><td>æš‚æœªç”¨åˆ°</td><td style="text-align:center">-</td></tr></tbody></table><p>Binderçš„é©±åŠ¨åè®®æè¿°äº†å¯¹äºBinderé©±åŠ¨çš„å…·ä½“ä½¿ç”¨è¿‡ç¨‹ã€‚é©±åŠ¨åè®®åˆå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><p>ä¸€ç±»æ˜¯binder_driver_command_protocolï¼Œæè¿°äº†è¿›ç¨‹å‘é€ç»™Binderé©±åŠ¨çš„å‘½ä»¤ ä¸€ç±»æ˜¯binder_driver_return_protocolï¼Œæè¿°äº†Binderé©±åŠ¨å‘é€ç»™è¿›ç¨‹çš„å‘½ä»¤ binder_driver_command_protocolå…±åŒ…å«17ä¸ªå‘½ä»¤ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><table><thead><tr><th style="text-align:left">ç»“æ„ä½“åç§°</th><th>è¯´æ˜</th><th style="text-align:center">å‚æ•°ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">BC_TRANSACTION</td><td>Binderäº‹åŠ¡ï¼Œå³ï¼šClientå¯¹äºServerçš„è¯·æ±‚</td><td style="text-align:center">binder_transaction_data</td></tr><tr><td style="text-align:left">BC_REPLY</td><td>äº‹åŠ¡çš„åº”ç­”ï¼Œå³ï¼šServerå¯¹äºClientçš„å›å¤</td><td style="text-align:center">binder_transaction_data</td></tr><tr><td style="text-align:left">BC_FREE_BUFFER</td><td>é€šçŸ¥é©±åŠ¨é‡Šæ”¾Buffer</td><td style="text-align:center">binder_uintptr_t</td></tr><tr><td style="text-align:left">BC_ACQUIRE</td><td>å¼ºå¼•ç”¨è®¡æ•°+1</td><td style="text-align:center">__u32</td></tr><tr><td style="text-align:left">BC_RELEASE</td><td>å¼ºå¼•ç”¨è®¡æ•°-1</td><td style="text-align:center">__u32</td></tr><tr><td style="text-align:left">BC_INCREFS</td><td>å¼±å¼•ç”¨è®¡æ•°+1</td><td style="text-align:center">__u32</td></tr><tr><td style="text-align:left">BC_DECREFS</td><td>å¼±å¼•ç”¨è®¡æ•°-1 __u32</td></tr><tr><td style="text-align:left">BC_ACQUIRE_DONE</td><td>BR_ACQUIREçš„å›å¤</td><td style="text-align:center">binder_ptr_cookie</td></tr><tr><td style="text-align:left">BC_INCREFS_DONE</td><td>BR_INCREFSçš„å›å¤</td><td style="text-align:center">binder_ptr_cookie</td></tr><tr><td style="text-align:left">BC_ENTER_LOOPER</td><td>é€šçŸ¥é©±åŠ¨ä¸»çº¿ç¨‹ready</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BC_REGISTER_LOOPER</td><td>é€šçŸ¥é©±åŠ¨å­çº¿ç¨‹ready</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BC_EXIT_LOOPER</td><td>é€šçŸ¥é©±åŠ¨çº¿ç¨‹å·²ç»é€€å‡º</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BC_REQUEST_DEATH_NOTIFICATION</td><td>è¯·æ±‚æ¥æ”¶æ­»äº¡é€šçŸ¥</td><td style="text-align:center">binder_handle_cookie</td></tr><tr><td style="text-align:left">BC_CLEAR_DEATH_NOTIFICATION</td><td>å»é™¤æ¥æ”¶æ­»äº¡é€šçŸ¥</td><td style="text-align:center">binder_handle_cookie</td></tr><tr><td style="text-align:left">BC_DEAD_BINDER_DONE</td><td>å·²ç»å¤„ç†å®Œæ­»äº¡é€šçŸ¥</td><td style="text-align:center">binder_uintptr_t</td></tr><tr><td style="text-align:left">BC_ATTEMPT_ACQUIRE</td><td>æš‚æœªå®ç°</td><td style="text-align:center">-</td></tr><tr><td style="text-align:left">BC_ACQUIRE_RESULT</td><td>æš‚æœªå®ç°</td><td style="text-align:center">-</td></tr></tbody></table><p>binder_driver_return_protocolå…±åŒ…å«18ä¸ªå‘½ä»¤ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><table><thead><tr><th style="text-align:left">ç»“æ„ä½“åç§°</th><th>è¯´æ˜</th><th style="text-align:center">å‚æ•°ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">BR_OK</td><td>æ“ä½œå®Œæˆ</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BR_NOOP</td><td>æ“ä½œå®Œæˆ</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BR_ERROR</td><td>å‘ç”Ÿé”™è¯¯</td><td style="text-align:center">__s32</td></tr><tr><td style="text-align:left">BR_TRANSACTION</td><td>é€šçŸ¥è¿›ç¨‹æ”¶åˆ°ä¸€æ¬¡Binderè¯·æ±‚ï¼ˆServerç«¯ï¼‰</td><td style="text-align:center">binder_transaction_data</td></tr><tr><td style="text-align:left">BR_REPLY</td><td>é€šçŸ¥è¿›ç¨‹æ”¶åˆ°Binderè¯·æ±‚çš„å›å¤ï¼ˆClientï¼‰</td><td style="text-align:center">binder_transaction_data</td></tr><tr><td style="text-align:left">BR_TRANSACTION_COMPLETE</td><td>é©±åŠ¨å¯¹äºæ¥å—è¯·æ±‚çš„ç¡®è®¤å›å¤</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BR_FAILED_REPLY</td><td>å‘ŠçŸ¥å‘é€æ–¹é€šä¿¡ç›®æ ‡ä¸å­˜åœ¨</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BR_SPAWN_LOOPER</td><td>é€šçŸ¥Binderè¿›ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BR_ACQUIRE</td><td>å¼ºå¼•ç”¨è®¡æ•°+1è¯·æ±‚</td><td style="text-align:center">binder_ptr_cookie</td></tr><tr><td style="text-align:left">BR_RELEASE</td><td>å¼ºå¼•ç”¨è®¡æ•°-1è¯·æ±‚</td><td style="text-align:center">binder_ptr_cookie</td></tr><tr><td style="text-align:left">BR_INCREFS</td><td>å¼±å¼•ç”¨è®¡æ•°+1è¯·æ±‚</td><td style="text-align:center">binder_ptr_cookie</td></tr><tr><td style="text-align:left">BR_DECREFS</td><td>è‹¥å¼•ç”¨è®¡æ•°-1è¯·æ±‚</td><td style="text-align:center">binder_ptr_cookie</td></tr><tr><td style="text-align:left">BR_DEAD_BINDER</td><td>å‘é€æ­»äº¡é€šçŸ¥</td><td style="text-align:center">binder_uintptr_t</td></tr><tr><td style="text-align:left">BR_CLEAR_DEATH_NOTIFICATION_DONE</td><td>æ¸…ç†æ­»äº¡é€šçŸ¥å®Œæˆ</td><td style="text-align:center">binder_uintptr_t</td></tr><tr><td style="text-align:left">BR_DEAD_REPLY</td><td>å‘ŠçŸ¥å‘é€æ–¹å¯¹æ–¹å·²ç»æ­»äº¡</td><td style="text-align:center">void</td></tr><tr><td style="text-align:left">BR_ACQUIRE_RESULT</td><td>æš‚æœªå®ç°</td><td style="text-align:center">-</td></tr><tr><td style="text-align:left">BR_ATTEMPT_ACQUIRE</td><td>æš‚æœªå®ç°</td><td style="text-align:center">-</td></tr><tr><td style="text-align:left">BR_FINISHED</td><td>æš‚æœªå®ç°</td><td style="text-align:center">-</td></tr></tbody></table><p>å•ç‹¬çœ‹ä¸Šé¢çš„åè®®å¯èƒ½å¾ˆéš¾ç†è§£ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ä¸€æ¬¡Binderè¯·æ±‚è¿‡ç¨‹æ¥è¯¦ç»†çœ‹ä¸€ä¸‹Binderåè®®æ˜¯å¦‚ä½•é€šä¿¡çš„ï¼Œå°±æ¯”è¾ƒå¥½ç†è§£äº†ã€‚</p><p>è¿™å¹…å›¾çš„è¯´æ˜å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/18-Android-binder_transaction_ipc.jpg" alt="Markdown"></p><p>Binderæ˜¯C/Sæ¶æ„çš„ï¼Œé€šä¿¡è¿‡ç¨‹ç‰µæ¶‰åˆ°ï¼šClientï¼ŒServerä»¥åŠBinderé©±åŠ¨ä¸‰ä¸ªè§’è‰² Clientå¯¹äºServerçš„è¯·æ±‚ä»¥åŠServerå¯¹äºClientå›å¤éƒ½éœ€è¦é€šè¿‡Binderé©±åŠ¨æ¥ä¸­è½¬æ•°æ® BC_XXXå‘½ä»¤æ˜¯è¿›ç¨‹å‘é€ç»™é©±åŠ¨çš„å‘½ä»¤ BR_XXXå‘½ä»¤æ˜¯é©±åŠ¨å‘é€ç»™è¿›ç¨‹çš„å‘½ä»¤ æ•´ä¸ªé€šä¿¡è¿‡ç¨‹ç”±Binderé©±åŠ¨æ§åˆ¶</p><h4 id="2-4ã€binder-open"><a href="#2-4ã€binder-open" class="headerlink" title="2.4ã€binder_open()"></a>2.4ã€binder_open()</h4><p>ä»»ä½•è¿›ç¨‹åœ¨ä½¿ç”¨Binderä¹‹å‰ï¼Œéƒ½éœ€è¦å…ˆé€šè¿‡open(â€œ/dev/binderâ€)æ‰“å¼€Binderè®¾å¤‡ã€‚ä¸Šæ–‡å·²ç»æåˆ°ï¼Œç”¨æˆ·ç©ºé—´çš„openç³»ç»Ÿè°ƒç”¨å¯¹åº”äº†é©±åŠ¨ä¸­çš„binder_openå‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ï¼ŒBinderé©±åŠ¨ä¼šä¸ºè°ƒç”¨çš„è¿›ç¨‹åšä¸€äº›åˆå§‹åŒ–å·¥ä½œã€‚binder_openå‡½æ•°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_open</span><span class="params">(struct inode *nodp, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// åˆ›å»ºè¿›ç¨‹å¯¹åº”çš„binder_procå¯¹è±¡</span></span><br><span class="line">    proc = kzalloc(<span class="keyword">sizeof</span>(*proc), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (proc == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    get_task_struct(current);</span><br><span class="line">    proc-&gt;tsk = current;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–binder_proc</span></span><br><span class="line">    INIT_LIST_HEAD(&amp;proc-&gt;todo);</span><br><span class="line">    init_waitqueue_head(&amp;proc-&gt;wait);</span><br><span class="line">    proc-&gt;default_priority = task_nice(current);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”ä¿æŠ¤</span></span><br><span class="line">    binder_lock(__func__);</span><br><span class="line"></span><br><span class="line">    binder_stats_created(BINDER_STAT_PROC);</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°å…¨å±€åˆ—è¡¨binder_procsä¸­</span></span><br><span class="line">    hlist_add_head(&amp;proc-&gt;proc_node, &amp;binder_procs);</span><br><span class="line">    proc-&gt;pid = current-&gt;group_leader-&gt;pid;</span><br><span class="line">    INIT_LIST_HEAD(&amp;proc-&gt;delivered_death);</span><br><span class="line">    filp-&gt;private_data = proc;</span><br><span class="line"></span><br><span class="line">    binder_unlock(__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨Binderé©±åŠ¨ä¸­ï¼Œé€šè¿‡binder_procsè®°å½•äº†æ‰€æœ‰ä½¿ç”¨Binderçš„è¿›ç¨‹ã€‚æ¯ä¸ªåˆæ¬¡æ‰“å¼€Binderè®¾å¤‡çš„è¿›ç¨‹éƒ½ä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­çš„ã€‚</p><p>å¦å¤–ï¼Œè¯·è¯»è€…å›é¡¾ä¸€ä¸‹ä¸Šæ–‡ä»‹ç»çš„Binderé©±åŠ¨ä¸­çš„å‡ ä¸ªå…³é”®ç»“æ„ä½“ï¼š</p><blockquote><p>binder_proc binder_node binder_thread binder_ref binder_buffer</p></blockquote><p>åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†ä¾¿äºæŸ¥æ‰¾ï¼Œè¿™äº›ç»“æ„ä½“äº’ç›¸ä¹‹é—´éƒ½ç•™æœ‰å­—æ®µå­˜å‚¨å…³è”çš„ç»“æ„ã€‚</p><p>ä¸‹é¢è¿™å¹…å›¾æè¿°äº†è¿™é‡Œè¯´åˆ°çš„è¿™äº›å†…å®¹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/19-Android-binder_main_struct.png" alt="Markdown"></p><h4 id="2-5ã€binder-mmap"><a href="#2-5ã€binder-mmap" class="headerlink" title="2.5ã€binder_mmap()"></a>2.5ã€binder_mmap()</h4><p>åœ¨æ‰“å¼€Binderè®¾å¤‡ä¹‹åï¼Œè¿›ç¨‹è¿˜ä¼šé€šè¿‡mmapè¿›è¡Œå†…å­˜æ˜ å°„ã€‚mmapçš„ä½œç”¨æœ‰å¦‚ä¸‹ä¸¤ä¸ªï¼š</p><p>ç”³è¯·ä¸€å—å†…å­˜ç©ºé—´ï¼Œç”¨æ¥æ¥æ”¶Binderé€šä¿¡è¿‡ç¨‹ä¸­çš„æ•°æ® å¯¹è¿™å—å†…å­˜è¿›è¡Œåœ°å€æ˜ å°„ï¼Œä»¥ä¾¿å°†æ¥è®¿é—® binder_mmapå‡½æ•°å¯¹åº”äº†mmapç³»ç»Ÿè°ƒç”¨çš„å¤„ç†ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯Binderé©±åŠ¨çš„ç²¾åæ‰€åœ¨ï¼ˆè¿™é‡Œè¯´çš„binder_mmapå‡½æ•°ä¹ŸåŒ…æ‹¬å…¶å†…éƒ¨è°ƒç”¨çš„binder_update_page_rangeå‡½æ•°ï¼Œè§ä¸‹æ–‡ï¼‰ã€‚</p><p>å‰æ–‡æˆ‘ä»¬è¯´åˆ°ï¼Œä½¿ç”¨Binderæœºåˆ¶ï¼Œæ•°æ®åªéœ€è¦ç»å†ä¸€æ¬¡æ‹·è´å°±å¯ä»¥äº†ï¼Œå…¶åŸç†å°±åœ¨è¿™ä¸ªå‡½æ•°ä¸­ã€‚</p><p>binder_mmapè¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šç”³è¯·ä¸€å—ç‰©ç†å†…å­˜ï¼Œç„¶ååœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´åŒæ—¶å¯¹åº”åˆ°è¿™å—å†…å­˜ä¸Šã€‚åœ¨è¿™ä¹‹åï¼Œå½“æœ‰Clientè¦å‘é€æ•°æ®ç»™Serverçš„æ—¶å€™ï¼Œåªéœ€ä¸€æ¬¡ï¼Œå°†Clientå‘é€è¿‡æ¥çš„æ•°æ®æ‹·è´åˆ°Serverç«¯çš„å†…æ ¸ç©ºé—´æŒ‡å®šçš„å†…å­˜åœ°å€å³å¯ï¼Œç”±äºè¿™ä¸ªå†…å­˜åœ°å€åœ¨æœåŠ¡ç«¯å·²ç»åŒæ—¶æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå› æ­¤æ— éœ€å†åšä¸€æ¬¡å¤åˆ¶ï¼ŒServerå³å¯ç›´æ¥è®¿é—®ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/20-Android-mmap_and_transaction.png" alt="Markdown"></p><p>è¿™å¹…å›¾çš„è¯´æ˜å¦‚ä¸‹ï¼š</p><p>Serveråœ¨å¯åŠ¨ä¹‹åï¼Œè°ƒç”¨å¯¹/dev/binderè®¾å¤‡è°ƒç”¨mmap å†…æ ¸ä¸­çš„binder_mmapå‡½æ•°è¿›è¡Œå¯¹åº”çš„å¤„ç†ï¼šç”³è¯·ä¸€å—ç‰©ç†å†…å­˜ï¼Œç„¶ååœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´åŒæ—¶è¿›è¡Œæ˜ å°„ Clienté€šè¿‡BINDER_WRITE_READå‘½ä»¤å‘é€è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚å°†å…ˆåˆ°é©±åŠ¨ä¸­ï¼ŒåŒæ—¶éœ€è¦å°†æ•°æ®ä»Clientè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ é©±åŠ¨é€šè¿‡BR_TRANSACTIONé€šçŸ¥Serveræœ‰äººå‘å‡ºè¯·æ±‚ï¼ŒServerè¿›è¡Œå¤„ç†ã€‚ç”±äºè¿™å—å†…å­˜ä¹Ÿåœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œäº†æ˜ å°„ï¼Œå› æ­¤Serverè¿›ç¨‹çš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—® äº†è§£åŸç†ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹Binderé©±åŠ¨çš„ç›¸å…³æºç ã€‚è¿™æ®µä»£ç æœ‰ä¸¤ä¸ªå‡½æ•°ï¼š</p><p>binder_mmapå‡½æ•°å¯¹åº”äº†mmapçš„ç³»ç»Ÿè°ƒç”¨çš„å¤„ç† binder_update_page_rangeå‡½æ•°çœŸæ­£å®ç°äº†å†…å­˜åˆ†é…å’Œåœ°å€æ˜ å°„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_mmap</span><span class="params">(struct file *filp, struct vm_area_struct *vma)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_struct</span> *<span class="title">area</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *failure_string;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_buffer</span> *<span class="title">buffer</span>;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">   <span class="comment">// åœ¨å†…æ ¸ç©ºé—´è·å–ä¸€å—åœ°å€èŒƒå›´</span></span><br><span class="line">    area = get_vm_area(vma-&gt;vm_end - vma-&gt;vm_start, VM_IOREMAP);</span><br><span class="line">    <span class="keyword">if</span> (area == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        failure_string = <span class="string">"get_vm_area"</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_get_vm_area_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    proc-&gt;buffer = area-&gt;addr;</span><br><span class="line">    <span class="comment">// è®°å½•å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´çš„åœ°å€åç§»</span></span><br><span class="line">    proc-&gt;user_buffer_offset = vma-&gt;vm_start - (<span class="keyword">uintptr_t</span>)proc-&gt;buffer;</span><br><span class="line">    mutex_unlock(&amp;binder_mmap_lock);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">    proc-&gt;pages = kzalloc(<span class="keyword">sizeof</span>(proc-&gt;pages[<span class="number">0</span>]) * ((vma-&gt;vm_end - vma-&gt;vm_start) / PAGE_SIZE), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (proc-&gt;pages == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        failure_string = <span class="string">"alloc page array"</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_alloc_pages_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    proc-&gt;buffer_size = vma-&gt;vm_end - vma-&gt;vm_start;</span><br><span class="line"></span><br><span class="line">    vma-&gt;vm_ops = &amp;binder_vm_ops;</span><br><span class="line">    vma-&gt;vm_private_data = proc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* binder_update_page_range assumes preemption is disabled */</span></span><br><span class="line">    preempt_disable();</span><br><span class="line">    <span class="comment">// é€šè¿‡ä¸‹é¢è¿™ä¸ªå‡½æ•°çœŸæ­£å®Œæˆå†…å­˜çš„ç”³è¯·å’Œåœ°å€çš„æ˜ å°„</span></span><br><span class="line">    <span class="comment">// åˆæ¬¡ä½¿ç”¨ï¼Œå…ˆç”³è¯·ä¸€ä¸ªPAGE_SIZEå¤§å°çš„å†…å­˜</span></span><br><span class="line">    ret = binder_update_page_range(proc, <span class="number">1</span>, proc-&gt;buffer, proc-&gt;buffer + PAGE_SIZE, vma);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_update_page_range</span><span class="params">(struct binder_proc *proc, <span class="keyword">int</span> allocate,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> *start, <span class="keyword">void</span> *end,</span></span></span><br><span class="line"><span class="function"><span class="params">                    struct vm_area_struct *vma)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *page_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> user_page_addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_struct</span> <span class="title">tmp_area</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> **<span class="title">page</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (page_addr = start; page_addr &lt; end; page_addr += PAGE_SIZE) &#123;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> **<span class="title">page_array_ptr</span>;</span></span><br><span class="line">        page = &amp;proc-&gt;pages[(page_addr - proc-&gt;buffer) / PAGE_SIZE];</span><br><span class="line"></span><br><span class="line">        BUG_ON(*page);</span><br><span class="line">        <span class="comment">// çœŸæ­£è¿›è¡Œå†…å­˜çš„åˆ†é…</span></span><br><span class="line">        *page = alloc_page(GFP_KERNEL | __GFP_HIGHMEM | __GFP_ZERO);</span><br><span class="line">        <span class="keyword">if</span> (*page == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            pr_err(<span class="string">"%d: binder_alloc_buf failed for page at %p\n"</span>,</span><br><span class="line">                proc-&gt;pid, page_addr);</span><br><span class="line">            <span class="keyword">goto</span> err_alloc_page_failed;</span><br><span class="line">        &#125;</span><br><span class="line">        tmp_area.addr = page_addr;</span><br><span class="line">        tmp_area.size = PAGE_SIZE + PAGE_SIZE <span class="comment">/* guard page? */</span>;</span><br><span class="line">        page_array_ptr = page;</span><br><span class="line">        <span class="comment">// åœ¨å†…æ ¸ç©ºé—´è¿›è¡Œå†…å­˜æ˜ å°„</span></span><br><span class="line">        ret = map_vm_area(&amp;tmp_area, PAGE_KERNEL, &amp;page_array_ptr);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            pr_err(<span class="string">"%d: binder_alloc_buf failed to map page at %p in kernel\n"</span>,</span><br><span class="line">                   proc-&gt;pid, page_addr);</span><br><span class="line">            <span class="keyword">goto</span> err_map_kernel_failed;</span><br><span class="line">        &#125;</span><br><span class="line">        user_page_addr =</span><br><span class="line">            (<span class="keyword">uintptr_t</span>)page_addr + proc-&gt;user_buffer_offset;</span><br><span class="line">        <span class="comment">// åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œå†…å­˜æ˜ å°„</span></span><br><span class="line">        ret = vm_insert_page(vma, user_page_addr, page[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            pr_err(<span class="string">"%d: binder_alloc_buf failed to map page at %lx in userspace\n"</span>,</span><br><span class="line">                   proc-&gt;pid, user_page_addr);</span><br><span class="line">            <span class="keyword">goto</span> err_vm_insert_page_failed;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* vm_insert_page does not seem to increment the refcount */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mm) &#123;</span><br><span class="line">        up_write(&amp;mm-&gt;mmap_sem);</span><br><span class="line">        mmput(mm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    preempt_disable();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>binder_update_page_rangeä¸»è¦å®Œæˆå·¥ä½œï¼šåˆ†é…ç‰©ç†ç©ºé—´ï¼Œå°†ç‰©ç†ç©ºé—´æ˜ å°„åˆ°å†…æ ¸ç©ºé—´ï¼Œå°†ç‰©ç†ç©ºé—´æ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´. å¦å¤–ï¼Œä¸åŒå‚æ•°ä¸‹è¯¥æ–¹æ³•ä¹Ÿå¯ä»¥é‡Šæ”¾ç‰©ç†é¡µé¢ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/21-Android-binder_mmap.png" alt="Markdown"></p><h4 id="2-6ã€binder-ioctl-å†…å­˜ç®¡ç†"><a href="#2-6ã€binder-ioctl-å†…å­˜ç®¡ç†" class="headerlink" title="2.6ã€binder_ioctl()å†…å­˜ç®¡ç†"></a>2.6ã€binder_ioctl()å†…å­˜ç®¡ç†</h4><p>ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°binder_mmapçš„æ—¶å€™ï¼Œä¼šç”³è¯·ä¸€ä¸ªPAGE_SIZE(é€šå¸¸æ˜¯4K)çš„å†…å­˜ã€‚è€Œå®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªPAGE_SIZEçš„å¤§å°é€šå¸¸æ˜¯ä¸å¤Ÿçš„ã€‚</p><p>åœ¨é©±åŠ¨ä¸­ï¼Œä¼šæ ¹æ®å®é™…çš„ä½¿ç”¨æƒ…å†µè¿›è¡Œå†…å­˜çš„åˆ†é…ã€‚æœ‰å†…å­˜çš„åˆ†é…ï¼Œå½“ç„¶ä¹Ÿéœ€è¦å†…å­˜çš„é‡Šæ”¾ã€‚è¿™é‡Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹Binderé©±åŠ¨ä¸­æ˜¯å¦‚ä½•è¿›è¡Œå†…å­˜çš„ç®¡ç†çš„ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»ä¸€æ¬¡IPCè¯·æ±‚è¯´èµ·ã€‚</p><p>å½“ä¸€ä¸ªClientæƒ³è¦å¯¹Serverå‘å‡ºè¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆå°†è¯·æ±‚å‘é€åˆ°Binderè®¾å¤‡ä¸Šï¼Œç”±Binderé©±åŠ¨æ ¹æ®è¯·æ±‚çš„ä¿¡æ¯æ‰¾åˆ°å¯¹åº”çš„ç›®æ ‡èŠ‚ç‚¹ï¼Œç„¶åå°†è¯·æ±‚æ•°æ®ä¼ é€’è¿‡å»ã€‚</p><p>è¿›ç¨‹é€šè¿‡ioctlç³»ç»Ÿè°ƒç”¨æ¥å‘å‡ºè¯·æ±‚ï¼šioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr)</p><p>è¿™é‡Œçš„bs-&gt;fdå¯¹åº”äº†æ‰“å¼€Binderè®¾å¤‡æ—¶çš„fdã€‚BINDER_WRITE_READå¯¹åº”äº†å…·ä½“è¦åšçš„æ“ä½œç ï¼Œè¿™ä¸ªæ“ä½œç å°†ç”±Binderé©±åŠ¨è§£æã€‚bwrå­˜å‚¨äº†è¯·æ±‚æ•°æ®ï¼Œå…¶ç±»å‹æ˜¯binder_write_readã€‚</p><p>binder_write_readå…¶å®æ˜¯ä¸€ä¸ªç›¸å¯¹å¤–å±‚çš„æ•°æ®ç»“æ„ï¼Œå…¶å†…éƒ¨ä¼šåŒ…å«ä¸€ä¸ªbinder_transaction_dataç»“æ„çš„æ•°æ®ã€‚binder_transaction_dataåŒ…å«äº†å‘å‡ºè¯·æ±‚è€…çš„æ ‡è¯†ï¼Œè¯·æ±‚çš„ç›®æ ‡å¯¹è±¡ä»¥åŠè¯·æ±‚æ‰€éœ€è¦çš„å‚æ•°ã€‚å®ƒä»¬çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/22-Android-binder_write_read.png" alt="Markdown"></p><p>binder_ioctlå‡½æ•°å¯¹åº”äº†ioctlç³»ç»Ÿè°ƒç”¨çš„å¤„ç†ã€‚è¿™ä¸ªå‡½æ•°çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ ¹æ®ioctlçš„å‘½ä»¤æ¥ç¡®å®šè¿›ä¸€æ­¥å¤„ç†çš„é€»è¾‘ï¼Œå…·ä½“å¦‚ä¸‹:</p><p>â— å¦‚æœå‘½ä»¤æ˜¯BINDER_WRITE_READï¼Œå¹¶ä¸”<br>â— å¦‚æœ bwr.write_size &gt; 0ï¼Œåˆ™è°ƒç”¨binder_thread_write<br>â— å¦‚æœ bwr.read_size &gt; 0ï¼Œåˆ™è°ƒç”¨binder_thread_read<br>â— å¦‚æœå‘½ä»¤æ˜¯BINDER_SET_MAX_THREADSï¼Œåˆ™è®¾ç½®è¿›ç¨‹çš„max_threadsï¼Œå³è¿›ç¨‹æ”¯æŒçš„æœ€å¤§çº¿ç¨‹æ•°<br>â— å¦‚æœå‘½ä»¤æ˜¯BINDER_SET_CONTEXT_MGRï¼Œåˆ™è®¾ç½®å½“å‰è¿›ç¨‹ä¸ºServiceManagerï¼Œè§ä¸‹æ–‡<br>â— å¦‚æœå‘½ä»¤æ˜¯BINDER_THREAD_EXITï¼Œåˆ™è°ƒç”¨binder_free_threadï¼Œé‡Šæ”¾binder_thread<br>â— å¦‚æœå‘½ä»¤æ˜¯BINDER_VERSIONï¼Œåˆ™è¿”å›å½“å‰çš„Binderç‰ˆæœ¬å· è¿™å…¶ä¸­ï¼Œæœ€å…³é”®çš„å°±æ˜¯binder_thread_writeæ–¹æ³•ã€‚å½“Clientè¯·æ±‚Serverçš„æ—¶å€™ï¼Œä¾¿ä¼šå‘é€ä¸€ä¸ªBINDER_WRITE_READå‘½ä»¤ï¼ŒåŒæ—¶æ¡†æ¶ä¼šå°†å°†å®é™…çš„æ•°æ®åŒ…è£…å¥½ã€‚æ­¤æ—¶ï¼Œbinder_transaction_dataä¸­çš„codeå°†æ˜¯BC_TRANSACTIONï¼Œç”±æ­¤ä¾¿ä¼šè°ƒç”¨åˆ°binder_transactionæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¯¹ä¸€æ¬¡Binderäº‹åŠ¡çš„å¤„ç†ï¼Œè¿™å…¶ä¸­ä¼šè°ƒç”¨binder_alloc_bufå‡½æ•°ä¸ºæ­¤æ¬¡äº‹åŠ¡ç”³è¯·ä¸€ä¸ªç¼“å­˜ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="built_in">free</span>:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> allow_user_free:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> async_transaction:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> debug_id:<span class="number">29</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">transaction</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> data_size;</span><br><span class="line">    <span class="keyword">size_t</span> offsets_size;</span><br><span class="line">    <span class="keyword">uint8_t</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨binder_procï¼ˆæè¿°äº†ä½¿ç”¨Binderçš„è¿›ç¨‹ï¼‰ä¸­ï¼ŒåŒ…å«äº†å‡ ä¸ªå­—æ®µç”¨æ¥ç®¡ç†è¿›ç¨‹åœ¨Binder IPCè¿‡ç¨‹ä¸­ç¼“å­˜ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">buffers</span>;</span> <span class="comment">// è¿›ç¨‹æ‹¥æœ‰çš„bufferåˆ—è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">free_buffers</span>;</span> <span class="comment">// ç©ºé—²bufferåˆ—è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">allocated_buffers</span>;</span> <span class="comment">// å·²ä½¿ç”¨çš„bufferåˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">size_t</span> free_async_space; <span class="comment">// å‰©ä½™çš„å¼‚æ­¥è°ƒç”¨çš„ç©ºé—´</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> buffer_size; <span class="comment">// ç¼“å­˜çš„ä¸Šé™</span></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿›ç¨‹åœ¨mmapæ—¶ï¼Œä¼šè®¾å®šæ”¯æŒçš„æ€»ç¼“å­˜å¤§å°çš„ä¸Šé™ï¼ˆä¸‹æ–‡ä¼šè®²åˆ°ï¼‰ã€‚è€Œè¿›ç¨‹æ¯å½“æ”¶åˆ°BC_TRANSACTIONï¼Œå°±ä¼šåˆ¤æ–­å·²ä½¿ç”¨ç¼“å­˜åŠ æœ¬æ¬¡ç”³è¯·çš„å’Œæœ‰æ²¡æœ‰è¶…è¿‡ä¸Šé™ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±è€ƒè™‘è¿›è¡Œå†…å­˜çš„åˆ†é…ã€‚</p><p>è¿›ç¨‹çš„ç©ºé—²ç¼“å­˜è®°å½•åœ¨binder_procçš„free_buffersä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªä»¥çº¢é»‘æ ‘å½¢å¼å­˜å‚¨çš„ç»“æ„ã€‚æ¯æ¬¡å°è¯•åˆ†é…ç¼“å­˜çš„æ—¶å€™ï¼Œä¼šä»è¿™é‡Œé¢æŒ‰å¤§å°é¡ºåºè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘éœ€è¦çš„ä¸€å—ç¼“å­˜ã€‚æŸ¥æ‰¾çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (n) &#123;</span><br><span class="line">    buffer = rb_entry(n, struct binder_buffer, rb_node);</span><br><span class="line">    BUG_ON(!buffer-&gt;<span class="built_in">free</span>);</span><br><span class="line">    buffer_size = binder_buffer_size(proc, buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt; buffer_size) &#123;</span><br><span class="line">        best_fit = n;</span><br><span class="line">        n = n-&gt;rb_left;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size &gt; buffer_size)</span><br><span class="line">        n = n-&gt;rb_right;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        best_fit = n;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¹‹åï¼Œè¿˜éœ€è¦å¯¹binder_procä¸­çš„å­—æ®µè¿›è¡Œç›¸åº”çš„æ›´æ–°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rb_erase(best_fit, &amp;proc-&gt;free_buffers);</span><br><span class="line">buffer-&gt;<span class="built_in">free</span> = <span class="number">0</span>;</span><br><span class="line">binder_insert_allocated_buffer(proc, buffer);</span><br><span class="line"><span class="keyword">if</span> (buffer_size != size) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_buffer</span> *<span class="title">new_buffer</span> = (<span class="title">void</span> *)<span class="title">buffer</span>-&gt;<span class="title">data</span> + <span class="title">size</span>;</span></span><br><span class="line">    list_add(&amp;new_buffer-&gt;entry, &amp;buffer-&gt;entry);</span><br><span class="line">    new_buffer-&gt;<span class="built_in">free</span> = <span class="number">1</span>;</span><br><span class="line">    binder_insert_free_buffer(proc, new_buffer);</span><br><span class="line">&#125;</span><br><span class="line">binder_debug(BINDER_DEBUG_BUFFER_ALLOC,</span><br><span class="line">         <span class="string">"%d: binder_alloc_buf size %zd got %p\n"</span>,</span><br><span class="line">          proc-&gt;pid, size, buffer);</span><br><span class="line">buffer-&gt;data_size = data_size;</span><br><span class="line">buffer-&gt;offsets_size = offsets_size;</span><br><span class="line">buffer-&gt;async_transaction = is_async;</span><br><span class="line"><span class="keyword">if</span> (is_async) &#123;</span><br><span class="line">    proc-&gt;free_async_space -= size + <span class="keyword">sizeof</span>(struct binder_buffer);</span><br><span class="line">    binder_debug(BINDER_DEBUG_BUFFER_ALLOC_ASYNC,</span><br><span class="line">             <span class="string">"%d: binder_alloc_buf size %zd async free %zd\n"</span>,</span><br><span class="line">              proc-&gt;pid, size, proc-&gt;free_async_space);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹çœ‹å†…å­˜çš„é‡Šæ”¾ã€‚</p><p>BC_FREE_BUFFERå‘½ä»¤æ˜¯é€šçŸ¥é©±åŠ¨è¿›è¡Œå†…å­˜çš„é‡Šæ”¾ï¼Œbinder_free_bufå‡½æ•°æ˜¯çœŸæ­£å®ç°çš„é€»è¾‘ï¼Œè¿™ä¸ªå‡½æ•°ä¸binder_alloc_bufæ˜¯åˆšå¥½å¯¹åº”çš„ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæ‰€åšçš„äº‹æƒ…åŒ…æ‹¬ï¼š</p><p>é‡æ–°è®¡ç®—è¿›ç¨‹çš„ç©ºé—²ç¼“å­˜å¤§å° é€šè¿‡binder_update_page_rangeé‡Šæ”¾å†…å­˜ æ›´æ–°binder_procçš„buffersï¼Œfree_buffersï¼Œallocated_bufferså­—æ®µ</p><h4 id="2-7ã€Binderä¸­çš„â€é¢å‘å¯¹è±¡â€"><a href="#2-7ã€Binderä¸­çš„â€é¢å‘å¯¹è±¡â€" class="headerlink" title="2.7ã€Binderä¸­çš„â€é¢å‘å¯¹è±¡â€"></a>2.7ã€<strong>Binderä¸­çš„â€é¢å‘å¯¹è±¡â€</strong></h4><p>Binderæœºåˆ¶æ·¡åŒ–äº†è¿›ç¨‹çš„è¾¹ç•Œï¼Œä½¿å¾—è·¨è¶Šè¿›ç¨‹ä¹Ÿèƒ½å¤Ÿè°ƒç”¨åˆ°æŒ‡å®šæœåŠ¡çš„æ–¹æ³•ï¼Œå…¶åŸå› æ˜¯å› ä¸ºBinderæœºåˆ¶åœ¨åº•å±‚å¤„ç†äº†åœ¨è¿›ç¨‹é—´çš„â€å¯¹è±¡â€ä¼ é€’ã€‚</p><p>åœ¨Binderé©±åŠ¨ä¸­ï¼Œå¹¶ä¸æ˜¯çœŸçš„å°†å¯¹è±¡åœ¨è¿›ç¨‹é—´æ¥å›åºåˆ—åŒ–ï¼Œè€Œæ˜¯é€šè¿‡ç‰¹å®šçš„æ ‡è¯†æ¥è¿›è¡Œå¯¹è±¡çš„ä¼ é€’ã€‚Binderé©±åŠ¨ä¸­ï¼Œé€šè¿‡flat_binder_objectæ¥æè¿°éœ€è¦è·¨è¶Šè¿›ç¨‹ä¼ é€’çš„å¯¹è±¡ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flat_binder_object</span> &#123;</span></span><br><span class="line">    __u32        type;</span><br><span class="line">    __u32        flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">binder_uintptr_t</span>    binder; <span class="comment">/* local object */</span></span><br><span class="line">        __u32            handle;    <span class="comment">/* remote object */</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">binder_uintptr_t</span>    cookie;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™å…¶ä¸­ï¼Œtypeæœ‰å¦‚ä¸‹5ç§ç±»å‹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    BINDER_TYPE_BINDER    = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</span><br><span class="line">    BINDER_TYPE_WEAK_BINDER    = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</span><br><span class="line">    BINDER_TYPE_HANDLE    = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</span><br><span class="line">    BINDER_TYPE_WEAK_HANDLE    = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</span><br><span class="line">    BINDER_TYPE_FD        = B_PACK_CHARS(<span class="string">'f'</span>, <span class="string">'d'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“å¯¹è±¡ä¼ é€’åˆ°Binderé©±åŠ¨ä¸­çš„æ—¶å€™ï¼Œç”±é©±åŠ¨æ¥è¿›è¡Œç¿»è¯‘å’Œè§£é‡Šï¼Œç„¶åä¼ é€’åˆ°æ¥æ”¶çš„è¿›ç¨‹ã€‚</p><p>ä¾‹å¦‚å½“ServeræŠŠBinderå®ä½“ä¼ é€’ç»™Clientæ—¶ï¼Œåœ¨å‘é€æ•°æ®æµä¸­ï¼Œflat_binder_objectä¸­çš„typeæ˜¯BINDER_TYPE_BINDERï¼ŒåŒæ—¶binderå­—æ®µæŒ‡å‘Serverè¿›ç¨‹ç”¨æˆ·ç©ºé—´åœ°å€ã€‚ä½†è¿™ä¸ªåœ°å€å¯¹äºClientè¿›ç¨‹æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼ˆLinuxä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´æ˜¯äº’ç›¸éš”ç¦»çš„ï¼‰ï¼Œé©±åŠ¨å¿…é¡»å¯¹æ•°æ®æµä¸­çš„flat_binder_objectåšç›¸åº”çš„ç¿»è¯‘ï¼šå°†typeè¯¥æˆBINDER_TYPE_HANDLEï¼›ä¸ºè¿™ä¸ªBinderåœ¨æ¥æ”¶è¿›ç¨‹ä¸­åˆ›å»ºä½äºå†…æ ¸ä¸­çš„å¼•ç”¨å¹¶å°†å¼•ç”¨å·å¡«å…¥handleä¸­ã€‚å¯¹äºå‘ç”Ÿæ•°æ®æµä¸­å¼•ç”¨ç±»å‹çš„Binderä¹Ÿè¦åšåŒæ ·è½¬æ¢ã€‚ç»è¿‡å¤„ç†åæ¥æ”¶è¿›ç¨‹ä»æ•°æ®æµä¸­å–å¾—çš„Binderå¼•ç”¨æ‰æ˜¯æœ‰æ•ˆçš„ï¼Œæ‰å¯ä»¥å°†å…¶å¡«å…¥æ•°æ®åŒ…binder_transaction_dataçš„target.handleåŸŸï¼Œå‘Binderå®ä½“å‘é€è¯·æ±‚ã€‚</p><p>ç”±äºæ¯ä¸ªè¯·æ±‚å’Œè¯·æ±‚çš„è¿”å›éƒ½ä¼šç»å†å†…æ ¸çš„ç¿»è¯‘ï¼Œå› æ­¤è¿™ä¸ªè¿‡ç¨‹ä»è¿›ç¨‹çš„è§’åº¦æ¥çœ‹æ˜¯å®Œå…¨é€æ˜çš„ã€‚è¿›ç¨‹å®Œå…¨ä¸ç”¨æ„ŸçŸ¥è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±å¥½åƒå¯¹è±¡çœŸçš„åœ¨è¿›ç¨‹é—´æ¥å›ä¼ é€’ä¸€æ ·ã€‚</p><h4 id="2-8ã€é©±åŠ¨å±‚çš„çº¿ç¨‹ç®¡ç†"><a href="#2-8ã€é©±åŠ¨å±‚çš„çº¿ç¨‹ç®¡ç†" class="headerlink" title="2.8ã€é©±åŠ¨å±‚çš„çº¿ç¨‹ç®¡ç†"></a>2.8ã€<strong>é©±åŠ¨å±‚çš„çº¿ç¨‹ç®¡ç†</strong></h4><p>ä¸Šæ–‡å¤šæ¬¡æåˆ°ï¼ŒBinderæœ¬èº«æ˜¯C/Sæ¶æ„ã€‚ç”±Serveræä¾›æœåŠ¡ï¼Œè¢«Clientä½¿ç”¨ã€‚æ—¢ç„¶æ˜¯C/Sæ¶æ„ï¼Œå°±å¯èƒ½å­˜åœ¨å¤šä¸ªClientä¼šåŒæ—¶è®¿é—®Serverçš„æƒ…å†µã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœServeråªæœ‰ä¸€ä¸ªçº¿ç¨‹å¤„ç†å“åº”ï¼Œå°±ä¼šå¯¼è‡´å®¢æˆ·ç«¯çš„è¯·æ±‚å¯èƒ½éœ€è¦æ’é˜Ÿè€Œå¯¼è‡´å“åº”è¿‡æ…¢çš„ç°è±¡å‘ç”Ÿã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å°±æ˜¯å¼•å…¥å¤šçº¿ç¨‹ã€‚</p><p>Binderæœºåˆ¶çš„è®¾è®¡ä»æœ€åº•å±‚â€“é©±åŠ¨å±‚ï¼Œå°±è€ƒè™‘åˆ°äº†å¯¹äºå¤šçº¿ç¨‹çš„æ”¯æŒã€‚å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p><p>ä½¿ç”¨Binderçš„è¿›ç¨‹åœ¨å¯åŠ¨ä¹‹åï¼Œé€šè¿‡BINDER_SET_MAX_THREADSå‘ŠçŸ¥é©±åŠ¨å…¶æ”¯æŒçš„æœ€å¤§çº¿ç¨‹æ•°é‡ é©±åŠ¨ä¼šå¯¹çº¿ç¨‹è¿›è¡Œç®¡ç†ã€‚åœ¨binder_procç»“æ„ä¸­ï¼Œè¿™äº›å­—æ®µè®°å½•äº†è¿›ç¨‹ä¸­çº¿ç¨‹çš„ä¿¡æ¯ï¼šmax_threadsï¼Œrequested_threadsï¼Œrequested_threads_startedï¼Œready_threads binder_threadç»“æ„å¯¹åº”äº†Binderè¿›ç¨‹ä¸­çš„çº¿ç¨‹ é©±åŠ¨é€šè¿‡BR_SPAWN_LOOPERå‘½ä»¤å‘ŠçŸ¥è¿›ç¨‹éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ è¿›ç¨‹é€šè¿‡BC_ENTER_LOOPERå‘½ä»¤å‘ŠçŸ¥é©±åŠ¨å…¶ä¸»çº¿ç¨‹å·²ç»ready è¿›ç¨‹é€šè¿‡BC_REGISTER_LOOPERå‘½ä»¤å‘ŠçŸ¥é©±åŠ¨å…¶å­çº¿ç¨‹ï¼ˆéä¸»çº¿ç¨‹ï¼‰å·²ç»ready è¿›ç¨‹é€šè¿‡BC_EXIT_LOOPERå‘½ä»¤å‘ŠçŸ¥é©±åŠ¨å…¶çº¿ç¨‹å°†è¦é€€å‡º åœ¨çº¿ç¨‹é€€å‡ºä¹‹åï¼Œé€šè¿‡BINDER_THREAD_EXITå‘ŠçŸ¥Binderé©±åŠ¨ã€‚é©±åŠ¨å°†å¯¹åº”çš„binder_threadå¯¹è±¡é”€æ¯</p><h4 id="2-9ã€å†èŠServiceManager"><a href="#2-9ã€å†èŠServiceManager" class="headerlink" title="2.9ã€å†èŠServiceManager"></a>2.9ã€å†èŠServiceManager</h4><p>ä¸Šæ–‡å·²ç»è¯´è¿‡ï¼Œæ¯ä¸€ä¸ªBinder Serveråœ¨é©±åŠ¨ä¸­ä¼šæœ‰ä¸€ä¸ªbinder_nodeè¿›è¡Œå¯¹åº”ã€‚åŒæ—¶ï¼ŒBinderé©±åŠ¨ä¼šè´Ÿè´£åœ¨è¿›ç¨‹é—´ä¼ é€’æœåŠ¡å¯¹è±¡ï¼Œå¹¶è´Ÿè´£åº•å±‚çš„è½¬æ¢ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°ï¼Œæ¯ä¸€ä¸ªBinderæœåŠ¡éƒ½éœ€è¦æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°ã€‚ç”±ServiceManageræ¥ç®¡ç†è¿™äº›æœåŠ¡çš„æ³¨å†Œå’ŒæŸ¥æ‰¾ã€‚</p><p>è€Œå®é™…ä¸Šï¼Œä¸ºäº†ä¾¿äºä½¿ç”¨ï¼ŒServiceManageræœ¬èº«ä¹Ÿå®ç°ä¸ºä¸€ä¸ªServerå¯¹è±¡ã€‚ä»»ä½•è¿›ç¨‹åœ¨ä½¿ç”¨ServiceManagerçš„æ—¶å€™ï¼Œéƒ½éœ€è¦å…ˆæ‹¿åˆ°æŒ‡å‘å®ƒçš„æ ‡è¯†ã€‚ç„¶åé€šè¿‡è¿™ä¸ªæ ‡è¯†æ¥ä½¿ç”¨ServiceManagerã€‚</p><p>è¿™ä¼¼ä¹å½¢æˆäº†ä¸€ä¸ªäº’ç›¸çŸ›ç›¾çš„ç°è±¡ï¼š</p><p>é€šè¿‡ServiceManageræˆ‘ä»¬æ‰èƒ½æ‹¿åˆ°Serverçš„æ ‡è¯† ServiceManageræœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªServer è§£å†³è¿™ä¸ªçŸ›ç›¾çš„åŠæ³•å…¶å®ä¹Ÿå¾ˆç®€å•ï¼šBinderæœºåˆ¶ä¸ºServiceManageré¢„ç•™äº†ä¸€ä¸ªç‰¹æ®Šçš„ä½ç½®ã€‚è¿™ä¸ªä½ç½®æ˜¯é¢„å…ˆå®šå¥½çš„ï¼Œä»»ä½•æƒ³è¦ä½¿ç”¨ServiceManagerçš„è¿›ç¨‹åªè¦é€šè¿‡è¿™ä¸ªç‰¹å®šçš„ä½ç½®å°±å¯ä»¥è®¿é—®åˆ°ServiceManageräº†ï¼ˆè€Œä¸ç”¨å†é€šè¿‡ServiceManagerçš„æ¥å£ï¼‰ã€‚</p><p>åœ¨Binderé©±åŠ¨ä¸­ï¼Œæœ‰ä¸€ä¸ªå…¨å±€çš„binder_node å˜é‡ï¼š</p><blockquote><p><strong>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹äºæ¯ä¸€ä¸ªServeré©±åŠ¨å±‚ä¼šå¯¹åº”ä¸€ä¸ªbinder_nodeèŠ‚ç‚¹ï¼Œç„¶è€Œbinder_context_mgr_nodeæ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ²¡æœ‰å¯¹åº”çš„åº”ç”¨å±‚binderå®ä½“ã€‚åœ¨æ•´ä¸ªç³»ç»Ÿé‡Œï¼Œå®ƒæ˜¯å¦‚æ­¤ç‰¹æ®Šï¼Œä»¥è‡³äºç³»ç»Ÿè§„å®šï¼Œä»»ä½•åº”ç”¨éƒ½å¿…é¡»ä½¿ç”¨å¥æŸ„0æ¥è·¨è¿›ç¨‹åœ°è®¿é—®å®ƒã€‚</strong></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">binder_context_mgr_node</span>;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå˜é‡æŒ‡å‘çš„å°±æ˜¯ServiceManagerã€‚</p><p>å½“æœ‰è¿›ç¨‹é€šè¿‡ioctlå¹¶æŒ‡å®šå‘½ä»¤ä¸ºBINDER_SET_CONTEXT_MGRçš„æ—¶å€™ï¼Œé©±åŠ¨è¢«è®¤å®šè¿™ä¸ªè¿›ç¨‹æ˜¯ServiceManagerï¼Œbinder_ioctl()å‡½æ•°ä¸­å¯¹åº”çš„å¤„ç†å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BINDER_SET_CONTEXT_MGR:</span><br><span class="line">    <span class="keyword">if</span> (binder_context_mgr_node != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = security_binder_set_context_mgr(proc-&gt;tsk);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    binder_context_mgr_uid = current-&gt;cred-&gt;euid;</span><br><span class="line">    binder_context_mgr_node = binder_new_node(proc, <span class="number">0</span>, <span class="number">0</span>);<span class="comment">//åœ¨Binderé©±åŠ¨å±‚åˆ›å»ºbinder_nodeç»“æ„ä½“å¯¹è±¡</span></span><br><span class="line">    binder_context_mgr_node-&gt;local_weak_refs++;</span><br><span class="line">    binder_context_mgr_node-&gt;local_strong_refs++;</span><br><span class="line">    binder_context_mgr_node-&gt;has_strong_ref = <span class="number">1</span>;</span><br><span class="line">    binder_context_mgr_node-&gt;has_weak_ref = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>ServiceManageråº”å½“è¦å…ˆäºæ‰€æœ‰Binder Serverä¹‹å‰å¯åŠ¨ã€‚åœ¨å®ƒå¯åŠ¨å®Œæˆå¹¶å‘ŠçŸ¥Binderé©±åŠ¨ä¹‹åï¼Œé©±åŠ¨ä¾¿è®¾å®šå¥½äº†è¿™ä¸ªç‰¹å®šçš„èŠ‚ç‚¹ã€‚</p><p>åœ¨è¿™ä¹‹åï¼Œå½“æœ‰å…¶ä»–æ¨¡å—æƒ³è¦ä½¿ç”¨ServerManagerçš„æ—¶å€™ï¼Œåªè¦å°†è¯·æ±‚æŒ‡å‘ServiceManageræ‰€åœ¨çš„ä½ç½®å³å¯ã€‚</p><p>åœ¨Binderé©±åŠ¨ä¸­ï¼Œé€šè¿‡handle = 0è¿™ä¸ªä½ç½®æ¥è®¿é—®ServiceManagerã€‚ä¾‹å¦‚ï¼Œbinder_transactionä¸­ï¼Œåˆ¤æ–­å¦‚æœtarget.handlerä¸º0ï¼Œåˆ™è®¤ä¸ºè¿™ä¸ªè¯·æ±‚æ˜¯å‘é€ç»™ServiceManagerçš„ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tr-&gt;target.handle) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></span><br><span class="line">    ref = binder_get_ref(proc, tr-&gt;target.handle, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (ref == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        binder_user_error(<span class="string">"%d:%d got transaction to invalid handle\n"</span>,</span><br><span class="line">            proc-&gt;pid, thread-&gt;pid);</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_invalid_target_handle;</span><br><span class="line">    &#125;</span><br><span class="line">    target_node = ref-&gt;node;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    target_node = binder_context_mgr_node;</span><br><span class="line">    <span class="keyword">if</span> (target_node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        return_error = BR_DEAD_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_no_context_mgr_node;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-10ã€binder-nodeç­‰é‡è¦ç»“æ„ä½“"><a href="#2-10ã€binder-nodeç­‰é‡è¦ç»“æ„ä½“" class="headerlink" title="2.10ã€binder_nodeç­‰é‡è¦ç»“æ„ä½“"></a>2.10ã€binder_nodeç­‰é‡è¦ç»“æ„ä½“</h4><blockquote><p>binder_proc binder_node binder_thread binder_ref binder_buffer</p></blockquote><p><strong>1. Binderå®ä½“binder_node</strong></p><p>Binderå®ä½“ï¼Œæ˜¯å„ä¸ªServerä»¥åŠServiceManageråœ¨å†…æ ¸ä¸­çš„å­˜åœ¨å½¢å¼ã€‚ Binderå®ä½“å®é™…ä¸Šæ˜¯å†…æ ¸ä¸­binder_nodeç»“æ„ä½“çš„å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨å†…æ ¸ä¸­ä¿å­˜Serverå’ŒServiceManagerçš„ä¿¡æ¯(ä¾‹å¦‚ï¼ŒBinderå®ä½“ä¸­ä¿å­˜äº†Serverå¯¹è±¡åœ¨ç”¨æˆ·ç©ºé—´çš„åœ°å€)ã€‚ç®€è¨€ä¹‹ï¼ŒBinderå®ä½“æ˜¯Serveråœ¨Binderé©±åŠ¨ä¸­çš„å­˜åœ¨å½¢å¼ï¼Œå†…æ ¸é€šè¿‡Binderå®ä½“å¯ä»¥æ‰¾åˆ°ç”¨æˆ·ç©ºé—´çš„Serverå¯¹è±¡ã€‚ åœ¨ä¸Šå›¾ä¸­ï¼ŒServerå’ŒServiceManageråœ¨Binderé©±åŠ¨ä¸­éƒ½å¯¹åº”çš„å­˜åœ¨ä¸€ä¸ªBinderå®ä½“ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/26-Android-Binder_node_struct.png" alt="Markdown"></p><p><strong>2. Binderå¼•ç”¨binder_ref</strong></p><p>è¯´åˆ°Binderå®ä½“ï¼Œå°±ä¸å¾—ä¸è¯´â€Binderå¼•ç”¨â€ã€‚æ‰€è°“Binderå¼•ç”¨ï¼Œå®é™…ä¸Šæ˜¯å†…æ ¸ä¸­binder_refç»“æ„ä½“çš„å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨è¡¨ç¤ºâ€Binderå®ä½“â€çš„å¼•ç”¨ã€‚æ¢å¥è¯è¯´ï¼Œæ¯ä¸€ä¸ªBinderå¼•ç”¨éƒ½æ˜¯æŸä¸€ä¸ªBinderå®ä½“çš„å¼•ç”¨ï¼Œé€šè¿‡Binderå¼•ç”¨å¯ä»¥åœ¨å†…æ ¸ä¸­æ‰¾åˆ°å®ƒå¯¹åº”çš„Binderå®ä½“ã€‚ å¦‚æœå°†Serverçœ‹ä½œæ˜¯Binderå®ä½“çš„è¯ï¼Œé‚£ä¹ˆClientå°±å¥½æ¯”Binderå¼•ç”¨ã€‚Clientè¦å’ŒServeré€šä¿¡ï¼Œå®ƒå°±æ˜¯é€šè¿‡ä¿å­˜ä¸€ä¸ªServerå¯¹è±¡çš„Binderå¼•ç”¨ï¼Œå†é€šè¿‡è¯¥Binderå¼•ç”¨åœ¨å†…æ ¸ä¸­æ‰¾åˆ°å¯¹åº”çš„Binderå®ä½“ï¼Œè¿›è€Œæ‰¾åˆ°Serverå¯¹è±¡ï¼Œç„¶åå°†é€šä¿¡å†…å®¹å‘é€ç»™Serverå¯¹è±¡ã€‚</p><p>Binderå®ä½“å’ŒBinderå¼•ç”¨éƒ½æ˜¯å†…æ ¸(å³ï¼ŒBinderé©±åŠ¨)ä¸­çš„æ•°æ®ç»“æ„ã€‚æ¯ä¸€ä¸ªServeråœ¨å†…æ ¸ä¸­å°±è¡¨ç°ä¸ºä¸€ä¸ªBinderå®ä½“ï¼Œè€Œæ¯ä¸€ä¸ªClientåˆ™è¡¨ç°ä¸ºä¸€ä¸ªBinderå¼•ç”¨ã€‚è¿™æ ·ï¼Œæ¯ä¸ªBinderå¼•ç”¨éƒ½å¯¹åº”ä¸€ä¸ªBinderå®ä½“ï¼Œè€Œæ¯ä¸ªBinderå®ä½“åˆ™å¯ä»¥å¤šä¸ªBinderå¼•ç”¨ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/24-Android-binder_ref.png" alt="Markdown"></p><p><strong>3ã€Binder bufferï¼šbinder_buffer</strong><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/99-Android-Binder-IPCall.png" alt="Markdown"></p><p><strong>4ã€Binderè¿›ç¨‹binder_proc</strong></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/25-Android-binder_proc.png" alt="Markdown"></p><p><strong>5ã€Binderçº¿ç¨‹binder_thread</strong><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/27-Android-binder_thread.png" alt="Markdown"></p><p>binderæœºåˆ¶åˆ°åº•æ˜¯å¦‚ä½•ä»Binderå¯¹è±¡æ‰¾åˆ°å…¶å¯¹åº”çš„Binderå®ä½“å‘¢ï¼Ÿ<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/28-Android-Bp-Bbinder.png" alt="Markdown"></p><p>æ³¨æ„å…¶ä¸­çš„é‚£4ä¸ªrb_rootåŸŸï¼Œâ€rbâ€çš„æ„æ€æ˜¯â€red blackâ€ï¼Œå¯è§binder_procé‡Œæå‡ºäº†4ä¸ªçº¢é»‘æ ‘ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/29-Android-binder_proc_red_root.png" alt="Markdown"></p><p>å…¶ä¸­ï¼Œnodesæ ‘ç”¨äºè®°å½•binderå®ä½“ï¼Œrefs_by_descæ ‘å’Œrefs_by_nodeæ ‘åˆ™ç”¨äºè®°å½•binderä»£ç†ã€‚ä¹‹æ‰€ä»¥ä¼šæœ‰ä¸¤ä¸ªä»£ç†æ ‘ï¼Œæ˜¯ä¸ºäº†ä¾¿äºå¿«é€ŸæŸ¥æ‰¾ï¼Œæˆ‘ä»¬æš‚æ—¶åªå…³å¿ƒå…¶ä¸­ä¹‹ä¸€å°±å¯ä»¥äº†ã€‚threadsæ ‘ç”¨äºè®°å½•æ‰§è¡Œä¼ è¾“åŠ¨ä½œçš„çº¿ç¨‹ä¿¡æ¯ã€‚</p><p>åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæœ‰å¤šå°‘â€è¢«å…¶ä»–è¿›ç¨‹è¿›è¡Œè·¨è¿›ç¨‹è°ƒç”¨çš„â€binderå®ä½“ï¼Œå°±ä¼šåœ¨è¯¥è¿›ç¨‹å¯¹åº”çš„nodesæ ‘ä¸­ç”Ÿæˆå¤šå°‘ä¸ªçº¢é»‘æ ‘èŠ‚ç‚¹ã€‚å¦ä¸€æ–¹é¢ï¼Œä¸€ä¸ªè¿›ç¨‹è¦è®¿é—®å¤šå°‘å…¶ä»–è¿›ç¨‹çš„binderå®ä½“ï¼Œåˆ™å¿…é¡»åœ¨å…¶refs_by_descæ ‘ä¸­æ‹¥æœ‰å¯¹åº”çš„å¼•ç”¨èŠ‚ç‚¹ã€‚</p><p>è¿™4æ£µæ ‘çš„èŠ‚ç‚¹ç±»å‹æ˜¯ä¸åŒçš„ï¼Œthreadsæ ‘çš„èŠ‚ç‚¹ç±»å‹ä¸ºbinder_threadï¼Œnodesæ ‘çš„èŠ‚ç‚¹ç±»å‹ä¸ºbinder_nodeï¼Œrefs_by_descæ ‘å’Œrefs_by_nodeæ ‘çš„èŠ‚ç‚¹ç±»å‹ç›¸åŒï¼Œä¸ºbinder_refã€‚è¿™äº›èŠ‚ç‚¹å†…éƒ¨éƒ½ä¼šåŒ…å«rb_nodeå­ç»“æ„ï¼Œè¯¥ç»“æ„ä¸“é—¨è´Ÿè´£è¿æ¥èŠ‚ç‚¹çš„å·¥ä½œï¼Œå’Œå‰æ–‡çš„hlist_nodeæœ‰ç‚¹å„¿å¼‚æ›²åŒå·¥ï¼Œè¿™ä¹Ÿæ˜¯linuxä¸Šä¸€ä¸ªå¸¸ç”¨çš„å°æŠ€å·§ã€‚æˆ‘ä»¬ä»¥nodesæ ‘ä¸ºä¾‹<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/30-Android-binder_proc_hlist_node.png" alt="Markdown"></p><p>nodesæ ‘æ˜¯ç”¨äºè®°å½•binderå®ä½“çš„ï¼Œæ‰€ä»¥nodesæ ‘ä¸­çš„æ¯ä¸ªbinder_nodeèŠ‚ç‚¹ï¼Œå¿…é¡»èƒ½å¤Ÿè®°å½•ä¸‹ç›¸åº”binderå®ä½“çš„ä¿¡æ¯ã€‚å› æ­¤è¯·å¤§å®¶æ³¨æ„binder_nodeçš„ptråŸŸå’ŒcookieåŸŸã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œrefs_by_descæ ‘å’Œrefs_by_nodeæ ‘çš„æ¯ä¸ªbinder_refèŠ‚ç‚¹åˆ™å’Œä¸Šå±‚çš„ä¸€ä¸ªBpBinderå¯¹åº”ï¼Œè€Œä¸”æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒå¿…é¡»å…·æœ‰å’Œâ€ç›®æ ‡binderå®ä½“çš„binder_nodeâ€è¿›è¡Œå…³è”çš„ä¿¡æ¯ã€‚</p><p>è¯·æ³¨æ„binder_refçš„é‚£ä¸ªnodeåŸŸï¼Œå®ƒè´Ÿè´£å’Œbinder_nodeå…³è”ã€‚å¦å¤–ï¼Œbinder_refä¸­æœ‰ä¸¤ä¸ªç±»å‹ä¸ºrb_nodeçš„åŸŸï¼šrb_node_descåŸŸå’Œrb_node_nodeåŸŸï¼Œå®ƒä»¬åˆ†åˆ«ç”¨äºè¿æ¥refs_by_descæ ‘å’Œrefs_by_nodeã€‚ä¹Ÿå°±æ˜¯è¯´è™½ç„¶binder_procä¸­æœ‰ä¸¤æ£µå¼•ç”¨æ ‘ï¼Œä½†è¿™ä¸¤æ£µæ ‘ç”¨åˆ°çš„å…·ä½“binder_refèŠ‚ç‚¹å…¶å®æ˜¯å¤ç”¨çš„ã€‚</p><blockquote><p>binder_node.ptrå¯¹åº”äºflat_binder_object.binderï¼› binder_node.cookieå¯¹åº”äºflat_binder_object.cookieã€‚</p></blockquote><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/31-Android-binder_ref-find-binder_node.png" alt="Markdown"><br>OKï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ›´æ·±å…¥åœ°è¯´æ˜binderå¥æŸ„çš„ä½œç”¨äº†ï¼Œæ¯”å¦‚è¿›ç¨‹1çš„BpBinderåœ¨å‘èµ·è·¨è¿›ç¨‹è°ƒç”¨æ—¶ï¼Œå‘binderé©±åŠ¨ä¼ å…¥äº†è‡ªå·±è®°å½•çš„å¥æŸ„å€¼ï¼Œbinderé©±åŠ¨å°±ä¼šåœ¨â€è¿›ç¨‹1å¯¹åº”çš„binder_procç»“æ„â€çš„å¼•ç”¨æ ‘ä¸­æŸ¥æ‰¾å’Œå¥æŸ„å€¼ç›¸ç¬¦çš„binder_refèŠ‚ç‚¹ï¼Œä¸€æ—¦æ‰¾åˆ°binder_refèŠ‚ç‚¹ï¼Œå°±å¯ä»¥é€šè¿‡è¯¥èŠ‚ç‚¹çš„nodeåŸŸæ‰¾åˆ°å¯¹åº”çš„binder_nodeèŠ‚ç‚¹ï¼Œè¿™ä¸ªç›®æ ‡binder_nodeå½“ç„¶æ˜¯ä»å±äºè¿›ç¨‹2çš„binder_procå•¦ï¼Œä¸è¿‡ä¸è¦ç´§ï¼Œå› ä¸ºbinder_refå’Œbinder_nodeéƒ½å¤„äºbinderé©±åŠ¨çš„åœ°å€ç©ºé—´ä¸­ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ç”¨æŒ‡é’ˆç›´æ¥æŒ‡å‘çš„ã€‚ç›®æ ‡binder_nodeèŠ‚ç‚¹çš„cookieåŸŸï¼Œè®°å½•çš„å…¶å®æ˜¯è¿›ç¨‹2ä¸­BBinderçš„åœ°å€ï¼Œbinderé©±åŠ¨åªéœ€æŠŠè¿™ä¸ªå€¼åæ˜ ç»™åº”ç”¨å±‚ï¼Œåº”ç”¨å±‚å°±å¯ä»¥ç›´æ¥æ‹¿åˆ°BBinderäº†ã€‚è¿™å°±æ˜¯Binderå®Œæˆç²¾ç¡®æ‰“å‡»çš„å¤§ä½“è¿‡ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/32-Android-binder_relationship.jpg" alt="Markdown"></p><h2 id="ä¸‰ã€Android-Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æ"><a href="#ä¸‰ã€Android-Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æ" class="headerlink" title="ä¸‰ã€Android Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æ"></a>ä¸‰ã€Android Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æ</h2><p>ä¸ºäº†æ›´æ·±åˆ»çš„äº†è§£Binderç³»ç»Ÿ æ³¨å†ŒæœåŠ¡ã€è·å–æœåŠ¡ã€ä½¿ç”¨æœåŠ¡çš„è¿‡ç¨‹ï¼Œåœ¨Driverå±‚(kernel/drivers/staging/android/binder.c)çš„binder_thread_read()å‡½æ•°ã€binder_transaction()å‡½æ•°å…¥æ‰“å°logï¼Œè®©å‰é¢ç¼–å†™çš„Cç¨‹åºç¤ºä¾‹ä¸binderé©±åŠ¨äº¤äº’æ‰“å°æ›´è¯¦ç»†çš„è¿‡ç¨‹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc, struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">void</span> __user *buffer, <span class="keyword">int</span> size, <span class="keyword">signed</span> <span class="keyword">long</span> *consumed)</span></span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/weidongshan/DRV_0003_Binder/" target="_blank" rel="noopener">å·²æ·»åŠ å¥½æ‰“å°logçš„binder.cæ–‡ä»¶è§GitHubï¼ˆæ³¨ï¼šæœç´¢[/* print] å…³é”®å­—ï¼‰</a> äº‹å…ˆå·²ç»å‡†å¤‡å¥½æ‰“å°logï¼Œç°åœ¨ç»“åˆlogå’ŒBinderäº‹åŠ¡å¤„ç†å¼€å§‹è¯¦ç»†åˆ†æã€‚æ³¨ï¼šlogç¨ååˆ†æå†è´´å‡ºã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/33-Android-binder_transaction_ipc.jpg" alt="Markdown"></p><h3 id="ï¼ˆ1ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“æœåŠ¡â€Helloâ€æ³¨å†Œè¿‡ç¨‹"><a href="#ï¼ˆ1ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“æœåŠ¡â€Helloâ€æ³¨å†Œè¿‡ç¨‹" class="headerlink" title="ï¼ˆ1ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“æœåŠ¡â€Helloâ€æ³¨å†Œè¿‡ç¨‹"></a>ï¼ˆ1ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“æœåŠ¡â€Helloâ€æ³¨å†Œè¿‡ç¨‹</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/35-Android-binder-add_service.png" alt="Markdown"></p><h4 id="1-1ã€ServiceManagerä¼‘çœ ç­‰å¾…"><a href="#1-1ã€ServiceManagerä¼‘çœ ç­‰å¾…" class="headerlink" title="1.1ã€ServiceManagerä¼‘çœ ç­‰å¾…"></a>1.1ã€ServiceManagerä¼‘çœ ç­‰å¾…</h4><p>å›é¡¾ä¸€ä¸‹ServiceManagerå¯åŠ¨æµç¨‹ï¼ŒServiceManagerè¿›å…¥binder_loop()å ä¼šä¼‘çœ ç­‰å¾…å“åº”clientè¯·æ±‚ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">binder_loop()&#123;</span><br><span class="line">    <span class="comment">// å‘Šè¯‰Kernelï¼ŒServiceManagerè¿›ç¨‹è¿›å…¥äº†æ¶ˆæ¯å¾ªç¯çŠ¶æ€ã€‚</span></span><br><span class="line">    readbuf[<span class="number">0</span>] = BC_ENTER_LOOPER;</span><br><span class="line">    binder_write(bs, readbuf, <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span>));</span><br><span class="line"></span><br><span class="line">    bwr.write_size = <span class="number">0</span>;</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        bwr.read_size = <span class="keyword">sizeof</span>(readbuf);</span><br><span class="line">        bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = (<span class="keyword">unsigned</span>) readbuf;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘Kernelä¸­å‘é€æ¶ˆæ¯(å…ˆå†™åè¯»)ã€‚</span></span><br><span class="line">        <span class="comment">// å…ˆå°†æ¶ˆæ¯ä¼ é€’ç»™Kernelï¼Œç„¶åå†ä»Kernelè¯»å–æ¶ˆæ¯åé¦ˆ</span></span><br><span class="line">        res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line">        <span class="comment">// è§£æè¯»å–çš„æ¶ˆæ¯åé¦ˆ</span></span><br><span class="line">        res = binder_parse(bs, <span class="number">0</span>, readbuf, bwr.read_consumed, func);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>binder_write(bs, readbuf, sizeof(unsigned));ä¼šè°ƒç”¨ioctlå‘å†…æ ¸å‘é€æ•°æ®ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">binder_write</span><span class="params">(struct binder_state *bs, <span class="keyword">void</span> *data, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line"></span><br><span class="line">    bwr.write_size = len;</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">uintptr_t</span>) data;</span><br><span class="line">    bwr.read_size = <span class="number">0</span>;</span><br><span class="line">    bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.read_buffer = <span class="number">0</span>;</span><br><span class="line">    res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœ bwr.write_size &gt; 0ï¼Œåˆ™è°ƒç”¨binder_thread_write å¦‚æœ bwr.read_size &gt;0ï¼Œåˆ™è°ƒç”¨binder_thread_read</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">thread</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> size = _IOC_SIZE(cmd);</span><br><span class="line">  <span class="keyword">void</span> __user *ubuf = (<span class="keyword">void</span> __user *)arg;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸­æ–­ç­‰å¾…å‡½æ•°ã€‚</span></span><br><span class="line">  ret = wait_event_interruptible(...);</span><br><span class="line">  <span class="comment">// åœ¨procè¿›ç¨‹ä¸­æŸ¥æ‰¾è¯¥çº¿ç¨‹å¯¹åº”çš„binder_threadï¼›è‹¥æŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™æ–°å»ºä¸€ä¸ªbinder_threadï¼Œå¹¶æ·»åŠ åˆ°proc-&gt;threadsä¸­ã€‚</span></span><br><span class="line">  thread = binder_get_thread(proc);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">  <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// å°†binder_write_readä»"ç”¨æˆ·ç©ºé—´" æ‹·è´åˆ° "å†…æ ¸ç©ºé—´"</span></span><br><span class="line">      <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚æœwrite_size&gt;0ï¼Œåˆ™è¿›è¡Œå†™æ“ä½œ</span></span><br><span class="line">      <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚æœread_size&gt;0ï¼Œåˆ™è¿›è¡Œè¯»æ“ä½œ</span></span><br><span class="line">      <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags   &amp; O_NONBLOCK);</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bwr.write_size &gt; 0; ç»§ç»­æŸ¥çœ‹binder_thread_write()</p><blockquote><p>æ³¨ï¼šåªæœ‰BR_TRANSACTIONã€BR_REPLYã€BC_TRANSACTIONã€BC_REPLYæ¶‰åŠä¸¤è¿›ç¨‹ å…¶ä»–æ‰€æœ‰BC_XXXã€BR_XXXéƒ½åªæ˜¯Appå’Œé©±åŠ¨äº¤äº’ç”¨äºæ”¹å˜æŠ¥å‘ŠçŠ¶æ€ã€‚</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc, struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">void</span> __user *buffer, <span class="keyword">int</span> size, <span class="keyword">signed</span> <span class="keyword">long</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">  <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">  <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯»å–binder_write_read.write_bufferä¸­çš„å†…å®¹ã€‚</span></span><br><span class="line">  <span class="comment">// æ¯æ¬¡è¯»å–32bit(å³4ä¸ªå­—èŠ‚)</span></span><br><span class="line">  <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;</span><br><span class="line">      <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è¯»å–32bitåˆ°å†…æ ¸ä¸­ï¼Œå¹¶èµ‹å€¼ç»™cmdã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (get_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">          <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">      ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">      <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> BC_ENTER_LOOPER:</span><br><span class="line">            thread-&gt;looper |= BINDER_LOOPER_STATE_ENTERED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°bwr.write_consumedçš„å€¼</span></span><br><span class="line">      *consumed = ptr - buffer;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å‰çº¿ç¨‹è¿›å…¥BC_ENTER_LOOPERçŠ¶æ€ï¼Œç­‰å¾…è¯·æ±‚ã€‚ ç»§ç»­binder_loop()ä¸­çš„for(;;;)å¾ªç¯ï¼Œbwr.read_size &gt;0;ä¼šé€šè¿‡binder_thread_read()è¯»æ“ä½œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">  <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line">  <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> wait_for_proc_work;</span><br><span class="line">  <span class="comment">// å¦‚æœ*consumed=0ï¼Œåˆ™å†™å…¥BR_NOOPåˆ°ç”¨æˆ·ä¼ è¿›æ¥çš„bwr.read_bufferç¼“å­˜åŒº</span></span><br><span class="line">  <span class="keyword">if</span> (*consumed == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (put_user(BR_NOOP, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">          <span class="keyword">return</span> -EFAULT;</span><br><span class="line">      <span class="comment">// ä¿®æ”¹æŒ‡é’ˆä½ç½®</span></span><br><span class="line">      ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é©±åŠ¨put_user(BR_NOOP, (uint32_t __user *)ptr)å‘é€BR_NOOPåˆ°ServiceManager</p><blockquote><p>å¯¹äºæ‰€æœ‰çš„è¯»æ“ä½œï¼Œæ•°æ®å¤´éƒ½æ˜¯BR_NOOPï¼Œå¦‚BR_REPLY<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/36-Android-binder-BWR-read-BR_NOOP.png" alt="Markdown"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;  ./service_manager &amp;</span><br><span class="line">&gt; [   32.566620] service_manager (1362, 1362), binder_thread_write : BC_ENTER_LOOPER</span><br><span class="line">&gt; [   32.566712] service_manager (1362, 1362), binder_thread_read : BR_NOOP</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><h4 id="1-2ã€Clentï¼ˆæ­¤å¤„ä¸ºTest-serverï¼‰è¯·æ±‚SMæ·»åŠ æœåŠ¡"><a href="#1-2ã€Clentï¼ˆæ­¤å¤„ä¸ºTest-serverï¼‰è¯·æ±‚SMæ·»åŠ æœåŠ¡" class="headerlink" title="1.2ã€Clentï¼ˆæ­¤å¤„ä¸ºTest_serverï¼‰è¯·æ±‚SMæ·»åŠ æœåŠ¡"></a>1.2ã€Clentï¼ˆæ­¤å¤„ä¸ºTest_serverï¼‰è¯·æ±‚SMæ·»åŠ æœåŠ¡</h4><p><strong>æ„é€ æ•°æ®å‘é€ç»™é©±åŠ¨</strong> æˆ‘ä»¬æ‰§è¡ŒTest_serveræ—¶ï¼Œæ‰“å°äº†å¾ˆå¤šæ•°æ®ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹æ•°æ®çš„æ„é€ è¿‡ç¨‹ å’Œ ç»„ç»‡æ ¼å¼ï¼Œè¿™æœ‰åŠ©äºåŠ æ·±æˆ‘ä»¬å¯¹binderç³»ç»Ÿçš„ç†è§£ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">svcmgr_publish</span><span class="params">(struct binder_state *bs, <span class="keyword">uint32_t</span> target, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">unsigned</span> iodata[<span class="number">512</span>/<span class="number">4</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">msg</span>, <span class="title">reply</span>;</span></span><br><span class="line"></span><br><span class="line">    bio_init(&amp;msg, iodata, <span class="keyword">sizeof</span>(iodata), <span class="number">4</span>);</span><br><span class="line">    bio_put_uint32(&amp;msg, <span class="number">0</span>);  <span class="comment">// strict mode header</span></span><br><span class="line">    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);</span><br><span class="line">    bio_put_string16_x(&amp;msg, name);</span><br><span class="line">    bio_put_obj(&amp;msg, ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    status = bio_get_uint32(&amp;reply);</span><br><span class="line">    binder_done(bs, &amp;msg, &amp;reply);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bio_init()ã€bio_put_uint32()ã€bio_put_string16_x()å‡½æ•°æ¯”è¾ƒç®€æ´ã€‚æˆ‘ä»¬çœ‹ä¸‹bio_put_obj()å‡½æ•°ã€‚ æ„å»ºåˆå§‹åŒ–flat_binder_objectç»“æ„ä½“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void bio_put_obj(struct binder_io *bio, void *ptr)</span><br><span class="line">&#123;</span><br><span class="line">    struct flat_binder_object *obj;</span><br><span class="line"></span><br><span class="line">    obj = bio_alloc_obj(bio);</span><br><span class="line">    if (!obj)</span><br><span class="line">        return;</span><br><span class="line"></span><br><span class="line">    obj-&gt;flags = 0x7f | FLAT_BINDER_FLAG_ACCEPTS_FDS;//</span><br><span class="line">    obj-&gt;type = BINDER_TYPE_BINDER;//</span><br><span class="line">    obj-&gt;binder = (uintptr_t)ptr;//</span><br><span class="line">    obj-&gt;cookie = 0;//0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®ç»“æ„ç¤ºæ„å›¾ï¼š</strong></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/37-Android-binder-Binder-io-transaction-data.jpg" alt="Markdown"></p><p>Clentï¼ˆæ­¤å¤„ä¸ºTest_serverï¼‰ï¼Œtest_server.cè°ƒç”¨æµç¨‹ï¼š -&gt;svcmgr_publish() -&gt;binder_call() -&gt;ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr) -&gt;binder_thread_write() -&gt;binder_transaction()</p><p>ç°åœ¨æ•°æ®æ„é€ å¥½äº†ï¼Œbinder_call()ä¼šè°ƒç”¨ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_call</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct binder_io *msg, struct binder_io *reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">uint32_t</span> target, <span class="keyword">uint32_t</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">txn</span>;</span></span><br><span class="line">    &#125; __attribute__((packed)) writebuf;</span><br><span class="line">    <span class="keyword">unsigned</span> readbuf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    writebuf.cmd = BC_TRANSACTION;</span><br><span class="line">    writebuf.txn.target.handle = target;</span><br><span class="line">    writebuf.txn.code = code;</span><br><span class="line">    writebuf.txn.flags = <span class="number">0</span>;</span><br><span class="line">    writebuf.txn.data_size = msg-&gt;data - msg-&gt;data0;</span><br><span class="line">    writebuf.txn.offsets_size = ((<span class="keyword">char</span>*) msg-&gt;offs) - ((<span class="keyword">char</span>*) msg-&gt;offs0);</span><br><span class="line">    writebuf.txn.data.ptr.buffer = (<span class="keyword">uintptr_t</span>)msg-&gt;data0;</span><br><span class="line">    writebuf.txn.data.ptr.offsets = (<span class="keyword">uintptr_t</span>)msg-&gt;offs0;</span><br><span class="line"></span><br><span class="line">    bwr.write_size = <span class="keyword">sizeof</span>(writebuf);</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">uintptr_t</span>) &amp;writebuf;</span><br><span class="line"></span><br><span class="line">    hexdump(msg-&gt;data0, msg-&gt;data - msg-&gt;data0);</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        bwr.read_size = <span class="keyword">sizeof</span>(readbuf);</span><br><span class="line">        bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = (<span class="keyword">uintptr_t</span>) readbuf;</span><br><span class="line"></span><br><span class="line">        res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line">        ...</span><br><span class="line">        res = binder_parse(bs, reply, (<span class="keyword">uintptr_t</span>) readbuf, bwr.read_consumed, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[ 38.320197] test_server (1363, 1363), binder_thread_write : BC_TRANSACTION å‘é€æ•°æ®ï¼Œè¿›è€Œä¼šè°ƒç”¨binder_thread_write()å¤„ç†æ•°æ®ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">binder_ioctl(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">thread</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> size = _IOC_SIZE(cmd);</span><br><span class="line">  <span class="keyword">void</span> __user *ubuf = (<span class="keyword">void</span> __user *)arg;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸­æ–­ç­‰å¾…å‡½æ•°ã€‚</span></span><br><span class="line">  ret = wait_event_interruptible(...);</span><br><span class="line">  <span class="comment">// åœ¨procè¿›ç¨‹ä¸­æŸ¥æ‰¾è¯¥çº¿ç¨‹å¯¹åº”çš„binder_threadï¼›è‹¥æŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™æ–°å»ºä¸€ä¸ªbinder_threadï¼Œå¹¶æ·»åŠ åˆ°proc-&gt;threadsä¸­ã€‚</span></span><br><span class="line">  thread = binder_get_thread(proc);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">  <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// å°†binder_write_readä»"ç”¨æˆ·ç©ºé—´" æ‹·è´åˆ° "å†…æ ¸ç©ºé—´"</span></span><br><span class="line">      <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚æœwrite_size&gt;0ï¼Œåˆ™è¿›è¡Œå†™æ“ä½œ</span></span><br><span class="line">      <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚æœread_size&gt;0ï¼Œåˆ™è¿›è¡Œè¯»æ“ä½œ</span></span><br><span class="line">      <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags   &amp; O_NONBLOCK);</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºwrite_size&gt;0ï¼Œè°ƒç”¨binder_thread_write()å¤„ç†æ•°æ®ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc, struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">void</span> __user *buffer, <span class="keyword">int</span> size, <span class="keyword">signed</span> <span class="keyword">long</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">  <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">  <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯»å–binder_write_read.write_bufferä¸­çš„å†…å®¹ã€‚</span></span><br><span class="line">  <span class="comment">// æ¯æ¬¡è¯»å–32bit(å³4ä¸ªå­—èŠ‚)</span></span><br><span class="line">  <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;</span><br><span class="line">      <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è¯»å–32bitåˆ°å†…æ ¸ä¸­ï¼Œå¹¶èµ‹å€¼ç»™cmdã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (get_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">          <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">      ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="keyword">case</span> BC_TRANSACTION:</span><br><span class="line">        <span class="keyword">case</span> BC_REPLY: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (copy_from_user(&amp;tr, ptr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(tr);</span><br><span class="line">            binder_transaction(proc, thread, &amp;tr, cmd == BC_REPLY);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°bwr.write_consumedçš„å€¼</span></span><br><span class="line">      *consumed = ptr - buffer;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¹‹å‰binder_call()åˆ†æï¼Œwritebuf.cmd = BC_TRANSACTION;ä¼šæ‰§è¡Œbinder_transaction()å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">tcomplete</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> *offp, *off_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">target_proc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">target_thread</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">target_list</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> *target_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">in_reply_to</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_log_entry</span> *<span class="title">e</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> return_error;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tr-&gt;target.handle) &#123;</span><br><span class="line">            target_node = ref-&gt;node;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// äº‹åŠ¡ç›®æ ‡å¯¹è±¡æ˜¯ServiceManagerçš„binderå®ä½“</span></span><br><span class="line">            <span class="comment">// å³ï¼Œè¯¥äº‹åŠ¡æ˜¯äº¤ç»™Service Manageræ¥å¤„ç†çš„ã€‚</span></span><br><span class="line">            target_node = binder_context_mgr_node;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¾ç½®å¤„ç†äº‹åŠ¡çš„ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">        target_proc = target_node-&gt;proc;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_thread) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        target_list = &amp;target_proc-&gt;todo;</span><br><span class="line">        target_wait = &amp;target_proc-&gt;wait;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªå¾…å¤„ç†çš„äº‹åŠ¡tï¼Œtæ˜¯binderäº‹åŠ¡(binder_transactionå¯¹è±¡)</span></span><br><span class="line">    t = kzalloc(<span class="keyword">sizeof</span>(*t), GFP_KERNEL);</span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªå¾…å®Œæˆçš„å·¥ä½œtcompleteï¼Œtcompleteæ˜¯binder_workå¯¹è±¡ã€‚</span></span><br><span class="line">    tcomplete = kzalloc(<span class="keyword">sizeof</span>(*tcomplete), GFP_KERNEL);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹åŠ¡å°†äº¤ç»™target_procè¿›ç¨‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    t-&gt;to_proc = target_proc;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡å°†äº¤ç»™target_threadçº¿ç¨‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    t-&gt;to_thread = target_thread;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ç©ºé—´,ä»ç›®çš„è¿›ç¨‹æ˜ å°„çš„ç©ºé—´åˆ†é…buf</span></span><br><span class="line">    t-&gt;buffer = binder_alloc_buf(target_proc, tr-&gt;data_size,</span><br><span class="line">        tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// ä¿å­˜äº‹åŠ¡</span></span><br><span class="line">    t-&gt;buffer-&gt;transaction = t;</span><br><span class="line">    <span class="comment">// ä¿å­˜äº‹åŠ¡çš„ç›®æ ‡å¯¹è±¡(å³å¤„ç†è¯¥äº‹åŠ¡çš„binderå¯¹è±¡)</span></span><br><span class="line">    t-&gt;buffer-&gt;target_node = target_node;</span><br><span class="line"></span><br><span class="line">    offp = (<span class="keyword">size_t</span> *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†"ç”¨æˆ·ç©ºé—´çš„æ•°æ®"æ‹·è´åˆ°å†…æ ¸ä¸­</span></span><br><span class="line">    <span class="comment">// tr-&gt;data.ptr.bufferå°±æ˜¯ç”¨æˆ·ç©ºé—´æ•°æ®çš„èµ·å§‹åœ°å€ï¼Œtr-&gt;data_sizeå°±æ˜¯æ•°æ®å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(t-&gt;buffer-&gt;data, tr-&gt;data.ptr.buffer, tr-&gt;data_size)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†"ç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¸­æ‰€å«å¯¹è±¡çš„åç§»åœ°å€"æ‹·è´åˆ°å†…æ ¸ä¸­</span></span><br><span class="line">    <span class="comment">// tr-&gt;data.ptr.offsetså°±æ˜¯æ•°æ®ä¸­çš„å¯¹è±¡åç§»åœ°å€æ•°ç»„ï¼Œtr-&gt;offsets_sizeå°±æ•°æ®ä¸­çš„å¯¹è±¡ä¸ªæ•°</span></span><br><span class="line">    <span class="comment">// æ‹·è´ä¹‹åï¼Œoffpå°±æ˜¯flat_binder_objectå¯¹è±¡æ•°ç»„åœ¨å†…æ ¸ç©ºé—´çš„åç§»æ•°ç»„çš„èµ·å§‹åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(offp, tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// off_endå°±æ˜¯flat_binder_objectå¯¹è±¡æ•°ç»„åœ¨å†…æ ¸ç©ºé—´çš„åç§»åœ°å€çš„ç»“æŸåœ°å€</span></span><br><span class="line">    off_end = (<span class="keyword">void</span> *)offp + tr-&gt;offsets_size;</span><br><span class="line">    <span class="comment">// å°†æ‰€æœ‰çš„flat_binder_objectå¯¹è±¡è¯»å–å‡ºæ¥</span></span><br><span class="line">    <span class="comment">// å¯¹TestServerè€Œè¨€ï¼Œåªæœ‰ä¸€ä¸ªflat_binder_objectå¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (; offp &lt; off_end; offp++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">flat_binder_object</span> *<span class="title">fp</span>;</span></span><br><span class="line">        ...</span><br><span class="line">        fp = (struct flat_binder_object *)(t-&gt;buffer-&gt;data + *offp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (fp-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> BINDER_TYPE_BINDER:</span><br><span class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_BINDER: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></span><br><span class="line">            <span class="comment">// åœ¨procä¸­æŸ¥æ‰¾binderå®ä½“å¯¹åº”çš„binder_node</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span> = <span class="title">binder_get_node</span>(<span class="title">proc</span>, <span class="title">fp</span>-&gt;<span class="title">binder</span>);</span></span><br><span class="line">            <span class="comment">// è‹¥æ‰¾ä¸åˆ°ï¼Œåˆ™æ–°å»ºä¸€ä¸ªbinder_nodeï¼›ä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                node = binder_new_node(proc, fp-&gt;binder, fp-&gt;cookie);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// åœ¨target_proc(å³ï¼ŒServiceManagerçš„è¿›ç¨‹ä¸Šä¸‹æ–‡)ä¸­æŸ¥æ‰¾æ˜¯å¦åŒ…è¡Œ"è¯¥Binderå®ä½“çš„å¼•ç”¨"ï¼Œ</span></span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯ï¼Œåˆ™å°†"è¯¥binderå®ä½“çš„å¼•ç”¨"æ·»åŠ åˆ°target_proc-&gt;refs_by_nodeçº¢é»‘æ ‘ä¸­ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥é€šè¿‡Service Managerå¯¹è¯¥</span></span><br><span class="line">Binderå®ä½“è¿›è¡Œç®¡ç†äº†ã€‚</span><br><span class="line">            ref = binder_get_ref_for_node(target_proc, node);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç°åœ¨ä¿®æ”¹ç›®çš„è¿›ç¨‹typeï¼Œè¡¨ç¤ºServiceManageræŒæœ‰TestServerå¼•ç”¨ï¼ŒTestServerè¿›ç¨‹æ‰èƒ½æ‹¥æœ‰å®ä½“ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_BINDER)</span><br><span class="line">                fp-&gt;type = BINDER_TYPE_HANDLE;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                fp-&gt;type = BINDER_TYPE_WEAK_HANDLE;</span><br><span class="line">            <span class="comment">// ä¿®æ”¹handleã€‚handleå’Œbinderæ˜¯è”åˆä½“ï¼Œè¿™é‡Œå°†handleè®¾ä¸ºå¼•ç”¨çš„æè¿°ã€‚</span></span><br><span class="line">            <span class="comment">// æ ¹æ®è¯¥handleå¯ä»¥æ‰¾åˆ°"è¯¥binderå®ä½“åœ¨target_procä¸­çš„binderå¼•ç”¨"ï¼›</span></span><br><span class="line">            <span class="comment">// å³ï¼Œå¯ä»¥æ ¹æ®è¯¥handleï¼Œå¯ä»¥ä»Service Manageræ‰¾åˆ°å¯¹åº”çš„Binderå®ä½“çš„å¼•ç”¨ï¼Œä»è€Œè·å–Binderå®ä½“ã€‚</span></span><br><span class="line">            fp-&gt;handle = ref-&gt;desc;</span><br><span class="line">            <span class="comment">// å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œé˜²æ­¢"è¯¥binderå®ä½“"åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è¢«é”€æ¯ã€‚</span></span><br><span class="line">            binder_inc_ref(ref, fp-&gt;type == BINDER_TYPE_HANDLE,</span><br><span class="line">                       &amp;thread-&gt;todo);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        ..</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">        BUG_ON(t-&gt;buffer-&gt;async_transaction != <span class="number">0</span>);</span><br><span class="line">        t-&gt;need_reply = <span class="number">1</span>;</span><br><span class="line">        t-&gt;from_parent = thread-&gt;transaction_stack;</span><br><span class="line">        <span class="comment">// å°†å½“å‰äº‹åŠ¡æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„äº‹åŠ¡æ ˆä¸­</span></span><br><span class="line">        thread-&gt;transaction_stack = t;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®äº‹åŠ¡çš„ç±»å‹ä¸ºBINDER_WORK_TRANSACTION</span></span><br><span class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</span><br><span class="line">    <span class="comment">// å°†äº‹åŠ¡æ·»åŠ åˆ°target_listé˜Ÿåˆ—ä¸­ï¼Œå³target_listçš„å¾…å¤„ç†äº‹åŠ¡ä¸­</span></span><br><span class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</span><br><span class="line">    <span class="comment">// è®¾ç½®å¾…å®Œæˆå·¥ä½œçš„ç±»å‹ä¸ºBINDER_WORK_TRANSACTION_COMPLETE</span></span><br><span class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</span><br><span class="line">    <span class="comment">// å°†å¾…å®Œæˆå·¥ä½œæ·»åŠ åˆ°thread-&gt;todoé˜Ÿåˆ—ä¸­ï¼Œå³å½“å‰çº¿ç¨‹çš„å¾…å®Œæˆå·¥ä½œä¸­ã€‚</span></span><br><span class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</span><br><span class="line">    <span class="comment">// å”¤é†’ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (target_wait)</span><br><span class="line">        wake_up_interruptible(target_wait);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šè¿™é‡Œçš„tr-&gt;target.handle=0ï¼Œå› æ­¤ï¼Œä¼šè®¾ç½®target_nodeä¸ºServiceManagerå¯¹åº”çš„Binderå®ä½“ã€‚ä¸‹é¢æ˜¯target_node,target_procç­‰å€¼åˆå§‹åŒ–ä¹‹åçš„å€¼ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target_node = binder_context_mgr_node; <span class="comment">// ç›®æ ‡èŠ‚ç‚¹ä¸ºService Managerå¯¹åº”çš„Binderå®ä½“</span></span><br><span class="line">target_proc = target_node-&gt;proc;       <span class="comment">// ç›®æ ‡è¿›ç¨‹ä¸ºService Managerå¯¹åº”çš„binder_procè¿›ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line">target_list = &amp;target_thread-&gt;todo;    <span class="comment">// å¾…å¤„ç†äº‹åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">target_wait = &amp;target_thread-&gt;wait;    <span class="comment">// ç­‰å¾…é˜Ÿåˆ—</span></span><br></pre></td></tr></table></figure><p>å°ç»“ï¼š é©±åŠ¨æ¥æ”¶åˆ°TestServerå‘é€çš„æ•°æ®åï¼Œé©±åŠ¨ä¸»è¦å·¥ä½œï¼š ï¼ˆ1ï¼‰æ ¹æ®Handle = 0 æ‰¾åˆ°ç›®çš„è¿›ç¨‹ServiceManager ï¼ˆ2ï¼‰æŠŠæ•°æ®é€šè¿‡copy_from_user()æ”¾åˆ°ç›®çš„è¿›ç¨‹ServiceManagerçš„ç©ºé—´ï¼ˆmmapï¼‰ ï¼ˆ3ï¼‰å¤„ç†offsæ•°æ®ï¼Œå³è§£æflat_binder_objectç»“æ„ä½“ a. ä¸ºTestServeræ„é€ binder_node node = binder_new_node(proc, fp-&gt;binder, fp-&gt;cookie); b.æ„é€ binder_refç»™ç›®çš„è¿›ç¨‹ServiceManager ref = binder_get_ref_for_node(target_proc, node); c.å¢åŠ å¼•ç”¨è®¡æ•°TestServer binder_inc_ref(ref, fp-&gt;type == BINDER_TYPE_HANDLE, &amp;thread-&gt;todo); å¢åŠ å¼•ç”¨è®¡æ•°ä¼šæ·»åŠ work.entryï¼ˆBR_INCREFSã€BR_ACQUIRï¼‰åˆ°TestServer tododé˜Ÿåˆ— list_add_tail(&amp;node-&gt;work.entry, target_list)</p><p>è¯´æ˜ï¼šå°±æ–°å»ºBinderå®ä½“çš„å¼•ç”¨ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°target_proc-&gt;refs_by_nodeçº¢é»‘æ ‘ å’Œ target_proc-&gt;refs_by_descçº¢é»‘æ ‘ä¸­ã€‚ è¿™æ ·ï¼ŒServiceManagerçš„è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­å°±å­˜åœ¨Hello Serviceçš„Binderå¼•ç”¨ï¼ŒServiceManagerä¹Ÿå°±å¯ä»¥å¯¹Hello Serviceè¿›è¡Œç®¡ç†äº†ï¼ç„¶åï¼Œä¿®æ”¹fp-&gt;type=BINDER_TYPE_HANDLEï¼Œå¹¶ä½¿fp-&gt;handle = ref-&gt;descã€‚</p><p>ï¼ˆ4)æ–°å»ºä¸€ä¸ªå¾…å¤„ç†äº‹åŠ¡tå’Œå¾…å®Œæˆçš„å·¥ä½œtcompleteï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œåˆå§‹åŒ–ã€‚å¾…å¤„ç†äº‹åŠ¡tä¼šè¢«æäº¤ç»™ç›®æ ‡(å³ServiceManagerå¯¹åº”çš„Binderå®ä½“)è¿›è¡Œå¤„ç†ï¼›è€Œå¾…å®Œæˆçš„å·¥ä½œtcompleteåˆ™æ˜¯ä¸ºäº†åé¦ˆç»™TestServeræœåŠ¡ï¼Œå‘Šè¯‰TestServerå®ƒçš„è¯·æ±‚Binderé©±åŠ¨å·²ç»æ”¶åˆ°äº†ã€‚æ³¨æ„ï¼Œè¿™é‡Œä»…ä»…æ˜¯å‘Šè¯‰TestServerè¯¥è¯·æ±‚å·²ç»è¢«æ”¶åˆ°ï¼Œè€Œä¸æ˜¯å¤„ç†å®Œæ¯•ï¼å¾…ServiceManagerå¤„ç†å®Œæ¯•è¯¥è¯·æ±‚ä¹‹åï¼ŒBinderé©±åŠ¨ä¼šå†æ¬¡åé¦ˆç›¸åº”çš„æ¶ˆæ¯ç»™TestServerã€‚ ï¼ˆ5ï¼‰binder_thread_write()ä¸­æ‰§è¡Œbinder_transaction()åï¼Œä¼šæ›´æ–°*consumedçš„å€¼ï¼Œå³bwr.write_consumedçš„å€¼ ï¼ˆ6ï¼‰æ­¤æ—¶ï¼ŒTestServerè¿›ç¨‹è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œè€Œä¸”å®ƒä¹Ÿé€šè¿‡wake_up_interruptible()å”¤é†’äº†ServiceManagerè¿›ç¨‹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ›´æ–°bwr.write_consumedçš„å€¼</span></span><br><span class="line">*consumed = ptr - buffer;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œioctl()ä¼šæ‰§è¡Œbinder_thread_read()æ¥è®¾ç½®åé¦ˆæ•°æ®ç»™TestServerè¿›ç¨‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ*consumed=0ï¼Œåˆ™å†™å…¥BR_NOOPåˆ°ç”¨æˆ·ä¼ è¿›æ¥çš„bwr.read_bufferç¼“å­˜åŒº</span></span><br><span class="line">    <span class="keyword">if</span> (*consumed == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (put_user(BR_NOOP, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹çš„"å¾…å®Œæˆå·¥ä½œ"ä¸ä¸ºç©ºï¼Œåˆ™å–å‡ºå¾…å®Œæˆå·¥ä½œã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!list_empty(&amp;thread-&gt;todo))</span><br><span class="line">            w = list_first_entry(&amp;thread-&gt;todo, struct binder_work, entry);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> BINDER_WORK_TRANSACTION_COMPLETE: &#123;</span><br><span class="line">            cmd = BR_TRANSACTION_COMPLETE;</span><br><span class="line">            <span class="comment">// å°†BR_TRANSACTION_COMPLETEå†™å…¥åˆ°ç”¨æˆ·ç¼“å†²ç©ºé—´ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// æ›´æ–°bwr.read_consumedçš„å€¼</span></span><br><span class="line">    *consumed = ptr - buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå‘é€BR_NOOPç»™TestServerï¼Œç„¶åå¤„ç†todoé˜Ÿåˆ—ï¼Œå¤„ç†å®Œæˆåä¼šå‘é€BR_TRANSACTION_COMPLETEã€‚</p><p>ç°åœ¨å†…æ ¸å·²ç»å¤„ç†å®Œæ•°æ®ï¼Œæˆ‘ä»¬ä»logçœ‹çœ‹æ•°æ®å‘ç”Ÿäº†å“ªäº›å˜åŒ–ï¼š æˆ‘ä»¬å‘ç°flat_binder_objectç»“æ„ä½“çš„typeå€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œbinderå˜æˆäº†Handleï¼Œçœ‹ä¸€ä¸‹ç»“æ„ä½“ï¼Œhandler å’Œ binderæ˜¯ä¸€ä¸ªunionï¼Œå ç”¨åŒä¸€ä¸ªä½ç½®ï¼›Handleä¸º1ä»£è¡¨ç¬¬ä¸€ä¸ªå¼•ç”¨ï¼Œæ„æ€æ˜¯åœ¨ServiceManagerè¿›ç¨‹é‡Œé¢æ ¹æ®1èƒ½æ‰¾åˆ°ç¬¬ä¸€ä¸ªbinder_refï¼Œæ ¹æ®binder_refèƒ½æ‰¾åˆ°æœåŠ¡helloçš„binder_nodeå®ä½“ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/38-Android-binder-flat_binder_object.png" alt="Markdown"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/39-Android-binder-Binder-io-transaction-data.jpg" alt="Markdown"></p><p>æ¥ä¸‹æ¥å°±ç­‰å¾…ServiceManagerå¤„ç†å®Œæˆåï¼Œå›å¤æ¶ˆæ¯ã€‚</p><h4 id="1-3ã€å”¤é†’ServiceManageræ‰§è¡Œæ·»åŠ â€helloâ€æœåŠ¡"><a href="#1-3ã€å”¤é†’ServiceManageræ‰§è¡Œæ·»åŠ â€helloâ€æœåŠ¡" class="headerlink" title="1.3ã€å”¤é†’ServiceManageræ‰§è¡Œæ·»åŠ â€helloâ€æœåŠ¡"></a>1.3ã€å”¤é†’ServiceManageræ‰§è¡Œæ·»åŠ â€helloâ€æœåŠ¡</h4><p>å‰é¢é©±åŠ¨å·²ç»åˆ›å»ºå¥½TestServerçš„binder_nodeï¼Œç°åœ¨å”¤é†’ServiceManageræ·»åŠ svcinfo çœ‹çœ‹ServiceManagerè¢«å”¤é†’åï¼Œä¼šå¹²äº›ä»€ä¹ˆã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    wait_for_proc_work = thread-&gt;transaction_stack == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">                list_empty(&amp;thread-&gt;todo);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹çš„"å¾…å®Œæˆå·¥ä½œ"ä¸ä¸ºç©ºï¼Œåˆ™å–å‡ºå¾…å®Œæˆå·¥ä½œã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!list_empty(&amp;thread-&gt;todo))</span><br><span class="line">            w = list_first_entry(&amp;thread-&gt;todo, struct binder_work, entry);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo) &amp;&amp; wait_for_proc_work)</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_TRANSACTION: &#123;</span><br><span class="line">                t = container_of(w, struct binder_transaction, work);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// t-&gt;buffer-&gt;target_nodeæ˜¯ç›®æ ‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œï¼ŒaddServiceè¯·æ±‚çš„ç›®æ ‡æ˜¯ServiceManagerï¼Œå› æ­¤target_nodeæ˜¯ServiceManagerå¯¹åº”çš„èŠ‚ç‚¹ï¼›</span></span><br><span class="line">        <span class="comment">// å®ƒçš„å€¼åœ¨äº‹åŠ¡äº¤äº’æ—¶(binder_transactionä¸­)ï¼Œè¢«èµ‹å€¼ä¸ºServiceManagerå¯¹åº”çš„Binderå®ä½“ã€‚  </span></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;buffer-&gt;target_node) &#123;</span><br><span class="line">            <span class="comment">// äº‹åŠ¡ç›®æ ‡å¯¹åº”çš„Binderå®ä½“(å³ï¼ŒServiceManagerå¯¹åº”çš„Binderå®ä½“)</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">t</span>-&gt;<span class="title">buffer</span>-&gt;<span class="title">target_node</span>;</span></span><br><span class="line">            <span class="comment">// Binderå®ä½“åœ¨ç”¨æˆ·ç©ºé—´çš„åœ°å€(ServiceManagerçš„pträ¸ºNULL)</span></span><br><span class="line">            tr.target.ptr = target_node-&gt;ptr;</span><br><span class="line">            <span class="comment">// Binderå®ä½“åœ¨ç”¨æˆ·ç©ºé—´çš„å…¶å®ƒæ•°æ®(ServiceManagerçš„cookieä¸ºNULL)</span></span><br><span class="line">            tr.cookie =  target_node-&gt;cookie;</span><br><span class="line">            t-&gt;saved_priority = task_nice(current);</span><br><span class="line">            <span class="keyword">if</span> (t-&gt;priority &lt; target_node-&gt;min_priority &amp;&amp;</span><br><span class="line">                !(t-&gt;flags &amp; TF_ONE_WAY))</span><br><span class="line">                binder_set_nice(t-&gt;priority);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY) ||</span><br><span class="line">                 t-&gt;saved_priority &gt; target_node-&gt;min_priority)</span><br><span class="line">                binder_set_nice(target_node-&gt;min_priority);</span><br><span class="line">            **cmd = BR_TRANSACTION;<span class="comment">//å°†å‘½ä»¤æ”¹ä¸ºBR_TRANSACTION</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tr.target.ptr = <span class="literal">NULL</span>;</span><br><span class="line">            tr.cookie = <span class="literal">NULL</span>;</span><br><span class="line">            cmd = BR_REPLY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// äº¤æ˜“ç </span></span><br><span class="line">        tr.code = t-&gt;code;</span><br><span class="line">        tr.flags = t-&gt;flags;</span><br><span class="line">        tr.sender_euid = t-&gt;sender_euid;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;from) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">sender</span> = <span class="title">t</span>-&gt;<span class="title">from</span>-&gt;<span class="title">proc</span>-&gt;<span class="title">tsk</span>;</span></span><br><span class="line">            tr.sender_pid = task_tgid_nr_ns(sender,</span><br><span class="line">                            current-&gt;nsproxy-&gt;pid_ns);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tr.sender_pid = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ•°æ®å¤§å°</span></span><br><span class="line">        tr.data_size = t-&gt;buffer-&gt;data_size;</span><br><span class="line">        <span class="comment">// æ•°æ®ä¸­å¯¹è±¡çš„åç§»æ•°ç»„çš„å¤§å°(å³å¯¹è±¡çš„ä¸ªæ•°)</span></span><br><span class="line">        tr.offsets_size = t-&gt;buffer-&gt;offsets_size;</span><br><span class="line">        <span class="comment">// æ•°æ®</span></span><br><span class="line">        tr.data.ptr.buffer = (<span class="keyword">void</span> *)t-&gt;buffer-&gt;data +</span><br><span class="line">                    proc-&gt;user_buffer_offset;</span><br><span class="line">        <span class="comment">// æ•°æ®ä¸­å¯¹è±¡çš„åç§»æ•°ç»„</span></span><br><span class="line">        tr.data.ptr.offsets = tr.data.ptr.buffer +</span><br><span class="line">                    ALIGN(t-&gt;buffer-&gt;data_size,</span><br><span class="line">                        <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†cmdæŒ‡ä»¤å†™å…¥åˆ°ptrï¼Œå³ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´</span></span><br><span class="line">        <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        <span class="comment">// å°†træ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</span></span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(ptr, &amp;tr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(tr);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// åˆ é™¤å·²å¤„ç†çš„äº‹åŠ¡</span></span><br><span class="line">        list_del(&amp;t-&gt;work.entry);</span><br><span class="line">        t-&gt;buffer-&gt;allow_user_free = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// è®¾ç½®å›å¤ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">if</span> (cmd == BR_TRANSACTION &amp;&amp; !(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">            <span class="comment">// è¯¥äº‹åŠ¡ä¼šå‘é€ç»™Service Managerå®ˆæŠ¤è¿›ç¨‹è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">            <span class="comment">// Service Managerå¤„ç†ä¹‹åï¼Œè¿˜éœ€è¦ç»™Binderé©±åŠ¨å›å¤å¤„ç†ç»“æœã€‚</span></span><br><span class="line">            <span class="comment">// è¿™é‡Œè®¾ç½®Binderé©±åŠ¨å›å¤ä¿¡æ¯ã€‚</span></span><br><span class="line">            t-&gt;to_parent = thread-&gt;transaction_stack;</span><br><span class="line">            <span class="comment">// to_threadè¡¨ç¤ºService Manageråé¦ˆåï¼Œå°†åé¦ˆç»“æœäº¤ç»™å½“å‰threadè¿›è¡Œå¤„ç†</span></span><br><span class="line">            t-&gt;to_thread = thread;</span><br><span class="line">            <span class="comment">// transaction_stackäº¤æ˜“æ ˆä¿å­˜å½“å‰äº‹åŠ¡ã€‚ç”¨äºä¹‹å¤„åé¦ˆæ˜¯é’ˆå¯¹å“ªä¸ªäº‹åŠ¡çš„ã€‚</span></span><br><span class="line">            thread-&gt;transaction_stack = t;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°bwr.read_consumedçš„å€¼</span></span><br><span class="line">    *consumed = ptr - buffer;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šServiceManagerè¿›ç¨‹åœ¨è°ƒç”¨wait_event_interruptible_exclusive(proc-&gt;wait, binder_has_proc_work(proc, thread))è¿›å…¥ç­‰å¾…ä¹‹åï¼Œè¢«TestServerè¿›ç¨‹å”¤é†’ã€‚å”¤é†’ä¹‹åï¼Œbinder_has_thread_work()ä¸ºtrueï¼Œå› ä¸ºServiceManagerçš„å¾…å¤„ç†äº‹åŠ¡é˜Ÿåˆ—ä¸­æœ‰ä¸ªå¾…å¤„ç†äº‹åŠ¡(å³ï¼ŒTestServeræ·»åŠ æœåŠ¡çš„è¯·æ±‚)ã€‚ (01) è¿›å…¥whileå¾ªç¯åï¼Œé¦–å…ˆå–å‡ºå¾…å¤„ç†äº‹åŠ¡ã€‚ (02) äº‹åŠ¡çš„ç±»å‹æ˜¯BINDER_WORK_TRANSACTIONï¼Œå¾—åˆ°å¯¹åº”çš„binder_transaction*ç±»å‹æŒ‡é’ˆtä¹‹åï¼Œè·³å‡ºswitchè¯­å¥ã€‚å¾ˆæ˜¾ç„¶ï¼Œæ­¤æ—¶tä¸ä¸ºNULLï¼Œå› æ­¤ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚ä¸‹é¢çš„å·¥ä½œçš„ç›®çš„ï¼Œæ˜¯å°†tä¸­çš„æ•°æ®è½¬ç§»åˆ°trä¸­(træ˜¯äº‹åŠ¡äº¤äº’æ•°æ®åŒ…ç»“æ„ä½“binder_transaction_dataå¯¹åº”çš„æŒ‡é’ˆ)ï¼Œç„¶åå°†æŒ‡ä»¤å’Œtræ•°æ®éƒ½æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè®©ServiceManagerè¯»å–åè¿›è¡Œå¤„ç†ã€‚</p><p>Service Managerå®ˆæŠ¤è¿›ç¨‹åœ¨å¤„ç†å®Œäº‹åŠ¡ä¹‹åï¼Œéœ€è¦åé¦ˆç»“æœç»™Binderé©±åŠ¨ã€‚å› æ­¤ï¼Œæ¥ä¸‹æ¥ä¼šè®¾ç½®t-&gt;to_threadå’Œt-&gt;transaction_stackç­‰æˆå‘˜ã€‚æœ€åï¼Œä¿®æ”¹*consumedçš„å€¼ï¼Œå³bwr.read_consumedçš„å€¼ï¼Œè¡¨ç¤ºå¾…è¯»å–å†…å®¹çš„å¤§å°ã€‚ æ‰§è¡Œå®Œbinder_thread_read()ä¹‹åï¼Œå›åˆ°binder_ioctl()ä¸­ï¼Œæ‰§è¡Œcopy_to_user()å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚æ¥ä¸‹æ¥ï¼Œå°±å›åˆ°äº†Service Managerçš„å®ˆæŠ¤è¿›ç¨‹å½“ä¸­ï¼Œå³å›åˆ°binder_loop()ä¸­ã€‚ binder_loop()ä¼šå°†ioctl()åé¦ˆçš„æ•°æ®å‘é€ç»™binder_parse()è¿›è¡Œè§£æã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_parse</span><span class="params">(struct binder_state *bs, struct binder_io *bio,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">uintptr_t</span> ptr, <span class="keyword">size_t</span> size, binder_handler func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> BR_NOOP:</span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> *<span class="title">txn</span> = (<span class="title">struct</span> <span class="title">binder_transaction_data</span> *) <span class="title">ptr</span>;</span></span><br><span class="line">            <span class="keyword">if</span> ((end - ptr) &lt; <span class="keyword">sizeof</span>(*txn)) &#123;</span><br><span class="line">                ALOGE(<span class="string">"parse: txn too small!\n"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            binder_dump_txn(txn);</span><br><span class="line">            <span class="keyword">if</span> (func) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> rdata[<span class="number">256</span>/<span class="number">4</span>];</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">msg</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">reply</span>;</span></span><br><span class="line">                <span class="keyword">int</span> res;</span><br><span class="line"></span><br><span class="line">                bio_init(&amp;reply, rdata, <span class="keyword">sizeof</span>(rdata), <span class="number">4</span>);</span><br><span class="line">                bio_init_from_txn(&amp;msg, txn);</span><br><span class="line">                res = func(bs, txn, &amp;msg, &amp;reply);</span><br><span class="line">                binder_send_reply(bs, &amp;reply, txn-&gt;data.ptr.buffer, res);</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(*txn);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šè°ƒç”¨svcmgr_handler()-&gt;do_add_service()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_add_service</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">uint16_t</span> *s, <span class="keyword">size_t</span> len,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">uint32_t</span> handle, <span class="keyword">uid_t</span> uid, <span class="keyword">int</span> allow_isolated,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">pid_t</span> spid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line">    si = find_svc(s, len);</span><br><span class="line">    <span class="keyword">if</span> (si) &#123;</span><br><span class="line">        <span class="keyword">if</span> (si-&gt;handle) &#123;</span><br><span class="line">                    svcinfo_death(bs, si);</span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        si = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*si) + (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">        si-&gt;len = len;</span><br><span class="line">        <span class="built_in">memcpy</span>(si-&gt;name, s, (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        si-&gt;name[len] = <span class="string">'\0'</span>;</span><br><span class="line">        si-&gt;death.func = (<span class="keyword">void</span>*) svcinfo_death;</span><br><span class="line">        si-&gt;death.ptr = si;</span><br><span class="line">        si-&gt;allow_isolated = allow_isolated;</span><br><span class="line">        si-&gt;next = svclist;</span><br><span class="line">        svclist = si;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binder_acquire(bs, handle);</span><br><span class="line">    binder_link_to_death(bs, handle, &amp;si-&gt;death);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é¦–å…ˆä¸ºhelloæœåŠ¡æ–°åˆ†é…ä¸€ä¸ªç»“æ„ä½“svcinfoï¼Œç„¶åå°†handleèµ‹å€¼ç»™svcinfoï¼Œè¿™ä¹Ÿæ˜¯ä»¥åæˆ‘ä»¬æŸ¥æ‰¾æœåŠ¡æ‰€å¾—åˆ°çš„handleã€‚ ç„¶åè°ƒåŠ¨äº†binder_acquireã€binder_link_to_deathå‘é€ä¿¡æ¯ç»™é©±åŠ¨ã€‚ [ 38.467270] service_manager (1362, 1362), binder_thread_write : BC_ACQUIRE [ 38.480122] service_manager (1362, 1362), binder_thread_write : BC_REQUEST_DEATH_NOTIFICATION æ¥ç€çœ‹binder_send_reply(bs, &amp;reply, txn-&gt;data.ptr.buffer, res);</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">binder_send_reply</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                       struct binder_io *reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">binder_uintptr_t</span> buffer_to_free,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> status)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    data.cmd_free = BC_FREE_BUFFER;</span><br><span class="line">    data.buffer = buffer_to_free;</span><br><span class="line">    data.cmd_reply = BC_REPLY;</span><br><span class="line">    data.txn.target.ptr = <span class="number">0</span>;</span><br><span class="line">    data.txn.cookie = <span class="number">0</span>;</span><br><span class="line">    data.txn.code = <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">    binder_write(bs, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ‰BC_FREE_BUFFERã€BC_REPLYï¼Œé€šè¿‡binder_write(bs, &amp;data, sizeof(data))å›å¤BC_REPLYåˆ°é©±åŠ¨ã€‚</p><p>é©±åŠ¨å¤„ç†æ¶ˆæ¯è·Ÿä¹‹å‰æµç¨‹ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†åˆ†æã€‚ç®€å•æ€»ç»“ï¼š 1ã€é©±åŠ¨æ¥æ”¶åˆ°BC_REPLYè¯·æ±‚ï¼Œä¼šæ–°å»ºä¸€ä¸ªå¾…å¤„ç†äº‹åŠ¡tï¼ˆTestServerå¤„ç†ï¼‰å’Œå¾…å®Œæˆçš„å·¥ä½œtcompleteï¼ˆservice_managerå¤„ç†ï¼‰ 2ã€ç„¶åå”¤é†’TestServerå¤„ç†BC_REPLYè¯·æ±‚ è‡³æ­¤ï¼Œå·²ç»æˆåŠŸæ·»åŠ Hello Service svcmgr: add_service(â€˜helloâ€™), handle = 1</p><h3 id="ï¼ˆ2ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentè·å–â€Helloâ€æœåŠ¡è¿‡ç¨‹"><a href="#ï¼ˆ2ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentè·å–â€Helloâ€æœåŠ¡è¿‡ç¨‹" class="headerlink" title="ï¼ˆ2ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentè·å–â€Helloâ€æœåŠ¡è¿‡ç¨‹"></a>ï¼ˆ2ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentè·å–â€Helloâ€æœåŠ¡è¿‡ç¨‹</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/40-Android-binder-binder_get_service.png" alt="Markdown"></p><h4 id="2-0ã€æ„é€ æ•°æ®"><a href="#2-0ã€æ„é€ æ•°æ®" class="headerlink" title="2.0ã€æ„é€ æ•°æ®"></a>2.0ã€æ„é€ æ•°æ®</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/41-Android-binder-getSvr-Binder-io-transaction-data.jpg" alt="Markdown"></p><h4 id="2-1ã€å‘é€æ•°æ®ç»™ServiceManager"><a href="#2-1ã€å‘é€æ•°æ®ç»™ServiceManager" class="headerlink" title="2.1ã€å‘é€æ•°æ®ç»™ServiceManager"></a>2.1ã€å‘é€æ•°æ®ç»™ServiceManager</h4><p>bwråˆå§‹åŒ–å®Œæˆä¹‹åï¼Œè°ƒç”¨ioctl(,BINDER_WRITE_READ,)å’ŒBinderé©±åŠ¨è¿›è¡Œäº¤äº’ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">thread</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> size = _IOC_SIZE(cmd);</span><br><span class="line">  <span class="keyword">void</span> __user *ubuf = (<span class="keyword">void</span> __user *)arg;</span><br><span class="line">  <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">  <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">      <span class="comment">// å°†binder_write_readä»"ç”¨æˆ·ç©ºé—´" æ‹·è´åˆ° "å†…æ ¸ç©ºé—´"</span></span><br><span class="line">      <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœwrite_size&gt;0ï¼Œåˆ™è¿›è¡Œå†™æ“ä½œ</span></span><br><span class="line">      <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœread_size&gt;0ï¼Œåˆ™è¿›è¡Œè¯»æ“ä½œ</span></span><br><span class="line">      <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags   &amp; O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">          ret = -EFAULT;</span><br><span class="line">          <span class="keyword">goto</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œä¼šå°†binder_write_readä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ä¹‹åã€‚æ‹·è´ä¹‹åï¼Œè¯»å–å‡ºæ¥çš„bwr.write_sizeå’Œbwr.read_sizeéƒ½&gt;0ï¼Œå› æ­¤å…ˆå†™åè¯»ã€‚å³ï¼Œå…ˆæ‰§è¡Œbinder_thread_write()ï¼Œç„¶åæ‰§è¡Œbinder_thread_read()ã€‚</p><h4 id="2-2ã€binder-thread-write-å¤„ç†æ•°æ®"><a href="#2-2ã€binder-thread-write-å¤„ç†æ•°æ®" class="headerlink" title="2.2ã€binder_thread_write()å¤„ç†æ•°æ®"></a>2.2ã€binder_thread_write()å¤„ç†æ•°æ®</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc, struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">void</span> __user *buffer, <span class="keyword">int</span> size, <span class="keyword">signed</span> <span class="keyword">long</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">  <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">  <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯»å–binder_write_read.write_bufferä¸­çš„å†…å®¹ã€‚</span></span><br><span class="line">  <span class="comment">// æ¯æ¬¡è¯»å–32bit(å³4ä¸ªå­—èŠ‚)</span></span><br><span class="line">  <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;</span><br><span class="line">      <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è¯»å–32bitåˆ°å†…æ ¸ä¸­ï¼Œå¹¶èµ‹å€¼ç»™cmdã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (get_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">          <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">      ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="keyword">case</span> BC_TRANSACTION:</span><br><span class="line">        <span class="keyword">case</span> BC_REPLY: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (copy_from_user(&amp;tr, ptr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(tr);</span><br><span class="line">            binder_transaction(proc, thread, &amp;tr, cmd == BC_REPLY);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°bwr.write_consumedçš„å€¼</span></span><br><span class="line">      *consumed = ptr - buffer;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šMediaPlayerå‘é€çš„æŒ‡ä»¤æ˜¯BC_TRANSACTIONï¼Œè¿™é‡Œåªå…³å¿ƒä¸BC_TRANSACTIONç›¸å…³çš„éƒ¨åˆ†ã€‚åœ¨é€šè¿‡copy_from_user()å°†æ•°æ®æ‹·è´ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ä¹‹åï¼Œå°±è°ƒç”¨binder_transaction()è¿›è¡Œå¤„ç†ã€‚</p><h4 id="2-3ã€Binderé©±åŠ¨ä¸­binder-transaction-çš„æºç "><a href="#2-3ã€Binderé©±åŠ¨ä¸­binder-transaction-çš„æºç " class="headerlink" title="2.3ã€Binderé©±åŠ¨ä¸­binder_transaction()çš„æºç "></a>2.3ã€Binderé©±åŠ¨ä¸­binder_transaction()çš„æºç </h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">tcomplete</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> *offp, *off_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">target_proc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">target_thread</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">target_list</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> *target_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">in_reply_to</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_log_entry</span> *<span class="title">e</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> return_error;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tr-&gt;target.handle) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¯¥getServiceæ˜¯ä»ServiceManagerä¸­è·å–MediaPlayerï¼›</span></span><br><span class="line">            <span class="comment">// å› æ­¤äº‹åŠ¡ç›®æ ‡å¯¹è±¡æ˜¯ServiceManagerçš„binderå®ä½“ã€‚</span></span><br><span class="line">            target_node = binder_context_mgr_node;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// è®¾ç½®å¤„ç†äº‹åŠ¡çš„ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">        target_proc = target_node-&gt;proc;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_thread) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        target_list = &amp;target_proc-&gt;todo;</span><br><span class="line">        target_wait = &amp;target_proc-&gt;wait;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªå¾…å¤„ç†çš„äº‹åŠ¡tï¼Œtæ˜¯binderäº‹åŠ¡(binder_transactionå¯¹è±¡)</span></span><br><span class="line">    t = kzalloc(<span class="keyword">sizeof</span>(*t), GFP_KERNEL);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªå¾…å®Œæˆçš„å·¥ä½œtcompleteï¼Œtcompleteæ˜¯binder_workå¯¹è±¡ã€‚</span></span><br><span class="line">    tcomplete = kzalloc(<span class="keyword">sizeof</span>(*tcomplete), GFP_KERNEL);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    t-&gt;debug_id = ++binder_last_id;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®fromï¼Œè¡¨ç¤ºè¯¥äº‹åŠ¡æ˜¯MediaPlayerçº¿ç¨‹å‘èµ·çš„</span></span><br><span class="line">    <span class="keyword">if</span> (!reply &amp;&amp; !(tr-&gt;flags &amp; TF_ONE_WAY))</span><br><span class="line">        t-&gt;from = thread;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t-&gt;from = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„ä¸€äº›èµ‹å€¼æ˜¯åˆå§‹åŒ–äº‹åŠ¡t</span></span><br><span class="line">    t-&gt;sender_euid = proc-&gt;tsk-&gt;cred-&gt;euid;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡å°†äº¤ç»™target_procè¿›ç¨‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    t-&gt;to_proc = target_proc;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡å°†äº¤ç»™target_threadçº¿ç¨‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    t-&gt;to_thread = target_thread;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡ç¼–ç </span></span><br><span class="line">    t-&gt;code = tr-&gt;code;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡æ ‡å¿—</span></span><br><span class="line">    t-&gt;flags = tr-&gt;flags;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡ä¼˜å…ˆçº§</span></span><br><span class="line">    t-&gt;priority = task_nice(current);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ç©ºé—´</span></span><br><span class="line">    t-&gt;buffer = binder_alloc_buf(target_proc, tr-&gt;data_size,</span><br><span class="line">        tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</span><br><span class="line">    ...</span><br><span class="line">    t-&gt;buffer-&gt;allow_user_free = <span class="number">0</span>;</span><br><span class="line">    t-&gt;buffer-&gt;debug_id = t-&gt;debug_id;</span><br><span class="line">    <span class="comment">// ä¿å­˜äº‹åŠ¡</span></span><br><span class="line">    t-&gt;buffer-&gt;transaction = t;</span><br><span class="line">    <span class="comment">// ä¿å­˜äº‹åŠ¡çš„ç›®æ ‡å¯¹è±¡(å³å¤„ç†è¯¥äº‹åŠ¡çš„binderå¯¹è±¡)</span></span><br><span class="line">    t-&gt;buffer-&gt;target_node = target_node;</span><br><span class="line">    trace_binder_transaction_alloc_buf(t-&gt;buffer);</span><br><span class="line">    <span class="keyword">if</span> (target_node)</span><br><span class="line">        binder_inc_node(target_node, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    offp = (<span class="keyword">size_t</span> *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†"ç”¨æˆ·ç©ºé—´çš„æ•°æ®"æ‹·è´åˆ°å†…æ ¸ä¸­</span></span><br><span class="line">    <span class="comment">// tr-&gt;data.ptr.bufferå°±æ˜¯ç”¨æˆ·ç©ºé—´æ•°æ®çš„èµ·å§‹åœ°å€ï¼Œtr-&gt;data_sizeå°±æ˜¯æ•°æ®å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(t-&gt;buffer-&gt;data, tr-&gt;data.ptr.buffer, tr-&gt;data_size)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†"ç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¸­æ‰€å«å¯¹è±¡çš„åç§»åœ°å€"æ‹·è´åˆ°å†…æ ¸ä¸­</span></span><br><span class="line">    <span class="comment">// MediaPlayerä¸­ä¸åŒ…å«å¯¹è±¡, offp=null</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(offp, tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// MediaPlayerä¸­ä¸åŒ…å«å¯¹è±¡, off_endä¸ºnull</span></span><br><span class="line">    off_end = (<span class="keyword">void</span> *)offp + tr-&gt;offsets_size;</span><br><span class="line">    <span class="comment">// MediaPlayerä¸­ä¸åŒ…å«å¯¹è±¡, offp=off_end</span></span><br><span class="line">    <span class="keyword">for</span> (; offp &lt; off_end; offp++) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        ..</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">        BUG_ON(t-&gt;buffer-&gt;async_transaction != <span class="number">0</span>);</span><br><span class="line">        t-&gt;need_reply = <span class="number">1</span>;</span><br><span class="line">        t-&gt;from_parent = thread-&gt;transaction_stack;</span><br><span class="line">        <span class="comment">// å°†å½“å‰äº‹åŠ¡æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„äº‹åŠ¡æ ˆä¸­</span></span><br><span class="line">        thread-&gt;transaction_stack = t;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®äº‹åŠ¡çš„ç±»å‹ä¸ºBINDER_WORK_TRANSACTION</span></span><br><span class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</span><br><span class="line">    <span class="comment">// å°†äº‹åŠ¡æ·»åŠ åˆ°target_listé˜Ÿåˆ—ä¸­ï¼Œå³target_listçš„å¾…å¤„ç†äº‹åŠ¡ä¸­</span></span><br><span class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</span><br><span class="line">    <span class="comment">// è®¾ç½®å¾…å®Œæˆå·¥ä½œçš„ç±»å‹ä¸ºBINDER_WORK_TRANSACTION_COMPLETE</span></span><br><span class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</span><br><span class="line">    <span class="comment">// å°†å¾…å®Œæˆå·¥ä½œæ·»åŠ åˆ°thread-&gt;todoé˜Ÿåˆ—ä¸­ï¼Œå³å½“å‰çº¿ç¨‹çš„å¾…å®Œæˆå·¥ä½œä¸­ã€‚</span></span><br><span class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</span><br><span class="line">    <span class="comment">// å”¤é†’ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (target_wait)</span><br><span class="line">        wake_up_interruptible(target_wait);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šå‚æ•°reply=0ï¼Œè¡¨æ˜è¿™æ˜¯ä¸ªè¯·æ±‚äº‹åŠ¡ï¼Œè€Œä¸æ˜¯åé¦ˆã€‚binder_transactionæ–°å»ºä¼šæ–°å»ºâ€ä¸€ä¸ªå¾…å¤„ç†äº‹åŠ¡tâ€å’Œâ€å¾…å®Œæˆçš„å·¥ä½œtcompleteâ€ï¼Œå¹¶æ ¹æ®è¯·æ±‚çš„æ•°æ®å¯¹å®ƒä»¬è¿›è¡Œåˆå§‹åŒ–ã€‚ (01) TestClentçš„getServiceè¯·æ±‚æ˜¯æäº¤ç»™ServiceManagerè¿›è¡Œå¤„ç†çš„ï¼Œå› æ­¤ï¼Œâ€å¾…å¤„ç†äº‹åŠ¡tâ€ä¼šè¢«æ·»åŠ åˆ°ServiceManagerçš„å¾…å¤„ç†äº‹åŠ¡é˜Ÿåˆ—ä¸­ã€‚æ­¤æ—¶çš„target_threadæ˜¯ServiceManagerå¯¹åº”çš„çº¿ç¨‹ï¼Œè€Œtarget_procåˆ™æ˜¯ServiceManagerå¯¹åº”çš„è¿›ç¨‹ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚ (02) æ­¤æ—¶ï¼ŒBinderé©±åŠ¨å·²ç»æ”¶åˆ°äº†TestClentçš„getServiceè¯·æ±‚ï¼›äºæ˜¯ï¼Œå°†ä¸€ä¸ªBINDER_WORK_TRANSACTION_COMPLETEç±»å‹çš„â€å¾…å®Œæˆå·¥ä½œtcompleteâ€æ·»åŠ åˆ°å½“å‰çº¿ç¨‹(å³ï¼ŒTestClentçº¿ç¨‹)çš„å¾…å¤„ç†äº‹åŠ¡é˜Ÿåˆ—ä¸­ã€‚ç›®çš„æ˜¯å‘Šè¯‰TestClentï¼ŒBinderé©±åŠ¨å·²ç»æ”¶åˆ°å®ƒçš„getServiceè¯·æ±‚äº†ã€‚ (03) æœ€åï¼Œè°ƒç”¨wake_up_interruptible(target_wait)å°†ServiceManagerå”¤é†’ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè¿˜æ˜¯å…ˆåˆ†æå®ŒTestClentçº¿ç¨‹ï¼Œå†çœ‹ServiceManagerè¢«å”¤é†’ååšäº†äº›ä»€ä¹ˆã€‚</p><p>binder_transaction()æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå°±ä¼šè¿”å›åˆ°binder_thread_write()ä¸­ã€‚binder_thread_write()æ›´æ–°bwr.write_consumedçš„å€¼åï¼Œå°±è¿”å›åˆ°binder_ioctl()ç»§ç»­æ‰§è¡Œâ€è¯»â€åŠ¨ä½œã€‚å³æ‰§è¡Œbinder_thread_read()ã€‚</p><h4 id="2-4ã€Binderé©±åŠ¨ä¸­binder-thread-read-çš„æºç "><a href="#2-4ã€Binderé©±åŠ¨ä¸­binder-thread-read-çš„æºç " class="headerlink" title="2.4ã€Binderé©±åŠ¨ä¸­binder_thread_read()çš„æºç "></a>2.4ã€Binderé©±åŠ¨ä¸­binder_thread_read()çš„æºç </h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">    <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> wait_for_proc_work;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ*consumed=0ï¼Œåˆ™å†™å…¥BR_NOOPåˆ°ç”¨æˆ·ä¼ è¿›æ¥çš„bwr.read_bufferç¼“å­˜åŒº</span></span><br><span class="line">    <span class="keyword">if</span> (*consumed == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (put_user(BR_NOOP, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line">    <span class="comment">// ç­‰å¾…procè¿›ç¨‹çš„äº‹åŠ¡æ ‡è®°ã€‚</span></span><br><span class="line">    <span class="comment">// å½“çº¿ç¨‹çš„äº‹åŠ¡æ ˆä¸ºç©º å¹¶ä¸” å¾…å¤„ç†äº‹åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè¯¥æ ‡è®°ä½trueã€‚</span></span><br><span class="line">    wait_for_proc_work = thread-&gt;transaction_stack == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">                list_empty(&amp;thread-&gt;todo);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (non_block) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            ret = wait_event_interruptible(thread-&gt;wait, binder_has_thread_work(thread));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹çš„"å¾…å®Œæˆå·¥ä½œ"ä¸ä¸ºç©ºï¼Œåˆ™å–å‡ºå¾…å®Œæˆå·¥ä½œã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!list_empty(&amp;thread-&gt;todo))</span><br><span class="line">            w = list_first_entry(&amp;thread-&gt;todo, struct binder_work, entry);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo) &amp;&amp; wait_for_proc_work)</span><br><span class="line">            ...</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ptr - buffer == <span class="number">4</span> &amp;&amp; !(thread-&gt;looper &amp; BINDER_LOOPER_STATE_NEED_RETURN)) <span class="comment">/* no data added */</span></span><br><span class="line">                <span class="keyword">goto</span> retry;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> BINDER_WORK_TRANSACTION_COMPLETE: &#123;</span><br><span class="line">            cmd = BR_TRANSACTION_COMPLETE;</span><br><span class="line">            <span class="comment">// å°†BR_TRANSACTION_COMPLETEå†™å…¥åˆ°ç”¨æˆ·ç¼“å†²ç©ºé—´ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// å¾…å®Œæˆäº‹åŠ¡å·²ç»å¤„ç†å®Œæ¯•ï¼Œå°†å…¶ä»å¾…å®Œæˆäº‹åŠ¡é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚</span></span><br><span class="line">            list_del(&amp;w-&gt;entry);</span><br><span class="line">            kfree(w);</span><br><span class="line">            binder_stats_deleted(BINDER_STAT_TRANSACTION_COMPLETE);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!t)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// æ›´æ–°bwr.read_consumedçš„å€¼</span></span><br><span class="line">    *consumed = ptr - buffer;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š (01) bwr.read_consumed=0ï¼Œå³if (*consumed == 0)ä¸ºtrueã€‚å› æ­¤ï¼Œä¼šå°†BR_NOOPå†™å…¥åˆ°bwr.read_bufferä¸­ã€‚ (02) thread-&gt;transaction_stackä¸ä¸ºç©ºï¼Œthread-&gt;todoä¹Ÿä¸ä¸ºç©ºã€‚å› ä¸ºï¼Œå‰é¢åœ¨binder_transaction()ä¸­æœ‰å°†ä¸€ä¸ªBINDER_WORK_TRANSACTION_COMPLETEç±»å‹çš„å¾…å®Œæˆå·¥ä½œæ·»åŠ åˆ°threadçš„å¾…å®Œæˆå·¥ä½œé˜Ÿåˆ—ä¸­ã€‚å› æ­¤ï¼Œwait_for_proc_workä¸ºfalseã€‚ (03) binder_has_thread_work(thread)ä¸ºtrueã€‚å› æ­¤ï¼Œåœ¨è°ƒç”¨wait_event_interruptible()æ—¶ï¼Œä¸ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œæ˜¯ç»§ç»­è¿è¡Œã€‚ (04) è¿›å…¥whileå¾ªç¯åï¼Œé€šè¿‡list_first_entry()å–å‡ºå¾…å®Œæˆå·¥ä½œwã€‚wçš„ç±»å‹w-&gt;type=BINDER_WORK_TRANSACTION_COMPLETEï¼Œè¿›å…¥åˆ°å¯¹åº”çš„switchåˆ†æ”¯ã€‚éšåï¼Œå°†BR_TRANSACTION_COMPLETEå†™å…¥åˆ°bwr.read_bufferä¸­ã€‚æ­¤æ—¶ï¼Œå¾…å¤„ç†å·¥ä½œå·²ç»å®Œæˆï¼Œå°†å…¶ä»å½“å‰çº¿ç¨‹çš„å¾…å¤„ç†å·¥ä½œé˜Ÿåˆ—ä¸­åˆ é™¤ã€‚ (05) æœ€åï¼Œæ›´æ–°bwr.read_consumedçš„å€¼ã€‚</p><p>ç»è¿‡binder_thread_read()å¤„ç†ä¹‹åï¼Œbwr.read_bufferä¸­åŒ…å«äº†ä¸¤ä¸ªæŒ‡ä»¤ï¼šBR_NOOPå’ŒBR_TRANSACTION_COMPLETEã€‚</p><h4 id="2-5ã€ServiceManagerå¤„ç†getServiceè¯·æ±‚"><a href="#2-5ã€ServiceManagerå¤„ç†getServiceè¯·æ±‚" class="headerlink" title="2.5ã€ServiceManagerå¤„ç†getServiceè¯·æ±‚"></a>2.5ã€ServiceManagerå¤„ç†getServiceè¯·æ±‚</h4><p>ä¸‹é¢çœ‹çœ‹ServiceManagerè¢«å”¤é†’ä¹‹åï¼Œæ˜¯å¦‚ä½•å¤„ç†getServiceè¯·æ±‚çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">int binder_parse(struct binder_state *bs, struct binder_io *bio,</span><br><span class="line">                 uint32_t *ptr, uint32_t size, binder_handler func)</span><br><span class="line">&#123;</span><br><span class="line">    while (ptr &lt; end) &#123;</span><br><span class="line">        case BR_TRANSACTION: &#123;</span><br><span class="line">            struct binder_txn *txn = (void *) ptr;</span><br><span class="line">            ...</span><br><span class="line">            if (func) &#123;</span><br><span class="line">                unsigned rdata[256/4];</span><br><span class="line">                struct binder_io msg;   // ç”¨äºä¿å­˜&quot;Binderé©±åŠ¨åé¦ˆçš„ä¿¡æ¯&quot;</span><br><span class="line">                struct binder_io reply; // ç”¨æ¥ä¿å­˜&quot;å›å¤ç»™Binderé©±åŠ¨çš„ä¿¡æ¯&quot;</span><br><span class="line">                int res;</span><br><span class="line"></span><br><span class="line">                // åˆå§‹åŒ–reply</span><br><span class="line">                bio_init(&amp;reply, rdata, sizeof(rdata), 4);</span><br><span class="line">                // æ ¹æ®txt(Binderé©±åŠ¨åé¦ˆçš„ä¿¡æ¯)åˆå§‹åŒ–msg</span><br><span class="line">                bio_init_from_txn(&amp;msg, txn);</span><br><span class="line">                // æ¶ˆæ¯å¤„ç†</span><br><span class="line">                res = func(bs, txn, &amp;msg, &amp;reply);</span><br><span class="line">                // åé¦ˆæ¶ˆæ¯ç»™Binderé©±åŠ¨ã€‚</span><br><span class="line">                binder_send_reply(bs, &amp;reply, txn-&gt;data, res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>binder_send_reply(bs, &amp;reply, txn-&gt;data, res);-&gt;binder_write()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">binder_write()</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_write</span><span class="params">(struct binder_state *bs, <span class="keyword">void</span> *data, <span class="keyword">unsigned</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    bwr.write_size = len;</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">unsigned</span>) data;</span><br><span class="line">    bwr.read_size = <span class="number">0</span>;</span><br><span class="line">    bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.read_buffer = <span class="number">0</span>;</span><br><span class="line">    res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"binder_write: ioctl failed (%s)\n"</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šbinder_write()ä¼šå°†æ•°æ®å°è£…åˆ°binder_write_readçš„å˜é‡bwrä¸­ï¼›å…¶ä¸­ï¼Œbwr.read_size=0ï¼Œè€Œbwr.write_size&gt;0ã€‚æ¥ç€ï¼Œä¾¿é€šè¿‡ioctl(,BINDER_WRITE_READ,)å’ŒBinderé©±åŠ¨äº¤äº’ï¼Œå°†æ•°æ®åé¦ˆç»™Binderé©±åŠ¨ã€‚</p><p>å†æ¬¡å›åˆ°Binderé©±åŠ¨çš„binder_ioctl()å¯¹åº”çš„BINDER_WRITE_READåˆ†æ”¯ä¸­ã€‚æ­¤æ—¶ï¼Œç”±äºbwr.read_size=0ï¼Œè€Œbwr.write_size&gt;0ï¼›å› æ­¤ï¼ŒBinderé©±åŠ¨åªè°ƒç”¨binder_thread_writeè¿›è¡Œå†™æ“ä½œï¼Œè€Œä¸ä¼šè¿›è¡Œè¯»ã€‚</p><p>è¿”å›æ•°æ®ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/42-Android-binder-Binder-io-transaction-data.jpg" alt="Markdown"></p><p>handle = 1 ä»£è¡¨ç¬¬ä¸€ä¸ª</p><h5 id="2-6ã€Binderé©±åŠ¨ä¸­å¤„ç†ServiceManagerè¿”å›æ•°æ®"><a href="#2-6ã€Binderé©±åŠ¨ä¸­å¤„ç†ServiceManagerè¿”å›æ•°æ®" class="headerlink" title="2.6ã€Binderé©±åŠ¨ä¸­å¤„ç†ServiceManagerè¿”å›æ•°æ®"></a>2.6ã€Binderé©±åŠ¨ä¸­å¤„ç†ServiceManagerè¿”å›æ•°æ®</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc, struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">void</span> __user *buffer, <span class="keyword">int</span> size, <span class="keyword">signed</span> <span class="keyword">long</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">  <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">  <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯»å–binder_write_read.write_bufferä¸­çš„å†…å®¹ã€‚</span></span><br><span class="line">  <span class="comment">// æ¯æ¬¡è¯»å–32bit(å³4ä¸ªå­—èŠ‚)</span></span><br><span class="line">  <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;</span><br><span class="line">      <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è¯»å–32bitåˆ°å†…æ ¸ä¸­ï¼Œå¹¶èµ‹å€¼ç»™cmdã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (get_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">          <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">      ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> BC_FREE_BUFFER:</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> BC_TRANSACTION:</span><br><span class="line">        <span class="keyword">case</span> BC_REPLY: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (copy_from_user(&amp;tr, ptr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(tr);</span><br><span class="line">            binder_transaction(proc, thread, &amp;tr, cmd == BC_REPLY);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°bwr.write_consumedçš„å€¼</span></span><br><span class="line">      *consumed = ptr - buffer;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>binder_thread_write()è¿›å…¥BC_REPLYä¹‹åï¼Œä¼šå°†æ•°æ®æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œç„¶åè°ƒç”¨binder_transaction()è¿›è¡Œå¤„ç†</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">tcomplete</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> *offp, *off_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">target_proc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">target_thread</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">target_list</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> *target_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">in_reply_to</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_log_entry</span> *<span class="title">e</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> return_error;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        <span class="comment">// äº‹åŠ¡æ ˆ</span></span><br><span class="line">        in_reply_to = thread-&gt;transaction_stack;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¼˜å…ˆçº§</span></span><br><span class="line">        binder_set_nice(in_reply_to-&gt;saved_priority);</span><br><span class="line">        ...</span><br><span class="line">        thread-&gt;transaction_stack = in_reply_to-&gt;to_parent;</span><br><span class="line">        <span class="comment">// å‘èµ·è¯·æ±‚çš„çº¿ç¨‹ï¼Œå³MediaPlayeræ‰€åœ¨çº¿ç¨‹ã€‚</span></span><br><span class="line">        <span class="comment">// fromçš„å€¼ï¼Œæ˜¯MediaPlayerå‘èµ·è¯·æ±‚æ—¶åœ¨binder_transaction()ä¸­èµ‹å€¼çš„ã€‚</span></span><br><span class="line">        target_thread = in_reply_to-&gt;from;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// MediaPlayerå¯¹åº”çš„è¿›ç¨‹</span></span><br><span class="line">        target_proc = target_thread-&gt;proc;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (target_thread) &#123;</span><br><span class="line">        e-&gt;to_thread = target_thread-&gt;pid;</span><br><span class="line">        target_list = &amp;target_thread-&gt;todo;</span><br><span class="line">        target_wait = &amp;target_thread-&gt;wait;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    e-&gt;to_proc = target_proc-&gt;pid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªå¾…å¤„ç†çš„äº‹åŠ¡tï¼Œtæ˜¯binderäº‹åŠ¡(binder_transactionå¯¹è±¡)</span></span><br><span class="line">    t = kzalloc(<span class="keyword">sizeof</span>(*t), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_alloc_t_failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªå¾…å®Œæˆçš„å·¥ä½œtcompleteï¼Œtcompleteæ˜¯binder_workå¯¹è±¡ã€‚</span></span><br><span class="line">    tcomplete = kzalloc(<span class="keyword">sizeof</span>(*tcomplete), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (tcomplete == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_alloc_tcomplete_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    binder_stats_created(BINDER_STAT_TRANSACTION_COMPLETE);</span><br><span class="line"></span><br><span class="line">    t-&gt;debug_id = ++binder_last_id;</span><br><span class="line">    e-&gt;debug_id = t-&gt;debug_id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!reply &amp;&amp; !(tr-&gt;flags &amp; TF_ONE_WAY))</span><br><span class="line">        t-&gt;from = thread;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t-&gt;from = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„ä¸€äº›èµ‹å€¼æ˜¯åˆå§‹åŒ–äº‹åŠ¡t</span></span><br><span class="line">    t-&gt;sender_euid = proc-&gt;tsk-&gt;cred-&gt;euid;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡å°†äº¤ç»™target_procè¿›ç¨‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    t-&gt;to_proc = target_proc;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡å°†äº¤ç»™target_threadçº¿ç¨‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    t-&gt;to_thread = target_thread;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡ç¼–ç </span></span><br><span class="line">    t-&gt;code = tr-&gt;code;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡æ ‡å¿—</span></span><br><span class="line">    t-&gt;flags = tr-&gt;flags;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡ä¼˜å…ˆçº§</span></span><br><span class="line">    t-&gt;priority = task_nice(current);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ç©ºé—´</span></span><br><span class="line">    t-&gt;buffer = binder_alloc_buf(target_proc, tr-&gt;data_size,</span><br><span class="line">        tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_binder_alloc_buf_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    t-&gt;buffer-&gt;allow_user_free = <span class="number">0</span>;</span><br><span class="line">    t-&gt;buffer-&gt;debug_id = t-&gt;debug_id;</span><br><span class="line">    <span class="comment">// ä¿å­˜äº‹åŠ¡</span></span><br><span class="line">    t-&gt;buffer-&gt;transaction = t;</span><br><span class="line">    <span class="comment">// target_nodeä¸ºNULL</span></span><br><span class="line">    t-&gt;buffer-&gt;target_node = target_node;</span><br><span class="line">    trace_binder_transaction_alloc_buf(t-&gt;buffer);</span><br><span class="line">    <span class="keyword">if</span> (target_node)</span><br><span class="line">        binder_inc_node(target_node, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    offp = (<span class="keyword">size_t</span> *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†"ç”¨æˆ·ä¼ å…¥çš„æ•°æ®"ä¿å­˜åˆ°äº‹åŠ¡ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(t-&gt;buffer-&gt;data, tr-&gt;data.ptr.buffer, tr-&gt;data_size)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†"ç”¨æˆ·ä¼ å…¥çš„æ•°æ®åç§»åœ°å€"ä¿å­˜åˆ°äº‹åŠ¡ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(offp, tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    off_end = (<span class="keyword">void</span> *)offp + tr-&gt;offsets_size;</span><br><span class="line">    <span class="comment">// å°†flat_binder_objectå¯¹è±¡è¯»å–å‡ºæ¥ï¼Œ</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå°±æ˜¯Service Managerä¸­åé¦ˆçš„MediaPlayerServiceå¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (; offp &lt; off_end; offp++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">flat_binder_object</span> *<span class="title">fp</span>;</span></span><br><span class="line">        ...</span><br><span class="line">        fp = (struct flat_binder_object *)(t-&gt;buffer-&gt;data + *offp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (fp-&gt;type) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">case</span> BINDER_TYPE_HANDLE:</span><br><span class="line">            <span class="keyword">case</span> BINDER_TYPE_WEAK_HANDLE: &#123;</span><br><span class="line">                <span class="comment">// æ ¹æ®handleè·å–å¯¹åº”çš„Binderå¼•ç”¨ï¼Œå³å¾—åˆ°MediaPlayerServiceçš„Binderå¼•ç”¨</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span> = <span class="title">binder_get_ref</span>(<span class="title">proc</span>, <span class="title">fp</span>-&gt;<span class="title">handle</span>);</span></span><br><span class="line">                <span class="keyword">if</span> (ref == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ref-&gt;node-&gt;procæ˜¯MediaPlayerServiceçš„è¿›ç¨‹ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œ</span></span><br><span class="line">                <span class="comment">// è€Œtarget_procæ˜¯MediaPlayerçš„è¿›ç¨‹ä¸Šä¸‹æ–‡ç¯å¢ƒ</span></span><br><span class="line">                <span class="keyword">if</span> (ref-&gt;node-&gt;proc == target_proc) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    struct binder_ref *new_ref;</span><br><span class="line">                    <span class="comment">// åœ¨MediaPlayerè¿›ç¨‹ä¸­å¼•ç”¨"MediaPlayerService"ã€‚</span></span><br><span class="line">                    <span class="comment">// è¡¨ç°ä¸ºï¼Œæ‰§è¡Œbinder_get_ref_for_node()ä¼šï¼Œä¼šå…ˆåœ¨MediaPlayerè¿›ç¨‹ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨MediaPlayerServiceå¯¹åº”çš„Binderå¼•ç”¨ï¼›</span></span><br><span class="line">                    <span class="comment">// å¾ˆæ˜¾ç„¶æ˜¯ä¸å­˜åœ¨çš„ã€‚äºæ˜¯ï¼Œå¹¶æ–°å»ºMediaPlayerServiceå¯¹åº”çš„Binderå¼•ç”¨ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°MediaPlayerçš„Binderå¼•ç”¨çº¢é»‘æ ‘ä¸­ã€‚</span></span><br><span class="line">                    new_ref = binder_get_ref_for_node(target_proc, ref-&gt;node);</span><br><span class="line">                    <span class="keyword">if</span> (new_ref == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        ...</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å°†new_refçš„å¼•ç”¨æè¿°å¤åˆ¶ç»™fp-&gt;handleã€‚</span></span><br><span class="line">                    fp-&gt;handle = new_ref-&gt;desc;</span><br><span class="line">                    binder_inc_ref(new_ref, fp-&gt;type == BINDER_TYPE_HANDLE, <span class="literal">NULL</span>);</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        binder_pop_transaction(target_thread, in_reply_to);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®äº‹åŠ¡çš„ç±»å‹ä¸ºBINDER_WORK_TRANSACTION</span></span><br><span class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</span><br><span class="line">    <span class="comment">// å°†äº‹åŠ¡æ·»åŠ åˆ°target_listé˜Ÿåˆ—ä¸­ï¼Œå³target_listçš„å¾…å¤„ç†äº‹åŠ¡ä¸­</span></span><br><span class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</span><br><span class="line">    <span class="comment">// è®¾ç½®å¾…å®Œæˆå·¥ä½œçš„ç±»å‹ä¸ºBINDER_WORK_TRANSACTION_COMPLETE</span></span><br><span class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</span><br><span class="line">    <span class="comment">// å°†å¾…å®Œæˆå·¥ä½œæ·»åŠ åˆ°thread-&gt;todoé˜Ÿåˆ—ä¸­ï¼Œå³å½“å‰çº¿ç¨‹çš„å¾…å®Œæˆå·¥ä½œä¸­ã€‚</span></span><br><span class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</span><br><span class="line">    <span class="comment">// å”¤é†’ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (target_wait)</span><br><span class="line">        wake_up_interruptible(target_wait);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šreply=1ï¼Œè¿™é‡Œåªå…³æ³¨replyéƒ¨åˆ†ã€‚ (01) æ­¤åé¦ˆæœ€ç»ˆæ˜¯è¦å›å¤ç»™TestClientçš„ã€‚å› æ­¤ï¼Œtarget_threadè¢«èµ‹å€¼ä¸ºTestServeræ‰€åœ¨çš„çº¿ç¨‹ï¼Œtarget_procåˆ™æ˜¯TestClientå¯¹åº”çš„è¿›ç¨‹ï¼Œtarget_nodeä¸ºnullã€‚ (02) è¿™é‡Œï¼Œå…ˆçœ‹çœ‹forå¾ªç¯é‡Œé¢çš„å†…å®¹ï¼Œå–å‡ºBR_REPLYæŒ‡ä»¤æ‰€å‘é€çš„æ•°æ®ï¼Œç„¶åè·å–æ•°æ®ä¸­çš„flat_binder_objectå˜é‡fpã€‚å› ä¸ºfp-&gt;typeä¸ºBINDER_TYPE_HANDLEï¼Œå› æ­¤è¿›å…¥BINDER_TYPE_HANDLEå¯¹åº”çš„åˆ†æ”¯ã€‚æ¥ç€ï¼Œé€šè¿‡binder_get_ref()è·å–Hello Serviceå¯¹åº”çš„Binderå¼•ç”¨ï¼›å¾ˆæ˜æ˜¾ï¼Œèƒ½å¤Ÿæ­£å¸¸è·å–åˆ°Hello Serviceçš„Binderå¼•ç”¨ã€‚å› ä¸ºåœ¨Hello Serviceè°ƒç”¨addServiceè¯·æ±‚æ—¶ï¼Œå·²ç»åˆ›å»ºäº†å®ƒçš„Binderå¼•ç”¨ã€‚ binder_get_ref_for_node()çš„ä½œç”¨æ˜¯åœ¨TestClentè¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­æ·»åŠ â€TestServerå¯¹åº”çš„Binderå¼•ç”¨â€ã€‚è¿™æ ·ï¼Œåé¢å°±å¯ä»¥æ ¹æ®è¯¥Binderå¼•ç”¨ä¸€æ­¥æ­¥çš„è·å–TestServerå¯¹è±¡ã€‚ æœ€åï¼Œå°†Binderå¼•ç”¨çš„æè¿°èµ‹å€¼ç»™fp-&gt;handleã€‚ (03) æ­¤æ—¶ï¼ŒService Managerå·²ç»å¤„ç†äº†getServiceè¯·æ±‚ã€‚ä¾¿è°ƒç”¨binder_pop_transaction(target_thread, in_reply_to)å°†äº‹åŠ¡ä»â€target_threadçš„äº‹åŠ¡æ ˆâ€ä¸­åˆ é™¤ï¼Œå³ä»MediaPlayerçº¿ç¨‹çš„äº‹åŠ¡æ ˆä¸­åˆ é™¤è¯¥äº‹åŠ¡ã€‚ (04) æ–°å»ºçš„â€å¾…å¤„ç†äº‹åŠ¡tâ€çš„typeä¸ºè®¾ä¸ºBINDER_WORK_TRANSACTIONåï¼Œä¼šè¢«æ·»åŠ åˆ°MediaPlayerçš„å¾…å¤„ç†äº‹åŠ¡é˜Ÿåˆ—ä¸­ã€‚ (05) æ­¤æ—¶ï¼ŒService Managerå·²ç»å¤„ç†äº†getServiceè¯·æ±‚ï¼Œè€ŒBinderé©±åŠ¨åœ¨ç­‰å¾…å®ƒçš„å›å¤ã€‚äºæ˜¯ï¼Œå°†ä¸€ä¸ªBINDER_WORK_TRANSACTION_COMPLETEç±»å‹çš„â€å¾…å®Œæˆå·¥ä½œtcompleteâ€(ä½œä¸ºå›å¤)æ·»åŠ åˆ°å½“å‰çº¿ç¨‹(å³ï¼ŒService Managerçº¿ç¨‹)çš„å¾…å¤„ç†äº‹åŠ¡é˜Ÿåˆ—ä¸­ã€‚ (06) æœ€åï¼Œè°ƒç”¨wake_up_interruptible()å”¤é†’TestServerã€‚TestServerè¢«å”¤é†’åï¼Œä¼šå¯¹äº‹åŠ¡BINDER_WORK_TRANSACTIONè¿›è¡Œå¤„ç†ã€‚</p><p>OKï¼Œåˆ°ç°åœ¨ä¸ºæ­¢ï¼Œè¿˜æœ‰ä¸¤ä¸ªå¾…å¤„ç†äº‹åŠ¡ï¼š(01) ServiceManagerå¾…å¤„ç†äº‹åŠ¡åˆ—è¡¨ä¸­æœ‰ä¸ªBINDER_WORK_TRANSACTION_COMPLETEç±»å‹çš„äº‹åŠ¡ (02) TestServerå¾…å¤„ç†äº‹åŠ¡åˆ—è¡¨ä¸­æœ‰ä¸ªBINDER_WORK_TRANSACTIONäº‹åŠ¡ã€‚</p><h4 id="2-7-Testclientè·å–handle"><a href="#2-7-Testclientè·å–handle" class="headerlink" title="2.7. Testclientè·å–handle"></a>2.7. Testclientè·å–handle</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/43-Android-binder-binder_use_service.png" alt="Markdown"></p><h3 id="ï¼ˆ3ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentä½¿ç”¨â€Helloâ€æœåŠ¡è¿‡ç¨‹"><a href="#ï¼ˆ3ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentä½¿ç”¨â€Helloâ€æœåŠ¡è¿‡ç¨‹" class="headerlink" title="ï¼ˆ3ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentä½¿ç”¨â€Helloâ€æœåŠ¡è¿‡ç¨‹"></a>ï¼ˆ3ï¼‰ã€Binderç³»ç»Ÿé©±åŠ¨æƒ…æ™¯åˆ†æâ€“TestClentä½¿ç”¨â€Helloâ€æœåŠ¡è¿‡ç¨‹</h3><p>æ„é€ æ•°æ®å‘é€æ•°æ®â€weidongshanâ€<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/44-Android-binder-Binder-io-transaction-data.jpg" alt="Markdown"></p><h2 id="å››ã€Android-Binderç³»ç»Ÿ-Nativeå±‚"><a href="#å››ã€Android-Binderç³»ç»Ÿ-Nativeå±‚" class="headerlink" title="å››ã€Android Binderç³»ç»Ÿ-Nativeå±‚"></a>å››ã€Android Binderç³»ç»Ÿ-Nativeå±‚</h2><p>å‰é¢æˆ‘ä»¬åˆ†æå†…æ ¸é©±åŠ¨Binderä½¿ç”¨è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œbinderç³»ç»Ÿåœ¨å†…æ ¸èƒ½æ­£å¸¸å®ŒæˆIPCé€šä¿¡ï¼Œæ¥ä¸‹æ¥åˆ†æAndroid framworkå±‚ï¼Œæœ€åæ˜¯Appå±‚ã€‚</p><p>Frameworkæ˜¯ä¸€ä¸ªä¸­é—´å±‚ï¼Œå®ƒå¯¹æ¥äº†åº•å±‚å®ç°ï¼Œå°è£…äº†å¤æ‚çš„å†…éƒ¨é€»è¾‘ï¼Œå¹¶æä¾›ä¾›å¤–éƒ¨ä½¿ç”¨çš„æ¥å£ã€‚Frameworkå±‚æ˜¯åº”ç”¨ç¨‹åºå¼€å‘çš„åŸºç¡€ã€‚</p><p>Binder Frameworkå±‚åˆ†ä¸ºC++å’ŒJavaä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸ºäº†è¾¾åˆ°åŠŸèƒ½çš„å¤ç”¨ï¼Œä¸­é—´é€šè¿‡JNIè¿›è¡Œè¡”æ¥ã€‚</p><p>Binder Frameworkçš„C++éƒ¨åˆ†ï¼Œå¤´æ–‡ä»¶ä½äºè¿™ä¸ªè·¯å¾„ï¼š/frameworks/native/include/binder/ï¼Œå®ç°ä½äºè¿™ä¸ªè·¯å¾„ï¼š/frameworks/native/libs/binder/ ã€‚Binderåº“æœ€ç»ˆä¼šç¼–è¯‘æˆä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼šlibbinder.soï¼Œä¾›å…¶ä»–è¿›ç¨‹é“¾æ¥ä½¿ç”¨ã€‚</p><p>ä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œä¸‹æ–‡ä¸­æˆ‘ä»¬å°†Binder Framework çš„C++éƒ¨åˆ†ç§°ä¹‹ä¸ºlibbinderã€‚é¦–å…ˆè¯´ä¸€ä¸‹ServiceManagerï¼Œç„¶åè¯¦ç»†ä»‹ç»ã€‚</p><h3 id="1-ã€ServiceManagerç±»å›¾-Nativeå±‚"><a href="#1-ã€ServiceManagerç±»å›¾-Nativeå±‚" class="headerlink" title="(1)ã€ServiceManagerç±»å›¾(Nativeå±‚)"></a>(1)ã€ServiceManagerç±»å›¾(Nativeå±‚)</h3><p>IServiceManagerç›¸å…³ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/45-Android-native_binder_framework_servicemananger.png" alt="Markdown"></p><p>IServiceManageræ˜¯è¡¨ç¤ºservicemanagerçš„æ¥å£ï¼Œæœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p><p>1) getServiceè·å¾—binder serviceå¼•ç”¨ï¼Œ</p><p>2) checkServiceè·å¾—binder serviceå¼•ç”¨ï¼Œ</p><p>3) addServiceæ·»åŠ binder serviceï¼Œ</p><p>4) listServices åˆ—ä¸¾æ‰€æœ‰binder serviceã€‚</p><p>servicemanagerçš„binder serviceæœåŠ¡ç«¯å…¶å®æ˜¯åœ¨frameworks/base/cmds/servicemanager é‡Œå®ç°ï¼ŒBnServiceManangerå®é™…ä¸Šå¹¶æœªä½¿ç”¨ã€‚BpServiceManangerå°±æ˜¯åˆ©ç”¨è·å¾—çš„IBinderæŒ‡é’ˆå»ºç«‹çš„IServiceManangerå¯¹è±¡çš„å®é™…ç±»å‹ã€‚</p><h3 id="2-ã€Binderæ¡†æ¶Nativeå±‚"><a href="#2-ã€Binderæ¡†æ¶Nativeå±‚" class="headerlink" title="(2)ã€Binderæ¡†æ¶Nativeå±‚"></a>(2)ã€Binderæ¡†æ¶Nativeå±‚</h3><p>libbinderä¸­ï¼Œå°†å®ç°åˆ†ä¸ºProxyå’ŒNativeä¸¤ç«¯ã€‚Proxyå¯¹åº”äº†ä¸Šæ–‡æåˆ°çš„Clientç«¯ï¼Œæ˜¯æœåŠ¡å¯¹å¤–æä¾›çš„æ¥å£ã€‚è€ŒNativeæ˜¯æœåŠ¡å®ç°çš„ä¸€ç«¯ï¼Œå¯¹åº”äº†ä¸Šæ–‡æåˆ°çš„Serverç«¯ã€‚ç±»åä¸­å¸¦æœ‰å°å†™å­—æ¯pçš„ï¼ˆä¾‹å¦‚BpInterfaceï¼‰ï¼Œå°±æ˜¯æŒ‡Proxyç«¯ã€‚ç±»åå¸¦æœ‰å°å†™å­—æ¯nçš„ï¼ˆä¾‹å¦‚BnInterfaceï¼‰ï¼Œå°±æ˜¯æŒ‡Nativeç«¯ã€‚</p><p>Proxyä»£è¡¨äº†è°ƒç”¨æ–¹ï¼Œé€šå¸¸ä¸æœåŠ¡çš„å®ç°ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ï¼Œå› æ­¤ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿç§°Proxyç«¯ä¸ºâ€è¿œç¨‹â€ç«¯ã€‚Nativeç«¯æ˜¯æœåŠ¡å®ç°çš„è‡ªèº«ï¼Œå› æ­¤ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿç§°Nativeç«¯ä¸ºâ€æœ¬åœ°â€ç«¯ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆå¯¹libbinderä¸­çš„ä¸»è¦ç±»åšä¸€ä¸ªç®€è¦è¯´æ˜ï¼Œäº†è§£ä¸€ä¸‹å®ƒä»¬çš„å…³ç³»ï¼Œç„¶åå†è¯¦ç»†çš„è®²è§£ã€‚</p><table><thead><tr><th style="text-align:left">ç±»å</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">BpRefBase</td><td style="text-align:left">RefBaseçš„å­ç±»ï¼Œæä¾›remote()æ–¹æ³•è·å–è¿œç¨‹Binder</td></tr><tr><td style="text-align:left">IInterface</td><td style="text-align:left">BinderæœåŠ¡æ¥å£çš„åŸºç±»ï¼ŒBinderæœåŠ¡é€šå¸¸éœ€è¦åŒæ—¶æä¾›æœ¬åœ°æ¥å£å’Œè¿œç¨‹æ¥å£</td></tr><tr><td style="text-align:left">BpInterface</td><td style="text-align:left">è¿œç¨‹æ¥å£çš„åŸºç±»ï¼Œè¿œç¨‹æ¥å£æ˜¯ä¾›å®¢æˆ·ç«¯è°ƒç”¨çš„æ¥å£é›†</td></tr><tr><td style="text-align:left">BnInterface</td><td style="text-align:left">æœ¬åœ°æ¥å£çš„åŸºç±»ï¼Œæœ¬åœ°æ¥å£æ˜¯éœ€è¦æœåŠ¡ä¸­çœŸæ­£å®ç°çš„æ¥å£é›†</td></tr><tr><td style="text-align:left">IBiner</td><td style="text-align:left">Binderå¯¹è±¡çš„åŸºç±»ï¼ŒBBinderå’ŒBpBinderéƒ½æ˜¯è¿™ä¸ªç±»çš„å­ç±»</td></tr><tr><td style="text-align:left">BpBinder</td><td style="text-align:left">è¿œç¨‹Binderï¼Œè¿™ä¸ªç±»æä¾›transactæ–¹æ³•æ¥å‘é€è¯·æ±‚ï¼ŒBpXXXå®ç°ä¸­ä¼šç”¨åˆ°</td></tr><tr><td style="text-align:left">BBinder</td><td style="text-align:left">æœ¬åœ°Binderï¼ŒæœåŠ¡å®ç°æ–¹çš„åŸºç±»ï¼Œæä¾›äº†onTransactæ¥å£æ¥æ¥æ”¶è¯·æ±‚</td></tr><tr><td style="text-align:left">ProcessState</td><td style="text-align:left">ä»£è¡¨äº†ä½¿ç”¨Binderçš„è¿›ç¨‹</td></tr><tr><td style="text-align:left">IPCThreadState</td><td style="text-align:left">ä»£è¡¨äº†ä½¿ç”¨Binderçš„çº¿ç¨‹ï¼Œè¿™ä¸ªç±»ä¸­å°è£…äº†ä¸Binderé©±åŠ¨é€šä¿¡çš„é€»è¾‘</td></tr><tr><td style="text-align:left">Parcel</td><td style="text-align:left">åœ¨Binderä¸Šä¼ é€’çš„æ•°æ®çš„åŒ…è£…å™¨</td></tr></tbody></table><p>ä¸‹å›¾æè¿°äº†è¿™äº›ç±»ä¹‹é—´çš„å…³ç³»ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/46-Androi-binder_middleware.png" alt="Markdown"></p><p>å¦å¤–è¯´æ˜ä¸€ä¸‹ï¼ŒBinderæœåŠ¡çš„å®ç°ç±»ï¼ˆå›¾ä¸­ç´«è‰²éƒ¨åˆ†ï¼‰é€šå¸¸éƒ½ä¼šéµå®ˆä¸‹é¢çš„å‘½åè§„åˆ™ï¼š</p><p>â˜¯ æœåŠ¡çš„æ¥å£ä½¿ç”¨Iå­—æ¯ä½œä¸ºå‰ç¼€ â˜¯ è¿œç¨‹æ¥å£ä½¿ç”¨Bpä½œä¸ºå‰ç¼€ â˜¯ æœ¬åœ°æ¥å£ä½¿ç”¨Bnä½œä¸ºå‰ç¼€</p><p>çœ‹äº†ä¸Šé¢è¿™äº›ä»‹ç»ï¼Œä½ å¯èƒ½è¿˜æ˜¯ä¸å¤ªå®¹æ˜“ç†è§£ã€‚ä¸è¿‡ä¸è¦ç´§ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šé€æ­¥æ‹†åˆ†è®²è§£è¿™äº›å†…å®¹ã€‚</p><p>åœ¨è¿™å¹…å›¾ä¸­ï¼Œæµ…é»„è‰²éƒ¨åˆ†çš„ç»“æ„æ˜¯æœ€éš¾ç†è§£çš„ï¼Œå› æ­¤æˆ‘ä»¬å…ˆä»å®ƒä»¬ç€æ‰‹ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹IBinderè¿™ä¸ªç±»ã€‚è¿™ä¸ªç±»æè¿°äº†æ‰€æœ‰åœ¨Binderä¸Šä¼ é€’çš„å¯¹è±¡ï¼Œå®ƒæ—¢æ˜¯Binderæœ¬åœ°å¯¹è±¡BBinderçš„çˆ¶ç±»ï¼Œä¹Ÿæ˜¯Binderè¿œç¨‹å¯¹è±¡BpBinderçš„çˆ¶ç±»ã€‚è¿™ä¸ªç±»ä¸­çš„ä¸»è¦æ–¹æ³•è¯´æ˜å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:left">æ–¹æ³•å</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">localBinder</td><td style="text-align:left">è·å–æœ¬åœ°Binderå¯¹è±¡</td></tr><tr><td style="text-align:left">remoteBinder</td><td style="text-align:left">è·å–è¿œç¨‹Binderå¯¹è±¡</td></tr><tr><td style="text-align:left">transact</td><td style="text-align:left">è¿›è¡Œä¸€æ¬¡Binderæ“ä½œ</td></tr><tr><td style="text-align:left">queryLocalInterface</td><td style="text-align:left">å°è¯•è·å–æœ¬åœ°Binderï¼Œå¦‚ä½•å¤±è´¥è¿”å›NULL</td></tr><tr><td style="text-align:left">getInterfaceDescriptor</td><td style="text-align:left">è·å–Binderçš„æœåŠ¡æ¥å£æè¿°ï¼Œå…¶å®å°±æ˜¯BinderæœåŠ¡çš„å”¯ä¸€æ ‡è¯†</td></tr><tr><td style="text-align:left">isBinderAlive</td><td style="text-align:left">æŸ¥è¯¢BinderæœåŠ¡æ˜¯å¦è¿˜æ´»ç€</td></tr><tr><td style="text-align:left">pingBinder</td><td style="text-align:left">å‘é€PING_TRANSACTIONç»™BinderæœåŠ¡</td></tr></tbody></table><p>BpBinderçš„å®ä¾‹ä»£è¡¨äº†è¿œç¨‹Binderï¼Œè¿™ä¸ªç±»çš„å¯¹è±¡å°†è¢«å®¢æˆ·ç«¯è°ƒç”¨ã€‚å…¶ä¸­handleæ–¹æ³•ä¼šè¿”å›æŒ‡å‘BinderæœåŠ¡å®ç°è€…çš„å¥æŸ„ï¼Œè¿™ä¸ªç±»æœ€é‡è¦å°±æ˜¯æä¾›äº†transactæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå°†è¿œç¨‹è°ƒç”¨çš„å‚æ•°å°è£…å¥½å‘é€çš„Binderé©±åŠ¨ã€‚</p><p>ç”±äºæ¯ä¸ªBinderæœåŠ¡é€šå¸¸éƒ½ä¼šæä¾›å¤šä¸ªæœåŠ¡æ¥å£ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ä¸­çš„uint32_t codeå‚æ•°å°±æ˜¯ç”¨æ¥å¯¹æœåŠ¡æ¥å£è¿›è¡Œç¼–å·åŒºåˆ†çš„ã€‚BinderæœåŠ¡çš„æ¯ä¸ªæ¥å£éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„codeï¼Œè¿™ä¸ªcodeè¦åœ¨Proxyå’ŒNativeç«¯é…å¯¹å¥½ã€‚å½“å®¢æˆ·ç«¯å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡ç«¯çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯æ ¹æ®è¿™ä¸ªcodeï¼ˆonTransactæ–¹æ³•ä¸­ï¼‰æ¥åŒºåˆ†è°ƒç”¨å“ªä¸ªæ¥å£æ–¹æ³•ã€‚</p><p>BBinderçš„å®ä¾‹ä»£è¡¨äº†æœ¬åœ°Binderï¼Œå®ƒæè¿°äº†æœåŠ¡çš„æä¾›æ–¹ï¼Œæ‰€æœ‰BinderæœåŠ¡çš„å®ç°è€…éƒ½è¦ç»§æ‰¿è¿™ä¸ªç±»ï¼ˆçš„å­ç±»ï¼‰ï¼Œåœ¨ç»§æ‰¿ç±»ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯å®ç°onTransactæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯æ‰€æœ‰è¯·æ±‚çš„å…¥å£ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å’ŒBpBinderä¸­çš„transactæ–¹æ³•å¯¹åº”çš„ï¼Œè¿™ä¸ªæ–¹æ³•åŒæ ·ä¹Ÿæœ‰ä¸€ä¸ªuint32_t codeå‚æ•°ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¸­ï¼Œç”±æœåŠ¡æä¾›è€…é€šè¿‡codeå¯¹è¯·æ±‚çš„æ¥å£è¿›è¡ŒåŒºåˆ†ï¼Œç„¶åè°ƒç”¨å…·ä½“å®ç°æœåŠ¡çš„æ–¹æ³•ã€‚</p><p>IBinderä¸­å®šä¹‰äº†uint32_t codeå…è®¸çš„èŒƒå›´ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FIRST_CALL_TRANSACTION  = <span class="number">0x00000001</span>,</span><br><span class="line">LAST_CALL_TRANSACTION   = <span class="number">0x00ffffff</span>,</span><br></pre></td></tr></table></figure><p>BinderæœåŠ¡è¦ä¿è¯è‡ªå·±æä¾›çš„æ¯ä¸ªæœåŠ¡æ¥å£æœ‰ä¸€ä¸ªå”¯ä¸€çš„codeï¼Œä¾‹å¦‚helloæœåŠ¡:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_SVR_CMD_SAYHELLO     1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_SVR_CMD_SAYHELLO_TO  2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_SVR_CMD_GET_FD       3</span></span><br></pre></td></tr></table></figure><p>è®²å®Œäº†IBinderï¼ŒBpBinderå’ŒBBinderä¸‰ä¸ªç±»ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹BpReBaseï¼ŒIInterfaceï¼ŒBpInterfaceå’ŒBnInterfaceã€‚</p><p>æ¯ä¸ªBinderæœåŠ¡éƒ½æ˜¯ä¸ºäº†æŸä¸ªåŠŸèƒ½è€Œå®ç°çš„ï¼Œå› æ­¤å…¶æœ¬èº«ä¼šå®šä¹‰ä¸€å¥—æ¥å£é›†ï¼ˆé€šå¸¸æ˜¯C++çš„ä¸€ä¸ªç±»ï¼‰æ¥æè¿°è‡ªå·±æä¾›çš„æ‰€æœ‰åŠŸèƒ½ã€‚è€ŒBinderæœåŠ¡æ—¢æœ‰è‡ªèº«å®ç°æœåŠ¡çš„ç±»ï¼Œä¹Ÿè¦æœ‰ç»™å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨çš„ç±»ã€‚ä¸ºäº†ä¾¿äºå¼€å‘ï¼Œè¿™ä¸¤ä¸­ç±»é‡Œé¢çš„æœåŠ¡æ¥å£åº”å½“æ˜¯ä¸€è‡´çš„ï¼Œä¾‹å¦‚ï¼šå‡è®¾æœåŠ¡å®ç°æ–¹æä¾›äº†ä¸€ä¸ªæ¥å£ä¸ºsayhello(void)çš„æœåŠ¡æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶è¿œç¨‹æ¥å£ä¸­ä¹Ÿåº”å½“æœ‰ä¸€ä¸ªsayhello(void)æ–¹æ³•ã€‚å› æ­¤ä¸ºäº†å®ç°æ–¹ä¾¿ï¼Œæœ¬åœ°å®ç°ç±»å’Œè¿œç¨‹æ¥å£ç±»éœ€è¦æœ‰ä¸€ä¸ªå…¬å…±çš„æè¿°æœåŠ¡æ¥å£çš„åŸºç±»ï¼ˆå³ä¸Šå›¾ä¸­çš„IXXXServiceï¼‰æ¥ç»§æ‰¿ã€‚è€Œè¿™ä¸ªåŸºç±»é€šå¸¸æ˜¯IInterfaceçš„å­ç±»ï¼ŒIInterfaceçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IInterface</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> RefBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">            IInterface();</span><br><span class="line">            <span class="keyword">static</span> sp&lt;IBinder&gt;  asBinder(<span class="keyword">const</span> IInterface*);</span><br><span class="line">            <span class="keyword">static</span> sp&lt;IBinder&gt;  asBinder(<span class="keyword">const</span> sp&lt;IInterface&gt;&amp;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span>                     ~IInterface();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IBinder*            <span class="title">onAsBinder</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥è¦ç»§æ‰¿è‡ªIInterfaceç±»æ˜¯å› ä¸ºè¿™ä¸ªç±»ä¸­å®šä¹‰äº†onAsBinderè®©å­ç±»å®ç°ã€‚onAsBinderåœ¨æœ¬åœ°å¯¹è±¡çš„å®ç°ç±»ä¸­è¿”å›çš„æ˜¯æœ¬åœ°å¯¹è±¡ï¼Œåœ¨è¿œç¨‹å¯¹è±¡çš„å®ç°ç±»ä¸­è¿”å›çš„æ˜¯è¿œç¨‹å¯¹è±¡ã€‚onAsBinderæ–¹æ³•è¢«ä¸¤ä¸ªé™æ€æ–¹æ³•asBinderæ–¹æ³•è°ƒç”¨ã€‚æœ‰äº†è¿™äº›æ¥å£ä¹‹åï¼Œåœ¨ä»£ç ä¸­ä¾¿å¯ä»¥ç›´æ¥é€šè¿‡IXXX::asBinderæ–¹æ³•è·å–åˆ°ä¸ç”¨åŒºåˆ†æœ¬åœ°è¿˜æ˜¯è¿œç¨‹çš„IBinderå¯¹è±¡ã€‚è¿™ä¸ªåœ¨è·¨è¿›ç¨‹ä¼ é€’Binderå¯¹è±¡çš„æ—¶å€™æœ‰å¾ˆå¤§çš„ä½œç”¨ï¼ˆå› ä¸ºä¸ç”¨åŒºåˆ†å…·ä½“ç»†èŠ‚ï¼Œåªè¦ç›´æ¥è°ƒç”¨å’Œä¼ é€’å°±å¥½ï¼‰ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹BpInterfaceå’ŒBnInterfaceçš„å®šä¹‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BnInterface</span> :</span> <span class="keyword">public</span> INTERFACE, <span class="keyword">public</span> BBinder</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> sp&lt;IInterface&gt;      queryLocalInterface(<span class="keyword">const</span> String16&amp; _descriptor);</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> String16&amp;     <span class="title">getInterfaceDescriptor</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IBinder*            <span class="title">onAsBinder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BpInterface</span> :</span> <span class="keyword">public</span> INTERFACE, <span class="keyword">public</span> BpRefBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">                                BpInterface(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; remote);</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IBinder*            <span class="title">onAsBinder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªç±»éƒ½æ˜¯æ¨¡æ¿ç±»ï¼Œå®ƒä»¬åœ¨ç»§æ‰¿è‡ªINTERFACEçš„åŸºç¡€ä¸Šå„è‡ªç»§æ‰¿äº†å¦å¤–ä¸€ä¸ªç±»ã€‚è¿™é‡Œçš„INTERFACEä¾¿æ˜¯æˆ‘ä»¬BinderæœåŠ¡æ¥å£çš„åŸºç±»ã€‚å¦å¤–ï¼ŒBnInterfaceç»§æ‰¿äº†BBinderç±»ï¼Œç”±æ­¤å¯ä»¥é€šè¿‡å¤å†™onTransactæ–¹æ³•æ¥æä¾›å®ç°ã€‚BpInterfaceç»§æ‰¿äº†BpRefBaseï¼Œé€šè¿‡è¿™ä¸ªç±»çš„remoteæ–¹æ³•å¯ä»¥è·å–åˆ°æŒ‡å‘æœåŠ¡å®ç°æ–¹çš„å¥æŸ„ã€‚åœ¨å®¢æˆ·ç«¯æ¥å£çš„å®ç°ç±»ä¸­ï¼Œæ¯ä¸ªæ¥å£åœ¨ç»„è£…å¥½å‚æ•°ä¹‹åï¼Œéƒ½ä¼šè°ƒç”¨remote()-&gt;transactæ¥å‘é€è¯·æ±‚ï¼Œè€Œè¿™é‡Œå…¶å®å°±æ˜¯è°ƒç”¨çš„BpBinderçš„transactæ–¹æ³•ï¼Œè¿™æ ·è¯·æ±‚ä¾¿é€šè¿‡Binderåˆ°è¾¾äº†æœåŠ¡å®ç°æ–¹çš„onTransactä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/47-Android-Binder-IPCall.png" alt="Markdown"></p><p>åŸºäºBinderæ¡†æ¶å¼€å‘çš„æœåŠ¡ï¼Œé™¤äº†æ»¡è¶³ä¸Šæ–‡æåˆ°çš„ç±»åè§„åˆ™ä¹‹å¤–ï¼Œè¿˜éœ€è¦éµå®ˆå…¶ä»–ä¸€äº›å…±åŒçš„è§„çº¦ï¼š</p><p>â˜¯ä¸ºäº†è¿›è¡ŒæœåŠ¡çš„åŒºåˆ†ï¼Œæ¯ä¸ªBinderæœåŠ¡éœ€è¦æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†é€šè¿‡getInterfaceDescriptorè¿”å›ï¼Œç±»å‹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚é€šå¸¸ï¼ŒBinderæœåŠ¡ä¼šåœ¨ç±»ä¸­å®šä¹‰static const android::String16 descriptor;è¿™æ ·ä¸€ä¸ªå¸¸é‡æ¥æè¿°è¿™ä¸ªæ ‡è¯†ç¬¦ï¼Œç„¶ååœ¨getInterfaceDescriptoræ–¹æ³•ä¸­è¿”å›è¿™ä¸ªå¸¸é‡ã€‚ â˜¯ä¸ºäº†ä¾¿äºè°ƒç”¨è€…è·å–åˆ°è°ƒç”¨æ¥å£ï¼ŒæœåŠ¡æ¥å£çš„å…¬å…±åŸºç±»éœ€è¦æä¾›ä¸€ä¸ªandroid::sp</p><ixxx>asInterfaceæ–¹æ³•æ¥è¿”å›åŸºç±»å¯¹è±¡æŒ‡é’ˆã€‚<br>ç”±äºä¸Šé¢æåˆ°çš„è¿™ä¸¤ç‚¹å¯¹äºæ‰€æœ‰BinderæœåŠ¡çš„å®ç°é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„ã€‚ä¸ºäº†ç®€åŒ–å¼€å‘è€…çš„é‡å¤å·¥ä½œï¼Œåœ¨libbinderä¸­ï¼Œå®šä¹‰äº†ä¸¤ä¸ªå®æ¥ç®€åŒ–è¿™äº›é‡å¤å·¥ä½œï¼Œå®ƒä»¬æ˜¯ï¼š</ixxx><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_META_INTERFACE(INTERFACE)                            \</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> android::String16 descriptor;                       \</span><br><span class="line">    <span class="keyword">static</span> android::sp&lt;I##INTERFACE&gt; asInterface(                    \</span><br><span class="line">            <span class="keyword">const</span> android::sp&lt;android::IBinder&gt;&amp; obj);               \</span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> android::<span class="function">String16&amp; <span class="title">getInterfaceDescriptor</span><span class="params">()</span> <span class="keyword">const</span></span>; \</span><br><span class="line">    I##INTERFACE();                                                  \</span><br><span class="line">    <span class="keyword">virtual</span> ~I##INTERFACE();                                         \</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_META_INTERFACE(INTERFACE, NAME)                    \</span></span><br><span class="line">    <span class="keyword">const</span> android::String16 I##INTERFACE::descriptor(NAME);          \</span><br><span class="line">    <span class="keyword">const</span> android::String16&amp;                                         \</span><br><span class="line">            I##INTERFACE::getInterfaceDescriptor() <span class="keyword">const</span> &#123;           \</span><br><span class="line">        <span class="keyword">return</span> I##INTERFACE::descriptor;                             \</span><br><span class="line">    &#125;                                                                \</span><br><span class="line">    android::sp&lt;I##INTERFACE&gt; I##INTERFACE::asInterface(             \</span><br><span class="line">            <span class="keyword">const</span> android::sp&lt;android::IBinder&gt;&amp; obj)                \</span><br><span class="line">    &#123;                                                                \</span><br><span class="line">        android::sp&lt;I##INTERFACE&gt; intr;                              \</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;                                           \</span><br><span class="line">            intr = <span class="keyword">static_cast</span>&lt;I##INTERFACE*&gt;(                       \</span><br><span class="line">                obj-&gt;queryLocalInterface(                            \</span><br><span class="line">                        I##INTERFACE::descriptor).get());            \</span><br><span class="line">            <span class="keyword">if</span> (intr == <span class="literal">NULL</span>) &#123;                                      \</span><br><span class="line">                intr = <span class="keyword">new</span> Bp##INTERFACE(obj);                       \</span><br><span class="line">            &#125;                                                        \</span><br><span class="line">        &#125;                                                            \</span><br><span class="line">        <span class="keyword">return</span> intr;                                                 \</span><br><span class="line">    &#125;                                                                \</span><br><span class="line">    I##INTERFACE::I##INTERFACE() &#123; &#125;                                 \</span><br><span class="line">    I##INTERFACE::~I##INTERFACE() &#123; &#125;                                \</span><br></pre></td></tr></table></figure><p>æœ‰äº†è¿™ä¸¤ä¸ªå®ä¹‹åï¼Œå¼€å‘è€…åªè¦åœ¨æ¥å£åŸºç±»ï¼ˆIXXXï¼‰å¤´æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨DECLARE_META_INTERFACEå®ä¾¿å®Œæˆäº†éœ€è¦çš„ç»„ä»¶çš„å£°æ˜ã€‚ç„¶ååœ¨cppæ–‡ä»¶ä¸­ä½¿ç”¨IMPLEMENT_META_INTERFACEä¾¿å®Œæˆäº†è¿™äº›ç»„ä»¶çš„å®ç°ã€‚</p><h4 id="2-1ã€Binderçš„åˆå§‹åŒ–ProcessState"><a href="#2-1ã€Binderçš„åˆå§‹åŒ–ProcessState" class="headerlink" title="2.1ã€Binderçš„åˆå§‹åŒ–ProcessState"></a>2.1ã€<strong>Binderçš„åˆå§‹åŒ–ProcessState</strong></h4><p>åœ¨è®²è§£Binderé©±åŠ¨çš„æ—¶å€™æˆ‘ä»¬å°±æåˆ°ï¼šä»»ä½•ä½¿ç”¨Binderæœºåˆ¶çš„è¿›ç¨‹éƒ½å¿…é¡»è¦å¯¹/dev/binderè®¾å¤‡è¿›è¡Œopenä»¥åŠmmapä¹‹åæ‰èƒ½ä½¿ç”¨ï¼Œè¿™éƒ¨åˆ†é€»è¾‘æ˜¯æ‰€æœ‰ä½¿ç”¨Binderæœºåˆ¶è¿›ç¨‹å…±åŒçš„ã€‚å¯¹äºè¿™ç§å…±åŒé€»è¾‘çš„å°è£…ä¾¿æ˜¯Frameworkå±‚çš„èŒè´£ä¹‹ä¸€ã€‚libbinderä¸­ï¼ŒProcessStateç±»å°è£…äº†è¿™ä¸ªé€»è¾‘ï¼Œç›¸å…³ä»£ç è§ä¸‹æ–‡ã€‚</p><p>è¿™é‡Œæ˜¯ProcessStateæ„é€ å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œåˆå§‹åŒ–mDriverFDçš„æ—¶å€™è°ƒç”¨äº†open_driveræ–¹æ³•æ‰“å¼€binderè®¾å¤‡ï¼Œç„¶ååˆåœ¨å‡½æ•°ä½“ä¸­ï¼Œé€šè¿‡mmapè¿›è¡Œå†…å­˜æ˜ å°„ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ProcessState::ProcessState()</span><br><span class="line">    : mDriverFD(open_driver())</span><br><span class="line">    , mVMStart(MAP_FAILED)</span><br><span class="line">    , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER)</span><br><span class="line">    , mThreadCountDecrement(PTHREAD_COND_INITIALIZER)</span><br><span class="line">    , mExecutingThreadsCount(<span class="number">0</span>)</span><br><span class="line">    , mMaxThreads(DEFAULT_MAX_BINDER_THREADS)</span><br><span class="line">    , mStarvationStartTimeMs(<span class="number">0</span>)</span><br><span class="line">    , mManagesContexts(<span class="literal">false</span>)</span><br><span class="line">    , mBinderContextCheckFunc(<span class="literal">NULL</span>)</span><br><span class="line">    , mBinderContextUserData(<span class="literal">NULL</span>)</span><br><span class="line">    , mThreadPoolStarted(<span class="literal">false</span>)</span><br><span class="line">    , mThreadPoolSeq(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDriverFD &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        mVMStart = mmap(<span class="number">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>open_driverçš„å‡½æ•°å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆäº†ä¸‰ä¸ªå·¥ä½œï¼š</p><p>â˜¯é¦–å…ˆé€šè¿‡openç³»ç»Ÿè°ƒç”¨æ‰“å¼€äº†dev/binderè®¾å¤‡ â˜¯ç„¶åé€šè¿‡ioctlè·å–Binderå®ç°çš„ç‰ˆæœ¬å·ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦åŒ¹é… â˜¯æœ€åé€šè¿‡ioctlè®¾ç½®è¿›ç¨‹æ”¯æŒçš„æœ€å¤§çº¿ç¨‹æ•°é‡ å…³äºè¿™éƒ¨åˆ†é€»è¾‘èƒŒåçš„å¤„ç†ï¼Œåœ¨è®²è§£Binderé©±åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»è®²è§£è¿‡äº†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">open_driver</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/binder"</span>, O_RDWR | O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> vers = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">status_t</span> result = ioctl(fd, BINDER_VERSION, &amp;vers);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">size_t</span> maxThreads = DEFAULT_MAX_BINDER_THREADS;</span><br><span class="line">        result = ioctl(fd, BINDER_SET_MAX_THREADS, &amp;maxThreads);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProcessStateæ˜¯ä¸€ä¸ªSingletonï¼ˆå•ä¾‹ï¼‰ç±»å‹çš„ç±»ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œåªä¼šå­˜åœ¨ä¸€ä¸ªå®ä¾‹ã€‚é€šè¿‡ProcessState::self()æ¥å£è·å–è¿™ä¸ªå®ä¾‹ã€‚ä¸€æ—¦è·å–è¿™ä¸ªå®ä¾‹ï¼Œä¾¿ä¼šæ‰§è¡Œå…¶æ„é€ å‡½æ•°ï¼Œç”±æ­¤å®Œæˆäº†å¯¹äºBinderè®¾å¤‡çš„åˆå§‹åŒ–å·¥ä½œã€‚</p><h4 id="2-2ã€å…³äºBinderä¼ é€’æ•°æ®çš„å¤§å°é™åˆ¶"><a href="#2-2ã€å…³äºBinderä¼ é€’æ•°æ®çš„å¤§å°é™åˆ¶" class="headerlink" title="2.2ã€å…³äºBinderä¼ é€’æ•°æ®çš„å¤§å°é™åˆ¶"></a>2.2ã€<strong>å…³äºBinderä¼ é€’æ•°æ®çš„å¤§å°é™åˆ¶</strong></h4><p>ç”±äºBinderçš„æ•°æ®éœ€è¦è·¨è¿›ç¨‹ä¼ é€’ï¼Œå¹¶ä¸”è¿˜éœ€è¦åœ¨å†…æ ¸ä¸Šå¼€è¾Ÿç©ºé—´ï¼Œå› æ­¤å…è®¸åœ¨Binderä¸Šä¼ é€’çš„æ•°æ®å¹¶ä¸æ˜¯æ— æ— é™å¤§çš„ã€‚mmapä¸­æŒ‡å®šçš„å¤§å°ä¾¿æ˜¯å¯¹æ•°æ®ä¼ é€’çš„å¤§å°é™åˆ¶ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_VM_SIZE ((1*1024*1024) - (4096 *2)) <span class="comment">// 1M - 8k</span></span></span><br><span class="line">mVMStart = mmap(<span class="number">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨è¿›è¡Œmmapçš„æ—¶å€™ï¼ŒæŒ‡å®šäº†æœ€å¤§sizeä¸ºBINDER_VM_SIZEï¼Œå³ 1M - 8kçš„å¤§å°ã€‚ å› æ­¤æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸€æ¬¡Binderè°ƒç”¨çš„æ•°æ®æ€»å’Œä¸èƒ½è¶…è¿‡è¿™ä¸ªå¤§å°ã€‚</p><p>å¯¹äºè¿™ä¸ªåŒºåŸŸçš„å¤§å°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è®¾å¤‡ä¸Šè¿›è¡Œç¡®è®¤ã€‚è¿™é‡Œæˆ‘ä»¬è¿˜ä¹‹å‰æåˆ°çš„system_serverä¸ºä¾‹ã€‚ä¸Šé¢æˆ‘ä»¬è®²è§£äº†é€šè¿‡procfsæ¥è·å–æ˜ å°„çš„å†…å­˜åœ°å€ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡showmapå‘½ä»¤ï¼Œæ¥ç¡®å®šè¿™å—åŒºåŸŸçš„å¤§å°ï¼Œç›¸å…³å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">angler:/ <span class="meta"># ps  | grep system_server                                            </span></span><br><span class="line">system    <span class="number">1889</span>  <span class="number">526</span>   <span class="number">2353404</span> <span class="number">135968</span> SyS_epoll_ <span class="number">72972</span>eeaf4 S system_server</span><br><span class="line">angler:/ <span class="meta"># showmap 1889 | grep <span class="meta-string">"/dev/binder"</span>                                   </span></span><br><span class="line">    <span class="number">1016</span>        <span class="number">4</span>        <span class="number">4</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">4</span>        <span class="number">0</span>        <span class="number">0</span>    <span class="number">1</span> /dev/binder</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™å—åŒºåŸŸçš„å¤§å°æ­£æ˜¯ 1M - 8K = 1016kã€‚</p><p>Tips: é€šè¿‡showmapå‘½ä»¤å¯ä»¥çœ‹åˆ°è¿›ç¨‹çš„è¯¦ç»†å†…å­˜å ç”¨æƒ…å†µã€‚åœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬è¦å¯¹æŸä¸ªè¿›ç¨‹åšå†…å­˜å ç”¨åˆ†æçš„æ—¶å€™ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯ç›¸å½“æœ‰ç”¨çš„ã€‚å»ºè®®è¯»è€…å°è¯•é€šè¿‡showmapå‘½ä»¤æŸ¥çœ‹system_serveræˆ–å…¶ä»–æ„Ÿå…´è¶£è¿›ç¨‹çš„å®Œæ•´mapï¼Œçœ‹çœ‹è¿™äº›è¿›ç¨‹éƒ½ä¾èµ–äº†å“ªäº›åº“æˆ–è€…æ¨¡å—ï¼Œä»¥åŠå†…å­˜å ç”¨æƒ…å†µæ˜¯æ€æ ·çš„ã€‚</p><h4 id="2-3ã€ä¸é©±åŠ¨çš„é€šä¿¡IPCThreadState"><a href="#2-3ã€ä¸é©±åŠ¨çš„é€šä¿¡IPCThreadState" class="headerlink" title="2.3ã€ä¸é©±åŠ¨çš„é€šä¿¡IPCThreadState"></a>2.3ã€<strong>ä¸é©±åŠ¨çš„é€šä¿¡IPCThreadState</strong></h4><p>ä¸Šæ–‡æåˆ°ProcessStateæ˜¯ä¸€ä¸ªå•ä¾‹ç±»ï¼Œä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚è€Œè´Ÿè´£ä¸Binderé©±åŠ¨é€šä¿¡çš„IPCThreadStateä¹Ÿæ˜¯ä¸€ä¸ªå•ä¾‹ç±»ã€‚ä½†è¿™ä¸ªç±»ä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè€Œæ˜¯ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªå®ä¾‹ã€‚</p><p>IPCThreadStateè´Ÿè´£äº†ä¸é©±åŠ¨é€šä¿¡çš„ç»†èŠ‚å¤„ç†ã€‚è¿™ä¸ªç±»ä¸­çš„å…³é”®å‡ ä¸ªæ–¹æ³•è¯´æ˜å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:left">æ–¹æ³•</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">transact</td><td style="text-align:left">å…¬å¼€æ¥å£ã€‚ä¾›Proxyå‘é€æ•°æ®åˆ°é©±åŠ¨ï¼Œå¹¶è¯»å–è¿”å›ç»“æœ</td></tr><tr><td style="text-align:left">sendReply</td><td style="text-align:left">ä¾›Serverç«¯å†™å›è¯·æ±‚çš„è¿”å›ç»“æœ</td></tr><tr><td style="text-align:left">waitForResponse</td><td style="text-align:left">å‘é€è¯·æ±‚åç­‰å¾…å“åº”ç»“æœ</td></tr><tr><td style="text-align:left">talkWithDriver</td><td style="text-align:left">é€šè¿‡ioctl BINDER_WRITE_READæ¥ä¸é©±åŠ¨é€šä¿¡</td></tr><tr><td style="text-align:left">writeTransactionData</td><td style="text-align:left">å†™å…¥ä¸€æ¬¡äº‹åŠ¡çš„æ•°æ®</td></tr><tr><td style="text-align:left">executeCommand</td><td style="text-align:left">å¤„ç†binder_driver_return_protocolåè®®å‘½ä»¤</td></tr><tr><td style="text-align:left">freeBuffer</td><td style="text-align:left">é€šè¿‡BC_FREE_BUFFERå‘½ä»¤é‡Šæ”¾Buffer</td></tr></tbody></table><p>BpBinder::transactæ–¹æ³•åœ¨å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯ç›´æ¥è°ƒç”¨äº†IPCThreadStateå¯¹åº”çš„æ–¹æ³•æ¥å‘é€è¯·æ±‚åˆ°Binderé©±åŠ¨çš„ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> BpBinder::transact(</span><br><span class="line">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mAlive) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> status = IPCThreadState::self()-&gt;transact(</span><br><span class="line">            mHandle, code, data, reply, flags);</span><br><span class="line">        <span class="keyword">if</span> (status == DEAD_OBJECT) mAlive = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ŒIPCThreadState::transactæ–¹æ³•ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::transact(<span class="keyword">int32_t</span> handle,</span><br><span class="line">                                  <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data,</span><br><span class="line">                                  Parcel* reply, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">status_t</span> err = data.errorCheck();</span><br><span class="line"></span><br><span class="line">    flags |= TF_ACCEPT_FDS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        err = writeTransactionData(BC_TRANSACTION, flags, handle, code, data, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (reply) reply-&gt;setError(err);</span><br><span class="line">        <span class="keyword">return</span> (mLastError = err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; TF_ONE_WAY) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">            err = waitForResponse(reply);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Parcel fakeReply;</span><br><span class="line">            err = waitForResponse(&amp;fakeReply);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = waitForResponse(<span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼šé¦–å…ˆé€šè¿‡writeTransactionDataå†™å…¥æ•°æ®ï¼Œç„¶åé€šè¿‡waitForResponseç­‰å¾…è¿”å›ç»“æœã€‚TF_ONE_WAYè¡¨ç¤ºæ­¤æ¬¡è¯·æ±‚æ˜¯å•å‘çš„ï¼Œå³ï¼šä¸ç”¨çœŸæ­£ç­‰å¾…ç»“æœå³å¯è¿”å›ã€‚</p><p>è€ŒwriteTransactionDataæ–¹æ³•å…¶å®å°±æ˜¯åœ¨ç»„è£…binder_transaction_dataæ•°æ®ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::writeTransactionData(<span class="keyword">int32_t</span> cmd, <span class="keyword">uint32_t</span> binderFlags,</span><br><span class="line">    <span class="keyword">int32_t</span> handle, <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, <span class="keyword">status_t</span>* statusBuffer)</span><br><span class="line">&#123;</span><br><span class="line">    binder_transaction_data tr;</span><br><span class="line"></span><br><span class="line">    tr.target.ptr = <span class="number">0</span>; <span class="comment">/* Don't pass uninitialized stack data to a remote process */</span></span><br><span class="line">    tr.target.handle = handle;</span><br><span class="line">    tr.code = code;</span><br><span class="line">    tr.flags = binderFlags;</span><br><span class="line">    tr.cookie = <span class="number">0</span>;</span><br><span class="line">    tr.sender_pid = <span class="number">0</span>;</span><br><span class="line">    tr.sender_euid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">status_t</span> err = data.errorCheck();</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        tr.data_size = data.ipcDataSize();</span><br><span class="line">        tr.data.ptr.buffer = data.ipcData();</span><br><span class="line">        tr.offsets_size = data.ipcObjectsCount()*<span class="keyword">sizeof</span>(<span class="keyword">binder_size_t</span>);</span><br><span class="line">        tr.data.ptr.offsets = data.ipcObjects();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusBuffer) &#123;</span><br><span class="line">        tr.flags |= TF_STATUS_CODE;</span><br><span class="line">        *statusBuffer = err;</span><br><span class="line">        tr.data_size = <span class="keyword">sizeof</span>(<span class="keyword">status_t</span>);</span><br><span class="line">        tr.data.ptr.buffer = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(statusBuffer);</span><br><span class="line">        tr.offsets_size = <span class="number">0</span>;</span><br><span class="line">        tr.data.ptr.offsets = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (mLastError = err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mOut.writeInt32(cmd);</span><br><span class="line">    mOut.write(&amp;tr, <span class="keyword">sizeof</span>(tr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºbinder_transaction_dataåœ¨è®²è§£Binderé©±åŠ¨çš„æ—¶å€™æˆ‘ä»¬å·²ç»è¯¦ç»†è®²è§£è¿‡äº†ã€‚è€Œè¿™é‡Œçš„Parcelæˆ‘ä»¬è¿˜ä¸äº†è§£ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬é©¬ä¸Šå°±æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»ã€‚</p><p>æ•°æ®åŒ…è£…å™¨ï¼šParcel Binderä¸Šæä¾›çš„æ˜¯è·¨è¿›ç¨‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡åŒ…å«äº†ä¸åŒçš„æ¥å£ï¼Œæ¯ä¸ªæ¥å£çš„å‚æ•°æ•°é‡å’Œç±»å‹éƒ½ä¸ä¸€æ ·ã€‚é‚£ä¹ˆå½“å®¢æˆ·ç«¯æƒ³è¦è°ƒç”¨æœåŠ¡ç«¯çš„æ¥å£ï¼Œå‚æ•°æ˜¯å¦‚ä½•è·¨è¿›ç¨‹ä¼ é€’ç»™æœåŠ¡ç«¯çš„å‘¢ï¼Ÿé™¤æ­¤ä¹‹å¤–ï¼ŒæœåŠ¡ç«¯æƒ³è¦ç»™å®¢æˆ·ç«¯è¿”å›ç»“æœï¼Œç»“æœåˆæ˜¯å¦‚ä½•ä¼ é€’å›æ¥çš„å‘¢ï¼Ÿ</p><p>è¿™äº›é—®é¢˜çš„ç­”æ¡ˆå°±æ˜¯ï¼šParcelã€‚Parcelå°±åƒä¸€ä¸ªåŒ…è£…å™¨ï¼Œè°ƒç”¨è€…å¯ä»¥ä»¥ä»»æ„é¡ºåºå¾€é‡Œé¢æ”¾å…¥éœ€è¦çš„æ•°æ®ï¼Œæ‰€æœ‰å†™å…¥çš„æ•°æ®å°±åƒæ˜¯è¢«æ‰“æˆä¸€ä¸ªæ•´ä½“çš„åŒ…ï¼Œç„¶åå¯ä»¥ç›´æ¥åœ¨Bindeä¸Šä¼ è¾“ã€‚</p><p>Parcelæä¾›äº†æ‰€æœ‰åŸºæœ¬ç±»å‹çš„å†™å…¥å’Œè¯»å‡ºæ¥å£ï¼Œä¸‹é¢æ˜¯å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">status_t</span>            writeInt32(<span class="keyword">int32_t</span> val);</span><br><span class="line"><span class="keyword">status_t</span>            writeUint32(<span class="keyword">uint32_t</span> val);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">status_t</span>            readUtf8FromUtf16(<span class="built_in">std</span>::<span class="built_in">string</span>* str) <span class="keyword">const</span>;</span><br><span class="line"><span class="keyword">status_t</span>            readUtf8FromUtf16(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;* str) <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>*         <span class="title">readCString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å› æ­¤å¯¹äºåŸºæœ¬ç±»å‹ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥è°ƒç”¨æ¥å£å†™å…¥å’Œè¯»å‡ºã€‚è€Œå¯¹äºéåŸºæœ¬ç±»å‹ï¼Œéœ€è¦ç”±å¼€å‘è€…å°†å…¶æ‹†åˆ†æˆåŸºæœ¬ç±»å‹ç„¶åå†™å…¥åˆ°Parcelä¸­ï¼ˆè¯»å‡ºçš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·ï¼‰ã€‚ Parcelä¼šå°†æ‰€æœ‰å†™å…¥çš„æ•°æ®è¿›è¡Œæ‰“åŒ…ï¼ŒParcelæœ¬èº«å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“åœ¨è¿›ç¨‹é—´ä¼ é€’ã€‚æ¥æ”¶æ–¹åœ¨æ”¶åˆ°Parcelä¹‹åï¼Œåªè¦æŒ‰å†™å…¥åŒæ ·çš„é¡ºåºè¯»å‡ºå³å¯ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹ï¼Œå’Œæˆ‘ä»¬ç°å®ç”Ÿæ´»ä¸­å¯„é€åŒ…è£¹åšæ³•æ˜¯ä¸€æ ·çš„ï¼šæˆ‘ä»¬å°†éœ€è¦å¯„é€çš„åŒ…è£¹æ”¾åˆ°ç¡¬çº¸ç›’ä¸­äº¤ç»™å¿«é€’å…¬å¸ã€‚å¿«é€’å…¬å¸å°†æ‰€æœ‰çš„åŒ…è£¹è¿›è¡Œæ‰“åŒ…ï¼Œç„¶åé›†ä¸­æ”¾åˆ°è¿è¾“è½¦ä¸­é€åˆ°ç›®çš„åœ°ï¼Œåˆ°äº†ç›®çš„åœ°ä¹‹åç„¶åå†è¿›è¡Œæ‹†åˆ†ã€‚</p><p>Parcelæ—¢åŒ…å«C++éƒ¨åˆ†çš„å®ç°ï¼Œä¹ŸåŒæ—¶æä¾›äº†Javaçš„æ¥å£ï¼Œä¸­é—´é€šè¿‡JNIè¡”æ¥ã€‚Javaå±‚çš„æ¥å£å…¶å®ä»…ä»…æ˜¯ä¸€å±‚åŒ…è£…ï¼ŒçœŸæ­£çš„å®ç°éƒ½æ˜¯ä½äºC++éƒ¨åˆ†ä¸­ã€‚ ç‰¹åˆ«éœ€è¦è¯´æ˜ä¸€ä¸‹çš„æ˜¯ï¼ŒParcelç±»é™¤äº†å¯ä»¥ä¼ é€’åŸºæœ¬æ•°æ®ç±»å‹ï¼Œè¿˜å¯ä»¥ä¼ é€’Binderå¯¹è±¡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Parcel::writeStrongBinder(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; val)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> flatten_binder(ProcessState::self(), val, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•å†™å…¥çš„æ˜¯sp</p><ibinder>ç±»å‹çš„å¯¹è±¡ï¼Œè€ŒIBinderæ—¢å¯èƒ½æ˜¯æœ¬åœ°Binderï¼Œä¹Ÿå¯èƒ½æ˜¯è¿œç¨‹Binderï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¯ä»¥ä¸ç”¨å…³å¿ƒå…·ä½“ç»†èŠ‚ç›´æ¥è¿›è¡ŒBinderå¯¹è±¡çš„ä¼ é€’ã€‚</ibinder><p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆIInterfaceä¸­å®šä¹‰äº†ä¸¤ä¸ªasBinderçš„staticæ–¹æ³•ï¼Œå¦‚æœä½ ä¸è®°å¾—äº†ï¼Œè¯·å›å¿†ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> sp&lt;IBinder&gt;  asBinder(<span class="keyword">const</span> IInterface*);</span><br><span class="line"><span class="keyword">static</span> sp&lt;IBinder&gt;  asBinder(<span class="keyword">const</span> sp&lt;IInterface&gt;&amp;);</span><br></pre></td></tr></table></figure><p>è€Œå¯¹äºBinderé©±åŠ¨ï¼Œæˆ‘ä»¬å‰é¢å·²ç»è®²è§£è¿‡ï¼šBinderé©±åŠ¨å¹¶ä¸æ˜¯çœŸçš„å°†å¯¹è±¡åœ¨è¿›ç¨‹é—´åºåˆ—åŒ–ä¼ é€’ï¼Œè€Œæ˜¯ç”±Binderé©±åŠ¨å®Œæˆäº†å¯¹äºBinderå¯¹è±¡æŒ‡é’ˆçš„è§£é‡Šå’Œç¿»è¯‘ï¼Œä½¿è°ƒç”¨è€…çœ‹èµ·æ¥å°±åƒåœ¨è¿›ç¨‹é—´ä¼ é€’å¯¹è±¡ä¸€æ ·ã€‚</p><h4 id="2-4ã€Frameworkå±‚çš„çº¿ç¨‹ç®¡ç†"><a href="#2-4ã€Frameworkå±‚çš„çº¿ç¨‹ç®¡ç†" class="headerlink" title="2.4ã€Frameworkå±‚çš„çº¿ç¨‹ç®¡ç†"></a>2.4ã€<strong>Frameworkå±‚çš„çº¿ç¨‹ç®¡ç†</strong></h4><p>åœ¨è®²è§£Binderé©±åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è®²è§£è¿‡é©±åŠ¨ä¸­å¯¹åº”çº¿ç¨‹çš„ç®¡ç†ã€‚è¿™é‡Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ï¼ŒFrameworkå±‚æ˜¯å¦‚ä½•ä¸é©±åŠ¨å±‚å¯¹æ¥è¿›è¡Œçº¿ç¨‹ç®¡ç†çš„ã€‚</p><p>ProcessState::setThreadPoolMaxThreadCount æ–¹æ³•ä¸­ï¼Œä¼šé€šè¿‡BINDER_SET_MAX_THREADSå‘½ä»¤è®¾ç½®è¿›ç¨‹æ”¯æŒçš„æœ€å¤§çº¿ç¨‹æ•°é‡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_MAX_BINDER_THREADS 15</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> ProcessState::setThreadPoolMaxThreadCount(<span class="keyword">size_t</span> maxThreads) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(mDriverFD, BINDER_SET_MAX_THREADS, &amp;maxThreads) != <span class="number">-1</span>) &#123;</span><br><span class="line">        mMaxThreads = maxThreads;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = -errno;</span><br><span class="line">        ALOGE(<span class="string">"Binder ioctl to set max threads failed: %s"</span>, strerror(-result));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤é©±åŠ¨ä¾¿çŸ¥é“äº†è¯¥BinderæœåŠ¡æ”¯æŒçš„æœ€å¤§çº¿ç¨‹æ•°ã€‚é©±åŠ¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæ ¹æ®éœ€è¦ï¼Œå¹¶åœ¨æ²¡æœ‰è¶…è¿‡ä¸Šé™çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡BR_SPAWN_LOOPERå‘½ä»¤é€šçŸ¥è¿›ç¨‹åˆ›å»ºçº¿ç¨‹ï¼š</p><p>IPCThreadStateåœ¨æ”¶åˆ°BR_SPAWN_LOOPERè¯·æ±‚ä¹‹åï¼Œä¾¿ä¼šè°ƒç”¨ProcessState::spawnPooledThreadæ¥åˆ›å»ºçº¿ç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::executeCommand(<span class="keyword">int32_t</span> cmd)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">case</span> BR_SPAWN_LOOPER:</span><br><span class="line">        mProcess-&gt;spawnPooledThread(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProcessState::spawnPooledThreadæ–¹æ³•è´Ÿè´£ä¸ºçº¿ç¨‹è®¾å®šåç§°å¹¶åˆ›å»ºçº¿ç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ProcessState::spawnPooledThread(<span class="keyword">bool</span> isMain)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mThreadPoolStarted) &#123;</span><br><span class="line">        String8 name = makeBinderThreadName();</span><br><span class="line">        ALOGV(<span class="string">"Spawning new pooled thread, name=%s\n"</span>, name.<span class="built_in">string</span>());</span><br><span class="line">        sp&lt;Thread&gt; t = <span class="keyword">new</span> PoolThread(isMain);</span><br><span class="line">        t-&gt;run(name.<span class="built_in">string</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹åœ¨runä¹‹åï¼Œä¼šè°ƒç”¨threadLoopå°†è‡ªèº«æ·»åŠ çš„çº¿ç¨‹æ± ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">threadLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   IPCThreadState::self()-&gt;joinThreadPool(mIsMain);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ŒIPCThreadState::joinThreadPoolæ–¹æ³•ä¸­ï¼Œä¼šæ ¹æ®å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹å‘é€BC_ENTER_LOOPERæˆ–è€…BC_REGISTER_LOOPERå‘½ä»¤å‘ŠçŸ¥é©±åŠ¨çº¿ç¨‹å·²ç»åˆ›å»ºå®Œæ¯•ã€‚æ•´ä¸ªè°ƒç”¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/48-Android-binder_thread_create.jpg" alt="Markdown"></p><h3 id="ï¼ˆ3ï¼‰ã€Android-Binderç³»ç»Ÿ-Nativeå±‚æ·»åŠ helloæœåŠ¡"><a href="#ï¼ˆ3ï¼‰ã€Android-Binderç³»ç»Ÿ-Nativeå±‚æ·»åŠ helloæœåŠ¡" class="headerlink" title="ï¼ˆ3ï¼‰ã€Android Binderç³»ç»Ÿ-Nativeå±‚æ·»åŠ helloæœåŠ¡"></a>ï¼ˆ3ï¼‰ã€Android Binderç³»ç»Ÿ-Nativeå±‚æ·»åŠ helloæœåŠ¡</h3><h4 id="3-1ã€Clientæ„é€ æ•°æ®ï¼Œå‘é€æ•°æ®ç»™é©±åŠ¨"><a href="#3-1ã€Clientæ„é€ æ•°æ®ï¼Œå‘é€æ•°æ®ç»™é©±åŠ¨" class="headerlink" title="3.1ã€Clientæ„é€ æ•°æ®ï¼Œå‘é€æ•°æ®ç»™é©±åŠ¨"></a>3.1ã€<strong>Clientæ„é€ æ•°æ®ï¼Œå‘é€æ•°æ®ç»™é©±åŠ¨</strong></h4><p>é¦–å…ˆçœ‹ä¸€ä¸‹Native ServiceManageræ¶æ„å›¾</p><p>åªè®²æ•°æ®æ„é€ è¿‡ç¨‹ã€‚ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/49-Android-addService.jpg" alt="Markdown"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/50-Android-binder-BpBinder.png" alt="Markdown"></p><p>æ„é€ ï¼š [-&gt; IServiceManager.cpp ::BpServiceManager]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">addService</span><span class="params">(<span class="keyword">const</span> String16&amp; name, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; service, <span class="keyword">bool</span> allowIsolated)</span> </span>&#123;</span><br><span class="line">    Parcel data, reply; <span class="comment">//Parcelæ˜¯æ•°æ®é€šä¿¡åŒ…</span></span><br><span class="line">    <span class="comment">//å†™å…¥å¤´ä¿¡æ¯"android.os.IServiceManager"</span></span><br><span class="line">    data.writeInterfaceToken(IServiceManager::getInterfaceDescriptor());   </span><br><span class="line">    data.writeString16(name);        <span class="comment">// nameä¸º "hello"</span></span><br><span class="line">    data.writeStrongBinder(service); <span class="comment">// HelloServiceå¯¹è±¡ï¼ŒæŠŠä¸€ä¸ªbinderå®ä½“â€œæ‰“æ‰â€å¹¶å†™å…¥parcel</span></span><br><span class="line">    data.writeInt32(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>); <span class="comment">// allowIsolated= false</span></span><br><span class="line">    <span class="comment">//remote()æŒ‡å‘çš„æ˜¯BpBinderå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">status_t</span> err = remote()-&gt;transact(ADD_SERVICE_TRANSACTION, data, &amp;reply);</span><br><span class="line">    <span class="keyword">return</span> err == NO_ERROR ? reply.readExceptionCode() : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡æ³¨å†Œè¿‡ç¨‹ï¼šå‘ServiceManageræ³¨å†ŒæœåŠ¡hello Serviceï¼ŒæœåŠ¡åä¸ºâ€helloâ€ï¼› è¯·å¤§å®¶æ³¨æ„ä¸Šé¢data.writeStrongBinder()ä¸€å¥ï¼Œå®ƒä¸“é—¨è´Ÿè´£æŠŠä¸€ä¸ªbinderå®ä½“â€æ‰“æ‰â€å¹¶å†™å…¥parcelã€‚å…¶ä»£ç å¦‚ä¸‹ï¼š</p><h4 id="3-2-1ã€-writeStrongBinder"><a href="#3-2-1ã€-writeStrongBinder" class="headerlink" title="3.2.1ã€* writeStrongBinder()"></a>3.2.1ã€<em>* writeStrongBinder()</em></h4><p>[-&gt; parcel.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Parcel::writeStrongBinder(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; val)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> flatten_binder(ProcessState::self(), val, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-2ã€flatten-binder"><a href="#3-2-2ã€flatten-binder" class="headerlink" title="3.2.2ã€flatten_binder()"></a>3.2.2ã€<strong>flatten_binder()</strong></h4><p>[-&gt; parcel.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> flatten_binder(<span class="keyword">const</span> sp&lt;ProcessState&gt;&amp; <span class="comment">/*proc*/</span>,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; binder, Parcel* out)</span><br><span class="line">&#123;</span><br><span class="line">    flat_binder_object obj;</span><br><span class="line"></span><br><span class="line">    obj.flags = <span class="number">0x7f</span> | FLAT_BINDER_FLAG_ACCEPTS_FDS;</span><br><span class="line">    <span class="keyword">if</span> (binder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        IBinder *local = binder-&gt;localBinder(); <span class="comment">//æœ¬åœ°Binderä¸ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (!local) &#123;</span><br><span class="line">            BpBinder *proxy = binder-&gt;remoteBinder();</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int32_t</span> handle = proxy ? proxy-&gt;handle() : <span class="number">0</span>;</span><br><span class="line">            obj.type = BINDER_TYPE_HANDLE;</span><br><span class="line">            obj.binder = <span class="number">0</span>;</span><br><span class="line">            obj.handle = handle;</span><br><span class="line">            obj.cookie = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//è¿›å…¥è¯¥åˆ†æ”¯</span></span><br><span class="line">            obj.type = BINDER_TYPE_BINDER;</span><br><span class="line">            obj.binder = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(local-&gt;getWeakRefs());</span><br><span class="line">            obj.cookie = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(local);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> finish_flatten_binder(binder, obj, out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/51-Android-Binder-flatten_binder.png" alt="Markdown"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/52-Android-Binder-flatten_binder.png" alt="Markdown"></p><p>å°†Binderå¯¹è±¡æ‰å¹³åŒ–ï¼Œè½¬æ¢æˆflat_binder_objectå¯¹è±¡ã€‚ çœ‹åˆ°äº†å—ï¼Ÿâ€æ‰“æ‰â€çš„æ„æ€å°±æ˜¯æŠŠbinderå¯¹è±¡æ•´ç†æˆflat_binder_objectå˜é‡ï¼Œå¦‚æœæ‰“æ‰çš„æ˜¯binderå®ä½“ï¼Œé‚£ä¹ˆflat_binder_objectç”¨cookieåŸŸè®°å½•binderå®ä½“çš„æŒ‡é’ˆï¼Œå³BBinderæŒ‡é’ˆï¼Œè€Œå¦‚æœæ‰“æ‰çš„æ˜¯binderä»£ç†ï¼Œé‚£ä¹ˆflat_binder_objectç”¨handleåŸŸè®°å½•çš„binderä»£ç†çš„å¥æŸ„å€¼ã€‚</p><blockquote><p>æ€»ç»“ï¼šParcelçš„æ•°æ®åŒºåŸŸåˆ†ä¸¤ä¸ªéƒ¨åˆ†ï¼šmDataå’ŒmObjectsï¼Œæ‰€æœ‰çš„æ•°æ®ä¸ç®¡æ˜¯åŸºç¡€æ•°æ®ç±»å‹è¿˜æ˜¯å¯¹è±¡å®ä½“ï¼Œå…¨éƒ½è¿½åŠ åˆ°mDataé‡Œï¼ŒmObjectsæ˜¯ä¸€ä¸ªåç§»é‡æ•°ç»„ï¼Œè®°å½•æ‰€æœ‰å­˜æ”¾åœ¨mDataä¸­çš„flat_binder_objectå®ä½“çš„åç§»é‡ã€‚</p></blockquote><h4 id="3-2-3ã€finish-flatten-binder"><a href="#3-2-3ã€finish-flatten-binder" class="headerlink" title="3.2.3ã€finish_flatten_binder()"></a>3.2.3ã€<strong>finish_flatten_binder()</strong></h4><p>å°†flat_binder_objectå†™å…¥outã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> status_t <span class="title">finish_flatten_binder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; , <span class="keyword">const</span> flat_binder_object&amp; flat, Parcel* out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> out-&gt;writeObject(flat, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åflatten_binder()è°ƒç”¨äº†ä¸€ä¸ªå…³é”®çš„finish_flatten_binder()å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè®°å½•ä¸‹åˆšåˆšè¢«æ‰å¹³åŒ–çš„flat_binder_objectåœ¨parcelä¸­çš„ä½ç½®ã€‚è¯´å¾—æ›´è¯¦ç»†ç‚¹å„¿å°±æ˜¯ï¼Œparcelå¯¹è±¡å†…éƒ¨ä¼šæœ‰ä¸€ä¸ªbufferï¼Œè®°å½•ç€parcelä¸­æ‰€æœ‰æ‰å¹³åŒ–çš„æ•°æ®ï¼Œæœ‰äº›æ‰å¹³æ•°æ®æ˜¯æ™®é€šæ•°æ®ï¼Œè€Œå¦ä¸€äº›æ‰å¹³æ•°æ®åˆ™è®°å½•ç€binderå¯¹è±¡ã€‚æ‰€ä»¥parcelä¸­ä¼šæ„é€ å¦ä¸€ä¸ªmObjectsæ•°ç»„ï¼Œä¸“é—¨è®°å½•é‚£äº›binderæ‰å¹³æ•°æ®æ‰€åœ¨çš„ä½ç½®ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/53-Android-Binder-parcel.png" alt="Markdown"></p><p>ä¸€æ—¦åˆ°äº†å‘é©±åŠ¨å±‚ä¼ é€’æ•°æ®çš„æ—¶å€™ï¼ŒIPCThreadState::writeTransactionData()ä¼šå…ˆæŠŠParcelæ•°æ®æ•´ç†æˆä¸€ä¸ªbinder_transaction_dataæ•°æ®</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::writeTransactionData(<span class="keyword">int32_t</span> cmd, <span class="keyword">uint32_t</span> binderFlags,</span><br><span class="line">    <span class="keyword">int32_t</span> handle, <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, <span class="keyword">status_t</span>* statusBuffer)</span><br><span class="line">&#123;</span><br><span class="line">    binder_transaction_data tr;</span><br><span class="line"></span><br><span class="line">    tr.target.ptr = <span class="number">0</span>; <span class="comment">/* Don't pass uninitialized stack data to a remote process */</span></span><br><span class="line">    tr.target.handle = handle;</span><br><span class="line">    tr.code = code;</span><br><span class="line">    tr.flags = binderFlags;</span><br><span class="line">    tr.cookie = <span class="number">0</span>;</span><br><span class="line">    tr.sender_pid = <span class="number">0</span>;</span><br><span class="line">    tr.sender_euid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">status_t</span> err = data.errorCheck();</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        tr.data_size = data.ipcDataSize();</span><br><span class="line">        tr.data.ptr.buffer = data.ipcData();</span><br><span class="line">        tr.offsets_size = data.ipcObjectsCount()*<span class="keyword">sizeof</span>(<span class="keyword">binder_size_t</span>);</span><br><span class="line">        tr.data.ptr.offsets = data.ipcObjects();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusBuffer) &#123;</span><br><span class="line">        tr.flags |= TF_STATUS_CODE;</span><br><span class="line">        *statusBuffer = err;</span><br><span class="line">        tr.data_size = <span class="keyword">sizeof</span>(<span class="keyword">status_t</span>);</span><br><span class="line">        tr.data.ptr.buffer = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(statusBuffer);</span><br><span class="line">        tr.offsets_size = <span class="number">0</span>;</span><br><span class="line">        tr.data.ptr.offsets = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (mLastError = err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mOut.writeInt32(cmd);</span><br><span class="line">    mOut.write(&amp;tr, <span class="keyword">sizeof</span>(tr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/54-Android-binder-writeTransactionData.png" alt="Markdown"></p><h4 id="3-2-4-ã€waitForResponse"><a href="#3-2-4-ã€waitForResponse" class="headerlink" title="3.2.4 ã€waitForResponse()"></a>3.2.4 ã€<strong>waitForResponse()</strong></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::waitForResponse(Parcel *reply, <span class="keyword">status_t</span> *acquireResult)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> cmd;</span><br><span class="line">    <span class="keyword">int32_t</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err=talkWithDriver()) &lt; NO_ERROR) <span class="keyword">break</span>;<span class="comment">//ç›®çš„å°±æ˜¯æŠŠä¸Šé¢æ‰“åŒ…çš„mOutæ•°æ®ç»™kernel,æ¥ç€çœ‹taklWithDriver();</span></span><br><span class="line">        cmd = mIn.readInt32();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> BR_REPLY:</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">goto</span> finish;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            err = executeCommand(cmd);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">finish:</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æ˜¯ä¸serviceManageré€šä¿¡çš„ä¸»è¦å‡½æ•°ï¼Œé¦–å…ˆä¼šè°ƒç”¨talkWithDriver()æ–¹æ³•ï¼Œå°†ä¹‹å‰çš„æ‰“åŒ…åœ¨mOutä¸­çš„æ•°æ®æ‰“åŒ…æˆstruct binder_write_read å¯¹è±¡ï¼Œå¹¶é€šè¿‡ioctrlå‘é€ç»™kernelã€‚</p><h4 id="3-2-5ã€-IPCThreadState-talkWithDriver"><a href="#3-2-5ã€-IPCThreadState-talkWithDriver" class="headerlink" title="3.2.5ã€ IPCThreadState::talkWithDriver"></a>3.2.5ã€ <strong>IPCThreadState::talkWithDriver</strong></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::talkWithDriver(<span class="keyword">bool</span> doReceive)</span><br><span class="line">&#123;</span><br><span class="line">    binder_write_read bwr;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> needRead = mIn.dataPosition() &gt;= mIn.dataSize();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> outAvail = (!doReceive || needRead) ? mOut.dataSize() : <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//doReceiveå‚æ•°ï¼Œé»˜è®¤æ˜¯ä¸ºtrue,ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°æ²¡æœ‰ä¼ å‚æ•°ï¼Œé‚£ä¹ˆdoReceive = 1ï¼›</span></span><br><span class="line">    bwr.write_size = outAvail;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">uintptr_t</span>)mOut.data(); <span class="comment">//å°†mOutæ•°æ®æŒ‡é’ˆå­˜æ”¾åˆ°è¿™é‡Œ,è¿™å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰“åŒ…çš„æ•°æ®ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is what we'll read.</span></span><br><span class="line">    <span class="keyword">if</span> (doReceive &amp;&amp; needRead) &#123;</span><br><span class="line">        bwr.read_size = mIn.dataCapacity(); <span class="comment">//æ³¨æ„è¿™é‡Œæ•°æ®çš„å¤§å°ï¼Œåœ¨æˆ‘ä»¬new IPCThreadStateå¯¹è±¡æ—¶ï¼Œå·²ç»åˆå§‹åŒ–ä¸º256.</span></span><br><span class="line">        bwr.read_buffer = (<span class="keyword">uintptr_t</span>)mIn.data(); <span class="comment">//mInæ•°æ®æŒ‡é’ˆï¼Œæ”¾åˆ°è¿™é‡Œ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bwr.read_size = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>) <span class="comment">//è¿™é‡Œé€šè¿‡ioctlå°†æ•°æ®å†™ç»™kernel</span></span><br><span class="line">      .....</span><br><span class="line">    &#125; <span class="keyword">while</span> (err == -EINTR);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†ä¹‹å‰æ‰“åŒ…çš„æ•°æ®é€šè¿‡ç³»ç»Ÿè°ƒç”¨ioctlå‘é€ç»™kernelï¼Œæœ€ç»ˆå‘é€ç»™kernelçš„æ•°æ®æ˜¯struct binder_write_readå¯¹è±¡ã€‚è¯¥å¯¹è±¡å·²ç»è¢«æ‰“åŒ…äº†3æ¬¡ï¼Œå®ƒä»¬çš„åŒ…å«å…³ç³»å¦‚ä¸‹æ‰€ç¤ºã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/55-Android-binder-Transaction_data.png" alt="Markdown"></p><h4 id="3-2-6ã€Clientè·å–æœåŠ¡ã€å¤„ç†å›å¤æ•°æ®è¿‡ç¨‹"><a href="#3-2-6ã€Clientè·å–æœåŠ¡ã€å¤„ç†å›å¤æ•°æ®è¿‡ç¨‹" class="headerlink" title="3.2.6ã€Clientè·å–æœåŠ¡ã€å¤„ç†å›å¤æ•°æ®è¿‡ç¨‹"></a>3.2.6ã€<strong>Clientè·å–æœåŠ¡ã€å¤„ç†å›å¤æ•°æ®è¿‡ç¨‹</strong></h4><p>å†…æ ¸ä¼šå”¤é†’Clientè¿›ç¨‹å¤„ç†å›å¤æ¶ˆæ¯ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::waitForResponse(Parcel *reply, <span class="keyword">status_t</span> *acquireResult)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> cmd;</span><br><span class="line">    <span class="keyword">int32_t</span> err;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err=talkWithDriver()) &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">        cmd = mIn.readInt32();</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">          <span class="keyword">case</span> BR_REPLY:</span><br><span class="line">          &#123;</span><br><span class="line">            binder_transaction_data tr;</span><br><span class="line">            err = mIn.read(&amp;tr, <span class="keyword">sizeof</span>(tr));</span><br><span class="line">            <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tr.flags &amp; TF_STATUS_CODE) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//å½“replyå¯¹è±¡å›æ”¶æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨freeBufferæ¥å›æ”¶å†…å­˜</span></span><br><span class="line">                    reply-&gt;ipcSetDataReference(</span><br><span class="line">                        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(tr.data.ptr.buffer),</span><br><span class="line">                        tr.data_size,</span><br><span class="line">                        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">binder_size_t</span>*&gt;(tr.data.ptr.offsets),</span><br><span class="line">                        tr.offsets_size/<span class="keyword">sizeof</span>(<span class="keyword">binder_size_t</span>),</span><br><span class="line">                        freeBuffer, <span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">          ...     </span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-7ã€Parcel-ipcSetDataReference"><a href="#3-2-7ã€Parcel-ipcSetDataReference" class="headerlink" title="3.2.7ã€Parcel::ipcSetDataReference"></a>3.2.7ã€<strong>Parcel::ipcSetDataReference</strong></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Parcel::ipcSetDataReference(<span class="keyword">const</span> <span class="keyword">uint8_t</span>* data, <span class="keyword">size_t</span> dataSize,</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">binder_size_t</span>* objects, <span class="keyword">size_t</span> objectsCount, release_func relFunc, <span class="keyword">void</span>* relCookie)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">binder_size_t</span> minOffset = <span class="number">0</span>;</span><br><span class="line">    freeDataNoInit();</span><br><span class="line">    mError = NO_ERROR;</span><br><span class="line">    mData = <span class="keyword">const_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(data); <span class="comment">//è¿™æ˜¯æœ‰4ä¸ªå­—èŠ‚çš„bufferã€‚ä¸”å­˜æ”¾çš„æ•°æ®æ˜¯0</span></span><br><span class="line">    mDataSize = mDataCapacity = dataSize; <span class="comment">//ä¹‹å‰ç”³è¯·çš„å¤§å°å°±æ˜¯4ä¸ªå­—èŠ‚ã€‚</span></span><br><span class="line">    <span class="comment">//ALOGI("setDataReference Setting data size of %p to %lu (pid=%d)", this, mDataSize, getpid());</span></span><br><span class="line">    mDataPos = <span class="number">0</span>;</span><br><span class="line">    ALOGV(<span class="string">"setDataReference Setting data pos of %p to %zu"</span>, <span class="keyword">this</span>, mDataPos);</span><br><span class="line">    mObjects = <span class="keyword">const_cast</span>&lt;<span class="keyword">binder_size_t</span>*&gt;(objects); <span class="comment">//binderå¯¹è±¡å…¶å®åœ°å€</span></span><br><span class="line">    mObjectsSize = mObjectsCapacity = objectsCount; <span class="comment">//binderå¯¹è±¡çš„ä¸ªæ•°ã€‚</span></span><br><span class="line">    mNextObjectHint = <span class="number">0</span>;</span><br><span class="line">    mOwner = relFunc; <span class="comment">//é‡Šæ”¾å†…å­˜çš„å‡½æ•°ï¼Œåé¢æˆ‘ä»¬å°±ä¸è¿›è¡Œäº†ã€‚</span></span><br><span class="line">    mOwnerCookie = relCookie;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mObjectsSize; i++) &#123;</span><br><span class="line">        <span class="keyword">binder_size_t</span> offset = mObjects[i];</span><br><span class="line">        <span class="keyword">if</span> (offset &lt; minOffset) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: bad object offset %"</span>PRIu64<span class="string">" &lt; %"</span>PRIu64<span class="string">"\n"</span>,</span><br><span class="line">                  __func__, (<span class="keyword">uint64_t</span>)offset, (<span class="keyword">uint64_t</span>)minOffset);</span><br><span class="line">            mObjectsSize = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        minOffset = offset + <span class="keyword">sizeof</span>(flat_binder_object);</span><br><span class="line">    &#125;</span><br><span class="line">    scanForFds();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åšçš„å·¥ä½œåªæ˜¯å°†äº‹åŠ¡æ•°æ®åˆ†åˆ«å®‰æ”¾åˆ°å½“å‰Parcelå¯¹è±¡çš„ç›¸åº”ä½ç½®ã€‚å…¶ä¸­scanForFdsï¼ˆï¼‰æ˜¯ä¸ºäº†æŸ¥æ‰¾è¿”å›æ¥çš„æ•°æ®ä¸­æ˜¯å¦æœ‰binderå¯¹è±¡ï¼Œè¿™ä¸ªåœ¨è·å–ä»£ç†å¯¹è±¡æ—¶æœ‰ç”¨ã€‚</p><h4 id="3-2-8ã€readStrongBinder"><a href="#3-2-8ã€readStrongBinder" class="headerlink" title="3.2.8ã€readStrongBinder()"></a>3.2.8ã€<strong>readStrongBinder()</strong></h4><p>[-&gt; Parcel.java]</p><p>readStrongBinderçš„è¿‡ç¨‹åŸºæœ¬æ˜¯writeStrongBinderé€†è¿‡ç¨‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static jobject android_os_Parcel_readStrongBinder(JNIEnv* env, jclass clazz, jlong nativePtr) &#123;</span><br><span class="line">    Parcel* parcel = reinterpret_cast&lt;Parcel*&gt;(nativePtr);</span><br><span class="line">    if (parcel != NULL) &#123;</span><br><span class="line">        return javaObjectForIBinder(env, parcel-&gt;readStrongBinder());</span><br><span class="line">    &#125;</span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>javaObjectForIBinder å°†nativeå±‚BpBinderå¯¹è±¡è½¬æ¢ä¸ºJavaå±‚BinderProxyå¯¹è±¡ã€‚</p><h4 id="3-2-9ã€readStrongBinder-C"><a href="#3-2-9ã€readStrongBinder-C" class="headerlink" title="3.2.9ã€readStrongBinder(C++)"></a>3.2.9ã€<strong>readStrongBinder(C++)</strong></h4><p>[-&gt; Parcel.cpp]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; Parcel::readStrongBinder() const</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;IBinder&gt; val;</span><br><span class="line">    unflatten_binder(ProcessState::self(), *this, &amp;val);</span><br><span class="line">    return val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-10ã€unflatten-binder"><a href="#3-2-10ã€unflatten-binder" class="headerlink" title="3.2.10ã€unflatten_binder()"></a>3.2.10ã€<strong>unflatten_binder()</strong></h4><p>[-&gt; Parcel.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> unflatten_binder(<span class="keyword">const</span> sp&lt;ProcessState&gt;&amp; proc, <span class="keyword">const</span> Parcel&amp; in, sp&lt;IBinder&gt;* out) &#123;</span><br><span class="line">    <span class="keyword">const</span> flat_binder_object* flat = in.readObject(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (flat) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (flat-&gt;type) &#123;</span><br><span class="line">            <span class="keyword">case</span> BINDER_TYPE_BINDER:</span><br><span class="line">                *out = <span class="keyword">reinterpret_cast</span>&lt;IBinder*&gt;(flat-&gt;cookie);</span><br><span class="line">                <span class="keyword">return</span> finish_unflatten_binder(<span class="literal">NULL</span>, *flat, in);</span><br><span class="line">            <span class="keyword">case</span> BINDER_TYPE_HANDLE:</span><br><span class="line">                *out = proc-&gt;getStrongProxyForHandle(flat-&gt;handle);</span><br><span class="line">                <span class="comment">//åˆ›å»ºBpBinderå¯¹è±¡</span></span><br><span class="line">                <span class="keyword">return</span> finish_unflatten_binder(</span><br><span class="line">                    <span class="keyword">static_cast</span>&lt;BpBinder*&gt;(out-&gt;get()), *flat, in);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BAD_TYPE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šreadObject()çš„ä½œç”¨æ˜¯ä»Parcelä¸­è¯»å–å‡ºå®ƒæ‰€ä¿å­˜çš„flat_binder_objectç±»å‹çš„å¯¹è±¡ã€‚è¯¥å¯¹è±¡çš„ç±»å‹æ˜¯BINDER_TYPE_HANDLEï¼Œå› æ­¤ä¼šæŒ‡å‘BINDER_TYPE_HANDLEå¯¹åº”çš„switchåˆ†æ”¯ã€‚ (01) è¿™é‡Œçš„procæ˜¯ProcessStateå¯¹è±¡ï¼Œæ‰§è¡Œproc-&gt;getStrongProxyForHandle()ä¼šå°†å¥æŸ„(MediaPlayerServiceçš„Binderå¼•ç”¨æè¿°)ä¿å­˜åˆ°ProcessStateçš„é“¾è¡¨ä¸­ï¼Œç„¶åå†åˆ›å»ºå¹¶è¿”å›è¯¥å¥æŸ„çš„BpBinderå¯¹è±¡(å³Binderçš„ä»£ç†)ã€‚åœ¨Android Binderæœºåˆ¶(å››) defaultServiceManager()çš„å®ç°ä¸­æœ‰getStrongProxyForHandle()çš„è¯¦ç»†è¯´æ˜ï¼Œä¸‹é¢åªç»™å‡ºgetStrongProxyForHandle()ä»£ç ã€‚ (02) finish_unflatten_binder()ä¸­åªæœ‰return NO_ERRORã€‚</p><h4 id="3-2-11ã€getStrongProxyForHandle"><a href="#3-2-11ã€getStrongProxyForHandle" class="headerlink" title="3.2.11ã€getStrongProxyForHandle()"></a>3.2.11ã€<strong>getStrongProxyForHandle()</strong></h4><p>[-&gt; ProcessState.cpp]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(int32_t handle)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;IBinder&gt; result;</span><br><span class="line"></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line">    //æŸ¥æ‰¾handleå¯¹åº”çš„èµ„æºé¡¹</span><br><span class="line">    handle_entry* e = lookupHandleLocked(handle);</span><br><span class="line"></span><br><span class="line">    if (e != NULL) &#123;</span><br><span class="line">        IBinder* b = e-&gt;binder;</span><br><span class="line">        if (b == NULL || !e-&gt;refs-&gt;attemptIncWeak(this)) &#123;</span><br><span class="line">            ...</span><br><span class="line">            //å½“handleå€¼æ‰€å¯¹åº”çš„IBinderä¸å­˜åœ¨æˆ–å¼±å¼•ç”¨æ— æ•ˆæ—¶ï¼Œåˆ™åˆ›å»ºBpBinderå¯¹è±¡</span><br><span class="line">            b = new BpBinder(handle);</span><br><span class="line">            e-&gt;binder = b;</span><br><span class="line">            if (b) e-&gt;refs = b-&gt;getWeakRefs();</span><br><span class="line">            result = b;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            result.force_set(b);</span><br><span class="line">            e-&gt;refs-&gt;decWeak(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡è¯¥æ–¹æ³•ï¼Œæœ€ç»ˆåˆ›å»ºäº†æŒ‡å‘BinderæœåŠ¡ç«¯çš„BpBinderä»£ç†å¯¹è±¡ã€‚</p><h3 id="ï¼ˆ4ï¼‰ã€Android-Binderç³»ç»Ÿ-Nativeå±‚è·å–helloæœåŠ¡"><a href="#ï¼ˆ4ï¼‰ã€Android-Binderç³»ç»Ÿ-Nativeå±‚è·å–helloæœåŠ¡" class="headerlink" title="ï¼ˆ4ï¼‰ã€Android Binderç³»ç»Ÿ-Nativeå±‚è·å–helloæœåŠ¡"></a>ï¼ˆ4ï¼‰ã€Android Binderç³»ç»Ÿ-Nativeå±‚è·å–helloæœåŠ¡</h3><p>ç»è¿‡å‰é¢çš„åˆ†æï¼ŒçŸ¥é“æµç¨‹åŸºæœ¬ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†ç»§ç»­åˆ†æè·å–helloæœåŠ¡</p><h2 id="äº”ã€Android-Binderç³»ç»Ÿ-Framwork-Javaå±‚"><a href="#äº”ã€Android-Binderç³»ç»Ÿ-Framwork-Javaå±‚" class="headerlink" title="äº”ã€Android Binderç³»ç»Ÿ-Framwork-Javaå±‚"></a>äº”ã€Android Binderç³»ç»Ÿ-Framwork-Javaå±‚</h2><h3 id="ï¼ˆ1ï¼‰ã€Android-Binderç³»ç»ŸJavaå±‚"><a href="#ï¼ˆ1ï¼‰ã€Android-Binderç³»ç»ŸJavaå±‚" class="headerlink" title="ï¼ˆ1ï¼‰ã€Android Binderç³»ç»ŸJavaå±‚"></a>ï¼ˆ1ï¼‰ã€Android Binderç³»ç»ŸJavaå±‚</h3><p>ä¸»è¦ç»“æ„ Androidåº”ç”¨ç¨‹åºä½¿ç”¨Javaè¯­è¨€å¼€å‘ï¼ŒBinderæ¡†æ¶è‡ªç„¶ä¹Ÿå°‘ä¸äº†åœ¨Javaå±‚æä¾›æ¥å£ã€‚</p><p>å‰æ–‡ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼ŒBinderæœºåˆ¶åœ¨C++å±‚å·²ç»æœ‰äº†å®Œæ•´çš„å®ç°ã€‚å› æ­¤Javaå±‚å®Œå…¨ä¸ç”¨é‡å¤å®ç°ï¼Œè€Œæ˜¯é€šè¿‡JNIè¡”æ¥äº†C++å±‚ä»¥å¤ç”¨å…¶å®ç°ã€‚</p><p>ä¸‹å›¾æè¿°äº†Binder Framework Javaå±‚åˆ°C++å±‚çš„è¡”æ¥å…³ç³»ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/56-Android-Binder_JNI.png" alt="Markdown"></p><p>è¿™é‡Œå¯¹å›¾ä¸­Javaå±‚å’ŒJNIå±‚çš„å‡ ä¸ªç±»åšä¸€ä¸‹è¯´æ˜( å…³äºC++å±‚çš„è®²è§£è¯·çœ‹è¿™é‡Œ )ï¼š</p><p>è¿™é‡Œçš„IInterfaceï¼ŒIBinderå’ŒC++å±‚çš„ä¸¤ä¸ªç±»æ˜¯åŒåçš„ã€‚è¿™ä¸ªåŒåå¹¶ä¸æ˜¯å·§åˆï¼šå®ƒä»¬ä¸ä»…ä»…åŒåï¼Œå®ƒä»¬æ‰€èµ·çš„ä½œç”¨ï¼Œä»¥åŠå…¶ä¸­åŒ…å«çš„æ¥å£éƒ½æ˜¯å‡ ä¹ä¸€æ ·çš„ï¼ŒåŒºåˆ«ä»…ä»…åœ¨äºä¸€ä¸ªæ˜¯C++å±‚ï¼Œä¸€ä¸ªæ˜¯Javaå±‚è€Œå·²ã€‚</p><p>é™¤äº†IInterfaceï¼ŒIBinderä¹‹å¤–ï¼Œè¿™é‡ŒBinderä¸BinderProxyç±»ä¹Ÿæ˜¯ä¸C++çš„ç±»å¯¹åº”çš„ï¼Œä¸‹é¢åˆ—å‡ºäº†Javaå±‚å’ŒC++å±‚ç±»çš„å¯¹åº”å…³ç³»ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/57-Android-binder-Java-class.png" alt="Markdown"></p><p>é™¤äº†IInterfaceï¼ŒIBinderä¹‹å¤–ï¼Œè¿™é‡ŒBinderä¸BinderProxyç±»ä¹Ÿæ˜¯ä¸C++çš„ç±»å¯¹åº”çš„ï¼Œä¸‹é¢åˆ—å‡ºäº†Javaå±‚å’ŒC++å±‚ç±»çš„å¯¹åº”å…³ç³»ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/58-Android-binder-Java-c-class.png" alt="Markdown"></p><h3 id="ï¼ˆ2ï¼‰ã€JNIçš„è¡”æ¥"><a href="#ï¼ˆ2ï¼‰ã€JNIçš„è¡”æ¥" class="headerlink" title="ï¼ˆ2ï¼‰ã€JNIçš„è¡”æ¥"></a>ï¼ˆ2ï¼‰ã€JNIçš„è¡”æ¥</h3><p>JNIå…¨ç§°æ˜¯Java Native Interfaceï¼Œè¿™ä¸ªæ˜¯ç”±Javaè™šæ‹Ÿæœºæä¾›çš„æœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶ä½¿å¾—nativeä»£ç å¯ä»¥å’ŒJavaä»£ç äº’ç›¸é€šè®¯ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼šæˆ‘ä»¬å¯ä»¥åœ¨C/C++ç«¯è°ƒç”¨Javaä»£ç ï¼Œä¹Ÿå¯ä»¥åœ¨Javaç«¯è°ƒç”¨C/C++ä»£ç ã€‚</p><p>å…³äºJNIçš„è¯¦ç»†è¯´æ˜ï¼Œå¯ä»¥å‚è§Oracleçš„å®˜æ–¹æ–‡æ¡£ï¼šJava Native Interface ï¼Œè¿™é‡Œä¸å¤šè¯´æ˜ã€‚</p><p>å®é™…ä¸Šï¼Œåœ¨Androidä¸­å¾ˆå¤šçš„æœåŠ¡æˆ–è€…æœºåˆ¶éƒ½æ˜¯åœ¨C/C++å±‚å®ç°çš„ï¼Œæƒ³è¦å°†è¿™äº›å®ç°å¤ç”¨åˆ°Javaå±‚ï¼Œå°±å¿…é¡»é€šè¿‡JNIè¿›è¡Œè¡”æ¥ã€‚AOSPæºç ä¸­ï¼Œ/frameworks/base/core/jni/ ç›®å½•ä¸‹çš„æºç å°±æ˜¯ä¸“é—¨ç”¨æ¥å¯¹æ¥Frameworkå±‚çš„JNIå®ç°çš„ã€‚</p><p>çœ‹ä¸€ä¸‹Binder.javaçš„å®ç°å°±ä¼šå‘ç°ï¼Œè¿™é‡Œé¢æœ‰ä¸å°‘çš„æ–¹æ³•éƒ½æ˜¯ç”¨nativeå…³é”®å­—ä¿®é¥°çš„ï¼Œå¹¶ä¸”æ²¡æœ‰æ–¹æ³•å®ç°ä½“ï¼Œè¿™äº›æ–¹æ³•å…¶å®éƒ½æ˜¯åœ¨C++ä¸­android_util_Binder.cppå®ç°çš„ï¼š é‚£ä¹ˆï¼Œé‚£ä¹ˆï¼ŒC++æ˜¯å¦‚ä½•è°ƒç”¨Javaçš„å‘¢ï¼Ÿæœ€å…³é”®çš„ï¼Œlibbinderä¸­çš„BBinder::onTransactæ˜¯å¦‚ä½•èƒ½å¤Ÿè°ƒç”¨åˆ°Javaä¸­çš„Binder::onTransactçš„å‘¢ï¼Ÿ<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/59-Android-binder-JavaBBinder.png" alt="Markdown"></p><p>è¿™æ®µé€»è¾‘å°±æ˜¯android_util_Binder.cppä¸­JavaBBinder::onTransactä¸­å¤„ç†çš„äº†ã€‚JavaBBinderæ˜¯BBinderå­ç±»ï¼Œå…¶ç±»ç»“æ„å¦‚ä¸‹ï¼šlibbinderä¸­çš„BBinder::onTransactæ˜¯å¦‚ä½•èƒ½å¤Ÿè°ƒç”¨åˆ°Javaä¸­çš„Binder::onTransactçš„å‘¢ï¼Ÿ JavaBBinder::onTransactå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">onTransact</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">   <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   JNIEnv* env = javavm_to_jnienv(mVM);</span><br><span class="line"></span><br><span class="line">   IPCThreadState* thread_state = IPCThreadState::self();</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">int32_t</span> strict_policy_before = thread_state-&gt;getStrictModePolicy();</span><br><span class="line"></span><br><span class="line">   jboolean res = env-&gt;CallBooleanMethod(mObject, gBinderOffsets.mExecTransact,</span><br><span class="line">       code, <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(&amp;data), <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(reply), flags);</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„è¿™æ®µä»£ç ä¸­çš„è¿™ä¸€è¡Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jboolean res = env-&gt;CallBooleanMethod(mObject, gBinderOffsets.mExecTransact,</span><br><span class="line">  code, <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(&amp;data), <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(reply), flags);</span><br></pre></td></tr></table></figure><p>è¿™ä¸€è¡Œä»£ç å…¶å®æ˜¯åœ¨è°ƒç”¨mObjectä¸Šoffsetä¸ºmExecTransactçš„æ–¹æ³•ã€‚è¿™é‡Œçš„å‡ ä¸ªå‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p><p>mObject æŒ‡å‘äº†Javaç«¯çš„Binderå¯¹è±¡ gBinderOffsets.mExecTransact æŒ‡å‘äº†Binderç±»çš„execTransactæ–¹æ³• data è°ƒç”¨execTransactæ–¹æ³•çš„å‚æ•° code, data, reply, flagséƒ½æ˜¯ä¼ é€’ç»™è°ƒç”¨æ–¹æ³•execTransactçš„å‚æ•° è€ŒJNIEnv.CallBooleanMethodè¿™ä¸ªæ–¹æ³•æ˜¯ç”±è™šæ‹Ÿæœºå®ç°çš„ã€‚å³ï¼šè™šæ‹Ÿæœºä¼šæä¾›nativeæ–¹æ³•æ¥è°ƒç”¨ä¸€ä¸ªJava Objectä¸Šçš„æ–¹æ³•ï¼ˆå…³äºAndroidä¸Šçš„Javaè™šæ‹Ÿæœºï¼Œä»Šåæˆ‘ä»¬ä¼šä¸“é—¨è®²è§£ï¼‰ã€‚</p><p>è¿™æ ·ï¼Œå°±åœ¨C++å±‚çš„JavaBBinder::onTransactä¸­è°ƒç”¨äº†Javaå±‚Binder::execTransactæ–¹æ³•ã€‚è€Œåœ¨Binder::execTransactæ–¹æ³•ä¸­ï¼Œåˆè°ƒç”¨äº†è‡ªèº«çš„onTransactæ–¹æ³•ï¼Œç”±æ­¤ä¿è¯æ•´ä¸ªè¿‡ç¨‹ä¸²è”äº†èµ·æ¥ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> boolean <span class="title">execTransact</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">long</span> dataObj, <span class="keyword">long</span> replyObj,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">   Parcel data = Parcel.obtain(dataObj);</span><br><span class="line">   Parcel reply = Parcel.obtain(replyObj);</span><br><span class="line">   boolean res;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       res = onTransact(code, data, reply, flags);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (RemoteException|RuntimeException e) &#123;</span><br><span class="line">       <span class="keyword">if</span> (LOG_RUNTIME_EXCEPTION) &#123;</span><br><span class="line">           Log.w(TAG, <span class="string">"Caught a RuntimeException from the binder stub implementation."</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> ((flags &amp; FLAG_ONEWAY) != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (e instanceof RemoteException) &#123;</span><br><span class="line">               Log.w(TAG, <span class="string">"Binder call failed."</span>, e);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               Log.w(TAG, <span class="string">"Caught a RuntimeException from the binder stub implementation."</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           reply.setDataPosition(<span class="number">0</span>);</span><br><span class="line">           reply.writeException(e);</span><br><span class="line">       &#125;</span><br><span class="line">       res = <span class="literal">true</span>;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">       RuntimeException re = <span class="keyword">new</span> RuntimeException(<span class="string">"Out of memory"</span>, e);</span><br><span class="line">       reply.setDataPosition(<span class="number">0</span>);</span><br><span class="line">       reply.writeException(re);</span><br><span class="line">       res = <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   checkParcel(<span class="keyword">this</span>, code, reply, <span class="string">"Unreasonably large binder reply buffer"</span>);</span><br><span class="line">   reply.recycle();</span><br><span class="line">   data.recycle();</span><br><span class="line"></span><br><span class="line">   StrictMode.clearGatheredViolations();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ï¼ˆ3ï¼‰ã€Javaå±‚çš„ServiceManager"><a href="#ï¼ˆ3ï¼‰ã€Javaå±‚çš„ServiceManager" class="headerlink" title="ï¼ˆ3ï¼‰ã€Javaå±‚çš„ServiceManager"></a>ï¼ˆ3ï¼‰ã€Javaå±‚çš„ServiceManager</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/60-Android-binder-class_ServiceManager_java.jpg" alt="Markdown"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/61-Android-binder-ServiceManager_Java.png" alt="Markdown"></p><p>é€šè¿‡è¿™ä¸ªç±»å›¾æˆ‘ä»¬çœ‹åˆ°ï¼ŒJavaå±‚çš„ServiceManagerå’ŒC++å±‚çš„æ¥å£æ˜¯ä¸€æ ·çš„ã€‚</p><p>é€šè¿‡è¿™ä¸ªç±»å›¾æˆ‘ä»¬çœ‹åˆ°ï¼ŒJavaå±‚çš„ServiceManagerå’ŒC++å±‚çš„æ¥å£æ˜¯ä¸€æ ·çš„ã€‚</p><p>ç„¶åæˆ‘ä»¬å†é€‰å–addServiceæ–¹æ³•çœ‹ä¸€ä¸‹å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service, <span class="keyword">boolean</span> allowIsolated)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       getIServiceManager().addService(name, service, allowIsolated);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">       Log.e(TAG, <span class="string">"error in addService"</span>, e);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (sServiceManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> sServiceManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Find the service manager</span></span><br><span class="line">   sServiceManager = ServiceManagerNative.asInterface(BinderInternal.getContextObject());</span><br><span class="line">   <span class="keyword">return</span> sServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶ï¼Œè¿™æ®µä»£ç ä¸­ï¼Œæœ€å…³é”®å°±æ˜¯ä¸‹é¢è¿™ä¸ªè°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServiceManagerNative.asInterface(BinderInternal.getContextObject());</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦å†çœ‹ä¸€ä¸‹BinderInternal.getContextObject()å’ŒServiceManagerNative.asInterfaceä¸¤ä¸ªæ–¹æ³•ã€‚</p><p>BinderInternal.getContextObject()æ˜¯ä¸€ä¸ªJNIæ–¹æ³•ï¼Œå…¶å®ç°ä»£ç åœ¨android_util_Binder.cppä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">android_os_BinderInternal_getContextObject</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::self()-&gt;getContextObject(NULL);</span><br><span class="line">    <span class="keyword">return</span> javaObjectForIBinder(env, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ŒServiceManagerNative.asInterfaceçš„å®ç°å’Œå…¶ä»–çš„BinderæœåŠ¡æ˜¯ä¸€æ ·çš„å¥—è·¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   IServiceManager in =</span><br><span class="line">       (IServiceManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">   <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> in;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ServiceManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆé€šè¿‡queryLocalInterfaceæŸ¥çœ‹èƒ½ä¸èƒ½è·å¾—æœ¬åœ°Binderï¼Œå¦‚æœæ— æ³•è·å–ï¼Œåˆ™åˆ›å»ºå¹¶è¿”å›ServiceManagerProxyå¯¹è±¡ã€‚</p><p>è€ŒServiceManagerProxyè‡ªç„¶ä¹Ÿæ˜¯å’Œå…¶ä»–Binder Proxyä¸€æ ·çš„å®ç°å¥—è·¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service, <span class="keyword">boolean</span> allowIsolated)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">   Parcel data = Parcel.obtain();</span><br><span class="line">   Parcel reply = Parcel.obtain();</span><br><span class="line">   data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">   data.writeString(name);</span><br><span class="line">   data.writeStrongBinder(service);</span><br><span class="line">   data.writeInt(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">   mRemote.transact(ADD_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">   reply.recycle();</span><br><span class="line">   data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çš„è°ƒç”¨æµç¨‹å‰é¢å·²ç»åˆ†æè¿‡äº†ï¼Œåœ¨æ­¤å°±ä¸å†åˆ†æäº†ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/62-Android-binder-binder_ipc_process.jpg" alt="Markdown"></p><h2 id="å…­ã€Android-Binderç³»ç»Ÿ-AIDL"><a href="#å…­ã€Android-Binderç³»ç»Ÿ-AIDL" class="headerlink" title="å…­ã€Android Binderç³»ç»Ÿ-AIDL"></a>å…­ã€Android Binderç³»ç»Ÿ-AIDL</h2><p>ä½œä¸ºBinderæœºåˆ¶çš„æœ€åä¸€ä¸ªéƒ¨åˆ†å†…å®¹ï¼Œæˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹å¼€å‘è€…ç»å¸¸ä½¿ç”¨çš„AIDLæœºåˆ¶æ˜¯æ€ä¹ˆå›äº‹ã€‚</p><p>AIDLå…¨ç§°æ˜¯Android Interface Definition Languageï¼Œå®ƒæ˜¯Android SDKæä¾›çš„ä¸€ç§æœºåˆ¶ã€‚å€ŸåŠ©è¿™ä¸ªæœºåˆ¶ï¼Œåº”ç”¨å¯ä»¥æä¾›è·¨è¿›ç¨‹çš„æœåŠ¡ä¾›å…¶ä»–åº”ç”¨ä½¿ç”¨ã€‚AIDLçš„è¯¦ç»†è¯´æ˜å¯ä»¥å‚è§å®˜æ–¹å¼€å‘æ–‡æ¡£ï¼š<a href="https://developer.android.com/guide/components/aidl.html" target="_blank" rel="noopener">https://developer.android.com/guide/components/aidl.html</a> ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬å°±ä»¥å®˜æ–¹æ–‡æ¡£ä¸Šçš„ä¾‹å­çœ‹æ¥ä¸€ä¸‹AIDLä¸Binderæ¡†æ¶çš„å…³ç³»ã€‚</p><p>å¼€å‘ä¸€ä¸ªåŸºäºAIDLçš„Serviceéœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼š</p><p>å®šä¹‰ä¸€ä¸ª.aidlæ–‡ä»¶ å®ç°æ¥å£ æš´éœ²æ¥å£ç»™å®¢æˆ·ç«¯ä½¿ç”¨ aidlæ–‡ä»¶ä½¿ç”¨Javaè¯­è¨€çš„è¯­æ³•æ¥å®šä¹‰ï¼Œæ¯ä¸ª.aidlæ–‡ä»¶åªèƒ½åŒ…å«ä¸€ä¸ªinterfaceï¼Œå¹¶ä¸”è¦åŒ…å«interfaceçš„æ‰€æœ‰æ–¹æ³•å£°æ˜ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒAIDLæ”¯æŒçš„æ•°æ®ç±»å‹åŒ…æ‹¬ï¼š</p><p>åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå³intï¼Œlongï¼Œcharï¼Œbooleanç­‰ï¼‰ String CharSequence Listï¼ˆListçš„å…ƒç´ ç±»å‹å¿…é¡»æ˜¯AIDLæ”¯æŒçš„ï¼‰ Mapï¼ˆMapä¸­çš„å…ƒç´ å¿…é¡»æ˜¯AIDLæ”¯æŒçš„ï¼‰ å¯¹äºAIDLä¸­çš„æ¥å£ï¼Œå¯ä»¥åŒ…å«0ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼Œå¯ä»¥è¿”å›voidæˆ–ä¸€ä¸ªå€¼ã€‚æ‰€æœ‰éåŸºæœ¬ç±»å‹çš„å‚æ•°å¿…é¡»åŒ…å«ä¸€ä¸ªæè¿°æ˜¯æ•°æ®æµå‘çš„æ ‡ç­¾ï¼Œå¯èƒ½çš„å–å€¼æ˜¯ï¼šinï¼Œoutæˆ–è€…inoutã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªaidlæ–‡ä»¶çš„ç¤ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// IRemoteService.aidl</span><br><span class="line">package com.example.android;</span><br><span class="line"></span><br><span class="line">// Declare any non-default types here with import statements</span><br><span class="line"></span><br><span class="line">/** Example service interface */</span><br><span class="line">interface IRemoteService &#123;</span><br><span class="line">    /** Request the process ID of this service, to do evil things with it. */</span><br><span class="line">    int getPid();</span><br><span class="line"></span><br><span class="line">    /** Demonstrates some basic types that you can use as parameters</span><br><span class="line">     * and return values in AIDL.</span><br><span class="line">     */</span><br><span class="line">    void basicTypes(int anInt, long aLong, boolean aBoolean, float aFloat,</span><br><span class="line">            double aDouble, String aString);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶ä¸­åŒ…å«äº†ä¸¤ä¸ªæ¥å£ ï¼š</p><p>getPid ä¸€ä¸ªæ— å‚çš„æ¥å£ï¼Œè¿”å›å€¼ç±»å‹ä¸ºint basicTypesï¼ŒåŒ…å«äº†å‡ ä¸ªåŸºæœ¬ç±»å‹ä½œä¸ºå‚æ•°çš„æ¥å£ï¼Œæ— è¿”å›å€¼ å¯¹äºåŒ…å«.aidlæ–‡ä»¶çš„å·¥ç¨‹ï¼ŒAndroid IDEï¼ˆä»¥å‰æ˜¯Eclipseï¼Œç°åœ¨æ˜¯Android Studioï¼‰åœ¨ç¼–è¯‘é¡¹ç›®çš„æ—¶å€™ï¼Œä¼šä¸ºaidlæ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„Javaæ–‡ä»¶ã€‚</p><p>é’ˆå¯¹ä¸Šé¢è¿™ä¸ªaidlæ–‡ä»¶ç”Ÿæˆçš„javaæ–‡ä»¶ä¸­åŒ…å«çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/63-Android-binder-aidl_java.png" alt="Markdown"></p><p>åœ¨è¿™ä¸ªç”Ÿæˆçš„Javaæ–‡ä»¶ä¸­ï¼ŒåŒ…æ‹¬äº†ï¼š</p><p>ä¸€ä¸ªåç§°ä¸ºIRemoteServiceçš„interfaceï¼Œè¯¥interfaceç»§æ‰¿è‡ªandroid.os.IInterfaceå¹¶ä¸”åŒ…å«äº†æˆ‘ä»¬åœ¨aidlæ–‡ä»¶ä¸­å£°æ˜çš„æ¥å£æ–¹æ³• IRemoteServiceä¸­åŒ…å«äº†ä¸€ä¸ªåç§°ä¸ºStubçš„é™æ€å†…éƒ¨ç±»ï¼Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»§æ‰¿è‡ªandroid.os.Binderå¹¶ä¸”å®ç°äº†IRemoteServiceæ¥å£ã€‚è¿™ä¸ªç±»ä¸­åŒ…å«äº†ä¸€ä¸ªonTransactæ–¹æ³• Stubå†…éƒ¨åˆåŒ…å«äº†ä¸€ä¸ªåç§°ä¸ºProxyçš„é™æ€å†…éƒ¨ç±»ï¼ŒProxyç±»åŒæ ·å®ç°äº†IRemoteServiceæ¥å£ ä»”ç»†çœ‹ä¸€ä¸‹Stubç±»å’ŒProxyä¸¤ä¸ªä¸­åŒ…å«çš„æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—å¾ˆç†Ÿæ‚‰ï¼Ÿæ˜¯çš„ï¼Œè¿™é‡Œå’Œå‰é¢ä»‹ç»çš„æœåŠ¡å®ç°æ˜¯ä¸€æ ·çš„æ¨¡å¼ã€‚è¿™é‡Œæˆ‘ä»¬åˆ—ä¸€ä¸‹å„å±‚ç±»çš„å¯¹åº”å…³ç³»ï¼š</p><table><thead><tr><th style="text-align:center">C++å±‚</th><th style="text-align:center">Javaå±‚</th><th style="text-align:center">AIDL</th></tr></thead><tbody><tr><td style="text-align:center">BpXXX</td><td style="text-align:center">XXXProxy</td><td style="text-align:center">IXXX.Stub.Proxy</td></tr><tr><td style="text-align:center">BnXXX</td><td style="text-align:center">XXXNative</td><td style="text-align:center">IXXX.Stub</td></tr></tbody></table><p>ä¸ºäº†æ•´ä¸ªç»“æ„çš„å®Œæ•´æ€§ï¼Œæœ€åæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹ä¸€ä¸‹ç”Ÿæˆçš„Stubå’ŒProxyç±»ä¸­çš„å®ç°é€»è¾‘ã€‚</p><p>Stubæ˜¯æä¾›ç»™å¼€å‘è€…å®ç°ä¸šåŠ¡çš„çˆ¶ç±»ï¼Œè€ŒProxyçš„å®ç°äº†å¯¹å¤–æä¾›çš„æ¥å£ã€‚Stubå’ŒProxyä¸¤ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªasBinderçš„æ–¹æ³•ã€‚</p><p>Stubç±»ä¸­çš„asBinderå®ç°å°±æ˜¯è¿”å›è‡ªèº«å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ŒProxyä¸­asBinderçš„å®ç°æ˜¯è¿”å›æ„é€ å‡½æ•°ä¸­è·å–çš„mRemoteå¯¹è±¡ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line"></span><br><span class="line">Proxy(android.os.IBinder remote) &#123;</span><br><span class="line">    mRemote = remote;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Override</span><br><span class="line"><span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mRemote;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œè¿™é‡Œçš„mRemoteå¯¹è±¡å…¶å®å°±æ˜¯è¿œç¨‹æœåŠ¡åœ¨å½“å‰è¿›ç¨‹çš„æ ‡è¯†ã€‚</p><p>ä¸Šæ–‡æˆ‘ä»¬è¯´äº†ï¼ŒStubç±»æ˜¯ç”¨æ¥æä¾›ç»™å¼€å‘è€…å®ç°ä¸šåŠ¡é€»è¾‘çš„çˆ¶ç±»ï¼Œå¼€å‘è€…è€…ç»§æ‰¿è‡ªStubç„¶åå®Œæˆè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å®ç°ï¼Œä¾‹å¦‚è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> Process.myPid();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Does something</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªProxyç±»ï¼Œå°±æ˜¯ç”¨æ¥ç»™è°ƒç”¨è€…ä½¿ç”¨çš„å¯¹å¤–æ¥å£ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹Proxyä¸­çš„æ¥å£åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><p>Proxyä¸­getPidæ–¹æ³•å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">    android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">    android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">    <span class="keyword">int</span> _result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        mRemote.transact(Stub.TRANSACTION_getPid, _data, _reply, <span class="number">0</span>);</span><br><span class="line">        _reply.readException();</span><br><span class="line">        _result = _reply.readInt();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯é€šè¿‡Parcelå¯¹è±¡ä»¥åŠtransactè°ƒç”¨å¯¹åº”è¿œç¨‹æœåŠ¡çš„æ¥å£ã€‚è€Œåœ¨Stubç±»ä¸­ï¼Œç”Ÿæˆçš„onTransactæ–¹æ³•å¯¹åº”çš„å¤„ç†äº†è¿™é‡Œçš„è¯·æ±‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</span><br><span class="line">        reply.writeString(DESCRIPTOR);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> TRANSACTION_getPid: &#123;</span><br><span class="line">        data.enforceInterface(DESCRIPTOR);</span><br><span class="line">        <span class="keyword">int</span> _result = <span class="keyword">this</span>.getPid();</span><br><span class="line">        reply.writeNoException();</span><br><span class="line">        reply.writeInt(_result);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> TRANSACTION_basicTypes: &#123;</span><br><span class="line">        data.enforceInterface(DESCRIPTOR);</span><br><span class="line">        <span class="keyword">int</span> _arg0;</span><br><span class="line">        _arg0 = data.readInt();</span><br><span class="line">        <span class="keyword">long</span> _arg1;</span><br><span class="line">        _arg1 = data.readLong();</span><br><span class="line">        <span class="keyword">boolean</span> _arg2;</span><br><span class="line">        _arg2 = (<span class="number">0</span> != data.readInt());</span><br><span class="line">        <span class="keyword">float</span> _arg3;</span><br><span class="line">        _arg3 = data.readFloat();</span><br><span class="line">        <span class="keyword">double</span> _arg4;</span><br><span class="line">        _arg4 = data.readDouble();</span><br><span class="line">        java.lang.String _arg5;</span><br><span class="line">        _arg5 = data.readString();</span><br><span class="line">        <span class="keyword">this</span>.basicTypes(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5);</span><br><span class="line">        reply.writeNoException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>onTransact()æ‰€è¦åšçš„å°±æ˜¯ï¼š</p><p>æ ¹æ®codeåŒºåˆ†è¯·æ±‚çš„æ˜¯å“ªä¸ªæ¥å£ é€šè¿‡dataæ¥è·å–è¯·æ±‚çš„å‚æ•° è°ƒç”¨ç”±å­ç±»å®ç°çš„æŠ½è±¡æ–¹æ³• æœ‰äº†å‰æ–‡çš„è®²è§£ï¼Œå¯¹äºè¿™éƒ¨åˆ†å†…å®¹åº”å½“ä¸éš¾ç†è§£äº†ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºè®²è§£å®ŒBinderäº†ã€‚</p><p>å®Œæ•´æ¡†æ¶ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.binder/64-Android-Binder-IPCall.png" alt="Markdown"></p><h2 id="ä¸ƒã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ä¸ƒã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ä¸ƒã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ä¸ƒã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h2><p><a href="https://github.com/xdtianyu/SourceAnalysis/blob/master/Binder%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md" target="_blank" rel="noopener">Binderæºç åˆ†æ</a><br><a href="http://blog.csdn.net/yangwen123/article/category/1609389" target="_blank" rel="noopener">æ·±å…¥åˆ†æAndroid Binder</a><br><a href="http://gityuan.com/tags/#binder" target="_blank" rel="noopener">Binderç³»åˆ— - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢</a><br><a href="https://wangkuiwu.github.io/page2/" target="_blank" rel="noopener">Android Binderæœºåˆ¶(1) ~ (12) - Wangkuiwu.github.io</a><br><a href="http://www.jcodecraeer.com/tags.php?/Binder/" target="_blank" rel="noopener">Binderæœºåˆ¶-å…³äºBinderçš„æ–‡ç«  - æ³¡åœ¨ç½‘ä¸Šçš„æ—¥å­</a><br><a href="http://qiangbo.space/tags/#Android" target="_blank" rel="noopener">ç†è§£Android Binderæœºåˆ¶ - Qiangbo.spaceåšå®¢</a><br><a href="https://my.oschina.net/youranhongcha/blog?catalog=373547&amp;temp=1505099522160" target="_blank" rel="noopener">çº¢èŒ¶ä¸€æ¯è¯Binder - æ‚ ç„¶çº¢èŒ¶</a><br><a href="https://github.com/hehonghui/android-tech-frontier/blob/master/issue-22/Binder%E6%A1%86%E6%9E%B6%E8%A7%A3%E6%9E%90.md" target="_blank" rel="noopener">Binderæ¡†æ¶è§£æ</a><br><a href="https://mr-cao.gitbooks.io/android/content/android-binder.html" target="_blank" rel="noopener">Android Binderè¯¦è§£</a><br><a href="http://blog.csdn.net/carson_ho/article/details/73560642" target="_blank" rel="noopener">å›¾æ–‡è¯¦è§£ Android Binderè·¨è¿›ç¨‹é€šä¿¡æœºåˆ¶ åŸç†</a><br><a href="http://qiangbo.space/2017-01-15/AndroidAnatomy_Binder_Driver/" target="_blank" rel="noopener">ç†è§£Android Binderæœºåˆ¶(1/3)ï¼šé©±åŠ¨ç¯‡-qiangbo.space</a><br><a href="http://qiangbo.space/2017-02-12/AndroidAnatomy_Binder_CPP/" target="_blank" rel="noopener">ç†è§£Android Binderæœºåˆ¶(2/3)ï¼šC++å±‚-qiangbo.space</a><br><a href="http://qiangbo.space/2017-03-15/AndroidAnatomy_Binder_Java/" target="_blank" rel="noopener">ç†è§£Android Binderæœºåˆ¶(3/3)ï¼šJavaå±‚-qiangbo.space</a><br><a href="http://light3moon.com/1986/12/20/%E6%96%87%E7%AB%A0%E7%B4%A2%E5%BC%95/#" target="_blank" rel="noopener">Android Binder åˆ†æâ€“ç³»åˆ—-light3moon</a><br><a href="http://palanceli.com/categories/Android%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/page/2/" target="_blank" rel="noopener">Androidå­¦ä¹ ç¬”è®°-Binder | Palanceâ€™s Blog</a><br><a href="http://blog.csdn.net/armwind/article/category/6282972" target="_blank" rel="noopener">androidç³»ç»Ÿ -Binder - armwindçš„ä¸“æ  - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/Bettarwang/article/category/2276043" target="_blank" rel="noopener">Bettarwangçš„ä¸“æ  -Android Binderæœºåˆ¶</a><br><a href="http://blog.csdn.net/yangwen123/article/category/1609389" target="_blank" rel="noopener">æ·±å…¥å‰–æAndroidç³»ç»Ÿ - binder - CSDNåšå®¢</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/01/01/Android-7-1-2-Android-N-Android-Binderç³»ç»Ÿåˆ†æ/">http://zhoujinjian.cc/2018/01/01/Android-7-1-2-Android-N-Android-Binderç³»ç»Ÿåˆ†æ/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2017/12/01/Android-7-1-2-Android-N-Android-è¾“å…¥å­ç³»ç»Ÿ-Input-System/" title="Android 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ - Input System åˆ†æ"><i class="iconfont icon-prev"></i>Android 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ - Input System åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-ç³»ç»Ÿåˆ†æ/" title="Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]">Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">21</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/" title="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" alt="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</h3><span class="item__text">2018-08-30</span></div></a></li><li class="latest-post-item"><a href="/2018/08/16/Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ/" title="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.22.jpg" alt="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ</h3><span class="item__text">2018-08-16</span></div></a></li><li class="latest-post-item"><a href="/2018/08/01/Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ/" title="Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æ ä¹‹  HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.21.jpg" alt="Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æ ä¹‹  HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æ ä¹‹ HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ</h3><span class="item__text">2018-08-01</span></div></a></li><li class="latest-post-item"><a href="/2018/07/20/Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL && OpenGL/" title="Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL && OpenGL"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.20.jpg" alt="Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL && OpenGL"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL && OpenGL</h3><span class="item__text">2018-07-20</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">327.5k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>