<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/09/28/Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.28.jpg" alt="Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ"></div><header class="post__info"><h1 class="post__title">Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://www.github.com/izhoujinjian">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-09-28</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€Android-O-Treble-æ¶æ„ä»‹ç»"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€Android O Treble æ¶æ„ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-0ã€Androidæ•´ä½“æ¶æ„å˜åŒ–ï¼ˆVNDKã€VINTFã€HIDLï¼‰"><span class="toc-text">1.0ã€Androidæ•´ä½“æ¶æ„å˜åŒ–ï¼ˆVNDKã€VINTFã€HIDLï¼‰</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1ã€Binderé€šä¿¡åŸŸå˜åŒ–"><span class="toc-text">1.1ã€Binderé€šä¿¡åŸŸå˜åŒ–</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2ã€vndbinder-amp-amp-vndservicemanager"><span class="toc-text">1.2ã€vndbinder &amp;&amp; vndservicemanager</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-1ã€vndbinder"><span class="toc-text">1.2.1ã€vndbinder</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2ã€vndservicemanager"><span class="toc-text">1.2.2ã€vndservicemanager</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-3ã€servicemanager"><span class="toc-text">1.2.3ã€servicemanager</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-3ã€hwservicemanager"><span class="toc-text">1.3ã€hwservicemanager</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-4ã€Binderåº“å˜åŒ–"><span class="toc-text">1.4ã€Binderåº“å˜åŒ–</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-5ã€Binderé€šä¿¡æ¡†æ¶å˜åŒ–"><span class="toc-text">1.5ã€Binderé€šä¿¡æ¡†æ¶å˜åŒ–</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-6ã€æ¡†æ¶å±‚Binderå¯¹è±¡å˜åŒ–"><span class="toc-text">1.6ã€æ¡†æ¶å±‚Binderå¯¹è±¡å˜åŒ–</span></a></li></ol></li></ol><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€Android-O-Treble-ä¹‹-HIDLæ–‡ä»¶ï¼ˆ-halæ–‡ä»¶ï¼‰æ¥å£æ–‡ä»¶ç¼–è¯‘"><span class="toc-text">ï¼ˆäºŒï¼‰ã€Android O Treble ä¹‹ HIDLæ–‡ä»¶ï¼ˆ.halæ–‡ä»¶ï¼‰æ¥å£æ–‡ä»¶ç¼–è¯‘</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1ã€ç”Ÿæˆå­Android-mkå’ŒAndroid-bpæ–‡ä»¶"><span class="toc-text">2.1ã€ç”Ÿæˆå­Android.mkå’ŒAndroid.bpæ–‡ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2ã€hidl-genå·¥å…·"><span class="toc-text">2.2ã€hidl-genå·¥å…·</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-å¯åŠ¨è¿‡ç¨‹"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€Android O Treble ä¹‹ hwservicemanager å¯åŠ¨è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1ã€åˆ›å»ºBnHwServiceManager"><span class="toc-text">3.1ã€åˆ›å»ºBnHwServiceManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2ã€IPCThreadState-gt-setTheContextObject-service"><span class="toc-text">3.2ã€IPCThreadState-&gt;setTheContextObject(service)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3ã€BinderCallback"><span class="toc-text">3.3ã€BinderCallback</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4ã€hwservicemanager-ç»§ç»­å…³ç³»"><span class="toc-text">3.4ã€hwservicemanager ç»§ç»­å…³ç³»</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå››ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-æ·»åŠ æœåŠ¡ï¼ˆaddï¼‰è¿‡ç¨‹"><span class="toc-text">ï¼ˆå››ï¼‰ã€Android O Treble ä¹‹ hwservicemanager æ·»åŠ æœåŠ¡ï¼ˆaddï¼‰è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-1ã€ILight-registerAsService"><span class="toc-text">4.1ã€ILight::registerAsService()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2ã€sm-gt-add-serviceName-c-str-this-æ·»åŠ light-service"><span class="toc-text">4.2ã€sm-&gt;add(serviceName.c_str(), this) æ·»åŠ light service</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3ã€joinRpcThreadpool"><span class="toc-text">4.3ã€joinRpcThreadpool()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäº”ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-æŸ¥è¯¢æœåŠ¡ï¼ˆgetï¼‰è¿‡ç¨‹"><span class="toc-text">ï¼ˆäº”ï¼‰ã€Android O Treble ä¹‹ hwservicemanager æŸ¥è¯¢æœåŠ¡ï¼ˆgetï¼‰è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1ã€æœåŠ¡æŸ¥è¯¢-hidl-get"><span class="toc-text">5.1ã€æœåŠ¡æŸ¥è¯¢_hidl_get()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2ã€æ¥å£è½¬æ¢IXXX-castFrom"><span class="toc-text">5.2ã€æ¥å£è½¬æ¢IXXX::castFrom()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå…­ï¼‰ã€Android-O-Treble-ä¹‹-HIDLæœåŠ¡Javaæ¡†æ¶å®ç°"><span class="toc-text">ï¼ˆå…­ï¼‰ã€Android O Treble ä¹‹ HIDLæœåŠ¡Javaæ¡†æ¶å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-1ã€Java-hidlæœåŠ¡åˆ›å»ºè¿‡ç¨‹"><span class="toc-text">6.1ã€Java hidlæœåŠ¡åˆ›å»ºè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2ã€Javaå±‚æœåŠ¡æ³¨å†Œï¼ˆaddï¼‰æŸ¥è¯¢ï¼ˆgetï¼‰è¿‡ç¨‹"><span class="toc-text">6.2ã€Javaå±‚æœåŠ¡æ³¨å†Œï¼ˆaddï¼‰æŸ¥è¯¢ï¼ˆgetï¼‰è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></div><hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ Android 8.x &amp;&amp; Linuxï¼ˆkernel 4.xï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼ˆâ—•â€¿â—•ï¼‰ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Â©Android @Linux ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/o.hidl.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p>é¦–å…ˆæ„Ÿè°¢ï¼š</p><p><a href="https://blog.csdn.net/yangwen123" target="_blank" rel="noopener">ã€YANGWEN123ã€‘Android O Trebleæ¶æ„ï¼ˆç³»åˆ—åˆ†ææ–‡ç« ï¼‰</a><br><a href="https://www.slideshare.net/opersys/androids-hidl-treble-in-the-hal" target="_blank" rel="noopener">ã€Karim Yaghmourã€‘Androidâ€™s HIDL: Treble in the HAL - SlideShare</a></p><p>æ­£æ˜¯ç”±äºå‰äººçš„åˆ†æå’Œæ€»ç»“ï¼Œå¸®åŠ©æˆ‘èŠ‚çº¦äº†å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå†æ¬¡æ„Ÿè°¢ï¼ï¼ï¼</p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆ==<strong>æ–‡ç« åŸºäº Kernel-4.x</strong>==ï¼‰ï¼š<br><a href="https://github.com/izhoujinjian/wahoo" target="_blank" rel="noopener">Kernel source for Pixel 2 (walleye) and Pixel 2 XL (taimen) - GitHub</a></p><p>AOSP æºç ï¼ˆ==<strong>æ–‡ç« åŸºäº Android 8.x</strong>==ï¼‰ï¼š<br><a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener">Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>==æºç ï¼ˆéƒ¨åˆ†ï¼‰==ï¼š</p><blockquote><p>Javaæ¡†æ¶</p></blockquote><p>/frameworks/base/core/java/android/os/ï¼ˆJAVAï¼‰</p><ul><li>IHwInterface.java</li><li>HwBinder.java</li><li>HwRemoteBinder.java</li><li>IHwBinder.java</li><li>HwParcel.java</li></ul><p>/frameworks/base/core/jni/ï¼ˆJNIï¼‰</p><ul><li>android_os_HwRemoteBinder.cpp</li><li>android_os_HwBinder.cpp</li><li>android_os_HwParcel.cpp</li></ul><blockquote><p>Nativeæ¡†æ¶</p></blockquote><p>/system/libhwbinder/</p><ul><li>Binder.cpp</li><li>BpHwBinder.cpp</li><li>IInterface.cpp</li><li>IPCThreadState.cpp</li><li>Parcel.cpp</li><li>ProcessState.cpp</li></ul><p>/system/libhidl/transport/</p><ul><li>HidlBinderSupport.cpp</li><li>HidlTransportSupport.cpp</li><li>ServiceManagement.cpp</li><li>/manager/1.0/IServiceManager.hal</li><li>/manager/1.0/IServiceNotification.hal</li></ul><p>/system/hwservicemanager/</p><ul><li>HidlService.cpp</li><li>hwservicemanager.rc</li><li>ServiceManager.cpp</li><li>service.cpp</li></ul><blockquote><p>Binder Driverï¼ˆKernelï¼‰</p></blockquote><p>/drivers/android/</p><ul><li>binder.c</li><li>binder_alloc.c</li></ul><blockquote><p>æºç ç¼–è¯‘ç”Ÿæˆè·¯å¾„ï¼ˆJavaï¼‰ï¼š</p></blockquote><p>\out\target\common\gen\JAVA_LIBRARIES</p><ul><li>android.hardware.light-V2.0-java_intermediates</li><li>android.hidl.manager-V1.0-java_intermediates</li><li>â€¦â€¦</li></ul><blockquote><p>æºç ç¼–è¯‘ç”Ÿæˆè·¯å¾„ï¼ˆhardware/interfaces/ï¼‰ï¼š</p></blockquote><p>\out\soong.intermediates\system\</p><ul><li>libhidl\transport\manager\1.1\android.hidl.manager@1.1_genc++</li></ul><p>\out\soong.intermediates\hardware\interfaces*</p><ul><li>light\2.0\android.hardware.light@2.0_genc++</li><li>audio\2.0\android.hardware.audio@2.0_genc++</li><li>camera*</li><li>graphics*</li><li>media*</li><li>wifi*</li><li>â€¦â€¦</li></ul><hr><blockquote><p>æ³¨ï¼šæ–‡ä¸­å›¾æ–‡è®¸å¤šå‚è€ƒ<a href="https://blog.csdn.net/yangwen123/" target="_blank" rel="noopener">å¿«ä¹å®‰å“</a>ï¼Œç”±äºåšä¸»æœ‰ç‚¹å°å°çš„å¼ºè¿«ç—‡ï¼ŒæŠŠå›¾ç‰‡æ°´å°éƒ½å»æ‰äº†ï¼Œè¯·å„ä½è§è°…ï¼</p></blockquote><h4 id="ï¼ˆä¸€ï¼‰ã€Android-O-Treble-æ¶æ„ä»‹ç»"><a href="#ï¼ˆä¸€ï¼‰ã€Android-O-Treble-æ¶æ„ä»‹ç»" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Android O Treble æ¶æ„ä»‹ç»"></a>ï¼ˆä¸€ï¼‰ã€Android O Treble æ¶æ„ä»‹ç»</h4><h6 id="1-0ã€Androidæ•´ä½“æ¶æ„å˜åŒ–ï¼ˆVNDKã€VINTFã€HIDLï¼‰"><a href="#1-0ã€Androidæ•´ä½“æ¶æ„å˜åŒ–ï¼ˆVNDKã€VINTFã€HIDLï¼‰" class="headerlink" title="1.0ã€Androidæ•´ä½“æ¶æ„å˜åŒ–ï¼ˆVNDKã€VINTFã€HIDLï¼‰"></a>1.0ã€Androidæ•´ä½“æ¶æ„å˜åŒ–ï¼ˆVNDKã€VINTFã€HIDLï¼‰</h6><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-01-HIDL-treble-after.png.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-02-HIDL-treble-architecture.png.png" alt="Alt text | center"></p><p>AndroidOå¼•å…¥Trebleæ¶æ„åçš„å˜åŒ–:</p><ol><li><p>å¢åŠ äº†2ä¸ªæœåŠ¡ç®¡å®¶ï¼ŒAndroid O ä¹‹å‰ç‰ˆæœ¬æœ‰ä¸”åªæœ‰ä¸€ä¸ªservicemanagerï¼Œç°åœ¨å¢åŠ åˆ°3ä¸ª(servicemanagerã€hwservicemanagerã€vndservicemanager)ï¼Œä»–ä»¬åˆ†ç®¡ä¸åŒçš„æœåŠ¡ã€‚</p></li><li><p>å¢åŠ äº†binderé€šä¿¡åº“ï¼Œè¿™æ˜¯ä¸ºäº†é€‚é…binderåŸŸçš„æ‰©å±•ã€‚</p></li><li><p>å¢åŠ äº†binderåŸŸï¼Œç³»ç»Ÿå®šä¹‰äº†3ä¸ªbinderè®¾å¤‡èŠ‚ç‚¹ï¼Œbinderé©±åŠ¨åˆ†åˆ«å¤„ç†è¿™3ä¸ªbinderè®¾å¤‡èŠ‚ç‚¹ä¸Šçš„binderé€šä¿¡äº‹ä»¶ã€‚</p></li></ol><h6 id="1-1ã€Binderé€šä¿¡åŸŸå˜åŒ–"><a href="#1-1ã€Binderé€šä¿¡åŸŸå˜åŒ–" class="headerlink" title="1.1ã€Binderé€šä¿¡åŸŸå˜åŒ–"></a>1.1ã€Binderé€šä¿¡åŸŸå˜åŒ–</h6><p>Trebleæ¶æ„çš„å¼•å…¥è¶³ä»¥è¯´æ˜Binderé€šä¿¡çš„é‡è¦æ€§ï¼Œä¹‹å‰APPå’ŒFrameworkä¹‹é—´é€šè¿‡binderå®ç°è·¨è¿›ç¨‹è°ƒç”¨ï¼Œå½“ç„¶è¿™ä¸ªè°ƒç”¨å¯¹å¼€å‘è€…æ¥è¯´æ˜¯é€æ˜çš„ï¼Œç›¸å½“äºå‡½æ•°æœ¬åœ°è°ƒç”¨ã€‚Trebleå¼•å…¥åï¼ŒFrameworkå’ŒHALåˆå®ç°äº†è¿›ç¨‹åˆ†ç¦»ï¼ŒFrameworkå’ŒHALä¹‹é—´ä¾ç„¶ä½¿ç”¨binderé€šä¿¡ï¼Œé€šè¿‡HIDLæ¥å®šä¹‰é€šä¿¡æ¥å£ã€‚é‚£binderé€šä¿¡æœ‰ä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿ åœ¨Trebleä¸­ï¼Œå¼•å…¥äº†å¤šä¸ªbinderåŸŸï¼Œä¸»è¦æ˜¯å¢åŠ äº†å¤šä¸ªbinderè®¾å¤‡ï¼Œbinderé©±åŠ¨å®ç°åŸç†åŸºæœ¬æ²¡å˜ï¼Œå˜åŒ–äº†ä¸€äº›ç»†èŠ‚ã€‚å¢åŠ binderè®¾å¤‡åº”è¯¥æ˜¯ä¸ºäº†å®ç°æ›´æ¢çš„æƒé™æ§åˆ¶ï¼Œä½¿ç”¨ä¸åŒbinderè®¾å¤‡çš„ä¸»ä½“å’Œå®¢ä½“ä¹‹é—´çš„selinuxæƒé™æœ‰æ‰€ä¸åŒï¼ŒåŒæ—¶ï¼ŒAndroid æ¡†æ¶å’Œ HAL ç°åœ¨ä½¿ç”¨ Binder äº’ç›¸é€šä¿¡ã€‚ç”±äºè¿™ç§é€šä¿¡æ–¹å¼æå¤§åœ°å¢åŠ äº† Binder æµé‡ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-03-HIDL-Binder-enhancement.png" alt="Alt text | center"></p><p>ä¸ºäº†æ˜ç¡®åœ°æ‹†åˆ†æ¡†æ¶ï¼ˆä¸è®¾å¤‡æ— å…³ï¼‰å’Œä¾›åº”å•†ï¼ˆä¸å…·ä½“è®¾å¤‡ç›¸å…³ï¼‰ä»£ç ä¹‹é—´çš„ Binder æµé‡ï¼ŒAndroid O å¼•å…¥äº†â€œBinder ä¸Šä¸‹æ–‡â€è¿™ä¸€æ¦‚å¿µã€‚æ¯ä¸ª Binder ä¸Šä¸‹æ–‡éƒ½æœ‰è‡ªå·±çš„è®¾å¤‡èŠ‚ç‚¹å’Œä¸Šä¸‹æ–‡ï¼ˆæœåŠ¡ï¼‰ç®¡ç†å™¨ã€‚æ‚¨åªèƒ½é€šè¿‡ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ‰€å±çš„è®¾å¤‡èŠ‚ç‚¹å¯¹å…¶è¿›è¡Œè®¿é—®ï¼Œå¹¶ä¸”åœ¨é€šè¿‡ç‰¹å®šä¸Šä¸‹æ–‡ä¼ é€’ Binder èŠ‚ç‚¹æ—¶ï¼Œåªèƒ½ç”±å¦ä¸€ä¸ªè¿›ç¨‹ä»ç›¸åŒçš„ä¸Šä¸‹æ–‡è®¿é—®ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œä»è€Œç¡®ä¿è¿™äº›åŸŸå®Œå…¨äº’ç›¸éš”ç¦»ã€‚ä¸ºäº†æ˜¾ç¤º /dev/vndbinderï¼Œè¯·ç¡®ä¿å†…æ ¸é…ç½®é¡¹ CONFIG_ANDROID_BINDER_DEVICES è®¾ä¸ºâ€binder,hwbinder,vndbinderâ€</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;kernel/android/configs/android-base.cfg]</span><br><span class="line">CONFIG_ANDROID_BINDER_DEVICES=binder,hwbinder,vndbinder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[-&gt;kernel/drivers/android/binder.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *binder_devices_param = CONFIG_ANDROID_BINDER_DEVICES;</span><br><span class="line">module_param_named(devices, binder_devices_param, charp, S_IRUGO);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">binder_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Copy the module_parameter string, because we don't want to</span></span><br><span class="line"><span class="comment">	 * tokenize it in-place.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	device_names = kzalloc(<span class="built_in">strlen</span>(binder_devices_param) + <span class="number">1</span>, GFP_KERNEL);</span><br><span class="line">	......</span><br><span class="line">	<span class="built_in">strcpy</span>(device_names, binder_devices_param);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((device_name = strsep(&amp;device_names, <span class="string">","</span>))) &#123;</span><br><span class="line">		ret = init_binder_device(device_name);</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">init_binder_device</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_device</span> *<span class="title">binder_device</span>;</span></span><br><span class="line"></span><br><span class="line">	binder_device = kzalloc(<span class="keyword">sizeof</span>(*binder_device), GFP_KERNEL);</span><br><span class="line">	......</span><br><span class="line">	ret = misc_register(&amp;binder_device-&gt;miscdev);</span><br><span class="line">	......</span><br><span class="line">	hlist_add_head(&amp;binder_device-&gt;hlist, &amp;binder_devices);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥kernelå‚æ•°å½¢å¼å¾—åˆ°é…ç½®çš„binderè®¾å¤‡èŠ‚ç‚¹åç§°ï¼Œç„¶ååœ¨binderé©±åŠ¨ä¸­åˆ›å»ºä¸åŒçš„binderè®¾å¤‡ï¼š<br>è¿™æ ·åœ¨é©±åŠ¨ä¸­å°±åˆ›å»ºäº†binderã€vndbinderã€hwbinderä¸‰ä¸ªé©±åŠ¨è®¾å¤‡ï¼Œå¹¶ä¿å­˜åœ¨binderè®¾å¤‡åˆ—è¡¨binder_devicesä¸­ã€‚/dev/binder è®¾å¤‡èŠ‚ç‚¹æˆä¸ºäº†æ¡†æ¶è¿›ç¨‹çš„ä¸“å±èŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€oemè¿›ç¨‹å°†æ— æ³•å†è®¿é—®è¯¥èŠ‚ç‚¹ã€‚oemè¿›ç¨‹å¯ä»¥è®¿é—® /dev/hwbinderï¼Œä½†å¿…é¡»å°†å…¶ AIDL æ¥å£è½¬ä¸ºä½¿ç”¨ HIDLã€‚</p><h6 id="1-2ã€vndbinder-amp-amp-vndservicemanager"><a href="#1-2ã€vndbinder-amp-amp-vndservicemanager" class="headerlink" title="1.2ã€vndbinder &amp;&amp; vndservicemanager"></a>1.2ã€vndbinder &amp;&amp; vndservicemanager</h6><p>ä¸€ç›´ä»¥æ¥ï¼Œä¾›åº”å•†è¿›ç¨‹éƒ½ä½¿ç”¨ Binder è¿›ç¨‹é—´é€šä¿¡ (IPC) æŠ€æœ¯è¿›è¡Œé€šä¿¡ã€‚åœ¨ Android O ä¸­ï¼Œ/dev/binder è®¾å¤‡èŠ‚ç‚¹æˆä¸ºäº†æ¡†æ¶è¿›ç¨‹çš„ä¸“å±èŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€ä¾›åº”å•†è¿›ç¨‹å°†æ— æ³•å†è®¿é—®è¯¥èŠ‚ç‚¹ã€‚ä¾›åº”å•†è¿›ç¨‹å¯ä»¥è®¿é—® /dev/hwbinderï¼Œä½†å¿…é¡»å°†å…¶ AIDL æ¥å£è½¬ä¸ºä½¿ç”¨ HIDLã€‚å¯¹äºæƒ³è¦ç»§ç»­åœ¨ä¾›åº”å•†è¿›ç¨‹ä¹‹é—´ä½¿ç”¨ AIDL æ¥å£çš„ä¾›åº”å•†ï¼ŒAndroid ä¼šæŒ‰ä»¥ä¸‹æ–¹å¼æ”¯æŒ Binder IPCã€‚</p><h6 id="1-2-1ã€vndbinder"><a href="#1-2-1ã€vndbinder" class="headerlink" title="1.2.1ã€vndbinder"></a>1.2.1ã€vndbinder</h6><p>Android O æ”¯æŒä¾›åº”å•†æœåŠ¡ä½¿ç”¨æ–°çš„ Binder åŸŸï¼Œè¿™å¯é€šè¿‡ä½¿ç”¨ /dev/vndbinderï¼ˆè€Œé /dev/binderï¼‰è¿›è¡Œè®¿é—®ã€‚æ·»åŠ  /dev/vndbinder åï¼ŒAndroid ç°åœ¨æ‹¥æœ‰ä»¥ä¸‹ 3 ä¸ª IPC åŸŸï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-04-HIDL-hwbinder-vndbinder.png" alt="Alt text | center"></p><p>é€šå¸¸ï¼Œä¾›åº”å•†è¿›ç¨‹ä¸ç›´æ¥æ‰“å¼€ Binder é©±åŠ¨ç¨‹åºï¼Œè€Œæ˜¯é“¾æ¥åˆ°æ‰“å¼€ Binder é©±åŠ¨ç¨‹åºçš„ libbinder ç”¨æˆ·ç©ºé—´åº“ã€‚ä¸º ::android::ProcessState() æ·»åŠ æ–¹æ³•å¯ä¸º libbinder é€‰æ‹© Binder é©±åŠ¨ç¨‹åºã€‚ä¾›åº”å•†è¿›ç¨‹åº”è¯¥åœ¨è°ƒç”¨ ProcessState,ã€IPCThreadState æˆ–å‘å‡ºä»»ä½•æ™®é€š Binder è°ƒç”¨ä¹‹å‰è°ƒç”¨æ­¤æ–¹æ³•ã€‚è¦ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œè¯·åœ¨ä¾›åº”å•†è¿›ç¨‹ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼‰çš„ main() åæ”¾ç½®ä»¥ä¸‹è°ƒç”¨ï¼š</p><p>ProcessState::initWithDriver(â€œ/dev/vndbinderâ€);</p><h6 id="1-2-2ã€vndservicemanager"><a href="#1-2-2ã€vndservicemanager" class="headerlink" title="1.2.2ã€vndservicemanager"></a>1.2.2ã€vndservicemanager</h6><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-05-HIDL-hwservicemanager.png" alt="Alt text | center"></p><p>ä»¥å‰ï¼ŒBinder æœåŠ¡é€šè¿‡ servicemanager æ³¨å†Œï¼Œå…¶ä»–è¿›ç¨‹å¯ä»ä¸­æ£€ç´¢è¿™äº›æœåŠ¡ã€‚åœ¨ Android O ä¸­ï¼Œservicemanager ç°åœ¨ä¸“ç”¨äºæ¡†æ¶å’Œåº”ç”¨è¿›ç¨‹ï¼Œä¾›åº”å•†è¿›ç¨‹æ— æ³•å†å¯¹å…¶è¿›è¡Œè®¿é—®ã€‚</p><p>ä¸è¿‡ï¼Œä¾›åº”å•†æœåŠ¡ç°åœ¨å¯ä»¥ä½¿ç”¨ vndservicemanagerï¼Œè¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ /dev/vndbinderï¼ˆ<strong>ä½œä¸ºæ„å»ºåŸºç¡€çš„æºä»£ç ä¸æ¡†æ¶ servicemanager ç›¸åŒ/frameworks/native/cmds/servicemanager/</strong>ï¼‰è€Œé /dev/binder çš„ servicemanager çš„æ–°å®ä¾‹ã€‚ä¾›åº”å•†è¿›ç¨‹æ— éœ€æ›´æ”¹å³å¯ä¸ vndservicemanager é€šä¿¡ï¼›å½“ä¾›åº”å•†è¿›ç¨‹æ‰“å¼€ /dev/vndbinder æ—¶ï¼ŒæœåŠ¡æŸ¥è¯¢ä¼šè‡ªåŠ¨è½¬è‡³ vndservicemanagerã€‚</p><p>vndservicemanager äºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«åœ¨ Android çš„é»˜è®¤è®¾å¤‡ Makefile ä¸­ã€‚<br>servicemanagerå’Œvndservicemanagerä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œéƒ½æ˜¯ç”±service_manager.cç¼–è¯‘è€Œæ¥ã€‚<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/native/cmds/servicemanager/]</span><br><span class="line">Android.bp</span><br><span class="line">bctest.c</span><br><span class="line">binder.c</span><br><span class="line">binder.h</span><br><span class="line">service_manager.c</span><br><span class="line">servicemanager.rc</span><br><span class="line">vndservicemanager.rc</span><br><span class="line"></span><br><span class="line">[-&gt;/frameworks/native/cmds/servicemanager/service_manager.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span> *<span class="title">bs</span>;</span></span><br><span class="line">    <span class="keyword">union</span> selinux_callback cb;</span><br><span class="line">    <span class="keyword">char</span> *driver;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        driver = argv[<span class="number">1</span>]; <span class="comment">/* /dev/vndbinder */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        driver = <span class="string">"/dev/binder"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bs = binder_open(driver, <span class="number">128</span>*<span class="number">1024</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (binder_become_context_manager(bs)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"cannot become context manager (%s)\n"</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cb.func_audit = audit_callback;</span><br><span class="line">    selinux_set_callback(SELINUX_CB_AUDIT, cb);</span><br><span class="line">    cb.func_log = selinux_log_callback;</span><br><span class="line">    selinux_set_callback(SELINUX_CB_LOG, cb);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VENDORSERVICEMANAGER</span></span><br><span class="line">    sehandle = selinux_android_vendor_service_context_handle();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    sehandle = selinux_android_service_context_handle();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    selinux_status_open(<span class="literal">true</span>);</span><br><span class="line">    ......</span><br><span class="line">    binder_loop(bs, svcmgr_handler);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨å¯åŠ¨servicemanager æ—¶ï¼Œå¹¶æ²¡æœ‰ä¼ å‚ï¼Œè€Œå¯åŠ¨vndservicemanageræ—¶ï¼Œä¼ é€’äº†binderè®¾å¤‡èŠ‚ç‚¹ã€‚</p><blockquote><p>service servicemanager /system/bin/servicemanager<br>service vndservicemanager /vendor/bin/vndservicemanager ==<strong>/dev/vndbinder</strong>==<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/native/cmds/servicemanager/vndservicemanager.rc]</span><br><span class="line">service vndservicemanager /vendor/bin/vndservicemanager /dev/vndbinder</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">core</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">system</span> <span class="title">readproc</span></span></span><br><span class="line"><span class="class">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">system</span>-<span class="title">background</span>/<span class="title">tasks</span></span></span><br><span class="line"><span class="class">    <span class="title">shutdown</span> <span class="title">critical</span></span></span><br></pre></td></tr></table></figure><p></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/native/cmds/servicemanager/servicemanager.rc]</span><br><span class="line">service servicemanager /system/bin/servicemanager</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">core</span> <span class="title">animation</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">system</span> <span class="title">readproc</span></span></span><br><span class="line"><span class="class">    <span class="title">critical</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">healthd</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">zygote</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">audioserver</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">media</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">surfaceflinger</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">inputflinger</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">drm</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">cameraserver</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">keystore</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">gatekeeperd</span></span></span><br><span class="line"><span class="class">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">system</span>-<span class="title">background</span>/<span class="title">tasks</span></span></span><br><span class="line"><span class="class">    <span class="title">shutdown</span> <span class="title">critical</span></span></span><br></pre></td></tr></table></figure><h6 id="1-2-3ã€servicemanager"><a href="#1-2-3ã€servicemanager" class="headerlink" title="1.2.3ã€servicemanager"></a>1.2.3ã€servicemanager</h6><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-05-HIDL-servicemanager.png.png" alt="Alt text | center"></p><h6 id="1-3ã€hwservicemanager"><a href="#1-3ã€hwservicemanager" class="headerlink" title="1.3ã€hwservicemanager"></a>1.3ã€hwservicemanager</h6><p>hwservicemanagerç”¨äºç®¡ç†hidlæœåŠ¡ï¼Œå› æ­¤å…¶å®ç°å’Œservicemanagerå®Œå…¨ä¸åŒï¼Œä½¿ç”¨çš„binderåº“ä¹Ÿå®Œå…¨ä¸åŒã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-05-HIDL-vndservicemanager.png.png" alt="Alt text | center"></p><h6 id="1-4ã€Binderåº“å˜åŒ–"><a href="#1-4ã€Binderåº“å˜åŒ–" class="headerlink" title="1.4ã€Binderåº“å˜åŒ–"></a>1.4ã€Binderåº“å˜åŒ–</h6><p>servicemanagerå’Œvndservicemanageréƒ½ä½¿ç”¨libbinderåº“ï¼Œåªæ˜¯ä»–ä»¬ä½¿ç”¨çš„binderé©±åŠ¨ä¸åŒè€Œå·²ï¼Œè€Œhwservicemanagerä½¿ç”¨libhwbinderåº“ï¼Œbinderé©±åŠ¨ä¹Ÿä¸åŒã€‚</p><p>libbinderåº“æºç (\frameworks\native\libs\binder)<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-06-libbinder-sourcecode.png" alt="Alt text | center"></p><p>libhwbinderåº“æºç ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-07-libhwbinder-sourcecode.png" alt="Alt text | center"></p><p>æ–‡ä»¶å¯¹æ¯”ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-08-HIDL-binder-hwbinder-file-compare.png" alt="Alt text | center"></p><h6 id="1-5ã€Binderé€šä¿¡æ¡†æ¶å˜åŒ–"><a href="#1-5ã€Binderé€šä¿¡æ¡†æ¶å˜åŒ–" class="headerlink" title="1.5ã€Binderé€šä¿¡æ¡†æ¶å˜åŒ–"></a>1.5ã€Binderé€šä¿¡æ¡†æ¶å˜åŒ–</h6><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-09-HIDL-binder-binder_ipc_process.jpg" alt="Alt text | center"></p><p>1.åœ¨æ™®é€šJava Binderæ¡†æ¶ä¸­ï¼ŒClientç«¯Proxyç±»å®Œæˆæ•°æ®æ‰“åŒ…ï¼Œç„¶åäº¤ç»™mRemotebinderä»£ç†æ¥å®Œæˆæ•°æ®ä¼ è¾“ã€‚Serverç«¯Stubç±»å®Œæˆæ•°æ®è§£æï¼Œç„¶åäº¤ç»™å…¶å­ç±»å®ç°ã€‚</p><p>2.åœ¨æ™®é€šNative Binderæ¡†æ¶ä¸­ï¼ŒClientç«¯BpXXXç±»å®Œæˆæ•°æ®æ‰“åŒ…ï¼Œç„¶åäº¤ç»™mRemoteBpBinderæ¥å®Œæˆæ•°æ®ä¼ è¾“ã€‚Serverç«¯BnXXXç±»å®Œæˆæ•°æ®è§£æï¼Œç„¶åäº¤ä¸ªå…¶å­ç±»å®ç°ã€‚</p><ol><li>åœ¨HwBinderæ¡†æ¶ä¸­ï¼ŒClientç«¯çš„BpHwXXXç±»å®Œæˆæ•°æ®æ‰“åŒ…ï¼Œç„¶åäº¤ç»™mRemoteBpHwBinderæ¥å®Œæˆæ•°æ®ä¼ è¾“ã€‚Serverç«¯çš„BnHwXXXç±»å®Œæˆæ•°æ®è§£æï¼Œç„¶åäº¤ç»™_hidl_mImplæ¥å®ç°ã€‚</li></ol><h6 id="1-6ã€æ¡†æ¶å±‚Binderå¯¹è±¡å˜åŒ–"><a href="#1-6ã€æ¡†æ¶å±‚Binderå¯¹è±¡å˜åŒ–" class="headerlink" title="1.6ã€æ¡†æ¶å±‚Binderå¯¹è±¡å˜åŒ–"></a>1.6ã€æ¡†æ¶å±‚Binderå¯¹è±¡å˜åŒ–</h6><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/yangwen123/article/details/79836109" target="_blank" rel="noopener">ã€AndroidO Trebleæ¶æ„ä¸‹çš„å˜åŒ–ã€‘</a><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-10-HIDL-binder-hwbinder-fw-compare.png" alt="Alt text | center"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-11-HIDL-hwbinder-object.png" alt="Alt text | center"></p><h4 id="ï¼ˆäºŒï¼‰ã€Android-O-Treble-ä¹‹-HIDLæ–‡ä»¶ï¼ˆ-halæ–‡ä»¶ï¼‰æ¥å£æ–‡ä»¶ç¼–è¯‘"><a href="#ï¼ˆäºŒï¼‰ã€Android-O-Treble-ä¹‹-HIDLæ–‡ä»¶ï¼ˆ-halæ–‡ä»¶ï¼‰æ¥å£æ–‡ä»¶ç¼–è¯‘" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Android O Treble ä¹‹ HIDLæ–‡ä»¶ï¼ˆ.halæ–‡ä»¶ï¼‰æ¥å£æ–‡ä»¶ç¼–è¯‘"></a>ï¼ˆäºŒï¼‰ã€Android O Treble ä¹‹ HIDLæ–‡ä»¶ï¼ˆ.halæ–‡ä»¶ï¼‰æ¥å£æ–‡ä»¶ç¼–è¯‘</h4><p>HIDLæ˜¯ä¸€ç§æ¥å£å®šä¹‰è¯­è¨€ï¼Œæè¿°äº†HALå’Œå®ƒçš„ç”¨æˆ·ä¹‹é—´çš„æ¥å£ã€‚åŒaidiç±»ä¼¼ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºhalå®šä¹‰ç›¸å…³æ¥å£ï¼Œç„¶åé€šè¿‡hidl-genå·¥å…·å³å¯è‡ªåŠ¨ç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„C++æˆ–è€…javaæºæ–‡ä»¶ï¼Œå®šä¹‰halæ¥å£çš„æ–‡ä»¶å‘½åä¸ºxxx.halï¼Œä¸ºäº†ç¼–è¯‘è¿™äº›.halæ–‡ä»¶ï¼Œéœ€è¦ç¼–å†™ç›¸åº”çš„Android.bpæˆ–è€…Android.mkæ–‡ä»¶:</p><ol><li><p>Android.bpæ–‡ä»¶ç”¨äºç¼–è¯‘C++ï¼›</p></li><li><p>Android.mkæ–‡ä»¶ç”¨äºç¼–è¯‘Javaï¼›</p></li></ol><h5 id="2-1ã€ç”Ÿæˆå­Android-mkå’ŒAndroid-bpæ–‡ä»¶"><a href="#2-1ã€ç”Ÿæˆå­Android-mkå’ŒAndroid-bpæ–‡ä»¶" class="headerlink" title="2.1ã€ç”Ÿæˆå­Android.mkå’ŒAndroid.bpæ–‡ä»¶"></a>2.1ã€ç”Ÿæˆå­Android.mkå’ŒAndroid.bpæ–‡ä»¶</h5><p>æ‰€æœ‰çš„HIDL Interface éƒ½æ˜¯é€šè¿‡ä¸€ä¸ª.halæ–‡ä»¶æ¥æè¿°ï¼Œä¸ºäº†æ–¹ä¾¿ç¼–è¯‘ç”Ÿæˆæ¯ä¸€ä¸ªå­halã€‚Googleåœ¨ç³»ç»Ÿé»˜è®¤æä¾›äº†ä¸€ä¸ªè„šæœ¬update-makefiles.shï¼Œä½äºhardware/interfaces/ã€frameworks/hardware/interfaces/ã€system/hardware/interfaces/ã€system/libhidl/ã€‚ä»¥hardware/interfaces/é‡Œé¢çš„ä»£ç ä¸ºå®ä¾‹åšä»‹ç»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"> </span><br><span class="line">source system/tools/hidl/update-makefiles-helper.sh</span><br><span class="line"> </span><br><span class="line">do_makefiles_update \</span><br><span class="line">  <span class="string">"android.hardware:hardware/interfaces"</span> \</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè„šæœ¬çš„ä¸»è¦ä½œç”¨ï¼šæ ¹æ®halæ–‡ä»¶ç”ŸæˆAndroid.mk(makefile)å’ŒAndroid.bp(blueprint)æ–‡ä»¶ã€‚åœ¨hardware/interfacesçš„å­ç›®å½•é‡Œé¢ï¼Œå­˜åœ¨.halæ–‡ä»¶çš„ç›®å½•ï¼Œéƒ½ä¼šäº§ç”ŸAndroid.bpå’ŒAndroid.mkæ–‡ä»¶ã€‚è¯¦ç»†åˆ†æå¦‚ä¸‹ï¼š</p><ol><li>source system/toolsä¸‹é¢çš„update-makefiles-helper.shï¼Œç„¶åæ‰§è¡Œdo_makefiles_update</li><li>è§£æä¼ å…¥è¿›å»çš„å‚æ•°ã€‚å‚æ•°android.hardware:hardware/interfaces:<br>android.hardware: android.hardwareè¡¨ç¤ºåŒ…åã€‚<br>hardware/interfacesï¼šè¡¨ç¤ºç›¸å¯¹äºæ ¹ç›®å½•çš„æ–‡ä»¶è·¯å¾„ã€‚<br>ä¼šè¾“å‡ºå¦‚ä¸‹LOGï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Updating makefiles <span class="keyword">for</span> android.hardware in hardware/interfaces.</span><br><span class="line">Updating â€¦.</span><br></pre></td></tr></table></figure><p>3.è·å–æ‰€æœ‰çš„åŒ…åã€‚é€šè¿‡function get_packages()å‡½æ•°ï¼Œè·å–hardware/interfacesè·¯å¾„ä¸‹é¢çš„æ‰€æœ‰halæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•è·¯å¾„ï¼Œæ¯”å¦‚å­ç›®å½•Lighté‡Œé¢çš„halæ–‡ä»¶çš„è·¯å¾„æ˜¯\hardware\interfaces\light\2.0ï¼ŒåŠ ä¸Šå½“å‰çš„å‚æ•°åŒ…åhardware/interfacesï¼Œé€šè¿‡ç‚¹çš„æ–¹å¼è¿æ¥ï¼Œå°†light/2.0+hardware/interfacesé‡Œé¢çš„æ–œçº¿è½¬æ¢æˆç‚¹,æœ€ç»ˆè·å–çš„åŒ…åå°±æ˜¯ android.hardware.light@2.0ï¼Œä¾æ¬¡ç±»æ¨è·å–æ‰€æœ‰çš„åŒ…åã€‚<br>4.æ‰§è¡Œhidl-genå‘½ä»¤.å°†cæ­¥éª¤é‡Œé¢è·å–çš„å‚æ•°å’ŒåŒ…åè¿˜æœ‰ç±»åä¼ å…¥hidl-genå‘½ä»¤ï¼Œåœ¨\hardware\interfaces\light\2.0ç›®å½•ä¸‹äº§ç”ŸAndroid.mkå’ŒAndroid.bpæ–‡ä»¶ã€‚<br>Android.mk: hidl-gen -Lmakefile -r android.hardware:hardware/interfaces -r android.hidl:system/libhidl/transport android.hardware.light@2.0</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-12-HIDL-android-hal-make.png" alt="Alt text | center"></p><p>ç¼–è¯‘æœ€ç»ˆåœ¨./out/target/common/gen/JAVA_LIBRARIESç›®å½•ä¸‹ç”ŸæˆJavaæºæ–‡ä»¶ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-13-HIDL-android-make-java.png" alt="Alt text | center"></p><pre><code>Android.bp: hidl-gen -Landroidbp -r android.hardware:hardware/interfaces -r android.hidl:system/libhidl/transport android.hidl.manager@1.0
</code></pre><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-14-HIDL-android-hal-manager.png" alt="Alt text | center"></p><p>ç¼–è¯‘æœ€ç»ˆåœ¨./out/soong/.intermediates/hardware/interfacesç›®å½•ä¸‹ç”ŸæˆC++æºæ–‡ä»¶ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-15-HIDL-android-hal-manager-gen-c++.png" alt="Alt text | center"></p><p>5.åœ¨hardware/interfacesçš„æ¯ä¸ªå­ç›®å½•ä¸‹é¢äº§ç”ŸAndroid.bpæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ä¸»è¦æ˜¯subdirsçš„åˆå§‹åŒ–ï¼Œå­˜æ”¾å½“å‰ç›®å½•éœ€è¦åŒ…å«çš„å­ç›®å½•ã€‚æ¯”å¦‚hardware/interfaces/light/ä¸‹é¢çš„Android.bpæ–‡ä»¶ã€‚</p><p>ç»è¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œå°±ä¼šåœ¨å¯¹åº”çš„å­ç›®å½•äº§ç”ŸAndroid.mkå’ŒAndroid.bpæ–‡ä»¶ã€‚è¿™æ ·ä»¥åæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œæ­£å¸¸çš„ç¼–è¯‘å‘½ä»¤è¿›è¡Œç¼–è¯‘äº†ã€‚æ¯”å¦‚mmm hardware/interfaces/light/,é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨æºç ä¸­ï¼ŒAndroid.mkå’ŒAndroid.bpæ–‡ä»¶å·²ç»å­˜åœ¨ã€‚</p><h5 id="2-2ã€hidl-genå·¥å…·"><a href="#2-2ã€hidl-genå·¥å…·" class="headerlink" title="2.2ã€hidl-genå·¥å…·"></a>2.2ã€hidl-genå·¥å…·</h5><p>åœ¨Trebleæ¶æ„ä¸­ï¼Œç³»ç»Ÿå®šä¹‰çš„æ‰€æœ‰çš„.halæ¥å£ï¼Œéƒ½æ˜¯é€šè¿‡hidl-genå·¥å…·è½¬æ¢æˆå¯¹åº”çš„ä»£ç ã€‚æ¯”å¦‚\hardware\interfaces\light\2.0\ILight.halï¼Œä¼šé€šè¿‡hidl-genè½¬æ¢æˆ\out\soong.intermediates\hardware\interfaces\light\2.0\android.hardware.light@2.0_genc++\gen\android\hardware\light\2.0\LightAll.cppæ–‡ä»¶ã€‚<br>hidl-genæºç è·¯å¾„ï¼šsystem/tools/hidlï¼Œæ˜¯åœ¨ubuntuä¸Šå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚<br>ä½¿ç”¨æ–¹æ³•ï¼šhidl-gen -o output-path -L language (-r interface-root) fqname<br>å‚æ•°å«ä¹‰ï¼š<br>-Lï¼š è¯­è¨€ç±»å‹ï¼ŒåŒ…æ‹¬c++, c++-headers, c++-sources, export-header, c++-impl, java, java-constants, vts, makefile, androidbp, androidbp-impl, hashç­‰ã€‚hidl-genå¯æ ¹æ®ä¼ å…¥çš„è¯­è¨€ç±»å‹äº§ç”Ÿä¸åŒçš„æ–‡ä»¶ã€‚fqnameï¼šå®Œå…¨é™å®šåç§°çš„è¾“å…¥æ–‡ä»¶ã€‚æ¯”å¦‚æœ¬ä¾‹ä¸­android.hardware.light@2.0ï¼Œè¦æ±‚åœ¨æºç ç›®å½•ä¸‹å¿…é¡»æœ‰hardware/interfaces/light/2.0/ç›®å½•ã€‚<br>å¯¹äºå•ä¸ªæ–‡ä»¶æ¥è¯´ï¼Œæ ¼å¼å¦‚ä¸‹ï¼špackage@version::fileNameï¼Œæ¯”å¦‚android.hardware.light@1.0::types.Featureã€‚<br>å¯¹äºç›®å½•æ¥è¯´ã€‚æ ¼å¼å¦‚ä¸‹package@versionï¼Œæ¯”å¦‚android.hardware.light@2.0ã€‚<br>-rï¼š æ ¼å¼package:pathï¼Œå¯é€‰ï¼Œå¯¹fqnameå¯¹åº”çš„æ–‡ä»¶æ¥è¯´ï¼Œç”¨æ¥æŒ‡å®šåŒ…åå’Œæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åˆ°Androidç³»ç»Ÿæºç æ ¹ç›®å½•çš„è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰åˆ¶å®šï¼Œå‰ç¼€é»˜è®¤æ˜¯ï¼šandroid.hardwareï¼Œç›®å½•æ˜¯Androidæºç çš„æ ¹ç›®å½•ã€‚<br>-o ï¼š å­˜æ”¾hidl-genäº§ç”Ÿçš„ä¸­é—´æ–‡ä»¶çš„è·¯å¾„ã€‚æˆ‘ä»¬æŸ¥çœ‹\hardware\interfaces\light\2.0\Android.bpï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ-oå‚æ•°éƒ½æ˜¯å†™çš„$(genDir),ä¸€èˆ¬éƒ½æ˜¯åœ¨\out\soong.intermediates\hardware\interfaces\light\2.0\ä¸‹é¢ï¼Œæ ¹æ®-Lçš„ä¸åŒï¼Œåé¢äº§ç”Ÿçš„è·¯å¾„å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œæ¯”å¦‚c++ï¼Œé‚£ä¹ˆå°±ä¼šå°±æ˜¯\out\soong.intermediates\hardware\interfaces\light\2.0\genï¼Œå¦‚æœæ˜¯c++-headersï¼Œé‚£ä¹ˆå°±æ˜¯\out\soong.intermediates\hardware\interfaces\light\2.0\android.hardware.light@2.0_genc++_headers\genã€‚</p><p>å¯¹äºå®ä¾‹æ¥è¯´ï¼Œfqnameæ˜¯ï¼šandroid.hardware.light@2.0ï¼ŒåŒ…åæ˜¯android.hardwareï¼Œæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•æ˜¯hardware/interfacesã€‚ä¾‹å­ä¸­çš„å‘½ä»¤ä¼šåœ¨\out\soong.intermediates\hardware\interfaces\light\2.0\ä¸‹é¢äº§ç”Ÿå¯¹åº”çš„c++æ–‡ä»¶ã€‚</p><p>åœ¨\hardware\interfaces\light\2.0\ç›®å½•ä¸‹mmç¼–è¯‘å°†ç”Ÿæˆï¼š</p><p>\system\lib64\android.hardware.light@2.0.so<br>\symbols\vendor\lib64\hw\android.hardware.light@2.0-impl.so<br>\vendor\etc\init\android.hardware.light@2.0-service.rc<br>\vendor\bin\hw\android.hardware.light@2.0-service</p><p>android.hardware.light@2.0-serviceä¸ºhalè¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåœ¨android.hardware.light@2.0-service.rcæ˜¯halè¿›ç¨‹å¯åŠ¨çš„é…ç½®è„šæœ¬æ–‡ä»¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\interfaces\light\<span class="number">2.0</span>\<span class="keyword">default</span>\android.hardware.light@<span class="number">2.0</span>-service.rc]</span><br><span class="line"></span><br><span class="line">service light-hal<span class="number">-2</span><span class="number">-0</span> /vendor/bin/hw/android.hardware.light@<span class="number">2.0</span>-service</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">hal</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">system</span></span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´AndroidOçš„Trebleæ¶æ„ä¸‹ï¼Œæ‰€æœ‰haléƒ½è¿è¡Œåœ¨ç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-16-HIDL-hal-process-.png" alt="Alt text | center"></p><h4 id="ï¼ˆä¸‰ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-å¯åŠ¨è¿‡ç¨‹"><a href="#ï¼ˆä¸‰ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Android O Treble ä¹‹ hwservicemanager å¯åŠ¨è¿‡ç¨‹"></a>ï¼ˆä¸‰ï¼‰ã€Android O Treble ä¹‹ hwservicemanager å¯åŠ¨è¿‡ç¨‹</h4><p>hwservicemanageræ˜¯hidlæœåŠ¡ç®¡ç†ä¸­å¿ƒï¼Œè´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰hidlæœåŠ¡ï¼Œç”±initè¿›ç¨‹å¯åŠ¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/system/core/rootdir/init.rc]</span><br><span class="line">on post-fs</span><br><span class="line">    # Load properties from</span><br><span class="line">    #     /system/build.prop,</span><br><span class="line">    #     /odm/build.prop,</span><br><span class="line">    #     /vendor/build.prop <span class="keyword">and</span></span><br><span class="line">    #     /factory/factory.prop</span><br><span class="line">    load_system_props</span><br><span class="line">    <span class="meta"># start essential services</span></span><br><span class="line">    start logd</span><br><span class="line">    start servicemanager</span><br><span class="line">    start hwservicemanager</span><br><span class="line">    start vndservicemanager</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨æ–‡ä»¶ç³»ç»Ÿåˆšåˆå§‹åŒ–æ²¡å¤šä¹…ï¼Œå°±å¯åŠ¨äº†ç³»ç»Ÿéå¸¸é‡è¦çš„ä¸‰ä¸ªç®¡ç†æœåŠ¡ï¼Œæ¥ä¸‹æ¥åˆ†æhwservicemanagerçš„å¯åŠ¨æµç¨‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\hwservicemanager\hwservicemanager.rc]</span><br><span class="line">service hwservicemanager /system/bin/hwservicemanager</span><br><span class="line">    user system</span><br><span class="line">    disabled</span><br><span class="line">    group system readproc</span><br><span class="line">    critical</span><br><span class="line">    onrestart setprop hwservicemanager.ready <span class="literal">false</span></span><br><span class="line">    onrestart class_restart hal</span><br><span class="line">    onrestart class_restart early_hal</span><br><span class="line">    writepid /dev/cpuset/system-background/tasks</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">animation</span></span></span><br></pre></td></tr></table></figure><p>hwservicemanagerçš„æºç ä½äºsystem\hwservicemanager\sã€‚<br>æˆ‘ä»¬ä»system\hwservicemanager\service.cpp çš„main()å…¥å£å‡½æ•°å¼€å§‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;system\hwservicemanager\service.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    configureRpcThreadpool(<span class="number">1</span>, <span class="literal">true</span> <span class="comment">/* callerWillJoin */</span>);</span><br><span class="line">	<span class="comment">//åˆ›å»ºServiceManagerå¯¹è±¡</span></span><br><span class="line">    ServiceManager *manager = <span class="keyword">new</span> ServiceManager();</span><br><span class="line">	<span class="comment">//å°†ServiceManagerå¯¹è±¡è‡ªèº«æ³¨å†Œåˆ°mServiceMapè¡¨ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (!manager-&gt;add(serviceName, manager)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Failed to register hwservicemanager with itself."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//åˆ›å»ºTokenManagerå¯¹è±¡</span></span><br><span class="line">    TokenManager *tokenManager = <span class="keyword">new</span> TokenManager();</span><br><span class="line">	<span class="comment">//å°†TokenManagerå¯¹è±¡è‡ªèº«æ³¨å†Œåˆ°mServiceMapè¡¨ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (!manager-&gt;add(serviceName, tokenManager)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Failed to register ITokenManager with hwservicemanager."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//å»ºç«‹æ¶ˆæ¯å¾ªç¯</span></span><br><span class="line">    sp&lt;Looper&gt; looper(Looper::prepare(<span class="number">0</span> <span class="comment">/* opts */</span>));</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> binder_fd = <span class="number">-1</span>;</span><br><span class="line">	<span class="comment">//å°†ä¸»çº¿ç¨‹åŠ å…¥binderçº¿ç¨‹æ± ï¼Œå¹¶å¾—åˆ°/dev/hwbinderå¥æŸ„</span></span><br><span class="line">    IPCThreadState::self()-&gt;setupPolling(&amp;binder_fd);</span><br><span class="line">    <span class="keyword">if</span> (binder_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Failed to aquire binder FD. Aborting..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Flush after setupPolling(), to make sure the binder driver</span></span><br><span class="line">    <span class="comment">// knows about this thread handling commands.</span></span><br><span class="line">    IPCThreadState::self()-&gt;flushCommands();</span><br><span class="line">	<span class="comment">//ä¸»çº¿ç¨‹ç›‘å¬EVENT_INPUTï¼Œé€šè¿‡å›è°ƒBinderCallbackå¤„ç†</span></span><br><span class="line">    sp&lt;BinderCallback&gt; cb(<span class="keyword">new</span> BinderCallback);</span><br><span class="line">    <span class="keyword">if</span> (looper-&gt;addFd(binder_fd, Looper::POLL_CALLBACK, Looper::EVENT_INPUT, cb,</span><br><span class="line">            <span class="literal">nullptr</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Failed to add hwbinder FD to Looper. Aborting..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//åˆ›å»ºBnHwServiceManagerå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// Tell IPCThreadState we're the service manager</span></span><br><span class="line">    sp&lt;BnHwServiceManager&gt; service = <span class="keyword">new</span> BnHwServiceManager(manager);</span><br><span class="line">    IPCThreadState::self()-&gt;setTheContextObject(service);</span><br><span class="line">    <span class="comment">// Then tell binder kernel</span></span><br><span class="line">    ioctl(binder_fd, BINDER_SET_CONTEXT_MGR, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Only enable FIFO inheritance for hwbinder</span></span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> remove define when in the kernel</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_SET_INHERIT_FIFO_PRIO    _IO(<span class="meta-string">'b'</span>, 10)</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> rc = ioctl(binder_fd, BINDER_SET_INHERIT_FIFO_PRIO);</span><br><span class="line">    <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">        ALOGE(<span class="string">"BINDER_SET_INHERIT_FIFO_PRIO failed with error %d\n"</span>, rc);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//é€šè¿‡å±æ€§æ–¹å¼å‘ŠçŸ¥å…¶ä»–è¿›ç¨‹ï¼Œhwservicemanagerå·²ç»å°±ç»ª</span></span><br><span class="line">    rc = property_set(<span class="string">"hwservicemanager.ready"</span>, <span class="string">"true"</span>);</span><br><span class="line">    <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Failed to set \"hwservicemanager.ready\" (error %d). "</span>\</span><br><span class="line">              <span class="string">"HAL services will not start!\n"</span>, rc);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//è¿›å…¥æ¶ˆæ¯å¾ªç¯</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        looper-&gt;pollAll(<span class="number">-1</span> <span class="comment">/* timeoutMillis */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hwservicemanagerå¯åŠ¨è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œæœ€é‡è¦çš„å°±æ˜¯ä»¥ä¸‹å‡ è¡Œï¼š</p><h5 id="3-1ã€åˆ›å»ºBnHwServiceManager"><a href="#3-1ã€åˆ›å»ºBnHwServiceManager" class="headerlink" title="3.1ã€åˆ›å»ºBnHwServiceManager"></a>3.1ã€åˆ›å»ºBnHwServiceManager</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;BnHwServiceManager&gt; service = <span class="keyword">new</span> BnHwServiceManager(manager);</span><br><span class="line">IPCThreadState::self()-&gt;setTheContextObject(service);</span><br><span class="line"><span class="comment">// Then tell binder kernel</span></span><br><span class="line">ioctl(binder_fd, BINDER_SET_CONTEXT_MGR, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›‘å¬è¯·æ±‚</span></span><br><span class="line">sp&lt;BinderCallback&gt; cb(<span class="keyword">new</span> BinderCallback);</span><br><span class="line">looper-&gt;addFd(binder_fd, Looper::POLL_CALLBACK, Looper::EVENT_INPUT, cb,<span class="literal">nullptr</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºä¸€ä¸ªbinderæœ¬åœ°å¯¹è±¡BnHwServiceManagerï¼Œç„¶åæ³¨å†Œåˆ°binderé©±åŠ¨ä¸­ï¼Œè®©å…¶ä»–clientè¿›ç¨‹éƒ½å¯ä»¥æ‰¾åˆ°è¿™ä¸ªbinderæœ¬åœ°å¯¹è±¡ï¼Œç„¶åä¸ºå…¶åˆ›å»ºbinderä»£ç†å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯BnHwServiceManagerçš„æˆå‘˜å˜é‡_hidl_mImplä¿å­˜çš„æ˜¯ServiceManagerå®ä¾‹ï¼ŒServiceManagerç±»å®ç°äº†IServiceManageræ¥å£ã€‚<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\system\libhidl\transport\manager\1.1\android.hidl.manager@1.1_genc++\gen\android\hidl\manager\1.1\ServiceManagerAll.cpp]</span><br><span class="line"></span><br><span class="line">BnHwServiceManager::BnHwServiceManager(const ::android::sp&lt;IServiceManager&gt; &amp;_hidl_impl)</span><br><span class="line">        : ::android::hidl::base::V1_0::BnHwBase(_hidl_impl, &quot;android.hidl.manager@1.1&quot;, &quot;IServiceManager&quot;) &#123; </span><br><span class="line">            _hidl_mImpl = _hidl_impl;</span><br><span class="line">            auto prio = ::android::hardware::details::gServicePrioMap.get(_hidl_impl, &#123;SCHED_NORMAL, 0&#125;);</span><br><span class="line">            mSchedPolicy = prio.sched_policy;</span><br><span class="line">            mSchedPriority = prio.prio;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h5 id="3-2ã€IPCThreadState-gt-setTheContextObject-service"><a href="#3-2ã€IPCThreadState-gt-setTheContextObject-service" class="headerlink" title="3.2ã€IPCThreadState-&gt;setTheContextObject(service)"></a>3.2ã€IPCThreadState-&gt;setTheContextObject(service)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†BnHwServiceManagerè®¾ç½®åˆ°IPCThreadStateå†…éƒ¨å¯¹è±¡å½“ä¸­ï¼š</span></span><br><span class="line">sp&lt;BHwBinder&gt;         mContextObject;</span><br><span class="line"><span class="keyword">void</span> IPCThreadState::setTheContextObject(sp&lt;BHwBinder&gt; obj)</span><br><span class="line">&#123;</span><br><span class="line">    mContextObject = obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-3ã€BinderCallback"><a href="#3-3ã€BinderCallback" class="headerlink" title="3.3ã€BinderCallback"></a>3.3ã€BinderCallback</h5><p>é€šè¿‡å¾ªç¯ç›‘å¬binder_fdï¼Œå½“æœ‰è¯·æ±‚æ—¶ä¼šå›è°ƒBinderCallbackçš„handleEvent()å‡½æ•°ï¼Œè¿™éƒ¨åˆ†çš„çŸ¥è¯†è¯·å‚è€ƒ<br><a href="http://zhoujinjian.cc/2017/08/01/Android-7-1-2-Android-N-Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E2%80%93Handler%E3%80%81Looper%E3%80%81Message/">ã€Android 7.1.2 (Android N) Androidæ¶ˆæ¯æœºåˆ¶â€“Handlerã€Looperã€Message åˆ†æã€‘</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;system\core\libutils\Looper.cpp]</span><br><span class="line"><span class="keyword">int</span> Looper::pollInner(<span class="keyword">int</span> timeoutMillis) &#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">int</span> callbackResult = response.request.callback-&gt;handleEvent(fd, events, data);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†è¯·æ±‚ handlePolledCommands<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinderCallback</span> :</span> <span class="keyword">public</span> LooperCallback &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    BinderCallback() &#123;&#125;</span><br><span class="line">    ~BinderCallback() override &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">handleEvent</span><span class="params">(<span class="keyword">int</span> <span class="comment">/* fd */</span>, <span class="keyword">int</span> <span class="comment">/* events */</span>, <span class="keyword">void</span>* <span class="comment">/* data */</span>)</span> override </span>&#123;</span><br><span class="line">        IPCThreadState::self()-&gt;handlePolledCommands();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// Continue receiving callbacks.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>è¿›ä¸€æ­¥é€šè¿‡talkWithDriver() å’Œ executeCommand(cmd) å¤„ç†è¯·æ±‚ï¼Œè¿™ä¸€éƒ¨åˆ†è·Ÿæ™®é€šçš„binderé€šä¿¡å°±æ²¡æœ‰åŒºåˆ«äº†ï¼Œè¿™é‡Œå°±ä¸åšåˆ†æäº†ã€‚<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\libhwbinder\IPCThreadState.cpp]</span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::handlePolledCommands()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">status_t</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        result = getAndExecuteCommand();</span><br><span class="line">    &#125; <span class="keyword">while</span> (mIn.dataPosition() &lt; mIn.dataSize());</span><br><span class="line"></span><br><span class="line">    processPendingDerefs();</span><br><span class="line">    flushCommands();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::getAndExecuteCommand()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">status_t</span> result;</span><br><span class="line">    <span class="keyword">int32_t</span> cmd;</span><br><span class="line"></span><br><span class="line">    result = talkWithDriver();</span><br><span class="line">    <span class="keyword">if</span> (result &gt;= NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> IN = mIn.dataAvail();</span><br><span class="line">        <span class="keyword">if</span> (IN &lt; <span class="keyword">sizeof</span>(<span class="keyword">int32_t</span>)) <span class="keyword">return</span> result;</span><br><span class="line">        cmd = mIn.readInt32();</span><br><span class="line">        .......</span><br><span class="line">        result = executeCommand(cmd);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h5 id="3-4ã€hwservicemanager-ç»§ç»­å…³ç³»"><a href="#3-4ã€hwservicemanager-ç»§ç»­å…³ç³»" class="headerlink" title="3.4ã€hwservicemanager ç»§ç»­å…³ç³»"></a>3.4ã€hwservicemanager ç»§ç»­å…³ç³»</h5><p>hwservicemanagerè¿›ç¨‹ä¸­çš„servicemanagerä½œä¸ºhidlæœåŠ¡ï¼ŒåŒæ ·é€‚ç”¨äº†hwbinderæ¡†æ¶ï¼Œå…¶ç±»ç»§æ‰¿å…³ç³»å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-17-HIDL-binder-bnservicemanager.png" alt="Alt text | center"></p><h4 id="ï¼ˆå››ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-æ·»åŠ æœåŠ¡ï¼ˆaddï¼‰è¿‡ç¨‹"><a href="#ï¼ˆå››ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-æ·»åŠ æœåŠ¡ï¼ˆaddï¼‰è¿‡ç¨‹" class="headerlink" title="ï¼ˆå››ï¼‰ã€Android O Treble ä¹‹ hwservicemanager æ·»åŠ æœåŠ¡ï¼ˆaddï¼‰è¿‡ç¨‹"></a>ï¼ˆå››ï¼‰ã€Android O Treble ä¹‹ hwservicemanager æ·»åŠ æœåŠ¡ï¼ˆaddï¼‰è¿‡ç¨‹</h4><p>è¿™é‡Œä»¥lightæ¨¡å—ä¸ºä¾‹å­ï¼ˆå…¶ä»–æ¨¡å—ç±»ä¼¼ï¼‰:</p><blockquote><p><a href="https://blog.csdn.net/ly890700/article/details/62424821" target="_blank" rel="noopener">Android 7.0 init.rcçš„ä¸€ç‚¹æ”¹å˜</a><br>åœ¨Android 7ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œç³»ç»ŸNativeæœåŠ¡ï¼Œä¸ç®¡å®ƒä»¬çš„å¯æ‰§è¡Œæ–‡ä»¶ä½äºç³»ç»Ÿä»€ä¹ˆä½ç½®éƒ½å®šä¹‰åœ¨æ ¹åˆ†åŒºçš„init.*.rcæ–‡ä»¶ä¸­ã€‚è¿™é€ æˆinitï¼Š.rcæ–‡ä»¶è‡ƒè‚¿åºå¤§ï¼Œç»™ç»´æŠ¤å¸¦æ¥äº†ä¸€äº›ä¸ä¾¿ï¼Œè€Œä¸”å…¶ä¸­å®šä¹‰çš„ä¸€äº›æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¹æœ¬ä¸å­˜åœ¨ã€‚</p><p>ä½†åœ¨Android 7.0ä¸­ï¼Œå¯¹è¯¥æœºåˆ¶åšäº†ä¸€äº›æ”¹å˜ ã€‚</p><p>å•ä¸€çš„initï¼Š.rcï¼Œè¢«æ‹†åˆ†ï¼ŒæœåŠ¡æ ¹æ®å…¶äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½ç½®ï¼ˆ/systemï¼Œ/vendorï¼Œ/odmï¼‰å®šä¹‰åˆ°å¯¹åº”åˆ†åŒºçš„etc/initç›®å½•ä¸­ï¼Œæ¯ä¸ªæœåŠ¡ä¸€ä¸ªrcæ–‡ä»¶ã€‚ä¸è¯¥æœåŠ¡ç›¸å…³çš„è§¦å‘å™¨ã€æ“ä½œç­‰ä¹Ÿå®šä¹‰åœ¨åŒä¸€rcæ–‡ä»¶ä¸­ã€‚</p><ul><li>/system/etc/initï¼ŒåŒ…å«ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡çš„å®šä¹‰ï¼Œå¦‚SurfaceFlingerã€MediaServerã€Logcatdç­‰ã€‚</li><li>/vendor/etc/initï¼Œ SOCå‚å•†é’ˆå¯¹SOCæ ¸å¿ƒåŠŸèƒ½å®šä¹‰çš„ä¸€äº›æœåŠ¡ã€‚æ¯”å¦‚é«˜é€šã€MTKæŸä¸€æ¬¾SOCçš„ç›¸å…³çš„æœåŠ¡ã€‚</li><li>/odm/etc/initï¼ŒOEM/ODMå‚å•†å¦‚å°ç±³ã€åä¸ºã€OPPå…¶äº§å“æ‰€ä½¿ç”¨çš„å¤–è®¾ä»¥åŠå·®å¼‚åŒ–åŠŸèƒ½ç›¸å…³çš„æœåŠ¡ã€‚</li></ul><p>è¿™æ ·çš„ç›®å½•ç»“æ„æ‹†åˆ†ï¼Œä¹Ÿä¸Androidäº§å“çš„å¼€å‘æµç¨‹ç›¸å»åˆï¼Œå‡è½»äº†ç»´æŠ¤çš„è´Ÿæ‹…ã€‚ä¸‹å›¾ä¸ºAndroid7.0<br>æ¨¡æ‹Ÿå™¨/system/etc/initä¸­å®šä¹‰çš„æœåŠ¡ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[æºä»£ç è·¯å¾„]</span><br><span class="line">[-&gt;\hardware\interfaces\light\<span class="number">2.0</span>\<span class="keyword">default</span>\android.hardware.light@<span class="number">2.0</span>-service.rc]</span><br><span class="line">service light-hal<span class="number">-2</span><span class="number">-0</span> /vendor/bin/hw/android.hardware.light@<span class="number">2.0</span>-service</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">hal</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">[ç¼–è¯‘ç”Ÿæˆè·¯å¾„ï¼ˆçœŸæœº /<span class="title">vendor</span>/<span class="title">etc</span>/<span class="title">init</span>ï¼‰]</span></span><br><span class="line"><span class="class">[-&gt;\<span class="title">out</span>\<span class="title">target</span>\<span class="title">product</span>\<span class="title">msm8909go</span>\<span class="title">vendor</span>\<span class="title">etc</span>\<span class="title">init</span>\<span class="title">android</span>.<span class="title">hardware</span>.<span class="title">light</span>@2.0-<span class="title">service</span>.<span class="title">rc</span>]</span></span><br></pre></td></tr></table></figure><p>å¼€æœºä¼šæ³¨å†Œandroid.hardware.light@2.0-serviceï¼Œ ç›´æ¥çœ‹main()å‡½æ•°<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\interfaces\light\<span class="number">2.0</span>\<span class="keyword">default</span>\service.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> defaultPassthroughServiceImplementation&lt;ILight&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€è°ƒç”¨defaultPassthroughServiceImplementation<ilight>()æ¨¡æ¿å‡½æ•°</ilight></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\libhidl\transport\include\hidl\LegacySupport.h]</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Interface</span>&gt;</span></span><br><span class="line"><span class="class">__<span class="title">attribute__</span>((<span class="title">warn_unused_result</span>))</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">registerPassthroughServiceImplementation</span>(</span></span><br><span class="line"><span class="class">        <span class="title">std</span>:</span>:<span class="built_in">string</span> name = <span class="string">"default"</span>) &#123;</span><br><span class="line">    sp&lt;Interface&gt; service = Interface::getService(name, <span class="literal">true</span> <span class="comment">/* getStub */</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">status_t</span> status = service-&gt;registerAsService(name);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Interface</span>&gt;</span></span><br><span class="line"><span class="class">__<span class="title">attribute__</span>((<span class="title">warn_unused_result</span>))</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">defaultPassthroughServiceImplementation</span>(<span class="title">std</span>:</span>:<span class="built_in">string</span> name,</span><br><span class="line">                                            <span class="keyword">size_t</span> maxThreads = <span class="number">1</span>) &#123;</span><br><span class="line">    configureRpcThreadpool(maxThreads, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">status_t</span> result = registerPassthroughServiceImplementation&lt;Interface&gt;(name);</span><br><span class="line">    ......</span><br><span class="line">    joinRpcThreadpool();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Interface</span>&gt;</span></span><br><span class="line"><span class="class">__<span class="title">attribute__</span>((<span class="title">warn_unused_result</span>))</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">defaultPassthroughServiceImplementation</span>(<span class="title">size_t</span> <span class="title">maxThreads</span> = 1) &#123;</span></span><br><span class="line">    <span class="keyword">return</span> defaultPassthroughServiceImplementation&lt;Interface&gt;(<span class="string">"default"</span>, maxThreads);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\hardware\interfaces\light\2.0\android.hardware.light@2.0_genc++\gen\android\hardware\light\2.0\LightAll.cpp]</span><br><span class="line">// static</span><br><span class="line">::android::sp&lt;ILight&gt; ILight::getService(const std::string &amp;serviceName, const bool getStub) &#123;</span><br><span class="line">    using ::android::hardware::defaultServiceManager;</span><br><span class="line">    using ::android::hardware::details::waitForHwService;</span><br><span class="line">    using ::android::hardware::getPassthroughServiceManager;</span><br><span class="line">    using ::android::hardware::Return;</span><br><span class="line">    using ::android::sp;</span><br><span class="line">    using Transport = ::android::hidl::manager::V1_0::IServiceManager::Transport;</span><br><span class="line"></span><br><span class="line">    sp&lt;ILight&gt; iface = nullptr;</span><br><span class="line"></span><br><span class="line">    const sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line"></span><br><span class="line">    Return&lt;Transport&gt; transportRet = sm-&gt;getTransport(ILight::descriptor, serviceName);</span><br><span class="line">    </span><br><span class="line">    Transport transport = transportRet;</span><br><span class="line">    const bool vintfHwbinder = (transport == Transport::HWBINDER);</span><br><span class="line">    const bool vintfPassthru = (transport == Transport::PASSTHROUGH);</span><br><span class="line">    ......</span><br><span class="line">    if (getStub || vintfPassthru || vintfLegacy) &#123;</span><br><span class="line">        const sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; pm = getPassthroughServiceManager();</span><br><span class="line">        if (pm != nullptr) &#123;</span><br><span class="line">            Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                    pm-&gt;get(ILight::descriptor, serviceName);</span><br><span class="line">            if (ret.isOk()) &#123;</span><br><span class="line">                sp&lt;::android::hidl::base::V1_0::IBase&gt; baseInterface = ret;</span><br><span class="line">                if (baseInterface != nullptr) &#123;</span><br><span class="line">                    iface = ILight::castFrom(baseInterface);</span><br><span class="line">                    if (!getStub || trebleTestingOverride) &#123;</span><br><span class="line">                        iface = new BsLight(iface);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return iface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sp<interface>service = Interface::getService(name, true /<em> getStub </em>/)æ‰€ä»¥getStub=true. è¿™é‡Œé€šè¿‡PassthroughServiceManageræ¥è·å–ILightå¯¹è±¡ã€‚å…¶å®æ‰€æœ‰çš„Hal è¿›ç¨‹éƒ½æ˜¯é€šè¿‡PassthroughServiceManageræ¥å¾—åˆ°hidlæœåŠ¡å¯¹è±¡çš„ï¼Œè€Œä½œä¸ºHalè¿›ç¨‹çš„Clientç«¯Frameworkè¿›ç¨‹åœ¨è·å–hidlæœåŠ¡å¯¹è±¡æ—¶ï¼Œéœ€è¦é€šè¿‡halçš„Transportç±»å‹æ¥é€‰æ‹©è·å–æ–¹å¼ã€‚</interface></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[\device\qcom\xxx\manifest.xml]</span><br><span class="line">    &lt;hal format=<span class="string">"hidl"</span>&gt;</span><br><span class="line">        &lt;name&gt;android.hardware.light&lt;/name&gt;</span><br><span class="line">        &lt;transport&gt;hwbinder&lt;/transport&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">2.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;interface&gt;</span><br><span class="line">            &lt;name&gt;ILight&lt;/name&gt;</span><br><span class="line">            &lt;instance&gt;<span class="keyword">default</span>&lt;/instance&gt;</span><br><span class="line">        &lt;/interface&gt;</span><br><span class="line">    &lt;/hal&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-18-HIDL-treble_cpp_legacy_hal_progression.png" alt="Alt text | center"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;system\libhidl\transport\ServiceManagement.cpp]</span><br><span class="line"></span><br><span class="line">sp&lt;IServiceManager1_0&gt; getPassthroughServiceManager() &#123;</span><br><span class="line">    <span class="keyword">return</span> getPassthroughServiceManager1_1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;IServiceManager1_1&gt; getPassthroughServiceManager1_1() &#123;</span><br><span class="line">    <span class="keyword">static</span> sp&lt;PassthroughServiceManager&gt; manager(<span class="keyword">new</span> PassthroughServiceManager());</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PassthroughServiceManager</span> :</span> IServiceManager1_1 &#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">openLibs</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; fqName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="built_in">std</span>::function&lt;<span class="keyword">bool</span> <span class="comment">/* continue */</span>(<span class="keyword">void</span>* <span class="comment">/* handle */</span>,</span></span></span><br><span class="line">                const std::string&amp; /* lib */, const std::string&amp; /* sym */)&gt; eachLib) &#123;</span><br><span class="line">        <span class="comment">//fqName looks like android.hardware.foo@1.0::IFoo</span></span><br><span class="line">        <span class="keyword">size_t</span> idx = fqName.find(<span class="string">"::"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> packageAndVersion = fqName.substr(<span class="number">0</span>, idx);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> ifaceName = fqName.substr(idx + <span class="built_in">strlen</span>(<span class="string">"::"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> prefix = packageAndVersion + <span class="string">"-impl"</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> sym = <span class="string">"HIDL_FETCH_"</span> + ifaceName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> dlMode = RTLD_LAZY;</span><br><span class="line">        <span class="keyword">void</span> *handle = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; paths = &#123;HAL_LIBRARY_PATH_ODM, HAL_LIBRARY_PATH_VENDOR,</span><br><span class="line">                                          HAL_LIBRARY_PATH_VNDK_SP, HAL_LIBRARY_PATH_SYSTEM&#125;;</span><br><span class="line">                                          </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path : paths) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; libs = search(path, prefix, <span class="string">".so"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;lib : libs) &#123;</span><br><span class="line">                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> fullPath = path + lib;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (path != HAL_LIBRARY_PATH_SYSTEM) &#123;</span><br><span class="line">                    handle = android_load_sphal_library(fullPath.c_str(), dlMode);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    handle = dlopen(fullPath.c_str(), dlMode);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (!eachLib(handle, lib, sym)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯ç®€å•çš„åˆ›å»ºäº†ä¸€ä¸ªPassthroughServiceManagerå¯¹è±¡ã€‚PassthroughServiceManagerä¹Ÿå®ç°äº†IServiceManageræ¥å£ã€‚ç„¶åé€šè¿‡PassthroughServiceManagerè¯¢æœåŠ¡ï¼š</p><p>æ ¹æ®ä¼ å…¥çš„fqNameè·å–å½“å‰çš„æ¥å£åILightï¼Œæ‹¼æ¥å‡ºåé¢éœ€è¦æŸ¥æ‰¾çš„å‡½æ•°åHIDL_FETCH_ILightå’Œåº“åå­—android.hardware.light@2.0-impl.so,ç„¶åæŸ¥æ‰¾â€/system/lib64/hw/â€œã€â€/vendor/lib64/hw/â€œã€â€/odm/lib64/hw/â€œä¸‹æ˜¯å¦æœ‰å¯¹åº”çš„soåº“ã€‚æ¥ç€é€šè¿‡dlopenè½½å…¥/vendor/lib/hw/android.hardware.light@2.0-impl.soï¼Œç„¶åé€šè¿‡dlsymæŸ¥æ‰¾å¹¶è°ƒç”¨HIDL_FETCH_ILightå‡½æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[-&gt;\hardware\interfaces\light\<span class="number">2.0</span>\<span class="keyword">default</span>\Light.cpp]</span><br><span class="line"><span class="function">ILight* <span class="title">HIDL_FETCH_ILight</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* <span class="comment">/* name */</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">map</span>&lt;Type, <span class="keyword">light_device_t</span>*&gt; lights;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> <span class="keyword">const</span> &amp;pair : kLogicalLights) &#123;</span><br><span class="line">        Type type = pair.first;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* name = pair.second;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">light_device_t</span>* light = getLightDevice(name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (light != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            lights[type] = light;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lights.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Log information, but still return new Light.</span></span><br><span class="line">        <span class="comment">// Some devices may not have any lights.</span></span><br><span class="line">        ALOGI(<span class="string">"Could not open any lights."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Light(<span class="built_in">std</span>::move(lights));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-19-HIDL-binder-ILight-so-dlopen.png" alt="Alt text | center"></p><h6 id="4-1ã€ILight-registerAsService"><a href="#4-1ã€ILight-registerAsService" class="headerlink" title="4.1ã€ILight::registerAsService()"></a>4.1ã€ILight::registerAsService()</h6><p>é¦–å…ˆä¼šè°ƒç”¨registerAsService()æ³¨å†ŒæœåŠ¡ï¼Œç„¶åjoinRpcThreadpool()åŠ å…¥çº¿ç¨‹æ± <br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\hardware\interfaces\light\<span class="number">2.0</span>\android.hardware.light@<span class="number">2.0</span>_genc++\gen\android\hardware\light\<span class="number">2.0</span>\LightAll.cpp]</span><br><span class="line"></span><br><span class="line">::android::<span class="keyword">status_t</span> ILight::registerAsService(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName) &#123;</span><br><span class="line">    ::android::hardware::details::onRegistration(<span class="string">"android.hardware.light@2.0"</span>, <span class="string">"ILight"</span>, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ::android::sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm</span><br><span class="line">            = ::android::hardware::defaultServiceManager();</span><br><span class="line">    <span class="keyword">if</span> (sm == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ::android::INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line">    ::android::hardware::Return&lt;<span class="keyword">bool</span>&gt; ret = sm-&gt;add(serviceName.c_str(), <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> ret.isOk() &amp;&amp; ret ? ::android::OK : ::android::UNKNOWN_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡defaultServiceManager()è·å–IServiceManagerï¼Œæ¥ç€add()æ·»åŠ æœåŠ¡</p><p>é¦–å…ˆæ ¹æ®å±æ€§â€hwservicemanager.readyâ€å€¼åˆ¤æ–­hwservicemanagerè¿›ç¨‹æ˜¯å¦å¯åŠ¨å°±ç»ªï¼Œå¦‚æœhwservicemanagerå·²ç»å¯åŠ¨ï¼Œé‚£ä¹ˆé€šè¿‡fromBinder<iservicemanager , bphwservicemanager,="" bnhwservicemanager="">( ProcessState::self()-&gt;getContextObject(NULL))æ¥è·å–hwservicemanagerçš„ä»£ç†ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\libhidl\transport\ServiceManagement.cpp]</span><br><span class="line">sp&lt;IServiceManager1_0&gt; defaultServiceManager() &#123;</span><br><span class="line">    <span class="keyword">return</span> defaultServiceManager1_1();</span><br><span class="line">&#125;</span><br><span class="line">sp&lt;IServiceManager1_1&gt; defaultServiceManager1_1() &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        AutoMutex _l(details::gDefaultServiceManagerLock);</span><br><span class="line">        <span class="keyword">if</span> (details::gDefaultServiceManager != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> details::gDefaultServiceManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (access(<span class="string">"/dev/hwbinder"</span>, F_OK|R_OK|W_OK) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        waitForHwServiceManager();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (details::gDefaultServiceManager == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            details::gDefaultServiceManager =</span><br><span class="line">                    fromBinder&lt;IServiceManager1_1, BpHwServiceManager, BnHwServiceManager&gt;(</span><br><span class="line">                        ProcessState::self()-&gt;getContextObject(<span class="literal">NULL</span>));</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> details::gDefaultServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></iservicemanager></p><p>é¦–å…ˆçœ‹çœ‹ProcessState::getContextObject()</p><p>å› æ­¤é€šè¿‡ProcessState::self()-&gt;getContextObject(NULL)å°†å¾—åˆ°ä¸€ä¸ªBpHwBinderå¯¹è±¡ï¼Œç„¶åé€šè¿‡fromBinder<iservicemanager , bphwservicemanager,="" bnhwservicemanager="">è¿›è¡Œè½¬æ¢ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\libhwbinder\ProcessState.cpp]</span><br><span class="line">sp&lt;IBinder&gt; ProcessState::getContextObject(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; <span class="comment">/*caller*/</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> getStrongProxyForHandle(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(<span class="keyword">int32_t</span> handle)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;IBinder&gt; result;</span><br><span class="line"></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">    handle_entry* e = lookupHandleLocked(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        IBinder* b = e-&gt;binder;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span> || !e-&gt;refs-&gt;attemptIncWeak(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            b = <span class="keyword">new</span> BpHwBinder(handle);</span><br><span class="line">            e-&gt;binder = b;</span><br><span class="line">            <span class="keyword">if</span> (b) e-&gt;refs = b-&gt;getWeakRefs();</span><br><span class="line">            result = b;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.force_set(b);</span><br><span class="line">            e-&gt;refs-&gt;decWeak(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></iservicemanager></p><p>ç¬¬ä¸€æ¬¡è°ƒç”¨ä¼šè°ƒç”¨fromBinder()å‡½æ•°ï¼Œåœ¨è¿™é‡Œå°†åˆ›å»ºä¸€ä¸ªBpHwServiceManagerå¯¹è±¡ï¼ŒProcessState::self()-&gt;getContextObject(NULL)å¦‚æœè¿”å›çš„æ˜¯è¿œç¨‹binderå¯¹è±¡ï¼Œé‚£ä¹ˆåŸºäºBpHwBinderåˆ›å»ºBpHwServiceManagerå¯¹è±¡ï¼ŒBpHwBinderè´Ÿè´£æ•°æ®ä¼ è¾“ï¼Œè€ŒBpHwServiceManageræœåŠ¡æ•°æ®ä¸šåŠ¡ï¼Œä¸šåŠ¡æ•°æ®åœ¨BpHwServiceManagerå±‚æ‰“åŒ…å¥½åï¼Œè½¬äº¤ç»™BpHwBinderå‘é€ã€‚å¦‚æœgetContextObject(NULL)è¿”å›çš„æ˜¯æœ¬åœ°binderå¯¹è±¡ï¼Œé‚£ä¹ˆå°†è¿™ä¸ªæœ¬åœ°binderå¯¹è±¡å¼ºåˆ¶è½¬æ¢ä¸ºBnHwBaseç±»å‹ï¼Œä»ä¸Šå›¾å¯çŸ¥BnHwBaseç»§æ‰¿BHwBinderç±»ï¼ŒBHwBinderå³æ˜¯æœ¬åœ°binderå¯¹è±¡ã€‚<br>static_cast<bnhwbase *>(binderIface.get()) ç„¶åé€šè¿‡BnHwBaseçš„getImpl()å‡½æ•°å¾—åˆ°å…¶ä¸šåŠ¡å®ç°å¯¹è±¡IBaseã€‚<br>sp<ibase>base =static_cast<bnhwbase *>(binderIface.get())-&gt;getImpl();</bnhwbase></ibase></bnhwbase></p><p>ç„¶åæ£€æŸ¥ä¸šåŠ¡æ¥å£æ˜¯å¦ç›¸åŒï¼š<br>if (details::canCastInterface(base.get(),IType::descriptor))<br>å¦‚æœä¸šåŠ¡æ¥å£ç±»å‹ç›¸åŒï¼Œé‚£ä¹ˆå†æ¬¡å°†è¿™ä¸ªæœ¬åœ°binderå¯¹è±¡è½¬æ¢ä¸ºå­™ç±»BnHwServiceManagerç±»å‹ï¼š<br>BnHwServiceManager<em> stub = static_cast&lt;BnHwServiceManager</em>&gt;(binderIface.get());<br>ç„¶åè¿”å›ä¸šåŠ¡å®ç°ç±»å¯¹è±¡ServiceManagerå¯¹è±¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\libhidl\transport\include\hidl\HidlBinderSupport.h]</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> IType, <span class="keyword">typename</span> ProxyType, <span class="keyword">typename</span> StubType&gt;</span><br><span class="line">sp&lt;IType&gt; fromBinder(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; binderIface) &#123;</span><br><span class="line">    <span class="keyword">using</span> ::android::hidl::base::V1_0::IBase;</span><br><span class="line">    <span class="keyword">using</span> ::android::hidl::base::V1_0::BnHwBase;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (binderIface.get() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (binderIface-&gt;localBinder() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProxyType(binderIface);</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;IBase&gt; base = <span class="keyword">static_cast</span>&lt;BnHwBase*&gt;(binderIface.get())-&gt;getImpl();</span><br><span class="line">    <span class="keyword">if</span> (details::canCastInterface(base.get(), IType::descriptor)) &#123;</span><br><span class="line">        StubType* stub = <span class="keyword">static_cast</span>&lt;StubType*&gt;(binderIface.get());</span><br><span class="line">        <span class="keyword">return</span> stub-&gt;getImpl();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ getImpl()å‡½æ•°å®ç°ï¼Œè¿”å›çš„æ˜¯<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++_headers\gen\android\hidl\manager\<span class="number">1.0</span>\BnHwServiceManager.h]</span><br><span class="line"></span><br><span class="line">    ::android::sp&lt;IServiceManager&gt; _hidl_mImpl;</span><br><span class="line">    </span><br><span class="line">    ::android::sp&lt;IServiceManager&gt; getImpl() &#123; <span class="keyword">return</span> _hidl_mImpl; &#125;;</span><br></pre></td></tr></table></figure><p></p><h6 id="4-2ã€sm-gt-add-serviceName-c-str-this-æ·»åŠ light-service"><a href="#4-2ã€sm-gt-add-serviceName-c-str-this-æ·»åŠ light-service" class="headerlink" title="4.2ã€sm-&gt;add(serviceName.c_str(), this) æ·»åŠ light service"></a>4.2ã€sm-&gt;add(serviceName.c_str(), this) æ·»åŠ light service</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp]</span><br><span class="line"></span><br><span class="line">::android::hardware::Return&lt;<span class="keyword">bool</span>&gt; BpHwServiceManager::add(<span class="keyword">const</span> ::android::hardware::hidl_string&amp; name, <span class="keyword">const</span> ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&amp; service)&#123;</span><br><span class="line">    ::android::hardware::Return&lt;<span class="keyword">bool</span>&gt;  _hidl_out = ::android::hidl::manager::V1_0::BpHwServiceManager::_hidl_add(<span class="keyword">this</span>, <span class="keyword">this</span>, name, service);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _hidl_out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::android::hardware::Return&lt;<span class="keyword">bool</span>&gt; BpHwServiceManager::_hidl_add(::android::hardware::IInterface *_hidl_this, ::android::hardware::details::HidlInstrumentor *_hidl_this_instrumentor, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; name, <span class="keyword">const</span> ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&amp; service) &#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    ::android::hardware::Parcel _hidl_data;</span><br><span class="line">    ::android::hardware::Parcel _hidl_reply;</span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err;</span><br><span class="line">    ::android::hardware::Status _hidl_status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    ::android::hardware::ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    _hidl_err = ::android::hardware::IInterface::asBinder(_hidl_this)-&gt;transact(<span class="number">2</span> <span class="comment">/* add */</span>, _hidl_data, &amp;_hidl_reply);</span><br><span class="line">   .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\libhwbinder\BpHwBinder.cpp]</span><br><span class="line"><span class="keyword">status_t</span> BpHwBinder::transact(</span><br><span class="line">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags, TransactCallback <span class="comment">/*callback*/</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Once a binder has died, it will never come back to life.</span></span><br><span class="line">    <span class="keyword">if</span> (mAlive) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> status = IPCThreadState::self()-&gt;transact(</span><br><span class="line">            mHandle, code, data, reply, flags);</span><br><span class="line">        <span class="keyword">if</span> (status == DEAD_OBJECT) mAlive = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/system/libhwbinder/IPCThreadState.cpp]</span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::transact(<span class="keyword">int32_t</span> handle,</span><br><span class="line">                                  <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data,</span><br><span class="line">                                  Parcel* reply, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">status_t</span> err = data.errorCheck();</span><br><span class="line"></span><br><span class="line">    flags |= TF_ACCEPT_FDS;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        err = writeTransactionData(BC_TRANSACTION_SG, flags, handle, code, data, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; TF_ONE_WAY) == <span class="number">0</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">            err = waitForResponse(reply);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Parcel fakeReply;</span><br><span class="line">            err = waitForResponse(&amp;fakeReply);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = waitForResponse(<span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>waitForResponse()ä¼šé€šè¿‡åº•å±‚binder é©±åŠ¨è¿›å…¥åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ç›‘å¬æ¶ˆæ¯æ¥åˆ°å¤„ç†è¿‡åä¼šè°ƒç”¨onTransact()å‡½æ•°</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-20-HIDL-ioctl-kernel.png.png" alt="Alt text | center"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/system/libhwbinder/Binder.cpp]</span><br><span class="line">status_t BHwBinder::transact(</span><br><span class="line">    uint32_t code, const Parcel&amp; data, Parcel* reply, uint32_t flags, TransactCallback callback)</span><br><span class="line">&#123;</span><br><span class="line">    data.setDataPosition(0);</span><br><span class="line"></span><br><span class="line">    status_t err = NO_ERROR;</span><br><span class="line">    switch (code) &#123;</span><br><span class="line">        default:</span><br><span class="line">            err = onTransact(code, data, reply, flags,</span><br><span class="line">                    [&amp;](auto &amp;replyParcel) &#123;</span><br><span class="line">                        replyParcel.setDataPosition(0);</span><br><span class="line">                        if (callback != NULL) &#123;</span><br><span class="line">                            callback(replyParcel);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp]</span><br><span class="line">::android::<span class="keyword">status_t</span> BnHwServiceManager::onTransact(</span><br><span class="line">        <span class="keyword">uint32_t</span> _hidl_code,</span><br><span class="line">        <span class="keyword">const</span> ::android::hardware::Parcel &amp;_hidl_data,</span><br><span class="line">        ::android::hardware::Parcel *_hidl_reply,</span><br><span class="line">        <span class="keyword">uint32_t</span> _hidl_flags,</span><br><span class="line">        TransactCallback _hidl_cb) &#123;</span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err = ::android::OK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (_hidl_code) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span> <span class="comment">/* add */</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> _hidl_is_oneway = _hidl_flags &amp; ::android::hardware::IBinder::FLAG_ONEWAY;</span><br><span class="line">            <span class="keyword">if</span> (_hidl_is_oneway != <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> ::android::UNKNOWN_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _hidl_err = ::android::hidl::manager::V1_0::BnHwServiceManager::_hidl_add(<span class="keyword">this</span>, _hidl_data, _hidl_reply, _hidl_cb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">::android::<span class="keyword">status_t</span> BnHwServiceManager::_hidl_add(</span><br><span class="line">        ::android::hidl::base::V1_0::BnHwBase* _hidl_this,</span><br><span class="line">        <span class="keyword">const</span> ::android::hardware::Parcel &amp;_hidl_data,</span><br><span class="line">        ::android::hardware::Parcel *_hidl_reply,</span><br><span class="line">        TransactCallback _hidl_cb) &#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ::android::hardware::hidl_string* name;</span><br><span class="line">    ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt; service;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.readBuffer(<span class="keyword">sizeof</span>(*name), &amp;_hidl_name_parent,  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">void</span> **&gt;(&amp;name));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readEmbeddedFromParcel(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::android::hardware::hidl_string &amp;&gt;(*name),</span><br><span class="line">            _hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        ::android::sp&lt;::android::hardware::IBinder&gt; _hidl_service_binder;</span><br><span class="line">        _hidl_err = _hidl_data.readNullableStrongBinder(&amp;_hidl_service_binder);</span><br><span class="line">        <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">        service = ::android::hardware::fromBinder&lt;::android::hidl::base::V1_0::IBase,::android::hidl::base::V1_0::BpHwBase,::android::hidl::base::V1_0::BnHwBase&gt;(_hidl_service_binder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    atrace_begin(ATRACE_TAG_HAL, <span class="string">"HIDL::IServiceManager::add::server"</span>);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> _hidl_out_success = <span class="keyword">static_cast</span>&lt;BnHwServiceManager*&gt;(_hidl_this)-&gt;_hidl_mImpl-&gt;add(*name, service);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> _hidl_err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„çš„_hidl_mImplå³ä¹‹å‰å¾—åˆ°çš„::android::sp<iservicemanager>==_hidl_mImpl== å¯¹è±¡ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨</iservicemanager></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\hwservicemanager\ServiceManager.cpp]</span><br><span class="line">Return&lt;<span class="keyword">bool</span>&gt; ServiceManager::add(<span class="keyword">const</span> hidl_string&amp; name, <span class="keyword">const</span> sp&lt;IBase&gt;&amp; service) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">pid_t</span> pid = IPCThreadState::self()-&gt;getCallingPid();</span><br><span class="line">    <span class="keyword">auto</span> context = mAcl.getContext(pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> ret = service-&gt;interfaceChain([&amp;](<span class="keyword">const</span> <span class="keyword">auto</span> &amp;interfaceChain) &#123;</span><br><span class="line">    </span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; interfaceChain.size(); i++) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> fqName = interfaceChain[i];</span><br><span class="line"></span><br><span class="line">            PackageInterfaceMap &amp;ifaceMap = mServiceMap[fqName];</span><br><span class="line">            HidlService *hidlService = ifaceMap.lookup(name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hidlService == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                ifaceMap.insertService(</span><br><span class="line">                    <span class="built_in">std</span>::make_unique&lt;HidlService&gt;(fqName, name, service, pid));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (hidlService-&gt;getService() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    <span class="keyword">auto</span> ret = hidlService-&gt;getService()-&gt;unlinkToDeath(<span class="keyword">this</span>);</span><br><span class="line">                    ret.isOk(); <span class="comment">// ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">                hidlService-&gt;setService(service, pid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ifaceMap.sendPackageRegistrationNotification(fqName, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> linkRet = service-&gt;linkToDeath(<span class="keyword">this</span>, <span class="number">0</span> <span class="comment">/*cookie*/</span>);</span><br><span class="line">        linkRet.isOk(); <span class="comment">// ignore</span></span><br><span class="line">        isValidService = <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> isValidService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæˆæ’å…¥åˆ°PackageInterfaceMap &amp;ifaceMap å¯¹è±¡ä¸­ï¼Œå¹¶æ·»åŠ ä¸€äº›ç›‘å¬ã€‚ä¹‹åå°±å¯ä»¥æŸ¥è¯¢åˆ°light serviceäº†ã€‚</p><h6 id="4-3ã€joinRpcThreadpool"><a href="#4-3ã€joinRpcThreadpool" class="headerlink" title="4.3ã€joinRpcThreadpool()"></a>4.3ã€joinRpcThreadpool()</h6><p>åŠ å…¥çº¿ç¨‹æ± ï¼Œè‡³æ­¤Light service å°±å¯åŠ¨èµ·æ¥äº†ï¼Œå¯ä»¥ç­‰å¾…Clientçš„è¯·æ±‚äº†<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\system\libhidl\transport\HidlTransportSupport.cpp]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">joinRpcThreadpool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO(b/32756130) this should be transport-dependent</span></span><br><span class="line">    joinBinderRpcThreadpool();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[-&gt;\system\libhidl\transport\HidlBinderSupport.cpp]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">joinBinderRpcThreadpool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[-&gt;\system\libhwbinder\IPCThreadState.cpp]</span><br><span class="line"><span class="keyword">void</span> IPCThreadState::joinThreadPool(<span class="keyword">bool</span> isMain)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    mOut.writeInt32(isMain ? BC_ENTER_LOOPER : BC_REGISTER_LOOPER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        processPendingDerefs();</span><br><span class="line">        <span class="comment">// now get the next command to be processed, waiting if necessary</span></span><br><span class="line">        result = getAndExecuteCommand();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">while</span> (result != -ECONNREFUSED &amp;&amp; result != -EBADF);</span><br><span class="line">    </span><br><span class="line">    mOut.writeInt32(BC_EXIT_LOOPER);</span><br><span class="line">    talkWithDriver(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ°æ­¤å°±å®Œæˆäº†hidlæœåŠ¡æ³¨å†Œã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-21-HIDL-hwbinder-ILight-add.png" alt="Alt text | center"></p><h4 id="ï¼ˆäº”ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-æŸ¥è¯¢æœåŠ¡ï¼ˆgetï¼‰è¿‡ç¨‹"><a href="#ï¼ˆäº”ï¼‰ã€Android-O-Treble-ä¹‹-hwservicemanager-æŸ¥è¯¢æœåŠ¡ï¼ˆgetï¼‰è¿‡ç¨‹" class="headerlink" title="ï¼ˆäº”ï¼‰ã€Android O Treble ä¹‹ hwservicemanager æŸ¥è¯¢æœåŠ¡ï¼ˆgetï¼‰è¿‡ç¨‹"></a>ï¼ˆäº”ï¼‰ã€Android O Treble ä¹‹ hwservicemanager æŸ¥è¯¢æœåŠ¡ï¼ˆgetï¼‰è¿‡ç¨‹</h4><p>è¿™é‡Œä»¥lightæ¨¡å—ä¸ºä¾‹å­ï¼ˆå…¶ä»–æ¨¡å—ç±»ä¼¼ï¼‰ï¼š<br>é€šè¿‡å‰é¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼ŒHalè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šå‘hwservicemanagerè¿›ç¨‹æ³¨å†ŒhidlæœåŠ¡ï¼Œé‚£ä¹ˆå½“Framework Serveréœ€è¦é€šè¿‡halè®¿é—®ç¡¬ä»¶è®¾å¤‡æ—¶ï¼Œé¦–å…ˆéœ€è¦æŸ¥è¯¢å¯¹åº”çš„hidlæœåŠ¡ï¼Œé‚£ä¹ˆClientè¿›ç¨‹æ˜¯å¦‚ä½•æŸ¥è¯¢hidlæœåŠ¡çš„å‘¢ï¼Ÿè¿™ç¯‡æ–‡ç« å°†å±•å¼€åˆ†æï¼Œè¿™é‡Œå†æ¬¡ä»¥ILightä¸ºä¾‹è¿›è¡Œå±•å¼€ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-22-android-hwservicemanager-get.png" alt="Alt text | center"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/base/services/core/java/com/android/server/lights/LightsService.java]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setLight_native</span><span class="params">(<span class="keyword">int</span> light, <span class="keyword">int</span> color, <span class="keyword">int</span> mode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> onMS, <span class="keyword">int</span> offMS, <span class="keyword">int</span> brightnessMode)</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/base/services/core/jni/com_android_server_lights_LightsService.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setLight_native</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        JNIEnv* <span class="comment">/* env */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobject <span class="comment">/* clazz */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint light,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint colorARGB,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint flashMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint onMS,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint offMS,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint brightnessMode)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    sp&lt;ILight&gt; hal = LightHal::associate();</span><br><span class="line">    .......</span><br><span class="line">    Type type = <span class="keyword">static_cast</span>&lt;Type&gt;(light);</span><br><span class="line">    LightState state = constructState(</span><br><span class="line">        colorARGB, flashMode, onMS, offMS, brightnessMode);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        android::base::Timer t;</span><br><span class="line">        Return&lt;Status&gt; ret = hal-&gt;setLight(type, state);</span><br><span class="line">        processReturn(ret, type, state);</span><br><span class="line">        <span class="keyword">if</span> (t.duration() &gt; <span class="number">50</span>ms) ALOGD(<span class="string">"Excessive delay setting light"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>associate() ä¼šè·å–ILight::getService();è¿™é‡Œé€šè¿‡ILight::getService()å‡½æ•°æ¥æŸ¥è¯¢ILightè¿™ä¸ªHIDLæœåŠ¡ï¼Œç”±äºè¿™é‡Œæ²¡æœ‰ä¼ é€’ä»»ä½•å‚æ•°ï¼Œå› æ­¤å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\hardware\interfaces\light\<span class="number">2.0</span>\android.hardware.light@<span class="number">2.0</span>_genc++_headers\gen\android\hardware\light\<span class="number">2.0</span>\ILight.h]</span><br><span class="line">    <span class="keyword">static</span> ::android::sp&lt;ILight&gt; getService(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName=<span class="string">"default"</span>, <span class="keyword">bool</span> getStub=<span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œè¿™é‡Œçš„getStubä¸ºfalseï¼Œè¯´æ˜åŠ è½½hidlæœåŠ¡æ–¹å¼æ˜¯ç”±å½“å‰hidlæœåŠ¡çš„transportç±»å‹å†³å®šã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[\device\qcom\xxx\manifest.xml]</span><br><span class="line">    &lt;hal format=<span class="string">"hidl"</span>&gt;</span><br><span class="line">        &lt;name&gt;android.hardware.light&lt;/name&gt;</span><br><span class="line">        &lt;transport&gt;hwbinder&lt;/transport&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">2.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;interface&gt;</span><br><span class="line">            &lt;name&gt;ILight&lt;/name&gt;</span><br><span class="line">            &lt;instance&gt;<span class="keyword">default</span>&lt;/instance&gt;</span><br><span class="line">        &lt;/interface&gt;</span><br><span class="line">    &lt;/hal&gt;</span><br></pre></td></tr></table></figure><p>ç”±äºILightçš„transportæ˜¯hwbinderç±»å‹ï¼Œé‚£ä¹ˆå°†ä»hwservicemanagerä¸­æŸ¥è¯¢hidlæœåŠ¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[\out\soong\.intermediates\hardware\interfaces\light\<span class="number">2.0</span>\android.hardware.light@<span class="number">2.0</span>_genc++\gen\android\hardware\light\<span class="number">2.0</span>\LightAll.cpp]</span><br><span class="line"></span><br><span class="line"><span class="comment">// static</span></span><br><span class="line">::android::sp&lt;ILight&gt; ILight::getService(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName, <span class="keyword">const</span> <span class="keyword">bool</span> getStub) &#123;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::defaultServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::details::waitForHwService;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::getPassthroughServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::Return;</span><br><span class="line">    <span class="keyword">using</span> ::android::sp;</span><br><span class="line">    <span class="keyword">using</span> Transport = ::android::hidl::manager::V1_0::IServiceManager::Transport;</span><br><span class="line"></span><br><span class="line">    sp&lt;ILight&gt; iface = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line"></span><br><span class="line">    Return&lt;Transport&gt; transportRet = sm-&gt;getTransport(ILight::descriptor, serviceName);</span><br><span class="line">    </span><br><span class="line">    Transport transport = transportRet;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfHwbinder = (transport == Transport::HWBINDER);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfPassthru = (transport == Transport::PASSTHROUGH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> tries = <span class="number">0</span>; !getStub &amp;&amp; (vintfHwbinder || (vintfLegacy &amp;&amp; tries == <span class="number">0</span>)); tries++) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (vintfHwbinder &amp;&amp; tries &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            waitForHwService(ILight::descriptor, serviceName);</span><br><span class="line">        &#125;</span><br><span class="line">        Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                sm-&gt;get(ILight::descriptor, serviceName);</span><br><span class="line"></span><br><span class="line">        sp&lt;::android::hidl::base::V1_0::IBase&gt; base = ret;</span><br><span class="line"></span><br><span class="line">        Return&lt;sp&lt;ILight&gt;&gt; castRet = ILight::castFrom(base, <span class="literal">true</span> <span class="comment">/* emitError */</span>);</span><br><span class="line"></span><br><span class="line">        iface = castRet;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> iface;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getStub || vintfPassthru || vintfLegacy) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; pm = getPassthroughServiceManager();</span><br><span class="line">        <span class="keyword">if</span> (pm != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                    pm-&gt;get(ILight::descriptor, serviceName);</span><br><span class="line">            <span class="keyword">if</span> (ret.isOk()) &#123;</span><br><span class="line">                sp&lt;::android::hidl::base::V1_0::IBase&gt; baseInterface = ret;</span><br><span class="line">                <span class="keyword">if</span> (baseInterface != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    iface = ILight::castFrom(baseInterface);</span><br><span class="line">                    <span class="keyword">if</span> (!getStub || trebleTestingOverride) &#123;</span><br><span class="line">                        iface = <span class="keyword">new</span> BsLight(iface);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡sm-&gt;get(ILight::descriptor, serviceName)æŸ¥è¯¢ILightè¿™ä¸ªhidlæœåŠ¡ï¼Œå¾—åˆ°IBaseå¯¹è±¡åï¼Œåœ¨é€šè¿‡ILight::castFromè½¬æ¢ä¸ºILightå¯¹è±¡ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-23-HIDL-castFrom.png" alt="Alt text | center"></p><h5 id="5-1ã€æœåŠ¡æŸ¥è¯¢-hidl-get"><a href="#5-1ã€æœåŠ¡æŸ¥è¯¢-hidl-get" class="headerlink" title="5.1ã€æœåŠ¡æŸ¥è¯¢_hidl_get()"></a>5.1ã€æœåŠ¡æŸ¥è¯¢_hidl_get()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.1</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.1</span>\ServiceManagerAll.cpp]</span><br><span class="line">::android::hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; BpHwServiceManager::get(<span class="keyword">const</span> ::android::hardware::hidl_string&amp; fqName, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; name)&#123;</span><br><span class="line">    ::android::hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt;  _hidl_out = ::android::hidl::manager::V1_0::BpHwServiceManager::_hidl_get(<span class="keyword">this</span>, <span class="keyword">this</span>, fqName, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _hidl_out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\system\libhidl\transport\manager\1.0\android.hidl.manager@1.0_genc++\gen\android\hidl\manager\1.0\ServiceManagerAll.cpp]</span><br><span class="line"></span><br><span class="line">::android::hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; BpHwServiceManager::_hidl_get(::android::hardware::IInterface *_hidl_this, ::android::hardware::details::HidlInstrumentor *_hidl_this_instrumentor, const ::android::hardware::hidl_string&amp; fqName, const ::android::hardware::hidl_string&amp; name) &#123;</span><br><span class="line">    </span><br><span class="line">    ::android::hardware::Parcel _hidl_data;</span><br><span class="line">    ::android::hardware::Parcel _hidl_reply;</span><br><span class="line">    ::android::status_t _hidl_err;</span><br><span class="line">    ::android::hardware::Status _hidl_status;</span><br><span class="line"></span><br><span class="line">    ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt; _hidl_out_service;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeInterfaceToken(BpHwServiceManager::descriptor);</span><br><span class="line"></span><br><span class="line">    size_t _hidl_fqName_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeBuffer(&amp;fqName, sizeof(fqName), &amp;_hidl_fqName_parent);</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::writeEmbeddedToParcel(</span><br><span class="line">            fqName,</span><br><span class="line">            &amp;_hidl_data,</span><br><span class="line">            _hidl_fqName_parent,</span><br><span class="line">            0 /* parentOffset */);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    size_t _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeBuffer(&amp;name, sizeof(name), &amp;_hidl_name_parent);</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::writeEmbeddedToParcel(</span><br><span class="line">            name,</span><br><span class="line">            &amp;_hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            0 /* parentOffset */);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::IInterface::asBinder(_hidl_this)-&gt;transact(1 /* get */, _hidl_data, &amp;_hidl_reply);</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readFromParcel(&amp;_hidl_status, _hidl_reply);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        ::android::sp&lt;::android::hardware::IBinder&gt; _hidl__hidl_out_service_binder;</span><br><span class="line">        _hidl_err = _hidl_reply.readNullableStrongBinder(&amp;_hidl__hidl_out_service_binder);</span><br><span class="line"></span><br><span class="line">        _hidl_out_service = ::android::hardware::fromBinder&lt;::android::hidl::base::V1_0::IBase,::android::hidl::base::V1_0::BpHwBase,::android::hidl::base::V1_0::BnHwBase&gt;(_hidl__hidl_out_service_binder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_status.setFromStatusT(_hidl_err);</span><br><span class="line">    return ::android::hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt;(_hidl_out_service);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹å’Œhidl æ·»åŠ æœåŠ¡è¿‡ç¨‹å®Œå…¨ä¸€è‡´ï¼Œå°±æ˜¯ä¸€ä¸ªä»BpHwServiceManager â€“&gt; BnHwServiceManager â€“&gt; ServiceManagerçš„è¿‡ç¨‹ã€‚ä½†éœ€è¦æ³¨æ„ï¼ŒBpHwServiceManagerå¾—åˆ°BnHwServiceManagerè¿”å›è¿‡æ¥çš„binderä»£ç†åï¼Œä¼šé€šè¿‡fromBinderå‡½æ•°è¿›è¡Œå¯¹è±¡è½¬æ¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::android::hardware::fromBinder&lt;::android::hidl::base::V1_0::IBase,::android::hidl::base::V1_0::BpHwBase,::android::hidl::base::V1_0::BnHwBase&gt;(_hidl__hidl_out_service_binder)</span><br></pre></td></tr></table></figure><p>hwservicemanagerå°†ILightçš„binderä»£ç†BpHwBinderå‘ç»™Framework Serverè¿›ç¨‹ï¼ŒFramework Serverè¿›ç¨‹æ‹¿åˆ°çš„ä¾ç„¶æ˜¯ILightçš„binderä»£ç†BpHwBinderå¯¹è±¡ï¼Œå› æ­¤åœ¨fromBinderå‡½æ•°ä¸­å°†åˆ›å»ºBpHwBaseå¯¹è±¡æ¥å°è£…BpHwBinderã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp]</span><br><span class="line"></span><br><span class="line">::android::<span class="keyword">status_t</span> BnHwServiceManager::_hidl_get(</span><br><span class="line">        ::android::hidl::base::V1_0::BnHwBase* _hidl_this,</span><br><span class="line">        <span class="keyword">const</span> ::android::hardware::Parcel &amp;_hidl_data,</span><br><span class="line">        ::android::hardware::Parcel *_hidl_reply,</span><br><span class="line">        TransactCallback _hidl_cb) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ::android::hardware::hidl_string* fqName;</span><br><span class="line">    <span class="keyword">const</span> ::android::hardware::hidl_string* name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_fqName_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.readBuffer(<span class="keyword">sizeof</span>(*fqName), &amp;_hidl_fqName_parent,  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">void</span> **&gt;(&amp;fqName));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readEmbeddedFromParcel(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::android::hardware::hidl_string &amp;&gt;(*fqName),</span><br><span class="line">            _hidl_data,</span><br><span class="line">            _hidl_fqName_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.readBuffer(<span class="keyword">sizeof</span>(*name), &amp;_hidl_name_parent,  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">void</span> **&gt;(&amp;name));</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readEmbeddedFromParcel(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::android::hardware::hidl_string &amp;&gt;(*name),</span><br><span class="line">            _hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt; _hidl_out_service = <span class="keyword">static_cast</span>&lt;BnHwServiceManager*&gt;(_hidl_this)-&gt;_hidl_mImpl-&gt;get(*fqName, *name);</span><br><span class="line"></span><br><span class="line">    ::android::hardware::writeToParcel(::android::hardware::Status::ok(), _hidl_reply);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_out_service == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        _hidl_err = _hidl_reply-&gt;writeStrongBinder(<span class="literal">nullptr</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ::android::sp&lt;::android::hardware::IBinder&gt; _hidl_binder = ::android::hardware::toBinder&lt;</span><br><span class="line">                ::android::hidl::base::V1_0::IBase&gt;(_hidl_out_service);</span><br><span class="line">        <span class="keyword">if</span> (_hidl_binder.get() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            _hidl_err = _hidl_reply-&gt;writeStrongBinder(_hidl_binder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _hidl_err = ::android::UNKNOWN_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_cb(*_hidl_reply);</span><br><span class="line">    <span class="keyword">return</span> _hidl_err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BnHwServiceManageré€šè¿‡ServiceManagerå¯¹è±¡æŸ¥è¯¢åˆ°å¯¹åº”çš„hidlæœåŠ¡ï¼Œè¿”å›IBaseå¯¹è±¡åï¼Œä¼šè°ƒç”¨toBinderå‡½æ•°è½¬æ¢ä¸ºIBinderç±»å‹å¯¹è±¡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::android::hardware::toBinder&lt; ::android::hidl::base::V1_0::IBase&gt;(_hidl_out_service)</span><br></pre></td></tr></table></figure><p>ç”±äºåœ¨hwservicemanagerè¿™è¾¹ï¼Œä¿å­˜çš„æ˜¯ILightçš„BpHwBaseå¯¹è±¡ï¼Œå› æ­¤åœ¨toBinderå‡½æ•°ä¸­å°†è°ƒç”¨IInterface::asBinderæ¥å¾—åˆ°BpHwBaseçš„æˆå‘˜å˜é‡ä¸­çš„BpHwBinderå¯¹è±¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ifacePtr-&gt;isRemote()) &#123;</span><br><span class="line">	<span class="keyword">return</span> ::android::hardware::IInterface::asBinder(<span class="keyword">static_cast</span>&lt;ProxyType *&gt;(ifacePtr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡æŸ¥è¯¢è¿‡ç¨‹å…¶å®å°±æ˜¯æ ¹æ®æ¥å£åŒ…ååŠæœåŠ¡åç§°ï¼Œä»hwservicemanagerç®¡ç†çš„è¡¨ä¸­æŸ¥è¯¢å¯¹åº”çš„IBaseæœåŠ¡å¯¹è±¡ï¼Œç„¶ååœ¨Clientè¿›ç¨‹ç©ºé—´åˆ†åˆ«åˆ›å»ºBpHwBinderå’ŒBpHwBaseå¯¹è±¡ã€‚</p><h5 id="5-2ã€æ¥å£è½¬æ¢IXXX-castFrom"><a href="#5-2ã€æ¥å£è½¬æ¢IXXX-castFrom" class="headerlink" title="5.2ã€æ¥å£è½¬æ¢IXXX::castFrom()"></a>5.2ã€æ¥å£è½¬æ¢IXXX::castFrom()</h5><p>Framework Serverè¿›ç¨‹é€šè¿‡ä¸Šè¿°hidlæœåŠ¡æŸ¥è¯¢ï¼Œå¾—åˆ°äº†BpHwBaseå¯¹è±¡åï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºä¸ä¸šåŠ¡ç›¸å…³çš„ä»£ç†å¯¹è±¡ï¼Œè¿™å°±æ˜¯é€šè¿‡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\out\soong\.intermediates\hardware\interfaces\light\<span class="number">2.0</span>\android.hardware.light@<span class="number">2.0</span>_genc++\gen\android\hardware\light\<span class="number">2.0</span>\LightAll.cpp]</span><br><span class="line"></span><br><span class="line">::android::hardware::Return&lt;::android::sp&lt;ILight&gt;&gt; ILight::castFrom(<span class="keyword">const</span> ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&amp; parent, <span class="keyword">bool</span> emitError) &#123;</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::details::castInterface&lt;ILight, ::android::hidl::base::V1_0::IBase, BpHwLight&gt;(</span><br><span class="line">            parent, <span class="string">"android.hardware.light@2.0::ILight"</span>, emitError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>system\libhidl\transport\include\hidl\HidlTransportSupport.h</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cast the interface IParent to IChild.</span></span><br><span class="line"><span class="comment">// Return nonnull if cast successful.</span></span><br><span class="line"><span class="comment">// Return nullptr if:</span></span><br><span class="line"><span class="comment">// 1. parent is null</span></span><br><span class="line"><span class="comment">// 2. cast failed because IChild is not a child type of IParent.</span></span><br><span class="line"><span class="comment">// 3. !emitError, calling into parent fails.</span></span><br><span class="line"><span class="comment">// Return an error Return object if:</span></span><br><span class="line"><span class="comment">// 1. emitError, calling into parent fails.</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> IChild, <span class="keyword">typename</span> IParent, <span class="keyword">typename</span> BpChild, <span class="keyword">typename</span> BpParent&gt;</span><br><span class="line">Return&lt;sp&lt;IChild&gt;&gt; castInterface(sp&lt;IParent&gt; parent, <span class="keyword">const</span> <span class="keyword">char</span> *childIndicator, <span class="keyword">bool</span> emitError) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.get() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// casts always succeed with nullptrs.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Return&lt;<span class="keyword">bool</span>&gt; canCastRet = details::canCastInterface(parent.get(), childIndicator, emitError);</span><br><span class="line">    <span class="keyword">if</span> (!canCastRet.isOk()) &#123;</span><br><span class="line">        <span class="comment">// call fails, propagate the error if emitError</span></span><br><span class="line">        <span class="keyword">return</span> emitError</span><br><span class="line">                ? details::StatusOf&lt;<span class="keyword">bool</span>, sp&lt;IChild&gt;&gt;(canCastRet)</span><br><span class="line">                : Return&lt;sp&lt;IChild&gt;&gt;(sp&lt;IChild&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!canCastRet) &#123;</span><br><span class="line">        <span class="keyword">return</span> sp&lt;IChild&gt;(<span class="literal">nullptr</span>); <span class="comment">// cast failed.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO b/32001926 Needs to be fixed for socket mode.</span></span><br><span class="line">    <span class="keyword">if</span> (parent-&gt;isRemote()) &#123;</span><br><span class="line">        <span class="comment">// binderized mode. Got BpChild. grab the remote and wrap it.</span></span><br><span class="line">        <span class="keyword">return</span> sp&lt;IChild&gt;(<span class="keyword">new</span> BpChild(toBinder&lt;IParent, BpParent&gt;(parent)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Passthrough mode. Got BnChild and BsChild.</span></span><br><span class="line">    <span class="keyword">return</span> sp&lt;IChild&gt;(<span class="keyword">static_cast</span>&lt;IChild *&gt;(parent.get()));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125;  <span class="comment">// namespace details</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¨¡æ¿å‡½æ•°å±•å¼€åå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Return&lt;sp&lt;ILight&gt;&gt; castInterface(sp&lt;IBase&gt; parent, <span class="keyword">const</span> <span class="keyword">char</span> *childIndicator, <span class="keyword">bool</span> emitError) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.get() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// casts always succeed with nullptrs.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Return&lt;<span class="keyword">bool</span>&gt; canCastRet = details::canCastInterface(parent.get(), childIndicator, emitError);</span><br><span class="line">    <span class="keyword">if</span> (!canCastRet.isOk()) &#123;</span><br><span class="line">        <span class="comment">// call fails, propagate the error if emitError</span></span><br><span class="line">        <span class="keyword">return</span> emitError</span><br><span class="line">                ? details::StatusOf&lt;<span class="keyword">bool</span>, sp&lt;ILight&gt;&gt;(canCastRet)</span><br><span class="line">                : Return&lt;sp&lt;ILight&gt;&gt;(sp&lt;ILight&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!canCastRet) &#123;</span><br><span class="line">        <span class="keyword">return</span> sp&lt;ILight&gt;(<span class="literal">nullptr</span>); <span class="comment">// cast failed.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO b/32001926 Needs to be fixed for socket mode.</span></span><br><span class="line">    <span class="keyword">if</span> (parent-&gt;isRemote()) &#123;</span><br><span class="line">        <span class="comment">// binderized mode. Got BpChild. grab the remote and wrap it.</span></span><br><span class="line">        <span class="keyword">return</span> sp&lt;ILight&gt;(<span class="keyword">new</span> BpHwLight(toBinder&lt;IBase, BpParent&gt;(parent)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Passthrough mode. Got BnChild and BsChild.</span></span><br><span class="line">    <span class="keyword">return</span> sp&lt;ILight&gt;(<span class="keyword">static_cast</span>&lt;ILight*&gt;(parent.get()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤æœ€ç»ˆä¼šåˆ›å»ºä¸€ä¸ªBpHwLightå¯¹è±¡ã€‚new BpHwLight(toBinder<ibase , bpparent="">(parent))</ibase></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-24-HIDL-binder-bphwxxxx.png" alt="Alt text | center"></p><h4 id="ï¼ˆå…­ï¼‰ã€Android-O-Treble-ä¹‹-HIDLæœåŠ¡Javaæ¡†æ¶å®ç°"><a href="#ï¼ˆå…­ï¼‰ã€Android-O-Treble-ä¹‹-HIDLæœåŠ¡Javaæ¡†æ¶å®ç°" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Android O Treble ä¹‹ HIDLæœåŠ¡Javaæ¡†æ¶å®ç°"></a>ï¼ˆå…­ï¼‰ã€Android O Treble ä¹‹ HIDLæœåŠ¡Javaæ¡†æ¶å®ç°</h4><p>å‰é¢ä»‹ç»äº†HIDLæœåŠ¡åœ¨nativeå±‚çš„å®ç°è¿‡ç¨‹ï¼ŒåŒ…æ‹¬HIDLæœåŠ¡åŠ è½½åˆ›å»ºã€æœåŠ¡æ³¨å†Œã€æœåŠ¡æŸ¥è¯¢è¿‡ç¨‹ç­‰ï¼Œé‚£ä¹ˆJavaå±‚æ˜¯å¦ä¹Ÿå®ç°äº†ç›¸å…³çš„æœåŠ¡æ¡†æ¶å‘¢ï¼Ÿ é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„Haléƒ½å®ç°åœ¨nativeå±‚é¢ï¼Œæ¯ä¸ªhalè¿›ç¨‹éƒ½æ˜¯ä¸€ä¸ªnativeè¿›ç¨‹ï¼Œç”±initè¿›ç¨‹å¯åŠ¨ï¼Œåœ¨halè¿›ç¨‹å¯åŠ¨æ—¶ä¼šå®ŒæˆHIDLæœåŠ¡æ³¨å†Œï¼ŒFramework Serverè¿›ç¨‹ä¸ä¸€å®šå®Œå…¨æ˜¯nativeè¿›ç¨‹ï¼Œæ¯”å¦‚system_serverè¿›ç¨‹ï¼Œå®ƒè¿è¡Œåœ¨è™šæ‹Ÿæœºç¯å¢ƒä¸­ï¼Œç”±zygoteè¿›ç¨‹forkè€Œæ¥ï¼Œè¿™æ—¶ï¼ŒJavaå±‚ä¹Ÿéœ€è¦è¯·æ±‚HIDLæœåŠ¡ï¼Œå› æ­¤Androidä¸ä»…åœ¨nativeå±‚HIDLåŒ–äº†halï¼Œåœ¨Javaå±‚åŒæ ·ä¹Ÿå®šä¹‰äº†ç›¸å…³çš„æœåŠ¡æ¡†æ¶ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-25-Java-binder.png" alt="Alt text | center"></p><p>ä¸Šå›¾æ˜¯Javaå±‚binderå’Œhwbinderä¹‹é—´çš„ç±»åŸºç¡€å›¾å¯¹æ¯”ã€‚å½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª.halæ¥å£æ–‡ä»¶æ—¶ï¼Œé€šè¿‡hidl-genç¼–è¯‘ä¸ºJavaæ–‡ä»¶åï¼Œå°†æŒ‰ä¸Šå›¾ä¸­çš„ç±»ç»§æ‰¿å…³ç³»è‡ªåŠ¨ç”Ÿæˆä»£ç ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-26-Java-binder-class-inherit.png" alt="Alt text | center"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“æˆ‘ä»¬å®šä¹‰IXXX.halæ–‡ä»¶åï¼Œé€šè¿‡ç¼–è¯‘å°†åœ¨out/target/common/gen/JAVA_LIBRARIESç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„IXXX.javaï¼Œè¯¥æ–‡ä»¶æŒ‰ä¸Šè¿°ç±»ç»§æ‰¿å…³ç³»è‡ªåŠ¨ç”Ÿæˆç›¸å…³ä»£ç ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ªXXXImpç±»ï¼Œç»§æ‰¿Stubå¹¶å®ç°æ‰€æœ‰æ–¹æ³•ï¼Œç„¶ååœ¨æŸä¸ªæœåŠ¡è¿›ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªXXXImpå¯¹è±¡ï¼Œå¹¶è°ƒç”¨registerServiceï¼ˆï¼‰å‡½æ•°è¿›è¡ŒhidlæœåŠ¡æ³¨å†Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">XXXImp mXXXImp = <span class="keyword">new</span> XXXImp();</span><br><span class="line">mXXXImp.registerAsService(<span class="string">"XXXImp"</span>);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªJavaå±‚çš„hidlæœåŠ¡æ³¨å†Œï¼Œå½“ç„¶åœ¨å½“å‰Androidç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨åˆ†è¿˜æ˜¯nativeå±‚çš„hidlæœåŠ¡ï¼ŒJavaå±‚çš„hidlæœåŠ¡è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ã€‚ä»ä¸Šè¿°å¯çŸ¥ï¼ŒJavaå±‚çš„hidlæœåŠ¡åŒ…æ‹¬2ä¸ªæ­¥éª¤ï¼š</p><ol><li>hidlæœåŠ¡å¯¹è±¡åˆ›å»ºï¼›</li></ol><p>2.hidlæœåŠ¡æ³¨å†Œï¼›</p><h5 id="6-1ã€Java-hidlæœåŠ¡åˆ›å»ºè¿‡ç¨‹"><a href="#6-1ã€Java-hidlæœåŠ¡åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="6.1ã€Java hidlæœåŠ¡åˆ›å»ºè¿‡ç¨‹"></a>6.1ã€Java hidlæœåŠ¡åˆ›å»ºè¿‡ç¨‹</h5><p>ä»ä¸Šé¢çš„ç±»ç»§æ‰¿å›¾å¯çŸ¥ï¼ŒhidlæœåŠ¡å®ç°ç±»ç»§æ‰¿äºStubï¼ŒStubåˆç»§æ‰¿äºHwBinderï¼Œå› æ­¤åˆ›å»ºä¸€ä¸ªXXXImpå¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨HwBinderçš„æ„é€ å‡½æ•°ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-27-HwBinder.java.setup.png" alt="Alt text | center"></p><p>frameworks\base\core\java\android\os\HwBinder.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HwBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	native_setup();</span><br><span class="line"> </span><br><span class="line">	sNativeRegistry.registerNativeAllocation(</span><br><span class="line">			<span class="keyword">this</span>,</span><br><span class="line">			mNativeContext);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	<span class="keyword">long</span> freeFunction = native_init();</span><br><span class="line"> </span><br><span class="line">	sNativeRegistry = <span class="keyword">new</span> NativeAllocationRegistry(</span><br><span class="line">			HwBinder.class.getClassLoader(),</span><br><span class="line">			freeFunction,</span><br><span class="line">			<span class="number">128</span> <span class="comment">/* size */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºHwBinderå¯¹è±¡ä¼šé¦–å…ˆæ‰§è¡Œnative_init()å‡½æ•°ï¼Œç„¶åè°ƒç”¨native_setup()å‡½æ•°ã€‚<br>frameworks\base\core\jni\android_os_HwBinder.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">JHwBinder_native_init</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    JHwBinder::InitClass(env);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(&amp;releaseNativeContext);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">JHwBinder_native_setup</span><span class="params">(JNIEnv *env, jobject thiz)</span> </span>&#123;</span><br><span class="line">    sp&lt;JHwBinderHolder&gt; context = <span class="keyword">new</span> JHwBinderHolder;</span><br><span class="line">    JHwBinder::SetNativeContext(env, thiz, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºä¸€ä¸ªJHwBinderHolder å¯¹è±¡ï¼Œå¹¶ä¿å­˜åœ¨HwBinderç±»çš„mNativeContextå˜é‡ä¸­ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;JHwBinderHolder&gt; JHwBinder::SetNativeContext(</span><br><span class="line">        JNIEnv *env, jobject thiz, <span class="keyword">const</span> sp&lt;JHwBinderHolder&gt; &amp;context) &#123;</span><br><span class="line">    sp&lt;JHwBinderHolder&gt; old =</span><br><span class="line">        (JHwBinderHolder *)env-&gt;GetLongField(thiz, gFields.contextID);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        context-&gt;incStrong(<span class="literal">NULL</span> <span class="comment">/* id */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (old != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        old-&gt;decStrong(<span class="literal">NULL</span> <span class="comment">/* id */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    env-&gt;SetLongField(thiz, gFields.contextID, (<span class="keyword">long</span>)context.get());</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‡ºç°äº†å¤šä¸ªbinderç±»å‹ï¼šHwBinderã€JHwBinderHolderã€JHwBinderä»–ä»¬çš„ç±»ç»§æ‰¿å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-28-Java-binder---.png" alt="Alt text | center"></p><p>çº¢çº¿æ ‡è¯†äº†è¿™3ä¸ªç±»å¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œä¸ºäº†æ›´åŠ æ¸…æ™°åœ°æè¿°ä»–ä»¬ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-29-HIDL-java-object.png" alt="Alt text | center"></p><h5 id="6-2ã€Javaå±‚æœåŠ¡æ³¨å†Œï¼ˆaddï¼‰æŸ¥è¯¢ï¼ˆgetï¼‰è¿‡ç¨‹"><a href="#6-2ã€Javaå±‚æœåŠ¡æ³¨å†Œï¼ˆaddï¼‰æŸ¥è¯¢ï¼ˆgetï¼‰è¿‡ç¨‹" class="headerlink" title="6.2ã€Javaå±‚æœåŠ¡æ³¨å†Œï¼ˆaddï¼‰æŸ¥è¯¢ï¼ˆgetï¼‰è¿‡ç¨‹"></a>6.2ã€Javaå±‚æœåŠ¡æ³¨å†Œï¼ˆaddï¼‰æŸ¥è¯¢ï¼ˆgetï¼‰è¿‡ç¨‹</h5><p>æœåŠ¡æ³¨å†ŒæŸ¥è¯¢è¿‡ç¨‹æœ¬è´¨ä¹Ÿæ˜¯é€šè¿‡Nativeå±‚çš„hwservicemanageræ¥è¿›è¡Œçš„ã€‚<br>ï¼ˆç•¥ï¼‰è¯·å‚è€ƒå¤§ç‰›åšå®¢ï¼š<a href="https://blog.csdn.net/yangwen123/article/details/79876534" target="_blank" rel="noopener">Android O Trebleæ¶æ„ä¸‹HIDLæœåŠ¡Javaæ¡†æ¶å®ç°</a><br>åˆ°æ­¤Trebleæ¶æ„ä¸‹çš„hwBinderå®ç°è¿‡ç¨‹å°±åŸºæœ¬ä»‹ç»å®Œæˆã€‚<br>æ€»ä½“æ¶æ„ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/o.hidl.system/Treble-09-HIDL-binder-binder_ipc_process.jpg" alt="Alt text | center"></p><h4 id="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://blog.csdn.net/yangwen123" target="_blank" rel="noopener">Android O Trebleæ¶æ„ï¼ˆç³»åˆ—åˆ†ææ–‡ç« ï¼‰ - CSDNåšå®¢</a><br><a href="http://zhoujinjian.cc/2018/01/01/Android-7-1-2-Android-N-Android-Binder%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/">Android 7.1.2 (Android N) Android Binder ç³»ç»Ÿåˆ†æ</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/09/28/Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ/">http://zhoujinjian.cc/2018/09/28/Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/09/17/Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®/" title="Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®"><i class="iconfont icon-prev"></i>Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®</a></div><div class="post__prev post__prev--right"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">27</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.08.jpg" alt="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/28/Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ/" title="Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.28.jpg" alt="Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android O Treble æ¶æ„ - HIDLæºä»£ç åˆ†æ</h3><span class="item__text">2018-09-28</span></div></a></li><li class="latest-post-item"><a href="/2018/09/17/Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®/" title="Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.27.jpg" alt="Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®</h3><span class="item__text">2018-09-17</span></div></a></li><li class="latest-post-item"><a href="/2018/09/12/Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ/" title="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.26.jpg" alt="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</h3><span class="item__text">2018-09-12</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>izhoujinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:izhoujinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">379.4k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>