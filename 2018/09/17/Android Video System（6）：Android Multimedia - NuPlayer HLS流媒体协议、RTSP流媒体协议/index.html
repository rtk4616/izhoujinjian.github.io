<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®® | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/09/17/Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.27.jpg" alt="Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®"></div><header class="post__info"><h1 class="post__title">Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://www.github.com/izhoujinjian">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-09-17</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“åè®®"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“åè®®</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1ã€HLS-æ¦‚è¿°"><span class="toc-text">1.1ã€HLS æ¦‚è¿°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2ã€HLSæ¡†æ¶ä»‹ç»"><span class="toc-text">1.2ã€HLSæ¡†æ¶ä»‹ç»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3ã€HLSæ’­æ”¾æµç¨‹"><span class="toc-text">1.3ã€HLSæ’­æ”¾æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“æ’­æ”¾æºç åˆ†æ"><span class="toc-text">ï¼ˆäºŒï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“æ’­æ”¾æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1ã€HTTPLiveSource-prepareAsync"><span class="toc-text">2.1ã€HTTPLiveSource::prepareAsync()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2ã€è·å–æ•°æ®è¿›è¡Œè§£ç "><span class="toc-text">2.2ã€è·å–æ•°æ®è¿›è¡Œè§£ç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3ã€å¾ªç¯è·å–æ•°æ®HTTPLiveSource-dequeueAccessUnit"><span class="toc-text">2.3ã€å¾ªç¯è·å–æ•°æ®HTTPLiveSource::dequeueAccessUnit()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4ã€è§£ç åéŸ³è§†é¢‘æ’­æ”¾è¿‡ç¨‹"><span class="toc-text">2.4ã€è§£ç åéŸ³è§†é¢‘æ’­æ”¾è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€åŸºäºNuPlayerçš„RTSPæµåª’ä½“åè®®"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€åŸºäºNuPlayerçš„RTSPæµåª’ä½“åè®®</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1ã€RTSP-æ¦‚è¿°ï¼š"><span class="toc-text">3.1.1ã€RTSP æ¦‚è¿°ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2ã€RTSP-æ¨¡å‹ï¼š"><span class="toc-text">3.1.2ã€RTSP æ¨¡å‹ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-3ã€RTSP-åè®®æ¶ˆæ¯æ ¼å¼ï¼š"><span class="toc-text">3.1.3ã€RTSP åè®®æ¶ˆæ¯æ ¼å¼ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4ã€ç®€å•çš„RTSP-äº¤äº’è¿‡ç¨‹"><span class="toc-text">3.1.4ã€ç®€å•çš„RTSP äº¤äº’è¿‡ç¨‹:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-5ã€RTSPçš„ä¸»è¦å‘½ä»¤è¡¨ï¼š"><span class="toc-text">3.1.5ã€RTSPçš„ä¸»è¦å‘½ä»¤è¡¨ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-6ã€SDPçš„æ ¼å¼ï¼š"><span class="toc-text">3.1.6ã€SDPçš„æ ¼å¼ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-7ã€RTPåè®®ï¼š"><span class="toc-text">3.1.7ã€RTPåè®®ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-8ã€RTPåè®®æŠ¥å¤´æ ¼å¼"><span class="toc-text">3.1.8ã€RTPåè®®æŠ¥å¤´æ ¼å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-9ã€RTCPåè®®æŠ¥å¤´æ ¼å¼"><span class="toc-text">3.1.9ã€RTCPåè®®æŠ¥å¤´æ ¼å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2ã€åŸºäºNuPLayerçš„RTSP-ä»£ç æµç¨‹"><span class="toc-text">3.2ã€åŸºäºNuPLayerçš„RTSP ä»£ç æµç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3ã€RTSPSource-prepareAsync-æµç¨‹"><span class="toc-text">3.3ã€RTSPSource::prepareAsync()æµç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4ã€è·å–æ•°æ®è¿›è¡Œç¼–ç ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰"><span class="toc-text">3.4ã€è·å–æ•°æ®è¿›è¡Œç¼–ç ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5ã€æ’­æ”¾æµç¨‹ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰"><span class="toc-text">3.5ã€æ’­æ”¾æµç¨‹ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div><hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼ˆâ—•â€¿â—•ï¼‰ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/video.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="https://tbfungeek.github.io/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android æºç åˆ†æä¹‹åŸºäºNuPlayerçš„HLSæµåª’ä½“åè®®ã€‘</a><br><a href="https://tbfungeek.github.io/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android æºç åˆ†æä¹‹åŸºäºNuPlayerçš„RTSPæµåª’ä½“åè®®ã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br><a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br><a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener">Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><blockquote><p>æ³¨ï¼šæœ¬æ–‡åŸºæœ¬è½¬è½½äºä¸Šè¿°ä¸¤ç¯‡åšå®¢ï¼ï¼ï¼</p></blockquote><h4 id="ï¼ˆä¸€ï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“åè®®"><a href="#ï¼ˆä¸€ï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“åè®®" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“åè®®"></a>ï¼ˆä¸€ï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“åè®®</h4><h5 id="1-1ã€HLS-æ¦‚è¿°"><a href="#1-1ã€HLS-æ¦‚è¿°" class="headerlink" title="1.1ã€HLS æ¦‚è¿°"></a>1.1ã€HLS æ¦‚è¿°</h5><p>HTTP Live Streamingï¼ˆHLSï¼‰æ˜¯è‹¹æœå…¬å¸å®ç°çš„åŸºäºHTTPçš„æµåª’ä½“ç›´æ’­å’Œç‚¹æ’­åè®®ï¼Œä¸»è¦åº”ç”¨åœ¨iOSç³»ç»Ÿã€‚ç›¸å¯¹äºæ™®é€šçš„æµåª’ä½“ï¼Œä¾‹å¦‚RTMPåè®®ã€RTSPåè®®ã€MMSåè®®ç­‰ï¼ŒHLSæœ€å¤§çš„ä¼˜ç‚¹æ˜¯å¯ä»¥æ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸åŒç ç‡çš„è§†é¢‘ï¼Œå¦‚æœç½‘ç»œçŠ¶å†µè¾ƒå¥½ï¼Œåˆ™ä¼šåˆ‡æ¢åˆ°é«˜ç ç‡çš„è§†é¢‘ï¼Œè‹¥å‘ç°ç½‘ç»œçŠ¶å†µä¸ä½³ï¼Œåˆ™ä¼šé€æ¸è¿‡æ¸¡åˆ°ä½ç ç‡çš„è§†é¢‘ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸‹é¢å°†ä¼šç»“åˆä»£ç å¯¹å…¶è¿›è¡Œè¯´æ˜ã€‚</p><h5 id="1-2ã€HLSæ¡†æ¶ä»‹ç»"><a href="#1-2ã€HLSæ¡†æ¶ä»‹ç»" class="headerlink" title="1.2ã€HLSæ¡†æ¶ä»‹ç»"></a>1.2ã€HLSæ¡†æ¶ä»‹ç»</h5><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹HLSç³»ç»Ÿçš„æ•´ä½“ç»“æ„å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-01-HLS-playback-architecture.png" alt="Alt text | center"></p><p>æˆ‘ä»¬é¦–å…ˆå°†è¦ç›´æ’­çš„è§†é¢‘é€åˆ°ç¼–ç å™¨ä¸­ï¼Œç¼–ç å™¨åˆ†åˆ«å¯¹è§†é¢‘å’ŒéŸ³é¢‘è¿›è¡Œç¼–ç ï¼Œç„¶åè¾“å‡ºåˆ°ä¸€ä¸ªMPEG-2æ ¼å¼çš„ä¼ è¾“æµä¸­ï¼Œå†ç”±åˆ†æ®µå™¨å°†MPEG-2ä¼ è¾“æµè¿›è¡Œåˆ†æ®µï¼Œäº§ç”Ÿä¸€ç³»åˆ—ç­‰é—´éš”çš„åª’ä½“ç‰‡æ®µï¼Œè¿™äº›åª’ä½“ç‰‡æ®µä¸€èˆ¬å¾ˆå°å¹¶ä¸”ä¿å­˜æˆåç¼€ä¸º.tsçš„æ–‡ä»¶ï¼ŒåŒæ—¶ç”Ÿæˆä¸€ä¸ªæŒ‡å‘è¿™äº›åª’ä½“æ–‡ä»¶çš„ç´¢å¼•æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¾ˆç»å¸¸å¬åˆ°çš„.M3U8æ–‡ä»¶ã€‚å®Œæˆåˆ†æ®µä¹‹åå°†è¿™äº›ç´¢å¼•æ–‡ä»¶ä»¥åŠåª’ä½“æ–‡ä»¶ä¸Šä¼ åˆ°WebæœåŠ¡å™¨ä¸Šã€‚å®¢æˆ·ç«¯è¯»å–ç´¢å¼•æ–‡ä»¶ï¼Œç„¶åæŒ‰é¡ºåºè¯·æ±‚ä¸‹è½½ç´¢å¼•æ–‡ä»¶ä¸­åˆ—å‡ºçš„åª’ä½“æ–‡ä»¶ã€‚ä¸‹è½½åæ˜¯ä¸€ä¸ªtsæ–‡ä»¶ã€‚éœ€è¦è¿›è¡Œè§£å‹è·å¾—å¯¹åº”çš„åª’ä½“æ•°æ®å¹¶è§£ç åè¿›è¡Œæ’­æ”¾ã€‚ç”±äºåœ¨ç›´æ’­è¿‡ç¨‹ä¸­æœåŠ¡å™¨ç«¯ä¼šä¸æ–­åœ°å°†æœ€æ–°çš„ç›´æ’­æ•°æ®ç”Ÿæˆæ–°çš„å°æ–‡ä»¶ï¼Œå¹¶ä¸Šä¼ æ‰€ä»¥åªè¦å®¢æˆ·ç«¯ä¸æ–­åœ°æŒ‰é¡ºåºä¸‹è½½å¹¶æ’­æ”¾ä»æœåŠ¡å™¨è·å–åˆ°çš„æ–‡ä»¶ï¼Œä»æ•´ä¸ªè¿‡ç¨‹ä¸Šçœ‹å°±ç›¸å½“äºå®ç°äº†ç›´æ’­ã€‚è€Œä¸”ç”±äºåˆ†æ®µæ–‡ä»¶çš„å¾ˆçŸ­ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®å®é™…çš„å¸¦å®½æƒ…å†µåˆ‡æ¢åˆ°ä¸åŒç ç‡çš„ç›´æ’­æºï¼Œä»è€Œå®ç°å¤šç ç‡çš„é€‚é…çš„ç›®çš„ã€‚</p><p>M3U8 çŸ¥è¯†è¯·å‚è€ƒï¼š<a href="https://blog.csdn.net/Guofengpu/article/details/54922865" target="_blank" rel="noopener">HLSä¹‹m3u8ã€tsæµæ ¼å¼è¯¦è§£</a></p><h5 id="1-3ã€HLSæ’­æ”¾æµç¨‹"><a href="#1-3ã€HLSæ’­æ”¾æµç¨‹" class="headerlink" title="1.3ã€HLSæ’­æ”¾æµç¨‹"></a>1.3ã€HLSæ’­æ”¾æµç¨‹</h5><p>1ã€è·å–ä¸åŒå¸¦å®½ä¸‹å¯¹åº”çš„ç½‘ç»œèµ„æºURIåŠéŸ³è§†é¢‘ç¼–è§£ç ï¼Œè§†é¢‘åˆ†è¾¨ç‡ç­‰ä¿¡æ¯çš„æ–‡ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=899152,RESOLUTION=480x270,CODECS="avc1.4d4015,mp4a.40.5"</span><br><span class="line">http:<span class="comment">//hls.ftdp.com/video1_widld/m3u8/01.m3u8</span></span><br></pre></td></tr></table></figure><p>2ã€æ ¹æ®ä¸Šè¿°è·å–çš„ä¿¡æ¯åˆå§‹åŒ–å¯¹åº”çš„ç¼–è§£ç å™¨</p><p>3ã€è·å–ç¬¬ä¸€ä¸ªç½‘ç»œèµ„æºå¯¹åº”çš„åˆ†æ®µç´¢å¼•åˆ—è¡¨ï¼ˆindexæ–‡ä»¶ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:6532</span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI="18319965201.key"</span><br><span class="line">#EXTINF:10,</span><br><span class="line"><span class="number">20125484</span>T125708<span class="number">-01</span><span class="number">-6533.</span>ts</span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI="14319965205.key"</span><br><span class="line">#EXTINF:10,</span><br><span class="line"><span class="number">20125484</span>T125708<span class="number">-01</span><span class="number">-6534.</span>ts</span><br><span class="line">....</span><br><span class="line">#EXTINF:8,</span><br><span class="line"></span><br><span class="line"><span class="number">20140804</span>T125708<span class="number">-01</span><span class="number">-6593.</span>ts</span><br></pre></td></tr></table></figure><p>4ã€è·å–æŸä¸€ä¸ªåˆ†ç‰‡çš„Key</p><p>5ã€è¯·æ±‚ä¸‹è½½æŸä¸€ä¸ªåˆ†ç‰‡<br>6ã€æ ¹æ®å½“å‰çš„å¸¦å®½å†³å®šæ˜¯å¦åˆ‡æ¢è§†é¢‘èµ„æº<br>7ã€å°†ä¸‹è½½çš„åˆ†ç‰‡èµ„æºè§£å¯†åé€åˆ°è§£ç å™¨è¿›è¡Œè§£ç </p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-02-HLS-playback-flow.png" alt="Alt text | center"></p><p>å…³äºNuPlayerDrvierçš„åˆ›å»ºä»¥åŠSetDataSourceçš„æµç¨‹å’ŒStagefight Playerå¤§ä½“ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºsetDataSourceçš„æ—¶å€™æ˜¯æ ¹æ®urlçš„ä¸åŒä¼šåˆ›å»ºä¸‰ç§ä¸åŒçš„DataSourceï¼šHttpLiveSourceï¼ŒRTSPSourceï¼Œä»¥åŠGenericSourceã€‚è¿™é‡Œå°±ä¸åšå¤§ç¯‡å¹…çš„ä»‹ç»äº†ï¼Œå°±ç›´æ¥ä¸Šå›¾å§</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-03-HLS-nuplayer-setdatasource-java.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-04-HLS-nuplayer-setdatasource-native.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-05-HLS-nuplayer-setdatasource-native-2.png" alt="Alt text | center"></p><h4 id="ï¼ˆäºŒï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“æ’­æ”¾æºç åˆ†æ"><a href="#ï¼ˆäºŒï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“æ’­æ”¾æºç åˆ†æ" class="headerlink" title="ï¼ˆäºŒï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“æ’­æ”¾æºç åˆ†æ"></a>ï¼ˆäºŒï¼‰ã€åŸºäºNuPlayerçš„HLSæµåª’ä½“æ’­æ”¾æºç åˆ†æ</h4><p>é¦–å…ˆçœ‹çœ‹æ€»ä½“æ—¶åºå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-06-HttpLiveStream-flow.png" alt="Alt text | center"></p><h5 id="2-1ã€HTTPLiveSource-prepareAsync"><a href="#2-1ã€HTTPLiveSource-prepareAsync" class="headerlink" title="2.1ã€HTTPLiveSource::prepareAsync()"></a>2.1ã€HTTPLiveSource::prepareAsync()</h5><p>æˆ‘ä»¬ç›´æ¥ä»prepareç»“åˆHLSåŸç†å¼€å§‹åˆ†æï¼Œç›´æ¥çœ‹HttpliveSourceçš„prepareAsyncã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\HTTPLiveSource.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::HTTPLiveSource::prepareAsync() &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªLooper</span></span><br><span class="line">    <span class="keyword">if</span> (mLiveLooper == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mLiveLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">        mLiveLooper-&gt;setName(<span class="string">"http live"</span>);</span><br><span class="line">        mLiveLooper-&gt;start();</span><br><span class="line">        mLiveLooper-&gt;registerHandler(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªkWhatSessionNotifyèµ‹å€¼ç»™LiveSessionç”¨äºé€šçŸ¥</span></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSessionNotify, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªLiveSession</span></span><br><span class="line">    mLiveSession = <span class="keyword">new</span> LiveSession(</span><br><span class="line">            notify,</span><br><span class="line">            (mFlags &amp; kFlagIncognito) ? LiveSession::kFlagIncognito : <span class="number">0</span>,</span><br><span class="line">            mHTTPService);</span><br><span class="line">    mLiveLooper-&gt;registerHandler(mLiveSession);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨LiveSessionè¿›è¡Œå¼‚æ­¥è¿æ¥</span></span><br><span class="line">    mLiveSession-&gt;connectAsync(mURL.c_str(), mExtraHeaders.isEmpty() ? <span class="literal">NULL</span> : &amp;mExtraHeaders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">void</span> LiveSession::connectAsync(<span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">const</span> KeyedVector&lt;String8, String8&gt; *headers) &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªkWhatConnectå¹¶ä¼ å…¥url</span></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatConnect, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setString(<span class="string">"url"</span>, url);</span><br><span class="line">    <span class="keyword">if</span> (headers != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        msg-&gt;setPointer(<span class="string">"headers"</span>,<span class="keyword">new</span> KeyedVector&lt;String8, String8&gt;(*headers));</span><br><span class="line">    &#125;</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LiveSession::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">	<span class="keyword">case</span> kWhatConnect:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨onConnect</span></span><br><span class="line">        onConnect(msg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LiveSession::onConnect(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="comment">//è·å–ä¼ è¿‡æ¥çš„Uri</span></span><br><span class="line">    CHECK(msg-&gt;findString(<span class="string">"url"</span>, &amp;mMasterURL));</span><br><span class="line">    KeyedVector&lt;String8, String8&gt; *headers = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!msg-&gt;findPointer(<span class="string">"headers"</span>, (<span class="keyword">void</span> **)&amp;headers)) &#123;</span><br><span class="line">        mExtraHeaders.clear();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mExtraHeaders = *headers;</span><br><span class="line">        <span class="keyword">delete</span> headers;</span><br><span class="line">        headers = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªmFetcherLooper</span></span><br><span class="line">    <span class="keyword">if</span> (mFetcherLooper == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mFetcherLooper = <span class="keyword">new</span> ALooper();</span><br><span class="line">        mFetcherLooper-&gt;setName(<span class="string">"Fetcher"</span>);</span><br><span class="line">        mFetcherLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–ä¸åŒå¸¦å®½ä¸‹å¯¹åº”çš„ç½‘ç»œèµ„æºURIåŠéŸ³è§†é¢‘ç¼–è§£ç ä¿¡æ¯</span></span><br><span class="line">    addFetcher(mMasterURL.c_str())-&gt;fetchPlaylistAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±å¼€å§‹è·å–ä¸åŒå¸¦å®½ä¸‹å¯¹åº”çš„ç½‘ç»œèµ„æºURIåŠéŸ³è§†é¢‘ç¼–è§£ç ä¿¡æ¯äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line">sp&lt;PlaylistFetcher&gt; LiveSession::addFetcher(<span class="keyword">const</span> <span class="keyword">char</span> *uri) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> index = mFetcherInfos.indexOfKey(uri);</span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatFetcherNotify, <span class="keyword">this</span>);</span><br><span class="line">    notify-&gt;setString(<span class="string">"uri"</span>, uri);</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"switchGeneration"</span>, mSwitchGeneration);</span><br><span class="line">    FetcherInfo info;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªPlaylistFetcherå¹¶è¿”å›</span></span><br><span class="line">    info.mFetcher = <span class="keyword">new</span> PlaylistFetcher(notify, <span class="keyword">this</span>, uri, mCurBandwidthIndex, mSubtitleGeneration);</span><br><span class="line">    info.mDurationUs = <span class="number">-1l</span>l;</span><br><span class="line">    info.mToBeRemoved = <span class="literal">false</span>;</span><br><span class="line">    info.mToBeResumed = <span class="literal">false</span>;</span><br><span class="line">    mFetcherLooper-&gt;registerHandler(info.mFetcher);</span><br><span class="line">    mFetcherInfos.add(uri, info);</span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„info.mFetcheræ˜¯ä¸Šé¢new å‡ºæ¥çš„PlaylistFetcher</span></span><br><span class="line">    <span class="keyword">return</span> info.mFetcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡è¿™é‡Œè¿”å›çš„PlaylistFetcherè°ƒç”¨fetchPlaylistAsyncæ¥è·å–playlists<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\PlaylistFetcher.cpp]</span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::fetchPlaylistAsync() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatFetchPlaylist, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">case</span> kWhatFetchPlaylist:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">bool</span> unchanged;</span><br><span class="line">        <span class="comment">//è·å–ä¸€ä¸ªM3U8Parser</span></span><br><span class="line">        sp&lt;M3UParser&gt; playlist = mHTTPDownloader-&gt;fetchPlaylist(mURI.c_str(), <span class="literal">NULL</span> <span class="comment">/* curPlaylistHash */</span>, &amp;unchanged);</span><br><span class="line">        sp&lt;AMessage&gt; notify = mNotify-&gt;dup();</span><br><span class="line">        notify-&gt;setInt32(<span class="string">"what"</span>, kWhatPlaylistFetched);</span><br><span class="line">        <span class="comment">//å°†playlistè¿”å›</span></span><br><span class="line">        notify-&gt;setObject(<span class="string">"playlist"</span>, playlist);</span><br><span class="line">        notify-&gt;post();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹fetchFileè¿‡ç¨‹ï¼šé¦–å…ˆä¼šé€šè¿‡fetchFileä»æœåŠ¡å™¨ç«¯è·å–åˆ°m3u8 playlistå†…å®¹å­˜æ”¾åˆ°bufferç¼“å­˜åŒºï¼Œç„¶åå°†è·å–åˆ°çš„ç¼“å­˜æ•°æ®åŒ…è£…æˆM3UParser</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\HTTPDownloader.cpp]</span><br><span class="line">sp&lt;M3UParser&gt; HTTPDownloader::fetchPlaylist(</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">uint8_t</span> *curPlaylistHash, <span class="keyword">bool</span> *unchanged) &#123;</span><br><span class="line"></span><br><span class="line">    *unchanged = <span class="literal">false</span>;</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    String8 actualUrl;</span><br><span class="line">    <span class="comment">//è°ƒç”¨fetchFile</span></span><br><span class="line">    <span class="keyword">ssize_t</span> err = fetchFile(url, &amp;buffer, &amp;actualUrl);</span><br><span class="line">	<span class="comment">//æ–­å¼€è¿æ¥</span></span><br><span class="line">    mHTTPDataSource-&gt;disconnect();</span><br><span class="line"> 	<span class="comment">//å°†è·å–åˆ°çš„ç¼“å­˜æ•°æ®åŒ…è£…æˆM3UParser</span></span><br><span class="line">    sp&lt;M3UParser&gt; playlist = <span class="keyword">new</span> M3UParser(actualUrl.<span class="built_in">string</span>(), buffer-&gt;data(), buffer-&gt;size());</span><br><span class="line">    <span class="keyword">return</span> playlist;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> HTTPDownloader::fetchFile(</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *url, sp&lt;ABuffer&gt; *out, String8 *actualUrl) &#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> err = fetchBlock(url, out, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span>, actualUrl, <span class="literal">true</span> <span class="comment">/* reconnect */</span>);</span><br><span class="line">    <span class="comment">// close off the connection after use</span></span><br><span class="line">    mHTTPDataSource-&gt;disconnect();</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™é‡Œçœ‹ä¸‹M3UParseræ„é€ æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\M3UParser.cpp]</span><br><span class="line">M3UParser::M3UParser(</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *baseURI, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> size)</span><br><span class="line">    : mInitCheck(NO_INIT),</span><br><span class="line">      mBaseURI(baseURI),</span><br><span class="line">      mIsExtM3U(<span class="literal">false</span>),</span><br><span class="line">      mIsVariantPlaylist(<span class="literal">false</span>),</span><br><span class="line">      mIsComplete(<span class="literal">false</span>),</span><br><span class="line">      mIsEvent(<span class="literal">false</span>),</span><br><span class="line">      mFirstSeqNumber(<span class="number">-1</span>),</span><br><span class="line">      mLastSeqNumber(<span class="number">-1</span>),</span><br><span class="line">      mTargetDurationUs(<span class="number">-1l</span>l),</span><br><span class="line">      mDiscontinuitySeq(<span class="number">0</span>),</span><br><span class="line">      mDiscontinuityCount(<span class="number">0</span>),</span><br><span class="line">      mSelectedIndex(<span class="number">-1</span>) &#123;</span><br><span class="line">    mInitCheck = parse(data, size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æœ€åçš„æ—¶å€™ä¼šè°ƒç”¨parseå¯¹ç¼“å­˜æ•°æ®è¿›è¡Œè§£æï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\M3UParser.cpp]</span><br><span class="line"><span class="keyword">status_t</span> M3UParser::parse(<span class="keyword">const</span> <span class="keyword">void</span> *_data, <span class="keyword">size_t</span> size) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> lineNo = <span class="number">0</span>;</span><br><span class="line">    sp&lt;AMessage&gt; itemMeta;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *data = (<span class="keyword">const</span> <span class="keyword">char</span> *)_data;</span><br><span class="line">    <span class="keyword">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> segmentRangeOffset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (offset &lt; size) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> offsetLF = offset;</span><br><span class="line">        <span class="keyword">while</span> (offsetLF &lt; size &amp;&amp; data[offsetLF] != <span class="string">'\n'</span>) &#123;</span><br><span class="line">            ++offsetLF;</span><br><span class="line">        &#125;</span><br><span class="line">        AString line;</span><br><span class="line">        <span class="keyword">if</span> (offsetLF &gt; offset &amp;&amp; data[offsetLF - <span class="number">1</span>] == <span class="string">'\r'</span>) &#123;</span><br><span class="line">            line.setTo(&amp;data[offset], offsetLF - offset - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            line.setTo(&amp;data[offset], offsetLF - offset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (line.empty()) &#123;</span><br><span class="line">            offset = offsetLF + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (lineNo == <span class="number">0</span> &amp;&amp; line == <span class="string">"#EXTM3U"</span>) &#123;</span><br><span class="line">            mIsExtM3U = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mIsExtM3U) &#123;</span><br><span class="line">            <span class="keyword">status_t</span> err = OK;</span><br><span class="line">            <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-TARGETDURATION"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaData(line, &amp;mMeta, <span class="string">"target-duration"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-MEDIA-SEQUENCE"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaData(line, &amp;mMeta, <span class="string">"media-sequence"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-KEY"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseCipherInfo(line, &amp;itemMeta, mBaseURI);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-ENDLIST"</span>)) &#123;</span><br><span class="line">                mIsComplete = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-PLAYLIST-TYPE:EVENT"</span>)) &#123;</span><br><span class="line">                mIsEvent = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXTINF"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaDataDuration(line, &amp;itemMeta, <span class="string">"durationUs"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-DISCONTINUITY"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (itemMeta == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    itemMeta = <span class="keyword">new</span> AMessage;</span><br><span class="line">                &#125;</span><br><span class="line">                itemMeta-&gt;setInt32(<span class="string">"discontinuity"</span>, <span class="literal">true</span>);</span><br><span class="line">                ++mDiscontinuityCount;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-STREAM-INF"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mMeta != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                mIsVariantPlaylist = <span class="literal">true</span>;</span><br><span class="line">                err = parseStreamInf(line, &amp;itemMeta);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-BYTERANGE"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">uint64_t</span> length, offset;</span><br><span class="line">                err = parseByteRange(line, segmentRangeOffset, &amp;length, &amp;offset);</span><br><span class="line">                <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (itemMeta == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        itemMeta = <span class="keyword">new</span> AMessage;</span><br><span class="line">                    &#125;</span><br><span class="line">                    itemMeta-&gt;setInt64(<span class="string">"range-offset"</span>, offset);</span><br><span class="line">                    itemMeta-&gt;setInt64(<span class="string">"range-length"</span>, length);</span><br><span class="line">                    segmentRangeOffset = offset + length;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-MEDIA"</span>)) &#123;</span><br><span class="line">                err = parseMedia(line);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-DISCONTINUITY-SEQUENCE"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">size_t</span> seq;</span><br><span class="line">                err = parseDiscontinuitySequence(line, &amp;seq);</span><br><span class="line">                <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                    mDiscontinuitySeq = seq;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!line.startsWith(<span class="string">"#"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mIsVariantPlaylist) &#123;</span><br><span class="line">                <span class="keyword">int64_t</span> durationUs;</span><br><span class="line">                <span class="keyword">if</span> (itemMeta == <span class="literal">NULL</span></span><br><span class="line">                        || !itemMeta-&gt;findInt64(<span class="string">"durationUs"</span>, &amp;durationUs)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                itemMeta-&gt;setInt32(<span class="string">"discontinuity-sequence"</span>,</span><br><span class="line">                        mDiscontinuitySeq + mDiscontinuityCount);</span><br><span class="line">            &#125;</span><br><span class="line">            mItems.push();</span><br><span class="line">            Item *item = &amp;mItems.editItemAt(mItems.size() - <span class="number">1</span>);</span><br><span class="line">            CHECK(MakeURL(mBaseURI.c_str(), line.c_str(), &amp;item-&gt;mURI));</span><br><span class="line">            item-&gt;mMeta = itemMeta;</span><br><span class="line">            itemMeta.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        offset = offsetLF + <span class="number">1</span>;</span><br><span class="line">        ++lineNo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mIsVariantPlaylist) &#123;</span><br><span class="line">        <span class="keyword">int32_t</span> targetDurationSecs;</span><br><span class="line">        <span class="keyword">if</span> (mMeta == <span class="literal">NULL</span> || !mMeta-&gt;findInt32(</span><br><span class="line">                <span class="string">"target-duration"</span>, &amp;targetDurationSecs)) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Media playlist missing #EXT-X-TARGETDURATION"</span>);</span><br><span class="line">            <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">        &#125;</span><br><span class="line">        mTargetDurationUs = targetDurationSecs * <span class="number">1000000l</span>l;</span><br><span class="line">        mFirstSeqNumber = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mMeta != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mMeta-&gt;findInt32(<span class="string">"media-sequence"</span>, &amp;mFirstSeqNumber);</span><br><span class="line">        &#125;</span><br><span class="line">        mLastSeqNumber = mFirstSeqNumber + mItems.size() - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¥½äº†æˆ‘ä»¬ç°åœ¨å·²ç»è·å–åˆ°äº†ç±»å‹ä¸ºM3UParserçš„æ’­æ”¾åˆ—è¡¨æ–‡ä»¶äº†ï¼Œè¿™æ—¶å€™ä¼šå‘é€ä¸€ä¸ªkWhatPlaylistFetchedï¼Œè¿™ä¸ªåœ¨å“ªé‡Œè¢«å¤„ç†å‘¢ï¼Ÿå½“ç„¶æ˜¯LiveSessionå•Šã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">case</span> PlaylistFetcher::kWhatPlaylistFetched:</span><br><span class="line">&#123;</span><br><span class="line">    onMasterPlaylistFetched(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–åˆ°æ’­æ”¾åˆ—è¡¨åè¦å¹²å•¥å‘¢ï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">void</span> LiveSession::onMasterPlaylistFetched(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line"></span><br><span class="line">    AString uri;</span><br><span class="line">    CHECK(msg-&gt;findString(<span class="string">"uri"</span>, &amp;uri));</span><br><span class="line">    <span class="keyword">ssize_t</span> index = mFetcherInfos.indexOfKey(uri);</span><br><span class="line">    <span class="comment">// no longer useful, remove</span></span><br><span class="line">    mFetcherLooper-&gt;unregisterHandler(mFetcherInfos[index].mFetcher-&gt;id());</span><br><span class="line">    mFetcherInfos.removeItemsAt(index);</span><br><span class="line">    <span class="comment">//å–èµ°è·å–åˆ°çš„playlist</span></span><br><span class="line">    CHECK(msg-&gt;findObject(<span class="string">"playlist"</span>, (sp&lt;RefBase&gt; *)&amp;mPlaylist));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We trust the content provider to make a reasonable choice of preferred</span></span><br><span class="line">    <span class="comment">// initial bandwidth by listing it first in the variant playlist.</span></span><br><span class="line">    <span class="comment">// At startup we really don't have a good estimate on the available</span></span><br><span class="line">    <span class="comment">// network bandwidth since we haven't tranferred any data yet. Once</span></span><br><span class="line">    <span class="comment">// we have we can make a better informed choice.</span></span><br><span class="line">    <span class="keyword">size_t</span> initialBandwidth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> initialBandwidthIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> maxWidth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> maxHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è·å–åˆ°çš„playlistæ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆå°±æ²¡å•¥ç”¨äº†ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾æœ‰æ•ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (mPlaylist-&gt;isVariantPlaylist()) &#123;</span><br><span class="line">        Vector&lt;BandwidthItem&gt; itemsWithVideo;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mPlaylist-&gt;size(); ++i) &#123;</span><br><span class="line">            BandwidthItem item;</span><br><span class="line">            item.mPlaylistIndex = i;</span><br><span class="line">            item.mLastFailureUs = <span class="number">-1l</span>l;</span><br><span class="line">            sp&lt;AMessage&gt; meta;</span><br><span class="line">            AString uri;</span><br><span class="line">            mPlaylist-&gt;itemAt(i, &amp;uri, &amp;meta);</span><br><span class="line">            <span class="comment">//è·å–å¸¦å®½</span></span><br><span class="line">            CHECK(meta-&gt;findInt32(<span class="string">"bandwidth"</span>, (<span class="keyword">int32_t</span> *)&amp;item.mBandwidth));</span><br><span class="line">            <span class="comment">//è·å–æœ€å¤§åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="keyword">int32_t</span> width, height;</span><br><span class="line">            <span class="keyword">if</span> (meta-&gt;findInt32(<span class="string">"width"</span>, &amp;width)) &#123;</span><br><span class="line">                maxWidth = max(maxWidth, width);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (meta-&gt;findInt32(<span class="string">"height"</span>, &amp;height)) &#123;</span><br><span class="line">                maxHeight = max(maxHeight, height);</span><br><span class="line">            &#125;</span><br><span class="line">            mBandwidthItems.push(item);</span><br><span class="line">            <span class="keyword">if</span> (mPlaylist-&gt;hasType(i, <span class="string">"video"</span>)) &#123;</span><br><span class="line">                itemsWithVideo.push(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ç§»é™¤åªæœ‰å£°éŸ³çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">if</span> (!itemsWithVideo.empty()&amp;&amp; itemsWithVideo.size() &lt; mBandwidthItems.size()) &#123;</span><br><span class="line">            mBandwidthItems.clear();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; itemsWithVideo.size(); ++i) &#123;</span><br><span class="line">                mBandwidthItems.push(itemsWithVideo[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        CHECK_GT(mBandwidthItems.size(), <span class="number">0u</span>);</span><br><span class="line">        initialBandwidth = mBandwidthItems[<span class="number">0</span>].mBandwidth;</span><br><span class="line">        <span class="comment">//æŒ‰ç…§å¸¦å®½è¿›è¡Œæ’åº</span></span><br><span class="line">        mBandwidthItems.sort(SortByBandwidth);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mBandwidthItems.size(); ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mBandwidthItems.itemAt(i).mBandwidth == initialBandwidth) &#123;</span><br><span class="line">                initialBandwidthIndex = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">//......</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//è·å–åˆ°æœ€å¤§çš„åˆ†è¾¨ç‡</span></span><br><span class="line">    mMaxWidth = maxWidth &gt; <span class="number">0</span> ? maxWidth : mMaxWidth;</span><br><span class="line">    mMaxHeight = maxHeight &gt; <span class="number">0</span> ? maxHeight : mMaxHeight;</span><br><span class="line">    mPlaylist-&gt;pickRandomMediaItems();</span><br><span class="line">    changeConfiguration(<span class="number">0l</span>l <span class="comment">/* timeUs */</span>, initialBandwidthIndex, <span class="literal">false</span> <span class="comment">/* pickTrack */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">void</span> LiveSession::changeConfiguration(<span class="keyword">int64_t</span> timeUs, <span class="keyword">ssize_t</span> bandwidthIndex, <span class="keyword">bool</span> pickTrack) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å–æ¶ˆå¸¦å®½åˆ‡æ¢</span></span><br><span class="line">    cancelBandwidthSwitch();</span><br><span class="line">    mReconfigurationInProgress = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//ç”±mOrigBandwidthIndexåˆ‡æ¢åˆ°mCurBandwidthIndex</span></span><br><span class="line">    <span class="keyword">if</span> (bandwidthIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å°†å½“å‰çš„å¸¦å®½è®¾ç½®ä¸ºå½“å‰å¸¦å®½</span></span><br><span class="line">        mOrigBandwidthIndex = mCurBandwidthIndex;</span><br><span class="line">        mCurBandwidthIndex = bandwidthIndex;</span><br><span class="line">        <span class="keyword">if</span> (mOrigBandwidthIndex != mCurBandwidthIndex) &#123;</span><br><span class="line">            <span class="comment">//å¼€å§‹åˆ‡æ¢å¸¦å®½</span></span><br><span class="line">            ALOGI(<span class="string">"#### Starting Bandwidth Switch: %zd =&gt; %zd"</span>,mOrigBandwidthIndex, mCurBandwidthIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    CHECK_LT(mCurBandwidthIndex, mBandwidthItems.size());</span><br><span class="line">    <span class="comment">//è·å–å½“å‰çš„BandwidthItem</span></span><br><span class="line">    <span class="keyword">const</span> BandwidthItem &amp;item = mBandwidthItems.itemAt(mCurBandwidthIndex);</span><br><span class="line">    <span class="keyword">uint32_t</span> streamMask = <span class="number">0</span>; <span class="comment">// streams that should be fetched by the new fetcher</span></span><br><span class="line">    <span class="keyword">uint32_t</span> resumeMask = <span class="number">0</span>; <span class="comment">// streams that should be fetched by the original fetcher</span></span><br><span class="line">    AString URIs[kMaxStreams];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPlaylist-&gt;getTypeURI(item.mPlaylistIndex, mStreams[i].mType, &amp;URIs[i])) &#123;</span><br><span class="line">            streamMask |= indexToType(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢æˆ‘ä»¬ä¸éœ€è¦çš„ï¼Œæš‚åœæˆ‘ä»¬å°†è¦å¤ç”¨çš„ï¼Œç¬¬ä¸€æ¬¡çš„æ—¶å€™è¿™é‡Œæ˜¯æ²¡æœ‰çš„æ‰€ä»¥è·³è¿‡</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mFetcherInfos.size(); ++i) &#123;</span><br><span class="line">        <span class="comment">//.........................</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg;</span><br><span class="line">    <span class="keyword">if</span> (timeUs &lt; <span class="number">0l</span>l) &#123;</span><br><span class="line">        <span class="comment">// skip onChangeConfiguration2 (decoder destruction) if not seeking.</span></span><br><span class="line">        msg = <span class="keyword">new</span> AMessage(kWhatChangeConfiguration3, <span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg = <span class="keyword">new</span> AMessage(kWhatChangeConfiguration2, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"streamMask"</span>, streamMask);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"resumeMask"</span>, resumeMask);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"pickTrack"</span>, pickTrack);</span><br><span class="line">    msg-&gt;setInt64(<span class="string">"timeUs"</span>, timeUs);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((streamMask | resumeMask) &amp; indexToType(i)) &#123;</span><br><span class="line">            msg-&gt;setString(mStreams[i].uriKey().c_str(), URIs[i].c_str());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Every time a fetcher acknowledges the stopAsync or pauseAsync request</span></span><br><span class="line">    <span class="comment">// we'll decrement mContinuationCounter, once it reaches zero, i.e. all</span></span><br><span class="line">    <span class="comment">// fetchers have completed their asynchronous operation, we'll post</span></span><br><span class="line">    <span class="comment">// mContinuation, which then is handled below in onChangeConfiguration2.</span></span><br><span class="line">  	<span class="comment">//æ¯æ¬¡fetcher è°ƒç”¨äº†stopAsyncå’ŒpauseAsync mContinuationCounter æ•°å€¼éƒ½ä¼šå‡å»1,ä¸€æ—¦å‡åˆ°0 é‚£ä¹ˆå°†ä¼šåœ¨onChangeConfiguration2å¤„ç†</span></span><br><span class="line">    mContinuationCounter = mFetcherInfos.size();</span><br><span class="line">    mContinuation = msg;</span><br><span class="line">    <span class="keyword">if</span> (mContinuationCounter == <span class="number">0</span>) &#123;</span><br><span class="line">        msg-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LiveSession::onChangeConfiguration2(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">    CHECK(msg-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timeUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        mLastSeekTimeUs = timeUs;</span><br><span class="line">        mLastDequeuedTimeUs = timeUs;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mPacketSources.size(); i++) &#123;</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; packetSource = mPacketSources.editValueAt(i);</span><br><span class="line">            sp&lt;MetaData&gt; format = packetSource-&gt;getFormat();</span><br><span class="line">            packetSource-&gt;clear();</span><br><span class="line">            packetSource-&gt;setFormat(format);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">            mStreams[i].reset();</span><br><span class="line">        &#125;</span><br><span class="line">        mDiscontinuityOffsetTimesUs.clear();</span><br><span class="line">        mDiscontinuityAbsStartTimesUs.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSeekReplyID != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            CHECK(mSeekReply != <span class="literal">NULL</span>);</span><br><span class="line">            mSeekReply-&gt;setInt32(<span class="string">"err"</span>, OK);</span><br><span class="line">            mSeekReply-&gt;postReply(mSeekReplyID);</span><br><span class="line">            mSeekReplyID.clear();</span><br><span class="line">            mSeekReply.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        restartPollBuffering();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> streamMask, resumeMask;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"streamMask"</span>, (<span class="keyword">int32_t</span> *)&amp;streamMask));</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"resumeMask"</span>, (<span class="keyword">int32_t</span> *)&amp;resumeMask));</span><br><span class="line"></span><br><span class="line">    streamMask |= resumeMask;</span><br><span class="line"></span><br><span class="line">    AString URIs[kMaxStreams];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (streamMask &amp; indexToType(i)) &#123;</span><br><span class="line">            <span class="keyword">const</span> AString &amp;uriKey = mStreams[i].uriKey();</span><br><span class="line">            CHECK(msg-&gt;findString(uriKey.c_str(), &amp;URIs[i]));</span><br><span class="line">            ALOGV(<span class="string">"%s = '%s'"</span>, uriKey.c_str(), URIs[i].c_str());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> changedMask = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams &amp;&amp; i != kSubtitleIndex; ++i) &#123;</span><br><span class="line">        <span class="comment">// stream URI could change even if onChangeConfiguration2 is only</span></span><br><span class="line">        <span class="comment">// used for seek. Seek could happen during a bw switch, in this</span></span><br><span class="line">        <span class="comment">// case bw switch will be cancelled, but the seekTo position will</span></span><br><span class="line">        <span class="comment">// fetch from the new URI.</span></span><br><span class="line">        <span class="keyword">if</span> ((mStreamMask &amp; streamMask &amp; indexToType(i))</span><br><span class="line">                &amp;&amp; !mStreams[i].mUri.empty()</span><br><span class="line">                &amp;&amp; !(URIs[i] == mStreams[i].mUri)) &#123;</span><br><span class="line">            ALOGV(<span class="string">"stream %zu changed: oldURI %s, newURI %s"</span>, i,</span><br><span class="line">                    mStreams[i].mUri.c_str(), URIs[i].c_str());</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; source = mPacketSources.valueFor(indexToType(i));</span><br><span class="line">            <span class="keyword">if</span> (source-&gt;getLatestDequeuedMeta() != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                source-&gt;queueDiscontinuity(ATSParser::DISCONTINUITY_FORMATCHANGE, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Determine which decoders to shutdown on the player side,</span></span><br><span class="line">        <span class="comment">// a decoder has to be shutdown if its streamtype was active</span></span><br><span class="line">        <span class="comment">// before but now longer isn't.</span></span><br><span class="line">        <span class="keyword">if</span> ((mStreamMask &amp; ~streamMask &amp; indexToType(i))) &#123;</span><br><span class="line">            changedMask |= indexToType(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è¿™é‡Œä¼šè§¦å‘kWhatStreamsChanged</span></span><br><span class="line">    sp&lt;AMessage&gt; notify = mNotify-&gt;dup();</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"what"</span>, kWhatStreamsChanged);</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"changedMask"</span>, changedMask);</span><br><span class="line">	<span class="comment">//å°†kWhatChangeConfiguration3ä½œä¸ºå›å¤æ¶ˆæ¯</span></span><br><span class="line">    msg-&gt;setWhat(kWhatChangeConfiguration3);</span><br><span class="line">    msg-&gt;setTarget(<span class="keyword">this</span>);</span><br><span class="line">    notify-&gt;setMessage(<span class="string">"reply"</span>, msg);</span><br><span class="line">    notify-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">void</span> LiveSession::onChangeConfiguration3(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    mContinuation.clear();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint32_t</span> streamMask, resumeMask;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"streamMask"</span>, (<span class="keyword">int32_t</span> *)&amp;streamMask));</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"resumeMask"</span>, (<span class="keyword">int32_t</span> *)&amp;resumeMask));</span><br><span class="line"></span><br><span class="line">    mNewStreamMask = streamMask | resumeMask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">    <span class="keyword">int32_t</span> pickTrack;</span><br><span class="line">    <span class="keyword">bool</span> switching = <span class="literal">false</span>;</span><br><span class="line">    CHECK(msg-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs));</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"pickTrack"</span>, &amp;pickTrack));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; i++) &#123;</span><br><span class="line">        ......</span><br><span class="line">        fetcher-&gt;startAsync(</span><br><span class="line">                sources[kAudioIndex],</span><br><span class="line">                sources[kVideoIndex],</span><br><span class="line">                sources[kSubtitleIndex],</span><br><span class="line">                getMetadataSource(sources, mNewStreamMask, switching),</span><br><span class="line">                startTime.mTimeUs &lt; <span class="number">0</span> ? mLastSeekTimeUs : startTime.mTimeUs,</span><br><span class="line">                startTime.getSegmentTimeUs(),</span><br><span class="line">                startTime.mSeq,</span><br><span class="line">                seekMode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">```cpp</span><br><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\PlaylistFetcher.cpp]</span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::startAsync(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; &amp;audioSource,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; &amp;videoSource,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; &amp;subtitleSource,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; &amp;metadataSource,</span><br><span class="line">        <span class="keyword">int64_t</span> startTimeUs,</span><br><span class="line">        <span class="keyword">int64_t</span> segmentStartTimeUs,</span><br><span class="line">        <span class="keyword">int32_t</span> startDiscontinuitySeq,</span><br><span class="line">        LiveSession::SeekMode seekMode) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatStart, <span class="keyword">this</span>);</span><br><span class="line">    ......</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"streamTypeMask"</span>, streamTypeMask);</span><br><span class="line">    msg-&gt;setInt64(<span class="string">"startTimeUs"</span>, startTimeUs);</span><br><span class="line">    msg-&gt;setInt64(<span class="string">"segmentStartTimeUs"</span>, segmentStartTimeUs);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"startDiscontinuitySeq"</span>, startDiscontinuitySeq);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"seekMode"</span>, seekMode);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">status_t</span> PlaylistFetcher::onStart(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    postMonitorQueue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::postMonitorQueue(<span class="keyword">int64_t</span> delayUs, <span class="keyword">int64_t</span> minDelayUs) &#123;</span><br><span class="line">    <span class="keyword">int64_t</span> maxDelayUs = delayUsToRefreshPlaylist();</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatMonitorQueue, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"generation"</span>, mMonitorQueueGeneration);</span><br><span class="line">    msg-&gt;post(delayUs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> kWhatDownloadNext:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int32_t</span> generation;</span><br><span class="line">            CHECK(msg-&gt;findInt32(<span class="string">"generation"</span>, &amp;generation));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (generation != mMonitorQueueGeneration) &#123;</span><br><span class="line">                <span class="comment">// Stale event</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (msg-&gt;what() == kWhatMonitorQueue) &#123;</span><br><span class="line">                onMonitorQueue();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                onDownloadNext();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::onDownloadNext() &#123;</span><br><span class="line">    AString uri;</span><br><span class="line">    sp&lt;AMessage&gt; itemMeta;</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    sp&lt;ABuffer&gt; tsBuffer;</span><br><span class="line">    <span class="keyword">int32_t</span> firstSeqNumberInPlaylist = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> lastSeqNumberInPlaylist = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> connectHTTP = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// block-wise download</span></span><br><span class="line">    <span class="keyword">bool</span> shouldPause = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> bytesRead;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> startUs = ALooper::GetNowUs();</span><br><span class="line">        bytesRead = mHTTPDownloader-&gt;fetchBlock(</span><br><span class="line">                uri.c_str(), &amp;buffer, range_offset, range_length, kDownloadBlockSize,</span><br><span class="line">                <span class="literal">NULL</span> <span class="comment">/* actualURL */</span>, connectHTTP);</span><br><span class="line">        <span class="keyword">int64_t</span> delayUs = ALooper::GetNowUs() - startUs;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (bufferStartsWithTsSyncByte(buffer)) &#123;</span><br><span class="line">            <span class="comment">// Incremental extraction is only supported for MPEG2 transport streams.</span></span><br><span class="line">            <span class="keyword">if</span> (tsBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                tsBuffer = <span class="keyword">new</span> ABuffer(buffer-&gt;data(), buffer-&gt;capacity());</span><br><span class="line">                tsBuffer-&gt;setRange(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tsBuffer-&gt;capacity() != buffer-&gt;capacity()) &#123;</span><br><span class="line">                <span class="keyword">size_t</span> tsOff = tsBuffer-&gt;offset(), tsSize = tsBuffer-&gt;size();</span><br><span class="line">                tsBuffer = <span class="keyword">new</span> ABuffer(buffer-&gt;data(), buffer-&gt;capacity());</span><br><span class="line">                tsBuffer-&gt;setRange(tsOff, tsSize);</span><br><span class="line">            &#125;</span><br><span class="line">            tsBuffer-&gt;setRange(tsBuffer-&gt;offset(), tsBuffer-&gt;size() + bytesRead);</span><br><span class="line">            err = extractAndQueueAccessUnitsFromTs(tsBuffer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">while</span> (bytesRead != <span class="number">0</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// bulk extract non-ts files</span></span><br><span class="line">    <span class="keyword">bool</span> startUp = mStartup;</span><br><span class="line">    <span class="keyword">if</span> (tsBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> err = extractAndQueueAccessUnits(buffer, itemMeta);</span><br><span class="line">        <span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">            <span class="comment">// starting sequence number too low/high</span></span><br><span class="line">            postMonitorQueue();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == ERROR_OUT_OF_RANGE) &#123;</span><br><span class="line">            <span class="comment">// reached stopping point</span></span><br><span class="line">            notifyStopReached();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            notifyError(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> PlaylistFetcher::extractAndQueueAccessUnits(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;itemMeta) &#123;</span><br><span class="line">    <span class="keyword">if</span> (bufferStartsWithWebVTTMagicSequence(buffer)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStreamTypeMask != LiveSession::STREAMTYPE_SUBTITLES) &#123;</span><br><span class="line">            ALOGE(<span class="string">"This stream only contains subtitles."</span>);</span><br><span class="line">            <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; packetSource =</span><br><span class="line">            mPacketSources.valueFor(LiveSession::STREAMTYPE_SUBTITLES);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int64_t</span> durationUs;</span><br><span class="line">        CHECK(itemMeta-&gt;findInt64(<span class="string">"durationUs"</span>, &amp;durationUs));</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt64(<span class="string">"timeUs"</span>, getSegmentStartTimeUs(mSeqNumber));</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt64(<span class="string">"durationUs"</span>, durationUs);</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt64(<span class="string">"segmentStartTimeUs"</span>, getSegmentStartTimeUs(mSeqNumber));</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt32(<span class="string">"discontinuitySeq"</span>, mDiscontinuitySeq);</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt32(<span class="string">"subtitleGeneration"</span>, mSubtitleGeneration);</span><br><span class="line">        packetSource-&gt;queueAccessUnit(buffer);</span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (offset &lt; buffer-&gt;size()) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint8_t</span> *adtsHeader = buffer-&gt;data() + offset;</span><br><span class="line">        CHECK_LT(offset + <span class="number">5</span>, buffer-&gt;size());</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        sp&lt;ABuffer&gt; unit = <span class="keyword">new</span> ABuffer(aac_frame_length);</span><br><span class="line">        <span class="built_in">memcpy</span>(unit-&gt;data(), adtsHeader, aac_frame_length);</span><br><span class="line"></span><br><span class="line">        unit-&gt;meta()-&gt;setInt64(<span class="string">"timeUs"</span>, unitTimeUs);</span><br><span class="line">        setAccessUnitProperties(unit, packetSource);</span><br><span class="line">        packetSource-&gt;queueAccessUnit(unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\mpeg2ts\AnotherPacketSource.cpp]</span><br><span class="line"><span class="keyword">void</span> AnotherPacketSource::queueAccessUnit(<span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> damaged;</span><br><span class="line">    ......</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    mBuffers.push_back(buffer);</span><br><span class="line">    mCondition.signal();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> discontinuity;</span><br><span class="line">    <span class="keyword">if</span> (buffer-&gt;meta()-&gt;findInt32(<span class="string">"discontinuity"</span>, &amp;discontinuity))&#123;</span><br><span class="line">        ALOGV(<span class="string">"queueing a discontinuity with queueAccessUnit"</span>);</span><br><span class="line"></span><br><span class="line">        mLastQueuedTimeUs = <span class="number">0l</span>l;</span><br><span class="line">        mEOSResult = OK;</span><br><span class="line">        mLatestEnqueuedMeta = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        mDiscontinuitySegments.push_back(DiscontinuitySegment());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-2ã€è·å–æ•°æ®è¿›è¡Œè§£ç "><a href="#2-2ã€è·å–æ•°æ®è¿›è¡Œè§£ç " class="headerlink" title="2.2ã€è·å–æ•°æ®è¿›è¡Œè§£ç "></a>2.2ã€è·å–æ•°æ®è¿›è¡Œè§£ç </h5><p>å…³äºè§£ç åˆå§‹åŒ–NuPlayer::instantiateDecoderè¿‡ç¨‹è¯·å‚è€ƒï¼š<a href="http://zhoujinjian.cc/2018/06/06/Android%20Video%20System%EF%BC%882%EF%BC%89%EF%BC%9A%E9%9F%B3%E8%A7%86%E9%A2%91%E5%88%86%E7%A6%BBMediaExtractor%E3%80%81%E8%A7%A3%E7%A0%81Decoder%E3%80%81%E6%B8%B2%E6%9F%93Renderer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ</a><br>æˆ‘ä»¬ç›´æ¥çœ‹å¦‚ä½•è·å–æ•°æ®è¿›è¡Œè§£ç :</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">void</span> ACodec::signalResume() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatResume, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatResume:</span><br><span class="line">&#123;</span><br><span class="line">    resume();</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ACodec::ExecutingState::resume() &#123;</span><br><span class="line"></span><br><span class="line">    submitOutputBuffers();</span><br><span class="line">    <span class="comment">// Post all available input buffers</span></span><br><span class="line">    <span class="keyword">if</span> (mCodec-&gt;mBuffers[kPortIndexInput].size() == <span class="number">0u</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"[%s] we don't have any input buffers to resume"</span>, mCodec-&gt;mComponentName.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mCodec-&gt;mBuffers[kPortIndexInput].size(); i++) &#123;</span><br><span class="line">        BufferInfo *info = &amp;mCodec-&gt;mBuffers[kPortIndexInput].editItemAt(i);</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;mStatus == BufferInfo::OWNED_BY_US) &#123;</span><br><span class="line">            postFillThisBuffer(info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActive = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ACodec::BaseState::postFillThisBuffer(BufferInfo *info) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mCodec-&gt;mPortEOS[kPortIndexInput]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHECK_EQ((<span class="keyword">int</span>)info-&gt;mStatus, (<span class="keyword">int</span>)BufferInfo::OWNED_BY_US);</span><br><span class="line">    sp&lt;AMessage&gt; notify = mCodec-&gt;mNotify-&gt;dup();</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"what"</span>, CodecBase::kWhatFillThisBuffer);</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"buffer-id"</span>, info-&gt;mBufferID);</span><br><span class="line">    info-&gt;mData-&gt;meta()-&gt;clear();</span><br><span class="line">    notify-&gt;setBuffer(<span class="string">"buffer"</span>, info-&gt;mData);</span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatInputBufferFilled, mCodec);</span><br><span class="line">    reply-&gt;setInt32(<span class="string">"buffer-id"</span>, info-&gt;mBufferID);</span><br><span class="line">    notify-&gt;setMessage(<span class="string">"reply"</span>, reply);</span><br><span class="line">    notify-&gt;post();</span><br><span class="line">    info-&gt;mStatus = BufferInfo::OWNED_BY_UPSTREAM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> CodecBase::kWhatFillThisBuffer:</span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//..........</span></span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; kFlagIsAsync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mHaveInputSurface) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mState == FLUSHED) &#123;</span><br><span class="line">                mHavePendingInputBuffers = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                onInputBufferAvailable();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFlags &amp; kFlagDequeueInputPending) &#123;</span><br><span class="line">        CHECK(handleDequeueInputBuffer(mDequeueInputReplyID));</span><br><span class="line">        ++mDequeueInputTimeoutGeneration;</span><br><span class="line">        mFlags &amp;= ~kFlagDequeueInputPending;</span><br><span class="line">        mDequeueInputReplyID = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        postActivityNotificationIfPossible();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> MediaCodec::onInputBufferAvailable() &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    <span class="keyword">while</span> ((index = dequeuePortBuffer(kPortIndexInput)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = mCallback-&gt;dup();</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"callbackID"</span>, CB_INPUT_AVAILABLE);</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"index"</span>, index);</span><br><span class="line">        msg-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">è¿™ä¸ªmCallbackæ€ä¹ˆæ¥çš„ï¼Ÿ</span><br><span class="line"></span><br><span class="line">``` cpp</span><br><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Decoder::onConfigure(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.................</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatCodecNotify, <span class="keyword">this</span>);</span><br><span class="line">    mCodec-&gt;setCallback(reply);</span><br><span class="line">	<span class="comment">//..................</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodec.cpp]</span><br><span class="line"><span class="keyword">status_t</span> MediaCodec::setCallback(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;callback) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetCallback, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setMessage(<span class="string">"callback"</span>, callback);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; response;</span><br><span class="line">    <span class="keyword">return</span> PostAndAwaitResponse(msg, &amp;response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatSetCallback:</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">    CHECK(msg-&gt;senderAwaitsResponse(&amp;replyID));</span><br><span class="line">    sp&lt;AMessage&gt; callback;</span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"callback"</span>, &amp;callback));</span><br><span class="line"></span><br><span class="line">    mCallback = callback;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCallback != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mFlags |= kFlagIsAsync;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mFlags &amp;= ~kFlagIsAsync;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; response = <span class="keyword">new</span> AMessage;</span><br><span class="line">    response-&gt;postReply(replyID);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ ¹æ®ä¸Šé¢æˆ‘ä»¬å¯ä»¥çŸ¥é“æ¥ä¸‹æ¥iè°ƒç”¨çš„æ˜¯kWhatCodecNotify ä¸‹çš„ CB_INPUT_AVAILABLE</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">case</span> MediaCodec::CB_INPUT_AVAILABLE:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"index"</span>, &amp;index));</span><br><span class="line"></span><br><span class="line">    handleAnInputBuffer(index);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">bool</span> NuPlayer::Decoder::handleAnInputBuffer(<span class="keyword">size_t</span> index) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDiscontinuityPending()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    mCodec-&gt;getInputBuffer(index, &amp;buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        handleError(UNKNOWN_ERROR);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mInputBuffers.size()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = mInputBuffers.size(); i &lt;= index; ++i) &#123;</span><br><span class="line">            mInputBuffers.add();</span><br><span class="line">            mMediaBuffers.add();</span><br><span class="line">            mInputBufferIsDequeued.add();</span><br><span class="line">            mMediaBuffers.editItemAt(i) = <span class="literal">NULL</span>;</span><br><span class="line">            mInputBufferIsDequeued.editItemAt(i) = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBuffers.editItemAt(index) = buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CHECK_LT(bufferIx, mInputBuffers.size());</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mMediaBuffers[index] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mMediaBuffers[index]-&gt;release();</span><br><span class="line">        mMediaBuffers.editItemAt(index) = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBufferIsDequeued.editItemAt(index) = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mCSDsToSubmit.isEmpty()) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage();</span><br><span class="line">        msg-&gt;setSize(<span class="string">"buffer-ix"</span>, index);</span><br><span class="line"></span><br><span class="line">        sp&lt;ABuffer&gt; buffer = mCSDsToSubmit.itemAt(<span class="number">0</span>);</span><br><span class="line">        ALOGI(<span class="string">"[%s] resubmitting CSD"</span>, mComponentName.c_str());</span><br><span class="line">        msg-&gt;setBuffer(<span class="string">"buffer"</span>, buffer);</span><br><span class="line">        mCSDsToSubmit.removeAt(<span class="number">0</span>);</span><br><span class="line">        CHECK(onInputBufferFetched(msg));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!mPendingInputMessages.empty()) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = *mPendingInputMessages.begin();</span><br><span class="line">        <span class="keyword">if</span> (!onInputBufferFetched(msg)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingInputMessages.erase(mPendingInputMessages.begin());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mInputBufferIsDequeued.editItemAt(index)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDequeuedInputBuffers.push_back(index);</span><br><span class="line"></span><br><span class="line">    onRequestInputBuffers();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoderBase.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::DecoderBase::onRequestInputBuffers() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mRequestInputBuffersPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// doRequestBuffers() return true if we should request more data</span></span><br><span class="line">    <span class="keyword">if</span> (doRequestBuffers()) &#123;</span><br><span class="line">        mRequestInputBuffersPending = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatRequestInputBuffers, <span class="keyword">this</span>);</span><br><span class="line">        msg-&gt;post(<span class="number">10</span> * <span class="number">1000l</span>l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">bool</span> NuPlayer::Decoder::doRequestBuffers() &#123;</span><br><span class="line">    <span class="comment">// mRenderer is only NULL if we have a legacy widevine source that</span></span><br><span class="line">    <span class="comment">// is not yet ready. In this case we must not fetch input.</span></span><br><span class="line">    <span class="keyword">if</span> (isDiscontinuityPending() || mRenderer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">status_t</span> err = OK;</span><br><span class="line">    <span class="keyword">while</span> (err == OK &amp;&amp; !mDequeuedInputBuffers.empty()) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> bufferIx = *mDequeuedInputBuffers.begin();</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage();</span><br><span class="line">        msg-&gt;setSize(<span class="string">"buffer-ix"</span>, bufferIx);</span><br><span class="line">        err = fetchInputData(msg);</span><br><span class="line">        <span class="keyword">if</span> (err != OK &amp;&amp; err != ERROR_END_OF_STREAM) &#123;</span><br><span class="line">            <span class="comment">// if EOS, need to queue EOS buffer</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mDequeuedInputBuffers.erase(mDequeuedInputBuffers.begin());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mPendingInputMessages.empty()</span><br><span class="line">                || !onInputBufferFetched(msg)) &#123;</span><br><span class="line">            mPendingInputMessages.push_back(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err == -EWOULDBLOCK</span><br><span class="line">            &amp;&amp; mSource-&gt;feedMoreTSData() == OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">status_t</span> NuPlayer::Decoder::fetchInputData(sp&lt;AMessage&gt; &amp;reply) &#123;</span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    <span class="keyword">bool</span> dropAccessUnit;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">status_t</span> err = mSource-&gt;dequeueAccessUnit(mIsAudio, &amp;accessUnit);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == -EWOULDBLOCK) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err == INFO_DISCONTINUITY) &#123;</span><br><span class="line">                <span class="keyword">int32_t</span> type;</span><br><span class="line">                CHECK(accessUnit-&gt;meta()-&gt;findInt32(<span class="string">"discontinuity"</span>, &amp;type));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">bool</span> formatChange =</span><br><span class="line">                    (mIsAudio &amp;&amp;</span><br><span class="line">                     (type &amp; ATSParser::DISCONTINUITY_AUDIO_FORMAT))</span><br><span class="line">                    || (!mIsAudio &amp;&amp;</span><br><span class="line">                            (type &amp; ATSParser::DISCONTINUITY_VIDEO_FORMAT));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">bool</span> timeChange = (type &amp; ATSParser::DISCONTINUITY_TIME) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                ALOGI(<span class="string">"%s discontinuity (format=%d, time=%d)"</span>,</span><br><span class="line">                        mIsAudio ? <span class="string">"audio"</span> : <span class="string">"video"</span>, formatChange, timeChange);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">bool</span> seamlessFormatChange = <span class="literal">false</span>;</span><br><span class="line">                sp&lt;AMessage&gt; newFormat = mSource-&gt;getFormat(mIsAudio);</span><br><span class="line">                <span class="keyword">if</span> (formatChange) &#123;</span><br><span class="line">                    seamlessFormatChange =</span><br><span class="line">                        supportsSeamlessFormatChange(newFormat);</span><br><span class="line">                    <span class="comment">// treat seamless format change separately</span></span><br><span class="line">                    formatChange = !seamlessFormatChange;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For format or time change, return EOS to queue EOS input,</span></span><br><span class="line">                <span class="comment">// then wait for EOS on output.</span></span><br><span class="line">                <span class="keyword">if</span> (formatChange <span class="comment">/* not seamless */</span>) &#123;</span><br><span class="line">                    mFormatChangePending = <span class="literal">true</span>;</span><br><span class="line">                    err = ERROR_END_OF_STREAM;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeChange) &#123;</span><br><span class="line">                    rememberCodecSpecificData(newFormat);</span><br><span class="line">                    mTimeChangePending = <span class="literal">true</span>;</span><br><span class="line">                    err = ERROR_END_OF_STREAM;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seamlessFormatChange) &#123;</span><br><span class="line">                    <span class="comment">// reuse existing decoder and don't flush</span></span><br><span class="line">                    rememberCodecSpecificData(newFormat);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// This stream is unaffected by the discontinuity</span></span><br><span class="line">                    <span class="keyword">return</span> -EWOULDBLOCK;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reply should only be returned without a buffer set</span></span><br><span class="line">            <span class="comment">// when there is an error (including EOS)</span></span><br><span class="line">            CHECK(err != OK);</span><br><span class="line"></span><br><span class="line">            reply-&gt;setInt32(<span class="string">"err"</span>, err);</span><br><span class="line">            <span class="keyword">return</span> ERROR_END_OF_STREAM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dropAccessUnit = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mIsAudio</span><br><span class="line">                &amp;&amp; !mIsSecure</span><br><span class="line">                &amp;&amp; mRenderer-&gt;getVideoLateByUs() &gt; <span class="number">100000l</span>l</span><br><span class="line">                &amp;&amp; mIsVideoAVC</span><br><span class="line">                &amp;&amp; !IsAVCReferenceFrame(accessUnit)) &#123;</span><br><span class="line">            dropAccessUnit = <span class="literal">true</span>;</span><br><span class="line">            ++mNumInputFramesDropped;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (dropAccessUnit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGV("returned a valid buffer of %s data", mIsAudio ? "mIsAudio" : "video");</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="keyword">int64_t</span> mediaTimeUs;</span><br><span class="line">    CHECK(accessUnit-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;mediaTimeUs));</span><br><span class="line">    ALOGV(<span class="string">"[%s] feeding input buffer at media time %.3f"</span>,</span><br><span class="line">         mIsAudio ? <span class="string">"audio"</span> : <span class="string">"video"</span>,</span><br><span class="line">         mediaTimeUs / <span class="number">1E6</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCCDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mCCDecoder-&gt;decode(accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reply-&gt;setBuffer(<span class="string">"buffer"</span>, accessUnit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3ã€å¾ªç¯è·å–æ•°æ®HTTPLiveSource-dequeueAccessUnit"><a href="#2-3ã€å¾ªç¯è·å–æ•°æ®HTTPLiveSource-dequeueAccessUnit" class="headerlink" title="2.3ã€å¾ªç¯è·å–æ•°æ®HTTPLiveSource::dequeueAccessUnit()"></a>2.3ã€å¾ªç¯è·å–æ•°æ®HTTPLiveSource::dequeueAccessUnit()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">status_t</span> LiveSession::dequeueAccessUnit(</span><br><span class="line">        StreamType stream, sp&lt;ABuffer&gt; *accessUnit) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> finalResult = OK;</span><br><span class="line">    sp&lt;AnotherPacketSource&gt; packetSource = mPacketSources.valueFor(stream);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = packetSource-&gt;dequeueAccessUnit(accessUnit);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\mpeg2ts\AnotherPacketSource.cpp]</span><br><span class="line"><span class="keyword">status_t</span> AnotherPacketSource::dequeueAccessUnit(sp&lt;ABuffer&gt; *buffer) &#123;</span><br><span class="line">    buffer-&gt;clear();</span><br><span class="line"></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (mEOSResult == OK &amp;&amp; mBuffers.empty()) &#123;</span><br><span class="line">        mCondition.wait(mLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mBuffers.empty()) &#123;</span><br><span class="line">        *buffer = *mBuffers.begin();</span><br><span class="line">        mBuffers.erase(mBuffers.begin());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int32_t</span> discontinuity;</span><br><span class="line">        <span class="keyword">if</span> ((*buffer)-&gt;meta()-&gt;findInt32(<span class="string">"discontinuity"</span>, &amp;discontinuity)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (wasFormatChange(discontinuity)) &#123;</span><br><span class="line">                mFormat.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mDiscontinuitySegments.erase(mDiscontinuitySegments.begin());</span><br><span class="line">            <span class="comment">// CHECK(!mDiscontinuitySegments.empty());</span></span><br><span class="line">            <span class="keyword">return</span> INFO_DISCONTINUITY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CHECK(!mDiscontinuitySegments.empty());</span></span><br><span class="line">        DiscontinuitySegment &amp;seg = *mDiscontinuitySegments.begin();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">        mLatestDequeuedMeta = (*buffer)-&gt;meta()-&gt;dup();</span><br><span class="line">        CHECK(mLatestDequeuedMeta-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs));</span><br><span class="line">        <span class="keyword">if</span> (timeUs &gt; seg.mMaxDequeTimeUs) &#123;</span><br><span class="line">            seg.mMaxDequeTimeUs = timeUs;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sp&lt;RefBase&gt; object;</span><br><span class="line">        <span class="keyword">if</span> ((*buffer)-&gt;meta()-&gt;findObject(<span class="string">"format"</span>, &amp;object)) &#123;</span><br><span class="line">            setFormat(<span class="keyword">static_cast</span>&lt;MetaData*&gt;(object.get()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mEOSResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-4ã€è§£ç åéŸ³è§†é¢‘æ’­æ”¾è¿‡ç¨‹"><a href="#2-4ã€è§£ç åéŸ³è§†é¢‘æ’­æ”¾è¿‡ç¨‹" class="headerlink" title="2.4ã€è§£ç åéŸ³è§†é¢‘æ’­æ”¾è¿‡ç¨‹"></a>2.4ã€è§£ç åéŸ³è§†é¢‘æ’­æ”¾è¿‡ç¨‹</h5><p>å…³äºè§£ç åæ’­æ”¾è¿‡ç¨‹è¯·å‚è€ƒï¼š<a href="http://zhoujinjian.cc/2018/09/12/Android%20Video%20System%EF%BC%885%EF%BC%89%EF%BC%9AAndroid%20Multimedia%20-%20NuPlayer%E9%9F%B3%E8%A7%86%E9%A2%91%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/">Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</a></p><h4 id="ï¼ˆä¸‰ï¼‰ã€åŸºäºNuPlayerçš„RTSPæµåª’ä½“åè®®"><a href="#ï¼ˆä¸‰ï¼‰ã€åŸºäºNuPlayerçš„RTSPæµåª’ä½“åè®®" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€åŸºäºNuPlayerçš„RTSPæµåª’ä½“åè®®"></a>ï¼ˆä¸‰ï¼‰ã€åŸºäºNuPlayerçš„RTSPæµåª’ä½“åè®®</h4><h5 id="3-1-1ã€RTSP-æ¦‚è¿°ï¼š"><a href="#3-1-1ã€RTSP-æ¦‚è¿°ï¼š" class="headerlink" title="3.1.1ã€RTSP æ¦‚è¿°ï¼š"></a>3.1.1ã€RTSP æ¦‚è¿°ï¼š</h5><p>RTSP æ˜¯Real Time Streaming Protocolï¼ˆå®æ—¶æµåª’ä½“åè®®ï¼‰çš„ç®€ç§°ã€‚RTSPæä¾›ä¸€ç§å¯æ‰©å±•çš„æ¡†æ¶ï¼Œä½¿å¾—èƒ½å¤Ÿæä¾›å¯æ§åˆ¶çš„ï¼ŒæŒ‰éœ€ä¼ è¾“å®æ—¶æ•°æ®ï¼Œæ¯”å¦‚éŸ³é¢‘å’Œè§†é¢‘æ–‡ä»¶ã€‚RTSPå¯¹æµåª’ä½“æä¾›äº†è¯¸å¦‚æš‚åœï¼Œå¿«è¿›ç­‰æ§åˆ¶ï¼Œè€Œå®ƒæœ¬èº«å¹¶ä¸ä¼ è¾“æ•°æ®ï¼ŒRTSPä½œç”¨ç›¸å½“äºæµåª’ä½“æœåŠ¡å™¨çš„è¿œç¨‹æ§åˆ¶ã€‚ä¼ è¾“æ•°æ®å¯ä»¥é€šè¿‡ä¼ è¾“å±‚çš„TCPï¼ŒUDPåè®®ï¼ŒRTSPä¹Ÿæä¾›äº†åŸºäº RTPä¼ è¾“æœºåˆ¶çš„ä¸€äº›æœ‰æ•ˆçš„æ–¹æ³•ã€‚</p><h5 id="3-1-2ã€RTSP-æ¨¡å‹ï¼š"><a href="#3-1-2ã€RTSP-æ¨¡å‹ï¼š" class="headerlink" title="3.1.2ã€RTSP æ¨¡å‹ï¼š"></a>3.1.2ã€RTSP æ¨¡å‹ï¼š</h5><p>å®¢æˆ·æœºåœ¨å‘è§†é¢‘æœåŠ¡å™¨è¯·æ±‚è§†é¢‘æœåŠ¡ä¹‹å‰ï¼Œé¦–å…ˆé€šè¿‡HTTPåè®®ä»WEBæœåŠ¡å™¨è·å–æ‰€è¯·æ±‚è§†é¢‘æœåŠ¡çš„æ¼”ç¤ºæè¿°ï¼ˆPresentation descriptionï¼‰æ–‡ä»¶ï¼Œåœ¨RTSPä¸­ï¼Œæ¯ä¸ªæ¼”ç¤ºï¼ˆPresentationï¼‰åŠå…¶æ‰€å¯¹åº”çš„åª’ä½“æµéƒ½ç”±ä¸€ä¸ªRTSP URLæ ‡è¯†ã€‚æ•´ä¸ªæ¼”ç¤ºåŠåª’ä½“ç‰¹æ€§éƒ½åœ¨ä¸€ä¸ªæ¼”ç¤ºæè¿°ï¼ˆPresentation descriptionï¼‰æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¯¥æ–‡ä»¶å¯èƒ½åŒ…æ‹¬åª’ä½“ç¼–ç æ–¹å¼ã€è¯­è¨€ã€RTSPURLsã€ç›®æ ‡åœ°å€ã€ç«¯å£åŠå…¶å®ƒå‚æ•°ã€‚ç”¨æˆ·åœ¨å‘æœåŠ¡å™¨è¯·æ±‚æŸä¸ªè¿ç»­åª’ä½“æµçš„æœåŠ¡ä¹‹å‰ï¼Œå¿…é¡»é¦–å…ˆä»æœåŠ¡å™¨è·å¾—è¯¥åª’ä½“æµçš„æ¼”ç¤ºæè¿°ï¼ˆPresentation description ï¼‰æ–‡ä»¶ä»¥å¾—åˆ°å¿…éœ€çš„å‚æ•°ã€‚åˆ©ç”¨è¯¥æ–‡ä»¶æä¾›çš„ä¿¡æ¯å®šä½è§†é¢‘æœåŠ¡åœ°å€ï¼ˆåŒ…æ‹¬è§†é¢‘æœåŠ¡å™¨åœ°å€å’Œç«¯å£å·ï¼‰åŠè§†é¢‘æœåŠ¡çš„ç¼–ç æ–¹å¼ç­‰ä¿¡æ¯ã€‚<br>å®¢æˆ·æœºæ ¹æ®ä¸Šè¿°ä¿¡æ¯å‘è§†é¢‘æœåŠ¡å™¨è¯·æ±‚è§†é¢‘æœåŠ¡ã€‚è§†é¢‘æœåŠ¡åˆå§‹åŒ–å®Œæ¯•ï¼Œè§†é¢‘æœåŠ¡å™¨ä¸ºè¯¥å®¢æˆ·å»ºç«‹ä¸€ä¸ªæ–°çš„è§†é¢‘æœåŠ¡æµï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿è¡Œå®æ—¶æµæ§åˆ¶åè®®RTSPï¼Œä»¥å¯¹è¯¥æµè¿›è¡Œå„ç§VCR æ§åˆ¶ä¿¡å·çš„äº¤æ¢ï¼Œå¦‚æ’­æ”¾ã€æš‚åœã€å¿«è¿›ã€å¿«é€€ç­‰ã€‚å½“æœåŠ¡å®Œæ¯•ï¼Œå®¢æˆ·ç«¯æå‡ºæ‹†çº¿ï¼ˆTEARDOWNï¼‰è¯·æ±‚ã€‚æœåŠ¡å™¨ä½¿ç”¨ RTPåè®®å°†åª’ä½“æ•°æ®ä¼ è¾“ç»™å®¢æˆ·ç«¯ï¼Œä¸€æ—¦æ•°æ®æŠµè¾¾å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå³å¯æ’­æ”¾è¾“å‡ºã€‚åœ¨æµå¼ä¼ è¾“ä¸­ï¼Œä½¿ç”¨RTP/RTCPå’ŒRTSP /TCPä¸¤ç§ä¸åŒçš„é€šä¿¡åè®®åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´å»ºç«‹è”ç³»ã€‚å¦‚ä¸‹å›¾ï¼š</p><h5 id="3-1-3ã€RTSP-åè®®æ¶ˆæ¯æ ¼å¼ï¼š"><a href="#3-1-3ã€RTSP-åè®®æ¶ˆæ¯æ ¼å¼ï¼š" class="headerlink" title="3.1.3ã€RTSP åè®®æ¶ˆæ¯æ ¼å¼ï¼š"></a>3.1.3ã€RTSP åè®®æ¶ˆæ¯æ ¼å¼ï¼š</h5><p>è¯·æ±‚æ¶ˆæ¯æ ¼å¼:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ–¹æ³•   URI  RTSPç‰ˆæœ¬   CR  LF </span><br><span class="line">æ¶ˆæ¯å¤´ CR   LF   CR  LF </span><br><span class="line">æ¶ˆæ¯ä½“ CR   LF</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ–¹æ³•åŒ…æ‹¬OPTIONå›åº”ä¸­æ‰€æœ‰çš„å‘½ä»¤,URIæ˜¯æ¥å—æ–¹çš„åœ°å€,ä¾‹å¦‚<br>rtsp://192.168.20.136</p><p>RTSPç‰ˆæœ¬ä¸€èˆ¬éƒ½æ˜¯ RTSP/1.0.æ¯è¡Œåé¢çš„CR LFè¡¨ç¤ºå›è½¦æ¢è¡Œï¼Œéœ€è¦æ¥å—ç«¯æœ‰ç›¸åº”çš„è§£æï¼Œæœ€åä¸€ä¸ªæ¶ˆæ¯å¤´éœ€è¦æœ‰ä¸¤ä¸ªCR LF</p><p>å›åº”æ¶ˆæ¯æ ¼å¼:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RTSPç‰ˆæœ¬  çŠ¶æ€ç   è§£é‡Š CR  LF </span><br><span class="line">æ¶ˆæ¯å¤´ CR  LF  CR  LF </span><br><span class="line">æ¶ˆæ¯ä½“ CR  LF</span><br></pre></td></tr></table></figure><p>å…¶ä¸­RTSPç‰ˆæœ¬ä¸€èˆ¬éƒ½æ˜¯RTSP/1.0,çŠ¶æ€ç æ˜¯ä¸€ä¸ªæ•°å€¼,200è¡¨ç¤ºæˆåŠŸ,è§£é‡Šæ˜¯ä¸çŠ¶æ€ç å¯¹åº”çš„æ–‡æœ¬è§£é‡Šã€‚</p><h5 id="3-1-4ã€ç®€å•çš„RTSP-äº¤äº’è¿‡ç¨‹"><a href="#3-1-4ã€ç®€å•çš„RTSP-äº¤äº’è¿‡ç¨‹" class="headerlink" title="3.1.4ã€ç®€å•çš„RTSP äº¤äº’è¿‡ç¨‹:"></a>3.1.4ã€ç®€å•çš„RTSP äº¤äº’è¿‡ç¨‹:</h5><p>ä¸‹é¢ä»¥ä¸€æ¬¡æµåª’ä½“æ’­æ”¾ä¸ºä¾‹ä»‹ç»æ•´ä¸ªæ’­æ”¾è¿‡ç¨‹çš„RTSPçŠ¶æ€è½¬æ¢çš„æµç¨‹ï¼š<br>å…¶ä¸­Cè¡¨ç¤ºRTSPå®¢æˆ·ç«¯,Sè¡¨ç¤ºRTSPæœåŠ¡ç«¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">C-&gt;S:OPTION     request        <span class="comment">//è¯¢é—®æœåŠ¡ç«¯æœ‰å“ªäº›æ–¹æ³•å¯ç”¨</span></span><br><span class="line">S-&gt;C:OPTION     response       <span class="comment">//æœåŠ¡ç«¯å›åº”ä¿¡æ¯ä¸­åŒ…æ‹¬æä¾›çš„æ‰€æœ‰å¯ç”¨æ–¹æ³• </span></span><br><span class="line"></span><br><span class="line">C-&gt;S:DESCRIBE    request        <span class="comment">//è¦æ±‚å¾—åˆ°æœåŠ¡ç«¯æä¾›çš„åª’ä½“åˆå§‹åŒ–æè¿°ä¿¡æ¯ </span></span><br><span class="line">S-&gt;C:DESCRIBE    response       <span class="comment">//æœåŠ¡ç«¯å›åº”åª’ä½“åˆå§‹åŒ–æè¿°ä¿¡æ¯ï¼Œä¸»è¦æ˜¯SDP</span></span><br><span class="line"></span><br><span class="line">C-&gt;S:SETUP       request        <span class="comment">//è®¾ç½®ä¼šè¯çš„å±æ€§ï¼Œä»¥åŠä¼ è¾“æ¨¡å¼æé†’æœåŠ¡ç«¯å»ºç«‹ä¼šè¯ </span></span><br><span class="line">S-&gt;C:SETUP       response       <span class="comment">//æœåŠ¡ç«¯å»ºç«‹ä¼šè¯ï¼Œè¿”å›ä¼šè¯æ ‡è¯†ç¬¦ï¼Œå’Œä¼šè¯ç›¸å…³ä¿¡æ¯ </span></span><br><span class="line"></span><br><span class="line">C-&gt;S:PLAY        request         <span class="comment">//å®¢æˆ·ç«¯è¯·æ±‚æ’­æ”¾ </span></span><br><span class="line">S-&gt;C:PLAY        response       <span class="comment">//æœåŠ¡å™¨å›åº”è¯¥è¯·æ±‚çš„ä¿¡æ¯ </span></span><br><span class="line"></span><br><span class="line">S-&gt;C:                           <span class="comment">//å‘é€æµåª’ä½“æ•°æ® </span></span><br><span class="line"></span><br><span class="line">C-&gt;S:TEARDOWN    request        <span class="comment">//å®¢æˆ·ç«¯è¯·æ±‚å…³é—­ä¼šè¯ </span></span><br><span class="line">S-&gt;C:TEARDOWN    response <span class="comment">//æœåŠ¡ç«¯å›åº”è¯¥è¯·æ±‚</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç¬¬SETUPå’ŒPLAYè¿™ä¸¤éƒ¨æ˜¯å¿…éœ€çš„ï¼Œ<br>OPTION æ­¥éª¤åªè¦æœåŠ¡å™¨å®¢æˆ·ç«¯çº¦å®šå¥½ï¼Œæœ‰å“ªäº›æ–¹æ³•å¯ç”¨ï¼Œåˆ™optionè¯·æ±‚å¯ä»¥ä¸è¦ã€‚<br>å¦‚æœæˆ‘ä»¬æœ‰å…¶ä»–é€”å¾„å¾—åˆ°åª’ä½“åˆå§‹åŒ–æè¿°ä¿¡æ¯ï¼Œåˆ™æˆ‘ä»¬ä¹Ÿä¸éœ€è¦é€šè¿‡RTSPä¸­çš„DESCRIPTIONè¯·æ±‚æ¥å®Œæˆã€‚<br>TEARDOWNï¼Œå¯ä»¥æ ¹æ®ç³»ç»Ÿéœ€æ±‚çš„è®¾è®¡æ¥å†³å®šæ˜¯å¦éœ€è¦ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-07-RTSP-TEARDOWN.png" alt="Alt text | center"></p><h5 id="3-1-5ã€RTSPçš„ä¸»è¦å‘½ä»¤è¡¨ï¼š"><a href="#3-1-5ã€RTSPçš„ä¸»è¦å‘½ä»¤è¡¨ï¼š" class="headerlink" title="3.1.5ã€RTSPçš„ä¸»è¦å‘½ä»¤è¡¨ï¼š"></a>3.1.5ã€RTSPçš„ä¸»è¦å‘½ä»¤è¡¨ï¼š</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-08-RTSP-option.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-09-RTSP-describe.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-10-RTSP-setup.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-11-RTSP-play.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-12-RTSP-teardowm.png" alt="Alt text | center"></p><p>RTSPçŠ¶æ€ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Status-Code =</span><br><span class="line">| <span class="string">"100"</span> ; 				Continue</span><br><span class="line">| <span class="string">"200"</span> ; 				OK</span><br><span class="line">| <span class="string">"201"</span> ; 				Created</span><br><span class="line">| <span class="string">"250"</span> ; 				Low on Storage Space</span><br><span class="line">| <span class="string">"300"</span> ; 				Multiple Choices</span><br><span class="line">| <span class="string">"301"</span> ;				Moved Permanently</span><br><span class="line">| <span class="string">"302"</span> ; 				Moved Temporarily</span><br><span class="line">| <span class="string">"303"</span> ; 				See Other</span><br><span class="line">| <span class="string">"304"</span> ; 				Not Modified</span><br><span class="line">| <span class="string">"305"</span> ; 				Use Proxy</span><br><span class="line">| <span class="string">"400"</span> ; 				Bad Request</span><br><span class="line">| <span class="string">"401"</span> ; 				Unauthorized</span><br><span class="line">| <span class="string">"402"</span> ; 				Payment Required</span><br><span class="line">| <span class="string">"403"</span> ; 				Forbidden</span><br><span class="line">| <span class="string">"404"</span> ; 				Not Found</span><br><span class="line">| <span class="string">"405"</span> ; 				Method Not Allowed</span><br><span class="line">| <span class="string">"406"</span> ; 				Not Acceptable</span><br><span class="line">| <span class="string">"407"</span> ; 				Proxy Authentication Required</span><br><span class="line">| <span class="string">"408"</span> ; 				Request Time-out</span><br><span class="line">| <span class="string">"410"</span> ; 				Gone</span><br><span class="line">| <span class="string">"411"</span> ; 				Length Required</span><br><span class="line">| <span class="string">"412"</span> ; 				Precondition Failed</span><br><span class="line">| <span class="string">"413"</span> ; 				Request Entity Too Large</span><br><span class="line">| <span class="string">"414"</span> ; 				Request-URI Too Large</span><br><span class="line">| <span class="string">"415"</span> ; 				Unsupported Media Type</span><br><span class="line">| <span class="string">"451"</span> ; 				Parameter Not Understood</span><br><span class="line">| <span class="string">"452"</span> ; 				Conference Not Found</span><br><span class="line">| <span class="string">"453"</span> ; 				Not Enough Bandwidth</span><br><span class="line">| <span class="string">"454"</span> ; 				Session Not Found</span><br><span class="line">| <span class="string">"455"</span> ; 				Method Not Valid in This State</span><br><span class="line">| <span class="string">"456"</span> ; 				Header Field Not Valid <span class="keyword">for</span> Resource</span><br><span class="line">| <span class="string">"457"</span> ; 				Invalid Range</span><br><span class="line">| <span class="string">"458"</span> ; 				Parameter Is Read-Only</span><br><span class="line">| <span class="string">"459"</span> ;				Aggregate operation <span class="keyword">not</span> allowed</span><br><span class="line">| <span class="string">"460"</span> ; 				Only aggregate operation allowed</span><br><span class="line">| <span class="string">"461"</span> ; 				Unsupported transport</span><br><span class="line">| <span class="string">"462"</span> ; 				Destination unreachable</span><br><span class="line">| <span class="string">"500"</span> ; 				Internal Server Error</span><br><span class="line">| <span class="string">"501"</span> ; 				Not Implemented</span><br><span class="line">| <span class="string">"502"</span> ; 				Bad Gateway</span><br><span class="line">| <span class="string">"503"</span> ; 				Service Unavailable</span><br><span class="line">| <span class="string">"504"</span> ; 				Gateway Time-out</span><br><span class="line">| <span class="string">"505"</span> ; 				RTSP Version <span class="keyword">not</span> supported</span><br><span class="line">| <span class="string">"551"</span> ; 				Option <span class="keyword">not</span> supported</span><br></pre></td></tr></table></figure><h5 id="3-1-6ã€SDPçš„æ ¼å¼ï¼š"><a href="#3-1-6ã€SDPçš„æ ¼å¼ï¼š" class="headerlink" title="3.1.6ã€SDPçš„æ ¼å¼ï¼š"></a>3.1.6ã€SDPçš„æ ¼å¼ï¼š</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">v=&lt;version&gt;                            (åè®®ç‰ˆæœ¬)</span><br><span class="line">o=&lt;username&gt; &lt;session id&gt; &lt;version&gt; &lt;network type&gt; &lt;address type&gt; &lt;address&gt;                              ï¼ˆæ‰€æœ‰è€…/åˆ›å»ºè€…å’Œä¼šè¯æ ‡è¯†ç¬¦ï¼‰</span><br><span class="line">s=&lt;session name&gt;                       ï¼ˆä¼šè¯åç§°ï¼‰</span><br><span class="line">i=&lt;session description&gt;                ï¼ˆä¼šè¯ä¿¡æ¯ï¼‰ </span><br><span class="line">u=&lt;URI&gt;                                ï¼ˆURI æè¿°ï¼‰</span><br><span class="line">e=&lt;email address&gt;                      ï¼ˆEmail åœ°å€ï¼‰</span><br><span class="line">p=&lt;phone number&gt;                       ï¼ˆç”µè¯å·ç ï¼‰</span><br><span class="line">c=&lt;network type&gt; &lt;address type&gt; &lt;connection address&gt;   ï¼ˆè¿æ¥ä¿¡æ¯ï¼‰</span><br><span class="line">b=&lt;modifier&gt;:&lt;bandwidth-value&gt;         ï¼ˆå¸¦å®½ä¿¡æ¯ï¼‰</span><br><span class="line">t=&lt;start time&gt; &lt;stop time&gt;             ï¼ˆä¼šè¯æ´»åŠ¨æ—¶é—´ï¼‰</span><br><span class="line">r=&lt;repeat interval&gt; &lt;active duration&gt; &lt;<span class="built_in">list</span> of offsets from start-time&gt; </span><br><span class="line">                                        ï¼ˆ<span class="number">0</span>æˆ–å¤šæ¬¡é‡å¤æ¬¡æ•°ï¼‰</span><br><span class="line">z=&lt;adjustment time&gt; &lt;offset&gt; &lt;adjustment time&gt; &lt;offset&gt;ï¼ˆæ—¶é—´åŒºåŸŸè°ƒæ•´ï¼‰</span><br><span class="line">k=&lt;method&gt;:&lt;encryption key&gt;             ï¼ˆåŠ å¯†å¯†é’¥ï¼‰</span><br><span class="line">a=&lt;attribute&gt;:&lt;value&gt;                   ï¼ˆ<span class="number">0</span> ä¸ªæˆ–å¤šä¸ªä¼šè¯å±æ€§è¡Œï¼‰</span><br><span class="line">m=&lt;media&gt; &lt;port&gt; &lt;transport&gt; &lt;fmt <span class="built_in">list</span>&gt; ï¼ˆåª’ä½“åç§°å’Œä¼ è¾“åœ°å€ï¼‰</span><br><span class="line"></span><br><span class="line">æ—¶é—´æè¿°ï¼š </span><br><span class="line">t = ï¼ˆä¼šè¯æ´»åŠ¨æ—¶é—´ï¼‰ </span><br><span class="line">r = * ï¼ˆ<span class="number">0</span>æˆ–å¤šæ¬¡é‡å¤æ¬¡æ•°ï¼‰ </span><br><span class="line">åª’ä½“æè¿°ï¼š </span><br><span class="line">m = ï¼ˆåª’ä½“åç§°å’Œä¼ è¾“åœ°å€ï¼‰ </span><br><span class="line">i = * ï¼ˆåª’ä½“æ ‡é¢˜ï¼‰ </span><br><span class="line">c = * ï¼ˆè¿æ¥ä¿¡æ¯ â€” å¦‚æœåŒ…å«åœ¨ä¼šè¯å±‚åˆ™è¯¥å­—æ®µå¯é€‰ï¼‰ </span><br><span class="line">b = * ï¼ˆå¸¦å®½ä¿¡æ¯ï¼‰ </span><br><span class="line">k = * ï¼ˆåŠ å¯†å¯†é’¥ï¼‰ </span><br><span class="line">a = * ï¼ˆ<span class="number">0</span> ä¸ªæˆ–å¤šä¸ªåª’ä½“å±æ€§è¡Œï¼‰</span><br></pre></td></tr></table></figure><h5 id="3-1-7ã€RTPåè®®ï¼š"><a href="#3-1-7ã€RTPåè®®ï¼š" class="headerlink" title="3.1.7ã€RTPåè®®ï¼š"></a>3.1.7ã€RTPåè®®ï¼š</h5><p>å®æ—¶ä¼ è¾“åè®®ï¼ˆReal-time Transport Protocolï¼ŒRTPï¼‰æ˜¯ç”¨æ¥åœ¨å•æ’­æˆ–è€…å¤šæ’­çš„æƒ…å¢ƒä¸­ä¼ æµåª’ä½“æ•°æ®çš„æ•°æ®ä¼ è¾“åè®®ã€‚é€šå¸¸ä½¿ç”¨UDPæ¥è¿›è¡Œå¤šåª’ä½“æ•°æ®çš„ä¼ è¾“ï¼Œä¹Ÿä¸æ’é™¤ä½¿ç”¨TCPæˆ–è€…ATMç­‰å…¶å®ƒåè®®ä½œä¸ºå®ƒçš„è½½ä½“ï¼Œæ•´ä¸ªRTP åè®®ç”±ä¸¤ä¸ªå¯†åˆ‡ç›¸å…³çš„éƒ¨åˆ†ç»„æˆï¼šRTPæ•°æ®åè®®å’ŒRTPæ§åˆ¶åè®®ï¼ˆä¹Ÿå°±æ˜¯RTCPåè®®ï¼‰ã€‚<br>RTPä¸ºInternetä¸Šç«¯åˆ°ç«¯çš„å®æ—¶ä¼ è¾“æä¾›æ—¶é—´ä¿¡æ¯å’ŒæµåŒæ­¥ï¼Œä½†å®ƒå¹¶ä¸ä¿è¯æœåŠ¡è´¨é‡ï¼ŒæœåŠ¡è´¨é‡ç”±RTCPæ¥æä¾›ã€‚</p><ul><li><p>ä½¿ç”¨RTPåè®®è¿›è¡Œæ•°æ®ä¼ è¾“çš„ä¸€ä¸ªç®€è¦RTPçš„ä¼šè¯è¿‡ç¨‹ï¼š<br>å½“åº”ç”¨ç¨‹åºå»ºç«‹ä¸€ä¸ªRTPä¼šè¯æ—¶ï¼Œåº”ç”¨ç¨‹åºå°†ç¡®å®šä¸€å¯¹ç›®çš„ä¼ è¾“åœ°å€ã€‚ç›®çš„ä¼ è¾“åœ°å€ç”±ä¸€ä¸ªç½‘ç»œåœ°å€å’Œä¸€å¯¹ç«¯å£ç»„æˆï¼Œæœ‰ä¸¤ä¸ªç«¯å£ï¼šä¸€ä¸ªç»™RTPåŒ…ï¼Œä¸€ä¸ªç»™RTCPåŒ…ï¼Œä¹Ÿå°±æ˜¯è¯´RTPå’ŒRTCPæ•°æ®åŒ…æ˜¯åˆ†å¼€ä¼ è¾“çš„ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—RTP/RTCPæ•°æ®èƒ½å¤Ÿæ­£ç¡®å‘é€ã€‚å…¶ä¸­RTPæ•°æ®å‘å‘å¶æ•°çš„UDPç«¯å£ï¼Œè€Œå¯¹åº”çš„æ§åˆ¶ä¿¡å·RTCPæ•°æ®å‘å‘ç›¸é‚»çš„å¥‡æ•°UDPç«¯å£ï¼Œè¿™æ ·å°±æ„æˆä¸€ä¸ªUDPç«¯å£å¯¹ã€‚<br>å½“å‘é€æ•°æ®çš„æ—¶å€™RTPåè®®ä»ä¸Šå±‚æ¥æ”¶æµåª’ä½“ä¿¡æ¯ç æµï¼Œå°è£…æˆRTPæ•°æ®åŒ…ï¼›RTCPä»ä¸Šå±‚æ¥æ”¶æ§åˆ¶ä¿¡æ¯ï¼Œå°è£…æˆRTCPæ§åˆ¶åŒ…ã€‚RTPå°†RTP æ•°æ®åŒ…å‘å¾€UDPç«¯å£å¯¹ä¸­å¶æ•°ç«¯å£ï¼›RTCPå°†RTCPæ§åˆ¶åŒ…å‘å¾€UDPç«¯å£å¯¹ä¸­çš„æ¥æ”¶ç«¯å£ã€‚<br>å¦‚æœåœ¨ä¸€æ¬¡ä¼šè®®ä¸­åŒæ—¶ä½¿ç”¨äº†éŸ³é¢‘å’Œè§†é¢‘ä¼šè®®ï¼Œè¿™ä¸¤ç§åª’ä½“å°†åˆ†åˆ«åœ¨ä¸åŒçš„RTPä¼šè¯ä¸­ä¼ é€ï¼Œæ¯ä¸€ä¸ªä¼šè¯ä½¿ç”¨ä¸åŒçš„ä¼ è¾“åœ°å€ï¼ˆIPåœ°å€ï¼‹ç«¯å£ï¼‰ã€‚å¦‚æœä¸€ä¸ªç”¨æˆ·åŒæ—¶ä½¿ç”¨äº†ä¸¤ä¸ªä¼šè¯ï¼Œåˆ™æ¯ä¸ªä¼šè¯å¯¹åº”çš„RTCPåŒ…éƒ½ä½¿ç”¨è§„èŒƒåŒ–åå­—CNAMEï¼ˆCanonical Nameï¼‰ã€‚ä¸ä¼šè€…å¯ä»¥æ ¹æ®RTCPåŒ…ä¸­çš„CNAMEæ¥è·å–ç›¸å…³è”çš„éŸ³é¢‘å’Œè§†é¢‘ï¼Œç„¶åæ ¹æ®RTCPåŒ…ä¸­çš„è®¡æ—¶ä¿¡æ¯(Network time protocol)æ¥å®ç°éŸ³é¢‘å’Œè§†é¢‘çš„åŒæ­¥ã€‚</p></li><li><p>ç¿»è¯‘å™¨å’Œæ··åˆå™¨<br>åœ¨RTPåè®®ä¸­è¿˜å¼•å…¥äº†ç¿»è¯‘å™¨å’Œæ··åˆå™¨ã€‚ç¿»è¯‘å™¨å’Œæ··åˆå™¨éƒ½æ˜¯RTPçº§çš„ä¸­ç»§ç³»ç»Ÿã€‚<br>æ··åˆå™¨çš„ä½¿ç”¨æƒ…æ™¯ï¼š<br>åœ¨Internetä¸Šä¸¾è¡Œè§†é¢‘ä¼šè®®æ—¶ï¼Œå¯èƒ½æœ‰å°‘æ•°å‚åŠ è€…é€šè¿‡ä½é€Ÿé“¾è·¯ä¸ä½¿ç”¨é«˜é€Ÿç½‘ç»œçš„å¤šæ•°å‚åŠ è€…ç›¸è¿æ¥ã€‚ä¸ºäº†ä¸å¼ºåˆ¶æ‰€æœ‰ä¼šè®®å‚åŠ è€…éƒ½ä½¿ç”¨ä½å¸¦å®½å’Œä½è´¨é‡çš„æ•°æ®ç¼–ç ï¼ŒRTPå…è®¸åœ¨ä½å¸¦å®½åŒºåŸŸé™„è¿‘ä½¿ç”¨æ··åˆå™¨ä½œä¸ºRTPçº§ä¸­ç»§å™¨ã€‚æ··åˆå™¨ä»ä¸€ä¸ªæˆ–å¤šä¸ªä¿¡æºæ¥æ”¶RTPæŠ¥æ–‡ï¼Œå¯¹åˆ°è¾¾çš„æ•°æ®æŠ¥æ–‡è¿›è¡Œé‡æ–°åŒæ­¥å’Œé‡æ–°ç»„åˆï¼Œè¿™äº›é‡ç»„çš„æ•°æ®æµè¢«æ··åˆæˆä¸€ä¸ªæ•°æ®æµï¼Œå°†æ•°æ®ç¼–ç è½¬åŒ–ä¸ºåœ¨ä½å¸¦å®½ä¸Šå¯ç”¨çš„ç±»å‹ï¼Œå¹¶é€šè¿‡ä½é€Ÿé“¾è·¯å‘ä½å¸¦å®½åŒºåŸŸè½¬å‘ã€‚ä¸ºäº†å¯¹å¤šä¸ªè¾“å…¥ä¿¡æºè¿›è¡Œç»Ÿä¸€çš„åŒæ­¥ï¼Œæ··åˆå™¨åœ¨å¤šä¸ªåª’ä½“æµä¹‹é—´è¿›è¡Œå®šæ—¶è°ƒæ•´ï¼Œäº§ç”Ÿå®ƒè‡ªå·±çš„å®šæ—¶åŒæ­¥ï¼Œå› æ­¤æ‰€æœ‰ä»æ··åˆå™¨è¾“å‡ºçš„æŠ¥æ–‡éƒ½æŠŠæ··åˆå™¨ä½œä¸ºåŒæ­¥ä¿¡æºã€‚ä¸ºäº†ä¿è¯æ¥æ”¶è€…èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«æ··åˆå™¨å¤„ç†å‰çš„åŸå§‹æŠ¥æ–‡å‘é€è€…ï¼Œæ··åˆå™¨åœ¨RTPæŠ¥å¤´ä¸­è®¾ç½®äº†CSRCæ ‡è¯†ç¬¦é˜Ÿåˆ—ï¼Œä»¥æ ‡è¯†é‚£äº›äº§ç”Ÿæ··å’ŒæŠ¥æ–‡çš„åŸå§‹åŒæ­¥ä¿¡æºã€‚<br>ç¿»è¯‘å™¨çš„ä½¿ç”¨æƒ…æ™¯<br>åœ¨Internetç¯å¢ƒä¸­ï¼Œä¸€äº›ä¼šè®®çš„å‚åŠ è€…å¯èƒ½è¢«éš”ç¦»åœ¨åº”ç”¨çº§é˜²ç«å¢™çš„å¤–é¢ï¼Œè¿™äº›å‚åŠ è€…è¢«ç¦æ­¢ç›´æ¥ä½¿ç”¨IPç»„æ’­åœ°å€è¿›è¡Œè®¿é—®ï¼Œè™½ç„¶ä»–ä»¬å¯èƒ½æ˜¯é€šè¿‡é«˜é€Ÿé“¾è·¯è¿æ¥çš„ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼ŒRTPå…è®¸ä½¿ç”¨è½¬æ¢å™¨ä½œä¸ºRTPçº§ä¸­ç»§å™¨ã€‚åœ¨é˜²ç«å¢™ä¸¤ç«¯åˆ†åˆ«å®‰è£…ä¸€ä¸ªè½¬æ¢å™¨ï¼Œé˜²ç«å¢™ä¹‹å¤–çš„è½¬æ¢å™¨è¿‡æ»¤æ‰€æœ‰æ¥æ”¶åˆ°çš„ç»„æ’­æŠ¥æ–‡ï¼Œå¹¶é€šè¿‡ä¸€æ¡å®‰å…¨çš„è¿æ¥ä¼ é€ç»™é˜²ç«å¢™ä¹‹å†…çš„è½¬æ¢å™¨ï¼Œå†…éƒ¨è½¬æ¢å™¨å°†è¿™äº›ç»„æ’­æŠ¥æ–‡å†è½¬å‘é€ç»™å†…éƒ¨ç½‘ç»œä¸­çš„ç»„æ’­ç»„æˆå‘˜</p><h5 id="3-1-8ã€RTPåè®®æŠ¥å¤´æ ¼å¼"><a href="#3-1-8ã€RTPåè®®æŠ¥å¤´æ ¼å¼" class="headerlink" title="3.1.8ã€RTPåè®®æŠ¥å¤´æ ¼å¼"></a>3.1.8ã€RTPåè®®æŠ¥å¤´æ ¼å¼</h5></li></ul><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-13-RTSP-baotou1.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-14-RTSP-baotou2.png" alt="Alt text | center"></p><h5 id="3-1-9ã€RTCPåè®®æŠ¥å¤´æ ¼å¼"><a href="#3-1-9ã€RTCPåè®®æŠ¥å¤´æ ¼å¼" class="headerlink" title="3.1.9ã€RTCPåè®®æŠ¥å¤´æ ¼å¼"></a>3.1.9ã€RTCPåè®®æŠ¥å¤´æ ¼å¼</h5><p>å¦‚å‰é¢æ‰€è¿°RTCPçš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼šæœåŠ¡è´¨é‡çš„ç›‘è§†ä¸åé¦ˆã€åª’ä½“é—´çš„åŒæ­¥ï¼Œä»¥åŠå¤šæ’­ç»„ä¸­æˆå‘˜çš„æ ‡è¯†ã€‚åœ¨RTPä¼šè¯æœŸé—´ï¼Œå„å‚ä¸è€…å‘¨æœŸæ€§åœ°ä¼ é€RTCPåŒ…ã€‚RTCPåŒ…ä¸­å«æœ‰å·²å‘é€çš„æ•°æ®åŒ…çš„æ•°é‡ã€ä¸¢å¤±çš„æ•°æ®åŒ…çš„æ•°é‡ç­‰ç»Ÿè®¡èµ„æ–™ï¼Œå› æ­¤ï¼Œå„å‚ä¸è€…å¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯åŠ¨æ€åœ°æ”¹å˜ä¼ è¾“é€Ÿç‡ï¼Œç”šè‡³æ”¹å˜æœ‰æ•ˆè½½è·ç±»å‹ã€‚RTPå’ŒRTCPé…åˆä½¿ç”¨ï¼Œå®ƒä»¬èƒ½ä»¥æœ‰æ•ˆçš„åé¦ˆå’Œæœ€å°çš„å¼€é”€ä½¿ä¼ è¾“æ•ˆç‡æœ€ä½³åŒ–ï¼Œå› è€Œç‰¹åˆ«é€‚åˆä¼ é€ç½‘ä¸Šçš„å®æ—¶æ•°æ®ã€‚RTCPä¹Ÿæ˜¯ç”¨UDPæ¥ä¼ é€çš„ï¼Œä½†RTCPå°è£…çš„ä»…ä»…æ˜¯ä¸€äº›æ§åˆ¶ä¿¡æ¯ï¼Œå› è€Œåˆ†ç»„å¾ˆçŸ­ï¼Œæ‰€ä»¥å¯ä»¥å°†å¤šä¸ªRTCPåˆ†ç»„å°è£…åœ¨ä¸€ä¸ªUDPåŒ…ä¸­ã€‚<br>RTCPæœ‰å¦‚ä¸‹äº”ç§åˆ†ç»„ç±»å‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-15-RTCP-baotou1.png" alt="Alt text | center"></p><p>ä¸‹é¢æ˜¯SRåˆ†ç»„çš„æ ¼å¼ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-16-RTCP-baotou2.png" alt="Alt text | center"></p><h5 id="3-2ã€åŸºäºNuPLayerçš„RTSP-ä»£ç æµç¨‹"><a href="#3-2ã€åŸºäºNuPLayerçš„RTSP-ä»£ç æµç¨‹" class="headerlink" title="3.2ã€åŸºäºNuPLayerçš„RTSP ä»£ç æµç¨‹"></a>3.2ã€åŸºäºNuPLayerçš„RTSP ä»£ç æµç¨‹</h5><p>setDataSource é˜¶æ®µçš„ä»»åŠ¡è¿™é‡Œå°±ä¸é‡å¤ä»‹ç»äº†ï¼Œå®ƒä¸»è¦å®Œæˆæ’­æ”¾å¼•æ“çš„å»ºç«‹ä»¥åŠæ ¹æ®URLæ ¼å¼åˆ›å»ºå¯¹åº”çš„Sourceï¼Œæ¯”å¦‚è¿™é‡Œå°†è¦æåˆ°çš„RTSPSourceï¼Œç„¶åèµ‹å€¼ç»™mSourceã€‚</p><p>æˆ‘ä»¬ç›´æ¥æ¥çœ‹prepareé˜¶æ®µï¼š</p><p>å…ˆä¸Šå›¾å†çœ‹ä»£ç ï¼Œç»“åˆå›¾çœ‹ä¼šæ¯”è¾ƒæ¸…æ™°<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-17-ARTSPConnection.png" alt="Alt text | center"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-18-ARTSP-Source.png" alt="Alt text | center"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-19-ARTSP-Source-state.png" alt="Alt text | center"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-20-ARTSP-Source-state2.png" alt="Alt text | center"></p><h5 id="3-3ã€RTSPSource-prepareAsync-æµç¨‹"><a href="#3-3ã€RTSPSource-prepareAsync-æµç¨‹" class="headerlink" title="3.3ã€RTSPSource::prepareAsync()æµç¨‹"></a>3.3ã€RTSPSource::prepareAsync()æµç¨‹</h5><p>åœ¨prepareé˜¶æ®µæˆ‘ä»¬é¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦æ˜¯SDPï¼ŒmIsSDPè¿™ä¸ªå˜é‡æ˜¯åœ¨åˆå§‹åŒ–RTSPSourceæ—¶å€™ä¼ å…¥çš„ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆåˆ†æmIsSDP = falseçš„æƒ…å†µã€‚è¿™ç§æƒ…å†µä¸‹é¦–å…ˆåˆ›å»ºä¸€ä¸ªMyHandlerï¼Œå¹¶è°ƒç”¨connectï¼Œä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\RTSPSource.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::RTSPSource::prepareAsync() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//..........</span></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatNotify, <span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦ä¸ºDISCONNECTED</span></span><br><span class="line">    CHECK_EQ(mState, (<span class="keyword">int</span>)DISCONNECTED);</span><br><span class="line">    <span class="comment">//è®¾ç½®å½“å‰çŠ¶æ€ä¸ºCONNECTING</span></span><br><span class="line">    mState = CONNECTING;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsSDP) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯SDPé‚£ä¹ˆå°±éœ€è¦åˆ›å»ºä¸€ä¸ªSDPLoader ä»æœåŠ¡å™¨ä¸ŠåŠ è½½ä¸€ä¸ªæè¿°æ–‡ä»¶</span></span><br><span class="line">        mSDPLoader = <span class="keyword">new</span> SDPLoader(notify, (mFlags &amp; kFlagIncognito) ? SDPLoader::kFlagIncognito : <span class="number">0</span>, mHTTPService);</span><br><span class="line">        mSDPLoader-&gt;load(mURL.c_str(), mExtraHeaders.isEmpty() ? <span class="literal">NULL</span> : &amp;mExtraHeaders);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸æ˜¯SDP é‚£ä¹ˆå°±ä½¿ç”¨MyHandler æ¥è¿›è¡Œè¿æ¥</span></span><br><span class="line">        mHandler = <span class="keyword">new</span> MyHandler(mURL.c_str(), notify, mUIDValid, mUID);</span><br><span class="line">        mLooper-&gt;registerHandler(mHandler);</span><br><span class="line">        mHandler-&gt;connect();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¯åŠ¨ç¼“å­˜</span></span><br><span class="line">    startBufferingIfNecessary();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä»‹ç»connectæ–¹æ³•ä¹‹å‰éœ€è¦å…ˆäº†è§£mConnä»¥åŠmRTPConnè¿™ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼ŒmConnæ˜¯ä¸€ä¸ªARTSPConnectionï¼Œå®ƒä¸»è¦ä¸æœåŠ¡å™¨ç›¸è¿ï¼Œå‘é€å’Œæ¥æ”¶è¯·æ±‚æ•°æ®ï¼ŒmRTPConnæ˜¯ä¸€ä¸ªARTPConnection ç”¨äºå‘é€å’Œæ¥æ”¶åª’ä½“æ•°æ®ã€‚<br>åœ¨connectæ–¹æ³•ä¸­ä¼šä½¿ç”¨mConnå‘æœåŠ¡å™¨å‘èµ·è¿æ¥è¯·æ±‚ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\MyHandler.h]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//mConn(new ARTSPConnection(mUIDValid, mUID)),</span></span><br><span class="line">    looper()-&gt;registerHandler(mConn);</span><br><span class="line">    <span class="comment">//mRTPConn(new ARTPConnection),</span></span><br><span class="line">    (<span class="number">1</span> ? mNetLooper : looper())-&gt;registerHandler(mRTPConn);</span><br><span class="line">    sp&lt;AMessage&gt; notify = new AMessage('biny', this);</span><br><span class="line">    mConn-&gt;observeBinaryData(notify);</span><br><span class="line">    <span class="comment">//è¿æ¥æœåŠ¡</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = new AMessage('conn', this);</span><br><span class="line">    mConn-&gt;connect(mOriginalSessionURL.c_str(), reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::connect(<span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;reply) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatConnect, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setString(<span class="string">"url"</span>, url);</span><br><span class="line">    msg-&gt;setMessage(<span class="string">"reply"</span>, reply);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatConnect:</span><br><span class="line">    onConnect(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>åœ¨ARTSPConnection::onConnectä¸­å°†ä¼šä»ä¼ é€’è¿‡æ¥çš„URlä¸­è§£æhostï¼Œportï¼Œpathï¼ŒmUserï¼ŒmPassï¼Œå¹¶è°ƒç”¨::connect å’ŒæœåŠ¡å™¨å–å¾—è”ç³»ï¼Œæœ€åè°ƒç”¨postReceiveReponseEventå°†è¯·æ±‚çš„å›å¤å“åº”æš‚å­˜èµ·æ¥ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::onConnect(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    ++mConnectionID;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mState != DISCONNECTED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPBase::UnRegisterSocketUserTag(mSocket);</span><br><span class="line">            HTTPBase::UnRegisterSocketUserMark(mSocket);</span><br><span class="line">        &#125;</span><br><span class="line">        close(mSocket);</span><br><span class="line">        mSocket = <span class="number">-1</span>;</span><br><span class="line">        flushPendingRequests();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mState = CONNECTING;</span><br><span class="line">    AString url;</span><br><span class="line">    <span class="comment">//ä»æ¶ˆæ¯ä¸­å–ä¸‹Url</span></span><br><span class="line">    CHECK(msg-&gt;findString(<span class="string">"url"</span>, &amp;url));</span><br><span class="line">    sp&lt;AMessage&gt; reply;</span><br><span class="line">    <span class="comment">//ä»æ¶ˆæ¯ä¸­å–ä¸‹replay</span></span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"reply"</span>, &amp;reply));</span><br><span class="line"></span><br><span class="line">    AString host, path;</span><br><span class="line">    <span class="keyword">unsigned</span> port;</span><br><span class="line">    <span class="comment">//ä»URlä¸­è§£æhostï¼Œportï¼Œpathï¼ŒmUserï¼ŒmPass</span></span><br><span class="line">    <span class="keyword">if</span> (!ParseURL(url.c_str(), &amp;host, &amp;port, &amp;path, &amp;mUser, &amp;mPass)</span><br><span class="line">            || (mUser.size() &gt; <span class="number">0</span> &amp;&amp; mPass.size() == <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æœ‰ç”¨æˆ·åï¼Œä½†æ˜¯æ²¡æœ‰å¯†ç ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="comment">// If we have a user name but no password we have to give up</span></span><br><span class="line">        <span class="comment">// right here, since we currently have no way of asking the user</span></span><br><span class="line">        <span class="comment">// for this information.</span></span><br><span class="line">        ALOGE(<span class="string">"Malformed rtsp url %s"</span>, uriDebugString(url).c_str());</span><br><span class="line">        reply-&gt;setInt32(<span class="string">"result"</span>, ERROR_MALFORMED);</span><br><span class="line">        reply-&gt;post();</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mUser.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGV(<span class="string">"user = '%s', pass = '%s'"</span>, mUser.c_str(), mPass.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">ent</span> = <span class="title">gethostbyname</span>(<span class="title">host</span>.<span class="title">c_str</span>());</span></span><br><span class="line">    <span class="keyword">if</span> (ent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Unknown host %s"</span>, host.c_str());</span><br><span class="line">        reply-&gt;setInt32(<span class="string">"result"</span>, -ENOENT);</span><br><span class="line">        reply-&gt;post();</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mSocket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">        HTTPBase::RegisterSocketUserTag(mSocket, mUID,(<span class="keyword">uint32_t</span>)*(<span class="keyword">uint32_t</span>*) <span class="string">"RTSP"</span>);</span><br><span class="line">        HTTPBase::RegisterSocketUserMark(mSocket, mUID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MakeSocketBlocking(mSocket, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">remote</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(remote.sin_zero, <span class="number">0</span>, <span class="keyword">sizeof</span>(remote.sin_zero));</span><br><span class="line">    remote.sin_family = AF_INET;</span><br><span class="line">    remote.sin_addr.s_addr = *(<span class="keyword">in_addr_t</span> *)ent-&gt;h_addr;</span><br><span class="line">    remote.sin_port = htons(port);</span><br><span class="line">    <span class="comment">//è¿æ¥åˆ°æœåŠ¡å™¨</span></span><br><span class="line">    <span class="keyword">int</span> err = ::connect(mSocket, (<span class="keyword">const</span> struct sockaddr *)&amp;remote, <span class="keyword">sizeof</span>(remote));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›æœåŠ¡å™¨ip</span></span><br><span class="line">    reply-&gt;setInt32(<span class="string">"server-ip"</span>, ntohl(remote.sin_addr.s_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINPROGRESS) &#123;</span><br><span class="line">            sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatCompleteConnection, <span class="keyword">this</span>);</span><br><span class="line">            msg-&gt;setMessage(<span class="string">"reply"</span>, reply);</span><br><span class="line">            msg-&gt;setInt32(<span class="string">"connection-id"</span>, mConnectionID);</span><br><span class="line">            msg-&gt;post();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        reply-&gt;setInt32(<span class="string">"result"</span>, -errno);</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPBase::UnRegisterSocketUserTag(mSocket);</span><br><span class="line">            HTTPBase::UnRegisterSocketUserMark(mSocket);</span><br><span class="line">        &#125;</span><br><span class="line">        close(mSocket);</span><br><span class="line">        mSocket = <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//æˆåŠŸçš„èŠ±è¿”å›resultä¸ºOK</span></span><br><span class="line">        reply-&gt;setInt32(<span class="string">"result"</span>, OK);</span><br><span class="line">        <span class="comment">//è®¾ç½®çŠ¶æ€ä¸ºCONNECTED</span></span><br><span class="line">        mState = CONNECTED;</span><br><span class="line">        mNextCSeq = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//å‘é€ç­‰å¾…è¿”å›æ¶ˆæ¯</span></span><br><span class="line">        postReceiveReponseEvent();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//â€˜connâ€™</span></span><br><span class="line">    reply-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹postReceiveReponseEvent,è°ƒç”¨receiveRTSPReponseè·å¾—æœåŠ¡å™¨çš„å›å¤</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;]</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::postReceiveReponseEvent() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mReceiveResponseEventPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatReceiveResponse, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">    mReceiveResponseEventPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::onReceiveResponse() &#123;</span><br><span class="line">    mReceiveResponseEventPending = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mState != CONNECTED) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    tv.tv_sec = <span class="number">0</span>;</span><br><span class="line">    tv.tv_usec = kSelectTimeoutUs;</span><br><span class="line">    fd_set rs;</span><br><span class="line">    FD_ZERO(&amp;rs);</span><br><span class="line">    FD_SET(mSocket, &amp;rs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€‰æ‹©ä¸€ä¸ªè¿”å›çš„è¿æ¥</span></span><br><span class="line">    <span class="keyword">int</span> res = select(mSocket + <span class="number">1</span>, &amp;rs, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">1</span>) &#123;</span><br><span class="line">        MakeSocketBlocking(mSocket, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">bool</span> success = receiveRTSPReponse();</span><br><span class="line">        MakeSocketBlocking(mSocket, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// Something horrible, irreparable has happened.</span></span><br><span class="line">            flushPendingRequests();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    postReceiveReponseEvent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œçš„receiveRTSPReponseæ˜¯æœ‰åŒé‡åŠŸèƒ½çš„ï¼Œæ–¹é¢å¯ä»¥æ¥æ”¶ä»æœåŠ¡å™¨å‘æ¥çš„è¯·æ±‚ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥å¤„ç†æœåŠ¡å™¨å‘æ¥çš„åº”ç­”ä¿¡å·ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">bool</span> ARTSPConnection::receiveRTSPReponse() &#123;</span><br><span class="line"></span><br><span class="line">    AString statusLine;</span><br><span class="line">    <span class="keyword">if</span> (!receiveLine(&amp;statusLine)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statusLine == <span class="string">"$"</span>) &#123;</span><br><span class="line">        sp&lt;ABuffer&gt; buffer = receiveBinaryData();</span><br><span class="line">        <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mObserveBinaryMessage != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sp&lt;AMessage&gt; notify = mObserveBinaryMessage-&gt;dup();</span><br><span class="line">            notify-&gt;setBuffer(<span class="string">"buffer"</span>, buffer);</span><br><span class="line">            notify-&gt;post();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGW(<span class="string">"received binary data, but no one cares."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RTSPè¿”å›å¯¹è±¡</span></span><br><span class="line">    sp&lt;ARTSPResponse&gt; response = <span class="keyword">new</span> ARTSPResponse;</span><br><span class="line">    response-&gt;mStatusLine = statusLine;</span><br><span class="line">    ALOGI(<span class="string">"status: %s"</span>, response-&gt;mStatusLine.c_str());</span><br><span class="line">    <span class="keyword">ssize_t</span> space1 = response-&gt;mStatusLine.find(<span class="string">" "</span>);</span><br><span class="line">    <span class="keyword">if</span> (space1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">ssize_t</span> space2 = response-&gt;mStatusLine.find(<span class="string">" "</span>, space1 + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (space2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isRequest = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è¿”å›çš„RTSPç‰ˆæœ¬æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> (!IsRTSPVersion(AString(response-&gt;mStatusLine, <span class="number">0</span>, space1))) &#123;</span><br><span class="line">        CHECK(IsRTSPVersion(AString(response-&gt;mStatusLine,space2 + <span class="number">1</span>,response-&gt;mStatusLine.size() - space2 - <span class="number">1</span>)));</span><br><span class="line">        isRequest = <span class="literal">true</span>;</span><br><span class="line">        response-&gt;mStatusCode = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­çŠ¶æ€ç æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">        AString statusCodeStr(response-&gt;mStatusLine, space1 + <span class="number">1</span>, space2 - space1 - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ParseSingleUnsignedLong(statusCodeStr.c_str(), &amp;response-&gt;mStatusCode) || response-&gt;mStatusCode &lt; <span class="number">100</span> || response-&gt;mStatusCode &gt; <span class="number">999</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AString line;</span><br><span class="line">    <span class="keyword">ssize_t</span> lastDictIndex = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!receiveLine(&amp;line)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (line.empty()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ALOGV(<span class="string">"line: '%s'"</span>, line.c_str());</span><br><span class="line">        <span class="keyword">if</span> (line.c_str()[<span class="number">0</span>] == <span class="string">' '</span> || line.c_str()[<span class="number">0</span>] == <span class="string">'\t'</span>) &#123;</span><br><span class="line">            <span class="comment">// Support for folded header values.</span></span><br><span class="line">            <span class="keyword">if</span> (lastDictIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// First line cannot be a continuation of the previous one.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            AString &amp;value = response-&gt;mHeaders.editValueAt(lastDictIndex);</span><br><span class="line">            value.append(line);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">ssize_t</span> colonPos = line.find(<span class="string">":"</span>);</span><br><span class="line">        <span class="keyword">if</span> (colonPos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Malformed header line.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">AString <span class="title">key</span><span class="params">(line, <span class="number">0</span>, colonPos)</span></span>;</span><br><span class="line">        key.trim();</span><br><span class="line">        key.<span class="built_in">tolower</span>();</span><br><span class="line">        line.erase(<span class="number">0</span>, colonPos + <span class="number">1</span>);</span><br><span class="line">        lastDictIndex = response-&gt;mHeaders.add(key, line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; response-&gt;mHeaders.size(); ++i) &#123;</span><br><span class="line">        response-&gt;mHeaders.editValueAt(i).trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> contentLength = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> i = response-&gt;mHeaders.indexOfKey(<span class="string">"content-length"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        AString value = response-&gt;mHeaders.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (!ParseSingleUnsignedLong(value.c_str(), &amp;contentLength)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ¥æ”¶mContent</span></span><br><span class="line">    <span class="keyword">if</span> (contentLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        response-&gt;mContent = <span class="keyword">new</span> ABuffer(contentLength);</span><br><span class="line">        <span class="keyword">if</span> (receive(response-&gt;mContent-&gt;data(), contentLength) != OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//isRequest è¡¨ç¤ºæ˜¯æœåŠ¡å™¨ä¸»åŠ¨å‘é€çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå°†è°ƒç”¨handleServerRequestï¼Œå¦åˆ™è¡¨ç¤ºæ˜¯æœåŠ¡å™¨è¢«åŠ¨å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå°†é€šçŸ¥æœåŠ¡å™¨æœ‰å“åº”äº†notifyResponseListener</span></span><br><span class="line">    <span class="keyword">return</span> isRequest</span><br><span class="line">        ? handleServerRequest(response)</span><br><span class="line">        : notifyResponseListener(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>isRequest è¡¨ç¤ºæ˜¯æœåŠ¡å™¨ä¸»åŠ¨å‘é€çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå°†è°ƒç”¨handleServerRequestï¼Œå¦åˆ™è¡¨ç¤ºæ˜¯æœåŠ¡å™¨è¢«åŠ¨å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå°†é€šçŸ¥æœåŠ¡å™¨æœ‰å“åº”äº†notifyResponseListenerï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆçœ‹ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°ï¼š</p><p>çœ‹åˆ°handleServerRequestå¤§å®¶å¯èƒ½ä¼šæœ‰ç‚¹å¤±æœ›ï¼Œå› ä¸ºè¿™é‡Œå°šæœªå®ç°è¿™ä¸ªåŠŸèƒ½æ‰€ä»¥åªæ˜¯å‘æœåŠ¡å™¨è¿”å›ä¸€ä¸ªâ€œRTSP/1.0 501 Not Implementedâ€çš„æ¶ˆæ¯ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">bool</span> ARTSPConnection::handleServerRequest(<span class="keyword">const</span> sp&lt;ARTSPResponse&gt; &amp;request) &#123;</span><br><span class="line">    <span class="comment">// Implementation of server-&gt;client requests is optional for all methods</span></span><br><span class="line">    <span class="comment">// but we do need to respond, even if it's just to say that we don't</span></span><br><span class="line">    <span class="comment">// support the method.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™é‡Œæˆ‘ä»¬ä¸å®ç°ä»»ä½•ç­”å¤è¡Œä¸ºåªæ˜¯ç®€å•åé¦ˆæˆ‘ä»¬å°šæœªå®ç°è¿™ä¸ªåŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">ssize_t</span> space1 = request-&gt;mStatusLine.find(<span class="string">" "</span>);</span><br><span class="line">    CHECK_GE(space1, <span class="number">0</span>);</span><br><span class="line">    AString response;</span><br><span class="line">    response.append(<span class="string">"RTSP/1.0 501 Not Implemented\r\n"</span>);</span><br><span class="line">    <span class="keyword">ssize_t</span> i = request-&gt;mHeaders.indexOfKey(<span class="string">"cseq"</span>);</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        AString value = request-&gt;mHeaders.valueAt(i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> cseq;</span><br><span class="line">        <span class="keyword">if</span> (!ParseSingleUnsignedLong(value.c_str(), &amp;cseq)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.append(<span class="string">"CSeq: "</span>);</span><br><span class="line">        response.append(cseq);</span><br><span class="line">        response.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    response.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    <span class="keyword">size_t</span> numBytesSent = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (numBytesSent &lt; response.size()) &#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> n =</span><br><span class="line">            send(mSocket, response.c_str() + numBytesSent,</span><br><span class="line">                 response.size() - numBytesSent, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span> &amp;&amp; errno == EINTR) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Server closed the connection.</span></span><br><span class="line">                ALOGE(<span class="string">"Server unexpectedly closed the connection."</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ALOGE(<span class="string">"Error sending rtsp response (%s)."</span>, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            performDisconnect();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        numBytesSent += (<span class="keyword">size_t</span>)n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>notifyResponseListenerçš„å®ç°æ¯”è¾ƒæ¸…æ™°ï¼Œå®ƒä¼šæ ¹æ®æœåŠ¡å™¨å‘æ¥çš„åº”ç­”å“åº”ï¼Œæ‰¾å‡ºå“åº”è¯¥åº”ç­”çš„Messageï¼Œç„¶åå°†responseè¿”å›ç»™MyHandlerï¼Œè¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">bool</span> ARTSPConnection::notifyResponseListener(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTSPResponse&gt; &amp;response) &#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> i;</span><br><span class="line">    <span class="comment">//åœ¨é˜Ÿåˆ—ä¸­æŸ¥æ‰¾å°šæœªå¤„ç†çš„è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">status_t</span> err = findPendingRequest(response, &amp;i);</span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘é€æœåŠ¡å™¨çš„å›å¤ç»™å®ƒ</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = mPendingRequests.valueAt(i);</span><br><span class="line">    mPendingRequests.removeItemsAt(i);</span><br><span class="line">    reply-&gt;setInt32(<span class="string">"result"</span>, OK);</span><br><span class="line">    reply-&gt;setObject(<span class="string">"response"</span>, response);</span><br><span class="line">    reply-&gt;post();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½äº†æˆ‘ä»¬è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬çœ‹ä¸‹MyHandlerä¸­å¯¹connå›å¤æ€ä¹ˆå¤„ç†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\MyHandler.h]</span><br><span class="line">case 'conn':</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="comment">//å–å‡ºåé¦ˆç»“æœ</span></span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"result"</span>, &amp;result));</span><br><span class="line">    <span class="keyword">if</span> (result == OK) &#123;</span><br><span class="line">        <span class="comment">//å‘é€è¯·æ±‚æè¿°ç¬¦çš„æ¶ˆæ¯</span></span><br><span class="line">        AString request;</span><br><span class="line">        request = <span class="string">"DESCRIBE "</span>;</span><br><span class="line">        request.append(mSessionURL);</span><br><span class="line">        request.append(<span class="string">" RTSP/1.0\r\n"</span>);</span><br><span class="line">        request.append(<span class="string">"Accept: application/sdp\r\n"</span>);</span><br><span class="line">        request.append(<span class="string">"\r\n"</span>);</span><br><span class="line">        sp&lt;AMessage&gt; reply = new AMessage('desc', this);</span><br><span class="line">        mConn-&gt;sendRequest(request.c_str(), reply);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        (new AMessage('disc', this))-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¯”è¾ƒç®€å•å°±æ˜¯æ”¶åˆ°ç­”å¤ä¹‹åï¼Œç›´æ¥åˆ¤æ–­ç»“æœæ˜¯OKè¿˜æ˜¯ä¸OKï¼Œå¦‚æœOKé‚£ä¹ˆå°±å‘é€ä¸€ä¸ªDESCRIBEçš„è¯·æ±‚ã€‚æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ï¼ŒonSendRequestç†è§£è¿™ä¸ªå¾ˆé‡è¦ï¼š<br>åœ¨onSendRequestä¸­ä¼šå¯¹è¯·æ±‚åŠ å·¥å¤„ç†ä¸‹ï¼Œæ¯”å¦‚æ·»åŠ Cseqç­‰æ“ä½œï¼Œç„¶åå°±ä¼šè°ƒç”¨sendå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚å¹¶å°†è¯·æ±‚ä»¥Cseqä¸ºé”®ç ï¼Œreplayä¸ºå›å¤æ¶ˆæ¯çš„å¾…å¤„ç†è¯·æ±‚é˜Ÿåˆ—ä¸­ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::onSendRequest(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; reply;</span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"reply"</span>, &amp;reply));</span><br><span class="line">    <span class="comment">//å¯¹è¯·æ±‚è¿›è¡ŒåŠ å·¥å¤„ç†</span></span><br><span class="line">    AString request;</span><br><span class="line">    CHECK(msg-&gt;findString(<span class="string">"request"</span>, &amp;request));</span><br><span class="line">    <span class="comment">// Just in case we need to re-issue the request with proper authentication</span></span><br><span class="line">    <span class="comment">// later, stash it away.</span></span><br><span class="line">    reply-&gt;setString(<span class="string">"original-request"</span>, request.c_str(), request.size());</span><br><span class="line">    addAuthentication(&amp;request);</span><br><span class="line">    addUserAgent(&amp;request);</span><br><span class="line">    <span class="comment">// Find the boundary between headers and the body.</span></span><br><span class="line">    <span class="keyword">ssize_t</span> i = request.find(<span class="string">"\r\n\r\n"</span>);</span><br><span class="line">    CHECK_GE(i, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int32_t</span> cseq = mNextCSeq++;</span><br><span class="line">    AString cseqHeader = <span class="string">"CSeq: "</span>;</span><br><span class="line">    cseqHeader.append(cseq);</span><br><span class="line">    cseqHeader.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    request.insert(cseqHeader, i + <span class="number">2</span>);</span><br><span class="line">    ALOGV(<span class="string">"request: '%s'"</span>, request.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> numBytesSent = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (numBytesSent &lt; request.size()) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœè¯·æ±‚è¿˜æ²¡å®Œå…¨å‘é€ç»“æŸé‚£ä¹ˆç»§ç»­å‘é€</span></span><br><span class="line">        <span class="keyword">ssize_t</span> n = send(mSocket, request.c_str() + numBytesSent,request.size() - numBytesSent, <span class="number">0</span>);&#125;</span><br><span class="line">        <span class="comment">//å¿½ç•¥é”™è¯¯å¤„ç†ä»£ç </span></span><br><span class="line">        numBytesSent += (<span class="keyword">size_t</span>)n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†è¯·æ±‚æ·»åŠ åˆ°mPendingRequestsï¼Œç­‰å¾…æœåŠ¡å™¨å›å¤</span></span><br><span class="line">    mPendingRequests.add(cseq, reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°ä¸Šé¢æåˆ°çš„notifyResponseListenerç»“åˆonSendRequestä»¥åŠfindPendingRequestæ˜¯å¦çœ‹å‡ºäº†æ•´ä¸ªäº‹ä»¶å¤„ç†çš„æµç¨‹ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> ARTSPConnection::findPendingRequest(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTSPResponse&gt; &amp;response, <span class="keyword">ssize_t</span> *index) <span class="keyword">const</span> &#123;</span><br><span class="line">    *index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> i = response-&gt;mHeaders.indexOfKey(<span class="string">"cseq"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// This is an unsolicited server-&gt;client message.</span></span><br><span class="line">        *index = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line">    AString value = response-&gt;mHeaders.valueAt(i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cseq;</span><br><span class="line">    <span class="keyword">if</span> (!ParseSingleUnsignedLong(value.c_str(), &amp;cseq)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">    &#125;</span><br><span class="line">    i = mPendingRequests.indexOfKey(cseq);</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOENT;</span><br><span class="line">    &#125;</span><br><span class="line">    *index = i;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>onSendRequest ä¼šä¸æ–­å°†è¯·æ±‚æ”¾å…¥mPendingRequestsä¸­ï¼Œè€Œæ¯æ¬¡æœåŠ¡å™¨ç»™å‡ºåº”ç­”çš„æ—¶å€™ä¼šè°ƒç”¨notifyResponseListenerï¼ŒnotifyResponseListenerä¼šä»mPendingRequestsä¸­å–å‡ºä¸€ä¸ªåº”ç­”æ¶ˆæ¯ï¼Œå¹¶å‘é€æ¶ˆæ¯ç»™MyHandlerè¿›è¡Œå¤„ç†ï¼Œè€ŒnotifyResponseListeneråˆä¼šé˜»å¡ç­‰å¾…ä¸‹ä¸€ä¸ªæœåŠ¡å™¨çš„åº”ç­”ä¿¡å·ã€‚</p><p>OKæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹æ”¶åˆ°â€˜descâ€™ä¿¡å·åçš„å¤„ç†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">case 'desc':</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"result"</span>, &amp;result));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == OK) &#123;</span><br><span class="line">        sp&lt;RefBase&gt; obj;</span><br><span class="line">        CHECK(msg-&gt;findObject(<span class="string">"response"</span>, &amp;obj));</span><br><span class="line">        sp&lt;ARTSPResponse&gt; response = <span class="keyword">static_cast</span>&lt;ARTSPResponse *&gt;(obj.get());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (response-&gt;mStatusCode == <span class="number">301</span> || response-&gt;mStatusCode == <span class="number">302</span>) &#123;</span><br><span class="line">            <span class="comment">//é‡å®šå‘è¿æ¥</span></span><br><span class="line">            <span class="comment">//............</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response-&gt;mStatusCode != <span class="number">200</span>) &#123;</span><br><span class="line">            result = UNKNOWN_ERROR;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response-&gt;mContent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            result = ERROR_MALFORMED;</span><br><span class="line">            ALOGE(<span class="string">"The response has no content."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è·å¾—ASessionDescription</span></span><br><span class="line">            mSessionDesc = <span class="keyword">new</span> ASessionDescription;</span><br><span class="line">            mSessionDesc-&gt;setTo(response-&gt;mContent-&gt;data(),response-&gt;mContent-&gt;size());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mSessionDesc-&gt;isValid()) &#123;</span><br><span class="line">                <span class="comment">//............</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//............</span></span><br><span class="line">                <span class="keyword">if</span> (mSessionDesc-&gt;countTracks() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="comment">// There's no actual tracks in this session.</span></span><br><span class="line">                    <span class="comment">// The first "track" is merely session meta</span></span><br><span class="line">                    <span class="comment">// data.</span></span><br><span class="line">                    ALOGW(<span class="string">"Session doesn't contain any playable "</span></span><br><span class="line">                         <span class="string">"tracks. Aborting."</span>);</span><br><span class="line">                    result = ERROR_UNSUPPORTED;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//è¿™é‡Œæ‰æ˜¯çœŸæ­£è¦å¤„ç†çš„ä»£ç </span></span><br><span class="line">                    setupTrack(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç å¾ˆé•¿æˆ‘ä»¬å¿½ç•¥ä¸é‡è¦çš„ï¼Œç›´æ¥çœ‹setupTrackã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupTrack</span><span class="params">(<span class="keyword">size_t</span> index)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    sp&lt;APacketSource&gt; source = <span class="keyword">new</span> APacketSource(mSessionDesc, index);</span><br><span class="line">    AString url;</span><br><span class="line">    CHECK(mSessionDesc-&gt;findAttribute(index, <span class="string">"a=control"</span>, &amp;url));</span><br><span class="line">    AString trackURL;</span><br><span class="line">    <span class="comment">//è·å¾—å¤šåª’ä½“æ–‡ä»¶çš„Uri</span></span><br><span class="line">    CHECK(MakeURL(mBaseURL.c_str(), url.c_str(), &amp;trackURL));</span><br><span class="line"></span><br><span class="line">    mTracks.push(TrackInfo());</span><br><span class="line">    TrackInfo *info = &amp;mTracks.editItemAt(mTracks.size() - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//è®¾ç½®uri</span></span><br><span class="line">    info-&gt;mURL = trackURL;</span><br><span class="line">    <span class="comment">//è®¾ç½®APacketSource</span></span><br><span class="line">    info-&gt;mPacketSource = source;</span><br><span class="line">    info-&gt;mUsingInterleavedTCP = <span class="literal">false</span>;</span><br><span class="line">    info-&gt;mFirstSeqNumInSegment = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNewSegment = <span class="literal">true</span>;</span><br><span class="line">    info-&gt;mRTPSocket = <span class="number">-1</span>;</span><br><span class="line">    info-&gt;mRTCPSocket = <span class="number">-1</span>;</span><br><span class="line">    info-&gt;mRTPAnchor = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNTPAnchorUs = <span class="number">-1</span>;</span><br><span class="line">    info-&gt;mNormalPlayTimeRTP = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNormalPlayTimeUs = <span class="number">0l</span>l;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> PT;</span><br><span class="line">    AString formatDesc;</span><br><span class="line">    AString formatParams;</span><br><span class="line">    mSessionDesc-&gt;getFormatType(index, &amp;PT, &amp;formatDesc, &amp;formatParams);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> timescale;</span><br><span class="line">    <span class="keyword">int32_t</span> numChannels;</span><br><span class="line">    ASessionDescription::ParseFormatDesc(formatDesc.c_str(), &amp;timescale, &amp;numChannels);</span><br><span class="line"></span><br><span class="line">    info-&gt;mTimeScale = timescale;</span><br><span class="line">    info-&gt;mEOSReceived = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"track #%zu URL=%s"</span>, mTracks.size(), trackURL.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å»ºç«‹SETUPè¯·æ±‚</span></span><br><span class="line">    AString request = <span class="string">"SETUP "</span>;</span><br><span class="line">    request.append(trackURL);</span><br><span class="line">    request.append(<span class="string">" RTSP/1.0\r\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mTryTCPInterleaving) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> interleaveIndex = <span class="number">2</span> * (mTracks.size() - <span class="number">1</span>);</span><br><span class="line">        info-&gt;mUsingInterleavedTCP = <span class="literal">true</span>;</span><br><span class="line">        info-&gt;mRTPSocket = interleaveIndex;</span><br><span class="line">        info-&gt;mRTCPSocket = interleaveIndex + <span class="number">1</span>;</span><br><span class="line">        request.append(<span class="string">"Transport: RTP/AVP/TCP;interleaved="</span>);</span><br><span class="line">        request.append(interleaveIndex);</span><br><span class="line">        request.append(<span class="string">"-"</span>);</span><br><span class="line">        request.append(interleaveIndex + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> rtpPort;</span><br><span class="line">        ARTPConnection::MakePortPair(</span><br><span class="line">                &amp;info-&gt;mRTPSocket, &amp;info-&gt;mRTCPSocket, &amp;rtpPort);</span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPBase::RegisterSocketUserTag(info-&gt;mRTPSocket, mUID,</span><br><span class="line">                                            (<span class="keyword">uint32_t</span>)*(<span class="keyword">uint32_t</span>*) <span class="string">"RTP_"</span>);</span><br><span class="line">            HTTPBase::RegisterSocketUserTag(info-&gt;mRTCPSocket, mUID,</span><br><span class="line">                                            (<span class="keyword">uint32_t</span>)*(<span class="keyword">uint32_t</span>*) <span class="string">"RTP_"</span>);</span><br><span class="line">            HTTPBase::RegisterSocketUserMark(info-&gt;mRTPSocket, mUID);</span><br><span class="line">            HTTPBase::RegisterSocketUserMark(info-&gt;mRTCPSocket, mUID);</span><br><span class="line">        &#125;</span><br><span class="line">        request.append(<span class="string">"Transport: RTP/AVP/UDP;unicast;client_port="</span>);</span><br><span class="line">        request.append(rtpPort);</span><br><span class="line">        request.append(<span class="string">"-"</span>);</span><br><span class="line">        request.append(rtpPort + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    request.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        request.append(<span class="string">"Session: "</span>);</span><br><span class="line">        request.append(mSessionID);</span><br><span class="line">        request.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    request.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    sp&lt;AMessage&gt; reply = new AMessage('setu', this);</span><br><span class="line">    reply-&gt;setSize(<span class="string">"index"</span>, index);</span><br><span class="line">    reply-&gt;setSize(<span class="string">"track-index"</span>, mTracks.size() - <span class="number">1</span>);</span><br><span class="line">    mConn-&gt;sendRequest(request.c_str(), reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„é€»è¾‘ä¹Ÿå¾ˆç®€å•å°±æ˜¯å°†è¦è·å–åˆ°çš„æ­Œæ›²ä¿¡æ¯å­˜æ”¾åˆ°mTracksï¼Œå¹¶ä½¿ç”¨sendRequestå‘èµ·setuè¯·æ±‚ï¼ŒsendRequestå°±ä¸å†ä½œè¯¦ç»†ä»‹ç»äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¸‹â€˜setuâ€™è¿”å›åçš„å¤„ç†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">case 'setu':</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"index"</span>, &amp;index));</span><br><span class="line">    TrackInfo *track = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span> trackIndex;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findSize(<span class="string">"track-index"</span>, &amp;trackIndex)) &#123;</span><br><span class="line">        track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"result"</span>, &amp;result));</span><br><span class="line">    <span class="keyword">if</span> (result == OK) &#123;</span><br><span class="line">        CHECK(track != <span class="literal">NULL</span>);</span><br><span class="line">        sp&lt;RefBase&gt; obj;</span><br><span class="line">        CHECK(msg-&gt;findObject(<span class="string">"response"</span>, &amp;obj));</span><br><span class="line">        sp&lt;ARTSPResponse&gt; response =</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;ARTSPResponse *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response-&gt;mStatusCode != <span class="number">200</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">ssize_t</span> i = response-&gt;mHeaders.indexOfKey(<span class="string">"session"</span>);</span><br><span class="line">            CHECK_GE(i, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//å¾—åˆ°SessionID</span></span><br><span class="line">            mSessionID = response-&gt;mHeaders.valueAt(i);</span><br><span class="line">            mKeepAliveTimeoutUs = kDefaultKeepAliveTimeoutUs;</span><br><span class="line">            AString timeoutStr;</span><br><span class="line">            <span class="comment">//........................</span></span><br><span class="line">            sp&lt;AMessage&gt; notify = new AMessage('accu', this);</span><br><span class="line">            notify-&gt;setSize(<span class="string">"track-index"</span>, trackIndex);</span><br><span class="line">            i = response-&gt;mHeaders.indexOfKey(<span class="string">"transport"</span>);</span><br><span class="line">            CHECK_GE(i, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (track-&gt;mRTPSocket != <span class="number">-1</span> &amp;&amp; track-&gt;mRTCPSocket != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!track-&gt;mUsingInterleavedTCP) &#123;</span><br><span class="line">                    AString transport = response-&gt;mHeaders.valueAt(i);</span><br><span class="line">                    <span class="comment">// We are going to continue even if we were</span></span><br><span class="line">                    <span class="comment">// unable to poke a hole into the firewall...</span></span><br><span class="line">                    pokeAHole(</span><br><span class="line">                            track-&gt;mRTPSocket,</span><br><span class="line">                            track-&gt;mRTCPSocket,</span><br><span class="line">                            transport);</span><br><span class="line">                &#125;</span><br><span class="line">                mRTPConn-&gt;addStream(</span><br><span class="line">                        track-&gt;mRTPSocket, track-&gt;mRTCPSocket,</span><br><span class="line">                        mSessionDesc, index,</span><br><span class="line">                        notify, track-&gt;mUsingInterleavedTCP);</span><br><span class="line">                mSetupTracksSuccessful = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = BAD_VALUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æœ€é‡è¦çš„å°±æ˜¯è·å–SessionIDå¹¶è°ƒç”¨mRTPConn-&gt;addStreamå®ŒARTPConnectionä¸­æ·»åŠ ä¸€ä¸ªæµï¼Œæˆ‘ä»¬çœ‹ä¸‹addStreamï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ARTPConnection::addStream(</span><br><span class="line">        <span class="keyword">int</span> rtpSocket, <span class="keyword">int</span> rtcpSocket,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ASessionDescription&gt; &amp;sessionDesc,</span><br><span class="line">        <span class="keyword">size_t</span> index,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;notify,</span><br><span class="line">        <span class="keyword">bool</span> injected) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatAddStream, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"rtp-socket"</span>, rtpSocket);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"rtcp-socket"</span>, rtcpSocket);</span><br><span class="line">    msg-&gt;setObject(<span class="string">"session-desc"</span>, sessionDesc);</span><br><span class="line">    msg-&gt;setSize(<span class="string">"index"</span>, index);</span><br><span class="line">    msg-&gt;setMessage(<span class="string">"notify"</span>, notify);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"injected"</span>, injected);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatAddStream:</span><br><span class="line">&#123;</span><br><span class="line">    onAddStream(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ARTPConnection::onAddStream(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="comment">//å°†Streamä¿¡æ¯æ·»åŠ åˆ°mStreams</span></span><br><span class="line">    mStreams.push_back(StreamInfo());</span><br><span class="line">    StreamInfo *info = &amp;*--mStreams.end();</span><br><span class="line">    <span class="keyword">int32_t</span> s;</span><br><span class="line">    <span class="comment">//è·å¾—rtp-socket</span></span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"rtp-socket"</span>, &amp;s));</span><br><span class="line">    info-&gt;mRTPSocket = s;</span><br><span class="line">    <span class="comment">//è·å¾—rtcp-socket</span></span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"rtcp-socket"</span>, &amp;s));</span><br><span class="line">    info-&gt;mRTCPSocket = s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> injected;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"injected"</span>, &amp;injected));</span><br><span class="line"></span><br><span class="line">    info-&gt;mIsInjected = injected;</span><br><span class="line">    <span class="comment">//è·å¾—session-desc</span></span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    CHECK(msg-&gt;findObject(<span class="string">"session-desc"</span>, &amp;obj));</span><br><span class="line">    info-&gt;mSessionDesc = <span class="keyword">static_cast</span>&lt;ASessionDescription *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"index"</span>, &amp;info-&gt;mIndex));</span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"notify"</span>, &amp;info-&gt;mNotifyMsg));</span><br><span class="line"></span><br><span class="line">    info-&gt;mNumRTCPPacketsReceived = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNumRTPPacketsReceived = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;info-&gt;mRemoteRTCPAddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(info-&gt;mRemoteRTCPAddr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‘é€è½®è¯¢æŸ¥è¯¢äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (!injected) &#123;</span><br><span class="line">        postPollEvent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­é‡ç‚¹å…³æ³¨çš„æ˜¯postPollEventï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ARTPConnection::postPollEvent() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPollEventPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatPollStreams, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">    mPollEventPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatPollStreams:</span><br><span class="line">&#123;</span><br><span class="line">    onPollStreams();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ARTPConnection::onPollStreams() &#123;</span><br><span class="line">    mPollEventPending = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStreams.empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    tv.tv_sec = <span class="number">0</span>;</span><br><span class="line">    tv.tv_usec = kSelectTimeoutUs;</span><br><span class="line"></span><br><span class="line">    fd_set rs;</span><br><span class="line">    FD_ZERO(&amp;rs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> maxSocket = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">         it != mStreams.end(); ++it) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*it).mIsInjected) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        FD_SET(it-&gt;mRTPSocket, &amp;rs);</span><br><span class="line">        FD_SET(it-&gt;mRTCPSocket, &amp;rs);</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;mRTPSocket &gt; maxSocket) &#123;</span><br><span class="line">            maxSocket = it-&gt;mRTPSocket;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;mRTCPSocket &gt; maxSocket) &#123;</span><br><span class="line">            maxSocket = it-&gt;mRTCPSocket;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (maxSocket == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€‰æ‹©ä¸€ä¸ªç½‘ç»œè¯·æ±‚</span></span><br><span class="line">    <span class="keyword">int</span> res = select(maxSocket + <span class="number">1</span>, &amp;rs, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//åœ¨è¿™é‡Œæ¥æ”¶æœåŠ¡å™¨å‘è¿‡æ¥çš„æ•°æ®</span></span><br><span class="line">        List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">        <span class="keyword">while</span> (it != mStreams.end()) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((*it).mIsInjected) &#123;</span><br><span class="line">                ++it;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">status_t</span> err = OK;</span><br><span class="line">            <span class="comment">//æ¥å—ä»æœåŠ¡å™¨å‘æ¥çš„æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> (FD_ISSET(it-&gt;mRTPSocket, &amp;rs)) &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨çš„æ˜¯status_t ARTPConnection::receive(StreamInfo *s, bool receiveRTP)</span></span><br><span class="line">                err = receive(&amp;*it, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ¥å—ä»æœåŠ¡å™¨å‘æ¥çš„æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> (err == OK &amp;&amp; FD_ISSET(it-&gt;mRTCPSocket, &amp;rs)) &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨çš„æ˜¯status_t ARTPConnection::receive(StreamInfo *s, bool receiveRTP)</span></span><br><span class="line">                err = receive(&amp;*it, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ++it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> nowUs = ALooper::GetNowUs();</span><br><span class="line">    <span class="keyword">if</span> (mLastReceiverReportTimeUs &lt;= <span class="number">0</span>|| mLastReceiverReportTimeUs + <span class="number">5000000l</span>l &lt;= nowUs) &#123;</span><br><span class="line">        <span class="comment">//æ–°å»ºä¸€ä¸ªç¼“å­˜åŒº</span></span><br><span class="line">        sp&lt;ABuffer&gt; buffer = <span class="keyword">new</span> ABuffer(kMaxUDPSize);</span><br><span class="line">        List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">        <span class="keyword">while</span> (it != mStreams.end()) &#123;</span><br><span class="line">            StreamInfo *s = &amp;*it;</span><br><span class="line">            <span class="keyword">if</span> (s-&gt;mIsInjected) &#123;</span><br><span class="line">                ++it;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (s-&gt;mNumRTCPPacketsReceived == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// We have never received any RTCP packets on this stream,</span></span><br><span class="line">                <span class="comment">// we don't even know where to send a report.</span></span><br><span class="line">                ++it;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buffer-&gt;setRange(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; s-&gt;mSources.size(); ++i) &#123;</span><br><span class="line">                sp&lt;ARTPSource&gt; source = s-&gt;mSources.valueAt(i);</span><br><span class="line">                <span class="comment">//å¡«å……buffer</span></span><br><span class="line">                source-&gt;addReceiverReport(buffer);</span><br><span class="line">                <span class="keyword">if</span> (mFlags &amp; kRegularlyRequestFIR) &#123;</span><br><span class="line">                    source-&gt;addFIR(buffer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (buffer-&gt;size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGV(<span class="string">"Sending RR..."</span>);</span><br><span class="line">                <span class="keyword">ssize_t</span> n;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">//é€šéRTCPSocketç™¼é€</span></span><br><span class="line">                    n = sendto(s-&gt;mRTCPSocket, buffer-&gt;data(), buffer-&gt;size(), <span class="number">0</span>,(<span class="keyword">const</span> struct sockaddr *)&amp;s-&gt;mRemoteRTCPAddr, <span class="keyword">sizeof</span>(s-&gt;mRemoteRTCPAddr));</span><br><span class="line">                &#125; <span class="keyword">while</span> (n &lt; <span class="number">0</span> &amp;&amp; errno == EINTR);</span><br><span class="line">                CHECK_EQ(n, (<span class="keyword">ssize_t</span>)buffer-&gt;size());</span><br><span class="line">                mLastReceiverReportTimeUs = nowUs;</span><br><span class="line">            &#125;</span><br><span class="line">            ++it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mStreams.empty()) &#123;</span><br><span class="line">        postPollEvent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†onPollStreamsä¸­ä¼šé˜»å¡ç›‘å¬æœåŠ¡å™¨å‘è¿‡æ¥çš„åª’ä½“æ•°æ®ï¼Œå¹¶è°ƒç”¨receiveå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå¹¶å®šæœŸå‘é€RTCPæ¶ˆæ¯ç»™æœåŠ¡å™¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> ARTPConnection::receive(StreamInfo *s, <span class="keyword">bool</span> receiveRTP) &#123;</span><br><span class="line">    </span><br><span class="line">    ALOGV(<span class="string">"receiving %s"</span>, receiveRTP ? <span class="string">"RTP"</span> : <span class="string">"RTCP"</span>);</span><br><span class="line"></span><br><span class="line">    CHECK(!s-&gt;mIsInjected);</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer = <span class="keyword">new</span> ABuffer(<span class="number">65536</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> remoteAddrLen =</span><br><span class="line">        (!receiveRTP &amp;&amp; s-&gt;mNumRTCPPacketsReceived == <span class="number">0</span>)</span><br><span class="line">            ? <span class="keyword">sizeof</span>(s-&gt;mRemoteRTCPAddr) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> nbytes;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//ä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®</span></span><br><span class="line">        nbytes = recvfrom(</span><br><span class="line">            receiveRTP ? s-&gt;mRTPSocket : s-&gt;mRTCPSocket,</span><br><span class="line">            buffer-&gt;data(),</span><br><span class="line">            buffer-&gt;capacity(),</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            remoteAddrLen &gt; <span class="number">0</span> ? (struct sockaddr *)&amp;s-&gt;mRemoteRTCPAddr : <span class="literal">NULL</span>,</span><br><span class="line">            remoteAddrLen &gt; <span class="number">0</span> ? &amp;remoteAddrLen : <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (nbytes &lt; <span class="number">0</span> &amp;&amp; errno == EINTR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ECONNRESET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buffer-&gt;setRange(<span class="number">0</span>, nbytes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGI("received %d bytes.", buffer-&gt;size());</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="comment">//è§£æRTP æˆ–è€… parseRTCP</span></span><br><span class="line">    <span class="keyword">if</span> (receiveRTP) &#123;</span><br><span class="line">        err = parseRTP(s, buffer);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = parseRTCP(s, buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>receiveæ–¹æ³•ä¸­ä¼šè°ƒç”¨recvfromã€‚å°†æ•°æ®ä»æœåŠ¡å™¨ä¸­è¯»å–åˆ°ç¼“å­˜ï¼Œå¹¶è°ƒç”¨parseRTPæˆ–è€…parseRTCPå¯¹ç¼“å­˜ä¸­çš„æ•°æ®è¿›è¡Œå¤„ç†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> ARTPConnection::parseRTP(StreamInfo *s, <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *data = buffer-&gt;data();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((data[<span class="number">0</span>] &gt;&gt; <span class="number">6</span>) != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// Unsupported version.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[<span class="number">0</span>] &amp; <span class="number">0x20</span>) &#123;</span><br><span class="line">        <span class="comment">// Padding present.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">size_t</span> paddingLength = data[size - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (paddingLength + <span class="number">12</span> &gt; size) &#123;</span><br><span class="line">            <span class="comment">// If we removed this much padding we'd end up with something</span></span><br><span class="line">            <span class="comment">// that's too short to be a valid RTP header.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        size -= paddingLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numCSRCs = data[<span class="number">0</span>] &amp; <span class="number">0x0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> payloadOffset = <span class="number">12</span> + <span class="number">4</span> * numCSRCs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt; payloadOffset) &#123;</span><br><span class="line">        <span class="comment">// Not enough data to fit the basic header and all the CSRC entries.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[<span class="number">0</span>] &amp; <span class="number">0x10</span>) &#123;</span><br><span class="line">        <span class="comment">// Header eXtension present.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &lt; payloadOffset + <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="comment">// Not enough data to fit the basic header, all CSRC entries</span></span><br><span class="line">            <span class="comment">// and the first 4 bytes of the extension header.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint8_t</span> *extensionData = &amp;data[payloadOffset];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">size_t</span> extensionLength =</span><br><span class="line">            <span class="number">4</span> * (extensionData[<span class="number">2</span>] &lt;&lt; <span class="number">8</span> | extensionData[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &lt; payloadOffset + <span class="number">4</span> + extensionLength) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        payloadOffset += <span class="number">4</span> + extensionLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> srcId = u32at(&amp;data[<span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">    sp&lt;ARTPSource&gt; source = findSource(s, srcId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> rtpTime = u32at(&amp;data[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; meta = buffer-&gt;meta();</span><br><span class="line">    meta-&gt;setInt32(<span class="string">"ssrc"</span>, srcId);</span><br><span class="line">    meta-&gt;setInt32(<span class="string">"rtp-time"</span>, rtpTime);</span><br><span class="line">    meta-&gt;setInt32(<span class="string">"PT"</span>, data[<span class="number">1</span>] &amp; <span class="number">0x7f</span>);</span><br><span class="line">    meta-&gt;setInt32(<span class="string">"M"</span>, data[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    buffer-&gt;setInt32Data(u16at(&amp;data[<span class="number">2</span>]));</span><br><span class="line">    buffer-&gt;setRange(payloadOffset, size - payloadOffset);</span><br><span class="line">    <span class="comment">//è¿™é‡Œååˆ†é‡è¦void ARTPSource::processRTPPacket(const sp&lt;ABuffer&gt; &amp;buffer)</span></span><br><span class="line">    source-&gt;processRTPPacket(buffer);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨parsRTPä¸­æ ¹æ®RTPæ ¼å¼å¯¹ç¼“å­˜åŒºä¸­çš„æ•°æ®è¿›è¡Œè§£æï¼Œæœ€åè°ƒç”¨ARTPSource::processRTPPacketè¿›è¡Œåç»­å¤„ç†ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTPSource.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTPSource::processRTPPacket(<span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (queuePacket(buffer) &amp;&amp; mAssembler != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mAssembler-&gt;onPacketReceived(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>processRTPPacketä¸­è°ƒç”¨Assembleræ¥å°†æ•°æ®è¿›è¡Œé‡ç»„ï¼Œè¿™é‡Œæœ€é‡è¦çš„æ–¹æ³•æ˜¯assembleMore</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTPAssembler.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTPAssembler::onPacketReceived(<span class="keyword">const</span> sp&lt;ARTPSource&gt; &amp;source) &#123;</span><br><span class="line">    AssemblyStatus status;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//assembleMore</span></span><br><span class="line">        status = assembleMore(source);</span><br><span class="line">        <span class="keyword">if</span> (status == WRONG_SEQUENCE_NUMBER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFirstFailureTimeUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ALooper::GetNowUs() - mFirstFailureTimeUs &gt; <span class="number">10000l</span>l) &#123;</span><br><span class="line">                    mFirstFailureTimeUs = <span class="number">-1</span>;</span><br><span class="line">                    <span class="comment">// LOG(VERBOSE) &lt;&lt; "waited too long for packet.";</span></span><br><span class="line">                    packetLost();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mFirstFailureTimeUs = ALooper::GetNowUs();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mFirstFailureTimeUs = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">if</span> (status == NOT_ENOUGH_DATA) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ARTPAssembler::AssemblyStatus AMPEG4AudioAssembler::assembleMore(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTPSource&gt; &amp;source) &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨addPacket</span></span><br><span class="line">    AssemblyStatus status = addPacket(source);</span><br><span class="line">    <span class="keyword">if</span> (status == MALFORMED_PACKET) &#123;</span><br><span class="line">        mAccessUnitDamaged = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®é™…ä¸Šæ˜¯å¯¹æ— åºçš„æ•°æ®åŒ…è¿›è¡Œæ’åºï¼Œå¹¶è°ƒç”¨submitAccessUnitæäº¤AUæ•°æ®ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">ARTPAssembler::AssemblyStatus AMPEG4AudioAssembler::addPacket(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTPSource&gt; &amp;source) &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;sp&lt;ABuffer&gt; &gt; *<span class="built_in">queue</span> = source-&gt;<span class="built_in">queue</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> NOT_ENOUGH_DATA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mNextExpectedSeqNoValid) &#123;</span><br><span class="line">        List&lt;sp&lt;ABuffer&gt; &gt;::iterator it = <span class="built_in">queue</span>-&gt;begin();</span><br><span class="line">        <span class="keyword">while</span> (it != <span class="built_in">queue</span>-&gt;end()) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">uint32_t</span>)(*it)-&gt;int32Data() &gt;= mNextExpectedSeqNo) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            it = <span class="built_in">queue</span>-&gt;erase(it);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;empty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> NOT_ENOUGH_DATA;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer = *<span class="built_in">queue</span>-&gt;begin();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mNextExpectedSeqNoValid) &#123;</span><br><span class="line">        mNextExpectedSeqNoValid = <span class="literal">true</span>;</span><br><span class="line">        mNextExpectedSeqNo = (<span class="keyword">uint32_t</span>)buffer-&gt;int32Data();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">uint32_t</span>)buffer-&gt;int32Data() != mNextExpectedSeqNo) &#123;</span><br><span class="line">#<span class="keyword">if</span> VERBOSE</span><br><span class="line">        LOG(VERBOSE) &lt;&lt; <span class="string">"Not the sequence number I expected"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> WRONG_SEQUENCE_NUMBER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> rtpTime;</span><br><span class="line">    CHECK(buffer-&gt;meta()-&gt;findInt32(<span class="string">"rtp-time"</span>, (<span class="keyword">int32_t</span> *)&amp;rtpTime));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æäº¤AccessUnit</span></span><br><span class="line">    <span class="keyword">if</span> (mPackets.size() &gt; <span class="number">0</span> &amp;&amp; rtpTime != mAccessUnitRTPTime) &#123;</span><br><span class="line">        submitAccessUnit();</span><br><span class="line">    &#125;</span><br><span class="line">    mAccessUnitRTPTime = rtpTime;</span><br><span class="line">    <span class="comment">//å°†ç¼“å­˜æ·»åŠ åˆ°mPackets</span></span><br><span class="line">    mPackets.push_back(buffer);</span><br><span class="line">    <span class="built_in">queue</span>-&gt;erase(<span class="built_in">queue</span>-&gt;begin());</span><br><span class="line">    ++mNextExpectedSeqNo;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>submitAccessUnitä¸­å›è°ƒâ€˜accuâ€™ï¼Œäº¤ç»™MyHandlerå¤„ç†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AMPEG4AudioAssembler::submitAccessUnit() &#123;</span><br><span class="line">    CHECK(!mPackets.empty());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> VERBOSE</span></span><br><span class="line">    LOG(VERBOSE) &lt;&lt; <span class="string">"Access unit complete ("</span> &lt;&lt; mPackets.size() &lt;&lt; <span class="string">" packets)"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit = MakeCompoundFromPackets(mPackets);</span><br><span class="line">    accessUnit = removeLATMFraming(accessUnit);</span><br><span class="line">    CopyTimes(accessUnit, *mPackets.begin());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAccessUnitDamaged) &#123;</span><br><span class="line">        accessUnit-&gt;meta()-&gt;setInt32(<span class="string">"damaged"</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPackets.clear();</span><br><span class="line">    mAccessUnitDamaged = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//å›è°ƒâ€˜accuâ€™</span></span><br><span class="line">    sp&lt;AMessage&gt; msg = mNotifyMsg-&gt;dup();</span><br><span class="line">    msg-&gt;setBuffer(<span class="string">"access-unit"</span>, accessUnit);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case 'accu':</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> timeUpdate;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"time-update"</span>, &amp;timeUpdate) &amp;&amp; timeUpdate) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> trackIndex;</span><br><span class="line">        CHECK(msg-&gt;findSize(<span class="string">"track-index"</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> rtpTime;</span><br><span class="line">        <span class="keyword">uint64_t</span> ntpTime;</span><br><span class="line">        CHECK(msg-&gt;findInt32(<span class="string">"rtp-time"</span>, (<span class="keyword">int32_t</span> *)&amp;rtpTime));</span><br><span class="line">        CHECK(msg-&gt;findInt64(<span class="string">"ntp-time"</span>, (<span class="keyword">int64_t</span> *)&amp;ntpTime));</span><br><span class="line"></span><br><span class="line">        onTimeUpdate(trackIndex, rtpTime, ntpTime);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> first;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"first-rtcp"</span>, &amp;first)) &#123;</span><br><span class="line">        mReceivedFirstRTCPPacket = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"first-rtp"</span>, &amp;first)) &#123;</span><br><span class="line">        mReceivedFirstRTPPacket = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ++mNumAccessUnitsReceived;</span><br><span class="line">    postAccessUnitTimeoutCheck();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> trackIndex;</span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"track-index"</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (trackIndex &gt;= mTracks.size()) &#123;</span><br><span class="line">        ALOGV(<span class="string">"late packets ignored."</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> eos;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"eos"</span>, &amp;eos)) &#123;</span><br><span class="line">        ALOGI(<span class="string">"received BYE on track index %zu"</span>, trackIndex);</span><br><span class="line">        <span class="keyword">if</span> (!mAllTracksHaveTime &amp;&amp; dataReceivedOnAllChannels()) &#123;</span><br><span class="line">            ALOGI(<span class="string">"No time established =&gt; fake existing data"</span>);</span><br><span class="line"></span><br><span class="line">            track-&gt;mEOSReceived = <span class="literal">true</span>;</span><br><span class="line">            mTryFakeRTCP = <span class="literal">true</span>;</span><br><span class="line">            mReceivedFirstRTCPPacket = <span class="literal">true</span>;</span><br><span class="line">            fakeTimestamps();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            postQueueEOS(trackIndex, ERROR_END_OF_STREAM);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    <span class="comment">//å–å‡ºaccessUnit</span></span><br><span class="line">    CHECK(msg-&gt;findBuffer(<span class="string">"access-unit"</span>, &amp;accessUnit));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> seqNum = (<span class="keyword">uint32_t</span>)accessUnit-&gt;int32Data();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSeekPending) &#123;</span><br><span class="line">        ALOGV(<span class="string">"we're seeking, dropping stale packet."</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seqNum &lt; track-&gt;mFirstSeqNumInSegment) &#123;</span><br><span class="line">        ALOGV(<span class="string">"dropping stale access-unit (%d &lt; %d)"</span>,</span><br><span class="line">             seqNum, track-&gt;mFirstSeqNumInSegment);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (track-&gt;mNewSegment) &#123;</span><br><span class="line">        track-&gt;mNewSegment = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è°ƒç”¨onAccessUnitComplete</span></span><br><span class="line">    onAccessUnitComplete(trackIndex, accessUnit);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€˜accuâ€™å–å‡ºAUæ•°æ®åè°ƒç”¨onAccessUnitCompleteè¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹è¿™éƒ¨åˆ†é€»è¾‘ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onAccessUnitComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int32_t</span> trackIndex, <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;accessUnit)</span> </span>&#123;</span><br><span class="line">    ALOGV(<span class="string">"onAccessUnitComplete track %d"</span>, trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!mPlayResponseParsed)&#123;</span><br><span class="line">        ALOGI(<span class="string">"play response is not parsed, storing accessunit"</span>);</span><br><span class="line">        TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line">        track-&gt;mPackets.push_back(accessUnit);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handleFirstAccessUnit();</span><br><span class="line"></span><br><span class="line">    TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mAllTracksHaveTime) &#123;</span><br><span class="line">        ALOGV(<span class="string">"storing accessUnit, no time established yet"</span>);</span><br><span class="line">        track-&gt;mPackets.push_back(accessUnit);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!track-&gt;mPackets.empty()) &#123;</span><br><span class="line">        sp&lt;ABuffer&gt; accessUnit = *track-&gt;mPackets.begin();</span><br><span class="line">        track-&gt;mPackets.erase(track-&gt;mPackets.begin());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (addMediaTimestamp(trackIndex, track, accessUnit)) &#123;</span><br><span class="line">            <span class="comment">//postQueueAccessUnit</span></span><br><span class="line">            postQueueAccessUnit(trackIndex, accessUnit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addMediaTimestamp(trackIndex, track, accessUnit)) &#123;</span><br><span class="line">        postQueueAccessUnit(trackIndex, accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (track-&gt;mEOSReceived) &#123;</span><br><span class="line">        postQueueEOS(trackIndex, ERROR_END_OF_STREAM);</span><br><span class="line">        track-&gt;mEOSReceived = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">postQueueAccessUnit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">size_t</span> trackIndex, <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;accessUnit)</span> </span>&#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = mNotify-&gt;dup();</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"what"</span>, kWhatAccessUnit);</span><br><span class="line">    msg-&gt;setSize(<span class="string">"trackIndex"</span>, trackIndex);</span><br><span class="line">    msg-&gt;setBuffer(<span class="string">"accessUnit"</span>, accessUnit);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨RTSPSourceä¸­è°ƒç”¨AnotherPacketSource queueAccessUnit(accessUnit)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MyHandler::kWhatAccessUnit:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> trackIndex;</span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"trackIndex"</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mTSParser == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        CHECK_LT(trackIndex, mTracks.size());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CHECK_EQ(trackIndex, <span class="number">0u</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    CHECK(msg-&gt;findBuffer(<span class="string">"accessUnit"</span>, &amp;accessUnit));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> damaged;</span><br><span class="line">    <span class="keyword">if</span> (accessUnit-&gt;meta()-&gt;findInt32(<span class="string">"damaged"</span>, &amp;damaged)</span><br><span class="line">            &amp;&amp; damaged) &#123;</span><br><span class="line">        ALOGI(<span class="string">"dropping damaged access unit."</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mTSParser != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">status_t</span> err = OK;</span><br><span class="line">        <span class="keyword">while</span> (offset + <span class="number">188</span> &lt;= accessUnit-&gt;size()) &#123;</span><br><span class="line">            err = mTSParser-&gt;feedTSPacket(</span><br><span class="line">                    accessUnit-&gt;data() + offset, <span class="number">188</span>);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            offset += <span class="number">188</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (offset &lt; accessUnit-&gt;size()) &#123;</span><br><span class="line">            err = ERROR_MALFORMED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; source = getSource(<span class="literal">false</span> <span class="comment">/* audio */</span>);</span><br><span class="line">            <span class="keyword">if</span> (source != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                source-&gt;signalEOS(err);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            source = getSource(<span class="literal">true</span> <span class="comment">/* audio */</span>);</span><br><span class="line">            <span class="keyword">if</span> (source != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                source-&gt;signalEOS(err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TrackInfo *info = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    sp&lt;AnotherPacketSource&gt; source = info-&gt;mSource;</span><br><span class="line">    <span class="keyword">if</span> (source != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> rtpTime;</span><br><span class="line">        CHECK(accessUnit-&gt;meta()-&gt;findInt32(<span class="string">"rtp-time"</span>, (<span class="keyword">int32_t</span> *)&amp;rtpTime));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!info-&gt;mNPTMappingValid) &#123;</span><br><span class="line">            <span class="comment">// This is a live stream, we didn't receive any normal</span></span><br><span class="line">            <span class="comment">// playtime mapping. We won't map to npt time.</span></span><br><span class="line">            source-&gt;queueAccessUnit(accessUnit);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int64_t</span> nptUs =</span><br><span class="line">            ((<span class="keyword">double</span>)rtpTime - (<span class="keyword">double</span>)info-&gt;mRTPTime)</span><br><span class="line">                / info-&gt;mTimeScale</span><br><span class="line">                * <span class="number">1000000l</span>l</span><br><span class="line">                + info-&gt;mNormalPlaytimeUs;</span><br><span class="line"></span><br><span class="line">        accessUnit-&gt;meta()-&gt;setInt64(<span class="string">"timeUs"</span>, nptUs);</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">        source-&gt;queueAccessUnit(accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>queueAccessUnit(accessUnit);å°†AUæ•°æ®å­˜æ”¾åˆ°AnotherPacketSource çš„mBuffersä¸­ä¾›è§£ç å™¨è§£ç æ’­æ”¾ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AnotherPacketSource::queueAccessUnit(<span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> damaged;</span><br><span class="line">    ......</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    mBuffers.push_back(buffer);</span><br><span class="line">    mCondition.signal();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> discontinuity;</span><br><span class="line">    <span class="keyword">if</span> (buffer-&gt;meta()-&gt;findInt32(<span class="string">"discontinuity"</span>, &amp;discontinuity))&#123;</span><br><span class="line">        ALOGV(<span class="string">"queueing a discontinuity with queueAccessUnit"</span>);</span><br><span class="line"></span><br><span class="line">        mLastQueuedTimeUs = <span class="number">0l</span>l;</span><br><span class="line">        mEOSResult = OK;</span><br><span class="line">        mLatestEnqueuedMeta = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        mDiscontinuitySegments.push_back(DiscontinuitySegment());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> lastQueuedTimeUs;</span><br><span class="line">    CHECK(buffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;lastQueuedTimeUs));</span><br><span class="line">    mLastQueuedTimeUs = lastQueuedTimeUs;</span><br><span class="line">    ALOGV(<span class="string">"queueAccessUnit timeUs=%"</span> PRIi64 <span class="string">" us (%.2f secs)"</span>,</span><br><span class="line">            mLastQueuedTimeUs, mLastQueuedTimeUs / <span class="number">1E6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CHECK(!mDiscontinuitySegments.empty());</span></span><br><span class="line">    DiscontinuitySegment &amp;tailSeg = *(--mDiscontinuitySegments.end());</span><br><span class="line">    <span class="keyword">if</span> (lastQueuedTimeUs &gt; tailSeg.mMaxEnqueTimeUs) &#123;</span><br><span class="line">        tailSeg.mMaxEnqueTimeUs = lastQueuedTimeUs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (tailSeg.mMaxDequeTimeUs == <span class="number">-1</span>) &#123;</span><br><span class="line">        tailSeg.mMaxDequeTimeUs = lastQueuedTimeUs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mLatestEnqueuedMeta == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mLatestEnqueuedMeta = buffer-&gt;meta()-&gt;dup();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> latestTimeUs = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int64_t</span> frameDeltaUs = <span class="number">0</span>;</span><br><span class="line">        CHECK(mLatestEnqueuedMeta-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;latestTimeUs));</span><br><span class="line">        <span class="keyword">if</span> (lastQueuedTimeUs &gt; latestTimeUs) &#123;</span><br><span class="line">            mLatestEnqueuedMeta = buffer-&gt;meta()-&gt;dup();</span><br><span class="line">            frameDeltaUs = lastQueuedTimeUs - latestTimeUs;</span><br><span class="line">            mLatestEnqueuedMeta-&gt;setInt64(<span class="string">"durationUs"</span>, frameDeltaUs);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mLatestEnqueuedMeta-&gt;findInt64(<span class="string">"durationUs"</span>, &amp;frameDeltaUs)) &#123;</span><br><span class="line">            <span class="comment">// For B frames</span></span><br><span class="line">            frameDeltaUs = latestTimeUs - lastQueuedTimeUs;</span><br><span class="line">            mLatestEnqueuedMeta-&gt;setInt64(<span class="string">"durationUs"</span>, frameDeltaUs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-4ã€è·å–æ•°æ®è¿›è¡Œç¼–ç ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰"><a href="#3-4ã€è·å–æ•°æ®è¿›è¡Œç¼–ç ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰" class="headerlink" title="3.4ã€è·å–æ•°æ®è¿›è¡Œç¼–ç ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰"></a>3.4ã€è·å–æ•°æ®è¿›è¡Œç¼–ç ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰</h5><h5 id="3-5ã€æ’­æ”¾æµç¨‹ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰"><a href="#3-5ã€æ’­æ”¾æµç¨‹ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰" class="headerlink" title="3.5ã€æ’­æ”¾æµç¨‹ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰"></a>3.5ã€æ’­æ”¾æµç¨‹ï¼ˆè¯·å‚è€ƒå‰é¢HLSå°èŠ‚åˆ†æï¼‰</h5><h4 id="ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå››ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">android ACodec MediaCodec NuPlayer flow - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">android MediaCodec ACodec - CSDNåšå®¢</a><br><a href="https://tbfungeek.github.io/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">Android æºç åˆ†æä¹‹åŸºäºNuPlayerçš„HLSæµåª’ä½“åè®®</a><br><a href="https://tbfungeek.github.io/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">Android æºç åˆ†æä¹‹åŸºäºNuPlayerçš„RTSPæµåª’ä½“åè®®</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/09/17/Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®/">http://zhoujinjian.cc/2018/09/17/Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/09/12/Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ/" title="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"><i class="iconfont icon-prev"></i>Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">26</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.08.jpg" alt="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/17/Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®/" title="Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.27.jpg" alt="Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®</h3><span class="item__text">2018-09-17</span></div></a></li><li class="latest-post-item"><a href="/2018/09/12/Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ/" title="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.26.jpg" alt="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</h3><span class="item__text">2018-09-12</span></div></a></li><li class="latest-post-item"><a href="/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/" title="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.25.jpg" alt="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</h3><span class="item__text">2018-09-06</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>izhoujinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:izhoujinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">368.9k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>