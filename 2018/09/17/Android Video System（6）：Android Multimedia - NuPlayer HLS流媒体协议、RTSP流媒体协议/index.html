<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议 | ๑Charles✦ˑ̫✦Vincent๑</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="๑Charles✦ˑ̫✦Vincent๑"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, 源代码, ActivityManagerService, AMS, WindowManagerService, WMS , zygote ，InputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="嘿嘿(๑乛◡乛๑),但这也是无可奈何的事情，毕竟世上不可能有那么多十全十美的好事，做人在某些时候总是要有些取舍的。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/09/17/Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="๑Charles✦ˑ̫✦Vincent๑"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="๑Charles✦ˑ̫✦Vincent๑" alt="๑Charles✦ˑ̫✦Vincent๑"><img src="/img/Logo.png" alt="๑Charles✦ˑ̫✦Vincent๑"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.27.jpg" alt="Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议"></div><header class="post__info"><h1 class="post__title">Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://www.github.com/izhoujinjian">๑Charles✦ˑ̫✦Vincent๑</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-09-17</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">👽<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">🌀<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#（一）、基于NuPlayer的HLS流媒体协议"><span class="toc-text">（一）、基于NuPlayer的HLS流媒体协议</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1、HLS-概述"><span class="toc-text">1.1、HLS 概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2、HLS框架介绍"><span class="toc-text">1.2、HLS框架介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3、HLS播放流程"><span class="toc-text">1.3、HLS播放流程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（二）、基于NuPlayer的HLS流媒体播放源码分析"><span class="toc-text">（二）、基于NuPlayer的HLS流媒体播放源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1、HTTPLiveSource-prepareAsync"><span class="toc-text">2.1、HTTPLiveSource::prepareAsync()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2、获取数据进行解码"><span class="toc-text">2.2、获取数据进行解码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3、循环获取数据HTTPLiveSource-dequeueAccessUnit"><span class="toc-text">2.3、循环获取数据HTTPLiveSource::dequeueAccessUnit()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4、解码后音视频播放过程"><span class="toc-text">2.4、解码后音视频播放过程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（三）、基于NuPlayer的RTSP流媒体协议"><span class="toc-text">（三）、基于NuPlayer的RTSP流媒体协议</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1、RTSP-概述："><span class="toc-text">3.1.1、RTSP 概述：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2、RTSP-模型："><span class="toc-text">3.1.2、RTSP 模型：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-3、RTSP-协议消息格式："><span class="toc-text">3.1.3、RTSP 协议消息格式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4、简单的RTSP-交互过程"><span class="toc-text">3.1.4、简单的RTSP 交互过程:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-5、RTSP的主要命令表："><span class="toc-text">3.1.5、RTSP的主要命令表：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-6、SDP的格式："><span class="toc-text">3.1.6、SDP的格式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-7、RTP协议："><span class="toc-text">3.1.7、RTP协议：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-8、RTP协议报头格式"><span class="toc-text">3.1.8、RTP协议报头格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-9、RTCP协议报头格式"><span class="toc-text">3.1.9、RTCP协议报头格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2、基于NuPLayer的RTSP-代码流程"><span class="toc-text">3.2、基于NuPLayer的RTSP 代码流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3、RTSPSource-prepareAsync-流程"><span class="toc-text">3.3、RTSPSource::prepareAsync()流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4、获取数据进行编码（请参考前面HLS小节分析）"><span class="toc-text">3.4、获取数据进行编码（请参考前面HLS小节分析）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5、播放流程（请参考前面HLS小节分析）"><span class="toc-text">3.5、播放流程（请参考前面HLS小节分析）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（四）、参考资料-特别感谢各位前辈的分析和图示-："><span class="toc-text">（四）、参考资料(特别感谢各位前辈的分析和图示)：</span></a></li></ol></div><hr><p>注：文章都是通过阅读各位前辈总结的资料 Android 7.1.2 &amp;&amp; Linux（kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网（◕‿◕），如有侵权，请联系删除，禁止转载（©Qualcomm Technologies, Inc. 版权所有），谢谢。</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/video.system" target="_blank" rel="noopener">【博客原图链接】</a><br><a href="https://tbfungeek.github.io/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">【特别感谢 - Android 源码分析之基于NuPlayer的HLS流媒体协议】</a><br><a href="https://tbfungeek.github.io/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">【特别感谢 - Android 源码分析之基于NuPlayer的RTSP流媒体协议】</a></p><p>Google Pixel、Pixel XL 内核代码（文章基于 Kernel-3.18）：<br><a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP 源码（文章基于 Android 7.1.2）：<br><a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener">Android 系统全套源代码分享 (更新到 8.1.0_r1)</a></p><hr><blockquote><p>注：本文基本转载于上述两篇博客！！！</p></blockquote><h4 id="（一）、基于NuPlayer的HLS流媒体协议"><a href="#（一）、基于NuPlayer的HLS流媒体协议" class="headerlink" title="（一）、基于NuPlayer的HLS流媒体协议"></a>（一）、基于NuPlayer的HLS流媒体协议</h4><h5 id="1-1、HLS-概述"><a href="#1-1、HLS-概述" class="headerlink" title="1.1、HLS 概述"></a>1.1、HLS 概述</h5><p>HTTP Live Streaming（HLS）是苹果公司实现的基于HTTP的流媒体直播和点播协议，主要应用在iOS系统。相对于普通的流媒体，例如RTMP协议、RTSP协议、MMS协议等，HLS最大的优点是可以根据网络状况自动切换到不同码率的视频，如果网络状况较好，则会切换到高码率的视频，若发现网络状况不佳，则会逐渐过渡到低码率的视频，这个我们下面将会结合代码对其进行说明。</p><h5 id="1-2、HLS框架介绍"><a href="#1-2、HLS框架介绍" class="headerlink" title="1.2、HLS框架介绍"></a>1.2、HLS框架介绍</h5><p>我们接下来看下HLS系统的整体结构图：</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-01-HLS-playback-architecture.png" alt="Alt text | center"></p><p>我们首先将要直播的视频送到编码器中，编码器分别对视频和音频进行编码，然后输出到一个MPEG-2格式的传输流中，再由分段器将MPEG-2传输流进行分段，产生一系列等间隔的媒体片段，这些媒体片段一般很小并且保存成后缀为.ts的文件，同时生成一个指向这些媒体文件的索引文件，也就是我们很经常听到的.M3U8文件。完成分段之后将这些索引文件以及媒体文件上传到Web服务器上。客户端读取索引文件，然后按顺序请求下载索引文件中列出的媒体文件。下载后是一个ts文件。需要进行解压获得对应的媒体数据并解码后进行播放。由于在直播过程中服务器端会不断地将最新的直播数据生成新的小文件，并上传所以只要客户端不断地按顺序下载并播放从服务器获取到的文件，从整个过程上看就相当于实现了直播。而且由于分段文件的很短，客户端可以根据实际的带宽情况切换到不同码率的直播源，从而实现多码率的适配的目的。</p><p>M3U8 知识请参考：<a href="https://blog.csdn.net/Guofengpu/article/details/54922865" target="_blank" rel="noopener">HLS之m3u8、ts流格式详解</a></p><h5 id="1-3、HLS播放流程"><a href="#1-3、HLS播放流程" class="headerlink" title="1.3、HLS播放流程"></a>1.3、HLS播放流程</h5><p>1、获取不同带宽下对应的网络资源URI及音视频编解码，视频分辨率等信息的文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=899152,RESOLUTION=480x270,CODECS="avc1.4d4015,mp4a.40.5"</span><br><span class="line">http:<span class="comment">//hls.ftdp.com/video1_widld/m3u8/01.m3u8</span></span><br></pre></td></tr></table></figure><p>2、根据上述获取的信息初始化对应的编解码器</p><p>3、获取第一个网络资源对应的分段索引列表（index文件）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:6532</span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI="18319965201.key"</span><br><span class="line">#EXTINF:10,</span><br><span class="line"><span class="number">20125484</span>T125708<span class="number">-01</span><span class="number">-6533.</span>ts</span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI="14319965205.key"</span><br><span class="line">#EXTINF:10,</span><br><span class="line"><span class="number">20125484</span>T125708<span class="number">-01</span><span class="number">-6534.</span>ts</span><br><span class="line">....</span><br><span class="line">#EXTINF:8,</span><br><span class="line"></span><br><span class="line"><span class="number">20140804</span>T125708<span class="number">-01</span><span class="number">-6593.</span>ts</span><br></pre></td></tr></table></figure><p>4、获取某一个分片的Key</p><p>5、请求下载某一个分片<br>6、根据当前的带宽决定是否切换视频资源<br>7、将下载的分片资源解密后送到解码器进行解码</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-02-HLS-playback-flow.png" alt="Alt text | center"></p><p>关于NuPlayerDrvier的创建以及SetDataSource的流程和Stagefight Player大体一致，区别在于setDataSource的时候是根据url的不同会创建三种不同的DataSource：HttpLiveSource，RTSPSource，以及GenericSource。这里就不做大篇幅的介绍了，就直接上图吧</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-03-HLS-nuplayer-setdatasource-java.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-04-HLS-nuplayer-setdatasource-native.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-05-HLS-nuplayer-setdatasource-native-2.png" alt="Alt text | center"></p><h4 id="（二）、基于NuPlayer的HLS流媒体播放源码分析"><a href="#（二）、基于NuPlayer的HLS流媒体播放源码分析" class="headerlink" title="（二）、基于NuPlayer的HLS流媒体播放源码分析"></a>（二）、基于NuPlayer的HLS流媒体播放源码分析</h4><p>首先看看总体时序图：</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-06-HttpLiveStream-flow.png" alt="Alt text | center"></p><h5 id="2-1、HTTPLiveSource-prepareAsync"><a href="#2-1、HTTPLiveSource-prepareAsync" class="headerlink" title="2.1、HTTPLiveSource::prepareAsync()"></a>2.1、HTTPLiveSource::prepareAsync()</h5><p>我们直接从prepare结合HLS原理开始分析，直接看HttpliveSource的prepareAsync。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\HTTPLiveSource.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::HTTPLiveSource::prepareAsync() &#123;</span><br><span class="line">    <span class="comment">//创建并启动一个Looper</span></span><br><span class="line">    <span class="keyword">if</span> (mLiveLooper == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mLiveLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">        mLiveLooper-&gt;setName(<span class="string">"http live"</span>);</span><br><span class="line">        mLiveLooper-&gt;start();</span><br><span class="line">        mLiveLooper-&gt;registerHandler(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建一个kWhatSessionNotify赋值给LiveSession用于通知</span></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSessionNotify, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//创建一个LiveSession</span></span><br><span class="line">    mLiveSession = <span class="keyword">new</span> LiveSession(</span><br><span class="line">            notify,</span><br><span class="line">            (mFlags &amp; kFlagIncognito) ? LiveSession::kFlagIncognito : <span class="number">0</span>,</span><br><span class="line">            mHTTPService);</span><br><span class="line">    mLiveLooper-&gt;registerHandler(mLiveSession);</span><br><span class="line">    <span class="comment">//使用LiveSession进行异步连接</span></span><br><span class="line">    mLiveSession-&gt;connectAsync(mURL.c_str(), mExtraHeaders.isEmpty() ? <span class="literal">NULL</span> : &amp;mExtraHeaders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">void</span> LiveSession::connectAsync(<span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">const</span> KeyedVector&lt;String8, String8&gt; *headers) &#123;</span><br><span class="line">    <span class="comment">//创建一个kWhatConnect并传入url</span></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatConnect, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setString(<span class="string">"url"</span>, url);</span><br><span class="line">    <span class="keyword">if</span> (headers != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        msg-&gt;setPointer(<span class="string">"headers"</span>,<span class="keyword">new</span> KeyedVector&lt;String8, String8&gt;(*headers));</span><br><span class="line">    &#125;</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LiveSession::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">	<span class="keyword">case</span> kWhatConnect:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//调用onConnect</span></span><br><span class="line">        onConnect(msg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LiveSession::onConnect(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="comment">//获取传过来的Uri</span></span><br><span class="line">    CHECK(msg-&gt;findString(<span class="string">"url"</span>, &amp;mMasterURL));</span><br><span class="line">    KeyedVector&lt;String8, String8&gt; *headers = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!msg-&gt;findPointer(<span class="string">"headers"</span>, (<span class="keyword">void</span> **)&amp;headers)) &#123;</span><br><span class="line">        mExtraHeaders.clear();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mExtraHeaders = *headers;</span><br><span class="line">        <span class="keyword">delete</span> headers;</span><br><span class="line">        headers = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建一个mFetcherLooper</span></span><br><span class="line">    <span class="keyword">if</span> (mFetcherLooper == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mFetcherLooper = <span class="keyword">new</span> ALooper();</span><br><span class="line">        mFetcherLooper-&gt;setName(<span class="string">"Fetcher"</span>);</span><br><span class="line">        mFetcherLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取不同带宽下对应的网络资源URI及音视频编解码信息</span></span><br><span class="line">    addFetcher(mMasterURL.c_str())-&gt;fetchPlaylistAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就开始获取不同带宽下对应的网络资源URI及音视频编解码信息了</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line">sp&lt;PlaylistFetcher&gt; LiveSession::addFetcher(<span class="keyword">const</span> <span class="keyword">char</span> *uri) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> index = mFetcherInfos.indexOfKey(uri);</span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatFetcherNotify, <span class="keyword">this</span>);</span><br><span class="line">    notify-&gt;setString(<span class="string">"uri"</span>, uri);</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"switchGeneration"</span>, mSwitchGeneration);</span><br><span class="line">    FetcherInfo info;</span><br><span class="line">    <span class="comment">//创建一个PlaylistFetcher并返回</span></span><br><span class="line">    info.mFetcher = <span class="keyword">new</span> PlaylistFetcher(notify, <span class="keyword">this</span>, uri, mCurBandwidthIndex, mSubtitleGeneration);</span><br><span class="line">    info.mDurationUs = <span class="number">-1l</span>l;</span><br><span class="line">    info.mToBeRemoved = <span class="literal">false</span>;</span><br><span class="line">    info.mToBeResumed = <span class="literal">false</span>;</span><br><span class="line">    mFetcherLooper-&gt;registerHandler(info.mFetcher);</span><br><span class="line">    mFetcherInfos.add(uri, info);</span><br><span class="line">    <span class="comment">//这里的info.mFetcher是上面new 出来的PlaylistFetcher</span></span><br><span class="line">    <span class="keyword">return</span> info.mFetcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们通过这里返回的PlaylistFetcher调用fetchPlaylistAsync来获取playlists<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\PlaylistFetcher.cpp]</span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::fetchPlaylistAsync() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatFetchPlaylist, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">case</span> kWhatFetchPlaylist:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">bool</span> unchanged;</span><br><span class="line">        <span class="comment">//获取一个M3U8Parser</span></span><br><span class="line">        sp&lt;M3UParser&gt; playlist = mHTTPDownloader-&gt;fetchPlaylist(mURI.c_str(), <span class="literal">NULL</span> <span class="comment">/* curPlaylistHash */</span>, &amp;unchanged);</span><br><span class="line">        sp&lt;AMessage&gt; notify = mNotify-&gt;dup();</span><br><span class="line">        notify-&gt;setInt32(<span class="string">"what"</span>, kWhatPlaylistFetched);</span><br><span class="line">        <span class="comment">//将playlist返回</span></span><br><span class="line">        notify-&gt;setObject(<span class="string">"playlist"</span>, playlist);</span><br><span class="line">        notify-&gt;post();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>我们接下来看下fetchFile过程：首先会通过fetchFile从服务器端获取到m3u8 playlist内容存放到buffer缓存区，然后将获取到的缓存数据包装成M3UParser</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\HTTPDownloader.cpp]</span><br><span class="line">sp&lt;M3UParser&gt; HTTPDownloader::fetchPlaylist(</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">uint8_t</span> *curPlaylistHash, <span class="keyword">bool</span> *unchanged) &#123;</span><br><span class="line"></span><br><span class="line">    *unchanged = <span class="literal">false</span>;</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    String8 actualUrl;</span><br><span class="line">    <span class="comment">//调用fetchFile</span></span><br><span class="line">    <span class="keyword">ssize_t</span> err = fetchFile(url, &amp;buffer, &amp;actualUrl);</span><br><span class="line">	<span class="comment">//断开连接</span></span><br><span class="line">    mHTTPDataSource-&gt;disconnect();</span><br><span class="line"> 	<span class="comment">//将获取到的缓存数据包装成M3UParser</span></span><br><span class="line">    sp&lt;M3UParser&gt; playlist = <span class="keyword">new</span> M3UParser(actualUrl.<span class="built_in">string</span>(), buffer-&gt;data(), buffer-&gt;size());</span><br><span class="line">    <span class="keyword">return</span> playlist;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> HTTPDownloader::fetchFile(</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *url, sp&lt;ABuffer&gt; *out, String8 *actualUrl) &#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> err = fetchBlock(url, out, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span>, actualUrl, <span class="literal">true</span> <span class="comment">/* reconnect */</span>);</span><br><span class="line">    <span class="comment">// close off the connection after use</span></span><br><span class="line">    mHTTPDataSource-&gt;disconnect();</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们这里看下M3UParser构造方法：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\M3UParser.cpp]</span><br><span class="line">M3UParser::M3UParser(</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *baseURI, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> size)</span><br><span class="line">    : mInitCheck(NO_INIT),</span><br><span class="line">      mBaseURI(baseURI),</span><br><span class="line">      mIsExtM3U(<span class="literal">false</span>),</span><br><span class="line">      mIsVariantPlaylist(<span class="literal">false</span>),</span><br><span class="line">      mIsComplete(<span class="literal">false</span>),</span><br><span class="line">      mIsEvent(<span class="literal">false</span>),</span><br><span class="line">      mFirstSeqNumber(<span class="number">-1</span>),</span><br><span class="line">      mLastSeqNumber(<span class="number">-1</span>),</span><br><span class="line">      mTargetDurationUs(<span class="number">-1l</span>l),</span><br><span class="line">      mDiscontinuitySeq(<span class="number">0</span>),</span><br><span class="line">      mDiscontinuityCount(<span class="number">0</span>),</span><br><span class="line">      mSelectedIndex(<span class="number">-1</span>) &#123;</span><br><span class="line">    mInitCheck = parse(data, size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在最后的时候会调用parse对缓存数据进行解析：<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\M3UParser.cpp]</span><br><span class="line"><span class="keyword">status_t</span> M3UParser::parse(<span class="keyword">const</span> <span class="keyword">void</span> *_data, <span class="keyword">size_t</span> size) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> lineNo = <span class="number">0</span>;</span><br><span class="line">    sp&lt;AMessage&gt; itemMeta;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *data = (<span class="keyword">const</span> <span class="keyword">char</span> *)_data;</span><br><span class="line">    <span class="keyword">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> segmentRangeOffset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (offset &lt; size) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> offsetLF = offset;</span><br><span class="line">        <span class="keyword">while</span> (offsetLF &lt; size &amp;&amp; data[offsetLF] != <span class="string">'\n'</span>) &#123;</span><br><span class="line">            ++offsetLF;</span><br><span class="line">        &#125;</span><br><span class="line">        AString line;</span><br><span class="line">        <span class="keyword">if</span> (offsetLF &gt; offset &amp;&amp; data[offsetLF - <span class="number">1</span>] == <span class="string">'\r'</span>) &#123;</span><br><span class="line">            line.setTo(&amp;data[offset], offsetLF - offset - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            line.setTo(&amp;data[offset], offsetLF - offset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (line.empty()) &#123;</span><br><span class="line">            offset = offsetLF + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (lineNo == <span class="number">0</span> &amp;&amp; line == <span class="string">"#EXTM3U"</span>) &#123;</span><br><span class="line">            mIsExtM3U = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mIsExtM3U) &#123;</span><br><span class="line">            <span class="keyword">status_t</span> err = OK;</span><br><span class="line">            <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-TARGETDURATION"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaData(line, &amp;mMeta, <span class="string">"target-duration"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-MEDIA-SEQUENCE"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaData(line, &amp;mMeta, <span class="string">"media-sequence"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-KEY"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseCipherInfo(line, &amp;itemMeta, mBaseURI);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-ENDLIST"</span>)) &#123;</span><br><span class="line">                mIsComplete = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-PLAYLIST-TYPE:EVENT"</span>)) &#123;</span><br><span class="line">                mIsEvent = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXTINF"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaDataDuration(line, &amp;itemMeta, <span class="string">"durationUs"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-DISCONTINUITY"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (itemMeta == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    itemMeta = <span class="keyword">new</span> AMessage;</span><br><span class="line">                &#125;</span><br><span class="line">                itemMeta-&gt;setInt32(<span class="string">"discontinuity"</span>, <span class="literal">true</span>);</span><br><span class="line">                ++mDiscontinuityCount;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-STREAM-INF"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mMeta != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                mIsVariantPlaylist = <span class="literal">true</span>;</span><br><span class="line">                err = parseStreamInf(line, &amp;itemMeta);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-BYTERANGE"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">uint64_t</span> length, offset;</span><br><span class="line">                err = parseByteRange(line, segmentRangeOffset, &amp;length, &amp;offset);</span><br><span class="line">                <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (itemMeta == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        itemMeta = <span class="keyword">new</span> AMessage;</span><br><span class="line">                    &#125;</span><br><span class="line">                    itemMeta-&gt;setInt64(<span class="string">"range-offset"</span>, offset);</span><br><span class="line">                    itemMeta-&gt;setInt64(<span class="string">"range-length"</span>, length);</span><br><span class="line">                    segmentRangeOffset = offset + length;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-MEDIA"</span>)) &#123;</span><br><span class="line">                err = parseMedia(line);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.startsWith(<span class="string">"#EXT-X-DISCONTINUITY-SEQUENCE"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">size_t</span> seq;</span><br><span class="line">                err = parseDiscontinuitySequence(line, &amp;seq);</span><br><span class="line">                <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                    mDiscontinuitySeq = seq;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!line.startsWith(<span class="string">"#"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mIsVariantPlaylist) &#123;</span><br><span class="line">                <span class="keyword">int64_t</span> durationUs;</span><br><span class="line">                <span class="keyword">if</span> (itemMeta == <span class="literal">NULL</span></span><br><span class="line">                        || !itemMeta-&gt;findInt64(<span class="string">"durationUs"</span>, &amp;durationUs)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                itemMeta-&gt;setInt32(<span class="string">"discontinuity-sequence"</span>,</span><br><span class="line">                        mDiscontinuitySeq + mDiscontinuityCount);</span><br><span class="line">            &#125;</span><br><span class="line">            mItems.push();</span><br><span class="line">            Item *item = &amp;mItems.editItemAt(mItems.size() - <span class="number">1</span>);</span><br><span class="line">            CHECK(MakeURL(mBaseURI.c_str(), line.c_str(), &amp;item-&gt;mURI));</span><br><span class="line">            item-&gt;mMeta = itemMeta;</span><br><span class="line">            itemMeta.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        offset = offsetLF + <span class="number">1</span>;</span><br><span class="line">        ++lineNo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mIsVariantPlaylist) &#123;</span><br><span class="line">        <span class="keyword">int32_t</span> targetDurationSecs;</span><br><span class="line">        <span class="keyword">if</span> (mMeta == <span class="literal">NULL</span> || !mMeta-&gt;findInt32(</span><br><span class="line">                <span class="string">"target-duration"</span>, &amp;targetDurationSecs)) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Media playlist missing #EXT-X-TARGETDURATION"</span>);</span><br><span class="line">            <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">        &#125;</span><br><span class="line">        mTargetDurationUs = targetDurationSecs * <span class="number">1000000l</span>l;</span><br><span class="line">        mFirstSeqNumber = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mMeta != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mMeta-&gt;findInt32(<span class="string">"media-sequence"</span>, &amp;mFirstSeqNumber);</span><br><span class="line">        &#125;</span><br><span class="line">        mLastSeqNumber = mFirstSeqNumber + mItems.size() - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>好了我们现在已经获取到了类型为M3UParser的播放列表文件了，这时候会发送一个kWhatPlaylistFetched，这个在哪里被处理呢？当然是LiveSession啊。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">case</span> PlaylistFetcher::kWhatPlaylistFetched:</span><br><span class="line">&#123;</span><br><span class="line">    onMasterPlaylistFetched(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取到播放列表后要干啥呢？我们接下来看：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">void</span> LiveSession::onMasterPlaylistFetched(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line"></span><br><span class="line">    AString uri;</span><br><span class="line">    CHECK(msg-&gt;findString(<span class="string">"uri"</span>, &amp;uri));</span><br><span class="line">    <span class="keyword">ssize_t</span> index = mFetcherInfos.indexOfKey(uri);</span><br><span class="line">    <span class="comment">// no longer useful, remove</span></span><br><span class="line">    mFetcherLooper-&gt;unregisterHandler(mFetcherInfos[index].mFetcher-&gt;id());</span><br><span class="line">    mFetcherInfos.removeItemsAt(index);</span><br><span class="line">    <span class="comment">//取走获取到的playlist</span></span><br><span class="line">    CHECK(msg-&gt;findObject(<span class="string">"playlist"</span>, (sp&lt;RefBase&gt; *)&amp;mPlaylist));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We trust the content provider to make a reasonable choice of preferred</span></span><br><span class="line">    <span class="comment">// initial bandwidth by listing it first in the variant playlist.</span></span><br><span class="line">    <span class="comment">// At startup we really don't have a good estimate on the available</span></span><br><span class="line">    <span class="comment">// network bandwidth since we haven't tranferred any data yet. Once</span></span><br><span class="line">    <span class="comment">// we have we can make a better informed choice.</span></span><br><span class="line">    <span class="keyword">size_t</span> initialBandwidth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> initialBandwidthIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> maxWidth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> maxHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//判断获取到的playlist是否有效，无效就没啥用了，我们这里假设有效</span></span><br><span class="line">    <span class="keyword">if</span> (mPlaylist-&gt;isVariantPlaylist()) &#123;</span><br><span class="line">        Vector&lt;BandwidthItem&gt; itemsWithVideo;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mPlaylist-&gt;size(); ++i) &#123;</span><br><span class="line">            BandwidthItem item;</span><br><span class="line">            item.mPlaylistIndex = i;</span><br><span class="line">            item.mLastFailureUs = <span class="number">-1l</span>l;</span><br><span class="line">            sp&lt;AMessage&gt; meta;</span><br><span class="line">            AString uri;</span><br><span class="line">            mPlaylist-&gt;itemAt(i, &amp;uri, &amp;meta);</span><br><span class="line">            <span class="comment">//获取带宽</span></span><br><span class="line">            CHECK(meta-&gt;findInt32(<span class="string">"bandwidth"</span>, (<span class="keyword">int32_t</span> *)&amp;item.mBandwidth));</span><br><span class="line">            <span class="comment">//获取最大分辨率</span></span><br><span class="line">            <span class="keyword">int32_t</span> width, height;</span><br><span class="line">            <span class="keyword">if</span> (meta-&gt;findInt32(<span class="string">"width"</span>, &amp;width)) &#123;</span><br><span class="line">                maxWidth = max(maxWidth, width);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (meta-&gt;findInt32(<span class="string">"height"</span>, &amp;height)) &#123;</span><br><span class="line">                maxHeight = max(maxHeight, height);</span><br><span class="line">            &#125;</span><br><span class="line">            mBandwidthItems.push(item);</span><br><span class="line">            <span class="keyword">if</span> (mPlaylist-&gt;hasType(i, <span class="string">"video"</span>)) &#123;</span><br><span class="line">                itemsWithVideo.push(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//移除只有声音的信息</span></span><br><span class="line">        <span class="keyword">if</span> (!itemsWithVideo.empty()&amp;&amp; itemsWithVideo.size() &lt; mBandwidthItems.size()) &#123;</span><br><span class="line">            mBandwidthItems.clear();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; itemsWithVideo.size(); ++i) &#123;</span><br><span class="line">                mBandwidthItems.push(itemsWithVideo[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        CHECK_GT(mBandwidthItems.size(), <span class="number">0u</span>);</span><br><span class="line">        initialBandwidth = mBandwidthItems[<span class="number">0</span>].mBandwidth;</span><br><span class="line">        <span class="comment">//按照带宽进行排序</span></span><br><span class="line">        mBandwidthItems.sort(SortByBandwidth);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mBandwidthItems.size(); ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mBandwidthItems.itemAt(i).mBandwidth == initialBandwidth) &#123;</span><br><span class="line">                initialBandwidthIndex = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">//......</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//获取到最大的分辨率</span></span><br><span class="line">    mMaxWidth = maxWidth &gt; <span class="number">0</span> ? maxWidth : mMaxWidth;</span><br><span class="line">    mMaxHeight = maxHeight &gt; <span class="number">0</span> ? maxHeight : mMaxHeight;</span><br><span class="line">    mPlaylist-&gt;pickRandomMediaItems();</span><br><span class="line">    changeConfiguration(<span class="number">0l</span>l <span class="comment">/* timeUs */</span>, initialBandwidthIndex, <span class="literal">false</span> <span class="comment">/* pickTrack */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">void</span> LiveSession::changeConfiguration(<span class="keyword">int64_t</span> timeUs, <span class="keyword">ssize_t</span> bandwidthIndex, <span class="keyword">bool</span> pickTrack) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取消带宽切换</span></span><br><span class="line">    cancelBandwidthSwitch();</span><br><span class="line">    mReconfigurationInProgress = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//由mOrigBandwidthIndex切换到mCurBandwidthIndex</span></span><br><span class="line">    <span class="keyword">if</span> (bandwidthIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//将当前的带宽设置为当前带宽</span></span><br><span class="line">        mOrigBandwidthIndex = mCurBandwidthIndex;</span><br><span class="line">        mCurBandwidthIndex = bandwidthIndex;</span><br><span class="line">        <span class="keyword">if</span> (mOrigBandwidthIndex != mCurBandwidthIndex) &#123;</span><br><span class="line">            <span class="comment">//开始切换带宽</span></span><br><span class="line">            ALOGI(<span class="string">"#### Starting Bandwidth Switch: %zd =&gt; %zd"</span>,mOrigBandwidthIndex, mCurBandwidthIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    CHECK_LT(mCurBandwidthIndex, mBandwidthItems.size());</span><br><span class="line">    <span class="comment">//获取当前的BandwidthItem</span></span><br><span class="line">    <span class="keyword">const</span> BandwidthItem &amp;item = mBandwidthItems.itemAt(mCurBandwidthIndex);</span><br><span class="line">    <span class="keyword">uint32_t</span> streamMask = <span class="number">0</span>; <span class="comment">// streams that should be fetched by the new fetcher</span></span><br><span class="line">    <span class="keyword">uint32_t</span> resumeMask = <span class="number">0</span>; <span class="comment">// streams that should be fetched by the original fetcher</span></span><br><span class="line">    AString URIs[kMaxStreams];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPlaylist-&gt;getTypeURI(item.mPlaylistIndex, mStreams[i].mType, &amp;URIs[i])) &#123;</span><br><span class="line">            streamMask |= indexToType(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止我们不需要的，暂停我们将要复用的，第一次的时候这里是没有的所以跳过</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mFetcherInfos.size(); ++i) &#123;</span><br><span class="line">        <span class="comment">//.........................</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg;</span><br><span class="line">    <span class="keyword">if</span> (timeUs &lt; <span class="number">0l</span>l) &#123;</span><br><span class="line">        <span class="comment">// skip onChangeConfiguration2 (decoder destruction) if not seeking.</span></span><br><span class="line">        msg = <span class="keyword">new</span> AMessage(kWhatChangeConfiguration3, <span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg = <span class="keyword">new</span> AMessage(kWhatChangeConfiguration2, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"streamMask"</span>, streamMask);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"resumeMask"</span>, resumeMask);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"pickTrack"</span>, pickTrack);</span><br><span class="line">    msg-&gt;setInt64(<span class="string">"timeUs"</span>, timeUs);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((streamMask | resumeMask) &amp; indexToType(i)) &#123;</span><br><span class="line">            msg-&gt;setString(mStreams[i].uriKey().c_str(), URIs[i].c_str());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Every time a fetcher acknowledges the stopAsync or pauseAsync request</span></span><br><span class="line">    <span class="comment">// we'll decrement mContinuationCounter, once it reaches zero, i.e. all</span></span><br><span class="line">    <span class="comment">// fetchers have completed their asynchronous operation, we'll post</span></span><br><span class="line">    <span class="comment">// mContinuation, which then is handled below in onChangeConfiguration2.</span></span><br><span class="line">  	<span class="comment">//每次fetcher 调用了stopAsync和pauseAsync mContinuationCounter 数值都会减去1,一旦减到0 那么将会在onChangeConfiguration2处理</span></span><br><span class="line">    mContinuationCounter = mFetcherInfos.size();</span><br><span class="line">    mContinuation = msg;</span><br><span class="line">    <span class="keyword">if</span> (mContinuationCounter == <span class="number">0</span>) &#123;</span><br><span class="line">        msg-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LiveSession::onChangeConfiguration2(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">    CHECK(msg-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timeUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        mLastSeekTimeUs = timeUs;</span><br><span class="line">        mLastDequeuedTimeUs = timeUs;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mPacketSources.size(); i++) &#123;</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; packetSource = mPacketSources.editValueAt(i);</span><br><span class="line">            sp&lt;MetaData&gt; format = packetSource-&gt;getFormat();</span><br><span class="line">            packetSource-&gt;clear();</span><br><span class="line">            packetSource-&gt;setFormat(format);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">            mStreams[i].reset();</span><br><span class="line">        &#125;</span><br><span class="line">        mDiscontinuityOffsetTimesUs.clear();</span><br><span class="line">        mDiscontinuityAbsStartTimesUs.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSeekReplyID != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            CHECK(mSeekReply != <span class="literal">NULL</span>);</span><br><span class="line">            mSeekReply-&gt;setInt32(<span class="string">"err"</span>, OK);</span><br><span class="line">            mSeekReply-&gt;postReply(mSeekReplyID);</span><br><span class="line">            mSeekReplyID.clear();</span><br><span class="line">            mSeekReply.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        restartPollBuffering();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> streamMask, resumeMask;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"streamMask"</span>, (<span class="keyword">int32_t</span> *)&amp;streamMask));</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"resumeMask"</span>, (<span class="keyword">int32_t</span> *)&amp;resumeMask));</span><br><span class="line"></span><br><span class="line">    streamMask |= resumeMask;</span><br><span class="line"></span><br><span class="line">    AString URIs[kMaxStreams];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (streamMask &amp; indexToType(i)) &#123;</span><br><span class="line">            <span class="keyword">const</span> AString &amp;uriKey = mStreams[i].uriKey();</span><br><span class="line">            CHECK(msg-&gt;findString(uriKey.c_str(), &amp;URIs[i]));</span><br><span class="line">            ALOGV(<span class="string">"%s = '%s'"</span>, uriKey.c_str(), URIs[i].c_str());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> changedMask = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams &amp;&amp; i != kSubtitleIndex; ++i) &#123;</span><br><span class="line">        <span class="comment">// stream URI could change even if onChangeConfiguration2 is only</span></span><br><span class="line">        <span class="comment">// used for seek. Seek could happen during a bw switch, in this</span></span><br><span class="line">        <span class="comment">// case bw switch will be cancelled, but the seekTo position will</span></span><br><span class="line">        <span class="comment">// fetch from the new URI.</span></span><br><span class="line">        <span class="keyword">if</span> ((mStreamMask &amp; streamMask &amp; indexToType(i))</span><br><span class="line">                &amp;&amp; !mStreams[i].mUri.empty()</span><br><span class="line">                &amp;&amp; !(URIs[i] == mStreams[i].mUri)) &#123;</span><br><span class="line">            ALOGV(<span class="string">"stream %zu changed: oldURI %s, newURI %s"</span>, i,</span><br><span class="line">                    mStreams[i].mUri.c_str(), URIs[i].c_str());</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; source = mPacketSources.valueFor(indexToType(i));</span><br><span class="line">            <span class="keyword">if</span> (source-&gt;getLatestDequeuedMeta() != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                source-&gt;queueDiscontinuity(ATSParser::DISCONTINUITY_FORMATCHANGE, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Determine which decoders to shutdown on the player side,</span></span><br><span class="line">        <span class="comment">// a decoder has to be shutdown if its streamtype was active</span></span><br><span class="line">        <span class="comment">// before but now longer isn't.</span></span><br><span class="line">        <span class="keyword">if</span> ((mStreamMask &amp; ~streamMask &amp; indexToType(i))) &#123;</span><br><span class="line">            changedMask |= indexToType(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//这里会触发kWhatStreamsChanged</span></span><br><span class="line">    sp&lt;AMessage&gt; notify = mNotify-&gt;dup();</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"what"</span>, kWhatStreamsChanged);</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"changedMask"</span>, changedMask);</span><br><span class="line">	<span class="comment">//将kWhatChangeConfiguration3作为回复消息</span></span><br><span class="line">    msg-&gt;setWhat(kWhatChangeConfiguration3);</span><br><span class="line">    msg-&gt;setTarget(<span class="keyword">this</span>);</span><br><span class="line">    notify-&gt;setMessage(<span class="string">"reply"</span>, msg);</span><br><span class="line">    notify-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">void</span> LiveSession::onChangeConfiguration3(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    mContinuation.clear();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint32_t</span> streamMask, resumeMask;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"streamMask"</span>, (<span class="keyword">int32_t</span> *)&amp;streamMask));</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"resumeMask"</span>, (<span class="keyword">int32_t</span> *)&amp;resumeMask));</span><br><span class="line"></span><br><span class="line">    mNewStreamMask = streamMask | resumeMask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">    <span class="keyword">int32_t</span> pickTrack;</span><br><span class="line">    <span class="keyword">bool</span> switching = <span class="literal">false</span>;</span><br><span class="line">    CHECK(msg-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs));</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"pickTrack"</span>, &amp;pickTrack));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxStreams; i++) &#123;</span><br><span class="line">        ......</span><br><span class="line">        fetcher-&gt;startAsync(</span><br><span class="line">                sources[kAudioIndex],</span><br><span class="line">                sources[kVideoIndex],</span><br><span class="line">                sources[kSubtitleIndex],</span><br><span class="line">                getMetadataSource(sources, mNewStreamMask, switching),</span><br><span class="line">                startTime.mTimeUs &lt; <span class="number">0</span> ? mLastSeekTimeUs : startTime.mTimeUs,</span><br><span class="line">                startTime.getSegmentTimeUs(),</span><br><span class="line">                startTime.mSeq,</span><br><span class="line">                seekMode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">```cpp</span><br><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\PlaylistFetcher.cpp]</span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::startAsync(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; &amp;audioSource,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; &amp;videoSource,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; &amp;subtitleSource,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; &amp;metadataSource,</span><br><span class="line">        <span class="keyword">int64_t</span> startTimeUs,</span><br><span class="line">        <span class="keyword">int64_t</span> segmentStartTimeUs,</span><br><span class="line">        <span class="keyword">int32_t</span> startDiscontinuitySeq,</span><br><span class="line">        LiveSession::SeekMode seekMode) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatStart, <span class="keyword">this</span>);</span><br><span class="line">    ......</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"streamTypeMask"</span>, streamTypeMask);</span><br><span class="line">    msg-&gt;setInt64(<span class="string">"startTimeUs"</span>, startTimeUs);</span><br><span class="line">    msg-&gt;setInt64(<span class="string">"segmentStartTimeUs"</span>, segmentStartTimeUs);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"startDiscontinuitySeq"</span>, startDiscontinuitySeq);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"seekMode"</span>, seekMode);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">status_t</span> PlaylistFetcher::onStart(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    postMonitorQueue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::postMonitorQueue(<span class="keyword">int64_t</span> delayUs, <span class="keyword">int64_t</span> minDelayUs) &#123;</span><br><span class="line">    <span class="keyword">int64_t</span> maxDelayUs = delayUsToRefreshPlaylist();</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatMonitorQueue, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"generation"</span>, mMonitorQueueGeneration);</span><br><span class="line">    msg-&gt;post(delayUs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> kWhatDownloadNext:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int32_t</span> generation;</span><br><span class="line">            CHECK(msg-&gt;findInt32(<span class="string">"generation"</span>, &amp;generation));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (generation != mMonitorQueueGeneration) &#123;</span><br><span class="line">                <span class="comment">// Stale event</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (msg-&gt;what() == kWhatMonitorQueue) &#123;</span><br><span class="line">                onMonitorQueue();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                onDownloadNext();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> PlaylistFetcher::onDownloadNext() &#123;</span><br><span class="line">    AString uri;</span><br><span class="line">    sp&lt;AMessage&gt; itemMeta;</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    sp&lt;ABuffer&gt; tsBuffer;</span><br><span class="line">    <span class="keyword">int32_t</span> firstSeqNumberInPlaylist = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> lastSeqNumberInPlaylist = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> connectHTTP = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// block-wise download</span></span><br><span class="line">    <span class="keyword">bool</span> shouldPause = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> bytesRead;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> startUs = ALooper::GetNowUs();</span><br><span class="line">        bytesRead = mHTTPDownloader-&gt;fetchBlock(</span><br><span class="line">                uri.c_str(), &amp;buffer, range_offset, range_length, kDownloadBlockSize,</span><br><span class="line">                <span class="literal">NULL</span> <span class="comment">/* actualURL */</span>, connectHTTP);</span><br><span class="line">        <span class="keyword">int64_t</span> delayUs = ALooper::GetNowUs() - startUs;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (bufferStartsWithTsSyncByte(buffer)) &#123;</span><br><span class="line">            <span class="comment">// Incremental extraction is only supported for MPEG2 transport streams.</span></span><br><span class="line">            <span class="keyword">if</span> (tsBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                tsBuffer = <span class="keyword">new</span> ABuffer(buffer-&gt;data(), buffer-&gt;capacity());</span><br><span class="line">                tsBuffer-&gt;setRange(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tsBuffer-&gt;capacity() != buffer-&gt;capacity()) &#123;</span><br><span class="line">                <span class="keyword">size_t</span> tsOff = tsBuffer-&gt;offset(), tsSize = tsBuffer-&gt;size();</span><br><span class="line">                tsBuffer = <span class="keyword">new</span> ABuffer(buffer-&gt;data(), buffer-&gt;capacity());</span><br><span class="line">                tsBuffer-&gt;setRange(tsOff, tsSize);</span><br><span class="line">            &#125;</span><br><span class="line">            tsBuffer-&gt;setRange(tsBuffer-&gt;offset(), tsBuffer-&gt;size() + bytesRead);</span><br><span class="line">            err = extractAndQueueAccessUnitsFromTs(tsBuffer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">while</span> (bytesRead != <span class="number">0</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// bulk extract non-ts files</span></span><br><span class="line">    <span class="keyword">bool</span> startUp = mStartup;</span><br><span class="line">    <span class="keyword">if</span> (tsBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> err = extractAndQueueAccessUnits(buffer, itemMeta);</span><br><span class="line">        <span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">            <span class="comment">// starting sequence number too low/high</span></span><br><span class="line">            postMonitorQueue();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == ERROR_OUT_OF_RANGE) &#123;</span><br><span class="line">            <span class="comment">// reached stopping point</span></span><br><span class="line">            notifyStopReached();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            notifyError(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> PlaylistFetcher::extractAndQueueAccessUnits(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;itemMeta) &#123;</span><br><span class="line">    <span class="keyword">if</span> (bufferStartsWithWebVTTMagicSequence(buffer)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStreamTypeMask != LiveSession::STREAMTYPE_SUBTITLES) &#123;</span><br><span class="line">            ALOGE(<span class="string">"This stream only contains subtitles."</span>);</span><br><span class="line">            <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> sp&lt;AnotherPacketSource&gt; packetSource =</span><br><span class="line">            mPacketSources.valueFor(LiveSession::STREAMTYPE_SUBTITLES);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int64_t</span> durationUs;</span><br><span class="line">        CHECK(itemMeta-&gt;findInt64(<span class="string">"durationUs"</span>, &amp;durationUs));</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt64(<span class="string">"timeUs"</span>, getSegmentStartTimeUs(mSeqNumber));</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt64(<span class="string">"durationUs"</span>, durationUs);</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt64(<span class="string">"segmentStartTimeUs"</span>, getSegmentStartTimeUs(mSeqNumber));</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt32(<span class="string">"discontinuitySeq"</span>, mDiscontinuitySeq);</span><br><span class="line">        buffer-&gt;meta()-&gt;setInt32(<span class="string">"subtitleGeneration"</span>, mSubtitleGeneration);</span><br><span class="line">        packetSource-&gt;queueAccessUnit(buffer);</span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (offset &lt; buffer-&gt;size()) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint8_t</span> *adtsHeader = buffer-&gt;data() + offset;</span><br><span class="line">        CHECK_LT(offset + <span class="number">5</span>, buffer-&gt;size());</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        sp&lt;ABuffer&gt; unit = <span class="keyword">new</span> ABuffer(aac_frame_length);</span><br><span class="line">        <span class="built_in">memcpy</span>(unit-&gt;data(), adtsHeader, aac_frame_length);</span><br><span class="line"></span><br><span class="line">        unit-&gt;meta()-&gt;setInt64(<span class="string">"timeUs"</span>, unitTimeUs);</span><br><span class="line">        setAccessUnitProperties(unit, packetSource);</span><br><span class="line">        packetSource-&gt;queueAccessUnit(unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\mpeg2ts\AnotherPacketSource.cpp]</span><br><span class="line"><span class="keyword">void</span> AnotherPacketSource::queueAccessUnit(<span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> damaged;</span><br><span class="line">    ......</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    mBuffers.push_back(buffer);</span><br><span class="line">    mCondition.signal();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> discontinuity;</span><br><span class="line">    <span class="keyword">if</span> (buffer-&gt;meta()-&gt;findInt32(<span class="string">"discontinuity"</span>, &amp;discontinuity))&#123;</span><br><span class="line">        ALOGV(<span class="string">"queueing a discontinuity with queueAccessUnit"</span>);</span><br><span class="line"></span><br><span class="line">        mLastQueuedTimeUs = <span class="number">0l</span>l;</span><br><span class="line">        mEOSResult = OK;</span><br><span class="line">        mLatestEnqueuedMeta = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        mDiscontinuitySegments.push_back(DiscontinuitySegment());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-2、获取数据进行解码"><a href="#2-2、获取数据进行解码" class="headerlink" title="2.2、获取数据进行解码"></a>2.2、获取数据进行解码</h5><p>关于解码初始化NuPlayer::instantiateDecoder过程请参考：<a href="http://zhoujinjian.cc/2018/06/06/Android%20Video%20System%EF%BC%882%EF%BC%89%EF%BC%9A%E9%9F%B3%E8%A7%86%E9%A2%91%E5%88%86%E7%A6%BBMediaExtractor%E3%80%81%E8%A7%A3%E7%A0%81Decoder%E3%80%81%E6%B8%B2%E6%9F%93Renderer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android Video System（2）：音视频分离MediaExtractor、解码Decoder、渲染Renderer源码分析</a><br>我们直接看如何获取数据进行解码:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"><span class="keyword">void</span> ACodec::signalResume() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatResume, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatResume:</span><br><span class="line">&#123;</span><br><span class="line">    resume();</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ACodec::ExecutingState::resume() &#123;</span><br><span class="line"></span><br><span class="line">    submitOutputBuffers();</span><br><span class="line">    <span class="comment">// Post all available input buffers</span></span><br><span class="line">    <span class="keyword">if</span> (mCodec-&gt;mBuffers[kPortIndexInput].size() == <span class="number">0u</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"[%s] we don't have any input buffers to resume"</span>, mCodec-&gt;mComponentName.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mCodec-&gt;mBuffers[kPortIndexInput].size(); i++) &#123;</span><br><span class="line">        BufferInfo *info = &amp;mCodec-&gt;mBuffers[kPortIndexInput].editItemAt(i);</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;mStatus == BufferInfo::OWNED_BY_US) &#123;</span><br><span class="line">            postFillThisBuffer(info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActive = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ACodec::BaseState::postFillThisBuffer(BufferInfo *info) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mCodec-&gt;mPortEOS[kPortIndexInput]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHECK_EQ((<span class="keyword">int</span>)info-&gt;mStatus, (<span class="keyword">int</span>)BufferInfo::OWNED_BY_US);</span><br><span class="line">    sp&lt;AMessage&gt; notify = mCodec-&gt;mNotify-&gt;dup();</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"what"</span>, CodecBase::kWhatFillThisBuffer);</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"buffer-id"</span>, info-&gt;mBufferID);</span><br><span class="line">    info-&gt;mData-&gt;meta()-&gt;clear();</span><br><span class="line">    notify-&gt;setBuffer(<span class="string">"buffer"</span>, info-&gt;mData);</span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatInputBufferFilled, mCodec);</span><br><span class="line">    reply-&gt;setInt32(<span class="string">"buffer-id"</span>, info-&gt;mBufferID);</span><br><span class="line">    notify-&gt;setMessage(<span class="string">"reply"</span>, reply);</span><br><span class="line">    notify-&gt;post();</span><br><span class="line">    info-&gt;mStatus = BufferInfo::OWNED_BY_UPSTREAM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\ACodec.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> CodecBase::kWhatFillThisBuffer:</span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//..........</span></span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; kFlagIsAsync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mHaveInputSurface) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mState == FLUSHED) &#123;</span><br><span class="line">                mHavePendingInputBuffers = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                onInputBufferAvailable();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFlags &amp; kFlagDequeueInputPending) &#123;</span><br><span class="line">        CHECK(handleDequeueInputBuffer(mDequeueInputReplyID));</span><br><span class="line">        ++mDequeueInputTimeoutGeneration;</span><br><span class="line">        mFlags &amp;= ~kFlagDequeueInputPending;</span><br><span class="line">        mDequeueInputReplyID = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        postActivityNotificationIfPossible();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> MediaCodec::onInputBufferAvailable() &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    <span class="keyword">while</span> ((index = dequeuePortBuffer(kPortIndexInput)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = mCallback-&gt;dup();</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"callbackID"</span>, CB_INPUT_AVAILABLE);</span><br><span class="line">        msg-&gt;setInt32(<span class="string">"index"</span>, index);</span><br><span class="line">        msg-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">这个mCallback怎么来的？</span><br><span class="line"></span><br><span class="line">``` cpp</span><br><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::Decoder::onConfigure(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.................</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatCodecNotify, <span class="keyword">this</span>);</span><br><span class="line">    mCodec-&gt;setCallback(reply);</span><br><span class="line">	<span class="comment">//..................</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[-&gt;\frameworks\av\media\libstagefright\MediaCodec.cpp]</span><br><span class="line"><span class="keyword">status_t</span> MediaCodec::setCallback(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;callback) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetCallback, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setMessage(<span class="string">"callback"</span>, callback);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; response;</span><br><span class="line">    <span class="keyword">return</span> PostAndAwaitResponse(msg, &amp;response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatSetCallback:</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">    CHECK(msg-&gt;senderAwaitsResponse(&amp;replyID));</span><br><span class="line">    sp&lt;AMessage&gt; callback;</span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"callback"</span>, &amp;callback));</span><br><span class="line"></span><br><span class="line">    mCallback = callback;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCallback != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mFlags |= kFlagIsAsync;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mFlags &amp;= ~kFlagIsAsync;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; response = <span class="keyword">new</span> AMessage;</span><br><span class="line">    response-&gt;postReply(replyID);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以根据上面我们可以知道接下来i调用的是kWhatCodecNotify 下的 CB_INPUT_AVAILABLE</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">case</span> MediaCodec::CB_INPUT_AVAILABLE:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"index"</span>, &amp;index));</span><br><span class="line"></span><br><span class="line">    handleAnInputBuffer(index);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">bool</span> NuPlayer::Decoder::handleAnInputBuffer(<span class="keyword">size_t</span> index) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDiscontinuityPending()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    mCodec-&gt;getInputBuffer(index, &amp;buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        handleError(UNKNOWN_ERROR);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mInputBuffers.size()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = mInputBuffers.size(); i &lt;= index; ++i) &#123;</span><br><span class="line">            mInputBuffers.add();</span><br><span class="line">            mMediaBuffers.add();</span><br><span class="line">            mInputBufferIsDequeued.add();</span><br><span class="line">            mMediaBuffers.editItemAt(i) = <span class="literal">NULL</span>;</span><br><span class="line">            mInputBufferIsDequeued.editItemAt(i) = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBuffers.editItemAt(index) = buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CHECK_LT(bufferIx, mInputBuffers.size());</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mMediaBuffers[index] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mMediaBuffers[index]-&gt;release();</span><br><span class="line">        mMediaBuffers.editItemAt(index) = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBufferIsDequeued.editItemAt(index) = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mCSDsToSubmit.isEmpty()) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage();</span><br><span class="line">        msg-&gt;setSize(<span class="string">"buffer-ix"</span>, index);</span><br><span class="line"></span><br><span class="line">        sp&lt;ABuffer&gt; buffer = mCSDsToSubmit.itemAt(<span class="number">0</span>);</span><br><span class="line">        ALOGI(<span class="string">"[%s] resubmitting CSD"</span>, mComponentName.c_str());</span><br><span class="line">        msg-&gt;setBuffer(<span class="string">"buffer"</span>, buffer);</span><br><span class="line">        mCSDsToSubmit.removeAt(<span class="number">0</span>);</span><br><span class="line">        CHECK(onInputBufferFetched(msg));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!mPendingInputMessages.empty()) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = *mPendingInputMessages.begin();</span><br><span class="line">        <span class="keyword">if</span> (!onInputBufferFetched(msg)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingInputMessages.erase(mPendingInputMessages.begin());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mInputBufferIsDequeued.editItemAt(index)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDequeuedInputBuffers.push_back(index);</span><br><span class="line"></span><br><span class="line">    onRequestInputBuffers();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoderBase.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::DecoderBase::onRequestInputBuffers() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mRequestInputBuffersPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// doRequestBuffers() return true if we should request more data</span></span><br><span class="line">    <span class="keyword">if</span> (doRequestBuffers()) &#123;</span><br><span class="line">        mRequestInputBuffersPending = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatRequestInputBuffers, <span class="keyword">this</span>);</span><br><span class="line">        msg-&gt;post(<span class="number">10</span> * <span class="number">1000l</span>l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\NuPlayerDecoder.cpp]</span><br><span class="line"><span class="keyword">bool</span> NuPlayer::Decoder::doRequestBuffers() &#123;</span><br><span class="line">    <span class="comment">// mRenderer is only NULL if we have a legacy widevine source that</span></span><br><span class="line">    <span class="comment">// is not yet ready. In this case we must not fetch input.</span></span><br><span class="line">    <span class="keyword">if</span> (isDiscontinuityPending() || mRenderer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">status_t</span> err = OK;</span><br><span class="line">    <span class="keyword">while</span> (err == OK &amp;&amp; !mDequeuedInputBuffers.empty()) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> bufferIx = *mDequeuedInputBuffers.begin();</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage();</span><br><span class="line">        msg-&gt;setSize(<span class="string">"buffer-ix"</span>, bufferIx);</span><br><span class="line">        err = fetchInputData(msg);</span><br><span class="line">        <span class="keyword">if</span> (err != OK &amp;&amp; err != ERROR_END_OF_STREAM) &#123;</span><br><span class="line">            <span class="comment">// if EOS, need to queue EOS buffer</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mDequeuedInputBuffers.erase(mDequeuedInputBuffers.begin());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mPendingInputMessages.empty()</span><br><span class="line">                || !onInputBufferFetched(msg)) &#123;</span><br><span class="line">            mPendingInputMessages.push_back(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err == -EWOULDBLOCK</span><br><span class="line">            &amp;&amp; mSource-&gt;feedMoreTSData() == OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">status_t</span> NuPlayer::Decoder::fetchInputData(sp&lt;AMessage&gt; &amp;reply) &#123;</span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    <span class="keyword">bool</span> dropAccessUnit;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">status_t</span> err = mSource-&gt;dequeueAccessUnit(mIsAudio, &amp;accessUnit);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == -EWOULDBLOCK) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err == INFO_DISCONTINUITY) &#123;</span><br><span class="line">                <span class="keyword">int32_t</span> type;</span><br><span class="line">                CHECK(accessUnit-&gt;meta()-&gt;findInt32(<span class="string">"discontinuity"</span>, &amp;type));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">bool</span> formatChange =</span><br><span class="line">                    (mIsAudio &amp;&amp;</span><br><span class="line">                     (type &amp; ATSParser::DISCONTINUITY_AUDIO_FORMAT))</span><br><span class="line">                    || (!mIsAudio &amp;&amp;</span><br><span class="line">                            (type &amp; ATSParser::DISCONTINUITY_VIDEO_FORMAT));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">bool</span> timeChange = (type &amp; ATSParser::DISCONTINUITY_TIME) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                ALOGI(<span class="string">"%s discontinuity (format=%d, time=%d)"</span>,</span><br><span class="line">                        mIsAudio ? <span class="string">"audio"</span> : <span class="string">"video"</span>, formatChange, timeChange);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">bool</span> seamlessFormatChange = <span class="literal">false</span>;</span><br><span class="line">                sp&lt;AMessage&gt; newFormat = mSource-&gt;getFormat(mIsAudio);</span><br><span class="line">                <span class="keyword">if</span> (formatChange) &#123;</span><br><span class="line">                    seamlessFormatChange =</span><br><span class="line">                        supportsSeamlessFormatChange(newFormat);</span><br><span class="line">                    <span class="comment">// treat seamless format change separately</span></span><br><span class="line">                    formatChange = !seamlessFormatChange;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For format or time change, return EOS to queue EOS input,</span></span><br><span class="line">                <span class="comment">// then wait for EOS on output.</span></span><br><span class="line">                <span class="keyword">if</span> (formatChange <span class="comment">/* not seamless */</span>) &#123;</span><br><span class="line">                    mFormatChangePending = <span class="literal">true</span>;</span><br><span class="line">                    err = ERROR_END_OF_STREAM;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeChange) &#123;</span><br><span class="line">                    rememberCodecSpecificData(newFormat);</span><br><span class="line">                    mTimeChangePending = <span class="literal">true</span>;</span><br><span class="line">                    err = ERROR_END_OF_STREAM;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seamlessFormatChange) &#123;</span><br><span class="line">                    <span class="comment">// reuse existing decoder and don't flush</span></span><br><span class="line">                    rememberCodecSpecificData(newFormat);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// This stream is unaffected by the discontinuity</span></span><br><span class="line">                    <span class="keyword">return</span> -EWOULDBLOCK;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reply should only be returned without a buffer set</span></span><br><span class="line">            <span class="comment">// when there is an error (including EOS)</span></span><br><span class="line">            CHECK(err != OK);</span><br><span class="line"></span><br><span class="line">            reply-&gt;setInt32(<span class="string">"err"</span>, err);</span><br><span class="line">            <span class="keyword">return</span> ERROR_END_OF_STREAM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dropAccessUnit = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mIsAudio</span><br><span class="line">                &amp;&amp; !mIsSecure</span><br><span class="line">                &amp;&amp; mRenderer-&gt;getVideoLateByUs() &gt; <span class="number">100000l</span>l</span><br><span class="line">                &amp;&amp; mIsVideoAVC</span><br><span class="line">                &amp;&amp; !IsAVCReferenceFrame(accessUnit)) &#123;</span><br><span class="line">            dropAccessUnit = <span class="literal">true</span>;</span><br><span class="line">            ++mNumInputFramesDropped;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (dropAccessUnit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGV("returned a valid buffer of %s data", mIsAudio ? "mIsAudio" : "video");</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="keyword">int64_t</span> mediaTimeUs;</span><br><span class="line">    CHECK(accessUnit-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;mediaTimeUs));</span><br><span class="line">    ALOGV(<span class="string">"[%s] feeding input buffer at media time %.3f"</span>,</span><br><span class="line">         mIsAudio ? <span class="string">"audio"</span> : <span class="string">"video"</span>,</span><br><span class="line">         mediaTimeUs / <span class="number">1E6</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCCDecoder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mCCDecoder-&gt;decode(accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reply-&gt;setBuffer(<span class="string">"buffer"</span>, accessUnit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3、循环获取数据HTTPLiveSource-dequeueAccessUnit"><a href="#2-3、循环获取数据HTTPLiveSource-dequeueAccessUnit" class="headerlink" title="2.3、循环获取数据HTTPLiveSource::dequeueAccessUnit()"></a>2.3、循环获取数据HTTPLiveSource::dequeueAccessUnit()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\httplive\LiveSession.cpp]</span><br><span class="line"><span class="keyword">status_t</span> LiveSession::dequeueAccessUnit(</span><br><span class="line">        StreamType stream, sp&lt;ABuffer&gt; *accessUnit) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> finalResult = OK;</span><br><span class="line">    sp&lt;AnotherPacketSource&gt; packetSource = mPacketSources.valueFor(stream);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = packetSource-&gt;dequeueAccessUnit(accessUnit);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\mpeg2ts\AnotherPacketSource.cpp]</span><br><span class="line"><span class="keyword">status_t</span> AnotherPacketSource::dequeueAccessUnit(sp&lt;ABuffer&gt; *buffer) &#123;</span><br><span class="line">    buffer-&gt;clear();</span><br><span class="line"></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (mEOSResult == OK &amp;&amp; mBuffers.empty()) &#123;</span><br><span class="line">        mCondition.wait(mLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mBuffers.empty()) &#123;</span><br><span class="line">        *buffer = *mBuffers.begin();</span><br><span class="line">        mBuffers.erase(mBuffers.begin());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int32_t</span> discontinuity;</span><br><span class="line">        <span class="keyword">if</span> ((*buffer)-&gt;meta()-&gt;findInt32(<span class="string">"discontinuity"</span>, &amp;discontinuity)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (wasFormatChange(discontinuity)) &#123;</span><br><span class="line">                mFormat.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mDiscontinuitySegments.erase(mDiscontinuitySegments.begin());</span><br><span class="line">            <span class="comment">// CHECK(!mDiscontinuitySegments.empty());</span></span><br><span class="line">            <span class="keyword">return</span> INFO_DISCONTINUITY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CHECK(!mDiscontinuitySegments.empty());</span></span><br><span class="line">        DiscontinuitySegment &amp;seg = *mDiscontinuitySegments.begin();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int64_t</span> timeUs;</span><br><span class="line">        mLatestDequeuedMeta = (*buffer)-&gt;meta()-&gt;dup();</span><br><span class="line">        CHECK(mLatestDequeuedMeta-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;timeUs));</span><br><span class="line">        <span class="keyword">if</span> (timeUs &gt; seg.mMaxDequeTimeUs) &#123;</span><br><span class="line">            seg.mMaxDequeTimeUs = timeUs;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sp&lt;RefBase&gt; object;</span><br><span class="line">        <span class="keyword">if</span> ((*buffer)-&gt;meta()-&gt;findObject(<span class="string">"format"</span>, &amp;object)) &#123;</span><br><span class="line">            setFormat(<span class="keyword">static_cast</span>&lt;MetaData*&gt;(object.get()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mEOSResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-4、解码后音视频播放过程"><a href="#2-4、解码后音视频播放过程" class="headerlink" title="2.4、解码后音视频播放过程"></a>2.4、解码后音视频播放过程</h5><p>关于解码后播放过程请参考：<a href="http://zhoujinjian.cc/2018/09/12/Android%20Video%20System%EF%BC%885%EF%BC%89%EF%BC%9AAndroid%20Multimedia%20-%20NuPlayer%E9%9F%B3%E8%A7%86%E9%A2%91%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/">Android Video System（5）：Android Multimedia - NuPlayer音视频同步实现分析</a></p><h4 id="（三）、基于NuPlayer的RTSP流媒体协议"><a href="#（三）、基于NuPlayer的RTSP流媒体协议" class="headerlink" title="（三）、基于NuPlayer的RTSP流媒体协议"></a>（三）、基于NuPlayer的RTSP流媒体协议</h4><h5 id="3-1-1、RTSP-概述："><a href="#3-1-1、RTSP-概述：" class="headerlink" title="3.1.1、RTSP 概述："></a>3.1.1、RTSP 概述：</h5><p>RTSP 是Real Time Streaming Protocol（实时流媒体协议）的简称。RTSP提供一种可扩展的框架，使得能够提供可控制的，按需传输实时数据，比如音频和视频文件。RTSP对流媒体提供了诸如暂停，快进等控制，而它本身并不传输数据，RTSP作用相当于流媒体服务器的远程控制。传输数据可以通过传输层的TCP，UDP协议，RTSP也提供了基于 RTP传输机制的一些有效的方法。</p><h5 id="3-1-2、RTSP-模型："><a href="#3-1-2、RTSP-模型：" class="headerlink" title="3.1.2、RTSP 模型："></a>3.1.2、RTSP 模型：</h5><p>客户机在向视频服务器请求视频服务之前，首先通过HTTP协议从WEB服务器获取所请求视频服务的演示描述（Presentation description）文件，在RTSP中，每个演示（Presentation）及其所对应的媒体流都由一个RTSP URL标识。整个演示及媒体特性都在一个演示描述（Presentation description）文件中定义，该文件可能包括媒体编码方式、语言、RTSPURLs、目标地址、端口及其它参数。用户在向服务器请求某个连续媒体流的服务之前，必须首先从服务器获得该媒体流的演示描述（Presentation description ）文件以得到必需的参数。利用该文件提供的信息定位视频服务地址（包括视频服务器地址和端口号）及视频服务的编码方式等信息。<br>客户机根据上述信息向视频服务器请求视频服务。视频服务初始化完毕，视频服务器为该客户建立一个新的视频服务流，客户端与服务器运行实时流控制协议RTSP，以对该流进行各种VCR 控制信号的交换，如播放、暂停、快进、快退等。当服务完毕，客户端提出拆线（TEARDOWN）请求。服务器使用 RTP协议将媒体数据传输给客户端，一旦数据抵达客户端，客户端应用程序即可播放输出。在流式传输中，使用RTP/RTCP和RTSP /TCP两种不同的通信协议在客户端和服务器间建立联系。如下图：</p><h5 id="3-1-3、RTSP-协议消息格式："><a href="#3-1-3、RTSP-协议消息格式：" class="headerlink" title="3.1.3、RTSP 协议消息格式："></a>3.1.3、RTSP 协议消息格式：</h5><p>请求消息格式:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">方法   URI  RTSP版本   CR  LF </span><br><span class="line">消息头 CR   LF   CR  LF </span><br><span class="line">消息体 CR   LF</span><br></pre></td></tr></table></figure><p>其中方法包括OPTION回应中所有的命令,URI是接受方的地址,例如<br>rtsp://192.168.20.136</p><p>RTSP版本一般都是 RTSP/1.0.每行后面的CR LF表示回车换行，需要接受端有相应的解析，最后一个消息头需要有两个CR LF</p><p>回应消息格式:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RTSP版本  状态码  解释 CR  LF </span><br><span class="line">消息头 CR  LF  CR  LF </span><br><span class="line">消息体 CR  LF</span><br></pre></td></tr></table></figure><p>其中RTSP版本一般都是RTSP/1.0,状态码是一个数值,200表示成功,解释是与状态码对应的文本解释。</p><h5 id="3-1-4、简单的RTSP-交互过程"><a href="#3-1-4、简单的RTSP-交互过程" class="headerlink" title="3.1.4、简单的RTSP 交互过程:"></a>3.1.4、简单的RTSP 交互过程:</h5><p>下面以一次流媒体播放为例介绍整个播放过程的RTSP状态转换的流程：<br>其中C表示RTSP客户端,S表示RTSP服务端：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">C-&gt;S:OPTION     request        <span class="comment">//询问服务端有哪些方法可用</span></span><br><span class="line">S-&gt;C:OPTION     response       <span class="comment">//服务端回应信息中包括提供的所有可用方法 </span></span><br><span class="line"></span><br><span class="line">C-&gt;S:DESCRIBE    request        <span class="comment">//要求得到服务端提供的媒体初始化描述信息 </span></span><br><span class="line">S-&gt;C:DESCRIBE    response       <span class="comment">//服务端回应媒体初始化描述信息，主要是SDP</span></span><br><span class="line"></span><br><span class="line">C-&gt;S:SETUP       request        <span class="comment">//设置会话的属性，以及传输模式提醒服务端建立会话 </span></span><br><span class="line">S-&gt;C:SETUP       response       <span class="comment">//服务端建立会话，返回会话标识符，和会话相关信息 </span></span><br><span class="line"></span><br><span class="line">C-&gt;S:PLAY        request         <span class="comment">//客户端请求播放 </span></span><br><span class="line">S-&gt;C:PLAY        response       <span class="comment">//服务器回应该请求的信息 </span></span><br><span class="line"></span><br><span class="line">S-&gt;C:                           <span class="comment">//发送流媒体数据 </span></span><br><span class="line"></span><br><span class="line">C-&gt;S:TEARDOWN    request        <span class="comment">//客户端请求关闭会话 </span></span><br><span class="line">S-&gt;C:TEARDOWN    response <span class="comment">//服务端回应该请求</span></span><br></pre></td></tr></table></figure><p>其中第SETUP和PLAY这两部是必需的，<br>OPTION 步骤只要服务器客户端约定好，有哪些方法可用，则option请求可以不要。<br>如果我们有其他途径得到媒体初始化描述信息，则我们也不需要通过RTSP中的DESCRIPTION请求来完成。<br>TEARDOWN，可以根据系统需求的设计来决定是否需要。</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-07-RTSP-TEARDOWN.png" alt="Alt text | center"></p><h5 id="3-1-5、RTSP的主要命令表："><a href="#3-1-5、RTSP的主要命令表：" class="headerlink" title="3.1.5、RTSP的主要命令表："></a>3.1.5、RTSP的主要命令表：</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-08-RTSP-option.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-09-RTSP-describe.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-10-RTSP-setup.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-11-RTSP-play.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-12-RTSP-teardowm.png" alt="Alt text | center"></p><p>RTSP状态码：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Status-Code =</span><br><span class="line">| <span class="string">"100"</span> ; 				Continue</span><br><span class="line">| <span class="string">"200"</span> ; 				OK</span><br><span class="line">| <span class="string">"201"</span> ; 				Created</span><br><span class="line">| <span class="string">"250"</span> ; 				Low on Storage Space</span><br><span class="line">| <span class="string">"300"</span> ; 				Multiple Choices</span><br><span class="line">| <span class="string">"301"</span> ;				Moved Permanently</span><br><span class="line">| <span class="string">"302"</span> ; 				Moved Temporarily</span><br><span class="line">| <span class="string">"303"</span> ; 				See Other</span><br><span class="line">| <span class="string">"304"</span> ; 				Not Modified</span><br><span class="line">| <span class="string">"305"</span> ; 				Use Proxy</span><br><span class="line">| <span class="string">"400"</span> ; 				Bad Request</span><br><span class="line">| <span class="string">"401"</span> ; 				Unauthorized</span><br><span class="line">| <span class="string">"402"</span> ; 				Payment Required</span><br><span class="line">| <span class="string">"403"</span> ; 				Forbidden</span><br><span class="line">| <span class="string">"404"</span> ; 				Not Found</span><br><span class="line">| <span class="string">"405"</span> ; 				Method Not Allowed</span><br><span class="line">| <span class="string">"406"</span> ; 				Not Acceptable</span><br><span class="line">| <span class="string">"407"</span> ; 				Proxy Authentication Required</span><br><span class="line">| <span class="string">"408"</span> ; 				Request Time-out</span><br><span class="line">| <span class="string">"410"</span> ; 				Gone</span><br><span class="line">| <span class="string">"411"</span> ; 				Length Required</span><br><span class="line">| <span class="string">"412"</span> ; 				Precondition Failed</span><br><span class="line">| <span class="string">"413"</span> ; 				Request Entity Too Large</span><br><span class="line">| <span class="string">"414"</span> ; 				Request-URI Too Large</span><br><span class="line">| <span class="string">"415"</span> ; 				Unsupported Media Type</span><br><span class="line">| <span class="string">"451"</span> ; 				Parameter Not Understood</span><br><span class="line">| <span class="string">"452"</span> ; 				Conference Not Found</span><br><span class="line">| <span class="string">"453"</span> ; 				Not Enough Bandwidth</span><br><span class="line">| <span class="string">"454"</span> ; 				Session Not Found</span><br><span class="line">| <span class="string">"455"</span> ; 				Method Not Valid in This State</span><br><span class="line">| <span class="string">"456"</span> ; 				Header Field Not Valid <span class="keyword">for</span> Resource</span><br><span class="line">| <span class="string">"457"</span> ; 				Invalid Range</span><br><span class="line">| <span class="string">"458"</span> ; 				Parameter Is Read-Only</span><br><span class="line">| <span class="string">"459"</span> ;				Aggregate operation <span class="keyword">not</span> allowed</span><br><span class="line">| <span class="string">"460"</span> ; 				Only aggregate operation allowed</span><br><span class="line">| <span class="string">"461"</span> ; 				Unsupported transport</span><br><span class="line">| <span class="string">"462"</span> ; 				Destination unreachable</span><br><span class="line">| <span class="string">"500"</span> ; 				Internal Server Error</span><br><span class="line">| <span class="string">"501"</span> ; 				Not Implemented</span><br><span class="line">| <span class="string">"502"</span> ; 				Bad Gateway</span><br><span class="line">| <span class="string">"503"</span> ; 				Service Unavailable</span><br><span class="line">| <span class="string">"504"</span> ; 				Gateway Time-out</span><br><span class="line">| <span class="string">"505"</span> ; 				RTSP Version <span class="keyword">not</span> supported</span><br><span class="line">| <span class="string">"551"</span> ; 				Option <span class="keyword">not</span> supported</span><br></pre></td></tr></table></figure><h5 id="3-1-6、SDP的格式："><a href="#3-1-6、SDP的格式：" class="headerlink" title="3.1.6、SDP的格式："></a>3.1.6、SDP的格式：</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">v=&lt;version&gt;                            (协议版本)</span><br><span class="line">o=&lt;username&gt; &lt;session id&gt; &lt;version&gt; &lt;network type&gt; &lt;address type&gt; &lt;address&gt;                              （所有者/创建者和会话标识符）</span><br><span class="line">s=&lt;session name&gt;                       （会话名称）</span><br><span class="line">i=&lt;session description&gt;                （会话信息） </span><br><span class="line">u=&lt;URI&gt;                                （URI 描述）</span><br><span class="line">e=&lt;email address&gt;                      （Email 地址）</span><br><span class="line">p=&lt;phone number&gt;                       （电话号码）</span><br><span class="line">c=&lt;network type&gt; &lt;address type&gt; &lt;connection address&gt;   （连接信息）</span><br><span class="line">b=&lt;modifier&gt;:&lt;bandwidth-value&gt;         （带宽信息）</span><br><span class="line">t=&lt;start time&gt; &lt;stop time&gt;             （会话活动时间）</span><br><span class="line">r=&lt;repeat interval&gt; &lt;active duration&gt; &lt;<span class="built_in">list</span> of offsets from start-time&gt; </span><br><span class="line">                                        （<span class="number">0</span>或多次重复次数）</span><br><span class="line">z=&lt;adjustment time&gt; &lt;offset&gt; &lt;adjustment time&gt; &lt;offset&gt;（时间区域调整）</span><br><span class="line">k=&lt;method&gt;:&lt;encryption key&gt;             （加密密钥）</span><br><span class="line">a=&lt;attribute&gt;:&lt;value&gt;                   （<span class="number">0</span> 个或多个会话属性行）</span><br><span class="line">m=&lt;media&gt; &lt;port&gt; &lt;transport&gt; &lt;fmt <span class="built_in">list</span>&gt; （媒体名称和传输地址）</span><br><span class="line"></span><br><span class="line">时间描述： </span><br><span class="line">t = （会话活动时间） </span><br><span class="line">r = * （<span class="number">0</span>或多次重复次数） </span><br><span class="line">媒体描述： </span><br><span class="line">m = （媒体名称和传输地址） </span><br><span class="line">i = * （媒体标题） </span><br><span class="line">c = * （连接信息 — 如果包含在会话层则该字段可选） </span><br><span class="line">b = * （带宽信息） </span><br><span class="line">k = * （加密密钥） </span><br><span class="line">a = * （<span class="number">0</span> 个或多个媒体属性行）</span><br></pre></td></tr></table></figure><h5 id="3-1-7、RTP协议："><a href="#3-1-7、RTP协议：" class="headerlink" title="3.1.7、RTP协议："></a>3.1.7、RTP协议：</h5><p>实时传输协议（Real-time Transport Protocol，RTP）是用来在单播或者多播的情境中传流媒体数据的数据传输协议。通常使用UDP来进行多媒体数据的传输，也不排除使用TCP或者ATM等其它协议作为它的载体，整个RTP 协议由两个密切相关的部分组成：RTP数据协议和RTP控制协议（也就是RTCP协议）。<br>RTP为Internet上端到端的实时传输提供时间信息和流同步，但它并不保证服务质量，服务质量由RTCP来提供。</p><ul><li><p>使用RTP协议进行数据传输的一个简要RTP的会话过程：<br>当应用程序建立一个RTP会话时，应用程序将确定一对目的传输地址。目的传输地址由一个网络地址和一对端口组成，有两个端口：一个给RTP包，一个给RTCP包，也就是说RTP和RTCP数据包是分开传输的，这样可以使得RTP/RTCP数据能够正确发送。其中RTP数据发向偶数的UDP端口，而对应的控制信号RTCP数据发向相邻的奇数UDP端口，这样就构成一个UDP端口对。<br>当发送数据的时候RTP协议从上层接收流媒体信息码流，封装成RTP数据包；RTCP从上层接收控制信息，封装成RTCP控制包。RTP将RTP 数据包发往UDP端口对中偶数端口；RTCP将RTCP控制包发往UDP端口对中的接收端口。<br>如果在一次会议中同时使用了音频和视频会议，这两种媒体将分别在不同的RTP会话中传送，每一个会话使用不同的传输地址（IP地址＋端口）。如果一个用户同时使用了两个会话，则每个会话对应的RTCP包都使用规范化名字CNAME（Canonical Name）。与会者可以根据RTCP包中的CNAME来获取相关联的音频和视频，然后根据RTCP包中的计时信息(Network time protocol)来实现音频和视频的同步。</p></li><li><p>翻译器和混合器<br>在RTP协议中还引入了翻译器和混合器。翻译器和混合器都是RTP级的中继系统。<br>混合器的使用情景：<br>在Internet上举行视频会议时，可能有少数参加者通过低速链路与使用高速网络的多数参加者相连接。为了不强制所有会议参加者都使用低带宽和低质量的数据编码，RTP允许在低带宽区域附近使用混合器作为RTP级中继器。混合器从一个或多个信源接收RTP报文，对到达的数据报文进行重新同步和重新组合，这些重组的数据流被混合成一个数据流，将数据编码转化为在低带宽上可用的类型，并通过低速链路向低带宽区域转发。为了对多个输入信源进行统一的同步，混合器在多个媒体流之间进行定时调整，产生它自己的定时同步，因此所有从混合器输出的报文都把混合器作为同步信源。为了保证接收者能够正确识别混合器处理前的原始报文发送者，混合器在RTP报头中设置了CSRC标识符队列，以标识那些产生混和报文的原始同步信源。<br>翻译器的使用情景<br>在Internet环境中，一些会议的参加者可能被隔离在应用级防火墙的外面，这些参加者被禁止直接使用IP组播地址进行访问，虽然他们可能是通过高速链路连接的。在这些情况下，RTP允许使用转换器作为RTP级中继器。在防火墙两端分别安装一个转换器，防火墙之外的转换器过滤所有接收到的组播报文，并通过一条安全的连接传送给防火墙之内的转换器，内部转换器将这些组播报文再转发送给内部网络中的组播组成员</p><h5 id="3-1-8、RTP协议报头格式"><a href="#3-1-8、RTP协议报头格式" class="headerlink" title="3.1.8、RTP协议报头格式"></a>3.1.8、RTP协议报头格式</h5></li></ul><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-13-RTSP-baotou1.png" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-14-RTSP-baotou2.png" alt="Alt text | center"></p><h5 id="3-1-9、RTCP协议报头格式"><a href="#3-1-9、RTCP协议报头格式" class="headerlink" title="3.1.9、RTCP协议报头格式"></a>3.1.9、RTCP协议报头格式</h5><p>如前面所述RTCP的主要功能是：服务质量的监视与反馈、媒体间的同步，以及多播组中成员的标识。在RTP会话期间，各参与者周期性地传送RTCP包。RTCP包中含有已发送的数据包的数量、丢失的数据包的数量等统计资料，因此，各参与者可以利用这些信息动态地改变传输速率，甚至改变有效载荷类型。RTP和RTCP配合使用，它们能以有效的反馈和最小的开销使传输效率最佳化，因而特别适合传送网上的实时数据。RTCP也是用UDP来传送的，但RTCP封装的仅仅是一些控制信息，因而分组很短，所以可以将多个RTCP分组封装在一个UDP包中。<br>RTCP有如下五种分组类型：</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-15-RTCP-baotou1.png" alt="Alt text | center"></p><p>下面是SR分组的格式：</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-16-RTCP-baotou2.png" alt="Alt text | center"></p><h5 id="3-2、基于NuPLayer的RTSP-代码流程"><a href="#3-2、基于NuPLayer的RTSP-代码流程" class="headerlink" title="3.2、基于NuPLayer的RTSP 代码流程"></a>3.2、基于NuPLayer的RTSP 代码流程</h5><p>setDataSource 阶段的任务这里就不重复介绍了，它主要完成播放引擎的建立以及根据URL格式创建对应的Source，比如这里将要提到的RTSPSource，然后赋值给mSource。</p><p>我们直接来看prepare阶段：</p><p>先上图再看代码，结合图看会比较清晰<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-17-ARTSPConnection.png" alt="Alt text | center"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-18-ARTSP-Source.png" alt="Alt text | center"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-19-ARTSP-Source-state.png" alt="Alt text | center"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/video.system/VS-06-20-ARTSP-Source-state2.png" alt="Alt text | center"></p><h5 id="3-3、RTSPSource-prepareAsync-流程"><a href="#3-3、RTSPSource-prepareAsync-流程" class="headerlink" title="3.3、RTSPSource::prepareAsync()流程"></a>3.3、RTSPSource::prepareAsync()流程</h5><p>在prepare阶段我们首先会判断是否是SDP，mIsSDP这个变量是在初始化RTSPSource时候传入的，我们这里先分析mIsSDP = false的情况。这种情况下首先创建一个MyHandler，并调用connect，与服务器建立连接。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmediaplayerservice\nuplayer\RTSPSource.cpp]</span><br><span class="line"><span class="keyword">void</span> NuPlayer::RTSPSource::prepareAsync() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//..........</span></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatNotify, <span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查当前状态是否为DISCONNECTED</span></span><br><span class="line">    CHECK_EQ(mState, (<span class="keyword">int</span>)DISCONNECTED);</span><br><span class="line">    <span class="comment">//设置当前状态为CONNECTING</span></span><br><span class="line">    mState = CONNECTING;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsSDP) &#123;</span><br><span class="line">        <span class="comment">//如果是SDP那么就需要创建一个SDPLoader 从服务器上加载一个描述文件</span></span><br><span class="line">        mSDPLoader = <span class="keyword">new</span> SDPLoader(notify, (mFlags &amp; kFlagIncognito) ? SDPLoader::kFlagIncognito : <span class="number">0</span>, mHTTPService);</span><br><span class="line">        mSDPLoader-&gt;load(mURL.c_str(), mExtraHeaders.isEmpty() ? <span class="literal">NULL</span> : &amp;mExtraHeaders);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果不是SDP 那么就使用MyHandler 来进行连接</span></span><br><span class="line">        mHandler = <span class="keyword">new</span> MyHandler(mURL.c_str(), notify, mUIDValid, mUID);</span><br><span class="line">        mLooper-&gt;registerHandler(mHandler);</span><br><span class="line">        mHandler-&gt;connect();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//启动缓存</span></span><br><span class="line">    startBufferingIfNecessary();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在介绍connect方法之前需要先了解mConn以及mRTPConn这两个成员变量，mConn是一个ARTSPConnection，它主要与服务器相连，发送和接收请求数据，mRTPConn是一个ARTPConnection 用于发送和接收媒体数据。<br>在connect方法中会使用mConn向服务器发起连接请求。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\MyHandler.h]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//mConn(new ARTSPConnection(mUIDValid, mUID)),</span></span><br><span class="line">    looper()-&gt;registerHandler(mConn);</span><br><span class="line">    <span class="comment">//mRTPConn(new ARTPConnection),</span></span><br><span class="line">    (<span class="number">1</span> ? mNetLooper : looper())-&gt;registerHandler(mRTPConn);</span><br><span class="line">    sp&lt;AMessage&gt; notify = new AMessage('biny', this);</span><br><span class="line">    mConn-&gt;observeBinaryData(notify);</span><br><span class="line">    <span class="comment">//连接服务</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = new AMessage('conn', this);</span><br><span class="line">    mConn-&gt;connect(mOriginalSessionURL.c_str(), reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::connect(<span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;reply) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatConnect, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setString(<span class="string">"url"</span>, url);</span><br><span class="line">    msg-&gt;setMessage(<span class="string">"reply"</span>, reply);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatConnect:</span><br><span class="line">    onConnect(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>在ARTSPConnection::onConnect中将会从传递过来的URl中解析host，port，path，mUser，mPass，并调用::connect 和服务器取得联系，最后调用postReceiveReponseEvent将请求的回复响应暂存起来。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::onConnect(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    ++mConnectionID;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mState != DISCONNECTED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPBase::UnRegisterSocketUserTag(mSocket);</span><br><span class="line">            HTTPBase::UnRegisterSocketUserMark(mSocket);</span><br><span class="line">        &#125;</span><br><span class="line">        close(mSocket);</span><br><span class="line">        mSocket = <span class="number">-1</span>;</span><br><span class="line">        flushPendingRequests();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mState = CONNECTING;</span><br><span class="line">    AString url;</span><br><span class="line">    <span class="comment">//从消息中取下Url</span></span><br><span class="line">    CHECK(msg-&gt;findString(<span class="string">"url"</span>, &amp;url));</span><br><span class="line">    sp&lt;AMessage&gt; reply;</span><br><span class="line">    <span class="comment">//从消息中取下replay</span></span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"reply"</span>, &amp;reply));</span><br><span class="line"></span><br><span class="line">    AString host, path;</span><br><span class="line">    <span class="keyword">unsigned</span> port;</span><br><span class="line">    <span class="comment">//从URl中解析host，port，path，mUser，mPass</span></span><br><span class="line">    <span class="keyword">if</span> (!ParseURL(url.c_str(), &amp;host, &amp;port, &amp;path, &amp;mUser, &amp;mPass)</span><br><span class="line">            || (mUser.size() &gt; <span class="number">0</span> &amp;&amp; mPass.size() == <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//有用户名，但是没有密码，返回错误信息</span></span><br><span class="line">        <span class="comment">// If we have a user name but no password we have to give up</span></span><br><span class="line">        <span class="comment">// right here, since we currently have no way of asking the user</span></span><br><span class="line">        <span class="comment">// for this information.</span></span><br><span class="line">        ALOGE(<span class="string">"Malformed rtsp url %s"</span>, uriDebugString(url).c_str());</span><br><span class="line">        reply-&gt;setInt32(<span class="string">"result"</span>, ERROR_MALFORMED);</span><br><span class="line">        reply-&gt;post();</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mUser.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGV(<span class="string">"user = '%s', pass = '%s'"</span>, mUser.c_str(), mPass.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">ent</span> = <span class="title">gethostbyname</span>(<span class="title">host</span>.<span class="title">c_str</span>());</span></span><br><span class="line">    <span class="keyword">if</span> (ent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Unknown host %s"</span>, host.c_str());</span><br><span class="line">        reply-&gt;setInt32(<span class="string">"result"</span>, -ENOENT);</span><br><span class="line">        reply-&gt;post();</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mSocket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">        HTTPBase::RegisterSocketUserTag(mSocket, mUID,(<span class="keyword">uint32_t</span>)*(<span class="keyword">uint32_t</span>*) <span class="string">"RTSP"</span>);</span><br><span class="line">        HTTPBase::RegisterSocketUserMark(mSocket, mUID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MakeSocketBlocking(mSocket, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">remote</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(remote.sin_zero, <span class="number">0</span>, <span class="keyword">sizeof</span>(remote.sin_zero));</span><br><span class="line">    remote.sin_family = AF_INET;</span><br><span class="line">    remote.sin_addr.s_addr = *(<span class="keyword">in_addr_t</span> *)ent-&gt;h_addr;</span><br><span class="line">    remote.sin_port = htons(port);</span><br><span class="line">    <span class="comment">//连接到服务器</span></span><br><span class="line">    <span class="keyword">int</span> err = ::connect(mSocket, (<span class="keyword">const</span> struct sockaddr *)&amp;remote, <span class="keyword">sizeof</span>(remote));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回服务器ip</span></span><br><span class="line">    reply-&gt;setInt32(<span class="string">"server-ip"</span>, ntohl(remote.sin_addr.s_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINPROGRESS) &#123;</span><br><span class="line">            sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatCompleteConnection, <span class="keyword">this</span>);</span><br><span class="line">            msg-&gt;setMessage(<span class="string">"reply"</span>, reply);</span><br><span class="line">            msg-&gt;setInt32(<span class="string">"connection-id"</span>, mConnectionID);</span><br><span class="line">            msg-&gt;post();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        reply-&gt;setInt32(<span class="string">"result"</span>, -errno);</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPBase::UnRegisterSocketUserTag(mSocket);</span><br><span class="line">            HTTPBase::UnRegisterSocketUserMark(mSocket);</span><br><span class="line">        &#125;</span><br><span class="line">        close(mSocket);</span><br><span class="line">        mSocket = <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//成功的花返回result为OK</span></span><br><span class="line">        reply-&gt;setInt32(<span class="string">"result"</span>, OK);</span><br><span class="line">        <span class="comment">//设置状态为CONNECTED</span></span><br><span class="line">        mState = CONNECTED;</span><br><span class="line">        mNextCSeq = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//发送等待返回消息</span></span><br><span class="line">        postReceiveReponseEvent();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//‘conn’</span></span><br><span class="line">    reply-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们接下来看下postReceiveReponseEvent,调用receiveRTSPReponse获得服务器的回复</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;]</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::postReceiveReponseEvent() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mReceiveResponseEventPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatReceiveResponse, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">    mReceiveResponseEventPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::onReceiveResponse() &#123;</span><br><span class="line">    mReceiveResponseEventPending = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mState != CONNECTED) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    tv.tv_sec = <span class="number">0</span>;</span><br><span class="line">    tv.tv_usec = kSelectTimeoutUs;</span><br><span class="line">    fd_set rs;</span><br><span class="line">    FD_ZERO(&amp;rs);</span><br><span class="line">    FD_SET(mSocket, &amp;rs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选择一个返回的连接</span></span><br><span class="line">    <span class="keyword">int</span> res = select(mSocket + <span class="number">1</span>, &amp;rs, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">1</span>) &#123;</span><br><span class="line">        MakeSocketBlocking(mSocket, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">bool</span> success = receiveRTSPReponse();</span><br><span class="line">        MakeSocketBlocking(mSocket, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// Something horrible, irreparable has happened.</span></span><br><span class="line">            flushPendingRequests();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    postReceiveReponseEvent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意这里的receiveRTSPReponse是有双重功能的，方面可以接收从服务器发来的请求，另一方面可以处理服务器发来的应答信号。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">bool</span> ARTSPConnection::receiveRTSPReponse() &#123;</span><br><span class="line"></span><br><span class="line">    AString statusLine;</span><br><span class="line">    <span class="keyword">if</span> (!receiveLine(&amp;statusLine)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statusLine == <span class="string">"$"</span>) &#123;</span><br><span class="line">        sp&lt;ABuffer&gt; buffer = receiveBinaryData();</span><br><span class="line">        <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mObserveBinaryMessage != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sp&lt;AMessage&gt; notify = mObserveBinaryMessage-&gt;dup();</span><br><span class="line">            notify-&gt;setBuffer(<span class="string">"buffer"</span>, buffer);</span><br><span class="line">            notify-&gt;post();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGW(<span class="string">"received binary data, but no one cares."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RTSP返回对象</span></span><br><span class="line">    sp&lt;ARTSPResponse&gt; response = <span class="keyword">new</span> ARTSPResponse;</span><br><span class="line">    response-&gt;mStatusLine = statusLine;</span><br><span class="line">    ALOGI(<span class="string">"status: %s"</span>, response-&gt;mStatusLine.c_str());</span><br><span class="line">    <span class="keyword">ssize_t</span> space1 = response-&gt;mStatusLine.find(<span class="string">" "</span>);</span><br><span class="line">    <span class="keyword">if</span> (space1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">ssize_t</span> space2 = response-&gt;mStatusLine.find(<span class="string">" "</span>, space1 + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (space2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isRequest = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//判断返回的RTSP版本是否正确</span></span><br><span class="line">    <span class="keyword">if</span> (!IsRTSPVersion(AString(response-&gt;mStatusLine, <span class="number">0</span>, space1))) &#123;</span><br><span class="line">        CHECK(IsRTSPVersion(AString(response-&gt;mStatusLine,space2 + <span class="number">1</span>,response-&gt;mStatusLine.size() - space2 - <span class="number">1</span>)));</span><br><span class="line">        isRequest = <span class="literal">true</span>;</span><br><span class="line">        response-&gt;mStatusCode = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//判断状态码是否正确</span></span><br><span class="line">        AString statusCodeStr(response-&gt;mStatusLine, space1 + <span class="number">1</span>, space2 - space1 - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ParseSingleUnsignedLong(statusCodeStr.c_str(), &amp;response-&gt;mStatusCode) || response-&gt;mStatusCode &lt; <span class="number">100</span> || response-&gt;mStatusCode &gt; <span class="number">999</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AString line;</span><br><span class="line">    <span class="keyword">ssize_t</span> lastDictIndex = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!receiveLine(&amp;line)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (line.empty()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ALOGV(<span class="string">"line: '%s'"</span>, line.c_str());</span><br><span class="line">        <span class="keyword">if</span> (line.c_str()[<span class="number">0</span>] == <span class="string">' '</span> || line.c_str()[<span class="number">0</span>] == <span class="string">'\t'</span>) &#123;</span><br><span class="line">            <span class="comment">// Support for folded header values.</span></span><br><span class="line">            <span class="keyword">if</span> (lastDictIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// First line cannot be a continuation of the previous one.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            AString &amp;value = response-&gt;mHeaders.editValueAt(lastDictIndex);</span><br><span class="line">            value.append(line);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">ssize_t</span> colonPos = line.find(<span class="string">":"</span>);</span><br><span class="line">        <span class="keyword">if</span> (colonPos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Malformed header line.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">AString <span class="title">key</span><span class="params">(line, <span class="number">0</span>, colonPos)</span></span>;</span><br><span class="line">        key.trim();</span><br><span class="line">        key.<span class="built_in">tolower</span>();</span><br><span class="line">        line.erase(<span class="number">0</span>, colonPos + <span class="number">1</span>);</span><br><span class="line">        lastDictIndex = response-&gt;mHeaders.add(key, line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; response-&gt;mHeaders.size(); ++i) &#123;</span><br><span class="line">        response-&gt;mHeaders.editValueAt(i).trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> contentLength = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> i = response-&gt;mHeaders.indexOfKey(<span class="string">"content-length"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        AString value = response-&gt;mHeaders.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (!ParseSingleUnsignedLong(value.c_str(), &amp;contentLength)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//接收mContent</span></span><br><span class="line">    <span class="keyword">if</span> (contentLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        response-&gt;mContent = <span class="keyword">new</span> ABuffer(contentLength);</span><br><span class="line">        <span class="keyword">if</span> (receive(response-&gt;mContent-&gt;data(), contentLength) != OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//isRequest 表示是服务器主动发送的请求，那么将调用handleServerRequest，否则表示是服务器被动响应客户端的请求，那么将通知服务器有响应了notifyResponseListener</span></span><br><span class="line">    <span class="keyword">return</span> isRequest</span><br><span class="line">        ? handleServerRequest(response)</span><br><span class="line">        : notifyResponseListener(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>isRequest 表示是服务器主动发送的请求，那么将调用handleServerRequest，否则表示是服务器被动响应客户端的请求，那么将通知服务器有响应了notifyResponseListener，我们这里先看下这两个方法的实现：</p><p>看到handleServerRequest大家可能会有点失望，因为这里尚未实现这个功能所以只是向服务器返回一个“RTSP/1.0 501 Not Implemented”的消息。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">bool</span> ARTSPConnection::handleServerRequest(<span class="keyword">const</span> sp&lt;ARTSPResponse&gt; &amp;request) &#123;</span><br><span class="line">    <span class="comment">// Implementation of server-&gt;client requests is optional for all methods</span></span><br><span class="line">    <span class="comment">// but we do need to respond, even if it's just to say that we don't</span></span><br><span class="line">    <span class="comment">// support the method.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里我们不实现任何答复行为只是简单反馈我们尚未实现这个功能</span></span><br><span class="line">    <span class="keyword">ssize_t</span> space1 = request-&gt;mStatusLine.find(<span class="string">" "</span>);</span><br><span class="line">    CHECK_GE(space1, <span class="number">0</span>);</span><br><span class="line">    AString response;</span><br><span class="line">    response.append(<span class="string">"RTSP/1.0 501 Not Implemented\r\n"</span>);</span><br><span class="line">    <span class="keyword">ssize_t</span> i = request-&gt;mHeaders.indexOfKey(<span class="string">"cseq"</span>);</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        AString value = request-&gt;mHeaders.valueAt(i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> cseq;</span><br><span class="line">        <span class="keyword">if</span> (!ParseSingleUnsignedLong(value.c_str(), &amp;cseq)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.append(<span class="string">"CSeq: "</span>);</span><br><span class="line">        response.append(cseq);</span><br><span class="line">        response.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    response.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    <span class="keyword">size_t</span> numBytesSent = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (numBytesSent &lt; response.size()) &#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> n =</span><br><span class="line">            send(mSocket, response.c_str() + numBytesSent,</span><br><span class="line">                 response.size() - numBytesSent, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span> &amp;&amp; errno == EINTR) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Server closed the connection.</span></span><br><span class="line">                ALOGE(<span class="string">"Server unexpectedly closed the connection."</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ALOGE(<span class="string">"Error sending rtsp response (%s)."</span>, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            performDisconnect();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        numBytesSent += (<span class="keyword">size_t</span>)n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>notifyResponseListener的实现比较清晰，它会根据服务器发来的应答响应，找出响应该应答的Message，然后将response返回给MyHandler，进行处理。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">bool</span> ARTSPConnection::notifyResponseListener(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTSPResponse&gt; &amp;response) &#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> i;</span><br><span class="line">    <span class="comment">//在队列中查找尚未处理的请求</span></span><br><span class="line">    <span class="keyword">status_t</span> err = findPendingRequest(response, &amp;i);</span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//发送服务器的回复给它</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = mPendingRequests.valueAt(i);</span><br><span class="line">    mPendingRequests.removeItemsAt(i);</span><br><span class="line">    reply-&gt;setInt32(<span class="string">"result"</span>, OK);</span><br><span class="line">    reply-&gt;setObject(<span class="string">"response"</span>, response);</span><br><span class="line">    reply-&gt;post();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>好了我们言归正传，我们看下MyHandler中对conn回复怎么处理：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\MyHandler.h]</span><br><span class="line">case 'conn':</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="comment">//取出反馈结果</span></span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"result"</span>, &amp;result));</span><br><span class="line">    <span class="keyword">if</span> (result == OK) &#123;</span><br><span class="line">        <span class="comment">//发送请求描述符的消息</span></span><br><span class="line">        AString request;</span><br><span class="line">        request = <span class="string">"DESCRIBE "</span>;</span><br><span class="line">        request.append(mSessionURL);</span><br><span class="line">        request.append(<span class="string">" RTSP/1.0\r\n"</span>);</span><br><span class="line">        request.append(<span class="string">"Accept: application/sdp\r\n"</span>);</span><br><span class="line">        request.append(<span class="string">"\r\n"</span>);</span><br><span class="line">        sp&lt;AMessage&gt; reply = new AMessage('desc', this);</span><br><span class="line">        mConn-&gt;sendRequest(request.c_str(), reply);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        (new AMessage('disc', this))-&gt;post();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里比较简单就是收到答复之后，直接判断结果是OK还是不OK，如果OK那么就发送一个DESCRIBE的请求。我们重点看下，onSendRequest理解这个很重要：<br>在onSendRequest中会对请求加工处理下，比如添加Cseq等操作，然后就会调用send向服务器发送请求。并将请求以Cseq为键码，replay为回复消息的待处理请求队列中。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTSPConnection.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTSPConnection::onSendRequest(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; reply;</span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"reply"</span>, &amp;reply));</span><br><span class="line">    <span class="comment">//对请求进行加工处理</span></span><br><span class="line">    AString request;</span><br><span class="line">    CHECK(msg-&gt;findString(<span class="string">"request"</span>, &amp;request));</span><br><span class="line">    <span class="comment">// Just in case we need to re-issue the request with proper authentication</span></span><br><span class="line">    <span class="comment">// later, stash it away.</span></span><br><span class="line">    reply-&gt;setString(<span class="string">"original-request"</span>, request.c_str(), request.size());</span><br><span class="line">    addAuthentication(&amp;request);</span><br><span class="line">    addUserAgent(&amp;request);</span><br><span class="line">    <span class="comment">// Find the boundary between headers and the body.</span></span><br><span class="line">    <span class="keyword">ssize_t</span> i = request.find(<span class="string">"\r\n\r\n"</span>);</span><br><span class="line">    CHECK_GE(i, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int32_t</span> cseq = mNextCSeq++;</span><br><span class="line">    AString cseqHeader = <span class="string">"CSeq: "</span>;</span><br><span class="line">    cseqHeader.append(cseq);</span><br><span class="line">    cseqHeader.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    request.insert(cseqHeader, i + <span class="number">2</span>);</span><br><span class="line">    ALOGV(<span class="string">"request: '%s'"</span>, request.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> numBytesSent = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (numBytesSent &lt; request.size()) &#123;</span><br><span class="line">        <span class="comment">//如果请求还没完全发送结束那么继续发送</span></span><br><span class="line">        <span class="keyword">ssize_t</span> n = send(mSocket, request.c_str() + numBytesSent,request.size() - numBytesSent, <span class="number">0</span>);&#125;</span><br><span class="line">        <span class="comment">//忽略错误处理代码</span></span><br><span class="line">        numBytesSent += (<span class="keyword">size_t</span>)n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将请求添加到mPendingRequests，等待服务器回复</span></span><br><span class="line">    mPendingRequests.add(cseq, reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回到上面提到的notifyResponseListener结合onSendRequest以及findPendingRequest是否看出了整个事件处理的流程？</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> ARTSPConnection::findPendingRequest(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTSPResponse&gt; &amp;response, <span class="keyword">ssize_t</span> *index) <span class="keyword">const</span> &#123;</span><br><span class="line">    *index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> i = response-&gt;mHeaders.indexOfKey(<span class="string">"cseq"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// This is an unsolicited server-&gt;client message.</span></span><br><span class="line">        *index = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line">    AString value = response-&gt;mHeaders.valueAt(i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cseq;</span><br><span class="line">    <span class="keyword">if</span> (!ParseSingleUnsignedLong(value.c_str(), &amp;cseq)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">    &#125;</span><br><span class="line">    i = mPendingRequests.indexOfKey(cseq);</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOENT;</span><br><span class="line">    &#125;</span><br><span class="line">    *index = i;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>onSendRequest 会不断将请求放入mPendingRequests中，而每次服务器给出应答的时候会调用notifyResponseListener，notifyResponseListener会从mPendingRequests中取出一个应答消息，并发送消息给MyHandler进行处理，而notifyResponseListener又会阻塞等待下一个服务器的应答信号。</p><p>OK我们接下来看下收到‘desc’信号后的处理：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">case 'desc':</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"result"</span>, &amp;result));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == OK) &#123;</span><br><span class="line">        sp&lt;RefBase&gt; obj;</span><br><span class="line">        CHECK(msg-&gt;findObject(<span class="string">"response"</span>, &amp;obj));</span><br><span class="line">        sp&lt;ARTSPResponse&gt; response = <span class="keyword">static_cast</span>&lt;ARTSPResponse *&gt;(obj.get());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (response-&gt;mStatusCode == <span class="number">301</span> || response-&gt;mStatusCode == <span class="number">302</span>) &#123;</span><br><span class="line">            <span class="comment">//重定向连接</span></span><br><span class="line">            <span class="comment">//............</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response-&gt;mStatusCode != <span class="number">200</span>) &#123;</span><br><span class="line">            result = UNKNOWN_ERROR;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response-&gt;mContent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            result = ERROR_MALFORMED;</span><br><span class="line">            ALOGE(<span class="string">"The response has no content."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//获得ASessionDescription</span></span><br><span class="line">            mSessionDesc = <span class="keyword">new</span> ASessionDescription;</span><br><span class="line">            mSessionDesc-&gt;setTo(response-&gt;mContent-&gt;data(),response-&gt;mContent-&gt;size());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mSessionDesc-&gt;isValid()) &#123;</span><br><span class="line">                <span class="comment">//............</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//............</span></span><br><span class="line">                <span class="keyword">if</span> (mSessionDesc-&gt;countTracks() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="comment">// There's no actual tracks in this session.</span></span><br><span class="line">                    <span class="comment">// The first "track" is merely session meta</span></span><br><span class="line">                    <span class="comment">// data.</span></span><br><span class="line">                    ALOGW(<span class="string">"Session doesn't contain any playable "</span></span><br><span class="line">                         <span class="string">"tracks. Aborting."</span>);</span><br><span class="line">                    result = ERROR_UNSUPPORTED;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//这里才是真正要处理的代码</span></span><br><span class="line">                    setupTrack(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面代码很长我们忽略不重要的，直接看setupTrack。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupTrack</span><span class="params">(<span class="keyword">size_t</span> index)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    sp&lt;APacketSource&gt; source = <span class="keyword">new</span> APacketSource(mSessionDesc, index);</span><br><span class="line">    AString url;</span><br><span class="line">    CHECK(mSessionDesc-&gt;findAttribute(index, <span class="string">"a=control"</span>, &amp;url));</span><br><span class="line">    AString trackURL;</span><br><span class="line">    <span class="comment">//获得多媒体文件的Uri</span></span><br><span class="line">    CHECK(MakeURL(mBaseURL.c_str(), url.c_str(), &amp;trackURL));</span><br><span class="line"></span><br><span class="line">    mTracks.push(TrackInfo());</span><br><span class="line">    TrackInfo *info = &amp;mTracks.editItemAt(mTracks.size() - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//设置uri</span></span><br><span class="line">    info-&gt;mURL = trackURL;</span><br><span class="line">    <span class="comment">//设置APacketSource</span></span><br><span class="line">    info-&gt;mPacketSource = source;</span><br><span class="line">    info-&gt;mUsingInterleavedTCP = <span class="literal">false</span>;</span><br><span class="line">    info-&gt;mFirstSeqNumInSegment = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNewSegment = <span class="literal">true</span>;</span><br><span class="line">    info-&gt;mRTPSocket = <span class="number">-1</span>;</span><br><span class="line">    info-&gt;mRTCPSocket = <span class="number">-1</span>;</span><br><span class="line">    info-&gt;mRTPAnchor = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNTPAnchorUs = <span class="number">-1</span>;</span><br><span class="line">    info-&gt;mNormalPlayTimeRTP = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNormalPlayTimeUs = <span class="number">0l</span>l;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> PT;</span><br><span class="line">    AString formatDesc;</span><br><span class="line">    AString formatParams;</span><br><span class="line">    mSessionDesc-&gt;getFormatType(index, &amp;PT, &amp;formatDesc, &amp;formatParams);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> timescale;</span><br><span class="line">    <span class="keyword">int32_t</span> numChannels;</span><br><span class="line">    ASessionDescription::ParseFormatDesc(formatDesc.c_str(), &amp;timescale, &amp;numChannels);</span><br><span class="line"></span><br><span class="line">    info-&gt;mTimeScale = timescale;</span><br><span class="line">    info-&gt;mEOSReceived = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"track #%zu URL=%s"</span>, mTracks.size(), trackURL.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//建立SETUP请求</span></span><br><span class="line">    AString request = <span class="string">"SETUP "</span>;</span><br><span class="line">    request.append(trackURL);</span><br><span class="line">    request.append(<span class="string">" RTSP/1.0\r\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mTryTCPInterleaving) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> interleaveIndex = <span class="number">2</span> * (mTracks.size() - <span class="number">1</span>);</span><br><span class="line">        info-&gt;mUsingInterleavedTCP = <span class="literal">true</span>;</span><br><span class="line">        info-&gt;mRTPSocket = interleaveIndex;</span><br><span class="line">        info-&gt;mRTCPSocket = interleaveIndex + <span class="number">1</span>;</span><br><span class="line">        request.append(<span class="string">"Transport: RTP/AVP/TCP;interleaved="</span>);</span><br><span class="line">        request.append(interleaveIndex);</span><br><span class="line">        request.append(<span class="string">"-"</span>);</span><br><span class="line">        request.append(interleaveIndex + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> rtpPort;</span><br><span class="line">        ARTPConnection::MakePortPair(</span><br><span class="line">                &amp;info-&gt;mRTPSocket, &amp;info-&gt;mRTCPSocket, &amp;rtpPort);</span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPBase::RegisterSocketUserTag(info-&gt;mRTPSocket, mUID,</span><br><span class="line">                                            (<span class="keyword">uint32_t</span>)*(<span class="keyword">uint32_t</span>*) <span class="string">"RTP_"</span>);</span><br><span class="line">            HTTPBase::RegisterSocketUserTag(info-&gt;mRTCPSocket, mUID,</span><br><span class="line">                                            (<span class="keyword">uint32_t</span>)*(<span class="keyword">uint32_t</span>*) <span class="string">"RTP_"</span>);</span><br><span class="line">            HTTPBase::RegisterSocketUserMark(info-&gt;mRTPSocket, mUID);</span><br><span class="line">            HTTPBase::RegisterSocketUserMark(info-&gt;mRTCPSocket, mUID);</span><br><span class="line">        &#125;</span><br><span class="line">        request.append(<span class="string">"Transport: RTP/AVP/UDP;unicast;client_port="</span>);</span><br><span class="line">        request.append(rtpPort);</span><br><span class="line">        request.append(<span class="string">"-"</span>);</span><br><span class="line">        request.append(rtpPort + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    request.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        request.append(<span class="string">"Session: "</span>);</span><br><span class="line">        request.append(mSessionID);</span><br><span class="line">        request.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    request.append(<span class="string">"\r\n"</span>);</span><br><span class="line">    sp&lt;AMessage&gt; reply = new AMessage('setu', this);</span><br><span class="line">    reply-&gt;setSize(<span class="string">"index"</span>, index);</span><br><span class="line">    reply-&gt;setSize(<span class="string">"track-index"</span>, mTracks.size() - <span class="number">1</span>);</span><br><span class="line">    mConn-&gt;sendRequest(request.c_str(), reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的逻辑也很简单就是将要获取到的歌曲信息存放到mTracks，并使用sendRequest发起setu请求，sendRequest就不再作详细介绍了，我们直接看下‘setu’返回后的处理：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">case 'setu':</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"index"</span>, &amp;index));</span><br><span class="line">    TrackInfo *track = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span> trackIndex;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findSize(<span class="string">"track-index"</span>, &amp;trackIndex)) &#123;</span><br><span class="line">        track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"result"</span>, &amp;result));</span><br><span class="line">    <span class="keyword">if</span> (result == OK) &#123;</span><br><span class="line">        CHECK(track != <span class="literal">NULL</span>);</span><br><span class="line">        sp&lt;RefBase&gt; obj;</span><br><span class="line">        CHECK(msg-&gt;findObject(<span class="string">"response"</span>, &amp;obj));</span><br><span class="line">        sp&lt;ARTSPResponse&gt; response =</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;ARTSPResponse *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response-&gt;mStatusCode != <span class="number">200</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">ssize_t</span> i = response-&gt;mHeaders.indexOfKey(<span class="string">"session"</span>);</span><br><span class="line">            CHECK_GE(i, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//得到SessionID</span></span><br><span class="line">            mSessionID = response-&gt;mHeaders.valueAt(i);</span><br><span class="line">            mKeepAliveTimeoutUs = kDefaultKeepAliveTimeoutUs;</span><br><span class="line">            AString timeoutStr;</span><br><span class="line">            <span class="comment">//........................</span></span><br><span class="line">            sp&lt;AMessage&gt; notify = new AMessage('accu', this);</span><br><span class="line">            notify-&gt;setSize(<span class="string">"track-index"</span>, trackIndex);</span><br><span class="line">            i = response-&gt;mHeaders.indexOfKey(<span class="string">"transport"</span>);</span><br><span class="line">            CHECK_GE(i, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (track-&gt;mRTPSocket != <span class="number">-1</span> &amp;&amp; track-&gt;mRTCPSocket != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!track-&gt;mUsingInterleavedTCP) &#123;</span><br><span class="line">                    AString transport = response-&gt;mHeaders.valueAt(i);</span><br><span class="line">                    <span class="comment">// We are going to continue even if we were</span></span><br><span class="line">                    <span class="comment">// unable to poke a hole into the firewall...</span></span><br><span class="line">                    pokeAHole(</span><br><span class="line">                            track-&gt;mRTPSocket,</span><br><span class="line">                            track-&gt;mRTCPSocket,</span><br><span class="line">                            transport);</span><br><span class="line">                &#125;</span><br><span class="line">                mRTPConn-&gt;addStream(</span><br><span class="line">                        track-&gt;mRTPSocket, track-&gt;mRTCPSocket,</span><br><span class="line">                        mSessionDesc, index,</span><br><span class="line">                        notify, track-&gt;mUsingInterleavedTCP);</span><br><span class="line">                mSetupTracksSuccessful = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = BAD_VALUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>上面最重要的就是获取SessionID并调用mRTPConn-&gt;addStream完ARTPConnection中添加一个流，我们看下addStream：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ARTPConnection::addStream(</span><br><span class="line">        <span class="keyword">int</span> rtpSocket, <span class="keyword">int</span> rtcpSocket,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ASessionDescription&gt; &amp;sessionDesc,</span><br><span class="line">        <span class="keyword">size_t</span> index,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;notify,</span><br><span class="line">        <span class="keyword">bool</span> injected) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatAddStream, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"rtp-socket"</span>, rtpSocket);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"rtcp-socket"</span>, rtcpSocket);</span><br><span class="line">    msg-&gt;setObject(<span class="string">"session-desc"</span>, sessionDesc);</span><br><span class="line">    msg-&gt;setSize(<span class="string">"index"</span>, index);</span><br><span class="line">    msg-&gt;setMessage(<span class="string">"notify"</span>, notify);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"injected"</span>, injected);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatAddStream:</span><br><span class="line">&#123;</span><br><span class="line">    onAddStream(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ARTPConnection::onAddStream(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="comment">//将Stream信息添加到mStreams</span></span><br><span class="line">    mStreams.push_back(StreamInfo());</span><br><span class="line">    StreamInfo *info = &amp;*--mStreams.end();</span><br><span class="line">    <span class="keyword">int32_t</span> s;</span><br><span class="line">    <span class="comment">//获得rtp-socket</span></span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"rtp-socket"</span>, &amp;s));</span><br><span class="line">    info-&gt;mRTPSocket = s;</span><br><span class="line">    <span class="comment">//获得rtcp-socket</span></span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"rtcp-socket"</span>, &amp;s));</span><br><span class="line">    info-&gt;mRTCPSocket = s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> injected;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"injected"</span>, &amp;injected));</span><br><span class="line"></span><br><span class="line">    info-&gt;mIsInjected = injected;</span><br><span class="line">    <span class="comment">//获得session-desc</span></span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    CHECK(msg-&gt;findObject(<span class="string">"session-desc"</span>, &amp;obj));</span><br><span class="line">    info-&gt;mSessionDesc = <span class="keyword">static_cast</span>&lt;ASessionDescription *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"index"</span>, &amp;info-&gt;mIndex));</span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"notify"</span>, &amp;info-&gt;mNotifyMsg));</span><br><span class="line"></span><br><span class="line">    info-&gt;mNumRTCPPacketsReceived = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNumRTPPacketsReceived = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;info-&gt;mRemoteRTCPAddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(info-&gt;mRemoteRTCPAddr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送轮询查询事件</span></span><br><span class="line">    <span class="keyword">if</span> (!injected) &#123;</span><br><span class="line">        postPollEvent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面代码中重点关注的是postPollEvent：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ARTPConnection::postPollEvent() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPollEventPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatPollStreams, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">    mPollEventPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> kWhatPollStreams:</span><br><span class="line">&#123;</span><br><span class="line">    onPollStreams();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ARTPConnection::onPollStreams() &#123;</span><br><span class="line">    mPollEventPending = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStreams.empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    tv.tv_sec = <span class="number">0</span>;</span><br><span class="line">    tv.tv_usec = kSelectTimeoutUs;</span><br><span class="line"></span><br><span class="line">    fd_set rs;</span><br><span class="line">    FD_ZERO(&amp;rs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> maxSocket = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">         it != mStreams.end(); ++it) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*it).mIsInjected) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        FD_SET(it-&gt;mRTPSocket, &amp;rs);</span><br><span class="line">        FD_SET(it-&gt;mRTCPSocket, &amp;rs);</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;mRTPSocket &gt; maxSocket) &#123;</span><br><span class="line">            maxSocket = it-&gt;mRTPSocket;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;mRTCPSocket &gt; maxSocket) &#123;</span><br><span class="line">            maxSocket = it-&gt;mRTCPSocket;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (maxSocket == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选择一个网络请求</span></span><br><span class="line">    <span class="keyword">int</span> res = select(maxSocket + <span class="number">1</span>, &amp;rs, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//在这里接收服务器发过来的数据</span></span><br><span class="line">        List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">        <span class="keyword">while</span> (it != mStreams.end()) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((*it).mIsInjected) &#123;</span><br><span class="line">                ++it;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">status_t</span> err = OK;</span><br><span class="line">            <span class="comment">//接受从服务器发来的数据</span></span><br><span class="line">            <span class="keyword">if</span> (FD_ISSET(it-&gt;mRTPSocket, &amp;rs)) &#123;</span><br><span class="line">                <span class="comment">//调用的是status_t ARTPConnection::receive(StreamInfo *s, bool receiveRTP)</span></span><br><span class="line">                err = receive(&amp;*it, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//接受从服务器发来的数据</span></span><br><span class="line">            <span class="keyword">if</span> (err == OK &amp;&amp; FD_ISSET(it-&gt;mRTCPSocket, &amp;rs)) &#123;</span><br><span class="line">                <span class="comment">//调用的是status_t ARTPConnection::receive(StreamInfo *s, bool receiveRTP)</span></span><br><span class="line">                err = receive(&amp;*it, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ++it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> nowUs = ALooper::GetNowUs();</span><br><span class="line">    <span class="keyword">if</span> (mLastReceiverReportTimeUs &lt;= <span class="number">0</span>|| mLastReceiverReportTimeUs + <span class="number">5000000l</span>l &lt;= nowUs) &#123;</span><br><span class="line">        <span class="comment">//新建一个缓存区</span></span><br><span class="line">        sp&lt;ABuffer&gt; buffer = <span class="keyword">new</span> ABuffer(kMaxUDPSize);</span><br><span class="line">        List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">        <span class="keyword">while</span> (it != mStreams.end()) &#123;</span><br><span class="line">            StreamInfo *s = &amp;*it;</span><br><span class="line">            <span class="keyword">if</span> (s-&gt;mIsInjected) &#123;</span><br><span class="line">                ++it;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (s-&gt;mNumRTCPPacketsReceived == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// We have never received any RTCP packets on this stream,</span></span><br><span class="line">                <span class="comment">// we don't even know where to send a report.</span></span><br><span class="line">                ++it;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buffer-&gt;setRange(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; s-&gt;mSources.size(); ++i) &#123;</span><br><span class="line">                sp&lt;ARTPSource&gt; source = s-&gt;mSources.valueAt(i);</span><br><span class="line">                <span class="comment">//填充buffer</span></span><br><span class="line">                source-&gt;addReceiverReport(buffer);</span><br><span class="line">                <span class="keyword">if</span> (mFlags &amp; kRegularlyRequestFIR) &#123;</span><br><span class="line">                    source-&gt;addFIR(buffer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (buffer-&gt;size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGV(<span class="string">"Sending RR..."</span>);</span><br><span class="line">                <span class="keyword">ssize_t</span> n;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">//通過RTCPSocket發送</span></span><br><span class="line">                    n = sendto(s-&gt;mRTCPSocket, buffer-&gt;data(), buffer-&gt;size(), <span class="number">0</span>,(<span class="keyword">const</span> struct sockaddr *)&amp;s-&gt;mRemoteRTCPAddr, <span class="keyword">sizeof</span>(s-&gt;mRemoteRTCPAddr));</span><br><span class="line">                &#125; <span class="keyword">while</span> (n &lt; <span class="number">0</span> &amp;&amp; errno == EINTR);</span><br><span class="line">                CHECK_EQ(n, (<span class="keyword">ssize_t</span>)buffer-&gt;size());</span><br><span class="line">                mLastReceiverReportTimeUs = nowUs;</span><br><span class="line">            &#125;</span><br><span class="line">            ++it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mStreams.empty()) &#123;</span><br><span class="line">        postPollEvent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再onPollStreams中会阻塞监听服务器发过来的媒体数据，并调用receive对其进行处理，并定期发送RTCP消息给服务器。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> ARTPConnection::receive(StreamInfo *s, <span class="keyword">bool</span> receiveRTP) &#123;</span><br><span class="line">    </span><br><span class="line">    ALOGV(<span class="string">"receiving %s"</span>, receiveRTP ? <span class="string">"RTP"</span> : <span class="string">"RTCP"</span>);</span><br><span class="line"></span><br><span class="line">    CHECK(!s-&gt;mIsInjected);</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer = <span class="keyword">new</span> ABuffer(<span class="number">65536</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> remoteAddrLen =</span><br><span class="line">        (!receiveRTP &amp;&amp; s-&gt;mNumRTCPPacketsReceived == <span class="number">0</span>)</span><br><span class="line">            ? <span class="keyword">sizeof</span>(s-&gt;mRemoteRTCPAddr) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> nbytes;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//从服务器接收数据</span></span><br><span class="line">        nbytes = recvfrom(</span><br><span class="line">            receiveRTP ? s-&gt;mRTPSocket : s-&gt;mRTCPSocket,</span><br><span class="line">            buffer-&gt;data(),</span><br><span class="line">            buffer-&gt;capacity(),</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            remoteAddrLen &gt; <span class="number">0</span> ? (struct sockaddr *)&amp;s-&gt;mRemoteRTCPAddr : <span class="literal">NULL</span>,</span><br><span class="line">            remoteAddrLen &gt; <span class="number">0</span> ? &amp;remoteAddrLen : <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (nbytes &lt; <span class="number">0</span> &amp;&amp; errno == EINTR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ECONNRESET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buffer-&gt;setRange(<span class="number">0</span>, nbytes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGI("received %d bytes.", buffer-&gt;size());</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="comment">//解析RTP 或者 parseRTCP</span></span><br><span class="line">    <span class="keyword">if</span> (receiveRTP) &#123;</span><br><span class="line">        err = parseRTP(s, buffer);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = parseRTCP(s, buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>receive方法中会调用recvfrom。将数据从服务器中读取到缓存，并调用parseRTP或者parseRTCP对缓存中的数据进行处理</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> ARTPConnection::parseRTP(StreamInfo *s, <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *data = buffer-&gt;data();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((data[<span class="number">0</span>] &gt;&gt; <span class="number">6</span>) != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// Unsupported version.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[<span class="number">0</span>] &amp; <span class="number">0x20</span>) &#123;</span><br><span class="line">        <span class="comment">// Padding present.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">size_t</span> paddingLength = data[size - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (paddingLength + <span class="number">12</span> &gt; size) &#123;</span><br><span class="line">            <span class="comment">// If we removed this much padding we'd end up with something</span></span><br><span class="line">            <span class="comment">// that's too short to be a valid RTP header.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        size -= paddingLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numCSRCs = data[<span class="number">0</span>] &amp; <span class="number">0x0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> payloadOffset = <span class="number">12</span> + <span class="number">4</span> * numCSRCs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt; payloadOffset) &#123;</span><br><span class="line">        <span class="comment">// Not enough data to fit the basic header and all the CSRC entries.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[<span class="number">0</span>] &amp; <span class="number">0x10</span>) &#123;</span><br><span class="line">        <span class="comment">// Header eXtension present.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &lt; payloadOffset + <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="comment">// Not enough data to fit the basic header, all CSRC entries</span></span><br><span class="line">            <span class="comment">// and the first 4 bytes of the extension header.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint8_t</span> *extensionData = &amp;data[payloadOffset];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">size_t</span> extensionLength =</span><br><span class="line">            <span class="number">4</span> * (extensionData[<span class="number">2</span>] &lt;&lt; <span class="number">8</span> | extensionData[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &lt; payloadOffset + <span class="number">4</span> + extensionLength) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        payloadOffset += <span class="number">4</span> + extensionLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> srcId = u32at(&amp;data[<span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">    sp&lt;ARTPSource&gt; source = findSource(s, srcId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> rtpTime = u32at(&amp;data[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; meta = buffer-&gt;meta();</span><br><span class="line">    meta-&gt;setInt32(<span class="string">"ssrc"</span>, srcId);</span><br><span class="line">    meta-&gt;setInt32(<span class="string">"rtp-time"</span>, rtpTime);</span><br><span class="line">    meta-&gt;setInt32(<span class="string">"PT"</span>, data[<span class="number">1</span>] &amp; <span class="number">0x7f</span>);</span><br><span class="line">    meta-&gt;setInt32(<span class="string">"M"</span>, data[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    buffer-&gt;setInt32Data(u16at(&amp;data[<span class="number">2</span>]));</span><br><span class="line">    buffer-&gt;setRange(payloadOffset, size - payloadOffset);</span><br><span class="line">    <span class="comment">//这里十分重要void ARTPSource::processRTPPacket(const sp&lt;ABuffer&gt; &amp;buffer)</span></span><br><span class="line">    source-&gt;processRTPPacket(buffer);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在parsRTP中根据RTP格式对缓存区中的数据进行解析，最后调用ARTPSource::processRTPPacket进行后续处理。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTPSource.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTPSource::processRTPPacket(<span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (queuePacket(buffer) &amp;&amp; mAssembler != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mAssembler-&gt;onPacketReceived(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>processRTPPacket中调用Assembler来将数据进行重组，这里最重要的方法是assembleMore</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libstagefright\rtsp\ARTPAssembler.cpp]</span><br><span class="line"><span class="keyword">void</span> ARTPAssembler::onPacketReceived(<span class="keyword">const</span> sp&lt;ARTPSource&gt; &amp;source) &#123;</span><br><span class="line">    AssemblyStatus status;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//assembleMore</span></span><br><span class="line">        status = assembleMore(source);</span><br><span class="line">        <span class="keyword">if</span> (status == WRONG_SEQUENCE_NUMBER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFirstFailureTimeUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ALooper::GetNowUs() - mFirstFailureTimeUs &gt; <span class="number">10000l</span>l) &#123;</span><br><span class="line">                    mFirstFailureTimeUs = <span class="number">-1</span>;</span><br><span class="line">                    <span class="comment">// LOG(VERBOSE) &lt;&lt; "waited too long for packet.";</span></span><br><span class="line">                    packetLost();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mFirstFailureTimeUs = ALooper::GetNowUs();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mFirstFailureTimeUs = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">if</span> (status == NOT_ENOUGH_DATA) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ARTPAssembler::AssemblyStatus AMPEG4AudioAssembler::assembleMore(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTPSource&gt; &amp;source) &#123;</span><br><span class="line">        <span class="comment">//调用addPacket</span></span><br><span class="line">    AssemblyStatus status = addPacket(source);</span><br><span class="line">    <span class="keyword">if</span> (status == MALFORMED_PACKET) &#123;</span><br><span class="line">        mAccessUnitDamaged = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里实际上是对无序的数据包进行排序，并调用submitAccessUnit提交AU数据。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">ARTPAssembler::AssemblyStatus AMPEG4AudioAssembler::addPacket(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTPSource&gt; &amp;source) &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;sp&lt;ABuffer&gt; &gt; *<span class="built_in">queue</span> = source-&gt;<span class="built_in">queue</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> NOT_ENOUGH_DATA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mNextExpectedSeqNoValid) &#123;</span><br><span class="line">        List&lt;sp&lt;ABuffer&gt; &gt;::iterator it = <span class="built_in">queue</span>-&gt;begin();</span><br><span class="line">        <span class="keyword">while</span> (it != <span class="built_in">queue</span>-&gt;end()) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">uint32_t</span>)(*it)-&gt;int32Data() &gt;= mNextExpectedSeqNo) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            it = <span class="built_in">queue</span>-&gt;erase(it);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;empty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> NOT_ENOUGH_DATA;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer = *<span class="built_in">queue</span>-&gt;begin();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mNextExpectedSeqNoValid) &#123;</span><br><span class="line">        mNextExpectedSeqNoValid = <span class="literal">true</span>;</span><br><span class="line">        mNextExpectedSeqNo = (<span class="keyword">uint32_t</span>)buffer-&gt;int32Data();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">uint32_t</span>)buffer-&gt;int32Data() != mNextExpectedSeqNo) &#123;</span><br><span class="line">#<span class="keyword">if</span> VERBOSE</span><br><span class="line">        LOG(VERBOSE) &lt;&lt; <span class="string">"Not the sequence number I expected"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> WRONG_SEQUENCE_NUMBER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> rtpTime;</span><br><span class="line">    CHECK(buffer-&gt;meta()-&gt;findInt32(<span class="string">"rtp-time"</span>, (<span class="keyword">int32_t</span> *)&amp;rtpTime));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提交AccessUnit</span></span><br><span class="line">    <span class="keyword">if</span> (mPackets.size() &gt; <span class="number">0</span> &amp;&amp; rtpTime != mAccessUnitRTPTime) &#123;</span><br><span class="line">        submitAccessUnit();</span><br><span class="line">    &#125;</span><br><span class="line">    mAccessUnitRTPTime = rtpTime;</span><br><span class="line">    <span class="comment">//将缓存添加到mPackets</span></span><br><span class="line">    mPackets.push_back(buffer);</span><br><span class="line">    <span class="built_in">queue</span>-&gt;erase(<span class="built_in">queue</span>-&gt;begin());</span><br><span class="line">    ++mNextExpectedSeqNo;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>submitAccessUnit中回调‘accu’，交给MyHandler处理</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AMPEG4AudioAssembler::submitAccessUnit() &#123;</span><br><span class="line">    CHECK(!mPackets.empty());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> VERBOSE</span></span><br><span class="line">    LOG(VERBOSE) &lt;&lt; <span class="string">"Access unit complete ("</span> &lt;&lt; mPackets.size() &lt;&lt; <span class="string">" packets)"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit = MakeCompoundFromPackets(mPackets);</span><br><span class="line">    accessUnit = removeLATMFraming(accessUnit);</span><br><span class="line">    CopyTimes(accessUnit, *mPackets.begin());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAccessUnitDamaged) &#123;</span><br><span class="line">        accessUnit-&gt;meta()-&gt;setInt32(<span class="string">"damaged"</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPackets.clear();</span><br><span class="line">    mAccessUnitDamaged = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//回调‘accu’</span></span><br><span class="line">    sp&lt;AMessage&gt; msg = mNotifyMsg-&gt;dup();</span><br><span class="line">    msg-&gt;setBuffer(<span class="string">"access-unit"</span>, accessUnit);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case 'accu':</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> timeUpdate;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"time-update"</span>, &amp;timeUpdate) &amp;&amp; timeUpdate) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> trackIndex;</span><br><span class="line">        CHECK(msg-&gt;findSize(<span class="string">"track-index"</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> rtpTime;</span><br><span class="line">        <span class="keyword">uint64_t</span> ntpTime;</span><br><span class="line">        CHECK(msg-&gt;findInt32(<span class="string">"rtp-time"</span>, (<span class="keyword">int32_t</span> *)&amp;rtpTime));</span><br><span class="line">        CHECK(msg-&gt;findInt64(<span class="string">"ntp-time"</span>, (<span class="keyword">int64_t</span> *)&amp;ntpTime));</span><br><span class="line"></span><br><span class="line">        onTimeUpdate(trackIndex, rtpTime, ntpTime);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> first;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"first-rtcp"</span>, &amp;first)) &#123;</span><br><span class="line">        mReceivedFirstRTCPPacket = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"first-rtp"</span>, &amp;first)) &#123;</span><br><span class="line">        mReceivedFirstRTPPacket = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ++mNumAccessUnitsReceived;</span><br><span class="line">    postAccessUnitTimeoutCheck();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> trackIndex;</span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"track-index"</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (trackIndex &gt;= mTracks.size()) &#123;</span><br><span class="line">        ALOGV(<span class="string">"late packets ignored."</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> eos;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;findInt32(<span class="string">"eos"</span>, &amp;eos)) &#123;</span><br><span class="line">        ALOGI(<span class="string">"received BYE on track index %zu"</span>, trackIndex);</span><br><span class="line">        <span class="keyword">if</span> (!mAllTracksHaveTime &amp;&amp; dataReceivedOnAllChannels()) &#123;</span><br><span class="line">            ALOGI(<span class="string">"No time established =&gt; fake existing data"</span>);</span><br><span class="line"></span><br><span class="line">            track-&gt;mEOSReceived = <span class="literal">true</span>;</span><br><span class="line">            mTryFakeRTCP = <span class="literal">true</span>;</span><br><span class="line">            mReceivedFirstRTCPPacket = <span class="literal">true</span>;</span><br><span class="line">            fakeTimestamps();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            postQueueEOS(trackIndex, ERROR_END_OF_STREAM);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    <span class="comment">//取出accessUnit</span></span><br><span class="line">    CHECK(msg-&gt;findBuffer(<span class="string">"access-unit"</span>, &amp;accessUnit));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> seqNum = (<span class="keyword">uint32_t</span>)accessUnit-&gt;int32Data();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSeekPending) &#123;</span><br><span class="line">        ALOGV(<span class="string">"we're seeking, dropping stale packet."</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seqNum &lt; track-&gt;mFirstSeqNumInSegment) &#123;</span><br><span class="line">        ALOGV(<span class="string">"dropping stale access-unit (%d &lt; %d)"</span>,</span><br><span class="line">             seqNum, track-&gt;mFirstSeqNumInSegment);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (track-&gt;mNewSegment) &#123;</span><br><span class="line">        track-&gt;mNewSegment = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//调用onAccessUnitComplete</span></span><br><span class="line">    onAccessUnitComplete(trackIndex, accessUnit);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‘accu’取出AU数据后调用onAccessUnitComplete进行处理，我们接下来看下这部分逻辑：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onAccessUnitComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int32_t</span> trackIndex, <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;accessUnit)</span> </span>&#123;</span><br><span class="line">    ALOGV(<span class="string">"onAccessUnitComplete track %d"</span>, trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!mPlayResponseParsed)&#123;</span><br><span class="line">        ALOGI(<span class="string">"play response is not parsed, storing accessunit"</span>);</span><br><span class="line">        TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line">        track-&gt;mPackets.push_back(accessUnit);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handleFirstAccessUnit();</span><br><span class="line"></span><br><span class="line">    TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mAllTracksHaveTime) &#123;</span><br><span class="line">        ALOGV(<span class="string">"storing accessUnit, no time established yet"</span>);</span><br><span class="line">        track-&gt;mPackets.push_back(accessUnit);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!track-&gt;mPackets.empty()) &#123;</span><br><span class="line">        sp&lt;ABuffer&gt; accessUnit = *track-&gt;mPackets.begin();</span><br><span class="line">        track-&gt;mPackets.erase(track-&gt;mPackets.begin());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (addMediaTimestamp(trackIndex, track, accessUnit)) &#123;</span><br><span class="line">            <span class="comment">//postQueueAccessUnit</span></span><br><span class="line">            postQueueAccessUnit(trackIndex, accessUnit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addMediaTimestamp(trackIndex, track, accessUnit)) &#123;</span><br><span class="line">        postQueueAccessUnit(trackIndex, accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (track-&gt;mEOSReceived) &#123;</span><br><span class="line">        postQueueEOS(trackIndex, ERROR_END_OF_STREAM);</span><br><span class="line">        track-&gt;mEOSReceived = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">postQueueAccessUnit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">size_t</span> trackIndex, <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;accessUnit)</span> </span>&#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = mNotify-&gt;dup();</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"what"</span>, kWhatAccessUnit);</span><br><span class="line">    msg-&gt;setSize(<span class="string">"trackIndex"</span>, trackIndex);</span><br><span class="line">    msg-&gt;setBuffer(<span class="string">"accessUnit"</span>, accessUnit);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在RTSPSource中调用AnotherPacketSource queueAccessUnit(accessUnit)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MyHandler::kWhatAccessUnit:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> trackIndex;</span><br><span class="line">    CHECK(msg-&gt;findSize(<span class="string">"trackIndex"</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mTSParser == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        CHECK_LT(trackIndex, mTracks.size());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CHECK_EQ(trackIndex, <span class="number">0u</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    CHECK(msg-&gt;findBuffer(<span class="string">"accessUnit"</span>, &amp;accessUnit));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> damaged;</span><br><span class="line">    <span class="keyword">if</span> (accessUnit-&gt;meta()-&gt;findInt32(<span class="string">"damaged"</span>, &amp;damaged)</span><br><span class="line">            &amp;&amp; damaged) &#123;</span><br><span class="line">        ALOGI(<span class="string">"dropping damaged access unit."</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mTSParser != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">status_t</span> err = OK;</span><br><span class="line">        <span class="keyword">while</span> (offset + <span class="number">188</span> &lt;= accessUnit-&gt;size()) &#123;</span><br><span class="line">            err = mTSParser-&gt;feedTSPacket(</span><br><span class="line">                    accessUnit-&gt;data() + offset, <span class="number">188</span>);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            offset += <span class="number">188</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (offset &lt; accessUnit-&gt;size()) &#123;</span><br><span class="line">            err = ERROR_MALFORMED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; source = getSource(<span class="literal">false</span> <span class="comment">/* audio */</span>);</span><br><span class="line">            <span class="keyword">if</span> (source != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                source-&gt;signalEOS(err);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            source = getSource(<span class="literal">true</span> <span class="comment">/* audio */</span>);</span><br><span class="line">            <span class="keyword">if</span> (source != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                source-&gt;signalEOS(err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TrackInfo *info = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    sp&lt;AnotherPacketSource&gt; source = info-&gt;mSource;</span><br><span class="line">    <span class="keyword">if</span> (source != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> rtpTime;</span><br><span class="line">        CHECK(accessUnit-&gt;meta()-&gt;findInt32(<span class="string">"rtp-time"</span>, (<span class="keyword">int32_t</span> *)&amp;rtpTime));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!info-&gt;mNPTMappingValid) &#123;</span><br><span class="line">            <span class="comment">// This is a live stream, we didn't receive any normal</span></span><br><span class="line">            <span class="comment">// playtime mapping. We won't map to npt time.</span></span><br><span class="line">            source-&gt;queueAccessUnit(accessUnit);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int64_t</span> nptUs =</span><br><span class="line">            ((<span class="keyword">double</span>)rtpTime - (<span class="keyword">double</span>)info-&gt;mRTPTime)</span><br><span class="line">                / info-&gt;mTimeScale</span><br><span class="line">                * <span class="number">1000000l</span>l</span><br><span class="line">                + info-&gt;mNormalPlaytimeUs;</span><br><span class="line"></span><br><span class="line">        accessUnit-&gt;meta()-&gt;setInt64(<span class="string">"timeUs"</span>, nptUs);</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">        source-&gt;queueAccessUnit(accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>queueAccessUnit(accessUnit);将AU数据存放到AnotherPacketSource 的mBuffers中供解码器解码播放：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AnotherPacketSource::queueAccessUnit(<span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> damaged;</span><br><span class="line">    ......</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    mBuffers.push_back(buffer);</span><br><span class="line">    mCondition.signal();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> discontinuity;</span><br><span class="line">    <span class="keyword">if</span> (buffer-&gt;meta()-&gt;findInt32(<span class="string">"discontinuity"</span>, &amp;discontinuity))&#123;</span><br><span class="line">        ALOGV(<span class="string">"queueing a discontinuity with queueAccessUnit"</span>);</span><br><span class="line"></span><br><span class="line">        mLastQueuedTimeUs = <span class="number">0l</span>l;</span><br><span class="line">        mEOSResult = OK;</span><br><span class="line">        mLatestEnqueuedMeta = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        mDiscontinuitySegments.push_back(DiscontinuitySegment());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int64_t</span> lastQueuedTimeUs;</span><br><span class="line">    CHECK(buffer-&gt;meta()-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;lastQueuedTimeUs));</span><br><span class="line">    mLastQueuedTimeUs = lastQueuedTimeUs;</span><br><span class="line">    ALOGV(<span class="string">"queueAccessUnit timeUs=%"</span> PRIi64 <span class="string">" us (%.2f secs)"</span>,</span><br><span class="line">            mLastQueuedTimeUs, mLastQueuedTimeUs / <span class="number">1E6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CHECK(!mDiscontinuitySegments.empty());</span></span><br><span class="line">    DiscontinuitySegment &amp;tailSeg = *(--mDiscontinuitySegments.end());</span><br><span class="line">    <span class="keyword">if</span> (lastQueuedTimeUs &gt; tailSeg.mMaxEnqueTimeUs) &#123;</span><br><span class="line">        tailSeg.mMaxEnqueTimeUs = lastQueuedTimeUs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (tailSeg.mMaxDequeTimeUs == <span class="number">-1</span>) &#123;</span><br><span class="line">        tailSeg.mMaxDequeTimeUs = lastQueuedTimeUs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mLatestEnqueuedMeta == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mLatestEnqueuedMeta = buffer-&gt;meta()-&gt;dup();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> latestTimeUs = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int64_t</span> frameDeltaUs = <span class="number">0</span>;</span><br><span class="line">        CHECK(mLatestEnqueuedMeta-&gt;findInt64(<span class="string">"timeUs"</span>, &amp;latestTimeUs));</span><br><span class="line">        <span class="keyword">if</span> (lastQueuedTimeUs &gt; latestTimeUs) &#123;</span><br><span class="line">            mLatestEnqueuedMeta = buffer-&gt;meta()-&gt;dup();</span><br><span class="line">            frameDeltaUs = lastQueuedTimeUs - latestTimeUs;</span><br><span class="line">            mLatestEnqueuedMeta-&gt;setInt64(<span class="string">"durationUs"</span>, frameDeltaUs);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mLatestEnqueuedMeta-&gt;findInt64(<span class="string">"durationUs"</span>, &amp;frameDeltaUs)) &#123;</span><br><span class="line">            <span class="comment">// For B frames</span></span><br><span class="line">            frameDeltaUs = latestTimeUs - lastQueuedTimeUs;</span><br><span class="line">            mLatestEnqueuedMeta-&gt;setInt64(<span class="string">"durationUs"</span>, frameDeltaUs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-4、获取数据进行编码（请参考前面HLS小节分析）"><a href="#3-4、获取数据进行编码（请参考前面HLS小节分析）" class="headerlink" title="3.4、获取数据进行编码（请参考前面HLS小节分析）"></a>3.4、获取数据进行编码（请参考前面HLS小节分析）</h5><h5 id="3-5、播放流程（请参考前面HLS小节分析）"><a href="#3-5、播放流程（请参考前面HLS小节分析）" class="headerlink" title="3.5、播放流程（请参考前面HLS小节分析）"></a>3.5、播放流程（请参考前面HLS小节分析）</h5><h4 id="（四）、参考资料-特别感谢各位前辈的分析和图示-："><a href="#（四）、参考资料-特别感谢各位前辈的分析和图示-：" class="headerlink" title="（四）、参考资料(特别感谢各位前辈的分析和图示)："></a>（四）、参考资料(特别感谢各位前辈的分析和图示)：</h4><p><a href="https://blog.csdn.net/dfhuang09/article/details/54926526" target="_blank" rel="noopener">android ACodec MediaCodec NuPlayer flow - CSDN博客</a><br><a href="https://blog.csdn.net/dfhuang09/article/details/60132620" target="_blank" rel="noopener">android MediaCodec ACodec - CSDN博客</a><br><a href="https://tbfungeek.github.io/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">Android 源码分析之基于NuPlayer的HLS流媒体协议</a><br><a href="https://tbfungeek.github.io/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">Android 源码分析之基于NuPlayer的RTSP流媒体协议</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">๑Charles✦ˑ̫✦Vincent๑</a> copyright, if reproduced, please indicate the source：๑Charles✦ˑ̫✦Vincent๑（<a href="http://zhoujinjian.cc/2018/09/17/Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议/">http://zhoujinjian.cc/2018/09/17/Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2018/09/12/Android Video System（5）：Android Multimedia - NuPlayer音视频同步实现分析/" title="Android Video System（5）：Android Multimedia - NuPlayer音视频同步实现分析"><i class="iconfont icon-prev"></i>Android Video System（5）：Android Multimedia - NuPlayer音视频同步实现分析</a></div><div class="post__prev post__prev--right"><a href="/2088/08/08/zhoujinjian.cc-Android系列分析文档【🌀置顶🌀】/" title="zhoujinjian.cc-Android系列分析文档【🌀置顶🌀】">zhoujinjian.cc-Android系列分析文档【🌀置顶🌀】<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">嘿嘿(๑乛◡乛๑),但这也是无可奈何的事情，毕竟世上不可能有那么多十全十美的好事，做人在某些时候总是要有些取舍的。</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">26</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/zhoujinjian.cc-Android系列分析文档【🌀置顶🌀】/" title="zhoujinjian.cc-Android系列分析文档【🌀置顶🌀】"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.08.jpg" alt="zhoujinjian.cc-Android系列分析文档【🌀置顶🌀】"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Android系列分析文档【🌀置顶🌀】</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/17/Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议/" title="Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.27.jpg" alt="Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议"></div><div class="item__info"><h3 class="item__title">Android Video System（6）：Android Multimedia - NuPlayer HLS流媒体协议、RTSP流媒体协议</h3><span class="item__text">2018-09-17</span></div></a></li><li class="latest-post-item"><a href="/2018/09/12/Android Video System（5）：Android Multimedia - NuPlayer音视频同步实现分析/" title="Android Video System（5）：Android Multimedia - NuPlayer音视频同步实现分析"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.26.jpg" alt="Android Video System（5）：Android Multimedia - NuPlayer音视频同步实现分析"></div><div class="item__info"><h3 class="item__title">Android Video System（5）：Android Multimedia - NuPlayer音视频同步实现分析</h3><span class="item__text">2018-09-12</span></div></a></li><li class="latest-post-item"><a href="/2018/09/06/Android Video System（4）：Android Multimedia - OpenMax实现分析/" title="Android Video System（4）：Android Multimedia - OpenMax实现分析"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.25.jpg" alt="Android Video System（4）：Android Multimedia - OpenMax实现分析"></div><div class="item__info"><h3 class="item__title">Android Video System（4）：Android Multimedia - OpenMax实现分析</h3><span class="item__text">2018-09-06</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">开始的开始亦是结束•结束的结束亦是开始</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>izhoujinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="๑Charles✦ˑ̫✦Vincent๑"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZのBlog" target="_blank">MARKSZのBlog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="๑Charles✦ˑ̫✦Vincent๑" target="_blank">๑Charles✦ˑ̫✦Vincent๑</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">๑Charles✦ˑ̫✦Vincent๑</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:izhoujinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>🍀<span class="post-count">368.9k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">👽<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">🌀<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>