<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~] | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/04/01/Linuxå†…æ ¸ï¼ˆKernel-3-18ï¼‰-Input-å­ç³»ç»Ÿåˆ†æ-i-wonder/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.09.jpg" alt="Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]"></div><header class="post__info"><h1 class="post__title">Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="http://zhoujinjian.cc/">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘.</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-04-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€Linux-Input-å­ç³»ç»Ÿæ¡†æ¶"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€Linux Input å­ç³»ç»Ÿæ¡†æ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€Input-ä¸»è¦é€šç”¨æ•°æ®ç»“æ„"><span class="toc-text">ï¼ˆäºŒï¼‰ã€Input ä¸»è¦é€šç”¨æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1ã€input-dev"><span class="toc-text">2.1ã€input_dev</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1ã€input-handler"><span class="toc-text">2.1ã€input_handler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3ã€input-handle"><span class="toc-text">2.3ã€input_handle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»"><span class="toc-text">2.4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€Input-æ ¸å¿ƒå±‚ï¼ˆInput-cï¼‰"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€Input æ ¸å¿ƒå±‚ï¼ˆInput.cï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–"><span class="toc-text">3.1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input-dev"><span class="toc-text">3.2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input_dev</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handler"><span class="toc-text">3.3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰"><span class="toc-text">3.4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆå››ï¼‰ã€Input-äº‹ä»¶å¤„ç†å±‚-Event-handler-ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰"><span class="toc-text">ï¼ˆå››ï¼‰ã€Input äº‹ä»¶å¤„ç†å±‚ Event handler ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1ã€ä¸»è¦æ•°æ®ç»“æ„"><span class="toc-text">4.1ã€ä¸»è¦æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2ã€äº‹ä»¶å¤„ç†å±‚evdev"><span class="toc-text">4.2ã€äº‹ä»¶å¤„ç†å±‚evdev</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open-æ“ä½œ"><span class="toc-text">4.3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open()æ“ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°"><span class="toc-text">4.4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäº”ï¼‰ã€Input-äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹"><span class="toc-text">ï¼ˆäº”ï¼‰ã€Input äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1ã€Input-äº‹ä»¶äº§ç”Ÿ"><span class="toc-text">5.1ã€Input äº‹ä»¶äº§ç”Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2ã€Input-äº‹ä»¶æŠ¥å‘Š"><span class="toc-text">5.2ã€Input äº‹ä»¶æŠ¥å‘Š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆå…­ï¼‰ã€Android-Inputå­ç³»ç»Ÿ"><span class="toc-text">ï¼ˆå…­ï¼‰ã€Android Inputå­ç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸ƒï¼‰ã€Input-è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰"><span class="toc-text">ï¼ˆä¸ƒï¼‰ã€Input è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1ã€åˆ†é…Input-devç»“æ„ä½“"><span class="toc-text">7.1ã€åˆ†é…Input_devç»“æ„ä½“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-1ã€synaptics-rmi4-f12-init"><span class="toc-text">7.1.1ã€synaptics_rmi4_f12_init()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-2ã€synaptics-rmi4-probe"><span class="toc-text">7.1.2ã€synaptics_rmi4_probe()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-3ã€åˆ†é…Input-devç»“æ„ä½“"><span class="toc-text">7.1.3ã€åˆ†é…Input_devç»“æ„ä½“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹-set-bit-EV-SYN-evbit-ã€set-bit-EV-KEY-evbit-ã€set-bit-EV-ABS-evbit-â€¦â€¦"><span class="toc-text">7.2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹ set_bit(EV_SYN, evbit)ã€set_bit(EV_KEY, evbit)ã€set_bit(EV_ABS,evbit) â€¦â€¦</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3ã€æ³¨å†Œè®¾å¤‡input-register-device"><span class="toc-text">7.3ã€æ³¨å†Œè®¾å¤‡input_register_device()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ"><span class="toc-text">7.4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š"><span class="toc-text">7.4.1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/linux.input" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p>æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</p><p><strong>kernel/msm-3.18/include/linux</strong></p><ul><li>Input.h</li><li>evdev.h</li></ul><p><strong>kernel/msm-3.18/drivers/input</strong></p><ul><li>Input.c</li><li>evdev.c</li><li>gpio_keys.c</li></ul><p><strong>kernel/msm-3.18/drivers/input/touchscreen/synaptics_dsx_htc_2.6</strong></p><ul><li>Makefile</li><li>Kconfig</li><li>synaptics_dsx_core.c</li></ul><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/linux.input" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆKernel-3.18ï¼‰ï¼š</p><p><a href="https://android.googlesource.com/kernel/msm/+/android-msm-marlin-3.18-nougat-mr2-pixel" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - Google</a> <a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><hr><h2 id="ï¼ˆä¸€ï¼‰ã€Linux-Input-å­ç³»ç»Ÿæ¡†æ¶"><a href="#ï¼ˆä¸€ï¼‰ã€Linux-Input-å­ç³»ç»Ÿæ¡†æ¶" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Linux Input å­ç³»ç»Ÿæ¡†æ¶"></a>ï¼ˆä¸€ï¼‰ã€Linux Input å­ç³»ç»Ÿæ¡†æ¶</h2><p>è¾“å…¥(Input)å­ç³»ç»Ÿæ˜¯åˆ†å±‚æ¶æ„çš„ï¼Œæ€»å…±åˆ†ä¸º5 å±‚ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯ï¼šç”¨æˆ·ç©ºé—´å±‚ï¼ˆUser Spaceï¼‰äº‹ä»¶å¤„ç†å±‚(Event Handler)ã€è¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒå±‚(Input Core)ã€ç¡¬ä»¶é©±åŠ¨å±‚(Input Driver) ã€ç¡¬ä»¶è®¾å¤‡å±‚ï¼ˆHardwareï¼‰ã€‚</p><p>é©±åŠ¨æ ¹æ®COREæä¾›çš„æ¥å£ï¼Œå‘ä¸ŠæŠ¥å‘Šå‘ç”Ÿçš„æŒ‰é”®åŠ¨ä½œã€‚ç„¶åCOREæ ¹æ®é©±åŠ¨çš„ç±»å‹ï¼Œåˆ†æ´¾è¿™ä¸ªæŠ¥å‘Šç»™å¯¹åº”çš„äº‹ä»¶å¤„ç†å±‚è¿›è¡Œå¤„ç†ã€‚äº‹ä»¶å¤„ç†å±‚æŠŠæ•°æ®å˜åŒ–ååº”åˆ°è®¾å¤‡æ¨¡å‹çš„æ–‡ä»¶ä¸­ï¼ˆäº‹ä»¶ç¼“å†²åŒºï¼‰ã€‚å¹¶é€šçŸ¥åœ¨è¿™äº›è®¾å¤‡æ¨¡å‹æ–‡ä»¶ä¸Šç­‰å¾…çš„è¿›ç¨‹ã€‚</p><p>inputå­ç³»ç»Ÿæ¡†æ¶ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/01-Linux-kernel-input-subsystem-framework.png" alt="Markdown"></p><p>(1) â€œç¡¬ä»¶é©±åŠ¨å±‚â€è´Ÿè´£æ“ä½œå…·ä½“çš„ç¡¬ä»¶è®¾å¤‡ï¼Œè¿™å±‚çš„ä»£ç æ˜¯é’ˆå¯¹å…·ä½“çš„é©±åŠ¨ç¨‹åºçš„ï¼Œæ¯”å¦‚ä½ çš„è®¾å¤‡æ˜¯è§¦æ‘¸è¾“å…¥è®¾å¤‡ï¼Œè¿˜æ˜¯é¼ æ ‡è¾“å…¥è®¾å¤‡ï¼Œè¿˜æ˜¯é”®ç›˜è¾“å…¥è®¾å¤‡ï¼Œè¿™äº›ä¸åŒçš„è®¾å¤‡ï¼Œè‡ªç„¶æœ‰ä¸åŒçš„ç¡¬ä»¶æ“ä½œï¼Œé©±åŠ¨å·¥ç¨‹å¸ˆå¾€å¾€åªéœ€è¦å®Œæˆè¿™å±‚çš„ä»£ç ç¼–å†™ã€‚</p><p>(2) â€œè¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒå±‚â€æ˜¯é“¾æ¥å…¶ä»–ä¸¤å±‚ä¹‹é—´çš„çº½å¸¦ä¸æ¡¥æ¢ï¼Œå‘ä¸‹æä¾›ç¡¬ä»¶é©±åŠ¨å±‚çš„æ¥å£ï¼Œå‘ä¸Šæä¾›äº‹ä»¶å¤„ç†å±‚çš„æ¥å£ã€‚</p><p>(3) â€œäº‹ä»¶å¤„ç†å±‚â€ è´Ÿè´£ä¸ç”¨æˆ·ç¨‹åºæ‰“äº¤é“ï¼Œå°†ç¡¬ä»¶é©±åŠ¨å±‚ä¼ æ¥çš„äº‹ä»¶æŠ¥å‘Šç»™ç”¨æˆ·ç¨‹åºã€‚</p><p>å„å±‚ä¹‹é—´é€šä¿¡çš„åŸºæœ¬å•ä½å°±æ˜¯äº‹ä»¶ï¼Œä»»ä½•ä¸€ä¸ªè¾“å…¥è®¾å¤‡çš„åŠ¨ä½œéƒ½å¯ä»¥æŠ½è±¡æˆä¸€ç§äº‹ä»¶ï¼Œå¦‚é”®ç›˜çš„æŒ‰ä¸‹ï¼Œè§¦æ‘¸å±çš„æŒ‰ä¸‹ï¼Œé¼ æ ‡çš„ç§»åŠ¨ç­‰ã€‚äº‹ä»¶æœ‰ä¸‰ç§å±æ€§ï¼šç±»å‹ï¼ˆtypeï¼‰ï¼Œç¼–ç (code)ï¼Œå€¼(value)ï¼Œ Input å­ç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰äº‹ä»¶éƒ½å®šä¹‰åœ¨ input.hä¸­ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ”¯æŒçš„ç±»å‹ï¼Œæ‰€å±ç±»å‹æ”¯æŒçš„ç¼–ç ç­‰ã€‚äº‹ä»¶ä¼ é€çš„æ–¹å‘æ˜¯ ç¡¬ä»¶é©±åŠ¨å±‚â€“&gt;å­ç³»ç»Ÿæ ¸å¿ƒâ€“&gt;äº‹ä»¶å¤„ç†å±‚â€“&gt;ç”¨æˆ·ç©ºé—´ã€‚</p><h2 id="ï¼ˆäºŒï¼‰ã€Input-ä¸»è¦é€šç”¨æ•°æ®ç»“æ„"><a href="#ï¼ˆäºŒï¼‰ã€Input-ä¸»è¦é€šç”¨æ•°æ®ç»“æ„" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Input ä¸»è¦é€šç”¨æ•°æ®ç»“æ„"></a>ï¼ˆäºŒï¼‰ã€Input ä¸»è¦é€šç”¨æ•°æ®ç»“æ„</h2><h2 id="2-1ã€input-dev"><a href="#2-1ã€input-dev" class="headerlink" title="2.1ã€input_dev"></a>2.1ã€input_dev</h2><p>è¾“å…¥è®¾å¤‡ input_devï¼Œè¿™æ˜¯inputè®¾å¤‡åŸºæœ¬çš„è®¾å¤‡ç»“æ„ï¼Œæ¯ä¸ªinputé©±åŠ¨ç¨‹åºä¸­éƒ½å¿…é¡»åˆ†é…åˆå§‹åŒ–è¿™æ ·ä¸€ä¸ªç»“æ„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;    <span class="comment">//è¾“å…¥è®¾å¤‡çš„åç§°  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *phys;    <span class="comment">//è¾“å…¥è®¾å¤‡èŠ‚ç‚¹åç§°  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *uniq;    <span class="comment">//æŒ‡å®šå”¯ä¸€çš„IDå·ï¼Œå°±åƒMACåœ°å€ä¸€æ ·</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_id</span> <span class="title">id</span>;</span>    <span class="comment">//è¾“å…¥è®¾å¤‡æ ‡è¯†IDï¼Œç”¨äºå’Œäº‹ä»¶å¤„ç†å±‚è¿›è¡ŒåŒ¹é…</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> propbit[BITS_TO_LONGS(INPUT_PROP_CNT)];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> evbit[BITS_TO_LONGS(EV_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> keybit[BITS_TO_LONGS(KEY_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„æŒ‰é”®ç±»å‹      </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> relbit[BITS_TO_LONGS(REL_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„ç›¸å¯¹åæ ‡  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> absbit[BITS_TO_LONGS(ABS_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„ç»å¯¹åæ ‡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> mscbit[BITS_TO_LONGS(MSC_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„å…¶ä»–åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ledbit[BITS_TO_LONGS(LED_CNT)];    <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„æŒ‡ç¤ºç¯</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sndbit[BITS_TO_LONGS(SND_CNT)];   <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„å£°éŸ³æˆ–è­¦æŠ¥</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ffbit[BITS_TO_LONGS(FF_CNT)];     <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„ä½œç”¨åŠ›åŠŸèƒ½  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> swbit[BITS_TO_LONGS(SW_CNT)];     <span class="comment">//ä½å›¾ï¼Œè®°å½•è®¾å¤‡æ”¯æŒçš„å¼€å…³åŠŸèƒ½</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hint_events_per_packet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> keycodemax;      <span class="comment">//è®¾å¤‡æ”¯æŒçš„æœ€å¤§æŒ‰é”®å€¼ä¸ªæ•°  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> keycodesize;    <span class="comment">//æ¯ä¸ªæŒ‰é”®çš„å­—èŠ‚å¤§å°</span></span><br><span class="line">    <span class="keyword">void</span> *keycode;      <span class="comment">//æŒ‡å‘æŒ‰é”®æ± ï¼Œå³æŒ‡å‘æŒ‰é”®å€¼æ•°ç»„é¦–åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*setkeycode)(struct input_dev *dev,</span><br><span class="line">              <span class="keyword">const</span> struct input_keymap_entry *ke,</span><br><span class="line">              <span class="keyword">unsigned</span> <span class="keyword">int</span> *old_keycode);    <span class="comment">//ä¿®æ”¹æŒ‰é”®å€¼</span></span><br><span class="line">    <span class="keyword">int</span> (*getkeycode)(struct input_dev *dev,</span><br><span class="line">              struct input_keymap_entry *ke);   <span class="comment">//è·å–æŒ‰é”®å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ff_device</span> *<span class="title">ff</span>;</span>     <span class="comment">//ç”¨äºå¼ºåˆ¶æ›´æ–°è¾“å…¥è®¾å¤‡çš„éƒ¨åˆ†å†…å®¹  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> repeat_key;    <span class="comment">//é‡å¤æŒ‰é”®çš„é”®å€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">timer</span>;</span>   <span class="comment">//è®¾ç½®å½“æœ‰è¿å‡»æ—¶çš„å»¶æ—¶å®šæ—¶å™¨  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rep[REP_CNT];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_mt</span> *<span class="title">mt</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_absinfo</span> *<span class="title">absinfo</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> key[BITS_TO_LONGS(KEY_CNT)];    <span class="comment">//ä½å›¾ï¼ŒæŒ‰é”®çš„çŠ¶æ€  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> led[BITS_TO_LONGS(LED_CNT)];    <span class="comment">//ä½å›¾ï¼Œledçš„çŠ¶æ€  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> snd[BITS_TO_LONGS(SND_CNT)];    <span class="comment">//ä½å›¾ï¼Œå£°éŸ³çš„çŠ¶æ€  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sw[BITS_TO_LONGS(SW_CNT)];   <span class="comment">//ä½å›¾ï¼Œå¼€å…³çš„çŠ¶æ€  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*open)(struct input_dev *dev);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct input_dev *dev);</span><br><span class="line">    <span class="keyword">int</span> (*flush)(struct input_dev *dev, struct file *file);</span><br><span class="line">    <span class="keyword">int</span> (*event)(struct input_dev *dev, <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> __<span class="title">rcu</span> *<span class="title">grab</span>;</span> <span class="comment">//ç±»ä¼¼ç§æœ‰æŒ‡é’ˆï¼Œå¯ä»¥ç›´æ¥è®¿é—®åˆ°äº‹ä»¶å¤„ç†æ¥å£event  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">spinlock_t</span> event_lock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> users;</span><br><span class="line">    <span class="keyword">bool</span> going_away;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">h_list</span>;</span> <span class="comment">//è¯¥é“¾è¡¨å¤´ç”¨äºé“¾æ¥æ­¤è®¾å¤‡æ‰€å…³è”çš„input_handle   </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">node</span>;</span> <span class="comment">//ç”¨äºå°†æ­¤è®¾å¤‡é“¾æ¥åˆ°input_dev_list(é“¾æ¥äº†æ‰€æœ‰æ³¨å†Œåˆ°å†…æ ¸çš„äº‹ä»¶å¤„ç†å™¨)  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_vals;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> max_vals;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">vals</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> devres_managed;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2-1ã€input-handler"><a href="#2-1ã€input-handler" class="headerlink" title="2.1ã€input_handler"></a>2.1ã€input_handler</h2><p>input_handler è¿™æ˜¯äº‹ä»¶å¤„ç†å™¨çš„æ•°æ®ç»“æ„ï¼Œä»£è¡¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line">    <span class="comment">/* å½“äº‹ä»¶å¤„ç†å™¨æ¥æ”¶åˆ°æ¥è‡ªInputè®¾å¤‡ä¼ æ¥çš„äº‹ä»¶æ—¶è°ƒç”¨çš„å¤„ç†å‡½æ•°,</span></span><br><span class="line"><span class="comment">        eventã€eventsç”¨äºå¤„ç†äº‹ä»¶ */</span>  </span><br><span class="line">    <span class="keyword">void</span> (*event)(struct input_handle *handle, <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value);</span><br><span class="line">    <span class="keyword">void</span> (*events)(struct input_handle *handle,</span><br><span class="line">               <span class="keyword">const</span> struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">bool</span> (*filter)(struct input_handle *handle, <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value);</span><br><span class="line">    <span class="comment">/* æ¯”è¾ƒ device's id with handler's id_table ï¼ŒåŒ¹é…device and handler*/</span></span><br><span class="line">    <span class="keyword">bool</span> (*match)(struct input_handler *handler, struct input_dev *dev);</span><br><span class="line">    <span class="comment">/* connectç”¨äºå»ºç«‹intput_handlerå’Œinput_devçš„è”ç³»,</span></span><br><span class="line"><span class="comment">       å½“ä¸€ä¸ªInputè®¾å¤‡æ³¨å†Œåˆ°å†…æ ¸çš„æ—¶å€™è¢«è°ƒç”¨,å°†è¾“å…¥è®¾å¤‡ä¸äº‹ä»¶å¤„ç†å™¨è”ç»“èµ·æ¥ */</span></span><br><span class="line">    <span class="keyword">int</span> (*connect)(struct input_handler *handler, struct input_dev *dev, <span class="keyword">const</span> struct input_device_id *id);</span><br><span class="line">    <span class="comment">/* disconnectç”¨äºè§£é™¤handlerå’Œdeviceçš„è”ç³» */</span></span><br><span class="line">    <span class="keyword">void</span> (*disconnect)(struct input_handle *handle);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct input_handle *handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> legacy_minors;</span><br><span class="line">    <span class="keyword">int</span> minor;    <span class="comment">//æ¬¡è®¾å¤‡å·</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;    <span class="comment">//æ¬¡è®¾å¤‡å·</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id_table</span>;</span>    <span class="comment">//ç”¨äºå’ŒdeviceåŒ¹é… ,è¿™ä¸ªæ˜¯äº‹ä»¶å¤„ç†å™¨æ‰€æ”¯æŒçš„inputè®¾å¤‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ä¸ªé“¾è¡¨ç”¨æ¥é“¾æ¥ä»–æ‰€æ”¯æŒçš„input_handleç»“æ„,input_devä¸input_handleré…å¯¹ä¹‹åå°±ä¼šç”Ÿæˆä¸€ä¸ªinput_handleç»“æ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">h_list</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//é“¾æ¥åˆ°input_handler_listï¼Œè¿™ä¸ªé“¾è¡¨é“¾æ¥äº†æ‰€æœ‰æ³¨å†Œåˆ°å†…æ ¸çš„äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2-3ã€input-handle"><a href="#2-3ã€input-handle" class="headerlink" title="2.3ã€input_handle"></a>2.3ã€input_handle</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    æ¯ä¸ªé…å¯¹çš„äº‹ä»¶å¤„ç†å™¨éƒ½ä¼šåˆ†é…ä¸€ä¸ªå¯¹åº”çš„è®¾å¤‡ç»“æ„ï¼Œå¦‚evdeväº‹ä»¶å¤„ç†å™¨çš„evdevç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment">    æ³¨æ„è¿™ä¸ªç»“æ„ä¸è®¾å¤‡é©±åŠ¨å±‚çš„input_devä¸åŒï¼Œåˆå§‹åŒ–handleæ—¶ï¼Œä¿å­˜åˆ°è¿™é‡Œã€‚   </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    æ‰“å¼€æ ‡å¿—ï¼Œæ¯ä¸ªinput_handle æ‰“å¼€åæ‰èƒ½æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment">    è¿™ä¸ªä¸€èˆ¬é€šè¿‡äº‹ä»¶å¤„ç†å™¨çš„openæ–¹æ³•é—´æ¥è®¾ç½®  </span></span><br><span class="line"><span class="comment">    */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> open;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="comment">/* æŒ‡å‘Input_devç»“æ„å®ä½“ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="comment">/* æŒ‡å‘Input_Handerç»“æ„å®ä½“ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span>;</span></span><br><span class="line">    <span class="comment">/* input_handleé€šè¿‡d_nodeè¿æ¥åˆ°äº†input_devä¸Šçš„h_listé“¾è¡¨ä¸Š */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">d_node</span>;</span></span><br><span class="line">    <span class="comment">/* input_handleé€šè¿‡h_nodeè¿æ¥åˆ°äº†input_handlerçš„h_listé“¾è¡¨ä¸Š */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">h_node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2-4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»"><a href="#2-4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»" class="headerlink" title="2.4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»"></a>2.4ã€ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»</h2><blockquote><p>input_dev: æ˜¯ç¡¬ä»¶é©±åŠ¨å±‚ï¼Œä»£è¡¨ä¸€ä¸ªinputè®¾å¤‡ã€‚ input_handler: æ˜¯äº‹ä»¶å¤„ç†å±‚ï¼Œä»£è¡¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ã€‚ input_handle: å±äºæ ¸å¿ƒå±‚ï¼Œä»£è¡¨ä¸€ä¸ªé…å¯¹çš„input_devä¸input_handler</p></blockquote><p>input_dev é€šè¿‡å…¨å±€çš„input_dev_listé“¾æ¥åœ¨ä¸€èµ·ã€‚è®¾å¤‡æ³¨å†Œçš„æ—¶å€™å®ç°è¿™ä¸ªæ“ä½œã€‚æ³¨ï¼šï¼ˆç¨åè¯¦ç»†åˆ†æï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(input_dev_list)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(input_handler_list)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_device</span><span class="params">(struct input_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_devres</span> *<span class="title">devres</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> packet_size;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">    list_add_tail(&amp;dev-&gt;node, &amp;input_dev_list);</span><br><span class="line"></span><br><span class="line">    list_for_each_entry(handler, &amp;input_handler_list, node)</span><br><span class="line">        input_attach_handler(dev, handler);</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>input_handler é€šè¿‡å…¨å±€çš„input_handler_listé“¾æ¥åœ¨ä¸€èµ·ã€‚äº‹ä»¶å¤„ç†å™¨æ³¨å†Œçš„æ—¶å€™å®ç°è¿™ä¸ªæ“ä½œï¼ˆäº‹ä»¶å¤„ç†å™¨ä¸€èˆ¬å†…æ ¸è‡ªå¸¦ï¼Œä¸€èˆ¬ä¸éœ€è¦æˆ‘ä»¬æ¥å†™ï¼‰æ³¨ï¼šï¼ˆç¨åè¯¦ç»†åˆ†æï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(input_dev_list)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">LIST_HEAD</span><span class="params">(input_handler_list)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_handler</span><span class="params">(struct input_handler *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    ......</span><br><span class="line">    list_add_tail(&amp;handler-&gt;node, &amp;input_handler_list);</span><br><span class="line"></span><br><span class="line">    list_for_each_entry(dev, &amp;input_dev_list, node)</span><br><span class="line">        input_attach_handler(dev, handler);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>input_hande æ²¡æœ‰ä¸€ä¸ªå…¨å±€çš„é“¾è¡¨ï¼Œå®ƒæ³¨å†Œçš„æ—¶å€™å°†è‡ªå·±åˆ†åˆ«æŒ‚åœ¨äº†input_dev å’Œ input_handler çš„h_listä¸Šäº†ã€‚é€šè¿‡input_dev å’Œinput_handlerå°±å¯ä»¥æ‰¾åˆ°input_handleåœ¨è®¾å¤‡æ³¨å†Œå’Œäº‹ä»¶å¤„ç†å™¨ï¼Œæ³¨å†Œçš„æ—¶å€™éƒ½è¦è¿›è¡Œé…å¯¹å·¥ä½œ<strong>(input_match_device)</strong>ï¼Œé…å¯¹åå°±ä¼šå®ç°é“¾æ¥<strong>(handler-&gt;connect)</strong>é€šè¿‡input_handleä¹Ÿå¯ä»¥æ‰¾åˆ°input_devå’Œinput_handlerã€‚æ³¨ï¼šï¼ˆç¨åè¯¦ç»†åˆ†æï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">input_attach_handler</span><span class="params">(struct input_dev *dev, struct input_handler *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    id = input_match_device(handler, dev);</span><br><span class="line">    ......</span><br><span class="line">    error = handler-&gt;connect(handler, dev, id);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œinput_deviceå’Œinput_handlerä¸­éƒ½æœ‰ä¸€ä¸ªh_list,è€Œinput_handleæ‹¥æœ‰æŒ‡å‘input_devå’Œinput_handlerçš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´input_handleæ˜¯ç”¨æ¥å…³è”input_devå’Œinput_handlerçš„ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆä¸€ä¸ªinput_deviceå’Œinput_handlerä¸­æ‹¥æœ‰çš„æ˜¯h_listè€Œä¸æ˜¯ä¸€ä¸ªhandleå‘¢ï¼Ÿå› ä¸ºä¸€ä¸ªdeviceå¯èƒ½å¯¹åº”å¤šä¸ªhandler,è€Œä¸€ä¸ªhandlerä¹Ÿä¸èƒ½åªå¤„ç†ä¸€ä¸ªdevice,æ¯”å¦‚è¯´ä¸€ä¸ªé¼ æ ‡ï¼Œå®ƒå¯ä»¥å¯¹åº”even handlerï¼Œä¹Ÿå¯ä»¥å¯¹åº”mouse handler,å› æ­¤å½“å…¶æ³¨å†Œæ—¶ä¸ç³»ç»Ÿä¸­çš„handlerè¿›è¡ŒåŒ¹é…ï¼Œå°±æœ‰å¯èƒ½äº§ç”Ÿä¸¤ä¸ªå®ä¾‹ï¼Œä¸€ä¸ªæ˜¯evdev,å¦ä¸€ä¸ªæ˜¯mousedev,è€Œä»»ä½•ä¸€ä¸ªå®ä¾‹ä¸­éƒ½åªæœ‰ä¸€ä¸ªhandleã€‚è‡³äºä»¥ä½•ç§æ–¹å¼æ¥ä¼ é€’äº‹ä»¶ï¼Œå°±ç”±ç”¨æˆ·ç¨‹åºæ‰“å¼€å“ªä¸ªå®ä¾‹æ¥å†³å®šã€‚åé¢ä¸€ä¸ªæƒ…å†µå¾ˆå®¹æ˜“ç†è§£ï¼Œä¸€ä¸ªäº‹ä»¶é©±åŠ¨ä¸èƒ½åªä¸ºä¸€ä¸ªç”šè‡³ä¸€ç§è®¾å¤‡æœåŠ¡ï¼Œç³»ç»Ÿä¸­å¯èƒ½æœ‰å¤šç§è®¾å¤‡éƒ½èƒ½ä½¿ç”¨è¿™ç±»handler,æ¯”å¦‚event handlerå°±å¯ä»¥åŒ¹é…æ‰€æœ‰çš„è®¾å¤‡ã€‚åœ¨inputå­ç³»ç»Ÿä¸­ï¼Œæœ‰8ç§äº‹ä»¶é©±åŠ¨ï¼Œæ¯ç§äº‹ä»¶é©±åŠ¨æœ€å¤šå¯ä»¥å¯¹åº”32ä¸ªè®¾å¤‡ï¼Œå› æ­¤devå®ä¾‹æ€»æ•°æœ€å¤šå¯ä»¥è¾¾åˆ°256ä¸ªã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/02-Linux-kernel-input-dev-handler.png" alt="Markdown"></p><h2 id="ï¼ˆä¸‰ï¼‰ã€Input-æ ¸å¿ƒå±‚ï¼ˆInput-cï¼‰"><a href="#ï¼ˆä¸‰ï¼‰ã€Input-æ ¸å¿ƒå±‚ï¼ˆInput-cï¼‰" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Input æ ¸å¿ƒå±‚ï¼ˆInput.cï¼‰"></a>ï¼ˆä¸‰ï¼‰ã€Input æ ¸å¿ƒå±‚ï¼ˆInput.cï¼‰</h2><p>è¿™ä¸€èŠ‚ä¸»è¦ä»‹ç»æ ¸å¿ƒå±‚çš„åˆå§‹åŒ–ï¼Œinput_deviceã€input_handleã€input_handlerä¹‹é—´çš„å…³ç³»(ç¨åå›å¤´çœ‹æ›´ä½³)ã€‚ æ€»ä½“æ¦‚è§ˆå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/03-Linux-kernel-input-core-h_list.png" alt="Markdown"></p><h2 id="3-1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–"><a href="#3-1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–" class="headerlink" title="3.1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–"></a>3.1ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šåˆå§‹åŒ–</h2><p>é¦–å…ˆä»é©±åŠ¨â€å…¥å£å‡½æ•°â€å¼€å§‹æŸ¥çœ‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">input_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="comment">//æ³¨å†Œinputç±»ï¼Œå¯åœ¨/sys/classä¸‹çœ‹åˆ°å¯¹åº”èŠ‚ç‚¹æ–‡ä»¶</span></span><br><span class="line">    err = class_register(&amp;input_class);</span><br><span class="line">    ......</span><br><span class="line">    err = input_proc_init();<span class="comment">/*åˆ›å»º/procä¸­çš„é¡¹ï¼ŒæŸ¥çœ‹/proc/bus/input  */</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/*æ³¨å†Œè®¾å¤‡/dev/inputï¼Œä¸»è®¾å¤‡å·ä¸ºINPUT_MAJORï¼Œå°±æ˜¯13ï¼Œåé¢æ³¨å†Œçš„è¾“å…¥è®¾å¤‡éƒ½ä½¿ç”¨è¯¥ä¸»è®¾å¤‡å·*/</span></span><br><span class="line">    err = register_chrdev_region(MKDEV(INPUT_MAJOR, <span class="number">0</span>),</span><br><span class="line">                     INPUT_MAX_CHAR_DEVICES, <span class="string">"input"</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å…¥å£å‡½æ•°é‡Œé¢åˆ›å»ºäº†ä¸€ä¸ªinput_classç±»ï¼Œå…¶å®å°±åœ¨/sys/classä¸‹åˆ›å»ºäº†ä¸€ä¸ªç›®å½•input.å½“ç„¶å¯¹äºä¸€ä¸ªæ–°è®¾å¤‡ï¼Œå¯ä»¥æ³¨å†Œè¿›ä¸€ä¸ªclassä¹Ÿå¯ä»¥ä¸æ³¨å†Œè¿›å»ï¼Œå¦‚æœå­˜åœ¨å¯¹åº”classçš„è¯æ³¨å†Œè¿›å»æ›´å¥½ï¼Œå¦å¤–åœ¨/procåˆ›å»ºäº†å…¥å£é¡¹,è¿™æ ·å°±å¯ä»¥/procç›®å½•çœ‹åˆ°inputçš„ä¿¡æ¯ï¼Œç„¶åå°±æ³¨å†Œè®¾å¤‡ï¼Œå¯ä»¥çœ‹å‡ºè¾“å…¥å­ç³»ç»Ÿçš„ä¸»è®¾å¤‡å·æ˜¯13ï¼Œåœ¨è¿™é‡Œå¹¶æ²¡æœ‰ç”Ÿæˆè®¾å¤‡æ–‡ä»¶ã€‚åªæ˜¯åœ¨/dev/ç›®å½•ä¸‹åˆ›å»ºäº†inputç›®å½•ï¼Œä»¥åæ‰€æœ‰æ³¨å†Œè¿›ç³»ç»Ÿçš„è¾“å…¥è®¾å¤‡æ–‡ä»¶éƒ½æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚</p><p>ç›¸åº”çš„å¯¹åº”å…³ç³»å¯ä»¥ä½¿ç”¨adb å‘½ä»¤è¿›å…¥æ–‡ä»¶ç³»ç»Ÿä¹‹åï¼Œcat /proc/bus/input/devices ï¼ŒæŸ¥çœ‹å„ä¸ªè®¾å¤‡å¯¹åº”çš„eventå¤šå°‘ï¼Œæ¯”å¦‚Google Pixel æ‰‹æœºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">I: Bus=<span class="number">0000</span> Vendor=<span class="number">0000</span> Product=<span class="number">0003</span> Version=<span class="number">2066</span></span><br><span class="line">N: Name=<span class="string">"synaptics_dsxv26"</span></span><br><span class="line">P: Phys=synaptics_dsx/touch_input</span><br><span class="line">S: Sysfs=/devices/soc/<span class="number">7577000.</span>i2c/i2c<span class="number">-3</span>/<span class="number">3</span><span class="number">-0020</span>/input/input3</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=mdss_fb kgsl event3</span><br><span class="line">B: PROP=<span class="number">2</span></span><br><span class="line">B: EV=b</span><br><span class="line">B: KEY=<span class="number">8000</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">B: ABS=<span class="number">663800000000000</span></span><br></pre></td></tr></table></figure><p>event3 å°±æ˜¯äº‹ä»¶åºå·ï¼Œ æˆ‘ä»¬åœ¨è°ƒè¯•çš„æ—¶å€™ç›´æ¥ adb shell getevent /dev/input/event3ï¼Œæ¥å®æ—¶æ•æ‰ event3 ä¸­å‚¨å­˜çš„æ•°æ®ã€‚</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥çœ‹çœ‹æ€ä¹ˆæ³¨å†Œinputè®¾å¤‡çš„.æˆ‘ä»¬éœ€è¦åœ¨è®¾å¤‡é©±åŠ¨å±‚ä¸­å®Œæˆè¾“å…¥è®¾å¤‡çš„æ³¨å†Œï¼Œé€šè¿‡è°ƒç”¨input_register_device()å‡½æ•°æ¥å®Œæˆï¼Œè¯¥å‡½æ•°çš„ä¸€ä¸ªé‡è¦ä»»åŠ¡å°±æ˜¯å®Œæˆè®¾å¤‡ä¸äº‹ä»¶é©±åŠ¨çš„åŒ¹é…</p><h2 id="3-2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input-dev"><a href="#3-2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input-dev" class="headerlink" title="3.2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input_dev"></a>3.2ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œè®¾å¤‡input_dev</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_device</span><span class="params">(struct input_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_devres</span> *<span class="title">devres</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> packet_size;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;devres_managed) &#123;</span><br><span class="line">        devres = devres_alloc(devm_input_device_unregister,</span><br><span class="line">                      <span class="keyword">sizeof</span>(struct input_devres), GFP_KERNEL);</span><br><span class="line">        ......</span><br><span class="line">        devres-&gt;input = dev;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//EN_SYNè¿™ä¸ªæ˜¯è®¾å¤‡éƒ½è¦æ”¯æŒçš„äº‹ä»¶ç±»å‹ï¼Œæ‰€ä»¥è¦è®¾ç½®   </span></span><br><span class="line">    <span class="comment">/* Every input device generates EV_SYN/SYN_REPORT events. */</span></span><br><span class="line">    __set_bit(EV_SYN, dev-&gt;evbit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* KEY_RESERVED is not supposed to be transmitted to userspace. */</span></span><br><span class="line">    __clear_bit(KEY_RESERVED, dev-&gt;keybit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Make sure that bitmasks not mentioned in dev-&gt;evbit are clean. */</span></span><br><span class="line">    input_cleanse_bitmasks(dev);</span><br><span class="line"></span><br><span class="line">    packet_size = input_estimate_events_per_packet(dev);</span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;hint_events_per_packet &lt; packet_size)</span><br><span class="line">        dev-&gt;hint_events_per_packet = packet_size;</span><br><span class="line"></span><br><span class="line">    dev-&gt;max_vals = dev-&gt;hint_events_per_packet + <span class="number">2</span>;</span><br><span class="line">    dev-&gt;vals = kcalloc(dev-&gt;max_vals, <span class="keyword">sizeof</span>(*dev-&gt;vals), GFP_KERNEL);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If delay and period are pre-set by the driver, then autorepeating</span></span><br><span class="line"><span class="comment">     * is handled by the driver itself and we don't do it in input.c.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// è¿™ä¸ªå®šæ—¶å™¨æ˜¯ä¸ºäº†é‡å¤æŒ‰é”®è€Œè®¾ç½®çš„</span></span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;rep[REP_DELAY] &amp;&amp; !dev-&gt;rep[REP_PERIOD]) &#123;</span><br><span class="line">        dev-&gt;timer.data = (<span class="keyword">long</span>) dev;</span><br><span class="line">        dev-&gt;timer.function = input_repeat_key;</span><br><span class="line">        dev-&gt;rep[REP_DELAY] = <span class="number">250</span>;</span><br><span class="line">        dev-&gt;rep[REP_PERIOD] = <span class="number">33</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¦‚æœè®¾å¤‡é©±åŠ¨æ²¡æœ‰è®¾ç½®è‡ªå·±çš„è·å–é”®å€¼çš„å‡½æ•°ï¼Œç³»ç»Ÿé»˜è®¤ */</span>  </span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;getkeycode)</span><br><span class="line">        dev-&gt;getkeycode = input_default_getkeycode;</span><br><span class="line">    <span class="comment">/* å¦‚æœè®¾å¤‡é©±åŠ¨æ²¡æœ‰æŒ‡å®šæŒ‰é”®é‡ç½®å‡½æ•°ï¼Œç³»ç»Ÿé»˜è®¤ */</span>  </span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;setkeycode)</span><br><span class="line">        dev-&gt;setkeycode = input_default_setkeycode;</span><br><span class="line"></span><br><span class="line">    error = device_add(&amp;dev-&gt;dev);</span><br><span class="line">    ......</span><br><span class="line">    path = kobject_get_path(&amp;dev-&gt;dev.kobj, GFP_KERNEL);</span><br><span class="line">    pr_info(<span class="string">"%s as %s\n"</span>,</span><br><span class="line">        dev-&gt;name ? dev-&gt;name : <span class="string">"Unspecified device"</span>,</span><br><span class="line">        path ? path : <span class="string">"N/A"</span>);</span><br><span class="line">    kfree(path);</span><br><span class="line"></span><br><span class="line">    error = mutex_lock_interruptible(&amp;input_mutex);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// å°†æ–°åˆ†é…çš„inputè®¾å¤‡è¿æ¥åˆ°input_dev_listé“¾è¡¨ä¸Š  </span></span><br><span class="line">    list_add_tail(&amp;dev-&gt;node, &amp;input_dev_list);</span><br><span class="line">    <span class="comment">/* æ ¸å¿ƒé‡ç‚¹ï¼Œinputè®¾å¤‡åœ¨å¢åŠ åˆ°input_dev_listé“¾è¡¨ä¸Šä¹‹åï¼Œä¼šæŸ¥æ‰¾</span></span><br><span class="line"><span class="comment">     * input_handler_listäº‹ä»¶å¤„ç†é“¾è¡¨ä¸Šçš„handlerè¿›è¡ŒåŒ¹é…ï¼Œè¿™é‡Œçš„åŒ¹é…</span></span><br><span class="line"><span class="comment">     * æ–¹å¼ä¸è®¾å¤‡æ¨¡å‹çš„deviceå’ŒdriveråŒ¹é…è¿‡ç¨‹å¾ˆç›¸ä¼¼ï¼Œæ‰€æœ‰çš„input</span></span><br><span class="line"><span class="comment">     * éƒ½æŒ‚åœ¨input_dev_listä¸Šï¼Œæ‰€æœ‰ç±»å‹çš„äº‹ä»¶éƒ½æŒ‚åœ¨input_handler_list</span></span><br><span class="line"><span class="comment">     * ä¸Šï¼Œè¿›è¡Œâ€œåŒ¹é…ç›¸äº²â€ï¼Œlist_for_each_entryå°±æ˜¯ä¸ªforå¾ªç¯ï¼Œè·³å‡ºæ¡ä»¶éå†äº†ä¸€éï¼Œåˆå›åˆ°é“¾è¡¨å¤´ */</span>  </span><br><span class="line">    list_for_each_entry(handler, &amp;input_handler_list, node)</span><br><span class="line">        input_attach_handler(dev, handler);</span><br><span class="line"></span><br><span class="line">    input_wakeup_procfs_readers();</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;input_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;devres_managed) &#123;</span><br><span class="line">        dev_dbg(dev-&gt;dev.parent, <span class="string">"%s: registering %s with devres.\n"</span>,</span><br><span class="line">            __func__, dev_name(&amp;dev-&gt;dev));</span><br><span class="line">        devres_add(dev-&gt;dev.parent, devres);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¸»è¦çš„åŠŸèƒ½æœ‰ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼Œä¹Ÿæ˜¯è®¾å¤‡é©±åŠ¨æ³¨å†Œä¸ºè¾“å…¥è®¾å¤‡å§”æ‰˜å†…æ ¸åšçš„äº‹æƒ…ï¼š</p><p>1ã€è¿›ä¸€æ­¥åˆå§‹åŒ–è¾“å…¥è®¾å¤‡ï¼Œä¾‹å¦‚è¿å‡»äº‹ä»¶ 2ã€æ³¨å†Œè¾“å…¥è®¾å¤‡åˆ°inputç±»ä¸­ï¼ŒæŠŠè¾“å…¥è®¾å¤‡æŒ‚åˆ°è¾“å…¥è®¾å¤‡é“¾è¡¨input_dev_listä¸­ 3ã€æŸ¥æ‰¾å¹¶åŒ¹é…è¾“å…¥è®¾å¤‡å¯¹åº”çš„äº‹ä»¶å¤„ç†å±‚ï¼Œé€šè¿‡input_handler_listé“¾è¡¨</p><p>æˆ‘ä»¬éœ€è¦å†åˆ†æä¸‹è¿™ä¸ªåŒ¹é…çš„è¿‡ç¨‹ï¼Œinput_attach_handler()åŒ¹é…è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">input_attach_handler</span><span class="params">(struct input_dev *dev, struct input_handler *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    <span class="comment">/* input_dev å’Œ input_handler è¿›è¡ŒåŒ¹é…,è¿”å›åŒ¹é…çš„idï¼Œç±»å‹æ˜¯struct input_device_id  */</span>  </span><br><span class="line">    id = input_match_device(handler, dev);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* åŒ¹é…æˆåŠŸï¼Œè°ƒç”¨handleré‡Œé¢çš„connectå‡½æ•°,è¿™ä¸ªå‡½æ•°åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­å®šä¹‰ï¼Œä¸»è¦ç”Ÿæˆä¸€ä¸ªinput_handleç»“æ„ï¼Œå¹¶åˆå§‹åŒ–ï¼Œè¿˜ç”Ÿæˆä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ç›¸å…³çš„è®¾å¤‡ç»“æ„ */</span>  </span><br><span class="line">    error = handler-&gt;connect(handler, dev, id);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹input_match_deviceï¼ˆï¼‰å‡½æ•°ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªåŒ¹é…çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•åŒ¹é…çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼ŒåŒ¹é…çš„ç»“æœä¼šæ˜¯ä»€ä¹ˆ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> struct input_device_id *<span class="title">input_match_device</span><span class="params">(struct input_handler *handler,</span></span></span><br><span class="line"><span class="function"><span class="params">                            struct input_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> *<span class="title">id</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (id = handler-&gt;id_table; id-&gt;flags || id-&gt;driver_info; id++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id-&gt;flags &amp; INPUT_DEVICE_ID_MATCH_BUS)</span><br><span class="line">            <span class="keyword">if</span> (id-&gt;bustype != dev-&gt;id.bustype) <span class="comment">//åŒ¹é…æ€»çº¿id</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id-&gt;flags &amp; INPUT_DEVICE_ID_MATCH_VENDOR)</span><br><span class="line">            <span class="keyword">if</span> (id-&gt;vendor != dev-&gt;id.vendor)  <span class="comment">//åŒ¹é…ç”Ÿäº§å•†id</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id-&gt;flags &amp; INPUT_DEVICE_ID_MATCH_PRODUCT)</span><br><span class="line">            <span class="keyword">if</span> (id-&gt;product != dev-&gt;id.product)  <span class="comment">//åŒ¹é…äº§å“id  </span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id-&gt;flags &amp; INPUT_DEVICE_ID_MATCH_VERSION)</span><br><span class="line">            <span class="keyword">if</span> (id-&gt;version != dev-&gt;id.version) <span class="comment">//åŒ¹é…ç‰ˆæœ¬  </span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åŒ¹é…idçš„evbitå’Œinput_devä¸­evbitçš„å„ä¸ªä½ï¼Œå¦‚æœä¸åŒ¹é…åˆ™continueï¼Œæ•°ç»„ä¸­ä¸‹ä¸€ä¸ªè®¾å¤‡  </span></span><br><span class="line">        <span class="keyword">if</span> (!bitmap_subset(id-&gt;evbit, dev-&gt;evbit, EV_MAX))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (!bitmap_subset(id-&gt;swbit, dev-&gt;swbit, SW_MAX))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!handler-&gt;match || handler-&gt;match(handler, dev))</span><br><span class="line">            <span class="keyword">return</span> id;<span class="comment">//åŒ¹é…æˆåŠŸ,è¿”å›id</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>input_match_device() åˆ°æœ€åˆé€‚çš„äº‹ä»¶å¤„ç†å±‚é©±åŠ¨æ—¶ï¼Œä¾¿æ‰§è¡Œhandler-&gt;connect() å‡½æ•°è¿›è¡Œè¿æ¥äº†ï¼Œçœ‹ä¸‹é¢è¿™éƒ¨åˆ†ä»£ç ï¼ˆä»¥evdevç±»å‹é©±åŠ¨ä¸ºä¾‹ï¼Œåœ¨input/evdev.cä¸­ï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">evdev_connect</span><span class="params">(struct input_handler *handler, struct input_dev *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">const</span> struct input_device_id *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> minor;</span><br><span class="line">    <span class="keyword">int</span> dev_no;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    <span class="comment">/* EVDEV_MINORSä¸º32ï¼Œä»£è¡¨å…±èƒ½å®¹çº³32ä¸ªevdeväº‹ä»¶å±‚è®¾å¤‡ï¼Œä¸‹é¢ä»£ç åœ¨æ‰¾åˆ°ç©ºçš„åœ°æ–¹ï¼Œç”¨äºä¿å­˜evdeväº‹ä»¶å±‚çš„æ•°æ®ï¼Œå³ä¸Šé¢å®šä¹‰çš„evdev */</span></span><br><span class="line">    minor = input_get_new_minor(EVDEV_MINOR_BASE, EVDEV_MINORS, <span class="literal">true</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* å¼€å§‹ç»™evdeväº‹ä»¶å±‚é©±åŠ¨åˆ†é…ç©ºé—´äº† */</span></span><br><span class="line">    evdev = kzalloc(<span class="keyword">sizeof</span>(struct evdev), GFP_KERNEL);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–client_liståˆ—è¡¨å’Œevdev_waité˜Ÿåˆ—ï¼Œåé¢ä»‹ç» */</span></span><br><span class="line">    INIT_LIST_HEAD(&amp;evdev-&gt;client_list);</span><br><span class="line">    spin_lock_init(&amp;evdev-&gt;client_lock);</span><br><span class="line">    mutex_init(&amp;evdev-&gt;mutex);</span><br><span class="line">    init_waitqueue_head(&amp;evdev-&gt;wait);</span><br><span class="line">    evdev-&gt;exist = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–evdevç»“æ„ä½“ï¼Œå…¶ä¸­handleä¸ºè¾“å…¥è®¾å¤‡å’Œäº‹ä»¶å¤„ç†çš„å…³è”æ¥å£ */</span></span><br><span class="line">    dev_no = minor;</span><br><span class="line">    <span class="comment">/* Normalize device number if it falls into legacy range */</span></span><br><span class="line">    <span class="keyword">if</span> (dev_no &lt; EVDEV_MINOR_BASE + EVDEV_MINORS)</span><br><span class="line">        dev_no -= EVDEV_MINOR_BASE;</span><br><span class="line">    dev_set_name(&amp;evdev-&gt;dev, <span class="string">"event%d"</span>, dev_no);</span><br><span class="line">    <span class="comment">/*è¿™é‡Œå°±å°†handleçš„devæŒ‡é’ˆæŒ‡å‘äº†input_dev*/</span></span><br><span class="line">    evdev-&gt;handle.dev = input_get_device(dev);</span><br><span class="line">    evdev-&gt;handle.name = dev_name(&amp;evdev-&gt;dev);</span><br><span class="line">    evdev-&gt;handle.handler = handler;<span class="comment">/*è¿™é‡Œå°†handleçš„handleræŒ‡å‘äº†å½“å‰çš„input_handler.æ³¨æ„æœ¬å‡½æ•°evdev_connect,å¯èƒ½æ˜¯åœ¨åœ¨è¾“å…¥è®¾å¤‡æ³¨å†Œçš„æ—¶å€™</span></span><br><span class="line"><span class="comment">38     åœ¨input_register_deviceå‡½æ•°ä¸­è°ƒç”¨input_attach_handlerçš„æ—¶å€™è°ƒç”¨;ä¹Ÿå¯èƒ½æ˜¯åœ¨è¾“å…¥è®¾å¤‡çš„å¤„ç†æ–¹æ³•input_handleræ—¶åœ¨input_register_handler</span></span><br><span class="line"><span class="comment">39     å‡½æ•°ä¸­ä¹Ÿä¼šç”¨åˆ°input_attach_handlerå‡½æ•°,å°±ä¼šè°ƒç”¨æœ¬å‡½æ•°.è¿™é‡Œå°±å¾ˆæ˜æ˜¾äº†,æœ¬å‡½æ•°å°±å°†input_handlerå’Œinput_devéƒ½æ”¾åœ¨input_handleä¸­ç»Ÿä¸€ç®¡ç†*/</span></span><br><span class="line">    evdev-&gt;handle.<span class="keyword">private</span> = evdev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*åˆå§‹åŒ–evdevä¸­çš„å†…åµŒdevice*/</span></span><br><span class="line">    evdev-&gt;dev.devt = MKDEV(INPUT_MAJOR, minor);</span><br><span class="line">    evdev-&gt;dev.class = &amp;input_class;</span><br><span class="line">    evdev-&gt;dev.parent = &amp;dev-&gt;dev;</span><br><span class="line">    evdev-&gt;dev.release = evdev_free;</span><br><span class="line">    device_initialize(&amp;evdev-&gt;dev);</span><br><span class="line">   <span class="comment">/* input_devè®¾å¤‡é©±åŠ¨å±‚å’Œinput_handleräº‹ä»¶å¤„ç†å±‚çš„å…³è”ï¼Œç”±input_handleå®Œæˆ(ä¸è¦å’Œhandlerææ··æ·†äº†ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½) */</span>  </span><br><span class="line">    error = input_register_handle(&amp;evdev-&gt;handle);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;evdev-&gt;cdev, &amp;evdev_fops);</span><br><span class="line">    evdev-&gt;cdev.kobj.parent = &amp;evdev-&gt;dev.kobj;</span><br><span class="line">    error = cdev_add(&amp;evdev-&gt;cdev, evdev-&gt;dev.devt, <span class="number">1</span>);</span><br><span class="line">    ......</span><br><span class="line">    error = device_add(&amp;evdev-&gt;dev);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handler"><a href="#3-3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handler" class="headerlink" title="3.3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handler"></a>3.3ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handler</h2><p>ä¸ºäº†é€»è¾‘æ›´æ¸…æ–°ï¼Œæˆ‘ä»¬ç¨åå†æ¥çœ‹input_register_handle() ç¨‹ï¼Œå…ˆæ¥äº†è§£input_handlerçš„æ³¨å†Œè¿‡ç¨‹ã€‚ è¦äº†è§£input_handlerçš„æ³¨å†Œè¿‡ç¨‹ï¼Œåˆéœ€è¦å…ˆäº†è§£evdevåˆå§‹åŒ–è¿‡ç¨‹ï¼ˆä»¥evdevä¸ºä¾‹ï¼‰ï¼š /kernel/drivers/inputä¸‹ä¼—å¤šäº‹ä»¶å¤„ç†å™¨handlerå…¶ä¸­çš„ä¸€ä¸ªï¼Œå¯ä»¥çœ‹ä¸‹æºç /kernel/drivers/input/evdev.cä¸­çš„æ¨¡å—init</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;edev.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">evdev_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> input_register_handler(&amp;evdev_handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåˆå§‹åŒ–å°±æ˜¯å¾€inputæ ¸å¿ƒä¸­æ³¨å†Œä¸€ä¸ªinput_handlerç±»å‹çš„evdev_handlerï¼Œè°ƒç”¨çš„æ˜¯input.cæä¾›çš„æ¥å£ï¼Œinput_handlerç»“æ„å‰é¢æœ‰ä»‹ç»ï¼Œçœ‹ä¸‹evdev_handlerçš„èµ‹å€¼ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;edev.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> <span class="title">evdev_handler</span> = &#123;</span></span><br><span class="line">    .event        = evdev_event,</span><br><span class="line">    .events        = evdev_events,</span><br><span class="line">    .connect    = evdev_connect,</span><br><span class="line">    .disconnect    = evdev_disconnect,</span><br><span class="line">    .legacy_minors    = <span class="literal">true</span>,</span><br><span class="line">    .minor        = EVDEV_MINOR_BASE,</span><br><span class="line">    .name        = <span class="string">"evdev"</span>,</span><br><span class="line">    .id_table    = evdev_ids,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„çš„æ˜¯evdevæ˜¯åŒ¹é…æ‰€æœ‰è®¾å¤‡çš„ï¼Œå› ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;edev.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_device_id</span> <span class="title">evdev_ids</span>[] = &#123;</span></span><br><span class="line">    &#123; .driver_info = <span class="number">1</span> &#125;,    <span class="comment">/* Matches all devices */</span></span><br><span class="line">    &#123; &#125;,            <span class="comment">/* Terminating zero entry */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_handler</span><span class="params">(struct input_handler *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    error = mutex_lock_interruptible(&amp;input_mutex);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    INIT_LIST_HEAD(&amp;handler-&gt;h_list);</span><br><span class="line">    <span class="comment">//æ·»åŠ è¿›input_handler_listå…¨å±€é“¾è¡¨</span></span><br><span class="line">    list_add_tail(&amp;handler-&gt;node, &amp;input_handler_list);</span><br><span class="line">    <span class="comment">//åŒæ ·éå†input_devè¿™ä¸ªé“¾è¡¨ï¼Œä¾æ¬¡è°ƒç”¨ä¸‹é¢çš„input_attach_handlerå»åŒ¹é…input_dev,è¿™ä¸ªè·Ÿinput_devæ³¨å†Œçš„æ—¶å€™çš„æƒ…å½¢ç±»ä¼¼  </span></span><br><span class="line">    list_for_each_entry(dev, &amp;input_dev_list, node)</span><br><span class="line">        input_attach_handler(dev, handler);</span><br><span class="line"></span><br><span class="line">    input_wakeup_procfs_readers();</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;input_mutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰"><a href="#3-4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput-handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰" class="headerlink" title="3.4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰"></a>3.4ã€è¾“å…¥æ ¸å¿ƒå±‚ï¼šæ³¨å†Œinput_handleï¼ˆä¸è¦å’Œhandlerææ··æ·†äº†å“¦ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï½ï¼‰</h2><p>input_handleå…³è”åŒ¹é…input_devå’Œinput_handler ç»§ç»­åˆ†æinput_devå’Œinput_handler æ˜¯å¦‚ä½•å…³è”ä¸Šçš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_register_handle</span><span class="params">(struct input_handle *handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span> = <span class="title">handle</span>-&gt;<span class="title">handler</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span> = <span class="title">handle</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    error = mutex_lock_interruptible(&amp;dev-&gt;mutex);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†d_nodeé“¾æ¥åˆ°è¾“å…¥è®¾å¤‡çš„h_listï¼Œh_nodeé“¾æ¥åˆ°äº‹ä»¶å±‚çš„h_listé“¾è¡¨ä¸Š</span></span><br><span class="line"><span class="comment">    * å› æ­¤ï¼Œåœ¨handleä¸­æ˜¯è¾“å…¥è®¾å¤‡å’Œäº‹ä»¶å±‚çš„å…³è”ç»“æ„ä½“ï¼Œé€šè¿‡è¾“å…¥è®¾å¤‡å¯ä»¥</span></span><br><span class="line"><span class="comment">    * æ‰¾åˆ°å¯¹åº”çš„äº‹ä»¶å¤„ç†å±‚æ¥å£ï¼Œé€šè¿‡äº‹ä»¶å¤„ç†å±‚ä¹Ÿå¯æ‰¾åˆ°åŒ¹é…çš„è¾“å…¥è®¾å¤‡</span></span><br><span class="line"><span class="comment">    */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŠŠè¿™ä¸ªhandleçš„d_node åŠ åˆ°å¯¹åº”input_devçš„h_listé“¾è¡¨é‡Œé¢  </span></span><br><span class="line">    <span class="keyword">if</span> (handler-&gt;filter)</span><br><span class="line">        list_add_rcu(&amp;handle-&gt;d_node, &amp;dev-&gt;h_list);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        list_add_tail_rcu(&amp;handle-&gt;d_node, &amp;dev-&gt;h_list);</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//æŠŠè¿™ä¸ªhandleçš„h_node åŠ åˆ°å¯¹åº”input_handlerçš„h_listé“¾è¡¨é‡Œé¢</span></span><br><span class="line">    list_add_tail_rcu(&amp;handle-&gt;h_node, &amp;handler-&gt;h_list);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler-&gt;start)</span><br><span class="line">        handler-&gt;start(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ³¨å†Œæ˜¯æŠŠhandle æœ¬èº«çš„é“¾è¡¨åŠ å…¥åˆ°å®ƒè‡ªå·±çš„input_dev ä»¥åŠ input_handlerçš„h_listé“¾è¡¨ä¸­ï¼Œè¿™æ ·ä»¥åå°±å¯ä»¥é€šè¿‡h_listéå†åˆ°è¿™ä¸ªhandleï¼Œè¿™æ ·å°±å®ç°äº†ä¸‰è€…çš„ç»‘å®šè”ç³»ã€‚</p><p>ä»¥ä¸Šæ˜¯è¾“å…¥è®¾å¤‡é©±åŠ¨æ³¨å†Œçš„å…¨è¿‡ç¨‹ï¼Œçºµè§‚æ•´ä¸ªè¿‡ç¨‹ï¼Œè¾“å…¥è®¾å¤‡é©±åŠ¨æœ€ç»ˆçš„ç›®çš„å°±æ˜¯èƒ½å¤Ÿä¸äº‹ä»¶å¤„ç†å±‚çš„äº‹ä»¶é©±åŠ¨ç›¸äº’åŒ¹é…ï¼Œä½†æ˜¯åœ¨drivers/inputç›®å½•ä¸‹æœ‰evdev.cäº‹ä»¶é©±åŠ¨ã€mousedev.cäº‹ä»¶é©±åŠ¨ã€joydev.cäº‹ä»¶é©±åŠ¨ç­‰ç­‰ï¼Œæˆ‘ä»¬çš„è¾“å…¥è®¾å¤‡äº§ç”Ÿçš„äº‹ä»¶åº”è¯¥æœ€ç»ˆä¸ŠæŠ¥ç»™è°ï¼Œç„¶åè®©äº‹ä»¶è¢«è°å»å¤„ç†å‘¢ï¼ŸçŸ¥é“äº†è¿™ä¹ˆä¸ªåŸå› å†çœ‹ä¸Šé¢ä»£ç å°±ä¼šæ˜ç™½ï¼Œå…¶å®evdev.cã€mousedev.cç­‰æ ¹æ®ç¡¬ä»¶è¾“å…¥è®¾å¤‡çš„å¤„ç†æ–¹å¼çš„ä¸åŒæŠ½è±¡å‡ºäº†ä¸åŒçš„äº‹ä»¶å¤„ç†æ¥å£å¸®åŠ©ä¸Šå±‚å»è°ƒç”¨ï¼Œè€Œæˆ‘ä»¬å†™çš„è®¾å¤‡é©±åŠ¨ç¨‹åºåªä¸è¿‡æ˜¯å®Œæˆäº†ç¡¬ä»¶å¯„å­˜å™¨ä¸­æ•°æ®çš„è¯»å†™ï¼Œä½†æäº¤ç»™ç”¨æˆ·çš„äº‹ä»¶å¿…é¡»æ˜¯ç»è¿‡äº‹ä»¶å¤„ç†å±‚çš„å°è£…å’ŒåŒæ­¥æ‰èƒ½å¤Ÿå®Œæˆçš„ï¼Œäº‹ä»¶å¤„ç†å±‚æä¾›ç»™ç”¨æˆ·ä¸€ä¸ªç»Ÿä¸€çš„ç•Œé¢æ¥æ“ä½œã€‚ æ•´ä¸ªå…³è”æ³¨å†Œçš„è¿‡ç¨‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/04-Linux-kernel-input-reg-device.png" alt="Markdown"></p><h2 id="ï¼ˆå››ï¼‰ã€Input-äº‹ä»¶å¤„ç†å±‚-Event-handler-ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰"><a href="#ï¼ˆå››ï¼‰ã€Input-äº‹ä»¶å¤„ç†å±‚-Event-handler-ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰" class="headerlink" title="ï¼ˆå››ï¼‰ã€Input äº‹ä»¶å¤„ç†å±‚ Event handler ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰"></a>ï¼ˆå››ï¼‰ã€Input äº‹ä»¶å¤„ç†å±‚ Event handler ï¼ˆä»¥evdeväº‹ä»¶å¤„ç†å™¨ä¸ºä¾‹ï¼‰</h2><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/05-Linux-kernel-input-event-hardware.png" alt="Markdown"></p><h2 id="4-1ã€ä¸»è¦æ•°æ®ç»“æ„"><a href="#4-1ã€ä¸»è¦æ•°æ®ç»“æ„" class="headerlink" title="4.1ã€ä¸»è¦æ•°æ®ç»“æ„"></a>4.1ã€ä¸»è¦æ•°æ®ç»“æ„</h2><p><strong>ï¼ˆ1ï¼‰ evdevè®¾å¤‡ç»“æ„</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[evdev.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> &#123;</span>   </span><br><span class="line">    <span class="keyword">int</span> exist;   </span><br><span class="line">    <span class="keyword">int</span> open;                     <span class="comment">//æ‰“å¼€æ ‡å¿—   </span></span><br><span class="line">    <span class="keyword">int</span> minor;                    <span class="comment">//æ¬¡è®¾å¤‡å·   </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> <span class="title">handle</span>;</span>   <span class="comment">//å…³è”çš„input_handle   </span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> wait;       <span class="comment">//ç­‰å¾…é˜Ÿåˆ—ï¼Œå½“è¿›ç¨‹è¯»å–è®¾å¤‡ï¼Œè€Œæ²¡æœ‰äº‹ä»¶äº§ç”Ÿçš„æ—¶å€™ï¼Œè¿›ç¨‹å°±ä¼šç¡åœ¨å…¶ä¸Šé¢   </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> *<span class="title">grab</span>;</span>    <span class="comment">//å¼ºåˆ¶ç»‘å®šçš„evdev_clientç»“æ„ï¼Œè¿™ä¸ªç»“æ„åé¢å†åˆ†æ   </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">client_list</span>;</span> <span class="comment">//evdev_client é“¾è¡¨ï¼Œè¿™è¯´æ˜ä¸€ä¸ªevdevè®¾å¤‡å¯ä»¥å¤„ç†å¤šä¸ªevdev_clientï¼Œå¯ä»¥æœ‰å¤šä¸ªè¿›ç¨‹è®¿é—®evdevè®¾å¤‡   </span></span><br><span class="line">    <span class="keyword">spinlock_t</span> client_lock;       <span class="comment">/* protects client_list */</span>   </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span>   </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span>            <span class="comment">//deviceç»“æ„ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªè®¾å¤‡ç»“æ„   </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>evdevç»“æ„ä½“åœ¨é…å¯¹æˆåŠŸçš„æ—¶å€™ç”Ÿæˆï¼Œç”±handler-&gt;connectç”Ÿæˆï¼Œå¯¹åº”è®¾å¤‡æ–‡ä»¶ä¸º/class/input/event(n)ï¼Œå¦‚è§¦æ‘¸å±é©±åŠ¨çš„event3ï¼Œè¿™ä¸ªè®¾å¤‡æ˜¯ç”¨æˆ·ç©ºé—´è¦è®¿é—®çš„è®¾å¤‡ï¼Œå¯ä»¥ç†è§£å®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ï¼Œå› ä¸ºæ²¡æœ‰å¯¹åº”çš„ç¡¬ä»¶ï¼Œä½†æ˜¯é€šè¿‡handle-&gt;dev å°±å¯ä»¥æ‰¾åˆ°input_devç»“æ„ï¼Œè€Œå®ƒå¯¹åº”ç€è§¦æ‘¸å±ï¼Œè®¾å¤‡æ–‡ä»¶ä¸º/class/input/input3ã€‚è¿™ä¸ªè®¾å¤‡ç»“æ„ç”Ÿæˆä¹‹åä¿å­˜åœ¨evdev_tableä¸­ï¼Œç´¢å¼•å€¼æ˜¯minorã€‚ <strong>ï¼ˆ2ï¼‰evdevç”¨æˆ·ç«¯ç»“æ„</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[evdev.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> head;  <span class="comment">//bufferæ•°ç»„çš„ç´¢å¼•å¤´  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tail;   <span class="comment">//bufferæ•°ç»„çš„ç´¢å¼•å°¾  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> packet_head; <span class="comment">/* [future] position of the first element of next packet */</span>  </span><br><span class="line">    <span class="keyword">spinlock_t</span> buffer_lock; <span class="comment">/* protects access to buffer, head and tail */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">wake_lock</span> <span class="title">wake_lock</span>;</span>  </span><br><span class="line">    <span class="keyword">bool</span> use_wake_lock;  </span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">28</span>];  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span>    <span class="comment">//å¼‚æ­¥é€šçŸ¥å‡½æ•°  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span>;</span>  <span class="comment">//åŒ…å«ä¸€ä¸ªevdevå˜é‡  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>  <span class="comment">//é“¾è¡¨  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bufsize;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">buffer</span>[];</span>   <span class="comment">//input_eventæ•°æ®ç»“æ„çš„æ•°ç»„ï¼Œinput_eventä»£è¡¨ä¸€ä¸ªäº‹ä»¶ï¼ŒåŸºæœ¬æˆå‘˜ï¼šç±»å‹ï¼ˆtypeï¼‰ï¼Œç¼–ç ï¼ˆcodeï¼‰ï¼Œå€¼ï¼ˆvalueï¼‰  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„åœ¨è¿›ç¨‹æ‰“å¼€event3è®¾å¤‡çš„æ—¶å€™è°ƒç”¨evdevçš„openæ–¹æ³•ï¼Œåœ¨openä¸­åˆ›å»ºè¿™ä¸ªç»“æ„ï¼Œå¹¶åˆå§‹åŒ–ã€‚åœ¨å…³é—­è®¾å¤‡æ–‡ä»¶çš„æ—¶å€™é‡Šæ”¾è¿™ä¸ªç»“æ„ã€‚ <strong>ï¼ˆ3ï¼‰input_eventç»“æ„</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[input.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">time</span>;</span>    <span class="comment">//äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´   </span></span><br><span class="line">    __u16 type;             <span class="comment">//äº‹ä»¶ç±»å‹   </span></span><br><span class="line">    __u16 code;             <span class="comment">//å­äº‹ä»¶   </span></span><br><span class="line">    __s32 value;            <span class="comment">//äº‹ä»¶çš„value  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="4-2ã€äº‹ä»¶å¤„ç†å±‚evdev"><a href="#4-2ã€äº‹ä»¶å¤„ç†å±‚evdev" class="headerlink" title="4.2ã€äº‹ä»¶å¤„ç†å±‚evdev"></a>4.2ã€äº‹ä»¶å¤„ç†å±‚evdev</h2><p>äº‹ä»¶å¤„ç†å±‚ä¸ç”¨æˆ·ç¨‹åºå’Œè¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒæ‰“äº¤é“ï¼Œæ˜¯ä»–ä»¬ä¸¤å±‚çš„æ¡¥æ¢ã€‚ä¸€èˆ¬å†…æ ¸æœ‰å¥½å‡ ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œåƒevdev mousedev jotdevã€‚evdeväº‹ä»¶å¤„ç†å™¨å¯ä»¥å¤„ç†æ‰€æœ‰çš„äº‹ä»¶ï¼Œè§¦æ‘¸å±é©±åŠ¨å°±æ˜¯ç”¨çš„è¿™ä¸ªï¼Œæ‰€ä»¥ä¸‹é¢åˆ†æè¿™ä¸ªäº‹ä»¶å¤„ç†å™¨çš„å®ç°ã€‚å®ƒä¹Ÿæ˜¯ä½œä¸ºæ¨¡å—æ³¨å†Œåˆ°å†…æ ¸ä¸­çš„,å‰é¢å·²ç»åˆ†æè¿‡å®ƒçš„æ¨¡å—åˆå§‹åŒ–å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">evdev_fops</span> = &#123;</span></span><br><span class="line">    .owner        = THIS_MODULE,</span><br><span class="line">    .read        = evdev_read,</span><br><span class="line">    .write        = evdev_write,</span><br><span class="line">    .poll        = evdev_poll,</span><br><span class="line">    .open        = evdev_open,</span><br><span class="line">    .release    = evdev_release,</span><br><span class="line">    .unlocked_ioctl    = evdev_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">    .compat_ioctl    = evdev_ioctl_compat,</span><br><span class="line">#endif</span><br><span class="line">    .fasync        = evdev_fasync,</span><br><span class="line">    .flush        = evdev_flush,</span><br><span class="line">    .llseek        = no_llseek,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœåŒ¹é…ä¸Šäº†å°±ä¼šåˆ›å»ºä¸€ä¸ªevdevï¼Œå®ƒé‡Œè¾¹å°è£…äº†ä¸€ä¸ªhandleï¼Œä¼šæŠŠinput_devå’Œinput_handlerå…³è”åˆ°ä¸€èµ·ã€‚å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/06-Linux-kernel-input-evdev-connect.png" alt="Markdown"></p><h2 id="4-3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open-æ“ä½œ"><a href="#4-3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open-æ“ä½œ" class="headerlink" title="4.3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open()æ“ä½œ"></a>4.3ã€evdevè®¾å¤‡ç»“ç‚¹çš„open()æ“ä½œ</h2><p>æˆ‘ä»¬çŸ¥é“.å¯¹ä¸»è®¾å¤‡å·ä¸ºINPUT_MAJORçš„è®¾å¤‡èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œä¼šå°†æ“ä½œé›†è½¬æ¢æˆhandlerçš„æ“ä½œé›†ã€‚åœ¨evdevä¸­ï¼Œè¿™ä¸ªæ“ä½œé›†å°±æ˜¯evdev_fopsã€‚å¯¹åº”çš„openå‡½æ•°å¦‚ä¸‹ç¤ºï¼š</p><p>é¦–å…ˆæ¥çœ‹æ‰“å¼€event(x)è®¾å¤‡æ–‡ä»¶ï¼Œevdev_openå‡½æ•°.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">evdev_open</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span> = <span class="title">container_of</span>(<span class="title">inode</span>-&gt;<span class="title">i_cdev</span>, <span class="title">struct</span> <span class="title">evdev</span>, <span class="title">cdev</span>);</span></span><br><span class="line">    <span class="comment">//evdev_clientçš„bufferå¤§å°  </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bufsize = evdev_compute_buffer_size(evdev-&gt;handle.dev);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size = <span class="keyword">sizeof</span>(struct evdev_client) +</span><br><span class="line">                    bufsize * <span class="keyword">sizeof</span>(struct input_event);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> *<span class="title">client</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    <span class="comment">//æ‰“å¼€çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªevdev_client</span></span><br><span class="line">    client = kzalloc(size, GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    client-&gt;bufsize = bufsize;</span><br><span class="line">    spin_lock_init(&amp;client-&gt;buffer_lock);</span><br><span class="line">    <span class="built_in">snprintf</span>(client-&gt;name, <span class="keyword">sizeof</span>(client-&gt;name), <span class="string">"%s-%d"</span>,</span><br><span class="line">            dev_name(&amp;evdev-&gt;dev), task_tgid_vnr(current));</span><br><span class="line">    client-&gt;evdev = evdev;</span><br><span class="line">    evdev_attach_client(evdev, client);</span><br><span class="line">    <span class="comment">//è°ƒç”¨æ‰“å¼€çœŸæ­£çš„åº•å±‚è®¾å¤‡å‡½æ•°  </span></span><br><span class="line">    error = evdev_open_device(evdev);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    file-&gt;private_data = client;</span><br><span class="line">    nonseekable_open(inode, file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">evdev_open_device</span><span class="params">(struct evdev *evdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = mutex_lock_interruptible(&amp;evdev-&gt;mutex);</span><br><span class="line">    <span class="keyword">if</span> (retval)<span class="comment">/*å¦‚æœè®¾å¤‡ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯*/</span>  </span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!evdev-&gt;exist)</span><br><span class="line">        retval = -ENODEV;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!evdev-&gt;open++) &#123;<span class="comment">//é€’å¢æ‰“å¼€è®¡æ•°  </span></span><br><span class="line">        retval = input_open_device(&amp;evdev-&gt;handle);<span class="comment">//å¦‚æœæ˜¯è¢«ç¬¬ä¸€æ¬¡æ‰“å¼€ï¼Œåˆ™è°ƒç”¨input_open_device</span></span><br><span class="line">        <span class="keyword">if</span> (retval)</span><br><span class="line">            evdev-&gt;open--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;evdev-&gt;mutex);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_open_device</span><span class="params">(struct input_handle *handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">dev</span> = <span class="title">handle</span>-&gt;<span class="title">dev</span>;</span><span class="comment">//æ ¹æ®input_handleæ‰¾åˆ°å¯¹åº”çš„input_devè®¾å¤‡  </span></span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = mutex_lock_interruptible(&amp;dev-&gt;mutex);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    handle-&gt;open++;<span class="comment">//é€’å¢handleçš„æ‰“å¼€è®¡æ•°  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;users++ &amp;&amp; dev-&gt;open)</span><br><span class="line">        retval = dev-&gt;open(dev);<span class="comment">//å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€.åˆ™è°ƒç”¨input deviceçš„open()å‡½æ•°  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (retval) &#123;</span><br><span class="line">        dev-&gt;users--;</span><br><span class="line">        <span class="keyword">if</span> (!--handle-&gt;open) &#123;</span><br><span class="line">            synchronize_rcu();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">    mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°"><a href="#4-4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°" class="headerlink" title="4.4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°"></a>4.4ã€ç”¨æˆ·è¿›ç¨‹è¯»å–eventçš„åº•å±‚å®ç°</h2><p>è‡³äºå…·ä½“çš„å¦‚ä½•åˆå§‹åŒ–input_devï¼Œè¿™ä¸ªæ˜¯å…·ä½“çš„è¾“å…¥è®¾å¤‡å»å®ç°çš„ï¼Œç¨åå…·ä½“å®ä¾‹å†åˆ†æï¼Œç°åœ¨æ¥çœ‹çœ‹ï¼Œå¯¹äºä¸€ä¸ªevent(x)è®¾å¤‡æ–‡ä»¶çš„ï¼Œåº”ç”¨ç¨‹åºæ¥è¯»ï¼Œæœ€ç»ˆä¼šå¯¼è‡´â€handlerâ€é‡Œé¢çš„çš„â€è¯»å‡½æ•°â€è¢«è°ƒç”¨ã€‚</p><p>evdev_fops ç»“ æ„ ä½“ æ˜¯ ä¸€ ä¸ª file_operations çš„ ç±» å‹ ã€‚ å½“ ç”¨ æˆ· å±‚ è°ƒ ç”¨ ç±» ä¼¼ ä»£ ç open(â€œ/dev/input/event3â€ , O_RDONLY) å‡½ æ•° æ‰“ å¼€ è®¾ å¤‡ ç»“ ç‚¹ æ—¶ , ä¼š è°ƒ ç”¨ evdev_fops ä¸­ çš„evdev_read()å‡½æ•°,è¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">evdev_read</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> *<span class="title">client</span> = <span class="title">file</span>-&gt;<span class="title">private_data</span>;</span><span class="comment">//å°±æ˜¯åˆšæ‰åœ¨openå‡½æ•°ä¸­ä¿å­˜çš„evdev_client  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span> = <span class="title">client</span>-&gt;<span class="title">evdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">event</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> read = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//å¦‚æœè·å¾—äº†æ•°æ®åˆ™å–å‡ºæ¥ï¼Œè°ƒç”¨evdev_fetch_next_event  </span></span><br><span class="line">        <span class="keyword">while</span> (read + input_event_size() &lt;= count &amp;&amp;</span><br><span class="line">               evdev_fetch_next_event(client, &amp;event)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//input_event_to_userè°ƒç”¨copy_to_userä¼ å…¥ç”¨æˆ·ç¨‹åºä¸­ï¼Œè¿™æ ·è¯»å–å®Œæˆ  </span></span><br><span class="line">            <span class="keyword">if</span> (input_event_to_user(buffer + read, &amp;event))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">            read += input_event_size();</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">/*å¦‚æœæ˜¯å¯é˜»å¡çŠ¶æ€çš„è¯,åˆ™ç­‰å¾…åœ¨waité˜Ÿåˆ—ä¸Š.ç›´åˆ°æœ‰æ•°æ®è¦è¢«å¤„ç†,å½“å‰è¿›ç¨‹æ‰è¢«å”¤é†’.è¿™å¾ˆå¥½ç†è§£,æ—¢ç„¶æ˜¯</span></span><br><span class="line"><span class="comment">         è¾“å…¥è®¾å¤‡,è¯»çš„è¯æ¯”å¦‚è¯»æŒ‰é”®,é‚£ä¹ˆå¿…é¡»è¦æœ‰ç¡¬ä»¶è®¾å¤‡æœ‰æŒ‰é”®æŒ‰ä¸‹æ‰ä¼šè¿”å›æŒ‰é”®å€¼,è¿™é‡Œè¿˜æ˜¯å¤„äºäº‹ä»¶å¤„ç†å±‚,åº”ç”¨ç¨‹åºåœ¨è¿™é‡Œä¼‘çœ ,é‚£ä¹ˆè°æ¥å”¤é†’?</span></span><br><span class="line"><span class="comment">         å½“ç„¶æ˜¯æœ‰æŒ‰é”®æŒ‰ä¸‹æ‰å»å”¤é†’,å› æ­¤è¿™ä¸ªå·¥ä½œå°±äº¤ç»™äº†è®¾å¤‡é©±åŠ¨å±‚,é‚£ä¹ˆæ‰¾åˆ°è¿™ä¸ªå”¤é†’å‘¢,ç›´æ¥å»æ‰¾ä¸å¥½æ‰¾,é‚£ä¹ˆå¯ä»¥ç›´æ¥æœç´¢evdev-&gt;wait,æœç´¢ç»“æœ</span></span><br><span class="line"><span class="comment">         å¯çŸ¥evdev-&gt;waitåœ¨evdev_event()å‡½æ•°ä¸­è¢«å”¤é†’*/</span></span><br><span class="line">        <span class="keyword">if</span> (!(file-&gt;f_flags &amp; O_NONBLOCK)) &#123;</span><br><span class="line">            error = wait_event_interruptible(evdev-&gt;wait,</span><br><span class="line">                    client-&gt;packet_head != client-&gt;tail ||</span><br><span class="line">                    !evdev-&gt;exist || client-&gt;revoked);</span><br><span class="line">            <span class="keyword">if</span> (error)</span><br><span class="line">                <span class="keyword">return</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> read;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">evdev_fetch_next_event</span><span class="params">(struct evdev_client *client,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct input_event *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> have_event;</span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;client-&gt;buffer_lock);</span><br><span class="line">    <span class="comment">/*å…ˆåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æœ‰æ•°æ®*/</span>   </span><br><span class="line">    have_event = client-&gt;packet_head != client-&gt;tail;</span><br><span class="line">    <span class="comment">/*å¦‚æœæœ‰å°±ä»ç¯å½¢ç¼“å†²åŒºçš„å–å‡ºæ¥ï¼Œè®°å¾—æ˜¯ä»headå­˜å‚¨ï¼Œtailå–å‡º*/</span></span><br><span class="line">    <span class="keyword">if</span> (have_event) &#123;</span><br><span class="line">        *event = client-&gt;buffer[client-&gt;tail++];</span><br><span class="line">        client-&gt;tail &amp;= client-&gt;bufsize - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (client-&gt;use_wake_lock &amp;&amp;</span><br><span class="line">            client-&gt;packet_head == client-&gt;tail)</span><br><span class="line">            wake_unlock(&amp;client-&gt;wake_lock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spin_unlock_irq(&amp;client-&gt;buffer_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> have_event;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_event_to_user</span><span class="params">(<span class="keyword">char</span> __user *buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> struct input_event *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*å¦‚æœè®¾ç½®äº†æ ‡å¿—INPUT_COMPAT_TESTå°±å°†äº‹ä»¶eventåŒ…è£…æˆç»“æ„ä½“compat_event*/</span></span><br><span class="line">    <span class="keyword">if</span> (INPUT_COMPAT_TEST &amp;&amp; !COMPAT_USE_64BIT_TIME) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">input_event_compat</span> <span class="title">compat_event</span>;</span></span><br><span class="line"></span><br><span class="line">        compat_event.time.tv_sec = event-&gt;time.tv_sec;</span><br><span class="line">        compat_event.time.tv_usec = event-&gt;time.tv_usec;</span><br><span class="line">        compat_event.type = event-&gt;type;</span><br><span class="line">        compat_event.code = event-&gt;code;</span><br><span class="line">        compat_event.value = event-&gt;value;</span><br><span class="line">         <span class="comment">/*å°†åŒ…è£…æˆçš„compat_eventæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´*/</span>  </span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(buffer, &amp;compat_event,</span><br><span class="line">                 <span class="keyword">sizeof</span>(struct input_event_compat)))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">/*å¦åˆ™ï¼Œå°†eventæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´*/</span>   </span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(buffer, event, <span class="keyword">sizeof</span>(struct input_event)))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯å¯é˜»å¡çŠ¶æ€çš„è¯ï¼Œåˆ™ç­‰å¾…åœ¨waité˜Ÿåˆ—ä¸Šã€‚ç›´åˆ°æœ‰æ•°æ®è¦è¢«å¤„ç†ï¼Œå½“å‰è¿›ç¨‹æ‰è¢«å”¤é†’ã€‚è¿™å¾ˆå¥½ç†è§£ï¼Œæ—¢ç„¶æ˜¯è¾“å…¥è®¾å¤‡ï¼Œè¯»çš„è¯æ¯”å¦‚è¯»æŒ‰é”®ï¼Œé‚£ä¹ˆå¿…é¡»è¦æœ‰ç¡¬ä»¶è®¾å¤‡æœ‰æŒ‰é”®æŒ‰ä¸‹æ‰ä¼šè¿”å›æŒ‰é”®å€¼ï¼Œè¿™é‡Œè¿˜æ˜¯å¤„äºäº‹ä»¶å¤„ç†å±‚ï¼Œåº”ç”¨ç¨‹åºåœ¨è¿™é‡Œä¼‘çœ ï¼Œé‚£ä¹ˆè°æ¥å”¤é†’?</p><p>å½“ç„¶æ˜¯æœ‰æŒ‰é”®æŒ‰ä¸‹æ‰å»å”¤é†’ï¼Œå› æ­¤è¿™ä¸ªå·¥ä½œå°±äº¤ç»™äº†è®¾å¤‡é©±åŠ¨å±‚ã€‚é‚£ä¹ˆæ‰¾åˆ°è¿™ä¸ªå”¤é†’å‘¢ï¼Œç›´æ¥å»æ‰¾ä¸å¥½æ‰¾ã€‚é‚£ä¹ˆå¯ä»¥ç›´æ¥æœç´¢evdev-&gt;waitï¼Œæœç´¢ç»“æœå¯çŸ¥evdev-&gt;waitåœ¨evdev_event()å‡½æ•°ä¸­è¢«å”¤é†’</p><p>æ³¨é‡Šä¸­è¯´çš„å¾ˆæ¸…æ¥šï¼Œevdev_event()ä¼šå”¤é†’æ­¤å¤„çš„è¯»æŒ‰é”®è¿›ç¨‹ã€‚é‚£ä¹ˆevdev_event()åˆæ˜¯è¢«è°è°ƒç”¨?æ˜¾ç„¶æ˜¯è®¾å¤‡é©±åŠ¨å±‚ï¼Œç°åœ¨çœ‹ä¸€ä¸ªè®¾å¤‡å±‚ä¾‹å­ï¼Œå†…æ ¸ä¸­æœ‰ä¸ªæŒ‰é”®çš„ä¾‹å­ï¼Œgpiokey.cï¼Œè¿™åªæ˜¯ä¸ªä¾‹å­ä¸é’ˆå¯¹ä»»ä½•è®¾å¤‡ï¼Œåœ¨gpio_keys.cç»ˆç«¯å¤„ç†å‡½æ•°é‡Œé¢</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;gpio_keys.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> irqreturn_t <span class="title">gpio_keys_irq_isr</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (!bdata-&gt;key_pressed) &#123;</span><br><span class="line">        ......</span><br><span class="line">        input_event(input, EV_KEY, button-&gt;code, <span class="number">1</span>);</span><br><span class="line">        input_sync(input);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤å¯ä»¥çœ‹å‡º åœ¨è®¾å¤‡çš„ä¸­æ–­æœåŠ¡ç¨‹åºé‡Œé¢ï¼Œç¡®å®šäº‹ä»¶æ˜¯ä»€ä¹ˆï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„input_handlerçš„eventå¤„ç†å‡½æ•° å®é™…ä¸Šè¿™å°±æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒ input_event()æ˜¯ç”¨æ¥ä¸ŠæŠ¥äº‹ä»¶çš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">input_event</span><span class="params">(struct input_dev *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_event_supported(type, dev-&gt;evbit, EV_MAX)) &#123;</span><br><span class="line"></span><br><span class="line">        spin_lock_irqsave(&amp;dev-&gt;event_lock, flags);</span><br><span class="line">        input_handle_event(dev, type, code, value);</span><br><span class="line">        spin_unlock_irqrestore(&amp;dev-&gt;event_lock, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">input_handle_event</span><span class="params">(struct input_dev *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (disposition &amp; INPUT_FLUSH) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dev-&gt;num_vals &gt;= <span class="number">2</span>)</span><br><span class="line">            input_pass_values(dev, dev-&gt;vals, dev-&gt;num_vals);</span><br><span class="line">        dev-&gt;num_vals = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dev-&gt;num_vals &gt;= dev-&gt;max_vals - <span class="number">2</span>) &#123;</span><br><span class="line">        dev-&gt;vals[dev-&gt;num_vals++] = input_value_sync;</span><br><span class="line">        input_pass_values(dev, dev-&gt;vals, dev-&gt;num_vals);</span><br><span class="line">        dev-&gt;num_vals = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">input_pass_values</span><span class="params">(struct input_dev *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handle</span> *<span class="title">handle</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">v</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    handle = rcu_dereference(dev-&gt;grab);</span><br><span class="line">    <span class="keyword">if</span> (handle) &#123;</span><br><span class="line">        count = input_to_handler(handle, vals, count);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        list_for_each_entry_rcu(handle, &amp;dev-&gt;h_list, d_node)</span><br><span class="line">            <span class="keyword">if</span> (handle-&gt;open)</span><br><span class="line">                count = input_to_handler(handle, vals, count);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">input_to_handler</span><span class="params">(struct input_handle *handle,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span> = <span class="title">handle</span>-&gt;<span class="title">handler</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">end</span> = <span class="title">vals</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">v</span>;</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler-&gt;events)</span><br><span class="line">        handler-&gt;events(handle, vals, count);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (handler-&gt;event)</span><br><span class="line">        <span class="keyword">for</span> (v = vals; v != end; v++)</span><br><span class="line">            handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨handler-&gt;event()æ¥å¤„ç†ï¼Œæ­¤å¤„handlerå³å¯¹åº”evdevã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c]</span><br><span class="line">handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¼šè°ƒç”¨evdev_event()å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;evdev.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">evdev_pass_values</span><span class="params">(struct evdev_client *client,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">ktime_t</span> mono, <span class="keyword">ktime_t</span> real)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span> = <span class="title">client</span>-&gt;<span class="title">evdev</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">v</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">event</span>;</span></span><br><span class="line">    <span class="keyword">bool</span> wakeup = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (client-&gt;revoked)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    event.time = ktime_to_timeval(client-&gt;clkid == CLOCK_MONOTONIC ?</span><br><span class="line">                      mono : real);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Interrupts are disabled, just acquire the lock. */</span></span><br><span class="line">    spin_lock(&amp;client-&gt;buffer_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (v = vals; v != vals + count; v++) &#123;</span><br><span class="line">        event.type = v-&gt;type;</span><br><span class="line">        event.code = v-&gt;code;</span><br><span class="line">        event.value = v-&gt;value;</span><br><span class="line">        __pass_event(client, &amp;event);</span><br><span class="line">        <span class="keyword">if</span> (v-&gt;type == EV_SYN &amp;&amp; v-&gt;code == SYN_REPORT)</span><br><span class="line">            wakeup = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spin_unlock(&amp;client-&gt;buffer_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wakeup)</span><br><span class="line">        wake_up_interruptible(&amp;evdev-&gt;wait);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">evdev_events</span><span class="params">(struct input_handle *handle,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">const</span> struct input_value *vals, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev</span> *<span class="title">evdev</span> = <span class="title">handle</span>-&gt;<span class="title">private</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdev_client</span> *<span class="title">client</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (client)</span><br><span class="line">        evdev_pass_values(client, vals, count, time_mono, time_real);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        list_for_each_entry_rcu(client, &amp;evdev-&gt;client_list, node)</span><br><span class="line">            evdev_pass_values(client, vals, count,</span><br><span class="line">                      time_mono, time_real);</span><br><span class="line"></span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">evdev_event</span><span class="params">(struct input_handle *handle,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> <span class="keyword">int</span> type, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> <span class="title">vals</span>[] = &#123;</span> &#123; type, code, value &#125; &#125;;</span><br><span class="line">    evdev_events(handle, vals, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå”¤é†’evdev_read()å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p><h2 id="ï¼ˆäº”ï¼‰ã€Input-äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹"><a href="#ï¼ˆäº”ï¼‰ã€Input-äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹" class="headerlink" title="ï¼ˆäº”ï¼‰ã€Input äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹"></a>ï¼ˆäº”ï¼‰ã€Input äº‹ä»¶ä¸ŠæŠ¥è¿‡ç¨‹</h2><h2 id="5-1ã€Input-äº‹ä»¶äº§ç”Ÿ"><a href="#5-1ã€Input-äº‹ä»¶äº§ç”Ÿ" class="headerlink" title="5.1ã€Input äº‹ä»¶äº§ç”Ÿ"></a>5.1ã€Input äº‹ä»¶äº§ç”Ÿ</h2><p>å½“æŒ‰ä¸‹è§¦æ‘¸å±æ—¶ï¼Œè¿›å…¥è§¦æ‘¸å±æŒ‰ä¸‹ä¸­æ–­ï¼Œå¼€å§‹adè½¬æ¢ï¼Œadè½¬æ¢å®Œæˆè¿›å…¥adå®Œæˆä¸­æ–­ï¼Œåœ¨è¿™ä¸ªç»ˆç«¯ä¸­å°†äº‹ä»¶å‘é€å‡ºå»ï¼Œä¼šè°ƒç”¨ä»¥ä¸‹å‡½æ•°ä¸ŠæŠ¥äº‹ä»¶:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> input_report_key(input_dev,</span><br><span class="line">         BTN_TOUCH, 1);</span><br><span class="line"></span><br><span class="line"> input_report_abs(input_dev,</span><br><span class="line">         ABS_POSITION_X, x);</span><br><span class="line"></span><br><span class="line"> input_report_abs(input_dev,</span><br><span class="line">         ABS_POSITION_Y, y);</span><br><span class="line"></span><br><span class="line">input_sync(input_dev);</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°è°ƒç”¨äº† input_event(dev, EV_ABS, code, value) æ‰€æœ‰çš„äº‹ä»¶æŠ¥å‘Šå‡½æ•°éƒ½è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.h]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">input_report_key</span><span class="params">(struct input_dev *dev, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    input_event(dev, EV_KEY, code, !!value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">input_report_abs</span><span class="params">(struct input_dev *dev, <span class="keyword">unsigned</span> <span class="keyword">int</span> code, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    input_event(dev, EV_ABS, code, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">input_sync</span><span class="params">(struct input_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    input_event(dev, EV_SYN, SYN_REPORT, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-2ã€Input-äº‹ä»¶æŠ¥å‘Š"><a href="#5-2ã€Input-äº‹ä»¶æŠ¥å‘Š" class="headerlink" title="5.2ã€Input äº‹ä»¶æŠ¥å‘Š"></a>5.2ã€Input äº‹ä»¶æŠ¥å‘Š</h2><p>input_event å‡½æ•°å‰é¢å·²ç»åˆ†æè¿‡ï¼Œè¿™é‡Œä¸å†åˆ†æã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;input.c:input_pass_values]</span><br><span class="line"><span class="keyword">for</span> (v = vals; v != end; v++)</span><br><span class="line">    handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¼šè°ƒç”¨handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value) æ¥å°†æ•°æ® ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ç­‰å¾…è¯»å–æ•°æ®çš„è¿›ç¨‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_to_user(buffer, event, <span class="keyword">sizeof</span>(struct input_event))</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆå…­ï¼‰ã€Android-Inputå­ç³»ç»Ÿ"><a href="#ï¼ˆå…­ï¼‰ã€Android-Inputå­ç³»ç»Ÿ" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Android Inputå­ç³»ç»Ÿ"></a>ï¼ˆå…­ï¼‰ã€Android Inputå­ç³»ç»Ÿ</h2><p>è¾“å…¥å­ç³»ç»Ÿçš„ç³»ç»Ÿæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/07-Linux-kernel-android-input-system.png" alt="Markdown"></p><p>è¯¦ç»†åˆ†æè¯·å‚è€ƒï¼šAndroid 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ-Input System åˆ†æ</p><h2 id="ï¼ˆä¸ƒï¼‰ã€Input-è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰"><a href="#ï¼ˆä¸ƒï¼‰ã€Input-è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€Input è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰"></a>ï¼ˆä¸ƒï¼‰ã€Input è®¾å¤‡é©±åŠ¨å±‚å®ä¾‹ï¼ˆSynapticsï¼‰</h2><p>è§¦æ‘¸å±ä¹Ÿæ˜¯ç”¨ä¸Šé¢è¿™ä¸€å¥—æ¡†æ¶æ¥æ“ä½œçš„ã€‚å³è¾¹éœ€è¦ä¸€ä¸ªâ€evdev.câ€æ–‡ä»¶ã€‚å·¦è¾¹è¦åˆ†é…ä¸€ä¸ªâ€input_devâ€ç»“æ„ã€‚æ¥ç€å°±çœ‹ä¸Šå›¾çš„ç¡¬ä»¶è®¾å¤‡å·¦è¾¹çš„è¿‡ç¨‹ï¼šåˆ†é…ä¸€ä¸ªâ€input_devâ€ç»“æ„ä½“ â€“&gt; è®¾ç½®è¿™ä¸ªâ€input_devâ€ç»“æ„ä½“ â€“&gt; æ³¨å†Œè¿™ä¸ªâ€input_devâ€ç»“æ„ä½“ â€“&gt; ç¡¬ä»¶ç›¸å…³çš„æ“ä½œã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/linux.input/08-Linux-kernel-input-drivers-fw.png" alt="Markdown"></p><p>ç¼–å†™Inputé©±åŠ¨ä¸€èˆ¬æ¡†æ¶:</p><p>Google Pixelã€Pixel XL è§¦æ§é©±åŠ¨æ¨¡å—å‹å·ä¸ºSynapticsï¼ˆClearPad S3708ï¼‰ï¼Œæºç ï¼š<a href="https://github.com/matthewdalex/marlin/tree/2f567606935d601f1391ad9575b103f35737a438/drivers/input/touchscreen/synaptics_dsx_htc_2.6" target="_blank" rel="noopener">Synaptics è§¦æ‘¸å±é©±åŠ¨æºç </a></p><p>Makefileï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;drivers/input/touchscreen/synaptics_dsx_htc_2<span class="number">.6</span>/Makefile]</span><br><span class="line">#</span><br><span class="line"># Makefile <span class="keyword">for</span> the Synaptics DSX touchscreen driver.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Each configuration option enables a <span class="built_in">list</span> of files.</span><br><span class="line"></span><br><span class="line">obj-$(CONFIG_TOUCHSCREEN_SYNAPTICS_DSX_I2C_HTC_v26) += synaptics_dsx_i2c.o</span><br><span class="line">obj-$(CONFIG_TOUCHSCREEN_SYNAPTICS_DSX_SPI_HTC_v26) += synaptics_dsx_spi.o</span><br><span class="line">obj-$(CONFIG_TOUCHSCREEN_SYNAPTICS_DSX_CORE_HTC_v26) += synaptics_dsx_core.o</span><br><span class="line">obj-$(CONFIG_TOUCHSCREEN_SYNAPTICS_DSX_RMI_DEV_HTC_v26) += synaptics_dsx_rmi_dev.o</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>æŠ“å–kernel logï¼šå¯çŸ¥input é©±åŠ¨åä¸ºsynaptics_dsxv26ï¼Œå…¨å±€æœç´¢å¯çŸ¥synaptics_rmi4_f12_initåœ¨[-&gt;synaptics_dsx_core.c]ä¸­ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">1.362728</span>] c3      <span class="number">1</span> [TP]:synaptics_rmi4_f12_init: Function <span class="number">12</span> max x = <span class="number">1079</span> max y = <span class="number">1919</span> Rx: <span class="number">16</span> Tx: <span class="number">28</span></span><br><span class="line">[    <span class="number">1.363344</span>] c3      <span class="number">1</span> [TP]synaptics_rmi4_f12_init:Wakeup Gesture range (<span class="number">0</span>,<span class="number">0</span>) -&gt; (<span class="number">1079</span>,<span class="number">1919</span>)</span><br><span class="line">[    <span class="number">1.363623</span>] c3      <span class="number">1</span> [TP]:synaptics_rmi4_f12_init report data init done</span><br><span class="line">[    <span class="number">1.371945</span>] c3      <span class="number">1</span> [TP]:synaptics_rmi4_query_device: chip_id:<span class="number">3708</span>, firmware_id:<span class="number">2433782</span></span><br><span class="line">[    <span class="number">1.372865</span>] c3      <span class="number">1</span> [TP]:synaptics_rmi4_query_device: config_version: <span class="number">5331763200190000000000000000000000000000000000000000000000000000</span></span><br><span class="line">[    <span class="number">1.373249</span>] c3      <span class="number">1</span> input: synaptics_dsxv26 as /devices/soc/<span class="number">7577000.</span>i2c/i2c<span class="number">-3</span>/<span class="number">3</span><span class="number">-0020</span>/input/input3</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹inputè®¾å¤‡ï¼šadb shell cat /proc/bus/input/devices</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">I: Bus=0000 Vendor=0000 Product=0003 Version=2066</span><br><span class="line">N: Name=&quot;synaptics_dsxv26&quot;</span><br><span class="line">P: Phys=synaptics_dsx/touch_input</span><br><span class="line">S: Sysfs=/devices/soc/7577000.i2c/i2c-3/3-0020/input/input3</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=mdss_fb kgsl event3</span><br><span class="line">B: PROP=2</span><br><span class="line">B: EV=b</span><br><span class="line">B: KEY=8000 0 0</span><br><span class="line">B: ABS=663800000000000</span><br><span class="line"></span><br><span class="line">å¯¹åº”ï¼š/dev/input/event3</span><br></pre></td></tr></table></figure><h2 id="7-1ã€åˆ†é…Input-devç»“æ„ä½“"><a href="#7-1ã€åˆ†é…Input-devç»“æ„ä½“" class="headerlink" title="7.1ã€åˆ†é…Input_devç»“æ„ä½“"></a>7.1ã€åˆ†é…Input_devç»“æ„ä½“</h2><h2 id="7-1-1ã€synaptics-rmi4-f12-init"><a href="#7-1-1ã€synaptics-rmi4-f12-init" class="headerlink" title="7.1.1ã€synaptics_rmi4_f12_init()"></a>7.1.1ã€synaptics_rmi4_f12_init()</h2><p>é¦–å…ˆçœ‹ä¸€ä¸‹åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">synaptics_rmi4_driver</span> = &#123;</span></span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = PLATFORM_DRIVER_NAME,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">#ifdef CONFIG_PM</span><br><span class="line">        .pm = &amp;synaptics_rmi4_dev_pm_ops,</span><br><span class="line">#endif</span><br><span class="line">    &#125;,</span><br><span class="line">    .probe = synaptics_rmi4_probe,</span><br><span class="line">    .remove = synaptics_rmi4_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">synaptics_rmi4_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = synaptics_rmi4_bus_init();</span><br><span class="line">    <span class="keyword">if</span> (retval)</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;synaptics_rmi4_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_init(synaptics_rmi4_init);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ³¨å†Œå¹³å°é©±åŠ¨ï¼Œå½“é©±åŠ¨å’Œè®¾å¤‡åŒ¹é…æˆåŠŸï¼Œç»§ç»­çœ‹ä¸€ä¸‹synaptics_rmi4_probe()å‡½æ•°</p><h2 id="7-1-2ã€synaptics-rmi4-probe"><a href="#7-1-2ã€synaptics-rmi4-probe" class="headerlink" title="7.1.2ã€synaptics_rmi4_probe()"></a>7.1.2ã€synaptics_rmi4_probe()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval, len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> attr_count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_data</span> *<span class="title">rmi4_data</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_hw_interface</span> *<span class="title">hw_if</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">temp</span>;</span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–platform_dataã€board_dataã€rmi4_data</span></span><br><span class="line">    hw_if = pdev-&gt;dev.platform_data;</span><br><span class="line">    bdata = hw_if-&gt;board_data;</span><br><span class="line">    rmi4_data = kzalloc(<span class="keyword">sizeof</span>(*rmi4_data), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;pdev = pdev;</span><br><span class="line">    rmi4_data-&gt;current_page = MASK_8BIT;</span><br><span class="line">    rmi4_data-&gt;hw_if = hw_if;</span><br><span class="line">    rmi4_data-&gt;touch_stopped = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;sensor_sleep = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;irq_enabled = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;fw_updating = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;fingers_on_2d = <span class="literal">false</span>;</span><br><span class="line">    rmi4_data-&gt;update_coords = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;write_buf = devm_kzalloc(&amp;pdev-&gt;dev, I2C_WRITE_BUF_MAX_LEN,</span><br><span class="line">                    GFP_KERNEL);</span><br><span class="line">    rmi4_data-&gt;write_buf_len = I2C_WRITE_BUF_MAX_LEN;</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;irq_enable = synaptics_rmi4_irq_enable;</span><br><span class="line">    rmi4_data-&gt;reset_device = synaptics_rmi4_reset_device;</span><br><span class="line"></span><br><span class="line">    mutex_init(&amp;(rmi4_data-&gt;rmi4_io_ctrl_mutex));</span><br><span class="line">    mutex_init(&amp;(rmi4_data-&gt;rmi4_reset_mutex));</span><br><span class="line"></span><br><span class="line">    retval = synaptics_dsx_regulator_configure(rmi4_data);</span><br><span class="line">    retval = synaptics_dsx_regulator_enable(rmi4_data, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    platform_set_drvdata(pdev, rmi4_data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bdata-&gt;gpio_config) &#123;</span><br><span class="line">        retval = synaptics_rmi4_set_gpio(rmi4_data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        retval = synaptics_dsx_pinctrl_init(rmi4_data);</span><br><span class="line">        <span class="keyword">if</span> (!retval &amp;&amp; rmi4_data-&gt;ts_pinctrl) &#123;</span><br><span class="line">            retval = pinctrl_select_state(rmi4_data-&gt;ts_pinctrl,</span><br><span class="line">                    rmi4_data-&gt;pinctrl_state_active);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        retval = synaptics_dsx_gpio_configure(rmi4_data, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bdata-&gt;fw_name) &#123;</span><br><span class="line">        len = <span class="built_in">strlen</span>(bdata-&gt;fw_name);</span><br><span class="line"></span><br><span class="line">        strlcpy(rmi4_data-&gt;fw_name, bdata-&gt;fw_name, len + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ†é…Input_devç»“æ„ä½“ï¼Œè®¾ç½®ï¼Œæ³¨å†Œ</span></span><br><span class="line">    retval = synaptics_rmi4_set_input_dev(rmi4_data);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;irq = gpio_to_irq(bdata-&gt;irq_gpio);</span><br><span class="line">    <span class="comment">//è¯·æ±‚ä¸­æ–­ï¼Œå¹¶è®¾ç½®ä¸­æ–­å¤„ç†å‡½æ•°synaptics_rmi4_irq</span></span><br><span class="line">    retval = synaptics_rmi4_irq_enable(rmi4_data, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!exp_data.initialized) &#123;</span><br><span class="line">        mutex_init(&amp;exp_data.mutex);</span><br><span class="line">        INIT_LIST_HEAD(&amp;exp_data.<span class="built_in">list</span>);</span><br><span class="line">        exp_data.initialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    exp_data.workqueue = create_singlethread_workqueue(<span class="string">"dsx_exp_workqueue"</span>);</span><br><span class="line">    INIT_DELAYED_WORK(&amp;exp_data.work, synaptics_rmi4_exp_fn_work);</span><br><span class="line">    exp_data.rmi4_data = rmi4_data;</span><br><span class="line">    exp_data.queue_work = <span class="literal">true</span>;</span><br><span class="line">    queue_delayed_work(exp_data.workqueue,</span><br><span class="line">            &amp;exp_data.work,</span><br><span class="line">            msecs_to_jiffies(EXP_FN_WORK_DELAY_MS));</span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;dir = debugfs_create_dir(DEBUGFS_DIR_NAME, <span class="literal">NULL</span>);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (attr_count = <span class="number">0</span>; attr_count &lt; ARRAY_SIZE(attrs); attr_count++) &#123;</span><br><span class="line">        retval = sysfs_create_file(&amp;rmi4_data-&gt;input_dev-&gt;dev.kobj,</span><br><span class="line">                &amp;attrs[attr_count].attr);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synaptics_secure_touch_init(rmi4_data);</span><br><span class="line">    synaptics_secure_touch_stop(rmi4_data, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-1-3ã€åˆ†é…Input-devç»“æ„ä½“"><a href="#7-1-3ã€åˆ†é…Input-devç»“æ„ä½“" class="headerlink" title="7.1.3ã€åˆ†é…Input_devç»“æ„ä½“"></a>7.1.3ã€åˆ†é…Input_devç»“æ„ä½“</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_set_input_dev</span><span class="params">(struct synaptics_rmi4_data *rmi4_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span> =</span></span><br><span class="line"><span class="class">                <span class="title">rmi4_data</span>-&gt;<span class="title">hw_if</span>-&gt;<span class="title">board_data</span>;</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev = input_allocate_device();</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹-set-bit-EV-SYN-evbit-ã€set-bit-EV-KEY-evbit-ã€set-bit-EV-ABS-evbit-â€¦â€¦"><a href="#7-2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹-set-bit-EV-SYN-evbit-ã€set-bit-EV-KEY-evbit-ã€set-bit-EV-ABS-evbit-â€¦â€¦" class="headerlink" title="7.2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹ set_bit(EV_SYN, evbit)ã€set_bit(EV_KEY, evbit)ã€set_bit(EV_ABS,evbit) â€¦â€¦"></a>7.2ã€è®¾ç½®æ”¯æŒäº‹ä»¶ç±»å‹ set_bit(EV_SYN, evbit)ã€set_bit(EV_KEY, evbit)ã€set_bit(EV_ABS,evbit) â€¦â€¦</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_set_input_dev</span><span class="params">(struct synaptics_rmi4_data *rmi4_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span> =</span></span><br><span class="line"><span class="class">                <span class="title">rmi4_data</span>-&gt;<span class="title">hw_if</span>-&gt;<span class="title">board_data</span>;</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev = input_allocate_device();</span><br><span class="line">    ......</span><br><span class="line">    retval = synaptics_rmi4_query_device(rmi4_data);</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//#define PLATFORM_DRIVER_NAME "synaptics_dsxv26"(synaptics_dsx_v2_6.h)</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;name = PLATFORM_DRIVER_NAME;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;phys = INPUT_PHYS_NAME;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;id.product = SYNAPTICS_DSX_DRIVER_PRODUCT;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;id.version = SYNAPTICS_DSX_DRIVER_VERSION;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;dev.parent = rmi4_data-&gt;pdev-&gt;dev.parent;</span><br><span class="line">    input_set_drvdata(rmi4_data-&gt;input_dev, rmi4_data);</span><br><span class="line"></span><br><span class="line">    set_bit(EV_SYN, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(EV_KEY, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(EV_ABS, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(BTN_TOUCH, rmi4_data-&gt;input_dev-&gt;keybit);</span><br><span class="line">    set_bit(BTN_TOOL_FINGER, rmi4_data-&gt;input_dev-&gt;keybit);</span><br><span class="line"></span><br><span class="line">    synaptics_rmi4_set_params(rmi4_data);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-3ã€æ³¨å†Œè®¾å¤‡input-register-device"><a href="#7-3ã€æ³¨å†Œè®¾å¤‡input-register-device" class="headerlink" title="7.3ã€æ³¨å†Œè®¾å¤‡input_register_device()"></a>7.3ã€æ³¨å†Œè®¾å¤‡input_register_device()</h2><p>æ­¤å¤„å³ä¸å‰é¢kernel logå‘¼åº”ï¼šæ³¨å†Œåä¸º synaptics_dsxv26 çš„è¾“å…¥è®¾å¤‡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_set_input_dev</span><span class="params">(struct synaptics_rmi4_data *rmi4_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span> =</span></span><br><span class="line"><span class="class">                <span class="title">rmi4_data</span>-&gt;<span class="title">hw_if</span>-&gt;<span class="title">board_data</span>;</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev = input_allocate_device();</span><br><span class="line">    ......</span><br><span class="line">    retval = synaptics_rmi4_query_device(rmi4_data);</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//#define PLATFORM_DRIVER_NAME "synaptics_dsxv26"(synaptics_dsx_v2_6.h)</span></span><br><span class="line"></span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;name = PLATFORM_DRIVER_NAME;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;phys = INPUT_PHYS_NAME;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;id.product = SYNAPTICS_DSX_DRIVER_PRODUCT;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;id.version = SYNAPTICS_DSX_DRIVER_VERSION;</span><br><span class="line">    rmi4_data-&gt;input_dev-&gt;dev.parent = rmi4_data-&gt;pdev-&gt;dev.parent;</span><br><span class="line">    input_set_drvdata(rmi4_data-&gt;input_dev, rmi4_data);</span><br><span class="line"></span><br><span class="line">    set_bit(EV_SYN, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(EV_KEY, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(EV_ABS, rmi4_data-&gt;input_dev-&gt;evbit);</span><br><span class="line">    set_bit(BTN_TOUCH, rmi4_data-&gt;input_dev-&gt;keybit);</span><br><span class="line">    set_bit(BTN_TOOL_FINGER, rmi4_data-&gt;input_dev-&gt;keybit);</span><br><span class="line"></span><br><span class="line">    synaptics_rmi4_set_params(rmi4_data);</span><br><span class="line">    ......</span><br><span class="line">    retval = input_register_device(rmi4_data-&gt;input_dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ"><a href="#7-4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ" class="headerlink" title="7.4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ"></a>7.4ã€ç¡¬ä»¶ç›¸å…³æ“ä½œ</h2><p>å½“è§¦æ‘¸å±æŒ‰ä¸‹ï¼Œä¼šäº§ç”Ÿä¸­æ–­ï¼Œè¿›è€Œè°ƒç”¨ä¸­æ–­å¤„ç†å‡½æ•°synaptics_rmi4_irq():</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> irqreturn_t <span class="title">synaptics_rmi4_irq</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_data</span> *<span class="title">rmi4_data</span> = <span class="title">data</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_dsx_board_data</span> *<span class="title">bdata</span> =</span></span><br><span class="line"><span class="class">            <span class="title">rmi4_data</span>-&gt;<span class="title">hw_if</span>-&gt;<span class="title">board_data</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IRQ_HANDLED == synaptics_filter_interrupt(data))</span><br><span class="line">        <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gpio_get_value(bdata-&gt;irq_gpio) != bdata-&gt;irq_on_state)</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line"></span><br><span class="line">    synaptics_rmi4_sensor_report(rmi4_data, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥è°ƒç”¨synaptics_rmi4_sensor_report(rmi4_data, true)å¤„ç†æ•°æ®ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synaptics_rmi4_sensor_report</span><span class="params">(struct synaptics_rmi4_data *rmi4_data,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">bool</span> report)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> data[MAX_INTR_REGISTERS + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *intr = &amp;data[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">bool</span> was_in_bl_mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_f01_device_status</span> <span class="title">status</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_fn</span> *<span class="title">fhandler</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_exp_fhandler</span> *<span class="title">exp_fhandler</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_device_info</span> *<span class="title">rmi</span>;</span></span><br><span class="line"></span><br><span class="line">    rmi = &amp;(rmi4_data-&gt;rmi4_mod_info);</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    retval = synaptics_rmi4_reg_read(rmi4_data,</span><br><span class="line">            rmi4_data-&gt;f01_data_base_addr,</span><br><span class="line">            data,</span><br><span class="line">            rmi4_data-&gt;num_of_intr_regs + <span class="number">1</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//è¯»å–å¯„å­˜å™¨æ•°æ®</span></span><br><span class="line">    status.data[<span class="number">0</span>] = data[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (status.status_code == STATUS_CRC_IN_PROGRESS) &#123;</span><br><span class="line">        retval = synaptics_rmi4_check_status(rmi4_data,</span><br><span class="line">                &amp;was_in_bl_mode);</span><br><span class="line">        ....</span><br><span class="line">        retval = synaptics_rmi4_reg_read(rmi4_data,</span><br><span class="line">                rmi4_data-&gt;f01_data_base_addr,</span><br><span class="line">                status.data,</span><br><span class="line">                <span class="keyword">sizeof</span>(status.data));</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status.unconfigured &amp;&amp; !status.flash_prog) &#123;</span><br><span class="line">        pr_notice(<span class="string">"%s: spontaneous reset detected\n"</span>, __func__);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//synaptics_rmi4_report_touch()ä¸ŠæŠ¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (!list_empty(&amp;rmi-&gt;support_fn_list)) &#123;</span><br><span class="line">        list_for_each_entry(fhandler, &amp;rmi-&gt;support_fn_list, link) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fhandler-&gt;num_of_data_sources) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fhandler-&gt;intr_mask &amp;</span><br><span class="line">                        intr[fhandler-&gt;intr_reg_num]) &#123;</span><br><span class="line">                    synaptics_rmi4_report_touch(rmi4_data,</span><br><span class="line">                            fhandler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;exp_data.mutex);</span><br><span class="line">    <span class="keyword">if</span> (!list_empty(&amp;exp_data.<span class="built_in">list</span>)) &#123;</span><br><span class="line">        list_for_each_entry(exp_fhandler, &amp;exp_data.<span class="built_in">list</span>, link) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!exp_fhandler-&gt;insert &amp;&amp;</span><br><span class="line">                    !exp_fhandler-&gt;remove &amp;&amp;</span><br><span class="line">                    (exp_fhandler-&gt;exp_fn-&gt;attn != <span class="literal">NULL</span>))</span><br><span class="line">                exp_fhandler-&gt;exp_fn-&gt;attn(rmi4_data, intr[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;exp_data.mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-4-1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š"><a href="#7-4-1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š" class="headerlink" title="7.4.1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š"></a>7.4.1ã€Inputæ•°æ®ä¸ŠæŠ¥ï¼š</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;synaptics_dsx_core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synaptics_rmi4_report_touch</span><span class="params">(struct synaptics_rmi4_data *rmi4_data,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct synaptics_rmi4_fn *fhandler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">switch</span> (fhandler-&gt;fn_number) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> SYNAPTICS_RMI4_F12:</span><br><span class="line">        touch_count_2d = synaptics_rmi4_f12_abs_report(rmi4_data,</span><br><span class="line">                fhandler);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (touch_count_2d)</span><br><span class="line">            rmi4_data-&gt;fingers_on_2d = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            rmi4_data-&gt;fingers_on_2d = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">synaptics_rmi4_f12_abs_report</span><span class="params">(struct synaptics_rmi4_data *rmi4_data,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct synaptics_rmi4_fn *fhandler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> touch_count = <span class="number">0</span>; <span class="comment">/* number of touch points */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> finger;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> fingers_to_process;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> finger_status;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> size_of_2d_data;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> gesture_type;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> data_addr;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line">    <span class="keyword">int</span> wx;</span><br><span class="line">    <span class="keyword">int</span> wy;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_f12_extra_data</span> *<span class="title">extra_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_f12_finger_data</span> *<span class="title">data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">synaptics_rmi4_f12_finger_data</span> *<span class="title">finger_data</span>;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> finger_presence;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> stylus_presence;</span><br><span class="line"></span><br><span class="line">    fingers_to_process = fhandler-&gt;num_of_data_points;</span><br><span class="line">    data_addr = fhandler-&gt;full_addr.data_base;</span><br><span class="line">    extra_data = (struct synaptics_rmi4_f12_extra_data *)fhandler-&gt;extra;</span><br><span class="line">    size_of_2d_data = <span class="keyword">sizeof</span>(struct synaptics_rmi4_f12_finger_data);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    retval = synaptics_rmi4_reg_read(rmi4_data,</span><br><span class="line">            data_addr + extra_data-&gt;data1_offset,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)fhandler-&gt;data,</span><br><span class="line">            fingers_to_process * size_of_2d_data);</span><br><span class="line">    <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    data = (struct synaptics_rmi4_f12_finger_data *)fhandler-&gt;data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;(rmi4_data-&gt;rmi4_report_mutex));</span><br><span class="line">    <span class="comment">//æ ¹æ®è§¦æ‘¸ç‚¹æ•°é‡å¾ªç¯ä¸ŠæŠ¥inputæ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span> (finger = <span class="number">0</span>; finger &lt; fingers_to_process; finger++) &#123;</span><br><span class="line">        finger_data = data + finger;</span><br><span class="line">        finger_status = finger_data-&gt;object_type_and_status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        x = (finger_data-&gt;x_msb &lt;&lt; <span class="number">8</span>) | (finger_data-&gt;x_lsb);</span><br><span class="line">        y = (finger_data-&gt;y_msb &lt;&lt; <span class="number">8</span>) | (finger_data-&gt;y_lsb);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rmi4_data-&gt;hw_if-&gt;board_data-&gt;swap_axes) &#123;</span><br><span class="line">            temp = x;</span><br><span class="line">            x = y;</span><br><span class="line">            y = temp;</span><br><span class="line">            temp = wx;</span><br><span class="line">            wx = wy;</span><br><span class="line">            wy = temp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rmi4_data-&gt;hw_if-&gt;board_data-&gt;x_flip)</span><br><span class="line">            x = rmi4_data-&gt;sensor_max_x - x;</span><br><span class="line">        <span class="keyword">if</span> (rmi4_data-&gt;hw_if-&gt;board_data-&gt;y_flip)</span><br><span class="line">            y = rmi4_data-&gt;sensor_max_y - y;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (finger_status) &#123;</span><br><span class="line">        <span class="keyword">case</span> F12_FINGER_STATUS:</span><br><span class="line">        <span class="keyword">case</span> F12_GLOVED_FINGER_STATUS:</span><br><span class="line"></span><br><span class="line">            input_report_key(rmi4_data-&gt;input_dev,</span><br><span class="line">                    BTN_TOUCH, <span class="number">1</span>);</span><br><span class="line">            input_report_key(rmi4_data-&gt;input_dev,</span><br><span class="line">                    BTN_TOOL_FINGER, <span class="number">1</span>);</span><br><span class="line">            input_report_abs(rmi4_data-&gt;input_dev,</span><br><span class="line">                    ABS_MT_POSITION_X, x);</span><br><span class="line">            input_report_abs(rmi4_data-&gt;input_dev,</span><br><span class="line">                    ABS_MT_POSITION_Y, y);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    input_sync(rmi4_data-&gt;input_dev);</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;(rmi4_data-&gt;rmi4_report_mutex));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> touch_count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨input_report_key()ã€input_report_abs()ã€input_sync() ä¸ŠæŠ¥ã€åŒæ­¥æ•°æ®ã€‚</p><h2 id="ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå…«ï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h2><p><a href="https://blog.csdn.net/column/details/input.html" target="_blank" rel="noopener">Linux/Androidâ€”-Inputç³»ç»Ÿ</a><br><a href="https://blog.csdn.net/tiantangniaochao/article/details/50497353" target="_blank" rel="noopener">Android Inputå­ç³»ç»Ÿæµ…è°ˆ</a><br><a href="http://huaqianlee.github.io/2017/11/23/Android/Android-Linux-input-system-analysis/" target="_blank" rel="noopener">Android(Linux) è¾“å…¥å­ç³»ç»Ÿè§£æ</a><br><a href="http://www.cnblogs.com/jason-lu/p/3156411.html" target="_blank" rel="noopener">inputå­ç³»ç»Ÿåˆ†æä¹‹ä¸‰:é©±åŠ¨æ¨¡å—</a><br><a href="https://blog.csdn.net/fanwenjieok/article/details/38503027" target="_blank" rel="noopener">Linuxé©±åŠ¨æ¡†æ¶ä¹‹â€”-Inputå­ç³»ç»Ÿ</a><br><a href="https://www.zybuluo.com/zifehng/note/718523" target="_blank" rel="noopener">inputå­ç³»ç»Ÿäº‹ä»¶å¤„ç†å±‚(evdev)çš„ç¯å½¢ç¼“å†²åŒº</a><br><a href="https://blog.csdn.net/ielife/article/details/7814108" target="_blank" rel="noopener">linux inputè¾“å…¥å­ç³»ç»Ÿåˆ†æã€Šå››ã€‹ï¼šinputå­ç³»ç»Ÿæ•´ä½“æµç¨‹å…¨é¢åˆ†æ</a><br><a href="https://blog.csdn.net/yueqian_scut/article/details/48792939" target="_blank" rel="noopener">Linux inputå­ç³»ç»Ÿåˆ†æä¹‹äºŒï¼šæ·±å…¥å‰–æinput_handlerã€input_coreã€input_device</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/04/01/Linuxå†…æ ¸ï¼ˆKernel-3-18ï¼‰-Input-å­ç³»ç»Ÿåˆ†æ-i-wonder/">http://zhoujinjian.cc/2018/04/01/Linuxå†…æ ¸ï¼ˆKernel-3-18ï¼‰-Input-å­ç³»ç»Ÿåˆ†æ-i-wonder/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-çª—å£ç®¡ç†æœåŠ¡åˆ†æ-i-wonder/" title="Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]"><i class="iconfont icon-prev"></i>Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]</a></div><div class="post__prev post__prev--right"><a href="/2018/04/03/ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif)/" title="ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]">ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">24</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.08.jpg" alt="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/" title="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.25.jpg" alt="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</h3><span class="item__text">2018-09-06</span></div></a></li><li class="latest-post-item"><a href="/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/" title="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" alt="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</h3><span class="item__text">2018-08-30</span></div></a></li><li class="latest-post-item"><a href="/2018/08/16/Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ/" title="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.22.jpg" alt="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ</h3><span class="item__text">2018-08-16</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">350.7k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>