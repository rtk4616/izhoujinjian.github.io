<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/05/15/Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.14.jpg" alt="Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ"></div><header class="post__info"><h1 class="post__title">Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://www.github.com/izhoujinjian">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-05-15</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰-Overview"><span class="toc-text">ï¼ˆä¸€ï¼‰ Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ASoC-Core"><span class="toc-text">ï¼ˆäºŒï¼‰ASoC Core</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰Codec-Driver"><span class="toc-text">ï¼ˆä¸‰ï¼‰Codec Driver</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-Codec-DAI-and-PCM-configuration"><span class="toc-text">3.1. Codec DAI and PCM configuration</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-Codec-control-IO"><span class="toc-text">3.2. Codec control IO</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-Mixers-and-audio-controls"><span class="toc-text">3.3. Mixers and audio controls</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-Codec-audio-operations"><span class="toc-text">3.6. Codec audio operations</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-Codec-register"><span class="toc-text">3.6. Codec register</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå››ï¼‰Platform-Driver"><span class="toc-text">ï¼ˆå››ï¼‰Platform Driver</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-pcm-operations"><span class="toc-text">4.1. pcm operations</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-platform-driver-æ³¨å†Œ"><span class="toc-text">4.1. platform_driver æ³¨å†Œ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäº”ï¼‰-Machine-Driver"><span class="toc-text">ï¼ˆäº”ï¼‰ Machine Driver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ-PCM-è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹"><span class="toc-text">ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ PCM è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-1-å£°å¡ç»“æ„æ¦‚è¿°"><span class="toc-text">6.1. å£°å¡ç»“æ„æ¦‚è¿°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-å£°å¡çš„åˆ›å»ºsnd-card-create"><span class="toc-text">6.2. å£°å¡çš„åˆ›å»ºsnd_card_create()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-é€»è¾‘è®¾å¤‡çš„åˆ›å»º"><span class="toc-text">6.3. é€»è¾‘è®¾å¤‡çš„åˆ›å»º</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-4-å£°å¡çš„æ³¨å†Œ"><span class="toc-text">6.4. å£°å¡çš„æ³¨å†Œ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ"><span class="toc-text">ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1ã€DAPMç®€ä»‹"><span class="toc-text">7.1ã€DAPMç®€ä»‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1ã€kcontrol"><span class="toc-text">7.1ã€kcontrol</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-1ã€ç®€å•å‹çš„æ§ä»¶"><span class="toc-text">7.1.1ã€ç®€å•å‹çš„æ§ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-2ã€Mixeræ§ä»¶"><span class="toc-text">7.1.2ã€Mixeræ§ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-3ã€Muxæ§ä»¶"><span class="toc-text">7.1.3ã€Muxæ§ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2ã€widgetã€pathã€route"><span class="toc-text">7.2ã€widgetã€pathã€route</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget"><span class="toc-text">7.2.1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-2ã€widgetçš„ç§ç±»"><span class="toc-text">7.2.2ã€widgetçš„ç§ç±»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath"><span class="toc-text">7.2.3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute"><span class="toc-text">7.2.4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»"><span class="toc-text">7.3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-1ã€åˆ›å»ºwidget"><span class="toc-text">7.3.1ã€åˆ›å»ºwidget</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-2ã€ä¸ºwidgetå»ºç«‹dapm-kcontrol"><span class="toc-text">7.3.2ã€ä¸ºwidgetå»ºç«‹dapm kcontrol</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-2-1ã€snd-soc-dapm-new-widgetså‡½æ•°"><span class="toc-text">7.3.2.1ã€snd_soc_dapm_new_widgetså‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-2-2ã€dapm-mixer-kcontrol"><span class="toc-text">7.3.2.2ã€dapm mixer kcontrol</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-2-3ã€dapm-mux-kcontrol"><span class="toc-text">7.3.2.3ã€dapm mux kcontrol</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-2-4ã€dapm-pga-kcontrol"><span class="toc-text">7.3.2.4ã€dapm pga kcontrol</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-2-5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»"><span class="toc-text">7.3.2.5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå…«ï¼‰ã€tinyplay-playbackã€capture"><span class="toc-text">ï¼ˆå…«ï¼‰ã€tinyplay playbackã€capture</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1ã€tinyplay-playback"><span class="toc-text">8.1ã€tinyplay playback</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1ã€ä½¿ç”¨è€³æœºæ’­æ”¾"><span class="toc-text">8.1.1ã€ä½¿ç”¨è€³æœºæ’­æ”¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-2ã€tinyplay-capture"><span class="toc-text">8.2ã€tinyplay capture</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-2-1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶"><span class="toc-text">8.2.1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div><hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/audio.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p><a href="https://blog.csdn.net/zyuanyun" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - é›²å’Œå±±çš„å½¼ç«¯ - éŸ³é¢‘ç³»ç»Ÿåˆ†æã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆKernel-3.18ï¼‰ï¼š<br><a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆAndroid 7.1.2ï¼‰ï¼š<br><a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener">Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>æºç ï¼ˆä¸»è¦æºç è·¯å¾„ï¼‰ï¼š</p><blockquote><p>User space audio code æºç ï¼š</p></blockquote><p>â€¢ <strong>/hardware/qcom/audio/hal/ â€“ (Audio HAL æºç )</strong></p><p>â€¢ <strong>/external/tinyalsa/ â€“ (tinymix, tinyplay, tinycap æºç )</strong></p><p>â€¢ <strong>/vendor/qcom/proprietary/mm-audio/ â€“ (QTI OMX audio encoder and decoders æºç ï¼Œæœªå…¬å¼€)</strong></p><p>â€¢ <strong>/frameworks/av/media/audioserver/ â€“ (Audioserver æºç )</strong></p><p>â€¢ <strong>/frameworks/av/media/libstagefright/ â€“ (Google Stagefright å¤šåª’ä½“æ¡†æ¶æºç )</strong></p><p>â€¢ <strong>/frameworks/av/services/audioflinger/ â€“ (Audioflinger ç›¸å…³æºç )</strong></p><p>â€¢ <strong>/external/bluetooth/bluedroid/ â€“ (A2DP audio HAL ç›¸å…³æºç )</strong>/</p><p>â€¢ <strong>/hardware/libhardware/modules/usbaudio/ â€“ (USB HAL æºç )</strong>/</p><p>â€¢ <strong>/vendor/qcom/proprietary/wfd/mm/source/framework/src/ â€“ (Wi-Fi Display (WFD)ã€ WFDMMSourceAudioSource.cppï¼Œæœªå…¬å¼€)</strong></p><p>â€¢ <strong>/system/core/include/system/ â€“ (audio.h)</strong>/</p><blockquote><p>Kernel space audio code æºç ï¼š</p></blockquote><p>â€¢ <strong>/kernel/sound/soc/msm/ â€“ msm8996.c machine driver æºç </strong></p><p>â€¢ <strong>/kernel/sound/soc/msm/qdsp6v2 â€“ platform drivers, front end (FE), and back-end (BE) DAI driver, Hexagon DSP drivers for AFE, ADM, and ASM, voice driver ç›¸å…³æºç </strong></p><p>â€¢ <strong>kernel/sound/soc/soc-<em>.c â€“ All the SoC-</em>.c ALSA SoCs framework æºç </strong></p><p>â€¢ <strong>kernel/drivers/slimbus/ â€“ SLIMbus driver æºç </strong></p><p>â€¢ <strong>kernel/arch/arm/mach-msm/ â€“ åŒ…å«æ¯”å¦‚ acpuclock-8996.c, board-8996-gpiomux.c, board-8996.c, and clock-8996.c related to the GPIO, clock, and board-specific information on the MSM8996 ç›¸å…³æºç </strong></p><p>â€¢ <strong>/kernel/arch/arm/mach-msm/qdsp6v2/ â€“ Contains the drivers for DSP-based encoders and decoders, code for the aDSP loader, APR driver, Ion memory driver, and other utility files</strong></p><p>â€¢ <strong>/kernel/arch/arm/boot/dts â€“ Contains MSM8996-<em>.its and MSM8996-</em>.Dtsi files that contain MSM8996-specific information; audio-related customization is available in files such as MSM8996.dtsi, msm8996-mtp.dtsi, and msm8996-cdp.dtsi</strong></p><p>â€¢ <strong>/kernel/sound/soc/codecs/ â€“ Contains the source code for the codec driver for WCD9335; codec driver-related source files are wcd9335.c, wcd9xxx-mbhc.c, wcd9xxx-resmgr.c, wcd9xxx-common.c, and so on.</strong></p><p>â€¢ <strong>/kernel/drivers/mfd/ â€“ Contains the source code for the codec driver; wcd9xxx-core.c, wcd9xxx-slimslave.c, and wcd9xxx-irq.c are the codec driverrelated files</strong></p><h4 id="ï¼ˆä¸€ï¼‰-Overview"><a href="#ï¼ˆä¸€ï¼‰-Overview" class="headerlink" title="ï¼ˆä¸€ï¼‰ Overview"></a>ï¼ˆä¸€ï¼‰ Overview</h4><p>ç¡¬ä»¶å¹³å°åŠè½¯ä»¶ç‰ˆæœ¬ï¼š<br>â˜ Kernel - 3.18<br>â˜ SoC - Qualcomm snapdragon<br>â˜ CODEC - WCD9335<br>â˜ Machine - msm8996<br>â˜ Userspace - tinyalsa</p><p>Linux ALSA éŸ³é¢‘ç³»ç»Ÿæ¶æ„å¤§è‡´å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/21-Audio-system-Android-Linux-ASoc-arc.png.png" alt="Alt text"></p><p>â€¢ Native ALSA Applicationï¼štinyplay/tinycap/tinymixï¼Œè¿™äº›ç”¨æˆ·ç¨‹åºç›´æ¥è°ƒç”¨ alsa ç”¨æˆ·åº“æ¥å£æ¥å®ç°æ”¾éŸ³ã€å½•éŸ³ã€æ§åˆ¶<br>â€¢ ALSA Library APIï¼šalsa ç”¨æˆ·åº“æ¥å£ï¼Œå¸¸è§æœ‰ tinyalsaã€alsa-lib<br>â€¢ ALSA COREï¼šalsa æ ¸å¿ƒå±‚ï¼Œå‘ä¸Šæä¾›é€»è¾‘è®¾å¤‡ï¼ˆPCM/CTL/MIDI/TIMER/â€¦ï¼‰ç³»ç»Ÿè°ƒç”¨ï¼Œå‘ä¸‹é©±åŠ¨ç¡¬ä»¶è®¾å¤‡ï¼ˆMachine/I2S/DMA/CODECï¼‰<br>â€¢ ASoC COREï¼šasoc æ˜¯å»ºç«‹åœ¨æ ‡å‡† alsa core åŸºç¡€ä¸Šï¼Œä¸ºäº†æ›´å¥½æ”¯æŒåµŒå…¥å¼ç³»ç»Ÿå’Œåº”ç”¨äºç§»åŠ¨è®¾å¤‡çš„éŸ³é¢‘ codec çš„ä¸€å¥—è½¯ä»¶ä½“ç³»<br>â€¢ Hardware Driverï¼šéŸ³é¢‘ç¡¬ä»¶è®¾å¤‡é©±åŠ¨ï¼Œç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ Machineã€Platformã€Codec</p><p>Platformï¼šæŒ‡æŸæ¬¾ SoC å¹³å°çš„éŸ³é¢‘æ¨¡å—ï¼Œå¦‚ exynosã€omapã€qcom ç­‰ç­‰ã€‚Platform åˆå¯ç»†åˆ†ä¸¤éƒ¨åˆ†ï¼š</p><p>â€¢ cpu daiï¼šåœ¨åµŒå…¥å¼ç³»ç»Ÿé‡Œé¢é€šå¸¸æŒ‡ SoC çš„ I2Sã€PCM æ€»çº¿æ§åˆ¶å™¨ï¼Œè´Ÿè´£æŠŠéŸ³é¢‘æ•°æ®ä» I2S tx FIFO æ¬è¿åˆ° CODECï¼ˆè¿™æ˜¯å›æ”¾çš„æƒ…å½¢ï¼Œå½•åˆ¶åˆ™æ–¹å‘ç›¸åï¼‰ã€‚cpu_dai é€šè¿‡ <strong>snd_soc_register_dai()</strong> æ¥æ³¨å†Œã€‚æ³¨ï¼šDAI æ˜¯ Digital Audio Interface çš„ç®€ç§°ï¼Œåˆ†ä¸º cpu_dai å’Œ codec_daiï¼Œè¿™ä¸¤è€…é€šè¿‡ I2S/PCM æ€»çº¿è¿æ¥ï¼›AIF æ˜¯ Audio Interface çš„ç®€ç§°ï¼ŒåµŒå…¥å¼ç³»ç»Ÿä¸­ä¸€èˆ¬æ˜¯ I2S å’Œ PCM æ¥å£ã€‚<br>â€¢ pcm dmaï¼šè´Ÿè´£æŠŠ dma buffer ä¸­çš„éŸ³é¢‘æ•°æ®æ¬è¿åˆ° I2S tx FIFOã€‚å€¼å¾—ç•™æ„çš„æ˜¯ï¼šæŸäº›æƒ…å½¢ä¸‹æ˜¯ä¸éœ€è¦ dma æ“ä½œçš„ï¼Œæ¯”å¦‚ Modem å’Œ CODEC ç›´è¿ï¼Œå› ä¸º Modem æœ¬èº«å·²ç»æŠŠæ•°æ®é€åˆ° FIFO äº†ï¼Œè¿™æ—¶åªéœ€å¯åŠ¨ codec_dai æ¥æ”¶æ•°æ®å³å¯ï¼›è¯¥æƒ…å½¢ä¸‹ï¼ŒMachine é©±åŠ¨ dai_link ä¸­éœ€è¦è®¾å®š .platform_name = â€œmsm-pcm-xxxâ€ã€‚</p><p>Codecï¼šå¯¹äºå›æ”¾æ¥è¯´ï¼Œuserspace é€è¿‡æ¥çš„éŸ³é¢‘æ•°æ®æ˜¯ç»è¿‡é‡‡æ ·é‡åŒ–çš„æ•°å­—ä¿¡å·ï¼Œåœ¨ codec ç»è¿‡ DAC è½¬æ¢æˆæ¨¡æ‹Ÿä¿¡å·ç„¶åè¾“å‡ºåˆ°å¤–æ”¾æˆ–è€³æœºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¬åˆ°å£°éŸ³äº†ã€‚Codec å­—é¢æ„æ€æ˜¯ç¼–è§£ç å™¨ï¼Œä½†èŠ¯ç‰‡é‡Œé¢çš„åŠŸèƒ½éƒ¨ä»¶å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ AIFã€DACã€ADCã€Mixerã€PGAã€Line-inã€Line-outï¼Œæœ‰äº›é«˜ç«¯çš„ codec èŠ¯ç‰‡è¿˜æœ‰ EQã€DSPã€SRCã€DRCã€AGCã€Echo-Cancellerã€Noise-Suppression ç­‰éƒ¨ä»¶ã€‚</p><p>Machineï¼šæŒ‡æŸæ¬¾æœºå™¨ï¼Œé€šè¿‡é…ç½® dai_link æŠŠ cpu_daiã€codec_daiã€modem_dai å„ä¸ªéŸ³é¢‘æ¥å£ç»™é“¾ç»“æˆä¸€æ¡æ¡éŸ³é¢‘é“¾è·¯ï¼Œç„¶åæ³¨å†Œ snd_soc_cardã€‚å’Œä¸Šé¢ä¸¤ä¸ªä¸ä¸€æ ·ï¼ŒPlatform å’Œ CODEC é©±åŠ¨ä¸€èˆ¬æ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œè€Œ Machine æœ‰å®ƒç‰¹å®šçš„ç¡¬ä»¶ç‰¹æ€§ï¼Œå‡ ä¹æ˜¯ä¸å¯é‡ç”¨çš„ã€‚æ‰€è°“çš„ç¡¬ä»¶ç‰¹æ€§æŒ‡ï¼šSoC Platform ä¸ Codec çš„å·®å¼‚ï¼›DAIs ä¹‹é—´çš„é“¾ç»“æ–¹å¼ï¼›é€šè¿‡æŸä¸ª GPIO æ‰“å¼€ Amplifierï¼›é€šè¿‡æŸä¸ª GPIO æ£€æµ‹è€³æœºæ’æ‹”ï¼›ä½¿ç”¨æŸä¸ªæ—¶é’Ÿå¦‚ MCLK/External-OSC ä½œä¸º I2Sã€CODEC çš„æ—¶é’Ÿæºç­‰ç­‰ã€‚</p><p>ä»ä¸Šé¢çš„æè¿°æ¥çœ‹ï¼Œå¯¹äºå›æ”¾çš„æƒ…å½¢ï¼ŒPCM æ•°æ®æµå‘å¤§è‡´æ˜¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        copy_from_user           DMA                 I2S           DAC</span><br><span class="line">              ^                   ^                   ^             ^</span><br><span class="line">+---------+   |    +----------+   |   +-----------+   |   +-----+   |   +------+</span><br><span class="line">|userspace+--------&gt;DMA Buffer+-------&gt;I2S TX FIFO+-------&gt;CODEC+-------&gt;SPK/HP|</span><br><span class="line">+---------+        +----------+       +-----------+       +-----+       +------+</span><br></pre></td></tr></table></figure><p>å‡ ä¸ªéŸ³é¢‘ç‰©ç†é“¾è·¯çš„æ¦‚å¿µï¼š</p><p>dai_linkï¼šmachine é©±åŠ¨ä¸­å®šä¹‰çš„éŸ³é¢‘æ•°æ®é“¾è·¯ï¼Œå®ƒæŒ‡å®šé“¾è·¯ç”¨åˆ°çš„ codecã€codec_daiã€cpu_daiã€platformã€‚æ¯”å¦‚å¯¹äº WCD9335 å¹³å°çš„ media é“¾è·¯ï¼š.codec_dai_name = â€œsnd-soc-dummy-daiâ€, .codec_name = â€œsnd-soc-dummyâ€, .cpu_dai_name = â€œMultiMediaXâ€, .platform_name = â€œmsm-pcm-dsp.0â€ï¼Œè¿™å››è€…å°±æ„æˆäº†ä¸€æ¡éŸ³é¢‘æ•°æ®é“¾è·¯ç”¨äºå¤šåª’ä½“å£°éŸ³çš„å›æ”¾å’Œå½•åˆ¶ã€‚ä¸€ä¸ªç³»ç»Ÿå¯èƒ½æœ‰å¤šä¸ªéŸ³é¢‘æ•°æ®é“¾è·¯ï¼Œæ¯”å¦‚ media å’Œ voiceï¼Œå› æ­¤å¯ä»¥å®šä¹‰å¤šä¸ª dai_link ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm8996.c]</span><br><span class="line"><span class="comment">/* Digital audio interface glue - connects codec &lt;---&gt; CPU */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> <span class="title">msm8996_common_dai_links</span>[] = &#123;</span></span><br><span class="line">	<span class="comment">/* FrontEnd DAI Links */</span></span><br><span class="line">	&#123;</span><br><span class="line">		.name = <span class="string">"MSM8996 Media1"</span>,</span><br><span class="line">		.stream_name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">		.cpu_dai_name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">		.platform_name = <span class="string">"msm-pcm-dsp.0"</span>,</span><br><span class="line">		.dynamic = <span class="number">1</span>,</span><br><span class="line">		.async_ops = ASYNC_DPCM_SND_SOC_PREPARE,</span><br><span class="line">		.dpcm_playback = <span class="number">1</span>,</span><br><span class="line">		.dpcm_capture = <span class="number">1</span>,</span><br><span class="line">		.trigger = &#123;SND_SOC_DPCM_TRIGGER_POST,</span><br><span class="line">			SND_SOC_DPCM_TRIGGER_POST&#125;,</span><br><span class="line">		.codec_dai_name = <span class="string">"snd-soc-dummy-dai"</span>,</span><br><span class="line">		.codec_name = <span class="string">"snd-soc-dummy"</span>,</span><br><span class="line">		.ignore_suspend = <span class="number">1</span>,</span><br><span class="line">		<span class="comment">/* this dainlink has playback support */</span></span><br><span class="line">		.ignore_pmdown_time = <span class="number">1</span>,</span><br><span class="line">		.be_id = MSM_FRONTEND_DAI_MULTIMEDIA1</span><br><span class="line">	&#125;,</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/22-MSM8996-Linux-Android-Audio-ASoc-Architectre.png" alt="Alt text"></p><p>é«˜é€šå¹³å°å› DSPè€Œå­˜åœ¨ç‰¹æ®Šæ€§ï¼Œå¦‚ä¸Šå›¾ï¼ŒFrontend é“¾æ¥ â€œPlatformâ€ï¼Œç»ç”± â€œPlatformâ€-&gt;Backendé“¾æ¥åˆ°Codecã€‚<br>Front-end DAIï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm-dai-fe.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> <span class="title">msm_fe_dais</span>[] = &#123;</span></span><br><span class="line">	&#123;</span><br><span class="line">		.playback = &#123;</span><br><span class="line">			.stream_name = <span class="string">"MultiMedia1 Playback"</span>,</span><br><span class="line">			.aif_name = <span class="string">"MM_DL1"</span>,</span><br><span class="line">			.rates = (SNDRV_PCM_RATE_8000_192000|</span><br><span class="line">					SNDRV_PCM_RATE_KNOT),</span><br><span class="line">			.formats = (SNDRV_PCM_FMTBIT_S16_LE |</span><br><span class="line">						SNDRV_PCM_FMTBIT_S24_LE |</span><br><span class="line">						SNDRV_PCM_FMTBIT_S24_3LE),</span><br><span class="line">			.channels_min = <span class="number">1</span>,</span><br><span class="line">			.channels_max = <span class="number">8</span>,</span><br><span class="line">			.rate_min =     <span class="number">8000</span>,</span><br><span class="line">			.rate_max =	<span class="number">192000</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		.capture = &#123;</span><br><span class="line">			.stream_name = <span class="string">"MultiMedia1 Capture"</span>,</span><br><span class="line">			.aif_name = <span class="string">"MM_UL1"</span>,</span><br><span class="line">			.rates = (SNDRV_PCM_RATE_8000_192000|</span><br><span class="line">					SNDRV_PCM_RATE_KNOT),</span><br><span class="line">			.formats = (SNDRV_PCM_FMTBIT_S16_LE |</span><br><span class="line">				    SNDRV_PCM_FMTBIT_S24_LE|</span><br><span class="line">				    SNDRV_PCM_FMTBIT_S24_3LE),</span><br><span class="line">			.channels_min = <span class="number">1</span>,</span><br><span class="line">			.channels_max = <span class="number">4</span>,</span><br><span class="line">			.rate_min =     <span class="number">8000</span>,</span><br><span class="line">			.rate_max =	<span class="number">48000</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		.ops = &amp;msm_fe_Multimedia_dai_ops,</span><br><span class="line">		.name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">		.probe = fe_dai_probe,</span><br><span class="line">	&#125;,</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Back-end DAIï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/msm/msm8996.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> <span class="title">msm8996_tasha_be_dai_links</span>[] = &#123;</span></span><br><span class="line">	<span class="comment">/* Backend DAI Links */</span></span><br><span class="line">	&#123;</span><br><span class="line">		.name = LPASS_BE_SLIMBUS_0_RX,</span><br><span class="line">		.stream_name = <span class="string">"Slimbus Playback"</span>,</span><br><span class="line">		.cpu_dai_name = <span class="string">"msm-dai-q6-dev.16384"</span>,</span><br><span class="line">		.platform_name = <span class="string">"msm-pcm-routing"</span>,</span><br><span class="line">		.codec_name = <span class="string">"tasha_codec"</span>,</span><br><span class="line">		.codec_dai_name = <span class="string">"tasha_mix_rx1"</span>,</span><br><span class="line">		.no_pcm = <span class="number">1</span>,</span><br><span class="line">		.dpcm_playback = <span class="number">1</span>,</span><br><span class="line">		.be_id = MSM_BACKEND_DAI_SLIMBUS_0_RX,</span><br><span class="line">		.init = &amp;msm_audrx_init,</span><br><span class="line">		.be_hw_params_fixup = msm_slim_0_rx_be_hw_params_fixup,</span><br><span class="line">		<span class="comment">/* this dainlink has playback support */</span></span><br><span class="line">		.ignore_pmdown_time = <span class="number">1</span>,</span><br><span class="line">		.ignore_suspend = <span class="number">1</span>,</span><br><span class="line">		.ops = &amp;msm8996_be_ops,</span><br><span class="line">	&#125;,</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> struct snd_soc_dai_link msm8996_tasha_fe_dai_links[] = &#123;</span><br><span class="line">	&#123;</span><br><span class="line">		.name = LPASS_BE_SLIMBUS_4_TX,</span><br><span class="line">		.stream_name = <span class="string">"Slimbus4 Capture"</span>,</span><br><span class="line">		.cpu_dai_name = <span class="string">"msm-dai-q6-dev.16393"</span>,</span><br><span class="line">		.platform_name = <span class="string">"msm-pcm-hostless"</span>,</span><br><span class="line">		.codec_name = <span class="string">"tasha_codec"</span>,</span><br><span class="line">		.codec_dai_name = <span class="string">"tasha_vifeedback"</span>,</span><br><span class="line">		.be_id = MSM_BACKEND_DAI_SLIMBUS_4_TX,</span><br><span class="line">		.be_hw_params_fixup = msm_slim_4_tx_be_hw_params_fixup,</span><br><span class="line">		.ops = &amp;msm8996_be_ops,</span><br><span class="line">		.no_host_mode = SND_SOC_DAI_LINK_NO_HOST,</span><br><span class="line">		.ignore_suspend = <span class="number">1</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hw constraintsï¼šæŒ‡å¹³å°æœ¬èº«çš„ç¡¬ä»¶é™åˆ¶ï¼Œå¦‚æ‰€èƒ½æ”¯æŒçš„é€šé“æ•°/é‡‡æ ·ç‡/æ•°æ®æ ¼å¼ã€DMA æ”¯æŒçš„æ•°æ®å‘¨æœŸå¤§å°ï¼ˆperiod sizeï¼‰ã€å‘¨æœŸæ¬¡æ•°ï¼ˆperiod countï¼‰ç­‰ï¼Œé€šè¿‡ snd_pcm_hardware ç»“æ„ä½“æè¿°ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_hardware</span> <span class="title">msm_pcm_hardware_capture</span> = &#123;</span></span><br><span class="line">	.info =                 (SNDRV_PCM_INFO_MMAP |</span><br><span class="line">				SNDRV_PCM_INFO_BLOCK_TRANSFER |</span><br><span class="line">				SNDRV_PCM_INFO_MMAP_VALID |</span><br><span class="line">				SNDRV_PCM_INFO_INTERLEAVED |</span><br><span class="line">				SNDRV_PCM_INFO_PAUSE | SNDRV_PCM_INFO_RESUME),</span><br><span class="line">	.formats =              (SNDRV_PCM_FMTBIT_S16_LE |</span><br><span class="line">				SNDRV_PCM_FMTBIT_S24_LE |</span><br><span class="line">				SNDRV_PCM_FMTBIT_S24_3LE),</span><br><span class="line">	.rates =                SNDRV_PCM_RATE_8000_48000,</span><br><span class="line">	.rate_min =             <span class="number">8000</span>,</span><br><span class="line">	.rate_max =             <span class="number">48000</span>,</span><br><span class="line">	.channels_min =         <span class="number">1</span>,</span><br><span class="line">	.channels_max =         <span class="number">4</span>,</span><br><span class="line">	.buffer_bytes_max =     CAPTURE_MAX_NUM_PERIODS *</span><br><span class="line">				CAPTURE_MAX_PERIOD_SIZE,</span><br><span class="line">	.period_bytes_min =	CAPTURE_MIN_PERIOD_SIZE,</span><br><span class="line">	.period_bytes_max =     CAPTURE_MAX_PERIOD_SIZE,</span><br><span class="line">	.periods_min =          CAPTURE_MIN_NUM_PERIODS,</span><br><span class="line">	.periods_max =          CAPTURE_MAX_NUM_PERIODS,</span><br><span class="line">	.fifo_size =            <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>hw paramsï¼šç”¨æˆ·å±‚è®¾ç½®çš„ç¡¬ä»¶å‚æ•°ï¼Œå¦‚ channelsã€sample rateã€pcm formatã€period sizeã€period countï¼›è¿™äº›å‚æ•°å— hw constraints çº¦æŸã€‚</p><p>sw paramsï¼šç”¨æˆ·å±‚è®¾ç½®çš„è½¯ä»¶å‚æ•°ï¼Œå¦‚ start thresholdã€stop thresholdã€silence thresholdã€‚</p><h4 id="ï¼ˆäºŒï¼‰ASoC-Core"><a href="#ï¼ˆäºŒï¼‰ASoC-Core" class="headerlink" title="ï¼ˆäºŒï¼‰ASoC Core"></a>ï¼ˆäºŒï¼‰ASoC Core</h4><p>ASoCï¼šALSA System on Chipï¼Œæ˜¯å»ºç«‹åœ¨æ ‡å‡† ALSA é©±åŠ¨ä¹‹ä¸Šï¼Œä¸ºäº†æ›´å¥½æ”¯æŒåµŒå…¥å¼ç³»ç»Ÿå’Œåº”ç”¨äºç§»åŠ¨è®¾å¤‡çš„éŸ³é¢‘ codec çš„ä¸€å¥—è½¯ä»¶ä½“ç³»ï¼Œå®ƒä¾èµ–äºæ ‡å‡† ALSA é©±åŠ¨æ¡†æ¶ã€‚å†…æ ¸æ–‡æ¡£ Documentation/alsa/soc/overview.txt ä¸­è¯¦ç»†ä»‹ç»äº† ASoC çš„è®¾è®¡åˆè¡·ï¼Œè¿™é‡Œä¸ä¸€ä¸€å¼•ç”¨ï¼Œç®€å•é™ˆè¿°å¦‚ä¸‹ï¼š</p><p>â€¢ ç‹¬ç«‹çš„ codec é©±åŠ¨ï¼Œæ ‡å‡†çš„ ALSA é©±åŠ¨æ¡†æ¶é‡Œé¢ codec é©±åŠ¨å¾€å¾€ä¸ SoC/CPU è€¦åˆè¿‡äºç´§å¯†ï¼Œä¸åˆ©äºåœ¨å¤šæ ·åŒ–çš„å¹³å°/æœºå™¨ä¸Šç§»æ¤å¤ç”¨<br>â€¢ æ–¹ä¾¿ codec ä¸ SoC é€šè¿‡ PCM/I2S æ€»çº¿å»ºç«‹é“¾æ¥<br>â€¢ åŠ¨æ€éŸ³é¢‘ç”µæºç®¡ç† DAPMï¼Œä½¿å¾— codec ä»»ä½•æ—¶å€™éƒ½å·¥ä½œåœ¨æœ€ä½åŠŸè€—çŠ¶æ€ï¼ŒåŒæ—¶è´Ÿè´£éŸ³é¢‘è·¯ç”±çš„åˆ›å»º<br>â€¢ POPs å’Œ click éŸ³æŠ‘åˆ¶å¼±åŒ–å¤„ç†ï¼Œåœ¨ ASoC ä¸­é€šè¿‡æ­£ç¡®çš„éŸ³é¢‘éƒ¨ä»¶ä¸Šä¸‹ç”µæ¬¡åºæ¥å®ç°<br>â€¢ Machine é©±åŠ¨çš„ç‰¹å®šæ§åˆ¶ï¼Œæ¯”å¦‚è€³æœºã€éº¦å…‹é£çš„æ’æ‹”æ£€æµ‹ï¼Œå¤–æ”¾åŠŸæ”¾çš„å¼€å…³<br>åœ¨æ¦‚è¿°ä¸­å·²ç»ä»‹ç»äº† ASoC ç¡¬ä»¶è®¾å¤‡é©±åŠ¨çš„ä¸‰å¤§æ„æˆï¼šCodecã€Platform å’Œ Machineï¼Œä¸‹é¢åˆ—ä¸¾å„é©±åŠ¨çš„åŠŸèƒ½æ„æˆï¼š</p><p>ASoC Codec Driverï¼š</p><p>â€¢ Codec DAI å’Œ PCM çš„é…ç½®ä¿¡æ¯<br>â€¢ Codec çš„æ§åˆ¶æ¥å£ï¼Œå¦‚ I2C/SPI<br>â€¢ Mixer å’Œå…¶ä»–éŸ³é¢‘æ§ä»¶<br>â€¢ Codec çš„éŸ³é¢‘æ¥å£å‡½æ•°ï¼Œè§ snd_soc_dai_ops ç»“æ„ä½“å®šä¹‰<br>â€¢ DAPM æè¿°ä¿¡æ¯<br>â€¢ DAPM äº‹ä»¶å¤„ç†å¥æŸ„<br>â€¢ DAC æ•°å­—é™éŸ³æ§åˆ¶</p><p>ASoC Platform Driverï¼š åŒ…æ‹¬ dma å’Œ cpu_dai ä¸¤éƒ¨åˆ†ï¼š</p><p>â€¢ dma é©±åŠ¨å®ç°éŸ³é¢‘ dma æ“ä½œï¼Œå…·ä½“è§ snd_pcm_ops ç»“æ„ä½“å®šä¹‰<br>â€¢ cpu_dai é©±åŠ¨å®ç°éŸ³é¢‘æ•°å­—æ¥å£æ§åˆ¶å™¨çš„æè¿°å’Œé…ç½®<br>â€¢ ASoC Machine Driverï¼š</p><p>ä½œä¸ºé“¾ç»“ Platform å’Œ Codec çš„è½½ä½“ï¼Œå®ƒå¿…é¡»é…ç½® dai_link ä¸ºéŸ³é¢‘æ•°æ®é“¾è·¯æŒ‡å®š Platform å’Œ Codec<br>å¤„ç†æœºå™¨ç‰¹æœ‰çš„éŸ³é¢‘æ§ä»¶å’ŒéŸ³é¢‘äº‹ä»¶ï¼Œä¾‹å¦‚å›æ”¾æ—¶æ‰“å¼€å¤–æ”¾åŠŸæ”¾<br>ç¡¬ä»¶è®¾å¤‡é©±åŠ¨ç›¸å…³ç»“æ„ä½“ï¼š</p><p>â€¢ snd_soc_codec_driverï¼šéŸ³é¢‘ç¼–è§£ç èŠ¯ç‰‡æè¿°åŠæ“ä½œå‡½æ•°ï¼Œå¦‚æ§ä»¶/å¾®ä»¶/éŸ³é¢‘è·¯ç”±çš„æè¿°ä¿¡æ¯ã€æ—¶é’Ÿé…ç½®ã€IO æ§åˆ¶ç­‰<br>â€¢ snd_soc_dai_driverï¼šéŸ³é¢‘æ•°æ®æ¥å£æè¿°åŠæ“ä½œå‡½æ•°ï¼Œæ ¹æ® codec ç«¯å’Œ soc ç«¯ï¼Œåˆ†ä¸º codec_dai å’Œ cpu_dai<br>â€¢ snd_soc_platform_driverï¼šéŸ³é¢‘ dma è®¾å¤‡æè¿°åŠæ“ä½œå‡½æ•°<br>â€¢ snd_soc_dai_linkï¼šéŸ³é¢‘é“¾è·¯æè¿°åŠæ¿çº§æ“ä½œå‡½æ•°</p><h4 id="ï¼ˆä¸‰ï¼‰Codec-Driver"><a href="#ï¼ˆä¸‰ï¼‰Codec-Driver" class="headerlink" title="ï¼ˆä¸‰ï¼‰Codec Driver"></a>ï¼ˆä¸‰ï¼‰Codec Driver</h4><p>åŸºæœ¬æ˜¯ä»¥å†…æ ¸æ–‡æ¡£ Documentation/sound/alsa/soc/codec.txt ä¸­çš„å†…å®¹ä¸ºè„‰ç»œæ¥åˆ†æçš„ã€‚Codec çš„ä½œç”¨ï¼Œä¹‹å‰å·²æœ‰æè¿°ï¼Œæœ¬ç« ä¸»è¦ç½—åˆ—ä¸‹ Codec driver ä¸­é‡è¦çš„æ•°æ®ç»“æ„åŠæ³¨å†Œæµç¨‹ã€‚<br>å…¶ä¸­æœ‰ç€å„ç§åŠŸèƒ½éƒ¨ä»¶ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº ï¼š</p><blockquote><p>ADC æŠŠéº¦å…‹é£æ‹¾å–çš„æ¨¡æ‹Ÿä¿¡å·è½¬æ¢æˆæ•°å­—ä¿¡å·<br>DAC æŠŠéŸ³é¢‘æ¥å£è¿‡æ¥çš„æ•°å­—ä¿¡å·è½¬æ¢æˆæ¨¡æ‹Ÿä¿¡å·<br>MIXER æ··éŸ³å™¨ï¼ŒæŠŠå¤šè·¯è¾“å…¥ä¿¡å·æ··åˆæˆå•è·¯è¾“å‡º</p></blockquote><h5 id="3-1-Codec-DAI-and-PCM-configuration"><a href="#3-1-Codec-DAI-and-PCM-configuration" class="headerlink" title="3.1. Codec DAI and PCM configuration"></a>3.1. Codec DAI and PCM configuration</h5><p>codec_dai å’Œ pcm é…ç½®ä¿¡æ¯é€šè¿‡ç»“æ„ä½“ snd_soc_dai_driver æè¿°ï¼ŒåŒ…æ‹¬ dai çš„èƒ½åŠ›æè¿°å’Œæ“ä½œæ¥å£ï¼Œsnd_soc_dai_driver æœ€ç»ˆä¼šè¢«æ³¨å†Œåˆ° soc-core ä¸­ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/soc-dai.h]</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Digital Audio Interface Driver.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Describes the Digital Audio Interface in terms of its ALSA, DAI and AC97</span></span><br><span class="line"><span class="comment"> * operations and capabilities. Codec and platform drivers will register this</span></span><br><span class="line"><span class="comment"> * structure for every DAI they have.</span></span><br><span class="line"><span class="comment"> * This structure covers the clocking, formating and ALSA operations for each</span></span><br><span class="line"><span class="comment"> * interface.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> &#123;</span></span><br><span class="line">    <span class="comment">/* DAI description */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">int</span> ac97_control;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DAI driver callbacks */</span></span><br><span class="line">    <span class="keyword">int</span> (*probe)(struct snd_soc_dai *dai);</span><br><span class="line">    <span class="keyword">int</span> (*remove)(struct snd_soc_dai *dai);</span><br><span class="line">    <span class="keyword">int</span> (*suspend)(struct snd_soc_dai *dai);</span><br><span class="line">    <span class="keyword">int</span> (*resume)(struct snd_soc_dai *dai);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ops */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DAI capabilities */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> <span class="title">capture</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> <span class="title">playback</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_rates:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* probe ordering - for components with runtime dependencies */</span></span><br><span class="line">    <span class="keyword">int</span> probe_order;</span><br><span class="line">    <span class="keyword">int</span> remove_order;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>nameï¼šcodec_dai çš„åç§°æ ‡è¯†ï¼Œdai_link é€šè¿‡é…ç½® codec_dai_name æ¥æ‰¾åˆ°å¯¹åº”çš„ codec_daiï¼›<br>probeï¼šcodec_dai çš„åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œå£°å¡æ—¶å›è°ƒï¼›<br>playbackï¼šå›æ”¾èƒ½åŠ›æè¿°ï¼Œå¦‚å›æ”¾è®¾å¤‡æ‰€æ”¯æŒçš„å£°é“æ•°ã€é‡‡æ ·ç‡ã€éŸ³é¢‘æ ¼å¼ï¼›<br>captureï¼šå½•åˆ¶èƒ½åŠ›æè¿°ï¼Œå¦‚å½•åˆ¶è®¾å¤‡æ‰€æ”¯æŒå£°é“æ•°ã€é‡‡æ ·ç‡ã€éŸ³é¢‘æ ¼å¼ï¼›<br>opsï¼šcodec_dai çš„æ“ä½œå‡½æ•°é›†ï¼Œè¿™äº›å‡½æ•°é›†éå¸¸é‡è¦ï¼Œç”¨äº dai çš„æ—¶é’Ÿé…ç½®ã€æ ¼å¼é…ç½®ã€ç¡¬ä»¶å‚æ•°é…ç½®ã€‚</p><p>codec_daiï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> <span class="title">tasha_i2s_dai</span>[] = &#123;</span></span><br><span class="line">	&#123;</span><br><span class="line">		.name = <span class="string">"tasha_i2s_rx1"</span>,</span><br><span class="line">		.id = AIF1_PB,</span><br><span class="line">		.playback = &#123;</span><br><span class="line">			.stream_name = <span class="string">"AIF1 Playback"</span>,</span><br><span class="line">			.rates = WCD9335_RATES_MASK,</span><br><span class="line">			.formats = TASHA_FORMATS_S16_S24_LE,</span><br><span class="line">			.rate_max = <span class="number">192000</span>,</span><br><span class="line">			.rate_min = <span class="number">8000</span>,</span><br><span class="line">			.channels_min = <span class="number">1</span>,</span><br><span class="line">			.channels_max = <span class="number">2</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		.ops = &amp;tasha_dai_ops,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.name = <span class="string">"tasha_i2s_tx1"</span>,</span><br><span class="line">		.id = AIF1_CAP,</span><br><span class="line">		.capture = &#123;</span><br><span class="line">			.stream_name = <span class="string">"AIF1 Capture"</span>,</span><br><span class="line">			.rates = WCD9335_RATES_MASK,</span><br><span class="line">			.formats = TASHA_FORMATS,</span><br><span class="line">			.rate_max = <span class="number">192000</span>,</span><br><span class="line">			.rate_min = <span class="number">8000</span>,</span><br><span class="line">			.channels_min = <span class="number">1</span>,</span><br><span class="line">			.channels_max = <span class="number">4</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		.ops = &amp;tasha_dai_ops,</span><br><span class="line">	&#125;,</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h5 id="3-2-Codec-control-IO"><a href="#3-2-Codec-control-IO" class="headerlink" title="3.2. Codec control IO"></a>3.2. Codec control IO</h5><p>ç§»åŠ¨è®¾å¤‡çš„éŸ³é¢‘ Codecï¼Œå…¶æ§åˆ¶æ¥å£ä¸€èˆ¬æ˜¯ I2C æˆ– SPIï¼Œæ§åˆ¶æ¥å£ç”¨äºè¯»å†™ codec çš„å¯„å­˜å™¨ã€‚åœ¨ snd_soc_codec_driver ç»“æ„ä½“ä¸­ï¼Œæœ‰å¦‚ä¸‹å­—æ®µæè¿° Codec çš„æ§åˆ¶æ¥å£ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/soc.h]</span><br><span class="line"><span class="comment">/* codec driver */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec_driver</span> &#123;</span></span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* codec IO */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">regmap</span> *(*<span class="title">get_regmap</span>)(<span class="title">struct</span> <span class="title">device</span> *);</span></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*read)</span><span class="params">(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>)</span></span>;</span><br><span class="line">	<span class="keyword">int</span> (*write)(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*display_register)(struct snd_soc_codec *, <span class="keyword">char</span> *,</span><br><span class="line">				<span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*volatile_register)(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*readable_register)(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*writable_register)(struct snd_soc_codec *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> reg_cache_size;</span><br><span class="line">	<span class="keyword">short</span> reg_cache_step;</span><br><span class="line">	<span class="keyword">short</span> reg_word_size;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *reg_cache_default;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>â€¢ readï¼šè¯»å¯„å­˜å™¨ï¼›<br>â€¢ writeï¼šå†™å¯„å­˜å™¨ï¼›<br>â€¢ volatile_registerï¼šåˆ¤æ–­æŒ‡å®šçš„å¯„å­˜å™¨æ˜¯å¦æ˜¯ volatile å±æ€§ï¼›å‡å¦‚æ˜¯ï¼Œåˆ™è¯»å–å¯„å­˜å™¨æ—¶ä¸æ˜¯è¯» cacheï¼Œè€Œç›´æ¥è®¿é—®ç¡¬ä»¶ï¼›<br>â€¢ readable_registerï¼šåˆ¤æ–­æŒ‡å®šçš„å¯„å­˜å™¨æ˜¯å¦å¯è¯»ï¼›<br>â€¢ reg_cache_defaultï¼šå¯„å­˜å™¨çš„ç¼ºçœå€¼ï¼›<br>â€¢ reg_cache_sizeï¼šç¼ºçœçš„å¯„å­˜å™¨å€¼æ•°ç»„å¤§å°ï¼›<br>â€¢ reg_word_sizeï¼šå¯„å­˜å™¨å®½åº¦ã€‚<br>åœ¨ Linux-3.4.5 ä¸­ï¼Œå¾ˆå¤š codec çš„æ§åˆ¶æ¥å£éƒ½æ”¹ç”¨ regmap äº†ã€‚soc-core ä¸­åˆ¤æ–­æ˜¯å¦ç”¨çš„æ˜¯ regmapï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ regmap æ¥å£ã€‚</p><h5 id="3-3-Mixers-and-audio-controls"><a href="#3-3-Mixers-and-audio-controls" class="headerlink" title="3.3. Mixers and audio controls"></a>3.3. Mixers and audio controls</h5><p>éŸ³é¢‘æ§ä»¶å¤šç”¨äºéƒ¨ä»¶å¼€å…³å’ŒéŸ³é‡çš„è®¾å®šï¼ŒéŸ³é¢‘æ§ä»¶å¯é€šè¿‡ soc.h ä¸­çš„å®æ¥å®šä¹‰ï¼Œä¾‹å¦‚å•ä¸€å‹æ§ä»¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/soc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE(xname, reg, shift, max, invert) \</span></span><br><span class="line">&#123;   .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span><br><span class="line">    .info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span><br><span class="line">    .put = snd_soc_put_volsw, \</span><br><span class="line">    .private_value =  SOC_SINGLE_VALUE(reg, shift, max, invert) &#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ§ä»¶åªæœ‰ä¸€ä¸ªè®¾ç½®é‡ï¼Œä¸€èˆ¬ç”¨äºéƒ¨ä»¶å¼€å…³ã€‚å®å®šä¹‰çš„å‚æ•°è¯´æ˜ï¼š</p><p>â€¢ xnameï¼šæ§ä»¶çš„åç§°æ ‡è¯†ï¼›<br>â€¢ regï¼šæ§ä»¶å¯¹åº”çš„å¯„å­˜å™¨åœ°å€ï¼›<br>â€¢ shiftï¼šæ§ä»¶æ§åˆ¶ä½åœ¨å¯„å­˜å™¨ä¸­çš„åç§»ï¼›<br>â€¢ maxï¼šæ§ä»¶è®¾ç½®å€¼èŒƒå›´ï¼›<br>â€¢ invertï¼šè®¾å®šå€¼æ˜¯å¦å–åã€‚<br>å…¶ä»–ç±»å‹æ§ä»¶ç±»ä¼¼ï¼Œä¸ä¸€ä¸€ä»‹ç»äº†ã€‚</p><p>ä¸Šè¿°åªæ˜¯å®å®šä¹‰ï¼ŒéŸ³é¢‘æ§ä»¶çœŸæ­£çš„ç»“æ„æ˜¯ snd_kcontrol_newï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/control.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> &#123;</span></span><br><span class="line">    <span class="keyword">snd_ctl_elem_iface_t</span> iface; <span class="comment">/* interface identifier */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> device;        <span class="comment">/* device/client number */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> subdevice;     <span class="comment">/* subdevice (substream) number */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *name;  <span class="comment">/* ASCII name of item */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index;     <span class="comment">/* index of item */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> access;        <span class="comment">/* access rights */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;     <span class="comment">/* count of same elements */</span></span><br><span class="line">    <span class="keyword">snd_kcontrol_info_t</span> *info;</span><br><span class="line">    <span class="keyword">snd_kcontrol_get_t</span> *get;</span><br><span class="line">    <span class="keyword">snd_kcontrol_put_t</span> *put;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">snd_kcontrol_tlv_rw_t</span> *c;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *p;</span><br><span class="line">    &#125; tlv;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> private_value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Codec åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡ snd_soc_add_codec_controls() æŠŠæ‰€æœ‰å®šä¹‰å¥½çš„éŸ³é¢‘æ§ä»¶æ³¨å†Œåˆ° alsa-core ï¼Œä¸Šå±‚å¯ä»¥é€šè¿‡ tinymixã€alsa_amixer ç­‰å·¥å…·æŸ¥çœ‹ä¿®æ”¹è¿™äº›æ§ä»¶çš„è®¾å®šã€‚</p><h5 id="3-6-Codec-audio-operations"><a href="#3-6-Codec-audio-operations" class="headerlink" title="3.6. Codec audio operations"></a>3.6. Codec audio operations</h5><p>Codec éŸ³é¢‘æ“ä½œæ¥å£é€šè¿‡ç»“æ„ä½“ snd_soc_dai_ops æè¿°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/soc-dai.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * DAI clocking configuration, all optional.</span></span><br><span class="line"><span class="comment">	 * Called by soc_card drivers, normally in their hw_params.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*set_sysclk)(struct snd_soc_dai *dai,</span><br><span class="line">		<span class="keyword">int</span> clk_id, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq, <span class="keyword">int</span> dir);</span><br><span class="line">	<span class="keyword">int</span> (*set_pll)(struct snd_soc_dai *dai, <span class="keyword">int</span> pll_id, <span class="keyword">int</span> source,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> freq_in, <span class="keyword">unsigned</span> <span class="keyword">int</span> freq_out);</span><br><span class="line">	<span class="keyword">int</span> (*set_clkdiv)(struct snd_soc_dai *dai, <span class="keyword">int</span> div_id, <span class="keyword">int</span> div);</span><br><span class="line">	<span class="keyword">int</span> (*set_bclk_ratio)(struct snd_soc_dai *dai, <span class="keyword">unsigned</span> <span class="keyword">int</span> ratio);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * DAI format configuration</span></span><br><span class="line"><span class="comment">	 * Called by soc_card drivers, normally in their hw_params.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*set_fmt)(struct snd_soc_dai *dai, <span class="keyword">unsigned</span> <span class="keyword">int</span> fmt);</span><br><span class="line">	<span class="keyword">int</span> (*xlate_tdm_slot_mask)(<span class="keyword">unsigned</span> <span class="keyword">int</span> slots,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_mask);</span><br><span class="line">	<span class="keyword">int</span> (*set_tdm_slot)(struct snd_soc_dai *dai,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> tx_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> rx_mask,</span><br><span class="line">		<span class="keyword">int</span> slots, <span class="keyword">int</span> slot_width);</span><br><span class="line">	<span class="keyword">int</span> (*set_channel_map)(struct snd_soc_dai *dai,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> tx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_slot,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> rx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_slot);</span><br><span class="line">	<span class="keyword">int</span> (*set_tristate)(struct snd_soc_dai *dai, <span class="keyword">int</span> tristate);</span><br><span class="line">	<span class="keyword">int</span> (*get_channel_map)(struct snd_soc_dai *dai,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *tx_slot,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_num, <span class="keyword">unsigned</span> <span class="keyword">int</span> *rx_slot);</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ³¨é‡Šæ¯”è¾ƒè¯¦ç»†çš„äº†ï¼ŒCodec éŸ³é¢‘æ“ä½œæ¥å£åˆ†ä¸º 5 å¤§éƒ¨åˆ†ï¼šæ—¶é’Ÿé…ç½®ã€æ ¼å¼é…ç½®ã€æ•°å­—é™éŸ³ã€PCM éŸ³é¢‘æ¥å£ã€FIFO å»¶è¿Ÿã€‚ç€é‡è¯´ä¸‹æ—¶é’Ÿé…ç½®åŠæ ¼å¼é…ç½®æ¥å£ï¼š</p><p>â€¢ set_sysclkï¼šcodec_dai ç³»ç»Ÿæ—¶é’Ÿè®¾ç½®ï¼Œå½“ä¸Šå±‚æ‰“å¼€ pcm è®¾å¤‡æ—¶ï¼Œéœ€è¦å›è°ƒè¯¥æ¥å£è®¾ç½® Codec çš„ç³»ç»Ÿæ—¶é’Ÿï¼ŒCodec æ‰èƒ½æ­£å¸¸å·¥ä½œï¼›<br>â€¢ set_pllï¼šCodec FLL è®¾ç½®ï¼ŒCodec ä¸€èˆ¬æ¥äº†ä¸€ä¸ª MCLK è¾“å…¥æ—¶é’Ÿï¼Œå›è°ƒè¯¥æ¥å£åŸºäº MCLK æ¥äº§ç”Ÿ Codec FLL æ—¶é’Ÿï¼Œæ¥ç€ codec_dai çš„ sysclkã€bclkã€lrclk å‡å¯ä» FLL åˆ†é¢‘å‡ºæ¥ï¼ˆå‡è®¾ Codec ä½œä¸º masterï¼‰ï¼›<br>â€¢ set_fmtï¼šcodec_dai æ ¼å¼è®¾ç½®ï¼Œå…·ä½“è§ soc-dai.hï¼›<br>â€¢ SND_SOC_DAIFMT_I2Sï¼šéŸ³é¢‘æ•°æ®æ˜¯ I2S æ ¼å¼ï¼Œå¸¸ç”¨äºå¤šåª’ä½“éŸ³é¢‘ï¼›<br>â€¢ SND_SOC_DAIFMT_DSP_Aï¼šéŸ³é¢‘æ•°æ®æ˜¯ PCM æ ¼å¼ï¼Œå¸¸ç”¨äºé€šè¯è¯­éŸ³ï¼›<br>â€¢ SND_SOC_DAIFMT_CBM_CFMï¼šCodec ä½œä¸º masterï¼ŒBCLK å’Œ LRCLK ç”± Codec æä¾›ï¼›<br>â€¢ SND_SOC_DAIFMT_CBS_CFSï¼šCodec ä½œä¸º slaveï¼ŒBCLK å’Œ LRCLK ç”± SoC/CPU æä¾›ï¼›<br>â€¢ hw_paramsï¼šcodec_dai ç¡¬ä»¶å‚æ•°è®¾ç½®ï¼Œæ ¹æ®ä¸Šå±‚è®¾å®šçš„å£°é“æ•°ã€é‡‡æ ·ç‡ã€æ•°æ®æ ¼å¼ï¼Œæ¥é…ç½® codec_dai ç›¸å…³å¯„å­˜å™¨ã€‚</p><p>WCD9335çš„snd_soc_dai_ops ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> <span class="title">tasha_dai_ops</span> = &#123;</span></span><br><span class="line">	.startup = tasha_startup,</span><br><span class="line">	.shutdown = tasha_shutdown,</span><br><span class="line">	.hw_params = tasha_hw_params,</span><br><span class="line">	.prepare = tasha_prepare,</span><br><span class="line">	.set_sysclk = tasha_set_dai_sysclk,</span><br><span class="line">	.set_fmt = tasha_set_dai_fmt,</span><br><span class="line">	.set_channel_map = tasha_set_channel_map,</span><br><span class="line">	.get_channel_map = tasha_get_channel_map,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><h5 id="3-6-Codec-register"><a href="#3-6-Codec-register" class="headerlink" title="3.6. Codec register"></a>3.6. Codec register</h5><p>å½“ platform_driverï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">tasha_codec_driver</span> = &#123;</span></span><br><span class="line">	.probe = tasha_probe,</span><br><span class="line">	.remove = tasha_remove,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = <span class="string">"tasha_codec"</span>,</span><br><span class="line">		.owner = THIS_MODULE,</span><br><span class="line">#ifdef CONFIG_PM</span><br><span class="line">		.pm = &amp;tasha_pm_ops,</span><br><span class="line">#endif</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸.name = â€œtasha_codecâ€ çš„ platform_deviceï¼ˆè¯¥ platform_device åœ¨ drivers/mfd/wcd9xxx-core.c ä¸­æ³¨å†Œwcd9xxx_device_init-&gt;wcd9xxx_check_codec_type-&gt;tasha_devsï¼‰åŒ¹é…åï¼Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;drivers/mfd/wcd9xxx-core.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mfd_cell</span> <span class="title">tasha_devs</span>[] = &#123;</span></span><br><span class="line">	&#123;</span><br><span class="line">		.name = <span class="string">"tasha_codec"</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç«‹å³å›è°ƒ tasha_probe() æ³¨å†Œ Codecï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tasha_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tasha_priv</span> *<span class="title">tasha</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">wcd_ext_clk</span>, *<span class="title">wcd_native_clk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">wcd9xxx_resmgr_v2</span> *<span class="title">resmgr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">wcd9xxx_power_region</span> *<span class="title">cdc_pwr</span>;</span></span><br><span class="line">	......</span><br><span class="line">	tasha = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(struct tasha_priv),</span><br><span class="line">			    GFP_KERNEL);</span><br><span class="line">	......</span><br><span class="line">    tasha-&gt;resmgr = resmgr;</span><br><span class="line">	tasha-&gt;swr_plat_data.handle = (<span class="keyword">void</span> *) tasha;</span><br><span class="line">	tasha-&gt;swr_plat_data.read = tasha_swrm_read;</span><br><span class="line">	tasha-&gt;swr_plat_data.write = tasha_swrm_write;</span><br><span class="line">	tasha-&gt;swr_plat_data.bulk_write = tasha_swrm_bulk_write;</span><br><span class="line">	tasha-&gt;swr_plat_data.clk = tasha_swrm_clock;</span><br><span class="line">	tasha-&gt;swr_plat_data.handle_irq = tasha_swrm_handle_irq;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Register for Clock */</span></span><br><span class="line">	wcd_ext_clk = clk_get(tasha-&gt;wcd9xxx-&gt;dev, <span class="string">"wcd_clk"</span>);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(wcd_ext_clk)) &#123;</span><br><span class="line">		dev_err(tasha-&gt;wcd9xxx-&gt;dev, <span class="string">"%s: clk get %s failed\n"</span>,</span><br><span class="line">			__func__, <span class="string">"wcd_ext_clk"</span>);</span><br><span class="line">		<span class="keyword">goto</span> err_clk;</span><br><span class="line">	&#125;</span><br><span class="line">	tasha-&gt;wcd_ext_clk = wcd_ext_clk;</span><br><span class="line">	tasha-&gt;sido_voltage = SIDO_VOLTAGE_NOMINAL_MV;</span><br><span class="line">	set_bit(AUDIO_NOMINAL, &amp;tasha-&gt;status_mask);</span><br><span class="line">	tasha-&gt;sido_ccl_cnt = <span class="number">0</span>;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">if</span> (wcd9xxx_get_intf_type() == WCD9XXX_INTERFACE_TYPE_SLIMBUS)</span><br><span class="line">		ret = snd_soc_register_codec(&amp;pdev-&gt;dev, &amp;soc_codec_dev_tasha,</span><br><span class="line">					     tasha_dai, ARRAY_SIZE(tasha_dai));</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wcd9xxx_get_intf_type() == WCD9XXX_INTERFACE_TYPE_I2C)</span><br><span class="line">		ret = snd_soc_register_codec(&amp;pdev-&gt;dev, &amp;soc_codec_dev_tasha,</span><br><span class="line">					     tasha_i2s_dai,</span><br><span class="line">					     ARRAY_SIZE(tasha_i2s_dai));</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>snd_soc_register_codecï¼šå°† codec_driver å’Œ codec_dai_driver æ³¨å†Œåˆ° soc-coreã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * snd_soc_register_codec - Register a codec with the ASoC core</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @codec: codec to register</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_register_codec</span><span class="params">(struct device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">const</span> struct snd_soc_codec_driver *codec_drv,</span></span></span><br><span class="line"><span class="function"><span class="params">               struct snd_soc_dai_driver *dai_drv,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">int</span> num_dai)</span></span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ª snd_soc_codec å®ä¾‹ï¼ŒåŒ…å« codec_drvï¼ˆsnd_soc_dai_driverï¼‰ç›¸å…³ä¿¡æ¯ï¼Œå°è£…ç»™ soc-core ä½¿ç”¨ï¼Œç›¸å…³ä»£ç æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c: snd_soc_register_codec]</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec</span> *<span class="title">codec</span>;</span></span><br><span class="line"></span><br><span class="line">    dev_dbg(dev, <span class="string">"codec register %s\n"</span>, dev_name(dev));</span><br><span class="line"></span><br><span class="line">    codec = kzalloc(<span class="keyword">sizeof</span>(struct snd_soc_codec), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (codec == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create CODEC component name */</span></span><br><span class="line">    codec-&gt;name = fmt_single_name(dev, &amp;codec-&gt;id);</span><br><span class="line">    <span class="keyword">if</span> (codec-&gt;name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        kfree(codec);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– Codec çš„å¯„å­˜å™¨ç¼“å­˜é…ç½®åŠè¯»å†™æ¥å£</span></span><br><span class="line">    codec-&gt;write = codec_drv-&gt;write;</span><br><span class="line">    codec-&gt;read = codec_drv-&gt;read;</span><br><span class="line">    codec-&gt;volatile_register = codec_drv-&gt;volatile_register;</span><br><span class="line">    codec-&gt;readable_register = codec_drv-&gt;readable_register;</span><br><span class="line">    codec-&gt;writable_register = codec_drv-&gt;writable_register;</span><br><span class="line">    codec-&gt;ignore_pmdown_time = codec_drv-&gt;ignore_pmdown_time;</span><br><span class="line">    codec-&gt;dapm.bias_level = SND_SOC_BIAS_OFF;</span><br><span class="line">    codec-&gt;dapm.dev = dev;</span><br><span class="line">    codec-&gt;dapm.codec = codec;</span><br><span class="line">    codec-&gt;dapm.seq_notifier = codec_drv-&gt;seq_notifier;</span><br><span class="line">    codec-&gt;dapm.stream_event = codec_drv-&gt;stream_event;</span><br><span class="line">    codec-&gt;dev = dev;</span><br><span class="line">    codec-&gt;driver = codec_drv;</span><br><span class="line">    codec-&gt;num_dai = num_dai;</span><br><span class="line">    mutex_init(&amp;codec-&gt;mutex);</span><br></pre></td></tr></table></figure><p>æŠŠä»¥ä¸Š codec å®ä¾‹æ’å…¥åˆ° codec_listé“¾è¡¨ä¸­ï¼ˆå£°å¡æ³¨å†Œæ—¶ä¼šéå†è¯¥é“¾è¡¨ï¼Œæ‰¾åˆ° dai_link å£°æ˜çš„ codec å¹¶ç»‘å®šï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c: snd_soc_register_codec]</span><br><span class="line">list_add(&amp;codec-&gt;<span class="built_in">list</span>, &amp;codec_list);</span><br></pre></td></tr></table></figure><p>æŠŠ codec_drv ä¸­çš„ snd_soc_dai_driverï¼ˆtasha_dai æˆ–è€…tasha_i2s_dai ï¼‰æ³¨å†Œåˆ° soc-coreï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c: snd_soc_register_codec]</span><br><span class="line">snd_soc_register_dais(&amp;codec-&gt;component, dai_drv, num_dai, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>snd_soc_register_dais() ä¼šæŠŠ dai æ’å…¥åˆ° dai_list é“¾è¡¨ä¸­ï¼ˆå£°å¡æ³¨å†Œæ—¶ä¼šéå†è¯¥é“¾è¡¨ï¼Œæ‰¾åˆ° dai_link å£°æ˜çš„ codec_dai å¹¶ç»‘å®šï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c: snd_soc_register_codec]</span><br><span class="line">list_add(&amp;dai-&gt;<span class="built_in">list</span>, &amp;dai_list);</span><br></pre></td></tr></table></figure><p>æœ€åé¡ºä¾¿æä¸‹ codec å’Œ codec_dai çš„åŒºåˆ«ï¼šcodec æŒ‡éŸ³é¢‘èŠ¯ç‰‡å…±æœ‰çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬ codec åˆå§‹åŒ–å‡½æ•°ã€æ§åˆ¶æ¥å£ã€å¯„å­˜å™¨ç¼“å­˜ã€æ§ä»¶ã€dapm éƒ¨ä»¶ã€éŸ³é¢‘è·¯ç”±ã€åç½®ç”µå‹è®¾ç½®å‡½æ•°ç­‰æè¿°ä¿¡æ¯ï¼›è€Œ codec_dai æŒ‡ codec ä¸Šçš„éŸ³é¢‘æ¥å£é©±åŠ¨æè¿°ï¼ŒåŒ…æ‹¬æ—¶é’Ÿé…ç½®ã€æ ¼å¼é…ç½®ã€èƒ½åŠ›æè¿°ç­‰ç­‰ï¼Œå„ä¸ªæ¥å£çš„æè¿°ä¿¡æ¯ä¸ä¸€å®šéƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æ¯ä¸ªéŸ³é¢‘æ¥å£éƒ½æœ‰ç€å„è‡ªçš„é©±åŠ¨æè¿°ã€‚</p><h4 id="ï¼ˆå››ï¼‰Platform-Driver"><a href="#ï¼ˆå››ï¼‰Platform-Driver" class="headerlink" title="ï¼ˆå››ï¼‰Platform Driver"></a>ï¼ˆå››ï¼‰Platform Driver</h4><p>æ¦‚è¿°ä¸­æåˆ°éŸ³é¢‘ Platform é©±åŠ¨ä¸»è¦ç”¨äºéŸ³é¢‘æ•°æ®ä¼ è¾“ï¼Œè¿™é‡Œåˆç»†åˆ†ä¸ºä¸¤æ­¥ï¼š</p><p>å¯åŠ¨ dma è®¾å¤‡ï¼ŒæŠŠéŸ³é¢‘æ•°æ®ä» dma buffer æ¬è¿åˆ° cpu_dai FIFOï¼Œè¿™éƒ¨åˆ†é©±åŠ¨ç”¨ snd_soc_platform_driver æè¿°ï¼Œåé¢åˆ†æç”¨ pcm_dma æŒ‡ä»£å®ƒã€‚<br>å¯åŠ¨æ•°å­—éŸ³é¢‘æ¥å£æ§åˆ¶å™¨ï¼ˆI2S/PCM/AC97ï¼‰ï¼ŒæŠŠéŸ³é¢‘æ•°æ®ä» cpu_dai FIFO ä¼ é€åˆ° codec_daiï¼ˆé«˜é€šå¹³å°ä¼šå°†æ•°æ®ä¼ é€åˆ°ADSPï¼‰è¿™éƒ¨åˆ†é©±åŠ¨ç”¨ snd_soc_dai_driver æè¿°ï¼Œåé¢åˆ†æç”¨ cpu_dai æŒ‡ä»£å®ƒã€‚</p><blockquote><p>MSM8996 åŒ…å«ä¸‰ä¸ª Hexagon DSP ï¼šapplication, modem, and sensorã€‚<br>Application DSPï¼šä¸ä»…å¯ä»¥å¤„ç†è¯­éŸ³å’ŒéŸ³é¢‘ï¼Œè¿˜å¯ä»¥å¤„ç†è®¡ç®—æœº è§†è§‰ã€è§†é¢‘ã€å›¾åƒå’ŒCameraã€‚<br>Sensor DSPï¼šä¹Ÿå«åšSLPIï¼Œæ‰€æœ‰çš„sensoréƒ½é“¾æ¥åˆ°SLPIä¸Šé¢ï¼Œå®ƒç®¡ç†æ‰€æœ‰çš„SensoråŠç›¸å…³ç®—æ³•ã€‚</p></blockquote><p>å¯¹äº cpu_dai é©±åŠ¨ï¼Œä»ä¸Šé¢çš„ç±»å›¾æˆ‘ä»¬å¯çŸ¥ï¼Œä¸»è¦å·¥ä½œæœ‰ï¼š</p><p>å®ç° dai æ“ä½œå‡½æ•°ï¼Œè§ snd_soc_dai_ops å®šä¹‰ï¼Œç”¨äºé…ç½®å’Œæ“ä½œéŸ³é¢‘æ•°å­—æ¥å£æ§åˆ¶å™¨ï¼Œå¦‚æ—¶é’Ÿé…ç½® set_sysclk()ã€æ ¼å¼é…ç½® set_fmt()ã€ç¡¬ä»¶å‚æ•°é…ç½® hw_params()ã€å¯åŠ¨/åœæ­¢æ•°æ®ä¼ è¾“ trigger() ç­‰ï¼›<br>å®ç° probe å‡½æ•°ï¼ˆåˆå§‹åŒ–ï¼‰ã€remove å‡½æ•°ï¼ˆå¸è½½ï¼‰ã€suspend/resume å‡½æ•°ï¼ˆç”µæºç®¡ç†ï¼‰ï¼›<br>åˆå§‹åŒ– snd_soc_dai_driver å®ä¾‹ï¼ŒåŒ…æ‹¬å›æ”¾å’Œå½•åˆ¶çš„èƒ½åŠ›æè¿°ã€dai æ“ä½œå‡½æ•°é›†ã€probe/remove å›è°ƒã€ç”µæºç®¡ç†ç›¸å…³çš„ suspend/resume å›è°ƒï¼›<br>é€šè¿‡ snd_soc_register_dai() æŠŠåˆå§‹åŒ–å®Œæˆçš„ snd_soc_dai_driver æ³¨å†Œåˆ° soc-coreï¼šé¦–å…ˆåˆ›å»ºä¸€ä¸ª snd_soc_dai å®ä¾‹ï¼Œç„¶åæŠŠè¯¥ snd_soc_dai å®ä¾‹æ’å…¥åˆ° dai_list é“¾è¡¨ï¼ˆå£°å¡æ³¨å†Œæ—¶ä¼šéå†è¯¥é“¾è¡¨ï¼Œæ‰¾åˆ° dai_link å£°æ˜çš„ cpu_dai å¹¶ç»‘å®šï¼‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[sound/soc/soc-core.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_register_dais</span><span class="params">(struct snd_soc_component *component,</span></span></span><br><span class="line"><span class="function"><span class="params">	struct snd_soc_dai_driver *dai_drv, <span class="keyword">size_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">bool</span> legacy_dai_naming)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> = <span class="title">component</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> *<span class="title">dai</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	dev_dbg(dev, <span class="string">"ASoC: dai register %s #%Zu\n"</span>, dev_name(dev), count);</span><br><span class="line"></span><br><span class="line">	component-&gt;dai_drv = dai_drv;</span><br><span class="line">	component-&gt;num_dai = count;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line"></span><br><span class="line">		dai = kzalloc(<span class="keyword">sizeof</span>(struct snd_soc_dai), GFP_KERNEL);</span><br><span class="line">		......</span><br><span class="line">		<span class="keyword">if</span> (count == <span class="number">1</span> &amp;&amp; legacy_dai_naming) &#123;</span><br><span class="line">			dai-&gt;name = fmt_single_name(dev, &amp;dai-&gt;id);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			dai-&gt;name = fmt_multiple_name(dev, &amp;dai_drv[i]);</span><br><span class="line">			<span class="keyword">if</span> (dai_drv[i].id)</span><br><span class="line">				dai-&gt;id = dai_drv[i].id;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				dai-&gt;id = i;</span><br><span class="line">		&#125;</span><br><span class="line">		......</span><br><span class="line">		dai-&gt;component = component;</span><br><span class="line">		dai-&gt;dev = dev;</span><br><span class="line">		dai-&gt;driver = &amp;dai_drv[i];</span><br><span class="line">		<span class="keyword">if</span> (!dai-&gt;driver-&gt;ops)</span><br><span class="line">			dai-&gt;driver-&gt;ops = &amp;null_dai_ops;</span><br><span class="line"></span><br><span class="line">		list_add(&amp;dai-&gt;<span class="built_in">list</span>, &amp;component-&gt;dai_list);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dai æ“ä½œå‡½æ•°çš„å®ç°æ˜¯ cpu_dai é©±åŠ¨çš„ä¸»ä½“ï¼Œéœ€è¦é…ç½®å¥½ç›¸å…³å¯„å­˜å™¨è®© I2S/PCM æ€»çº¿æ§åˆ¶å™¨æ­£å¸¸è¿è½¬ï¼Œsnd_soc_dai_ops å­—æ®µçš„è¯¦ç»†è¯´æ˜è§ 3.6. Codec audio operations ç« èŠ‚ã€‚</p><p>cpu_dai é©±åŠ¨åº”è¯¥ç®—æ˜¯è¿™ä¸ªç³»åˆ—ä¸­æœ€ç®€å•çš„ä¸€ç¯ï¼Œå› æ­¤ä¸å¤šèŠ±è´¹ç¬”å¢¨åœ¨è¿™é‡Œäº†ã€‚å€’æ˜¯æŸäº›å¹³å°ä¸Šï¼Œdma è®¾å¤‡ä¿¡æ¯ï¼ˆæ€»çº¿åœ°å€ã€é€šé“å·ã€ä¼ è¾“å•å…ƒå¤§å°ï¼‰æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ï¼Œè¿™ç‚¹è¦ç•™æ„ï¼Œè¿™äº› dma è®¾å¤‡ä¿¡æ¯åœ¨ pcm_dma é©±åŠ¨ä¸­ç”¨åˆ°ã€‚</p><h5 id="4-1-pcm-operations"><a href="#4-1-pcm-operations" class="headerlink" title="4.1. pcm operations"></a>4.1. pcm operations</h5><p>æ“ä½œå‡½æ•°çš„å®ç°æ˜¯æœ¬æ¨¡å—çš„ä¸»ä½“ï¼Œè§ snd_pcm_ops ç»“æ„ä½“æè¿°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;include/sound/pcm.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_ops</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*open)(struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*close)(struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*ioctl)(struct snd_pcm_substream * substream,</span><br><span class="line">		     <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg);</span><br><span class="line">	<span class="keyword">int</span> (*compat_ioctl)(struct snd_pcm_substream *substream,</span><br><span class="line">		     <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg);</span><br><span class="line">	<span class="keyword">int</span> (*hw_params)(struct snd_pcm_substream *substream,</span><br><span class="line">			 struct snd_pcm_hw_params *params);</span><br><span class="line">	<span class="keyword">int</span> (*hw_free)(struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*prepare)(struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*trigger)(struct snd_pcm_substream *substream, <span class="keyword">int</span> cmd);</span><br><span class="line">	<span class="keyword">snd_pcm_uframes_t</span> (*pointer)(struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*delay_blk)(struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*wall_clock)(struct snd_pcm_substream *substream,</span><br><span class="line">			  struct timespec *audio_ts);</span><br><span class="line">	<span class="keyword">int</span> (*copy)(struct snd_pcm_substream *substream, <span class="keyword">int</span> channel,</span><br><span class="line">		    <span class="keyword">snd_pcm_uframes_t</span> pos,</span><br><span class="line">		    <span class="keyword">void</span> __user *buf, <span class="keyword">snd_pcm_uframes_t</span> count);</span><br><span class="line">	<span class="keyword">int</span> (*silence)(struct snd_pcm_substream *substream, <span class="keyword">int</span> channel,</span><br><span class="line">		       <span class="keyword">snd_pcm_uframes_t</span> pos, <span class="keyword">snd_pcm_uframes_t</span> count);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *(*<span class="title">page</span>)(<span class="title">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">substream</span>,</span></span><br><span class="line"><span class="class">			     <span class="title">unsigned</span> <span class="title">long</span> <span class="title">offset</span>);</span></span><br><span class="line">	<span class="keyword">int</span> (*mmap)(struct snd_pcm_substream *substream, struct vm_area_struct *vma);</span><br><span class="line">	<span class="keyword">int</span> (*ack)(struct snd_pcm_substream *substream);</span><br><span class="line">	<span class="keyword">int</span> (*restart)(struct snd_pcm_substream *substream);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="4-1-platform-driver-æ³¨å†Œ"><a href="#4-1-platform-driver-æ³¨å†Œ" class="headerlink" title="4.1. platform_driver æ³¨å†Œ"></a>4.1. platform_driver æ³¨å†Œ</h5><p>å½“ platform_driverï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">msm_pcm_driver</span> = &#123;</span></span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = <span class="string">"msm-pcm-dsp"</span>,</span><br><span class="line">		.owner = THIS_MODULE,</span><br><span class="line">		.of_match_table = msm_pcm_dt_match,</span><br><span class="line">	&#125;,</span><br><span class="line">	.probe = msm_pcm_probe,</span><br><span class="line">	.remove = msm_pcm_remove,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸ .name = â€œmsm-pcm-dspâ€ çš„ platform_device æ³¨å†Œ åŒ¹é…åï¼Œç³»ç»Ÿä¼šå›è°ƒ msm_pcm_probe() æ³¨å†Œ platformï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/soc/msm/qdsp6v2/msm-pcm-q6-v2.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm_pcm_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msm_plat_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *latency_level;</span><br><span class="line"></span><br><span class="line">	rc = of_property_read_u32(pdev-&gt;dev.of_node,</span><br><span class="line">				<span class="string">"qcom,msm-pcm-dsp-id"</span>, &amp;id);</span><br><span class="line">	......</span><br><span class="line">	pdata = kzalloc(<span class="keyword">sizeof</span>(struct msm_plat_data), GFP_KERNEL);</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (of_property_read_bool(pdev-&gt;dev.of_node,</span><br><span class="line">				<span class="string">"qcom,msm-pcm-low-latency"</span>)) &#123;</span><br><span class="line">		pdata-&gt;perf_mode = LOW_LATENCY_PCM_MODE;</span><br><span class="line">		rc = of_property_read_string(pdev-&gt;dev.of_node,</span><br><span class="line">			<span class="string">"qcom,latency-level"</span>, &amp;latency_level);</span><br><span class="line">		<span class="keyword">if</span> (!rc) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(latency_level, <span class="string">"ultra"</span>))</span><br><span class="line">				pdata-&gt;perf_mode = ULTRA_LOW_LATENCY_PCM_MODE;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(latency_level, <span class="string">"ull-pp"</span>))</span><br><span class="line">				pdata-&gt;perf_mode =</span><br><span class="line">					ULL_POST_PROCESSING_PCM_MODE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		pdata-&gt;perf_mode = LEGACY_PCM_MODE;</span><br><span class="line"></span><br><span class="line">	dev_set_drvdata(&amp;pdev-&gt;dev, pdata);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> snd_soc_register_platform(&amp;pdev-&gt;dev,</span><br><span class="line">				   &amp;msm_soc_platform);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>snd_soc_register_platformï¼šå°† platform_drv æ³¨å†Œåˆ° soc-coreã€‚<br>åˆ›å»ºä¸€ä¸ª snd_soc_platform å®ä¾‹ï¼ŒåŒ…å« platform_drvï¼ˆsnd_soc_platform_driverï¼‰çš„ç›¸å…³ä¿¡æ¯ï¼Œå°è£…ç»™ soc-core ä½¿ç”¨ï¼›<br>æŠŠä»¥ä¸Šåˆ›å»ºçš„ platform å®ä¾‹æ’å…¥åˆ° platform_list é“¾è¡¨ä¸Šï¼ˆå£°å¡æ³¨å†Œæ—¶ä¼šéå†è¯¥é“¾è¡¨ï¼Œæ‰¾åˆ° dai_link å£°æ˜çš„ platform å¹¶ç»‘å®šï¼‰ã€‚<br>ä»£ç å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int snd_soc_register_platform(struct device *dev,</span><br><span class="line">		const struct snd_soc_platform_driver *platform_drv)</span><br><span class="line">&#123;</span><br><span class="line">	struct snd_soc_platform *platform;</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	platform = kzalloc(sizeof(struct snd_soc_platform), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">	ret = snd_soc_add_platform(dev, platform, platform_drv);</span><br><span class="line"></span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå®Œæˆäº† Platform é©±åŠ¨çš„å®ç°ã€‚å›æ”¾æƒ…å½¢ä¸‹ï¼Œpcm_dma è®¾å¤‡è´Ÿè´£æŠŠ dma buffer ä¸­çš„æ•°æ®æ¬è¿åˆ° I2S tx FIFOï¼ŒI2S æ€»çº¿æ§åˆ¶å™¨è´Ÿè´£æŠŠ I2S tx FIFO ä¸­çš„æ•°æ®ä¼ é€DSPï¼ŒDSPç»å¤„ç†åä¼ é€åˆ°åˆ° Codecã€‚</p><h4 id="ï¼ˆäº”ï¼‰-Machine-Driver"><a href="#ï¼ˆäº”ï¼‰-Machine-Driver" class="headerlink" title="ï¼ˆäº”ï¼‰  Machine Driver"></a>ï¼ˆäº”ï¼‰ Machine Driver</h4><p>ç« èŠ‚ 3. Codec å’Œ 4. Platform ä»‹ç»äº† Codecã€Platform é©±åŠ¨ï¼Œä½†ä»…æœ‰ Codecã€Platform é©±åŠ¨æ˜¯ä¸èƒ½å·¥ä½œçš„ï¼Œéœ€è¦ä¸€ä¸ªè§’è‰²æŠŠ codecã€codec_daiã€cpu_daiã€platform ç»™é“¾ç»“èµ·æ¥æ‰èƒ½æ„æˆä¸€ä¸ªå®Œæ•´çš„éŸ³é¢‘é“¾è·¯ï¼Œè¿™ä¸ªè§’è‰²å°±ç”± machine_drv æ‰¿æ‹…äº†ã€‚</p><p>snd_soc_dai_link ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;			<span class="comment">/* Codec name */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *stream_name;		<span class="comment">/* Stream name */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *cpu_name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">cpu_of_node</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *cpu_dai_name;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *codec_name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">codec_of_node</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *codec_dai_name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">codecs</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_codecs;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *platform_name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">platform_of_node</span>;</span></span><br><span class="line">	<span class="keyword">int</span> be_id;	<span class="comment">/* optional ID for machine driver BE identification */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> *<span class="title">params</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dai_fmt;           <span class="comment">/* format to set on init */</span></span><br><span class="line">	<span class="keyword">enum</span> snd_soc_dpcm_trigger trigger[<span class="number">2</span>]; <span class="comment">/* trigger type for DPCM */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ignore_suspend:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_rates:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_channels:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> symmetric_samplebits:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> no_pcm:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dynamic:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> no_host_mode:<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_capture:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> dpcm_playback:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ignore_pmdown_time:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> (*init)(struct snd_soc_pcm_runtime *rtd);</span><br><span class="line">	<span class="keyword">int</span> (*be_hw_params_fixup)(struct snd_soc_pcm_runtime *rtd,</span><br><span class="line">			struct snd_pcm_hw_params *params);</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_compr_ops</span> *<span class="title">compr_ops</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> playback_only;</span><br><span class="line">	<span class="keyword">bool</span> capture_only;</span><br><span class="line">	<span class="keyword">enum</span> snd_soc_async_ops async_ops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹ä»‹ç»å¦‚ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><p>â€¢ codec_nameï¼šéŸ³é¢‘é“¾è·¯éœ€è¦ç»‘å®šçš„ codec åç§°ï¼Œå£°å¡æ³¨å†Œæ—¶ä¼šéå† codec_listï¼Œæ‰¾åˆ°åŒåçš„ codec å¹¶ç»‘å®šï¼›<br>â€¢ platform_nameï¼šéŸ³é¢‘é“¾è·¯éœ€è¦ç»‘å®šçš„ platform åç§°ï¼Œå£°å¡æ³¨å†Œæ—¶ä¼šéå† platform_listï¼Œæ‰¾åˆ°åŒåçš„ platform å¹¶ç»‘å®šï¼›<br>â€¢ cpu_dai_nameï¼šéŸ³é¢‘é“¾è·¯éœ€è¦ç»‘å®šçš„ cpu_dai åç§°ï¼Œå£°å¡æ³¨å†Œæ—¶ä¼šéå† dai_listï¼Œæ‰¾åˆ°åŒåçš„ dai å¹¶ç»‘å®šï¼›<br>â€¢ codec_dai_nameï¼šéŸ³é¢‘é“¾è·¯éœ€è¦ç»‘å®šçš„ codec_dai åç§°ï¼Œå£°å¡æ³¨å†Œæ—¶ä¼šéå† dai_listï¼Œæ‰¾åˆ°åŒåçš„ dai å¹¶ç»‘å®šï¼›<br>opsï¼šé‡ç‚¹ç•™æ„ hw_params() å›è°ƒï¼Œä¸€èˆ¬æ¥è¯´è¿™ä¸ªå›è°ƒæ˜¯è¦å®ç°çš„ï¼Œç”¨äºé…ç½® codecã€codec_daiã€cpu_dai çš„æ•°æ®æ ¼å¼å’Œç³»ç»Ÿæ—¶é’Ÿã€‚åœ¨ 3.6. Codec audio operations å°èŠ‚ä¸­æœ‰æè¿°ã€‚<br>/sound/soc/msm/msm8996.c ä¸­çš„ dai_link å®šä¹‰ï¼Œä¸¤ä¸ªéŸ³é¢‘é“¾è·¯åˆ†åˆ«ç”¨äº Mediaå’Œ Voiceï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm8996.c]</span><br><span class="line"><span class="comment">/* Digital audio interface glue - connects codec &lt;---&gt; CPU */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> <span class="title">msm8996_common_dai_links</span>[] = &#123;</span></span><br><span class="line">	<span class="comment">/* FrontEnd DAI Links */</span></span><br><span class="line">	&#123;</span><br><span class="line">		.name = <span class="string">"MSM8996 Media1"</span>,</span><br><span class="line">		.stream_name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">		.cpu_dai_name = <span class="string">"MultiMedia1"</span>,</span><br><span class="line">		.platform_name = <span class="string">"msm-pcm-dsp.0"</span>,</span><br><span class="line">		.dynamic = <span class="number">1</span>,</span><br><span class="line">		.async_ops = ASYNC_DPCM_SND_SOC_PREPARE,</span><br><span class="line">		.dpcm_playback = <span class="number">1</span>,</span><br><span class="line">		.dpcm_capture = <span class="number">1</span>,</span><br><span class="line">		.trigger = &#123;SND_SOC_DPCM_TRIGGER_POST,</span><br><span class="line">			SND_SOC_DPCM_TRIGGER_POST&#125;,</span><br><span class="line">		.codec_dai_name = <span class="string">"snd-soc-dummy-dai"</span>,</span><br><span class="line">		.codec_name = <span class="string">"snd-soc-dummy"</span>,</span><br><span class="line">		.ignore_suspend = <span class="number">1</span>,</span><br><span class="line">		<span class="comment">/* this dainlink has playback support */</span></span><br><span class="line">		.ignore_pmdown_time = <span class="number">1</span>,</span><br><span class="line">		.be_id = MSM_FRONTEND_DAI_MULTIMEDIA1</span><br><span class="line">	&#125;,</span><br><span class="line">	......</span><br><span class="line">	&#123;</span><br><span class="line">		.name = <span class="string">"VoiceMMode1"</span>,</span><br><span class="line">		.stream_name = <span class="string">"VoiceMMode1"</span>,</span><br><span class="line">		.cpu_dai_name = <span class="string">"VoiceMMode1"</span>,</span><br><span class="line">		.platform_name = <span class="string">"msm-pcm-voice"</span>,</span><br><span class="line">		.dynamic = <span class="number">1</span>,</span><br><span class="line">		.dpcm_playback = <span class="number">1</span>,</span><br><span class="line">		.dpcm_capture = <span class="number">1</span>,</span><br><span class="line">		.trigger = &#123;SND_SOC_DPCM_TRIGGER_POST,</span><br><span class="line">			    SND_SOC_DPCM_TRIGGER_POST&#125;,</span><br><span class="line">		.no_host_mode = SND_SOC_DAI_LINK_NO_HOST,</span><br><span class="line">		.ignore_suspend = <span class="number">1</span>,</span><br><span class="line">		.ignore_pmdown_time = <span class="number">1</span>,</span><br><span class="line">		.codec_dai_name = <span class="string">"snd-soc-dummy-dai"</span>,</span><br><span class="line">		.codec_name = <span class="string">"snd-soc-dummy"</span>,</span><br><span class="line">		.be_id = MSM_FRONTEND_DAI_VOICEMMODE1,</span><br><span class="line">	&#125;,</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº† dai_linkï¼Œæœºå™¨ä¸­ä¸€äº›ç‰¹å®šçš„éŸ³é¢‘æ§ä»¶å’ŒéŸ³é¢‘äº‹ä»¶ä¹Ÿå¯ä»¥åœ¨ machine_drv å®šä¹‰ï¼Œå¦‚è€³æœºæ’æ‹”æ£€æµ‹ã€å¤–éƒ¨åŠŸæ”¾æ‰“å¼€å…³é—­ç­‰ã€‚</p><p>æˆ‘ä»¬å†åˆ†æ machine_drv åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm8996.c]</span><br><span class="line">static struct platform_driver msm8996_asoc_machine_driver = &#123;</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = DRV_NAME,</span><br><span class="line">		.owner = THIS_MODULE,</span><br><span class="line">		.pm = &amp;snd_soc_pm_ops,</span><br><span class="line">		.of_match_table = msm8996_asoc_machine_of_match,</span><br><span class="line">	&#125;,</span><br><span class="line">	.probe = msm8996_asoc_machine_probe,</span><br><span class="line">	.remove = msm8996_asoc_machine_remove,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/msm/msm8996.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm8996_asoc_machine_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> *<span class="title">card</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msm8996_asoc_mach_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *mbhc_audio_jack_type = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">char</span> *mclk_freq_prop_name;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">match</span>;</span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">    ......</span><br><span class="line">	pdata = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line">			<span class="keyword">sizeof</span>(struct msm8996_asoc_mach_data), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	card = populate_snd_card_dailinks(&amp;pdev-&gt;dev);</span><br><span class="line">	......</span><br><span class="line">	match = of_match_node(msm8996_asoc_machine_of_match,</span><br><span class="line">			pdev-&gt;dev.of_node);</span><br><span class="line">	ret = msm8996_populate_dai_link_component_of_node(card);</span><br><span class="line">	......</span><br><span class="line">	</span><br><span class="line">	ret = snd_soc_register_card(card);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®dailinksåï¼Œç»§è€Œè°ƒç”¨ snd_soc_register_card() æ³¨å†Œå£°å¡ã€‚ç”±äºè¯¥è¿‡ç¨‹å¾ˆå†—é•¿ï¼Œè¿™é‡Œä¸ä¸€ä¸€è´´ä»£ç åˆ†æäº†ï¼Œä½†æ•´ä¸ªæµç¨‹æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/23-Audio-system-msm8996-probe-snd-card-register.png" alt="Alt text"></p><p>â€¢ å–å‡º platform_device çš„ç§æœ‰æ•°æ®ï¼Œè¯¥ç§æœ‰æ•°æ®å°±æ˜¯ snd_soc_card ï¼›<br>â€¢ snd_soc_register_card() ä¸ºæ¯ä¸ª dai_link åˆ†é…ä¸€ä¸ª snd_soc_pcm_runtime å®ä¾‹ï¼Œåˆ«å¿˜äº†ä¹‹å‰æè¿‡ snd_soc_pcm_runtime æ˜¯ ASoC çš„æ¡¥æ¢ï¼Œä¿å­˜ç€ codecã€codec_daiã€cpu_daiã€platform ç­‰ç¡¬ä»¶è®¾å¤‡å®ä¾‹ã€‚<br>â€¢ éšåçš„å·¥ä½œéƒ½åœ¨ snd_soc_instantiate_card() è¿›è¡Œï¼š<br>â€¢ éå† dai_listã€codec_listã€platform_list é“¾è¡¨ï¼Œä¸ºæ¯ä¸ªéŸ³é¢‘é“¾è·¯æ‰¾åˆ°å¯¹åº”çš„ cpu_daiã€codec_daiã€codecã€platformï¼›æ‰¾åˆ°çš„ cpu_daiã€codec_daiã€codecã€platform ä¿å­˜åˆ° snd_soc_pcm_runtime ï¼Œå®ŒæˆéŸ³é¢‘é“¾è·¯çš„è®¾å¤‡ç»‘å®šï¼›<br>â€¢ è°ƒç”¨ snd_card_create() åˆ›å»ºå£°å¡ï¼›<br>â€¢ soc_probe_dai_link() ä¾æ¬¡å›è°ƒ cpu_daiã€codecã€platformã€codec_dai çš„ probe() å‡½æ•°ï¼Œå®Œæˆå„éŸ³é¢‘è®¾å¤‡çš„åˆå§‹åŒ–ï¼Œéšåè°ƒç”¨<br>â€¢ soc_new_pcm() åˆ›å»º pcm é€»è¾‘è®¾å¤‡ï¼ˆå› ä¸ºæ¶‰åŠåˆ°æœ¬ç³»åˆ—çš„é‡ç‚¹å†…å®¹ï¼Œåé¢å…·ä½“åˆ†æè¿™ä¸ªå‡½æ•°ï¼‰ï¼›<br>æœ€åè°ƒç”¨ snd_card_register() æ³¨å†Œå£°å¡ã€‚</p><p>[-&gt;sound/soc/soc-core.c]</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/24-Audio-system-msm8996-probe-snd-card.png" alt="Alt text"></p><p>soc_new_pcm æºç åˆ†æï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-pcm.c]</span><br><span class="line"><span class="comment">/* create a new pcm */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">soc_new_pcm</span><span class="params">(struct snd_soc_pcm_runtime *rtd, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_platform</span> *<span class="title">platform</span> = <span class="title">rtd</span>-&gt;<span class="title">platform</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> *<span class="title">codec_dai</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> *<span class="title">cpu_dai</span> = <span class="title">rtd</span>-&gt;<span class="title">cpu_dai</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line">	<span class="keyword">char</span> new_name[<span class="number">64</span>];</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>, playback = <span class="number">0</span>, capture = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rtd-&gt;dai_link-&gt;dynamic || rtd-&gt;dai_link-&gt;no_pcm) &#123;</span><br><span class="line">		playback = rtd-&gt;dai_link-&gt;dpcm_playback;</span><br><span class="line">		capture = rtd-&gt;dai_link-&gt;dpcm_capture;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rtd-&gt;num_codecs; i++) &#123;</span><br><span class="line">			codec_dai = rtd-&gt;codec_dais[i];</span><br><span class="line">			<span class="keyword">if</span> (codec_dai-&gt;driver-&gt;playback.channels_min)</span><br><span class="line">				playback = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span> (codec_dai-&gt;driver-&gt;capture.channels_min)</span><br><span class="line">				capture = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		capture = capture &amp;&amp; cpu_dai-&gt;driver-&gt;capture.channels_min;</span><br><span class="line">		playback = playback &amp;&amp; cpu_dai-&gt;driver-&gt;playback.channels_min;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rtd-&gt;dai_link-&gt;playback_only) &#123;</span><br><span class="line">		playback = <span class="number">1</span>;</span><br><span class="line">		capture = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rtd-&gt;dai_link-&gt;capture_only) &#123;</span><br><span class="line">		playback = <span class="number">0</span>;</span><br><span class="line">		capture = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* create the PCM */</span></span><br><span class="line">	<span class="keyword">if</span> (rtd-&gt;dai_link-&gt;no_pcm) &#123;</span><br><span class="line">		<span class="built_in">snprintf</span>(new_name, <span class="keyword">sizeof</span>(new_name), <span class="string">"(%s)"</span>,</span><br><span class="line">			rtd-&gt;dai_link-&gt;stream_name);</span><br><span class="line"></span><br><span class="line">		ret = snd_pcm_new_internal(rtd-&gt;card-&gt;snd_card, new_name, num,</span><br><span class="line">				playback, capture, &amp;pcm);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (rtd-&gt;dai_link-&gt;dynamic)</span><br><span class="line">			<span class="built_in">snprintf</span>(new_name, <span class="keyword">sizeof</span>(new_name), <span class="string">"%s (*)"</span>,</span><br><span class="line">				rtd-&gt;dai_link-&gt;stream_name);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">snprintf</span>(new_name, <span class="keyword">sizeof</span>(new_name), <span class="string">"%s %s-%d"</span>,</span><br><span class="line">				rtd-&gt;dai_link-&gt;stream_name,</span><br><span class="line">				(rtd-&gt;num_codecs &gt; <span class="number">1</span>) ?</span><br><span class="line">				<span class="string">"multicodec"</span> : rtd-&gt;codec_dai-&gt;name, num);</span><br><span class="line"></span><br><span class="line">		ret = snd_pcm_new(rtd-&gt;card-&gt;snd_card, new_name, num, playback,</span><br><span class="line">			capture, &amp;pcm);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		dev_err(rtd-&gt;card-&gt;dev, <span class="string">"ASoC: can't create pcm for %s\n"</span>,</span><br><span class="line">			rtd-&gt;dai_link-&gt;name);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	dev_dbg(rtd-&gt;card-&gt;dev, <span class="string">"ASoC: registered pcm #%d %s\n"</span>,num, new_name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DAPM dai link stream work */</span></span><br><span class="line">	INIT_DELAYED_WORK(&amp;rtd-&gt;delayed_work, close_delayed_work);</span><br><span class="line"></span><br><span class="line">	rtd-&gt;pcm = pcm;</span><br><span class="line">	pcm-&gt;private_data = rtd;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rtd-&gt;dai_link-&gt;no_pcm) &#123;</span><br><span class="line">		<span class="keyword">if</span> (playback)</span><br><span class="line">			pcm-&gt;streams[SNDRV_PCM_STREAM_PLAYBACK].substream-&gt;private_data = rtd;</span><br><span class="line">		<span class="keyword">if</span> (capture)</span><br><span class="line">			pcm-&gt;streams[SNDRV_PCM_STREAM_CAPTURE].substream-&gt;private_data = rtd;</span><br><span class="line">		<span class="keyword">if</span> (platform-&gt;driver-&gt;pcm_new)</span><br><span class="line">			rtd-&gt;platform-&gt;driver-&gt;pcm_new(rtd);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* setup any hostless PCMs - i.e. no host IO is performed */</span></span><br><span class="line">	<span class="keyword">if</span> (rtd-&gt;dai_link-&gt;no_host_mode) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pcm-&gt;streams[SNDRV_PCM_STREAM_PLAYBACK].substream) &#123;</span><br><span class="line">			pcm-&gt;streams[SNDRV_PCM_STREAM_PLAYBACK].substream-&gt;hw_no_buffer = <span class="number">1</span>;</span><br><span class="line">			snd_soc_set_runtime_hwparams(</span><br><span class="line">				pcm-&gt;streams[SNDRV_PCM_STREAM_PLAYBACK].substream,</span><br><span class="line">				&amp;no_host_hardware);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (pcm-&gt;streams[SNDRV_PCM_STREAM_CAPTURE].substream) &#123;</span><br><span class="line">			pcm-&gt;streams[SNDRV_PCM_STREAM_CAPTURE].substream-&gt;hw_no_buffer = <span class="number">1</span>;</span><br><span class="line">			snd_soc_set_runtime_hwparams(</span><br><span class="line">				pcm-&gt;streams[SNDRV_PCM_STREAM_CAPTURE].substream,</span><br><span class="line">				&amp;no_host_hardware);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ASoC PCM operations */</span></span><br><span class="line">	<span class="keyword">if</span> (rtd-&gt;dai_link-&gt;dynamic) &#123;</span><br><span class="line">		rtd-&gt;ops.open		= dpcm_fe_dai_open;</span><br><span class="line">		rtd-&gt;ops.hw_params	= dpcm_fe_dai_hw_params;</span><br><span class="line">		rtd-&gt;ops.prepare	= dpcm_fe_dai_prepare;</span><br><span class="line">		rtd-&gt;ops.trigger	= dpcm_fe_dai_trigger;</span><br><span class="line">		rtd-&gt;ops.hw_free	= dpcm_fe_dai_hw_free;</span><br><span class="line">		rtd-&gt;ops.close		= dpcm_fe_dai_close;</span><br><span class="line">		rtd-&gt;ops.pointer	= soc_pcm_pointer;</span><br><span class="line">		rtd-&gt;ops.delay_blk	= soc_pcm_delay_blk;</span><br><span class="line">		rtd-&gt;ops.ioctl		= soc_pcm_ioctl;</span><br><span class="line">		rtd-&gt;ops.compat_ioctl   = soc_pcm_compat_ioctl;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		rtd-&gt;ops.open		= soc_pcm_open;</span><br><span class="line">		rtd-&gt;ops.hw_params	= soc_pcm_hw_params;</span><br><span class="line">		rtd-&gt;ops.prepare	= soc_pcm_prepare;</span><br><span class="line">		rtd-&gt;ops.trigger	= soc_pcm_trigger;</span><br><span class="line">		rtd-&gt;ops.hw_free	= soc_pcm_hw_free;</span><br><span class="line">		rtd-&gt;ops.close		= soc_pcm_close;</span><br><span class="line">		rtd-&gt;ops.pointer	= soc_pcm_pointer;</span><br><span class="line">		rtd-&gt;ops.delay_blk	= soc_pcm_delay_blk;</span><br><span class="line">		rtd-&gt;ops.ioctl		= soc_pcm_ioctl;</span><br><span class="line">		rtd-&gt;ops.compat_ioctl   = soc_pcm_compat_ioctl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (platform-&gt;driver-&gt;ops) &#123;</span><br><span class="line">		rtd-&gt;ops.ack		= platform-&gt;driver-&gt;ops-&gt;ack;</span><br><span class="line">		rtd-&gt;ops.copy		= platform-&gt;driver-&gt;ops-&gt;copy;</span><br><span class="line">		rtd-&gt;ops.silence	= platform-&gt;driver-&gt;ops-&gt;silence;</span><br><span class="line">		rtd-&gt;ops.page		= platform-&gt;driver-&gt;ops-&gt;page;</span><br><span class="line">		rtd-&gt;ops.mmap		= platform-&gt;driver-&gt;ops-&gt;mmap;</span><br><span class="line">		rtd-&gt;ops.restart	= platform-&gt;driver-&gt;ops-&gt;restart;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (playback)</span><br><span class="line">		snd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK, &amp;rtd-&gt;ops);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (capture)</span><br><span class="line">		snd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, &amp;rtd-&gt;ops);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (platform-&gt;driver-&gt;pcm_new) &#123;</span><br><span class="line">		ret = platform-&gt;driver-&gt;pcm_new(rtd);</span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			dev_err(platform-&gt;dev,</span><br><span class="line">				<span class="string">"ASoC: pcm constructor failed: %d\n"</span>,</span><br><span class="line">				ret);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pcm-&gt;private_free = platform-&gt;driver-&gt;pcm_free;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§ soc_new_pcm() æœ€ä¸»è¦çš„å·¥ä½œæ˜¯åˆ›å»º pcm é€»è¾‘è®¾å¤‡ï¼Œåˆ›å»ºå›æ”¾å­æµå’Œå½•åˆ¶å­æµå®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–å›æ”¾å­æµå’Œå½•åˆ¶å­æµçš„ pcm æ“ä½œå‡½æ•°ï¼ˆæ•°æ®æ¬è¿æ—¶ï¼Œéœ€è¦è°ƒç”¨è¿™äº›å‡½æ•°æ¥é©±åŠ¨ codecã€codec_daiã€cpu_daiã€dma è®¾å¤‡å·¥ä½œï¼‰ã€‚</p><h4 id="ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ-PCM-è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹"><a href="#ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ-PCM-è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹" class="headerlink" title="ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ PCM è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹"></a>ï¼ˆå…­ï¼‰ã€å£°å¡å’Œ PCM è®¾å¤‡çš„å»ºç«‹è¿‡ç¨‹</h4><p>å‰é¢å‡ ç« åˆ†æäº† Codecã€Platformã€Machine é©±åŠ¨çš„ç»„æˆéƒ¨åˆ†åŠå…¶æ³¨å†Œè¿‡ç¨‹ï¼Œè¿™ä¸‰è€…éƒ½æ˜¯ç‰©ç†è®¾å¤‡ç›¸å…³çš„ï¼Œå¤§å®¶åº”è¯¥å¯¹éŸ³é¢‘ç‰©ç†é“¾è·¯æœ‰äº†ä¸€å®šçš„è®¤çŸ¥ã€‚æ¥ç€åˆ†æéŸ³é¢‘é©±åŠ¨çš„ä¸­é—´å±‚ï¼Œç”±äºè¿™äº›å¹¶ä¸æ˜¯çœŸæ­£çš„ç‰©ç†è®¾å¤‡ï¼Œæ•…æˆ‘ä»¬ç§°ä¹‹ä¸ºé€»è¾‘è®¾å¤‡ã€‚</p><p>PCM é€»è¾‘è®¾å¤‡ï¼Œæˆ‘ä»¬åˆä¹ æƒ¯ç§°ä¹‹ä¸º PCM ä¸­é—´å±‚æˆ– pcm nativeï¼Œèµ·ç€æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼šå¾€ä¸Šæ˜¯ä¸ç”¨æˆ·æ€æ¥å£çš„äº¤äº’ï¼Œå®ç°éŸ³é¢‘æ•°æ®åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„æ‹·è´ï¼›å¾€ä¸‹æ˜¯è§¦å‘ codecã€platformã€machine çš„æ“ä½œå‡½æ•°ï¼Œå®ç°éŸ³é¢‘æ•°æ®åœ¨ dma_buffer &lt;-&gt; cpu_dai &lt;-&gt; codec ä¹‹é—´çš„ä¼ è¾“ã€‚åé¢ç« èŠ‚å°†ä¼šè¯¦ç»†åˆ†æè¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™é‡Œè¿˜æ˜¯å…ˆä»å£°å¡çš„æ³¨å†Œè°ˆèµ·ã€‚<br>å£°å¡é©±åŠ¨ä¸­ï¼Œä¸€èˆ¬æŒ‚è½½ç€å¤šä¸ªé€»è¾‘è®¾å¤‡ï¼Œçœ‹çœ‹æˆ‘ä»¬è®¡ç®—æœºçš„å£°å¡é©±åŠ¨æœ‰å‡ ä¸ªé€»è¾‘è®¾å¤‡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /proc/asound/devices </span><br><span class="line">  2: [ 0]   : control</span><br><span class="line">  3: [ 0- 0]: digital audio playback</span><br><span class="line">  4: [ 0- 0]: digital audio capture</span><br><span class="line">  5: [ 0- 1]: digital audio playback</span><br><span class="line">  6: [ 0- 1]: digital audio capture</span><br><span class="line"> ......</span><br><span class="line"> 27: [ 0-16]: digital audio playback</span><br><span class="line"> 28: [ 0-16]: digital audio capture</span><br><span class="line"> 29: [ 0-17]: digital audio playback</span><br><span class="line"> 30: [ 0-17]: digital audio capture</span><br><span class="line"> 33:        : timer</span><br></pre></td></tr></table></figure><blockquote><p>digital audio playback ç”¨äºå›æ”¾çš„ PCM è®¾å¤‡<br>digital audio capture ç”¨äºå½•åˆ¶çš„ PCM è®¾å¤‡<br>control ç”¨äºå£°å¡æ§åˆ¶çš„ CTL è®¾å¤‡ï¼Œå¦‚é€šè·¯æ§åˆ¶ã€éŸ³é‡è°ƒæ•´ç­‰<br>timer å®šæ—¶å™¨è®¾å¤‡<br>æ‰‹æœºç³»ç»Ÿä¸­ï¼Œé€šå¸¸æˆ‘ä»¬æ›´å…³å¿ƒ PCM å’Œ CTL è¿™ä¸¤ç§è®¾å¤‡ã€‚</p></blockquote><p>è®¾å¤‡èŠ‚ç‚¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">adb shell ls -l /dev/snd</span><br><span class="line">crw-rw---- 1 system audio 116,  51 1970-06-19 02:07 comprC0D24</span><br><span class="line">crw-rw---- 1 system audio 116,  52 1970-06-19 02:07 comprC0D27</span><br><span class="line">crw-rw---- 1 system audio 116,  53 1970-06-19 02:07 comprC0D28</span><br><span class="line">......</span><br><span class="line">crw-rw---- 1 system audio 116,   2 1970-06-19 02:07 controlC0</span><br><span class="line">crw-rw---- 1 system audio 116,  59 1970-06-19 02:07 hwC0D1000</span><br><span class="line">crw-rw---- 1 system audio 116,  66 1970-06-19 02:07 hwC0D11</span><br><span class="line">crw-rw---- 1 system audio 116,  67 1970-06-19 02:07 hwC0D12</span><br><span class="line">crw-rw---- 1 system audio 116,  76 1970-06-19 02:07 hwC0D13</span><br><span class="line">......</span><br><span class="line">crw-rw---- 1 system audio 116,  13 1970-06-19 02:07 pcmC0D6c</span><br><span class="line">crw-rw---- 1 system audio 116,  14 1970-06-19 02:07 pcmC0D7p</span><br><span class="line">crw-rw---- 1 system audio 116,  15 1970-06-19 02:07 pcmC0D8c</span><br><span class="line">crw-rw---- 1 system audio 116,  33 1970-06-19 02:07 timer</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™äº›è®¾å¤‡èŠ‚ç‚¹çš„ Major=116ï¼ŒMinor åˆ™ä¸ /proc/asound/devices æ‰€åˆ—çš„å¯¹åº”èµ·æ¥ï¼Œéƒ½æ˜¯å­—ç¬¦è®¾å¤‡ã€‚ä¸Šå±‚å¯ä»¥é€šè¿‡ open/close/read/write/ioctl ç­‰ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œå£°å¡è®¾å¤‡ï¼Œè¿™å’Œå…¶ä»–å­—ç¬¦è®¾å¤‡ç±»ä¼¼ï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šä½¿ç”¨å·²å°è£…å¥½çš„ç”¨æˆ·æ¥å£åº“å¦‚ tinyalsaã€alsa-libã€‚</p><h5 id="6-1-å£°å¡ç»“æ„æ¦‚è¿°"><a href="#6-1-å£°å¡ç»“æ„æ¦‚è¿°" class="headerlink" title="6.1. å£°å¡ç»“æ„æ¦‚è¿°"></a>6.1. å£°å¡ç»“æ„æ¦‚è¿°</h5><p>å›é¡¾ä¸‹ ASoC æ˜¯å¦‚ä½•æ³¨å†Œå£°å¡çš„ï¼Œè¯¦ç»†è¯·å‚è€ƒç« èŠ‚ 5. ASoC machine driverï¼Œè¿™é‡Œä»…ç®€å•é™ˆè¿°ä¸‹ï¼š</p><p>â€¢ Machine é©±åŠ¨åˆå§‹åŒ–æ—¶ï¼Œ.name = â€œsoc-audioâ€ çš„ platform_device ä¸ platform_driver åŒ¹é…æˆåŠŸï¼Œè§¦å‘ soc_probe() è°ƒç”¨ï¼›<br>â€¢ ç»§è€Œè°ƒç”¨ snd_soc_register_card()ï¼š<br>ï¹‹â€¢ ä¸ºæ¯ä¸ªéŸ³é¢‘ç‰©ç†é“¾è·¯æ‰¾åˆ°å¯¹åº”çš„ codecã€codec_daiã€cpu_daiã€platform è®¾å¤‡å®ä¾‹ï¼Œå®Œæˆ dai_link çš„ç»‘å®šï¼›<br>ï¹‹ â€¢ è°ƒç”¨ snd_card_create() åˆ›å»ºå£°å¡ï¼›<br>ï¹‹ â€¢ ä¾æ¬¡å›è°ƒ cpu_daiã€codecã€platform çš„ probe() å‡½æ•°ï¼Œå®Œæˆç‰©ç†è®¾å¤‡çš„åˆå§‹åŒ–ï¼›<br>â€¢ éšåè°ƒç”¨ soc_new_pcm()ï¼š<br>ï¹‹ â€¢ è®¾ç½® pcm native ä¸­è¦ä½¿ç”¨çš„ pcm æ“ä½œå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ç”¨äºé©±åŠ¨éŸ³é¢‘ç‰©ç†è®¾å¤‡ï¼ŒåŒ…æ‹¬ machineã€codec_daiã€cpu_daiã€platformï¼›<br>ï¹‹ â€¢ è°ƒç”¨ snd_pcm_new() åˆ›å»º pcm é€»è¾‘è®¾å¤‡ï¼Œå›æ”¾å­æµå’Œå½•åˆ¶å­æµéƒ½åœ¨è¿™é‡Œåˆ›å»ºï¼›<br>ï¹‹ â€¢ å›è°ƒ platform é©±åŠ¨çš„ pcm_new()ï¼Œå®ŒæˆéŸ³é¢‘ dma è®¾å¤‡åˆå§‹åŒ–å’Œ dma buffer å†…å­˜åˆ†é…ï¼›<br>â€¢ æœ€åè°ƒç”¨ snd_card_register() æ³¨å†Œå£°å¡ã€‚<br>å…³äºéŸ³é¢‘ç‰©ç†è®¾å¤‡éƒ¨åˆ†ï¼ˆCodec/Platform/Machineï¼‰ä¸å†ç´¯è¿°ï¼Œä¸‹é¢è¯¦ç»†åˆ†æå£°å¡å’Œ PCM é€»è¾‘è®¾å¤‡çš„æ³¨å†Œè¿‡ç¨‹ã€‚</p><p>ä¸Šé¢æåˆ°å£°å¡é©±åŠ¨ä¸ŠæŒ‚ç€å¤šä¸ªé€»è¾‘å­è®¾å¤‡ï¼Œæœ‰ pcm éŸ³é¢‘æ•°æ®æµã€control æ··éŸ³å™¨ã€midi è¿·ç¬›ã€timer å®šæ—¶å™¨ç­‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                  +-----------+</span><br><span class="line">                  | snd_card  |</span><br><span class="line">                  +-----------+</span><br><span class="line">                    |   |   |</span><br><span class="line">        +-----------+   |   +------------+</span><br><span class="line">        |               |                |</span><br><span class="line">+-----------+    +-----------+    +-----------+</span><br><span class="line"> |  snd_pcm  |    |snd_control|    | snd_timer |    ...</span><br><span class="line"> +-----------+    +-----------+    +-----------+</span><br></pre></td></tr></table></figure><p>è¿™äº›ä¸å£°éŸ³ç›¸å…³çš„é€»è¾‘è®¾å¤‡éƒ½åœ¨ç»“æ„ä½“ snd_card ç®¡ç†ä¹‹ä¸‹ï¼Œå¯ä»¥è¯´ snd_card æ˜¯ alsa ä¸­æœ€é¡¶å±‚çš„ç»“æ„ã€‚æˆ‘ä»¬å†çœ‹çœ‹ alsa å£°å¡é©±åŠ¨çš„å¤§è‡´ç»“æ„å›¾ï¼ˆä¸æ˜¯ä¸¥æ ¼çš„ UML ç±»å›¾ï¼Œæœ‰ç»“æ„ä½“å®šä¹‰ã€æ¨¡å—å…³ç³»ã€å‡½æ•°è°ƒç”¨ï¼Œæ–¹ä¾¿æ ‡ç¤ºç»“æ„æ¨¡å—çš„å±‚æ¬¡åŠå…³ç³»ï¼‰ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/25-Audio-system-snd-card-uml.png" alt="Alt text"></p><p>snd_cardsï¼šè®°å½•ç€æ‰€æ³¨å†Œçš„å£°å¡å®ä¾‹ï¼Œæ¯ä¸ªå£°å¡å®ä¾‹æœ‰ç€å„è‡ªçš„é€»è¾‘è®¾å¤‡ï¼Œå¦‚ PCM è®¾å¤‡ã€CTL è®¾å¤‡ã€MIDI è®¾å¤‡ç­‰ï¼Œå¹¶ä¸€ä¸€è®°å½•åˆ° snd_card çš„ devices é“¾è¡¨ä¸Š<br>snd_minorsï¼šè®°å½•ç€æ‰€æœ‰é€»è¾‘è®¾å¤‡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå®ƒæ˜¯å£°å¡é€»è¾‘è®¾å¤‡ä¸ç³»ç»Ÿè°ƒç”¨ API ä¹‹é—´çš„æ¡¥æ¢ï¼›æ¯ä¸ª snd_minor åœ¨é€»è¾‘è®¾å¤‡æ³¨å†Œæ—¶è¢«å¡«å……ï¼Œåœ¨é€»è¾‘è®¾å¤‡ä½¿ç”¨æ—¶å°±å¯ä»¥ä»è¯¥ç»“æ„ä½“ä¸­å¾—åˆ°ç›¸åº”çš„ä¿¡æ¯ï¼ˆä¸»è¦æ˜¯ç³»ç»Ÿè°ƒç”¨å‡½æ•°é›† file_operationsï¼‰</p><h5 id="6-2-å£°å¡çš„åˆ›å»ºsnd-card-create"><a href="#6-2-å£°å¡çš„åˆ›å»ºsnd-card-create" class="headerlink" title="6.2. å£°å¡çš„åˆ›å»ºsnd_card_create()"></a>6.2. å£°å¡çš„åˆ›å»ºsnd_card_create()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;sound/core/init.c]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  snd_card_new - create and initialize a soundcard structure</span></span><br><span class="line"><span class="comment"> *  @parent: the parent device object</span></span><br><span class="line"><span class="comment"> *  @idx: card index (address) [0 ... (SNDRV_CARDS-1)]</span></span><br><span class="line"><span class="comment"> *  @xid: card identification (ASCII string)</span></span><br><span class="line"><span class="comment"> *  @module: top level module for locking</span></span><br><span class="line"><span class="comment"> *  @extra_size: allocate this extra size after the main soundcard structure</span></span><br><span class="line"><span class="comment"> *  @card_ret: the pointer to store the created card instance</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Creates and initializes a soundcard structure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  The function allocates snd_card instance via kzalloc with the given</span></span><br><span class="line"><span class="comment"> *  space for the driver to use freely.  The allocated struct is stored</span></span><br><span class="line"><span class="comment"> *  in the given card_ret pointer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Return: Zero if successful or a negative error code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_card_new</span><span class="params">(struct device *parent, <span class="keyword">int</span> idx, <span class="keyword">const</span> <span class="keyword">char</span> *xid,</span></span></span><br><span class="line"><span class="function"><span class="params">		    struct <span class="keyword">module</span> *<span class="keyword">module</span>, <span class="keyword">int</span> extra_size,</span></span></span><br><span class="line"><span class="function"><span class="params">		    struct snd_card **card_ret)</span></span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šéå¸¸è¯¦ç»†ï¼Œç®€å•è¯´ä¸‹ï¼š<br>idxï¼šå£°å¡çš„ç¼–å·ï¼Œå¦‚ä¸º -1ï¼Œåˆ™ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…<br>xidï¼šå£°å¡æ ‡è¯†ç¬¦ï¼Œå¦‚ä¸º NULLï¼Œåˆ™ä»¥ snd_card çš„ shortname æˆ– longname ä»£æ›¿<br>card_retï¼šè¿”å›æ‰€åˆ›å»ºçš„å£°å¡å®ä¾‹çš„æŒ‡é’ˆ<br>å¦‚ä¸‹æ˜¯Google Pixelæ‰‹æœºçš„å£°å¡ä¿¡æ¯ï¼š<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">sailfish:/ $ cat /proc/asound/cards</span><br><span class="line"> 0 [msm8996tashamar]: msm8996-tasha-m - msm8996-tasha-marlin-snd-card</span><br><span class="line">                      msm8996-tasha-marlin-snd-card</span><br></pre></td></tr></table></figure><p></p><h5 id="6-3-é€»è¾‘è®¾å¤‡çš„åˆ›å»º"><a href="#6-3-é€»è¾‘è®¾å¤‡çš„åˆ›å»º" class="headerlink" title="6.3. é€»è¾‘è®¾å¤‡çš„åˆ›å»º"></a>6.3. é€»è¾‘è®¾å¤‡çš„åˆ›å»º</h5><p>å½“å£°å¡å®ä¾‹å»ºç«‹åï¼Œæ¥ç€å¯ä»¥åˆ›å»ºå£°å¡ä¸‹é¢çš„å„ä¸ªé€»è¾‘è®¾å¤‡äº†ã€‚æ¯ä¸ªé€»è¾‘è®¾å¤‡åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ snd_device_new() ç”Ÿæˆä¸€ä¸ª snd_device å®ä¾‹ï¼Œå¹¶æŠŠè¯¥å®ä¾‹æŒ‚åˆ°å£°å¡ snd_card çš„ devices é“¾è¡¨ä¸Šã€‚alsa é©±åŠ¨ä¸ºå„ç§é€»è¾‘è®¾å¤‡æä¾›äº†åˆ›å»ºæ¥å£ï¼Œå¦‚ä¸‹ï¼š</p><blockquote><p>PCM snd_pcm_new()<br>CONTROL snd_ctl_create()<br>MIDI snd_rawmidi_new()<br>TIMER snd_timer_new()<br>SEQUENCER snd_seq_device_new()<br>JACK snd_jack_new()</p></blockquote><p>è¿™äº›æ¥å£çš„ä¸€èˆ¬è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_xxx_new</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è¿™äº›æ¥å£ä¾›é€»è¾‘è®¾å¤‡æ³¨å†Œæ—¶å›è°ƒ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_device_ops</span> <span class="title">ops</span> = &#123;</span></span><br><span class="line">        .dev_free = snd_xxx_dev_free,</span><br><span class="line">        .dev_register = snd_xxx_dev_register,</span><br><span class="line">        .dev_disconnect = snd_xxx_dev_disconnect,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€»è¾‘è®¾å¤‡å®ä¾‹åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°å»ºä¸€ä¸ªè®¾å¤‡å®ä¾‹ snd_deviceï¼ŒæŒ‚åˆ° snd_card çš„ devices é“¾è¡¨ä¸Šï¼ŒæŠŠè¯¥é€»è¾‘è®¾å¤‡çº³å…¥å£°å¡çš„ç®¡ç†å½“ä¸­ï¼ŒSNDRV_DEV_xxx æ˜¯é€»è¾‘è®¾å¤‡çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> snd_device_new(card, SNDRV_DEV_xxx, card, &amp;ops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ snd_device_ops æ˜¯å£°å¡é€»è¾‘è®¾å¤‡çš„æ³¨å†Œå‡½æ•°é›†ï¼Œdev_register() å›è°ƒå°¤å…¶é‡è¦ï¼Œå®ƒåœ¨å£°å¡æ³¨å†Œæ—¶è¢«è°ƒç”¨ï¼Œç”¨äºå»ºç«‹ç³»ç»Ÿçš„è®¾å¤‡èŠ‚ç‚¹ï¼Œ/dev/snd/ ç›®å½•çš„è®¾å¤‡èŠ‚ç‚¹éƒ½æ˜¯åœ¨è¿™é‡Œåˆ›å»ºçš„ï¼Œé€šè¿‡è¿™äº›è®¾å¤‡èŠ‚ç‚¹å¯ç³»ç»Ÿè°ƒç”¨ open/release/read/write/ioctlâ€¦ è®¿é—®æ“ä½œè¯¥é€»è¾‘è®¾å¤‡ã€‚</p><p>ä¾‹å¦‚ snd_ctl_dev_register()ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/core/control.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">snd_ctl_f_ops</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	.owner =	THIS_MODULE,</span><br><span class="line">	.read =		snd_ctl_read,</span><br><span class="line">	.open =		snd_ctl_open,</span><br><span class="line">	.release =	snd_ctl_release,</span><br><span class="line">	.llseek =	no_llseek,</span><br><span class="line">	.poll =		snd_ctl_poll,</span><br><span class="line">	.unlocked_ioctl =	snd_ctl_ioctl,</span><br><span class="line">	.compat_ioctl =	snd_ctl_ioctl_compat,</span><br><span class="line">	.fasync =	snd_ctl_fasync,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * registration of the control device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_ctl_dev_register</span><span class="params">(struct snd_device *device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span> = <span class="title">device</span>-&gt;<span class="title">device_data</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err, cardnum;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (snd_BUG_ON(!card))</span><br><span class="line">		<span class="keyword">return</span> -ENXIO;</span><br><span class="line">	cardnum = card-&gt;number;</span><br><span class="line">	<span class="keyword">if</span> (snd_BUG_ON(cardnum &lt; <span class="number">0</span> || cardnum &gt;= SNDRV_CARDS))</span><br><span class="line">		<span class="keyword">return</span> -ENXIO;</span><br><span class="line">	<span class="built_in">sprintf</span>(name, <span class="string">"controlC%i"</span>, cardnum);</span><br><span class="line">	<span class="keyword">if</span> ((err = snd_register_device(SNDRV_DEVICE_TYPE_CONTROL, card, <span class="number">-1</span>,</span><br><span class="line">				       &amp;snd_ctl_f_ops, card, name)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº‹å®æ˜¯è°ƒç”¨ snd_register_device_for_dev ()ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/core/sound.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_register_device_for_dev</span><span class="params">(<span class="keyword">int</span> type, struct snd_card *card, <span class="keyword">int</span> dev,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">const</span> struct file_operations *f_ops,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">void</span> *private_data,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">const</span> <span class="keyword">char</span> *name, struct device *device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> minor;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_minor</span> *<span class="title">preg</span>;</span></span><br><span class="line">	preg = kmalloc(<span class="keyword">sizeof</span> *preg, GFP_KERNEL);</span><br><span class="line">	</span><br><span class="line">	preg-&gt;type = type;</span><br><span class="line">	preg-&gt;card = card ? card-&gt;number : <span class="number">-1</span>;</span><br><span class="line">	preg-&gt;device = dev;</span><br><span class="line">	preg-&gt;f_ops = f_ops;</span><br><span class="line">	preg-&gt;private_data = private_data;</span><br><span class="line">	preg-&gt;card_ptr = card;</span><br><span class="line">	mutex_lock(&amp;sound_mutex);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SND_DYNAMIC_MINORS</span></span><br><span class="line">	minor = snd_find_free_minor(type);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	minor = snd_kernel_minor(type, card, dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	......</span><br><span class="line">	snd_minors[minor] = preg;</span><br><span class="line">	preg-&gt;dev = device_create(sound_class, device, MKDEV(major, minor),</span><br><span class="line">				  private_data, <span class="string">"%s"</span>, name);</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;sound_mutex);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†é…å¹¶åˆå§‹åŒ–ä¸€ä¸ª snd_minor å®ä¾‹ï¼›<br>ä¿å­˜è¯¥ snd_minor å®ä¾‹åˆ° snd_minors æ•°ç»„ä¸­ï¼›<br>è°ƒç”¨ device_create() ç”Ÿæˆè®¾å¤‡æ–‡ä»¶èŠ‚ç‚¹ã€‚</p><p>ä¸Šé¢è¿‡ç¨‹æ˜¯å£°å¡æ³¨å†Œæ—¶æ‰è¢«å›è°ƒçš„ã€‚</p><h5 id="6-4-å£°å¡çš„æ³¨å†Œ"><a href="#6-4-å£°å¡çš„æ³¨å†Œ" class="headerlink" title="6.4. å£°å¡çš„æ³¨å†Œ"></a>6.4. å£°å¡çš„æ³¨å†Œ</h5><p>å½“å£°å¡ä¸‹çš„æ‰€æœ‰é€»è¾‘è®¾å¤‡éƒ½å·²ç»å‡†å¤‡å°±ç»ªåï¼Œå°±å¯ä»¥è°ƒç”¨ snd_card_register() æ³¨å†Œå£°å¡äº†ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/26-Audio-system-snd-card-register.png.png" alt="Alt text"></p><p>â€¢ åˆ›å»ºå£°å¡çš„ sysfs è®¾å¤‡ï¼›<br>â€¢ è°ƒç”¨ snd_device_register_all() æ³¨å†Œæ‰€æœ‰æŒ‚åœ¨è¯¥å£°å¡ä¸‹çš„é€»è¾‘è®¾å¤‡ï¼›<br>â€¢ å»ºç«‹ proc ä¿¡æ¯æ–‡ä»¶å’Œ sysfs å±æ€§æ–‡ä»¶ã€‚</p><h4 id="ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ"><a href="#ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ"></a>ï¼ˆä¸ƒï¼‰ã€DAPMåˆ†æ</h4><h5 id="7-1ã€DAPMç®€ä»‹"><a href="#7-1ã€DAPMç®€ä»‹" class="headerlink" title="7.1ã€DAPMç®€ä»‹"></a>7.1ã€DAPMç®€ä»‹</h5><p>DAPMæ˜¯Dynamic Audio Power Managementçš„ç¼©å†™ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯åŠ¨æ€éŸ³é¢‘ç”µæºç®¡ç†çš„æ„æ€ï¼ŒDAPMæ˜¯ä¸ºäº†ä½¿åŸºäºlinuxçš„ç§»åŠ¨è®¾å¤‡ä¸Šçš„éŸ³é¢‘å­ç³»ç»Ÿï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å·¥ä½œåœ¨æœ€å°åŠŸè€—çŠ¶æ€ä¸‹ã€‚DAPMå¯¹ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯é€æ˜çš„ï¼Œæ‰€æœ‰ä¸ç”µæºç›¸å…³çš„å¼€å…³éƒ½åœ¨ASoc coreä¸­å®Œæˆã€‚ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºæ— éœ€å¯¹ä»£ç åšå‡ºä¿®æ”¹ï¼Œä¹Ÿæ— éœ€é‡æ–°ç¼–è¯‘ï¼ŒDAPMæ ¹æ®å½“å‰æ¿€æ´»çš„éŸ³é¢‘æµï¼ˆplayback/captureï¼‰å’Œå£°å¡ä¸­çš„mixerç­‰çš„é…ç½®æ¥å†³å®šé‚£äº›éŸ³é¢‘æ§ä»¶çš„ç”µæºå¼€å…³è¢«æ‰“å¼€æˆ–å…³é—­ã€‚</p><p>DAPMæ˜¯åŸºäºkcontrolæ”¹è¿›è¿‡åçš„ç›¸åº”æ¡†æ¶ï¼Œå¢åŠ äº†ç›¸åº”çš„ç”µæºç®¡ç†æœºåˆ¶ï¼Œå…¶ç”µæºç®¡ç†æœºåˆ¶å…¶å®å°±æ˜¯æŒ‰ç…§ç›¸åº”çš„éŸ³é¢‘è·¯å¾„ï¼Œå®Œç¾çš„å¯¹å„ç§éƒ¨ä»¶çš„ç”µæºè¿›è¡Œæ§åˆ¶ï¼Œè€Œä¸”æŒ‰ç…§æŸç§é¡ºåºè¿›è¡Œã€‚</p><h5 id="7-1ã€kcontrol"><a href="#7-1ã€kcontrol" class="headerlink" title="7.1ã€kcontrol"></a>7.1ã€kcontrol</h5><p>é€šå¸¸ï¼Œä¸€ä¸ªkcontrolä»£è¡¨ç€ä¸€ä¸ªmixerï¼ˆæ··éŸ³å™¨ï¼‰ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªmuxï¼ˆå¤šè·¯å¼€å…³ï¼‰ï¼Œåˆæˆ–è€…æ˜¯ä¸€ä¸ªéŸ³é‡æ§åˆ¶å™¨ç­‰ç­‰ã€‚ ä»ä¸Šè¿°æ–‡ç« ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œå®šä¹‰ä¸€ä¸ªkcontrolä¸»è¦å°±æ˜¯å®šä¹‰ä¸€ä¸ªsnd_kcontrol_new ç»“æ„ï¼Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/control.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> &#123;</span></span><br><span class="line">	<span class="keyword">snd_ctl_elem_iface_t</span> iface;	<span class="comment">/* interface identifier */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> device;		<span class="comment">/* device/client number */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> subdevice;		<span class="comment">/* subdevice (substream) number */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *name;	<span class="comment">/* ASCII name of item */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> index;		<span class="comment">/* index of item */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> access;		<span class="comment">/* access rights */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count;		<span class="comment">/* count of same elements */</span></span><br><span class="line">	<span class="keyword">snd_kcontrol_info_t</span> *info;</span><br><span class="line">	<span class="keyword">snd_kcontrol_get_t</span> *get;</span><br><span class="line">	<span class="keyword">snd_kcontrol_put_t</span> *put;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="keyword">snd_kcontrol_tlv_rw_t</span> *c;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *p;</span><br><span class="line">	&#125; tlv;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> private_value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ¯ä¸ªæ§ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå’Œä»–å¯¹åº”çš„snd_kcontrol_newç»“æ„ï¼Œè¿™äº›snd_kcontrol_newç»“æ„ä¼šåœ¨å£°å¡çš„åˆå§‹åŒ–é˜¶æ®µï¼Œé€šè¿‡snd_soc_dapm_new_controls()å‡½æ•°æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´å°±å¯ä»¥é€šè¿‡tinymixæŸ¥çœ‹å’Œè®¾å®šè¿™äº›æ§ä»¶çš„çŠ¶æ€ã€‚<br>ç¼–è¯‘/external/tinyalsa/å¾—åˆ°tinymix, tinyplay, tinycapï¼ŒPushåˆ°æ‰‹æœºæ‰§è¡Œtinymixå¯å¾—åˆ°å¦‚ä¸‹ç±»ä¼¼ä¿¡æ¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">990	BOOL	1	QUAT_MI2S_RX Audio Mixer MultiMedia10    Off</span><br><span class="line">991	BOOL	1	QUAT_MI2S_RX Audio Mixer MultiMedia11    Off</span><br><span class="line">992	BOOL	1	QUAT_MI2S_RX Audio Mixer MultiMedia12    Off</span><br><span class="line">993	BOOL	1	QUAT_MI2S_RX Audio Mixer MultiMedia13    Off</span><br><span class="line">994	BOOL	1	QUAT_MI2S_RX Audio Mixer MultiMedia14    Off</span><br><span class="line">995	BOOL	1	QUAT_MI2S_RX Audio Mixer MultiMedia15    Off</span><br><span class="line">996	BOOL	1	QUAT_MI2S_RX Audio Mixer MultiMedia16    Off</span><br><span class="line">997	BOOL	1	MI2S_RX Audio Mixer MultiMedia1          Off</span><br><span class="line">998	BOOL	1	MI2S_RX Audio Mixer MultiMedia2          Off</span><br><span class="line">999	BOOL	1	MI2S_RX Audio Mixer MultiMedia3          Off</span><br><span class="line">1000	BOOL	1	MI2S_RX Audio Mixer MultiMedia4          Off</span><br><span class="line">1001	BOOL	1	MI2S_RX Audio Mixer MultiMedia5          Off</span><br><span class="line">1002	BOOL	1	MI2S_RX Audio Mixer MultiMedia6          Off</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>snd_kcontrol_newç»“æ„ä¸­ï¼Œå‡ ä¸ªä¸»è¦çš„å­—æ®µæ˜¯getï¼Œputï¼Œprivate_valueï¼Œgetå›è°ƒå‡½æ•°ç”¨äºè·å–è¯¥æ§ä»¶å½“å‰çš„çŠ¶æ€å€¼ï¼Œè€Œputå›è°ƒå‡½æ•°åˆ™ç”¨äºè®¾ç½®æ§ä»¶çš„çŠ¶æ€å€¼ï¼Œè€Œprivate_valueå­—æ®µåˆ™æ ¹æ®ä¸åŒçš„æ§ä»¶ç±»å‹æœ‰ä¸åŒçš„æ„ä¹‰ï¼Œæ¯”å¦‚å¯¹äºæ™®é€šçš„æ§ä»¶ï¼Œprivate_valueå­—æ®µå¯ä»¥ç”¨æ¥å®šä¹‰è¯¥æ§ä»¶æ‰€å¯¹åº”çš„å¯„å­˜å™¨çš„åœ°å€ä»¥åŠå¯¹åº”çš„æ§åˆ¶ä½åœ¨å¯„å­˜å™¨ä¸­çš„ä½ç½®ä¿¡æ¯ã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼ŒASocç³»ç»Ÿå·²ç»ä¸ºæˆ‘ä»¬å‡†å¤‡äº†å¤§é‡çš„å®å®šä¹‰ï¼Œç”¨äºå®šä¹‰å¸¸ç”¨çš„æ§ä»¶ï¼Œè¿™äº›å®å®šä¹‰ä½äºinclude/sound/soc.hä¸­ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«è®¨è®ºä¸€ä¸‹å¦‚ä½•ç”¨è¿™äº›é¢„è®¾çš„å®å®šä¹‰æ¥å®šä¹‰ä¸€äº›å¸¸ç”¨çš„æ§ä»¶ã€‚</p><h5 id="7-1-1ã€ç®€å•å‹çš„æ§ä»¶"><a href="#7-1-1ã€ç®€å•å‹çš„æ§ä»¶" class="headerlink" title="7.1.1ã€ç®€å•å‹çš„æ§ä»¶"></a>7.1.1ã€ç®€å•å‹çš„æ§ä»¶</h5><p>SOC_SINGLE SOC_SINGLEåº”è¯¥ç®—æ˜¯æœ€ç®€å•çš„æ§ä»¶äº†ï¼Œè¿™ç§æ§ä»¶åªæœ‰ä¸€ä¸ªæ§åˆ¶é‡ï¼Œæ¯”å¦‚ä¸€ä¸ªå¼€å…³ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ•°å€¼å˜é‡ï¼ˆæ¯”å¦‚Codecä¸­æŸä¸ªé¢‘ç‡ï¼ŒFIFOå¤§å°ç­‰ç­‰ï¼‰ã€‚æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå®æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE(xname, reg, shift, max, invert) \</span></span><br><span class="line">&#123;	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span><br><span class="line">	.info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span><br><span class="line">	.put = snd_soc_put_volsw, \</span><br><span class="line">	.private_value = SOC_SINGLE_VALUE(reg, shift, max, invert, <span class="number">0</span>) &#125;</span><br></pre></td></tr></table></figure><p></p><p>å®å®šä¹‰çš„å‚æ•°åˆ†åˆ«æ˜¯ï¼šxnameï¼ˆè¯¥æ§ä»¶çš„åå­—ï¼‰ï¼Œregï¼ˆè¯¥æ§ä»¶å¯¹åº”çš„å¯„å­˜å™¨çš„åœ°å€ï¼‰ï¼Œshiftï¼ˆæ§åˆ¶ä½åœ¨å¯„å­˜å™¨ä¸­çš„ä½ç§»ï¼‰ï¼Œmaxï¼ˆæ§ä»¶å¯è®¾ç½®çš„æœ€å¤§å€¼ï¼‰ï¼Œinvertï¼ˆè®¾å®šå€¼æ˜¯å¦é€»è¾‘å–åï¼‰ã€‚è¿™é‡Œåˆä½¿ç”¨äº†ä¸€ä¸ªå®æ¥å®šä¹‰private_valueå­—æ®µï¼šSOC_SINGLE_VALUEï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_DOUBLE_VALUE(xreg, shift_left, shift_right, xmax, xinvert, xautodisable) \</span></span><br><span class="line">	((<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;(struct soc_mixer_control) \</span><br><span class="line">	&#123;.reg = xreg, .rreg = xreg, .shift = shift_left, \</span><br><span class="line">	.rshift = shift_right, .max = xmax, .platform_max = xmax, \</span><br><span class="line">	.invert = xinvert, .autodisable = xautodisable&#125;)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE_VALUE(xreg, xshift, xmax, xinvert, xautodisable) \</span></span><br><span class="line">	SOC_DOUBLE_VALUE(xreg, xshift, xshift, xmax, xinvert, xautodisable)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®é™…ä¸Šæ˜¯å®šä¹‰äº†ä¸€ä¸ªsoc_mixer_controlç»“æ„ï¼Œç„¶åæŠŠè¯¥ç»“æ„çš„åœ°å€èµ‹å€¼ç»™äº†private_valueå­—æ®µï¼Œsoc_mixer_controlç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="comment">/* mixer control */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">soc_mixer_control</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> min, max, platform_max;</span><br><span class="line">	<span class="keyword">int</span> reg, rreg;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> shift, rshift;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> sign_bit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> invert:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> autodisable:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹æ¥soc_mixer_controlæ˜¯æ§ä»¶ç‰¹å¾çš„çœŸæ­£æè¿°è€…ï¼Œå®ƒç¡®å®šäº†è¯¥æ§ä»¶å¯¹åº”å¯„å­˜å™¨çš„åœ°å€ï¼Œä½ç§»å€¼ï¼Œæœ€å¤§å€¼å’Œæ˜¯å¦é€»è¾‘å–åç­‰ç‰¹æ€§ï¼Œæ§ä»¶çš„putå›è°ƒå‡½æ•°å’Œgetå›è°ƒå‡½æ•°éœ€è¦å€ŸåŠ©è¯¥ç»“æ„æ¥è®¿é—®å®é™…çš„å¯„å­˜å™¨ã€‚<br><strong>SOC_SINGLE_TLV</strong> <strong>SOC_SINGLE_TLV</strong>æ˜¯SOC_SINGLEçš„ä¸€ç§æ‰©å±•ï¼Œä¸»è¦ç”¨äºå®šä¹‰é‚£äº›æœ‰å¢ç›Šæ§åˆ¶çš„æ§ä»¶ï¼Œä¾‹å¦‚éŸ³é‡æ§åˆ¶å™¨ï¼ŒEQå‡è¡¡å™¨ç­‰ç­‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOC_SINGLE_TLV(xname, reg, shift, max, invert, tlv_array) \</span></span><br><span class="line">&#123;	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span><br><span class="line">	.access = SNDRV_CTL_ELEM_ACCESS_TLV_READ |\</span><br><span class="line">		 SNDRV_CTL_ELEM_ACCESS_READWRITE,\</span><br><span class="line">	.tlv.p = (tlv_array), \</span><br><span class="line">	.info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span><br><span class="line">	.put = snd_soc_put_volsw, \</span><br><span class="line">	.private_value = SOC_SINGLE_VALUE(reg, shift, max, invert, <span class="number">0</span>) &#125;</span><br></pre></td></tr></table></figure><p>ä»ä»–çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œç”¨äºè®¾å®šå¯„å­˜å™¨ä¿¡æ¯çš„private_valueå­—æ®µçš„å®šä¹‰å’ŒSOC_SINGLEæ˜¯ä¸€æ ·çš„ï¼Œç”šè‡³putã€getå›è°ƒå‡½æ•°ä¹Ÿæ˜¯ä½¿ç”¨åŒä¸€å¥—ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¢åŠ äº†ä¸€ä¸ªtlv_arrayå‚æ•°ï¼Œå¹¶æŠŠå®ƒèµ‹å€¼ç»™äº†tlv.på­—æ®µã€‚ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡å¯¹å£°å¡çš„controlè®¾å¤‡å‘èµ·ä»¥ä¸‹ä¸¤ç§ioctlæ¥è®¿é—®tlvå­—æ®µæ‰€æŒ‡å‘çš„æ•°ç»„ï¼š<br>â€¢ SNDRV_CTL_IOCTL_TLV_READ<br>â€¢ SNDRV_CTL_IOCTL_TLV_WRITE<br>â€¢ SNDRV_CTL_IOCTL_TLV_COMMAND</p><p>SOC_DOUBLE ä¸SOC_SINGLEç›¸å¯¹åº”ï¼ŒåŒºåˆ«æ˜¯SOC_SINGLEåªæ§åˆ¶ä¸€ä¸ªå˜é‡ï¼Œè€ŒSOC_DOUBLEåˆ™å¯ä»¥åŒæ—¶åœ¨ä¸€ä¸ªå¯„å­˜å™¨ä¸­æ§åˆ¶ä¸¤ä¸ªç›¸ä¼¼çš„å˜é‡ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯ç”¨äºä¸€äº›ç«‹ä½“å£°çš„æ§ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åŒæ—¶å¯¹å·¦å³å£°é“è¿›è¡Œæ§åˆ¶ï¼Œå› ä¸ºå¤šäº†ä¸€ä¸ªå£°é“ï¼Œå‚æ•°ä¹Ÿå°±ç›¸åº”åœ°å¤šäº†ä¸€ä¸ªshiftä½ç§»å€¼</p><p>SOC_DOUBLE_R ä¸SOC_DOUBLEç±»ä¼¼ï¼Œå¯¹äºå·¦å³å£°é“çš„æ§åˆ¶å¯„å­˜å™¨ä¸ä¸€æ ·çš„æƒ…å†µï¼Œä½¿ç”¨SOC_DOUBLE_Ræ¥å®šä¹‰ï¼Œå‚æ•°ä¸­éœ€è¦æŒ‡å®šä¸¤ä¸ªå¯„å­˜å™¨åœ°å€ã€‚<br>SOC_DOUBLE_TLV ä¸SOC_SINGLE_TLVå¯¹åº”çš„ç«‹ä½“å£°ç‰ˆæœ¬ï¼Œé€šå¸¸ç”¨äºç«‹ä½“å£°éŸ³é‡æ§ä»¶çš„å®šä¹‰ã€‚</p><p>SOC_DOUBLE_R_TLV å·¦å³å£°é“æœ‰ç‹¬ç«‹å¯„å­˜å™¨æ§åˆ¶çš„SOC_DOUBLE_TLVç‰ˆæœ¬</p><h5 id="7-1-2ã€Mixeræ§ä»¶"><a href="#7-1-2ã€Mixeræ§ä»¶" class="headerlink" title="7.1.2ã€Mixeræ§ä»¶"></a>7.1.2ã€Mixeræ§ä»¶</h5><p>Mixeræ§ä»¶ç”¨äºéŸ³é¢‘é€šé“çš„è·¯ç”±æ§åˆ¶ï¼Œç”±å¤šä¸ªè¾“å…¥å’Œä¸€ä¸ªè¾“å‡ºç»„æˆï¼Œå¤šä¸ªè¾“å…¥å¯ä»¥è‡ªç”±åœ°æ··åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆæ··åˆåçš„è¾“å‡ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/27-Audio-system-mixer-1525417497024.png" alt="Alt text"></p><p>å¯¹äºMixeræ§ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯å¤šä¸ªç®€å•æ§ä»¶çš„ç»„åˆï¼Œé€šå¸¸ï¼Œæˆ‘ä»¬ä¼šä¸ºmixerçš„æ¯ä¸ªè¾“å…¥ç«¯éƒ½å•ç‹¬å®šä¹‰ä¸€ä¸ªç®€å•æ§ä»¶æ¥æ§åˆ¶è¯¥è·¯è¾“å…¥çš„å¼€å¯å’Œå…³é—­ï¼Œååº”åœ¨ä»£ç ä¸Šï¼Œå°±æ˜¯å®šä¹‰ä¸€ä¸ªsoc_kcontrol_newæ•°ç»„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/codecs/wcd9335.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">aif4_vi_mixer</span>[] = &#123;</span></span><br><span class="line">	SOC_SINGLE_EXT(<span class="string">"SPKR_VI_1"</span>, SND_SOC_NOPM, TASHA_TX14, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">			tasha_vi_feed_mixer_get, tasha_vi_feed_mixer_put),</span><br><span class="line">	SOC_SINGLE_EXT(<span class="string">"SPKR_VI_2"</span>, SND_SOC_NOPM, TASHA_TX15, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">			tasha_vi_feed_mixer_get, tasha_vi_feed_mixer_put),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="7-1-3ã€Muxæ§ä»¶"><a href="#7-1-3ã€Muxæ§ä»¶" class="headerlink" title="7.1.3ã€Muxæ§ä»¶"></a>7.1.3ã€Muxæ§ä»¶</h5><p>muxæ§ä»¶ä¸mixeræ§ä»¶ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å¤šä¸ªè¾“å…¥ç«¯å’Œä¸€ä¸ªè¾“å‡ºç«¯çš„ç»„åˆæ§ä»¶ï¼Œä¸mixeræ§ä»¶ä¸åŒçš„æ˜¯ï¼Œmuxæ§ä»¶çš„å¤šä¸ªè¾“å…¥ç«¯åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªè¢«é€‰ä¸­ã€‚å› æ­¤ï¼Œmuxæ§ä»¶æ‰€å¯¹åº”çš„å¯„å­˜å™¨ï¼Œé€šå¸¸å¯ä»¥è®¾å®šä¸€æ®µè¿ç»­çš„æ•°å€¼ï¼Œæ¯ä¸ªä¸åŒçš„æ•°å€¼å¯¹åº”ä¸åŒçš„è¾“å…¥ç«¯è¢«æ‰“å¼€ï¼Œä¸ä¸Šè¿°çš„mixeræ§ä»¶ä¸åŒï¼ŒASocç”¨soc_enumç»“æ„æ¥æè¿°muxæ§ä»¶çš„å¯„å­˜å™¨ä¿¡æ¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc.h]</span><br><span class="line"><span class="comment">/* enumerated kcontrol */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">soc_enum</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> reg;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> shift_l;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> shift_r;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> items;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mask;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> *texts;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *values;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªå¯„å­˜å™¨åœ°å€å’Œä½ç§»å­—æ®µï¼šregï¼Œreg2ï¼Œshift_lï¼Œshift_rï¼Œç”¨äºæè¿°å·¦å³å£°é“çš„æ§åˆ¶å¯„å­˜å™¨ä¿¡æ¯ã€‚å­—ç¬¦ä¸²æ•°ç»„æŒ‡é’ˆç”¨äºæè¿°æ¯ä¸ªè¾“å…¥ç«¯å¯¹åº”çš„åå­—ï¼Œvalueå­—æ®µåˆ™æŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥æ•°ç»„å®šä¹‰äº†å¯„å­˜å™¨å¯ä»¥é€‰æ‹©çš„å€¼ï¼Œæ¯ä¸ªå€¼å¯¹åº”ä¸€ä¸ªè¾“å…¥ç«¯ï¼Œå¦‚æœvalueæ˜¯ä¸€ç»„è¿ç»­çš„å€¼ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥å¿½ç•¥valueså‚æ•°ã€‚</p><h5 id="7-2ã€widgetã€pathã€route"><a href="#7-2ã€widgetã€pathã€route" class="headerlink" title="7.2ã€widgetã€pathã€route"></a>7.2ã€widgetã€pathã€route</h5><p>å‰é¢ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†éŸ³é¢‘é©±åŠ¨ä¸­å¯¹åŸºæœ¬æ§åˆ¶å•å…ƒçš„å°è£…ï¼škcontrolã€‚åˆ©ç”¨kcontrolï¼Œæˆ‘ä»¬å¯ä»¥å®Œæˆå¯¹éŸ³é¢‘ç³»ç»Ÿä¸­çš„mixerï¼Œmuxï¼ŒéŸ³é‡æ§åˆ¶ï¼ŒéŸ³æ•ˆæ§åˆ¶ï¼Œä»¥åŠå„ç§å¼€å…³é‡çš„æ§åˆ¶ï¼Œé€šè¿‡å¯¹å„ç§kcontrolçš„æ§åˆ¶ï¼Œä½¿å¾—éŸ³é¢‘ç¡¬ä»¶èƒ½å¤ŸæŒ‰ç…§æˆ‘ä»¬é¢„æƒ³çš„ç»“æœè¿›è¡Œå·¥ä½œã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œkcontrolè¿˜æ˜¯æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸è¶³ï¼š<br>åªèƒ½æè¿°è‡ªèº«ï¼Œæ— æ³•æè¿°å„ä¸ªkcontrolä¹‹é—´çš„è¿æ¥å…³ç³»ï¼›<br>æ²¡æœ‰ç›¸åº”çš„ç”µæºç®¡ç†æœºåˆ¶ï¼›<br>æ²¡æœ‰ç›¸åº”çš„æ—¶é—´å¤„ç†æœºåˆ¶æ¥å“åº”æ’­æ”¾ã€åœæ­¢ã€ä¸Šç”µã€ä¸‹ç”µç­‰éŸ³é¢‘äº‹ä»¶ï¼›<br>ä¸ºäº†é˜²æ­¢pop-popå£°ï¼Œéœ€è¦ç”¨æˆ·ç¨‹åºå…³æ³¨å„ä¸ªkcontrolä¸Šç”µå’Œä¸‹ç”µçš„é¡ºåºï¼›<br>å½“ä¸€ä¸ªéŸ³é¢‘è·¯å¾„ä¸å†æœ‰æ•ˆæ—¶ï¼Œä¸èƒ½è‡ªåŠ¨å…³é—­è¯¥è·¯å¾„ä¸Šçš„æ‰€æœ‰çš„kcontrolï¼›<br>ä¸ºæ­¤ï¼ŒDAPMæ¡†æ¶æ­£æ˜¯ä¸ºäº†è¦è§£å†³ä»¥ä¸Šè¿™äº›é—®é¢˜è€Œè¯ç”Ÿçš„ï¼ŒDAPMç›®å‰å·²ç»æ˜¯ASocä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè®©æˆ‘ä»¬å…ˆä»DAPMçš„æ•°æ®ç»“æ„å¼€å§‹ï¼Œäº†è§£å®ƒçš„è®¾è®¡æ€æƒ³å’Œå·¥ä½œåŸç†ã€‚</p><h5 id="7-2-1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget"><a href="#7-2-1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget" class="headerlink" title="7.2.1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget"></a>7.2.1ã€DAPMçš„åŸºæœ¬å•å…ƒï¼šwidget</h5><p>æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬è¯´æ˜äº†ä¸€ä¸‹ç›®å‰kcontrolçš„ä¸€äº›ä¸è¶³ï¼Œè€ŒDAPMæ¡†æ¶ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼•å…¥äº†widgetè¿™ä¸€æ¦‚å¿µï¼Œæ‰€è°“widgetï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºæ˜¯kcontrolçš„è¿›ä¸€æ­¥å‡çº§å’Œå°è£…ï¼Œå¥¹åŒæ ·æ˜¯æŒ‡éŸ³é¢‘ç³»ç»Ÿä¸­çš„æŸä¸ªéƒ¨ä»¶ï¼Œæ¯”å¦‚mixerï¼Œmuxï¼Œè¾“å…¥è¾“å‡ºå¼•è„šï¼Œç”µæºä¾›åº”å™¨ç­‰ç­‰ï¼Œç”šè‡³ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰è™šæ‹Ÿçš„widgetï¼Œä¾‹å¦‚playback stream widgetã€‚widgetæŠŠkcontrolå’ŒåŠ¨æ€ç”µæºç®¡ç†è¿›è¡Œäº†æœ‰æœºçš„ç»“åˆï¼ŒåŒæ—¶è¿˜å…·å¤‡éŸ³é¢‘è·¯å¾„çš„è¿ç»“åŠŸèƒ½ï¼Œä¸€ä¸ªwidgetå¯ä»¥ä¸å®ƒç›¸é‚»çš„widgetæœ‰æŸç§åŠ¨æ€çš„è¿ç»“å…³ç³»ã€‚åœ¨DAPMæ¡†æ¶ä¸­ï¼Œwidgetç”¨ç»“æ„ä½“snd_soc_dapm_widgetæ¥æè¿°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc-dapm.h]</span><br><span class="line"><span class="comment">/* dapm widget */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> &#123;</span></span><br><span class="line">	<span class="keyword">enum</span> snd_soc_dapm_type id;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;		<span class="comment">/* widget name */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *sname;	<span class="comment">/* stream name */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec</span> *<span class="title">codec</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> *priv;				<span class="comment">/* widget specific data */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">regulator</span> *<span class="title">regulator</span>;</span>		<span class="comment">/* attached regulator */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> *<span class="title">params</span>;</span> <span class="comment">/* params for dai links */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* dapm control */</span></span><br><span class="line">	<span class="keyword">int</span> reg;				<span class="comment">/* negative reg = no direct dapm */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> shift;			<span class="comment">/* bits to shift */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mask;			<span class="comment">/* non-shifted mask */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> on_val;			<span class="comment">/* on state value */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> off_val;			<span class="comment">/* off state value */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> power:<span class="number">1</span>;			<span class="comment">/* block power status */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active:<span class="number">1</span>;			<span class="comment">/* active stream on DAC, ADC's */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> connected:<span class="number">1</span>;		<span class="comment">/* connected codec pin */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">new</span>:<span class="number">1</span>;			<span class="comment">/* cnew complete */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> ext:<span class="number">1</span>;			<span class="comment">/* has external widgets */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> force:<span class="number">1</span>;			<span class="comment">/* force state */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> ignore_suspend:<span class="number">1</span>;         <span class="comment">/* kept enabled over suspend */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> new_power:<span class="number">1</span>;		<span class="comment">/* power from this run */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> power_checked:<span class="number">1</span>;		<span class="comment">/* power checked this run */</span></span><br><span class="line">	<span class="keyword">int</span> subseq;				<span class="comment">/* sort within widget type */</span></span><br><span class="line">	......</span><br><span class="line">	<span class="comment">/* widget input and outputs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">sources</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">sinks</span>;</span></span><br><span class="line">	......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>snd_soc_dapm_widgetç»“æ„æ¯”è¾ƒå¤§ï¼Œä¸ºäº†ç®€æ´ä¸€äº›ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰åˆ—å‡ºè¯¥ç»“æ„ä½“çš„å®Œæ•´å­—æ®µï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¸‹é¢æˆ‘ä¼šè¯´æ˜æ¯ä¸ªå­—æ®µçš„æ„ä¹‰ï¼š<br>id è¯¥widgetçš„ç±»å‹å€¼ï¼Œæ¯”å¦‚snd_soc_dapm_outputï¼Œsnd_soc_dapm_mixerç­‰ç­‰ã€‚</p><p>*name è¯¥widgetçš„åå­—</p><p>*sname ä»£è¡¨è¯¥widgetæ‰€åœ¨streamçš„åå­—ï¼Œæ¯”å¦‚å¯¹äºsnd_soc_dapm_dai_inç±»å‹çš„widgetï¼Œä¼šä½¿ç”¨è¯¥å­—æ®µã€‚</p><p><em>codec </em>platform æŒ‡å‘è¯¥widgetæ‰€å±çš„codecå’Œplatformã€‚</p><p>list æ‰€æœ‰æ³¨å†Œåˆ°ç³»ç»Ÿä¸­çš„widgetéƒ½ä¼šé€šè¿‡è¯¥listï¼Œé“¾æ¥åˆ°ä»£è¡¨å£°å¡çš„snd_soc_cardç»“æ„çš„widgetsé“¾è¡¨å¤´å­—æ®µä¸­ã€‚</p><p>*dapm snd_soc_dapm_contextç»“æ„æŒ‡é’ˆï¼ŒASocæŠŠç³»ç»Ÿåˆ’åˆ†ä¸ºå¤šä¸ªdapmåŸŸï¼Œæ¯ä¸ªwidgetå±äºæŸä¸ªdapmåŸŸï¼ŒåŒä¸€ä¸ªåŸŸä»£è¡¨ç€åŒæ ·çš„åç½®ç”µå‹ä¾›ç”µç­–ç•¥ï¼Œæ¯”å¦‚ï¼ŒåŒä¸€ä¸ªcodecä¸­çš„widgeté€šå¸¸ä½äºåŒä¸€ä¸ªdapmåŸŸï¼Œè€Œå¹³å°ä¸Šçš„widgetå¯èƒ½åˆä¼šä½äºå¦å¤–ä¸€ä¸ªplatformåŸŸä¸­ã€‚</p><p>*priv æœ‰äº›widgetå¯èƒ½éœ€è¦ä¸€äº›ä¸“æœ‰çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å­—æ®µæ¥ä¿å­˜ï¼Œåƒsnd_soc_dapm_dai_inç±»å‹çš„widgetï¼Œä¼šä½¿ç”¨è¯¥å­—æ®µæ¥è®°ä½ä¸ä¹‹ç›¸å…³è”çš„snd_soc_daiç»“æ„æŒ‡é’ˆã€‚</p><p>*regulator å¯¹äºsnd_soc_dapm_regulator_supplyç±»å‹çš„widgetï¼Œè¯¥å­—æ®µæŒ‡å‘ä¸ä¹‹ç›¸å…³çš„regulatorç»“æ„æŒ‡é’ˆã€‚</p><p>*params ç›®å‰å¯¹äºsnd_soc_dapm_dai_linkç±»å‹çš„widgetï¼ŒæŒ‡å‘è¯¥daiçš„é…ç½®ä¿¡æ¯çš„snd_soc_pcm_streamç»“æ„ã€‚</p><p>reg shift mask è¿™3ä¸ªå­—æ®µç”¨æ¥æ§åˆ¶è¯¥widgetçš„ç”µæºçŠ¶æ€ï¼Œåˆ†åˆ«å¯¹åº”æ§åˆ¶ä¿¡æ¯æ‰€åœ¨çš„å¯„å­˜å™¨åœ°å€ï¼Œä½ç§»å€¼å’Œå±è”½å€¼ã€‚</p><p>value on_val off_val ç”µæºçŠ¶æ€çš„å½“å‰åªï¼Œå¼€å¯æ—¶å’Œå…³é—­æ—¶æ‰€å¯¹åº”çš„å€¼ã€‚</p><p>power invert ç”¨äºæŒ‡ç¤ºè¯¥widgetå½“å‰æ˜¯å¦å¤„äºä¸Šç”µçŠ¶æ€ï¼Œinvertåˆ™ç”¨äºè¡¨æ˜powerå­—æ®µæ˜¯å¦éœ€è¦é€»è¾‘åè½¬ã€‚</p><p>active connected åˆ†åˆ«è¡¨ç¤ºè¯¥widgetæ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€å’Œè¿æ¥çŠ¶æ€ï¼Œå½“å’Œç›¸é‚»çš„widgetæœ‰è¿æ¥å…³ç³»æ—¶ï¼Œconnectedä½ä¼šè¢«ç½®1ï¼Œå¦åˆ™ç½®0ã€‚</p><p>new æˆ‘ä»¬å®šä¹‰å¥½çš„widgetï¼ˆsnd_soc_dapm_widgetç»“æ„ï¼‰ï¼Œåœ¨æ³¨å†Œåˆ°å£°å¡ä¸­æ—¶éœ€è¦è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¯¥å­—æ®µç”¨æ¥è¡¨ç¤ºè¯¥widgetæ˜¯å¦å·²ç»è¢«å®ä¾‹åŒ–ã€‚</p><p>ext è¡¨ç¤ºè¯¥widgetå½“å‰æ˜¯å¦æœ‰å¤–éƒ¨è¿æ¥ï¼Œæ¯”å¦‚è¿æ¥micï¼Œè€³æœºï¼Œå–‡å­ç­‰ç­‰ã€‚</p><p>force è¯¥ä½è¢«è®¾ç½®åï¼Œå°†ä¼šä¸ç®¡widgetå½“å‰çš„çŠ¶æ€ï¼Œå¼ºåˆ¶æ›´æ–°è‡³æ–°çš„ç”µæºçŠ¶æ€ã€‚</p><p>ignore_suspend new_power power_checked è¿™äº›ç”µæºç®¡ç†ç›¸å…³çš„å­—æ®µã€‚</p><p>subseq è¯¥widgetç›®å‰åœ¨ä¸Šç”µæˆ–ä¸‹ç”µé˜Ÿåˆ—ä¸­çš„æ’åºç¼–å·ï¼Œä¸ºäº†é˜²æ­¢åœ¨ä¸Šä¸‹ç”µçš„è¿‡ç¨‹ä¸­å‡ºç°pop-popå£°ï¼ŒDAPMä¼šç»™æ¯ä¸ªwidgetåˆ†é…åˆç†çš„ä¸Šä¸‹ç”µé¡ºåºã€‚</p><p>*power_check ç”¨äºæ£€æŸ¥è¯¥widgetæ˜¯å¦åº”è¯¥ä¸Šç”µæˆ–ä¸‹ç”µçš„å›è°ƒå‡½æ•°æŒ‡é’ˆã€‚<br>event_flags è¯¥å­—æ®µæ˜¯ä¸€ä¸ªä½æˆ–å­—æ®µï¼Œæ¯ä¸ªä½ä»£è¡¨è¯¥widgetä¼šå…³æ³¨æŸä¸ªDAPMäº‹ä»¶é€šçŸ¥ã€‚åªæœ‰è¢«å…³æ³¨çš„é€šçŸ¥äº‹ä»¶ä¼šè¢«å‘é€åˆ°widgetçš„äº‹ä»¶å¤„ç†å›è°ƒå‡½æ•°ä¸­ã€‚</p><p>*event DAPMäº‹ä»¶å¤„ç†å›è°ƒå‡½æ•°æŒ‡é’ˆã€‚</p><p>num_kcontrols <em>kcontrol_news *</em>kcontrols è¿™3ä¸ªå­—æ®µç”¨æ¥æè¿°ä¸è¯¥widgetæ‰€åŒ…å«çš„kcontrolæ§ä»¶ï¼Œä¾‹å¦‚ä¸€ä¸ªmixeræ§ä»¶æˆ–è€…æ˜¯ä¸€ä¸ªmuxæ§ä»¶ã€‚</p><p>sources sinks ä¸¤ä¸ªé“¾è¡¨å­—æ®µï¼Œä¸¤ä¸ªwidgetå¦‚æœæœ‰è¿æ¥å…³ç³»ï¼Œä¼šé€šè¿‡ä¸€ä¸ªsnd_soc_dapm_pathç»“æ„è¿›è¡Œè¿æ¥ï¼Œsourcesé“¾è¡¨ç”¨äºé“¾æ¥æ‰€æœ‰çš„è¾“å…¥pathï¼Œsinksé“¾è¡¨ç”¨äºé“¾æ¥æ‰€æœ‰çš„è¾“å‡ºpathã€‚</p><p>power_list æ¯æ¬¡æ›´æ–°æ•´ä¸ªdapmçš„ç”µæºçŠ¶æ€æ—¶ï¼Œä¼šæ ¹æ®ä¸€å®šçš„ç®—æ³•æ‰«ææ‰€æœ‰çš„widgetï¼Œç„¶åæŠŠéœ€è¦å˜æ›´ç”µæºçŠ¶æ€çš„widgetåˆ©ç”¨è¯¥å­—æ®µé“¾æ¥åˆ°ä¸€ä¸ªä¸Šç”µæˆ–ä¸‹ç”µçš„é“¾è¡¨ä¸­ï¼Œæ‰«æå®Œæ¯•åï¼Œdapmç³»ç»Ÿä¼šéå†è¿™ä¸¤ä¸ªé“¾è¡¨æ‰§è¡Œç›¸åº”çš„ä¸Šç”µæˆ–ä¸‹ç”µæ“ä½œã€‚</p><p>dirty é“¾è¡¨å­—æ®µï¼Œwidgetçš„çŠ¶æ€å˜æ›´åï¼Œdapmç³»ç»Ÿä¼šåˆ©ç”¨è¯¥å­—æ®µï¼ŒæŠŠè¯¥widgetåŠ å…¥åˆ°ä¸€ä¸ªdirtyé“¾è¡¨ä¸­ï¼Œç¨åä¼šå¯¹dirtyé“¾è¡¨è¿›è¡Œæ‰«æï¼Œä»¥æ‰§è¡Œæ•´ä¸ªè·¯å¾„çš„æ›´æ–°ã€‚</p><p>inputs è¯¥widgetçš„æ‰€æœ‰æœ‰æ•ˆè·¯å¾„ä¸­ï¼Œè¿æ¥åˆ°è¾“å…¥ç«¯çš„è·¯å¾„æ•°é‡ã€‚</p><p>outputs è¯¥widgetçš„æ‰€æœ‰æœ‰æ•ˆè·¯å¾„ä¸­ï¼Œè¿æ¥åˆ°è¾“å‡ºç«¯çš„è·¯å¾„æ•°é‡ã€‚</p><p>*clk å¯¹äºsnd_soc_dapm_clock_supplyç±»å‹çš„widgetï¼ŒæŒ‡å‘ç›¸å…³è”çš„clkç»“æ„æŒ‡é’ˆã€‚</p><p>ä»¥ä¸Šæˆ‘ä»¬å¯¹snd_soc_dapm_widgetç»“æ„çš„å„ä¸ªå­—æ®µæ‰€ä»£è¡¨çš„æ„ä¹‰ä¸€ä¸€åšå‡ºäº†è¯´æ˜ï¼Œè¿™é‡Œåªæ˜¯è®©å¤§å®¶ç°æœ‰ä¸ªæ¦‚å¿µ</p><h5 id="7-2-2ã€widgetçš„ç§ç±»"><a href="#7-2-2ã€widgetçš„ç§ç±»" class="headerlink" title="7.2.2ã€widgetçš„ç§ç±»"></a>7.2.2ã€widgetçš„ç§ç±»</h5><p>åœ¨DAPMæ¡†æ¶ä¸­ï¼ŒæŠŠå„ç§ä¸åŒçš„widgetåˆ’åˆ†ä¸ºä¸åŒçš„ç§ç±»ï¼Œsnd_soc_dapm_widgetç»“æ„ä¸­çš„idå­—æ®µç”¨æ¥è¡¨ç¤ºè¯¥widgetçš„ç§ç±»ï¼Œå¯é€‰çš„ç§ç±»éƒ½å®šä¹‰åœ¨ä¸€ä¸ªæšä¸¾ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc-dapm.h]</span><br><span class="line"><span class="comment">/* dapm widget types */</span></span><br><span class="line"><span class="keyword">enum</span> snd_soc_dapm_type &#123;</span><br><span class="line">	snd_soc_dapm_input = <span class="number">0</span>,		<span class="comment">/* input pin */</span></span><br><span class="line">	snd_soc_dapm_output,		<span class="comment">/* output pin */</span></span><br><span class="line">	......</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬é€ä¸ªè§£é‡Šä¸€ä¸‹è¿™äº›widgetçš„ç§ç±»ï¼š<br>snd_soc_dapm_input è¯¥widgetå¯¹åº”ä¸€ä¸ªè¾“å…¥å¼•è„šã€‚<br>snd_soc_dapm_output è¯¥widgetå¯¹åº”ä¸€ä¸ªè¾“å‡ºå¼•è„šã€‚<br>snd_soc_dapm_mux è¯¥widgetå¯¹åº”ä¸€ä¸ªmuxæ§ä»¶ã€‚<br>snd_soc_dapm_virt_mux è¯¥widgetå¯¹åº”ä¸€ä¸ªè™šæ‹Ÿçš„muxæ§ä»¶ã€‚<br>snd_soc_dapm_value_mux è¯¥widgetå¯¹åº”ä¸€ä¸ªvalueç±»å‹çš„muxæ§ä»¶ã€‚<br>snd_soc_dapm_mixer è¯¥widgetå¯¹åº”ä¸€ä¸ªmixeræ§ä»¶ã€‚<br>snd_soc_dapm_mixer_named_ctl è¯¥widgetå¯¹åº”ä¸€ä¸ªmixeræ§ä»¶ï¼Œä½†æ˜¯å¯¹åº”çš„kcontrolçš„åå­—ä¸ä¼šåŠ å…¥widgetçš„åå­—ä½œä¸ºå‰ç¼€ã€‚<br>snd_soc_dapm_pga è¯¥widgetå¯¹åº”ä¸€ä¸ªpgaæ§ä»¶ï¼ˆå¯ç¼–ç¨‹å¢ç›Šæ§ä»¶ï¼‰ã€‚<br>snd_soc_dapm_out_drv è¯¥widgetå¯¹åº”ä¸€ä¸ªè¾“å‡ºé©±åŠ¨æ§ä»¶<br>snd_soc_dapm_adc è¯¥widgetå¯¹åº”ä¸€ä¸ªADC<br>snd_soc_dapm_dac è¯¥widgetå¯¹åº”ä¸€ä¸ªDAC<br>snd_soc_dapm_micbias è¯¥widgetå¯¹åº”ä¸€ä¸ªéº¦å…‹é£åç½®ç”µå‹æ§ä»¶<br>snd_soc_dapm_mic è¯¥widgetå¯¹åº”ä¸€ä¸ªéº¦å…‹é£ã€‚<br>snd_soc_dapm_hp è¯¥widgetå¯¹åº”ä¸€ä¸ªè€³æœºã€‚<br>snd_soc_dapm_spk è¯¥widgetå¯¹åº”ä¸€ä¸ªæ‰¬å£°å™¨ã€‚<br>snd_soc_dapm_line è¯¥widgetå¯¹åº”ä¸€ä¸ªçº¿è·¯è¾“å…¥ã€‚<br>snd_soc_dapm_switch è¯¥widgetå¯¹åº”ä¸€ä¸ªæ¨¡æ‹Ÿå¼€å…³ã€‚<br>snd_soc_dapm_vmid è¯¥widgetå¯¹åº”ä¸€ä¸ªcodecçš„vmidåç½®ç”µå‹ã€‚<br>snd_soc_dapm_pre machineçº§åˆ«çš„ä¸“ç”¨widgetï¼Œä¼šå…ˆäºå…¶å®ƒwidgetæ‰§è¡Œæ£€æŸ¥æ“ä½œã€‚<br>snd_soc_dapm_post machineçº§åˆ«çš„ä¸“ç”¨widgetï¼Œä¼šåäºå…¶å®ƒwidgetæ‰§è¡Œæ£€æŸ¥æ“ä½œã€‚<br>snd_soc_dapm_supply å¯¹åº”ä¸€ä¸ªç”µæºæˆ–æ˜¯æ—¶é’Ÿæºã€‚<br>snd_soc_dapm_regulator_supply å¯¹åº”ä¸€ä¸ªå¤–éƒ¨regulatorç¨³å‹å™¨ã€‚<br>snd_soc_dapm_clock_supply å¯¹åº”ä¸€ä¸ªå¤–éƒ¨æ—¶é’Ÿæºã€‚<br>snd_soc_dapm_aif_in å¯¹åº”ä¸€ä¸ªæ•°å­—éŸ³é¢‘è¾“å…¥æ¥å£ï¼Œæ¯”å¦‚I2Sæ¥å£çš„è¾“å…¥ç«¯ã€‚<br>snd_soc_dapm_aif_out å¯¹åº”ä¸€ä¸ªæ•°å­—éŸ³é¢‘è¾“å‡ºæ¥å£ï¼Œæ¯”å¦‚I2Sæ¥å£çš„è¾“å‡ºç«¯ã€‚<br>snd_soc_dapm_siggen å¯¹åº”ä¸€ä¸ªä¿¡å·å‘ç”Ÿå™¨ã€‚<br>snd_soc_dapm_dai_in å¯¹åº”ä¸€ä¸ªplatformæˆ–codecåŸŸçš„è¾“å…¥DAIç»“æ„ã€‚<br>snd_soc_dapm_dai_out å¯¹åº”ä¸€ä¸ªplatformæˆ–codecåŸŸçš„è¾“å‡ºDAIç»“æ„ã€‚<br>snd_soc_dapm_dai_link ç”¨äºé“¾æ¥ä¸€å¯¹è¾“å…¥/è¾“å‡ºDAIç»“æ„ã€‚</p><h5 id="7-2-3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath"><a href="#7-2-3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath" class="headerlink" title="7.2.3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath"></a>7.2.3ã€widgetä¹‹é—´çš„è¿æ¥å™¨ï¼špath</h5><p>ä¹‹å‰å·²ç»æåˆ°ï¼Œä¸€ä¸ªwidgetæ˜¯æœ‰è¾“å…¥å’Œè¾“å‡ºçš„ï¼Œè€Œä¸”widgetä¹‹é—´æ˜¯å¯ä»¥åŠ¨æ€åœ°è¿›è¡Œè¿æ¥çš„ï¼Œé‚£å®ƒä»¬æ˜¯ç”¨ä»€ä¹ˆæ¥è¿æ¥ä¸¤ä¸ªwidgetçš„å‘¢ï¼ŸDAPMä¸ºæˆ‘ä»¬æå‡ºäº†pathè¿™ä¸€æ¦‚å¿µï¼Œpathç›¸å½“äºç”µè·¯ä¸­çš„ä¸€æ ¹è·³çº¿ï¼Œå®ƒæŠŠä¸€ä¸ªwidgetçš„è¾“å‡ºç«¯å’Œå¦ä¸€ä¸ªwidgetçš„è¾“å…¥ç«¯è¿æ¥åœ¨ä¸€èµ·ï¼Œpathç”¨snd_soc_dapm_pathç»“æ„æ¥æè¿°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc-dapm.h]</span><br><span class="line"><span class="comment">/* dapm audio path between two widgets */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* source (input) and sink (output) widgets */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">source</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">sink</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* status */</span></span><br><span class="line">	u32 connect:<span class="number">1</span>;	<span class="comment">/* source and sink widgets are connected */</span></span><br><span class="line">	u32 walked:<span class="number">1</span>;	<span class="comment">/* path has been walked */</span></span><br><span class="line">	u32 walking:<span class="number">1</span>;  <span class="comment">/* path is in the process of being walked */</span></span><br><span class="line">	u32 weak:<span class="number">1</span>;	<span class="comment">/* path ignored for power management */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*connected)(struct snd_soc_dapm_widget *source,</span><br><span class="line">			 struct snd_soc_dapm_widget *sink);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_source</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_sink</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_kcontrol</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“widgetä¹‹é—´å‘ç”Ÿè¿æ¥å…³ç³»æ—¶ï¼Œsnd_soc_dapm_pathä½œä¸ºè¿æ¥è€…ï¼Œå®ƒçš„sourceå­—æ®µä¼šæŒ‡å‘è¯¥è¿æ¥çš„èµ·å§‹ç«¯widgetï¼Œè€Œå®ƒçš„sinkå­—æ®µä¼šæŒ‡å‘è¯¥è¿æ¥çš„åˆ°è¾¾ç«¯widgetï¼Œè¿˜è®°å¾—å‰é¢snd_soc_dapm_widgetç»“æ„ä¸­çš„ä¸¤ä¸ªé“¾è¡¨å¤´å­—æ®µï¼šsourceså’Œsinksä¹ˆï¼Ÿwidgetçš„è¾“å…¥ç«¯å’Œè¾“å‡ºç«¯å¯èƒ½è¿æ¥ç€å¤šä¸ªpathï¼Œæ‰€æœ‰è¾“å…¥ç«¯çš„snd_soc_dapm_pathç»“æ„é€šè¿‡list_sinkå­—æ®µæŒ‚åœ¨widgetçš„soucesé“¾è¡¨ä¸­ï¼ŒåŒæ ·ï¼Œæ‰€æœ‰è¾“å‡ºç«¯çš„snd_soc_dapm_pathç»“æ„é€šè¿‡list_sourceå­—æ®µæŒ‚åœ¨widgetçš„sinksé“¾è¡¨ä¸­ã€‚è¿™é‡Œå¯èƒ½å¤§å®¶ä¼šè¢«æå¾—æ™•å‘¼å‘¼çš„ï¼Œä¸€ä¼šsourceï¼Œä¸€ä¼šsinkï¼Œä¸è¦ç´§ï¼Œåªè¦è®°ä½ï¼Œè¿æ¥çš„è·¯å¾„æ˜¯è¿™æ ·çš„ï¼šèµ·å§‹ç«¯widgetçš„è¾“å‡ºâ€“&gt;pathçš„è¾“å…¥â€“&gt;pathçš„è¾“å‡ºâ€“&gt;åˆ°è¾¾ç«¯widgetè¾“å…¥ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/28-Audio-system-snd_soc_dapm_path.png" alt="Alt text"><br>å¦å¤–ï¼Œsnd_soc_dapm_pathç»“æ„çš„listå­—æ®µç”¨äºæŠŠæ‰€æœ‰çš„pathæ³¨å†Œåˆ°å£°å¡ä¸­ï¼Œå…¶å®å°±æ˜¯æŒ‚åœ¨snd_soc_cardç»“æ„çš„pathsé“¾è¡¨å¤´å­—æ®µä¸­ã€‚å¦‚æœä½ è¦è‡ªå·±å®šä¹‰æ–¹æ³•æ¥æ£€æŸ¥pathçš„å½“å‰è¿æ¥çŠ¶æ€ï¼Œä½ å¯ä»¥æä¾›è‡ªå·±çš„connectedå›è°ƒå‡½æ•°æŒ‡é’ˆã€‚</p><p>connectï¼Œwalkedï¼Œwalkingï¼Œweakæ˜¯å‡ ä¸ªè¾…åŠ©å­—æ®µï¼Œç”¨äºå¸®åŠ©æ‰€æœ‰pathçš„éå†ã€‚</p><h5 id="7-2-4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute"><a href="#7-2-4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute" class="headerlink" title="7.2.4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute"></a>7.2.4ã€widgetçš„è¿æ¥å…³ç³»ï¼šroute</h5><p>é€šè¿‡ä¸Šä¸€èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªè·¯å¾„çš„è¿æ¥è‡³å°‘åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼šèµ·å§‹ç«¯widgetï¼Œè·³çº¿pathï¼Œåˆ°è¾¾ç«¯widgetï¼Œåœ¨DAPMä¸­ï¼Œç”¨snd_soc_dapm_routeç»“æ„æ¥æè¿°è¿™æ ·ä¸€ä¸ªè¿æ¥å…³ç³»ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/include/sound/soc-dapm.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *sink;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *control;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *source;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Note: currently only supported for links where source is a supply */</span></span><br><span class="line">	<span class="keyword">int</span> (*connected)(struct snd_soc_dapm_widget *source,</span><br><span class="line">			 struct snd_soc_dapm_widget *sink);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>sinkæŒ‡å‘åˆ°è¾¾ç«¯widgetçš„åå­—å­—ç¬¦ä¸²ï¼ŒsourceæŒ‡å‘èµ·å§‹ç«¯widgetçš„åå­—å­—ç¬¦ä¸²ï¼ŒcontrolæŒ‡å‘è´Ÿè´£æ§åˆ¶è¯¥è¿æ¥æ‰€å¯¹åº”çš„kcontrolåå­—å­—ç¬¦ä¸²ï¼Œconnectedå›è°ƒåˆ™å®šä¹‰äº†ä¸Šä¸€èŠ‚æ‰€æåˆ°çš„è‡ªå®šä¹‰è¿æ¥æ£€æŸ¥å›è°ƒå‡½æ•°ã€‚è¯¥ç»“æ„çš„æ„ä¹‰å¾ˆæ˜æ˜¾å°±æ˜¯ï¼šsourceé€šè¿‡ä¸€ä¸ªkcontrolï¼Œå’Œsinkè¿æ¥åœ¨ä¸€èµ·ï¼Œç°åœ¨æ˜¯å¦å¤„äºè¿æ¥çŠ¶æ€ï¼Œè¯·è°ƒç”¨connectedå›è°ƒå‡½æ•°æ£€æŸ¥ã€‚<br>è¿™é‡Œç›´æ¥ä½¿ç”¨åå­—å­—ç¬¦ä¸²æ¥æè¿°è¿æ¥å…³ç³»ï¼Œæ‰€æœ‰å®šä¹‰å¥½çš„routeï¼Œæœ€åéƒ½è¦æ³¨å†Œåˆ°dapmç³»ç»Ÿä¸­ï¼Œdapmä¼šæ ¹æ®è¿™äº›åå­—æ‰¾å‡ºç›¸åº”çš„widgetï¼Œå¹¶åŠ¨æ€åœ°ç”Ÿæˆæ‰€éœ€è¦çš„snd_soc_dapm_pathç»“æ„ï¼Œæ­£ç¡®åœ°å¤„ç†å„ä¸ªé“¾è¡¨å’ŒæŒ‡é’ˆçš„å…³ç³»ï¼Œå®ç°ä¸¤ä¸ªwidgetä¹‹é—´çš„è¿æ¥</p><h5 id="7-3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»"><a href="#7-3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»" class="headerlink" title="7.3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»"></a>7.3ã€å»ºç«‹widgetä¹‹é—´çš„è¿æ¥å…³ç³»</h5><p>å‰é¢æˆ‘ä»¬ä¸»è¦ç€é‡äºcodecã€platformã€machineé©±åŠ¨ç¨‹åºä¸­å¦‚ä½•ä½¿ç”¨å’Œå»ºç«‹dapmæ‰€éœ€è¦çš„widgetï¼Œrouteï¼Œè¿™äº›æ˜¯éŸ³é¢‘é©±åŠ¨å¼€å‘äººå‘˜å¿…é¡»è¦äº†è§£çš„å†…å®¹ï¼Œç»è¿‡å‰å‡ ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬åº”è¯¥çŸ¥é“å¦‚ä½•åœ¨alsaéŸ³é¢‘é©±åŠ¨çš„3å¤§éƒ¨åˆ†ï¼ˆcodecã€platformã€machineï¼‰ä¸­ï¼ŒæŒ‰ç…§æ‰€ä½¿ç”¨çš„éŸ³é¢‘ç¡¬ä»¶ç»“æ„ï¼Œå®šä¹‰å‡ºç›¸åº”çš„widgetï¼Œkcontrolï¼Œä»¥åŠå¿…è¦çš„éŸ³é¢‘è·¯å¾„ï¼Œè€Œåœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šæ·±å…¥dapmçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œçœ‹çœ‹å„ä¸ªwidgetä¹‹é—´æ˜¯å¦‚ä½•å»ºç«‹è¿æ¥å…³ç³»ï¼Œå½¢æˆä¸€æ¡å®Œæ•´çš„éŸ³é¢‘è·¯å¾„ã€‚</p><p>å‰é¢æˆ‘ä»¬å·²ç»ç®€å•åœ°ä»‹ç»è¿‡ï¼Œé©±åŠ¨ç¨‹åºéœ€è¦ä½¿ç”¨ä»¥ä¸‹apiå‡½æ•°åˆ›å»ºwidgetï¼š</p><p>â€¢ snd_soc_dapm_new_controls()<br>å®é™…ä¸Šï¼Œè¿™ä¸ªå‡½æ•°åªæ˜¯åˆ›å»ºwidgetçš„ç¬¬ä¸€æ­¥ï¼Œå®ƒä¸ºæ¯ä¸ªwidgetåˆ†é…å†…å­˜ï¼Œåˆå§‹åŒ–å¿…è¦çš„å­—æ®µï¼Œç„¶åæŠŠè¿™äº›widgetæŒ‚åœ¨ä»£è¡¨å£°å¡çš„snd_soc_cardçš„widgetsé“¾è¡¨å­—æ®µä¸­ã€‚è¦ä½¿widgetä¹‹é—´å…·å¤‡è¿æ¥èƒ½åŠ›ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¬¬äºŒä¸ªå‡½æ•°ï¼š<br>â€¢ snd_soc_dapm_new_widgets()<br>è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®widgetçš„ä¿¡æ¯ï¼Œåˆ›å»ºwidgetæ‰€éœ€è¦çš„dapm kcontrolï¼Œè¿™äº›dapm kcontolçš„çŠ¶æ€å˜åŒ–ï¼Œä»£è¡¨ç€éŸ³é¢‘è·¯å¾„çš„å˜åŒ–ï¼Œä»è€Œå½±å“ç€å„ä¸ªwidgetçš„ç”µæºçŠ¶æ€ã€‚çœ‹åˆ°å‡½æ•°çš„åç§°å¯èƒ½ä¼šè¿·æƒ‘ä¸€ä¸‹ï¼Œå®é™…ä¸Šï¼Œsnd_soc_dapm_new_controlsçš„ä½œç”¨æ›´å¤šåœ°æ˜¯åˆ›å»ºwidgetï¼Œè€Œsnd_soc_dapm_new_widgetçš„ä½œç”¨åˆ™æ›´å¤šåœ°æ˜¯åˆ›å»ºwidgetæ‰€åŒ…å«çš„kcontrolï¼Œæ‰€ä»¥åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åç§°åº”è¯¥æ¢è¿‡æ¥å«æ›´å¥½ï¼ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><h5 id="7-3-1ã€åˆ›å»ºwidget"><a href="#7-3-1ã€åˆ›å»ºwidget" class="headerlink" title="7.3.1ã€åˆ›å»ºwidget"></a>7.3.1ã€åˆ›å»ºwidget</h5><p>snd_soc_dapm_new_controls()å‡½æ•°å®Œæˆwidgetçš„åˆ›å»ºå·¥ä½œï¼Œå¹¶æŠŠè¿™äº›åˆ›å»ºå¥½çš„widgetæ³¨å†Œåœ¨å£°å¡çš„widgetsé“¾è¡¨ä¸­ï¼Œæˆ‘ä»¬çœ‹çœ‹ä»–çš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_controls</span><span class="params">(struct snd_soc_dapm_context *dapm,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> struct snd_soc_dapm_widget *widget,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">w</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	mutex_lock_nested(&amp;dapm-&gt;card-&gt;dapm_mutex, SND_SOC_DAPM_CLASS_INIT);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">		w = snd_soc_dapm_new_control(dapm, widget);</span><br><span class="line">		<span class="keyword">if</span> (!w) &#123;</span><br><span class="line">			dev_err(dapm-&gt;dev,</span><br><span class="line">				<span class="string">"ASoC: Failed to create DAPM control %s\n"</span>,</span><br><span class="line">				widget-&gt;name);</span><br><span class="line">			ret = -ENOMEM;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		widget++;</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;dapm-&gt;card-&gt;dapm_mutex);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°åªæ˜¯ç®€å•çš„ä¸€ä¸ªå¾ªç¯ï¼Œä¸ºä¼ å…¥çš„widgetæ¨¡æ¿æ•°ç»„ä¾æ¬¡è°ƒç”¨snd_soc_dapm_new_controlå‡½æ•°ï¼Œå®é™…çš„å·¥ä½œç”±snd_soc_dapm_new_controlå®Œæˆï¼Œç»§ç»­è¿›å…¥è¯¥å‡½æ•°ï¼Œçœ‹çœ‹å®ƒåšäº†é‚£äº›å·¥ä½œã€‚<br>æˆ‘ä»¬ä¹‹å‰å·²ç»è¯´è¿‡ï¼Œé©±åŠ¨ä¸­å®šä¹‰çš„snd_soc_dapm_widgetæ•°ç»„ï¼Œåªæ˜¯ä½œä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œæ‰€ä»¥ï¼Œsnd_soc_dapm_new_controlæ‰€åšçš„ç¬¬ä¸€ä»¶äº‹ï¼Œå°±æ˜¯ä¸ºè¯¥widgeté‡æ–°åˆ†é…å†…å­˜ï¼Œå¹¶æŠŠæ¨¡æ¿çš„å†…å®¹æ‹·è´è¿‡æ¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *</span></span><br><span class="line"><span class="class"><span class="title">snd_soc_dapm_new_control</span>(<span class="title">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span>,</span></span><br><span class="line"><span class="class">			 <span class="title">const</span> <span class="title">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">widget</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">w</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *prefix;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((w = dapm_cnew_widget(widget)) == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//ç”±dapm_cnew_widgetå®Œæˆå†…å­˜ç”³è¯·å’Œæ‹·è´æ¨¡æ¿çš„åŠ¨ä½œã€‚æ¥ä¸‹æ¥ï¼Œæ ¹æ®widgetçš„ç±»å‹åšä¸åŒçš„å¤„ç†ï¼š</span></span><br><span class="line">	<span class="keyword">switch</span> (w-&gt;id) &#123;</span><br><span class="line">	<span class="keyword">case</span> snd_soc_dapm_regulator_supply:</span><br><span class="line">	......</span><br><span class="line">    &#125;</span><br><span class="line">	prefix = soc_dapm_prefix(dapm);</span><br><span class="line">	<span class="comment">//å¯¹äºsnd_soc_dapm_regulator_supplyç±»å‹çš„widgetï¼Œæ ¹æ®widgetçš„åç§°è·å–å¯¹åº”çš„regulatorç»“æ„ï¼Œå¯¹äºsnd_soc_dapm_clock_supplyç±»å‹çš„widgetï¼Œæ ¹æ®widgetçš„åç§°ï¼Œè·å–å¯¹åº”çš„clockç»“æ„ã€‚æ¥ä¸‹æ¥ï¼Œæ ¹æ®éœ€è¦ï¼Œåœ¨widgetçš„åç§°å‰åŠ å…¥å¿…è¦çš„å‰ç¼€ï¼š</span></span><br><span class="line">	<span class="keyword">if</span> (prefix) &#123;</span><br><span class="line">		w-&gt;name = kasprintf(GFP_KERNEL, <span class="string">"%s %s"</span>, prefix, widget-&gt;name);</span><br><span class="line">		<span class="keyword">if</span> (widget-&gt;sname)</span><br><span class="line">			w-&gt;sname = kasprintf(GFP_KERNEL, <span class="string">"%s %s"</span>, prefix,</span><br><span class="line">					     widget-&gt;sname);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		w-&gt;name = kasprintf(GFP_KERNEL, <span class="string">"%s"</span>, widget-&gt;name);</span><br><span class="line">		<span class="keyword">if</span> (widget-&gt;sname)</span><br><span class="line">			w-&gt;sname = kasprintf(GFP_KERNEL, <span class="string">"%s"</span>, widget-&gt;sname);</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/29-Audio-system-widget-1525420992983.png" alt="Alt text"><br>å½“éŸ³é¢‘è·¯å¾„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œpower_checkå›è°ƒä¼šè¢«è°ƒç”¨ï¼Œç”¨äºæ£€æŸ¥è¯¥widgetçš„ç”µæºçŠ¶æ€æ˜¯å¦éœ€è¦æ›´æ–°ã€‚power_checkè®¾ç½®å®Œæˆåï¼Œéœ€è¦è®¾ç½®widgetæ‰€å±çš„codecã€platformå’Œdapm contextï¼Œå‡ ä¸ªç”¨äºéŸ³é¢‘è·¯å¾„çš„é“¾è¡¨ä¹Ÿéœ€è¦åˆå§‹åŒ–ï¼Œç„¶åï¼ŒæŠŠè¯¥widgetåŠ å…¥åˆ°å£°å¡çš„widgetsé“¾è¡¨ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.cï¼šsnd_soc_dapm_new_control()</span><br><span class="line">w-&gt;dapm = dapm;  </span><br><span class="line">w-&gt;codec = dapm-&gt;codec;  </span><br><span class="line">w-&gt;platform = dapm-&gt;platform;  </span><br><span class="line">INIT_LIST_HEAD(&amp;w-&gt;sources);  </span><br><span class="line">INIT_LIST_HEAD(&amp;w-&gt;sinks);  </span><br><span class="line">INIT_LIST_HEAD(&amp;w-&gt;<span class="built_in">list</span>);  </span><br><span class="line">INIT_LIST_HEAD(&amp;w-&gt;dirty);  </span><br><span class="line">list_add(&amp;w-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;widgets);</span><br></pre></td></tr></table></figure><p>å‡ ä¸ªé“¾è¡¨çš„ä½œç”¨å¦‚ä¸‹ï¼š<br>sources ç”¨äºé“¾æ¥æ‰€æœ‰è¿æ¥åˆ°è¯¥widgetè¾“å…¥ç«¯çš„snd_soc_pathç»“æ„<br>sinks ç”¨äºé“¾æ¥æ‰€æœ‰è¿æ¥åˆ°è¯¥widgetè¾“å‡ºç«¯çš„snd_soc_pathç»“æ„<br>list ç”¨äºé“¾æ¥åˆ°å£°å¡çš„widgetsé“¾è¡¨<br>dirty ç”¨äºé“¾æ¥åˆ°å£°å¡çš„dapm_dirtyé“¾è¡¨<br>æœ€åï¼ŒæŠŠwidgetè®¾ç½®ä¸ºconnectçŠ¶æ€ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.cï¼šsnd_soc_dapm_new_control()</span><br><span class="line"><span class="comment">/* machine layer set ups unconnected pins and insertions */</span>  </span><br><span class="line">w-&gt;connected = <span class="number">1</span>;  </span><br><span class="line"><span class="keyword">return</span> w;</span><br></pre></td></tr></table></figure><p>connectedå­—æ®µä»£è¡¨ç€å¼•è„šçš„è¿æ¥çŠ¶æ€ï¼Œç›®å‰ï¼Œåªæœ‰ä»¥ä¸‹è¿™äº›widgetä½¿ç”¨connectedå­—æ®µï¼š<br>snd_soc_dapm_output<br>snd_soc_dapm_input<br>snd_soc_dapm_hp<br>snd_soc_dapm_spk<br>snd_soc_dapm_line<br>snd_soc_dapm_vmid<br>snd_soc_dapm_mic<br>snd_soc_dapm_siggen<br>é©±åŠ¨ç¨‹åºå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¿™äº›apiæ¥è®¾ç½®å¼•è„šçš„è¿æ¥çŠ¶æ€ï¼š<br>snd_soc_dapm_enable_pin<br>snd_soc_dapm_force_enable_pin<br>snd_soc_dapm_disable_pin<br>snd_soc_dapm_nc_pin<br>åˆ°æ­¤ï¼Œwidgetå·²ç»è¢«æ­£ç¡®åœ°åˆ›å»ºå¹¶åˆå§‹åŒ–ï¼Œè€Œä¸”è¢«æŒ‚åœ¨å£°å¡çš„widgetsé“¾è¡¨ä¸­ï¼Œä»¥åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å£°å¡çš„widgetsé“¾è¡¨æ¥éå†æ‰€æœ‰çš„widgetï¼Œå†æ¬¡å¼ºè°ƒä¸€ä¸‹snd_soc_dapm_new_controlså‡½æ•°æ‰€å®Œæˆçš„ä¸»è¦åŠŸèƒ½ï¼š<br>ä¸ºwidgetåˆ†é…å†…å­˜ï¼Œå¹¶æ‹·è´å‚æ•°ä¸­ä¼ å…¥çš„åœ¨é©±åŠ¨ä¸­å®šä¹‰å¥½çš„æ¨¡æ¿<br>è®¾ç½®power_checkå›è°ƒå‡½æ•°<br>æŠŠwidgetæŒ‚åœ¨å£°å¡çš„widgetsé“¾è¡¨ä¸­</p><h5 id="7-3-2ã€ä¸ºwidgetå»ºç«‹dapm-kcontrol"><a href="#7-3-2ã€ä¸ºwidgetå»ºç«‹dapm-kcontrol" class="headerlink" title="7.3.2ã€ä¸ºwidgetå»ºç«‹dapm kcontrol"></a>7.3.2ã€ä¸ºwidgetå»ºç«‹dapm kcontrol</h5><p>å®šä¹‰ä¸€ä¸ªwidgetï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šä¸¤ä¸ªå¾ˆé‡è¦çš„å†…å®¹ï¼šä¸€ä¸ªæ˜¯ç”¨äºæ§åˆ¶widgetçš„ç”µæºçŠ¶æ€çš„reg/shiftç­‰å¯„å­˜å™¨ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªæ˜¯ç”¨äºæ§åˆ¶éŸ³é¢‘è·¯å¾„åˆ‡æ¢çš„dapm kcontrolä¿¡æ¯ï¼Œè¿™äº›dapm kcontrolæœ‰å®ƒä»¬è‡ªå·±çš„reg/shiftå¯„å­˜å™¨ä¿¡æ¯ç”¨äºåˆ‡æ¢widgetçš„è·¯å¾„è¿æ¥æ–¹å¼ã€‚å‰ä¸€èŠ‚çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯åˆ›å»ºäº†widgetçš„å®ä¾‹ï¼Œå¹¶æŠŠå®ƒä»¬æ³¨å†Œåˆ°å£°å¡çš„widgtsé“¾è¡¨ä¸­ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒåŒ…å«åœ¨widgetä¸­çš„dapm kcontrolå¹¶æ²¡æœ‰å»ºç«‹èµ·æ¥ï¼Œdapmæ¡†æ¶åœ¨å£°å¡çš„åˆå§‹åŒ–é˜¶æ®µï¼Œç­‰æ‰€æœ‰çš„widgetï¼ˆåŒ…æ‹¬machineã€platformã€codecï¼‰éƒ½åˆ›å»ºå¥½ä¹‹åï¼Œé€šè¿‡snd_soc_dapm_new_widgetså‡½æ•°ï¼Œåˆ›å»ºwidgetå†…åŒ…å«çš„dapm kcontrolï¼Œå¹¶åˆå§‹åŒ–widgetçš„åˆå§‹ç”µæºçŠ¶æ€å’ŒéŸ³é¢‘è·¯å¾„çš„åˆå§‹è¿æ¥çŠ¶æ€ã€‚æˆ‘ä»¬çœ‹çœ‹å£°å¡çš„åˆå§‹åŒ–å‡½æ•°ï¼Œéƒ½æœ‰é‚£äº›åˆå§‹åŒ–ä¸dapmæœ‰å…³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_instantiate_card</span><span class="params">(struct snd_soc_card *card)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        ......  </span><br><span class="line">        <span class="comment">/* card bind complete so register a sound card */</span>  </span><br><span class="line">        ret = snd_card_create(SNDRV_DEFAULT_IDX1, SNDRV_DEFAULT_STR1,  </span><br><span class="line">                        card-&gt;owner, <span class="number">0</span>, &amp;card-&gt;snd_card);  </span><br><span class="line">        ......  </span><br><span class="line">   </span><br><span class="line">        card-&gt;dapm.bias_level = SND_SOC_BIAS_OFF;  </span><br><span class="line">        card-&gt;dapm.dev = card-&gt;dev;  </span><br><span class="line">        card-&gt;dapm.card = card;  </span><br><span class="line">        list_add(&amp;card-&gt;dapm.<span class="built_in">list</span>, &amp;card-&gt;dapm_list);  </span><br><span class="line">        ......  </span><br><span class="line">        <span class="keyword">if</span> (card-&gt;dapm_widgets)    <span class="comment">/* åˆ›å»ºmachineçº§åˆ«çš„widget  */</span>  </span><br><span class="line">                snd_soc_dapm_new_controls(&amp;card-&gt;dapm, card-&gt;dapm_widgets,  </span><br><span class="line">                                          card-&gt;num_dapm_widgets);  </span><br><span class="line">        ......  </span><br><span class="line">        snd_soc_dapm_link_dai_widgets(card);  <span class="comment">/*  è¿æ¥dai widget  */</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (card-&gt;controls)    <span class="comment">/*  å»ºç«‹machineçº§åˆ«çš„æ™®é€škcontrolæ§ä»¶  */</span>  </span><br><span class="line">                snd_soc_add_card_controls(card, card-&gt;controls, card-&gt;num_controls);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (card-&gt;dapm_routes)    <span class="comment">/*  æ³¨å†Œmachineçº§åˆ«çš„è·¯å¾„è¿æ¥ä¿¡æ¯  */</span>  </span><br><span class="line">                snd_soc_dapm_add_routes(&amp;card-&gt;dapm, card-&gt;dapm_routes,  </span><br><span class="line">                                        card-&gt;num_dapm_routes);  </span><br><span class="line">        ......  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (card-&gt;fully_routed)    <span class="comment">/*  å¦‚æœè¯¥æ ‡å¿—è¢«ç½®ä½ï¼Œè‡ªåŠ¨æŠŠcodecä¸­æ²¡æœ‰è·¯å¾„è¿æ¥ä¿¡æ¯çš„å¼•è„šè®¾ç½®ä¸ºæ— ç”¨widget  */</span>  </span><br><span class="line">                list_for_each_entry(codec, &amp;card-&gt;codec_dev_list, card_list)  </span><br><span class="line">                        snd_soc_dapm_auto_nc_codec_pins(codec);  </span><br><span class="line">  </span><br><span class="line">        snd_soc_dapm_new_widgets(card);    <span class="comment">/*åˆå§‹åŒ–widgetåŒ…å«çš„dapm kcontrolã€ç”µæºçŠ¶æ€å’Œè¿æ¥çŠ¶æ€*/</span>  </span><br><span class="line">  </span><br><span class="line">        ret = snd_card_register(card-&gt;snd_card);  </span><br><span class="line">        ......  </span><br><span class="line">        card-&gt;instantiated = <span class="number">1</span>;  </span><br><span class="line">        snd_soc_dapm_sync(&amp;card-&gt;dapm);  </span><br><span class="line">        ......  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£å¦‚æˆ‘æ·»åŠ çš„æ³¨é‡Šä¸­æ‰€ç¤ºï¼Œåœ¨å®Œæˆmachineçº§åˆ«çš„widgetå’Œrouteå¤„ç†ä¹‹åï¼Œè°ƒç”¨çš„snd_soc_dapm_new_widgetså‡½æ•°ï¼Œæ¥ä¸ºæ‰€æœ‰å·²ç»æ³¨å†Œçš„widgetåˆå§‹åŒ–ä»–ä»¬æ‰€åŒ…å«çš„dapm kcontrolï¼Œå¹¶åˆå§‹åŒ–widgetçš„ç”µæºçŠ¶æ€å’Œè·¯å¾„è¿æ¥çŠ¶æ€ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹snd_soc_dapm_new_widgetså‡½æ•°çš„å·¥ä½œè¿‡ç¨‹ã€‚</p><h5 id="7-3-2-1ã€snd-soc-dapm-new-widgetså‡½æ•°"><a href="#7-3-2-1ã€snd-soc-dapm-new-widgetså‡½æ•°" class="headerlink" title="7.3.2.1ã€snd_soc_dapm_new_widgetså‡½æ•°"></a>7.3.2.1ã€snd_soc_dapm_new_widgetså‡½æ•°</h5><p>è¯¥å‡½æ•°é€šè¿‡å£°å¡çš„widgetsé“¾è¡¨ï¼Œéå†æ‰€æœ‰å·²ç»æ³¨å†Œäº†çš„widgetï¼Œå…¶ä¸­çš„newå­—æ®µç”¨äºåˆ¤æ–­è¯¥widgetæ˜¯å¦å·²ç»æ‰§è¡Œè¿‡snd_soc_dapm_new_widgetså‡½æ•°ï¼Œå¦‚æœnum_kcontrolså­—æ®µæœ‰æ•°å€¼ï¼Œè¡¨æ˜è¯¥widgetåŒ…å«æœ‰è‹¥å¹²ä¸ªdapm kcontrolï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸ºè¿™äº›kcontrolåˆ†é…ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œå¹¶æŠŠæ•°ç»„çš„é¦–åœ°å€èµ‹å€¼ç»™widgetçš„kcontrolså­—æ®µï¼Œè¯¥æ•°ç»„å­˜æ”¾ç€æŒ‡å‘è¿™äº›kcontrolçš„æŒ‡é’ˆï¼Œå½“ç„¶ç°åœ¨è¿™äº›éƒ½æ˜¯ç©ºæŒ‡é’ˆï¼Œå› ä¸ºå®é™…çš„kcontrolç°åœ¨è¿˜æ²¡æœ‰è¢«åˆ›å»ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_widgets</span><span class="params">(struct snd_soc_card *card)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        ......  </span><br><span class="line">        list_for_each_entry(w, &amp;card-&gt;widgets, <span class="built_in">list</span>)  </span><br><span class="line">        &#123;                 </span><br><span class="line">                <span class="keyword">if</span> (w-&gt;<span class="keyword">new</span>) <span class="keyword">continue</span>;  </span><br><span class="line">                                  </span><br><span class="line">                <span class="keyword">if</span> (w-&gt;num_kcontrols) &#123;  </span><br><span class="line">                        w-&gt;kcontrols = kzalloc(w-&gt;num_kcontrols *  </span><br><span class="line">                                                <span class="keyword">sizeof</span>(struct snd_kcontrol *),  </span><br><span class="line">                                                GFP_KERNEL);  </span><br><span class="line">                        ......  </span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œå¯¹å‡ ç§èƒ½å½±å“éŸ³é¢‘è·¯å¾„çš„widgetï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–å®ƒä»¬æ‰€åŒ…å«çš„dapm kcontrolï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_new_widgets()]</span><br><span class="line"><span class="keyword">switch</span>(w-&gt;id) &#123;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_switch:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mixer:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mixer_named_ctl:  </span><br><span class="line">        dapm_new_mixer(w);  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mux:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_virt_mux:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_value_mux:  </span><br><span class="line">        dapm_new_mux(w);  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_pga:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_out_drv:  </span><br><span class="line">        dapm_new_pga(w);  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">default</span>:  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦ç”¨åˆ°çš„åˆ›å»ºå‡½æ•°åˆ†åˆ«æ˜¯ï¼š<br>dapm_new_mixer() å¯¹äºmixerç±»å‹ï¼Œç”¨è¯¥å‡½æ•°åˆ›å»ºdapm kcontrolï¼›<br>dapm_new_mux() å¯¹äºmuxç±»å‹ï¼Œç”¨è¯¥å‡½æ•°åˆ›å»ºdapm kcontrolï¼›<br>dapm_new_pga() å¯¹äºpgaç±»å‹ï¼Œç”¨è¯¥å‡½æ•°åˆ›å»ºdapm kcontrolï¼›<br>ç„¶åï¼Œæ ¹æ®widgetå¯„å­˜å™¨çš„å½“å‰å€¼ï¼Œåˆå§‹åŒ–widgetçš„ç”µæºçŠ¶æ€ï¼Œå¹¶è®¾ç½®åˆ°powerå­—æ®µä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_new_widgets()]</span><br><span class="line"><span class="comment">/* Read the initial power state from the device */</span>  </span><br><span class="line"><span class="keyword">if</span> (w-&gt;reg &gt;= <span class="number">0</span>) &#123;  </span><br><span class="line">        val = soc_widget_read(w, w-&gt;reg) &gt;&gt; w-&gt;shift;  </span><br><span class="line">        val &amp;= w-&gt;mask;  </span><br><span class="line">        <span class="keyword">if</span> (val == w-&gt;on_val)  </span><br><span class="line">                w-&gt;power = <span class="number">1</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œè®¾ç½®newå­—æ®µï¼Œè¡¨æ˜è¯¥widgetå·²ç»åˆå§‹åŒ–å®Œæˆï¼Œæˆ‘ä»¬è¿˜è¦å§è¯¥widgetåŠ å…¥åˆ°å£°å¡çš„dapm_dirtyé“¾è¡¨ä¸­ï¼Œè¡¨æ˜è¯¥widgetçš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œç¨ååœ¨åˆé€‚çš„æ—¶åˆ»ï¼Œdapmæ¡†æ¶ä¼šæ‰«ædapm_dirtyé“¾è¡¨ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰å·²ç»å˜åŒ–çš„widgetã€‚ä¸ºä»€ä¹ˆè¦ç»Ÿä¸€å¤„ç†ï¼Ÿå› ä¸ºdapmè¦æ§åˆ¶å„ç§widgetçš„ä¸Šä¸‹ç”µé¡ºåºï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†å‡å°‘å¯„å­˜å™¨çš„è¯»å†™æ¬¡æ•°ï¼ˆå¤šä¸ªwidgetå¯èƒ½ä½¿ç”¨åŒä¸€ä¸ªå¯„å­˜å™¨ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_new_widgets()]</span><br><span class="line">w-&gt;<span class="keyword">new</span> = <span class="number">1</span>;  </span><br><span class="line">  </span><br><span class="line">dapm_mark_dirty(w, <span class="string">"new widget"</span>);  </span><br><span class="line">dapm_debugfs_add_widget(w);</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œé€šè¿‡dapm_power_widgetså‡½æ•°ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰ä½äºdapm_dirtyé“¾è¡¨ä¸Šçš„widgetçš„çŠ¶æ€æ”¹å˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_new_widgets()]</span><br><span class="line">dapm_power_widgets(card, SND_SOC_DAPM_STREAM_NOP);  </span><br><span class="line">......  </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h5 id="7-3-2-2ã€dapm-mixer-kcontrol"><a href="#7-3-2-2ã€dapm-mixer-kcontrol" class="headerlink" title="7.3.2.2ã€dapm mixer kcontrol"></a>7.3.2.2ã€dapm mixer kcontrol</h5><p>ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œå¯¹äºmixerç±»å‹çš„dapm kcontrolï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨dapm_new_mixeræ¥å®Œæˆå…·ä½“çš„åˆ›å»ºå·¥ä½œï¼Œå…ˆçœ‹ä»£ç ååˆ†æï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_new_mixer</span><span class="params">(struct snd_soc_dapm_widget *w)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> i, ret;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> *<span class="title">path</span>;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">/* add kcontrol */</span>  </span><br><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; w-&gt;num_kcontrols; i++) &#123;                                  </span><br><span class="line">                <span class="comment">/* match name */</span>  </span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰                list_for_each_entry(path, &amp;w-&gt;sources, list_sink) &#123;               </span><br><span class="line">                        <span class="comment">/* mixer/mux paths name must match control name */</span>  </span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰                        <span class="keyword">if</span> (path-&gt;name != (<span class="keyword">char</span> *)w-&gt;kcontrol_news[i].name)       </span><br><span class="line">                                <span class="keyword">continue</span>;  </span><br><span class="line">  </span><br><span class="line">ï¼ˆ<span class="number">4</span>ï¼‰                        <span class="keyword">if</span> (w-&gt;kcontrols[i]) &#123;                                   </span><br><span class="line">                                dapm_kcontrol_add_path(w-&gt;kcontrols[i], path);  </span><br><span class="line">                                <span class="keyword">continue</span>;  </span><br><span class="line">                        &#125;  </span><br><span class="line">  </span><br><span class="line">ï¼ˆ<span class="number">5</span>ï¼‰                        ret = dapm_create_or_share_mixmux_kcontrol(w, i);        </span><br><span class="line">                        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)  </span><br><span class="line">                                <span class="keyword">return</span> ret;  </span><br><span class="line">  </span><br><span class="line">ï¼ˆ<span class="number">6</span>ï¼‰                        dapm_kcontrol_add_path(w-&gt;kcontrols[i], path);           </span><br><span class="line">                &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰ å› ä¸ºä¸€ä¸ªmixeræ˜¯ç”±å¤šä¸ªkcontrolç»„æˆçš„ï¼Œæ¯ä¸ªkcontrolæ§åˆ¶ç€mixerçš„ä¸€ä¸ªè¾“å…¥ç«¯çš„å¼€å¯å’Œå…³é—­ï¼Œæ‰€ä»¥ï¼Œè¯¥å‡½æ•°ä¼šæ ¹æ®kcontrolçš„æ•°é‡åšå¾ªç¯ï¼Œé€ä¸ªå»ºç«‹å¯¹åº”çš„kcontrolã€‚<br>ï¼ˆ2ï¼‰ï¼ˆ3ï¼‰ ä¹‹å‰å¤šæ¬¡æåˆ°ï¼Œwidgetä¹‹é—´ä½¿ç”¨snd_soc_pathè¿›è¡Œè¿æ¥ï¼Œwidgetçš„sourcesé“¾è¡¨ä¿å­˜ç€æ‰€æœ‰å’Œè¾“å…¥ç«¯è¿æ¥çš„snd_soc_pathç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨kcontrolæ¨¡æ¿ä¸­æŒ‡å®šçš„åå­—æ¥åŒ¹é…å¯¹åº”çš„snd_soc_pathç»“æ„ã€‚<br>ï¼ˆ4ï¼‰ å› ä¸ºä¸€ä¸ªè¾“å…¥è„šå¯èƒ½ä¼šè¿æ¥å¤šä¸ªè¾“å…¥æºï¼Œæ‰€ä»¥å¯èƒ½åœ¨ä¸Šä¸€ä¸ªè¾“å…¥æºçš„pathå…³è”æ—¶å·²ç»åˆ›å»ºäº†è¿™ä¸ªkcontrolï¼Œæ‰€ä»¥è¿™é‡Œåˆ¤æ–­kcontrolsæŒ‡é’ˆæ•°ç»„ä¸­å¯¹åº”ç´¢å¼•ä¸­çš„æŒ‡é’ˆå€¼ï¼Œå¦‚æœå·²ç»èµ‹å€¼ï¼Œè¯´æ˜kcontrolå·²ç»åœ¨ä¹‹å‰åˆ›å»ºå¥½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦ç®€å•åœ°æŠŠè¿æ¥è¯¥è¾“å…¥ç«¯çš„pathåŠ å…¥åˆ°kcontrolçš„path_listé“¾è¡¨ä¸­ï¼Œå¹¶ä¸”å¢åŠ ä¸€ä¸ªè™šæ‹Ÿçš„å½±å­widgetï¼Œè¯¥å½±å­widgetè¿æ¥å’Œè¾“å…¥ç«¯å¯¹åº”çš„æºwidgetï¼Œå› ä¸ºä½¿ç”¨äº†kcontrolæœ¬èº«çš„reg/shiftç­‰å¯„å­˜å™¨ä¿¡æ¯ï¼Œæ‰€ä»¥å®é™…ä¸Šæ§åˆ¶çš„æ˜¯è¯¥kcontrolçš„å¼€å’Œå…³ï¼Œè¿™ä¸ªå½±å­widgetåªæœ‰åœ¨kcontrolçš„autodisableå­—æ®µè¢«è®¾ç½®çš„æƒ…å†µä¸‹æ‰ä¼šè¢«åˆ›å»ºï¼Œè¯¥ç‰¹æ€§ä½¿å¾—sourceçš„å…³é—­æ—¶ï¼Œä¸ä¹‹è¿æ¥çš„mixerçš„è¾“å…¥ç«¯ä¹Ÿå¯ä»¥è‡ªåŠ¨å…³é—­ï¼Œè¿™ä¸ªç‰¹æ€§é€šè¿‡dapm_kcontrol_add_pathæ¥å®ç°è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dapm_kcontrol_add_path</span><span class="params">(<span class="keyword">const</span> struct snd_kcontrol *kcontrol,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_path *path)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dapm_kcontrol_data</span> *<span class="title">data</span> = <span class="title">snd_kcontrol_chip</span>(<span class="title">kcontrol</span>);</span>  </span><br><span class="line">        <span class="comment">/*  æŠŠkcontrolè¿æ¥çš„pathåŠ å…¥åˆ°pathsé“¾è¡¨ä¸­  */</span>  </span><br><span class="line">        <span class="comment">/*  pathsé“¾è¡¨æ‰€åœ¨çš„dapm_kcontrol_dataç»“æ„ä¼šä¿å­˜åœ¨kcontrolçš„private_dataå­—æ®µä¸­  */</span>  </span><br><span class="line">        list_add_tail(&amp;path-&gt;list_kcontrol, &amp;data-&gt;paths);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (data-&gt;widget) &#123;  </span><br><span class="line">                snd_soc_dapm_add_path(data-&gt;widget-&gt;dapm, data-&gt;widget,  </span><br><span class="line">                    path-&gt;source, <span class="literal">NULL</span>, <span class="literal">NULL</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰ å¦‚æœkcontrolä¹‹å‰æ²¡æœ‰è¢«åˆ›å»ºï¼Œåˆ™é€šè¿‡dapm_create_or_share_mixmux_kcontrolåˆ›å»ºè¿™ä¸ªè¾“å…¥ç«¯çš„kcontrolï¼ŒåŒç†ï¼Œkcontrolå¯¹åº”çš„å½±å­widgetä¹Ÿä¼šé€šè¿‡dapm_kcontrol_add_pathåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºã€‚</p><h5 id="7-3-2-3ã€dapm-mux-kcontrol"><a href="#7-3-2-3ã€dapm-mux-kcontrol" class="headerlink" title="7.3.2.3ã€dapm mux kcontrol"></a>7.3.2.3ã€dapm mux kcontrol</h5><p>å› ä¸ºä¸€ä¸ªwidgetæœ€å¤šåªä¼šåŒ…å«ä¸€ä¸ªmuxç±»å‹çš„damp kcontrolï¼Œæ‰€ä»¥ä»–çš„åˆ›å»ºæ–¹æ³•ç¨æœ‰ä¸åŒï¼Œdapmæ¡†æ¶ä½¿ç”¨dapm_new_muxå‡½æ•°æ¥åˆ›å»ºmuxç±»å‹çš„dapm kcontrolï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_new_mux</span><span class="params">(struct snd_soc_dapm_widget *w)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;         </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span> = <span class="title">w</span>-&gt;<span class="title">dapm</span>;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> *<span class="title">path</span>;</span>  </span><br><span class="line">        <span class="keyword">int</span> ret;  </span><br><span class="line">          </span><br><span class="line">(<span class="number">1</span>)     <span class="keyword">if</span> (w-&gt;num_kcontrols != <span class="number">1</span>) &#123;  </span><br><span class="line">                dev_err(dapm-&gt;dev,  </span><br><span class="line">                        <span class="string">"ASoC: mux %s has incorrect number of controls\n"</span>,  </span><br><span class="line">                        w-&gt;name);  </span><br><span class="line">                <span class="keyword">return</span> -EINVAL;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (list_empty(&amp;w-&gt;sources)) &#123;  </span><br><span class="line">                dev_err(dapm-&gt;dev, <span class="string">"ASoC: mux %s has no paths\n"</span>, w-&gt;name);  </span><br><span class="line">                <span class="keyword">return</span> -EINVAL;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">(<span class="number">2</span>)     ret = dapm_create_or_share_mixmux_kcontrol(w, <span class="number">0</span>);  </span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)  </span><br><span class="line">                <span class="keyword">return</span> ret;  </span><br><span class="line">(<span class="number">3</span>)       list_for_each_entry(path, &amp;w-&gt;sources, list_sink)  </span><br><span class="line">                dapm_kcontrol_add_path(w-&gt;kcontrols[<span class="number">0</span>], path);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰ å¯¹äºmuxç±»å‹çš„widgetï¼Œå› ä¸ºåªä¼šæœ‰ä¸€ä¸ªkcontrolï¼Œæ‰€ä»¥åœ¨è¿™é‡Œåšä¸€ä¸‹åˆ¤æ–­ã€‚<br>ï¼ˆ2ï¼‰ åŒæ ·åœ°ï¼Œå’Œmixerç±»å‹ä¸€æ ·ï¼Œä¹Ÿä½¿ç”¨dapm_create_or_share_mixmux_kcontrolæ¥åˆ›å»ºè¿™ä¸ªkcontrolã€‚<br>ï¼ˆ3ï¼‰ å¯¹æ¯ä¸ªè¾“å…¥ç«¯æ‰€è¿æ¥çš„pathéƒ½åŠ å…¥dapm_kcontrol_dataç»“æ„çš„pathsé“¾è¡¨ä¸­ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªå½±å­widgetï¼Œç”¨äºæ”¯æŒautodisableç‰¹æ€§ã€‚</p><h5 id="7-3-2-4ã€dapm-pga-kcontrol"><a href="#7-3-2-4ã€dapm-pga-kcontrol" class="headerlink" title="7.3.2.4ã€dapm pga kcontrol"></a>7.3.2.4ã€dapm pga kcontrol</h5><p>ç›®å‰å¯¹äºpgaç±»å‹çš„widgetï¼Œkcontrolçš„åˆ›å»ºå‡½æ•°æ˜¯ä¸ªç©ºå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ç”¨å¤ªå…³æ³¨å®ƒï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_new_pga</span><span class="params">(struct snd_soc_dapm_widget *w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (w-&gt;num_kcontrols)</span><br><span class="line">		dev_err(w-&gt;dapm-&gt;dev,</span><br><span class="line">			<span class="string">"ASoC: PGA controls not supported: '%s'\n"</span>, w-&gt;name);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dapm_create_or_share_mixmux_kcontrolå‡½æ•°<br>ä¸Šé¢æ‰€è¯´çš„mixerç±»å‹å’Œmuxç±»å‹çš„widgetï¼Œåœ¨åˆ›å»ºä»–ä»¬æ‰€åŒ…å«çš„dapm kcontrolæ—¶ï¼Œæœ€åå…¶å®éƒ½æ˜¯ä½¿ç”¨äº†dapm_create_or_share_mixmux_kcontrolå‡½æ•°æ¥å®Œæˆåˆ›å»ºå·¥ä½œçš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬æœ‰å¿…è¦åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å·¥ä½œåŸç†ã€‚è¿™ä¸ªå‡½æ•°ä¸­æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ä»£ç å®åœ¨å¤„ç†kcontrolçš„åå­—æ˜¯å¦è¦åŠ å…¥codecçš„å‰ç¼€ï¼Œæˆ‘ä»¬ä¼šå¿½ç•¥è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±æŸ¥çœ‹å†…æ ¸çš„ä»£ç ï¼Œè·¯å¾„åœ¨ï¼šsound/soc/soc-dapm.cä¸­ï¼Œç®€åŒ–åçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_create_or_share_mixmux_kcontrol</span><span class="params">(struct snd_soc_dapm_widget *w,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> kci)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">          ......  </span><br><span class="line">(<span class="number">1</span>)       shared = dapm_is_shared_kcontrol(dapm, w, &amp;w-&gt;kcontrol_news[kci],  </span><br><span class="line">                                         &amp;kcontrol);  </span><br><span class="line">     </span><br><span class="line">(<span class="number">2</span>)       <span class="keyword">if</span> (!kcontrol) &#123;  </span><br><span class="line">(<span class="number">3</span>)            kcontrol = snd_soc_cnew(&amp;w-&gt;kcontrol_news[kci], <span class="literal">NULL</span>, name,prefixï¼‰;  </span><br><span class="line">               ......  </span><br><span class="line">               kcontrol-&gt;private_free = dapm_kcontrol_free;  </span><br><span class="line">(<span class="number">4</span>)            ret = dapm_kcontrol_data_alloc(w, kcontrol);  </span><br><span class="line">                ......  </span><br><span class="line">(<span class="number">5</span>)            ret = snd_ctl_add(card, kcontrol);  </span><br><span class="line">                ......  </span><br><span class="line">        &#125;  </span><br><span class="line">(<span class="number">6</span>)     ret = dapm_kcontrol_add_widget(kcontrol, w);  </span><br><span class="line">        ......  </span><br><span class="line">(<span class="number">7</span>)     w-&gt;kcontrols[kci] = kcontrol;  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰ ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œé€šè¿‡kcontrolåå­—çš„åŒ¹é…æŸ¥æ‰¾ï¼Œå¦‚æœè¿™ä¸ªkcontrolå·²ç»åœ¨å…¶ä»–widgetä¸­å·²ç»åˆ›å»ºå¥½äº†ï¼Œé‚£æˆ‘ä»¬ä¸å†åˆ›å»ºï¼Œdapm_is_shared_kcontrolçš„å‚æ•°kcontrolä¼šè¿”å›å·²ç»åˆ›å»ºå¥½çš„kcontrolçš„æŒ‡é’ˆã€‚<br>ï¼ˆ2ï¼‰ å¦‚æœkcontrolæŒ‡é’ˆè¢«èµ‹å€¼ï¼Œè¯´æ˜åœ¨ï¼ˆ1ï¼‰ä¸­æŸ¥æ‰¾åˆ°äº†å…¶ä»–widgetä¸­åŒåçš„kcontrolï¼Œæˆ‘ä»¬ä¸ç”¨å†æ¬¡åˆ›å»ºï¼Œåªè¦å…±äº«è¯¥kcontrolå³å¯ã€‚<br>ï¼ˆ3ï¼‰ æ ‡å‡†çš„kcontrolåˆ›å»ºå‡½æ•°ï¼Œ<br>ï¼ˆ4ï¼‰ å¦‚æœwidgetæ”¯æŒautodisableç‰¹æ€§ï¼Œåˆ›å»ºä¸è¯¥kcontrolæ‰€å¯¹åº”çš„å½±å­widgetï¼Œè¯¥å½±å­widgetçš„ç±»å‹æ˜¯ï¼šsnd_soc_dapm_kcontrolã€‚<br>ï¼ˆ5ï¼‰ æ ‡å‡†çš„kcontrolåˆ›å»ºå‡½æ•°ï¼Œ<br>ï¼ˆ6ï¼‰ æŠŠæ‰€æœ‰å…±äº«è¯¥kcontrolçš„å½±å­widgetï¼ˆsnd_soc_dapm_kcontrolï¼‰ï¼ŒåŠ å…¥åˆ°kcontrolçš„private_dataå­—æ®µæ‰€æŒ‡å‘çš„dapm_kcontrol_dataç»“æ„ä¸­ã€‚<br>ï¼ˆ7ï¼‰ æŠŠåˆ›å»ºå¥½çš„kcontrolæŒ‡é’ˆèµ‹å€¼åˆ°widgetçš„kcontrolsæ•°ç»„ä¸­ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœkcontolæ”¯æŒautodisableç‰¹æ€§ï¼Œä¸€æ—¦kcontrolç”±äºsourceçš„å…³é—­è€Œè¢«è‡ªåŠ¨å…³é—­ï¼Œåˆ™ç”¨æˆ·ç©ºé—´åªèƒ½æ“ä½œè¯¥kcontrolçš„cacheå€¼ï¼Œåªæœ‰è¯¥kcontrolå†æ¬¡æ‰“å¼€æ—¶ï¼Œè¯¥cacheå€¼æ‰ä¼šè¢«çœŸæ­£åœ°æ›´æ–°åˆ°å¯„å­˜å™¨ä¸­ã€‚<br>ç°åœ¨ã€‚æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªwidgetæ‰€åŒ…å«çš„kcontrolæ‰€åšçš„å·¥ä½œï¼š<br>â€¢ å¾ªç¯æ¯ä¸€ä¸ªè¾“å…¥ç«¯ï¼Œä¸ºæ¯ä¸ªè¾“å…¥ç«¯ä¾æ¬¡æ‰§è¡Œä¸‹é¢çš„ä¸€ç³»åˆ—æ“ä½œ<br>â€¢ ä¸ºæ¯ä¸ªè¾“å…¥ç«¯åˆ›å»ºä¸€ä¸ªkcontrolï¼Œèƒ½å…±äº«çš„åˆ™ç›´æ¥ä½¿ç”¨åˆ›å»ºå¥½çš„kcontrol<br>â€¢ kcontrolçš„private_dataå­—æ®µä¿å­˜ç€è¿™äº›å…±äº«widgetçš„ä¿¡æ¯<br>â€¢ å¦‚æœæ”¯æŒautodisableç‰¹æ€§ï¼Œæ¯ä¸ªè¾“å…¥ç«¯è¿˜è¦é¢å¤–åœ°åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„snd_soc_dapm_kcontrolç±»å‹çš„å½±å­widgetï¼Œè¯¥å½±å­widgetä¹Ÿè®°å½•åœ¨private_dataå­—æ®µä¸­<br>â€¢ åˆ›å»ºå¥½çš„kcontrolä¼šä¾æ¬¡å­˜æ”¾åœ¨widgetçš„kcontrolsæ•°ç»„ä¸­ï¼Œä¾›è·¯å¾„çš„æ§åˆ¶å’ŒåŒ¹é…ä¹‹ç”¨ã€‚</p><h5 id="7-3-2-5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»"><a href="#7-3-2-5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»" class="headerlink" title="7.3.2.5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»"></a>7.3.2.5ã€ä¸ºwidgetå»ºç«‹è¿æ¥å…³ç³»</h5><p>å¦‚æœwidgetä¹‹é—´æ²¡æœ‰è¿æ¥å…³ç³»ï¼Œdapmå°±æ— æ³•å®ç°åŠ¨æ€çš„ç”µæºç®¡ç†å·¥ä½œï¼Œæ­£æ˜¯widgetä¹‹é—´æœ‰äº†è¿ç»“å…³ç³»ï¼Œè¿™äº›è¿æ¥å…³ç³»å½¢æˆäº†ä¸€æ¡æ‰€è°“çš„å®Œæˆçš„éŸ³é¢‘è·¯å¾„ï¼Œdapmå¯ä»¥é¡ºç€è¿™æ¡è·¯å¾„ï¼Œç»Ÿä¸€æ§åˆ¶è·¯å¾„ä¸Šæ‰€æœ‰widgetçš„ç”µæºçŠ¶æ€ï¼Œå‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œwidgetä¹‹é—´æ˜¯ä½¿ç”¨snd_soc_pathç»“æ„è¿›è¡Œè¿æ¥çš„ï¼Œé©±åŠ¨è¦åšçš„æ˜¯å®šä¹‰ä¸€ä¸ªsnd_soc_routeç»“æ„æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„æ¯ä¸ªæ¡ç›®æè¿°äº†ç›®çš„widgetçš„å’Œæºwidgetçš„åç§°ï¼Œä»¥åŠæ§åˆ¶è¿™ä¸ªè¿æ¥çš„kcontrolçš„åç§°ï¼Œæœ€ç»ˆï¼Œé©±åŠ¨ç¨‹åºä½¿ç”¨apiå‡½æ•°snd_soc_dapm_add_routesæ¥æ³¨å†Œè¿™äº›è¿æ¥ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯è¦åˆ†æè¯¥å‡½æ•°çš„å…·ä½“å®ç°æ–¹å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_add_routes</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> struct snd_soc_dapm_route *route, <span class="keyword">int</span> num)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> i, r, ret = <span class="number">0</span>;  </span><br><span class="line">  </span><br><span class="line">        mutex_lock_nested(&amp;dapm-&gt;card-&gt;dapm_mutex, SND_SOC_DAPM_CLASS_INIT);  </span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;  </span><br><span class="line">                r = snd_soc_dapm_add_route(dapm, route);  </span><br><span class="line">                ......  </span><br><span class="line">                route++;  </span><br><span class="line">        &#125;  </span><br><span class="line">        mutex_unlock(&amp;dapm-&gt;card-&gt;dapm_mutex);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> ret;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°åªæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¾æ¬¡å¯¹å‚æ•°ä¼ å…¥çš„æ•°ç»„è°ƒç”¨snd_soc_dapm_add_routeï¼Œä¸»è¦çš„å·¥ä½œç”±snd_soc_dapm_add_routeå®Œæˆã€‚æˆ‘ä»¬è¿›å…¥snd_soc_dapm_add_routeå‡½æ•°çœ‹çœ‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_dapm_add_route</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">const</span> struct snd_soc_dapm_route *route)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">wsource</span> = <span class="title">NULL</span>, *<span class="title">wsink</span> = <span class="title">NULL</span>, *<span class="title">w</span>;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">wtsource</span> = <span class="title">NULL</span>, *<span class="title">wtsink</span> = <span class="title">NULL</span>;</span>  </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *sink;  </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *source;  </span><br><span class="line">        ......  </span><br><span class="line">        list_for_each_entry(w, &amp;dapm-&gt;card-&gt;widgets, <span class="built_in">list</span>) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (!wsink &amp;&amp; !(<span class="built_in">strcmp</span>(w-&gt;name, sink))) &#123;  </span><br><span class="line">                        wtsink = w;  </span><br><span class="line">                        <span class="keyword">if</span> (w-&gt;dapm == dapm)  </span><br><span class="line">                                wsink = w;  </span><br><span class="line">                        <span class="keyword">continue</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">if</span> (!wsource &amp;&amp; !(<span class="built_in">strcmp</span>(w-&gt;name, source))) &#123;  </span><br><span class="line">                        wtsource = w;  </span><br><span class="line">                        <span class="keyword">if</span> (w-&gt;dapm == dapm)  </span><br><span class="line">                                wsource = w;  </span><br><span class="line">                &#125;  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æˆ‘å†æ¬¡çœç•¥äº†å…³äºåç§°å‰ç¼€çš„å¤„ç†éƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨widgetçš„åå­—æ¥æ¯”è¾ƒï¼Œéå†å£°å¡çš„widgetsé“¾è¡¨ï¼Œæ‰¾å‡ºæºwidgetå’Œç›®çš„widgetçš„æŒ‡é’ˆï¼Œè¿™æ®µä»£ç è™½ç„¶æ­£ç¡®ï¼Œä½†æˆ‘æ€»æ„Ÿè§‰å°‘äº†ä¸€ä¸ªåˆ¤æ–­é€€å‡ºå¾ªç¯çš„æ¡ä»¶ï¼Œå¦‚æœé“¾è¡¨çš„å¼€å¤´å°±æ‰¾åˆ°äº†ä¸¤ä¸ªwidgetï¼Œè¿˜æ˜¯è¦éå†æ•´ä¸ªé“¾è¡¨æ‰ç»“æŸå¾ªç¯ï¼Œå¥½æµªè´¹æ—¶é—´ã€‚<br>ä¸‹é¢ï¼Œå¦‚æœåœ¨æœ¬dapm contextä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä½¿ç”¨åˆ«çš„dapm contextä¸­æ‰¾åˆ°çš„widgetï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_route()]</span><br><span class="line"><span class="keyword">if</span> (!wsink)  </span><br><span class="line">        wsink = wtsink;  </span><br><span class="line"><span class="keyword">if</span> (!wsource)  </span><br><span class="line">        wsource = wtsource;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œä½¿ç”¨æ¥å¢åŠ ä¸€æ¡è¿æ¥ä¿¡æ¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_route()]</span><br><span class="line">        ret = snd_soc_dapm_add_path(dapm, wsource, wsink, route-&gt;control,  </span><br><span class="line">                route-&gt;connected);  </span><br><span class="line">        ......  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>snd_soc_dapm_add_pathå‡½æ•°æ˜¯æ•´ä¸ªè°ƒç”¨é“¾æ¡ä¸­çš„å…³é”®ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_dapm_add_path</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_widget *wsource, struct snd_soc_dapm_widget *wsink,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">char</span> *control,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> (*connected)</span><span class="params">(struct snd_soc_dapm_widget *source,  </span></span></span><br><span class="line">                         struct snd_soc_dapm_widget *sink))  </span><br><span class="line">&#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> *<span class="title">path</span>;</span>  </span><br><span class="line">        <span class="keyword">int</span> ret;  </span><br><span class="line">  </span><br><span class="line">        path = kzalloc(<span class="keyword">sizeof</span>(struct snd_soc_dapm_path), GFP_KERNEL);  </span><br><span class="line">        <span class="keyword">if</span> (!path)  </span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;  </span><br><span class="line">  </span><br><span class="line">        path-&gt;source = wsource;  </span><br><span class="line">        path-&gt;sink = wsink;  </span><br><span class="line">        path-&gt;connected = connected;  </span><br><span class="line">        INIT_LIST_HEAD(&amp;path-&gt;<span class="built_in">list</span>);  </span><br><span class="line">        INIT_LIST_HEAD(&amp;path-&gt;list_kcontrol);  </span><br><span class="line">        INIT_LIST_HEAD(&amp;path-&gt;list_source);  </span><br><span class="line">        INIT_LIST_HEAD(&amp;path-&gt;list_sink);</span><br></pre></td></tr></table></figure><p>å‡½æ•°çš„ä¸€å¼€å§‹ï¼Œé¦–å…ˆä¸ºè¿™ä¸ªè¿æ¥åˆ†é…äº†ä¸€ä¸ªsnd_soc_pathç»“æ„ï¼Œpathçš„sourceå’Œsinkå­—æ®µåˆ†åˆ«æŒ‡å‘æºwidgetå’Œç›®çš„widgetï¼Œconnectedå­—æ®µä¿å­˜connectedå›è°ƒå‡½æ•°ï¼Œåˆå§‹åŒ–å‡ ä¸ªsnd_soc_pathç»“æ„ä¸­çš„å‡ ä¸ªé“¾è¡¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line"><span class="comment">/* check for external widgets */</span>  </span><br><span class="line">        <span class="keyword">if</span> (wsink-&gt;id == snd_soc_dapm_input) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (wsource-&gt;id == snd_soc_dapm_micbias ||  </span><br><span class="line">                        wsource-&gt;id == snd_soc_dapm_mic ||  </span><br><span class="line">                        wsource-&gt;id == snd_soc_dapm_line ||  </span><br><span class="line">                        wsource-&gt;id == snd_soc_dapm_output)  </span><br><span class="line">                        wsink-&gt;ext = <span class="number">1</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (wsource-&gt;id == snd_soc_dapm_output) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (wsink-&gt;id == snd_soc_dapm_spk ||  </span><br><span class="line">                        wsink-&gt;id == snd_soc_dapm_hp ||  </span><br><span class="line">                        wsink-&gt;id == snd_soc_dapm_line ||  </span><br><span class="line">                        wsink-&gt;id == snd_soc_dapm_input)  </span><br><span class="line">                        wsource-&gt;ext = <span class="number">1</span>;  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰å¤–éƒ¨è¿æ¥å…³ç³»ï¼Œå¦‚æœæœ‰ï¼Œç½®ä½widgetçš„extå­—æ®µã€‚åˆ¤æ–­æ–¹æ³•ä»ä»£ç ä¸­å¯ä»¥æ–¹ä¾¿åœ°çœ‹å‡ºï¼š<br>ç›®çš„widgetæ˜¯ä¸€ä¸ªè¾“å…¥è„šï¼Œå¦‚æœæºwidgetæ˜¯micã€lineã€micbiasæˆ–outputï¼Œåˆ™è®¤ä¸ºç›®çš„widgetå…·æœ‰å¤–éƒ¨è¿æ¥å…³ç³»ã€‚<br>æºwidgetæ˜¯ä¸€ä¸ªè¾“å‡ºè„šï¼Œå¦‚æœç›®çš„widgetæ˜¯spkã€hpã€lineæˆ–inputï¼Œåˆ™è®¤ä¸ºæºwidgetå…·æœ‰å¤–éƒ¨è¿æ¥å…³ç³»ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line">dapm_mark_dirty(wsource, <span class="string">"Route added"</span>);  </span><br><span class="line">dapm_mark_dirty(wsink, <span class="string">"Route added"</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/* connect static paths */</span>  </span><br><span class="line"><span class="keyword">if</span> (control == <span class="literal">NULL</span>) &#123;  </span><br><span class="line">        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">        list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);  </span><br><span class="line">        list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);  </span><br><span class="line">        path-&gt;connect = <span class="number">1</span>;  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºå¢åŠ äº†è¿ç»“å…³ç³»ï¼Œæ‰€ä»¥æŠŠæºwidgetå’Œç›®çš„widgetåŠ å…¥åˆ°dapm_dirtyé“¾è¡¨ä¸­ã€‚å¦‚æœæ²¡æœ‰kcontrolæ¥æ§åˆ¶è¯¥è¿æ¥å…³ç³»ï¼Œåˆ™è¿™æ˜¯ä¸€ä¸ªé™æ€è¿æ¥ï¼Œç›´æ¥ç”¨pathæŠŠå®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ã€‚åœ¨æ¥ç€å¾€ä¸‹çœ‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line"><span class="comment">/* connect dynamic paths */</span>  </span><br><span class="line"><span class="keyword">switch</span> (wsink-&gt;id) &#123;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_adc:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_dac:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_pga:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_out_drv:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_input:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_output:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_siggen:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_micbias:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_vmid:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_pre:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_post:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_supply:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_regulator_supply:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_clock_supply:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_aif_in:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_aif_out:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_dai_in:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_dai_out:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_dai_link:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_kcontrol:  </span><br><span class="line">        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">        list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);  </span><br><span class="line">        list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);  </span><br><span class="line">        path-&gt;connect = <span class="number">1</span>;  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ç›®çš„widgetæ¥åˆ¤æ–­ï¼Œå¦‚æœå±äºä»¥ä¸Šè¿™äº›ç±»å‹ï¼Œç›´æ¥æŠŠå®ƒä»¬è¿æ¥åœ¨ä¸€èµ·å³å¯ï¼Œè¿™æ®µæ„Ÿè§‰æœ‰ç‚¹å¤šä½™ï¼Œå› ä¸ºé€šå¸¸ä»¥ä¸Šè¿™äº›ç±»å‹çš„widgetæœ¬æ¥ä¹Ÿæ²¡æœ‰kcontrolï¼Œç›´æ¥ç”¨ä¸Šä¸€æ®µä»£ç å°±å¯ä»¥äº†ï¼Œä¹Ÿè®¸æ˜¯dapmçš„ä½œè€…ä»¬æƒ³ç€ä»¥åå¯èƒ½ä¼šæœ‰æ‰€æ‰©å±•å§ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mux:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_virt_mux:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_value_mux:  </span><br><span class="line">        ret = dapm_connect_mux(dapm, wsource, wsink, path, control,  </span><br><span class="line">                &amp;wsink-&gt;kcontrol_news[<span class="number">0</span>]);  </span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)  </span><br><span class="line">                <span class="keyword">goto</span> err;  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_switch:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mixer:  </span><br><span class="line"><span class="keyword">case</span> snd_soc_dapm_mixer_named_ctl:  </span><br><span class="line">        ret = dapm_connect_mixer(dapm, wsource, wsink, path, control);  </span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)  </span><br><span class="line">                <span class="keyword">goto</span> err;  </span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>ç›®çš„widgetå¦‚æœæ˜¯mixerå’Œmuxç±»å‹ï¼Œåˆ†åˆ«ç”¨dapm_connect_mixerå’Œdapm_connect_muxå‡½æ•°å®Œæˆè¿æ¥å·¥ä½œï¼Œè¿™ä¸¤ä¸ªå‡½æ•°æˆ‘ä»¬åé¢å†è®²ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c:snd_soc_dapm_add_path()]</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_hp:  </span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_mic:  </span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_line:  </span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_spk:  </span><br><span class="line">                list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">                list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);  </span><br><span class="line">                list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);  </span><br><span class="line">                path-&gt;connect = <span class="number">0</span>;  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">err:  </span><br><span class="line">        kfree(path);  </span><br><span class="line">        <span class="keyword">return</span> ret;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hpã€micã€lineå’Œspkè¿™å‡ ç§widgetå±äºå¤–éƒ¨å™¨ä»¶ï¼Œä¹Ÿåªæ˜¯ç®€å•åœ°è¿æ¥åœ¨ä¸€èµ·ï¼Œä¸è¿‡connectå­—æ®µé»˜è®¤ä¸ºæ˜¯æœªè¿æ¥çŠ¶æ€ã€‚<br>ç°åœ¨ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹ç›®çš„widgetæ˜¯mixerå’Œmuxè¿™ä¸¤ç§ç±»å‹æ—¶çš„è¿æ¥æ–¹å¼ï¼š<br>dapm_connect_mixer ç”¨è¯¥å‡½æ•°è¿æ¥ä¸€ä¸ªç›®çš„widgetä¸ºmixerç±»å‹çš„æ‰€æœ‰è¾“å…¥ç«¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_connect_mixer</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_widget *src, struct snd_soc_dapm_widget *dest,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_path *path, <span class="keyword">const</span> <span class="keyword">char</span> *control_name)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> i;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">/* search for mixer kcontrol */</span>  </span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dest-&gt;num_kcontrols; i++) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(control_name, dest-&gt;kcontrol_news[i].name)) &#123;  </span><br><span class="line">                        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">                        list_add(&amp;path-&gt;list_sink, &amp;dest-&gt;sources);  </span><br><span class="line">                        list_add(&amp;path-&gt;list_source, &amp;src-&gt;sinks);  </span><br><span class="line">                        path-&gt;name = dest-&gt;kcontrol_news[i].name;  </span><br><span class="line">                        dapm_set_path_status(dest, path, i);  </span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> -ENODEV;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨éœ€è¦ç”¨æ¥è¿æ¥çš„kcontrolçš„åå­—ï¼Œå’Œç›®çš„widgetä¸­çš„kcontrolæ¨¡æ¿æ•°ç»„ä¸­çš„åå­—ç›¸æ¯”è¾ƒï¼Œæ‰¾å‡ºè¯¥kcontrolåœ¨widgetä¸­çš„ç¼–å·ï¼Œpathçš„åå­—è®¾ç½®ä¸ºè¯¥kcontrolçš„åå­—ï¼Œç„¶åç”¨dapm_set_path_statuså‡½æ•°æ¥åˆå§‹åŒ–è¯¥è¾“å…¥ç«¯çš„è¿æ¥çŠ¶æ€ã€‚è¿æ¥ä¸¤ä¸ªwidgetçš„é“¾è¡¨æ“ä½œå’Œå…¶ä»–widgetæ˜¯ä¸€æ ·çš„ã€‚</p><p>dapm_connect_mux ç”¨è¯¥å‡½æ•°è¿æ¥ä¸€ä¸ªç›®çš„widgetæ˜¯muxç±»å‹çš„æ‰€æœ‰è¾“å…¥ç«¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/sound/soc/soc-dapm.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dapm_connect_mux</span><span class="params">(struct snd_soc_dapm_context *dapm,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_widget *src, struct snd_soc_dapm_widget *dest,  </span></span></span><br><span class="line"><span class="function"><span class="params">        struct snd_soc_dapm_path *path, <span class="keyword">const</span> <span class="keyword">char</span> *control_name,  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> struct snd_kcontrol_new *kcontrol)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">soc_enum</span> *<span class="title">e</span> = (<span class="title">struct</span> <span class="title">soc_enum</span> *)<span class="title">kcontrol</span>-&gt;<span class="title">private_value</span>;</span>  </span><br><span class="line">        <span class="keyword">int</span> i;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; e-&gt;max; i++) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (!(<span class="built_in">strcmp</span>(control_name, e-&gt;texts[i]))) &#123;  </span><br><span class="line">                        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);  </span><br><span class="line">                        list_add(&amp;path-&gt;list_sink, &amp;dest-&gt;sources);  </span><br><span class="line">                        list_add(&amp;path-&gt;list_source, &amp;src-&gt;sinks);  </span><br><span class="line">                        path-&gt;name = (<span class="keyword">char</span>*)e-&gt;texts[i];  </span><br><span class="line">                        dapm_set_path_status(dest, path, <span class="number">0</span>);  </span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> -ENODEV;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œmixerç±»å‹ä¸€æ ·ç”¨åå­—è¿›è¡ŒåŒ¹é…ï¼Œåªä¸è¿‡muxç±»å‹çš„kcontrolåªéœ€ä¸€ä¸ªï¼Œæ‰€ä»¥è¦é€šè¿‡private_valueå­—æ®µæ‰€æŒ‡å‘çš„soc_enumç»“æ„æ‰¾å‡ºåŒ¹é…çš„è¾“å…¥è„šç¼–å·ï¼Œæœ€åä¹Ÿæ˜¯é€šè¿‡dapm_set_path_statuså‡½æ•°æ¥åˆå§‹åŒ–è¯¥è¾“å…¥ç«¯çš„è¿æ¥çŠ¶æ€ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªkcontrolï¼Œæ‰€ä»¥ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯0ã€‚è¿æ¥ä¸¤ä¸ªwidgetçš„é“¾è¡¨æ“ä½œå’Œå…¶ä»–widgetä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚<br>dapm_set_path_status è¯¥å‡½æ•°æ ¹æ®ä¼ å…¥widgetä¸­çš„kcontrolç¼–å·ï¼Œè¯»å–å®é™…å¯„å­˜å™¨çš„å€¼ï¼Œæ ¹æ®å¯„å­˜å™¨çš„å€¼æ¥åˆå§‹åŒ–è¿™ä¸ªpathæ˜¯å¦å¤„äºè¿æ¥çŠ¶æ€ï¼Œè¯¦ç»†çš„ä»£ç è¿™é‡Œå°±ä¸è´´äº†ã€‚<br>å½“widgetä¹‹é—´é€šè¿‡pathè¿›è¡Œè¿æ¥ä¹‹åï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/210-Audio-system-snd_soc_dapm_path.png" alt="Alt text"></p><p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸ºå£°å¡åˆ›å»ºå¹¶åˆå§‹åŒ–å¥½äº†æ‰€éœ€çš„widgetï¼Œå„ä¸ªwidgetä¹Ÿé€šè¿‡pathè¿æ¥åœ¨äº†ä¸€èµ·ï¼Œæ¥ä¸‹æ¥ï¼Œdapmç­‰å¾…ç”¨æˆ·çš„æŒ‡ä»¤ï¼Œä¸€æ—¦æŸä¸ªdapm kcontrolè¢«ç”¨æˆ·ç©ºé—´æ”¹å˜ï¼Œåˆ©ç”¨è¿™äº›è¿æ¥å…³ç³»ï¼Œdapmä¼šé‡æ–°åˆ›å»ºéŸ³é¢‘è·¯å¾„ï¼Œè„±ç¦»éŸ³é¢‘è·¯å¾„çš„widgetä¼šè¢«ä¸‹ç”µï¼ŒåŠ å…¥éŸ³é¢‘è·¯å¾„çš„widgetä¼šè¢«ä¸Šç”µï¼Œæ‰€æœ‰çš„ä¸Šä¸‹ç”µåŠ¨ä½œéƒ½ä¼šè‡ªåŠ¨å®Œæˆï¼Œç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºæ— éœ€å…³æ³¨è¿™äº›å˜åŒ–ï¼Œå®ƒåªç®¡æŒ‰éœ€è¦æ”¹å˜æŸä¸ªdapm kcontrolå³å¯ã€‚</p><h4 id="ï¼ˆå…«ï¼‰ã€tinyplay-playbackã€capture"><a href="#ï¼ˆå…«ï¼‰ã€tinyplay-playbackã€capture" class="headerlink" title="ï¼ˆå…«ï¼‰ã€tinyplay playbackã€capture"></a>ï¼ˆå…«ï¼‰ã€tinyplay playbackã€capture</h4><h5 id="8-1ã€tinyplay-playback"><a href="#8-1ã€tinyplay-playback" class="headerlink" title="8.1ã€tinyplay playback"></a>8.1ã€tinyplay playback</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/211-tiny-capture.png" alt="Alt text"></p><p>æœ‰æ—¶åºå›¾å¯çŸ¥ï¼šä¸»è¦æ¶‰åŠpcm_open()ã€pcm_write()ã€pcm_prepare()ã€pcm_start()ã€‚</p><h5 id="8-1-1ã€ä½¿ç”¨è€³æœºæ’­æ”¾"><a href="#8-1-1ã€ä½¿ç”¨è€³æœºæ’­æ”¾" class="headerlink" title="8.1.1ã€ä½¿ç”¨è€³æœºæ’­æ”¾"></a>8.1.1ã€ä½¿ç”¨è€³æœºæ’­æ”¾</h5><ol><li>å¯åŠ¨éŸ³é¢‘æ’­æ”¾</li><li>å¯ç”¨ Rx codec è·¯å¾„<br>tinymix â€˜RX1 MIX1 INP1â€™ â€˜RX1â€™<br>tinymix â€˜RX2 MIX1 INP1â€™ â€˜RX2â€™<br>tinymix â€˜RDAC2 MUXâ€™ â€˜RX2â€™<br>tinymix â€˜HPHLâ€™ â€˜Switchâ€™<br>tinymix â€˜HPHRâ€™ â€˜Switchâ€™<br>tinymix â€˜MI2S_RX Channelsâ€™ â€˜Two</li><li>å¯ç”¨ç”¨äºé€šè¿‡ MI2S æ¥å£è¿›è¡Œæ’­æ”¾çš„ DSP AFE<br>tinymix â€˜PRI_MI2S_RX Audio Mixer MultiMedia1â€™ 1</li><li>æ’­æ”¾ PCM éŸ³é¢‘<br>tinyplay<filename.wav></filename.wav></li><li>åœæ­¢éŸ³é¢‘æ’­æ”¾</li><li>ç¦ç”¨æ¥æ”¶ Rx codec è·¯å¾„<br>tinymix â€˜RX1 MIX1 INP1â€™ â€˜ZEROâ€™<br>tinymix â€˜RX2 MIX1 INP1â€™ â€˜ZEROâ€™<br>tinymix â€˜RDAC2 MUXâ€™ â€˜ZEROâ€™<br>tinymix â€˜HPHLâ€™ â€˜ZEROâ€™<br>tinymix â€˜HPHRâ€™ â€˜ZEROâ€™<br>tinymix â€˜MI2S_RX Channelsâ€™ â€˜Oneâ€™</li><li>ç¦ç”¨ç”¨äºé€šè¿‡ I2S æ¥å£è¿›è¡ŒéŸ³é¢‘æ’­æ”¾çš„ DSP AFE<br>tinymix â€˜PRI_MI2S_RX Audio Mixer MultiMedia1â€™ 0</li></ol><h5 id="8-2ã€tinyplay-capture"><a href="#8-2ã€tinyplay-capture" class="headerlink" title="8.2ã€tinyplay capture"></a>8.2ã€tinyplay capture</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/212-tiny-playback.png" alt="Alt text"></p><p>æœ‰æ—¶åºå›¾å¯çŸ¥ï¼šä¸»è¦æ¶‰åŠpcm_open()ã€pcm_read()ã€pcm_start()ã€‚</p><h5 id="8-2-1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶"><a href="#8-2-1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶" class="headerlink" title="8.2.1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶"></a>8.2.1ã€ä½¿ç”¨éŸ³é¢‘å½•åˆ¶</h5><ol><li>è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š<br>//Enable DSP AFE for Audio Recording over I2S<br>tinymix â€˜MultiMedia1 Mixer TERT_MI2S_TXâ€™ 1<br>//Enable Codec TX Path<br>tinymix â€˜DEC1 MUXâ€™ â€˜ADC2â€™<br>tinymix â€˜ADC2 MUXâ€™ â€˜INP2â€™</li><li>å¯åŠ¨å½•éŸ³åŠŸèƒ½ï¼š<br>tinycap /data/rec.wav</li><li>ç¦ç”¨ HeadsetX è®¾å¤‡ (AMIC2)ï¼š<br>tinymix â€˜MultiMedia1 Mixer TERT_MI2S_TXâ€™ 0<br>tinymix â€˜DEC1 MUXâ€™ â€˜ZEROâ€™<br>tinymix â€˜ADC2 MUXâ€™ â€˜ZEROâ€™</li></ol><h4 id="ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¹ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://zhuanlan.zhihu.com/p/27480328" target="_blank" rel="noopener">AndroidéŸ³é¢‘æ¨¡å—å¯åŠ¨æµç¨‹åˆ†æ</a><br><a href="https://zhuanlan.zhihu.com/jhuster" target="_blank" rel="noopener">Jhusterçš„ä¸“æ â€‹ AndroidéŸ³é¢‘å¼€å‘</a><br><a href="http://thinks.me/2016/09/13/audio_qcom_offload/" target="_blank" rel="noopener">é«˜é€šaudio offloadå­¦ä¹  | Thinking</a><br><a href="https://blog.csdn.net/droidphone/article/category/1118446" target="_blank" rel="noopener">DroidPhoneçš„ä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8866071" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„1-CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8982771" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„2-ASoc - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8995163" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„3-Pcm - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8999364" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„4-å£°å¡æ§åˆ¶ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59180272" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šé€»è¾‘è®¾å¤‡ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59170418" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šç‰©ç†é“¾è·¯ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/12812.html" target="_blank" rel="noopener">ä¸“æ ï¼šMultiMediaæ¡†æ¶æ€»ç»“(åŸºäº6.0æºç ) - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/60890534" target="_blank" rel="noopener">Android éŸ³é¢‘ç³»ç»Ÿï¼šä» AudioTrack åˆ° AudioFlinger - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/azloong/article/category/778492" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ALSA-Android Audio</a><br><a href="https://blog.csdn.net/azloong/article/category/777239" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ANDROIDéŸ³é¢‘ç³»ç»Ÿ</a><br><a href="https://winddoing.github.io/2017/07/10/audio_alsa/" target="_blank" rel="noopener">Audioé©±åŠ¨æ€»ç»“â€“ALSA | Winddoingâ€™s Blog</a><br><a href="http://www.cnblogs.com/muhe221/articles/4461543.html" target="_blank" rel="noopener">audio HAL - ç‰§ å¤© - åšå®¢å›­</a><br><a href="https://blog.csdn.net/xuesen_lin/article/category/1390680" target="_blank" rel="noopener">æ—å­¦æ£®çš„Androidä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">æ·±å…¥å‰–æAndroidéŸ³é¢‘ - CSDNåšå®¢Yangwen123</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">æ’­æ”¾æ¡†æ¶ - æ ‡ç­¾ - Tocy - åšå®¢å›­</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57415505" target="_blank" rel="noopener">Android-7.0-Nuplayeræ¦‚è¿° - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/56961370" target="_blank" rel="noopener">Android-7.0-Nuplayer-å¯åŠ¨æµç¨‹ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53386010" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-Nuplayerï¼ˆ1ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53397945" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-AHandler AMessage ALooper - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/category/6344583" target="_blank" rel="noopener">Android N Audioæ’­æ”¾ startçœŸé¢ç›®- (å…­ç¯‡) CSDNåšå®¢</a><br><a href="https://blog.csdn.net/nonmarking/article/details/78746671" target="_blank" rel="noopener">æ·±å…¥ç†è§£AndroidéŸ³è§†é¢‘åŒæ­¥æœºåˆ¶ï¼ˆäº”ç¯‡ï¼‰NuPlayerçš„avsyncé€»è¾‘ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/u014310046/article/category/6571854" target="_blank" rel="noopener">wangyfçš„ä¸“æ  - CSDNåšå®¢-MT6737 Android N å¹³å° Audioç³»ç»Ÿå­¦ä¹ </a><br><a href="https://blog.csdn.net/xiashaohua/article/details/53638780" target="_blank" rel="noopener">Android 7.0 Audio: Mediaplayer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/xiashaohua/article/category/6549668" target="_blank" rel="noopener">Android 7.0 Audio-ç›¸å…³ç±»æµ…æ- CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/details/59119144" target="_blank" rel="noopener">Android N Audioæ’­æ”¾å…­ï¼šå¦‚ä½•è¯»å–buffer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/78007568" target="_blank" rel="noopener">Fuchsia OSä¸­çš„RPCæœºåˆ¶-FIDL - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/linhaostudy/category/1145404.html" target="_blank" rel="noopener">é«˜é€šAudioä¸­ASOCçš„codecé©±åŠ¨ - yooooooo - åšå®¢å›­</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/05/15/Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ/">http://zhoujinjian.cc/2018/05/15/Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/05/01/Audio Systemï¼ˆ1ï¼‰ï¼šLinux && Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ/" title="Audio Systemï¼ˆ1ï¼‰ï¼šLinux && Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ"><i class="iconfont icon-prev"></i>Audio Systemï¼ˆ1ï¼‰ï¼šLinux && Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2018/05/25/Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system[éŸ³é¢‘ç³»ç»Ÿ]åˆ†æ/" title="Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ">Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">24</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.08.jpg" alt="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/" title="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.25.jpg" alt="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</h3><span class="item__text">2018-09-06</span></div></a></li><li class="latest-post-item"><a href="/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/" title="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" alt="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</h3><span class="item__text">2018-08-30</span></div></a></li><li class="latest-post-item"><a href="/2018/08/16/Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ/" title="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.22.jpg" alt="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ</h3><span class="item__text">2018-08-16</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">350.7k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>