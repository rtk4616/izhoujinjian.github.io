<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/05/25/Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.15.jpg" alt="Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ"></div><header class="post__info"><h1 class="post__title">Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://www.github.com/izhoujinjian">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-05-25</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¸€-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger"><span class="toc-text">(ä¸€)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-0ã€æ€»ä½“æ¡†æ¶å›¾"><span class="toc-text">1.0ã€æ€»ä½“æ¡†æ¶å›¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1ã€AudioFlinger"><span class="toc-text">1.1ã€AudioFlinger</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-1-AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ"><span class="toc-text">1.1.1 AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†"><span class="toc-text">1.2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1ã€åŠ è½½è®¾å¤‡loadHwModule"><span class="toc-text">1.2.1ã€åŠ è½½è®¾å¤‡loadHwModule()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput"><span class="toc-text">1.2.2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev-l"><span class="toc-text">1.2.2.1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev_l()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream"><span class="toc-text">1.2.2.2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-2-1ã€audio-hw-device-t-gt-gt-open-output-stream"><span class="toc-text">1.2.2.2.1ã€audio_hw_device_t-&gt;-&gt;open_output_stream()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹-PlaybackThread"><span class="toc-text">1.2.2.3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹(PlaybackThread)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3ã€AudioFlinger-éŸ³é¢‘æµç®¡ç†"><span class="toc-text">1.2.3ã€AudioFlinger éŸ³é¢‘æµç®¡ç†</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#äºŒ-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService"><span class="toc-text">(äºŒ)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1ã€Step-1-åˆ›å»ºAudioCommandThreadçº¿ç¨‹"><span class="toc-text">2.1ã€Step 1:åˆ›å»ºAudioCommandThreadçº¿ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2ã€Step-2-åˆ›å»ºAudioPolicyClientã€-AudioPolicyManager"><span class="toc-text">2.2ã€Step 2: åˆ›å»ºAudioPolicyClientã€ AudioPolicyManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3ã€åˆ›å»ºAudioPolicyManager"><span class="toc-text">2.3ã€åˆ›å»ºAudioPolicyManager()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1ã€åŠ è½½audio-policy-configuration-xmlæˆ–è€…audio-policy-confé…ç½®æ–‡ä»¶"><span class="toc-text">2.3.1ã€åŠ è½½audio_policy_configuration.xmlæˆ–è€…audio_policy.confé…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves-speakerDrcEnabled"><span class="toc-text">2.3.2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves(speakerDrcEnabled)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3ã€åŠ è½½audio-policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule"><span class="toc-text">2.3.3ã€åŠ è½½audio policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream"><span class="toc-text">2.3.4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-5ã€-æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs"><span class="toc-text">2.3.5ã€ æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4ã€æ€»ç»“"><span class="toc-text">2.4ã€æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¸‰-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack"><span class="toc-text">(ä¸‰)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-AudioTrack-amp-AudioFlinger-ç›¸å…³ç±»"><span class="toc-text">3.1. AudioTrack &amp; AudioFlinger ç›¸å…³ç±»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-AudioTrack-æ„é€ è¿‡ç¨‹"><span class="toc-text">3.2. AudioTrack æ„é€ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-AudioTrack-æ•°æ®å†™å…¥"><span class="toc-text">3.3. AudioTrack æ•°æ®å†™å…¥</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-AudioTrack-å†™æ•°æ®æµç¨‹"><span class="toc-text">3.3. 1. AudioTrack å†™æ•°æ®æµç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-AudioFlinger-è¯»æ•°æ®æµç¨‹"><span class="toc-text">3.3. 2. AudioFlinger è¯»æ•°æ®æµç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-3-ç¯å½¢-FIFO-ç®¡ç†"><span class="toc-text">3.3. 3. ç¯å½¢ FIFO ç®¡ç†</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å››-ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹"><span class="toc-text">(å››)ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div><hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/audio.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a><br><a href="https://blog.csdn.net/xuesen_lin/article/category/1390680" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - æ—å­¦æ£®çš„Androidä¸“æ ã€‘</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Yangwen123 - æ·±å…¥å‰–æAndroidéŸ³é¢‘ç³»ç»Ÿã€‘</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - Zyuanyun - Android éŸ³é¢‘ç³»ç»Ÿï¼šä» AudioTrack åˆ° AudioFlingerã€‘</a><br>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆKernel-3.18ï¼‰ï¼š<br><a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br><a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener">Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><hr><p>æºç ï¼ˆä¸»è¦æºç è·¯å¾„ï¼‰ï¼š</p><blockquote><p>User space audio code æºç ï¼š</p></blockquote><p>â€¢ <strong>/hardware/qcom/audio/hal/ â€“ (Audio é«˜é€šHAL æºç )</strong></p><p>â€¢ <strong>/libhardware/modules/audio/ â€“ (Audio åŸç”ŸHAL æºç )</strong></p><p>â€¢ <strong>/external/tinyalsa/ â€“ (tinymix, tinyplay, tinycap æºç )</strong></p><p>â€¢ <strong>/vendor/qcom/proprietary/mm-audio/ â€“ (QTI OMX audio encoder and decoders æºç ï¼Œæœªå…¬å¼€)</strong></p><p>â€¢ <strong>/frameworks/av/media/audioserver/ â€“ (Audioserver æºç )</strong></p><p>â€¢ <strong>/hardware/libhardware_legacy/audio â€“ (Audio legacy æºç )</strong></p><p>â€¢ <strong>/frameworks/av/media/libstagefright/ â€“ (Google Stagefright å¤šåª’ä½“æ¡†æ¶æºç )</strong></p><p>â€¢ <strong>/frameworks/av/services/audioflinger/ â€“ (Audioflinger ç›¸å…³æºç )</strong></p><p>â€¢ <strong>/external/bluetooth/bluedroid/ â€“ (A2DP audio HAL ç›¸å…³æºç )</strong>/</p><p>â€¢ <strong>/hardware/libhardware/modules/usbaudio/ â€“ (USB HAL æºç )</strong>/</p><p>â€¢ <strong>/vendor/qcom/proprietary/wfd/mm/source/framework/src/ â€“ (Wi-Fi Display (WFD)ã€ WFDMMSourceAudioSource.cppï¼Œæœªå…¬å¼€)</strong></p><p>â€¢ <strong>/system/core/include/system/ â€“ (audio.h)</strong>/</p><h4 id="ä¸€-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger"><a href="#ä¸€-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger" class="headerlink" title="(ä¸€)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger"></a>(ä¸€)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioFlinger</h4><h5 id="1-0ã€æ€»ä½“æ¡†æ¶å›¾"><a href="#1-0ã€æ€»ä½“æ¡†æ¶å›¾" class="headerlink" title="1.0ã€æ€»ä½“æ¡†æ¶å›¾"></a>1.0ã€æ€»ä½“æ¡†æ¶å›¾</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/31-Audio-system-Android-Linux-arc.png" alt="Alt text"></p><p>ç³»ç»Ÿå¯åŠ¨æ—¶å°†æ‰§è¡Œ /system/etc/init/audioserver.rc ï¼Œè¿è¡Œ /system/bin/ ç›®å½•ä¸‹çš„ audioserver æœåŠ¡ã€‚audioserver.rc å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\audioserver\audioserver.rc]</span><br><span class="line">service audioserver /system/bin/audioserver</span><br><span class="line">    class main</span><br><span class="line">    user audioserver</span><br><span class="line">    # media gid needed for /dev/fm (radio ) and for  /data/misc/media (tee)</span><br><span class="line">    group audio radio camera drmpc inet media mediarm net_bt net_bt_admin net_bw_acct</span><br><span class="line">    ioprio rt 4</span><br><span class="line">    writepid /dev/cpuset/forground/tasks /dev/stune/foreground/tasks</span><br></pre></td></tr></table></figure><p>audioserver æ˜¯ç”±åŒç›®å½•ä¸‹main_audioserverç¼–è¯‘ç”Ÿæˆçš„ã€‚</p><h5 id="1-1ã€AudioFlinger"><a href="#1-1ã€AudioFlinger" class="headerlink" title="1.1ã€AudioFlinger"></a>1.1ã€AudioFlinger</h5><p>AudioFlingeræ˜¯æ•´ä¸ªéŸ³é¢‘ç³»ç»Ÿçš„æ ¸å¿ƒä¸éš¾ç‚¹ã€‚ä½œä¸ºAndroidç³»ç»Ÿä¸­çš„éŸ³é¢‘ä¸­æ¢ï¼Œå®ƒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼Œå¯åˆ°æ‰¿ä¸Š(ä¸ºä¸Šå±‚æä¾›è®¿é—®æ¥å£)å¯ä¸‹(é€šè¿‡HALæ¥ç®¡ç†éŸ³é¢‘è®¾å¤‡)çš„ä½œç”¨ã€‚åªæœ‰ç†è§£äº†AudioFlingerï¼Œæ‰èƒ½ä»¥æ­¤ä¸ºåŸºç¡€æ›´å¥½åœ°æ·±å…¥åˆ°å…¶å®ƒæ¨¡å—ï¼Œå¹¶ä¸”Audioserveræœ€å…ˆå¯åŠ¨çš„ä¹Ÿæ˜¯AudioFlingerï¼Œå› è€Œæˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨å‰é¢è¿›è¡Œåˆ†æã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\audioserver\main_audioserver.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (doLog &amp;&amp; (childPid = fork()) != <span class="number">0</span>) &#123;</span><br><span class="line">    ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// all other services</span></span><br><span class="line">        <span class="keyword">if</span> (doLog) &#123;</span><br><span class="line">            prctl(PR_SET_PDEATHSIG, SIGKILL);   <span class="comment">// if parent media.log dies before me, kill me also</span></span><br><span class="line">            setpgid(<span class="number">0</span>, <span class="number">0</span>);                      <span class="comment">// but if I die first, don't kill my parent</span></span><br><span class="line">        &#125;</span><br><span class="line">        sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">        sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">        ALOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">        AudioFlinger::instantiate();</span><br><span class="line">        AudioPolicyService::instantiate();</span><br><span class="line">        RadioService::instantiate();</span><br><span class="line">        SoundTriggerHwService::instantiate();</span><br><span class="line">        ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AudioFlingerç»§æ‰¿äº†æ¨¡æ¿ç±»BinderServiceï¼Œè¯¥ç±»ç”¨äºæ³¨å†Œnative serviceã€‚<br>BinderServiceæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œè¯¥ç±»çš„publishå‡½æ•°å°±æ˜¯å®Œæˆå‘ServiceManageræ³¨å†ŒæœåŠ¡ã€‚<br>AudioFlingeræ³¨å†Œåä¸ºâ€media.audio_flingerâ€çš„æœåŠ¡ã€‚<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">getServiceName</span><span class="params">()</span> ANDROID_API </span>&#123; <span class="keyword">return</span> <span class="string">"media.audio_flinger"</span>; &#125;</span><br></pre></td></tr></table></figure><p></p><h5 id="1-1-1-AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ"><a href="#1-1-1-AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ" class="headerlink" title="1.1.1 AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ"></a>1.1.1 AudioFlingeræœåŠ¡çš„å¯åŠ¨å’Œè¿è¡Œ</h5><p>AudioFlingerçš„æ„é€ å‡½æ•°ï¼Œå‘ç°å®ƒåªæ˜¯ç®€å•åœ°ä¸ºå†…éƒ¨ä¸€äº›å˜é‡åšäº†åˆå§‹åŒ–ï¼Œé™¤æ­¤ä¹‹å¤–å°±æ²¡æœ‰ä»»ä½•ä»£ç äº†ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">AudioFlinger::AudioFlinger()</span><br><span class="line">    : BnAudioFlinger(),</span><br><span class="line">      mPrimaryHardwareDev(<span class="literal">NULL</span>),</span><br><span class="line">      mAudioHwDevs(<span class="literal">NULL</span>),</span><br><span class="line">      mHardwareStatus(AUDIO_HW_IDLE),</span><br><span class="line">      mMasterVolume(<span class="number">1.0f</span>),</span><br><span class="line">      mMasterMute(<span class="literal">false</span>),</span><br><span class="line">      <span class="comment">// mNextUniqueId(AUDIO_UNIQUE_ID_USE_MAX),</span></span><br><span class="line">      mMode(AUDIO_MODE_INVALID),</span><br><span class="line">      mBtNrecIsOff(<span class="literal">false</span>),</span><br><span class="line">      mIsLowRamDevice(<span class="literal">true</span>),</span><br><span class="line">      mIsDeviceTypeKnown(<span class="literal">false</span>),</span><br><span class="line">      mGlobalEffectEnableTime(<span class="number">0</span>),</span><br><span class="line">      mSystemReady(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// unsigned instead of audio_unique_id_use_t, because ++ operator is unavailable for enum</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> use = AUDIO_UNIQUE_ID_USE_UNSPECIFIED; use &lt; AUDIO_UNIQUE_ID_USE_MAX; use++) &#123;</span><br><span class="line">        <span class="comment">// zero ID has a special meaning, so unavailable</span></span><br><span class="line">        mNextUniqueIds[use] = AUDIO_UNIQUE_ID_USE_MAX;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BnAudioFlingeræ˜¯ç”±RefBaseå±‚å±‚ç»§æ‰¿è€Œæ¥çš„ï¼Œå¹¶ä¸”IServiceManager::addServiceçš„ç¬¬äºŒä¸ªå‚æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¼ºæŒ‡é’ˆå¼•ç”¨(constsp<ibinder>&amp;),å› è€ŒAudioFlingerå…·å¤‡äº†å¼ºæŒ‡é’ˆè¢«ç¬¬ä¸€æ¬¡å¼•ç”¨æ—¶è°ƒç”¨onFirstRefçš„ç¨‹åºé€»è¾‘ã€‚</ibinder></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line"><span class="keyword">void</span> AudioFlinger::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> move all this work into an Init() function */</span></span><br><span class="line">    <span class="keyword">char</span> val_str[PROPERTY_VALUE_MAX] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (property_get(<span class="string">"ro.audio.flinger_standbytime_ms"</span>, val_str, <span class="literal">NULL</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> int_val;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == <span class="built_in">sscanf</span>(val_str, <span class="string">"%u"</span>, &amp;int_val)) &#123;</span><br><span class="line">            mStandbyTimeInNsecs = milliseconds(int_val);</span><br><span class="line">            ALOGI(<span class="string">"Using %u mSec as standby time."</span>, int_val);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mStandbyTimeInNsecs = kDefaultStandbyTimeInNsecs;</span><br><span class="line">            ALOGI(<span class="string">"Using default %u mSec as standby time."</span>,</span><br><span class="line">                    (<span class="keyword">uint32_t</span>)(mStandbyTimeInNsecs / <span class="number">1000000</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPatchPanel = <span class="keyword">new</span> PatchPanel(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    mMode = AUDIO_MODE_NORMAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™æ—¶å¼€å§‹ï¼ŒAudioFlingerå°±æ˜¯ä¸€ä¸ªâ€œæœ‰æ„ä¹‰â€çš„å®ä½“äº†</p><h5 id="1-2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†"><a href="#1-2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†" class="headerlink" title="1.2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†"></a>1.2ã€éŸ³é¢‘è®¾å¤‡çš„ç®¡ç†</h5><p>è™½ç„¶AudioFlingerå®ä½“å·²ç»æˆåŠŸåˆ›å»ºå¹¶åˆå§‹åŒ–ï¼Œä½†åˆ°ç›®å‰ä¸ºæ­¢å®ƒè¿˜æ˜¯ä¸€å—é™æ€çš„å†…å­˜ç©ºé—´ï¼Œæ²¡æœ‰æ¶‰åŠåˆ°å…·ä½“çš„å·¥ä½œã€‚</p><p>ä»èŒèƒ½åˆ†å¸ƒä¸Šæ¥è®²ï¼ŒAudioPolicyServiceæ˜¯ç­–ç•¥çš„åˆ¶å®šè€…ï¼Œæ¯”å¦‚ä»€ä¹ˆæ—¶å€™æ‰“å¼€éŸ³é¢‘æ¥å£è®¾å¤‡ã€æŸç§Streamç±»å‹çš„éŸ³é¢‘å¯¹åº”ä»€ä¹ˆè®¾å¤‡ç­‰ç­‰ã€‚è€ŒAudioFlingeråˆ™æ˜¯ç­–ç•¥çš„æ‰§è¡Œè€…ï¼Œä¾‹å¦‚å…·ä½“å¦‚ä½•ä¸éŸ³é¢‘è®¾å¤‡é€šä¿¡ï¼Œå¦‚ä½•ç»´æŠ¤ç°æœ‰ç³»ç»Ÿä¸­çš„éŸ³é¢‘è®¾å¤‡ï¼Œä»¥åŠå¤šä¸ªéŸ³é¢‘æµçš„æ··éŸ³å¦‚ä½•å¤„ç†ç­‰ç­‰éƒ½å¾—ç”±å®ƒæ¥å®Œæˆã€‚</p><p>ç›®å‰Audioç³»ç»Ÿä¸­æ”¯æŒçš„éŸ³é¢‘è®¾å¤‡æ¥å£(Audio Interface)åˆ†ä¸ºä¸‰å¤§ç±»ï¼Œå³ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">static const char * const audio_interfaces[] = &#123;</span><br><span class="line">    AUDIO_HARDWARE_MODULE_ID_PRIMARY,</span><br><span class="line">    AUDIO_HARDWARE_MODULE_ID_A2DP,</span><br><span class="line">    AUDIO_HARDWARE_MODULE_ID_USB,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¯ç§éŸ³é¢‘è®¾å¤‡æ¥å£ç”±ä¸€ä¸ªå¯¹åº”çš„soåº“æä¾›æ”¯æŒã€‚é‚£ä¹ˆAudioFlingeræ€ä¹ˆä¼šçŸ¥é“å½“å‰è®¾å¤‡ä¸­æ”¯æŒä¸Šè¿°çš„å“ªäº›æ¥å£ï¼Œæ¯ç§æ¥å£åˆæ”¯æŒå“ªäº›å…·ä½“çš„éŸ³é¢‘è®¾å¤‡å‘¢ï¼Ÿè¿™æ˜¯AudioPolicyServiceçš„è´£ä»»ä¹‹ä¸€ï¼Œå³æ ¹æ®ç”¨æˆ·é…ç½®æ¥æŒ‡å¯¼AudioFlingeråŠ è½½è®¾å¤‡æ¥å£ã€‚</p><p>å½“AudioPolicyManagerBase(AudioPolicyServiceä¸­æŒæœ‰çš„Policyç®¡ç†è€…ï¼Œåé¢å°èŠ‚æœ‰è¯¦ç»†ä»‹ç»)æ„é€ æ—¶ï¼Œå®ƒä¼šè¯»å–å‚å•†å…³äºéŸ³é¢‘è®¾å¤‡çš„æè¿°æ–‡ä»¶(audio_policy.conf)ï¼Œç„¶åæ®æ­¤æ¥æ‰“å¼€ä»¥ä¸Šä¸‰ç±»éŸ³é¢‘æ¥å£(å¦‚æœå­˜åœ¨çš„è¯)ã€‚è¿™ä¸€è¿‡ç¨‹æœ€ç»ˆä¼šè°ƒç”¨loadHwModule@AudioFlingerï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><h5 id="1-2-1ã€åŠ è½½è®¾å¤‡loadHwModule"><a href="#1-2-1ã€åŠ è½½è®¾å¤‡loadHwModule" class="headerlink" title="1.2.1ã€åŠ è½½è®¾å¤‡loadHwModule()"></a>1.2.1ã€åŠ è½½è®¾å¤‡loadHwModule()</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">/*nameå°±æ˜¯å‰é¢audio_interfaces æ•°ç»„æˆå‘˜ä¸­çš„å­—ç¬¦ä¸²*/</span><br><span class="line">audio_module_handle_t AudioFlinger::loadHwModule(const char *name)</span><br><span class="line">&#123;</span><br><span class="line">    if (name == NULL) &#123;</span><br><span class="line">        return AUDIO_MODULE_HANDLE_NONE;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!settingsAllowed()) &#123;</span><br><span class="line">        return AUDIO_MODULE_HANDLE_NONE;</span><br><span class="line">    &#125;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    return loadHwModule_l(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ²¡æœ‰åšå®è´¨æ€§çš„å·¥ä½œï¼Œåªæ˜¯æ‰§è¡Œäº†åŠ é”åŠ¨ä½œï¼Œç„¶åæ¥ç€è°ƒç”¨ä¸‹é¢çš„å‡½æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">// loadHwModule_l() must be called with AudioFlinger::mLock held</span><br><span class="line">audio_module_handle_t AudioFlinger::loadHwModule_l(const char *name)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    /* Step 1. æ˜¯å¦å·²ç»æ·»åŠ äº†è¿™ä¸ªinterface ? */</span><br><span class="line">    for (size_t i = 0; i &lt; mAudioHwDevs.size(); i++) &#123;</span><br><span class="line">        if (strncmp(mAudioHwDevs.valueAt(i)-&gt;moduleName(), name, strlen(name)) == 0) &#123;</span><br><span class="line">            ALOGW(&quot;loadHwModule() module %s already loaded&quot;, name);</span><br><span class="line">            return mAudioHwDevs.keyAt(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    audio_hw_device_t *dev;</span><br><span class="line">    /* Step 2. åŠ è½½audio interface */</span><br><span class="line">    int rc = load_audio_interface(name, &amp;dev);</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    /* Step 3. åˆå§‹åŒ– */</span><br><span class="line">    mHardwareStatus = AUDIO_HW_INIT;</span><br><span class="line">    rc = dev-&gt;init_check(dev);</span><br><span class="line">    mHardwareStatus = AUDIO_HW_IDLE;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    /* Step 4. æ·»åŠ åˆ°å…¨å±€å˜é‡ä¸­ */</span><br><span class="line">    audio_module_handle_t handle = (audio_module_handle_t) nextUniqueId(AUDIO_UNIQUE_ID_USE_MODULE);</span><br><span class="line">    mAudioHwDevs.add(handle, new AudioHwDevice(handle, name, dev, flags));</span><br><span class="line"></span><br><span class="line">    return handle;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Step1@ loadHwModule_l. é¦–å…ˆæŸ¥æ‰¾mAudioHwDevsæ˜¯å¦å·²ç»æ·»åŠ äº†å˜é‡nameæ‰€æŒ‡ç¤ºçš„audio interfaceï¼Œå¦‚æœæ˜¯çš„è¯ç›´æ¥è¿”å›ã€‚ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶mAudioHwDevsçš„sizeä¸º0ï¼Œæ‰€ä»¥è¿˜ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p><p>Step2@ loadHwModule_l. åŠ è½½æŒ‡å®šçš„audiointerfaceï¼Œæ¯”å¦‚â€œprimaryâ€ã€â€œa2dpâ€æˆ–è€…â€œusbâ€ã€‚å‡½æ•°load_audio_interfaceç”¨æ¥åŠ è½½è®¾å¤‡æ‰€éœ€çš„åº“æ–‡ä»¶ï¼Œç„¶åæ‰“å¼€è®¾å¤‡å¹¶åˆ›å»ºä¸€ä¸ªaudio_hw_device_tå®ä¾‹ã€‚éŸ³é¢‘æ¥å£è®¾å¤‡æ‰€å¯¹åº”çš„åº“æ–‡ä»¶åç§°æ˜¯æœ‰ä¸€å®šæ ¼å¼çš„ï¼Œæ¯”å¦‚a2dpçš„æ¨¡å—åå¯èƒ½æ˜¯audio.a2dp.soæˆ–è€…audio.a2dp.default.soç­‰ç­‰ã€‚æŸ¥æ‰¾è·¯å¾„ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œå³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware\hardware.c]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH1 <span class="meta-string">"/system/lib64/hw"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH2 <span class="meta-string">"/vendor/lib64/hw"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH3 <span class="meta-string">"/odm/lib64/hw"</span></span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå› ä¸ºAndroidæ˜¯å®Œå…¨å¼€æºçš„ï¼Œå„å¼€å‘å•†å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¥è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ï¼Œæ¯”å¦‚ä¸‹é¢æ˜¯Google pixel è®¾å¤‡çš„éŸ³é¢‘åº“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">adb shell &amp;&amp; cd system/lib64/hw &amp;&amp; ls -l</span><br><span class="line">-rw-r--r-- 1 root root   30440 2009-01-01 00:00 audio.a2dp.default.so</span><br><span class="line">-rw-r--r-- 1 root root   18156 2009-01-01 00:00 audio.primary.default.so</span><br><span class="line">-rw-r--r-- 1 root root  275612 2009-01-01 00:00 audio.primary.msm8996.so</span><br><span class="line">-rw-r--r-- 1 root root   34540 2009-01-01 00:00 audio.r_submix.default.so</span><br><span class="line">-rw-r--r-- 1 root root   22248 2009-01-01 00:00 audio.usb.default.so</span><br><span class="line">-rw-r--r-- 1 root root   96096 2009-01-01 00:00 audio_policy.default.so</span><br><span class="line">-rw-r--r-- 1 root root 1637208 2009-01-01 00:00 bluetooth.default.so</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>Step3@ loadHwModule_lï¼Œè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚å…¶ä¸­init_checkæ˜¯ä¸ºäº†ç¡®å®šè¿™ä¸ªaudio interfaceæ˜¯å¦å·²ç»æˆåŠŸåˆå§‹åŒ–ï¼Œ0æ˜¯æˆåŠŸï¼Œå…¶å®ƒå€¼è¡¨ç¤ºå¤±è´¥ã€‚æ¥ä¸‹æ¥å¦‚æœè¿™ä¸ªdeviceæ”¯æŒä¸»éŸ³é‡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡set_master_volumeè¿›è¡Œè®¾ç½®ã€‚åœ¨æ¯æ¬¡æ“ä½œdeviceå‰ï¼Œéƒ½è¦å…ˆæ”¹å˜mHardwareStatusçš„çŠ¶æ€å€¼ï¼Œæ“ä½œç»“æŸåå°†å…¶å¤åŸä¸ºAUDIO_HW_IDLE(æ ¹æ®æºç ä¸­çš„æ³¨é‡Šï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿dumpæ—¶æ­£ç¡®è¾“å‡ºå†…éƒ¨çŠ¶æ€ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å»æ·±ç©¶äº†)ã€‚</p><p>Step4@ loadHwModule_l. æŠŠåŠ è½½åçš„è®¾å¤‡æ·»åŠ å…¥mAudioHwDevsé”®å€¼å¯¹ä¸­ï¼Œå…¶ä¸­keyçš„å€¼æ˜¯ç”±nextUniqueIdç”Ÿæˆçš„ï¼Œè¿™æ ·åšä¿è¯äº†è¿™ä¸ªaudiointerfaceæ‹¥æœ‰å…¨å±€å”¯ä¸€çš„idå·ã€‚</p><p>å®Œæˆäº†audiointerfaceçš„æ¨¡å—åŠ è½½åªæ˜¯ä¸‡é‡Œé•¿å¾çš„ç¬¬ä¸€æ­¥ã€‚å› ä¸ºæ¯ä¸€ä¸ªinterfaceåŒ…å«çš„è®¾å¤‡é€šå¸¸ä¸æ­¢ä¸€ä¸ªï¼ŒAndroidç³»ç»Ÿç›®å‰æ”¯æŒçš„éŸ³é¢‘è®¾å¤‡å¦‚ä¸‹åˆ—è¡¨æ‰€ç¤ºï¼š<br>Androidç³»ç»Ÿæ”¯æŒçš„éŸ³é¢‘è®¾å¤‡åˆ—è¡¨(è¾“å‡º)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\libhardware_legacy\audio\audio_hw_hal.cpp]</span><br><span class="line">static uint32_t audio_device_conv_table[][HAL_API_REV_NUM] =</span><br><span class="line">&#123;</span><br><span class="line">    /* output devices */</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_EARPIECE, AUDIO_DEVICE_OUT_EARPIECE &#125;,//</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_SPEAKER, AUDIO_DEVICE_OUT_SPEAKER &#125;,//SPEAKER</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_WIRED_HEADSET, AUDIO_DEVICE_OUT_WIRED_HEADSET &#125;,//HEADSET</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_WIRED_HEADPHONE, AUDIO_DEVICE_OUT_WIRED_HEADPHONE &#125;,//HEADPHONE</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_SCO, AUDIO_DEVICE_OUT_BLUETOOTH_SCO &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_SCO_HEADSET, AUDIO_DEVICE_OUT_BLUETOOTH_SCO_HEADSET &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_SCO_CARKIT, AUDIO_DEVICE_OUT_BLUETOOTH_SCO_CARKIT &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_A2DP, AUDIO_DEVICE_OUT_BLUETOOTH_A2DP &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES, AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_BLUETOOTH_A2DP_SPEAKER, AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_SPEAKER &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_AUX_DIGITAL, AUDIO_DEVICE_OUT_AUX_DIGITAL &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_ANLG_DOCK_HEADSET, AUDIO_DEVICE_OUT_ANLG_DOCK_HEADSET &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_DGTL_DOCK_HEADSET, AUDIO_DEVICE_OUT_DGTL_DOCK_HEADSET &#125;,</span><br><span class="line">    &#123; AudioSystem::DEVICE_OUT_DEFAULT, AUDIO_DEVICE_OUT_DEFAULT &#125;,//é»˜è®¤è®¾å¤‡</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼š</p><p>Ã˜ è¿™ä¹ˆå¤šçš„è¾“å‡ºè®¾å¤‡ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å›æ”¾éŸ³é¢‘æµ(å½•éŸ³ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µ)æ—¶ï¼Œè¯¥é€‰æ‹©å“ªä¸€ç§å‘¢ï¼Ÿ</p><p>Ã˜ è€Œä¸”å½“å‰ç³»ç»Ÿä¸­audio interfaceä¹Ÿå¾ˆå¯èƒ½ä¸æ­¢ä¸€ä¸ªï¼Œåº”è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ</p><p>æ˜¾ç„¶è¿™äº›å†³ç­–å·¥ä½œå°†ç”±AudioPolicyServiceæ¥å®Œæˆï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€å°èŠ‚åšè¯¦ç»†é˜è¿°ã€‚è¿™é‡Œå…ˆç»™å¤§å®¶åˆ†æä¸‹ï¼ŒAudioFlingeræ˜¯å¦‚ä½•æ‰“å¼€ä¸€ä¸ªOutputé€šé“çš„(ä¸€ä¸ªaudiointerfaceå¯èƒ½åŒ…å«è‹¥å¹²ä¸ªoutput)ã€‚</p><h5 id="1-2-2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput"><a href="#1-2-2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput" class="headerlink" title="1.2.2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput()"></a>1.2.2ã€æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“openOutput()</h5><p>æ‰“å¼€éŸ³é¢‘è¾“å‡ºé€šé“(output)åœ¨AudioFlingerä¸­å¯¹åº”çš„æ¥å£æ˜¯openOutput()ï¼Œå³ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line"><span class="keyword">status_t</span> AudioFlinger::openOutput(<span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span><br><span class="line">                                  <span class="keyword">audio_io_handle_t</span> *output,</span><br><span class="line">                                  <span class="keyword">audio_config_t</span> *config,</span><br><span class="line">                                  <span class="keyword">audio_devices_t</span> *devices,</span><br><span class="line">                                  <span class="keyword">const</span> String8&amp; address,</span><br><span class="line">                                  <span class="keyword">uint32_t</span> *latencyMs,</span><br><span class="line">                                  <span class="keyword">audio_output_flags_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">    sp&lt;PlaybackThread&gt; thread = openOutput_l(<span class="keyword">module</span>, output, config, *devices, address, flags);</span><br><span class="line">    <span class="keyword">if</span> (thread != <span class="number">0</span>) &#123;</span><br><span class="line">        *latencyMs = thread-&gt;latency();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// notify client processes of the new output creation</span></span><br><span class="line">        thread-&gt;ioConfigChanged(AUDIO_OUTPUT_OPENED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// the first primary output opened designates the primary hw device</span></span><br><span class="line">        <span class="keyword">if</span> ((mPrimaryHardwareDev == <span class="literal">NULL</span>) &amp;&amp; (flags &amp; AUDIO_OUTPUT_FLAG_PRIMARY)) &#123;</span><br><span class="line">            ALOGI(<span class="string">"Using module %d has the primary audio interface"</span>, <span class="keyword">module</span>);</span><br><span class="line">            mPrimaryHardwareDev = thread-&gt;getOutput()-&gt;audioHwDev;</span><br><span class="line"></span><br><span class="line">            <span class="function">AutoMutex <span class="title">lock</span><span class="params">(mHardwareLock)</span></span>;</span><br><span class="line">            mHardwareStatus = AUDIO_HW_SET_MODE;</span><br><span class="line">            mPrimaryHardwareDev-&gt;hwDevice()-&gt;set_mode(mPrimaryHardwareDev-&gt;hwDevice(), mMode);</span><br><span class="line">            mHardwareStatus = AUDIO_HW_IDLE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_INIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è°ƒç”¨ openOutput_l()å‡½æ•°ä»å¤„ç†ã€‚<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">sp&lt;AudioFlinger::PlaybackThread&gt; AudioFlinger::openOutput_l(<span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span><br><span class="line">                                                            <span class="keyword">audio_io_handle_t</span> *output,</span><br><span class="line">                                                            <span class="keyword">audio_config_t</span> *config,</span><br><span class="line">                                                            <span class="keyword">audio_devices_t</span> devices,</span><br><span class="line">                                                            <span class="keyword">const</span> String8&amp; address,</span><br><span class="line">                                                            <span class="keyword">audio_output_flags_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*Step 1. æŸ¥æ‰¾ç›¸åº”çš„audio interface</span></span><br><span class="line"><span class="comment">    AudioHwDevice *outHwDev = findSuitableHwDev_l(module, devices);</span></span><br><span class="line"><span class="comment">    ......</span></span><br><span class="line"><span class="comment">    mHardwareStatus = AUDIO_HW_OUTPUT_OPEN;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     ......</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    AudioStreamOut *outputStream = NULL;</span></span><br><span class="line"><span class="comment">     /*Step 2. ä¸ºè®¾å¤‡æ‰“å¼€ä¸€ä¸ªè¾“å‡ºæµ*/</span></span><br><span class="line">    <span class="keyword">status_t</span> status = outHwDev-&gt;openOutputStream(</span><br><span class="line">            &amp;outputStream,</span><br><span class="line">            *output,</span><br><span class="line">            devices,</span><br><span class="line">            flags,</span><br><span class="line">            config,</span><br><span class="line">            address.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    mHardwareStatus = AUDIO_HW_IDLE;</span><br><span class="line">    <span class="comment">/*Step 3.åˆ›å»ºPlaybackThread*/</span></span><br><span class="line">    <span class="keyword">if</span> (status == NO_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">        PlaybackThread *thread;</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD) &#123;</span><br><span class="line">            thread = <span class="keyword">new</span> OffloadThread(<span class="keyword">this</span>, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(<span class="string">"openOutput_l() created offload output: ID %d thread %p"</span>, *output, thread);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flags &amp; AUDIO_OUTPUT_FLAG_DIRECT)</span><br><span class="line">                || !isValidPcmSinkFormat(config-&gt;format)</span><br><span class="line">                || !isValidPcmSinkChannelMask(config-&gt;channel_mask)) &#123;</span><br><span class="line">            thread = <span class="keyword">new</span> DirectOutputThread(<span class="keyword">this</span>, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(<span class="string">"openOutput_l() created direct output: ID %d thread %p"</span>, *output, thread);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            thread = <span class="keyword">new</span> MixerThread(<span class="keyword">this</span>, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(<span class="string">"openOutput_l() created mixer output: ID %d thread %p"</span>, *output, thread);</span><br><span class="line">        &#125;</span><br><span class="line">        mPlaybackThreads.add(*output, thread);</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œé¢œè‰²åŠ æ·±çš„éƒ¨åˆ†æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥åˆ†æçš„é‡ç‚¹ï¼Œä¸»è¦è¿˜æ˜¯å›´ç»•outHwDevè¿™ä¸ªå˜é‡æ‰€åšçš„ä¸€ç³»åˆ—æ“ä½œï¼Œå³ï¼š</p><p>Â· æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡( findSuitableHwDev_l() )</p><p>Â· åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµ( é€šè¿‡openOutputStream()åˆ›å»ºAudioStreamOut )</p><p>Â· åˆ›å»ºæ’­æ”¾çº¿ç¨‹( PlaybackThread )</p><p>outHwDevç”¨äºè®°å½•ä¸€ä¸ªæ‰“å¼€çš„éŸ³é¢‘æ¥å£è®¾å¤‡ï¼Œå®ƒçš„æ•°æ®ç±»å‹æ˜¯audio_hw_device_tï¼Œæ˜¯ç”±HALè§„å®šçš„ä¸€ä¸ªéŸ³é¢‘æ¥å£è®¾å¤‡æ‰€åº”å…·æœ‰çš„å±æ€§é›†åˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioHwDevice.h]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AudioHwDevice</span> &#123;</span></span><br><span class="line">......</span><br><span class="line">    <span class="keyword">audio_module_handle_t</span> handle() <span class="keyword">const</span> &#123; <span class="keyword">return</span> mHandle; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">moduleName</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> mModuleName; &#125;</span><br><span class="line">    <span class="keyword">audio_hw_device_t</span> *hwDevice() <span class="keyword">const</span> &#123; <span class="keyword">return</span> mHwDevice; &#125;</span><br><span class="line">    <span class="keyword">uint32_t</span> version() <span class="keyword">const</span> &#123; <span class="keyword">return</span> mHwDevice-&gt;common.version; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">status_t</span> openOutputStream(</span><br><span class="line">            AudioStreamOut **ppStreamOut,</span><br><span class="line">            <span class="keyword">audio_io_handle_t</span> handle,</span><br><span class="line">            <span class="keyword">audio_devices_t</span> devices,</span><br><span class="line">            <span class="keyword">audio_output_flags_t</span> flags,</span><br><span class="line">            struct audio_config *config,</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *address);</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">audio_module_handle_t</span> mHandle;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span>          mModuleName;</span><br><span class="line">    <span class="keyword">audio_hw_device_t</span> * <span class="keyword">const</span>   mHwDevice;</span><br><span class="line">    <span class="keyword">const</span> Flags                 mFlags;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­commonä»£è¡¨äº†HALå±‚æ‰€æœ‰è®¾å¤‡çš„å…±æœ‰å±æ€§;set_master_volumeã€set_modeã€open_output_streamåˆ†åˆ«ä¸ºæˆ‘ä»¬è®¾ç½®audio interfaceçš„ä¸»éŸ³é‡ã€è®¾ç½®éŸ³é¢‘æ¨¡å¼ç±»å‹(æ¯”å¦‚AUDIO_MODE_RINGTONEã€AUDIO_MODE_IN_CALLç­‰ç­‰)ã€æ‰“å¼€è¾“å‡ºæ•°æ®æµæä¾›äº†æ¥å£ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æ­¥æ¥é˜è¿°ã€‚</p><h5 id="1-2-2-1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev-l"><a href="#1-2-2-1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev-l" class="headerlink" title="1.2.2.1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev_l()"></a>1.2.2.1ã€æŸ¥æ‰¾åˆé€‚çš„éŸ³é¢‘æ¥å£è®¾å¤‡findSuitableHwDev_l()</h5><p>Step1@ AudioFlinger::openOutput. åœ¨openOutputä¸­ï¼Œè®¾å¤‡outHwDevæ˜¯é€šè¿‡æŸ¥æ‰¾å½“å‰ç³»ç»Ÿæ¥å¾—åˆ°çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">AudioHwDevice* AudioFlinger::findSuitableHwDev_l(</span><br><span class="line">        <span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span><br><span class="line">        <span class="keyword">audio_devices_t</span> devices)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// if module is 0, the request comes from an old policy manager and we should load</span></span><br><span class="line">    <span class="comment">// well known modules</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"findSuitableHwDev_l() loading well know audio hw modules"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; ARRAY_SIZE(audio_interfaces); i++) &#123;</span><br><span class="line">            loadHwModule_l(audio_interfaces[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// then try to find a module supporting the requested device.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mAudioHwDevs.size(); i++) &#123;</span><br><span class="line">            AudioHwDevice *audioHwDevice = mAudioHwDevs.valueAt(i);</span><br><span class="line">            <span class="keyword">audio_hw_device_t</span> *dev = audioHwDevice-&gt;hwDevice();</span><br><span class="line">            <span class="keyword">if</span> ((dev-&gt;get_supported_devices != <span class="literal">NULL</span>) &amp;&amp;</span><br><span class="line">                    (dev-&gt;get_supported_devices(dev) &amp; devices) == devices)</span><br><span class="line">                <span class="keyword">return</span> audioHwDevice;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// check a match for the requested module handle</span></span><br><span class="line">        AudioHwDevice *audioHwDevice = mAudioHwDevs.valueFor(<span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">if</span> (audioHwDevice != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> audioHwDevice;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å˜é‡moduleå€¼ä¸º0çš„æƒ…å†µï¼Œæ˜¯ä¸ºäº†å…¼å®¹ä¹‹å‰çš„Audio Policyè€Œç‰¹åˆ«åšçš„å¤„ç†ã€‚å½“moduleç­‰äº0æ—¶ï¼Œé¦–å…ˆåŠ è½½æ‰€æœ‰å·²çŸ¥çš„éŸ³é¢‘æ¥å£è®¾å¤‡ï¼Œç„¶åå†æ ¹æ®devicesæ¥ç¡®å®šå…¶ä¸­ç¬¦åˆè¦æ±‚çš„ã€‚å…¥å‚devicesçš„å€¼å®é™…ä¸Šæ¥æºäºâ€œ Androidç³»ç»Ÿæ”¯æŒçš„éŸ³é¢‘è®¾å¤‡åˆ—è¡¨(è¾“å‡º)â€æ‰€ç¤ºçš„è®¾å¤‡ã€‚å¯ä»¥çœ‹åˆ°ï¼Œenumä¸­æ¯ä¸ªè®¾å¤‡ç±»å‹éƒ½å¯¹åº”ä¸€ä¸ªç‰¹å®šçš„æ¯”ç‰¹ä½ï¼Œå› è€Œä¸Šè¿°ä»£ç æ®µä¸­å¯ä»¥é€šè¿‡â€œä¸è¿ç®—â€æ¥æ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡ã€‚</p><p>å½“modulesä¸ºé0å€¼æ—¶ï¼Œè¯´æ˜Audio PolicyæŒ‡å®šäº†å…·ä½“çš„è®¾å¤‡idå·ï¼Œè¿™æ—¶å°±é€šè¿‡æŸ¥æ‰¾å…¨å±€çš„mAudioHwDevså˜é‡æ¥ç¡®è®¤æ˜¯å¦å­˜åœ¨ç¬¦åˆè¦æ±‚çš„è®¾å¤‡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.h]</span><br><span class="line">DefaultKeyedVector&lt;audio_module_handle_t, AudioHwDevice*&gt;  mAudioHwDevs;</span><br></pre></td></tr></table></figure><p>å˜é‡mAudioHwDevsæ˜¯ä¸€ä¸ªVectorï¼Œä»¥audio_module_handle_tä¸ºkeyï¼Œæ¯ä¸€ä¸ªhandleå€¼å”¯ä¸€ç¡®å®šäº†å·²ç»æ·»åŠ çš„éŸ³é¢‘è®¾å¤‡ã€‚é‚£ä¹ˆåœ¨ä»€ä¹ˆæ—¶å€™æ·»åŠ è®¾å¤‡å‘¢ï¼Ÿ</p><p>ä¸€ç§æƒ…å†µå°±æ˜¯å‰é¢çœ‹åˆ°çš„modulesä¸º0æ—¶ï¼Œä¼šloadæ‰€æœ‰æ½œåœ¨è®¾å¤‡ï¼Œå¦ä¸€ç§æƒ…å†µå°±æ˜¯AudioPolicyManagerBaseåœ¨æ„é€ æ—¶ä¼šé¢„åŠ è½½æ‰€æœ‰audio_policy.confä¸­æ‰€æè¿°çš„outputã€‚ä¸ç®¡æ˜¯å“ªä¸€ç§æƒ…å†µï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨loadHwModuleÃ loadHwModule_lï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬å¼€å¤´å°±åˆ†æè¿‡äº†ã€‚</p><p>å¦‚æœmodulesä¸ºé0ï¼Œä¸”ä»mAudioHwDevsä¸­ä¹Ÿæ‰¾ä¸åˆ°ç¬¦åˆè¦æ±‚çš„è®¾å¤‡ï¼Œç¨‹åºå¹¶ä¸ä¼šå°±æ­¤ç»ˆç»“â€”â€”å®ƒä¼šé€€è€Œæ±‚å…¶æ¬¡ï¼Œéå†æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ å¯»æ‰¾æ”¯æŒdevicesçš„ä»»ä½•ä¸€ä¸ªaudio interfaceã€‚</p><h5 id="1-2-2-2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream"><a href="#1-2-2-2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream" class="headerlink" title="1.2.2.2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream()"></a>1.2.2.2ã€åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµopenOutputStream()</h5><p>Step2@ AudioFlinger::openOutputï¼Œè°ƒç”¨openOutputStream()å‡½æ•°æ‰“å¼€ä¸€ä¸ªAudioStreamOut ã€‚æºç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioHwDevice.cpp]</span><br><span class="line">status_t AudioHwDevice::openOutputStream(</span><br><span class="line">        AudioStreamOut **ppStreamOut,</span><br><span class="line">        audio_io_handle_t handle,</span><br><span class="line">        audio_devices_t devices,</span><br><span class="line">        audio_output_flags_t flags,</span><br><span class="line">        struct audio_config *config,</span><br><span class="line">        const char *address)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    struct audio_config originalConfig = *config;</span><br><span class="line">    AudioStreamOut *outputStream = new AudioStreamOut(this, flags);</span><br><span class="line">    </span><br><span class="line">    status_t status = outputStream-&gt;open(handle, devices, config, address);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    *ppStreamOut = outputStream;</span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”ŸæˆAudioStreamOutå¯¹è±¡å¹¶èµ‹å€¼ç»™ppStreamOut ï¼Œè¿›ä¸€æ­¥è°ƒç”¨äº†AudioStreamOut-&gt;open()å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioStreamOut.cpp]</span><br><span class="line">status_t AudioStreamOut::open(</span><br><span class="line">        audio_io_handle_t handle,</span><br><span class="line">        audio_devices_t devices,</span><br><span class="line">        struct audio_config *config,</span><br><span class="line">        const char *address)</span><br><span class="line">&#123;</span><br><span class="line">    audio_stream_out_t *outStream;</span><br><span class="line">    .......</span><br><span class="line">    int status = hwDev()-&gt;open_output_stream(</span><br><span class="line">            hwDev(),</span><br><span class="line">            handle,</span><br><span class="line">            devices,</span><br><span class="line">            customFlags,</span><br><span class="line">            config,</span><br><span class="line">            &amp;outStream,</span><br><span class="line">            address);</span><br><span class="line">    ......</span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å³ä¼šé€šè¿‡audio_hw_device_t-&gt;-&gt;open_output_stream()åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµ</p><h5 id="1-2-2-2-1ã€audio-hw-device-t-gt-gt-open-output-stream"><a href="#1-2-2-2-1ã€audio-hw-device-t-gt-gt-open-output-stream" class="headerlink" title="1.2.2.2.1ã€audio_hw_device_t-&gt;-&gt;open_output_stream()"></a>1.2.2.2.1ã€audio_hw_device_t-&gt;-&gt;open_output_stream()</h5><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹HALå±‚ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\audio\hal\audio_hw.c]</span><br><span class="line">static int adev_open(const hw_module_t *module, const char *name,</span><br><span class="line">                     hw_device_t **device)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    adev = calloc(1, sizeof(struct audio_device));</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;adev-&gt;lock, (const pthread_mutexattr_t *) NULL);</span><br><span class="line"></span><br><span class="line">    adev-&gt;device.common.tag = HARDWARE_DEVICE_TAG;</span><br><span class="line">    adev-&gt;device.common.version = AUDIO_DEVICE_API_VERSION_2_0;</span><br><span class="line">    adev-&gt;device.common.module = (struct hw_module_t *)module;</span><br><span class="line">    adev-&gt;device.common.close = adev_close;</span><br><span class="line"></span><br><span class="line">    adev-&gt;device.init_check = adev_init_check;</span><br><span class="line">    adev-&gt;device.set_voice_volume = adev_set_voice_volume;</span><br><span class="line">    adev-&gt;device.set_master_volume = adev_set_master_volume;</span><br><span class="line">    adev-&gt;device.get_master_volume = adev_get_master_volume;</span><br><span class="line">    adev-&gt;device.set_master_mute = adev_set_master_mute;</span><br><span class="line">    adev-&gt;device.get_master_mute = adev_get_master_mute;</span><br><span class="line">    adev-&gt;device.set_mode = adev_set_mode;</span><br><span class="line">    adev-&gt;device.set_mic_mute = adev_set_mic_mute;</span><br><span class="line">    adev-&gt;device.get_mic_mute = adev_get_mic_mute;</span><br><span class="line">    adev-&gt;device.set_parameters = adev_set_parameters;</span><br><span class="line">    adev-&gt;device.get_parameters = adev_get_parameters;</span><br><span class="line">    adev-&gt;device.get_input_buffer_size = adev_get_input_buffer_size;</span><br><span class="line">    adev-&gt;device.open_output_stream = adev_open_output_stream;</span><br><span class="line">    adev-&gt;device.close_output_stream = adev_close_output_stream;</span><br><span class="line">    adev-&gt;device.open_input_stream = adev_open_input_stream;</span><br><span class="line">    adev-&gt;device.close_input_stream = adev_close_input_stream;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“è°ƒç”¨open_output_stream å°±ä¼šè°ƒç”¨adev_open_output_streamã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\audio\hal\audio_hw.c]</span><br><span class="line">static int adev_open_output_stream(struct audio_hw_device *dev,</span><br><span class="line">                                   audio_io_handle_t handle,</span><br><span class="line">                                   audio_devices_t devices,</span><br><span class="line">                                   audio_output_flags_t flags,</span><br><span class="line">                                   struct audio_config *config,</span><br><span class="line">                                   struct audio_stream_out **stream_out,</span><br><span class="line">                                   const char *address __unused)</span><br><span class="line">&#123;</span><br><span class="line">    struct audio_device *adev = (struct audio_device *)dev;</span><br><span class="line">    struct stream_out *out;</span><br><span class="line">    int i, ret;</span><br><span class="line">    </span><br><span class="line">    *stream_out = NULL;</span><br><span class="line">    out = (struct stream_out *)calloc(1, sizeof(struct stream_out));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    out-&gt;stream.common.get_sample_rate = out_get_sample_rate;</span><br><span class="line">    out-&gt;stream.common.set_sample_rate = out_set_sample_rate;</span><br><span class="line">    out-&gt;stream.common.get_buffer_size = out_get_buffer_size;</span><br><span class="line">    out-&gt;stream.common.get_channels = out_get_channels;</span><br><span class="line">    out-&gt;stream.common.get_format = out_get_format;</span><br><span class="line">    out-&gt;stream.common.set_format = out_set_format;</span><br><span class="line">    out-&gt;stream.common.standby = out_standby;</span><br><span class="line">    out-&gt;stream.common.dump = out_dump;</span><br><span class="line">    out-&gt;stream.common.set_parameters = out_set_parameters;</span><br><span class="line">    out-&gt;stream.common.get_parameters = out_get_parameters;</span><br><span class="line">    out-&gt;stream.common.add_audio_effect = out_add_audio_effect;</span><br><span class="line">    out-&gt;stream.common.remove_audio_effect = out_remove_audio_effect;</span><br><span class="line">    out-&gt;stream.get_latency = out_get_latency;</span><br><span class="line">    out-&gt;stream.set_volume = out_set_volume;</span><br><span class="line">#ifdef NO_AUDIO_OUT</span><br><span class="line">    out-&gt;stream.write = out_write_for_no_output;</span><br><span class="line">#else</span><br><span class="line">    out-&gt;stream.write = out_write;</span><br><span class="line">#endif</span><br><span class="line">    out-&gt;stream.get_render_position = out_get_render_position;</span><br><span class="line">    out-&gt;stream.get_next_write_timestamp = out_get_next_write_timestamp;</span><br><span class="line">    out-&gt;stream.get_presentation_position = out_get_presentation_position;</span><br><span class="line"></span><br><span class="line">    out-&gt;af_period_multiplier  = out-&gt;realtime ? af_period_multiplier : 1;</span><br><span class="line">    out-&gt;standby = 1;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    *stream_out = &amp;out-&gt;stream;</span><br><span class="line">    ALOGV(&quot;%s: exit&quot;, __func__);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®éŸ³é¢‘æµçš„ç†Ÿæ‚‰åšä¸€ç³»åˆ—åˆå§‹åŒ–æ“ä½œã€‚è½¬äº†ä¸€å¤§åœˆï¼Œç»§ç»­çœ‹çœ‹</p><h5 id="1-2-2-3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹-PlaybackThread"><a href="#1-2-2-3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹-PlaybackThread" class="headerlink" title="1.2.2.3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹(PlaybackThread)"></a>1.2.2.3ã€åˆ›å»ºæ’­æ”¾çº¿ç¨‹(PlaybackThread)</h5><p>Step3@ AudioFlinger::openOutput. æ—¢ç„¶é€šé“å·²ç»æ‰“å¼€ï¼Œé‚£ä¹ˆç”±è°æ¥å¾€é€šé“é‡Œæ”¾ä¸œè¥¿å‘¢ï¼Ÿè¿™å°±æ˜¯PlaybackThreadã€‚è¿™é‡Œåˆ†ä¸‰ç§ä¸åŒçš„æƒ…å†µï¼š<br>Â· OffloadThread</p><p>Â· DirectOutput</p><p>å¦‚æœä¸éœ€è¦æ··éŸ³</p><p>Â· Mixer</p><p>éœ€è¦æ··éŸ³</p><p>è¿™ä¸‰ç§æƒ…å†µåˆ†åˆ«å¯¹åº”DirectOutputThreadã€OffloadThreadå’ŒMixerThreadä¸¤ç§çº¿ç¨‹ã€‚æˆ‘ä»¬ä»¥åè€…ä¸ºä¾‹æ¥åˆ†æä¸‹PlaybackThreadçš„å·¥ä½œæ¨¡å¼ï¼Œä¹Ÿä¼šåé¢å°èŠ‚æ‰“ä¸‹åŸºç¡€ã€‚å›æ”¾çº¿ç¨‹ï¼ˆPlaybackThread åŠå…¶æ´¾ç”Ÿçš„å­ç±»ï¼‰å’Œå½•åˆ¶çº¿ç¨‹ï¼ˆRecordThreadï¼‰è¿›è¡Œçš„ï¼Œå…ˆç®€å•çœ‹çœ‹å›æ”¾çº¿ç¨‹å’Œå½•åˆ¶çº¿ç¨‹ç±»å…³ç³»ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/32-Audio-system-mixerthread.jpg" alt="Alt text"></p><p>Â· ThreadBaseï¼šPlaybackThread å’Œ RecordThread çš„åŸºç±»<br>Â· RecordThreadï¼šå½•åˆ¶çº¿ç¨‹ç±»ï¼Œç”± ThreadBase æ´¾ç”Ÿ<br>Â· PlaybackThreadï¼šå›æ”¾çº¿ç¨‹åŸºç±»ï¼ŒåŒç”± ThreadBase æ´¾ç”Ÿ<br>Â· MixerThreadï¼šæ··éŸ³å›æ”¾çº¿ç¨‹ç±»ï¼Œç”± PlaybackThread æ´¾ç”Ÿï¼Œè´Ÿè´£å¤„ç†æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_PRIMARYã€AUDIO_OUTPUT_FLAG_FASTã€AUDIO_OUTPUT_FLAG_DEEP_BUFFER çš„éŸ³é¢‘æµï¼ŒMixerThread å¯ä»¥æŠŠå¤šä¸ªéŸ³è½¨çš„æ•°æ®æ··éŸ³åå†è¾“å‡º<br>Â· DirectOutputThreadï¼šç›´è¾“å›æ”¾çº¿ç¨‹ç±»ï¼Œç”± PlaybackThread æ´¾ç”Ÿï¼Œè´Ÿè´£å¤„ç†æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_DIRECT çš„éŸ³é¢‘æµï¼Œè¿™ç§éŸ³é¢‘æµæ•°æ®ä¸éœ€è¦è½¯ä»¶æ··éŸ³ï¼Œç›´æ¥è¾“å‡ºåˆ°éŸ³é¢‘è®¾å¤‡å³å¯<br>Â· DuplicatingThreadï¼šå¤åˆ¶å›æ”¾çº¿ç¨‹ç±»ï¼Œç”± MixerThread æ´¾ç”Ÿï¼Œè´Ÿè´£å¤åˆ¶éŸ³é¢‘æµæ•°æ®åˆ°å…¶ä»–è¾“å‡ºè®¾å¤‡ï¼Œä½¿ç”¨åœºæ™¯å¦‚ä¸»å£°å¡è®¾å¤‡ã€è“ç‰™è€³æœºè®¾å¤‡ã€USB å£°å¡è®¾å¤‡åŒæ—¶è¾“å‡º<br>Â· OffloadThreadï¼šç¡¬è§£å›æ”¾çº¿ç¨‹ç±»ï¼Œç”± DirectOutputThread æ´¾ç”Ÿï¼Œè´Ÿè´£å¤„ç†æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD çš„éŸ³é¢‘æµï¼Œè¿™ç§éŸ³é¢‘æµæœªç»è½¯ä»¶è§£ç çš„ï¼ˆä¸€èˆ¬æ˜¯ MP3ã€AAC ç­‰æ ¼å¼çš„æ•°æ®ï¼‰ï¼Œéœ€è¦è¾“å‡ºåˆ°ç¡¬ä»¶è§£ç å™¨ï¼Œç”±ç¡¬ä»¶è§£ç å™¨è§£ç æˆ PCM æ•°æ®</p><p>PlaybackThread ä¸­æœ‰ä¸ªæä¸ºé‡è¦çš„å‡½æ•° threadLoop()ï¼Œå½“ PlaybackThread è¢«å¼ºå¼•ç”¨æ—¶ï¼ŒthreadLoop() ä¼šçœŸæ­£è¿è¡Œèµ·æ¥è¿›å…¥å¾ªç¯ä¸»ä½“ï¼Œå¤„ç†éŸ³é¢‘æµæ•°æ®ç›¸å…³äº‹åŠ¡ï¼ŒthreadLoop() å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼ˆä»¥ MixerThread ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\Threads.cpp]</span><br><span class="line">bool AudioFlinger::PlaybackThread::threadLoop()</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    while (!exitPending())</span><br><span class="line">    &#123;</span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        &#123; // scope for mLock</span><br><span class="line"></span><br><span class="line">            Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">            processConfigEvents_l();</span><br><span class="line"></span><br><span class="line">            // ......</span><br><span class="line"></span><br><span class="line">            if ((!mActiveTracks.size() &amp;&amp; systemTime() &gt; mStandbyTimeNs) ||</span><br><span class="line">                                   isSuspended()) &#123;</span><br><span class="line">                // put audio hardware into standby after short delay</span><br><span class="line">                if (shouldStandby_l()) &#123;</span><br><span class="line"></span><br><span class="line">                    threadLoop_standby();</span><br><span class="line"></span><br><span class="line">                    mStandby = true;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // ......</span><br><span class="line">            &#125;</span><br><span class="line">            // mMixerStatusIgnoringFastTracks is also updated internally</span><br><span class="line">            mMixerStatus = prepareTracks_l(&amp;tracksToRemove);</span><br><span class="line"></span><br><span class="line">            // ......</span><br><span class="line">        &#125; // mLock scope ends</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        if (mBytesRemaining == 0) &#123;</span><br><span class="line">            mCurrentWriteLength = 0;</span><br><span class="line">            if (mMixerStatus == MIXER_TRACKS_READY) &#123;</span><br><span class="line">                // threadLoop_mix() sets mCurrentWriteLength</span><br><span class="line">                threadLoop_mix();</span><br><span class="line">            &#125;</span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        if (!waitingAsyncCallback()) &#123;</span><br><span class="line">            // mSleepTimeUs == 0 means we must write to audio hardware</span><br><span class="line">            if (mSleepTimeUs == 0) &#123;</span><br><span class="line">                // ......</span><br><span class="line">                if (mBytesRemaining) &#123;</span><br><span class="line">                    // FIXME rewrite to reduce number of system calls</span><br><span class="line">                    ret = threadLoop_write();</span><br><span class="line">                    lastWriteFinished = systemTime();</span><br><span class="line">                    delta = lastWriteFinished - mLastWriteTime;</span><br><span class="line">                    if (ret &lt; 0) &#123;</span><br><span class="line">                        mBytesRemaining = 0;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        mBytesWritten += ret;</span><br><span class="line">                        mBytesRemaining -= ret;</span><br><span class="line">                        mFramesWritten += ret / mFrameSize;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // ......</span><br><span class="line">            &#125;</span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Finally let go of removed track(s), without the lock held</span><br><span class="line">        // since we can&apos;t guarantee the destructors won&apos;t acquire that</span><br><span class="line">        // same lock.  This will also mutate and push a new fast mixer state.</span><br><span class="line">        threadLoop_removeTracks(tracksToRemove);</span><br><span class="line">        tracksToRemove.clear();</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    threadLoop_exit();</span><br><span class="line"></span><br><span class="line">    if (!mStandby) &#123;</span><br><span class="line">        threadLoop_standby();</span><br><span class="line">        mStandby = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ......</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>threadLoop() å¾ªç¯çš„æ¡ä»¶æ˜¯ exitPending() è¿”å› falseï¼Œå¦‚æœæƒ³è¦ PlaybackThread ç»“æŸå¾ªç¯ï¼Œåˆ™å¯ä»¥è°ƒç”¨ requestExit() æ¥è¯·æ±‚é€€å‡ºï¼›<br>processConfigEvents_l() ï¼šå¤„ç†é…ç½®äº‹ä»¶ï¼›å½“æœ‰é…ç½®æ”¹å˜çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œéœ€è¦è°ƒç”¨ sendConfigEvent_l() æ¥é€šçŸ¥ PlaybackThreadï¼Œè¿™æ · PlaybackThread æ‰èƒ½åŠæ—¶å¤„ç†é…ç½®äº‹ä»¶ï¼›å¸¸è§çš„é…ç½®äº‹ä»¶æ˜¯åˆ‡æ¢éŸ³é¢‘é€šè·¯ï¼›<br>æ£€æŸ¥æ­¤æ—¶æ­¤åˆ»æ˜¯å¦ç¬¦åˆ standby æ¡ä»¶ï¼Œæ¯”å¦‚å½“å‰å¹¶æ²¡æœ‰ ACTIVE çŠ¶æ€çš„ Trackï¼ˆmActiveTracks.size() = 0ï¼‰ï¼Œé‚£ä¹ˆè°ƒç”¨ threadLoop_standby() å…³é—­éŸ³é¢‘ç¡¬ä»¶è®¾å¤‡ä»¥èŠ‚çœèƒ½è€—ï¼›<br>prepareTracks_l()ï¼š å‡†å¤‡éŸ³é¢‘æµå’Œæ··éŸ³å™¨ï¼Œè¯¥å‡½æ•°éå¸¸å¤æ‚ï¼Œè¿™é‡Œä¸è¯¦ç»†åˆ†æäº†ï¼Œä»…åˆ—ä¸€ä¸‹æµç¨‹è¦ç‚¹ï¼š<br>éå† mActiveTracksï¼Œé€ä¸ªå¤„ç† mActiveTracks ä¸Šçš„ Trackï¼Œæ£€æŸ¥è¯¥ Track æ˜¯å¦ä¸º ACTIVE çŠ¶æ€ï¼›<br>å¦‚æœ Track è®¾ç½®æ˜¯ ACTIVE çŠ¶æ€ï¼Œåˆ™å†æ£€æŸ¥è¯¥ Track çš„æ•°æ®æ˜¯å¦å‡†å¤‡å°±ç»ªäº†ï¼›<br>æ ¹æ®éŸ³é¢‘æµçš„éŸ³é‡å€¼ã€æ ¼å¼ã€å£°é“æ•°ã€éŸ³è½¨çš„é‡‡æ ·ç‡ã€ç¡¬ä»¶è®¾å¤‡çš„é‡‡æ ·ç‡ï¼Œé…ç½®å¥½æ··éŸ³å™¨å‚æ•°ï¼›<br>å¦‚æœ Track çš„çŠ¶æ€æ˜¯ PAUSED æˆ– STOPPEDï¼Œåˆ™æŠŠè¯¥ Track æ·»åŠ åˆ° tracksToRemove å‘é‡ä¸­ï¼›<br>threadLoop_mix()ï¼šè¯»å–æ‰€æœ‰ç½®äº† ACTIVE çŠ¶æ€çš„éŸ³é¢‘æµæ•°æ®ï¼Œæ··éŸ³å™¨å¼€å§‹å¤„ç†è¿™äº›æ•°æ®ï¼›<br>threadLoop_write()ï¼š æŠŠæ··éŸ³å™¨å¤„ç†åçš„æ•°æ®å†™åˆ°è¾“å‡ºæµè®¾å¤‡ï¼›<br>threadLoop_removeTracks()ï¼š æŠŠ tracksToRemove ä¸Šçš„æ‰€æœ‰ Track ä» mActiveTracks ä¸­ç§»é™¤å‡ºæ¥ï¼›è¿™æ ·ä¸‹ä¸€æ¬¡å¾ªç¯æ—¶å°±ä¸ä¼šå¤„ç†è¿™äº› Track äº†ã€‚<br>è¿™é‡Œè¯´è¯´ PlaybackThread ä¸è¾“å‡ºæµè®¾å¤‡çš„å…³ç³»ï¼šPlaybackThread å®ä¾‹ä¸è¾“å‡ºæµè®¾å¤‡æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ¯”æ–¹è¯´ OffloadThread åªä¼šå°†éŸ³é¢‘æ•°æ®è¾“å‡ºåˆ° compress_offload è®¾å¤‡ä¸­ï¼ŒMixerThread(with FastMixer) åªä¼šå°†éŸ³é¢‘æ•°æ®è¾“å‡ºåˆ° low_latency è®¾å¤‡ä¸­ã€‚</p><p>ä» Audio HAL ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸çœ‹åˆ°å¦‚ä¸‹ 4 ç§è¾“å‡ºæµè®¾å¤‡ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¸åŒçš„æ’­æ”¾åœºæ™¯ï¼š</p><p>primary_outï¼šä¸»è¾“å‡ºæµè®¾å¤‡ï¼Œç”¨äºé“ƒå£°ç±»å£°éŸ³è¾“å‡ºï¼Œå¯¹åº”ç€æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_PRIMARY çš„éŸ³é¢‘æµå’Œä¸€ä¸ª MixerThread å›æ”¾çº¿ç¨‹å®ä¾‹<br>low_latencyï¼šä½å»¶è¿Ÿè¾“å‡ºæµè®¾å¤‡ï¼Œç”¨äºæŒ‰é”®éŸ³ã€æ¸¸æˆèƒŒæ™¯éŸ³ç­‰å¯¹æ—¶å»¶è¦æ±‚é«˜çš„å£°éŸ³è¾“å‡ºï¼Œå¯¹åº”ç€æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_FAST çš„éŸ³é¢‘æµå’Œä¸€ä¸ª MixerThread å›æ”¾çº¿ç¨‹å®ä¾‹<br>deep_bufferï¼šéŸ³ä¹éŸ³è½¨è¾“å‡ºæµè®¾å¤‡ï¼Œç”¨äºéŸ³ä¹ç­‰å¯¹æ—¶å»¶è¦æ±‚ä¸é«˜çš„å£°éŸ³è¾“å‡ºï¼Œå¯¹åº”ç€æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_DEEP_BUFFER çš„éŸ³é¢‘æµå’Œä¸€ä¸ª MixerThread å›æ”¾çº¿ç¨‹å®ä¾‹<br>compress_offloadï¼šç¡¬è§£è¾“å‡ºæµè®¾å¤‡ï¼Œç”¨äºéœ€è¦ç¡¬ä»¶è§£ç çš„æ•°æ®è¾“å‡ºï¼Œå¯¹åº”ç€æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD çš„éŸ³é¢‘æµå’Œä¸€ä¸ª OffloadThread å›æ”¾çº¿ç¨‹å®ä¾‹<br>å…¶ä¸­ primary_out è®¾å¤‡æ˜¯å¿…é¡»å£°æ˜æ”¯æŒçš„ï¼Œè€Œä¸”ç³»ç»Ÿå¯åŠ¨æ—¶å°±å·²ç»æ‰“å¼€ primary_out è®¾å¤‡å¹¶åˆ›å»ºå¥½å¯¹åº”çš„ MixerThread å®ä¾‹ã€‚å…¶ä»–ç±»å‹çš„è¾“å‡ºæµè®¾å¤‡å¹¶éå¿…é¡»å£°æ˜æ”¯æŒçš„ï¼Œä¸»è¦æ˜¯çœ‹ç¡¬ä»¶ä¸Šæœ‰æ— è¿™ä¸ªèƒ½åŠ›ã€‚</p><p>å¯èƒ½æœ‰äººäº§ç”Ÿè¿™æ ·çš„ç–‘é—®ï¼šæ—¢ç„¶ primary_out è®¾å¤‡ä¸€ç›´ä¿æŒæ‰“å¼€ï¼Œé‚£ä¹ˆèƒ½è€—å²‚ä¸æ˜¯å¾ˆå¤§ï¼Ÿè¿™é‡Œé˜é‡Šä¸€ä¸ªæ¦‚å¿µï¼šè¾“å‡ºæµè®¾å¤‡å±äºé€»è¾‘è®¾å¤‡ï¼Œå¹¶ä¸æ˜¯ç¡¬ä»¶è®¾å¤‡ã€‚æ‰€ä»¥å³ä½¿è¾“å‡ºæµè®¾å¤‡ä¸€ç›´ä¿æŒæ‰“å¼€ï¼Œåªè¦ç¡¬ä»¶è®¾å¤‡ä¸å·¥ä½œï¼Œé‚£ä¹ˆå°±ä¸ä¼šå½±å“èƒ½è€—ã€‚é‚£ä¹ˆç¡¬ä»¶è®¾å¤‡ä»€ä¹ˆæ—¶å€™æ‰ä¼šæ‰“å¼€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ PlaybackThread å°†éŸ³é¢‘æ•°æ®å†™å…¥åˆ°è¾“å‡ºæµè®¾å¤‡æ—¶ã€‚</p><p>ä¸‹å›¾ç®€å•æè¿° AudioTrackã€PlaybackThreadã€è¾“å‡ºæµè®¾å¤‡ä¸‰è€…çš„å¯¹åº”å…³ç³»ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/33-Audio-system-Audio-playback-.png" alt="Alt text"></p><p>æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆè¯´ï¼šè¾“å‡ºæµè®¾å¤‡å†³å®šäº†å®ƒå¯¹åº”çš„ PlaybackThread æ˜¯ä»€ä¹ˆç±»å‹ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿæ„æ€æ˜¯è¯´ï¼šåªæœ‰æ”¯æŒäº†è¯¥ç±»å‹çš„è¾“å‡ºæµè®¾å¤‡ï¼Œé‚£ä¹ˆè¯¥ç±»å‹çš„ PlaybackThread æ‰æœ‰å¯èƒ½è¢«åˆ›å»ºã€‚ä¸¾ä¸ªä¾‹å­ï¼šåªæœ‰ç¡¬ä»¶ä¸Šå…·å¤‡ç¡¬ä»¶è§£ç å™¨ï¼Œç³»ç»Ÿæ‰å»ºç«‹ compress_offload è®¾å¤‡ï¼Œç„¶åæ’­æ”¾ mp3 æ ¼å¼çš„éŸ³ä¹æ–‡ä»¶æ—¶ï¼Œæ‰ä¼šåˆ›å»º OffloadThread æŠŠæ•°æ®è¾“å‡ºåˆ° compress_offload è®¾å¤‡ä¸Šï¼›åä¹‹ï¼Œå¦‚æœç¡¬ä»¶ä¸Šå¹¶ä¸å…·å¤‡ç¡¬ä»¶è§£ç å™¨ï¼Œç³»ç»Ÿåˆ™ä¸åº”è¯¥å»ºç«‹ compress_offload è®¾å¤‡ï¼Œé‚£ä¹ˆæ’­æ”¾ mp3 æ ¼å¼çš„éŸ³ä¹æ–‡ä»¶æ—¶ï¼Œé€šè¿‡ MixerThread æŠŠæ•°æ®è¾“å‡ºåˆ°å…¶ä»–è¾“å‡ºæµè®¾å¤‡ä¸Šã€‚</p><p>é‚£ä¹ˆæœ‰æ— å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼šåº•å±‚å¹¶ä¸æ”¯æŒ compress_offload è®¾å¤‡ï¼Œä½†ååæœ‰ä¸ªæ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD çš„éŸ³é¢‘æµé€åˆ° AudioFlinger äº†å‘¢ï¼Ÿè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šæ£€æŸ¥å¹¶ä¿å­˜è¾“å…¥è¾“å‡ºæµè®¾å¤‡çš„æ”¯æŒä¿¡æ¯ï¼›æ’­æ”¾å™¨åœ¨æ’­æ”¾ mp3 æ–‡ä»¶æ—¶ï¼Œé¦–å…ˆçœ‹ compress_offload è®¾å¤‡æ˜¯å¦æ”¯æŒäº†ï¼Œå¦‚æœæ”¯æŒï¼Œé‚£ä¹ˆä¸è¿›è¡Œè½¯ä»¶è§£ç ï¼Œç›´æ¥æŠŠæ•°æ®æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOADï¼›å¦‚æœä¸æ”¯æŒï¼Œé‚£ä¹ˆå…ˆè¿›è¡Œè½¯ä»¶è§£ç ï¼Œç„¶åæŠŠè§£ç å¥½çš„æ•°æ®æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_DEEP_BUFFERï¼Œå‰ææ˜¯ deep_buffer è®¾å¤‡æ˜¯æ”¯æŒäº†çš„ï¼›å¦‚æœ deep_buffer è®¾å¤‡ä¹Ÿä¸æ”¯æŒï¼Œé‚£ä¹ˆæŠŠæ•°æ®æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_PRIMARYã€‚</p><p>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå°±å·²ç»æ‰“å¼€ primary_outã€low_latencyã€deep_buffer è¿™ä¸‰ç§è¾“å‡ºæµè®¾å¤‡ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ MixerThread äº†ï¼›è€Œæ­¤æ—¶ DirectOutputThread ä¸ OffloadThread ä¸ä¼šè¢«åˆ›å»ºï¼Œç›´åˆ°æ ‡è¯†ä¸º AUDIO_OUTPUT_FLAG_DIRECT/AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD çš„éŸ³é¢‘æµéœ€è¦è¾“å‡ºæ—¶ï¼Œæ‰å¼€å§‹åˆ›å»º DirectOutputThread/OffloadThread å’Œæ‰“å¼€ direct_out/compress_offload è®¾å¤‡ã€‚è¿™ä¸€ç‚¹è¯·å‚è€ƒå¦‚ä¸‹ä»£ç ï¼Œæ³¨é‡Šéå¸¸æ¸…æ™°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\managerdefault\AudioPolicyManager.cpp]</span><br><span class="line">AudioPolicyManager::AudioPolicyManager(AudioPolicyClientInterface *clientInterface)</span><br><span class="line">    // ......</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    // mAvailableOutputDevices and mAvailableInputDevices now contain all attached devices</span><br><span class="line">    // open all output streams needed to access attached devices</span><br><span class="line">    // ......</span><br><span class="line">    for (size_t i = 0; i &lt; mHwModules.size(); i++) &#123;</span><br><span class="line">        // ......</span><br><span class="line">        // open all output streams needed to access attached devices</span><br><span class="line">        // except for direct output streams that are only opened when they are actually</span><br><span class="line">        // required by an app.</span><br><span class="line">        // This also validates mAvailableOutputDevices list</span><br><span class="line">        for (size_t j = 0; j &lt; mHwModules[i]-&gt;mOutputProfiles.size(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            // ......</span><br><span class="line">            if ((outProfile-&gt;getFlags() &amp; AUDIO_OUTPUT_FLAG_DIRECT) != 0) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            // ......</span><br><span class="line">            audio_io_handle_t output = AUDIO_IO_HANDLE_NONE;</span><br><span class="line">            status_t status = mpClientInterface-&gt;openOutput(outProfile-&gt;getModuleHandle(),</span><br><span class="line">                                                            &amp;output,</span><br><span class="line">                                                            &amp;config,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mDevice,</span><br><span class="line">                                                            address,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mLatency,</span><br><span class="line">                                                            outputDesc-&gt;mFlags);</span><br><span class="line"></span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line">        // open input streams needed to access attached devices to validate</span><br><span class="line">        // mAvailableInputDevices list</span><br><span class="line">        for (size_t j = 0; j &lt; mHwModules[i]-&gt;mInputProfiles.size(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            // ......</span><br><span class="line">            status_t status = mpClientInterface-&gt;openInput(inProfile-&gt;getModuleHandle(),</span><br><span class="line">                                                           &amp;input,</span><br><span class="line">                                                           &amp;config,</span><br><span class="line">                                                           &amp;inputDesc-&gt;mDevice,</span><br><span class="line">                                                           address,</span><br><span class="line">                                                           AUDIO_SOURCE_MIC,</span><br><span class="line">                                                           AUDIO_INPUT_FLAG_NONE);</span><br><span class="line"></span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    updateDevicesAndOutputs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ mpClientInterface-&gt;openOutput() æœ€ç»ˆä¼šè°ƒç”¨åˆ° AudioFlinger::openOutput()ï¼šæ‰“å¼€è¾“å‡ºæµè®¾å¤‡ï¼Œå¹¶åˆ›å»º PlaybackThread å¯¹è±¡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">status_t AudioFlinger::openOutput(audio_module_handle_t module,</span><br><span class="line">                                  audio_io_handle_t *output,</span><br><span class="line">                                  audio_config_t *config,</span><br><span class="line">                                  audio_devices_t *devices,</span><br><span class="line">                                  const String8&amp; address,</span><br><span class="line">                                  uint32_t *latencyMs,</span><br><span class="line">                                  audio_output_flags_t flags)</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">    sp&lt;PlaybackThread&gt; thread = openOutput_l(module, output, config, *devices, address, flags);</span><br><span class="line">    // ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;AudioFlinger::PlaybackThread&gt; AudioFlinger::openOutput_l(audio_module_handle_t module,</span><br><span class="line">                                                            audio_io_handle_t *output,</span><br><span class="line">                                                            audio_config_t *config,</span><br><span class="line">                                                            audio_devices_t devices,</span><br><span class="line">                                                            const String8&amp; address,</span><br><span class="line">                                                            audio_output_flags_t flags)</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line">    // åˆ†é…å…¨å±€å”¯ä¸€çš„ audio_io_handle_tï¼Œå¯ä»¥ç†è§£å®ƒæ˜¯å›æ”¾çº¿ç¨‹çš„ç´¢å¼•å·</span><br><span class="line">    if (*output == AUDIO_IO_HANDLE_NONE) &#123;</span><br><span class="line">        *output = nextUniqueId(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mHardwareStatus = AUDIO_HW_OUTPUT_OPEN;</span><br><span class="line"></span><br><span class="line">    //......</span><br><span class="line"></span><br><span class="line">    // æ‰“å¼€éŸ³é¢‘è¾“å‡ºæµè®¾å¤‡ï¼ŒHAL å±‚æ ¹æ® flags é€‰æ‹©æ‰“å¼€ç›¸å…³ç±»å‹çš„è¾“å‡ºæµè®¾å¤‡</span><br><span class="line">    AudioStreamOut *outputStream = NULL;</span><br><span class="line">    status_t status = outHwDev-&gt;openOutputStream(</span><br><span class="line">            &amp;outputStream,</span><br><span class="line">            *output,</span><br><span class="line">            devices,</span><br><span class="line">            flags,</span><br><span class="line">            config,</span><br><span class="line">            address.string());</span><br><span class="line"></span><br><span class="line">    mHardwareStatus = AUDIO_HW_IDLE;</span><br><span class="line"></span><br><span class="line">    if (status == NO_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">        PlaybackThread *thread;</span><br><span class="line">        if (flags &amp; AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD) &#123;</span><br><span class="line">            // AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD éŸ³é¢‘æµï¼Œåˆ›å»º OffloadThread å®ä¾‹</span><br><span class="line">            thread = new OffloadThread(this, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(&quot;openOutput_l() created offload output: ID %d thread %p&quot;, *output, thread);</span><br><span class="line">        &#125; else if ((flags &amp; AUDIO_OUTPUT_FLAG_DIRECT)</span><br><span class="line">                || !isValidPcmSinkFormat(config-&gt;format)</span><br><span class="line">                || !isValidPcmSinkChannelMask(config-&gt;channel_mask)) &#123;</span><br><span class="line">            // AUDIO_OUTPUT_FLAG_DIRECT éŸ³é¢‘æµï¼Œåˆ›å»º DirectOutputThread å®ä¾‹</span><br><span class="line">            thread = new DirectOutputThread(this, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(&quot;openOutput_l() created direct output: ID %d thread %p&quot;, *output, thread);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // å…¶ä»–æ ‡è¯†çš„éŸ³é¢‘æµï¼Œåˆ›å»º MixerThread å®ä¾‹</span><br><span class="line">            thread = new MixerThread(this, outputStream, *output, devices, mSystemReady);</span><br><span class="line">            ALOGV(&quot;openOutput_l() created mixer output: ID %d thread %p&quot;, *output, thread);</span><br><span class="line">        &#125;</span><br><span class="line">        // æŠŠ audio_io_handle_t å’Œ PlaybackThread æ·»åŠ åˆ°é”®å€¼å¯¹å‘é‡ mPlaybackThreads ä¸­</span><br><span class="line">        // é”®å€¼å¯¹å‘é‡ mPlaybackThreads ä¸­ï¼Œç”±äº audio_io_handle_t å’Œ PlaybackThread æ˜¯ä¸€</span><br><span class="line">        // ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæ‰€ä»¥æ‹¿åˆ°ä¸€ä¸ª audio_io_handle_tï¼Œå°±èƒ½æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThread</span><br><span class="line">        // æ‰€ä»¥å¯ä»¥ç†è§£ audio_io_handle_t ä¸º PlaybackThread çš„ç´¢å¼•å·</span><br><span class="line">        mPlaybackThreads.add(*output, thread);</span><br><span class="line">        return thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="1-2-3ã€AudioFlinger-éŸ³é¢‘æµç®¡ç†"><a href="#1-2-3ã€AudioFlinger-éŸ³é¢‘æµç®¡ç†" class="headerlink" title="1.2.3ã€AudioFlinger éŸ³é¢‘æµç®¡ç†"></a>1.2.3ã€AudioFlinger éŸ³é¢‘æµç®¡ç†</h5><p>AudioFlinger éŸ³é¢‘æµç®¡ç†ç”± AudioFlinger::PlaybackThread::Track å®ç°ï¼ŒTrack ä¸ AudioTrack æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¸€ä¸ª AudioTrack åˆ›å»ºåï¼Œé‚£ä¹ˆ AudioFlinger ä¼šåˆ›å»ºä¸€ä¸ª Track ä¸ä¹‹å¯¹åº”ï¼›PlaybackThread ä¸ AudioTrack/Track æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¸€ä¸ª PlaybackThread å¯ä»¥æŒ‚ç€å¤šä¸ª Trackã€‚</p><p>å…·ä½“æ¥è¯´ï¼šAudioTrack åˆ›å»ºåï¼ŒAudioPolicyManager æ ¹æ® AudioTrack çš„è¾“å‡ºæ ‡è¯†å’Œæµç±»å‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„è¾“å‡ºæµè®¾å¤‡å’Œ PlaybackThreadï¼ˆå¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯ï¼Œåˆ™ç³»ç»Ÿä¼šæ‰“å¼€å¯¹åº”çš„è¾“å‡ºæµè®¾å¤‡å¹¶æ–°å»ºä¸€ä¸ª PlaybackThreadï¼‰ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Track å¹¶æŒ‚åˆ°è¿™ä¸ª PlaybackThread ä¸‹é¢ã€‚</p><p>PlaybackThread æœ‰ä¸¤ä¸ªç§æœ‰æˆå‘˜å‘é‡ä¸æ­¤å¼ºç›¸å…³ï¼š</p><p>Â· mTracksï¼šè¯¥ PlaybackThread åˆ›å»ºçš„æ‰€æœ‰ Track å‡æ·»åŠ ä¿å­˜åˆ°è¿™ä¸ªå‘é‡ä¸­<br>Â· mActiveTracksï¼šåªæœ‰éœ€è¦æ’­æ”¾ï¼ˆè®¾ç½®äº† ACTIVE çŠ¶æ€ï¼‰çš„ Track ä¼šæ·»åŠ åˆ°è¿™ä¸ªå‘é‡ä¸­ï¼›PlaybackThread ä¼šä»è¯¥å‘é‡ä¸Šæ‰¾åˆ°æ‰€æœ‰è®¾ç½®äº† ACTIVE çŠ¶æ€çš„ Trackï¼ŒæŠŠè¿™äº› Track æ•°æ®æ··éŸ³åå†™åˆ°è¾“å‡ºæµè®¾å¤‡<br>éŸ³é¢‘æµæ§åˆ¶æœ€å¸¸ç”¨çš„ä¸‰ä¸ªæ¥å£ï¼š</p><p>AudioFlinger::PlaybackThread::Track::startï¼šå¼€å§‹æ’­æ”¾ï¼šæŠŠè¯¥ Track ç½® ACTIVE çŠ¶æ€ï¼Œç„¶åæ·»åŠ åˆ° mActiveTracks å‘é‡ä¸­ï¼Œæœ€åè°ƒç”¨ AudioFlinger::PlaybackThread::broadcast_l() å‘ŠçŸ¥ PlaybackThread æƒ…å†µæœ‰å˜<br>Â· AudioFlinger::PlaybackThread::Track::stopï¼šåœæ­¢æ’­æ”¾ï¼šæŠŠè¯¥ Track ç½® STOPPED çŠ¶æ€ï¼Œæœ€åè°ƒç”¨ AudioFlinger::PlaybackThread::broadcast_l() å‘ŠçŸ¥ PlaybackThread æƒ…å†µæœ‰å˜<br>Â· AudioFlinger::PlaybackThread::Track::pauseï¼šæš‚åœæ’­æ”¾ï¼šæŠŠè¯¥ Track ç½® PAUSING çŠ¶æ€ï¼Œæœ€åè°ƒç”¨ AudioFlinger::PlaybackThread::broadcast_l() å‘ŠçŸ¥ PlaybackThread æƒ…å†µæœ‰å˜<br>Â· AudioFlinger::PlaybackThread::threadLoop() å¾—æ‚‰æƒ…å†µæœ‰å˜åï¼Œè°ƒç”¨ prepareTracks_l() é‡æ–°å‡†å¤‡éŸ³é¢‘æµå’Œæ··éŸ³å™¨ï¼šACTIVE çŠ¶æ€çš„ Track ä¼šæ·»åŠ åˆ° mActiveTracksï¼Œæ­¤å¤–çš„ Track ä¼šä» mActiveTracks ä¸Šç§»é™¤å‡ºæ¥ï¼Œç„¶åé‡æ–°å‡†å¤‡ AudioMixerã€‚</p><p>å¯è§è¿™ä¸‰ä¸ªéŸ³é¢‘æµæ§åˆ¶æ¥å£æ˜¯éå¸¸ç®€å•çš„ï¼Œä¸»è¦æ˜¯è®¾ç½®ä¸€ä¸‹ Track çš„çŠ¶æ€ï¼Œç„¶åå‘ä¸ªäº‹ä»¶é€šçŸ¥ PlaybackThread å°±è¡Œï¼Œå¤æ‚çš„å¤„ç†éƒ½åœ¨ AudioFlinger::PlaybackThread::threadLoop() ä¸­äº†ã€‚</p><h4 id="äºŒ-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService"><a href="#äºŒ-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService" class="headerlink" title="(äºŒ)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService"></a>(äºŒ)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioPolicyService</h4><p>AudioPolicyServiceæ˜¯ç­–ç•¥çš„åˆ¶å®šè€…ï¼Œæ¯”å¦‚ä»€ä¹ˆæ—¶å€™æ‰“å¼€éŸ³é¢‘æ¥å£è®¾å¤‡ã€æŸç§Streamç±»å‹çš„éŸ³é¢‘å¯¹åº”ä»€ä¹ˆè®¾å¤‡ç­‰ç­‰ã€‚è€ŒAudioFlingeråˆ™æ˜¯ç­–ç•¥çš„æ‰§è¡Œè€…ï¼Œä¾‹å¦‚å…·ä½“å¦‚ä½•ä¸éŸ³é¢‘è®¾å¤‡é€šä¿¡ï¼Œå¦‚ä½•ç»´æŠ¤ç°æœ‰ç³»ç»Ÿä¸­çš„éŸ³é¢‘è®¾å¤‡ï¼Œä»¥åŠå¤šä¸ªéŸ³é¢‘æµçš„æ··éŸ³å¦‚ä½•å¤„ç†ç­‰ç­‰éƒ½å¾—ç”±å®ƒæ¥å®Œæˆã€‚AudioPolicyServiceæ ¹æ®ç”¨æˆ·é…ç½®æ¥æŒ‡å¯¼AudioFlingeråŠ è½½è®¾å¤‡æ¥å£ï¼Œèµ·åˆ°è·¯ç”±åŠŸèƒ½</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\audioserver\main_audioserver.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (doLog &amp;&amp; (childPid = fork()) != <span class="number">0</span>) &#123;</span><br><span class="line">    ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// all other services</span></span><br><span class="line">        <span class="keyword">if</span> (doLog) &#123;</span><br><span class="line">            prctl(PR_SET_PDEATHSIG, SIGKILL);   <span class="comment">// if parent media.log dies before me, kill me also</span></span><br><span class="line">            setpgid(<span class="number">0</span>, <span class="number">0</span>);                      <span class="comment">// but if I die first, don't kill my parent</span></span><br><span class="line">        &#125;</span><br><span class="line">        sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">        sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">        ALOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">        AudioFlinger::instantiate();</span><br><span class="line">        AudioPolicyService::instantiate();</span><br><span class="line">        RadioService::instantiate();</span><br><span class="line">        SoundTriggerHwService::instantiate();</span><br><span class="line">        ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AudioPolicyServiceç»§æ‰¿äº†æ¨¡æ¿ç±»BinderServiceï¼Œè¯¥ç±»ç”¨äºæ³¨å†Œnative serviceã€‚<br>BinderServiceæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œè¯¥ç±»çš„publishå‡½æ•°å°±æ˜¯å®Œæˆå‘ServiceManageræ³¨å†ŒæœåŠ¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\service\AudioPolicyService.h]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">getServiceName</span><span class="params">()</span> ANDROID_API </span>&#123; <span class="keyword">return</span> <span class="string">"media.audio_policy"</span>; &#125;</span><br></pre></td></tr></table></figure><p>AudioPolicyServiceæ³¨å†Œåä¸ºâ€media.audio_policyâ€çš„æœåŠ¡ã€‚<br>é¦–å…ˆçœ‹çœ‹AudioPolicyServiceçš„onFirstRef()å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\service\AudioPolicyService.cpp]</span><br><span class="line"></span><br><span class="line">AudioPolicyService::AudioPolicyService()</span><br><span class="line">    : BnAudioPolicyService(), mpAudioPolicyDev(<span class="literal">NULL</span>), mpAudioPolicy(<span class="literal">NULL</span>),</span><br><span class="line">      mAudioPolicyManager(<span class="literal">NULL</span>), mAudioPolicyClient(<span class="literal">NULL</span>), mPhoneState(AUDIO_MODE_INVALID)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> AudioPolicyService::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        <span class="comment">/* Step 1:åˆ›å»ºAudioCommandThreadçº¿ç¨‹ */</span></span><br><span class="line">        <span class="comment">// start tone playback thread</span></span><br><span class="line">        mTonePlaybackThread = <span class="keyword">new</span> AudioCommandThread(String8(<span class="string">"ApmTone"</span>), <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// start audio commands thread</span></span><br><span class="line">        mAudioCommandThread = <span class="keyword">new</span> AudioCommandThread(String8(<span class="string">"ApmAudio"</span>), <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// start output activity command thread</span></span><br><span class="line">        mOutputCommandThread = <span class="keyword">new</span> AudioCommandThread(String8(<span class="string">"ApmOutput"</span>), <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_LEGACY_AUDIO_POLICY</span></span><br><span class="line">         <span class="comment">// ä½¿ç”¨è€ç‰ˆæœ¬çš„ audio policy åˆå§‹åŒ–æ–¹å¼</span></span><br><span class="line">        ....</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æœ€æ–°çš„ audio policy åˆå§‹åŒ–æ–¹å¼</span></span><br><span class="line">        ALOGI(<span class="string">"AudioPolicyService CSTOR in new mode"</span>);</span><br><span class="line">        <span class="comment">/* Step 2:åˆ›å»ºAudioPolicyClientã€ AudioPolicyManager */</span></span><br><span class="line">        mAudioPolicyClient = <span class="keyword">new</span> AudioPolicyClient(<span class="keyword">this</span>);</span><br><span class="line">        mAudioPolicyManager = createAudioPolicyManager(mAudioPolicyClient);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// load audio processing modules</span></span><br><span class="line">    sp&lt;AudioPolicyEffects&gt;audioPolicyEffects = <span class="keyword">new</span> AudioPolicyEffects();</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        mAudioPolicyEffects = audioPolicyEffects;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹çœ‹æ€»ä½“æ—¶åºå›¾ï¼š</p><h5 id="2-1ã€Step-1-åˆ›å»ºAudioCommandThreadçº¿ç¨‹"><a href="#2-1ã€Step-1-åˆ›å»ºAudioCommandThreadçº¿ç¨‹" class="headerlink" title="2.1ã€Step 1:åˆ›å»ºAudioCommandThreadçº¿ç¨‹"></a>2.1ã€Step 1:åˆ›å»ºAudioCommandThreadçº¿ç¨‹</h5><p>åœ¨AudioPolicyServiceå¯¹è±¡æ„é€ è¿‡ç¨‹ä¸­ï¼Œåˆ†åˆ«åˆ›å»ºäº†ApmToneã€ApmAudioã€ApmOutputä¸‰ä¸ªAudioCommandThreadçº¿ç¨‹ï¼š</p><p>1ã€ ApmToneç”¨äºæ’­æ”¾toneéŸ³ï¼›</p><p>2ã€ ApmAudioç”¨äºæ‰§è¡Œaudioå‘½ä»¤ï¼›</p><p>3ã€ApmOutputç”¨äºæ‰§è¡Œè¾“å‡ºå‘½ä»¤ï¼›</p><p>åœ¨ç¬¬ä¸€æ¬¡å¼ºå¼•ç”¨AudioCommandThreadçº¿ç¨‹å¯¹è±¡æ—¶ï¼ŒAudioCommandThreadçš„onFirstRefå‡½æ•°è¢«å›è°ƒï¼Œåœ¨æ­¤å¯åŠ¨çº¿ç¨‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\service\AudioPolicyService.cpp]</span><br><span class="line"><span class="keyword">void</span> AudioPolicyService::AudioCommandThread::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    run(mName.<span class="built_in">string</span>(), ANDROID_PRIORITY_AUDIO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡‡ç”¨å¼‚æ­¥æ–¹å¼æ¥æ‰§è¡Œaudio commandï¼Œå½“éœ€è¦æ‰§è¡Œä¸Šè¡¨ä¸­çš„å‘½ä»¤æ—¶ï¼Œé¦–å…ˆå°†å‘½ä»¤æŠ•é€’åˆ°AudioCommandThreadçš„mAudioCommandså‘½ä»¤å‘é‡è¡¨ä¸­ï¼Œç„¶åé€šè¿‡mWaitWorkCV.signal()å”¤é†’AudioCommandThreadçº¿ç¨‹ï¼Œè¢«å”¤é†’çš„AudioCommandThreadçº¿ç¨‹æ‰§è¡Œå®Œcommandåï¼Œåˆé€šè¿‡mWaitWorkCV.waitRelative(mLock, waitTime)ç¡çœ ç­‰å¾…å‘½ä»¤åˆ°æ¥ã€‚</p><h5 id="2-2ã€Step-2-åˆ›å»ºAudioPolicyClientã€-AudioPolicyManager"><a href="#2-2ã€Step-2-åˆ›å»ºAudioPolicyClientã€-AudioPolicyManager" class="headerlink" title="2.2ã€Step 2: åˆ›å»ºAudioPolicyClientã€ AudioPolicyManager"></a>2.2ã€Step 2: åˆ›å»ºAudioPolicyClientã€ AudioPolicyManager</h5><p>é¦–å…ˆåˆ›å»ºAudioPolicyClient</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\service\AudioPolicyService.h]</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AudioPolicyClient</span> :</span> <span class="keyword">public</span> AudioPolicyClientInterface</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="keyword">public</span>:</span><br><span class="line">        AudioPolicyClient(AudioPolicyService *service) : mAudioPolicyService(service) &#123;&#125;</span><br><span class="line">        <span class="keyword">virtual</span> ~AudioPolicyClient() &#123;&#125;</span><br><span class="line">        <span class="comment">// loads a HW module.</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> audio_module_handle_t <span class="title">loadHwModule</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> status_t <span class="title">openOutput</span><span class="params">(<span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">audio_io_handle_t</span> *output,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">audio_config_t</span> *config,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">audio_devices_t</span> *devices,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">const</span> String8&amp; address,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">uint32_t</span> *latencyMs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">audio_output_flags_t</span> flags)</span></span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// opens an audio input</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> audio_io_handle_t <span class="title">openInput</span><span class="params">(<span class="keyword">audio_module_handle_t</span> <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_io_handle_t</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_config_t</span> *config,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_devices_t</span> *devices,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">const</span> String8&amp; address,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_source_t</span> source,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">audio_input_flags_t</span> flags)</span></span>;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span>:</span><br><span class="line">        AudioPolicyService *mAudioPolicyService;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>createAudioPolicyManager() å‡½æ•°çš„å®ç°ä½äº frameworks/av/services/audiopolicy/manager/AudioPolicyFactory.cppæ–‡ä»¶ä¸­ã€‚æŸ¥çœ‹æºç åæˆ‘ä»¬ä¼šå‘ç°å®ƒå®é™…ä¸Šæ˜¯ç›´æ¥è°ƒç”¨äº† AudioPolicyManager çš„æ„é€ å‡½æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\manager\AudioPolicyFactory.cpp]</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">AudioPolicyInterface* <span class="title">createAudioPolicyManager</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        AudioPolicyClientInterface *clientInterface)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AudioPolicyManager(clientInterface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3ã€åˆ›å»ºAudioPolicyManager"><a href="#2-3ã€åˆ›å»ºAudioPolicyManager" class="headerlink" title="2.3ã€åˆ›å»ºAudioPolicyManager()"></a>2.3ã€åˆ›å»ºAudioPolicyManager()</h5><p>æ€»ä½“æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/34-Audio-system-CreateAudioPolicyManager.png" alt="Alt text"></p><p>AudioPolicyManager çš„æ„é€ å‡½æ•°å°†è§£æéŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶ï¼Œä»è€Œè·å–åˆ°è®¾å¤‡æ‰€æ”¯æŒçš„éŸ³é¢‘è®¾å¤‡ä¿¡æ¯ï¼ˆåŒ…æ‹¬è®¾å¤‡æ˜¯å¦æ”¯æŒ Offloadã€Direct æ¨¡å¼è¾“å‡ºï¼Œå„è¾“å…¥è¾“å‡º profile æ‰€æ”¯æŒçš„é‡‡æ ·ç‡ã€é€šé“æ•°ã€æ•°æ®æ ¼å¼ç­‰ï¼‰ï¼ŒåŠ è½½å…¨éƒ¨ HwModuleï¼Œä¸ºä¹‹åˆ›å»ºæ‰€æœ‰é direct è¾“å‡ºç±»å‹çš„ outputStream å’Œæ‰€æœ‰ inputStreamï¼Œå¹¶åˆ›å»ºç›¸åº”çš„ playbackThread æˆ– recordThread çº¿ç¨‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAndroid 7.0ä¸Šçš„éŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶å¼€å§‹ä½¿ç”¨ XML æ ¼å¼ï¼Œå…¶æ–‡ä»¶åä¸º audio_policy_configuration.xmlï¼Œ</p><p>è€Œåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸ŠéŸ³é¢‘ç­–ç•¥é…ç½®æ–‡ä»¶ä¸º audio_policy.confã€‚frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp ä¸­ AudioPolicyManager æ„é€ å‡½æ•°çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\managerdefault\AudioPolicyManager.cpp]</span><br><span class="line">AudioPolicyManager::AudioPolicyManager(AudioPolicyClientInterface *clientInterface)</span><br><span class="line">    :</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> AUDIO_POLICY_TEST</span></span><br><span class="line">    Thread(<span class="literal">false</span>),</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//AUDIO_POLICY_TEST</span></span></span><br><span class="line">    mLimitRingtoneVolume(<span class="literal">false</span>), mLastVoiceVolume(<span class="number">-1.0f</span>),</span><br><span class="line">    mA2dpSuspended(<span class="literal">false</span>),</span><br><span class="line">    mAudioPortGeneration(<span class="number">1</span>),</span><br><span class="line">    mBeaconMuteRefCount(<span class="number">0</span>),</span><br><span class="line">    mBeaconPlayingRefCount(<span class="number">0</span>),</span><br><span class="line">    mBeaconMuted(<span class="literal">false</span>),</span><br><span class="line">    mTtsOutputAvailable(<span class="literal">false</span>),</span><br><span class="line">    mMasterMono(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_XML_AUDIO_POLICY_CONF</span></span><br><span class="line">    <span class="comment">// è®¾å¤‡ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ä¸º audio_policy_configuration.xml</span></span><br><span class="line">    mVolumeCurves = <span class="keyword">new</span> VolumeCurvesCollection();</span><br><span class="line">    <span class="function">AudioPolicyConfig <span class="title">config</span><span class="params">(mHwModules, mAvailableOutputDevices, mAvailableInputDevices,</span></span></span><br><span class="line"><span class="function"><span class="params">                             mDefaultOutputDevice, speakerDrcEnabled,</span></span></span><br><span class="line">                             static_cast&lt;VolumeCurvesCollection *&gt;(mVolumeCurves));</span><br><span class="line">    PolicySerializer serializer;</span><br><span class="line">    <span class="comment">// è§£æ xml é…ç½®æ–‡ä»¶ï¼Œå°†è®¾å¤‡æ”¯æŒçš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿å­˜åœ¨ mAvailableOutputDevices å˜é‡ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// å°†è®¾å¤‡æ”¯æŒçš„éŸ³é¢‘è¾“å…¥è®¾å¤‡ä¿å­˜åœ¨ mAvailableInputDevices å˜é‡ä¸­ï¼Œå°†è®¾å¤‡çš„é»˜è®¤éŸ³é¢‘è¾“å‡º</span></span><br><span class="line">    <span class="comment">// è®¾å¤‡ä¿å­˜åœ¨ mDefaultOutputDevice å˜é‡ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (serializer.deserialize(AUDIO_POLICY_XML_CONFIG_FILE, config) != NO_ERROR) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">// è®¾å¤‡ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ä¸º audio_policy.conf</span></span><br><span class="line">    mVolumeCurves = <span class="keyword">new</span> StreamDescriptorCollection();</span><br><span class="line">    <span class="function">AudioPolicyConfig <span class="title">config</span><span class="params">(mHwModules, mAvailableOutputDevices, mAvailableInputDevices,</span></span></span><br><span class="line"><span class="function"><span class="params">                             mDefaultOutputDevice, speakerDrcEnabled)</span></span>;</span><br><span class="line">    <span class="comment">// ä¼˜å…ˆè§£æ vendor ç›®å½•ä¸‹çš„ conf é…ç½®æ–‡ä»¶ï¼Œç„¶åè§£æ device ç›®å½•ä¸‹çš„ conf é…ç½®æ–‡ä»¶ã€‚</span></span><br><span class="line">    <span class="comment">// å°†è®¾å¤‡æ”¯æŒçš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿å­˜åœ¨ mAvailableOutputDevices å˜é‡ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// å°†è®¾å¤‡æ”¯æŒçš„éŸ³é¢‘è¾“å…¥è®¾å¤‡ä¿å­˜åœ¨ mAvailableInputDevices å˜é‡ä¸­ï¼Œå°†è®¾å¤‡çš„é»˜è®¤éŸ³é¢‘è¾“å‡º</span></span><br><span class="line">    <span class="comment">// è®¾å¤‡ä¿å­˜åœ¨ mDefaultOutputDevice å˜é‡ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> ((ConfigParsingUtils::loadConfig(AUDIO_POLICY_VENDOR_CONFIG_FILE, config) != NO_ERROR) &amp;&amp;</span><br><span class="line">            (ConfigParsingUtils::loadConfig(AUDIO_POLICY_CONFIG_FILE, config) != NO_ERROR)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        ALOGE(<span class="string">"could not load audio policy configuration file, setting defaults"</span>);</span><br><span class="line">        config.setDefault();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// must be done after reading the policy (since conditionned by Speaker Drc Enabling)</span></span><br><span class="line">    mVolumeCurves-&gt;initializeVolumeCurves(speakerDrcEnabled);    <span class="comment">// è®¾ç½®éŸ³é‡è°ƒèŠ‚æ›²çº¿</span></span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">// ä¾æ¬¡åŠ è½½ HwModule å¹¶æ‰“å¼€å…¶æ‰€å« profile çš„ outputStream åŠ inputStream</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mHwModules.size(); i++) &#123;</span><br><span class="line">        mHwModules[i]-&gt;mHandle = mpClientInterface-&gt;loadHwModule(mHwModules[i]-&gt;getName());</span><br><span class="line">        <span class="keyword">if</span> (mHwModules[i]-&gt;mHandle == <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGW(<span class="string">"could not open HW module %s"</span>, mHwModules[i]-&gt;getName());</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// open all output streams needed to access attached devices</span></span><br><span class="line">        <span class="comment">// except for direct output streams that are only opened when they are actually</span></span><br><span class="line">        <span class="comment">// required by an app.</span></span><br><span class="line">        <span class="comment">// This also validates mAvailableOutputDevices list</span></span><br><span class="line">        <span class="comment">// æ‰“å¼€å½“å‰ module ä¸‹æ‰€æœ‰é direct ç±»å‹ profile çš„ outputStream</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> j = <span class="number">0</span>; j &lt; mHwModules[i]-&gt;mOutputProfiles.size(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> sp&lt;IOProfile&gt; outProfile = mHwModules[i]-&gt;mOutputProfiles[j];</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰æ“ä½œçš„ module.profile æ˜¯ direct ç±»å‹ï¼Œåˆ™ä¸ä¸ºå…¶æ‰“å¼€ outputStream</span></span><br><span class="line">            <span class="keyword">if</span> ((outProfile-&gt;getFlags() &amp; AUDIO_OUTPUT_FLAG_DIRECT) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ....</span><br><span class="line">            <span class="comment">// è·å–é‡‡æ ·ç‡ã€é€šé“æ•°ã€æ•°æ®æ ¼å¼ç­‰å„éŸ³é¢‘å‚æ•°</span></span><br><span class="line">            sp&lt;SwAudioOutputDescriptor&gt; outputDesc = <span class="keyword">new</span> SwAudioOutputDescriptor(outProfile,</span><br><span class="line">                                                                                 mpClientInterface);</span><br><span class="line">            <span class="keyword">const</span> DeviceVector &amp;supportedDevices = outProfile-&gt;getSupportedDevices();</span><br><span class="line">            <span class="keyword">const</span> DeviceVector &amp;devicesForType = supportedDevices.getDevicesFromType(profileType);</span><br><span class="line">            String8 address = devicesForType.size() &gt; <span class="number">0</span> ? devicesForType.itemAt(<span class="number">0</span>)-&gt;mAddress</span><br><span class="line">                    : String8(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            outputDesc-&gt;mDevice = profileType;</span><br><span class="line">            <span class="keyword">audio_config_t</span> config = AUDIO_CONFIG_INITIALIZER;</span><br><span class="line">            config.sample_rate = outputDesc-&gt;mSamplingRate;</span><br><span class="line">            config.channel_mask = outputDesc-&gt;mChannelMask;</span><br><span class="line">            config.format = outputDesc-&gt;mFormat;</span><br><span class="line">            <span class="keyword">audio_io_handle_t</span> output = AUDIO_IO_HANDLE_NONE;</span><br><span class="line">            <span class="comment">// ä¸ºå½“å‰ module.profile æ‰“å¼€å¯¹åº”çš„ outputStream å¹¶åˆ›å»º playbackThread çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">status_t</span> status = mpClientInterface-&gt;openOutput(outProfile-&gt;getModuleHandle(),</span><br><span class="line">                                                            &amp;output,</span><br><span class="line">                                                            &amp;config,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mDevice,</span><br><span class="line">                                                            address,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mLatency,</span><br><span class="line">                                                            outputDesc-&gt;mFlags);</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// open input streams needed to access attached devices to validate</span></span><br><span class="line">        <span class="comment">// mAvailableInputDevices list</span></span><br><span class="line">        <span class="comment">// æ‰“å¼€å½“å‰ module ä¸‹æ‰€æœ‰ profile çš„ inputStream</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> j = <span class="number">0</span>; j &lt; mHwModules[i]-&gt;mInputProfiles.size(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> sp&lt;IOProfile&gt; inProfile = mHwModules[i]-&gt;mInputProfiles[j];</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">            sp&lt;AudioInputDescriptor&gt; inputDesc =</span><br><span class="line">                    <span class="keyword">new</span> AudioInputDescriptor(inProfile);</span><br><span class="line"></span><br><span class="line">            inputDesc-&gt;mDevice = profileType;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–é‡‡æ ·ç‡ã€é€šé“æ•°ã€æ•°æ®æ ¼å¼ç­‰å„éŸ³é¢‘å‚æ•°</span></span><br><span class="line">            <span class="comment">// find the address</span></span><br><span class="line">            DeviceVector inputDevices = mAvailableInputDevices.getDevicesFromType(profileType);</span><br><span class="line">            <span class="comment">//   the inputs vector must be of size 1, but we don't want to crash here</span></span><br><span class="line">            String8 address = inputDevices.size() &gt; <span class="number">0</span> ? inputDevices.itemAt(<span class="number">0</span>)-&gt;mAddress</span><br><span class="line">                    : String8(<span class="string">""</span>);</span><br><span class="line">            ALOGV(<span class="string">"  for input device 0x%x using address %s"</span>, profileType, address.<span class="built_in">string</span>());</span><br><span class="line">            ALOGE_IF(inputDevices.size() == <span class="number">0</span>, <span class="string">"Input device list is empty!"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">audio_config_t</span> config = AUDIO_CONFIG_INITIALIZER;</span><br><span class="line">            config.sample_rate = inputDesc-&gt;mSamplingRate;</span><br><span class="line">            config.channel_mask = inputDesc-&gt;mChannelMask;</span><br><span class="line">            config.format = inputDesc-&gt;mFormat;</span><br><span class="line">            <span class="keyword">audio_io_handle_t</span> input = AUDIO_IO_HANDLE_NONE;</span><br><span class="line">            <span class="comment">// ä¸ºå½“å‰ module.profile æ‰“å¼€å¯¹åº”çš„ inputStream å¹¶åˆ›å»º recordThread çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">status_t</span> status = mpClientInterface-&gt;openInput(inProfile-&gt;getModuleHandle(),</span><br><span class="line">                                                           &amp;input,</span><br><span class="line">                                                           &amp;config,</span><br><span class="line">                                                           &amp;inputDesc-&gt;mDevice,</span><br><span class="line">                                                           address,</span><br><span class="line">                                                           AUDIO_SOURCE_MIC,</span><br><span class="line">                                                           AUDIO_INPUT_FLAG_NONE);</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    updateDevicesAndOutputs();    <span class="comment">// æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯</span></span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AudioPolicyManagerå¯¹è±¡æ„é€ è¿‡ç¨‹ä¸­ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><p>1ã€ åŠ è½½audio_policy_configuration.xmlæˆ–è€…audio_policy.confé…ç½®æ–‡ä»¶</p><p>2ã€ åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves(speakerDrcEnabled)</p><p>3ã€ åŠ è½½audio policyç¡¬ä»¶æŠ½è±¡åº“ï¼šmpClientInterface-&gt;loadHwModule(mHwModules[i]-&gt;mName)</p><p>4ã€ æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream ï¼š mpClientInterface-&gt;openOutput()ã€mpClientInterface-&gt;openInput</p><p>5ã€ æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs()</p><h5 id="2-3-1ã€åŠ è½½audio-policy-configuration-xmlæˆ–è€…audio-policy-confé…ç½®æ–‡ä»¶"><a href="#2-3-1ã€åŠ è½½audio-policy-configuration-xmlæˆ–è€…audio-policy-confé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.1ã€åŠ è½½audio_policy_configuration.xmlæˆ–è€…audio_policy.confé…ç½®æ–‡ä»¶"></a>2.3.1ã€åŠ è½½audio_policy_configuration.xmlæˆ–è€…audio_policy.confé…ç½®æ–‡ä»¶</h5><p><a href="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/audio_policy_configuration.xml" target="_blank" rel="noopener">audio_policy_configuration.xml</a><br>audio_policy.confåŒæ—¶å®šä¹‰äº†å¤šä¸ªaudio æ¥å£ï¼Œæ¯ä¸€ä¸ªaudio æ¥å£åŒ…å«è‹¥å¹²outputå’Œinputï¼Œè€Œæ¯ä¸ªoutputå’ŒinputåˆåŒæ—¶æ”¯æŒå¤šç§è¾“å…¥è¾“å‡ºæ¨¡å¼ï¼Œæ¯ç§è¾“å…¥è¾“å‡ºæ¨¡å¼åˆæ”¯æŒè‹¥å¹²ç§è®¾å¤‡ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/35-Audio-system-audio_policy.conf.png" alt="Alt text"></p><h5 id="2-3-2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves-speakerDrcEnabled"><a href="#2-3-2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves-speakerDrcEnabled" class="headerlink" title="2.3.2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves(speakerDrcEnabled)"></a>2.3.2ã€åˆå§‹åŒ–éŸ³é‡è°ƒèŠ‚ç‚¹initializeVolumeCurves(speakerDrcEnabled)</h5><p>åœ¨AudioPolicyManagerBaseä¸­å®šä¹‰äº†éŸ³é‡è°ƒèŠ‚å¯¹åº”çš„éŸ³é¢‘æµæè¿°ç¬¦æ•°ç»„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//audio_policy_volumes.xml</span><br><span class="line">const AudioPolicyManagerBase::VolumeCurvePoint</span><br><span class="line">            *AudioPolicyManagerBase::sVolumeProfiles[AudioSystem::NUM_STREAM_TYPES]</span><br><span class="line">                                                   [AudioPolicyManagerBase::DEVICE_CATEGORY_CNT] = &#123;</span><br><span class="line">    &#123; // AUDIO_STREAM_VOICE_CALL</span><br><span class="line">        sDefaultVoiceVolumeCurve, // DEVICE_CATEGORY_HEADSET</span><br><span class="line">        sSpeakerVoiceVolumeCurve, // DEVICE_CATEGORY_SPEAKER</span><br><span class="line">        sDefaultVoiceVolumeCurve  // DEVICE_CATEGORY_EARPIECE</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; // AUDIO_STREAM_SYSTEM</span><br><span class="line">        sHeadsetSystemVolumeCurve, // DEVICE_CATEGORY_HEADSET</span><br><span class="line">        sDefaultSystemVolumeCurve, // DEVICE_CATEGORY_SPEAKER</span><br><span class="line">        sDefaultSystemVolumeCurve  // DEVICE_CATEGORY_EARPIECE</span><br><span class="line">    &#125;,</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>initializeVolumeCurves()å‡½æ•°å°±æ˜¯åˆå§‹åŒ–è¯¥æ•°ç»„å…ƒç´ ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;]</span><br><span class="line"><span class="keyword">void</span> AudioPolicyManagerBase::initializeVolumeCurves()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; AudioSystem::NUM_STREAM_TYPES; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; DEVICE_CATEGORY_CNT; j++) &#123;</span><br><span class="line">            mStreams[i].mVolumeCurve[j] =</span><br><span class="line">                    sVolumeProfiles[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check availability of DRC on speaker path: if available, override some of the speaker curves</span></span><br><span class="line">    <span class="keyword">if</span> (mSpeakerDrcEnabled) &#123;</span><br><span class="line">        mStreams[AUDIO_STREAM_SYSTEM].mVolumeCurve[DEVICE_CATEGORY_SPEAKER] =</span><br><span class="line">                sDefaultSystemVolumeCurveDrc;</span><br><span class="line">        mStreams[AUDIO_STREAM_RING].mVolumeCurve[DEVICE_CATEGORY_SPEAKER] =</span><br><span class="line">                sSpeakerSonificationVolumeCurveDrc;</span><br><span class="line">        mStreams[AUDIO_STREAM_ALARM].mVolumeCurve[DEVICE_CATEGORY_SPEAKER] =</span><br><span class="line">                sSpeakerSonificationVolumeCurveDrc;</span><br><span class="line">        mStreams[AUDIO_STREAM_NOTIFICATION].mVolumeCurve[DEVICE_CATEGORY_SPEAKER] =</span><br><span class="line">                sSpeakerSonificationVolumeCurveDrc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-3ã€åŠ è½½audio-policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule"><a href="#2-3-3ã€åŠ è½½audio-policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule" class="headerlink" title="2.3.3ã€åŠ è½½audio policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule()"></a>2.3.3ã€åŠ è½½audio policyç¡¬ä»¶æŠ½è±¡åº“loadHwModule()</h5><p>æˆ‘ä»¬ç›´æ¥åˆ†æAudioFlinger::loadHwModule_l()ä¸­çš„load_audio_interface()å‡½æ•°<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static int load_audio_interface(const char *if_name, audio_hw_device_t **dev)</span><br><span class="line">&#123;</span><br><span class="line">    const hw_module_t *mod;</span><br><span class="line">    int rc;</span><br><span class="line">    //æ ¹æ®åå­—åŠ è½½audio_moduleæ¨¡å—  </span><br><span class="line">    rc = hw_get_module_by_class(AUDIO_HARDWARE_MODULE_ID, if_name, &amp;mod);</span><br><span class="line">    ALOGE_IF(rc, &quot;%s couldn&apos;t load audio hw module %s.%s (%s)&quot;, __func__,</span><br><span class="line">                 AUDIO_HARDWARE_MODULE_ID, if_name, strerror(-rc));</span><br><span class="line">    //æ‰“å¼€audio_deviceè®¾å¤‡</span><br><span class="line">    rc = audio_hw_device_open(mod, dev);</span><br><span class="line">    ALOGE_IF(rc, &quot;%s couldn&apos;t open audio hw device in %s.%s (%s)&quot;, __func__,</span><br><span class="line">                 AUDIO_HARDWARE_MODULE_ID, if_name, strerror(-rc));</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">audio_hw_device_open</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       struct audio_hw_device** device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">module</span>-&gt;methods-&gt;open(<span class="keyword">module</span>, AUDIO_HARDWARE_INTERFACE,</span><br><span class="line">                                 (struct <span class="keyword">hw_device_t</span>**)device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;\hardware\libhardware_legacy\audio\audio_hw_hal.cpp]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">static int legacy_adev_open(const hw_module_t* module, const char* name,</span><br><span class="line">                            hw_device_t** device)</span><br><span class="line">&#123;</span><br><span class="line">    struct legacy_audio_device *ladev;</span><br><span class="line">    int ret;</span><br><span class="line">    ladev = (struct legacy_audio_device *)calloc(1, sizeof(*ladev));</span><br><span class="line"></span><br><span class="line">    ladev-&gt;device.common.tag = HARDWARE_DEVICE_TAG;</span><br><span class="line">    ladev-&gt;device.common.version = AUDIO_DEVICE_API_VERSION_2_0;</span><br><span class="line">    ladev-&gt;device.common.module = const_cast&lt;hw_module_t*&gt;(module);</span><br><span class="line">    ladev-&gt;device.common.close = legacy_adev_close;</span><br><span class="line"></span><br><span class="line">    ladev-&gt;device.init_check = adev_init_check;</span><br><span class="line">    ladev-&gt;device.set_voice_volume = adev_set_voice_volume;</span><br><span class="line">    ladev-&gt;device.set_master_volume = adev_set_master_volume;</span><br><span class="line">    ladev-&gt;device.get_master_volume = adev_get_master_volume;</span><br><span class="line">    ladev-&gt;device.set_mode = adev_set_mode;</span><br><span class="line">    ladev-&gt;device.set_mic_mute = adev_set_mic_mute;</span><br><span class="line">    ladev-&gt;device.get_mic_mute = adev_get_mic_mute;</span><br><span class="line">    ladev-&gt;device.set_parameters = adev_set_parameters;</span><br><span class="line">    ladev-&gt;device.get_parameters = adev_get_parameters;</span><br><span class="line">    ladev-&gt;device.get_input_buffer_size = adev_get_input_buffer_size;</span><br><span class="line">    ladev-&gt;device.open_output_stream = adev_open_output_stream;</span><br><span class="line">    ladev-&gt;device.close_output_stream = adev_close_output_stream;</span><br><span class="line">    ladev-&gt;device.open_input_stream = adev_open_input_stream;</span><br><span class="line">    ladev-&gt;device.close_input_stream = adev_close_input_stream;</span><br><span class="line">    ladev-&gt;device.dump = adev_dump;</span><br><span class="line"></span><br><span class="line">    ladev-&gt;hwif = createAudioHardware();</span><br><span class="line"></span><br><span class="line">    *device = &amp;ladev-&gt;device.common;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤å°±åŠ è½½å®Œç³»ç»Ÿå®šä¹‰çš„æ‰€æœ‰éŸ³é¢‘æ¥å£ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„æ•°æ®å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šâ€™<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/36-Audio-system-audiohwdevice.png" alt="Alt text"></p><h5 id="2-3-4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream"><a href="#2-3-4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream" class="headerlink" title="2.3.4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream"></a>2.3.4ã€æ‰“å¼€å¯¹åº”çš„outputStreamå’ŒinputStream</h5><p>å‰é¢ä¸€å°èŠ‚å·²ç»åˆ†æè¿‡outputStreamï¼Œè¿™é‡Œä¸å†åˆ†æäº†<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/37-Audio-system-AudioStreamOut.png" alt="Alt text"></p><p>æ‰“å¼€éŸ³é¢‘è¾“å‡ºåï¼Œåœ¨AudioFlingerä¸AudioPolicyServiceä¸­çš„è¡¨ç°å½¢å¼å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/38-Audio-system-audiohwdevice-openoutput.png" alt="Alt text"></p><p>æ‰“å¼€éŸ³é¢‘è¾“å…¥:<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/39-Audio-system-AudioStreamIn.png" alt="Alt text"><br>æ‰“å¼€éŸ³é¢‘è¾“å…¥åï¼Œåœ¨AudioFlingerä¸AudioPolicyServiceä¸­çš„è¡¨ç°å½¢å¼å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/310-Audio-system-audiohwdevice-openinput.png" alt="Alt text"></p><h5 id="2-3-5ã€-æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs"><a href="#2-3-5ã€-æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs" class="headerlink" title="2.3.5ã€ æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs()"></a>2.3.5ã€ æ›´æ–°ç³»ç»Ÿç¼“å­˜çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡ä¿¡æ¯updateDevicesAndOutputs()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audiopolicy\managerdefault\AudioPolicyManager.cpp]</span><br><span class="line"><span class="keyword">void</span> AudioPolicyManager::updateDevicesAndOutputs()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_STRATEGIES; i++) &#123;</span><br><span class="line">        mDeviceForStrategy[i] = getDeviceForStrategy((routing_strategy)i, <span class="literal">false</span> <span class="comment">/*fromCache*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mPreviousOutputs = mOutputs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-4ã€æ€»ç»“"><a href="#2-4ã€æ€»ç»“" class="headerlink" title="2.4ã€æ€»ç»“"></a>2.4ã€æ€»ç»“</h5><p>-&gt;æ‰“å¼€éŸ³é¢‘è¾“å‡ºæ—¶åˆ›å»ºä¸€ä¸ªaudio_stream_outé€šé“ï¼Œå¹¶åˆ›å»ºAudioStreamOutå¯¹è±¡ä»¥åŠæ–°å»ºPlaybackThreadæ’­æ”¾çº¿ç¨‹ã€‚</p><p>-&gt; æ‰“å¼€éŸ³é¢‘è¾“å…¥æ—¶åˆ›å»ºä¸€ä¸ªaudio_stream_iné€šé“ï¼Œå¹¶åˆ›å»ºAudioStreamInå¯¹è±¡ä»¥åŠåˆ›å»ºRecordThreadå½•éŸ³çº¿ç¨‹ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/311-Audio-system-audio_stream_in-out.png" alt="Alt text"></p><h4 id="ä¸‰-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack"><a href="#ä¸‰-ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack" class="headerlink" title="(ä¸‰)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack"></a>(ä¸‰)ã€æ·±å…¥å‰–æAndroidéŸ³é¢‘ä¹‹AudioTrack</h4><p>ç°åœ¨æˆ‘ä»¬å¼€å§‹åˆ†æ AudioTrack çš„åˆ›å»ºè¿‡ç¨‹ï¼Œç‰¹åˆ«ç•™æ„ AudioTrack ä¸ AudioFlinger å¦‚ä½•å»ºç«‹è”ç³»ã€ç”¨äº AudioTrack ä¸ AudioFlinger äº¤æ¢æ•°æ®çš„åŒ¿åå…±äº«å†…å­˜å¦‚ä½•åˆ†é…ã€‚</p><h5 id="3-1-AudioTrack-amp-AudioFlinger-ç›¸å…³ç±»"><a href="#3-1-AudioTrack-amp-AudioFlinger-ç›¸å…³ç±»" class="headerlink" title="3.1. AudioTrack &amp; AudioFlinger ç›¸å…³ç±»"></a>3.1. AudioTrack &amp; AudioFlinger ç›¸å…³ç±»</h5><p>æ—¶åºå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/312-Audio-system-create_audiotrack-flow.png" alt="Alt text"></p><p>é¦–å…ˆçœ‹ä¸€ä¸‹ AudioTrack &amp; AudioFlinger çš„ç±»å›¾ï¼Œç†ä¸€ä¸‹ AudioFlinger çš„ä¸»è¦ç±»åŠå…¶å…³ç³»ã€AudioTrack ä¸ AudioFlinger ä¹‹é—´çš„è”ç³»ï¼Œåé¢å°†ä»¥è¯¥å›¾ä¸ºè„‰ç»œå±•å¼€åˆ†æã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/313-Audio-system-create_audiotrack.jpg" alt="Alt text"></p><p>â˜¯ AudioFlinger::PlaybackThreadï¼šå›æ”¾çº¿ç¨‹åŸºç±»ï¼Œä¸åŒè¾“å‡ºæ ‡è¯†çš„éŸ³é¢‘æµå¯¹åº”ä¸åŒç±»å‹çš„ PlaybackThread å®ä¾‹ï¼ˆåˆ†ä¸ºå››ç§ï¼šMixerThreadã€DirectOutputThreadã€DuplicatingThreadã€OffloadThreadï¼‰ï¼Œå…·ä½“è§ 3.4. AudioFlinger å›æ”¾å½•åˆ¶çº¿ç¨‹ å°èŠ‚ï¼Œæ‰€æœ‰çš„ PlaybackThread å®ä¾‹éƒ½ä¼šæ·»åŠ åˆ° AudioFlinger.mPlaybackThreads å‘é‡ä¸­ï¼›è¿™ä¸ªå‘é‡çš„å®šä¹‰ï¼š DefaultKeyedVector&lt; audio_io_handle_t, sp<playbackthread>&gt; mPlaybackThreads;ï¼Œå¯è§ audio_io_handle_t æ˜¯ä¸ PlaybackThread æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œç”±å·²çŸ¥çš„ audio_io_handle_t å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„ PlaybackThreadï¼›audio_io_handle_t åœ¨åˆ›å»º PlaybackThread æ—¶ç”±ç³»ç»Ÿåˆ†é…ï¼Œè¿™ä¸ªå€¼æ˜¯å…¨å±€å”¯ä¸€çš„<br>â˜¯ AudioFlinger::PlaybackThread::Trackï¼šéŸ³é¢‘æµç®¡ç†ç±»ï¼Œåˆ›å»ºä¸€å—åŒ¿åå…±äº«å†…å­˜ç”¨äº AudioTrack ä¸ AudioFlinger ä¹‹é—´çš„æ•°æ®äº¤æ¢ï¼ˆæ–¹ä¾¿èµ·è§ï¼Œè¿™å—åŒ¿åå…±äº«å†…å­˜ï¼Œä»¥åå‡ç®€å•ç§°ä¸º FIFOï¼‰ï¼ŒåŒæ—¶å®ç° start()ã€stop()ã€pause() ç­‰éŸ³é¢‘æµå¸¸ç”¨æ§åˆ¶æ‰‹æ®µï¼›æ³¨æ„ï¼Œå¤šä¸ª Track å¯¹è±¡å¯èƒ½éƒ½æ³¨å†Œåˆ°åŒä¸€ä¸ª PlaybackThread ä¸­ï¼ˆå°¤å…¶å¯¹äº MixerThread è€Œè¨€ï¼Œä¸€ä¸ª MixerThread å¾€å¾€æŒ‚ç€å¤šä¸ª Track å¯¹è±¡ï¼‰ï¼Œè¿™å¤šä¸ª Track å¯¹è±¡éƒ½ä¼šæ·»åŠ åˆ° PlaybackThread.mTracks å‘é‡ä¸­ç»Ÿä¸€ç®¡ç†<br>â˜¯ AudioFlinger::TrackHandleï¼šTrack å¯¹è±¡åªè´Ÿè´£éŸ³é¢‘æµç®¡ç†ä¸šåŠ¡ï¼Œå¯¹å¤–å¹¶æ²¡æœ‰æä¾›è·¨è¿›ç¨‹çš„ Binder è°ƒç”¨æ¥å£ï¼Œè€Œåº”ç”¨è¿›ç¨‹åˆéœ€è¦å¯¹éŸ³é¢‘æµè¿›è¡Œæ§åˆ¶ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå¯¹è±¡æ¥ä»£ç† Track çš„è·¨è¿›ç¨‹é€šè®¯ï¼Œè¿™ä¸ªè§’è‰²å°±æ˜¯ TrackHandleï¼ŒAudioTrack é€šè¿‡å®ƒä¸ Track äº¤äº’<br>â˜¯ AudioTrackï¼šAndroid éŸ³é¢‘ç³»ç»Ÿå¯¹å¤–æä¾›çš„ä¸€ä¸ª API ç±»ï¼Œè´Ÿè´£éŸ³é¢‘æµæ•°æ®è¾“å‡ºï¼›æ¯ä¸ªéŸ³é¢‘æµå¯¹åº”ç€ä¸€ä¸ª AudioTrack å®ä¾‹ï¼Œä¸åŒè¾“å‡ºæ ‡è¯†çš„ AudioTrack ä¼šåŒ¹é…åˆ°ä¸åŒçš„ AudioFlinger::PlaybackThreadï¼›AudioTrack ä¸ AudioFlinger::PlaybackThread ä¹‹é—´é€šè¿‡ FIFO æ¥äº¤æ¢éŸ³é¢‘æ•°æ®ï¼ŒAudioTrack æ˜¯ FIFO ç”Ÿäº§è€…ï¼ŒAudioFlinger::PlaybackThread æ˜¯ FIFO æ¶ˆè´¹è€…<br>â˜¯ AudioTrack::AudioTrackThreadï¼šæ•°æ®ä¼ è¾“æ¨¡å¼ä¸º TRANSFER_CALLBACK æ—¶ï¼Œéœ€è¦åˆ›å»ºè¯¥çº¿ç¨‹ï¼Œå®ƒé€šè¿‡è°ƒç”¨ audioCallback å›è°ƒå‡½æ•°ä¸»åŠ¨ä»ç”¨æˆ·è¿›ç¨‹å¤„ç´¢å–æ•°æ®å¹¶å¡«å……åˆ° FIFO ä¸Šï¼›æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º TRANSFER_SYNC æ—¶ï¼Œåˆ™ä¸éœ€è¦åˆ›å»ºè¿™ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºç”¨æˆ·è¿›ç¨‹ä¼šæŒç»­è°ƒç”¨ AudioTrack.write() å¡«å……æ•°æ®åˆ° FIFOï¼›æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º TRANSFER_SHARED æ—¶ï¼Œä¹Ÿä¸éœ€è¦åˆ›å»ºè¿™ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºç”¨æˆ·è¿›ç¨‹ä¼šåˆ›å»ºä¸€å—åŒ¿åå…±äº«å†…å­˜ï¼Œå¹¶æŠŠè¦æ’­æ”¾çš„éŸ³é¢‘æ•°æ®ä¸€æ¬¡æ€§æ‹·è´åˆ°è¿™å—åŒ¿åå…±äº«å†…å­˜ä¸Šäº†<br>â˜¯ IAudioTrackï¼šIAudioTrack æ˜¯é“¾ç»“ AudioTrack ä¸ AudioFlinger çš„æ¡¥æ¢ï¼›å®ƒåœ¨ AudioTrack ç«¯çš„å¯¹è±¡æ˜¯ BpAudioTrackï¼Œåœ¨ AudioFlinger ç«¯çš„å¯¹è±¡æ˜¯ BnAudioTrackï¼Œä»å›¾ä¸­ä¸éš¾çœ‹å‡ºï¼ŒAudioFlinger::TrackHandle ç»§æ‰¿è‡ª BnAudioTrackï¼Œè€Œ AudioFlinger::TrackHandle æ°æ°æ˜¯AudioFlinger::PlaybackThread::Track çš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ AudioTrack å¾—åˆ° IAudioTrack å®ä¾‹åï¼Œå°±å¯ä»¥è°ƒç”¨ IAudioTrack çš„æ¥å£ä¸ AudioFlinger::PlaybackThread::Track äº¤äº’</playbackthread></p><p><strong>audio_io_handle_tï¼š</strong></p><p>è¿™é‡Œå†è¯¦ç»†è¯´æ˜ä¸€ä¸‹ audio_io_handle_tï¼Œå®ƒæ˜¯ AudioTrack/AudioRecord/AudioSystemã€AudioFlingerã€AudioPolicyManager ä¹‹é—´ä¸€ä¸ªé‡è¦çš„é“¾ç»“ç‚¹ã€‚3.4. AudioFlinger å›æ”¾å½•åˆ¶çº¿ç¨‹ å°èŠ‚åœ¨ AudioFlinger::openOutput_l() æ³¨é‡Šä¸­å¤§è‡´è¯´æ˜äº†å®ƒçš„æ¥å†åŠå…¶ä½œç”¨ï¼Œç°åœ¨å›é¡¾ä¸‹ï¼šå½“æ‰“å¼€è¾“å‡ºæµè®¾å¤‡åŠåˆ›å»º PlaybackThread æ—¶ï¼Œç³»ç»Ÿä¼šåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å€¼ä½œä¸º audio_io_handle_tï¼Œå¹¶æŠŠ audio_io_handle_t å’Œ PlaybackThread æ·»åŠ åˆ°é”®å€¼å¯¹å‘é‡ mPlaybackThreads ä¸­ï¼Œç”±äº audio_io_handle_t å’Œ PlaybackThread æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œå› æ­¤æ‹¿åˆ°ä¸€ä¸ª audio_io_handle_tï¼Œå°±èƒ½éå†é”®å€¼å¯¹å‘é‡ mPlaybackThreads æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThreadï¼Œå¯ä»¥ç®€å•ç†è§£ audio_io_handle_t ä¸º PlaybackThread çš„ç´¢å¼•å·æˆ–çº¿ç¨‹ idã€‚ç”±äº audio_io_handle_t å…·æœ‰ PlaybackThread ç´¢å¼•ç‰¹æ€§ï¼Œæ‰€ä»¥åº”ç”¨è¿›ç¨‹æƒ³è·å– PlaybackThread æŸäº›ä¿¡æ¯çš„è¯ï¼Œåªéœ€è¦ä¼ å…¥å¯¹åº”çš„ audio_io_handle_t å³å¯ã€‚ä¾‹å¦‚ AudioFlinger::format(audio_io_handle_t output)ï¼Œè¿™æ˜¯ AudioFlinger çš„ä¸€ä¸ªæœåŠ¡æ¥å£ï¼Œç”¨æˆ·è¿›ç¨‹å¯ä»¥é€šè¿‡è¯¥æ¥å£è·å–æŸä¸ª PlaybackThread é…ç½®çš„éŸ³é¢‘æ ¼å¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line"><span class="keyword">audio_format_t</span> AudioFlinger::format(<span class="keyword">audio_io_handle_t</span> output) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="comment">// checkPlaybackThread_l() æ ¹æ®ä¼ å…¥çš„ audio_io_handle_tï¼Œä»é”®å€¼å¯¹å‘é‡</span></span><br><span class="line">    <span class="comment">// mPlaybackThreads ä¸­æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThread</span></span><br><span class="line">    PlaybackThread *thread = checkPlaybackThread_l(output);</span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"format() unknown thread %d"</span>, output);</span><br><span class="line">        <span class="keyword">return</span> AUDIO_FORMAT_INVALID;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> thread-&gt;format();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AudioFlinger::PlaybackThread *AudioFlinger::checkPlaybackThread_l(<span class="keyword">audio_io_handle_t</span> output) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> mPlaybackThreads.valueFor(output).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-2-AudioTrack-æ„é€ è¿‡ç¨‹"><a href="#3-2-AudioTrack-æ„é€ è¿‡ç¨‹" class="headerlink" title="3.2. AudioTrack æ„é€ è¿‡ç¨‹"></a>3.2. AudioTrack æ„é€ è¿‡ç¨‹</h5><p>å½“æˆ‘ä»¬æ„é€ ä¸€ä¸ª AudioTrack å®ä¾‹æ—¶ï¼ˆä»¥ MODE_STREAM/TRANSFER_SYNC æ¨¡å¼ä¸ºä¾‹ï¼Œè¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ¨¡å¼äº†ï¼Œæ­¤æ—¶ sharedBuffer ä¸ºç©ºï¼‰ï¼Œç³»ç»Ÿéƒ½å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿé˜è¿°ä¸‹å¤§è‡´æµç¨‹ï¼š</p><p>å¦‚æœ cbfï¼ˆaudioCallback å›è°ƒå‡½æ•°ï¼‰éç©ºï¼Œé‚£ä¹ˆåˆ›å»º AudioTrackThread çº¿ç¨‹å¤„ç† audioCallback å›è°ƒå‡½æ•°ï¼ˆMODE_STREAM æ¨¡å¼æ—¶ï¼Œcbf ä¸ºç©ºï¼‰ï¼›<br>æ ¹æ® streamTypeï¼ˆæµç±»å‹ï¼‰ã€flagsï¼ˆè¾“å‡ºæ ‡è¯†ï¼‰ç­‰å‚æ•°è°ƒç”¨ AudioSystem::getOutputForAttr()ï¼›ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œè¿›å…¥ AudioPolicyManager::getOutputForDevice()ï¼š<br>å¦‚æœè¾“å‡ºæ ‡è¯†ç½®äº† AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD æˆ– AUDIO_OUTPUT_FLAG_DIRECTï¼Œé‚£ä¹ˆæœ€ç»ˆè°ƒç”¨ AudioFlinger::openOutput() æ‰“å¼€è¾“å‡ºæ ‡è¯†å¯¹åº”çš„è¾“å‡ºæµè®¾å¤‡å¹¶åˆ›å»ºç›¸åº”çš„ PlaybackThreadï¼Œä¿å­˜è¯¥ PlaybackThread å¯¹åº”çš„ audio_io_handle_t ç»™ AudioTrackï¼›<br>å¦‚æœè¾“å‡ºæ ‡è¯†æ˜¯å…¶ä»–ç±»å‹ï¼Œé‚£ä¹ˆæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸€ä¸ªè¾“å‡ºæµè®¾å¤‡å’Œ PlaybackThreadï¼Œå¹¶ä¿å­˜è¯¥ PlaybackThread å¯¹åº”çš„ audio_io_handle_t ç»™ AudioTrackï¼›åˆ«å¿˜äº†åœ¨ 3.4. AudioFlinger å›æ”¾å½•åˆ¶çº¿ç¨‹ å°èŠ‚ä¸­æåˆ°ï¼šç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå°±å·²ç»æ‰“å¼€ primary_outã€low_latencyã€deep_buffer è¿™ä¸‰ç§è¾“å‡ºæµè®¾å¤‡ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ PlaybackThread äº†ï¼›<br>é€šè¿‡ Binder æœºåˆ¶è°ƒç”¨ AudioFlinger::createTrack()ï¼ˆæ³¨æ„ step2 ä¸­ AudioTrack å·²ç»æ‹¿åˆ°ä¸€ä¸ª audio_io_handle_t äº†ï¼Œæ­¤æ—¶æŠŠè¿™ä¸ª audio_io_handle_t ä¼ å…¥ç»™ createTrack()ï¼‰ï¼š<br>æ ¹æ®ä¼ å…¥çš„ audio_io_handle_t æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThreadï¼›<br>PlaybackThread æ–°å»ºä¸€ä¸ªéŸ³é¢‘æµç®¡ç†å¯¹è±¡ Trackï¼›Track æ„é€ æ—¶ä¼šåˆ†é…ä¸€å—åŒ¿åå…±äº«å†…å­˜ç”¨äº AudioFlinger ä¸ AudioTrack çš„æ•°æ®äº¤æ¢ç¼“å†²åŒºï¼ˆFIFOï¼‰åŠå…¶æ§åˆ¶å—ï¼ˆaudio_track_cblk_tï¼‰ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª AudioTrackServerProxy å¯¹è±¡ï¼ˆPlaybackThread å°†ä½¿ç”¨å®ƒä» FIFO ä¸Šå–å¾—å¯è¯»æ•°æ®çš„ä½ç½®ï¼‰ï¼›<br>æœ€åæ–°å»ºä¸€ä¸ª Track çš„é€šè®¯ä»£ç† TrackHandleï¼Œå¹¶ä»¥ IAudioTrack ä½œä¸ºè¿”å›å€¼ç»™ AudioTrackï¼ˆTrackHandleã€BnAudioTrackã€BpAudioTrackã€IAudioTrack çš„å…³ç³»è§ä¸Šä¸€ä¸ªå°èŠ‚ï¼‰ï¼›<br>é€šè¿‡ IAudioTrack æ¥å£ï¼Œå–å¾— AudioFlinger ä¸­çš„ FIFO æ§åˆ¶å—ï¼ˆaudio_track_cblk_tï¼‰ï¼Œç”±æ­¤å†è®¡ç®—å¾—åˆ° FIFO çš„é¦–åœ°å€ï¼›<br>åˆ›å»ºä¸€ä¸ª AudioTrackClientProxy å¯¹è±¡ï¼ˆAudioTrack å°†ä½¿ç”¨å®ƒä» FIFO ä¸Šå–å¾—å¯ç”¨ç©ºé—´çš„ä½ç½®ï¼‰ï¼›<br>AudioTrack ç”±æ­¤å»ºç«‹äº†å’Œ AudioFlinger çš„å…¨éƒ¨è”ç³»å·¥ä½œï¼š</p><p>é€šè¿‡ IAudioTrack æ¥å£å¯ä»¥æ§åˆ¶è¯¥éŸ³è½¨çš„çŠ¶æ€ï¼Œä¾‹å¦‚ startã€stopã€pause<br>æŒç»­å†™å…¥æ•°æ®åˆ° FIFO ä¸Šï¼Œå®ç°éŸ³é¢‘è¿ç»­æ’­æ”¾<br>é€šè¿‡ audio_io_handle_tï¼Œå¯ä»¥æ‰¾åˆ°å®ƒå¯¹åº”çš„ PlaybackThreadï¼Œä»è€ŒæŸ¥è¯¢è¯¥ PlaybackThread çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æ‰€è®¾ç½®çš„é‡‡æ ·ç‡ã€æ ¼å¼ç­‰ç­‰<br>æ„é€  1 ä¸ª AudioTrack å®ä¾‹æ—¶ï¼ŒAudioFlinger ä¼šæœ‰ 1 ä¸ª PlaybackThread å®ä¾‹ã€1 ä¸ª Track å®ä¾‹ã€1 ä¸ª TrackHandle å®ä¾‹ã€1 ä¸ª AudioTrackServerProxy å®ä¾‹ã€1 å— FIFO ä¸ä¹‹å¯¹åº”ã€‚</p><p>å½“åŒæ—¶æ„é€  1 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_PRIMARYã€1 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_FASTã€3 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_DEEP_BUFFERã€1 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOADã€1 ä¸ª AudioTrack with AUDIO_OUTPUT_FLAG_DIRECT æ—¶ï¼ˆäº‹å®ä¸Šï¼ŒAndroid éŸ³é¢‘ç­–ç•¥ä¸å…è®¸å‡ºç°è¿™ç§æƒ…å½¢çš„ï¼‰ï¼ŒAudioFlinger æ‹¥æœ‰çš„ PlaybackThreadã€Trackã€TrackHandle å®ä¾‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/314-Audio-system-PlaybackThread-Track-TrackHandle.png" alt="Alt text"></p><p>æœ€åé™„ä¸Šç›¸å…³ä»£ç çš„æµç¨‹åˆ†æï¼Œæˆ‘æœ¬æ„æ˜¯ä¸å¤šè´´ä»£ç çš„ï¼Œä½†ä¸ä¸Šä»£ç æ€»è§‰å¾—ç¼ºç‚¹ä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘å°½é‡æŠŠä»£ç ç²¾ç®€ï¼Œæå–ä¸»å¹²ï¼Œå¿½ç•¥ç»†èŠ‚ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmedia\AudioTrack.cpp]</span><br><span class="line">AudioTrack::AudioTrack(</span><br><span class="line">        <span class="keyword">audio_stream_type_t</span> streamType,    <span class="comment">// éŸ³é¢‘æµç±»å‹ï¼šå¦‚ Musicã€Voice-Callã€DTMFã€Alarm ç­‰ç­‰</span></span><br><span class="line">        <span class="keyword">uint32_t</span> sampleRate,               <span class="comment">// é‡‡æ ·ç‡ï¼šå¦‚ 16KHzã€44.1KHzã€48KHz ç­‰ç­‰</span></span><br><span class="line">        <span class="keyword">audio_format_t</span> format,             <span class="comment">// éŸ³é¢‘æ ¼å¼ï¼šå¦‚ PCMã€MP3ã€AAC ç­‰ç­‰</span></span><br><span class="line">        <span class="keyword">audio_channel_mask_t</span> channelMask,  <span class="comment">// å£°é“æ•°ï¼šå¦‚ Monoï¼ˆå•å£°é“ï¼‰ã€Stereoï¼ˆåŒå£°é“ï¼‰</span></span><br><span class="line">        <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,   <span class="comment">// å…±äº«å†…å­˜ç¼“å†²åŒºï¼šæ•°æ®æ¨¡å¼æ˜¯ MODE_STATIC æ—¶ä½¿ç”¨ï¼Œæ•°æ®æ¨¡å¼æ˜¯ MODE_STREAM æ—¶ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">audio_output_flags_t</span> flags,        <span class="comment">// è¾“å‡ºæ ‡è¯†ä½ï¼Œè¯¦è§ AUDIO_OUTPUT_FLAG æè¿°</span></span><br><span class="line">        <span class="keyword">callback_t</span> cbf,                    <span class="comment">// å›è°ƒå‡½æ•°</span></span><br><span class="line">        <span class="keyword">void</span>* user,                        <span class="comment">// å›è°ƒå‡½æ•°çš„å‚æ•°</span></span><br><span class="line">        <span class="keyword">uint32_t</span> notificationFrames,</span><br><span class="line">        <span class="keyword">int</span> sessionId,</span><br><span class="line">        transfer_type transferType,        <span class="comment">// æ•°æ®ä¼ è¾“ç±»å‹</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">audio_offload_info_t</span> *offloadInfo,</span><br><span class="line">        <span class="keyword">int</span> uid,</span><br><span class="line">        <span class="keyword">pid_t</span> pid,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">audio_attributes_t</span>* pAttributes,</span><br><span class="line">        <span class="keyword">bool</span> doNotReconnect)</span><br><span class="line">    : mStatus(NO_INIT),</span><br><span class="line">      mIsTimed(<span class="literal">false</span>),</span><br><span class="line">      mPreviousPriority(ANDROID_PRIORITY_NORMAL),</span><br><span class="line">      mPreviousSchedulingGroup(SP_DEFAULT),</span><br><span class="line">      mPausedPosition(<span class="number">0</span>),</span><br><span class="line">      mSelectedDeviceId(AUDIO_PORT_HANDLE_NONE)</span><br><span class="line">&#123;</span><br><span class="line">    mStatus = <span class="built_in">set</span>(streamType, sampleRate, format, channelMask,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/*frameCount*/</span>, flags, cbf, user, notificationFrames,</span><br><span class="line">            sharedBuffer, <span class="literal">false</span> <span class="comment">/*threadCanCallJava*/</span>, sessionId, transferType, offloadInfo,</span><br><span class="line">            uid, pid, pAttributes, doNotReconnect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> AudioTrack::<span class="built_in">set</span>(</span><br><span class="line">        <span class="keyword">audio_stream_type_t</span> streamType,</span><br><span class="line">        <span class="keyword">uint32_t</span> sampleRate,</span><br><span class="line">        <span class="keyword">audio_format_t</span> format,</span><br><span class="line">        <span class="keyword">audio_channel_mask_t</span> channelMask,</span><br><span class="line">        <span class="keyword">size_t</span> frameCount,</span><br><span class="line">        <span class="keyword">audio_output_flags_t</span> flags,        </span><br><span class="line">        <span class="keyword">callback_t</span> cbf,</span><br><span class="line">        <span class="keyword">void</span>* user,</span><br><span class="line">        <span class="keyword">uint32_t</span> notificationFrames,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">        <span class="keyword">bool</span> threadCanCallJava,</span><br><span class="line">        <span class="keyword">int</span> sessionId,</span><br><span class="line">        transfer_type transferType,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">audio_offload_info_t</span> *offloadInfo,</span><br><span class="line">        <span class="keyword">int</span> uid,</span><br><span class="line">        <span class="keyword">pid_t</span> pid,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">audio_attributes_t</span>* pAttributes,</span><br><span class="line">        <span class="keyword">bool</span> doNotReconnect)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å‚æ•°æ ¼å¼åˆæ³•æ€§æ£€æŸ¥ã€éŸ³è½¨éŸ³é‡åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ cbf éç©ºï¼Œé‚£ä¹ˆåˆ›å»º AudioTrackThread çº¿ç¨‹å¤„ç† audioCallback å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (cbf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mAudioTrackThread = <span class="keyword">new</span> AudioTrackThread(*<span class="keyword">this</span>, threadCanCallJava);</span><br><span class="line">        mAudioTrackThread-&gt;run(<span class="string">"AudioTrack"</span>, ANDROID_PRIORITY_AUDIO, <span class="number">0</span> <span class="comment">/*stack*/</span>);</span><br><span class="line">        <span class="comment">// thread begins in paused state, and will not reference us until start()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the IAudioTrack</span></span><br><span class="line">    <span class="keyword">status_t</span> status = createTrack_l();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> AudioTrack::createTrack_l()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è·å– IAudioFlingerï¼Œé€šè¿‡ binder è¯·æ±‚ AudioFlinger æœåŠ¡</span></span><br><span class="line">    <span class="keyword">const</span> sp&lt;IAudioFlinger&gt;&amp; audioFlinger = AudioSystem::get_audio_flinger();</span><br><span class="line">    <span class="keyword">if</span> (audioFlinger == <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not get audioflinger"</span>);</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// AudioSystem::getOutputForAttr() ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œè¿›å…¥ AudioPolicyManager::getOutputForDevice()</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¾“å‡ºæ ‡è¯†ç½®äº† AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD æˆ– AUDIO_OUTPUT_FLAG_DIRECTï¼Œ</span></span><br><span class="line">    <span class="comment">// é‚£ä¹ˆæœ€ç»ˆè°ƒç”¨ AudioFlinger::openOutput() æ‰“å¼€è¾“å‡ºæ ‡è¯†å¯¹åº”çš„è¾“å‡ºæµè®¾å¤‡å¹¶åˆ›å»ºç›¸å…³çš„</span></span><br><span class="line">    <span class="comment">// PlaybackThreadï¼Œä¿å­˜è¯¥ PlaybackThread å¯¹åº”çš„ audio_io_handle_t ç»™ AudioTrackï¼›</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¾“å‡ºæ ‡è¯†æ˜¯å…¶ä»–ç±»å‹ï¼Œé‚£ä¹ˆæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸€ä¸ªè¾“å‡ºæµè®¾å¤‡å’Œ PlaybackThreadï¼Œå¹¶ä¿å­˜è¯¥</span></span><br><span class="line">    <span class="comment">// PlaybackThread å¯¹åº”çš„ audio_io_handle_t ç»™ AudioTrack</span></span><br><span class="line">    <span class="keyword">audio_io_handle_t</span> output;</span><br><span class="line">    status = AudioSystem::getOutputForAttr(attr, &amp;output,</span><br><span class="line">                                           (<span class="keyword">audio_session_t</span>)mSessionId, &amp;streamType, mClientUid,</span><br><span class="line">                                           mSampleRate, mFormat, mChannelMask,</span><br><span class="line">                                           mFlags, mSelectedDeviceId, mOffloadInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ AudioFlinger å‘å‡º createTrack è¯·æ±‚</span></span><br><span class="line">    sp&lt;IAudioTrack&gt; track = audioFlinger-&gt;createTrack(streamType,</span><br><span class="line">                                                      mSampleRate,</span><br><span class="line">                                                      mFormat,</span><br><span class="line">                                                      mChannelMask,</span><br><span class="line">                                                      &amp;temp,</span><br><span class="line">                                                      &amp;trackFlags,</span><br><span class="line">                                                      mSharedBuffer,</span><br><span class="line">                                                      output,</span><br><span class="line">                                                      tid,</span><br><span class="line">                                                      &amp;mSessionId,</span><br><span class="line">                                                      mClientUid,</span><br><span class="line">                                                      &amp;status);</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// AudioFlinger åˆ›å»º Track å¯¹è±¡æ—¶ä¼šåˆ†é…ä¸€ä¸ª FIFOï¼Œè¿™é‡Œè·å– FIFO çš„æ§åˆ¶å—</span></span><br><span class="line">    sp&lt;IMemory&gt; iMem = track-&gt;getCblk();</span><br><span class="line">    <span class="keyword">if</span> (iMem == <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not get control block"</span>);</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŒ¿åå…±äº«å†…å­˜é¦–åœ°å€</span></span><br><span class="line">    <span class="keyword">void</span> *iMemPointer = iMem-&gt;pointer();</span><br><span class="line">    <span class="keyword">if</span> (iMemPointer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not get control block pointer"</span>);</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line">    mAudioTrack = track; <span class="comment">// ä¿å­˜ AudioFlinger::PlaybackThread::Track çš„ä»£ç†å¯¹è±¡ IAudioTrack</span></span><br><span class="line">    mCblkMemory = iMem; <span class="comment">// ä¿å­˜åŒ¿åå…±äº«å†…å­˜é¦–åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ§åˆ¶å—ä½äº AudioFlinger åˆ†é…çš„åŒ¿åå…±äº«å†…å­˜çš„é¦–éƒ¨</span></span><br><span class="line">    <span class="keyword">audio_track_cblk_t</span>* cblk = <span class="keyword">static_cast</span>&lt;<span class="keyword">audio_track_cblk_t</span>*&gt;(iMemPointer);</span><br><span class="line">    mCblk = cblk;</span><br><span class="line">    mOutput = output; <span class="comment">// ä¿å­˜è¿”å›çš„ audio_io_handle_tï¼Œç”¨å®ƒå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ PlaybackThread</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// update proxy</span></span><br><span class="line">    <span class="keyword">if</span> (mSharedBuffer == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å½“ mSharedBuffer ä¸ºç©ºï¼Œæ„å‘³ç€éŸ³è½¨æ•°æ®æ¨¡å¼ä¸º MODE_STREAMï¼Œé‚£ä¹ˆåˆ›å»º AudioTrackClientProxy å¯¹è±¡</span></span><br><span class="line">        mStaticProxy.clear();</span><br><span class="line">        mProxy = <span class="keyword">new</span> AudioTrackClientProxy(cblk, buffers, frameCount, mFrameSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å½“ mSharedBuffer éç©ºï¼Œæ„å‘³ç€éŸ³è½¨æ•°æ®æ¨¡å¼ä¸º MODE_STATICï¼Œé‚£ä¹ˆåˆ›å»º StaticAudioTrackClientProxy å¯¹è±¡</span></span><br><span class="line">        mStaticProxy = <span class="keyword">new</span> StaticAudioTrackClientProxy(cblk, buffers, frameCount, mFrameSize);</span><br><span class="line">        mProxy = mStaticProxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AudioFlinger::createTrack()ï¼Œé¡¾åæ€ä¹‰ï¼Œåˆ›å»ºä¸€ä¸ª Track å¯¹è±¡ï¼Œå°†ç”¨äºéŸ³é¢‘æµçš„æ§åˆ¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">sp&lt;IAudioTrack&gt; AudioFlinger::createTrack(</span><br><span class="line">        audio_stream_type_t streamType,</span><br><span class="line">        uint32_t sampleRate,</span><br><span class="line">        audio_format_t format,</span><br><span class="line">        audio_channel_mask_t channelMask,</span><br><span class="line">        size_t *frameCount,</span><br><span class="line">        IAudioFlinger::track_flags_t *flags,</span><br><span class="line">        const sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">        audio_io_handle_t output,</span><br><span class="line">        pid_t tid,</span><br><span class="line">        int *sessionId,</span><br><span class="line">        int clientUid,</span><br><span class="line">        status_t *status)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;PlaybackThread::Track&gt; track;</span><br><span class="line">    sp&lt;TrackHandle&gt; trackHandle;</span><br><span class="line">    sp&lt;Client&gt; client;</span><br><span class="line">    status_t lStatus;</span><br><span class="line">    int lSessionId;</span><br><span class="line"></span><br><span class="line">    //......</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        // æ ¹æ®ä¼ å…¥æ¥çš„ audio_io_handle_tï¼Œæ‰¾åˆ°å¯¹åº”çš„ PlaybackThread</span><br><span class="line">        PlaybackThread *thread = checkPlaybackThread_l(output);</span><br><span class="line">        if (thread == NULL) &#123;</span><br><span class="line">            ALOGE(&quot;no playback thread found for output handle %d&quot;, output);</span><br><span class="line">            lStatus = BAD_VALUE;</span><br><span class="line">            goto Exit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //......</span><br><span class="line"></span><br><span class="line">        // åœ¨ PlaybackThread ä¸Šåˆ›å»ºä¸€ä¸ªéŸ³é¢‘æµç®¡ç†å¯¹è±¡ Track</span><br><span class="line">        track = thread-&gt;createTrack_l(client, streamType, sampleRate, format,</span><br><span class="line">                channelMask, frameCount, sharedBuffer, lSessionId, flags, tid, clientUid, &amp;lStatus);</span><br><span class="line">        //......</span><br><span class="line"></span><br><span class="line">        setAudioHwSyncForSession_l(thread, (audio_session_t)lSessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //......</span><br><span class="line"></span><br><span class="line">    // åˆ›å»º Track çš„é€šè®¯ä»£ç† TrackHandle å¹¶è¿”å›å®ƒ</span><br><span class="line">    trackHandle = new TrackHandle(track);</span><br><span class="line"></span><br><span class="line">Exit:</span><br><span class="line">    *status = lStatus;</span><br><span class="line">    return trackHandle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;AudioFlinger::PlaybackThread::Track&gt; AudioFlinger::PlaybackThread::createTrack_l(</span><br><span class="line">        const sp&lt;AudioFlinger::Client&gt;&amp; client,</span><br><span class="line">        audio_stream_type_t streamType,</span><br><span class="line">        uint32_t sampleRate,</span><br><span class="line">        audio_format_t format,</span><br><span class="line">        audio_channel_mask_t channelMask,</span><br><span class="line">        size_t *pFrameCount,</span><br><span class="line">        const sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">        int sessionId,</span><br><span class="line">        IAudioFlinger::track_flags_t *flags,</span><br><span class="line">        pid_t tid,</span><br><span class="line">        int uid,</span><br><span class="line">        status_t *status)</span><br><span class="line">&#123;</span><br><span class="line">    size_t frameCount = *pFrameCount;</span><br><span class="line">    sp&lt;Track&gt; track;</span><br><span class="line">    status_t lStatus;</span><br><span class="line"></span><br><span class="line">    bool isTimed = (*flags &amp; IAudioFlinger::TRACK_TIMED) != 0;</span><br><span class="line"></span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    &#123; // scope for mLock</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        if (!isTimed) &#123;</span><br><span class="line">            // åˆ›å»º Trackï¼Œç­‰ä¼šå†çœ‹çœ‹ Track æ„é€ å‡½æ•°å¹²äº›å•¥</span><br><span class="line">            track = new Track(this, client, streamType, sampleRate, format,</span><br><span class="line">                              channelMask, frameCount, NULL, sharedBuffer,</span><br><span class="line">                              sessionId, uid, *flags, TrackBase::TYPE_DEFAULT);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // åˆ›å»º TimedTrackï¼Œå¸¦æ—¶é—´æˆ³çš„ Trackï¼Ÿè¿™é‡Œä¸æ·±ç©¶</span><br><span class="line">            track = TimedTrack::create(this, client, streamType, sampleRate, format,</span><br><span class="line">                    channelMask, frameCount, sharedBuffer, sessionId, uid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line"></span><br><span class="line">        // æŠŠåˆ›å»ºçš„ Track æ·»åŠ åˆ° mTracks å‘é‡ä¸­ï¼Œæ–¹ä¾¿ PlaybackThread ç»Ÿä¸€ç®¡ç†</span><br><span class="line">        mTracks.add(track);</span><br><span class="line"></span><br><span class="line">        // ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lStatus = NO_ERROR;</span><br><span class="line"></span><br><span class="line">Exit:</span><br><span class="line">    *status = lStatus;</span><br><span class="line">    return track;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ----------------------------------------------------------------------------</span><br><span class="line">// å¦‚ä¸‹æ˜¯ TrackHandle çš„ç›¸å…³ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒTrackHandle å…¶å®å°±æ˜¯ä¸€ä¸ªå£³å­ï¼Œæ˜¯ Track çš„åŒ…è£…ç±»</span><br><span class="line">// æ‰€æœ‰ TrackHandle æ¥å£éƒ½æ˜¯è°ƒå‘ Track çš„</span><br><span class="line">// Google ä¸ºä»€ä¹ˆè¦æè¿™ä¹ˆä¸€åˆ™ï¼ŸTrack æ˜¯ PlaybackThread å†…éƒ¨ä½¿ç”¨çš„ï¼Œä¸é€‚å®œå¯¹å¤–æš´éœ²ï¼Œä½†åº”ç”¨è¿›ç¨‹</span><br><span class="line">// åˆç¡®å®éœ€è¦æ§åˆ¶éŸ³é¢‘æµçš„çŠ¶æ€ï¼ˆstartã€stopã€pauseï¼‰ï¼Œæ‰€ä»¥å°±é‡‡å–è¿™ä¹ˆä¸€ç§æ–¹å¼å®ç°</span><br><span class="line"></span><br><span class="line">AudioFlinger::TrackHandle::TrackHandle(const sp&lt;AudioFlinger::PlaybackThread::Track&gt;&amp; track)</span><br><span class="line">    : BnAudioTrack(),</span><br><span class="line">      mTrack(track)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AudioFlinger::TrackHandle::~TrackHandle() &#123;</span><br><span class="line">    // just stop the track on deletion, associated resources</span><br><span class="line">    // will be freed from the main thread once all pending buffers have</span><br><span class="line">    // been played. Unless it&apos;s not in the active track list, in which</span><br><span class="line">    // case we free everything now...</span><br><span class="line">    mTrack-&gt;destroy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;IMemory&gt; AudioFlinger::TrackHandle::getCblk() const &#123;</span><br><span class="line">    return mTrack-&gt;getCblk();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status_t AudioFlinger::TrackHandle::start() &#123;</span><br><span class="line">    return mTrack-&gt;start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void AudioFlinger::TrackHandle::stop() &#123;</span><br><span class="line">    mTrack-&gt;stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void AudioFlinger::TrackHandle::flush() &#123;</span><br><span class="line">    mTrack-&gt;flush();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void AudioFlinger::TrackHandle::pause() &#123;</span><br><span class="line">    mTrack-&gt;pause();</span><br><span class="line">&#125;</span><br><span class="line">// ----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬çœ‹çœ‹ Track çš„æ„é€ è¿‡ç¨‹ï¼Œä¸»è¦åˆ†ææ•°æ® FIFO åŠå®ƒçš„æ§åˆ¶å—æ˜¯å¦‚ä½•åˆ†é…çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">AudioFlinger::PlaybackThread::Track::Track(</span><br><span class="line">            PlaybackThread *thread,</span><br><span class="line">            <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">            <span class="keyword">audio_stream_type_t</span> streamType,</span><br><span class="line">            <span class="keyword">uint32_t</span> sampleRate,</span><br><span class="line">            <span class="keyword">audio_format_t</span> format,</span><br><span class="line">            <span class="keyword">audio_channel_mask_t</span> channelMask,</span><br><span class="line">            <span class="keyword">size_t</span> frameCount,</span><br><span class="line">            <span class="keyword">void</span> *buffer,</span><br><span class="line">            <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">            <span class="keyword">int</span> sessionId,</span><br><span class="line">            <span class="keyword">int</span> uid,</span><br><span class="line">            IAudioFlinger::<span class="keyword">track_flags_t</span> flags,</span><br><span class="line">            track_type type)</span><br><span class="line">    :   TrackBase(thread, client, sampleRate, format, channelMask, frameCount,</span><br><span class="line">                  (sharedBuffer != <span class="number">0</span>) ? sharedBuffer-&gt;pointer() : buffer,</span><br><span class="line">                  sessionId, uid, flags, <span class="literal">true</span> <span class="comment">/*isOut*/</span>,</span><br><span class="line">                  (type == TYPE_PATCH) ? ( buffer == <span class="literal">NULL</span> ? ALLOC_LOCAL : ALLOC_NONE) : ALLOC_CBLK,</span><br><span class="line">                  type),</span><br><span class="line">    mFillingUpStatus(FS_INVALID),</span><br><span class="line">    <span class="comment">// mRetryCount initialized later when needed</span></span><br><span class="line">    mSharedBuffer(sharedBuffer),</span><br><span class="line">    mStreamType(streamType),</span><br><span class="line">    mName(<span class="number">-1</span>),  <span class="comment">// see note below</span></span><br><span class="line">    mMainBuffer(thread-&gt;mixBuffer()),</span><br><span class="line">    mAuxBuffer(<span class="literal">NULL</span>),</span><br><span class="line">    mAuxEffectId(<span class="number">0</span>), mHasVolumeController(<span class="literal">false</span>),</span><br><span class="line">    mPresentationCompleteFrames(<span class="number">0</span>),</span><br><span class="line">    mFastIndex(<span class="number">-1</span>),</span><br><span class="line">    mCachedVolume(<span class="number">1.0</span>),</span><br><span class="line">    mIsInvalid(<span class="literal">false</span>),</span><br><span class="line">    mAudioTrackServerProxy(<span class="literal">NULL</span>),</span><br><span class="line">    mResumeToStopping(<span class="literal">false</span>),</span><br><span class="line">    mFlushHwPending(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// client == 0 implies sharedBuffer == 0</span></span><br><span class="line">    ALOG_ASSERT(!(client == <span class="number">0</span> &amp;&amp; sharedBuffer != <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    ALOGV_IF(sharedBuffer != <span class="number">0</span>, <span class="string">"sharedBuffer: %p, size: %d"</span>, sharedBuffer-&gt;pointer(),</span><br><span class="line">            sharedBuffer-&gt;size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥ FIFO æ§åˆ¶å—ï¼ˆaudio_track_cblk_tï¼‰æ˜¯å¦åˆ†é…å¥½äº†ï¼Œä¸Šé¢ä»£ç å¹¶æœªåˆ†é… audio_track_cblk_t</span></span><br><span class="line">    <span class="comment">// å› æ­¤åªå¯èƒ½æ˜¯æ„é€  TrackBase æ—¶åˆ†é…çš„ï¼Œç­‰ä¸‹å†çœ‹çœ‹ TrackBase çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (mCblk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sharedBuffer == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º MODE_STREAM æ¨¡å¼ï¼Œåˆ›å»ºä¸€ä¸ª AudioTrackServerProxy å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// PlaybackThread å°†æŒç»­ä½¿ç”¨å®ƒä» FIFO ä¸Šå–å¾—å¯è¯»æ•°æ®çš„ä½ç½®</span></span><br><span class="line">        mAudioTrackServerProxy = <span class="keyword">new</span> AudioTrackServerProxy(mCblk, mBuffer, frameCount,</span><br><span class="line">                mFrameSize, !isExternalTrack(), sampleRate);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º MODE_STATIC æ¨¡å¼ï¼Œåˆ›å»ºä¸€ä¸ª StaticAudioTrackServerProxy å¯¹è±¡</span></span><br><span class="line">        mAudioTrackServerProxy = <span class="keyword">new</span> StaticAudioTrackServerProxy(mCblk, mBuffer, frameCount,</span><br><span class="line">                mFrameSize);</span><br><span class="line">    &#125;</span><br><span class="line">    mServerProxy = mAudioTrackServerProxy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸º Track åˆ†é…ä¸€ä¸ªåç§°ï¼ŒAudioMixer ä¼šæ ¹æ® TrackName æ‰¾åˆ°å¯¹åº”çš„ Track</span></span><br><span class="line">    mName = thread-&gt;getTrackName_l(channelMask, format, sessionId);</span><br><span class="line">    <span class="keyword">if</span> (mName &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"no more track names available"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AudioFlinger::ThreadBase::TrackBase::TrackBase(</span><br><span class="line">            ThreadBase *thread,</span><br><span class="line">            <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">            <span class="keyword">uint32_t</span> sampleRate,</span><br><span class="line">            <span class="keyword">audio_format_t</span> format,</span><br><span class="line">            <span class="keyword">audio_channel_mask_t</span> channelMask,</span><br><span class="line">            <span class="keyword">size_t</span> frameCount,</span><br><span class="line">            <span class="keyword">void</span> *buffer,</span><br><span class="line">            <span class="keyword">int</span> sessionId,</span><br><span class="line">            <span class="keyword">int</span> clientUid,</span><br><span class="line">            IAudioFlinger::<span class="keyword">track_flags_t</span> flags,</span><br><span class="line">            <span class="keyword">bool</span> isOut,</span><br><span class="line">            alloc_type alloc,</span><br><span class="line">            track_type type)</span><br><span class="line">    :   RefBase(),</span><br><span class="line">        mThread(thread),</span><br><span class="line">        mClient(client),</span><br><span class="line">        mCblk(<span class="literal">NULL</span>),</span><br><span class="line">        <span class="comment">// mBuffer</span></span><br><span class="line">        mState(IDLE),</span><br><span class="line">        mSampleRate(sampleRate),</span><br><span class="line">        mFormat(format),</span><br><span class="line">        mChannelMask(channelMask),</span><br><span class="line">        mChannelCount(isOut ?</span><br><span class="line">                audio_channel_count_from_out_mask(channelMask) :</span><br><span class="line">                audio_channel_count_from_in_mask(channelMask)),</span><br><span class="line">        mFrameSize(audio_is_linear_pcm(format) ?</span><br><span class="line">                mChannelCount * audio_bytes_per_sample(format) : <span class="keyword">sizeof</span>(<span class="keyword">int8_t</span>)),</span><br><span class="line">        mFrameCount(frameCount),</span><br><span class="line">        mSessionId(sessionId),</span><br><span class="line">        mFlags(flags),</span><br><span class="line">        mIsOut(isOut),</span><br><span class="line">        mServerProxy(<span class="literal">NULL</span>),</span><br><span class="line">        mId(android_atomic_inc(&amp;nextTrackId)),</span><br><span class="line">        mTerminated(<span class="literal">false</span>),</span><br><span class="line">        mType(type),</span><br><span class="line">        mThreadIoHandle(thread-&gt;id())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGD("Creating track with %d buffers @ %d bytes", bufferCount, bufferSize);</span></span><br><span class="line">    <span class="keyword">size_t</span> size = <span class="keyword">sizeof</span>(<span class="keyword">audio_track_cblk_t</span>);</span><br><span class="line">    <span class="keyword">size_t</span> bufferSize = (buffer == <span class="literal">NULL</span> ? roundup(frameCount) : frameCount) * mFrameSize;</span><br><span class="line">    <span class="keyword">if</span> (buffer == <span class="literal">NULL</span> &amp;&amp; alloc == ALLOC_CBLK) &#123;</span><br><span class="line">        <span class="comment">// è¿™ä¸ª size å°†æ˜¯åˆ†é…çš„åŒ¿åå…±äº«å†…å­˜çš„å¤§å°</span></span><br><span class="line">        <span class="comment">// ç­‰äºæ§åˆ¶å—çš„å¤§å°ï¼ˆsizeof(audio_track_cblk_t)åŠ ä¸Šæ•°æ® FIFOçš„å¤§å°ï¼ˆbufferSizeï¼‰</span></span><br><span class="line">        <span class="comment">// å¾…ä¼šçœ‹åˆ°è¿™å—å†…å­˜çš„ç»“æ„ï¼Œå°±æ˜ç™½è¿™æ ·åˆ†é…çš„æ„ä¹‰äº†</span></span><br><span class="line">        size += bufferSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (client != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…ä¸€å—åŒ¿åå…±äº«å†…å­˜</span></span><br><span class="line">        mCblkMemory = client-&gt;heap()-&gt;allocate(size);</span><br><span class="line">        <span class="keyword">if</span> (mCblkMemory == <span class="number">0</span> ||</span><br><span class="line">                (mCblk = <span class="keyword">static_cast</span>&lt;<span class="keyword">audio_track_cblk_t</span> *&gt;(mCblkMemory-&gt;pointer())) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"not enough memory for AudioTrack size=%u"</span>, size);</span><br><span class="line">            client-&gt;heap()-&gt;dump(<span class="string">"AudioTrack"</span>);</span><br><span class="line">            mCblkMemory.clear();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// this syntax avoids calling the audio_track_cblk_t constructor twice</span></span><br><span class="line">        mCblk = (<span class="keyword">audio_track_cblk_t</span> *) <span class="keyword">new</span> <span class="keyword">uint8_t</span>[size];</span><br><span class="line">        <span class="comment">// assume mCblk != NULL</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// construct the shared structure in-place.</span></span><br><span class="line">    <span class="keyword">if</span> (mCblk != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿™æ˜¯ C++ çš„ placement newï¼ˆå®šä½åˆ›å»ºå¯¹è±¡ï¼‰è¯­æ³•ï¼šnew(@BUFFER) @CLASS();</span></span><br><span class="line">        <span class="comment">// å¯ä»¥åœ¨ç‰¹å®šå†…å­˜ä½ç½®ä¸Šæ„é€ ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œï¼Œåœ¨åŒ¿åå…±äº«å†…å­˜é¦–åœ°å€ä¸Šæ„é€ äº†ä¸€ä¸ª audio_track_cblk_t å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// è¿™æ · AudioTrack ä¸ AudioFlinger éƒ½èƒ½è®¿é—®è¿™ä¸ª audio_track_cblk_t å¯¹è±¡äº†</span></span><br><span class="line">        <span class="keyword">new</span>(mCblk) <span class="keyword">audio_track_cblk_t</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚ä¸‹åˆ†é…æ•°æ® FIFOï¼Œå°†ç”¨äº AudioTrack ä¸ AudioFlinger çš„æ•°æ®äº¤æ¢</span></span><br><span class="line">        <span class="keyword">switch</span> (alloc) &#123;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="keyword">case</span> ALLOC_CBLK:</span><br><span class="line">            <span class="comment">// clear all buffers</span></span><br><span class="line">            <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º MODE_STREAM/TRANSFER_SYNC æ—¶ï¼Œæ•°æ® FIFO çš„åˆ†é…</span></span><br><span class="line">                <span class="comment">// æ•°æ® FIFO çš„é¦–åœ°å€ç´§é æ§åˆ¶å—ï¼ˆaudio_track_cblk_tï¼‰ä¹‹å</span></span><br><span class="line">                <span class="comment">//   |                                                         |</span></span><br><span class="line">                <span class="comment">//   | -------------------&gt; mCblkMemory &lt;--------------------- |</span></span><br><span class="line">                <span class="comment">//   |                                                         |</span></span><br><span class="line">                <span class="comment">//   +--------------------+------------------------------------+</span></span><br><span class="line">                <span class="comment">//   | audio_track_cblk_t |             Buffer                 |</span></span><br><span class="line">                <span class="comment">//   +--------------------+------------------------------------+</span></span><br><span class="line">                <span class="comment">//   ^                    ^</span></span><br><span class="line">                <span class="comment">//   |                    |</span></span><br><span class="line">                <span class="comment">//   mCblk               mBuffer</span></span><br><span class="line">                mBuffer = (<span class="keyword">char</span>*)mCblk + <span class="keyword">sizeof</span>(<span class="keyword">audio_track_cblk_t</span>);</span><br><span class="line">                <span class="built_in">memset</span>(mBuffer, <span class="number">0</span>, bufferSize);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ•°æ®ä¼ è¾“æ¨¡å¼ä¸º MODE_STATIC/TRANSFER_SHARED æ—¶ï¼Œç›´æ¥æŒ‡å‘ sharedBuffer</span></span><br><span class="line">                <span class="comment">// sharedBuffer æ˜¯åº”ç”¨è¿›ç¨‹åˆ†é…çš„åŒ¿åå…±äº«å†…å­˜ï¼Œåº”ç”¨è¿›ç¨‹å·²ç»ä¸€æ¬¡æ€§æŠŠæ•°æ®</span></span><br><span class="line">                <span class="comment">// å†™åˆ° sharedBuffer æ¥äº†ï¼ŒAudioFlinger å¯ä»¥ç›´æ¥ä»è¿™é‡Œè¯»å–</span></span><br><span class="line">                <span class="comment">//   +--------------------+    +-----------------------------------+</span></span><br><span class="line">                <span class="comment">//   | audio_track_cblk_t |    |            sharedBuffer           |</span></span><br><span class="line">                <span class="comment">//   +--------------------+    +-----------------------------------+</span></span><br><span class="line">                <span class="comment">//   ^                         ^</span></span><br><span class="line">                <span class="comment">//   |                         |</span></span><br><span class="line">                <span class="comment">//   mCblk                    mBuffer</span></span><br><span class="line">                mBuffer = buffer;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-3-AudioTrack-æ•°æ®å†™å…¥"><a href="#3-3-AudioTrack-æ•°æ®å†™å…¥" class="headerlink" title="3.3. AudioTrack æ•°æ®å†™å…¥"></a>3.3. AudioTrack æ•°æ®å†™å…¥</h5><p>AudioTrack å®ä¾‹æ„é€ åï¼Œåº”ç”¨ç¨‹åºæ¥ç€å¯ä»¥å†™å…¥éŸ³é¢‘æ•°æ®äº†ã€‚å¦‚ä¹‹å‰æ‰€æè¿°ï¼šAudioTrack ä¸ AudioFlinger æ˜¯ ç”Ÿäº§è€…-æ¶ˆè´¹è€… çš„å…³ç³»ï¼š</p><p>â˜¯ AudioTrackï¼šAudioTrack åœ¨ FIFO ä¸­æ‰¾åˆ°ä¸€å—å¯ç”¨ç©ºé—´ï¼ŒæŠŠç”¨æˆ·ä¼ å…¥çš„éŸ³é¢‘æ•°æ®å†™å…¥åˆ°è¿™å—å¯ç”¨ç©ºé—´ä¸Šï¼Œç„¶åæ›´æ–°å†™ä½ç½®ï¼ˆå¯¹äº AudioFinger æ¥è¯´ï¼Œæ„å‘³ FIFO ä¸Šæœ‰æ›´å¤šçš„å¯è¯»æ•°æ®äº†ï¼‰ï¼›å¦‚æœç”¨æˆ·ä¼ å…¥çš„æ•°æ®é‡æ¯”å¯ç”¨ç©ºé—´è¦å¤§ï¼Œé‚£ä¹ˆè¦æŠŠç”¨æˆ·ä¼ å…¥çš„æ•°æ®æ‹†åˆ†å¤šæ¬¡å†™å…¥åˆ° FIFO ä¸­ï¼ˆAudioTrack å’Œ AudioFlinger æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼ŒAudioFlinger åŒæ—¶ä¹Ÿåœ¨ä¸åœåœ°è¯»å–æ•°æ®ï¼Œæ‰€ä»¥ FIFO å¯ç”¨ç©ºé—´æ˜¯åœ¨ä¸åœå˜åŒ–çš„ï¼‰<br>â˜¯ AudioFlingerï¼šAudioFlinger åœ¨ FIFO ä¸­æ‰¾åˆ°ä¸€å—å¯è¯»æ•°æ®å—ï¼ŒæŠŠå¯è¯»æ•°æ®æ‹·è´åˆ°ç›®çš„ç¼“å†²åŒºä¸Šï¼Œç„¶åæ›´æ–°è¯»ä½ç½®ï¼ˆå¯¹äº AudioTrack æ¥è¯´ï¼Œæ„å‘³ç€ FIFO ä¸Šæœ‰æ›´å¤šçš„å¯ç”¨ç©ºé—´äº†ï¼‰ï¼›å¦‚æœFIFO ä¸Šå¯è¯»æ•°æ®é‡æ¯”é¢„æœŸçš„è¦å°ï¼Œé‚£ä¹ˆè¦è¿›è¡Œå¤šæ¬¡çš„è¯»å–ï¼Œæ‰èƒ½ç§¯ç´¯åˆ°é¢„æœŸçš„æ•°æ®é‡ï¼ˆAudioTrack å’Œ AudioFlinger æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼ŒAudioTrack åŒæ—¶ä¹Ÿåœ¨ä¸åœåœ°å†™å…¥æ•°æ®ï¼Œæ‰€ä»¥ FIFO å¯è¯»çš„æ•°æ®é‡æ˜¯åœ¨ä¸åœå˜åŒ–çš„ï¼‰<br>ä¸Šé¢çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ AudioTrack æ€»èƒ½åŠæ—¶ç”Ÿäº§æ•°æ®ï¼Œå¹¶ä¸” AudioFlinger æ€»èƒ½åŠæ—¶æ¶ˆè€—æ‰è¿™äº›æ•°æ®ï¼Œé‚£ä¹ˆæ•´ä¸ªè¿‡ç¨‹å°†æ˜¯éå¸¸å’Œè°çš„ï¼›ä½†ç³»ç»Ÿå¯èƒ½ä¼šå‘ç”Ÿå¼‚å¸¸ï¼Œå‡ºç°å¦‚ä¸‹çš„çŠ¶æ€ï¼š</p><p>â˜¯ Blockï¼šAudioFlinger é•¿æ—¶é—´ä¸è¯»å– FIFO ä¸Šçš„å¯è¯»æ•°æ®ï¼Œä½¿å¾— AudioTrack é•¿æ—¶é—´è·å–ä¸åˆ°å¯ç”¨ç©ºé—´ï¼Œæ— æ³•å†™å…¥æ•°æ®ï¼›è¿™ç§æƒ…å†µçš„æ ¹æœ¬åŸå› å¤§å¤šæ˜¯åº•å±‚é©±åŠ¨å‘ç”Ÿé˜»å¡å¼‚å¸¸ï¼Œå¯¼è‡´ AudioFlinger æ— æ³•ç»§ç»­å†™æ•°æ®åˆ°ç¡¬ä»¶è®¾å¤‡ä¸­ï¼ŒAudioFlinger æœ¬èº«å¹¶æ²¡æœ‰é”™<br>â˜¯ Underrunï¼šAudioTrack å†™å…¥æ•°æ®çš„é€Ÿåº¦è·Ÿä¸ä¸Š AudioFlinger è¯»å–æ•°æ®çš„é€Ÿåº¦ï¼Œä½¿å¾— AudioFlinger ä¸èƒ½åŠæ—¶è·å–åˆ°é¢„æœŸçš„æ•°æ®é‡ï¼Œåæ˜ åˆ°ç°å®çš„åæœå°±æ˜¯å£°éŸ³æ–­ç»­ï¼›è¿™ç§æƒ…å†µçš„æ ¹æœ¬åŸå› å¤§å¤šæ˜¯åº”ç”¨ç¨‹åºä¸èƒ½åŠæ—¶å†™å…¥æ•°æ®æˆ–è€…ç¼“å†²åŒºåˆ†é…è¿‡å°ï¼ŒAudioTrack æœ¬èº«å¹¶æ²¡æœ‰é”™ï¼›AudioFlinger é’ˆå¯¹è¿™ç‚¹åšäº†å®¹é”™å¤„ç†ï¼šå½“å‘ç° underrun æ—¶ï¼Œå…ˆé™·å…¥çŸ­æ—¶é—´çš„ç¡çœ ï¼Œä¸æ€¥ç€è¯»å–æ•°æ®ï¼Œè®©åº”ç”¨ç¨‹åºå‡†å¤‡æ›´å¤šçš„æ•°æ®ï¼ˆå¦‚æœæŸä¸€å¤©åšåº”ç”¨çš„å“¥ä»¬æ„è¯†åˆ°è‡ªå·±çš„é”™è¯¯åŸæ¥ç”±åº•å±‚çš„å…„å¼Ÿé»˜é»˜åŸ‹å•äº†ï¼Œä¼šä¸ä¼šæ„ŸåŠ¨å¾—å“­äº†^_^ï¼‰</p><h5 id="3-3-1-AudioTrack-å†™æ•°æ®æµç¨‹"><a href="#3-3-1-AudioTrack-å†™æ•°æ®æµç¨‹" class="headerlink" title="3.3. 1. AudioTrack å†™æ•°æ®æµç¨‹"></a>3.3. 1. AudioTrack å†™æ•°æ®æµç¨‹</h5><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ AudioTrack å†™æ•°æ®çš„ä»£ç ï¼Œæµç¨‹å¾ˆç®€å•ï¼šobtainBuffer() åœ¨ FIFO ä¸­æ‰¾åˆ°ä¸€å—å¯ç”¨åŒºé—´ï¼Œmemcpy() æŠŠç”¨æˆ·ä¼ å…¥çš„éŸ³é¢‘æ•°æ®æ‹·è´åˆ°è¿™ä¸ªå¯ç”¨åŒºé—´ä¸Šï¼ŒreleaseBuffer() æ›´æ–°å†™ä½ç½®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\media\libmedia\AudioTrack.cpp]</span><br><span class="line">ssize_t AudioTrack::write(const void* buffer, size_t userSize, bool blocking)</span><br><span class="line">&#123;</span><br><span class="line">    if (mTransfer != TRANSFER_SYNC) &#123;</span><br><span class="line">        return INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isDirect()) &#123;</span><br><span class="line">        AutoMutex lock(mLock);</span><br><span class="line">        int32_t flags = android_atomic_and(</span><br><span class="line">                            ~(CBLK_UNDERRUN | CBLK_LOOP_CYCLE | CBLK_LOOP_FINAL | CBLK_BUFFER_END),</span><br><span class="line">                            &amp;mCblk-&gt;mFlags);</span><br><span class="line">        if (flags &amp; CBLK_INVALID) &#123;</span><br><span class="line">            return DEAD_OBJECT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ssize_t(userSize) &lt; 0 || (buffer == NULL &amp;&amp; userSize != 0)) &#123;</span><br><span class="line">        // Sanity-check: user is most-likely passing an error code, and it would</span><br><span class="line">        // make the return value ambiguous (actualSize vs error).</span><br><span class="line">        ALOGE(&quot;AudioTrack::write(buffer=%p, size=%zu (%zd)&quot;, buffer, userSize, userSize);</span><br><span class="line">        return BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size_t written = 0;</span><br><span class="line">    Buffer audioBuffer;</span><br><span class="line"></span><br><span class="line">    while (userSize &gt;= mFrameSize) &#123;</span><br><span class="line">        // å•å¸§æ•°æ®é‡ frameSize = channelCount * bytesPerSample</span><br><span class="line">        //   å¯¹äºåŒå£°é“ï¼Œ16ä½é‡‡æ ·çš„éŸ³é¢‘æ•°æ®æ¥è¯´ï¼ŒframeSize = 2 * 2 = 4(bytes)</span><br><span class="line">        // ç”¨æˆ·ä¼ å…¥çš„æ•°æ®å¸§æ•° frameCount = userSize / frameSize</span><br><span class="line">        audioBuffer.frameCount = userSize / mFrameSize;</span><br><span class="line"></span><br><span class="line">        // obtainBuffer() ä» FIFO ä¸Šå¾—åˆ°ä¸€å—å¯ç”¨åŒºé—´</span><br><span class="line">        status_t err = obtainBuffer(&amp;audioBuffer,</span><br><span class="line">                blocking ? &amp;ClientProxy::kForever : &amp;ClientProxy::kNonBlocking);</span><br><span class="line">        if (err &lt; 0) &#123;</span><br><span class="line">            if (written &gt; 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (err == TIMED_OUT || err == -EINTR) &#123;</span><br><span class="line">                err = WOULD_BLOCK;</span><br><span class="line">            &#125;</span><br><span class="line">            return ssize_t(err);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // toWrite æ˜¯ FIFO å¯ç”¨åŒºé—´çš„å¤§å°ï¼Œå¯èƒ½æ¯” userSizeï¼ˆç”¨æˆ·ä¼ å…¥æ•°æ®çš„å¤§å°ï¼‰è¦å°</span><br><span class="line">        //   å› æ­¤ç”¨æˆ·ä¼ å…¥çš„æ•°æ®å¯èƒ½è¦æ‹†åˆ†å¤šæ¬¡æ‹·è´åˆ° FIFO ä¸Š</span><br><span class="line">        // æ³¨æ„ï¼šAudioTrack å’Œ AudioFlinger æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼ŒAudioFlinger åŒæ—¶ä¹Ÿåœ¨ä¸åœåœ°</span><br><span class="line">        //   æ¶ˆè€—æ•°æ®ï¼Œæ‰€ä»¥ FIFO å¯ç”¨åŒºé—´æ˜¯åœ¨ä¸åœå˜åŒ–çš„</span><br><span class="line">        size_t toWrite = audioBuffer.size;</span><br><span class="line">        memcpy(audioBuffer.i8, buffer, toWrite); // æŠŠç”¨æˆ·æ•°æ®æ‹·è´åˆ° FIFO å¯ç”¨åŒºé—´</span><br><span class="line">        buffer = ((const char *) buffer) + toWrite; // æœªæ‹·è´æ•°æ®çš„ä½ç½®</span><br><span class="line">        userSize -= toWrite; // æœªæ‹·è´æ•°æ®çš„å¤§å°</span><br><span class="line">        written += toWrite; // å·²æ‹·è´æ•°æ®çš„å¤§å°</span><br><span class="line"></span><br><span class="line">        // releaseBuffer() æ›´æ–° FIFO å†™ä½ç½®</span><br><span class="line">        // å¯¹äº AudioFinger æ¥è¯´ï¼Œæ„å‘³ FIFO ä¸Šæœ‰æ›´å¤šçš„å¯è¯»æ•°æ®</span><br><span class="line">        releaseBuffer(&amp;audioBuffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (written &gt; 0) &#123;</span><br><span class="line">        mFramesWritten += written / mFrameSize;</span><br><span class="line">    &#125;</span><br><span class="line">    return written;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-3-2-AudioFlinger-è¯»æ•°æ®æµç¨‹"><a href="#3-3-2-AudioFlinger-è¯»æ•°æ®æµç¨‹" class="headerlink" title="3.3. 2. AudioFlinger è¯»æ•°æ®æµç¨‹"></a>3.3. 2. AudioFlinger è¯»æ•°æ®æµç¨‹</h5><p>AudioFlinger æ¶ˆè´¹æ•°æ®çš„æµç¨‹ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œ3.4. AudioFlinger å›æ”¾å½•åˆ¶çº¿ç¨‹ å°èŠ‚ä¸­æè¿°äº† AudioFlinger::PlaybackThread::threadLoop() å·¥ä½œæµç¨‹ï¼Œè¿™é‡Œä¸ç´¯è¿°äº†ï¼Œæˆ‘ä»¬æŠŠç„¦ç‚¹æ”¾åœ¨â€œå¦‚ä½•ä» FIFO è¯»å–æ•°æ®â€èŠ‚ç‚¹ä¸Šã€‚</p><p>æˆ‘ä»¬ä»¥ DirectOutputThread/OffloadThread ä¸ºä¾‹è¯´æ˜ï¼ˆMixerThread è¯»æ•°æ®ä¹Ÿæ˜¯ç±»ä¼¼çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡æ˜¯åœ¨ AudioMixer ä¸­è¿›è¡Œçš„ï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\audioflinger\AudioFlinger.cpp]</span><br><span class="line">void AudioFlinger::DirectOutputThread::threadLoop_mix()</span><br><span class="line">&#123;</span><br><span class="line">    // mFrameCount æ˜¯ç¡¬ä»¶è®¾å¤‡ï¼ˆPCM è®¾å¤‡ï¼‰å¤„ç†å•ä¸ªæ•°æ®å—çš„å¸§æ•°ï¼ˆå‘¨æœŸå¤§å°ï¼‰</span><br><span class="line">    //   ä¸Šå±‚å¿…é¡»ç§¯ç´¯äº†è¶³å¤Ÿå¤šï¼ˆmFrameCountï¼‰çš„æ•°æ®ï¼Œæ‰å†™å…¥åˆ° PCM è®¾å¤‡</span><br><span class="line">    //   æ‰€ä»¥ mFrameCount ä¹Ÿå°±æ˜¯ AudioFlinger é¢„æœŸçš„æ•°æ®é‡</span><br><span class="line">    size_t frameCount = mFrameCount;</span><br><span class="line">    // mSinkBuffer ç›®çš„ç¼“å†²åŒºï¼ŒthreadLoop_write() ä¼šæŠŠ mSinkBuffer ä¸Šçš„æ•°æ®å†™åˆ° PCM è®¾å¤‡</span><br><span class="line">    int8_t *curBuf = (int8_t *)mSinkBuffer;</span><br><span class="line">    // output audio to hardware</span><br><span class="line">    // FIFO ä¸Šå¯è¯»çš„æ•°æ®é‡å¯èƒ½è¦æ¯”é¢„æœŸçš„è¦å°ï¼Œå› æ­¤å¯èƒ½éœ€è¦å¤šæ¬¡è¯»å–æ‰èƒ½ç§¯ç´¯è¶³å¤Ÿçš„æ•°æ®é‡</span><br><span class="line">    // æ³¨æ„ï¼šAudioTrack å’Œ AudioFlinger æ˜¯ä¸åŒçš„è¿›ç¨‹ï¼ŒAudioTrack åŒæ—¶ä¹Ÿåœ¨ä¸åœåœ°ç”Ÿäº§æ•°æ®</span><br><span class="line">    //   æ‰€ä»¥ FIFO å¯è¯»çš„æ•°æ®é‡æ˜¯åœ¨ä¸åœå˜åŒ–çš„</span><br><span class="line">    while (frameCount) &#123;</span><br><span class="line">        AudioBufferProvider::Buffer buffer;</span><br><span class="line">        buffer.frameCount = frameCount;</span><br><span class="line">        // getNextBuffer() ä» FIFO ä¸Šè·å–å¯è¯»æ•°æ®å—</span><br><span class="line">        status_t status = mActiveTrack-&gt;getNextBuffer(&amp;buffer);</span><br><span class="line">        if (status != NO_ERROR || buffer.raw == NULL) &#123;</span><br><span class="line">            memset(curBuf, 0, frameCount * mFrameSize);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        // memcpy() æŠŠ FIFO å¯è¯»æ•°æ®æ‹·è´åˆ° mSinkBuffer ç›®çš„ç¼“å†²åŒº</span><br><span class="line">        memcpy(curBuf, buffer.raw, buffer.frameCount * mFrameSize);</span><br><span class="line">        frameCount -= buffer.frameCount;</span><br><span class="line">        curBuf += buffer.frameCount * mFrameSize;</span><br><span class="line">        // releaseBuffer() æ›´æ–° FIFO è¯»ä½ç½®</span><br><span class="line">        // å¯¹äº AudioTrack æ¥è¯´ï¼Œæ„å‘³ç€ FIFO ä¸Šæœ‰æ›´å¤šçš„å¯ç”¨ç©ºé—´</span><br><span class="line">        mActiveTrack-&gt;releaseBuffer(&amp;buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    mCurrentWriteLength = curBuf - (int8_t *)mSinkBuffer;</span><br><span class="line">    mSleepTimeUs = 0;</span><br><span class="line">    mStandbyTimeNs = systemTime() + mStandbyDelayNs;</span><br><span class="line">    mActiveTrack.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-3-3-ç¯å½¢-FIFO-ç®¡ç†"><a href="#3-3-3-ç¯å½¢-FIFO-ç®¡ç†" class="headerlink" title="3.3. 3. ç¯å½¢ FIFO ç®¡ç†"></a>3.3. 3. ç¯å½¢ FIFO ç®¡ç†</h5><p>åœ¨ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œä¸çŸ¥å¤§å®¶æœ‰æ— æ„è¯†åˆ°ï¼šæ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ€éš¾çš„æ˜¯å¦‚ä½•åè°ƒç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´çš„æ­¥è°ƒã€‚ä¸Šæ–‡æ‰€è¯´çš„ FIFO æ˜¯ç¯å½¢ FIFOï¼ŒAudioTrack å†™æŒ‡é’ˆã€AudioFlinger è¯»æŒ‡é’ˆéƒ½æ˜¯åŸºäº FIFO å½“å‰çš„è¯»å†™ä½ç½®æ¥è®¡ç®—çš„ã€‚</p><p>â˜¯AudioTrack ä¸ AudioFlinger ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸Šï¼Œæ€ä¹ˆä¿è¯è¯»å†™æŒ‡é’ˆçš„çº¿ç¨‹å®‰å…¨<br>â˜¯è¯»å†™æŒ‡é’ˆè¶Šè¿‡ FIFO åï¼Œæ€ä¹ˆå¤„ç†<br>â˜¯AudioTrack å†™æ•°æ®å®Œæˆåï¼Œéœ€è¦åŒæ­¥çŠ¶æ€ç»™ AudioFlingerï¼Œè®© AudioFlinger çŸ¥é“å½“å‰æœ‰å¯è¯»æ•°æ®äº†ï¼Œè€Œ AudioFlinger è¯»æ•°æ®å®Œæˆåï¼Œä¹Ÿéœ€è¦åŒæ­¥çŠ¶æ€ç»™ AudioTrackï¼Œè®© AudioTrack çŸ¥é“å½“å‰æœ‰å¯ç”¨ç©ºé—´äº†ï¼›è¿™é‡Œé‡‡å–ä»€ä¹ˆåŒæ­¥æœºåˆ¶<br>æˆ‘ä»¬å›é¡¾ä¸‹åˆ›å»º AudioTrack å¯¹è±¡æ—¶ï¼ŒFIFO åŠå…¶æ§åˆ¶å—çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MODE_STREAM æ¨¡å¼ä¸‹çš„åŒ¿åå…±äº«å†…å­˜ç»“æ„ï¼š</span><br><span class="line">  |                                                         |</span><br><span class="line">  | -------------------&gt; mCblkMemory &lt;--------------------- |</span><br><span class="line">  |                                                         |</span><br><span class="line">  +--------------------+------------------------------------+</span><br><span class="line">  | audio_track_cblk_t |               FIFO                 |</span><br><span class="line">  +--------------------+------------------------------------+</span><br><span class="line">  ^                    ^</span><br><span class="line">  |                    |</span><br><span class="line">mCblk               mBuffer</span><br><span class="line"></span><br><span class="line">mCblk = static_cast&lt;audio_track_cblk_t *&gt;(mCblkMemory-&gt;pointer());</span><br><span class="line">new(mCblk) audio_track_cblk_t();</span><br><span class="line">mBuffer = (char*)mCblk + sizeof(audio_track_cblk_t);</span><br></pre></td></tr></table></figure><p>â˜¯MODE_STATIC æ¨¡å¼ä¸‹çš„åŒ¿åå…±äº«å†…å­˜ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  +--------------------+    +-----------------------------------+</span><br><span class="line">  | audio_track_cblk_t |    |         FIFO (sharedBuffer)       |</span><br><span class="line">  +--------------------+    +-----------------------------------+</span><br><span class="line">  ^                         ^</span><br><span class="line">  |                         |</span><br><span class="line">mCblk                    mBuffer</span><br><span class="line"></span><br><span class="line">mCblk = (audio_track_cblk_t *) new uint8_t[size];</span><br><span class="line">new(mCblk) audio_track_cblk_t();</span><br><span class="line">mBuffer = sharedBuffer-&gt;pointer()</span><br></pre></td></tr></table></figure><p>FIFO ç®¡ç†ç›¸å…³çš„ç±»å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/315-Audio-system-FIFO.jpg" alt="Alt text"></p><p>â˜¯AudioTrackClientProxyï¼šMODE_STREAM æ¨¡å¼ä¸‹ï¼Œç”Ÿäº§è€… AudioTrack ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯ç”¨ç©ºé—´çš„ä½ç½®<br>â˜¯AudioTrackServerProxyï¼šMODE_STREAM æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€… AudioFlinger::PlaybackThread ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯è¯»æ•°æ®çš„ä½ç½®<br>â˜¯StaticAudioTrackClientProxyï¼šMODE_STATIC æ¨¡å¼ä¸‹ï¼Œç”Ÿäº§è€… AudioTrack ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯ç”¨ç©ºé—´çš„ä½ç½®<br>â˜¯StaticAudioTrackServerProxyï¼šMODE_STATIC æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€… AudioFlinger::PlaybackThread ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯è¯»æ•°æ®çš„ä½ç½®<br>â˜¯AudioRecordClientProxyï¼šæ¶ˆè´¹è€… AudioRecord ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯è¯»æ•°æ®çš„ä½ç½®<br>â˜¯AudioTrackServerProxyï¼šç”Ÿäº§è€… AudioFlinger::RecordThread ä½¿ç”¨å®ƒåœ¨ FIFO ä¸­æ‰¾åˆ°å¯ç”¨ç©ºé—´çš„ä½ç½®<br>åˆ°è¿™é‡Œï¼Œæˆ‘å†³å®šç»“æŸæœ¬æ–‡äº†ã€‚ç¯å½¢ FIFO ç®¡ç†æ˜¯ Android éŸ³é¢‘ç³»ç»Ÿçš„ç²¾é«“ï¼Œä¸€ä¸ªå°èŠ‚å¹¶ä¸è¶³ä»¥æè¿°å…¶åŸç†åŠå®ç°ç»†èŠ‚ï¼›Android ç¯å½¢ FIFO çš„å®ç°å¯è¯´å¾—ä¸Šç²¾å¦™ç»ä¼¦ï¼Œå…¶ä»–é¡¹ç›®å¦‚æœè¦ç”¨åˆ°ç¯å½¢ FIFOï¼Œä¸å¦¨å¤šå€Ÿé‰´å®ƒã€‚</p><h4 id="å››-ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹"><a href="#å››-ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹" class="headerlink" title="(å››)ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹"></a>(å››)ã€æ·±å…¥å‰–æMediaPlayeræ’­æ”¾éŸ³é¢‘æµç¨‹</h4><p>æ—¶åºå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/audio.system/316-Audio-system-mediaplayer-playback.png" alt="Alt text"></p><h4 id="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://zhuanlan.zhihu.com/p/27480328" target="_blank" rel="noopener">AndroidéŸ³é¢‘æ¨¡å—å¯åŠ¨æµç¨‹åˆ†æ</a><br><a href="https://zhuanlan.zhihu.com/jhuster" target="_blank" rel="noopener">Jhusterçš„ä¸“æ â€‹ AndroidéŸ³é¢‘å¼€å‘</a><br><a href="http://thinks.me/2016/09/13/audio_qcom_offload/" target="_blank" rel="noopener">é«˜é€šaudio offloadå­¦ä¹  | Thinking</a><br><a href="https://blog.csdn.net/droidphone/article/category/1118446" target="_blank" rel="noopener">DroidPhoneçš„ä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8866071" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„1-CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8982771" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„2-ASoc - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8995163" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„3-Pcm - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/orz415678659/article/details/8999364" target="_blank" rel="noopener">alsaéŸ³é¢‘æ¶æ„4-å£°å¡æ§åˆ¶ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59180272" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šé€»è¾‘è®¾å¤‡ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/59170418" target="_blank" rel="noopener">Linux ALSA éŸ³é¢‘ç³»ç»Ÿï¼šç‰©ç†é“¾è·¯ç¯‡ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/column/details/12812.html" target="_blank" rel="noopener">ä¸“æ ï¼šMultiMediaæ¡†æ¶æ€»ç»“(åŸºäº6.0æºç ) - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/zyuanyun/article/details/60890534" target="_blank" rel="noopener">Android éŸ³é¢‘ç³»ç»Ÿï¼šä» AudioTrack åˆ° AudioFlinger - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/azloong/article/category/778492" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ALSA-Android Audio</a><br><a href="https://blog.csdn.net/azloong/article/category/777239" target="_blank" rel="noopener">AZURE - CSDNåšå®¢ - ANDROIDéŸ³é¢‘ç³»ç»Ÿ</a><br><a href="https://winddoing.github.io/2017/07/10/audio_alsa/" target="_blank" rel="noopener">Audioé©±åŠ¨æ€»ç»“â€“ALSA | Winddoingâ€™s Blog</a><br><a href="http://www.cnblogs.com/muhe221/articles/4461543.html" target="_blank" rel="noopener">audio HAL - ç‰§ å¤© - åšå®¢å›­</a><br><a href="https://blog.csdn.net/xuesen_lin/article/category/1390680" target="_blank" rel="noopener">æ—å­¦æ£®çš„Androidä¸“æ  - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/yangwen123/article/category/2589087" target="_blank" rel="noopener">æ·±å…¥å‰–æAndroidéŸ³é¢‘ - CSDNåšå®¢Yangwen123</a><br><a href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener">æ’­æ”¾æ¡†æ¶ - æ ‡ç­¾ - Tocy - åšå®¢å›­</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/57415505" target="_blank" rel="noopener">Android-7.0-Nuplayeræ¦‚è¿° - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/miaomiao12345678/article/details/56961370" target="_blank" rel="noopener">Android-7.0-Nuplayer-å¯åŠ¨æµç¨‹ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53386010" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-Nuplayerï¼ˆ1ï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/harman_zjc/article/details/53397945" target="_blank" rel="noopener">Android Media Player æ¡†æ¶åˆ†æ-AHandler AMessage ALooper - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/category/6344583" target="_blank" rel="noopener">Android N Audioæ’­æ”¾ startçœŸé¢ç›®- (å…­ç¯‡) CSDNåšå®¢</a><br><a href="https://blog.csdn.net/nonmarking/article/details/78746671" target="_blank" rel="noopener">æ·±å…¥ç†è§£AndroidéŸ³è§†é¢‘åŒæ­¥æœºåˆ¶ï¼ˆäº”ç¯‡ï¼‰NuPlayerçš„avsyncé€»è¾‘ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/u014310046/article/category/6571854" target="_blank" rel="noopener">wangyfçš„ä¸“æ  - CSDNåšå®¢-MT6737 Android N å¹³å° Audioç³»ç»Ÿå­¦ä¹ </a><br><a href="https://blog.csdn.net/xiashaohua/article/details/53638780" target="_blank" rel="noopener">Android 7.0 Audio: Mediaplayer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/xiashaohua/article/category/6549668" target="_blank" rel="noopener">Android 7.0 Audio-ç›¸å…³ç±»æµ…æ- CSDNåšå®¢</a><br><a href="https://blog.csdn.net/liu1314you/article/details/59119144" target="_blank" rel="noopener">Android N Audioæ’­æ”¾å…­ï¼šå¦‚ä½•è¯»å–buffer - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/jinzhuojun/article/details/78007568" target="_blank" rel="noopener">Fuchsia OSä¸­çš„RPCæœºåˆ¶-FIDL - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/linhaostudy/category/1145404.html" target="_blank" rel="noopener">é«˜é€šAudioä¸­ASOCçš„codecé©±åŠ¨ - yooooooo - åšå®¢å›­</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/05/25/Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ/">http://zhoujinjian.cc/2018/05/25/Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/05/15/Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ/" title="Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ"><i class="iconfont icon-prev"></i>Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2018/06/01/Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ/" title="Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ">Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">17</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/07/10/Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ/" title="Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.19.jpg" alt="Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ</h3><span class="item__text">2018-07-10</span></div></a></li><li class="latest-post-item"><a href="/2018/06/30/Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ/" title="Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.18.jpg" alt="Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera System(Camera ç³»ç»Ÿ)æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ</h3><span class="item__text">2018-06-30</span></div></a></li><li class="latest-post-item"><a href="/2018/06/06/Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ/" title="Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.17.jpg" alt="Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ2ï¼‰ï¼šéŸ³è§†é¢‘åˆ†ç¦»MediaExtractorã€è§£ç Decoderã€æ¸²æŸ“Rendereræºç åˆ†æ</h3><span class="item__text">2018-06-06</span></div></a></li><li class="latest-post-item"><a href="/2018/06/01/Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ/" title="Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.16.jpg" alt="Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ1ï¼‰ï¼šVideo System(è§†é¢‘ç³»ç»Ÿ)æ¡†æ¶åˆ†æ</h3><span class="item__text">2018-06-01</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">282.7k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>