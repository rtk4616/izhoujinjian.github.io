<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~] | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-çª—å£ç®¡ç†æœåŠ¡åˆ†æ-i-wonder/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.08.jpg" alt="Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]"></div><header class="post__info"><h1 class="post__title">Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="http://zhoujinjian.cc/">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘.</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-03-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"><span class="toc-text">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"><span class="toc-text">æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1"><span class="toc-text">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€Window-ç»„ç»‡æ–¹å¼"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€Window ç»„ç»‡æ–¹å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1ã€Android-Tokenä»‹ç»"><span class="toc-text">1.1ã€Android Tokenä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1ã€Tokenå¯¹è±¡çš„åˆ›å»º"><span class="toc-text">1.1.1ã€Tokenå¯¹è±¡çš„åˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2ã€AMSè°ƒç”¨WMSçš„addAPPToken-æ¥å£"><span class="toc-text">1.1.2ã€AMSè°ƒç”¨WMSçš„addAPPToken()æ¥å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity-å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹"><span class="toc-text">1.1.3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity()å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹"><span class="toc-text">1.1.4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2ã€WMSç»„ç»‡æ–¹å¼"><span class="toc-text">1.2ã€WMSç»„ç»‡æ–¹å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3ã€WMSçª—å£ç±»å‹"><span class="toc-text">1.3ã€WMSçª—å£ç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1ã€åº”ç”¨çª—å£"><span class="toc-text">1.3.1ã€åº”ç”¨çª—å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2ã€å­çª—å£"><span class="toc-text">1.3.2ã€å­çª—å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3ã€ç³»ç»Ÿçª—å£"><span class="toc-text">1.3.3ã€ç³»ç»Ÿçª—å£</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€Window-Sizeï¼ˆå¤§å°ï¼‰å’Œ-Window-Positionï¼ˆä½ç½®ï¼‰-è®¡ç®—è¿‡ç¨‹"><span class="toc-text">ï¼ˆäºŒï¼‰ã€Window Sizeï¼ˆå¤§å°ï¼‰å’Œ Window Positionï¼ˆä½ç½®ï¼‰ è®¡ç®—è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1ã€-Android-å±å¹•åŒºåŸŸä»‹ç»"><span class="toc-text">2.1ã€ Android å±å¹•åŒºåŸŸä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2ã€-Window-å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹"><span class="toc-text">2.2ã€ Window å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1ã€ViewRootImpl-performTraversals"><span class="toc-text">2.2.1ã€ViewRootImpl.performTraversals()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2ã€ViewRootImpl-relayoutWindow"><span class="toc-text">2.2.2ã€ViewRootImpl.relayoutWindow()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3ã€Session-relayout"><span class="toc-text">2.2.3ã€Session.relayout()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4ã€WindowManagerService-relayoutWindow"><span class="toc-text">2.2.4ã€WindowManagerService.relayoutWindow()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5ã€WindowSurfacePlacer-performSurfacePlacement"><span class="toc-text">2.2.5ã€WindowSurfacePlacer.performSurfacePlacement()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-6-WindowSurfacePlacer-performSurfacePlacementLoop"><span class="toc-text">2.2.6.WindowSurfacePlacer.performSurfacePlacementLoop()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-7ã€WindowSurfacePlacer-performSurfacePlacementInner"><span class="toc-text">2.2.7ã€WindowSurfacePlacer.performSurfacePlacementInner()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-8ã€WindowSurfacePlacer-applySurfaceChangesTransaction"><span class="toc-text">2.2.8ã€WindowSurfacePlacer.applySurfaceChangesTransaction()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-9ã€WindowSurfacePlacer-applySurfaceChangesTransaction"><span class="toc-text">2.2.9ã€WindowSurfacePlacer.applySurfaceChangesTransaction()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-10ã€PhoneWindowManager-beginLayoutLw"><span class="toc-text">2.2.10ã€PhoneWindowManager.beginLayoutLw()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-11ã€PhoneWindowManager-layoutWindowLw"><span class="toc-text">2.2.11ã€PhoneWindowManager.layoutWindowLw()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-12ã€WindowState-computeFrameLw"><span class="toc-text">2.2.12ã€WindowState.computeFrameLw()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-13ã€PhoneWindowManager-finishLayoutLw"><span class="toc-text">2.2.13ã€PhoneWindowManager.finishLayoutLw()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€Window-Z-Order-è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€Window Z-Order è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯"><span class="toc-text">3.1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®"><span class="toc-text">3.2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1ã€WindowLayersController-assignLayersLocked"><span class="toc-text">3.2.1ã€WindowLayersController.assignLayersLocked()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»"><span class="toc-text">3.3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹"><span class="toc-text">3.3.1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2ã€å‡†å¤‡åˆ·æ–°UI"><span class="toc-text">3.3.2ã€å‡†å¤‡åˆ·æ–°UI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI"><span class="toc-text">3.3.3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£-Starting-Window-æ·»åŠ è¿‡ç¨‹"><span class="toc-text">ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£(Starting Window)æ·»åŠ è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£-Starting-Window-çš„æ·»åŠ è¿‡ç¨‹"><span class="toc-text">4.1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£(Starting Window)çš„æ·»åŠ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1ã€-ActivityStack-startActivityLocked"><span class="toc-text">4.1.1ã€ ActivityStack.startActivityLocked()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2ã€-ActivityRecord-showStartingWindow"><span class="toc-text">4.1.2ã€ ActivityRecord.showStartingWindow()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2ã€ActivityRecord-setAppStartingWindow"><span class="toc-text">4.1.2ã€ActivityRecord.setAppStartingWindow()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3ã€-H-handleMessage"><span class="toc-text">4.1.3ã€ H.handleMessage()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4ã€PhoneWindowManager-addStartingWindow"><span class="toc-text">4.1.4ã€PhoneWindowManager.addStartingWindow()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp-Transitionï¼‰è¿‡ç¨‹"><span class="toc-text">ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp Transitionï¼‰è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1ã€prepareAppTransition-è¿‡ç¨‹"><span class="toc-text">5.1ã€prepareAppTransition()è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1ã€ActivityStack-startActivityLocked"><span class="toc-text">5.1.1ã€ActivityStack.startActivityLocked()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2ã€WindowManagerService-prepareAppTransition"><span class="toc-text">5.1.2ã€WindowManagerService.prepareAppTransition()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3ã€AppTransition-prepareAppTransitionLocked"><span class="toc-text">5.1.3ã€AppTransition.prepareAppTransitionLocked()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2ã€AppTransition-animationè®¾ç½®è¿‡ç¨‹"><span class="toc-text">5.2ã€AppTransition animationè®¾ç½®è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3ã€executeAppTransitionè¿‡ç¨‹"><span class="toc-text">5.3ã€executeAppTransitionè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-WindowManagerService-executeAppTransition"><span class="toc-text">5.3.1.WindowManagerService.executeAppTransition()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆå…­ï¼‰ã€Activity-Window-åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹"><span class="toc-text">ï¼ˆå…­ï¼‰ã€Activity Window åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"><span class="toc-text">6.1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"><span class="toc-text">6.1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1ã€WindowManagerService-setTokenVisibilityLocked"><span class="toc-text">6.1.1ã€WindowManagerService.setTokenVisibilityLocked()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-WindowStateAnimator-applyAnimationLocked"><span class="toc-text">6.1.1.WindowStateAnimator.applyAnimationLocked()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶"><span class="toc-text">6.2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»"><span class="toc-text">6.3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹"><span class="toc-text">6.4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1ã€WindowAnimator-updateWindowsLocked"><span class="toc-text">6.4.1ã€WindowAnimator.updateWindowsLocked()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div><p>çª—å£ç®¡ç†ç³»ç»ŸWMSæ˜¯Androidä¸­çš„ä¸»è¦å­ç³»ç»Ÿä¹‹ä¸€ï¼Œå®ƒæ¶‰åŠåˆ°Appä¸­ç»„ä»¶çš„ç®¡ç†ï¼Œç³»ç»Ÿå’Œåº”ç”¨çª—å£çš„ç®¡ç†å’Œç»˜åˆ¶ç­‰å·¥ä½œã€‚ç”±äºå…¶æ¶‰åŠæ¨¡å—ä¼—å¤šï¼Œä¸”ä¸ç”¨æˆ·ä½“éªŒå¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯Androidå½“ä¸­æœ€ä¸ºå¤æ‚çš„å­ç³»ç»Ÿä¹‹ä¸€ã€‚ä¸€ä¸ªAppä»å¯åŠ¨åˆ°ä¸»çª—å£æ˜¾ç¤ºå‡ºæ¥ï¼Œéœ€è¦Appï¼ŒActivityManagerServiceï¼ˆAMSï¼‰ï¼ŒWindowManagerServiceï¼ˆWMSï¼‰ï¼ŒSurfaceFlingerï¼ˆSFï¼‰ç­‰å‡ ä¸ªæ¨¡å—ç›¸äº’åˆä½œã€‚Appè´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œç»˜åˆ¶è‡ªå·±çš„è§†å›¾ï¼›AMSç®¡ç†ç»„ä»¶ã€è¿›ç¨‹ä¿¡æ¯å’ŒActivityçš„å †æ ˆåŠçŠ¶æ€ç­‰ç­‰ï¼›WMSç®¡ç†Activityå¯¹åº”çš„çª—å£åŠå­çª—å£ï¼Œè¿˜æœ‰ç³»ç»Ÿçª—å£ç­‰ï¼›SFç”¨äºç®¡ç†å›¾å½¢ç¼“å†²åŒºï¼Œå°†Appç»˜åˆ¶çš„ä¸œè¥¿åˆæˆæ¸²æŸ“åœ¨å±å¹•ä¸Šã€‚</p><a id="more"></a><h2 id="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"><a href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘" class="headerlink" title="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.wms" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></h2><h2 id="æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"><a href="#æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š" class="headerlink" title="æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"></a>æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</h2><p><strong>/frameworks/base/services/core/java/com/android/server/am/</strong></p><ul><li>ActivityStack.java</li><li>ActivityManagerService.java</li><li>ActivityStackSupervisor.java</li><li>ActivityStarter.java</li><li>ActivityRecord.java</li></ul><p><strong>/frameworks/base/core/java/android/view/</strong></p><ul><li>WindowManagerImpl.java</li><li>ViewManager.java</li><li>WindowManagerGlobal.java</li><li>ViewRootImpl.java</li><li>Choreographer.java</li><li>IWindowSession.aidl</li><li>DisplayEventReceiver.java</li><li>SurfaceControl.java</li><li>Surface.java</li><li>SurfaceSession.java</li></ul><p><strong>/frameworks/base/services/core/java/com/android/server/wm/</strong></p><ul><li>WindowManagerService.java</li><li>AppWindowAnimator.java</li><li>AppTransition.java</li><li>AppWindowToken.java</li><li>Session.java</li><li>WindowState.java</li><li>WindowAnimator.java</li><li>WindowStateAnimator.java</li><li>WindowSurfacePlacer.java</li><li>WindowSurfaceController.java</li></ul><h2 id="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1"><a href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1" class="headerlink" title="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.wms" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></h2><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹çª—å£å¯åŠ¨ã€é€€å‡ºè¿‡ç¨‹åŠ¨æ€å›¾ï¼Œä¹‹åå†è¯¦ç»†åˆ†æï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/01-Android-WMS-ezgif.com-gif-maker-WindowManagerService-resize.gif" alt="Markdown"></p><h2 id="ï¼ˆä¸€ï¼‰ã€Window-ç»„ç»‡æ–¹å¼"><a href="#ï¼ˆä¸€ï¼‰ã€Window-ç»„ç»‡æ–¹å¼" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Window ç»„ç»‡æ–¹å¼"></a>ï¼ˆä¸€ï¼‰ã€Window ç»„ç»‡æ–¹å¼</h2><p>ActivityManagerServiceï¼ˆAMSï¼‰ï¼ŒWindowManagerServiceï¼ˆWMSï¼‰ï¼ŒSurfaceFlingerï¼ˆSFï¼‰ç­‰å‡ ä¸ªæ¨¡å—ç›¸äº’åˆä½œã€‚Appè´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œç»˜åˆ¶è‡ªå·±çš„è§†å›¾ï¼›AMSç®¡ç†ç»„ä»¶ã€è¿›ç¨‹ä¿¡æ¯å’ŒActivityçš„å †æ ˆåŠçŠ¶æ€ç­‰ç­‰ï¼›WMSç®¡ç†Activityå¯¹åº”çš„çª—å£åŠå­çª—å£ï¼Œè¿˜æœ‰ç³»ç»Ÿçª—å£ç­‰ï¼›SFç”¨äºç®¡ç†å›¾å½¢ç¼“å†²åŒºï¼Œå°†Appç»˜åˆ¶çš„ä¸œè¥¿åˆæˆæ¸²æŸ“åœ¨å±å¹•ä¸Šã€‚ çª—å£ç®¡ç†ç³»ç»Ÿä¸»è¦æ¡†æ¶ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/02-Android-WMS-AMS-SurfaceFlinger-Conn.png" alt="Markdown"></p><blockquote><p>ä¸»è¦å¯¹è±¡åŠŸèƒ½ä»‹ç»ï¼š</p><p>WindowManagerServiceè´Ÿè´£å®Œæˆçª—å£çš„ç®¡ç†å·¥ä½œ</p><p>WindowStateå’Œåº”ç”¨ç«¯çª—å£ä¸€ä¸€å¯¹åº”ï¼Œåº”ç”¨è°ƒç”¨WMSæ·»åŠ çª—å£æ—¶ï¼Œæœ€ç»ˆä¼šåœ¨WindowManagerService.addWindow()åˆ›å»ºä¸€ä¸ªWindowStateä¸ä¹‹ä¸€ä¸€å¯¹åº”</p><p>WindowTokenæ˜¯ä¸€ä¸ªå¥æŸ„ï¼Œä¿å­˜äº†æ‰€æœ‰å…·æœ‰åŒä¸€ä¸ªtokençš„WindowStateã€‚åº”ç”¨è¯·æ±‚WindowManagerServiceæ·»åŠ çª—å£çš„æ—¶å€™ï¼Œæä¾›äº†ä¸€ä¸ªtokenï¼Œè¯¥tokenæ ‡è¯†äº†è¢«æ·»åŠ çª—å£çš„å½’å±ï¼ŒWindowManagerServiceä¸ºè¯¥tokenç”Ÿæˆä¸€ä¸ªWindowTokenå¯¹è±¡ï¼Œæ‰€æœ‰tokenç›¸åŒçš„WindowStateè¢«å…³è”åˆ°åŒä¸€ä¸ªWindowTokenï¼Œå¦‚è¾“å…¥æ³•æ·»åŠ çª—å£æ—¶ï¼Œä¼šä¼ é€’ä¸€ä¸ªIBinder mCurTokenï¼Œå¢™çº¸æœåŠ¡æ·»åŠ çª—å£æ—¶ï¼Œä¼šä¼ é€’ä¸€ä¸ªWallpaperConnection::final Binder mTokenã€‚</p><p>AppWindowTokenç»§æ‰¿äºWindowTokenï¼Œä¸“é—¨ç”¨äºæ ‡è¯†ä¸€ä¸ªActivityã€‚AppWindowTokené‡Œçš„tokenå®é™…ä¸Šå°±æ˜¯æŒ‡å‘äº†ä¸€ä¸ªActivityã€‚ActivityManagerServiceé€šçŸ¥åº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œåœ¨æœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªtokenç”¨äºæ ‡è¯†è¯¥Activityï¼Œå¹¶ä¸”æŠŠè¯¥tokenä¼ é€’åˆ°åº”ç”¨å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯çš„Activityåœ¨ç”³è¯·æ·»åŠ çª—å£æ—¶ï¼Œä»¥è¯¥tokenä½œä¸ºæ ‡è¯†ä¼ é€’åˆ°WindowManagerServiceã€‚åŒä¸€ä¸ªActivityä¸­çš„ä¸»çª—å£ã€å¯¹è¯æ¡†çª—å£ã€èœå•çª—å£éƒ½å…³è”åˆ°åŒä¸€ä¸ªAppWindowTokenã€‚</p><p>Sessionè¡¨ç¤ºä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„äº¤äº’ä¼šè¯ã€‚ä¸€èˆ¬æ¥è¯´ä¸åŒçš„åº”ç”¨é€šè¿‡ä¸åŒçš„ä¼šè¯æ¥å’ŒWindowManagerServiceäº¤äº’ï¼Œä½†æ˜¯å¤„äºåŒä¸€ä¸ªè¿›ç¨‹çš„ä¸åŒåº”ç”¨é€šè¿‡åŒä¸€ä¸ªSessionæ¥äº¤äº’ã€‚</p></blockquote><h3 id="1-1ã€Android-Tokenä»‹ç»"><a href="#1-1ã€Android-Tokenä»‹ç»" class="headerlink" title="1.1ã€Android Tokenä»‹ç»"></a>1.1ã€Android Tokenä»‹ç»</h3><p>Tokenæ˜¯ActivityRecordçš„å†…éƒ¨é™æ€ç±»ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹Tokençš„ç»§æ‰¿å…³ç³»ï¼ŒToken extends IApplicationToken.Stubï¼Œä»IApplicationToken.Stubç±»è¿›è¡Œç»§æ‰¿ï¼Œæ ¹æ®Binderçš„æœºåˆ¶å¯ä»¥çŸ¥é“Tokenæ˜¯ä¸€ä¸ªåŒ¿åBinderå®ä½“ç±»ï¼Œè¿™ä¸ªåŒ¿åBinderå®ä½“ä¼šä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹ä¼šæ‹¿åˆ°Tokençš„ä»£ç†ç«¯ã€‚ æˆ‘ä»¬çŸ¥é“åŒ¿åBinderæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ç”¨é€”ï¼Œä¸€ä¸ªæ˜¯æ‹¿åˆ°Binderä»£ç†ç«¯åå¯è·¨Binderè°ƒç”¨å®ä½“ç«¯çš„å‡½æ•°æ¥å£ï¼Œå¦ä¸€ä¸ªä½œç”¨ä¾¿æ˜¯åœ¨å¤šä¸ªè¿›ç¨‹ä¸­æ ‡è¯†åŒä¸€ä¸ªå¯¹è±¡ã€‚å¾€å¾€è¿™ä¸¤ä¸ªä½œç”¨æ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œç ”ç©¶çš„Tokenå°±åŒæ—¶å­˜åœ¨è¿™ä¸¤ä¸ªä½œç”¨ï¼Œä½†æœ€é‡è¦çš„ä¾¿æ˜¯åè€…ï¼ŒTokenæ ‡è¯†äº†ä¸€ä¸ªActivityRecordå¯¹è±¡ï¼Œå³é—´æ¥æ ‡è¯†äº†ä¸€ä¸ªActivityã€‚</p><p>Tokenæ¢³ç†ï¼š åˆ†ææºç ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå¤§å¤šæ•° token çš„å¯¹è±¡ï¼Œéƒ½è¡¨ç¤ºä¸€ä¸ª IBinder å¯¹è±¡ã€‚æåˆ° IBinderï¼Œå¤§å®¶ä¸€ç‚¹ä¹Ÿä¸é™Œç”Ÿï¼Œå°±æ˜¯ Android çš„ IPC é€šä¿¡æœºåˆ¶ã€‚åœ¨åˆ›å»ºçª—å£è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°çš„ IPC é€šä¿¡ï¼Œæ— éåŒ…å«ä¸¤æ–¹é¢ï¼Œä¸€ä¸ªæ˜¯ WmS ç”¨æ¥è·Ÿåº”ç”¨æ‰€åœ¨çš„è¿›ç¨‹è¿›è¡Œé€šä¿¡çš„ ViewRootImpl.W ç±»çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªæ˜¯æŒ‡å‘ä¸€ä¸ª ActivityRecord çš„å¯¹è±¡ï¼Œè‡ªç„¶åº”è¯¥æ˜¯WMSç”¨æ¥è·Ÿ AMSè¿›è¡Œé€šä¿¡çš„äº†ã€‚æˆ‘ä»¬æ¢³ç†äº†ä¸€ä¸‹ï¼Œtoken ä»¥ä¸‹å‡ å¤„çš„å®šä¹‰ï¼Œåˆ†åˆ«æ¥è®²è®²è¿™é‡Œçš„ token ä»£è¡¨ä»€ä¹ˆã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/03-Android-WMS-Token-Detail.png" alt="Markdown"></p><p>åˆ†æä¸€ä¸‹ View çš„ AttachInfo çš„èµ‹å€¼ã€‚ViewRootImpl åœ¨æ„å»ºæ–¹æ³•é‡Œï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ª AttachInfo å®ä¾‹ï¼ŒæŠŠå®ƒçš„ Sessionï¼Œä»¥åŠ Wç±»å¯¹è±¡èµ‹å€¼ç»™ AttachInfoã€‚åˆ†æå¯ä»¥çœ‹åˆ°ï¼ŒAttachInfo ä¸­çš„ mWindowTokenï¼Œä¸mWindow éƒ½æ˜¯æŒ‡å‘ ViewRootImpl ä¸­çš„ mWindow(Wç±»å®ä¾‹)ã€‚å½“ä¸€ä¸ª View attach åˆ°çª—å£åï¼ŒViewRootImplä¼šæ‰§è¡ŒperformTraversalsï¼Œå¦‚æœå‘ç°æ˜¯é¦–æ¬¡è°ƒç”¨ä¼šï¼Œä¼šæŠŠè‡ªå·±çš„ mAttachInfo ä¼ é€’ç»™æ ¹ Viewï¼ˆé€šè¿‡dispatchAttachedToWindowï¼‰ï¼Œå‘Šè¯‰ View æ ‘ç°åœ¨å·²ç» attch to Window äº†ï¼Œé©¬ä¸Šå¯ä»¥æ˜¾ç¤ºäº†ã€‚æ ¹ Viewï¼ˆä¸€èˆ¬æ˜¯ ViewGroupï¼‰ä¼šæŠŠè¿™ä¸ªä¿¡æ¯ï¼Œéå†åœ°ä¼ é€’ç»™ View æ ‘ä¸­çš„æ¯ä¸€ä¸ªå­ Viewï¼Œè¿™æ ·æ¯ä¸ª View çš„ mAttachInfo éƒ½è¢«èµ‹å€¼ä¸º ViewRootImp çš„ mAttachInfoäº†ã€‚</p><h3 id="1-1-1ã€Tokenå¯¹è±¡çš„åˆ›å»º"><a href="#1-1-1ã€Tokenå¯¹è±¡çš„åˆ›å»º" class="headerlink" title="1.1.1ã€Tokenå¯¹è±¡çš„åˆ›å»º"></a>1.1.1ã€Tokenå¯¹è±¡çš„åˆ›å»º</h3><p>ä¸‹é¢è¿™ä¸ªå›¾æ˜¯Tokençš„ä¼ é€’ï¼Œé¦–å…ˆä¼šä¼ é€’åˆ°WMSä¸­ï¼Œæ¥ç€ä¼šä¼ é€’åˆ°åº”ç”¨è¿›ç¨‹ActivityThreadä¸­ï¼Œä¸‹é¢æ¥å…·ä½“åˆ†æè¿™ä¸ªä¼ é€’æµç¨‹ã€‚ æ€»ä½“æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/04-Android-WMS-Token.png" alt="Markdown"></p><p>æˆ‘ä»¬ä¹‹å‰åˆ†æï¼šã€Android 7.1.2 (Android N) Activityå¯åŠ¨æµç¨‹åˆ†æã€‘ åœ¨å¯åŠ¨Activityè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ActivityStarter.startActivityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params">        TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ActivityRecord sourceRecord = <span class="keyword">null</span>;</span><br><span class="line">    ActivityRecord resultRecord = <span class="keyword">null</span>;</span><br><span class="line">    ......</span><br><span class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">            intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">            requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, mSupervisor, container,</span><br><span class="line">            options, sourceRecord);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        err = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                <span class="keyword">true</span>, options, inTask);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨startActivityLocked()ä¸­åˆ›å»ºäº†ä¸€ä¸ªActivityRecordå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityRecord.java]</span><br><span class="line"><span class="keyword">final</span> IApplicationToken.Stub appToken; <span class="comment">// window manager token</span></span><br><span class="line"></span><br><span class="line">ActivityRecord(ActivityManagerService _service, ProcessRecord _caller,</span><br><span class="line">        <span class="keyword">int</span> _launchedFromUid, String _launchedFromPackage, Intent _intent, String _resolvedType,</span><br><span class="line">        ActivityInfo aInfo, Configuration _configuration,</span><br><span class="line">        ActivityRecord _resultTo, String _resultWho, <span class="keyword">int</span> _reqCode,</span><br><span class="line">        <span class="keyword">boolean</span> _componentSpecified, <span class="keyword">boolean</span> _rootVoiceInteraction,</span><br><span class="line">        ActivityStackSupervisor supervisor,</span><br><span class="line">        ActivityContainer container, ActivityOptions options, ActivityRecord sourceRecord) &#123;</span><br><span class="line">    service = _service;</span><br><span class="line">    appToken = <span class="keyword">new</span> Token(<span class="keyword">this</span>, service);</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨ActivityRecordçš„æ„é€ å‡½æ•°ä¸­åˆ›å»ºï¼Œæ ‡è¯†ç€å½“å‰è¿™ä¸ªActivityRecordï¼Œå³é—´æ¥ä»£è¡¨ç€ä¸€ä¸ªActivityã€‚</p><h3 id="1-1-2ã€AMSè°ƒç”¨WMSçš„addAPPToken-æ¥å£"><a href="#1-1-2ã€AMSè°ƒç”¨WMSçš„addAPPToken-æ¥å£" class="headerlink" title="1.1.2ã€AMSè°ƒç”¨WMSçš„addAPPToken()æ¥å£"></a>1.1.2ã€AMSè°ƒç”¨WMSçš„addAPPToken()æ¥å£</h3><p>åœ¨å¯åŠ¨ä¸€ä¸ªActivityæ—¶ï¼Œä¼šè°ƒç”¨startActivityLocked()æ¥åœ¨WMSä¸­æ·»åŠ ä¸€ä¸ªAppWindowTokenå¯¹è±¡ startActivityLocked()åˆ›å»ºActivityRecordå¯¹è±¡åä¼šç»§ç»­è°ƒç”¨startActivityUnchecked()æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mTargetStack.startActivityLocked(mStartActivity, newTask, mKeepCurTransition, mOptions);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStack.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> keepCurTransition,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityOptions options)</span> </span>&#123;</span><br><span class="line">            ......</span><br><span class="line">            addConfigOverride(r, task);</span><br><span class="line">            ......</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addConfigOverride</span><span class="params">(ActivityRecord r, TaskRecord task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Rect bounds = task.updateOverrideConfigurationFromLaunchBounds();</span><br><span class="line">        <span class="comment">// è·³è½¬åˆ°WMS</span></span><br><span class="line">        mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</span><br><span class="line">                r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</span><br><span class="line">                (r.info.flags &amp; FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId, r.info.configChanges,</span><br><span class="line">                task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind, bounds, task.mOverrideConfig,</span><br><span class="line">                task.mResizeMode, r.isAlwaysFocusable(), task.isHomeTask(),</span><br><span class="line">                r.appInfo.targetSdkVersion, r.mRotationAnimationHint);</span><br><span class="line">        r.taskConfigOverride = task.mOverrideConfig;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»§ç»­çœ‹ä¸‹WindowManager.addAppToken()æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAppToken</span><span class="params">(<span class="keyword">int</span> addPos, IApplicationToken token, <span class="keyword">int</span> taskId, <span class="keyword">int</span> stackId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> requestedOrientation, <span class="keyword">boolean</span> fullscreen, <span class="keyword">boolean</span> showForAllUsers, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> voiceInteraction, <span class="keyword">boolean</span> launchTaskBehind,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect taskBounds, Configuration config, <span class="keyword">int</span> taskResizeMode, <span class="keyword">boolean</span> alwaysFocusable,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> homeTask, <span class="keyword">int</span> targetSdkVersion, <span class="keyword">int</span> rotationAnimationHint)</span> </span>&#123;</span><br><span class="line">      ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            AppWindowToken atoken = findAppWindowToken(token.asBinder());</span><br><span class="line">            <span class="keyword">if</span> (atoken != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG_WM, <span class="string">"Attempted to add existing app token: "</span> + token);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ ¹æ®ActivityRecordä¸­IApplicationToken.Stubçš„ä»£ç†ï¼Œåˆ›å»ºAppWindowToken</span></span><br><span class="line">            atoken = <span class="keyword">new</span> AppWindowToken(<span class="keyword">this</span>, token, voiceInteraction);</span><br><span class="line">            atoken.inputDispatchingTimeoutNanos = inputDispatchingTimeoutNanos;</span><br><span class="line">            atoken.appFullscreen = fullscreen;</span><br><span class="line">            atoken.showForAllUsers = showForAllUsers;</span><br><span class="line">            atoken.targetSdk = targetSdkVersion;</span><br><span class="line">            atoken.requestedOrientation = requestedOrientation;</span><br><span class="line">            atoken.layoutConfigChanges = (configChanges &amp;</span><br><span class="line">                    (ActivityInfo.CONFIG_SCREEN_SIZE | ActivityInfo.CONFIG_ORIENTATION)) != <span class="number">0</span>;</span><br><span class="line">            atoken.mLaunchTaskBehind = launchTaskBehind;</span><br><span class="line">            atoken.mAlwaysFocusable = alwaysFocusable;</span><br><span class="line">            atoken.mRotationAnimationHint = rotationAnimationHint;</span><br><span class="line"></span><br><span class="line">            Task task = mTaskIdToTask.get(taskId);</span><br><span class="line">            <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</span><br><span class="line">                task = createTaskLocked(taskId, stackId, userId, atoken, taskBounds, config);</span><br><span class="line">            &#125;</span><br><span class="line">            task.addAppToken(addPos, atoken, taskResizeMode, homeTask);</span><br><span class="line">            <span class="comment">//å°†atokenæ”¾å…¥åˆ°mTokenMapä¸­ï¼Œç­‰åº”ç”¨ç¨‹åºaddWindowæ—¶ï¼Œè¿›è¡Œèº«ä»½éªŒè¯</span></span><br><span class="line">            <span class="comment">//å…¶ä¸­token.asBinder()æ˜¯IApplicationToken.Stubçš„ä»£ç†ï¼Œatokenå°±æ˜¯æ ¹æ®ä»£ç†ï¼Œå¾—åˆ°å¯¹åº”AppWindowToken</span></span><br><span class="line">            mTokenMap.put(token.asBinder(), atoken);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Application tokens start out hidden.</span></span><br><span class="line">            atoken.hidden = <span class="keyword">true</span>;</span><br><span class="line">            atoken.hiddenRequested = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="1-1-3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity-å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹"><a href="#1-1-3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity-å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹" class="headerlink" title="1.1.3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity()å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹"></a>1.1.3ã€AMSè·¨Binderè°ƒç”¨åº”ç”¨è¿›ç¨‹çš„scheduleLaunchActivity()å°†Tokenä¼ é€’ç»™ä¸Šå±‚åº”ç”¨è¿›ç¨‹</h3><p>å½“æ¡†æ¶é€šè¿‡ApplicationThreadçš„ä»£ç†å›è°ƒåˆ°ActivityThreadçš„æ—¶å€™ï¼Œå°†å¯¹åº”çš„æ­¥éª¤ä¸€ç§ç”Ÿæˆçš„tokenä»£ç†ä¼ å…¥ã€‚ ActivityStackSupervisor.realStartActivityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStackSupervisor.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">      ......</span><br><span class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡è°ƒç”¨IApplicationThreadçš„æ–¹æ³•å®ç°çš„ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯scheduleLaunchActivity()æ–¹æ³•ï¼Œæ‰€ä»¥çœŸæ­£æ‰§è¡Œçš„æ˜¯ActivityThreadä¸­çš„scheduleLaunchActivity()ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java :ApplicationThread]</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">                ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">                CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">                List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line">            <span class="comment">//ä¼ é€’ç»™äº†ActivityThreadçš„tokenï¼Œè¿™ä¸ªtokenå°±æ˜¯IApplicationToken.Stubçš„ä»£ç†</span></span><br><span class="line">            r.token = token;</span><br><span class="line">            ......</span><br><span class="line">            updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">            sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="1-1-4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹"><a href="#1-1-4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹" class="headerlink" title="1.1.4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹"></a>1.1.4ã€Activityçª—å£æ·»åŠ è¿‡ç¨‹</h3><p>è¯¦ç»†è¿‡ç¨‹è¯·æŸ¥çœ‹ï¼šã€Android 7.1.2 (Android N) Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹åˆ†æã€‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityThread.java]</span><br><span class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    ......</span><br><span class="line">    r = performResumeActivity(token, clearHide, reason);</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            <span class="comment">//è·å¾—ä¸ºå½“å‰Activityåˆ›å»ºçš„çª—å£PhoneWindowå¯¹è±¡</span></span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            <span class="comment">//è·å–ä¸ºçª—å£åˆ›å»ºçš„è§†å›¾DecorViewå¯¹è±¡</span></span><br><span class="line">            View decor = r.window.getDecorView();</span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            <span class="comment">//åœ¨attachå‡½æ•°ä¸­å°±ä¸ºå½“å‰Activityåˆ›å»ºäº†WindowManagerå¯¹è±¡  </span></span><br><span class="line">            ViewManager wm = a.getWindowManager();</span><br><span class="line">            <span class="comment">//å¾—åˆ°è¯¥è§†å›¾å¯¹è±¡çš„å¸ƒå±€å‚æ•°  </span></span><br><span class="line">            WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">            <span class="comment">//å°†è§†å›¾å¯¹è±¡ä¿å­˜åˆ°Activityçš„æˆå‘˜å˜é‡mDecorä¸­  </span></span><br><span class="line">            a.mDecor = decor;</span><br><span class="line">            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">            l.softInputMode |= forwardBit;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//å°†åˆ›å»ºçš„è§†å›¾å¯¹è±¡DecorViewæ·»åŠ åˆ°Activityçš„çª—å£ç®¡ç†å™¨ä¸­  </span></span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125;</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                r.activity.makeVisible();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›è€Œå±‚å±‚è°ƒç”¨åˆ°ï¼šViewRootImpl.setView()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line">WindowManager.LayoutParams l = r.window.getAttributes();</span><br></pre></td></tr></table></figure><p>ViewRootImpl.setView()å‡½æ•°ä¸­æ·»åŠ Activityçª—å£æ—¶åœ¨å‚æ•°mWindowAttributesä¸­æºå¸¦Tokenä»£ç†å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewManager.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,  </span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,  </span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outContentInsets, Rect outStableInsets, InputChannel outInputChannel)</span> </span>&#123;  </span><br><span class="line">        ......  </span><br><span class="line">        <span class="keyword">boolean</span> addToken = <span class="keyword">false</span>;  </span><br><span class="line">        <span class="comment">//attrsè¿™ä¸ªæ˜¯åº”ç”¨ç¨‹åºActivityClientRecordä¸­ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œå…¶ä¸­çš„attrs.tokenå°±æ˜¯æ­¥éª¤ä¸‰ç§çš„r.token</span></span><br><span class="line">        WindowToken token = mTokenMap.get(attrs.token);  </span><br><span class="line">        ......  </span><br><span class="line">        win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,  </span><br><span class="line">                attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);  </span><br><span class="line"></span><br><span class="line">        mWindowMap.put(client.asBinder(), win);  </span><br><span class="line">        ......  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®Binderæœºåˆ¶å¯ä»¥çŸ¥é“ä»ä¸Šå±‚åº”ç”¨ä¼ é€’è¿‡æ¥çš„Tokenä»£ç†å¯¹è±¡ä¼šè½¬æ¢æˆSystemServerè¿›ç¨‹ä¸­çš„Tokenæœ¬åœ°å¯¹è±¡ï¼Œåè€…ä¸ç¬¬2æ­¥ä¸­ä»Tokenå¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ä¸Šé¢è°ƒç”¨mTokenMap.get(attrs.token)æ—¶ä¾¿èƒ½è¿”å›æ­£ç¡®è¿”å›ä¸€ä¸ªWindowTokenï¼ˆè¿™ä¸ªWindowTokenå…¶å®æ˜¯ä¸€ä¸ªAPPWindowTokenï¼‰ï¼Œè¿™æ ·æ·»åŠ çš„çª—å£ä¹Ÿå°±è·ŸActivityå…³è”ä¸Šäº†ã€‚</p><h3 id="1-2ã€WMSç»„ç»‡æ–¹å¼"><a href="#1-2ã€WMSç»„ç»‡æ–¹å¼" class="headerlink" title="1.2ã€WMSç»„ç»‡æ–¹å¼"></a>1.2ã€WMSç»„ç»‡æ–¹å¼</h3><p>Activityç®¡ç†æœåŠ¡ActivityManagerServiceä¸­æ¯ä¸€ä¸ªActivityRecordå¯¹è±¡åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¸­éƒ½å¯¹åº”æœ‰ä¸€ä¸ªAppWindowTokenå¯¹è±¡ã€‚</p><p>æ­¤å¤–ï¼Œåœ¨è¾“å…¥æ³•ç®¡ç†æœåŠ¡InputMethodManagerServiceä¸­ï¼Œæ¯ä¸€ä¸ªè¾“å…¥æ³•çª—å£éƒ½å¯¹åº”æœ‰ä¸€ä¸ªBinderå¯¹è±¡ï¼Œè¿™ä¸ªBinderå¯¹è±¡åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceåˆå¯¹åº”æœ‰ä¸€ä¸ªWindowTokenå¯¹è±¡ã€‚</p><p>ä¸è¾“å…¥æ³•çª—å£ç±»ä¼¼ï¼Œåœ¨å£çº¸ç®¡ç†æœåŠ¡WallpaperManagerServiceä¸­ï¼Œæ¯ä¸€ä¸ªå£çº¸çª—å£éƒ½å¯¹åº”æœ‰ä¸€ä¸ªBinderå¯¹è±¡ï¼Œè¿™ä¸ªBinderå¯¹è±¡åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¹Ÿå¯¹åº”æœ‰ä¸€ä¸ªWindowTokenå¯¹è±¡ã€‚</p><p>åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¸­ï¼Œæ— è®ºæ˜¯AppWindowTokenå¯¹è±¡ï¼Œè¿˜æ˜¯WindowTokenå¯¹è±¡ï¼Œå®ƒä»¬éƒ½æ˜¯ç”¨æ¥æè¿°ä¸€ç»„æœ‰ç€ç›¸åŒä»¤ç‰Œçš„çª—å£çš„ï¼Œæ¯ä¸€ä¸ªçª—å£éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªWindowStateå¯¹è±¡æ¥æè¿°çš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªActivityç»„ä»¶çª—å£å¯èƒ½æœ‰ä¸€ä¸ªå¯åŠ¨çª—å£ï¼ˆStarting Windowï¼‰ï¼Œè¿˜æœ‰è‹¥å¹²ä¸ªå­çª—å£ï¼Œé‚£ä¹ˆè¿™äº›çª—å£å°±ä¼šç»„æˆä¸€ç»„ï¼Œå¹¶ä¸”éƒ½æ˜¯ä»¥Activityç»„ä»¶åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¸­æ‰€å¯¹åº”çš„AppWindowTokenå¯¹è±¡ä¸ºä»¤ç‰Œçš„ã€‚ä»æŠ½è±¡çš„è§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯åœ¨Windowç®¡ç†æœåŠ¡WindowManagerServiceä¸­ï¼Œæ¯ä¸€ä¸ªä»¤ç‰Œï¼ˆAppWindowTokenæˆ–è€…WindowTokenï¼‰éƒ½æ˜¯ç”¨æ¥æè¿°ä¸€ç»„çª—å£ï¼ˆWindowStateï¼‰çš„ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªçª—å£çš„å­çª—å£ä¹Ÿæ˜¯ä¸å®ƒåŒå±äºä¸€ä¸ªç»„ï¼Œå³éƒ½æœ‰ç€ç›¸åŒçš„ä»¤ç‰Œã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/05-Android-WMS-AppWindowToken.png" alt="Markdown"><br>å…¶ä¸­ï¼ŒActivity Stackæ˜¯åœ¨ActivityManagerServiceæœåŠ¡ä¸­åˆ›å»ºçš„ï¼ŒToken Listå’ŒWindow Stackæ˜¯åœ¨WindowManagerServiceä¸­åˆ›å»ºçš„ï¼Œè€ŒBinder for IMå’ŒBinder for WPåˆ†åˆ«æ˜¯åœ¨InputMethodManagerServiceæœåŠ¡å’ŒWallpaperManagerServiceæœåŠ¡ä¸­åˆ›å»ºçš„ï¼Œç”¨æ¥æè¿°ä¸€ä¸ªè¾“å…¥æ³•çª—å£å’Œä¸€ä¸ªå£çº¸çª—å£ã€‚</p><h3 id="1-3ã€WMSçª—å£ç±»å‹"><a href="#1-3ã€WMSçª—å£ç±»å‹" class="headerlink" title="1.3ã€WMSçª—å£ç±»å‹"></a>1.3ã€WMSçª—å£ç±»å‹</h3><p>æ·»åŠ ä¸€ä¸ªçª—å£æ˜¯é€šè¿‡ WindowManagerGlobal.addView()æ¥å®Œæˆçš„ï¼Œåˆ†æ addView æ–¹æ³•çš„å‚æ•°ï¼Œæœ‰ä¸‰ä¸ªå‚æ•°æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œviewï¼Œparamsï¼Œä»¥åŠ displayã€‚è€Œ display ä¸€èˆ¬ç›´æ¥å– WindowMnagerImpl ä¸­çš„ mDisplayï¼Œè¡¨ç¤ºè¦è¾“å‡ºçš„æ˜¾ç¤ºè®¾å¤‡ã€‚view è‡ªç„¶è¡¨ç¤ºè¦æ˜¾ç¤ºçš„ Viewï¼Œè€Œ params æ˜¯ WindowManager.LayoutParamsï¼Œç”¨æ¥æè¿°è¿™ä¸ª view çš„äº›çª—å£å±æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„å‚æ•° typeï¼Œç”¨æ¥æè¿°çª—å£çš„ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerGlobal]</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">            Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (display == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"display must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(params <span class="keyword">instanceof</span> WindowManager.LayoutParams)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Params must be WindowManager.LayoutParams"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ```</span><br></pre></td></tr></table></figure><p>}</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æ‰“å¼€WindowManagerç±»ï¼Œçœ‹åˆ°é™æ€å†…éƒ¨ç±»ã€‚</span><br><span class="line"></span><br><span class="line">``` java</span><br><span class="line">[-&gt;WindowManager]</span><br><span class="line">public static class LayoutParams extends ViewGroup.LayoutParams implements Parcelable &#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨LayoutParamsä¸­ï¼Œæœ‰2ä¸ªæ¯”è¾ƒé‡è¦çš„å‚æ•°: flags,typeã€‚ æˆ‘ä»¬ç®€è¦çš„åˆ†æä¸€ä¸‹flags,è¯¥å‚æ•°è¡¨ç¤ºWindowçš„å±æ€§ï¼Œå®ƒæœ‰å¾ˆå¤šé€‰é¡¹ï¼Œé€šè¿‡è¿™äº›é€‰é¡¹å¯ä»¥æ§åˆ¶Windowçš„æ˜¾ç¤ºç‰¹æ€§ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»å‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„é€‰é¡¹ã€‚</p><p>FLAG_NOT_FOCUSABLE è¡¨ç¤ºWindowä¸éœ€è¦è·å–ç„¦ç‚¹ï¼Œä¹Ÿä¸éœ€è¦æ¥æ”¶å„ç§è¾“å…¥äº‹ä»¶ï¼Œæ­¤æ ‡è®°ä¼šåŒæ—¶å¯ç”¨FLAG_NOT_TOUCH_MODALï¼Œæœ€ç»ˆäº‹ä»¶ä¼šç›´æ¥ä¼ é€’ç»™ä¸‹å±‚å…·æœ‰ç„¦ç‚¹çš„Windowã€‚</p><p>FLAG_NOT_TOUCH_MODAL ç³»ç»Ÿä¼šå°†å½“å‰WindowåŒºåŸŸä»¥å¤–çš„å•å‡»äº‹ä»¶ä¼ é€’ç»™åº•å±‚çš„Windowï¼Œå½“å‰WindowåŒºåŸŸä»¥å†…çš„å•å‡»äº‹ä»¶åˆ™è‡ªå·±å¤„ç†ï¼Œè¿™ä¸ªæ ‡è®°å¾ˆé‡è¦ï¼Œä¸€èˆ¬æ¥è¯´éƒ½éœ€è¦å¼€å¯æ­¤æ ‡è®°ï¼Œå¦åˆ™å…¶ä»–Windowå°†æ— æ³•æ¥æ”¶åˆ°å•å‡»äº‹ä»¶ã€‚</p><p>FLAG_SHOW_WHEN_LOCKED å¼€å¯æ­¤æ¨¡å¼å¯ä»¥è®©Windowæ˜¾ç¤ºåœ¨é”å±çš„ç•Œé¢ä¸Šã€‚</p><blockquote><p>Typeå‚æ•°è¡¨ç¤ºWindowçš„ç±»å‹ï¼ŒWindowæœ‰ä¸‰ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯åº”ç”¨Windowã€å­Windowã€ç³»ç»ŸWindowã€‚åº”ç”¨ç±»Windowå¯¹åº”ç€ä¸€ä¸ªActivityã€‚å­Windowä¸èƒ½å•ç‹¬å­˜åœ¨ï¼Œå®ƒéœ€è¦é™„å±åœ¨ç‰¹å®šçš„çˆ¶Windowä¹‹ä¸­ï¼Œæ¯”å¦‚å¸¸è§çš„PopupWindowå°±æ˜¯ä¸€ä¸ªå­Windowã€‚æœ‰äº›ç³»ç»ŸWindowæ˜¯éœ€è¦å£°æ˜æƒé™æ‰èƒ½åˆ›å»ºçš„Windowï¼Œæ¯”å¦‚Toastå’Œç³»ç»ŸçŠ¶æ€æ è¿™äº›éƒ½æ˜¯ç³»ç»ŸWindowã€‚</p></blockquote><h3 id="1-3-1ã€åº”ç”¨çª—å£"><a href="#1-3-1ã€åº”ç”¨çª—å£" class="headerlink" title="1.3.1ã€åº”ç”¨çª—å£"></a>1.3.1ã€åº”ç”¨çª—å£</h3><p>Activity å¯¹åº”çš„çª—å£ç±»å‹æ˜¯åº”ç”¨çª—å£ï¼Œ æ‰€æœ‰ Activity é»˜è®¤çš„çª—å£ç±»å‹æ˜¯ TYPE_BASE_APPLICATIONã€‚ WindowManager çš„ LayoutParams çš„é»˜è®¤ç±»å‹æ˜¯ TYPE_APPLICATIONã€‚ Dialog å¹¶æ²¡æœ‰è®¾ç½®typeï¼Œæ‰€ä»¥ä¹Ÿæ˜¯é»˜è®¤çš„çª—å£ç±»å‹å³ TYPE_APPLICATIONã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManager.LayoutParams]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</span><br><span class="line">    type = TYPE_APPLICATION;</span><br><span class="line">    format = PixelFormat.OPAQUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">typeå±‚çº§</th><th style="text-align:left">ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">FIRST_APPLICATION_WINDOW=1</td><td style="text-align:left">å¼€å§‹åº”ç”¨ç¨‹åºçª—å£ï¼Œç¬¬ä¸€ä¸ªæ™®é€šåº”ç”¨çª—å£</td></tr><tr><td style="text-align:left">TYPE_BASE_APPLICATION=1</td><td style="text-align:left">æ‰€æœ‰ç¨‹åºçª—å£çš„baseçª—å£ï¼Œå…¶ä»–åº”ç”¨ç¨‹åºçª—å£éƒ½æ˜¾ç¤ºåœ¨å®ƒä¸Šé¢</td></tr><tr><td style="text-align:left">TYPE_APPLICATION=2</td><td style="text-align:left">æ™®é€šåº”ç”¨ç¨‹åºçª—å£ï¼Œtokenå¿…é¡»è®¾ç½®ä¸ºActivityçš„tokenæ¥æŒ‡å®šçª—å£å±äºè°</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_STARTING=3</td><td style="text-align:left">åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å…ˆæ˜¾ç¤ºæ­¤çª—å£ï¼Œå½“çœŸæ­£çš„çª—å£é…ç½®å®Œæˆåï¼Œå…³é—­æ­¤çª—å£</td></tr><tr><td style="text-align:left">LAST_APPLICATION_WINDOW=99</td><td style="text-align:left">æœ€åä¸€ä¸ªåº”ç”¨çª—å£</td></tr></tbody></table><h3 id="1-3-2ã€å­çª—å£"><a href="#1-3-2ã€å­çª—å£" class="headerlink" title="1.3.2ã€å­çª—å£"></a>1.3.2ã€å­çª—å£</h3><p>å­çª—å£ä¸èƒ½å•ç‹¬å­˜åœ¨ï¼Œå®ƒéœ€è¦é™„å±åœ¨ç‰¹å®šçš„çˆ¶Windowä¹‹ä¸­ï¼Œä¾‹å¦‚å¼€ç¯‡ç¬¬ä¸€å¼ å›¾ï¼Œç»¿è‰²æ¡†æ¡†å³ä¸ºpopupWindowï¼Œå®ƒå°±æ˜¯å­çª—å£ï¼Œç±»å‹ä¸€èˆ¬ä¸ºTYPE_APPLICATION_PANELã€‚ä¹‹æ‰€ä»¥ç§°ä¸ºå­çª—å£ï¼Œå³å®ƒçš„çˆ¶çª—å£æ˜¾ç¤ºæ—¶ï¼Œå­çª—å£æ‰æ˜¾ç¤ºã€‚çˆ¶çª—å£ä¸æ˜¾ç¤ºï¼Œå®ƒä¹Ÿä¸æ˜¾ç¤ºã€‚è¿½éšçˆ¶çª—å£ã€‚</p><table><thead><tr><th style="text-align:left">typeå±‚çº§</th><th style="text-align:left">ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">FIRST_SUB_WINDOW=1000</td><td style="text-align:left">ç¬¬ä¸€ä¸ªå­çª—å£</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_PANEL=1000</td><td style="text-align:left">åº”ç”¨çª—å£çš„å­çª—å£,popupWindowçš„é»˜è®¤ç±»å‹</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_MEDIA=1001</td><td style="text-align:left">åª’ä½“çª—å£</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_SUB_PANEL=1002</td><td style="text-align:left">TYPE_APPLICATION_PANEçš„å­çª—å£</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_ATTACHED_DIALOG=1003</td><td style="text-align:left">å¯¹è¯æ¡†ï¼Œç±»ä¼¼äºé¢æ¿çª—å£(OptionMenu,ContextMenu)</td></tr><tr><td style="text-align:left">TYPE_APPLICATION_MEDIA_OVERLAY=1004</td><td style="text-align:left">åª’ä½“ä¿¡æ¯ï¼Œæ˜¾ç¤ºåœ¨åª’ä½“å±‚å’Œç¨‹åºçª—å£ä¹‹é—´ï¼Œéœ€è¦å®ç°åŠé€æ˜æ•ˆæœ</td></tr><tr><td style="text-align:left">LAST_SUB_WINDOW=1999</td><td style="text-align:left">æœ€åä¸€ä¸ªå­çª—å£</td></tr></tbody></table><h3 id="1-3-3ã€ç³»ç»Ÿçª—å£"><a href="#1-3-3ã€ç³»ç»Ÿçª—å£" class="headerlink" title="1.3.3ã€ç³»ç»Ÿçª—å£"></a>1.3.3ã€ç³»ç»Ÿçª—å£</h3><p>ç³»ç»Ÿçª—å£è·Ÿåº”ç”¨çª—å£ä¸åŒï¼Œä¸éœ€è¦å¯¹åº” Activityã€‚è·Ÿå­çª—å£ä¸åŒï¼Œä¸éœ€è¦æœ‰çˆ¶çª—å£ã€‚ä¸€èˆ¬æ¥è®²ï¼Œç³»ç»Ÿçª—å£åº”è¯¥ç”±ç³»ç»Ÿæ¥åˆ›å»ºçš„ï¼Œä¾‹å¦‚å‘ç”Ÿå¼‚å¸¸ï¼ŒANRæ—¶çš„æç¤ºæ¡†ï¼Œåˆå¦‚ç³»ç»ŸçŠ¶æ€æ ï¼Œå±ä¿ç­‰ã€‚ä½†æ˜¯ï¼ŒFramework è¿˜æ˜¯å®šä¹‰äº†ä¸€äº›ï¼Œå¯ä»¥è¢«åº”ç”¨æ‰€åˆ›å»ºçš„ç³»ç»Ÿçª—å£ï¼Œå¦‚ TYPE _TOASTï¼ŒTYPE <em>INPUT</em> METHODï¼ŒTYPE _WALLPAPTER ç­‰ç­‰ã€‚</p><table><thead><tr><th style="text-align:left">typeå±‚çº§</th><th style="text-align:left">ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:left">FIRST_SYSTEM_WINDOW=2000</td><td style="text-align:left">ç¬¬ä¸€ä¸ªç³»ç»Ÿçª—å£</td></tr><tr><td style="text-align:left">TYPE_STATUS_BAR=2000</td><td style="text-align:left">çŠ¶æ€æ ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçŠ¶æ€æ ï¼Œä½äºå±å¹•é¡¶ç«¯</td></tr><tr><td style="text-align:left">TYPE_SEARCH_BAR =2001</td><td style="text-align:left">æœç´¢æ </td></tr><tr><td style="text-align:left">TYPE_PHONE=2002</td><td style="text-align:left">ç”µè¯çª—å£ï¼Œå®ƒç”¨äºç”µè¯äº¤äº’</td></tr><tr><td style="text-align:left">TYPE_SYSTEM_ALERT=2003</td><td style="text-align:left">ç³»ç»Ÿè­¦å‘Šï¼Œå‡ºç°åœ¨åº”ç”¨ç¨‹åºçª—å£ä¹‹ä¸Š</td></tr><tr><td style="text-align:left">TYPE_KEYGUARD=2004</td><td style="text-align:left">é”å±çª—å£</td></tr><tr><td style="text-align:left">TYPE_TOAST=2005</td><td style="text-align:left">ä¿¡æ¯çª—å£ï¼Œç”¨äºæ˜¾ç¤ºToast</td></tr><tr><td style="text-align:left">TYPE_SYSTEM_OVERLAY=2006</td><td style="text-align:left">ç³»ç»Ÿé¡¶å±‚çª—å£ï¼Œæ˜¾ç¤ºåœ¨å…¶ä»–å†…å®¹ä¹‹ä¸Šï¼Œæ­¤çª—å£ä¸èƒ½è·å¾—è¾“å…¥ç„¦ç‚¹ï¼Œå¦åˆ™å½±å“é”å±</td></tr><tr><td style="text-align:left">TYPE_PRIORITY_PHONE=2007</td><td style="text-align:left">å½“é”å±æ—¶æ˜¾ç¤ºçš„æ¥ç”µæ˜¾ç¤ºçª—å£</td></tr><tr><td style="text-align:left">TYPE_SYSTEM_DIALOG=2008</td><td style="text-align:left">ç³»ç»Ÿå¯¹è¯æ¡†</td></tr><tr><td style="text-align:left">TYPE_KEYGUARD_DIALOG=2009</td><td style="text-align:left">é”å±æ—¶æ˜¾ç¤ºçš„å¯¹è¯æ¡†</td></tr><tr><td style="text-align:left">TYPE_SYSTEM_ERROR=2010</td><td style="text-align:left">ç³»ç»Ÿå†…éƒ¨é”™è¯¯æç¤º</td></tr><tr><td style="text-align:left">TYPE_INPUT_METHOD=2011</td><td style="text-align:left">è¾“å…¥æ³•çª—å£ï¼Œæ˜¾ç¤ºäºæ™®é€šåº”ç”¨/å­çª—å£ä¹‹ä¸Š</td></tr><tr><td style="text-align:left">TYPE_INPUT_METHOD_DIALOG=2012</td><td style="text-align:left">è¾“å…¥æ³•ä¸­å¤‡é€‰æ¡†å¯¹åº”çš„çª—å£</td></tr><tr><td style="text-align:left">TYPE_WALLPAPER=2013</td><td style="text-align:left">å¢™çº¸çª—å£</td></tr><tr><td style="text-align:left">TYPE_STATUS_BAR_PANEL=2014</td><td style="text-align:left">æ»‘åŠ¨çŠ¶æ€æ¡åå‡ºç°çš„çª—å£</td></tr><tr><td style="text-align:left">TYPE_SECURE_SYSTEM_OVERLAY=2015</td><td style="text-align:left">å®‰å…¨ç³»ç»Ÿè¦†ç›–çª—å£</td></tr><tr><td style="text-align:left">â€¦â€¦</td><td style="text-align:left">â€¦â€¦</td></tr><tr><td style="text-align:left">LAST_SYSTEM_WINDOW=2999</td><td style="text-align:left">æœ€åä¸€ä¸ªç³»ç»Ÿçª—å£</td></tr></tbody></table><p>é‚£ä¹ˆï¼Œè¿™ä¸ªtypeå±‚çº§åˆ°åº•æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ Windowæ˜¯åˆ†å±‚çš„ï¼Œæ¯ä¸ªWindowéƒ½æœ‰å¯¹åº”çš„z-orderedï¼Œï¼ˆzè½´ï¼Œä»1å±‚å±‚å åŠ åˆ°2999ï¼Œä½ å¯ä»¥å°†å±å¹•æƒ³æˆä¸‰ç»´åæ ‡æ¨¡å¼ï¼‰å±‚çº§å¤§çš„ä¼šè¦†ç›–åœ¨å±‚çº§å°çš„Windowä¸Šé¢ã€‚</p><p>åœ¨ä¸‰ç±»Windowä¸­ï¼Œåº”ç”¨Windowçš„å±‚çº§èŒƒå›´æ˜¯1~99ã€‚å­Windowçš„å±‚çº§èŒƒå›´æ˜¯1000~1999ï¼Œç³»ç»ŸWindowçš„å±‚çº§èŒƒå›´æ˜¯2000~2999ï¼Œè¿™äº›å±‚çº§èŒƒå›´å¯¹åº”ç€WindowManager.LayoutParamsçš„typeå‚æ•°ã€‚å¦‚æœæƒ³è¦Windowä½äºæ‰€æœ‰Windowçš„æœ€é¡¶å±‚ï¼Œé‚£ä¹ˆé‡‡ç”¨è¾ƒå¤§çš„å±‚çº§å³å¯ã€‚å¦å¤–æœ‰äº›ç³»ç»Ÿå±‚çº§çš„ä½¿ç”¨æ˜¯éœ€è¦å£°æ˜æƒé™çš„ã€‚</p><h2 id="ï¼ˆäºŒï¼‰ã€Window-Sizeï¼ˆå¤§å°ï¼‰å’Œ-Window-Positionï¼ˆä½ç½®ï¼‰-è®¡ç®—è¿‡ç¨‹"><a href="#ï¼ˆäºŒï¼‰ã€Window-Sizeï¼ˆå¤§å°ï¼‰å’Œ-Window-Positionï¼ˆä½ç½®ï¼‰-è®¡ç®—è¿‡ç¨‹" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Window Sizeï¼ˆå¤§å°ï¼‰å’Œ Window Positionï¼ˆä½ç½®ï¼‰ è®¡ç®—è¿‡ç¨‹"></a>ï¼ˆäºŒï¼‰ã€Window Sizeï¼ˆå¤§å°ï¼‰å’Œ Window Positionï¼ˆä½ç½®ï¼‰ è®¡ç®—è¿‡ç¨‹</h2><p>ä¹‹å‰åœ¨ã€Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿåˆ†æ [i.wonder~]ã€‘åˆ†æè¿‡ï¼Œå½“Vsyncäº‹ä»¶åˆ°æ¥æ—¶ï¼Œå°±ä¼šé€šè¿‡Choreographerçš„postCallback()ï¼Œæ¥ç€æ‰§è¡ŒmTraversalRunnableå¯¹è±¡çš„run()æ–¹æ³•ã€‚ mTraversalRunnableå¯¹è±¡çš„ç±»å‹ä¸ºTraversalRunnableï¼Œè¯¥ç±»å®ç°äº†Runnableæ¥å£ï¼Œåœ¨å…¶run()å‡½æ•°ä¸­è°ƒç”¨äº†doTraversal()å‡½æ•°æ¥å®Œæˆçª—å£å¸ƒå±€ã€‚ä¸ºäº†åˆ†æçš„è¿è´¯æ€§ï¼Œè¿™é‡Œé‡æ–°è´´ä¸€ä¸‹æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> TraversalRunnable mTraversalRunnable = <span class="keyword">new</span> TraversalRunnable();</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line">        ......</span><br><span class="line">        performTraversals();</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>performTraversals()å‡½æ•°ç›¸å½“å¤æ‚ï¼Œå…¶ä¸»è¦å®ç°ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š</p><p>1.æ‰§è¡Œçª—å£æµ‹é‡ï¼›</p><p>2.æ‰§è¡Œçª—å£æ³¨å†Œï¼›</p><p>3.æ‰§è¡Œçª—å£å¸ƒå±€ï¼›</p><p>4.æ‰§è¡Œçª—å£ç»˜å›¾ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£æµ‹é‡******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">        windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************å‘WMSæœåŠ¡æ·»åŠ çª—å£******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">            viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£å¸ƒå±€******************/</span></span><br><span class="line">    <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">        performLayout(lp, mWidth, mHeight);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£ç»˜åˆ¶******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">        ......</span><br><span class="line">        performDraw();</span><br><span class="line">    &#125; ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1ã€-Android-å±å¹•åŒºåŸŸä»‹ç»"><a href="#2-1ã€-Android-å±å¹•åŒºåŸŸä»‹ç»" class="headerlink" title="2.1ã€ Android å±å¹•åŒºåŸŸä»‹ç»"></a>2.1ã€ Android å±å¹•åŒºåŸŸä»‹ç»</h3><p>é¦–å…ˆæ¥çœ‹relayoutWindow()ã€‚relayoutWindow() æ˜¯Window Manager Service é‡è¦å·¥ä½œä¹‹ä¸€ï¼Œå®ƒçš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/06-Android-WMS-relayoutWindow-flow.png.png" alt="Markdown"></p><p>æ¯ä¸ªViewå°†æœŸæœ›çª—å£å°ºå¯¸äº¤ç»™WMSï¼ˆWindowManager Service). WMS å°†æ‰€æœ‰çš„çª—å£å¤§å°ä»¥åŠå½“å‰çš„OverscanåŒºåŸŸä¼ ç»™WPM ï¼ˆWindowManager Policy). WPMæ ¹æ®ç”¨æˆ·é…ç½®ç¡®å®šæ¯ä¸ªWindowåœ¨æœ€ç»ˆDisplayè¾“å‡ºä¸Šçš„ä½ç½®ä»¥åŠéœ€è¦åˆ†é…çš„Surfaceå¤§å°ã€‚ è¿”å›è¿™äº›ä¿¡æ¯ç»™æ¯ä¸ªViewï¼Œä»–ä»¬å°†åœ¨ç»™ä¼šçš„åŒºåŸŸç©ºé—´é‡Œç»˜å›¾ã€‚ Androidé‡Œå®šä¹‰äº†å¾ˆå¤šåŒºåŸŸ,å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/07-Android-WMS-OverSan-area.png" alt="Markdown"></p><p><strong>Overscan:</strong> Overscan æ˜¯ç”µè§†ç‰¹æœ‰çš„æ¦‚å¿µï¼Œä¸Šå›¾ä¸­é»„è‰²éƒ¨åˆ†å°±æ˜¯OverscanåŒºåŸŸï¼ŒæŒ‡çš„æ˜¯ç”µè§†æœºå±å¹•å››å‘¨æŸäº›ä¸å¯è§çš„åŒºåŸŸï¼ˆå› ä¸ºç”µè§†ç‰¹æ€§ï¼Œè¿™éƒ¨åˆ†åŒºåŸŸçš„bufferå†…å®¹æ˜¾ç¤ºæ—¶è¢«ä¸¢å¼ƒï¼‰ï¼Œä¹Ÿæ„å‘³ç€å¦‚æœçª—å£çš„æŸäº›å†…å®¹ç”»åœ¨è¿™ä¸ªåŒºåŸŸé‡Œï¼Œå®ƒåœ¨æŸäº›ç”µè§†ä¸Šå°±ä¼šçœ‹ä¸åˆ°ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œé€šå¸¸è¦æ±‚UIä¸è¦ç”»åœ¨å±å¹•çš„è¾¹è§’ä¸Šï¼Œè€Œæ˜¯é¢„ç•™ä¸€å®šçš„ç©ºé—´ã€‚å› ä¸ºOverscançš„åŒºåŸŸå¤§å°éšç€ç”µè§†ä¸ åŒè€Œä¸åŒï¼Œå®ƒä¸€èˆ¬ç”±ç»ˆç«¯ç”¨æˆ·é€šè¿‡UIæŒ‡å®šï¼Œï¼ˆæ¯”å¦‚è¯´GoogleTVé‡Œå°±æœ‰ç¡®å®šOverscanå¤§å°çš„åº”ç”¨ï¼‰ã€‚</p><p><strong>OverscanScreen, Screen:</strong> OverscanScreen æ˜¯åŒ…å«OverscanåŒºåŸŸçš„å±å¹•å¤§å°,è€ŒScreenåˆ™ä¸ºå»é™¤OverscanåŒºåŸŸåçš„å±å¹•åŒºåŸŸ, OverscanScreen &gt; Screen.</p><p><strong>Restricted and Unrestricted:</strong> æŸäº›åŒºåŸŸæ˜¯è¢«ç³»ç»Ÿä¿ç•™çš„ï¼Œæ¯”å¦‚è¯´æ‰‹æœºå±å¹•ä¸Šæ–¹çš„çŠ¶æ€æ (å¦‚å›¾çº¸ç»¿è‰²åŒºåŸŸï¼‰å’Œä¸‹æ–¹çš„å¯¼èˆªæ ï¼Œæ ¹æ®æ˜¯å¦åŒ…æ‹¬è¿™äº›é¢„ç•™çš„åŒºåŸŸï¼ŒAndroidæŠŠåŒºåŸŸåˆ†ä¸ºUnrestricted Area å’Œ Resctrited Aread, å‰è€…åŒ…æ‹¬è¿™éƒ¨åˆ†é¢„ç•™åŒºåŸŸï¼Œåè€…åˆ™ä¸åŒ…å«, Unrestricted area &gt; Rectricted areaã€‚</p><p><strong>mFrame, mDisplayFrame, mContainingFrame</strong> FrameæŒ‡çš„æ˜¯ä¸€ç‰‡å†…å­˜åŒºåŸŸ, å¯¹åº”äºå±å¹•ä¸Šçš„ä¸€å—çŸ©å½¢åŒºåŸŸ. mFrameçš„å¤§å°å°±æ˜¯Surfaceçš„å¤§å°, å¦‚ä¸Šä¸Šå›¾ä¸­çš„è“è‰²åŒºåŸŸ. mDisplayFrame å’Œ mContainingFrame ä¸€èˆ¬å’ŒmFrame å¤§å°ä¸€è‡´. mXXX æ˜¯Window(ViewRootImpl, Windowstate) é‡Œé¢å®šä¹‰çš„æˆå‘˜å˜é‡.</p><p><strong>mContentFrame, mVisibleFrame</strong> ä¸€ä¸ªSurfaceçš„æ‰€æœ‰å†…å®¹ä¸ä¸€å®šåœ¨å±å¹•ä¸Šéƒ½å¾—åˆ°æ˜¾ç¤º, ä¸Overscané‡å çš„éƒ¨åˆ†ä¼šè¢«æˆªæ‰, ç³»ç»Ÿçš„å…¶ä»–çª—å£ä¹Ÿä¼šé®æŒ¡æ‰éƒ¨åˆ†åŒºåŸŸ (æ¯”å¦‚çŸ­ä¿¡çª—å£ï¼ŒContentFrameæ˜¯800x600(æ²¡æœ‰Status Bar), ä½†å½“è¾“å…¥æ³•çª—å£å¼¹å‡ºæ˜¯ï¼Œå˜æˆäº†800x352), å‰©ä¸‹çš„åŒºåŸŸç§°ä¸ºVisible Frame, UIå†…å®¹åªæœ‰ç”»åœ¨è¿™ä¸ªåŒºåŸŸé‡Œæ‰èƒ½ç¡®ä¿å¯è§. æ‰€ä»¥ä¹Ÿç§°ä¸ºContent Frame. mXXXä¹Ÿæ˜¯Window(ViewRootImpl, WindowState) é‡Œé¢å®šä¹‰çš„æˆå‘˜å˜é‡.<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/08-Android-WMS-Content-Insets.png" alt="Markdown"></p><p><strong>Insets</strong> insetsçš„å®šä¹‰å¦‚ä¸Šå›¾æ‰€ç¤º, ç”¨äº†è¡¨ç¤ºæŸä¸ªFrameçš„è¾¹ç¼˜å¤§å°.</p><h3 id="2-2ã€-Window-å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹"><a href="#2-2ã€-Window-å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹" class="headerlink" title="2.2ã€ Window å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹"></a>2.2ã€ Window å¤§å°ä½ç½®è®¡ç®—è¿‡ç¨‹</h3><p>åœ¨Androidç³»ç»Ÿä¸­ï¼ŒActivityçª—å£çš„å¤§å°æ˜¯ç”±WindowManagerServiceæœåŠ¡æ¥è®¡ç®—çš„ã€‚WindowManagerServiceæœåŠ¡ä¼šæ ¹æ®å±å¹•åŠå…¶è£…é¥°åŒºçš„å¤§å°æ¥å†³å®šActivityçª—å£çš„å¤§å°ã€‚ä¸€ä¸ªActivityçª—å£åªæœ‰çŸ¥é“è‡ªå·±çš„å¤§å°ä¹‹åï¼Œæ‰èƒ½å¯¹å®ƒé‡Œé¢çš„UIå…ƒç´ è¿›è¡Œæµ‹é‡ã€å¸ƒå±€ä»¥åŠç»˜åˆ¶ã€‚ ä¸€èˆ¬æ¥è¯´ï¼ŒActivityçª—å£çš„å¤§å°ç­‰äºæ•´ä¸ªå±å¹•çš„å¤§å°ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å æ®ç€æ•´å—å±å¹•ã€‚ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æä¸€ä¸‹Activityçª—å£çš„åŒºåŸŸæ˜¯å¦‚ä½•åˆ’åˆ†çš„ã€‚ æˆ‘ä»¬çŸ¥é“ï¼ŒActivityçª—å£çš„ä¸Šæ–¹ä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ªçŠ¶æ€æ ï¼Œç”¨æ¥æ˜¾ç¤º3Gä¿¡å·ã€ç”µé‡ä½¿ç”¨ç­‰å›¾æ ‡ï¼Œå¦‚å›¾<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/09-Android-WMS-Content-Visible-Frame.png" alt="Markdown"></p><p>ä»Activityçª—å£å‰”é™¤æ‰çŠ¶æ€æ æ‰€å ç”¨çš„åŒºåŸŸä¹‹åï¼Œæ‰€å¾—åˆ°çš„åŒºåŸŸå°±ç§°ä¸ºå†…å®¹åŒºåŸŸï¼ˆContent Regionï¼‰ã€‚é¡¾åæ€ä¹‰ï¼Œå†…å®¹åŒºåŸŸå°±æ˜¯ç”¨æ¥æ˜¾ç¤ºActivityçª—å£çš„å†…å®¹çš„ã€‚æˆ‘ä»¬å†æŠ½è±¡ä¸€ä¸‹ï¼Œå‡è®¾Activityçª—å£çš„å››å‘¨éƒ½æœ‰ä¸€å—ç±»ä¼¼çŠ¶æ€æ çš„åŒºåŸŸï¼Œé‚£ä¹ˆå°†è¿™äº›åŒºåŸŸå‰”é™¤ä¹‹åï¼Œå¾—åˆ°ä¸­é—´çš„é‚£ä¸€å—åŒºåŸŸå°±ç§°ä¸ºå†…å®¹åŒºåŸŸï¼Œè€Œè¢«å‰”é™¤å‡ºæ¥çš„åŒºåŸŸæ‰€ç»„æˆçš„åŒºåŸŸå°±ç§°ä¸ºå†…å®¹è¾¹è¡¬åŒºåŸŸï¼ˆContent Insetsï¼‰ã€‚Activityçª—å£çš„å†…å®¹è¾¹è¡¬åŒºåŸŸå¯ä»¥ç”¨ä¸€ä¸ªå››å…ƒç»„ï¼ˆcontent-left, content-top, content-right, content-bottomï¼‰æ¥æè¿°ï¼Œå…¶ä¸­ï¼Œcontent-leftã€content-rightã€content-topã€content-bottomåˆ†åˆ«ç”¨æ¥æè¿°å†…å®¹åŒºåŸŸä¸çª—å£åŒºåŸŸçš„å·¦å³ä¸Šä¸‹è¾¹ç•Œè·ç¦»ã€‚ æˆ‘ä»¬è¿˜çŸ¥é“ï¼ŒActivityçª—å£æœ‰æ—¶å€™éœ€è¦æ˜¾ç¤ºè¾“å…¥æ³•çª—å£ï¼Œå¦‚å›¾ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/10-Android-WMS-InputMethod-Content-Frame.png" alt="Markdown"></p><p>è¿™æ—¶å€™Activityçª—å£çš„å†…å®¹åŒºåŸŸçš„å¤§å°æœ‰å¯èƒ½æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè¿™å–å†³äºå®ƒçš„Soft Input Modeã€‚æˆ‘ä»¬å‡è®¾Activityçª—å£çš„å†…å®¹åŒºåŸŸæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®ƒåœ¨åº•éƒ¨çš„ä¸€äº›åŒºåŸŸè¢«è¾“å…¥æ³•çª—å£é®æŒ¡äº†ï¼Œå³å®ƒåœ¨åº•éƒ¨çš„ä¸€äº›å†…å®¹æ˜¯ä¸å¯è§çš„ã€‚ä»Activityçª—å£å‰”é™¤æ‰çŠ¶æ€æ å’Œè¾“å…¥æ³•çª—å£æ‰€å ç”¨çš„åŒºåŸŸä¹‹åï¼Œæ‰€å¾—åˆ°çš„åŒºåŸŸå°±ç§°ä¸ºå¯è§åŒºåŸŸï¼ˆVisible Regionï¼‰ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å†æŠ½è±¡ä¸€ä¸‹ï¼Œå‡è®¾Activityçª—å£çš„å››å‘¨éƒ½æœ‰ä¸€å—ç±»ä¼¼çŠ¶æ€æ å’Œè¾“å…¥æ³•çª—å£çš„åŒºåŸŸï¼Œé‚£ä¹ˆå°†è¿™äº›åŒºåŸŸå‰”é™¤ä¹‹åï¼Œå¾—åˆ°ä¸­é—´çš„é‚£ä¸€å—åŒºåŸŸå°±ç§°ä¸ºå¯è§åŒºåŸŸï¼Œè€Œè¢«å‰”é™¤å‡ºæ¥çš„åŒºåŸŸæ‰€ç»„æˆçš„åŒºåŸŸå°±ç§°ä¸ºå¯è§è¾¹è¡¬åŒºåŸŸï¼ˆVisible Insetsï¼‰ã€‚Activityçª—å£çš„å¯è§è¾¹è¡¬åŒºåŸŸå¯ä»¥ç”¨ä¸€ä¸ªå››å…ƒç»„ï¼ˆvisible-left, visible-top, visible-right, visible-bottomï¼‰æ¥æè¿°ï¼Œå…¶ä¸­ï¼Œvisible-leftã€visible-rightã€visible-topã€visible-bottomåˆ†åˆ«ç”¨æ¥æè¿°å¯è§åŒºåŸŸä¸çª—å£åŒºåŸŸçš„å·¦å³ä¸Šä¸‹è¾¹ç•Œè·ç¦»ã€‚</p><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒActivityçª—å£çš„å†…å®¹åŒºåŸŸå’Œå¯è§åŒºåŸŸçš„å¤§å°æ˜¯ä¸€è‡´çš„ï¼Œè€ŒçŠ¶æ€æ å’Œè¾“å…¥æ³•çª—å£æ‰€å ç”¨çš„åŒºåŸŸåˆç§°ä¸ºå±å¹•è£…é¥°åŒºã€‚ç†è§£äº†è¿™äº›æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¨æ–­ï¼ŒWindowManagerServiceæœåŠ¡å®é™…ä¸Šå°±æ˜¯éœ€è¦æ ¹æ®å±å¹•ä»¥åŠå¯èƒ½å‡ºç°çš„çŠ¶æ€æ å’Œè¾“å…¥æ³•çª—å£çš„å¤§å°æ¥è®¡ç®—å‡ºActivityçª—å£çš„æ•´ä½“å¤§å°åŠå…¶å†…å®¹åŒºåŸŸè¾¹è¡¬å’Œå¯è§åŒºåŸŸè¾¹è¡¬çš„å¤§å°ã€‚æœ‰äº†è¿™ä¸‰ä¸ªæ•°æ®ä¹‹åï¼ŒActivityçª—å£å°±å¯ä»¥å¯¹å®ƒé‡Œé¢çš„UIå…ƒç´ è¿›è¡Œæµ‹é‡ã€å¸ƒå±€ä»¥åŠç»˜åˆ¶ç­‰æ“ä½œäº†ã€‚ æ€»ä½“æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/11-Android-WMS-relayoutWindow-time-diagram.png" alt="Markdown"></p><p>è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸º13ä¸ªæ­¥éª¤ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¯¦ç»†åˆ†ææ¯ä¸€ä¸ªæ­¥éª¤ã€‚</p><h3 id="2-2-1ã€ViewRootImpl-performTraversals"><a href="#2-2-1ã€ViewRootImpl-performTraversals" class="headerlink" title="2.2.1ã€ViewRootImpl.performTraversals()"></a>2.2.1ã€ViewRootImpl.performTraversals()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// cache mView since it is used so much below...</span></span><br><span class="line">    <span class="keyword">final</span> View host = mView;</span><br><span class="line">    ......</span><br><span class="line">    WindowManager.LayoutParams lp = mWindowAttributes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> desiredWindowWidth;</span><br><span class="line">    <span class="keyword">int</span> desiredWindowHeight;</span><br><span class="line">    ......</span><br><span class="line">    Rect frame = mWinFrame;</span><br><span class="line">    <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">        mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€æ¬¡è¢«è¯·æ±‚æ‰§è¡Œæµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶æ“ä½œï¼ŒdesiredWindowWidthå’ŒdesiredWindowHeightç­‰äºDisplay Sizeï¼Œå¦åˆ™mWinFrameä¿å­˜çš„å®½åº¦å’Œé«˜åº¦å€¼ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">            Point size = <span class="keyword">new</span> Point();</span><br><span class="line">            mDisplay.getRealSize(size);</span><br><span class="line">            desiredWindowWidth = size.x;</span><br><span class="line">            desiredWindowHeight = size.y;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Configuration config = mContext.getResources().getConfiguration();</span><br><span class="line">            desiredWindowWidth = dipToPx(config.screenWidthDp);</span><br><span class="line">            desiredWindowHeight = dipToPx(config.screenHeightDp);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        host.dispatchAttachedToWindow(mAttachInfo, <span class="number">0</span>);</span><br><span class="line">        mAttachInfo.mTreeObserver.dispatchOnWindowAttachedChange(<span class="keyword">true</span>);</span><br><span class="line">        dispatchApplyInsets(host);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œå½“desiredWindowWidth != mWidth || desiredWindowHeight != mHeightï¼Œè¯´æ˜Activityçª—å£çš„å¤§å°å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ—¶å€™windowSizeMayChange = trueï¼Œä»¥ä¾¿æ¥ä¸‹æ¥å¯¹Activityçª—å£å¤§å°å˜åŒ–è¿›è¡Œå¤„ç†</span></span><br><span class="line">        desiredWindowWidth = frame.width();</span><br><span class="line">        desiredWindowHeight = frame.height();</span><br><span class="line">        <span class="keyword">if</span> (desiredWindowWidth != mWidth || desiredWindowHeight != mHeight) &#123;</span><br><span class="line">            mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">            windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨æ¥è·å¾—Activityçª—å£çš„å½“å‰å®½åº¦desiredWindowWidthå’Œå½“å‰é«˜åº¦desiredWindowHeightã€‚</p><p>ç»§ç»­é˜…è¯»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java::performTraversals()]</span><br><span class="line"><span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line"><span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Resources res = mView.getContext().getResources();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//AttachInfoå¯¹è±¡ç”¨æ¥æè¿°Activityçª—å£çš„å±æ€§,mContentInsetså’ŒmVisibleInsetsåˆ†åˆ«ç”¨æ¥æè¿°Activityçª—å£çš„å½“å‰å†…å®¹è¾¹è¡¬å¤§å°å’Œå¯è§è¾¹è¡¬å¤§å°ã€‚</span></span><br><span class="line">        <span class="comment">//åˆ¤æ–­Activityçª—å£çš„OverscanInsetsã€ContentInsetsã€StableInsetsã€VisibleInsetså¤§å°æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (!mPendingOverscanInsets.equals(mAttachInfo.mOverscanInsets)) &#123;</span><br><span class="line">            insetsChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//WRAP_CONTENTè¡¨æ˜Activityçª—å£çš„å¤§å°è¦ç­‰äºå†…å®¹åŒºåŸŸçš„å¤§å°ï¼ŒåŒæ—¶ç­‰äºDisplay size</span></span><br><span class="line">        <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT</span><br><span class="line">                || lp.height == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">                Point size = <span class="keyword">new</span> Point();</span><br><span class="line">                mDisplay.getRealSize(size);</span><br><span class="line">                desiredWindowWidth = size.x;</span><br><span class="line">                desiredWindowHeight = size.y;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Configuration config = res.getConfiguration();</span><br><span class="line">                desiredWindowWidth = dipToPx(config.screenWidthDp);</span><br><span class="line">                desiredWindowHeight = dipToPx(config.screenHeightDp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Ask host how big it wants to be</span></span><br><span class="line">    <span class="comment">//çŸ¥é“äº†é¡¶å±‚Activityçª—å£å¤§å°ä»è€Œè®¡ç®—Activityå†…å„ä¸ªå­Viewçš„å¤§å°</span></span><br><span class="line">    windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">            desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨æ¥åœ¨Activityçª—å£ä¸»åŠ¨è¯·æ±‚WindowManagerServiceæœåŠ¡è®¡ç®—å¤§å°ä¹‹å‰ï¼Œå¯¹å®ƒçš„é¡¶å±‚è§†å›¾è¿›è¡Œä¸€æ¬¡æµ‹é‡æ“ä½œã€‚</p><p>ç»§ç»­é˜…è¯»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java::performTraversals()]</span><br><span class="line"> <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">        viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//relayoutWindowæ¥è¯·æ±‚WMSè®¡ç®—Activityçª—å£çš„å¤§å°ä»¥åŠxxxInsetså¤§å°ï¼Œå¹¶ä¿å­˜åœ¨PendingxxxInsetsä¸­</span></span><br><span class="line">        relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (contentInsetsChanged) &#123;</span><br><span class="line">            mAttachInfo.mContentInsets.set(mPendingContentInsets);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (visibleInsetsChanged) &#123;</span><br><span class="line">            mAttachInfo.mVisibleInsets.set(mPendingVisibleInsets);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//å°†è®¡ç®—å¾—åˆ°çš„Activityçª—å£çš„å·¦ä¸Šè§’åæ ‡ä¿å­˜åœ¨å˜é‡attachInfoæ‰€æŒ‡å‘çš„ä¸€ä¸ªAttachInfoå¯¹è±¡çš„æˆå‘˜å˜é‡mWindowLeftå’ŒmWindowTop</span></span><br><span class="line">    mAttachInfo.mWindowLeft = frame.left;</span><br><span class="line">    mAttachInfo.mWindowTop = frame.top;</span><br><span class="line">    <span class="comment">//å°†è®¡ç®—å¾—åˆ°çš„Activityçª—å£çš„å®½åº¦å’Œé«˜åº¦ä¿å­˜åœ¨ViewRootImplç±»çš„æˆå‘˜å˜é‡mWidthå’ŒmHeightä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (mWidth != frame.width() || mHeight != frame.height()) &#123;</span><br><span class="line">        mWidth = frame.width();</span><br><span class="line">        mHeight = frame.height();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸»è¦è°ƒç”¨relayoutWindow()æ¥è¯·æ±‚WMSè®¡ç®—Activityçª—å£çš„å¤§å°ä»¥åŠè¾¹å¿–xxxInsetså¤§å°ã€‚è®¡ç®—å®Œæ¯•ä¹‹åï¼Œåˆ†åˆ«ä¿å­˜åœ¨mPendingXXXInsetsä¸­ã€‚</p><p>ç»§ç»­é˜…è¯»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java::performTraversals()]</span><br><span class="line"> <span class="keyword">if</span> (!mStopped || mReportNextDraw) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</span><br><span class="line">                    (relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</span><br><span class="line">                    || mHeight != host.getMeasuredHeight() || contentInsetsChanged ||</span><br><span class="line">                    updatedConfiguration) &#123;</span><br><span class="line">                <span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</span><br><span class="line">                <span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</span><br><span class="line">                ......</span><br><span class="line">                 <span class="comment">// Ask host how big it wants to be</span></span><br><span class="line">                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">int</span> width = host.getMeasuredWidth();</span><br><span class="line">                <span class="keyword">int</span> height = host.getMeasuredHeight();</span><br><span class="line">                <span class="keyword">boolean</span> measureAgain = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (lp.horizontalWeight &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">                    width += (<span class="keyword">int</span>) ((mWidth - width) * lp.horizontalWeight);</span><br><span class="line">                    childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width,</span><br><span class="line">                            MeasureSpec.EXACTLY);</span><br><span class="line">                    measureAgain = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (lp.verticalWeight &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">                    height += (<span class="keyword">int</span>) ((mHeight - height) * lp.verticalWeight);</span><br><span class="line">                    childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height,</span><br><span class="line">                            MeasureSpec.EXACTLY);</span><br><span class="line">                    measureAgain = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (measureAgain) &#123;</span><br><span class="line">                    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                layoutRequested = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨æ¥æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æµ‹é‡Activityçª—å£çš„å¤§å°ã€‚</p><p>ç»è¿‡å‰é¢æ¼«é•¿çš„æ“ä½œåï¼ŒActivityçª—å£çš„å¤§å°æµ‹é‡å·¥ä½œç»ˆäºå°˜åŸƒè½å®šï¼Œè¿™æ—¶å€™å°±å¯ä»¥å¯¹Activityçª—å£çš„å†…å®¹è¿›è¡Œå¸ƒå±€ performLayout(lp, mWidth, mHeight)å’Œè¿›è¡Œç»˜ç”»äº†ï¼ŒperformDraw()ï¼Œç”±äºä¸»è¦å…³æ³¨Activityçª—å£å¤§å°è®¡ç®—è¿‡ç¨‹ï¼Œåœ¨æ­¤ä¸åšç»§ç»­åˆ†æã€‚</p><h3 id="2-2-2ã€ViewRootImpl-relayoutWindow"><a href="#2-2-2ã€ViewRootImpl-relayoutWindow" class="headerlink" title="2.2.2ã€ViewRootImpl.relayoutWindow()"></a>2.2.2ã€ViewRootImpl.relayoutWindow()</h3><p>é€šè¿‡è°ƒç”¨è¿™ä¸ªSessionå¯¹è±¡çš„æˆå‘˜å‡½æ•°relayout()æ¥è¯·æ±‚WindowManagerServiceæœåŠ¡è®¡ç®—Activityçª—å£çš„å¤§å°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(WindowManager.LayoutParams params, <span class="keyword">int</span> viewVisibility,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> insetsPending)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">int</span> relayoutResult = mWindowSession.relayout(</span><br><span class="line">            mWindow, mSeq, params,</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredWidth() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredHeight() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            viewVisibility, insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="number">0</span>,</span><br><span class="line">            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</span><br><span class="line">            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingConfiguration,</span><br><span class="line">            mSurface);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> relayoutResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š 1ã€mWindow ç”¨æ¥æ ‡å¿—è¦è®¡ç®—çš„æ˜¯å“ªä¸€ä¸ªActivityçª—å£çš„å¤§å°p 2ã€Activityçª—å£çš„é¡¶å±‚è§†å›¾ç»è¿‡æµ‹é‡åå¾—åˆ°çš„å®½åº¦å’Œé«˜åº¦ 3ã€Activityçª—å£çš„å¯è§çŠ¶æ€ï¼Œå³viewVisibility 4ã€Activityçª—å£æ˜¯å¦æœ‰é¢å¤–çš„å†…å®¹åŒºåŸŸè¾¹è¡¬å’Œå¯è§åŒºåŸŸè¾¹è¡¬ç­‰å¾…å‘Šè¯‰ç»™WindowManagerServiceæœåŠ¡ï¼Œå³å‚æ•°insetsPending 5ã€mWinFrameï¼Œè¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥ä¿å­˜WindowManagerServiceæœåŠ¡è®¡ç®—åå¾—åˆ°çš„Activityçª—å£çš„å¤§å° 6ã€mPendingOverscanInsetsç”¨æ¥ä¿å­˜Overscanè¾¹è¡¬ï¼ŒmPendingContentInsetsç”¨æ¥ä¿å­˜å†…å®¹åŒºåŸŸè¾¹è¡¬ï¼ŒmPendingVisibleInsetsç”¨æ¥ä¿å­˜å¯è§åŒºåŸŸè¾¹è¡¬ï¼ŒmPendingStableInsetsç”¨æ¥ä¿å­˜å¯èƒ½è¢«ç³»ç»ŸUIå…ƒç´ éƒ¨åˆ†æˆ–å®Œå…¨é®è”½çš„å…¨å±çª—å£åŒºåŸŸ 7ã€mPendingConfigurationï¼Œè¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥ä¿å­˜WindowManagerServiceæœåŠ¡è¿”å›æ¥çš„Activityçª—å£çš„é…ç½®ä¿¡æ¯ 8ã€mSurfaceï¼Œè¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥ä¿å­˜WindowManagerServiceæœåŠ¡è¿”å›æ¥çš„Activityçª—å£çš„ç»˜å›¾è¡¨é¢</p><h3 id="2-2-3ã€Session-relayout"><a href="#2-2-3ã€Session-relayout" class="headerlink" title="2.2.3ã€Session.relayout()"></a>2.2.3ã€Session.relayout()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Session.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = mService.relayoutWindow(<span class="keyword">this</span>, window, seq, attrs,</span><br><span class="line">            requestedWidth, requestedHeight, viewFlags, flags,</span><br><span class="line">            outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</span><br><span class="line">            outStableInsets, outsets, outBackdropFrame, outConfig, outSurface);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªæ˜¯è°ƒç”¨äº†WindowManagerServiceç±»çš„æˆå‘˜å‡½æ•°relayoutWindowæ¥è¿›ä¸€æ­¥è®¡ç®—å‚æ•°windowæ‰€æè¿°çš„ä¸€ä¸ªActivityçª—å“çš„å¤§å°</p><h3 id="2-2-4ã€WindowManagerService-relayoutWindow"><a href="#2-2-4ã€WindowManagerService-relayoutWindow" class="headerlink" title="2.2.4ã€WindowManagerService.relayoutWindow()"></a>2.2.4ã€WindowManagerService.relayoutWindow()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        WindowState win = windowForClientLocked(session, client, <span class="keyword">false</span>);</span><br><span class="line">        WindowStateAnimator winAnimator = win.mWinAnimator;</span><br><span class="line">        <span class="keyword">if</span> (viewVisibility != View.GONE) &#123;</span><br><span class="line">            win.setRequestedSize(requestedWidth, requestedHeight);</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">        <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPolicy.adjustWindowParamsLw(attrs);</span><br><span class="line">                ......</span><br><span class="line">        &#125;</span><br><span class="line">        win.setWindowScale(win.mRequestedWidth, win.mRequestedHeight);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (viewVisibility == View.VISIBLE &amp;&amp;</span><br><span class="line">                (win.mAppToken == <span class="keyword">null</span> || !win.mAppToken.clientHidden)) &#123;</span><br><span class="line">            result = relayoutVisibleWindow(outConfig, result, win, winAnimator, attrChanges,</span><br><span class="line">                    oldVisibility);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = createSurfaceControl(outSurface, result, win, winAnimator);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">            win.adjustStartingWindowFlags();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        mWindowPlacerLocked.performSurfacePlacement();</span><br><span class="line">        ......</span><br><span class="line">        outFrame.set(win.mCompatFrame);</span><br><span class="line">        outOverscanInsets.set(win.mOverscanInsets);</span><br><span class="line">        outContentInsets.set(win.mContentInsets);</span><br><span class="line">        outVisibleInsets.set(win.mVisibleInsets);</span><br><span class="line">        outStableInsets.set(win.mStableInsets);</span><br><span class="line">        outOutsets.set(win.mOutsets);</span><br><span class="line">        outBackdropFrame.set(win.getBackdropFrame(win.mFrame));</span><br><span class="line">        ......</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªå…³æ³¨relayoutWindowä¸­ä¸çª—å£å¤§å°è®¡ç®—æœ‰å…³çš„é€»è¾‘ï¼Œè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š 1ã€å‚æ•°requestedWidthå’ŒrequestedHeightæè¿°çš„æ˜¯åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚è®¾ç½®Activityçª—å£ä¸­çš„å®½åº¦å’Œé«˜åº¦ï¼Œå®ƒä»¬ä¼šè¢«è®°å½•åœ¨WindowStateå¯¹è±¡winçš„æˆå‘˜å˜é‡mRequestedWidthå’ŒmRequestedHeightä¸­ 2ã€WindowStateå¯¹è±¡winçš„æˆå‘˜å˜é‡mAttrsï¼Œå®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªWindowManager.LayoutParamså¯¹è±¡ï¼Œç”¨æ¥æè¿°Activityçª—å£çš„å¸ƒå±€å‚æ•° 3ã€è°ƒç”¨WindowSurfacePlacer.performSurfacePlacement()æ¥è®¡ç®—Activityçª—å£çš„å¤§å°ã€‚è®¡ç®—å®Œæˆä¹‹åï¼Œå‚æ•°clientæ‰€æè¿°çš„Activityçª—å£çš„å¤§å°ã€å†…å®¹åŒºåŸŸè¾¹è¡¬å¤§å°å’Œå¯è§åŒºåŸŸè¾¹è¾¹è¡¬å¤§å°å°±ä¼šåˆ†åˆ«ä¿å­˜åœ¨WindowStateå¯¹è±¡winçš„æˆå‘˜å˜é‡mCompatFrameã€mOverscanInsetsã€mContentInsetsã€mVisibleInsetsã€mStableInsetsã€mOutsetsä¸­ 4ã€ å°†WindowStateå¯¹è±¡winçš„æˆå‘˜å˜é‡mCompatFrameã€mOverscanInsetsã€mContentInsetsã€mVisibleInsetsã€mStableInsetsã€mOutsetsæ‹·è´èµ‹å€¼å¯¹åº”å˜é‡ä¸­ï¼Œä»¥ä¾¿å¯ä»¥è¿”å›ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹</p><p>ç»è¿‡ä¸Šè¿°4ä¸ªæ“ä½œåï¼ŒActivityçª—å£çš„å¤§å°è®¡ç®—è¿‡ç¨‹å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åˆ†æWindowSurfacePlacer.performSurfacePlacement()çš„å®ç°ï¼Œä»¥ä¾¿å¯ä»¥è¯¦ç»†äº†è§£Activityçª—å£çš„å¤§å°è®¡ç®—è¿‡ç¨‹</p><h3 id="2-2-5ã€WindowSurfacePlacer-performSurfacePlacement"><a href="#2-2-5ã€WindowSurfacePlacer-performSurfacePlacement" class="headerlink" title="2.2.5ã€WindowSurfacePlacer.performSurfacePlacement()"></a>2.2.5ã€WindowSurfacePlacer.performSurfacePlacement()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performSurfacePlacement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDeferDepth &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> loopCount = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">        performSurfacePlacementLoop();</span><br><span class="line">        mService.mH.removeMessages(DO_TRAVERSAL);</span><br><span class="line">        loopCount--;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mTraversalScheduled &amp;&amp; loopCount &gt; <span class="number">0</span>);</span><br><span class="line">    mWallpaperActionPending = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-6-WindowSurfacePlacer-performSurfacePlacementLoop"><a href="#2-2-6-WindowSurfacePlacer-performSurfacePlacementLoop" class="headerlink" title="2.2.6.WindowSurfacePlacer.performSurfacePlacementLoop()"></a>2.2.6.WindowSurfacePlacer.performSurfacePlacementLoop()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performSurfacePlacementLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       mInLayout = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">boolean</span> recoveringMemory = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mService.mForceRemoves.isEmpty()) &#123;</span><br><span class="line">            recoveringMemory = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (!mService.mForceRemoves.isEmpty()) &#123;</span><br><span class="line">                WindowState ws = mService.mForceRemoves.remove(<span class="number">0</span>);</span><br><span class="line">                mService.removeWindowInnerLocked(ws);</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        performSurfacePlacementInner(recoveringMemory);</span><br><span class="line"></span><br><span class="line">        mInLayout = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mService.needsLayout()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (++mLayoutRepeatCount &lt; <span class="number">6</span>) &#123;</span><br><span class="line">                requestTraversal();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Performed 6 layouts in a row. Skipping"</span>);</span><br><span class="line">                mLayoutRepeatCount = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mLayoutRepeatCount = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mService.mWindowsChanged &amp;&amp; !mService.mWindowChangeListeners.isEmpty()) &#123;</span><br><span class="line">            mService.mH.removeMessages(REPORT_WINDOWS_CHANGE);</span><br><span class="line">            mService.mH.sendEmptyMessage(REPORT_WINDOWS_CHANGE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        mInLayout = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨æˆå‘˜å‡½æ•°performSurfacePlacementInner()åˆ·æ–°ç³»ç»ŸUIçš„å‰å 1ã€æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨å¼ºåˆ¶åˆ é™¤çš„çª—å£ 2ã€æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦æœ‰çª—å£éœ€è¦ç§»é™¤</p><h3 id="2-2-7ã€WindowSurfacePlacer-performSurfacePlacementInner"><a href="#2-2-7ã€WindowSurfacePlacer-performSurfacePlacementInner" class="headerlink" title="2.2.7ã€WindowSurfacePlacer.performSurfacePlacementInner()"></a>2.2.7ã€WindowSurfacePlacer.performSurfacePlacementInner()</h3><p>ç»§ç»­åˆ†æçš„performSurfacePlacementInner()å®ç°ï¼Œä»¥ä¾¿å¯ä»¥äº†è§£Activityçª—å£çš„å¤§å°è®¡ç®—è¿‡ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performSurfacePlacementInner</span><span class="params">(<span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_WINDOW_TRACE) Slog.v(TAG, <span class="string">"performSurfacePlacementInner: entry. Called by "</span></span><br><span class="line">            + Debug.getCallers(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayContent defaultDisplay = mService.getDefaultDisplayContentLocked();</span><br><span class="line">    <span class="keyword">final</span> DisplayInfo defaultInfo = defaultDisplay.getDisplayInfo();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> defaultDw = defaultInfo.logicalWidth;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> defaultDh = defaultInfo.logicalHeight;</span><br><span class="line">    SurfaceControl.openTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        applySurfaceChangesTransaction(recoveringMemory, numDisplays, defaultDw, defaultDh);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Unhandled exception in Window Manager"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SurfaceControl.closeTransaction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> WindowList defaultWindows = defaultDisplay.getWindowList();</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mService.mPendingRemove.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mService.mPendingRemoveTmp.length &lt; N) &#123;</span><br><span class="line">                mService.mPendingRemoveTmp = <span class="keyword">new</span> WindowState[N+<span class="number">10</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            mService.mPendingRemove.toArray(mService.mPendingRemoveTmp);</span><br><span class="line">            mService.mPendingRemove.clear();</span><br><span class="line">            DisplayContentList displayList = <span class="keyword">new</span> DisplayContentList();</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                WindowState w = mService.mPendingRemoveTmp[i];</span><br><span class="line">                mService.removeWindowInnerLocked(w);</span><br><span class="line">                <span class="keyword">final</span> DisplayContent displayContent = w.getDisplayContent();</span><br><span class="line">                <span class="keyword">if</span> (displayContent != <span class="keyword">null</span> &amp;&amp; !displayList.contains(displayContent)) &#123;</span><br><span class="line">                    displayList.add(displayContent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (DisplayContent displayContent : displayList) &#123;</span><br><span class="line">                mService.mLayersController.assignLayersLocked(displayContent.getWindowList());</span><br><span class="line">                displayContent.layoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        mService.scheduleAnimationLocked();</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿›ä¸€æ­¥è°ƒç”¨applySurfaceChangesTransaction()æ–¹æ³•è¿›è¡Œè¿›ä¸€æ­¥è®¡ç®—</p><h3 id="2-2-8ã€WindowSurfacePlacer-applySurfaceChangesTransaction"><a href="#2-2-8ã€WindowSurfacePlacer-applySurfaceChangesTransaction" class="headerlink" title="2.2.8ã€WindowSurfacePlacer.applySurfaceChangesTransaction()"></a>2.2.8ã€WindowSurfacePlacer.applySurfaceChangesTransaction()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applySurfaceChangesTransaction</span><span class="params">(<span class="keyword">boolean</span> recoveringMemory, <span class="keyword">int</span> numDisplays,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> defaultDw, <span class="keyword">int</span> defaultDh)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">boolean</span> focusDisplayed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = <span class="number">0</span>; displayNdx &lt; numDisplays; ++displayNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> DisplayContent displayContent = mService.mDisplayContents.valueAt(displayNdx);</span><br><span class="line">        <span class="keyword">boolean</span> updateAllDrawn = <span class="keyword">false</span>;</span><br><span class="line">        WindowList windows = displayContent.getWindowList();</span><br><span class="line">        DisplayInfo displayInfo = displayContent.getDisplayInfo();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> displayId = displayContent.getDisplayId();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dw = displayInfo.logicalWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dh = displayInfo.logicalHeight;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> innerDw = displayInfo.appWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> innerDh = displayInfo.appHeight;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isDefaultDisplay = (displayId == Display.DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset for each display.</span></span><br><span class="line">        mDisplayHasContent = <span class="keyword">false</span>;</span><br><span class="line">        mPreferredRefreshRate = <span class="number">0</span>;</span><br><span class="line">        mPreferredModeId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> repeats = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            repeats++;</span><br><span class="line">            <span class="keyword">if</span> (repeats &gt; <span class="number">6</span>) &#123;<span class="comment">//æœ€å¤šæ‰§è¡Œ7æ¬¡çš„whileå¾ªç¯</span></span><br><span class="line">                displayContent.layoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é€šçŸ¥SurfaceFlingeræœåŠ¡äº†ï¼Œä¹Ÿå°±æ˜¯è®©SurfaceFlingeræœåŠ¡æ›´æ–°å®ƒé‡Œé¢çš„å„ä¸ªLayerçš„å±æ€§å€¼ï¼Œä»¥ä¾¿å¯ä»¥å¯¹è¿™äº›Layeræ‰§è¡Œå¯è§æ€§è®¡ç®—ã€åˆæˆç­‰æ“ä½œï¼Œæœ€åæ¸²æŸ“åˆ°ç¡¬ä»¶å¸§ç¼“å†²åŒºä¸­å»</span></span><br><span class="line">            <span class="keyword">if</span> ((displayContent.pendingLayoutChanges &amp; FINISH_LAYOUT_REDO_WALLPAPER) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    mWallpaperControllerLocked.adjustWallpaperWindows()) &#123;</span><br><span class="line">                mService.mLayersController.assignLayersLocked(windows);</span><br><span class="line">                displayContent.layoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">           ......</span><br><span class="line">            <span class="keyword">if</span> ((displayContent.pendingLayoutChanges &amp; FINISH_LAYOUT_REDO_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">                displayContent.layoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// FIRST LOOP: Perform a layout, if needed.</span></span><br><span class="line">            <span class="comment">//è®¡ç®—å„ä¸ªçª—å“çš„å¤§å°</span></span><br><span class="line">            <span class="keyword">if</span> (repeats &lt; LAYOUT_REPEAT_THRESHOLD) &#123;</span><br><span class="line">                performLayoutLockedInner(displayContent, repeats == <span class="number">1</span>,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* updateInputWindows */</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// FIRST AND ONE HALF LOOP: Make WindowManagerPolicy think</span></span><br><span class="line">            <span class="comment">// it is animating.</span></span><br><span class="line">            displayContent.pendingLayoutChanges = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">                mService.mPolicy.beginPostLayoutPolicyLw(dw, dh);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = windows.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                    WindowState w = windows.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (w.mHasSurface) &#123;</span><br><span class="line">                        mService.mPolicy.applyPostLayoutPolicyLw(w, w.mAttrs,</span><br><span class="line">                                w.mAttachedWindow);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                displayContent.pendingLayoutChanges |=</span><br><span class="line">                        mService.mPolicy.finishPostLayoutPolicyLw();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (displayContent.pendingLayoutChanges != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-9ã€WindowSurfacePlacer-applySurfaceChangesTransaction"><a href="#2-2-9ã€WindowSurfacePlacer-applySurfaceChangesTransaction" class="headerlink" title="2.2.9ã€WindowSurfacePlacer.applySurfaceChangesTransaction()"></a>2.2.9ã€WindowSurfacePlacer.applySurfaceChangesTransaction()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfacePlacer.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performLayoutLockedInner</span><span class="params">(<span class="keyword">final</span> DisplayContent displayContent,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> initial, <span class="keyword">boolean</span> updateInputWindows)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    displayContent.layoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">    WindowList windows = displayContent.getWindowList();</span><br><span class="line">    <span class="keyword">boolean</span> isDefaultDisplay = displayContent.isDefaultDisplay;</span><br><span class="line"></span><br><span class="line">    DisplayInfo displayInfo = displayContent.getDisplayInfo();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> dw = displayInfo.logicalWidth;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> dh = displayInfo.logicalHeight;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = windows.size();</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    mService.mPolicy.beginLayoutLw(isDefaultDisplay, dw, dh, mService.mRotation,</span><br><span class="line">            mService.mCurConfiguration.uiMode);</span><br><span class="line">    ......</span><br><span class="line">    displayContent.resize(mTmpContentRect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> seq = mService.mLayoutSeq+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (seq &lt; <span class="number">0</span>) seq = <span class="number">0</span>;</span><br><span class="line">    mService.mLayoutSeq = seq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> behindDream = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> topAttached = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = N-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState win = windows.get(i);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> gone = (behindDream &amp;&amp; mService.mPolicy.canBeForceHidden(win, win.mAttrs))</span><br><span class="line">                || win.isGoneForLayoutLw();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (!gone || !win.mHaveFrame || win.mLayoutNeeded</span><br><span class="line">                || ((win.isConfigChanged() || win.setReportResizeHints())</span><br><span class="line">                        &amp;&amp; !win.isGoneForLayoutLw() &amp;&amp;</span><br><span class="line">                        ((win.mAttrs.privateFlags &amp; PRIVATE_FLAG_KEYGUARD) != <span class="number">0</span> ||</span><br><span class="line">                        (win.mHasSurface &amp;&amp; win.mAppToken != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        win.mAppToken.layoutConfigChanges)))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!win.mLayoutAttached) &#123;</span><br><span class="line">                ......</span><br><span class="line">                win.mLayoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">                win.prelayout();</span><br><span class="line">                mService.mPolicy.layoutWindowLw(win, <span class="keyword">null</span>);</span><br><span class="line">                win.mLayoutSeq = seq;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Window frames may have changed. Update dim layer with the new bounds.</span></span><br><span class="line">                <span class="keyword">final</span> Task task = win.getTask();</span><br><span class="line">                <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    displayContent.mDimLayerController.updateDimLayer(task);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> attachedBehindDream = <span class="keyword">false</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (i = topAttached; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState win = windows.get(i);</span><br><span class="line">        <span class="keyword">if</span> (win.mLayoutAttached) &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> ((win.mViewVisibility != View.GONE &amp;&amp; win.mRelayoutCalled)</span><br><span class="line">                    || !win.mHaveFrame || win.mLayoutNeeded) &#123;</span><br><span class="line">                ......</span><br><span class="line">                win.mLayoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">                win.prelayout();</span><br><span class="line">                mService.mPolicy.layoutWindowLw(win, win.mAttachedWindow);</span><br><span class="line">                win.mLayoutSeq = seq;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (win.mAttrs.type == TYPE_DREAM) &#123;</span><br><span class="line">            attachedBehindDream = behindDream;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Window frames may have changed. Tell the input dispatcher about it.</span></span><br><span class="line">    mService.mInputMonitor.setUpdateInputWindowsNeededLw();</span><br><span class="line">    <span class="keyword">if</span> (updateInputWindows) &#123;</span><br><span class="line">        mService.mInputMonitor.updateInputWindowsLw(<span class="keyword">false</span> <span class="comment">/*force*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.mPolicy.finishLayoutLw();</span><br><span class="line">    mService.mH.sendEmptyMessage(UPDATE_DOCKED_STACK_DIVIDER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€mPolicyæŒ‡å‘çš„æ˜¯ä¸€ä¸ªçª—å£ç®¡ç†ç­–ç•¥ç±»ï¼Œå³PhoneWindowManagerå¯¹è±¡ï¼Œä¸»è¦æ˜¯ç”¨æ¥åˆ¶å®šçª—å£çš„å¤§å°è®¡ç®—ç­–ç•¥ 2ã€å‡†å¤‡é˜¶æ®µï¼šè°ƒç”¨PhoneWindowManager.beginLayoutLw()æ¥è®¾ç½®å±å¹•çš„å¤§å°ã€‚åŒ…æ‹¬NavigationBarã€StatusBarå¤§å°è®¡ç®— 3ã€è®¡ç®—é˜¶æ®µï¼šè°ƒç”¨PhoneWindowManager.layoutWindowLw()æ¥è®¡ç®—å„ä¸ªçª—å£çš„å¤§å°ã€å†…å®¹åŒºåŸŸè¾¹è¡¬å¤§å°ä»¥åŠå¯è§åŒºåŸŸè¾¹è¡¬å¤§å°ã€‚ 4ã€ç»“æŸé˜¶æ®µï¼šè°ƒç”¨PhoneWindowManagerç±»çš„æˆå‘˜å‡½æ•°finishLayoutLw()æ¥æ‰§è¡Œä¸€äº›æ¸…ç†å·¥ä½œã€‚</p><h3 id="2-2-10ã€PhoneWindowManager-beginLayoutLw"><a href="#2-2-10ã€PhoneWindowManager-beginLayoutLw" class="headerlink" title="2.2.10ã€PhoneWindowManager.beginLayoutLw()"></a>2.2.10ã€PhoneWindowManager.beginLayoutLw()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;PhoneWindowManager.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginLayoutLw</span><span class="params">(<span class="keyword">boolean</span> isDefaultDisplay, <span class="keyword">int</span> displayWidth, <span class="keyword">int</span> displayHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> displayRotation, <span class="keyword">int</span> uiMode)</span> </span>&#123;</span><br><span class="line">    mDisplayRotation = displayRotation;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> overscanLeft, overscanTop, overscanRight, overscanBottom;</span><br><span class="line">    <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (displayRotation) &#123;</span><br><span class="line">            <span class="keyword">case</span> Surface.ROTATION_90:</span><br><span class="line">                overscanLeft = mOverscanTop;</span><br><span class="line">                overscanTop = mOverscanRight;</span><br><span class="line">                overscanRight = mOverscanBottom;</span><br><span class="line">                overscanBottom = mOverscanLeft;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        overscanLeft = <span class="number">0</span>;</span><br><span class="line">        overscanTop = <span class="number">0</span>;</span><br><span class="line">        overscanRight = <span class="number">0</span>;</span><br><span class="line">        overscanBottom = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mOverscanScreenLeft = mRestrictedOverscanScreenLeft = <span class="number">0</span>;</span><br><span class="line">    mOverscanScreenTop = mRestrictedOverscanScreenTop = <span class="number">0</span>;</span><br><span class="line">    mOverscanScreenWidth = mRestrictedOverscanScreenWidth = displayWidth;</span><br><span class="line">    mOverscanScreenHeight = mRestrictedOverscanScreenHeight = displayHeight;</span><br><span class="line">    mSystemLeft = <span class="number">0</span>;</span><br><span class="line">    mSystemTop = <span class="number">0</span>;</span><br><span class="line">    mSystemRight = displayWidth;</span><br><span class="line">    mSystemBottom = displayHeight;</span><br><span class="line">    mUnrestrictedScreenLeft = overscanLeft;</span><br><span class="line">    mUnrestrictedScreenTop = overscanTop;</span><br><span class="line">    mUnrestrictedScreenWidth = displayWidth - overscanLeft - overscanRight;</span><br><span class="line">    mUnrestrictedScreenHeight = displayHeight - overscanTop - overscanBottom;</span><br><span class="line">    mRestrictedScreenLeft = mUnrestrictedScreenLeft;</span><br><span class="line">    mRestrictedScreenTop = mUnrestrictedScreenTop;</span><br><span class="line">    mRestrictedScreenWidth = mSystemGestures.screenWidth = mUnrestrictedScreenWidth;</span><br><span class="line">    mRestrictedScreenHeight = mSystemGestures.screenHeight = mUnrestrictedScreenHeight;</span><br><span class="line">    mDockLeft = mContentLeft = mVoiceContentLeft = mStableLeft = mStableFullscreenLeft</span><br><span class="line">            = mCurLeft = mUnrestrictedScreenLeft;</span><br><span class="line">    mDockTop = mContentTop = mVoiceContentTop = mStableTop = mStableFullscreenTop</span><br><span class="line">            = mCurTop = mUnrestrictedScreenTop;</span><br><span class="line">    mDockRight = mContentRight = mVoiceContentRight = mStableRight = mStableFullscreenRight</span><br><span class="line">            = mCurRight = displayWidth - overscanRight;</span><br><span class="line">    mDockBottom = mContentBottom = mVoiceContentBottom = mStableBottom = mStableFullscreenBottom</span><br><span class="line">            = mCurBottom = displayHeight - overscanBottom;</span><br><span class="line">    mDockLayer = <span class="number">0x10000000</span>;</span><br><span class="line">    mStatusBarLayer = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start with the current dock rect, which will be (0,0,displayWidth,displayHeight)</span></span><br><span class="line">    <span class="keyword">final</span> Rect pf = mTmpParentFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect df = mTmpDisplayFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect of = mTmpOverscanFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect vf = mTmpVisibleFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect dcf = mTmpDecorFrame;</span><br><span class="line">    pf.left = df.left = of.left = vf.left = mDockLeft;</span><br><span class="line">    pf.top = df.top = of.top = vf.top = mDockTop;</span><br><span class="line">    pf.right = df.right = of.right = vf.right = mDockRight;</span><br><span class="line">    pf.bottom = df.bottom = of.bottom = vf.bottom = mDockBottom;</span><br><span class="line">    dcf.setEmpty();  <span class="comment">// Decor frame N/A for system bars.</span></span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">        navVisible |= !canHideNavigationBar();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> updateSysUiVisibility = layoutNavigationBar(displayWidth, displayHeight,</span><br><span class="line">                displayRotation, uiMode, overscanLeft, overscanRight, overscanBottom, dcf, navVisible, navTranslucent,navAllowedHidden, statusBarExpandedNotKeyguard);</span><br><span class="line">        updateSysUiVisibility |= layoutStatusBar(pf, df, of, vf, dcf, sysui, isKeyguardShowing);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (updateSysUiVisibility) &#123;</span><br><span class="line">            updateSystemUiVisibilityLw();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€åˆå§‹åŒ–Overscanã€UnrestrictedScreenã€RestrictedScreenç­‰å±å¹•åŒºåŸŸå˜é‡ 2ã€è®¡ç®—NavigationBarå’ŒStatusBarå¤§å°</p><h3 id="2-2-11ã€PhoneWindowManager-layoutWindowLw"><a href="#2-2-11ã€PhoneWindowManager-layoutWindowLw" class="headerlink" title="2.2.11ã€PhoneWindowManager.layoutWindowLw()"></a>2.2.11ã€PhoneWindowManager.layoutWindowLw()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;PhoneWindowManager.java]</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layoutWindowLw</span><span class="params">(WindowState win, WindowState attached)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> fl = PolicyControl.getWindowFlags(win, attrs);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pfl = attrs.privateFlags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sim = attrs.softInputMode;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sysUiFl = PolicyControl.getSystemUiVisibility(win, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Rect pf = mTmpParentFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect df = mTmpDisplayFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect of = mTmpOverscanFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect cf = mTmpContentFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect vf = mTmpVisibleFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect dcf = mTmpDecorFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect sf = mTmpStableFrame;</span><br><span class="line">    Rect osf = <span class="keyword">null</span>;</span><br><span class="line">    dcf.setEmpty();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasNavBar = (isDefaultDisplay &amp;&amp; mHasNavigationBar</span><br><span class="line">            &amp;&amp; mNavigationBar != <span class="keyword">null</span> &amp;&amp; mNavigationBar.isVisibleLw());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> adjust = sim &amp; SOFT_INPUT_MASK_ADJUST;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">        sf.set(mStableLeft, mStableTop, mStableRight, mStableBottom);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sf.set(mOverscanLeft, mOverscanTop, mOverscanRight, mOverscanBottom);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isDefaultDisplay) &#123;</span><br><span class="line">        <span class="keyword">if</span> (attached != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If this window is attached to another, our display</span></span><br><span class="line">            <span class="comment">// frame is the same as the one we are attached to.</span></span><br><span class="line">            setAttachedWindowFrames(win, fl, adjust, attached, <span class="keyword">true</span>, pf, df, of, cf, vf);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Give the window full screen.</span></span><br><span class="line">            pf.left = df.left = of.left = cf.left = mOverscanScreenLeft;</span><br><span class="line">            pf.top = df.top = of.top = cf.top = mOverscanScreenTop;</span><br><span class="line">            pf.right = df.right = of.right = cf.right</span><br><span class="line">                    = mOverscanScreenLeft + mOverscanScreenWidth;</span><br><span class="line">            pf.bottom = df.bottom = of.bottom = cf.bottom</span><br><span class="line">                    = mOverscanScreenTop + mOverscanScreenHeight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; ......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    win.computeFrameLw(pf, df, of, cf, vf, dcf, sf, osf);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨WindowState.computeFrameLwæ¥è®¡ç®—çª—å£winçš„å…·ä½“å¤§å°äº†ã€‚è®¡ç®—çš„ç»“æœä¾¿å¾—åˆ°äº†çª—å£winçš„å¤§å°ï¼Œä»¥åŠå®ƒçš„å†…å®¹åŒºåŸŸè¾¹è¡¬å¤§å°å’Œå¯è§åŒºåŸŸè¾¹è¡¬å¤§å°ã€‚</p><h3 id="2-2-12ã€WindowState-computeFrameLw"><a href="#2-2-12ã€WindowState-computeFrameLw" class="headerlink" title="2.2.12ã€WindowState.computeFrameLw()"></a>2.2.12ã€WindowState.computeFrameLw()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowState.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeFrameLw</span><span class="params">(Rect pf, Rect df, Rect of, Rect cf, Rect vf, Rect dcf, Rect sf,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect osf)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> Task task = getTask();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> fullscreenTask = !isInMultiWindowMode();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> windowsAreFloating = task != <span class="keyword">null</span> &amp;&amp; task.isFloating();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> Rect layoutContainingFrame;</span><br><span class="line">    <span class="keyword">final</span> Rect layoutDisplayFrame;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The offset from the layout containing frame to the actual containing frame.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> layoutXDiff;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> layoutYDiff;</span><br><span class="line">    <span class="keyword">if</span> (fullscreenTask || layoutInParentFrame()) &#123;</span><br><span class="line">        <span class="comment">// We use the parent frame as the containing frame for fullscreen and child windows</span></span><br><span class="line">        mContainingFrame.set(pf);</span><br><span class="line">        mDisplayFrame.set(df);</span><br><span class="line">        layoutDisplayFrame = df;</span><br><span class="line">        layoutContainingFrame = pf;</span><br><span class="line">        layoutXDiff = <span class="number">0</span>;</span><br><span class="line">        layoutYDiff = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        task.getBounds(mContainingFrame);</span><br><span class="line">        ......</span><br><span class="line">        mDisplayFrame.set(mContainingFrame);</span><br><span class="line">        layoutXDiff = !mInsetFrame.isEmpty() ? mInsetFrame.left - mContainingFrame.left : <span class="number">0</span>;</span><br><span class="line">        layoutYDiff = !mInsetFrame.isEmpty() ? mInsetFrame.top - mContainingFrame.top : <span class="number">0</span>;</span><br><span class="line">        layoutContainingFrame = !mInsetFrame.isEmpty() ? mInsetFrame : mContainingFrame;</span><br><span class="line">        mTmpRect.set(<span class="number">0</span>, <span class="number">0</span>, mDisplayContent.getDisplayInfo().logicalWidth,</span><br><span class="line">                mDisplayContent.getDisplayInfo().logicalHeight);</span><br><span class="line">        subtractInsets(mDisplayFrame, layoutContainingFrame, df, mTmpRect);</span><br><span class="line">        ......</span><br><span class="line">        layoutDisplayFrame = df;</span><br><span class="line">        layoutDisplayFrame.intersect(layoutContainingFrame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pw = mContainingFrame.width();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> ph = mContainingFrame.height();</span><br><span class="line">    ......</span><br><span class="line">    mOverscanFrame.set(of);</span><br><span class="line">    mContentFrame.set(cf);</span><br><span class="line">    mVisibleFrame.set(vf);</span><br><span class="line">    mDecorFrame.set(dcf);</span><br><span class="line">    mStableFrame.set(sf);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasOutsets = osf != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> fw = mFrame.width();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> fh = mFrame.height();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (windowsAreFloating &amp;&amp; !mFrame.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> height = Math.min(mFrame.height(), mContentFrame.height());</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> width = Math.min(mContentFrame.width(), mFrame.width());</span><br><span class="line">        <span class="keyword">final</span> DisplayMetrics displayMetrics = getDisplayContent().getDisplayMetrics();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> minVisibleHeight = Math.min(height, WindowManagerService.dipToPixel(</span><br><span class="line">                MINIMUM_VISIBLE_HEIGHT_IN_DP, displayMetrics));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> minVisibleWidth = Math.min(width, WindowManagerService.dipToPixel(</span><br><span class="line">                MINIMUM_VISIBLE_WIDTH_IN_DP, displayMetrics));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> top = Math.max(mContentFrame.top,</span><br><span class="line">                Math.min(mFrame.top, mContentFrame.bottom - minVisibleHeight));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> left = Math.max(mContentFrame.left + minVisibleWidth - width,</span><br><span class="line">                Math.min(mFrame.left, mContentFrame.right - minVisibleWidth));</span><br><span class="line">        mFrame.set(left, top, left + width, top + height);</span><br><span class="line">        mContentFrame.set(mFrame);</span><br><span class="line">        mVisibleFrame.set(mContentFrame);</span><br><span class="line">        mStableFrame.set(mContentFrame);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mAttrs.type == TYPE_DOCK_DIVIDER) &#123;</span><br><span class="line">        mDisplayContent.getDockedDividerController().positionDockedStackedDivider(mFrame);</span><br><span class="line">        mContentFrame.set(mFrame);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mContentFrame.set(......);</span><br><span class="line"></span><br><span class="line">        mVisibleFrame.set(......);</span><br><span class="line"></span><br><span class="line">        mStableFrame.set(......);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fullscreenTask &amp;&amp; !windowsAreFloating) &#123;</span><br><span class="line">        <span class="comment">// Windows that are not fullscreen can be positioned outside of the display frame,</span></span><br><span class="line">        mOverscanInsets.set(......);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAttrs.type == TYPE_DOCK_DIVIDER) &#123;</span><br><span class="line">        mStableInsets.set(......);</span><br><span class="line">        mContentInsets.setEmpty();</span><br><span class="line">        mVisibleInsets.setEmpty();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        getDisplayContent().getLogicalDisplayRect(mTmpRect);</span><br><span class="line">        <span class="keyword">boolean</span> overrideRightInset = !fullscreenTask &amp;&amp; mFrame.right &gt; mTmpRect.right;</span><br><span class="line">        <span class="keyword">boolean</span> overrideBottomInset = !fullscreenTask &amp;&amp; mFrame.bottom &gt; mTmpRect.bottom;</span><br><span class="line">        mContentInsets.set(......);</span><br><span class="line"></span><br><span class="line">        mVisibleInsets.set(......);</span><br><span class="line"></span><br><span class="line">        mStableInsets.set(......);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Offset the actual frame by the amount layout frame is off.</span></span><br><span class="line">    mFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">    mCompatFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">    mContentFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">    mVisibleFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">    mStableFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line"></span><br><span class="line">    mCompatFrame.set(mFrame);</span><br><span class="line">    <span class="keyword">if</span> (mEnforceSizeCompat) &#123;</span><br><span class="line">        mOverscanInsets.scale(mInvGlobalScale);</span><br><span class="line">        mContentInsets.scale(mInvGlobalScale);</span><br><span class="line">        mVisibleInsets.scale(mInvGlobalScale);</span><br><span class="line">        mStableInsets.scale(mInvGlobalScale);</span><br><span class="line">        mOutsets.scale(mInvGlobalScale);</span><br><span class="line">        mCompatFrame.scale(mInvGlobalScale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªçª—å£å¤§å°ä¿å­˜åœ¨WindowStateç±»çš„æˆå‘˜å˜é‡mFrameä¸­ï¼Œè€Œçª—å“çš„å†…å®¹åŒºåŸŸè¾¹è¡¬å¤§å°å’Œå¯è§åŒºåŸŸè¾¹è¡¬å¤§å°åˆ†åˆ«ä¿åœ¨WindowStateç±»çš„æˆå‘˜å˜é‡mContentInsetså’ŒmVisibleInsetsä¸­</p><h3 id="2-2-13ã€PhoneWindowManager-finishLayoutLw"><a href="#2-2-13ã€PhoneWindowManager-finishLayoutLw" class="headerlink" title="2.2.13ã€PhoneWindowManager.finishLayoutLw()"></a>2.2.13ã€PhoneWindowManager.finishLayoutLw()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[WindowState.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishLayoutLw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆä¸‰ï¼‰ã€Window-Z-Order-è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹"><a href="#ï¼ˆä¸‰ï¼‰ã€Window-Z-Order-è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Window Z-Order è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹"></a>ï¼ˆä¸‰ï¼‰ã€Window Z-Order è®¡ç®—å’Œè°ƒæ•´è¿‡ç¨‹</h2><p>å£çš„UIæœ€ç»ˆæ˜¯éœ€è¦é€šè¿‡SurfaceFlingeræœåŠ¡æ¥ç»Ÿä¸€æ¸²æŸ“çš„ï¼Œè€ŒSurfaceFlingeræœåŠ¡åœ¨æ¸²æŸ“çª—å£çš„UIä¹‹å‰ï¼Œéœ€è¦è®¡ç®—åŸºäºå„ä¸ªçª—å£çš„Zè½´ä½ç½®æ¥è®¡ç®—å®ƒä»¬çš„å¯è§åŒºåŸŸã€‚å› æ­¤ï¼ŒWindowManagerServiceæœåŠ¡è®¡ç®—å¥½æ¯ä¸€ä¸ªçª—å£çš„Zè½´ä½ç½®ä¹‹åï¼Œè¿˜éœ€è¦å°†å®ƒä»¬è®¾ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»ï¼Œä»¥ä¾¿SurfaceFlingeræœåŠ¡å¯ä»¥æ­£ç¡®åœ°æ¸²æŸ“æ¯ä¸€ä¸ªçª—å£çš„UIã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/12-Android-WMS-Z-Order.png" alt="Markdown"></p><h3 id="3-1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯"><a href="#3-1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯" class="headerlink" title="3.1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯"></a>3.1ã€éœ€è¦é‡æ–°è®¡ç®—çª—å£Zè½´ä½ç½®çš„æƒ…æ™¯</h3><p>åœ¨ã€Android 7.1.2 (Android N) Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹åˆ†æã€‘ä¸­å·²ç»è¯¦ç»†ä»‹ç»Windowæ·»åŠ è¿‡ç¨‹ï¼Œè¿™é‡Œç›´æ¥ä» WMS.addWindowå¼€å§‹åˆ†æã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> addToken = <span class="keyword">false</span>;</span><br><span class="line">        WindowToken token = mTokenMap.get(attrs.token);</span><br><span class="line">        AppWindowToken atoken = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> addToastWindowRequiresToken = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        WindowState win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,</span><br><span class="line">                attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (addToken) &#123;</span><br><span class="line">            mTokenMap.put(attrs.token, token);</span><br><span class="line">        &#125;</span><br><span class="line">        win.attach();</span><br><span class="line">        mWindowMap.put(client.asBinder(), win);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> imMayMove = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type == TYPE_INPUT_METHOD) &#123;</span><br><span class="line">            win.mGivenInsetsPending = <span class="keyword">true</span>;</span><br><span class="line">            mInputMethodWindow = win;</span><br><span class="line">            addInputMethodWindowToListLocked(win);</span><br><span class="line">            imMayMove = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TYPE_INPUT_METHOD_DIALOG) &#123;</span><br><span class="line">            mInputMethodDialogs.add(win);</span><br><span class="line">            addWindowToListInOrderLocked(win, <span class="keyword">true</span>);</span><br><span class="line">            moveInputMethodDialogsLocked(findDesiredInputMethodWindowIndexLocked(<span class="keyword">true</span>));</span><br><span class="line">            imMayMove = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addWindowToListInOrderLocked(win, <span class="keyword">true</span>);</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//é‡æ–°è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®</span></span><br><span class="line">        mLayersController.assignLayersLocked(displayContent.getWindowList());</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WMS.relayoutWindow()ä¹Ÿä¼šè°ƒç”¨WindowLayersController.assignLayersLocked()é‡æ–°è®¡ç®—ã€è°ƒæ•´ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®ï¼Œç”±äºåŸç†ç±»ä¼¼è¿™é‡Œä¸åšè§£é‡Šã€‚</p><h3 id="3-2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®"><a href="#3-2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®" class="headerlink" title="3.2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®"></a>3.2ã€è®¡ç®—ç³»ç»Ÿä¸­æ‰€æœ‰çª—å£çš„Zè½´ä½ç½®</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡WindowStateç±»çš„æ„é€ å‡½æ•°æ¥åˆ†æä¸€ä¸ªçª—å£çš„BaseLayerå€¼æ˜¯å¦‚ä½•ç¡®å®š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[WindowState.java]</span><br><span class="line">WindowState(WindowManagerService service, Session s, IWindow c, WindowToken token,</span><br><span class="line">       WindowState attachedWindow, <span class="keyword">int</span> appOp, <span class="keyword">int</span> seq, WindowManager.LayoutParams a,</span><br><span class="line">       <span class="keyword">int</span> viewVisibility, <span class="keyword">final</span> DisplayContent displayContent) &#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((mAttrs.type &gt;= FIRST_SUB_WINDOW &amp;&amp;</span><br><span class="line">            mAttrs.type &lt;= LAST_SUB_WINDOW)) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//windowTypeToLayerLwçš„è¿”å›å€¼å¹¶ä¸”ä¸æ˜¯ä¸€ä¸ªçª—å£çš„æœ€ç»ˆçš„BaseLayerå€¼ï¼Œè€Œæ˜¯è¦å°†å®ƒçš„è¿”å›å€¼ä¹˜ä»¥ä¸€ä¸ªå¸¸é‡TYPE_LAYER_MULTIPLIERï¼Œå†åŠ ä¸Šå¦å¤–ä¸€ä¸ªå¸¸é‡TYPE_LAYER_OFFSETä¹‹åï¼Œæ‰å¾—åˆ°æœ€ç»ˆçš„BaseLayerå€¼</span></span><br><span class="line">        mBaseLayer = mPolicy.windowTypeToLayerLw(</span><br><span class="line">                attachedWindow.mAttrs.type) * WindowManagerService.TYPE_LAYER_MULTIPLIER</span><br><span class="line">                + WindowManagerService.TYPE_LAYER_OFFSET;</span><br><span class="line">        mSubLayer = mPolicy.subWindowTypeToLayerLw(a.type);</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªçª—å£é™¤äº†æœ‰ä¸€ä¸ªBaseLayerå€¼ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªSubLayerå€¼ï¼Œåˆ†åˆ«ä¿å­˜åœ¨ä¸€ä¸ªå¯¹åº”çš„WindowStateå¯¹è±¡çš„æˆå‘˜å˜é‡mBaseLayerå’ŒmSubLayerã€‚SubLayerå€¼æ˜¯ç”¨æ¥æè¿°ä¸€ä¸ªçª—å£æ˜¯å¦æ˜¯å¦å¤–ä¸€ä¸ªçª—å£çš„å­çª—å£çš„ã€‚ åœ¨ç»§ç»­åˆ†æWindowLayersController.assignLayersLocked()ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æPhoneWindowManager.windowTypeToLayerLw()å’ŒsubWindowTypeToLayerLw()çš„å®ç°ï¼Œä»¥ä¾¿å¯ä»¥äº†è§£ä¸€ä¸ªçª—å£çš„BaseLayerå€¼å’ŒSubLayerå€¼æ˜¯å¦‚ä½•ç¡®å®šçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;PhoneWindowManager.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">windowTypeToLayerLw</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (type &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; type &lt;= LAST_APPLICATION_WINDOW) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">   ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_SYSTEM_DIALOG:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_TOAST:</span><br><span class="line">        <span class="comment">// toasts and the plugged-in battery thing</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">   ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_SYSTEM_ALERT:</span><br><span class="line">        <span class="comment">// like the ANR / app crashed dialogs</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_STATUS_BAR_SUB_PANEL:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_STATUS_BAR:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_STATUS_BAR_PANEL:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">17</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_KEYGUARD_DIALOG:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">18</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_NAVIGATION_BAR:</span><br><span class="line">        <span class="comment">// the navigation bar, if available, shows atop most things</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">21</span>;</span><br><span class="line">    <span class="keyword">case</span> TYPE_NAVIGATION_BAR_PANEL:</span><br><span class="line">        <span class="comment">// some panels (e.g. search) need to show on top of the navigation bar</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">22</span>;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** &#123;<span class="doctag">@inheritDoc</span>&#125; */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">subWindowTypeToLayerLw</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> TYPE_APPLICATION_PANEL:</span><br><span class="line">    <span class="keyword">case</span> TYPE_APPLICATION_ATTACHED_DIALOG:</span><br><span class="line">        <span class="keyword">return</span> APPLICATION_PANEL_SUBLAYER;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> TYPE_APPLICATION_ABOVE_SUB_PANEL:</span><br><span class="line">        <span class="keyword">return</span> APPLICATION_ABOVE_SUB_PANEL_SUBLAYER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ ¹æ®ä¸åŒçš„Window Typeè¿”å›ä¸ä¸€æ ·çš„æ•°å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_LAYER_MULTIPLIER = <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_LAYER_OFFSET = <span class="number">1000</span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç”¨adb shell dumpsys window -a å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹Layerçš„æ•°å€¼ï¼Œå¯ä»¥çœ‹åˆ°StatusBarçš„æ•°å€¼è®¡ç®—ï¼š mBaseLayer = 16 _WindowManagerService.TYPE_LAYER_MULTIPLIER+ WindowManagerService.TYPE_LAYER<em>OFFSET StatusBar.mBaseLayer = 16</em> 10000 + 1000 = 161000 ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Window #4 Window&#123;3c1f1fb u0 StatusBar&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">161000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">161000</span>+<span class="number">0</span>=<span class="number">161000</span> mLastLayer=<span class="number">161000</span></span><br><span class="line">Window #3 Window&#123;fe4aae2 u0 KeyguardScrim&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">141000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">141000</span>+<span class="number">0</span>=<span class="number">141000</span> mLastLayer=<span class="number">141000</span></span><br><span class="line">Window #2 Window&#123;173ee76 u0 DockedStackDivider&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">21000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">21010</span>+<span class="number">0</span>=<span class="number">21010</span> mLastLayer=<span class="number">0</span></span><br><span class="line">Window #1 Window&#123;3a83a4a u0 com.android.launcher&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">21000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">21005</span>+<span class="number">0</span>=<span class="number">21005</span> mLastLayer=<span class="number">21005</span></span><br><span class="line">Window #0 Window&#123;aefb7bc u0 com.android.systemui.ImageWallpaper&#125;:</span><br><span class="line">  mBaseLayer=<span class="number">21000</span> mSubLayer=<span class="number">0</span> mAnimLayer=<span class="number">21000</span>+<span class="number">0</span>=<span class="number">21000</span> mLastLayer=<span class="number">21000</span></span><br></pre></td></tr></table></figure><p>ç†è§£äº†çª—å£çš„BaseLayerå€¼å’ŒSubLayerå€¼çš„è®¡ç®—è¿‡ç¨‹ä¹‹å¤–ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥åˆ†æWindowManagerServiceç±»çš„æˆå‘˜å‡½æ•°assignLayersLocked()çš„å®ç°äº†</p><h3 id="3-2-1ã€WindowLayersController-assignLayersLocked"><a href="#3-2-1ã€WindowLayersController-assignLayersLocked" class="headerlink" title="3.2.1ã€WindowLayersController.assignLayersLocked()"></a>3.2.1ã€WindowLayersController.assignLayersLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowLayersController.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">assignLayersLocked</span><span class="params">(WindowList windows)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_LAYERS) Slog.v(TAG_WM, <span class="string">"Assigning layers based on windows="</span> + windows,</span><br><span class="line">            <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</span><br><span class="line">    clear();</span><br><span class="line">    <span class="keyword">int</span> curBaseLayer = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> curLayer = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> anyLayerChanged = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, windowCount = windows.size(); i &lt; windowCount; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState w = windows.get(i);</span><br><span class="line">        <span class="keyword">boolean</span> layerChanged = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> oldLayer = w.mLayer;</span><br><span class="line">        <span class="keyword">if</span> (w.mBaseLayer == curBaseLayer || w.mIsImWindow || (i &gt; <span class="number">0</span> &amp;&amp; w.mIsWallpaper)) &#123;</span><br><span class="line">            curLayer += WINDOW_LAYER_MULTIPLIER;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            curBaseLayer = curLayer = w.mBaseLayer;</span><br><span class="line">        &#125;</span><br><span class="line">        assignAnimLayer(w, curLayer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Preserved old behavior of code here but not sure comparing</span></span><br><span class="line">        <span class="comment">// oldLayer to mAnimLayer and mLayer makes sense...though the</span></span><br><span class="line">        <span class="comment">// worst case would be unintentionalp layer reassignment.</span></span><br><span class="line">        <span class="keyword">if</span> (w.mLayer != oldLayer || w.mWinAnimator.mAnimLayer != oldLayer) &#123;</span><br><span class="line">            layerChanged = <span class="keyword">true</span>;</span><br><span class="line">            anyLayerChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (w.mAppToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mHighestApplicationLayer = Math.max(mHighestApplicationLayer,</span><br><span class="line">                    w.mWinAnimator.mAnimLayer);</span><br><span class="line">        &#125;</span><br><span class="line">        collectSpecialWindows(w);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (layerChanged) &#123;</span><br><span class="line">            w.scheduleAnimationIfDimming();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    adjustSpecialWindows();</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ assignAnimLayer() è¿›è¡ŒLayerè°ƒæ•´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowLayersController.java]</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assignAnimLayer</span><span class="params">(WindowState w, <span class="keyword">int</span> layer)</span> </span>&#123;</span><br><span class="line">        w.mLayer = layer;</span><br><span class="line">        w.mWinAnimator.mAnimLayer = w.mLayer + w.getAnimLayerAdjustment() +</span><br><span class="line">                    getSpecialWindowAnimLayerAdjustment(w);</span><br><span class="line">        <span class="keyword">if</span> (w.mAppToken != <span class="keyword">null</span> &amp;&amp; w.mAppToken.mAppAnimator.thumbnailForceAboveLayer &gt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; w.mWinAnimator.mAnimLayer &gt; w.mAppToken.mAppAnimator.thumbnailForceAboveLayer) &#123;</span><br><span class="line">            w.mAppToken.mAppAnimator.thumbnailForceAboveLayer = w.mWinAnimator.mAnimLayer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="3-3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»"><a href="#3-3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»" class="headerlink" title="3.3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»"></a>3.3ã€è®¾ç½®çª—å£çš„Zè½´ä½ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»</h3><p>WindowManagerServiceæœåŠ¡åœ¨åˆ·æ–°ç³»ç»Ÿçš„UIçš„æ—¶å€™ï¼Œå°±ä¼šå°†ç³»ç»Ÿä¸­å·²ç»è®¡ç®—å¥½äº†çš„çª—å£Zè½´ä½ç½®è®¾ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»ï¼Œä»¥ä¾¿SurfaceFlingeræœåŠ¡å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„çª—å£è¿›è¡Œå¯è§æ€§è®¡ç®—ä»¥åŠåˆæˆå’Œæ¸²æŸ“ç­‰æ“ä½œ é¦–å…ˆçœ‹ä¸€ä¸‹å †æ ˆä¿¡æ¯ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">WindowSurfaceController.showSurface()æ·»åŠ æ‰“å°Log</span><br><span class="line">Slog.i(<span class="string">"zhoujinjian"</span>, <span class="string">"zhoujinjian"</span>,<span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>): zhoujinjian</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>): java.lang.RuntimeException: here</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowSurfaceController.showSurface(WindowSurfaceController.java:<span class="number">414</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowSurfaceController.updateVisibility(WindowSurfaceController.java:<span class="number">402</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowSurfaceController.showRobustlyInTransaction(WindowSurfaceController.java:<span class="number">391</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowStateAnimator.showSurfaceRobustlyLocked(WindowStateAnimator.java:<span class="number">1814</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowStateAnimator.prepareSurfaceLocked(WindowStateAnimator.java:<span class="number">1609</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowAnimator.animateLocked(WindowAnimator.java:<span class="number">791</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowAnimator.-wrap0(WindowAnimator.java)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.wm.WindowAnimator$<span class="number">1.</span>doFrame(WindowAnimator.java:<span class="number">166</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.view.Choreographer$CallbackRecord.run(Choreographer.java:<span class="number">879</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.view.Choreographer.doCallbacks(Choreographer.java:<span class="number">693</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.view.Choreographer.doFrame(Choreographer.java:<span class="number">625</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:<span class="number">867</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.os.Handler.handleCallback(Handler.java:<span class="number">751</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">95</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.os.Looper.loop(Looper.java:<span class="number">154</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at android.os.HandlerThread.run(HandlerThread.java:<span class="number">61</span>)</span><br><span class="line"><span class="number">03</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">06</span>:<span class="number">45.229</span>: I/zhoujinjian(<span class="number">1424</span>):     at com.android.server.ServiceThread.run(ServiceThread.java:<span class="number">46</span>)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†äº†è§£WMSæ˜¯å¦‚ä½•å°†Zè½´ä½ç½®è®¾ç½®åˆ°SurfaceFlingeræœåŠ¡ä¸­å»ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹WMSæ„é€ æ–¹æ³•ä¸­å…³é”®å¯¹è±¡WindowAnimatorçš„åˆ›å»º</p><h3 id="3-3-1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹"><a href="#3-3-1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹" class="headerlink" title="3.3.1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹"></a>3.3.1ã€Vsyncåˆ·æ–°UIå›è°ƒè¿‡ç¨‹</h3><p>å¼€æœºå¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–WMSã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">WindowManagerService</span><span class="params">(Context context, InputManagerService inputManager,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> haveInputMethods, <span class="keyword">boolean</span> showBootMsgs, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mAnimator = <span class="keyword">new</span> WindowAnimator(<span class="keyword">this</span>);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨WindowAnimatoræ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line">WindowAnimator(<span class="keyword">final</span> WindowManagerService service) &#123;</span><br><span class="line">    mService = service;</span><br><span class="line">    mContext = service.mContext;</span><br><span class="line">    mPolicy = service.mPolicy;</span><br><span class="line">    mWindowPlacerLocked = service.mWindowPlacerLocked;</span><br><span class="line"></span><br><span class="line">    mAnimationFrameCallback = <span class="keyword">new</span> Choreographer.FrameCallback() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNs)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mService.mWindowMap) &#123;</span><br><span class="line">                mService.mAnimationScheduled = <span class="keyword">false</span>;</span><br><span class="line">                animateLocked(frameTimeNs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆ›å»ºäº†Choreographer.FrameCallback()ï¼Œå‰é¢åœ¨ã€Android-7-1-2-Android-N-Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹ã€‘åˆ†æè¿‡ï¼ŒFrameDisplayEventReceiverï¼ˆåœ¨Choreographeræ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ï¼‰å¯¹è±¡ç”¨äºè¯·æ±‚å¹¶æ¥æ”¶Vsyncä¿¡å·ï¼Œå½“Vsyncä¿¡å·åˆ°æ¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨å…¶onVsync()å‡½æ•°ï¼Œåé¢ä¼šå›è°ƒåˆ°FrameDisplayEventReceiver.run()æ–¹æ³•ï¼Œå†å›è°ƒå‡½æ•°ä¸­æ‰§è¡ŒdoFrame()å®ç°å±å¹•åˆ·æ–°ï¼ŒdoFrame()ä¼šé¡ºåºæ‰§è¡ŒCALLBACK_INPUTã€CALLBACK_ANIMATIONã€CALLBACK_TRAVERSAL å’ŒCALLBACK_COMMIT å¯¹åº”CallbackQueueé˜Ÿåˆ—ä¸­æ³¨å†Œçš„å›è°ƒï¼Œä»è€Œä¼šæ‰§è¡ŒCallbackRecord.run()ï¼Œåœ¨æ‰§è¡Œå…¶å›è°ƒå‡½æ•°æ—¶ï¼Œå°±éœ€è¦åŒºåˆ«è¿™ä¸¤ç§å¯¹è±¡ç±»å‹ï¼Œå¦‚æœæ³¨å†Œçš„æ˜¯Runnableå¯¹è±¡ï¼Œåˆ™è°ƒç”¨å…¶run()å‡½æ•°ï¼Œå¦‚æœæ³¨å†Œçš„æ˜¯FrameCallbackå¯¹è±¡ï¼Œåˆ™è°ƒç”¨å®ƒçš„doFrame()å‡½æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Choreographer.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackRecord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> CallbackRecord next;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> dueTime;</span><br><span class="line">    <span class="keyword">public</span> Object action; <span class="comment">// Runnable or FrameCallback</span></span><br><span class="line">    <span class="keyword">public</span> Object token;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (token == FRAME_CALLBACK_TOKEN) &#123;</span><br><span class="line">            ((FrameCallback)action).doFrame(frameTimeNanos);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ((Runnable)action).run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ç§æƒ…å†µä¸‹ä¼šæ‰§è¡ŒFrameCallbackå¯¹è±¡çš„doFrame()å‡½æ•°ï¼ˆåŸå› ç¨åå†åˆ†æåŠ¨ç”»æ—¶è¯¦ç»†åˆ†æï¼‰ï¼Œç”±WindowAnimatoræ„é€ å‡½æ•°ä¸­å¯çŸ¥æ¥ç€å°±ä¼šæ‰§è¡ŒWindowAnimator.animateLocked()</p><h3 id="3-3-2ã€å‡†å¤‡åˆ·æ–°UI"><a href="#3-3-2ã€å‡†å¤‡åˆ·æ–°UI" class="headerlink" title="3.3.2ã€å‡†å¤‡åˆ·æ–°UI"></a>3.3.2ã€å‡†å¤‡åˆ·æ–°UI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">animateLocked</span><span class="params">(<span class="keyword">long</span> frameTimeNs)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">                TAG, <span class="string">"&gt;&gt;&gt; OPEN TRANSACTION animateLocked"</span>);</span><br><span class="line">        SurfaceControl.openTransaction();</span><br><span class="line">        SurfaceControl.setAnimationTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mDisplayContentsAnimators.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDisplays; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplayContentsAnimators.keyAt(i);</span><br><span class="line">                updateAppWindowsLocked(displayId);</span><br><span class="line">                DisplayContentsAnimator displayAnimator = mDisplayContentsAnimators.valueAt(i);</span><br><span class="line">                ......</span><br><span class="line">                updateWindowsLocked(displayId);</span><br><span class="line">                updateWallpaperLocked(displayId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> WindowList windows = mService.getWindowListLocked(displayId);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = windows.size();</span><br><span class="line">                <span class="comment">//é€šè¿‡ä¸€ä¸ªforå¾ªç¯æ¥éå†ä¿å­˜åœ¨çª—å£å †æ ˆçš„æ¯ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªçª—å£çš„ç»˜å›¾è¡¨é¢è¿›è¡Œæ›´æ–°</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++) &#123;</span><br><span class="line">                    windows.get(j).mWinAnimator.prepareSurfaceLocked(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            SurfaceControl.closeTransaction();</span><br><span class="line">            <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">                    TAG, <span class="string">"&lt;&lt;&lt; CLOSE TRANSACTION animateLocked"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–windowsåˆ—è¡¨ï¼Œç„¶åå¾ªç¯è°ƒç”¨windows.get(j).mWinAnimator.prepareSurfaceLocked(true)ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepareSurfaceLocked</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WindowState w = mWin;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> displayed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯</span></span><br><span class="line">    computeShownFrameLocked();</span><br><span class="line"></span><br><span class="line">    setSurfaceBoundariesLocked(recoveringMemory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsWallpaper &amp;&amp; !mWin.mWallpaperVisible) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (w.mAttachedHidden || !w.isOnScreen()) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLastLayer != mAnimLayer</span><br><span class="line">            || mLastAlpha != mShownAlpha</span><br><span class="line">            || mLastDsDx != mDsDx</span><br><span class="line">            || mLastDtDx != mDtDx</span><br><span class="line">            || mLastDsDy != mDsDy</span><br><span class="line">            || mLastDtDy != mDtDy</span><br><span class="line">            || w.mLastHScale != w.mHScale</span><br><span class="line">            || w.mLastVScale != w.mVScale</span><br><span class="line">            || mLastHidden) &#123;</span><br><span class="line">        displayed = <span class="keyword">true</span>;</span><br><span class="line">        mLastAlpha = mShownAlpha;</span><br><span class="line">        mLastLayer = mAnimLayer;</span><br><span class="line">        mLastDsDx = mDsDx;</span><br><span class="line">        mLastDtDx = mDtDx;</span><br><span class="line">        mLastDsDy = mDsDy;</span><br><span class="line">        mLastDtDy = mDtDy;</span><br><span class="line">        w.mLastHScale = w.mHScale;</span><br><span class="line">        w.mLastVScale = w.mVScale;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">boolean</span> prepared =</span><br><span class="line">            mSurfaceController.prepareToShowInTransaction(mShownAlpha, mAnimLayer,</span><br><span class="line">                    mDsDx * w.mHScale * mExtraHScale,</span><br><span class="line">                    mDtDx * w.mVScale * mExtraVScale,</span><br><span class="line">                    mDsDy * w.mHScale * mExtraHScale,</span><br><span class="line">                    mDtDy * w.mVScale * mExtraVScale,</span><br><span class="line">                    recoveringMemory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prepared &amp;&amp; mLastHidden &amp;&amp; mDrawState == HAS_DRAWN) &#123;</span><br><span class="line">            <span class="keyword">if</span> (showSurfaceRobustlyLocked()) &#123;</span><br><span class="line">                markPreservedSurfaceForDestroy();</span><br><span class="line">                mAnimator.requestRemovalOfReplacedWindows(w);</span><br><span class="line">                mLastHidden = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (mIsWallpaper) &#123;</span><br><span class="line">                    mWallpaperControllerLocked.dispatchWallpaperVisibility(w, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                mAnimator.setPendingLayoutChanges(w.getDisplayId(),</span><br><span class="line">                        WindowManagerPolicy.FINISH_LAYOUT_REDO_ANIM);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                w.mOrientationChanging = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasSurface()) &#123;</span><br><span class="line">            w.mToken.hasVisible = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        displayed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨prepareToShowInTransaction()å°†alphã€alayerã€setMatrixè®¾ç½®åˆ°mSurfaceControlä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">boolean prepareToShowInTransaction(float alpha, int layer, float dsdx, float dtdx, float dsdy,</span><br><span class="line">           float dtdy, boolean recoveringMemory) &#123;</span><br><span class="line">       if (mSurfaceControl != null) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               mSurfaceAlpha = alpha;</span><br><span class="line">               mSurfaceControl.setAlpha(alpha);</span><br><span class="line">               mSurfaceLayer = layer;</span><br><span class="line">               mSurfaceControl.setLayer(layer);</span><br><span class="line">               mSurfaceControl.setMatrix(</span><br><span class="line">                       dsdx, dtdx, dsdy, dtdy);</span><br><span class="line"></span><br><span class="line">           &#125; catch (RuntimeException e) &#123;</span><br><span class="line">               .......</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>setSurfaceBoundariesLocked()æ–¹æ³•ä¸­ä¼šè°ƒç”¨SurfaceControl.setPosition()ç­‰ç­‰æ–¹æ³•å°†è®¡ç®—å¥½çš„æ•°å€¼è®¾ç½®åˆ°mSurfaceControlä¸­ã€‚ è¯´æ˜ï¼šä¸€ä¸ªçª—å£çš„æ˜¾ç¤ºå’Œéšè—ï¼Œä»¥åŠå¤§å°ã€Xè½´å’ŒYè½´ä½ç½®ã€Zè½´ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µè®¾ç½®ï¼Œæ˜¯é€šè¿‡è°ƒç”¨Javaå±‚çš„SurfaceControlç±»çš„æˆå‘˜å‡½æ•°showã€hideã€setSizeã€setPositionã€setLayerã€setAlphaå’ŒsetMatrixæ¥å®ç°çš„ï¼Œå®ƒä»¬æœ€ç»ˆéƒ½æ˜¯é€šè¿‡è°ƒç”¨JNIæ–¹æ³•å®ç°çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SurfaceControl.java</span><br><span class="line">......</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlpha</span><span class="params">(<span class="keyword">float</span> alpha)</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    nativeSetAlpha(mNativeObject, alpha);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMatrix</span><span class="params">(<span class="keyword">float</span> dsdx, <span class="keyword">float</span> dtdx, <span class="keyword">float</span> dsdy, <span class="keyword">float</span> dtdy)</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    nativeSetMatrix(mNativeObject, dsdx, dtdx, dsdy, dtdy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowCrop</span><span class="params">(Rect crop)</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    <span class="keyword">if</span> (crop != <span class="keyword">null</span>) &#123;</span><br><span class="line">        nativeSetWindowCrop(mNativeObject,</span><br><span class="line">            crop.left, crop.top, crop.right, crop.bottom);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeSetWindowCrop(mNativeObject, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFinalCrop</span><span class="params">(Rect crop)</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    <span class="keyword">if</span> (crop != <span class="keyword">null</span>) &#123;</span><br><span class="line">        nativeSetFinalCrop(mNativeObject,</span><br><span class="line">            crop.left, crop.top, crop.right, crop.bottom);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeSetFinalCrop(mNativeObject, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure><h3 id="3-3-3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI"><a href="#3-3-3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI" class="headerlink" title="3.3.3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI"></a>3.3.3ã€å‘ŠçŸ¥SurfaceFlingeræ˜¾ç¤ºUI</h3><p>å¦‚æœWindowStateå¯¹è±¡wæ‰€æè¿°çš„çª—å£æ»¡è¶³æ¡ä»¶ï¼šprepared &amp;&amp; mLastHidden &amp;&amp; mDrawState == HAS_DRAWN é‚£ä¹ˆå°±è¯´æ˜ç°åœ¨æ˜¯æ—¶å€™è¦å°†WindowStateå¯¹è±¡wæ‰€æè¿°çš„çª—å£æ˜¾ç¤ºå‡ºæ¥äº†ï¼Œé€šè¿‡è°ƒç”¨showSurfaceRobustlyLockedå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">showSurfaceRobustlyLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Task task = mWin.getTask();</span><br><span class="line">    <span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; StackId.windowsAreScaleable(task.mStack.mStackId)) &#123;</span><br><span class="line">        mSurfaceController.forceScaleableInTransaction(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> shown = mSurfaceController.showRobustlyInTransaction();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mWin.mTurnOnScreen) &#123;</span><br><span class="line">        ......</span><br><span class="line">        mWin.mTurnOnScreen = <span class="keyword">false</span>;</span><br><span class="line">        mAnimator.mBulkUpdateParams |= SET_TURN_ON_SCREEN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨WindowSurfaceController.showRobustlyInTransaction() â€“&gt; updateVisibility()â€“&gt;showSurface()-&gt;SurfaceControl.show()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowSurfaceController.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">showRobustlyInTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mHiddenForOtherReasons = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> updateVisibility();</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateVisibility</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mHiddenForCrop || mHiddenForOtherReasons) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSurfaceShown) &#123;hideSurface();&#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSurfaceShown) &#123;<span class="keyword">return</span> showSurface();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">showSurface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mSurfaceShown = <span class="keyword">true</span>;</span><br><span class="line">            mSurfaceControl.show();</span><br><span class="line">             Slog.i(<span class="string">"zhoujinjian"</span>, <span class="string">"zhoujinjian"</span>,<span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‡ºç°å¼‚å¸¸,å›æ”¶ç³»ç»Ÿå†…å­˜èµ„æº</span></span><br><span class="line">        mAnimator.reclaimSomeSurfaceMemory(<span class="string">"show"</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;SurfaceControl.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkNotReleased();</span><br><span class="line">    nativeSetFlags(mNativeObject, <span class="number">0</span>, SURFACE_HIDDEN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡JNIè°ƒç”¨android_view_SurfaceControl.cppçš„nativeSetFlagså‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°flags == 0ï¼›</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;android_view_SurfaceControl.cpp]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeSetFlags</span><span class="params">(JNIEnv* env, jclass clazz, jlong nativeObject, jint flags, jint mask)</span> </span>&#123;</span><br><span class="line">    SurfaceControl* <span class="keyword">const</span> ctrl = <span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(nativeObject);</span><br><span class="line">    <span class="keyword">status_t</span> err = ctrl-&gt;setFlags(flags, mask);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span> &amp;&amp; err != NO_INIT) &#123;</span><br><span class="line">        doThrowIAE(env);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨SurfaceControl.cppçš„setFlags()å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;SurfaceControl.cpp]</span><br><span class="line"><span class="keyword">status_t</span> SurfaceControl::setFlags(<span class="keyword">uint32_t</span> flags, <span class="keyword">uint32_t</span> mask) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> err = validate();</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) <span class="keyword">return</span> err;</span><br><span class="line">    <span class="keyword">return</span> mClient-&gt;setFlags(mHandle, flags, mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥é€šè¿‡Binder IPCæœºåˆ¶ï¼ŒSurfaceComposerClient.cpp-&gt;Composer::setFlags()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;SurfaceComposerClient.cpp]</span><br><span class="line"><span class="keyword">status_t</span> Composer::setFlags(<span class="keyword">const</span> sp&lt;SurfaceComposerClient&gt;&amp; client,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; id, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">        <span class="keyword">uint32_t</span> mask) &#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="keyword">layer_state_t</span>* s = getLayerStateLocked(client, id);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ((mask &amp; <span class="keyword">layer_state_t</span>::eLayerOpaque) ||</span><br><span class="line">            (mask &amp; <span class="keyword">layer_state_t</span>::eLayerHidden) ||</span><br><span class="line">            (mask &amp; <span class="keyword">layer_state_t</span>::eLayerSecure)) &#123;</span><br><span class="line">        s-&gt;what |= <span class="keyword">layer_state_t</span>::eFlagsChanged;</span><br><span class="line">    &#125;</span><br><span class="line">    s-&gt;flags &amp;= ~mask;</span><br><span class="line">    s-&gt;flags |= (flags &amp; mask);</span><br><span class="line">    s-&gt;mask |= mask;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“æ•°å€¼å°±ä¸è¯¦ç»†è®¡ç®—äº†ï¼Œå‰é¢åˆ†æã€Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿåˆ†æ [i.wonder~]ã€‘å¯çŸ¥ï¼ŒSurfaceFlingeræ¥æ”¶Vsyncä¿¡å·ä¸Appæœ‰ä¸€ä¸ªoffseté—´éš”æ—¶é—´ï¼Œå½“SurfaceFlingeræ¥æ”¶Vsyncä¿¡å·æ—¶ï¼Œå°±å¯ä»¥æ ¹æ®flagsæ˜¯å¦æ˜¾ç¤º å’Œ ä¸Šé¢è®¾ç½®çš„ä¸€ç³»åˆ—æ•°å€¼è¿›è¡Œæ¸²æŸ“åˆæˆï¼Œæœ€ç»ˆæ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚</p><h2 id="ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£-Starting-Window-æ·»åŠ è¿‡ç¨‹"><a href="#ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£-Starting-Window-æ·»åŠ è¿‡ç¨‹" class="headerlink" title="ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£(Starting Window)æ·»åŠ è¿‡ç¨‹"></a>ï¼ˆå››ï¼‰ã€Activityå¯åŠ¨çª—å£(Starting Window)æ·»åŠ è¿‡ç¨‹</h2><h3 id="4-1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£-Starting-Window-çš„æ·»åŠ è¿‡ç¨‹"><a href="#4-1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£-Starting-Window-çš„æ·»åŠ è¿‡ç¨‹" class="headerlink" title="4.1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£(Starting Window)çš„æ·»åŠ è¿‡ç¨‹"></a>4.1ã€Activityç»„ä»¶çš„å¯åŠ¨çª—å£(Starting Window)çš„æ·»åŠ è¿‡ç¨‹</h3><p>æ—¶åºå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/13-Android-WMS-Starting-Window-addview.png" alt="Markdown"></p><h3 id="4-1-1ã€-ActivityStack-startActivityLocked"><a href="#4-1-1ã€-ActivityStack-startActivityLocked" class="headerlink" title="4.1.1ã€ ActivityStack.startActivityLocked()"></a>4.1.1ã€ ActivityStack.startActivityLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStack.java]</span><br><span class="line">   <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> keepCurTransition,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityOptions options)</span> </span>&#123;</span><br><span class="line">            ......</span><br><span class="line">                    <span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</span><br><span class="line">                mWindowManager.prepareAppTransition(TRANSIT_NONE, keepCurTransition);</span><br><span class="line">                mNoAnimActivities.add(r);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mWindowManager.prepareAppTransition(newTask</span><br><span class="line">                        ? r.mLaunchTaskBehind</span><br><span class="line">                                ? TRANSIT_TASK_OPEN_BEHIND</span><br><span class="line">                                : TRANSIT_TASK_OPEN</span><br><span class="line">                        : TRANSIT_ACTIVITY_OPEN, keepCurTransition);</span><br><span class="line">                mNoAnimActivities.remove(r);</span><br><span class="line">            &#125;</span><br><span class="line">            addConfigOverride(r, task);</span><br><span class="line">            <span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class="line">                .......</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class="line">                ActivityRecord prev = r.task.topRunningActivityWithStartingWindowLocked();</span><br><span class="line">                <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// We don't want to reuse the previous starting preview if:</span></span><br><span class="line">                    <span class="comment">// (1) The current activity is in a different task.</span></span><br><span class="line">                    <span class="keyword">if</span> (prev.task != r.task) &#123;</span><br><span class="line">                        prev = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// (2) The current activity is already displayed.</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</span><br><span class="line">                        prev = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                r.showStartingWindow(prev, showStartingIcon);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç›´æ¥è°ƒç”¨ActivityRecord.showStartingWindow()è¿›ä¸€æ­¥æ·»åŠ å¯åŠ¨çª—å£</p><h3 id="4-1-2ã€-ActivityRecord-showStartingWindow"><a href="#4-1-2ã€-ActivityRecord-showStartingWindow" class="headerlink" title="4.1.2ã€ ActivityRecord.showStartingWindow()"></a>4.1.2ã€ ActivityRecord.showStartingWindow()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityRecord.java]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showStartingWindow</span><span class="params">(ActivityRecord prev, <span class="keyword">boolean</span> createIfNeeded)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> CompatibilityInfo compatInfo =</span><br><span class="line">            service.compatibilityInfoForPackageLocked(info.applicationInfo);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> shown = service.mWindowManager.setAppStartingWindow(</span><br><span class="line">            appToken, packageName, theme, compatInfo, nonLocalizedLabel, labelRes, icon,</span><br><span class="line">            logo, windowFlags, prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, createIfNeeded);</span><br><span class="line">    <span class="keyword">if</span> (shown) &#123;</span><br><span class="line">        mStartingWindowState = STARTING_WINDOW_SHOWN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-2ã€ActivityRecord-setAppStartingWindow"><a href="#4-1-2ã€ActivityRecord-setAppStartingWindow" class="headerlink" title="4.1.2ã€ActivityRecord.setAppStartingWindow()"></a>4.1.2ã€ActivityRecord.setAppStartingWindow()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityRecord.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setAppStartingWindow</span><span class="params">(IBinder token, String pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> theme, CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence nonLocalizedLabel, <span class="keyword">int</span> labelRes, <span class="keyword">int</span> icon, <span class="keyword">int</span> logo,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> windowFlags, IBinder transferFrom, <span class="keyword">boolean</span> createIfNeeded)</span> </span>&#123;</span><br><span class="line">   ......</span><br><span class="line">  <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">   AppWindowToken wtoken = findAppWindowToken(token);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (transferStartingWindow(transferFrom, wtoken)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        wtoken.startingData = <span class="keyword">new</span> StartingData(pkg, theme, compatInfo, nonLocalizedLabel,</span><br><span class="line">                labelRes, icon, logo, windowFlags);</span><br><span class="line">        Message m = mH.obtainMessage(H.ADD_STARTING, wtoken);</span><br><span class="line">        mH.sendMessageAtFrontOfQueue(m);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå‚æ•°transferFromæ‰€æè¿°çš„Activityç»„ä»¶æ²¡æœ‰å¯åŠ¨çª—å£æˆ–è€…å¯åŠ¨çª—å£æ•°æ®è½¬ç§»ç»™å‚æ•°tokenæ‰€æè¿°çš„Activityç»„ä»¶ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¯èƒ½éœ€è¦ä¸ºå‚æ•°tokenæ‰€æè¿°çš„Activityç»„ä»¶åˆ›å»ºä¸€ä¸ªæ–°çš„å¯åŠ¨çª—å£</p><h3 id="4-1-3ã€-H-handleMessage"><a href="#4-1-3ã€-H-handleMessage" class="headerlink" title="4.1.3ã€ H.handleMessage()"></a>4.1.3ã€ H.handleMessage()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java::H]</span><br><span class="line"><span class="keyword">case</span> ADD_STARTING: &#123;</span><br><span class="line">    <span class="keyword">final</span> AppWindowToken wtoken = (AppWindowToken)msg.obj;</span><br><span class="line">    <span class="keyword">final</span> StartingData sd = wtoken.startingData;</span><br><span class="line">    ......</span><br><span class="line">    View view = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Configuration overrideConfig = wtoken != <span class="keyword">null</span> &amp;&amp; wtoken.mTask != <span class="keyword">null</span></span><br><span class="line">                ? wtoken.mTask.mOverrideConfig : <span class="keyword">null</span>;</span><br><span class="line">        view = mPolicy.addStartingWindow(wtoken.token, sd.pkg, sd.theme,</span><br><span class="line">            sd.compatInfo, sd.nonLocalizedLabel, sd.labelRes, sd.icon, sd.logo,</span><br><span class="line">            sd.windowFlags, overrideConfig);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> abort = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            <span class="keyword">if</span> (wtoken.removed || wtoken.startingData == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    wtoken.startingWindow = <span class="keyword">null</span>;</span><br><span class="line">                    wtoken.startingData = <span class="keyword">null</span>;</span><br><span class="line">                    abort = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                wtoken.startingView = view;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (abort) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mPolicy.removeStartingWindow(wtoken.token, view);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>PhoneWindowManagerå®ç°WindowManagerPolicyï¼Œæ‰€ä»¥ä¼šè°ƒç”¨PhoneWindowManagerä¸­çš„æ–¹æ³• ç»§ç»­åˆ†æPhoneWindowManager.addStartingWindow()</p><h3 id="4-1-4ã€PhoneWindowManager-addStartingWindow"><a href="#4-1-4ã€PhoneWindowManager-addStartingWindow" class="headerlink" title="4.1.4ã€PhoneWindowManager.addStartingWindow()"></a>4.1.4ã€PhoneWindowManager.addStartingWindow()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;PhoneWindowManager.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">addStartingWindow</span><span class="params">(IBinder appToken, String packageName, <span class="keyword">int</span> theme,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, CharSequence nonLocalizedLabel, <span class="keyword">int</span> labelRes,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> icon, <span class="keyword">int</span> logo, <span class="keyword">int</span> windowFlags, Configuration overrideConfig)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    WindowManager wm = <span class="keyword">null</span>;</span><br><span class="line">    View view = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Context context = mContext;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> PhoneWindow win = <span class="keyword">new</span> PhoneWindow(context);</span><br><span class="line">        win.setIsStartingWindow(<span class="keyword">true</span>);</span><br><span class="line">        ......</span><br><span class="line">        win.setType(</span><br><span class="line">            WindowManager.LayoutParams.TYPE_APPLICATION_STARTING);</span><br><span class="line">        ......</span><br><span class="line">        win.setLayout(WindowManager.LayoutParams.MATCH_PARENT,</span><br><span class="line">                WindowManager.LayoutParams.MATCH_PARENT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WindowManager.LayoutParams params = win.getAttributes();</span><br><span class="line">        params.token = appToken;</span><br><span class="line">        params.packageName = packageName;</span><br><span class="line">        params.windowAnimations = win.getWindowStyle().getResourceId(</span><br><span class="line">                com.android.internal.R.styleable.Window_windowAnimationStyle, <span class="number">0</span>);</span><br><span class="line">        ......</span><br><span class="line">        params.setTitle(<span class="string">"Starting "</span> + packageName);</span><br><span class="line">        wm = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">        view = win.getDecorView();</span><br><span class="line">       ......</span><br><span class="line">        wm.addView(view, params);</span><br><span class="line">        <span class="keyword">return</span> view.getParent() != <span class="keyword">null</span> ? view : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (WindowManager.BadTokenException e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (view != <span class="keyword">null</span> &amp;&amp; view.getParent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            wm.removeViewImmediate(view);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºPhoneWindowå¯¹è±¡ï¼Œæ¥ä¸‹æ¥ç»§ç»­è®¾ç½®æ‰€åˆ›å»ºçš„çª—å£winçš„ä»¥ä¸‹å±æ€§ï¼š 1ã€çª—å£ç±»å‹ï¼šè®¾ç½®ä¸ºWindowManager.LayoutParams.TYPE_APPLICATION_STARTINGï¼Œå³è®¾ç½®ä¸ºå¯åŠ¨çª—å£ç±»å‹ï¼›</p><p>2ã€çª—å£æ ‡é¢˜ï¼šç”±å‚æ•°labelResã€nonLocalizedLabelï¼Œä»¥åŠçª—å£çš„è¿è¡Œä¸Šä¸‹æ–‡contextæ¥ç¡®å®šï¼›</p><p>3ã€çª—å£æ ‡å¿—ï¼šåˆ†åˆ«å°†indowManager.LayoutParams.FLAG_NOT_TOUCHABLEã€WindowManager.LayoutParams.FLAG_NOT_FOCUSABLEå’ŒWindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IMä½è®¾ç½®ä¸º1ï¼Œå³ä¸å¯æ¥å—è§¦æ‘¸äº‹ä»¶å’Œä¸å¯è·å¾—ç„¦ç‚¹ï¼Œä½†æ˜¯å¯ä»¥æ¥å—è¾“å…¥æ³•çª—å£ï¼›</p><p>4ã€çª—å£å¤§å°ï¼šè®¾ç½®ä¸ºWindowManager.LayoutParams.MATCH_PARENTï¼Œå³ä¸çˆ¶çª—å£ä¸€æ ·å¤§ï¼Œä½†æ˜¯ç”±äºè¿™æ˜¯ä¸€ä¸ªé¡¶å±‚çª—å£ï¼Œå› æ­¤å®é™…ä¸Šæ˜¯æŒ‡ä¸å±å¹•ä¸€æ ·å¤§ï¼›</p><p>5ã€å¸ƒå±€å‚æ•°ï¼šåŒ…æ‹¬çª—å£æ‰€å¯¹åº”çš„çª—å£ä»¤ç‰Œï¼ˆtokenï¼‰å’ŒåŒ…åï¼ˆpackageNameï¼‰ï¼Œä»¥åŠçª—å£æ‰€ä½¿ç”¨çš„åŠ¨ç”»ç±»å‹ï¼ˆwindowAnimationsï¼‰å’Œæ ‡é¢˜ï¼ˆtitleï¼‰ã€‚</p><p>wm.addView(view, params)ï¼Œä¸€ä¸ªæ–°åˆ›å»ºçš„Activityç»„ä»¶çš„å¯åŠ¨çª—å£å°±å¢åŠ åˆ°WindowManagerServiceæœåŠ¡ä¸­å»äº†ï¼Œè¿™æ ·ï¼ŒWindowManagerServiceæœåŠ¡å°±å¯ä»¥ä¸‹æ¬¡åˆ·æ–°ç³»ç»ŸUIæ—¶ï¼Œå°†è¯¥å¯åŠ¨çª—å£æ˜¾ç¤ºå‡ºæ¥</p><h2 id="ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp-Transitionï¼‰è¿‡ç¨‹"><a href="#ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp-Transitionï¼‰è¿‡ç¨‹" class="headerlink" title="ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp Transitionï¼‰è¿‡ç¨‹"></a>ï¼ˆäº”ï¼‰ã€WMSåˆ‡æ¢Activityçª—å£ï¼ˆApp Transitionï¼‰è¿‡ç¨‹</h2><p>WindowManagerServiceæœåŠ¡åœ¨æ‰§è¡ŒActivityçª—å£çš„åˆ‡æ¢æ“ä½œçš„æ—¶å€™ï¼Œä¼šç»™å‚ä¸åˆ‡æ¢æ“ä½œçš„Activityç»„ä»¶çš„è®¾ç½®ä¸€ä¸ªåŠ¨ç”»ï¼Œä»¥ä¾¿å¯ä»¥å‘ç”¨æˆ·å±•ç°ä¸€ä¸ªActivityç»„ä»¶åˆ‡æ¢æ•ˆæœï¼Œä»è€Œæé«˜ç”¨æˆ·ä½“éªŒã€‚ é¦–å…ˆçœ‹ä¸€ä¸‹App TransitionåŠ¨æ€å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/14-Android-WMS-ezgif.com-video-to-gif-WMS-App-Transition.gif" alt="Markdown"></p><p>æ—¶åºå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/15-Android-WMS-executeAppTransition.png" alt="Markdown"></p><p>æˆ‘ä»¬ç›´æ¥åˆ†æApp Transitionè¿‡ç¨‹çš„prepareAppTransitionã€executeAppTransition å…³äºActivityå¯åŠ¨è¿‡ç¨‹è¯·å‚è€ƒï¼šã€Android-7-1-2-Android-N-Activityå¯åŠ¨æµç¨‹åˆ†æã€‘</p><h3 id="5-1ã€prepareAppTransition-è¿‡ç¨‹"><a href="#5-1ã€prepareAppTransition-è¿‡ç¨‹" class="headerlink" title="5.1ã€prepareAppTransition()è¿‡ç¨‹"></a>5.1ã€prepareAppTransition()è¿‡ç¨‹</h3><h3 id="5-1-1ã€ActivityStack-startActivityLocked"><a href="#5-1-1ã€ActivityStack-startActivityLocked" class="headerlink" title="5.1.1ã€ActivityStack.startActivityLocked()"></a>5.1.1ã€ActivityStack.startActivityLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStack.java]</span><br><span class="line">......</span><br><span class="line">mWindowManager.prepareAppTransition(newTask</span><br><span class="line">        ? r.mLaunchTaskBehind</span><br><span class="line">                ? TRANSIT_TASK_OPEN_BEHIND</span><br><span class="line">                : TRANSIT_TASK_OPEN</span><br><span class="line">        : TRANSIT_ACTIVITY_OPEN, keepCurTransition);</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h3 id="5-1-2ã€WindowManagerService-prepareAppTransition"><a href="#5-1-2ã€WindowManagerService-prepareAppTransition" class="headerlink" title="5.1.2ã€WindowManagerService.prepareAppTransition()"></a>5.1.2ã€WindowManagerService.prepareAppTransition()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareAppTransition</span><span class="params">(<span class="keyword">int</span> transit, <span class="keyword">boolean</span> alwaysKeepCurrent)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> prepared = mAppTransition.prepareAppTransitionLocked(</span><br><span class="line">                transit, alwaysKeepCurrent);</span><br><span class="line">        <span class="keyword">if</span> (prepared &amp;&amp; okToDisplay()) &#123;</span><br><span class="line">            mSkipAppTransitionAnimation = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ˜¯ç›´æ¥è°ƒç”¨AppTransition.prepareAppTransitionLocked()å®ç°çš„ã€‚</p><h3 id="5-1-3ã€AppTransition-prepareAppTransitionLocked"><a href="#5-1-3ã€AppTransition-prepareAppTransitionLocked" class="headerlink" title="5.1.3ã€AppTransition.prepareAppTransitionLocked()"></a>5.1.3ã€AppTransition.prepareAppTransitionLocked()</h3><p>è¿›ä¸€æ­¥è°ƒç”¨setAppTransition()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setAppTransition</span><span class="params">(<span class="keyword">int</span> transit)</span> </span>&#123;</span><br><span class="line">    mNextAppTransition = transit;</span><br><span class="line">    setLastAppTransition(TRANSIT_UNSET, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°åªæ˜¯å°†transitï¼ˆå³AppTransitionåŠ¨ç”»ç±»å‹ï¼‰èµ‹å€¼ç»™å˜é‡mNextAppTransition</p><h3 id="5-2ã€AppTransition-animationè®¾ç½®è¿‡ç¨‹"><a href="#5-2ã€AppTransition-animationè®¾ç½®è¿‡ç¨‹" class="headerlink" title="5.2ã€AppTransition animationè®¾ç½®è¿‡ç¨‹"></a>5.2ã€AppTransition animationè®¾ç½®è¿‡ç¨‹</h3><p>ç»§ç»­åˆ†æActivityStackSupervisor.realStartActivityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStackSupervisor.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        r.startFreezingScreenLocked(app, <span class="number">0</span>);</span><br><span class="line">        mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line">        r.startLaunchTickingLocked();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šé€šçŸ¥WindowManagerServiceæœåŠ¡å°†å‚æ•°r.appTokenæ‰€æè¿°çš„Activityç»„ä»¶çš„å¯è§æ€§è®¾ç½®ä¸ºtrue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppVisibility</span><span class="params">(IBinder token, <span class="keyword">boolean</span> visible)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    AppWindowToken wtoken;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        wtoken = findAppWindowToken(token);</span><br><span class="line">        ......</span><br><span class="line">        mOpeningApps.remove(wtoken);</span><br><span class="line">        mClosingApps.remove(wtoken);</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">            wtoken.inPendingTransaction = <span class="keyword">false</span>;</span><br><span class="line">            setTokenVisibilityLocked(wtoken, <span class="keyword">null</span>, visible, AppTransition.TRANSIT_UNSET,</span><br><span class="line">                    <span class="keyword">true</span>, wtoken.voiceInteraction);</span><br><span class="line">            wtoken.updateReportedVisibilityLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨WindowManagerService.setTokenVisibilityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setTokenVisibilityLocked</span><span class="params">(AppWindowToken wtoken, WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> visible, <span class="keyword">int</span> transit, <span class="keyword">boolean</span> performLayout, <span class="keyword">boolean</span> isVoiceInteraction)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (wtoken.hidden == visible || (wtoken.hidden &amp;&amp; wtoken.mIsExiting) ||</span><br><span class="line">                (visible &amp;&amp; wtoken.waitingForReplacement())) &#123;</span><br><span class="line">           ......</span><br><span class="line">            <span class="keyword">if</span> (transit != AppTransition.TRANSIT_UNSET) &#123;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (applyAnimationLocked(wtoken, lp, transit, visible, isVoiceInteraction)) &#123;</span><br><span class="line">                    delayed = runningAppAnimation = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨WindowManagerService.applyAnimationLocked()è®¾ç½®AppTransitionåŠ¨ç”»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">applyAnimationLocked</span><span class="params">(AppWindowToken atoken, WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> transit, <span class="keyword">boolean</span> enter, <span class="keyword">boolean</span> isVoiceInteraction)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (okToDisplay()) &#123;</span><br><span class="line">        Animation a = mAppTransition.loadAnimation(lp, transit, enter, mCurConfiguration.uiMode,</span><br><span class="line">        mCurConfiguration.orientation, frame, displayFrame, insets, surfaceInsets,</span><br><span class="line">        isVoiceInteraction, freeform, atoken.mTask.mTaskId);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»ˆäºåˆ°äº†AppTransitionçœŸæ­£è®¾ç½®è¿‡ç¨‹äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;AppTransition.java]</span><br><span class="line">Animation loadAnimation(WindowManager.LayoutParams lp, int transit, boolean enter, int uiMode,</span><br><span class="line">            int orientation, Rect frame, Rect displayFrame, Rect insets,</span><br><span class="line">            @Nullable Rect surfaceInsets, boolean isVoiceInteraction, boolean freeform,</span><br><span class="line">            int taskId) &#123;</span><br><span class="line">        Animation a;</span><br><span class="line">      if()&#123;&#125;</span><br><span class="line">      ......</span><br><span class="line">      &#125; else if()&#123;</span><br><span class="line">      ......</span><br><span class="line">      &#125;else &#123;</span><br><span class="line">        int animAttr = 0;</span><br><span class="line">        switch (transit) &#123;</span><br><span class="line">            case TRANSIT_ACTIVITY_OPEN:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_activityOpenEnterAnimation</span><br><span class="line">                        : WindowAnimation_activityOpenExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_ACTIVITY_CLOSE:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_activityCloseEnterAnimation</span><br><span class="line">                        : WindowAnimation_activityCloseExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_DOCK_TASK_FROM_RECENTS:</span><br><span class="line">            case TRANSIT_TASK_OPEN:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_taskOpenEnterAnimation</span><br><span class="line">                        : WindowAnimation_taskOpenExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_TASK_CLOSE:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_taskCloseEnterAnimation</span><br><span class="line">                        : WindowAnimation_taskCloseExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_TASK_TO_FRONT:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_taskToFrontEnterAnimation</span><br><span class="line">                        : WindowAnimation_taskToFrontExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            case TRANSIT_TASK_TO_BACK:</span><br><span class="line">                animAttr = enter</span><br><span class="line">                        ? WindowAnimation_taskToBackEnterAnimation</span><br><span class="line">                        : WindowAnimation_taskToBackExitAnimation;</span><br><span class="line">                break;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        a = animAttr != 0 ? loadAnimationAttr(lp, animAttr) : null;</span><br><span class="line">    &#125;</span><br><span class="line">    return a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åé€šè¿‡<strong>loadAnimationAttr</strong>åŠ è½½xmlæ–‡ä»¶åŠ è½½åŠ¨ç”»ï¼ŒåŠ¨ç”»xmlæ–‡ä»¶çš„å­˜æ”¾è·¯å¾„ï¼ˆ/frameworks/base/core/res/res/anim/ï¼‰<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/16-Android-WMS-executeAppTransition-xml.png" alt="Markdown"></p><h3 id="5-3ã€executeAppTransitionè¿‡ç¨‹"><a href="#5-3ã€executeAppTransitionè¿‡ç¨‹" class="headerlink" title="5.3ã€executeAppTransitionè¿‡ç¨‹"></a>5.3ã€executeAppTransitionè¿‡ç¨‹</h3><blockquote><p>ActivityStackSupervisor.realStartActivityLocked()</p><blockquote><p>ActivityStack.minimalResumeActivityLocked() ActivityStack.completeResumeLocked() ActivityStackSupervisor.reportResumedActivityLocked()</p></blockquote></blockquote><p>ç»§ç»­åˆ†æActivityStackSupervisor.reportResumedActivityLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStackSupervisor.java]</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">reportResumedActivityLocked</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = r.task.stack;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (allResumedActivitiesComplete()) &#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">        mWindowManager.executeAppTransition();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯Activityç»„ä»¶çš„å¯è§æ€§è®¾ç½®ï¼Œç„¶åæ‰§è¡ŒexecuteAppTransition()</p><h3 id="5-3-1-WindowManagerService-executeAppTransition"><a href="#5-3-1-WindowManagerService-executeAppTransition" class="headerlink" title="5.3.1.WindowManagerService.executeAppTransition()"></a>5.3.1.WindowManagerService.executeAppTransition()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeAppTransition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ......</span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAppTransition.isTransitionSet()) &#123;</span><br><span class="line">                mAppTransition.setReady();</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mWindowPlacerLocked.performSurfacePlacement();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è€ŒWindowSurfacePlacer.performSurfacePlacement()è¯·çœ‹å‰é¢ç¬¬äºŒèŠ‚åˆ†æ</p><h2 id="ï¼ˆå…­ï¼‰ã€Activity-Window-åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹"><a href="#ï¼ˆå…­ï¼‰ã€Activity-Window-åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Activity Window åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹"></a>ï¼ˆå…­ï¼‰ã€Activity Window åŠ¨ç”»æ˜¾ç¤ºè¿‡ç¨‹</h2><h3 id="6-1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"><a href="#6-1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹" class="headerlink" title="6.1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"></a>6.1ã€åŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹</h3><p>åœ¨Androidç³»ç»Ÿä¸­ï¼Œçª—å£åŠ¨ç”»çš„æœ¬è´¨å°±æ˜¯å¯¹åŸå§‹çª—å£æ–½åŠ ä¸€ä¸ªå˜æ¢ï¼ˆTransformationï¼‰ã€‚åœ¨çº¿æ€§æ•°å­¦ä¸­ï¼Œå¯¹ç‰©ä½“çš„å½¢çŠ¶è¿›è¡Œå˜æ¢æ˜¯é€šè¿‡ä¹˜ä»¥ä¸€ä¸ªçŸ©é˜µï¼ˆMatrixï¼‰æ¥å®ç°ï¼Œç›®çš„å°±æ˜¯å¯¹ç‰©ä½“è¿›è¡Œåç§»ã€æ—‹è½¬ã€ç¼©æ”¾ã€åˆ‡å˜ã€åå°„å’ŒæŠ•å½±ç­‰ã€‚å› æ­¤ï¼Œç»™çª—å£è®¾ç½®åŠ¨ç”»å®é™…ä¸Šå°±ç»™çª—å£è®¾ç½®ä¸€ä¸ªå˜æ¢çŸ©é˜µï¼ˆTransformation Matrixï¼‰ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/17-Android-WMS-Transformation-matrix.png" alt="Markdown"></p><p>çª—å£è¢«è®¾ç½®çš„åŠ¨ç”»è™½ç„¶å¯ä»¥è¾¾åˆ°ä¸‰ä¸ªï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªåŠ¨ç”»å¯ä»¥å½’ç»“ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æ™®é€šåŠ¨ç”»ï¼Œä¾‹å¦‚ï¼Œçª—å£åœ¨æ‰“å¼€è¿‡ç¨‹ä¸­è¢«è®¾ç½®çš„è¿›å…¥åŠ¨ç”»å’Œåœ¨å…³é—­è¿‡ç¨‹ä¸­è¢«è®¾ç½®çš„é€€å‡ºåŠ¨ç”»ï¼Œå¦ä¸€ç±»æ˜¯åˆ‡æ¢åŠ¨ç”»ã€‚å…¶ä¸­ï¼ŒSelf Transformationå’ŒAttached Transformationéƒ½æ˜¯å±äºæ™®é€šåŠ¨ç”»ï¼Œè€ŒApp Transformationå±äºåˆ‡æ¢åŠ¨ç”»ã€‚å‰é¢å·²ç»åˆ†æè¿‡App Transformationçš„è®¾ç½®è¿‡ç¨‹ æ¥ä¸‹æ¥åˆ†ææ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹ã€‚</p><h3 id="6-1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"><a href="#6-1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹" class="headerlink" title="6.1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹"></a>6.1ã€æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹</h3><p>æ™®é€šåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹ä¹Ÿæ˜¯é€šè¿‡setTokenVisibilityLocked()è®¾ç½®çš„</p><h3 id="6-1-1ã€WindowManagerService-setTokenVisibilityLocked"><a href="#6-1-1ã€WindowManagerService-setTokenVisibilityLocked" class="headerlink" title="6.1.1ã€WindowManagerService.setTokenVisibilityLocked()"></a>6.1.1ã€WindowManagerService.setTokenVisibilityLocked()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowManagerService.java]</span><br><span class="line">    boolean setTokenVisibilityLocked(AppWindowToken wtoken, WindowManager.LayoutParams lp,</span><br><span class="line">            boolean visible, int transit, boolean performLayout, boolean isVoiceInteraction) &#123;</span><br><span class="line">        ......</span><br><span class="line">        if (wtoken.hidden == visible || (wtoken.hidden &amp;&amp; wtoken.mIsExiting) ||</span><br><span class="line">                (visible &amp;&amp; wtoken.waitingForReplacement())) &#123;</span><br><span class="line">           ......</span><br><span class="line">            if (transit != AppTransition.TRANSIT_UNSET) &#123;</span><br><span class="line">                ......</span><br><span class="line">                if (applyAnimationLocked(wtoken, lp, transit, visible, isVoiceInteraction)) &#123;</span><br><span class="line">                    delayed = runningAppAnimation = true;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                changed = true;</span><br><span class="line">            &#125;</span><br><span class="line">            final int windowsCount = wtoken.allAppWindows.size();</span><br><span class="line">            for (int i = 0; i &lt; windowsCount; i++) &#123;</span><br><span class="line">                WindowState win = wtoken.allAppWindows.get(i);</span><br><span class="line">                ......</span><br><span class="line">                if (visible) &#123;</span><br><span class="line">                    if (!win.isVisibleNow()) &#123;</span><br><span class="line">                        if (!runningAppAnimation) &#123;</span><br><span class="line">                            win.mWinAnimator.applyAnimationLocked(</span><br><span class="line">                                    WindowManagerPolicy.TRANSIT_ENTER, true);</span><br><span class="line">                            ......</span><br><span class="line">                        &#125;</span><br><span class="line">                        changed = true;</span><br><span class="line">                        win.setDisplayLayoutNeeded();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (win.isVisibleNow()) &#123;</span><br><span class="line">                    if (!runningAppAnimation) &#123;</span><br><span class="line">                        win.mWinAnimator.applyAnimationLocked(</span><br><span class="line">                                WindowManagerPolicy.TRANSIT_EXIT, false);</span><br><span class="line">                        ......</span><br><span class="line">                    &#125;</span><br><span class="line">                    changed = true;</span><br><span class="line">                    win.setDisplayLayoutNeeded();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            wtoken.hidden = wtoken.hiddenRequested = !visible;</span><br><span class="line">            visibilityChanged = true;</span><br><span class="line">            ......</span><br><span class="line">            if (changed) &#123;</span><br><span class="line">                mInputMonitor.setUpdateInputWindowsNeededLw();</span><br><span class="line">                if (performLayout) &#123;</span><br><span class="line">                    updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,</span><br><span class="line">                            false /*updateInputWindows*/);</span><br><span class="line">                    mWindowPlacerLocked.performSurfacePlacement();</span><br><span class="line">                &#125;</span><br><span class="line">                mInputMonitor.updateInputWindowsLw(false /*force*/);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ™®é€šåŠ¨ç”»æ˜¯é€šè¿‡win.mWinAnimator.applyAnimationLocked(WindowManagerPolicy.TRANSIT_ENTER, true)</p><h3 id="6-1-1-WindowStateAnimator-applyAnimationLocked"><a href="#6-1-1-WindowStateAnimator-applyAnimationLocked" class="headerlink" title="6.1.1.WindowStateAnimator.applyAnimationLocked()"></a>6.1.1.WindowStateAnimator.applyAnimationLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">applyAnimationLocked</span><span class="params">(<span class="keyword">int</span> transit, <span class="keyword">boolean</span> isEntrance)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mService.okToDisplay()) &#123;</span><br><span class="line">        <span class="keyword">int</span> anim = mPolicy.selectAnimationLw(mWin, transit);</span><br><span class="line">        <span class="keyword">int</span> attr = -<span class="number">1</span>;</span><br><span class="line">        Animation a = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (anim != <span class="number">0</span>) &#123;</span><br><span class="line">            a = anim != -<span class="number">1</span> ? AnimationUtils.loadAnimation(mContext, anim) : <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (transit) &#123;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerPolicy.TRANSIT_ENTER:</span><br><span class="line">                    attr = com.android.internal.R.styleable.WindowAnimation_windowEnterAnimation;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerPolicy.TRANSIT_EXIT:</span><br><span class="line">                    attr = com.android.internal.R.styleable.WindowAnimation_windowExitAnimation;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerPolicy.TRANSIT_SHOW:</span><br><span class="line">                    attr = com.android.internal.R.styleable.WindowAnimation_windowShowAnimation;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerPolicy.TRANSIT_HIDE:</span><br><span class="line">                    attr = com.android.internal.R.styleable.WindowAnimation_windowHideAnimation;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (attr &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                a = mService.mAppTransition.loadAnimationAttr(mWin.mAttrs, attr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">            setAnimation(a);</span><br><span class="line">            mAnimationIsEntrance = isEntrance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clearAnimation();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> mAnimation != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯æ ¹æ®åŠ¨ç”»ç±»å‹ä»è€Œé€šè¿‡AppTransition.loadAnimationAttr(mWin.mAttrs, attr)åŠ è½½ä¸åŒçš„anim xmlæ–‡ä»¶ã€‚</p><h3 id="6-2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶"><a href="#6-2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶" class="headerlink" title="6.2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶"></a>6.2ã€çª—å£åŠ¨ç”»çš„æ˜¾ç¤ºæ¡†æ¶</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/19-Android-WMS-animationLocked.png" alt="Markdown"><br>é€šè¿‡å †æ ˆä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œç”±Vsyncä¿¡å·é©±åŠ¨ï¼Œç„¶åè°ƒç”¨Choreographer.doFrameå®ŒæˆåŠ¨ç”»çš„ç›¸å…³æ“ä½œï¼Œå…³äºVsyncè¿™éƒ¨åˆ†ä¹‹å‰æ–‡ç« å·²ç»åˆ†æè¿‡ï¼Œè¿™é‡Œä¸å†åˆ†æäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line"><span class="comment">/** Locked on mService.mWindowMap. */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">animateLocked</span><span class="params">(<span class="keyword">long</span> frameTimeNs)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mCurrentTime = frameTimeNs / TimeUtils.NANOS_PER_MS;</span><br><span class="line">    mBulkUpdateParams = SET_ORIENTATION_CHANGE_COMPLETE;</span><br><span class="line">    <span class="keyword">boolean</span> wasAnimating = mAnimating;</span><br><span class="line">    setAnimating(<span class="keyword">false</span>);</span><br><span class="line">    mAppWindowAnimating = <span class="keyword">false</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">            TAG, <span class="string">"&gt;&gt;&gt; OPEN TRANSACTION animateLocked"</span>);</span><br><span class="line">    SurfaceControl.openTransaction();</span><br><span class="line">    SurfaceControl.setAnimationTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mDisplayContentsAnimators.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDisplays; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplayContentsAnimators.keyAt(i);</span><br><span class="line">            <span class="comment">//1ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</span></span><br><span class="line">            updateAppWindowsLocked(displayId);</span><br><span class="line">            DisplayContentsAnimator displayAnimator = mDisplayContentsAnimators.valueAt(i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ScreenRotationAnimation screenRotationAnimation =</span><br><span class="line">                    displayAnimator.mScreenRotationAnimation;</span><br><span class="line">            <span class="keyword">if</span> (screenRotationAnimation != <span class="keyword">null</span> &amp;&amp; screenRotationAnimation.isAnimating()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (screenRotationAnimation.stepAnimationLocked(mCurrentTime)) &#123;</span><br><span class="line">                    setAnimating(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mBulkUpdateParams |= SET_UPDATE_ROTATION;</span><br><span class="line">                    screenRotationAnimation.kill();</span><br><span class="line">                    displayAnimator.mScreenRotationAnimation = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//TODO (multidisplay): Accessibility supported only for the default display.</span></span><br><span class="line">                    <span class="keyword">if</span> (mService.mAccessibilityController != <span class="keyword">null</span></span><br><span class="line">                            &amp;&amp; displayId == Display.DEFAULT_DISPLAY) &#123;</span><br><span class="line">                        <span class="comment">// We just finished rotation animation which means we did not</span></span><br><span class="line">                        <span class="comment">// anounce the rotation and waited for it to end, announce now.</span></span><br><span class="line">                        mService.mAccessibilityController.onRotationChangedLocked(</span><br><span class="line">                                mService.getDefaultDisplayContentLocked(), mService.mRotation);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update animations of all applications, including those</span></span><br><span class="line">            <span class="comment">// associated with exiting/removed apps</span></span><br><span class="line">            <span class="comment">//2ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</span></span><br><span class="line">            updateWindowsLocked(displayId);</span><br><span class="line">            <span class="comment">//å£çº¸åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</span></span><br><span class="line">            updateWallpaperLocked(displayId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> WindowList windows = mService.getWindowListLocked(displayId);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = windows.size();</span><br><span class="line">            <span class="comment">//3ã€é€šè¿‡ä¸€ä¸ªforå¾ªç¯æ¥éå†ä¿å­˜åœ¨çª—å£å †æ ˆçš„æ¯ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªçª—å£çš„ç»˜å›¾è¡¨é¢è¿›è¡Œæ›´æ–°</span></span><br><span class="line">            <span class="comment">//ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++) &#123;</span><br><span class="line">                windows.get(j).mWinAnimator.prepareSurfaceLocked(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDisplays; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplayContentsAnimators.keyAt(i);</span><br><span class="line"></span><br><span class="line">            testTokenMayBeDrawnLocked(displayId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ScreenRotationAnimation screenRotationAnimation =</span><br><span class="line">                    mDisplayContentsAnimators.valueAt(i).mScreenRotationAnimation;</span><br><span class="line">            <span class="keyword">if</span> (screenRotationAnimation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                screenRotationAnimation.updateSurfacesInTransaction();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            orAnimating(mService.getDisplayContentLocked(displayId).animateDimLayers());</span><br><span class="line">            orAnimating(mService.getDisplayContentLocked(displayId).getDockedDividerController()</span><br><span class="line">                    .animate(mCurrentTime));</span><br><span class="line">            <span class="comment">//TODO (multidisplay): Magnification is supported only for the default display.</span></span><br><span class="line">            <span class="keyword">if</span> (mService.mAccessibilityController != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; displayId == Display.DEFAULT_DISPLAY) &#123;</span><br><span class="line">                mService.mAccessibilityController.drawMagnifiedRegionBorderIfNeededLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//4ã€è§¦å‘ä¸‹ä¸€å¸§åŠ¨ç”»é€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> (mAnimating) &#123;</span><br><span class="line">            mService.scheduleAnimationLocked();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mService.mWatermark != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mService.mWatermark.drawIfNeeded();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        SurfaceControl.closeTransaction();</span><br><span class="line">        <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">                TAG, <span class="string">"&lt;&lt;&lt; CLOSE TRANSACTION animateLocked"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasPendingLayoutChanges = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mService.mDisplayContents.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = <span class="number">0</span>; displayNdx &lt; numDisplays; ++displayNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> DisplayContent displayContent = mService.mDisplayContents.valueAt(displayNdx);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pendingChanges = getPendingLayoutChanges(displayContent.getDisplayId());</span><br><span class="line">        <span class="keyword">if</span> ((pendingChanges &amp; WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER) != <span class="number">0</span>) &#123;</span><br><span class="line">            mBulkUpdateParams |= SET_WALLPAPER_ACTION_PENDING;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pendingChanges != <span class="number">0</span>) &#123;</span><br><span class="line">            hasPendingLayoutChanges = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> doRequest = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mBulkUpdateParams != <span class="number">0</span>) &#123;</span><br><span class="line">        doRequest = mWindowPlacerLocked.copyAnimToLayoutParamsLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5ã€åˆ·æ–°ç³»ç»ŸUI</span></span><br><span class="line">    <span class="keyword">if</span> (hasPendingLayoutChanges || doRequest) &#123;</span><br><span class="line">        mWindowPlacerLocked.requestTraversal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mRemoveReplacedWindows) &#123;</span><br><span class="line">        removeReplacedWindowsLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.stopUsingSavedSurfaceLocked();</span><br><span class="line">    mService.destroyPreservedSurfaceLocked();</span><br><span class="line">    mService.mWindowPlacerLocked.destroyPendingSurfaces();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»çš„æ¨è¿›ã€ 2ã€çª—å£åŠ¨ç”»çš„æ¨è¿›ã€å£çº¸åŠ¨ç”»æ¨è¿› 3ã€å¾ªç¯éå†ä¿å­˜åœ¨çª—å£å †æ ˆçš„æ¯ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªçª—å£çš„ç»˜å›¾è¡¨é¢è¿›è¡Œæ›´æ–° ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯ 4ã€è§¦å‘ä¸‹ä¸€å¸§åŠ¨ç”»é€»è¾‘ 5ã€åˆ·æ–°ç³»ç»ŸUI å…¶ä¸­ç¬¬3ç‚¹ prepareSurfaceLockedåœ¨3.3.å°èŠ‚å·²ç»åˆ†æè¿‡äº†ã€ç¬¬5ç‚¹æœ€ç»ˆä¼šè°ƒç”¨mWindowPlacerLocked.performSurfacePlacementæ¥åˆ·æ–°UIï¼Œä¹Ÿå·²ç»åˆ†æè¿‡äº†ã€‚ æ¥ä¸‹æ¥åˆ†æActivityç»„ä»¶åˆ‡æ¢åŠ¨ç”»ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹ã€‚</p><h3 id="6-3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»"><a href="#6-3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»" class="headerlink" title="6.3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»"></a>6.3ã€Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»</h3><p>AppWindowAnimator:å±äºAppWindowTokenï¼Œå®ƒçš„æˆå‘˜å˜é‡mAppAnimatorä»£è¡¨äº†æ­¤åº”ç”¨ç¨‹åºæ‰€å±çš„AppWindowAnimator WindowStateAnimator:WMSè®°å½•äº†æ‰€æœ‰çª—å£çš„WindowStateï¼Œå…¶ä¸­WindowState.mWinAnimatoræ˜¯ä¸€ä¸ªWindowStateAnimatorå¯¹è±¡ï¼Œå®ƒå’Œä¸Šé¢AppWindowAnimatorä¸€æ ·å¯ä»¥ç”±å¼€å‘äººå‘˜å®šåˆ¶</p><p>WindowAnimator.updateAppWindowsLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateAppWindowsLocked</span><span class="params">(<span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;TaskStack&gt; stacks = mService.getDisplayContentLocked(displayId).getStacks();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> TaskStack stack = stacks.get(stackNdx);</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;Task&gt; tasks = stack.getTasks();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = tasks.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> AppTokenList tokens = tasks.get(taskNdx).mAppTokens;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> tokenNdx = tokens.size() - <span class="number">1</span>; tokenNdx &gt;= <span class="number">0</span>; --tokenNdx) &#123;</span><br><span class="line">                <span class="keyword">final</span> AppWindowAnimator appAnimator = tokens.get(tokenNdx).mAppAnimator;</span><br><span class="line">                appAnimator.wasAnimating = appAnimator.animating;</span><br><span class="line">                <span class="keyword">if</span> (appAnimator.stepAnimationLocked(mCurrentTime, displayId)) &#123;</span><br><span class="line">                    appAnimator.animating = <span class="keyword">true</span>;</span><br><span class="line">                    setAnimating(<span class="keyword">true</span>);</span><br><span class="line">                    mAppWindowAnimating = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (appAnimator.wasAnimating) &#123;</span><br><span class="line">                    <span class="comment">// stopped animating, do one more pass through the layout</span></span><br><span class="line">                    setAppLayoutChanges(appAnimator,</span><br><span class="line">                            WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER,</span><br><span class="line">                            <span class="string">"appToken "</span> + appAnimator.mAppToken + <span class="string">" done"</span>, displayId);</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨stepAnimationLocked()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;AppWindowAnimator.java]</span><br><span class="line">    <span class="comment">// This must be called while inside a transaction.</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">stepAnimationLocked</span><span class="params">(<span class="keyword">long</span> currentTime, <span class="keyword">final</span> <span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mService.okToDisplay()) &#123;</span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((mAppToken.allDrawn || animating || mAppToken.startingDisplayed)</span><br><span class="line">                    &amp;&amp; animation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (stepAnimation(currentTime)) &#123;</span><br><span class="line">                    <span class="comment">// animation isn't over, step any thumbnail and that's</span></span><br><span class="line">                    <span class="comment">// it for now.</span></span><br><span class="line">                    <span class="keyword">if</span> (thumbnail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        stepThumbnailAnimation(currentTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            animating = <span class="keyword">true</span>;</span><br><span class="line">            animation = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨stepAnimation()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;AppWindowAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stepAnimation</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (animation == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    transformation.clear();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> animationFrameTime = getAnimationFrameTime(animation, currentTime);</span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="keyword">boolean</span> hasMoreFrames = animation.getTransformation(animationFrameTime, transformation);</span><br><span class="line">    <span class="keyword">if</span> (!hasMoreFrames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deferThumbnailDestruction &amp;&amp; !deferFinalFrameCleanup) &#123;</span><br><span class="line">            deferFinalFrameCleanup = <span class="keyword">true</span>;</span><br><span class="line">            hasMoreFrames = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            deferFinalFrameCleanup = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mProlongAnimation == PROLONG_ANIMATION_AT_END) &#123;</span><br><span class="line">                hasMoreFrames = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setNullAnimation();</span><br><span class="line">                clearThumbnail();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    hasTransformation = hasMoreFrames;</span><br><span class="line">    <span class="keyword">return</span> hasMoreFrames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1.å°†æˆå‘˜å˜é‡transformationæ‰€æè¿°çš„å˜æ¢çŸ©é˜µçš„æ•°æ®æ¸…ç©º 2.è°ƒç”¨Animation.getTransformation()æ¥è®¡ç®—Activityç»„ä»¶åˆ‡æ¢åŠ¨ç”»ä¸‹ä¸€æ­¥æ‰€å¯¹åº”çš„å˜æ¢çŸ©é˜µï¼Œå¹¶ä¸”å°†è¿™ä¸ªå˜æ¢çŸ©é˜µçš„æ•°æ®ä¿å­˜åœ¨æˆå‘˜å˜é‡transformation</p><h3 id="6-4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹"><a href="#6-4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹" class="headerlink" title="6.4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹"></a>6.4ã€çª—å£åŠ¨ç”»çš„æ¨è¿›è¿‡ç¨‹</h3><p>ç»§ç»­åˆ†æWindowAnimator.animateLocked()çš„updateWindowsLocked()</p><h3 id="6-4-1ã€WindowAnimator-updateWindowsLocked"><a href="#6-4-1ã€WindowAnimator-updateWindowsLocked" class="headerlink" title="6.4.1ã€WindowAnimator.updateWindowsLocked()"></a>6.4.1ã€WindowAnimator.updateWindowsLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateWindowsLocked</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">    ++mAnimTransactionSequence;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> WindowList windows = mService.getWindowListLocked(displayId);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = windows.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        WindowState win = windows.get(i);</span><br><span class="line">        WindowStateAnimator winAnimator = win.mWinAnimator;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = win.mAttrs.flags;</span><br><span class="line">        <span class="keyword">boolean</span> canBeForceHidden = mPolicy.canBeForceHidden(win, win.mAttrs);</span><br><span class="line">        <span class="keyword">boolean</span> shouldBeForceHidden = shouldForceHide(win);</span><br><span class="line">        <span class="keyword">if</span> (winAnimator.hasSurface()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> wasAnimating = winAnimator.mWasAnimating;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> nowAnimating = winAnimator.stepAnimationLocked(mCurrentTime);</span><br><span class="line">            winAnimator.mWasAnimating = nowAnimating;</span><br><span class="line">            orAnimating(nowAnimating);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WindowStateAnimator.stepAnimationLocked() å¦‚æœçª—å£çš„åŠ¨ç”»å°šæœªç»“æŸæ˜¾ç¤ºï¼Œé‚£ä¹ˆstepAnimationLocked()ä¼šè¿”å›ä¸€ä¸ªtrueå€¼ç»™è°ƒç”¨è€…ï¼Œå¦åˆ™çš„è¯ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªfalseå€¼ç»™è°ƒç”¨è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">stepAnimationLocked</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Save the animation state as it was before this step so WindowManagerService can tell if</span></span><br><span class="line">        <span class="comment">// we just started or just stopped animating by comparing mWasAnimating with isAnimationSet().</span></span><br><span class="line">        mWasAnimating = mAnimating;</span><br><span class="line">        <span class="keyword">final</span> DisplayContent displayContent = mWin.getDisplayContent();</span><br><span class="line">        <span class="keyword">if</span> (displayContent != <span class="keyword">null</span> &amp;&amp; mService.okToDisplay()) &#123;</span><br><span class="line">            <span class="comment">// We will run animations as long as the display isn't frozen.</span></span><br><span class="line">            <span class="keyword">if</span> (mWin.isDrawnLw() &amp;&amp; mAnimation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mHasTransformation = <span class="keyword">true</span>;</span><br><span class="line">                mHasLocalTransformation = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (!mLocalAnimating) &#123;</span><br><span class="line">                    <span class="keyword">final</span> DisplayInfo displayInfo = displayContent.getDisplayInfo();</span><br><span class="line">                    <span class="keyword">if</span> (mAnimateMove) &#123;</span><br><span class="line">                        mAnimateMove = <span class="keyword">false</span>;</span><br><span class="line">                        mAnimation.initialize(mWin.mFrame.width(), mWin.mFrame.height(),</span><br><span class="line">                                mAnimDx, mAnimDy);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mAnimation.initialize(mWin.mFrame.width(), mWin.mFrame.height(),</span><br><span class="line">                                displayInfo.appWidth, displayInfo.appHeight);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mAnimDx = displayInfo.appWidth;</span><br><span class="line">                    mAnimDy = displayInfo.appHeight;</span><br><span class="line">                    mAnimation.setStartTime(mAnimationStartTime != -<span class="number">1</span></span><br><span class="line">                            ? mAnimationStartTime</span><br><span class="line">                            : currentTime);</span><br><span class="line">                    mLocalAnimating = <span class="keyword">true</span>;</span><br><span class="line">                    mAnimating = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((mAnimation != <span class="keyword">null</span>) &amp;&amp; mLocalAnimating) &#123;</span><br><span class="line">                    mLastAnimationTime = currentTime;</span><br><span class="line">                    <span class="keyword">if</span> (stepAnimation(currentTime)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowStateAnimator.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stepAnimation</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    currentTime = getAnimationFrameTime(mAnimation, currentTime);</span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    mTransformation.clear();</span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> more = mAnimation.getTransformation(currentTime, mTransformation);</span><br><span class="line">    <span class="keyword">if</span> (mAnimationStartDelayed &amp;&amp; mAnimationIsEntrance) &#123;</span><br><span class="line">        mTransformation.setAlpha(<span class="number">0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> more;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€å°†æˆå‘˜å˜é‡mTransformationæ‰€æè¿°çš„å˜æ¢çŸ©é˜µçš„æ•°æ®æ¸…ç©ºã€‚ 2ã€è°ƒç”¨mAnimation.getTransformation()æ¥è®¡ç®—çª—å£åŠ¨ç”»ä¸‹ä¸€æ­¥æ‰€å¯¹åº”çš„å˜æ¢çŸ©é˜µï¼Œå¹¶ä¸”å°†è¿™ä¸ªå˜æ¢çŸ©é˜µçš„æ•°æ®ä¿å­˜åœ¨æˆå‘˜å˜é‡mTransformationã€‚</p><p>ç„¶åå°±æ˜¯åŠ¨ç”»è¿‡åï¼Œçª—å£å¤§å°è®¡ç®—ã€æ¸²æŸ“åˆæˆç­‰ç­‰æ˜¾ç¤ºæ­¥éª¤äº†ï¼Œç”±äºä¹‹å‰å·²ç»åˆ†æè¿‡äº†ï¼Œä¸å†åˆ†æäº†ï¼š 3ã€å¾ªç¯éå†ä¿å­˜åœ¨çª—å£å †æ ˆçš„æ¯ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªçª—å£çš„ç»˜å›¾è¡¨é¢è¿›è¡Œæ›´æ–° ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java::animateLocked()]</span><br><span class="line"><span class="comment">//ç¡®å®šè¯¥çª—å£å®é™…è¦æ˜¾ç¤ºçš„å¤§å°ã€ä½ç½®ã€Alphaé€šé“å’Œå˜æ¢çŸ©é˜µç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++) &#123;</span><br><span class="line">    windows.get(j).mWinAnimator.prepareSurfaceLocked(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4ã€è§¦å‘ä¸‹ä¸€å¸§åŠ¨ç”»é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java::animateLocked()]</span><br><span class="line"><span class="keyword">if</span> (mAnimating) &#123;</span><br><span class="line">    mService.scheduleAnimationLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5ã€åˆ·æ–°ç³»ç»ŸUI</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;WindowAnimator.java::animateLocked()]</span><br><span class="line"><span class="keyword">if</span> (hasPendingLayoutChanges || doRequest) &#123;</span><br><span class="line">    mWindowPlacerLocked.requestTraversal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç»è¿‡SurfaceFlingeråˆæˆæ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚ æ€»ä½“æµç¨‹å›¾(â€¦)ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.wms/20-Android-WMS-animation_Locked-time-diagram.png" alt="Markdown"></p><h2 id="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h2><p><a href="https://www.bbsmax.com/A/n2d9gjgJDv/" target="_blank" rel="noopener">æµ…æ Android çš„çª—å£</a><br><a href="https://www.jianshu.com/p/2faedc664d11" target="_blank" rel="noopener">WMS:çª—å£å¤§å°çš„è®¡ç®—</a><br><a href="http://blog.csdn.net/luozirong/article/details/70256809" target="_blank" rel="noopener">Android çª—å£çš„è®¡ç®—è¿‡ç¨‹</a><br><a href="http://blog.csdn.net/qian520ao/article/details/78555397" target="_blank" rel="noopener">Android Window æœºåˆ¶æ¢ç´¢</a><br><a href="https://calvinlee.github.io/blog/2012/04/21/android-window-management-architecture/" target="_blank" rel="noopener">Android çª—å£ç®¡ç† - ä¸”å¬é£åŸ</a><br><a href="http://www.cnblogs.com/all-for-fiona/p/4054527.html" target="_blank" rel="noopener">Android å…³äºWindow Overscan</a><br><a href="http://blog.csdn.net/guoqifa29/article/details/49273065" target="_blank" rel="noopener">WindowManagerServiceåŠ¨ç”»åˆ†æ</a><br><a href="http://blog.csdn.net/guoqifa29/article/details/46819377" target="_blank" rel="noopener">æ·±å…¥ç†è§£Activityâ€”-Tokenä¹‹æ—… - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/37737439" target="_blank" rel="noopener">Android 4.4(KitKat)çª—å£ç®¡ç†å­ç³»ç»Ÿ - ä½“ç³»æ¡†æ¶</a><br><a href="https://www.jianshu.com/p/c2e48b3e33a0" target="_blank" rel="noopener">Androidçª—å£ç³»ç»Ÿç¬¬å››ç¯‡â€”ActivityåŠ¨ç”»çš„è®¾ç½®è¿‡ç¨‹</a><br><a href="http://blog.csdn.net/lin20044140410/article/details/78798048" target="_blank" rel="noopener">Android 7.1 GUIç³»ç»Ÿ-çª—å£ç®¡ç†WMS-Surfaceç®¡ç†ï¼ˆå››ï¼‰</a><br><a href="http://www.cnblogs.com/samchen2009/p/3367496.html" target="_blank" rel="noopener">Android çš„çª—å£ç®¡ç†ç³»ç»Ÿ (View, Canvas, WindowManager)</a><br><a href="http://gityuan.com/2017/01/15/wms_starting_window/" target="_blank" rel="noopener">WMSâ€“å¯åŠ¨çª—å£(StartingWindow) - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢</a><br><a href="https://www.jianshu.com/p/a65861e946cb" target="_blank" rel="noopener">Viewç»˜åˆ¶æµç¨‹åŠæºç è§£æ(ä¸€)â€”-performTraversals()æºç åˆ†æ</a><br><a href="http://blog.csdn.net/u013263323/article/details/78482141" target="_blank" rel="noopener">Androidçª—å£ç³»ç»Ÿç¬¬ä¸‰ç¯‡â€”WindowManagerServiceä¸­çª—å£çš„ç»„ç»‡æ–¹å¼</a><br><a href="https://juejin.im/entry/58c899bea22b9d006411241c" target="_blank" rel="noopener">google è¿›å…¥åˆ†å±ååœ¨æ¨ªå±æ¨¡å¼æŒ‰ home é”®ç•Œé¢é”™ä¹± (äºŒ) - Android - æ˜é‡‘</a><br><a href="http://blog.csdn.net/yanbober/article/details/46361191" target="_blank" rel="noopener">Androidåº”ç”¨Activityã€Dialogã€PopWindowã€Toastçª—å£æ·»åŠ æœºåˆ¶åŠæºç åˆ†æ</a><br><a href="http://blog.csdn.net/luoshengyang/article/details/8462738" target="_blank" rel="noopener">Androidçª—å£ç®¡ç†æœåŠ¡WindowManagerServiceçš„ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’ - CSDNåšå®¢</a><br><a href="https://www.jianshu.com/p/40776c123adb" target="_blank" rel="noopener">Androidçª—å£ç®¡ç†åˆ†æï¼ˆ2ï¼‰ï¼šWindowManagerServiceçª—å£ç®¡ç†ä¹‹Windowæ·»åŠ æµç¨‹</a><br><a href="http://blog.csdn.net/luoshengyang/article/details/8611754" target="_blank" rel="noopener">Androidçª—å£ç®¡ç†æœåŠ¡WindowManagerServiceæ˜¾ç¤ºçª—å£åŠ¨ç”»çš„åŸç†åˆ†æ - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/kc58236582/article/details/53782138" target="_blank" rel="noopener">Android6.0 WMSï¼ˆäº”ï¼‰ WMSè®¡ç®—Activityçª—å£å¤§å°çš„è¿‡ç¨‹åˆ†æï¼ˆäºŒï¼‰WMSçš„relayoutWindow</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-çª—å£ç®¡ç†æœåŠ¡åˆ†æ-i-wonder/">http://zhoujinjian.cc/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-çª—å£ç®¡ç†æœåŠ¡åˆ†æ-i-wonder/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-ç³»ç»Ÿåˆ†æ/" title="Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]"><i class="iconfont icon-prev"></i>Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]</a></div><div class="post__prev post__prev--right"><a href="/2018/04/01/Linuxå†…æ ¸ï¼ˆKernel-3-18ï¼‰-Input-å­ç³»ç»Ÿåˆ†æ-i-wonder/" title="Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]">Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">13</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/05/25/Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ/" title="Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.15.jpg" alt="Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ"></div><div class="item__info"><h3 class="item__title">Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ</h3><span class="item__text">2018-05-25</span></div></a></li><li class="latest-post-item"><a href="/2018/05/15/Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ/" title="Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.14.jpg" alt="Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ"></div><div class="item__info"><h3 class="item__title">Audio Systemï¼ˆ2ï¼‰ï¼šLinux ALSAéŸ³é¢‘ç³»ç»Ÿåˆ†æ</h3><span class="item__text">2018-05-15</span></div></a></li><li class="latest-post-item"><a href="/2018/05/01/Audio Systemï¼ˆ1ï¼‰ï¼šLinux && Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ/" title="Audio Systemï¼ˆ1ï¼‰ï¼šLinux && Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.13.jpg" alt="Audio Systemï¼ˆ1ï¼‰ï¼šLinux && Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ"></div><div class="item__info"><h3 class="item__title">Audio Systemï¼ˆ1ï¼‰ï¼šLinux && Android Audio ç³»ç»Ÿæ¡†æ¶åˆ†æ</h3><span class="item__text">2018-05-01</span></div></a></li><li class="latest-post-item"><a href="/2018/04/20/Google Pixel Oreo 8.1 OPM2.171019.029 Root äº²æµ‹æˆåŠŸ/" title="Google Pixel Oreo 8.1 OPM2.171019.029 Root äº²æµ‹æˆåŠŸ [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.12.jpg" alt="Google Pixel Oreo 8.1 OPM2.171019.029 Root äº²æµ‹æˆåŠŸ [i.wonder~]"></div><div class="item__info"><h3 class="item__title">Google Pixel Oreo 8.1 OPM2.171019.029 Root äº²æµ‹æˆåŠŸ [i.wonder~]</h3><span class="item__text">2018-04-20</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">237.4k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>