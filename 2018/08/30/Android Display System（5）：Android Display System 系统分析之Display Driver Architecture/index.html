<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" alt="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"></div><header class="post__info"><h1 class="post__title">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://www.github.com/izhoujinjian">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-08-30</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"><span class="toc-text">1.1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-1ã€æºä»£ç "><span class="toc-text">1.1.1ã€æºä»£ç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2ã€ç¼–è¯‘æµ‹è¯•"><span class="toc-text">1.1.2ã€ç¼–è¯‘æµ‹è¯•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-3ã€æ˜¾ç¤ºæ•ˆæœ"><span class="toc-text">1.1.3ã€æ˜¾ç¤ºæ•ˆæœ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰"><span class="toc-text">1.1.4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾"><span class="toc-text">1.1.5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ"><span class="toc-text">ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1ã€-Framebufferæ•°æ®ç»“æ„"><span class="toc-text">2.1ã€ Framebufferæ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1ã€-fb-info"><span class="toc-text">2.1.1ã€ fb_info</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2ã€fb-var-screeninfo"><span class="toc-text">2.1.2ã€fb_var_screeninfo</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-3ã€fb-fix-screeninfo"><span class="toc-text">2.1.3ã€fb_fix_screeninfo</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹"><span class="toc-text">2.2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€MDP-driver"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€MDP driver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå››ï¼‰ã€DSI-controller-driver-ï¼ˆlcdé©±åŠ¨-dsiï¼‰"><span class="toc-text">ï¼ˆå››ï¼‰ã€DSI controller driver ï¼ˆlcdé©±åŠ¨ dsiï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆäº”ï¼‰ã€-Panel-driver-ï¼ˆé¢æ¿-dsiï¼‰"><span class="toc-text">ï¼ˆäº”ï¼‰ã€ Panel driver ï¼ˆé¢æ¿ dsiï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1ã€-dtsiæ–‡ä»¶è§£æ"><span class="toc-text">5.1ã€.dtsiæ–‡ä»¶è§£æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2ã€mdss-mdp-å’Œ-mdss-dsi0-çš„å…³ç³»"><span class="toc-text">5.2ã€mdss_mdp å’Œ mdss_dsi0 çš„å…³ç³»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨"><span class="toc-text">5.3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1ã€å¯åŠ¨"><span class="toc-text">5.3.1ã€å¯åŠ¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2ã€æš‚åœ-æ¢å¤"><span class="toc-text">5.3.2ã€æš‚åœ/æ¢å¤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2-1ã€æš‚åœåºåˆ—"><span class="toc-text">5.3.2.1ã€æš‚åœåºåˆ—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2-2ã€æ¢å¤åºåˆ—"><span class="toc-text">5.3.2.2ã€æ¢å¤åºåˆ—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿"><span class="toc-text">5.4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå…­ï¼‰ã€Msm8610-lcd-driver-å†…æ ¸åˆå§‹åŒ–åˆ†æ"><span class="toc-text">ï¼ˆå…­ï¼‰ã€Msm8610 lcd driver å†…æ ¸åˆå§‹åŒ–åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div><hr><p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p><p><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/display.system" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></p><p><a href="https://blog.csdn.net/eliot_shao/article/details/74926010" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - é«˜é€šAndroidå¹³å°-åº”ç”¨ç©ºé—´æ“ä½œframebuffer dump LCDæ€»ç»“ã€‘</a><br><a href="https://blog.csdn.net/u012719256/article/details/52096727" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - linux qcom LCD framworkã€‘</a><br><a href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347" target="_blank" rel="noopener">ã€ç‰¹åˆ«æ„Ÿè°¢ - msm8610 lcd driver code analysisã€‘</a></p><p>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br><a href="https://github.com/matthewdalex/marlin" target="_blank" rel="noopener">Kernel source for Pixel and Pixel XL - GitHub</a></p><p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br><a href="https://testerhome.com/topics/2229" target="_blank" rel="noopener">Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p><p>ğŸŒ€ğŸŒ€ï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶</p><p>ã€Android Display System ç³»ç»Ÿåˆ†æç³»åˆ—ã€‘ï¼š<br>ã€Android Display Systemï¼ˆ1ï¼‰ï¼šAndroid 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL &amp;&amp; OpenGLã€‘<br>ã€Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc &amp;&amp; HWComposeræ¨¡å—åˆ†æã€‘<br>ã€Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architectureã€‘</p><hr><p>è·¯å¾„ï¼š<br>kernel\msm-3.18\drivers\video\msm\mdss</p><p>MDSS driver software block diagram</p><ul><li>mdss_fb â†’ Top-level IOCTL/native framebufferinterface</li><li>mdss_mdp.c â†’ MDP resources(clocks/irq/bus-bw/power)</li><li>mdss_mdp_overlay â†’ Overlay/DMA top-levelAPI</li><li>mdss_mdp_ctl â†’ Controls the hardware abstraction to club the (LM + DSPP + Ping-pong +<br>interface)</li><li>mdss_mdp_pipe â†’ SRC pipe related handling</li><li>mdss_mdp_intf_cmd/mdss_mdp_intf_video/mdss_mdp_intf_writeback â†’ MDP panel<br>interface relatedhandling</li><li>mdss_mdp_pp â†’ Postprocessing related implementation</li><li>mdss_mdp_rotator â†’ Rotator APIs (overlay_set/overlay_playinterface)</li><li>mdss_mdp_pp.c â†’ Postprocessing relatedmaterial</li></ul><hr><p><strong>æ³¨ï¼š</strong>é¦–å…ˆè¯´æ˜ï¼Œç”±äºåšä¸»ä¸æ˜¯kernelå¼€å‘æ–¹å‘çš„ï¼Œå¯èƒ½ç†è§£ä¸å¤Ÿé€å½»ï¼Œè¿˜è¯·çœ‹å®˜è§è°…ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç†è§£Kernel DisplayåŸç†ã€‚ä¸ºäº†åŠ æ·±å¯¹æ˜¾ç¤ºå±å·¥ä½œåŸç†çš„ç†è§£ï¼Œé¦–å…ˆå…ˆçœ‹ä¸¤ä¸ªæ“ä½œLCDæ˜¾ç¤ºå±çš„ä¾‹å­<br>ç»ªè®ºï¼ˆæ€»ä½“æ¶æ„å›¾ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-01-Display-Architecture.png" alt="Alt text | center"></p><h4 id="ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"><a href="#ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"></a>ï¼ˆä¸€ï¼‰ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ</h4><h5 id="1-1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"><a href="#1-1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ" class="headerlink" title="1.1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ"></a>1.1ã€ç›´æ¥æ“ä½œframebufferæ˜¾ç¤ºå›¾åƒ</h5><h5 id="1-1-1ã€æºä»£ç "><a href="#1-1-1ã€æºä»£ç " class="headerlink" title="1.1.1ã€æºä»£ç "></a>1.1.1ã€æºä»£ç </h5><p><strong>panel_test.c</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fb.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"yellow_face.zif"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> fbfd = <span class="number">0</span>;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">vinfo</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">finfo</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_cmap</span> <span class="title">cmapinfo</span>;</span>  </span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> screensize = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">char</span> *fbp = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> location = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">int</span> b,g,r;  </span><br><span class="line">    <span class="comment">// Open the file for reading and writing  </span></span><br><span class="line">    fbfd = open(<span class="string">"/dev/graphics/fb0"</span>, O_RDWR,<span class="number">0</span>);                    <span class="comment">// æ‰“å¼€Frame Bufferè®¾å¤‡  </span></span><br><span class="line">    <span class="keyword">if</span> (fbfd &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error: cannot open framebuffer device.%x\n"</span>,fbfd);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The framebuffer device was opened successfully.\n"</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Get fixed screen information  </span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fbfd, FBIOGET_FSCREENINFO, &amp;finfo)) &#123;            <span class="comment">// è·å–è®¾å¤‡å›ºæœ‰ä¿¡æ¯  </span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error reading fixed information.\n"</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">2</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\ntype:0x%x\n"</span>, finfo.type );                            <span class="comment">// FrameBuffer ç±»å‹,å¦‚0ä¸ºè±¡ç´   </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"visual:%d\n"</span>, finfo.visual );                        <span class="comment">// è§†è§‰ç±»å‹ï¼šå¦‚çœŸå½©2ï¼Œä¼ªå½©3   </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"line_length:%d\n"</span>, finfo.line_length );        <span class="comment">// æ¯è¡Œé•¿åº¦  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\nsmem_start:0x%lx,smem_len:%u\n"</span>, finfo.smem_start, finfo.smem_len ); <span class="comment">// æ˜ è±¡RAMçš„å‚æ•°  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"mmio_start:0x%lx ,mmio_len:%u\n"</span>, finfo.mmio_start, finfo.mmio_len );  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">// Get variable screen information  </span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fbfd, FBIOGET_VSCREENINFO, &amp;vinfo)) &#123;            <span class="comment">// è·å–è®¾å¤‡å¯å˜ä¿¡æ¯  </span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error reading variable information.\n"</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">3</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%dx%d, %dbpp,xres_virtual=%d,yres_virtual=%dvinfo.xoffset=%d,vinfo.yoffset=%d\n"</span>, vinfo.xres, vinfo.yres, vinfo.bits_per_pixel,vinfo.xres_virtual,vinfo.yres_virtual,vinfo.xoffset,vinfo.yoffset);  </span><br><span class="line"></span><br><span class="line">	screensize = finfo.line_length * vinfo.yres_virtual;</span><br><span class="line">    <span class="comment">// Map the device to memory é€šè¿‡mmapç³»ç»Ÿè°ƒç”¨å°†framebufferå†…å­˜æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´,å¹¶è¿”å›æ˜ å°„åçš„èµ·å§‹åœ°å€  </span></span><br><span class="line">    fbp = (<span class="keyword">char</span> *)mmap(<span class="number">0</span>, screensize, PROT_READ | PROT_WRITE, MAP_SHARED,fbfd, <span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">int</span>)fbp == <span class="number">-1</span>) &#123;  </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error: failed to map framebuffer device to memory.\n"</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">4</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The framebuffer device was mapped to memory successfully.\n"</span>);  </span><br><span class="line"><span class="comment">/***************exampel 1**********************/</span></span><br><span class="line">	b = <span class="number">10</span>;</span><br><span class="line">	g = <span class="number">100</span>;</span><br><span class="line">	r = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">for</span> ( y = <span class="number">0</span>; y &lt; <span class="number">340</span>; y++ )</span><br><span class="line">        <span class="keyword">for</span> ( x = <span class="number">0</span>; x &lt; <span class="number">420</span>; x++ ) &#123; </span><br><span class="line">      </span><br><span class="line">         location = (x+<span class="number">100</span>) * (vinfo.bits_per_pixel/<span class="number">8</span>) + </span><br><span class="line">             (y+<span class="number">100</span>) * finfo.line_length; </span><br><span class="line">      </span><br><span class="line">         <span class="keyword">if</span> ( vinfo.bits_per_pixel == <span class="number">32</span> ) &#123;        <span class="comment">//          </span></span><br><span class="line">                        *(fbp + location) = b; <span class="comment">// Some blue  </span></span><br><span class="line">                        *(fbp + location + <span class="number">1</span>) = g;             <span class="comment">// A little green  </span></span><br><span class="line">                        *(fbp + location + <span class="number">2</span>) = r;             <span class="comment">// A lot of red  </span></span><br><span class="line">                        *(fbp + location + <span class="number">3</span>) = <span class="number">0</span>;     <span class="comment">// No transparency  </span></span><br><span class="line">         &#125;</span><br><span class="line">      </span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/*****************exampel 1********************/</span></span><br><span class="line"><span class="comment">/*****************exampel 2********************/</span>		</span><br><span class="line"> 	<span class="keyword">unsigned</span> <span class="keyword">char</span> *pTemp = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)fbp;</span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line">	<span class="comment">//èµ·å§‹åæ ‡(x,y),ç»ˆç‚¹åæ ‡(right,bottom)</span></span><br><span class="line">	x = <span class="number">400</span>;</span><br><span class="line">	y = <span class="number">400</span>;</span><br><span class="line">	<span class="keyword">int</span> right = <span class="number">700</span>;<span class="comment">//vinfo.xres;</span></span><br><span class="line">	<span class="keyword">int</span> bottom = <span class="number">1000</span>;<span class="comment">//vinfo.yres;</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=y; i&lt; bottom; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=x; j&lt;right; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">short</span> data = yellow_face_data[(((i-y)  % <span class="number">128</span>) * <span class="number">128</span>) + ((j-x) %<span class="number">128</span>)];</span><br><span class="line">			pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">2</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0xF800</span>) &gt;&gt; <span class="number">11</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">			pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0x7E0</span>) &gt;&gt; <span class="number">5</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line">			pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">0</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">3</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line"><span class="comment">/*****************exampel 2********************/</span>	</span><br><span class="line"><span class="comment">//noteï¼švinfo.xoffset =0 vinfo.yoffset =0 å¦åˆ™FBIOPAN_DISPLAYä¸æˆåŠŸ</span></span><br><span class="line">	<span class="keyword">if</span> (ioctl(fbfd, FBIOPAN_DISPLAY, &amp;vinfo)) &#123;    </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Error FBIOPAN_DISPLAY information.\n"</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">5</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">	sleep(<span class="number">10</span>);</span><br><span class="line">	munmap(fbp,finfo.smem_len);<span class="comment">//finfo.smem_len == screensize == finfo.line_length * vinfo.yres_virtual </span></span><br><span class="line">    close(fbfd);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Android.mk</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Copyright 2006-2014 The Android Open Source Project</span><br><span class="line"></span><br><span class="line">LOCAL_PATH:= $(call my-dir)</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES:= panel_test.c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOCAL_SHARED_LIBRARIES        := $(common_libs) libqdutils libdl liblog libbase libcutils</span><br><span class="line">LOCAL_C_INCLUDES              := $(common_includes) $(kernel_includes)</span><br><span class="line">LOCAL_ADDITIONAL_DEPENDENCIES := $(common_deps) $(kernel_deps)</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE := panel_test</span><br><span class="line"></span><br><span class="line">LOCAL_CFLAGS := -Werror</span><br><span class="line"></span><br><span class="line">include $(BUILD_EXECUTABLE)</span><br><span class="line"></span><br><span class="line">include $(call first-makefiles-under,$(LOCAL_PATH))</span><br></pre></td></tr></table></figure><p><strong>yellow_face.zif</strong><br><a href="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-yellow_face.zif" target="_blank" rel="noopener">yellow_face.zif</a></p><h5 id="1-1-2ã€ç¼–è¯‘æµ‹è¯•"><a href="#1-1-2ã€ç¼–è¯‘æµ‹è¯•" class="headerlink" title="1.1.2ã€ç¼–è¯‘æµ‹è¯•"></a>1.1.2ã€ç¼–è¯‘æµ‹è¯•</h5><p>ç¼–è¯‘ä¼šç”Ÿæˆpanel_testï¼Œç„¶åè¿›è¡Œæµ‹è¯•ã€‚</p><blockquote><p>æ³¨æ„äº‹é¡¹ï¼š<br>1ã€adb shell stop æ€æ‰surfaceflinger ä¹‹ååœ¨æµ‹è¯•ï¼›<br>2ã€è®¾ç½®èƒŒå…‰ echo 255 &gt; /sys/class/leds/lcd-backlight/brightness</p><p>1ã€è¿æ¥adb<br>2ã€adb push panel_test system/bin<br>3ã€è¿›å…¥adb shell<br>4ã€stop<br>5ã€echo 255 &gt; /sys/class/leds/lcd-backlight/brightness<br>6ã€system/bin/panel_test</p></blockquote><h5 id="1-1-3ã€æ˜¾ç¤ºæ•ˆæœ"><a href="#1-1-3ã€æ˜¾ç¤ºæ•ˆæœ" class="headerlink" title="1.1.3ã€æ˜¾ç¤ºæ•ˆæœ"></a>1.1.3ã€æ˜¾ç¤ºæ•ˆæœ</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-02-Qcom_FrameBuffer_test_.gif" alt="Alt text | center"></p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-03-yellow_face_zif_test.jpg" alt="Alt text | center"></p><h5 id="1-1-4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰"><a href="#1-1-4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰" class="headerlink" title="1.1.4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰"></a>1.1.4ã€è§†é¢‘ï¼ˆåŠ æ·±ç†è§£ã€è‡ªâ˜¯å¤‡â˜¯æ¢¯â˜¯å­ï¼‰</h5><p><a href="https://www.youtube.com/watch?v=BUPPyR6VasI" target="_blank" rel="noopener">Android Frame Buffer and Screen Shots Tutorial</a><br><a href="https://www.youtube.com/watch?v=7n_hDZ6kHjc" target="_blank" rel="noopener">Mplayer on Android Through Chroot and Frame Buffer</a></p><h5 id="1-1-5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾"><a href="#1-1-5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾" class="headerlink" title="1.1.5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾"></a>1.1.5ã€é©±åŠ¨æ€»ä½“æ¦‚è§ˆå›¾</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-04-msm8x25-display-overview.png" alt="Alt text | center"></p><h4 id="ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ"><a href="#ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ" class="headerlink" title="ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ"></a>ï¼ˆäºŒï¼‰ã€FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ</h4><p>FrameBufferé€šå¸¸ä½œä¸ºLCDæ§åˆ¶å™¨æˆ–è€…å…¶ä»–æ˜¾ç¤ºè®¾å¤‡çš„é©±åŠ¨ï¼ŒFrameBufferé©±åŠ¨æ˜¯ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œè®¾å¤‡èŠ‚ç‚¹æ˜¯/dev/fbXï¼ˆAndroid è®¾å¤‡ä¸º/dev/graphics/fb0ï¼‰ï¼Œä¸»è®¾å¤‡å·ä¸º29ï¼Œæ¬¡è®¾å¤‡å·é€’å¢ï¼Œç”¨æˆ·å¯ä»¥å°†Framebufferçœ‹æˆæ˜¯æ˜¾ç¤ºå†…å­˜çš„ä¸€ä¸ªæ˜ åƒï¼Œå°†å…¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œè€Œå†™æ“ä½œå¯ä»¥ç«‹å³ååº”åœ¨å±å¹•ä¸Šã€‚è¿™ç§æ“ä½œæ˜¯æŠ½è±¡çš„ï¼Œç»Ÿä¸€çš„ã€‚ç”¨æˆ·ä¸å¿…å…³å¿ƒç‰©ç†æ˜¾å­˜çš„ä½ç½®ã€æ¢é¡µæœºåˆ¶ç­‰ç­‰å…·ä½“ç»†èŠ‚ã€‚è¿™äº›éƒ½æ˜¯ç”±Framebufferè®¾å¤‡é©±åŠ¨æ¥å®Œæˆçš„ã€‚Framebufferè®¾å¤‡ä¸ºä¸Šå±‚åº”ç”¨ç¨‹åºæä¾›ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿä¸ºä¸‹ä¸€å±‚çš„ç‰¹å®šç¡¬ä»¶é©±åŠ¨æä¾›æ¥å£ï¼›é‚£äº›åº•å±‚ç¡¬ä»¶é©±åŠ¨éœ€è¦ç”¨åˆ°è¿™å„¿çš„æ¥å£æ¥å‘ç³»ç»Ÿå†…æ ¸æ³¨å†Œå®ƒä»¬è‡ªå·±ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-05-mdss-driver-architecture.png" alt="Alt text | center"></p><p>Linuxä¸­çš„PCIè®¾å¤‡å¯ä»¥å°†å…¶æ§åˆ¶å¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜ç©ºé—´ï¼Œè€Œåï¼Œå¯¹è¿™äº›æ§åˆ¶å¯„å­˜å™¨çš„è®¿é—®å˜æˆäº†å¯¹ç†å†…å­˜çš„è®¿é—®ï¼Œå› æ­¤ï¼Œè¿™äº›å¯„å­˜å™¨åˆè¢«ç§°ä¸ºâ€memioâ€ã€‚ä¸€æ—¦è¢«æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼ŒLinuxçš„æ™®é€šè¿›ç¨‹å°±å¯ä»¥é€šè¿‡mmapå°†è¿™äº›å†…å­˜I/Oæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è®¿é—®è¿™äº›å¯„å­˜å™¨äº†ã€‚</p><p>FrameBufferè®¾å¤‡å±äºå­—ç¬¦è®¾å¤‡ï¼Œé‡‡ç”¨äº†æ–‡ä»¶å±‚â€”é©±åŠ¨å±‚çš„æ¥å£æ–¹å¼ï¼ŒLinuxä¸ºå¸§ç¼“å†²è®¾å¤‡å®šä¹‰äº†é©±åŠ¨å±‚çš„æ¥å£fb_infoç»“æ„ï¼Œåœ¨æ–‡ä»¶å±‚ä¸Šï¼Œç”¨æˆ·è°ƒç”¨file_operationsçš„å‡½æ•°æ“ä½œï¼Œé—´æ¥è°ƒç”¨fb_infoä¸­çš„fb_opså‡½æ•°é›†æ¥æ“ä½œç¡¬ä»¶ã€‚</p><h5 id="2-1ã€-Framebufferæ•°æ®ç»“æ„"><a href="#2-1ã€-Framebufferæ•°æ®ç»“æ„" class="headerlink" title="2.1ã€ Framebufferæ•°æ®ç»“æ„"></a>2.1ã€ Framebufferæ•°æ®ç»“æ„</h5><h5 id="2-1-1ã€-fb-info"><a href="#2-1-1ã€-fb-info" class="headerlink" title="2.1.1ã€ fb_info"></a>2.1.1ã€ fb_info</h5><p>fb_infoæ˜¯Linuxä¸ºå¸§ç¼“å†²è®¾å¤‡å®šä¹‰çš„é©±åŠ¨å±‚æ¥å£ã€‚å®ƒä¸ä»…åŒ…å«äº†åº•å±‚å‡½æ•°ï¼Œè€Œä¸”è¿˜æœ‰è®°å½•è®¾å¤‡çŠ¶æ€çš„æ•°æ®ã€‚æ¯ä¸ªå¸§ç¼“å†²è®¾å¤‡éƒ½ä¸ä¸€ä¸ªfb_infoç»“æ„ç›¸å¯¹åº”ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;kernel\include\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span> count;</span><br><span class="line">	<span class="keyword">int</span> node;</span><br><span class="line">	<span class="keyword">int</span> flags;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span>		<span class="comment">/* Lock for open/release/ioctl funcs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mm_lock</span>;</span>		<span class="comment">/* Lock for fb_mmap and smem_* fields */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">var</span>;</span>	<span class="comment">/* Current var */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">fix</span>;</span>	<span class="comment">/* Current fix */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_monspecs</span> <span class="title">monspecs</span>;</span>	<span class="comment">/* Current Monitor specs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">queue</span>;</span>	<span class="comment">/* Framebuffer event queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_pixmap</span> <span class="title">pixmap</span>;</span>	<span class="comment">/* Image hardware mapper */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_pixmap</span> <span class="title">sprite</span>;</span>	<span class="comment">/* Cursor hardware mapper */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_cmap</span> <span class="title">cmap</span>;</span>		<span class="comment">/* Current cmap */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">modelist</span>;</span>      <span class="comment">/* mode list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_videomode</span> *<span class="title">mode</span>;</span>	<span class="comment">/* current mode */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span>		<span class="comment">/* current file node */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_DEFERRED_IO</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> <span class="title">deferred_work</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_deferred_io</span> *<span class="title">fbdefio</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> *<span class="title">fbops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span>		<span class="comment">/* This is the parent */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>		<span class="comment">/* This is this fb device */</span></span><br><span class="line">	<span class="keyword">int</span> class_flag;                    <span class="comment">/* private sysfs flags */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_TILEBLITTING</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_tile_ops</span> *<span class="title">tileops</span>;</span>    <span class="comment">/* Tile Blitting */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">char</span> __iomem *screen_base;	<span class="comment">/* Virtual address */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> screen_size;	<span class="comment">/* Amount of ioremapped VRAM or 0 */</span> </span><br><span class="line">	<span class="keyword">void</span> *pseudo_palette;		<span class="comment">/* Fake palette of 16 colors */</span> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FBINFO_STATE_RUNNING	0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FBINFO_STATE_SUSPENDED	1</span></span><br><span class="line">	u32 state;			<span class="comment">/* Hardware state i.e suspend */</span></span><br><span class="line">	<span class="keyword">void</span> *fbcon_par;                <span class="comment">/* fbcon use-only private area */</span></span><br><span class="line">	<span class="comment">/* From here on everything is device dependent */</span></span><br><span class="line">	<span class="keyword">void</span> *par;</span><br><span class="line">	<span class="comment">/* we need the PCI or similar aperture base/size not</span></span><br><span class="line"><span class="comment">	   smem_start/size as smem_start may just be an object</span></span><br><span class="line"><span class="comment">	   allocated inside the aperture so may not actually overlap */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">apertures_struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">aperture</span> &#123;</span></span><br><span class="line">			<span class="keyword">resource_size_t</span> base;</span><br><span class="line">			<span class="keyword">resource_size_t</span> size;</span><br><span class="line">		&#125; ranges[<span class="number">0</span>];</span><br><span class="line">	&#125; *apertures;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> skip_vt_switch; <span class="comment">/* no VT switch on suspend/resume required */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="2-1-2ã€fb-var-screeninfo"><a href="#2-1-2ã€fb-var-screeninfo" class="headerlink" title="2.1.2ã€fb_var_screeninfo"></a>2.1.2ã€fb_var_screeninfo</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-06-xres-yres.png" alt="Alt text | center"></p><p>fb_var_screeninfoï¼šç”¨äºè®°å½•ç”¨æˆ·å¯ä¿®æ”¹çš„æ˜¾ç¤ºæ§åˆ¶å™¨å‚æ•°ï¼ŒåŒ…æ‹¬å±å¹•åˆ†è¾¨ç‡ã€æ¯ä¸ªåƒç´ ç‚¹çš„æ¯”ç‰¹æ•°ç­‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\uapi\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> &#123;</span>  </span><br><span class="line">    __u32 xres;         <span class="comment">/* è¡Œå¯è§åƒç´ */</span>  </span><br><span class="line">    __u32 yres;         <span class="comment">/* åˆ—å¯è§åƒç´ */</span>  </span><br><span class="line">    __u32 xres_virtual; <span class="comment">/* è¡Œè™šæ‹Ÿåƒç´ */</span>  </span><br><span class="line">    __u32 yres_virtual; <span class="comment">/* åˆ—è™šæ‹Ÿåƒç´ */</span>  </span><br><span class="line">    __u32 xoffset;      <span class="comment">/* æ°´å¹³åç§»é‡*/</span>  </span><br><span class="line">    __u32 yoffset;      <span class="comment">/* å‚ç›´åç§»é‡*/</span>  </span><br><span class="line">    __u32 bits_per_pixel;<span class="comment">/*æ¯ä¸ªåƒç´ æ‰€å bitä½æ•°*/</span>  </span><br><span class="line">    __u32 grayscale;    <span class="comment">/* ç°è‰²åˆ»åº¦*/</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">red</span>;</span> <span class="comment">/* bitfield in fb mem if true color, */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">green</span>;</span>   <span class="comment">/* else only length is significant */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">blue</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">transp</span>;</span>  <span class="comment">/* transparency         */</span>    </span><br><span class="line">    __u32 nonstd;           <span class="comment">/* != 0 Non standard pixel format */</span>  </span><br><span class="line">    __u32 activate;         <span class="comment">/* see FB_ACTIVATE_*        */</span>  </span><br><span class="line">    __u32 height;           <span class="comment">/* å›¾åƒé«˜åº¦*/</span>  </span><br><span class="line">    __u32 width;            <span class="comment">/* å›¾åƒå®½åº¦*/</span>  </span><br><span class="line">    __u32 accel_flags;      <span class="comment">/* (OBSOLETE) see fb_info.flags */</span>  </span><br><span class="line">    __u32 pixclock;         <span class="comment">/* pixel clock in ps (pico seconds) */</span>  </span><br><span class="line">    __u32 left_margin;      <span class="comment">/* time from sync to picture    */</span>  </span><br><span class="line">    __u32 right_margin;     <span class="comment">/* time from picture to sync    */</span>  </span><br><span class="line">    __u32 upper_margin;     <span class="comment">/* time from sync to picture    */</span>  </span><br><span class="line">    __u32 lower_margin;  </span><br><span class="line">    __u32 hsync_len;        <span class="comment">/* length of horizontal sync    */</span>  </span><br><span class="line">    __u32 vsync_len;        <span class="comment">/* length of vertical sync  */</span>  </span><br><span class="line">    __u32 sync;         <span class="comment">/* see FB_SYNC_*        */</span>  </span><br><span class="line">    __u32 vmode;            <span class="comment">/* see FB_VMODE_*       */</span>  </span><br><span class="line">    __u32 rotate;           <span class="comment">/* angle we rotate counter clockwise */</span>  </span><br><span class="line">    __u32 reserved[<span class="number">5</span>];      <span class="comment">/* Reserved for future compatibility */</span>  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="2-1-3ã€fb-fix-screeninfo"><a href="#2-1-3ã€fb-fix-screeninfo" class="headerlink" title="2.1.3ã€fb_fix_screeninfo"></a>2.1.3ã€fb_fix_screeninfo</h5><p>fb_fix_screeninfoï¼šè®°å½•äº†ç”¨æˆ·ä¸èƒ½ä¿®æ”¹çš„æ˜¾ç¤ºæ§åˆ¶å™¨çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°æ˜¯åœ¨é©±åŠ¨åˆå§‹åŒ–æ—¶è®¾ç½®çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\uapi\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> &#123;</span></span><br><span class="line">	<span class="keyword">char</span> id[<span class="number">16</span>];			<span class="comment">/* identification string eg "TT Builtin" */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> smem_start;	<span class="comment">/* Start of frame buffer mem */</span></span><br><span class="line">					<span class="comment">/* (physical address) */</span></span><br><span class="line">	__u32 smem_len;			<span class="comment">/* Length of frame buffer mem */</span></span><br><span class="line">	__u32 type;			<span class="comment">/* see FB_TYPE_*		*/</span></span><br><span class="line">	__u32 type_aux;			<span class="comment">/* Interleave for interleaved Planes */</span></span><br><span class="line">	__u32 visual;			<span class="comment">/* see FB_VISUAL_*		*/</span> </span><br><span class="line">	__u16 xpanstep;			<span class="comment">/* zero if no hardware panning  */</span></span><br><span class="line">	__u16 ypanstep;			<span class="comment">/* zero if no hardware panning  */</span></span><br><span class="line">	__u16 ywrapstep;		<span class="comment">/* zero if no hardware ywrap    */</span></span><br><span class="line">	__u32 line_length;		<span class="comment">/* length of a line in bytes    */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mmio_start;	<span class="comment">/* Start of Memory Mapped I/O   */</span></span><br><span class="line">					<span class="comment">/* (physical address) */</span></span><br><span class="line">	__u32 mmio_len;			<span class="comment">/* Length of Memory Mapped I/O  */</span></span><br><span class="line">	__u32 accel;			<span class="comment">/* Indicate to driver which	*/</span></span><br><span class="line">					<span class="comment">/*  specific chip/card we have	*/</span></span><br><span class="line">	__u16 capabilities;		<span class="comment">/* see FB_CAP_*			*/</span></span><br><span class="line">	__u16 reserved[<span class="number">2</span>];		<span class="comment">/* Reserved for future compatibility */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>fb_opsæ˜¯æä¾›ç»™åº•å±‚è®¾å¤‡é©±åŠ¨çš„ä¸€ä¸ªæ¥å£ã€‚å½“æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªFrameBufferçš„æ—¶å€™ï¼Œå°±è¦ä¾ç…§Linux FrameBufferç¼–ç¨‹çš„å¥—è·¯ï¼Œå¡«å†™fb_opsç»“æ„ä½“ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> &#123;</span></span><br><span class="line">	<span class="comment">/* open/release and usage marking */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_open)(struct fb_info *info, <span class="keyword">int</span> user);</span><br><span class="line">	<span class="keyword">int</span> (*fb_release)(struct fb_info *info, <span class="keyword">int</span> user);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* For framebuffers with strange non linear layouts or that do not</span></span><br><span class="line"><span class="comment">	 * work with normal memory mapped access</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">ssize_t</span> (*fb_read)(struct fb_info *info, <span class="keyword">char</span> __user *buf,</span><br><span class="line">			   <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*fb_write)(struct fb_info *info, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span><br><span class="line">			    <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* checks var and eventually tweaks it to something supported,</span></span><br><span class="line"><span class="comment">	 * DO NOT MODIFY PAR */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_check_var)(struct fb_var_screeninfo *var, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set the video mode according to info-&gt;var */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_set_par)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set color register */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_setcolreg)(<span class="keyword">unsigned</span> regno, <span class="keyword">unsigned</span> red, <span class="keyword">unsigned</span> green,</span><br><span class="line">			    <span class="keyword">unsigned</span> blue, <span class="keyword">unsigned</span> transp, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set color registers in batch */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_setcmap)(struct fb_cmap *cmap, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* blank display */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_blank)(<span class="keyword">int</span> blank, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* pan display */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_pan_display)(struct fb_var_screeninfo *var, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Draws a rectangle */</span></span><br><span class="line">	<span class="keyword">void</span> (*fb_fillrect) (struct fb_info *info, <span class="keyword">const</span> struct fb_fillrect *rect);</span><br><span class="line">	<span class="comment">/* Copy data from area to another */</span></span><br><span class="line">	<span class="keyword">void</span> (*fb_copyarea) (struct fb_info *info, <span class="keyword">const</span> struct fb_copyarea *region);</span><br><span class="line">	<span class="comment">/* Draws a image to the display */</span></span><br><span class="line">	<span class="keyword">void</span> (*fb_imageblit) (struct fb_info *info, <span class="keyword">const</span> struct fb_image *image);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Draws cursor */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_cursor) (struct fb_info *info, struct fb_cursor *cursor);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Rotates the display */</span></span><br><span class="line">	<span class="keyword">void</span> (*fb_rotate)(struct fb_info *info, <span class="keyword">int</span> angle);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* wait for blit idle, optional */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_sync)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* perform fb specific ioctl (optional) */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_ioctl)(struct fb_info *info, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* perform fb specific ioctl v2 (optional) - provides file param */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_ioctl_v2)(struct fb_info *info, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> arg, struct file *file);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Handle 32bit compat ioctl (optional) */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_compat_ioctl)(struct fb_info *info, <span class="keyword">unsigned</span> cmd,</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Handle 32bit compat ioctl (optional) */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_compat_ioctl_v2)(struct fb_info *info, <span class="keyword">unsigned</span> cmd,</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> arg, struct file *file);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* perform fb specific mmap */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_mmap)(struct fb_info *info, struct vm_area_struct *vma);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* get capability given var */</span></span><br><span class="line">	<span class="keyword">void</span> (*fb_get_caps)(struct fb_info *info, struct fb_blit_caps *caps,</span><br><span class="line">			    struct fb_var_screeninfo *var);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* teardown any resources to do with this framebuffer */</span></span><br><span class="line">	<span class="keyword">void</span> (*fb_destroy)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* called at KDB enter and leave time to prepare the console */</span></span><br><span class="line">	<span class="keyword">int</span> (*fb_debug_enter)(struct fb_info *info);</span><br><span class="line">	<span class="keyword">int</span> (*fb_debug_leave)(struct fb_info *info);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="2-2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹"><a href="#2-2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹" class="headerlink" title="2.2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹"></a>2.2ã€Framebufferé©±åŠ¨æ³¨å†Œè¿‡ç¨‹</h5><p>åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå†…æ ¸è°ƒç”¨æ‰€æœ‰æ³¨å†Œé©±åŠ¨ç¨‹åºçš„é©±åŠ¨ç¨‹åºåˆå§‹åŒ–å‡½æ•°ã€‚ ä¸ºäº†å¸§ç¼“å†²åŒºé©±åŠ¨ç¨‹åºï¼Œè°ƒç”¨mdss_fb_initã€‚ mdss_fb_initæ³¨å†Œmdss_fb_driverã€‚é©±åŠ¨åœ¨mdss_fb.cæ–‡ä»¶ä¸­æ³¨å†Œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdss_fb_driver</span> = &#123;</span></span><br><span class="line">	.probe = mdss_fb_probe,</span><br><span class="line">	.remove = mdss_fb_remove,</span><br><span class="line">	.suspend = mdss_fb_suspend,</span><br><span class="line">	.resume = mdss_fb_resume,</span><br><span class="line">	.shutdown = mdss_fb_shutdown,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = <span class="string">"mdss_fb"</span>,</span><br><span class="line">		.of_match_table = mdss_fb_dt_match,</span><br><span class="line">		.pm = &amp;mdss_fb_pm_ops,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨initä¹‹åï¼Œå†…æ ¸è°ƒç”¨æ¯ä¸ªå¹³å°é©±åŠ¨ç¨‹åºçš„æ¢æµ‹å‡½æ•°ã€‚ åœ¨è°ƒç”¨mdss_fb_probeæ—¶ï¼Œå‡½æ•°æ‰§è¡Œèµ„æºåˆ†é…å¹¶è°ƒç”¨mdss_fb_registerã€‚ å¯ä»¥æœ‰å¤šä¸ªå¸§ç¼“å†²åŒºï¼ˆfbï¼‰è®¾å¤‡ï¼ˆèŠ‚ç‚¹ï¼‰ã€‚ è¯¥é©±åŠ¨ç¨‹åºé€šè¿‡è°ƒç”¨mdss_fb_registeræ¥æ³¨å†Œå„ä¸ªfbè®¾å¤‡ï¼Œåè€…åˆè°ƒç”¨register_framebufferã€‚ HDMIå’Œä¸»æ˜¾ç¤ºå™¨æ˜¯å„ä¸ªfbè®¾å¤‡çš„ä¾‹å­ã€‚ ä»¥ä¸‹æ“ä½œå·²æ³¨å†Œï¼š</p><p>é¦–å…ˆçœ‹ä¸€ä¸‹mdss_fb_probe()å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_fb_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msm_fb_data_type</span> *<span class="title">mfd</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fbi</span>;</span></span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	pdata = dev_get_platdata(&amp;pdev-&gt;dev);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * alloc framebuffer info + par data</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	fbi = framebuffer_alloc(<span class="keyword">sizeof</span>(struct msm_fb_data_type), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	mfd = (struct msm_fb_data_type *)fbi-&gt;par;</span><br><span class="line">	mfd-&gt;key = MFD_KEY;</span><br><span class="line">	mfd-&gt;fbi = fbi;</span><br><span class="line">	mfd-&gt;panel_info = &amp;pdata-&gt;panel_info;</span><br><span class="line">	mfd-&gt;panel.type = pdata-&gt;panel_info.type;</span><br><span class="line">	mfd-&gt;panel.id = mfd-&gt;index;</span><br><span class="line">	mfd-&gt;fb_page = MDSS_FB_NUM;</span><br><span class="line">	mfd-&gt;index = fbi_list_index;</span><br><span class="line">	mfd-&gt;mdp_fb_page_protection = MDP_FB_PAGE_PROTECTION_WRITECOMBINE;</span><br><span class="line"></span><br><span class="line">	mfd-&gt;ext_ad_ctrl = <span class="number">-1</span>;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	platform_set_drvdata(pdev, mfd);</span><br><span class="line"></span><br><span class="line">	rc = mdss_fb_register(mfd);</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨framebuffer_alloc()å‡½æ•°è¿”å›ä¸€ä¸ªfb_info ç»“æ„ä½“ï¼Œç„¶åè°ƒç”¨mdss_fb_register(mfd)<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_fb_register</span><span class="params">(struct msm_fb_data_type *mfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = -ENODEV;</span><br><span class="line">	<span class="keyword">int</span> bpp;</span><br><span class="line">	<span class="keyword">char</span> panel_name[<span class="number">20</span>];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_info</span> *<span class="title">panel_info</span> = <span class="title">mfd</span>-&gt;<span class="title">panel_info</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fbi</span> = <span class="title">mfd</span>-&gt;<span class="title">fbi</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> *<span class="title">fix</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> *<span class="title">var</span>;</span></span><br><span class="line">	<span class="keyword">int</span> *id;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * fb info initialization</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	fix = &amp;fbi-&gt;fix;</span><br><span class="line">	var = &amp;fbi-&gt;var;</span><br><span class="line"></span><br><span class="line">	fix-&gt;type_aux = <span class="number">0</span>;	<span class="comment">/* if type == FB_TYPE_INTERLEAVED_PLANES */</span></span><br><span class="line">	fix-&gt;visual = FB_VISUAL_TRUECOLOR;	<span class="comment">/* True Color */</span></span><br><span class="line">	fix-&gt;ywrapstep = <span class="number">0</span>;	<span class="comment">/* No support */</span></span><br><span class="line">	fix-&gt;mmio_start = <span class="number">0</span>;	<span class="comment">/* No MMIO Address */</span></span><br><span class="line">	fix-&gt;mmio_len = <span class="number">0</span>;	<span class="comment">/* No MMIO Address */</span></span><br><span class="line">	fix-&gt;accel = FB_ACCEL_NONE;<span class="comment">/* FB_ACCEL_MSM needes to be added in fb.h */</span></span><br><span class="line"></span><br><span class="line">	var-&gt;xoffset = <span class="number">0</span>,	<span class="comment">/* Offset from virtual to visible */</span></span><br><span class="line">	var-&gt;yoffset = <span class="number">0</span>,	<span class="comment">/* resolution */</span></span><br><span class="line">	var-&gt;grayscale = <span class="number">0</span>,	<span class="comment">/* No graylevels */</span></span><br><span class="line">	var-&gt;nonstd = <span class="number">0</span>,	<span class="comment">/* standard pixel format */</span></span><br><span class="line">	var-&gt;activate = FB_ACTIVATE_VBL,	<span class="comment">/* activate it at vsync */</span></span><br><span class="line">	var-&gt;height = <span class="number">-1</span>,	<span class="comment">/* height of picture in mm */</span></span><br><span class="line">	var-&gt;width = <span class="number">-1</span>,	<span class="comment">/* width of picture in mm */</span></span><br><span class="line">	var-&gt;accel_flags = <span class="number">0</span>,	<span class="comment">/* acceleration flags */</span></span><br><span class="line">	var-&gt;sync = <span class="number">0</span>,	<span class="comment">/* see FB_SYNC_* */</span></span><br><span class="line">	var-&gt;rotate = <span class="number">0</span>,	<span class="comment">/* angle we rotate counter clockwise */</span></span><br><span class="line">	mfd-&gt;op_enable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (mfd-&gt;fb_imgType) &#123;</span><br><span class="line">	<span class="keyword">case</span> MDP_RGB_565:</span><br><span class="line">		......</span><br><span class="line">		var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">		var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">		bpp = <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> MDP_RGB_888:</span><br><span class="line">		......</span><br><span class="line">		var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">		var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">		bpp = <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> MDP_ARGB_8888:</span><br><span class="line">		......</span><br><span class="line">		var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">		var-&gt;transp.length = <span class="number">8</span>;</span><br><span class="line">		bpp = <span class="number">4</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> MDP_RGBA_8888:</span><br><span class="line">		......</span><br><span class="line">		var-&gt;transp.offset = <span class="number">24</span>;</span><br><span class="line">		var-&gt;transp.length = <span class="number">8</span>;</span><br><span class="line">		bpp = <span class="number">4</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> MDP_YCRYCB_H2V1:</span><br><span class="line">		......</span><br><span class="line">		var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">		var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">		bpp = <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mdss_panelinfo_to_fb_var(panel_info, var);</span><br><span class="line"></span><br><span class="line">	fix-&gt;type = panel_info-&gt;is_3d_panel;</span><br><span class="line">	<span class="keyword">if</span> (mfd-&gt;mdp.fb_stride)</span><br><span class="line">		fix-&gt;line_length = mfd-&gt;mdp.fb_stride(mfd-&gt;index, var-&gt;xres,</span><br><span class="line">							bpp);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		fix-&gt;line_length = var-&gt;xres * bpp;</span><br><span class="line"></span><br><span class="line">	var-&gt;xres_virtual = var-&gt;xres;</span><br><span class="line">	var-&gt;yres_virtual = panel_info-&gt;yres * mfd-&gt;fb_page;</span><br><span class="line">	var-&gt;bits_per_pixel = bpp * <span class="number">8</span>;	<span class="comment">/* FrameBuffer color depth */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Populate smem length here for uspace to get the</span></span><br><span class="line"><span class="comment">	 * Framebuffer size when FBIO_FSCREENINFO ioctl is called.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	fix-&gt;smem_len = PAGE_ALIGN(fix-&gt;line_length * var-&gt;yres) * mfd-&gt;fb_page;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* id field for fb app  */</span></span><br><span class="line">	id = (<span class="keyword">int</span> *)&amp;mfd-&gt;panel;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(fix-&gt;id, <span class="keyword">sizeof</span>(fix-&gt;id), <span class="string">"mdssfb_%x"</span>, (u32) *id);</span><br><span class="line"></span><br><span class="line">	fbi-&gt;fbops = &amp;mdss_fb_ops;</span><br><span class="line">	fbi-&gt;flags = FBINFO_FLAG_DEFAULT;</span><br><span class="line">	fbi-&gt;pseudo_palette = mdss_fb_pseudo_palette;</span><br><span class="line"></span><br><span class="line">	mfd-&gt;ref_cnt = <span class="number">0</span>;</span><br><span class="line">	mfd-&gt;panel_power_state = MDSS_PANEL_POWER_OFF;</span><br><span class="line">	mfd-&gt;dcm_state = DCM_UNINIT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mdss_fb_alloc_fbmem(mfd))</span><br><span class="line">		pr_warn(<span class="string">"unable to allocate fb memory in fb register\n"</span>);</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	ret = fb_alloc_cmap(&amp;fbi-&gt;cmap, <span class="number">256</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		pr_err(<span class="string">"fb_alloc_cmap() failed!\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (register_framebuffer(fbi) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		fb_dealloc_cmap(&amp;fbi-&gt;cmap);</span><br><span class="line">		mfd-&gt;op_enable = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(panel_name, ARRAY_SIZE(panel_name), <span class="string">"mdss_panel_fb%d"</span>,</span><br><span class="line">		mfd-&gt;index);</span><br><span class="line">	mdss_panel_debugfs_init(panel_info, panel_name);</span><br><span class="line">	pr_info(<span class="string">"FrameBuffer[%d] %dx%d registered successfully!\n"</span>, mfd-&gt;index,</span><br><span class="line">					fbi-&gt;var.xres, fbi-&gt;var.yres);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä»»ä½•ä¸€ä¸ªç‰¹å®šç¡¬ä»¶Framebufferé©±åŠ¨åœ¨åˆå§‹åŒ–æ—¶éƒ½å¿…é¡»å‘fbmem.cæ³¨å†Œï¼ŒFrameBufferæ¨¡å—æä¾›äº†é©±åŠ¨æ³¨å†Œæ¥å£å‡½æ•°register_framebufferï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\fbdev\core\fbmem.c]</span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">register_framebuffer(struct fb_info *fb_info)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;registration_lock);</span><br><span class="line">	ret = do_register_framebuffer(fb_info);</span><br><span class="line">	mutex_unlock(&amp;registration_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°fb_infoæè¿°ç‰¹å®šç¡¬ä»¶çš„FrameBufferé©±åŠ¨ä¿¡æ¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\fbdev\core\fbmem.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_register_framebuffer</span><span class="params">(struct fb_info *fb_info)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> i;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_event</span> <span class="title">event</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_videomode</span> <span class="title">mode</span>;</span>  </span><br><span class="line">    <span class="keyword">if</span> (fb_check_foreignness(fb_info))  </span><br><span class="line">        <span class="keyword">return</span> -ENOSYS;  </span><br><span class="line">    <span class="comment">//æ ¹æ®å½“å‰æ³¨å†Œçš„fb_infoçš„apertureså±æ€§ä»FrameBufferé©±åŠ¨æ•°ç»„registered_fbä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨å†²çª  </span></span><br><span class="line">    do_remove_conflicting_framebuffers(fb_info-&gt;apertures, fb_info-&gt;fix.id,  </span><br><span class="line">                     fb_is_primary_device(fb_info));  </span><br><span class="line">    <span class="comment">//åˆ¤æ–­å·²æ³¨å†Œçš„é©±åŠ¨æ˜¯å¦è¶…è¿‡32ä¸ªFrameBufferé©±åŠ¨  </span></span><br><span class="line">    <span class="keyword">if</span> (num_registered_fb == FB_MAX)  </span><br><span class="line">        <span class="keyword">return</span> -ENXIO;  </span><br><span class="line">    <span class="comment">//å¢åŠ å·²æ³¨å†Œçš„é©±åŠ¨ä¸ªæ•°  </span></span><br><span class="line">    num_registered_fb++;  </span><br><span class="line">    <span class="comment">//ä»æ•°ç»„registered_fbä¸­æŸ¥æ‰¾ç©ºé—²å…ƒç´ ï¼Œç”¨äºå­˜å‚¨å½“å‰æ³¨å†Œçš„fb_info  </span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; FB_MAX; i++)  </span><br><span class="line">        <span class="keyword">if</span> (!registered_fb[i])  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">    <span class="comment">//å°†å½“å‰æ³¨å†Œçš„fb_infoåœ¨æ•°ç»„registered_fbä¸­çš„ç´¢å¼•ä½ç½®ä¿å­˜åˆ°fb_info-&gt;node  </span></span><br><span class="line">    fb_info-&gt;node = i;  </span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å½“å‰æ³¨å†Œçš„fb_infoçš„æˆå‘˜ä¿¡æ¯  </span></span><br><span class="line">    atomic_set(&amp;fb_info-&gt;count, <span class="number">1</span>);  </span><br><span class="line">    mutex_init(&amp;fb_info-&gt;lock);  </span><br><span class="line">    mutex_init(&amp;fb_info-&gt;mm_lock);  </span><br><span class="line">    <span class="comment">//åœ¨/devç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªfbxçš„è®¾å¤‡æ–‡ä»¶ï¼Œæ¬¡è®¾å¤‡å·å°±æ˜¯è¯¥fb_infoåœ¨æ•°ç»„registered_fbä¸­çš„ç´¢å¼•  </span></span><br><span class="line">    fb_info-&gt;dev = device_create(fb_class, fb_info-&gt;device,MKDEV(FB_MAJOR, i), <span class="literal">NULL</span>, <span class="string">"fb%d"</span>, i);  </span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(fb_info-&gt;dev)) &#123;  </span><br><span class="line">        printk(KERN_WARNING <span class="string">"Unable to create device for framebuffer %d; errno = %ld\n"</span>, i, PTR_ERR(fb_info-&gt;dev));  </span><br><span class="line">        fb_info-&gt;dev = <span class="literal">NULL</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span>  </span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–fb_info  </span></span><br><span class="line">        fb_init_device(fb_info);  </span><br><span class="line">    <span class="keyword">if</span> (fb_info-&gt;pixmap.addr == <span class="literal">NULL</span>) &#123;  </span><br><span class="line">        fb_info-&gt;pixmap.addr = kmalloc(FBPIXMAPSIZE, GFP_KERNEL);  </span><br><span class="line">        <span class="keyword">if</span> (fb_info-&gt;pixmap.addr) &#123;  </span><br><span class="line">            fb_info-&gt;pixmap.size = FBPIXMAPSIZE;  </span><br><span class="line">            fb_info-&gt;pixmap.buf_align = <span class="number">1</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.scan_align = <span class="number">1</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.access_align = <span class="number">32</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.flags = FB_PIXMAP_DEFAULT;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;     </span><br><span class="line">    fb_info-&gt;pixmap.offset = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;pixmap.blit_x)  </span><br><span class="line">        fb_info-&gt;pixmap.blit_x = ~(u32)<span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;pixmap.blit_y)  </span><br><span class="line">        fb_info-&gt;pixmap.blit_y = ~(u32)<span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;modelist.prev || !fb_info-&gt;modelist.next)  </span><br><span class="line">        INIT_LIST_HEAD(&amp;fb_info-&gt;modelist);  </span><br><span class="line">    fb_var_to_videomode(&amp;mode, &amp;fb_info-&gt;var);  </span><br><span class="line">    fb_add_videomode(&amp;mode, &amp;fb_info-&gt;modelist);  </span><br><span class="line">    <span class="comment">//å°†ç‰¹å®šç¡¬ä»¶å¯¹åº”çš„fb_infoæ³¨å†Œåˆ°registered_fbæ•°ç»„ä¸­  </span></span><br><span class="line">    registered_fb[i] = fb_info;  </span><br><span class="line">    event.info = fb_info;  </span><br><span class="line">    <span class="keyword">if</span> (!lock_fb_info(fb_info))  </span><br><span class="line">        <span class="keyword">return</span> -ENODEV;  </span><br><span class="line">    <span class="comment">//ä½¿ç”¨Linuxäº‹ä»¶é€šçŸ¥æœºåˆ¶å‘é€ä¸€ä¸ªFrameBufferæ³¨å†Œäº‹ä»¶FB_EVENT_FB_REGISTERED  </span></span><br><span class="line">    fb_notifier_call_chain(FB_EVENT_FB_REGISTERED, &amp;event);  </span><br><span class="line">    unlock_fb_info(fb_info);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œè¿‡ç¨‹å°±æ˜¯å°†æŒ‡å®šçš„è®¾å¤‡é©±åŠ¨ä¿¡æ¯fb_infoå­˜æ”¾åˆ°registered_fbæ•°ç»„ä¸­ã€‚å› æ­¤åœ¨æ³¨å†Œå…·ä½“çš„fb_infoæ—¶ï¼Œé¦–å…ˆè¦æ„é€ ä¸€ä¸ªfb_infoæ•°æ®ç»“æ„ï¼Œå¹¶åˆå§‹åŒ–è¯¥æ•°æ®ç»“æ„ï¼Œè¯¥ç»“æ„ç”¨äºæè¿°ä¸€ä¸ªç‰¹å®šçš„FrameBufferé©±åŠ¨ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-07-fb-device-create.jpg" alt="Alt text | center"></p><h4 id="ï¼ˆä¸‰ï¼‰ã€MDP-driver"><a href="#ï¼ˆä¸‰ï¼‰ã€MDP-driver" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€MDP driver"></a>ï¼ˆä¸‰ï¼‰ã€MDP driver</h4><p>MDPä¹Ÿè¢«æ³¨å†Œä¸ºå¹³å°é©±åŠ¨ç¨‹åºã€‚ mdp3_driver_initæ‰§è¡Œé©±åŠ¨ç¨‹åºinitã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdp3.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdp3_driver</span> = &#123;</span></span><br><span class="line">	.probe = mdp3_probe,</span><br><span class="line">	.remove = mdp3_remove,</span><br><span class="line">	.suspend = mdp3_suspend,</span><br><span class="line">	.resume = mdp3_resume,</span><br><span class="line">	.shutdown = <span class="literal">NULL</span>,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = <span class="string">"mdp3"</span>,</span><br><span class="line">		.of_match_table = mdp3_dt_match,</span><br><span class="line">		.pm             = &amp;mdp3_pm_ops,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">mdp3_driver_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = platform_driver_register(&amp;mdp3_driver);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		pr_err(<span class="string">"register mdp3 driver failed!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdp3_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">msm_mdp_interface</span> <span class="title">mdp3_interface</span> = &#123;</span></span><br><span class="line">	.init_fnc = mdp3_init,</span><br><span class="line">	.fb_mem_get_iommu_domain = mdp3_fb_mem_get_iommu_domain,</span><br><span class="line">	.panel_register_done = mdp3_panel_register_done,</span><br><span class="line">	.fb_stride = mdp3_fb_stride,</span><br><span class="line">	.check_dsi_status = mdp3_check_dsi_ctrl_status,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mdp3_intr_cb</span> <span class="title">underrun_cb</span> = &#123;</span></span><br><span class="line">		.cb = mdp3_dma_underrun_intr_handler,</span><br><span class="line">		.data = <span class="literal">NULL</span>,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">"%s: START\n"</span>, __func__);</span><br><span class="line">	<span class="keyword">if</span> (!pdev-&gt;dev.of_node) &#123;</span><br><span class="line">		pr_err(<span class="string">"MDP driver only supports device tree probe\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> -ENOTSUPP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mdp3_res) &#123;</span><br><span class="line">		pr_err(<span class="string">"MDP already initialized\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mdp3_res = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(struct mdp3_hw_resource),</span><br><span class="line">				GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (mdp3_res == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	pdev-&gt;id = <span class="number">0</span>;</span><br><span class="line">	mdp3_res-&gt;pdev = pdev;</span><br><span class="line">	mutex_init(&amp;mdp3_res-&gt;res_mutex);</span><br><span class="line">	spin_lock_init(&amp;mdp3_res-&gt;irq_lock);</span><br><span class="line">	platform_set_drvdata(pdev, mdp3_res);</span><br><span class="line">	atomic_set(&amp;mdp3_res-&gt;active_intf_cnt, <span class="number">0</span>);</span><br><span class="line">	mutex_init(&amp;mdp3_res-&gt;reg_bus_lock);</span><br><span class="line">	INIT_LIST_HEAD(&amp;mdp3_res-&gt;reg_bus_clist);</span><br><span class="line"></span><br><span class="line">	mdp3_res-&gt;mdss_util = mdss_get_util_intf();</span><br><span class="line">	<span class="keyword">if</span> (mdp3_res-&gt;mdss_util == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">"Failed to get mdss utility functions\n"</span>);</span><br><span class="line">		rc =  -ENODEV;</span><br><span class="line">		<span class="keyword">goto</span> get_util_fail;</span><br><span class="line">	&#125;</span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;get_iommu_domain = mdp3_get_iommu_domain;</span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;iommu_attached = is_mdss_iommu_attached;</span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;iommu_ctrl = mdp3_iommu_ctrl;</span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;bus_scale_set_quota = mdp3_bus_scale_set_quota;</span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;panel_intf_type = mdp3_panel_intf_type;</span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;dyn_clk_gating_ctrl =</span><br><span class="line">		mdp3_dynamic_clock_gating_ctrl;</span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;panel_intf_type = mdp3_panel_intf_type;</span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;panel_intf_status = mdp3_panel_get_intf_status;</span><br><span class="line">	rc = mdp3_parse_dt(pdev);</span><br><span class="line">	<span class="keyword">if</span> (rc)</span><br><span class="line">		<span class="keyword">goto</span> probe_done;</span><br><span class="line"></span><br><span class="line">	rc = mdp3_res_init();</span><br><span class="line">	<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">		pr_err(<span class="string">"unable to initialize mdp3 resources\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> probe_done;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mdp3_res-&gt;fs_ena = <span class="literal">false</span>;</span><br><span class="line">	mdp3_res-&gt;fs = devm_regulator_get(&amp;pdev-&gt;dev, <span class="string">"vdd"</span>);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR_OR_NULL(mdp3_res-&gt;fs)) &#123;</span><br><span class="line">		pr_err(<span class="string">"unable to get mdss gdsc regulator\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = mdp3_debug_init(pdev);</span><br><span class="line">	<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">		pr_err(<span class="string">"unable to initialize mdp debugging\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> probe_done;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pm_runtime_set_autosuspend_delay(&amp;pdev-&gt;dev, AUTOSUSPEND_TIMEOUT_MS);</span><br><span class="line">	<span class="keyword">if</span> (mdp3_res-&gt;idle_pc_enabled) &#123;</span><br><span class="line">		pr_debug(<span class="string">"%s: Enabling autosuspend\n"</span>, __func__);</span><br><span class="line">		pm_runtime_use_autosuspend(&amp;pdev-&gt;dev);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Enable PM runtime */</span></span><br><span class="line">	pm_runtime_set_suspended(&amp;pdev-&gt;dev);</span><br><span class="line">	pm_runtime_enable(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pm_runtime_enabled(&amp;pdev-&gt;dev)) &#123;</span><br><span class="line">		rc = mdp3_footswitch_ctrl(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">			pr_err(<span class="string">"unable to turn on FS\n"</span>);</span><br><span class="line">			<span class="keyword">goto</span> probe_done;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = mdp3_check_version();</span><br><span class="line">	<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">		pr_err(<span class="string">"mdp3 check version failed\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> probe_done;</span><br><span class="line">	&#125;</span><br><span class="line">	rc = mdp3_register_sysfs(pdev);</span><br><span class="line">	<span class="keyword">if</span> (rc)</span><br><span class="line">		pr_err(<span class="string">"unable to register mdp sysfs nodes\n"</span>);</span><br><span class="line"></span><br><span class="line">	rc = mdss_fb_register_mdp_instance(&amp;mdp3_interface);</span><br><span class="line">	<span class="keyword">if</span> (rc)</span><br><span class="line">		pr_err(<span class="string">"unable to register mdp instance\n"</span>);</span><br><span class="line"></span><br><span class="line">	rc = mdp3_set_intr_callback(MDP3_INTR_LCDC_UNDERFLOW,</span><br><span class="line">					&amp;underrun_cb);</span><br><span class="line">	<span class="keyword">if</span> (rc)</span><br><span class="line">		pr_err(<span class="string">"unable to configure interrupt callback\n"</span>);</span><br><span class="line"></span><br><span class="line">	rc = mdss_smmu_init(mdss_res, &amp;pdev-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (rc)</span><br><span class="line">		pr_err(<span class="string">"mdss smmu init failed\n"</span>);</span><br><span class="line"></span><br><span class="line">	mdp3_res-&gt;mdss_util-&gt;mdp_probe_done = <span class="literal">true</span>;</span><br><span class="line">	pr_debug(<span class="string">"%s: END\n"</span>, __func__);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…æ ¸è°ƒç”¨MDPæ¢æµ‹å‡½æ•°mdp3_probeã€‚ åœ¨æ¢æµ‹å™¨ä¸Šï¼Œé©±åŠ¨ç¨‹åºä»è®¾å¤‡æ ‘ä¸­è·å–é¢æ¿ä¿¡æ¯ï¼Œå¹¶é€šè¿‡è°ƒç”¨mdp3_parse_dtæ¥è§£æä¿¡æ¯ã€‚ åœ¨mdp3_ctrl_onæœŸé—´ï¼ŒMDPé©±åŠ¨ç¨‹åºè°ƒç”¨mdp3_ctrl_res_req_clkå¹¶è¯·æ±‚MDPå’ŒVsyncæ—¶é’Ÿã€‚ åœ¨mdp3_ctrl_offæœŸé—´ï¼Œé©±åŠ¨ç¨‹åºè¯·æ±‚å…³é—­MDPå’ŒVsyncæ—¶é’Ÿã€‚</p><h4 id="ï¼ˆå››ï¼‰ã€DSI-controller-driver-ï¼ˆlcdé©±åŠ¨-dsiï¼‰"><a href="#ï¼ˆå››ï¼‰ã€DSI-controller-driver-ï¼ˆlcdé©±åŠ¨-dsiï¼‰" class="headerlink" title="ï¼ˆå››ï¼‰ã€DSI controller driver ï¼ˆlcdé©±åŠ¨ dsiï¼‰"></a>ï¼ˆå››ï¼‰ã€DSI controller driver ï¼ˆlcdé©±åŠ¨ dsiï¼‰</h4><p>msm_dsi_v2_driver_initæ‰§è¡Œé©±åŠ¨ç¨‹åºåˆå§‹åŒ–ã€‚ msm_dsi_v2_driver_initè°ƒç”¨ msm_dsi_v2_register_driveræ³¨å†Œé©±åŠ¨ç¨‹åºã€‚<br>æ€»ä½“æ—¶åºå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-08-dsi-host-v2.png" alt="Alt text | center"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\dsi_host_v2.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">msm_dsi_v2_driver</span> = &#123;</span></span><br><span class="line">	.probe = msm_dsi_probe,</span><br><span class="line">	.remove = msm_dsi_remove,</span><br><span class="line">	.shutdown = <span class="literal">NULL</span>,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = <span class="string">"msm_dsi_v2"</span>,</span><br><span class="line">		.of_match_table = msm_dsi_v2_dt_match,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm_dsi_v2_register_driver</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> platform_driver_register(&amp;msm_dsi_v2_driver);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm_dsi_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dsi_interface</span> <span class="title">intf</span>;</span></span><br><span class="line">	<span class="keyword">char</span> panel_cfg[MDSS_MAX_PANEL_LEN];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mdss_dsi_ctrl_pdata</span> *<span class="title">ctrl_pdata</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">dsi_pan_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> cmd_cfg_cont_splash = <span class="literal">false</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">mdss_dsi_mres</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line"></span><br><span class="line">	rc = msm_dsi_init();</span><br><span class="line"></span><br><span class="line">	pdev-&gt;id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ctrl_pdata = platform_get_drvdata(pdev);</span><br><span class="line">	<span class="keyword">if</span> (!ctrl_pdata) &#123;</span><br><span class="line">		ctrl_pdata = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line">			<span class="keyword">sizeof</span>(struct mdss_dsi_ctrl_pdata), GFP_KERNEL);</span><br><span class="line">		platform_set_drvdata(pdev, ctrl_pdata);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctrl_pdata-&gt;mdss_util = mdss_get_util_intf();</span><br><span class="line">	<span class="keyword">if</span> (mdp3_res-&gt;mdss_util == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">"Failed to get mdss utility functions\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mdss_dsi_mres = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (!mdss_dsi_mres) &#123;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		dsi_host_private-&gt;dsi_reg_size = resource_size(mdss_dsi_mres);</span><br><span class="line">		dsi_host_private-&gt;dsi_base = ioremap(mdss_dsi_mres-&gt;start,</span><br><span class="line">						dsi_host_private-&gt;dsi_reg_size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mdss_dsi_mres = platform_get_resource(pdev, IORESOURCE_IRQ, <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	rc = of_platform_populate(pdev-&gt;dev.of_node, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;pdev-&gt;dev);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DSI panels can be different between controllers */</span></span><br><span class="line">	rc = dsi_get_panel_cfg(panel_cfg);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* find panel device node */</span></span><br><span class="line">	dsi_pan_node = dsi_find_panel_of_node(pdev, panel_cfg);</span><br><span class="line">	</span><br><span class="line">	cmd_cfg_cont_splash = mdp3_panel_get_boot_cfg() ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	rc = mdss_dsi_panel_init(dsi_pan_node, ctrl_pdata, cmd_cfg_cont_splash);</span><br><span class="line">	</span><br><span class="line">	rc = dsi_ctrl_config_init(pdev, ctrl_pdata);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	msm_dsi_parse_lane_swap(pdev-&gt;dev.of_node, &amp;(ctrl_pdata-&gt;dlane_swap));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>;  i &lt; DSI_MAX_PM; i++) &#123;</span><br><span class="line">		rc = msm_dsi_io_init(pdev, &amp;(ctrl_pdata-&gt;power_data[i]));</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">"%s: Dsi Ctrl-&gt;0 initialized\n"</span>, __func__);</span><br><span class="line"></span><br><span class="line">	dsi_host_private-&gt;dis_dev = pdev-&gt;dev;</span><br><span class="line">	intf.on = msm_dsi_on;</span><br><span class="line">	intf.off = msm_dsi_off;</span><br><span class="line">	intf.cont_on = msm_dsi_cont_on;</span><br><span class="line">	intf.clk_ctrl = msm_dsi_clk_ctrl;</span><br><span class="line">	intf.op_mode_config = msm_dsi_op_mode_config;</span><br><span class="line">	intf.index = <span class="number">0</span>;</span><br><span class="line">	intf.<span class="keyword">private</span> = <span class="literal">NULL</span>;</span><br><span class="line">	dsi_register_interface(&amp;intf);</span><br><span class="line"></span><br><span class="line">	msm_dsi_debug_init();</span><br><span class="line"></span><br><span class="line">	msm_dsi_ctrl_init(ctrl_pdata);</span><br><span class="line"></span><br><span class="line">	rc = msm_dsi_irq_init(&amp;pdev-&gt;dev, mdss_dsi_mres-&gt;start,</span><br><span class="line">					   ctrl_pdata);</span><br><span class="line">	</span><br><span class="line">	rc = dsi_panel_device_register_v2(pdev, ctrl_pdata);</span><br><span class="line">	</span><br><span class="line">	pr_debug(<span class="string">"%s success\n"</span>, __func__);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…æ ¸è°ƒç”¨msm_dsi_probeã€‚ é¢æ¿è¢«æ£€æµ‹åˆ°ã€‚ msm_dsi_probeè°ƒç”¨mdss_dsi_panel_initå‡½æ•°ã€‚ mdss_dsi_panel_initè°ƒç”¨mdss_panel_parse_dtæ¥è·å–é¢æ¿å‚æ•°ã€‚<br>MDPé©±åŠ¨ç¨‹åºä½¿ç”¨è¯¥äº‹ä»¶ä¸DSIé©±åŠ¨ç¨‹åºè¿›è¡Œé€šä¿¡ã€‚ DSIé©±åŠ¨ç¨‹åºå…·æœ‰mdss_dsi_event_handlerï¼Œè¿™æ˜¯MDPæ ¸å¿ƒäº‹ä»¶çš„å›è°ƒå¤„ç†ç¨‹åºã€‚ mdss_panel.hå®šä¹‰äº†MDPæ ¸å¿ƒäº‹ä»¶ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_panel.h]</span><br><span class="line"><span class="keyword">enum</span> mdss_intf_events &#123;</span><br><span class="line">	MDSS_EVENT_RESET = <span class="number">1</span>,</span><br><span class="line">	MDSS_EVENT_LINK_READY,</span><br><span class="line">	MDSS_EVENT_UNBLANK,</span><br><span class="line">	MDSS_EVENT_PANEL_ON,</span><br><span class="line">	MDSS_EVENT_POST_PANEL_ON,</span><br><span class="line">	MDSS_EVENT_BLANK,</span><br><span class="line">	MDSS_EVENT_PANEL_OFF,</span><br><span class="line">	MDSS_EVENT_CLOSE,</span><br><span class="line">	MDSS_EVENT_SUSPEND,</span><br><span class="line">	MDSS_EVENT_RESUME,</span><br><span class="line">	MDSS_EVENT_CHECK_PARAMS,</span><br><span class="line">	MDSS_EVENT_CONT_SPLASH_BEGIN,</span><br><span class="line">	MDSS_EVENT_CONT_SPLASH_FINISH,</span><br><span class="line">	MDSS_EVENT_PANEL_UPDATE_FPS,</span><br><span class="line">	MDSS_EVENT_FB_REGISTERED,</span><br><span class="line">	MDSS_EVENT_PANEL_CLK_CTRL,</span><br><span class="line">	MDSS_EVENT_DSI_CMDLIST_KOFF,</span><br><span class="line">	MDSS_EVENT_ENABLE_PARTIAL_ROI,</span><br><span class="line">	MDSS_EVENT_DSC_PPS_SEND,</span><br><span class="line">	MDSS_EVENT_DSI_STREAM_SIZE,</span><br><span class="line">	MDSS_EVENT_DSI_UPDATE_PANEL_DATA,</span><br><span class="line">	MDSS_EVENT_REGISTER_RECOVERY_HANDLER,</span><br><span class="line">	MDSS_EVENT_REGISTER_MDP_CALLBACK,</span><br><span class="line">	MDSS_EVENT_DSI_PANEL_STATUS,</span><br><span class="line">	MDSS_EVENT_DSI_DYNAMIC_SWITCH,</span><br><span class="line">	MDSS_EVENT_DSI_RECONFIG_CMD,</span><br><span class="line">	MDSS_EVENT_DSI_RESET_WRITE_PTR,</span><br><span class="line">	MDSS_EVENT_PANEL_TIMING_SWITCH,</span><br><span class="line">	MDSS_EVENT_MAX,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨msm_dsi_onæœŸé—´ï¼Œé€šè¿‡è°ƒç”¨msm_dsi_clk_enableæ‰“å¼€DSIæ—¶é’Ÿã€‚ åœ¨msm_dsi_offæœŸé—´ï¼Œé€šè¿‡è°ƒç”¨msm_dsi_clk_disableå…³é—­clksã€‚</p><h4 id="ï¼ˆäº”ï¼‰ã€-Panel-driver-ï¼ˆé¢æ¿-dsiï¼‰"><a href="#ï¼ˆäº”ï¼‰ã€-Panel-driver-ï¼ˆé¢æ¿-dsiï¼‰" class="headerlink" title="ï¼ˆäº”ï¼‰ã€ Panel driver ï¼ˆé¢æ¿ dsiï¼‰"></a>ï¼ˆäº”ï¼‰ã€ Panel driver ï¼ˆé¢æ¿ dsiï¼‰</h4><p>MDSS : Multimedia Display sub system<br>DSI: Display Serial Interface</p><blockquote><p>qcom,mdss-dsi-force-clock-lane-hs; // faulse ï¼šclockæ¯å¸§å›lp11<br>ture: clockä¸å› qcom,mdss-dsi-hfp-power-mode; // data æ¯è¡Œå›lp11,å¯¹åº”çš„hfpè¦ä¿®æ”¹æˆ300ä»¥ä¸Š</p></blockquote><p>é¢æ¿ä¿¡æ¯ä½äºkernel\arch\arm\boot\dts\ä¸­çš„.dtsiæ–‡ä»¶ä¸­ã€‚ è¿™åŒ…å«æ‰€æœ‰é¢æ¿ç‰¹å®šçš„å‘½ä»¤ï¼Œä¾‹å¦‚onï¼Œoffå’Œresetï¼ˆmdss-dsi-on-commandï¼Œmdss-dsi-off-commandï¼Œmdss-dsi-reset-sequenceï¼‰ï¼ŒBLæ§åˆ¶å’Œå…¶ä»–é¢æ¿ ç‹¬ç«‹å‚æ•°ã€‚<br>ä¾‹å¦‚ï¼š<br>msm8610-mdss.dtsi ï¼ˆæ–‡ä»¶åé€šå¸¸ä¸º msmxxx-mdss.dtsi æŒ‡å®šäº†mdss çš„ mdp å’Œ dsiï¼‰</p><h5 id="5-1ã€-dtsiæ–‡ä»¶è§£æ"><a href="#5-1ã€-dtsiæ–‡ä»¶è§£æ" class="headerlink" title="5.1ã€.dtsiæ–‡ä»¶è§£æ"></a>5.1ã€.dtsiæ–‡ä»¶è§£æ</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mdss_mdp: qcom,mdss_mdp@fd900000 &#123;</span><br><span class="line">            compatible = <span class="string">"qcom,mdss_mdp3"</span>;  <span class="comment">// å¯¹åº”mdssé©±åŠ¨ mdss_mdp.c</span></span><br><span class="line">----------</span><br><span class="line">  mdss_dsi0: qcom,mdss_dsi@fdd00000 &#123;</span><br><span class="line">        compatible = <span class="string">"qcom,msm-dsi-v2"</span>;      <span class="comment">// å¯¹åº”dsiè§£æé©±åŠ¨ dsi_host_v2.c</span></span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line"></span><br><span class="line">  mdss_dsi0: qcom,mdss_dsi_ctrl0@<span class="number">1</span>a94000 &#123;</span><br><span class="line">        compatible = <span class="string">"qcom,mdss-dsi-ctrl"</span>;  <span class="comment">// å¯¹åº”dsiè§£æé©±åŠ¨ mdss_dsi.c</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸‹é¢å‡½æ•°å‘ mdss_fb.c æ³¨å†Œäº†fb_infoç»“æ„ (åŒ…å«åœ¨mdss_dsi_ctrl_pdataç»“æ„ä¸­)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">drivers\video\msm\mdss\dsi_host_v2.c ï¼ˆlcdé©±åŠ¨ dsiï¼‰</span><br><span class="line">dsi_panel_device_register_v2(struct platform_device *dev,struct mdss_dsi_ctrl_pdata *ctrl_pdata)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static const struct of_device_id msm_dsi_v2_dt_match[] = &#123;</span><br><span class="line">    &#123;.compatible = &quot;qcom,msm-dsi-v2&quot;&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">æˆ–è€… </span><br><span class="line">drivers\video\msm\mdss\mdss_dsi.c</span><br></pre></td></tr></table></figure><p>msm8610-asus.dts ï¼ˆæŒ‡å®šmdpä¸­çš„å“ªä¸€ä¸ªé…ç½®ï¼‰<br>é€šå¸¸åœ¨dtsæ–‡ä»¶çš„ mdss_dsi0 labé‡Œé¢é€šè¿‡ qcom,dsi-pref-prim-pan å±æ€§ æŒ‡å®šä½¿ç”¨å“ªä¸€ä¸ªlcdé…ç½®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;mdss_dsi0 &#123;</span><br><span class="line">        qcom,dsi-pref-prim-pan = &lt;&amp;dsi_fl10802_fwvga_vid&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>dsi-panel-fl10802-fwvga-video.dtsi</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&amp;mdss_mdp &#123;</span><br><span class="line">    dsi_fl10802_fwvga_vid: qcom,mdss_dsi_fl10802_fwvga_video &#123;</span><br><span class="line">        qcom,mdss-dsi-panel-name = &quot;fl10802 fwvga video mode dsi panel&quot;;</span><br><span class="line">        qcom,mdss-dsi-drive-ic = &quot;fl10802&quot;;</span><br><span class="line">        qcom,mdss-dsi-panel-controller = &lt;&amp;mdss_dsi0&gt;;</span><br><span class="line">        qcom,mdss-dsi-panel-type = &quot;dsi_video_mode&quot;;</span><br><span class="line">        qcom,mdss-dsi-panel-destination = &quot;display_1&quot;;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h5 id="5-2ã€mdss-mdp-å’Œ-mdss-dsi0-çš„å…³ç³»"><a href="#5-2ã€mdss-mdp-å’Œ-mdss-dsi0-çš„å…³ç³»" class="headerlink" title="5.2ã€mdss_mdp å’Œ mdss_dsi0 çš„å…³ç³»"></a>5.2ã€mdss_mdp å’Œ mdss_dsi0 çš„å…³ç³»</h5><p>mdss_mdp ç›¸å½“äºä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢å®šä¹‰äº†å¾ˆå¤šä¸åŒlcdæ˜¾ç¤ºå±çš„é…ç½®é¡¹åŒ…æ‹¬åˆ†è¾¨ç‡ç­‰ç­‰</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-09-mdss_mdp-mdss_dsi0.jpg" alt="Alt text | center"></p><p>é¢æ¿é©±åŠ¨ç¨‹åºå¯ä»¥æ ¹æ®è¿æ¥çš„å®é™…é¢æ¿æ•°é‡å…·æœ‰å¤šä¸ªèŠ‚ç‚¹ã€‚<br>mdss_register_panelæ³¨å†Œé¢æ¿é©±åŠ¨ç¨‹åºï¼š<br>msm_dsi_probeâ†’dsi_panel_device_register_v2â†’mdss_register_panelâ†’<br>of_platform_device_create<br>ä»¥ä¸‹é¢æ¿æ§åˆ¶åŠŸèƒ½å¯ç”¨å¹¶åœ¨mdss_dsi_panel_initä¸­åˆå§‹åŒ–ï¼š<br>ctrl_pdataâ†’on = mdss_dsi_panel_on;<br>ctrl_pdataâ†’off = mdss_dsi_panel_off;<br>ctrl_pdataâ†’panel_data.set_backlight = mdss_dsi_panel_bl_ctrl;<br>ä¾‹å¦‚ï¼Œåœ¨mdp3_ctrl.cä¸­ï¼Œå‡½æ•°mdp3_ctrl_onï¼ˆï¼‰ä¼šè°ƒç”¨ä»¥ä¸‹DSIå¤„ç†ç¨‹åº<br>MDSS_EVENT_UNBLANKå’ŒMDSS_EVENT_PANEL_ONäº‹ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š<br>rc = panelâ†’event_handlerï¼ˆpanelï¼ŒMDSS_EVENT_UNBLANKï¼ŒNULLï¼‰;<br>rc | =é¢æ¿â†’event_handlerï¼ˆé¢æ¿ï¼ŒMDSS_EVENT_PANEL_ONï¼ŒNULLï¼‰;</p><h5 id="5-3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨"><a href="#5-3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨" class="headerlink" title="5.3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨"></a>5.3ã€é€šè¿‡å†…æ ¸æ¥å£æ‰“å¼€å’Œå…³é—­æ˜¾ç¤ºå™¨</h5><h5 id="5-3-1ã€å¯åŠ¨"><a href="#5-3-1ã€å¯åŠ¨" class="headerlink" title="5.3.1ã€å¯åŠ¨"></a>5.3.1ã€å¯åŠ¨</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-10-display-subsystem-on-bootup.png" alt="Alt text | center"></p><p>æŒ‰ç…§ä¸Šé¢çš„éƒ¨åˆ†æ‰€è¿°æ³¨å†Œè®¾å¤‡åï¼š<br>mdss_fb_openâ†’mdss_fb_blank_subâ†’pdataâ†’onï¼ˆé¢æ¿ONåŠŸèƒ½ï¼‰<br>æ³¨æ„ï¼šå¯¹äºå‘½ä»¤æ¨¡å¼é¢æ¿ï¼Œå¦‚æœé¢æ¿åœ¨å¯åŠ¨æ—¶å·²æ‰“å¼€ï¼Œåˆ™ä¼šè·³è¿‡è¯¥å¯åŠ¨åºåˆ— ä»¥é¿å…å…³é—­/ -onçš„æ–‡ç‰©ã€‚</p><h5 id="5-3-2ã€æš‚åœ-æ¢å¤"><a href="#5-3-2ã€æš‚åœ-æ¢å¤" class="headerlink" title="5.3.2ã€æš‚åœ/æ¢å¤"></a>5.3.2ã€æš‚åœ/æ¢å¤</h5><p>æŒ‚èµ·/æ¢å¤æ—¶ï¼Œè°ƒç”¨fbé©±åŠ¨ç¨‹åºæŒ‚èµ·/æ¢å¤å’ŒMDPé©±åŠ¨ç¨‹åºæŒ‚èµ·/æ¢å¤ã€‚ fbé©±åŠ¨ç¨‹åºä¾æ¬¡è°ƒç”¨é¢æ¿é©±åŠ¨ç¨‹åºçš„å¼€/å…³åŠŸèƒ½ã€‚</p><h5 id="5-3-2-1ã€æš‚åœåºåˆ—"><a href="#5-3-2-1ã€æš‚åœåºåˆ—" class="headerlink" title="5.3.2.1ã€æš‚åœåºåˆ—"></a>5.3.2.1ã€æš‚åœåºåˆ—</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-11-suspend sequence.png" alt="Alt text | center"></p><p>Kernelcallâ†’mdss_fb_release_allâ†’mdss_fb_blankâ†’mdss_fb_blank_subâ†’mdp3_ctrl_offâ†’<br>mdp3_ctrl_offå‘é€ä¸¤ä¸ªäº‹ä»¶ï¼š</p><ol><li>MDSS_EVENT_PANEL_OFF - dsi_event_handleræ¥æ”¶äº‹ä»¶ã€‚ å½“äº‹ä»¶å‘ç”Ÿæ—¶<br>æ¥æ”¶åˆ°æ—¶ï¼Œè°ƒç”¨å°ç»„å…³é—­åºåˆ—ã€‚</li><li>MDSS_EVENT_BLANK - è¯¥äº‹ä»¶ç”±è°ƒç”¨çš„dsi_event_handlerå¤„ç†<br>mdss_dsi_offã€‚</li></ol><ul><li>Kernelcallâ†’mdp3_suspend - æœªä½¿ç”¨<h5 id="5-3-2-2ã€æ¢å¤åºåˆ—"><a href="#5-3-2-2ã€æ¢å¤åºåˆ—" class="headerlink" title="5.3.2.2ã€æ¢å¤åºåˆ—"></a>5.3.2.2ã€æ¢å¤åºåˆ—</h5></li></ul><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-12-resume sequence.png" alt="Alt text | center"></p><p>Kernelcallâ†’mdss_fb_blankâ†’mdss_fb_blank_subâ†’mdp3_ctrl_onâ†’<br>mdp3_ctrl_onå‘é€ä¸¤ä¸ªäº‹ä»¶ï¼š</p><ol><li>MDSS_EVENT_UNBLANK - dsi_event_handleræ¥æ”¶äº‹ä»¶ã€‚ å½“äº‹ä»¶å‘ç”Ÿæ—¶<br>æ”¶åˆ°ï¼ŒDSI-onè¢«è°ƒç”¨ã€‚</li><li>MDSS_EVENT_PANEL_ON - äº‹ä»¶ç”±dsi_event_handlerå¤„ç†ï¼Œdsi_event_handlerå‘é€<br>é¢æ¿ä¸Šçš„åºåˆ—ã€‚<br>Kernelcallâ†’mdp3_resume - æœªä½¿ç”¨</li></ol><h5 id="5-4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿"><a href="#5-4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿" class="headerlink" title="5.4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿"></a>5.4ã€å›¾åƒæ›´æ–°åˆ°é¢æ¿</h5><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/display.system/DS05-13-flow for display subsystem commit.png" alt="Alt text | center"></p><p>ç”¨æˆ·å¿…é¡»ç¡®ä¿MSMFB_OVERLAY_SET IOCTLåœ¨å‘¼å«ä¹‹å‰è‡³å°‘è¢«è°ƒç”¨ä¸€æ¬¡ åˆ°MSMFB_OVERLAY_PLAY IOCLTï¼ˆä¾‹å¦‚ioctl(fd, MSMFB_OVERLAY_PLAY, &amp;od)ï¼‰ã€‚MSMFB_OVERLAY_PLAYé˜Ÿåˆ—ç¼“å†²åŒº æ˜¾ç¤ºåœ¨é¢æ¿ä¸Šã€‚ ç”¨æˆ·ä½¿ç”¨MSMFB_DISPLAY_COMMITè°ƒç”¨fb IOCLTã€‚è¿™ä¼šå¯åŠ¨ä¸€ä¸ªå‘¼å«<br>mdss_fb_display_commit å¹¶å®‰æ’å·¥ä½œé˜Ÿåˆ—ã€‚æ­¤å·¥ä½œé˜Ÿåˆ—å¤„ç†ç¨‹åºè°ƒç”¨<br>msm_fb_pan_display_exï¼Œç„¶åè°ƒç”¨mdp3_ctrl_pan_displayã€‚<br>mdss_fb_ioctlâ†’ï¼ˆMSMFB_DISPLAY_COMMITï¼‰â†’mdss_fb_display_commitâ†’<br>mdss_fb_pan_display_exâ†’è®¡åˆ’å·¥ä½œmdss_fb_commit_wq_handler<br>msm_fb_commit_wq_handlerâ†’mdp3_ctrl_display_commit_kickoffâ†’mdp3_dmap_update<br>ä¸€æ¬¡å‘¼å«åï¼Œå¯ä»¥æœ‰å¤šä¸ªå¯¹PLAYå’ŒCOMMIT IOCLTçš„å‘¼å« MSMFB_OVERLAY_SET IOCTLã€‚é¢æ¿æ›´æ–°å®Œæˆå¹¶ä¸”è®¾å¤‡å®Œæˆå<br>éœ€è¦è¿›å…¥æŒ‚èµ·æˆ–å…³é—­çŠ¶æ€ï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨MSMFB_OVERLAY_UNSETã€‚</p><p>æ³¨æ„ï¼šå·¥ä½œé˜Ÿåˆ—æ¶æ„æ­£åœ¨è¢«å³å°†å‘å¸ƒçš„çº¿ç¨‹å–ä»£ï¼Œ<br>è¿™äº›æ–‡ä»¶æœªè¢«æ•è·ã€‚è§†é¢‘å’Œå‘½ä»¤æ¨¡å¼é¢æ¿çš„é¢æ¿æ›´æ–°ç•¥æœ‰ä¸åŒã€‚ä¸ºäº†åœ¨å‘½ä»¤æ¨¡å¼é¢æ¿ä¸­ï¼Œmdp3_dmap_updateå‡½æ•°ä¼šç­‰å¾…ï¼Œç›´åˆ°å‰ä¸€ä¸ªå›¾åƒæ›´æ–°ä¸ºæ­¢å®Œæˆä½¿ç”¨MDP DMAå¼€å§‹æ–°å¸§æ›´æ–°</p><p>ifï¼ˆdma-&gt; output_config.out_sel == MDP3_DMA_OUTPUT_SEL_DSI_CMDï¼‰{<br>cb_type = MDP3_DMA_CALLBACK_TYPE_DMA_DONE;<br>å¦‚æœï¼ˆintf-&gt; activeï¼‰<br>wait_for_completion_killableï¼ˆDMA-&gt; dma_compï¼‰;</p><p>å¯¹äºè§†é¢‘é¢æ¿ï¼Œåœ¨DMAè§¦å‘åï¼Œmdp3_dmap_updateç­‰å¾…vsyncã€‚</p><h4 id="ï¼ˆå…­ï¼‰ã€Msm8610-lcd-driver-å†…æ ¸åˆå§‹åŒ–åˆ†æ"><a href="#ï¼ˆå…­ï¼‰ã€Msm8610-lcd-driver-å†…æ ¸åˆå§‹åŒ–åˆ†æ" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Msm8610  lcd driver å†…æ ¸åˆå§‹åŒ–åˆ†æ"></a>ï¼ˆå…­ï¼‰ã€Msm8610 lcd driver å†…æ ¸åˆå§‹åŒ–åˆ†æ</h4><p>è¯·å‚è€ƒ<a href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347" target="_blank" rel="noopener">ã€msm8610 lcd driver code analysisã€‘</a></p><h4 id="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¸ƒï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><strong>(à¹‘ä¹›â—¡ä¹›à¹‘) ã€ï¼ˆ Í¡Â° ÍœÊ– Í¡Â°ï¼‰ã€ï¼ˆà²¡Ï‰à²¡ï¼‰ï¼ï¼ï¼ç´¯~~~</strong><br><strong>æ—¶è‡³ä»Šæ—¥ï¼Œç»ˆäºå®Œæ•´çš„åˆ†æäº†Android Display System æ€»ä½“æ¡†æ¶æµç¨‹ï¼Œä¸ç¦æ„Ÿå¹è®¡ç®—æœºä¸–ç•Œçš„åšå¤§ç²¾æ·±ï¼Œåœ¨è¿™ä¸ªç³»åˆ—çš„åˆ†æä¸­å†ç»ƒäº†å¦‚ä½•æ‹†è§£åˆ†æä¸€ä¸ªåºå¤§å¤æ‚çš„æ¨¡å—ã€å­¦ä¹ æ”¶è·è‰¯å¤šï¼ŒåŒæ—¶ä¹Ÿäº†è§£äº†è‡ªèº«çŸ¥è¯†çš„æ¬ ç¼ºï¼Œç”±äºæ¶‰åŠçŸ¥è¯†è¾ƒå¤šè¾ƒå¹¿ï¼Œåšä¸»ä¹Ÿæœªèƒ½å®Œå…¨åƒé€ï¼Œå…¶ä¸­åˆ†ææœ‰è¯¯çš„åœ°æ–¹è¿˜è¯·å„ä½è§è°…ã€‚æ‰€è°“è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢ã€‚</strong><br><strong>Todoï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶ï¼ŒMultimedia System ä»»è¿˜æœ‰è®¸å¤šæœªè§£ä¹‹æƒ‘ï¼Œéœ€æ¶è¡¥Linuxå†…æ ¸çŸ¥è¯†ï¼Œå°‘å¹´ï¼ŒåŠ æ²¹ï¼ˆâ½â½â½ï¼‰</strong></p><h4 id="ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆå…«ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a href="https://s3.amazonaws.com/connect.linaro.org/bkk16/Presentations/Wednesday/BKK16-315.pdf" target="_blank" rel="noopener">Graphics Stack Update</a><br><a href="https://blog.csdn.net/eliot_shao/article/details/74926010" target="_blank" rel="noopener">é«˜é€šAndroidå¹³å°-åº”ç”¨ç©ºé—´æ“ä½œframebuffer dump LCDæ€»ç»“</a><br><a href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347" target="_blank" rel="noopener">msm8610 lcd driver code analysis</a><br><a href="https://blog.csdn.net/u012719256/article/details/52096727" target="_blank" rel="noopener">linux qcom LCD framwork</a><br><a href="https://blog.csdn.net/weijory/article/details/69391838" target="_blank" rel="noopener">Qualcommå¹³å° display bring up è¿‡ç¨‹è¯¦è§£</a><br><a href="https://blog.csdn.net/wlwl0071986/article/details/8247443" target="_blank" rel="noopener">é«˜é€š8x25å¹³å°displayæ¨¡å—æ€»ç»“</a><br><a href="https://blog.csdn.net/sfrysh/article/details/7305253" target="_blank" rel="noopener">Android ä¸­çš„ framebuffer</a><br><a href="https://blog.csdn.net/yangwen123/article/details/12096483" target="_blank" rel="noopener">FrameBufferé©±åŠ¨ç¨‹åºåˆ†æ</a><br><a href="http://www.wxtlife.com/2017/06/07/Android-framebuffer/" target="_blank" rel="noopener">Android Framebufferä»‹ç»åŠä½¿ç”¨</a><br><a href="https://www.wolfcstech.com/categories/Android-%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F/" target="_blank" rel="noopener">Android å›¾å½¢ç³»ç»Ÿ</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/">http://zhoujinjian.cc/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/08/16/Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ/" title="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"><i class="iconfont icon-prev"></i>Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/" title="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">25</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.08.jpg" alt="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/12/Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ/" title="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.26.jpg" alt="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</h3><span class="item__text">2018-09-12</span></div></a></li><li class="latest-post-item"><a href="/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/" title="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.25.jpg" alt="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</h3><span class="item__text">2018-09-06</span></div></a></li><li class="latest-post-item"><a href="/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/" title="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" alt="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</h3><span class="item__text">2018-08-30</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>izhoujinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:izhoujinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">353.8k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>