<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~] | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-ç³»ç»Ÿåˆ†æ/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.07.jpg" alt="Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]"></div><header class="post__info"><h1 class="post__title">Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="http://zhoujinjian.cc/">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘.</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-02-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">41058</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">105833</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"><span class="toc-text">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"><span class="toc-text">æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1"><span class="toc-text">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€Android-Graphics-ç³»ç»Ÿæ¡†æ¶"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€Android Graphics ç³»ç»Ÿæ¡†æ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€Android-Graphics-æµ‹è¯•ç¨‹åºï¼ˆC-ï¼‰"><span class="toc-text">ï¼ˆäºŒï¼‰ã€Android Graphics æµ‹è¯•ç¨‹åºï¼ˆC++ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€Android-Graphics-ç¦ç”¨hwcå’ŒGPU"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€Android Graphics ç¦ç”¨hwcå’ŒGPU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1ã€Disable-HWUI-GPU-HWC"><span class="toc-text">3.1ã€Disable_HWUI_GPU_HWC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2ã€Vsyncæµ‹è¯•ç¨‹åº"><span class="toc-text">3.2ã€Vsyncæµ‹è¯•ç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆå››ï¼‰ã€Android-SurfaceFlinger-å†…éƒ¨æœºåˆ¶"><span class="toc-text">ï¼ˆå››ï¼‰ã€Android SurfaceFlinger å†…éƒ¨æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„"><span class="toc-text">4.1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1ã€BufferQueueä»‹ç»"><span class="toc-text">4.1.1ã€BufferQueueä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2ã€ç”Ÿäº§è€…Producer"><span class="toc-text">4.1.2ã€ç”Ÿäº§è€…Producer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3ã€æ¶ˆè´¹è€…Consumer"><span class="toc-text">4.1.3ã€æ¶ˆè´¹è€…Consumer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹"><span class="toc-text">4.2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1ã€Activityå¯åŠ¨æµç¨‹"><span class="toc-text">4.2.1ã€Activityå¯åŠ¨æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹"><span class="toc-text">4.2.2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-1ã€ActivityThread-handleLaunchActivity"><span class="toc-text">4.2.2.1ã€ActivityThread.handleLaunchActivity()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-2ã€ActivityThread-handleResumeActivity"><span class="toc-text">4.2.2.2ã€ActivityThread.handleResumeActivity()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-3ã€ViewRootImpl-æ„é€ è¿‡ç¨‹ï¼š"><span class="toc-text">4.2.2.3ã€ViewRootImpl()æ„é€ è¿‡ç¨‹ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹"><span class="toc-text">4.2.2.4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl-setView"><span class="toc-text">4.2.2.5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl.setView()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-6ã€requestLayout-åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›"><span class="toc-text">4.2.2.6ã€requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-7ã€mWindowSession-addToDisplay-å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›"><span class="toc-text">4.2.2.7ã€mWindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹"><span class="toc-text">4.2.2.8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3ã€Appï¼ˆC-å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯-client-çš„è¿‡ç¨‹"><span class="toc-text">4.2.3ã€Appï¼ˆC++å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯(client)çš„è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹"><span class="toc-text">4.2.4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-Javaå±‚"><span class="toc-text">4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(Javaå±‚)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-C-å±‚"><span class="toc-text">4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(C++å±‚)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-2ã€BufferQueueæ„é€ è¿‡ç¨‹"><span class="toc-text">4.2.4.2ã€BufferQueueæ„é€ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹"><span class="toc-text">4.2.4.2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹"><span class="toc-text">4.2.4.3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-4ã€SurfaceFlingerè®¾ç½®ç›‘å¬"><span class="toc-text">4.2.4.4ã€SurfaceFlingerè®¾ç½®ç›‘å¬</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹"><span class="toc-text">4.2.4.5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout"><span class="toc-text">4.2.4.5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw"><span class="toc-text">4.2.4.7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw()</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3ã€APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹"><span class="toc-text">4.3ã€APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹"><span class="toc-text">4.3.1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4ã€APPæäº¤-unlockAndPost-Bufferçš„è¿‡ç¨‹"><span class="toc-text">4.4ã€APPæäº¤(unlockAndPost)Bufferçš„è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ"><span class="toc-text">ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸€ã€preComposition-å‡½æ•°"><span class="toc-text">ä¸€ã€preComposition()å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°"><span class="toc-text">1.1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2ã€ç»˜åˆ¶æµç¨‹"><span class="toc-text">1.2ã€ç»˜åˆ¶æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#äºŒã€handleTransaction-handPageFlipæ›´æ–°Layerå¯¹è±¡"><span class="toc-text">äºŒã€handleTransaction handPageFlipæ›´æ–°Layerå¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1ã€handleTransactionå‡½æ•°"><span class="toc-text">2.1ã€handleTransactionå‡½æ•°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2ã€Layerçš„doTransactionå‡½æ•°"><span class="toc-text">2.2ã€Layerçš„doTransactionå‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3ã€handleTransactionLockedå‡½æ•°"><span class="toc-text">2.3ã€handleTransactionLockedå‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–"><span class="toc-text">2.3.2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3ã€è®¾ç½®TransfromHit"><span class="toc-text">2.3.3ã€è®¾ç½®TransfromHit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ"><span class="toc-text">2.3.4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-5ã€è®¾ç½®mDrawingState"><span class="toc-text">2.3.5ã€è®¾ç½®mDrawingState</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4ã€handlePageFlipå‡½æ•°"><span class="toc-text">2.4ã€handlePageFlipå‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-å°ç»“"><span class="toc-text">2.5 å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸‰ã€rebuildLayerStackså‡½æ•°"><span class="toc-text">ä¸‰ã€rebuildLayerStackså‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å››ã€setUpHWComposerå‡½æ•°"><span class="toc-text">å››ã€setUpHWComposerå‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ-ï¼ˆdoComposition-å‡½æ•°ï¼‰"><span class="toc-text">äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ ï¼ˆdoComposition()å‡½æ•°ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å…­ã€postFramebuffer-å‡½æ•°"><span class="toc-text">å…­ã€postFramebuffer()å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆå…­ï¼‰ã€Android-SurfaceFlinger-VSyncå·¥ä½œåŸç†"><span class="toc-text">ï¼ˆå…­ï¼‰ã€Android SurfaceFlinger - VSyncå·¥ä½œåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸€ã€VSYNC-æ€»ä½“æ¦‚å¿µ"><span class="toc-text">ä¸€ã€VSYNC æ€»ä½“æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1ã€VSYNC-æ¦‚å¿µ"><span class="toc-text">6.1.1ã€VSYNC æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2ã€Android-VSYNC-â€“-é»„æ²¹è®¡åˆ’"><span class="toc-text">6.1.2ã€Android VSYNC â€“ é»„æ²¹è®¡åˆ’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#äºŒã€VSyncä¿¡å·äº§ç”Ÿ"><span class="toc-text">äºŒã€VSyncä¿¡å·äº§ç”Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†"><span class="toc-text">ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1ã€Surfaceflinger-init"><span class="toc-text">6.3.1ã€Surfaceflinger.init()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2ã€VSyncä¿¡å·çš„å¤„ç†"><span class="toc-text">6.3.2ã€VSyncä¿¡å·çš„å¤„ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection"><span class="toc-text">6.4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5ã€Appè¯·æ±‚Vsyncä¿¡å·"><span class="toc-text">6.5ã€Appè¯·æ±‚Vsyncä¿¡å·</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-1ã€Vsyncè¯·æ±‚è¿‡ç¨‹"><span class="toc-text">6.5.1ã€Vsyncè¯·æ±‚è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync"><span class="toc-text">6.5.2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-1ã€è§£æVSyncäº‹ä»¶"><span class="toc-text">6.5.2.1ã€è§£æVSyncäº‹ä»¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-3ã€VSyncäº‹ä»¶åˆ†å‘"><span class="toc-text">6.5.3ã€VSyncäº‹ä»¶åˆ†å‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-4ã€åº”ç”¨æ¥æ”¶Vsync"><span class="toc-text">6.5.4ã€åº”ç”¨æ¥æ”¶Vsync</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><span class="toc-text">ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></div><p>Androidç³»ç»Ÿå›¾å½¢æ¡†æ¶ç”±ä¸‹å¾€ä¸Šä¸»è¦çš„åŒ…æ‹¬HAL(HWComposerå’ŒGrallocä¸¤ä¸ªmoudle)ï¼ŒSurfaceFlingerï¼ˆBufferQueueçš„æ¶ˆè´¹è€…ï¼‰ï¼ŒWindowManagerServiceï¼ˆçª—å£ç®¡ç†è€…ï¼‰ï¼ŒViewï¼ˆBufferQueueçš„ç”Ÿäº§è€…ï¼‰å››å¤§æ¨¡å—ã€‚<br>â— HAL: åŒ…æ‹¬HWComposerå’ŒGrallocä¸¤ä¸ªmoudleï¼ŒAndroid Nä¸Šç”±SurfaceFlingeræ‰“å¼€ï¼Œå› æ­¤åœ¨åŒä¸€è¿›ç¨‹ã€‚ gralloc ç”¨äºBufferQueueçš„å†…å­˜åˆ†é…ï¼ŒåŒæ—¶ä¹Ÿæœ‰fbçš„æ˜¾ç¤ºæ¥å£ï¼ŒHWComposerä½œä¸ºåˆæˆSurfaceFlingeré‡Œé¢çš„Layerï¼Œå¹¶æ˜¾ç¤ºï¼ˆé€šè¿‡grallocçš„postå‡½æ•°ï¼‰<br>â— SurfaceFlingerå¯ä»¥å«åšLayerFlingerï¼Œä½œä¸ºLayerçš„ç®¡ç†è€…ï¼ŒåŒæ˜¯ä¹Ÿæ˜¯BufferQueueçš„æ¶ˆè´¹è€…ï¼Œå½“æ¯ä¸ªLayerçš„ç”Ÿäº§è€…drawå®Œå®Œæ•´çš„ä¸€å¸§æ—¶ï¼Œä¼šé€šçŸ¥SurfaceFlingerï¼Œé€šçŸ¥çš„æ–¹å¼é‡‡ç”¨BufferQueueã€‚<br>â— WindowManagerService: ä½œä¸ºWindowçš„ç®¡ç†è€…ï¼ŒæŒç®¡ç€è®¡ç®—çª—å£å¤§å°ï¼Œçª—å£åˆ‡æ¢ç­‰ä»»åŠ¡ï¼ŒåŒæ—¶ä¹Ÿä¼šå°†ç›¸åº”çš„å‚æ•°è®¾ç½®ç»™SurfaceFlingerï¼Œæ¯”å¦‚Windowçš„åœ¨z-orderï¼Œå’Œçª—å£çš„å¤§å°ã€‚<br>â— View: ä½œä¸ºBufferQueueçš„ç”Ÿäº§è€…ï¼Œæ¯å½“æ‰§è¡ŒlockCanvas-&gt;draw-&gt;unlockCanvasï¼Œä¹‹åä¼šå­˜å…¥ä¸€å¸§æ•°æ®è¿›å…¥BufferQueueä¸­ã€‚ å˜¿å˜¿(<em>^â–½^</em>),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚ <a id="more"></a></p><h2 id="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"><a href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘" class="headerlink" title="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.graphics" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></h2><h2 id="æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"><a href="#æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š" class="headerlink" title="æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š"></a>æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</h2><p><strong>/frameworks/native/services/surfaceflinger/</strong></p><ul><li>tests/Transaction_test.cpp</li><li>tests/vsync/vsync.cpp</li></ul><p><strong>/frameworks/native/include/gui/</strong></p><ul><li>BitTube.h</li><li>BufferSlot.h</li><li>BufferQueueCore.h</li><li>BufferQueueProducer.h</li></ul><p><strong>/frameworks/base/core/java/android/app/</strong></p><ul><li>Activity.java</li><li>ActivityThread.java</li><li>Instrumentation.java</li></ul><p><strong>/frameworks/base/core/jni/</strong></p><ul><li>android_view_DisplayEventReceiver.cpp</li><li>android_view_SurfaceControl.cpp</li><li>android_view_Surface.cpp</li><li>android_view_SurfaceSession.cpp</li></ul><p><strong>/frameworks/native/include/gui/</strong></p><ul><li>SurfaceComposerClient.h</li><li>IDisplayEventConnection.h</li><li>SurfaceComposerClient.h</li></ul><p><strong>/frameworks/native/services/surfaceflinger/</strong></p><ul><li>SurfaceFlinger.cpp</li><li>Client.cpp</li><li>main_surfaceflinger.cpp</li><li>DisplayDevice.cpp</li><li>DispSync.cpp</li><li>EventControlThread.cpp</li><li>EventThread.cpp</li><li>Layer.cpp</li><li>MonitoredProducer.cpp</li></ul><p><strong>/frameworks/base/core/java/android/view/</strong></p><ul><li>WindowManagerImpl.java</li><li>ViewManager.java</li><li>WindowManagerGlobal.java</li><li>ViewRootImpl.java</li><li>Choreographer.java</li><li>IWindowSession.aidl</li><li>DisplayEventReceiver.java</li><li>SurfaceControl.java</li><li>Surface.java</li><li>SurfaceSession.java</li></ul><p><strong>/frameworks/native/include/ui/</strong></p><ul><li>GraphicBuffer.h</li><li>GraphicBufferAllocator.h</li></ul><p><strong>/frameworks/base/services/core/java/com/android/server/wm/</strong></p><ul><li>WindowManagerService.java</li><li>Session.java</li><li>WindowState.java</li><li>WindowStateAnimator.java</li><li>WindowSurfaceController.java</li></ul><h2 id="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1"><a href="#ã€åšå®¢åŸå›¾é“¾æ¥ã€‘-1" class="headerlink" title="ã€åšå®¢åŸå›¾é“¾æ¥ã€‘"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.graphics" target="_blank" rel="noopener">ã€åšå®¢åŸå›¾é“¾æ¥ã€‘</a></h2><h2 id="ï¼ˆä¸€ï¼‰ã€Android-Graphics-ç³»ç»Ÿæ¡†æ¶"><a href="#ï¼ˆä¸€ï¼‰ã€Android-Graphics-ç³»ç»Ÿæ¡†æ¶" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Android Graphics ç³»ç»Ÿæ¡†æ¶"></a>ï¼ˆä¸€ï¼‰ã€Android Graphics ç³»ç»Ÿæ¡†æ¶</h2><p>ï¼ˆè¯•ç”¨é™åˆ¶ï¼Ÿï¼Ÿï¼Ÿä¸‡æ¶çš„äº¿å›¾(EDraw)å¼ºåŠ æ°´å°~ç«~ï¼‰<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/01-Android-Graphics-Architecture.png" alt="Markdown"></p><p><strong>App</strong> åŸºäºAndroidç³»ç»Ÿçš„GUIæ¡†æ¶å¼€å‘å®Œæ•´çš„Apkåº”ç”¨ã€‚</p><p><strong>Android Graphics Stack Client(SurfaceFlinger Client)</strong><br>Androidåœ¨å®¢æˆ·ç«¯çš„ç»˜å›¾å †æ ˆé€šå¸¸åŒ…æ‹¬ï¼š OpenGL ESï¼šä½¿ç”¨GPUè¿›è¡Œ3Då’Œ2Dçš„ç»˜å›¾çš„API EGLï¼šè¡”æ¥GLESå’Œç³»ç»Ÿçš„Native Windowç³»ç»Ÿçš„é€‚é…å±‚ Vulkanï¼šVulkanä¸ºKhronos Groupæ¨å‡ºçš„ä¸‹ä¸€ä»£è·¨å¹³å°å›¾å½¢å¼€å‘æ¥å£ï¼Œç”¨äºæ›¿ä»£å†å²æ‚ ä¹…çš„OpenGLã€‚Androidä»7.0(Nougat)å¼€å§‹åŠ å…¥äº†å¯¹å…¶çš„æ”¯æŒã€‚Vulkanä¸OpenGLç›¸æ¯”ï¼Œæ¥å£æ›´åº•å±‚ï¼Œä»è€Œä½¿å¼€å‘è€…èƒ½æ›´ç›´æ¥åœ°æ§åˆ¶GPUã€‚ç”±äºæ›´å¥½çš„å¹¶è¡Œæ”¯æŒï¼ŒåŠæ›´å°çš„å¼€é”€ï¼Œæ€§èƒ½ä¸Šä¹Ÿæœ‰ä¸€å®šçš„æå‡ã€‚<br><strong>Android Graphics Stack Serverï¼ˆSurfaceFlinger Serverï¼‰</strong><br>SurfaceFlingeræ˜¯Androidç”¨äºç®¡ç†Displayå’Œè´Ÿè´£Window Compositeï¼ˆçª—å£æ··åˆï¼‰ï¼ŒæŠŠåº”ç”¨çš„æ˜¾ç¤ºçª—å£è¾“å‡ºåˆ°Displayçš„ç³»ç»ŸæœåŠ¡ã€‚</p><p><strong>Android Driversï¼ˆHALï¼‰</strong><br>Androidçš„é©±åŠ¨å±‚ï¼Œé€šè¿‡Androidæœ¬èº«çš„HALï¼ˆç¡¬ä»¶æŠ½è±¡å±‚ï¼‰æœºåˆ¶ï¼Œè¿è¡ŒäºUser Spaceï¼Œè·Ÿæ¸²æŸ“ç›¸å…³çš„åŒ…æ‹¬ï¼š</p><p>Hwcomposerï¼šå¦‚æœç¡¬ä»¶æ”¯æŒï¼ŒSurfaceFlingerå¯ä»¥è¯·æ±‚hwcomposerå»åšçª—å£æ··åˆè€Œä¸éœ€è¦è‡ªå·±æ¥åšï¼Œè¿™æ ·çš„æ•ˆç‡ä¹Ÿä¼šæ›´é«˜ï¼Œå‡å°‘å¯¹GPUèµ„æºçš„å ç”¨ Grallocï¼šç”¨æ¥ç®¡ç†Graphics Bufferçš„åˆ†é…å’Œç®¡ç†ç³»ç»Ÿçš„framebuffer OpenGL ES/EGL</p><p><strong>Linux Kernel and Drivers</strong><br>é™¤äº†æ ‡å‡†çš„Linuxå†…æ ¸å’Œé©±åŠ¨ï¼ˆä¾‹å¦‚fbæ˜¯framebufferé©±åŠ¨ï¼‰ï¼Œç¡¬ä»¶å‚å•†è‡ªå·±çš„é©±åŠ¨å¤–ï¼ŒAndroidè‡ªå·±çš„ä¸€äº›Patchesï¼š</p><p>Ashmemï¼šå¼‚æ­¥å…±äº«å†…å­˜ï¼Œç”¨äºåœ¨è¿›ç¨‹é—´å…±äº«ä¸€å—å†…å­˜åŒºåŸŸï¼Œå¹¶å…è®¸ç³»ç»Ÿåœ¨èµ„æºç´§å¼ æ—¶å›æ”¶ä¸åŠ é”çš„å†…å­˜å— IONï¼šå†…å­˜ç®¡ç†å™¨ IONæ˜¯googleåœ¨Android4.0 ä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡ç®¡ç†è€Œå¼•å…¥çš„é€šç”¨å†…å­˜ç®¡ç†å™¨,åœ¨é¢å‘ç¨‹åºå‘˜ç¼–ç¨‹æ–¹é¢ï¼Œå®ƒå’Œashmemå¾ˆç›¸ä¼¼ã€‚ä½†IONæ¯”ashmemæ›´å¼ºå¤§ Binderï¼šé«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ Vsyncï¼šAndroid 4.1å¼•å…¥äº†Vsync(Vertical Syncronization)ç”¨äºæ¸²æŸ“åŒæ­¥ï¼Œä½¿å¾—App UIå’ŒSurfaceFlingerå¯ä»¥æŒ‰ç¡¬ä»¶äº§ç”Ÿçš„VSyncèŠ‚å¥æ¥è¿›è¡Œå·¥ä½œ <strong>Hardware</strong> Displayï¼ˆæ˜¾ç¤ºå™¨ï¼‰ã€CPUã€GPUã€VPUï¼ˆVideo Process Unitï¼‰ã€å’Œå†…å­˜ç­‰ç­‰</p><h2 id="ï¼ˆäºŒï¼‰ã€Android-Graphics-æµ‹è¯•ç¨‹åºï¼ˆC-ï¼‰"><a href="#ï¼ˆäºŒï¼‰ã€Android-Graphics-æµ‹è¯•ç¨‹åºï¼ˆC-ï¼‰" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Android Graphics æµ‹è¯•ç¨‹åºï¼ˆC++ï¼‰"></a>ï¼ˆäºŒï¼‰ã€Android Graphics æµ‹è¯•ç¨‹åºï¼ˆC++ï¼‰</h2><p>ä¸ºäº†ä¾¿äºè§‚å¯Ÿå¯¹åŸç”Ÿæµ‹è¯•ç¨‹åºæ˜¾ç¤ºå›¾åƒå¤§å°åšäº†å¦‚ä¸‹ä¿®æ”¹ï¼š</p><blockquote><p>frameworks/native/services/surfaceflinger/tests/Transaction_test.cpp</p></blockquote><p><a href="https://github.com/izhoujinjian/izhoujinjian.github.io.doc/blob/master/Android-7.1.2-Qualcomm-MSM89XX-Disable_HWUI_GPU_HWC.patch" target="_blank" rel="noopener">Disable_HWUI_GPU_HWC.patch</a></p><p>åŸç”ŸSurfaceFlingeræµ‹è¯•ç¨‹åºç¼–è¯‘ï¼š<br>1ã€ç¼–è¯‘Android 7.1.2æºç -userdebugç‰ˆæœ¬ï¼Œçƒ§å½•é‡å¯<br>2ã€ç¼–è¯‘/frameworks/native/services/surfaceflinger/tests/ä¼šç”ŸæˆSurfaceFlinger_test<br>3ã€è¿æ¥æ‰‹æœºæ‰§è¡Œå‘½ä»¤ adb rootã€adb remountã€adb push SurfaceFlinger_test /system/bin/<br>4ã€adb shell setenforce 0(æš‚æ—¶å…³é—­SELinuxæƒé™)<br>5ã€adb shellã€cd system/bin/ã€chmod 0777 SurfaceFlinger_test<br>6ã€è¿è¡Œæµ‹è¯•ç¨‹åºï¼š./SurfaceFlinger_test</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/02-Android-graphics-SurfaceFlinger-Test-00.gif" alt="Markdown"></p><p>å¯ä»¥çœ‹åˆ°åœ¨Android æ˜¾ç¤ºå±æ¥æ›¿ç»˜åˆ¶äº†å¤šä¸ªå›¾åƒï¼Œå¹¶ä¸”ä¼šå˜æ¢å½¢çŠ¶ã€ä½ç½®ã€é¢œè‰²ã€é€æ˜åº¦ç­‰ã€‚ æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸»è¦æ­¥éª¤ï¼š 1ã€ åˆ›å»ºSurfaceComposerClient</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceComposerClient&gt; mComposerClient;</span><br><span class="line">mComposerClient = <span class="keyword">new</span> SurfaceComposerClient;</span><br></pre></td></tr></table></figure><p>2ã€ å®¢æˆ·ç«¯SurfaceComposerClientè¯·æ±‚SurfaceFlingeråˆ›å»ºSurface æ³¨ï¼šAppç«¯å¯¹åº”SurfaceControl&lt;â€”&gt;SurfaceFlingerå¯¹åº”Layer</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceControl&gt; mBGSurfaceControl;</span><br><span class="line">sp&lt;SurfaceControl&gt; mFGSurfaceControl;</span><br><span class="line">       <span class="comment">// Background surface</span></span><br><span class="line">mBGSurfaceControl = mComposerClient-&gt;createSurface(</span><br><span class="line">                String8(<span class="string">"BG Test Surface"</span>), displayWidth, displayHeight,</span><br><span class="line">                PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">fillSurfaceRGBA8(mBGSurfaceControl, <span class="number">63</span>, <span class="number">63</span>, <span class="number">195</span>);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/03-Android-Graphics-SF-test-color-blue.png" alt="Markdown"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Foreground surface</span></span><br><span class="line">mFGSurfaceControl = mComposerClient-&gt;createSurface(</span><br><span class="line">        String8(<span class="string">"FG Test Surface"</span>), <span class="number">64</span>, <span class="number">64</span>, PIXEL_FORMAT_RGBA_8888, <span class="number">0</span>);</span><br><span class="line">fillSurfaceRGBA8(mFGSurfaceControl, <span class="number">195</span>, <span class="number">63</span>, <span class="number">63</span>);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/04-Android-Graphics-SF-test-color-red.png" alt="Markdown"></p><p>3ã€å¤„ç†äº‹åŠ¡ï¼Œå°†SurfaceControlï¼ˆAppï¼‰çš„å˜åŒ–æ›´æ–°åˆ°Layerï¼ˆSurfaceFlingerï¼‰å›¾å±‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SurfaceComposerClient::openGlobalTransaction();</span><br><span class="line"></span><br><span class="line">   mComposerClient-&gt;setDisplayLayerStack(display, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">   ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-2</span>));</span><br><span class="line">   ASSERT_EQ(NO_ERROR, mBGSurfaceControl-&gt;show());</span><br><span class="line"></span><br><span class="line">   ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setLayer(INT_MAX<span class="number">-1</span>));</span><br><span class="line">   ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;setPosition(<span class="number">64</span>, <span class="number">64</span>));</span><br><span class="line">   ASSERT_EQ(NO_ERROR, mFGSurfaceControl-&gt;show());</span><br><span class="line"></span><br><span class="line">   SurfaceComposerClient::closeGlobalTransaction(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>4ã€æ¥å—VsyncåŒæ­¥ä¿¡å·ï¼Œæ¸²æŸ“åˆæˆï¼Œæ¨é€åˆ°æ˜¾ç¤ºå±æ˜¾ç¤º<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/05-Android-Graphics-SF-test-frame_01_delay-1s.gif" alt="Markdown"></p><p>æ¥ä¸‹æ¥å¼€å§‹Android Graphicsç³»ç»Ÿç¥ç§˜æ¢ç´¢ä¹‹è°œã€‚</p><h2 id="ï¼ˆä¸‰ï¼‰ã€Android-Graphics-ç¦ç”¨hwcå’ŒGPU"><a href="#ï¼ˆä¸‰ï¼‰ã€Android-Graphics-ç¦ç”¨hwcå’ŒGPU" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Android Graphics ç¦ç”¨hwcå’ŒGPU"></a>ï¼ˆä¸‰ï¼‰ã€Android Graphics ç¦ç”¨hwcå’ŒGPU</h2><h3 id="3-1ã€Disable-HWUI-GPU-HWC"><a href="#3-1ã€Disable-HWUI-GPU-HWC" class="headerlink" title="3.1ã€Disable_HWUI_GPU_HWC"></a>3.1ã€Disable_HWUI_GPU_HWC</h3><p>æ³¨ï¼šåŸºäºAndroid 7.1.2 Qualcomm MSM89XXæºç ï¼Œç”±äºä»£ç æ®µè¾ƒé•¿ï¼Œå·²æ”¾åˆ°GitHub <a href="https://github.com/izhoujinjian/izhoujinjian.github.io.doc/blob/master/Android-7.1.2-Qualcomm-MSM89XX-Disable_HWUI_GPU_HWC.patch" target="_blank" rel="noopener">Disable_HWUI_GPU_HWC.patch</a></p><p>ç¼–è¯‘userdebugç‰ˆæœ¬ï¼Œçƒ§å½•å¼€æœº: è¿è¡Œæµ‹è¯•ç¨‹åºï¼š./SurfaceFlinger_test ç»“æœè·Ÿä¸Šè¿°ä¸€è‡´ï¼Œè¿™é‡Œä¸å†è´´å›¾äº†ã€‚</p><h3 id="3-2ã€Vsyncæµ‹è¯•ç¨‹åº"><a href="#3-2ã€Vsyncæµ‹è¯•ç¨‹åº" class="headerlink" title="3.2ã€Vsyncæµ‹è¯•ç¨‹åº"></a>3.2ã€Vsyncæµ‹è¯•ç¨‹åº</h3><p>Vsync(Vertical Syncronization)ç”¨äºæ¸²æŸ“åŒæ­¥ï¼Œä½¿å¾—App UIå’ŒSurfaceFlingerå¯ä»¥æŒ‰ç¡¬ä»¶äº§ç”Ÿçš„VSyncèŠ‚å¥æ¥è¿›è¡Œå·¥ä½œã€‚</p><p>æŸ¥çœ‹frameworks/native/services/surfaceflinger/tests/ä¸‹è¿˜æœ‰vsyncæµ‹è¯•ç¨‹åº</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/looper.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gui/DisplayEventReceiver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Looper.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">receiver</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DisplayEventReceiver* q = (DisplayEventReceiver*)data;</span><br><span class="line">    <span class="keyword">ssize_t</span> n;</span><br><span class="line">    DisplayEventReceiver::Event buffer[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">nsecs_t</span> oldTimeStamp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((n = q-&gt;getEvents(buffer, <span class="number">1</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ; i&lt;n ; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (buffer[i].header.type == DisplayEventReceiver::DISPLAY_EVENT_VSYNC) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"event vsync: count=%d\t"</span>, buffer[i].vsync.count);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (oldTimeStamp) &#123;</span><br><span class="line">                <span class="keyword">float</span> t = <span class="keyword">float</span>(buffer[i].header.timestamp - oldTimeStamp) / s2ns(<span class="number">1</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%f ms (%f Hz)\n"</span>, t*<span class="number">1000</span>, <span class="number">1.0</span>/t);</span><br><span class="line">            &#125;</span><br><span class="line">            oldTimeStamp = buffer[i].header.timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n&lt;<span class="number">0</span>) &#123;<span class="built_in">printf</span>(<span class="string">"error reading events (%s)\n"</span>, strerror(-n));&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DisplayEventReceiver myDisplayEvent;</span><br><span class="line">    sp&lt;Looper&gt; loop = <span class="keyword">new</span> Looper(<span class="literal">false</span>);</span><br><span class="line">    loop-&gt;addFd(myDisplayEvent.getFd(), <span class="number">0</span>, ALOOPER_EVENT_INPUT, receiver,</span><br><span class="line">            &amp;myDisplayEvent);</span><br><span class="line">    myDisplayEvent.setVsyncRate(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//printf("about to poll...\n");</span></span><br><span class="line">        <span class="keyword">int32_t</span> ret = loop-&gt;pollOnce(<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">            <span class="keyword">case</span> ALOOPER_POLL_WAKE:</span><br><span class="line">                <span class="comment">//("ALOOPER_POLL_WAKE\n");</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ALOOPER_POLL_CALLBACK:</span><br><span class="line">                <span class="comment">//("ALOOPER_POLL_CALLBACK\n");</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ALOOPER_POLL_TIMEOUT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"ALOOPER_POLL_TIMEOUT\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ALOOPER_POLL_ERROR:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"ALOOPER_POLL_TIMEOUT\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"ugh? poll returned %d\n"</span>, ret);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘è¿è¡Œçœ‹çœ‹ï¼šå¯ä»¥çœ‹åˆ°vsyncä¿¡å·æ¯éš”16 msä¸€æ¬¡ï¼Œå…³äºvsyncçŸ¥è¯†ç¨åå†åˆ†æã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">event vsync: count=<span class="number">2631</span> <span class="number">16.168612</span> ms (<span class="number">61.848231</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2632</span> <span class="number">16.168613</span> ms (<span class="number">61.848224</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2633</span> <span class="number">16.168312</span> ms (<span class="number">61.849378</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2634</span> <span class="number">16.168682</span> ms (<span class="number">61.847961</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2635</span> <span class="number">16.168596</span> ms (<span class="number">61.848288</span> Hz)</span><br><span class="line">event vsync: count=<span class="number">2636</span> <span class="number">16.168867</span> ms (<span class="number">61.847255</span> Hz)</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆå››ï¼‰ã€Android-SurfaceFlinger-å†…éƒ¨æœºåˆ¶"><a href="#ï¼ˆå››ï¼‰ã€Android-SurfaceFlinger-å†…éƒ¨æœºåˆ¶" class="headerlink" title="ï¼ˆå››ï¼‰ã€Android SurfaceFlinger å†…éƒ¨æœºåˆ¶"></a>ï¼ˆå››ï¼‰ã€Android SurfaceFlinger å†…éƒ¨æœºåˆ¶</h2><h3 id="4-1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„"><a href="#4-1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„" class="headerlink" title="4.1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„"></a>4.1ã€APPä¸SurfaceFlingerçš„æ•°æ®ç»“æ„</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/06-Android-Graphics-App-SurfaceFlinger.png" alt="Markdown"></p><h4 id="4-1-1ã€BufferQueueä»‹ç»"><a href="#4-1-1ã€BufferQueueä»‹ç»" class="headerlink" title="4.1.1ã€BufferQueueä»‹ç»"></a>4.1.1ã€BufferQueueä»‹ç»</h4><p>BufferQueue ç±»æ˜¯ Android ä¸­æ‰€æœ‰å›¾å½¢å¤„ç†æ“ä½œçš„æ ¸å¿ƒã€‚å®ƒçš„æ˜¯å°†ç”Ÿæˆå›¾å½¢æ•°æ®ç¼“å†²åŒºçš„ä¸€æ–¹ï¼ˆç”Ÿäº§è€…Producerï¼‰è¿æ¥åˆ°æ¥å—æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤ºæˆ–è¿›ä¸€æ­¥å¤„ç†çš„ä¸€æ–¹ï¼ˆæ¶ˆè´¹è€…Consumerï¼‰ã€‚å‡ ä¹æ‰€æœ‰åœ¨ç³»ç»Ÿä¸­ç§»åŠ¨å›¾å½¢æ•°æ®ç¼“å†²åŒºçš„å†…å®¹éƒ½ä¾èµ–äº BufferQueueã€‚ ä»ä¸Šå›¾APPä¸SurfaceFlingeräº¤äº’ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBufferQueueå†…éƒ¨ç»´æŒç€64ä¸ªBufferSlotï¼Œæ¯ä¸€ä¸ªBufferSlotå†…éƒ¨æœ‰ä¸€ä¸ªGraphicBufferæŒ‡å‘åˆ†é…çš„Graphic Bufferã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/07-Android-Graphics-SurfaceFlinger-BufferQueue.png.png" alt="Markdown"><br>å…ˆæ¥çœ‹ä¸€ä¸‹å›¾ä¸­å‡ ä¸ªçŠ¶æ€ä»£è¡¨çš„å«ä¹‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frameworks/native/include/gui/BufferSlot.h</span><br><span class="line"></span><br><span class="line"><span class="comment">// A buffer can be in one of five states, represented as below:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//         | mShared | mDequeueCount | mQueueCount | mAcquireCount |</span></span><br><span class="line"><span class="comment">// --------|---------|---------------|-------------|---------------|</span></span><br><span class="line"><span class="comment">// FREE    |  false  |       0       |      0      |       0       |</span></span><br><span class="line"><span class="comment">// DEQUEUED|  false  |       1       |      0      |       0       |</span></span><br><span class="line"><span class="comment">// QUEUED  |  false  |       0       |      1      |       0       |</span></span><br><span class="line"><span class="comment">// ACQUIRED|  false  |       0       |      0      |       1       |</span></span><br><span class="line"><span class="comment">// SHARED  |  true   |      any      |     any     |      any      |</span></span><br></pre></td></tr></table></figure><p><strong>FREE :</strong> FREEè¡¨ç¤ºç¼“å†²åŒºå¯ç”±ç”Ÿäº§è€…ï¼ˆProducerï¼‰DEQUEUEDå‡ºåˆ—ã€‚ è¯¥BufferSlotç”±BufferQueueâ€æ‹¥æœ‰â€ã€‚ å®ƒè½¬æ¢åˆ°DEQUEUED å½“è°ƒç”¨dequeueBufferæ—¶ã€‚</p><p><strong>DEQUEUEDï¼š</strong> DEQUEUEDè¡¨ç¤ºç¼“å†²åŒºå·²ç»è¢«ç”Ÿäº§è€…ï¼ˆProducerï¼‰å‡ºåˆ—ï¼Œä½†æ˜¯å°šæœªqueued æˆ–canceledã€‚ç”Ÿäº§è€…ï¼ˆProducerï¼‰å¯ä»¥ä¿®æ”¹ç¼“å†²åŒºçš„å†…å®¹ä¸€æ—¦ç›¸å…³çš„é‡Šæ”¾å›´æ è¢«å‘ä¿¡å·é€šçŸ¥ã€‚BufferSlotç”±Producerâ€æ‹¥æœ‰â€ã€‚ å®ƒå¯ä»¥è½¬æ¢åˆ°QUEUEDï¼ˆé€šè¿‡ queueBufferæˆ–è€…attachBufferï¼‰æˆ–è€…è¿”å›FREEï¼ˆé€šè¿‡cancelBufferæˆ–è€…detachBufferï¼‰ã€‚</p><p><strong>QUEUEDï¼š</strong> QUEUEDè¡¨ç¤ºç¼“å†²åŒºå·²ç»è¢«ç”Ÿäº§è€…ï¼ˆProducerï¼‰å¡«å……æ’é˜Ÿç­‰å¾…æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ä½¿ç”¨ã€‚ ç¼“å†²åŒºå†…å®¹å¯èƒ½è¢«ç»§ç»­ ä¿®æ”¹åœ¨æœ‰é™çš„æ—¶é—´å†…ï¼Œæ‰€ä»¥å†…å®¹ä¸èƒ½è¢«è®¿é—®ï¼Œç›´åˆ°å…³è”çš„æ …æ fenceå‘ä¿¡å·ã€‚ è¯¥BufferSlotç”±BufferQueueâ€æ‹¥æœ‰â€ã€‚ å®ƒ å¯ä»¥è½¬æ¢ä¸ºACQUIREDï¼ˆé€šè¿‡acquireBufferï¼‰æˆ–FREEï¼ˆå¦‚æœæ˜¯å¦ä¸€ä¸ªç¼“å†²åŒºä»¥å¼‚æ­¥æ¨¡å¼æ’é˜Ÿï¼‰ã€‚</p><p><strong>ACQUIREDï¼š</strong> ACQUIREDè¡¨ç¤ºç¼“å†²åŒºå·²è¢«æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰è·å–ã€‚ å¦‚ä¸QUEUEDï¼Œå†…å®¹ä¸èƒ½è¢«æ¶ˆè´¹è€…è®¿é—®ï¼Œç›´åˆ° è·å¾—æ …æ fenceä¿¡å·ã€‚ BufferSlotç”±Consumerâ€æ‹¥æœ‰â€ã€‚ å®ƒå½“releaseBufferï¼ˆæˆ–detachBufferï¼‰è¢«è°ƒç”¨æ—¶è½¬æ¢ä¸ºFREEã€‚ ä¸€ä¸ª åˆ†ç¦»çš„ç¼“å†²åŒºä¹Ÿå¯ä»¥é€šè¿‡attachBufferè¿›å…¥ACQUIREDçŠ¶æ€ã€‚</p><p><strong>SHAREDï¼š</strong> SHAREDè¡¨ç¤ºæ­¤ç¼“å†²åŒºæ­£åœ¨å…±äº«ç¼“å†²åŒºä¸­ä½¿ç”¨æ¨¡å¼ã€‚ å®ƒå¯ä»¥åŒæ—¶åœ¨å…¶ä»–Stateçš„ä»»ä½•ç»„åˆï¼Œ é™¤äº†FREE ï¼ˆå› ä¸ºè¿™ä¸åŒ…æ‹¬åœ¨ä»»ä½•å…¶ä»–Stateï¼‰ã€‚ å®ƒå¯ä»¥ä¹Ÿå¯ä»¥å‡ºåˆ—ï¼Œæ’é˜Ÿæˆ–å¤šæ¬¡è·å¾—ã€‚</p><p><strong>ç®€å•æè¿°ä¸€ä¸‹çŠ¶æ€è½¬æ¢è¿‡ç¨‹ï¼š</strong></p><p>1ã€é¦–å…ˆç”Ÿäº§è€…dequeueè¿‡æ¥ä¸€å—Bufferï¼Œæ­¤æ—¶è¯¥bufferçš„çŠ¶æ€ä¸ºDEQUEUEDï¼Œæ‰€æœ‰è€…ä¸ºPRODUCERï¼Œç”Ÿäº§è€…å¯ä»¥å¡«å……æ•°æ®äº†ã€‚åœ¨æ²¡æœ‰dequeueæ“ä½œæ—¶ï¼Œbufferçš„çŠ¶æ€ä¸ºfree,æ‰€æœ‰è€…ä¸ºBUFFERQUEUEã€‚</p><p>2ã€ç”Ÿäº§è€…å¡«å……å®Œæ•°æ®å,è¿›è¡Œqueueæ“ä½œï¼Œæ­¤æ—¶bufferçš„çŠ¶æ€ç”±DEQUEUED-&gt;QUEUEDçš„è½¬å˜ï¼Œbufferæ‰€æœ‰è€…ä¹Ÿå˜æˆäº†BufferQueueäº†ã€‚</p><p>3ã€ä¸Šé¢å·²ç»é€šçŸ¥æ¶ˆè´¹è€…å»æ‹¿bufferäº†ï¼Œè¿™ä¸ªæ—¶å€™æ¶ˆè´¹è€…å°±è¿›è¡Œacquireæ“ä½œå°†bufferæ‹¿è¿‡æ¥ï¼Œæ­¤æ—¶bufferçš„çŠ¶æ€ç”±QUEUED-&gt;ACQUIREDè½¬å˜ï¼Œbufferçš„æ‹¥æœ‰è€…ç”±BufferQueueå˜æˆConsumerã€‚</p><p>4ã€å½“æ¶ˆè´¹è€…å·²ç»æ¶ˆè´¹äº†è¿™å—buffer(å·²ç»åˆæˆï¼Œå·²ç»ç¼–ç ç­‰)ï¼Œå°±è¿›è¡Œreleaseæ“ä½œé‡Šæ”¾buffer,å°†bufferå½’è¿˜ç»™BufferQueue,bufferçŠ¶æ€ç”±ACQUIREDå˜æˆFREE.bufferæ‹¥æœ‰è€…ç”±Consumerå˜æˆBufferQueue.</p><h4 id="4-1-2ã€ç”Ÿäº§è€…Producer"><a href="#4-1-2ã€ç”Ÿäº§è€…Producer" class="headerlink" title="4.1.2ã€ç”Ÿäº§è€…Producer"></a>4.1.2ã€ç”Ÿäº§è€…Producer</h4><p>ç”Ÿäº§è€…Producerå®ç°IGraphicBufferProducerçš„æ¥å£ï¼Œåœ¨å®é™…è¿ä½œè¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ï¼ˆClientç«¯ï¼‰å­˜åœ¨ä»£ç†ç«¯BpGraphicBufferProducerï¼ŒSurfaceFlingerï¼ˆServerç«¯ï¼‰å­˜åœ¨Nativeç«¯BnGraphicBufferProducerã€‚ç”Ÿäº§è€…ä»£ç†ç«¯Bpé€šè¿‡Binderé€šä¿¡ï¼Œä¸æ–­çš„dequeueBufferå’ŒqueueBufferæ“ä½œï¼ŒNativeç«¯åŒæ ·å“åº”è¿™äº›æ“ä½œè¯·æ±‚ï¼Œè¿™æ ·bufferå°±è½¬äº†èµ·æ¥äº†ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/08-Android-Graphics-SurfaceFlinger-IGraphicsBufferProducer.png" alt="Markdown"></p><p>è¿™é‡Œä»‹ç»å‡ ä¸ªéå¸¸é‡è¦çš„å‡½æ•°ï¼š <strong>1ã€requestBuffer</strong> requestBufferä¸ºç»™å®šçš„ç´¢å¼•è¯·æ±‚ä¸€ä¸ªæ–°çš„Bufferã€‚ æœåŠ¡å™¨ï¼ˆå³IGraphicBufferProducerå®ç°ï¼‰åˆ†é…æ–°åˆ›å»ºçš„Bufferåˆ°ç»™å®šçš„BufferSlotæ§½ç´¢å¼•ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯å¯ä»¥é•œåƒslot-&gt;Bufferæ˜ å°„ï¼Œè¿™æ ·å°±æ²¡æœ‰å¿…è¦ä¼ è¾“ä¸€ä¸ªGraphicBufferç”¨äºæ¯ä¸ªå‡ºé˜Ÿæ“ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// requestBuffer requests a new buffer for the given index. The server (i.e.</span><br><span class="line">// the IGraphicBufferProducer implementation) assigns the newly created</span><br><span class="line">// buffer to the given slot index, and the client is expected to mirror the</span><br><span class="line">// slot-&gt;buffer mapping so that it&apos;s not necessary to transfer a</span><br><span class="line">// GraphicBuffer for every dequeue operation.</span><br><span class="line">//</span><br><span class="line">// The slot must be in the range of [0, NUM_BUFFER_SLOTS).</span><br><span class="line">virtual status_t requestBuffer(int slot, sp&lt;GraphicBuffer&gt;* buf) = 0;</span><br></pre></td></tr></table></figure><p><strong>2ã€dequeueBuffer</strong> dequeueBufferè¯·æ±‚ä¸€ä¸ªæ–°çš„Buffer Slotä¾›å®¢æˆ·ç«¯ä½¿ç”¨ã€‚ æ’æ§½çš„æ‰€æœ‰æƒè¢«è½¬ç§»åˆ°å®¢æˆ·ç«¯ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨ä¸ä¼šä½¿ç”¨ä¸è¯¥æ’æ§½å…³è”çš„ç¼“å†²åŒºçš„å†…å®¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// dequeueBuffer requests a new buffer slot for the client to use. Ownership</span><br><span class="line">// of the slot is transfered to the client, meaning that the server will not</span><br><span class="line">// use the contents of the buffer associated with that slot.</span><br><span class="line">//</span><br><span class="line">virtual status_t dequeueBuffer(int* slot, sp&lt;Fence&gt;* fence, uint32_t w,</span><br><span class="line">        uint32_t h, PixelFormat format, uint32_t usage) = 0;</span><br></pre></td></tr></table></figure><p><strong>3ã€detachBuffer</strong> detachBufferå°è¯•åˆ é™¤ç»™å®šbuffer çš„æ‰€æœ‰æƒæ’æ§½ä»buffer queueã€‚ å¦‚æœè¿™ä¸ªè¯·æ±‚æˆåŠŸï¼Œè¯¥slotå°†ä¼šè¢«freeï¼Œå¹¶ä¸”å°†æ— æ³•ä»è¿™ä¸ªæ¥å£è·å¾—ç¼“å†²åŒºã€‚é‡Šæ”¾çš„æ’æ§½å°†ä¿æŒæœªåˆ†é…çŠ¶æ€ï¼Œç›´åˆ°è¢«é€‰ä¸­ä¸ºæ­¢åœ¨dequeueBufferä¸­ä¿å­˜ä¸€ä¸ªæ–°åˆ†é…çš„ç¼“å†²åŒºï¼Œæˆ–è€…é™„åŠ ä¸€ä¸ªç¼“å†²åŒºåˆ°æ’æ§½ã€‚ ç¼“å†²åŒºå¿…é¡»å·²ç»è¢«å–å‡ºï¼Œå¹¶ä¸”è°ƒç”¨è€…å¿…é¡»å·²ç»æ‹¥æœ‰sp</p><graphicbuffer>ï¼ˆå³å¿…é¡»è°ƒç”¨requestBufferï¼‰</graphicbuffer><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// detachBuffer attempts to remove all ownership of the buffer in the given</span><br><span class="line">// slot from the buffer queue. If this call succeeds, the slot will be</span><br><span class="line">// freed, and there will be no way to obtain the buffer from this interface.</span><br><span class="line">// The freed slot will remain unallocated until either it is selected to</span><br><span class="line">// hold a freshly allocated buffer in dequeueBuffer or a buffer is attached</span><br><span class="line">// to the slot. The buffer must have already been dequeued, and the caller</span><br><span class="line">// must already possesses the sp&lt;GraphicBuffer&gt; (i.e., must have called</span><br><span class="line">// requestBuffer).</span><br><span class="line">//</span><br><span class="line">virtual status_t detachBuffer(int slot) = 0;</span><br></pre></td></tr></table></figure><p><strong>4ã€attachBuffer</strong> attachBufferå°è¯•å°†ç¼“å†²åŒºçš„æ‰€æœ‰æƒè½¬ç§»ç»™ç¼“å†²åŒºé˜Ÿåˆ—ã€‚ å¦‚æœè¿™ä¸ªè°ƒç”¨æˆåŠŸï¼Œå°±å¥½åƒè¿™ä¸ªç¼“å†²åŒºå·²ç»å‡ºé˜Ÿä¸€æ ·ä»è¿”å›çš„æ’æ§½å·ç ã€‚ å› æ­¤ï¼Œå¦‚æœè¿æ¥ï¼Œè¿™ä¸ªè°ƒç”¨å°†å¤±è´¥è¿™ä¸ªç¼“å†²åŒºä¼šå¯¼è‡´å¾ˆå¤šçš„ç¼“å†²åŒºåŒæ—¶å‡ºé˜Ÿã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// attachBuffer attempts to transfer ownership of a buffer to the buffer</span><br><span class="line">// queue. If this call succeeds, it will be as if this buffer was dequeued</span><br><span class="line">// from the returned slot number. As such, this call will fail if attaching</span><br><span class="line">// this buffer would cause too many buffers to be simultaneously dequeued.</span><br><span class="line">//</span><br><span class="line">virtual status_t attachBuffer(int* outSlot,</span><br><span class="line">        const sp&lt;GraphicBuffer&gt;&amp; buffer) = 0;</span><br></pre></td></tr></table></figure><h4 id="4-1-3ã€æ¶ˆè´¹è€…Consumer"><a href="#4-1-3ã€æ¶ˆè´¹è€…Consumer" class="headerlink" title="4.1.3ã€æ¶ˆè´¹è€…Consumer"></a>4.1.3ã€æ¶ˆè´¹è€…Consumer</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/09-Android-Graphics-SurfaceFlinger-IGraphicsBufferConsumer.png" alt="Markdown"><br>è¿™é‡Œä»‹ç»å‡ ä¸ªéå¸¸é‡è¦çš„å‡½æ•°ï¼š <strong>1ã€acquireBuffer</strong> acquireBufferå°è¯•è·å–ä¸‹ä¸€ä¸ªæœªå†³ç¼“å†²åŒºçš„æ‰€æœ‰æƒBufferQueueã€‚ å¦‚æœæ²¡æœ‰ç¼“å†²åŒºç­‰å¾…ï¼Œåˆ™è¿”å›NO_BUFFER_AVAILABLEã€‚ å¦‚æœç¼“å†²åŒºè¢«æˆåŠŸè·å–ï¼Œæœ‰å…³ç¼“å†²åŒºçš„ä¿¡æ¯å°†åœ¨BufferItemä¸­è¿”å›ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// acquireBuffer attempts to acquire ownership of the next pending buffer in</span><br><span class="line">// the BufferQueue.  If no buffer is pending then it returns</span><br><span class="line">// NO_BUFFER_AVAILABLE.  If a buffer is successfully acquired, the</span><br><span class="line">// information about the buffer is returned in BufferItem.</span><br><span class="line">//</span><br><span class="line">virtual status_t acquireBuffer(BufferItem* buffer, nsecs_t presentWhen,</span><br><span class="line">        uint64_t maxFrameNumber = 0) = 0;</span><br></pre></td></tr></table></figure><p><strong>2ã€releaseBuffer</strong> releaseBufferä»æ¶ˆè´¹è€…é‡Šæ”¾ä¸€ä¸ªBufferSlotå›åˆ°BufferQueueã€‚ è¿™å¯ä»¥åœ¨ç¼“å†²åŒºçš„å†…å®¹ä»ç„¶å­˜åœ¨æ—¶å®Œæˆè¢«è®¿é—®ã€‚ æ …æ å°†åœ¨ç¼“å†²åŒºä¸å†æ­£åœ¨ä½¿ç”¨æ—¶å‘å‡ºä¿¡å·ã€‚ frameNumberç”¨äºæ ‡è¯†è¿”å›çš„ç¡®åˆ‡ç¼“å†²åŒºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// releaseBuffer releases a buffer slot from the consumer back to the</span><br><span class="line">// BufferQueue.  This may be done while the buffer&apos;s contents are still</span><br><span class="line">// being accessed.  The fence will signal when the buffer is no longer</span><br><span class="line">// in use. frameNumber is used to indentify the exact buffer returned.</span><br><span class="line">//</span><br><span class="line">virtual status_t releaseBuffer(int buf, uint64_t frameNumber,</span><br><span class="line">        EGLDisplay display, EGLSyncKHR fence,</span><br><span class="line">        const sp&lt;Fence&gt;&amp; releaseFence) = 0;</span><br></pre></td></tr></table></figure><p><strong>3ã€detachBuffer</strong> detachBufferå°è¯•åˆ é™¤ç»™å®šç¼“å†²åŒºçš„æ‰€æœ‰æƒæ’æ§½ä»ç¼“å†²åŒºé˜Ÿåˆ—ã€‚ å¦‚æœè¿™ä¸ªè¯·æ±‚æˆåŠŸï¼Œè¯¥æ’æ§½å°†ä¼šæ˜¯é‡Šæ”¾ï¼Œå¹¶ä¸”å°†æ— æ³•ä»è¿™ä¸ªæ¥å£è·å¾—ç¼“å†²åŒºã€‚é‡Šæ”¾çš„æ’æ§½å°†ä¿æŒæœªåˆ†é…çŠ¶æ€ï¼Œç›´åˆ°è¢«é€‰ä¸­ä¸ºæ­¢åœ¨dequeueBufferä¸­ä¿å­˜ä¸€ä¸ªæ–°åˆ†é…çš„ç¼“å†²åŒºï¼Œæˆ–è€…é™„åŠ ä¸€ä¸ªç¼“å†²åŒºåˆ°slotã€‚ ç¼“å†²åŒºå¿…é¡»å·²è¢«acquiredã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// detachBuffer attempts to remove all ownership of the buffer in the given</span></span><br><span class="line"><span class="comment">// slot from the buffer queue. If this call succeeds, the slot will be</span></span><br><span class="line"><span class="comment">// freed, and there will be no way to obtain the buffer from this interface.</span></span><br><span class="line"><span class="comment">// The freed slot will remain unallocated until either it is selected to</span></span><br><span class="line"><span class="comment">// hold a freshly allocated buffer in dequeueBuffer or a buffer is attached</span></span><br><span class="line"><span class="comment">// to the slot. The buffer must have already been acquired.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">detachBuffer</span><span class="params">(<span class="keyword">int</span> slot)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p><strong>4ã€attachBuffer</strong> attachBufferå°è¯•å°†ç¼“å†²åŒºçš„æ‰€æœ‰æƒè½¬ç§»ç»™ç¼“å†²åŒºé˜Ÿåˆ—ã€‚ å¦‚æœè¿™ä¸ªè°ƒç”¨æˆåŠŸï¼Œå°±å¥½åƒè¿™ä¸ªç¼“å†²åŒºè¢«è·å–äº†ä¸€æ ·ä»è¿”å›çš„æ’æ§½å·ç ã€‚ å› æ­¤ï¼Œå¦‚æœè¿æ¥ï¼Œè¿™ä¸ªè°ƒç”¨å°†å¤±è´¥è¿™ä¸ªç¼“å†²åŒºä¼šå¯¼è‡´å¤ªå¤šçš„ç¼“å†²åŒºè¢«åŒæ—¶acquiredã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// attachBuffer attempts to transfer ownership of a buffer to the buffer</span></span><br><span class="line"><span class="comment">// queue. If this call succeeds, it will be as if this buffer was acquired</span></span><br><span class="line"><span class="comment">// from the returned slot number. As such, this call will fail if attaching</span></span><br><span class="line"><span class="comment">// this buffer would cause too many buffers to be simultaneously acquired.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">attachBuffer</span><span class="params">(<span class="keyword">int</span> *outSlot,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;GraphicBuffer&gt;&amp; buffer)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h2 id="4-2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹"><a href="#4-2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹" class="headerlink" title="4.2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹"></a>4.2ã€Appï¼ˆJavaå±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹</h2><h3 id="4-2-1ã€Activityå¯åŠ¨æµç¨‹"><a href="#4-2-1ã€Activityå¯åŠ¨æµç¨‹" class="headerlink" title="4.2.1ã€Activityå¯åŠ¨æµç¨‹"></a>4.2.1ã€Activityå¯åŠ¨æµç¨‹</h3><p>Activityåˆ›å»ºè¿‡ç¨‹è¿™é‡Œä¸å†å™è¿°ã€‚ è¯·å‚è€ƒ<a href="https://izhoujinjian.github.io/2017/12/29/Android-7-1-2-Android-N-Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#%E4%B8%89%E3%80%81-ActivityManagerService%E6%8E%A5%E6%94%B6%E5%90%AF%E5%8A%A8Activity%E7%9A%84%E8%AF%B7%E6%B1%82" target="_blank" rel="noopener">ã€Android 7.1.2 (Android N) Activityå¯åŠ¨æµç¨‹åˆ†æã€‘</a> &amp;&amp; <a href="https://izhoujinjian.github.io/2018/01/02/Android-7-1-2-Android-N-Activity-Window%E5%8A%A0%E8%BD%BD%E6%98%BE%E7%A4%BA%E6%B5%81%E7%A8%8B/#%E5%8D%9A%E5%AE%A2%E5%8E%9F%E5%9B%BE%E9%93%BE%E6%8E%A5" target="_blank" rel="noopener">ã€Android 7.1.2 (Android N) Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹åˆ†æã€‘</a></p><blockquote><p>â— ActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚</p><p>Activity.startActivity()<br>Activity.startActivityForResult()<br>Instrumentation.execStartActivity()<br>ActivityManagerProxy.startActivity()<br>ActivityManagerNative.onTransact()<br>ActivityManagerService.startActivity()<br>ActivityStarter.startActivityMayWait()<br>ActivityStarter.startActivityLocked()<br>ActivityStarter.startActivityUnchecked()<br>ActivityStackSupervisor.resumeFocusedStackTopActivityLocked() ActivityStack.resumeTopActivityUncheckedLocked()<br>ActivityStack.resumeTopActivityInnerLocked()<br>ActivityStackSupervisor.startSpecificActivityLocked()</p><p>â—â— åˆ›å»ºActivityæ‰€å±çš„åº”ç”¨è¿›ç¨‹ ActivityManagerService.startProcessLocked()</p><p>â—â—â— Zygoteé€šè¿‡socketé€šä¿¡forkä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶æ ¹æ®â€android.app.ActivityThreadâ€å­—ç¬¦ä¸²<br>â—â—â— åå°„å‡ºè¯¥å¯¹è±¡å¹¶æ‰§è¡ŒActivityThreadçš„mainæ–¹æ³•<br>ActivityThread.main()<br>ActivityThread.attach()<br>ActivityManagerProxy.attachApplication()<br>ActivityManagerNative.onTransact()<br>ActivityManagerService.attachApplication()<br>ActivityManagerService.attachApplicationLocked()<br>ActivityStackSupervisor.attachApplicationLocked()<br>ActivityStackSupervisor.realStartActivityLocked()</p><p>â—â—â—â— æ‰§è¡Œå¯åŠ¨Acitivity<br>IApplicationThread.scheduleLaunchActivity()<br>ActivityThread.ApplicationThread.scheduleLaunchActivity()<br>ActivityThread.sendMessage() ActivityThread.H.handleMessage()<br>ActivityThread.handleLauncherActivity()<br>ActivityThread.performLauncherActivity()<br>ActivityThread.handleResumeActivity()</p><h5 id="4-2-2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹"><a href="#4-2-2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹" class="headerlink" title="4.2.2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹"></a>4.2.2ã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹</h5><p>ç”»å›¾ï¼Œéœ€è¦é‡æ–°åˆ†æä¸€ä¸‹ä¸‹ï¼Œå˜¿å˜¿(<em>^â–½^</em>)~</p><h5 id="4-2-2-1ã€ActivityThread-handleLaunchActivity"><a href="#4-2-2-1ã€ActivityThread-handleLaunchActivity" class="headerlink" title="4.2.2.1ã€ActivityThread.handleLaunchActivity()"></a>4.2.2.1ã€ActivityThread.handleLaunchActivity()</h5><p>æ¥ç€ä»ActivityThreadçš„handleLaunchActivityæ–¹æ³•ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//åˆ›å»ºActivity  </span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//å¯åŠ¨Activity  </span></span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-2-2ã€ActivityThread-handleResumeActivity"><a href="#4-2-2-2ã€ActivityThread-handleResumeActivity" class="headerlink" title="4.2.2.2ã€ActivityThread.handleResumeActivity()"></a>4.2.2.2ã€ActivityThread.handleResumeActivity()</h3><p>å›åˆ°æˆ‘ä»¬åˆšåˆšçš„handleLaunchActivity()æ–¹æ³•ï¼Œåœ¨è°ƒç”¨å®ŒperformLaunchActivity()æ–¹æ³•ä¹‹åï¼Œå…¶æœ‰æ‰ç”¨äº†handleResumeActivity()æ³•ã€‚performLaunchActivity()æ–¹æ³•å®Œæˆäº†ä¸¤ä»¶äº‹ï¼š 1) Activityçª—å£å¯¹è±¡çš„åˆ›å»ºï¼Œé€šè¿‡attachå‡½æ•°æ¥å®Œæˆï¼› 2) Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºï¼Œé€šè¿‡setContentViewå‡½æ•°æ¥å®Œæˆï¼› è¿™äº›å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œå°±å¯ä»¥æ˜¾ç¤ºè¯¥Activityäº†ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹é€šè¿‡è°ƒç”¨handleResumeActivityå‡½æ•°æ¥å¯åŠ¨Activityçš„æ˜¾ç¤ºè¿‡ç¨‹ã€‚ [-&gt;ActivityThread.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    ......</span><br><span class="line">    r = performResumeActivity(token, clearHide, reason);</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            <span class="comment">//è·å¾—ä¸ºå½“å‰Activityåˆ›å»ºçš„çª—å£PhoneWindowå¯¹è±¡</span></span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            <span class="comment">//è·å–ä¸ºçª—å£åˆ›å»ºçš„è§†å›¾DecorViewå¯¹è±¡</span></span><br><span class="line">            View decor = r.window.getDecorView();</span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            <span class="comment">//åœ¨attachå‡½æ•°ä¸­å°±ä¸ºå½“å‰Activityåˆ›å»ºäº†WindowManagerå¯¹è±¡  </span></span><br><span class="line">            ViewManager wm = a.getWindowManager();</span><br><span class="line">            <span class="comment">//å¾—åˆ°è¯¥è§†å›¾å¯¹è±¡çš„å¸ƒå±€å‚æ•°  </span></span><br><span class="line">            WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">            <span class="comment">//å°†è§†å›¾å¯¹è±¡ä¿å­˜åˆ°Activityçš„æˆå‘˜å˜é‡mDecorä¸­  </span></span><br><span class="line">            a.mDecor = decor;</span><br><span class="line">            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">            l.softInputMode |= forwardBit;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//å°†åˆ›å»ºçš„è§†å›¾å¯¹è±¡DecorViewæ·»åŠ åˆ°Activityçš„çª—å£ç®¡ç†å™¨ä¸­  </span></span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‰é¢çš„performLaunchActivityå‡½æ•°ä¸­å®ŒæˆActivityçš„åˆ›å»ºåï¼Œä¼šå°†å½“å‰å½“å‰åˆ›å»ºçš„Activityåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ç«¯çš„æè¿°ç¬¦ActivityClientRecordä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åˆ°ActivityThreadçš„æˆå‘˜å˜é‡mActivitiesä¸­ï¼šmActivities.put(r.token, r)ï¼Œr.tokenå°±æ˜¯Activityçš„èº«ä»½è¯ï¼Œå³æ˜¯IApplicationToken.Proxyä»£ç†å¯¹è±¡ï¼Œä¹Ÿç”¨äºä¸AMSé€šä¿¡ã€‚ä¸Šé¢çš„å‡½æ•°é¦–å…ˆé€šè¿‡performResumeActivityä»mActivitieså˜é‡ä¸­å–å‡ºActivityçš„åº”ç”¨ç¨‹åºç«¯æè¿°ç¬¦ActivityClientRecordï¼Œç„¶åå–å‡ºå‰é¢ä¸ºActivityåˆ›å»ºçš„è§†å›¾å¯¹è±¡DecorViewå’Œçª—å£ç®¡ç†å™¨WindowManagerï¼Œæœ€åå°†è§†å›¾å¯¹è±¡æ·»åŠ åˆ°çª—å£ç®¡ç†å™¨ä¸­ã€‚ ViewManager.addView()çœŸæ­£å®ç°çš„çš„åœ°æ–¹åœ¨WindowManagerImpl.javaä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerGlobal.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">        Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        ......</span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">        mParams.add(wparams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        root.setView(view, wparams, panelParentView);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-2-3ã€ViewRootImpl-æ„é€ è¿‡ç¨‹ï¼š"><a href="#4-2-2-3ã€ViewRootImpl-æ„é€ è¿‡ç¨‹ï¼š" class="headerlink" title="4.2.2.3ã€ViewRootImpl()æ„é€ è¿‡ç¨‹ï¼š"></a>4.2.2.3ã€ViewRootImpl()æ„é€ è¿‡ç¨‹ï¼š</h3><p>[ViewRootImpl.java # ViewRootImpl()]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">final</span> W mWindow;</span><br><span class="line">    <span class="keyword">final</span> Surface mSurface = <span class="keyword">new</span> Surface();</span><br><span class="line">    <span class="keyword">final</span> ViewRootHandler mHandler = <span class="keyword">new</span> ViewRootHandler();</span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mWindowSession = WindowManagerGlobal.getWindowSession();<span class="comment">//IWindowSessionçš„ä»£ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºå’ŒWMSé€šä¿¡ã€‚</span></span><br><span class="line">    mDisplay = display;</span><br><span class="line">    ......</span><br><span class="line">    mWindow = <span class="keyword">new</span> W(<span class="keyword">this</span>);<span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªWæœ¬åœ°Binderå¯¹è±¡ï¼Œç”¨äºWMSé€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹</span></span><br><span class="line">    ......</span><br><span class="line">    mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler, <span class="keyword">this</span>);</span><br><span class="line">    ......</span><br><span class="line">    mViewConfiguration = ViewConfiguration.get(context);</span><br><span class="line">    mDensity = context.getResources().getDisplayMetrics().densityDpi;</span><br><span class="line">    mNoncompatDensity = context.getResources().getDisplayMetrics().noncompatDensityDpi;</span><br><span class="line">    mFallbackEventHandler = <span class="keyword">new</span> PhoneFallbackEventHandler(context);</span><br><span class="line">    mChoreographer = Choreographer.getInstance();<span class="comment">//Choreographerå¯¹è±¡</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ViewRootImplçš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–äº†ä¸€äº›æˆå‘˜å˜é‡ï¼ŒViewRootImplåˆ›å»ºäº†ä»¥ä¸‹å‡ ä¸ªä¸»è¦å¯¹è±¡ï¼š</p><p>(1) é€šè¿‡WindowManagerGlobal.getWindowSession()å¾—åˆ°IWindowSessionçš„ä»£ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºå’ŒWMSé€šä¿¡ã€‚</p><p>(2) åˆ›å»ºäº†ä¸€ä¸ªWæœ¬åœ°Binderå¯¹è±¡ï¼Œç”¨äºWMSé€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</p><p>(3) é‡‡ç”¨å•ä¾‹æ¨¡å¼åˆ›å»ºäº†ä¸€ä¸ªChoreographerå¯¹è±¡ï¼Œç”¨äºç»Ÿä¸€è°ƒåº¦çª—å£ç»˜å›¾ã€‚</p><p>(4) åˆ›å»ºViewRootHandlerå¯¹è±¡ï¼Œç”¨äºå¤„ç†å½“å‰è§†å›¾æ¶ˆæ¯ã€‚</p><p>(5) æ„é€ ä¸€ä¸ªAttachInfoå¯¹è±¡ï¼›</p><p>â—â—â—(6) åˆ›å»ºSurfaceå¯¹è±¡ï¼Œç”¨äºç»˜åˆ¶å½“å‰è§†å›¾ï¼Œå½“ç„¶è¯¥Surfaceå¯¹è±¡çš„çœŸæ­£åˆ›å»ºæ˜¯ç”±WMSæ¥å®Œæˆçš„ï¼Œåªä¸è¿‡æ˜¯WMSä¼ é€’ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹çš„ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/10-Android-Graphics-App-WMS-Surface.png.png" alt="Markdown"></p><h3 id="4-2-2-4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹"><a href="#4-2-2-4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹" class="headerlink" title="4.2.2.4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹"></a>4.2.2.4ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹</h3><p>[-&gt;WindowManagerGlobal.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> IWindowSession sWindowSession;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title">getWindowSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWindowSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">                <span class="comment">//å¾—åˆ°IWindowSessionä»£ç†å¯¹è±¡</span></span><br><span class="line">                sWindowSession = windowManager.openSession(</span><br><span class="line">                        <span class="keyword">new</span> IWindowSessionCallback.Stub() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimatorScaleChanged</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">                                ValueAnimator.setDurationScale(scale);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        imm.getClient(), imm.getInputContext());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWindowSession;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå‡½æ•°é€šè¿‡WMSçš„openSessionå‡½æ•°åˆ›å»ºåº”ç”¨ç¨‹åºä¸WMSä¹‹é—´çš„è¿æ¥é€šé“ï¼Œå³è·å–IWindowSessionä»£ç†å¯¹è±¡ï¼Œå¹¶å°†è¯¥ä»£ç†å¯¹è±¡ä¿å­˜åˆ°ViewRootImplçš„é™æ€æˆå‘˜å˜é‡sWindowSessionä¸­,å› æ­¤åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªIWindowSessionä»£ç†å¯¹è±¡ã€‚ [-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> IWindowSession <span class="title">openSession</span><span class="params">(IWindowSessionCallback callback, IInputMethodClient client,</span></span></span><br><span class="line"><span class="function"><span class="params">        IInputContext inputContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (client == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null client"</span>);</span><br><span class="line">    <span class="keyword">if</span> (inputContext == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null inputContext"</span>);</span><br><span class="line">    Session session = <span class="keyword">new</span> Session(<span class="keyword">this</span>, callback, client, inputContext);</span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨WMSæœåŠ¡ç«¯æ„é€ äº†ä¸€ä¸ªSessionå®ä¾‹å¯¹è±¡ã€‚ViewRootImpl æ˜¯ä¸€å¾ˆé‡è¦çš„ç±»ï¼Œç±»ä¼¼ ActivityThread è´Ÿè´£è·ŸAmSé€šä¿¡ä¸€æ ·ï¼ŒViewRootImpl çš„ä¸€ä¸ªé‡è¦èŒè´£å°±æ˜¯è·Ÿ WmS é€šä¿¡ï¼Œå®ƒé€šé™æ€å˜é‡ sWindowSessionï¼ˆIWindowSessionå®ä¾‹ï¼‰ä¸ WmS è¿›è¡Œé€šä¿¡ã€‚æ¯ä¸ªåº”ç”¨è¿›ç¨‹ï¼Œä»…æœ‰ä¸€ä¸ª sWindowSession å¯¹è±¡ï¼Œå®ƒå¯¹åº”äº† WmS ä¸­çš„ Session å­ç±»ï¼ŒWmS ä¸ºæ¯ä¸€ä¸ªåº”ç”¨è¿›ç¨‹åˆ†é…ä¸€ä¸ª Session å¯¹è±¡ã€‚WindowState ç±»æœ‰ä¸€ä¸ª IWindow mClient å‚æ•°ï¼Œæ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­èµ‹å€¼çš„ï¼Œæ˜¯ç”± Session è°ƒç”¨ addWindow ä¼ é€’è¿‡æ¥äº†ï¼Œå¯¹åº”äº† ViewRootImpl ä¸­çš„ W ç±»çš„å®ä¾‹ã€‚</p><h3 id="4-2-2-5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl-setView"><a href="#4-2-2-5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl-setView" class="headerlink" title="4.2.2.5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl.setView()"></a>4.2.2.5ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹ViewRootImpl.setView()</h3><p>çª—å£ç®¡ç†å™¨WindowManagerImplä¸ºå½“å‰æ·»åŠ çš„çª—å£åˆ›å»ºå¥½å„ç§å¯¹è±¡åï¼Œè°ƒç”¨ViewRootImplçš„setViewå‡½æ•°å‘WMSæœåŠ¡æ·»åŠ ä¸€ä¸ªçª—å£å¯¹è±¡ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">////å°†DecorViewä¿å­˜åˆ°ViewRootImplçš„æˆå‘˜å˜é‡mViewä¸­</span></span><br><span class="line">            mView = view;</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">//1ï¼‰åœ¨æ·»åŠ çª—å£å‰è¿›è¡ŒUIå¸ƒå±€  </span></span><br><span class="line">            requestLayout();</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ......</span><br><span class="line">                 <span class="comment">//2)å°†çª—å£æ·»åŠ åˆ°WMSæœåŠ¡ä¸­ï¼ŒmWindowä¸ºWæœ¬åœ°Binderå¯¹è±¡ï¼Œé€šè¿‡Binderä¼ è¾“åˆ°WMSæœåŠ¡ç«¯åï¼Œå˜ä¸ºIWindowä»£ç†å¯¹è±¡  </span></span><br><span class="line">                res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                        getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                        mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                        mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">            &#125; ......</span><br><span class="line">            <span class="comment">//3)å»ºç«‹çª—å£æ¶ˆæ¯é€šé“  </span></span><br><span class="line">            <span class="keyword">if</span> (mInputChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mInputQueueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mInputQueue = <span class="keyword">new</span> InputQueue();</span><br><span class="line">                    mInputQueueCallback.onInputQueueCreated(mInputQueue);</span><br><span class="line">                &#125;</span><br><span class="line">                mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</span><br><span class="line">                        Looper.myLooper());</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„UIä½œä¸ºä¸€ä¸ªå­Viewè¢«æ·»åŠ åˆ°DecorViewä¸­ï¼Œç„¶åå°†é¡¶çº§è§†å›¾DecorViewæ·»åŠ åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹çš„çª—å£ç®¡ç†å™¨ä¸­ï¼Œçª—å£ç®¡ç†å™¨é¦–å…ˆä¸ºå½“å‰æ·»åŠ çš„Viewåˆ›å»ºä¸€ä¸ªViewRootImplå¯¹è±¡ã€ä¸€ä¸ªå¸ƒå±€å‚æ•°å¯¹è±¡ViewGroup.LayoutParamsï¼Œç„¶åå°†è¿™ä¸‰ä¸ªå¯¹è±¡åˆ†åˆ«ä¿å­˜åˆ°å½“å‰åº”ç”¨ç¨‹åºè¿›ç¨‹çš„çª—å£ç®¡ç†å™¨WindowManagerImplä¸­ï¼Œæœ€åé€šè¿‡ViewRootImplå¯¹è±¡å°†å½“å‰è§†å›¾å¯¹è±¡æ³¨å†Œåˆ°WMSæœåŠ¡ä¸­ã€‚</p><p>ViewRootImplçš„setViewå‡½æ•°å‘WMSæœåŠ¡æ·»åŠ ä¸€ä¸ªçª—å£å¯¹è±¡è¿‡ç¨‹ï¼š (1) requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼› (2) WindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼› (3) æ³¨å†Œåº”ç”¨ç¨‹åºè¿›ç¨‹ç«¯çš„æ¶ˆæ¯æ¥æ”¶é€šé“ï¼›</p><h3 id="4-2-2-6ã€requestLayout-åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›"><a href="#4-2-2-6ã€requestLayout-åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›" class="headerlink" title="4.2.2.6ã€requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›"></a>4.2.2.6ã€requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›</h3><p>2.10ã€çª—å£UIå¸ƒå±€è¿‡ç¨‹ requestLayoutå‡½æ•°è°ƒç”¨é‡Œé¢ä½¿ç”¨äº†Hanlderçš„ä¸€ä¸ªå°æ‰‹æ®µï¼Œé‚£å°±æ˜¯åˆ©ç”¨postSyncBarrieræ·»åŠ äº†ä¸€ä¸ªBarrierï¼ˆæŒ¡æ¿ï¼‰ï¼Œè¿™ä¸ªæŒ¡æ¿çš„ä½œç”¨æ˜¯é˜»å¡æ™®é€šçš„åŒæ­¥æ¶ˆæ¯çš„æ‰§è¡Œï¼Œåœ¨æŒ¡æ¿è¢«æ’¤é”€ä¹‹å‰ï¼Œåªä¼šæ‰§è¡Œå¼‚æ­¥æ¶ˆæ¯ï¼Œè€ŒrequestLayoutå…ˆæ·»åŠ äº†ä¸€ä¸ªæŒ¡æ¿Barrierï¼Œä¹‹åè‡ªå·±æ’å…¥äº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡mTraversalRunnableï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯ä¿è¯mTraversalRunnableåœ¨æ‰€æœ‰åŒæ­¥Messageä¹‹å‰è¢«æ‰§è¡Œï¼Œä¿è¯Viewç»˜åˆ¶çš„æœ€é«˜ä¼˜å…ˆçº§ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæš‚æ—¶ä¸è®¨è®ºChoreographerå’ŒVsyncçŸ¥è¯†ï¼Œç¨åå†è¯¦ç»†åˆ†æã€‚ ç°åœ¨å…ˆè¯´å‡ºç»“è®ºï¼šChoreographeræ„é€ å‡½æ•°ä¸­ï¼Œæ„é€ äº†ä¸€ä¸ªFrameDisplayEventReceiverå¯¹è±¡ï¼Œç”¨äºè¯·æ±‚å¹¶æ¥æ”¶Vsyncä¿¡å·ã€‚ æ­¤æ—¶FrameDisplayEventReceiverä¼šCall requestNextVsync()æ¥å‘Šè¯‰ç³»ç»Ÿæˆ‘è¦åœ¨ä¸‹ä¸€ä¸ªVSYNCéœ€è¦è¢«triggerã€‚Vsyncä¿¡å·æ¯éš”16msä¸€æ¬¡ï¼Œæ­¤æ—¶Vsyncä¿¡å·è¿˜æœªæ¥åˆ°ï¼Œç»§ç»­åˆ†æmWindowSession.addToDisplay()ã€‚</p><h3 id="4-2-2-7ã€mWindowSession-addToDisplay-å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›"><a href="#4-2-2-7ã€mWindowSession-addToDisplay-å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›" class="headerlink" title="4.2.2.7ã€mWindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›"></a>4.2.2.7ã€mWindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›</h3><p>[Session.java]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line">public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs,</span><br><span class="line">        int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets,</span><br><span class="line">        Rect outOutsets, InputChannel outInputChannel) &#123;</span><br><span class="line">    return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId,</span><br><span class="line">            outContentInsets, outStableInsets, outOutsets, outInputChannel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        ......</span><br><span class="line">        WindowState win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,</span><br><span class="line">                attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> WindowManagerGlobal.ADD_APP_EXITING;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (addToken) &#123;</span><br><span class="line">            mTokenMap.put(attrs.token, token);</span><br><span class="line">        &#125;</span><br><span class="line">        win.attach();</span><br><span class="line">        mWindowMap.put(client.asBinder(), win);</span><br><span class="line">        ......</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œå¹¶å°†æ·»åŠ çš„çª—å£ä¿¡æ¯è®°å½•åˆ°mTokenMapå’ŒmWindowMapå“ˆå¸Œè¡¨ä¸­ã€‚ åœ¨WMSæœåŠ¡ç«¯åˆ›å»ºäº†æ‰€éœ€å¯¹è±¡åï¼Œæ¥ç€è°ƒç”¨äº†WindowStateçš„attach()æ¥è¿›ä¸€æ­¥å®Œæˆçª—å£æ·»åŠ ã€‚ [WindowState.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(TAG, <span class="string">"Attaching "</span> + <span class="keyword">this</span> + <span class="string">" token="</span> + mToken</span><br><span class="line">        + <span class="string">", list="</span> + mToken.windows);</span><br><span class="line">    mSession.windowAddedLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Session.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">windowAddedLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mSurfaceSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(</span><br><span class="line">            TAG_WM, <span class="string">"First window added to "</span> + <span class="keyword">this</span> + <span class="string">", creating SurfaceSession"</span>);</span><br><span class="line">        mSurfaceSession = <span class="keyword">new</span> SurfaceSession();</span><br><span class="line">        <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(TAG_WM, <span class="string">"  NEW SURFACE SESSION "</span> + mSurfaceSession);</span><br><span class="line">        mService.mSessions.add(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) &#123;</span><br><span class="line">            mService.dispatchNewAnimatorScaleLocked(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mNumWindow++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-2-8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹"><a href="#4-2-2-8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹" class="headerlink" title="4.2.2.8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹"></a>4.2.2.8ã€SurfaceSessionå»ºç«‹è¿‡ç¨‹</h3><p>SurfaceSessionå¯¹è±¡æ‰¿æ‹…äº†åº”ç”¨ç¨‹åºä¸SurfaceFlingerä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹ï¼Œæ¯ä¸€ä¸ªéœ€è¦ä¸SurfaceFlingerè¿›ç¨‹äº¤äº’çš„åº”ç”¨ç¨‹åºç«¯éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªSurfaceSessionå¯¹è±¡ã€‚</p><p>å®¢æˆ·ç«¯è¯·æ±‚ [SurfaceSession.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SurfaceSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mNativeClient = nativeCreate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaå±‚çš„SurfaceSessionå¯¹è±¡æ„é€ è¿‡ç¨‹ä¼šé€šè¿‡JNIåœ¨nativeå±‚åˆ›å»ºä¸€ä¸ªSurfaceComposerClientå¯¹è±¡ã€‚ [android_view_SurfaceSession.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz)</span> </span>&#123;</span><br><span class="line">SurfaceComposerClient* client = <span class="keyword">new</span> SurfaceComposerClient();</span><br><span class="line">client-&gt;incStrong((<span class="keyword">void</span>*)nativeCreate);</span><br><span class="line"><span class="keyword">return</span> reinterpret_cast&lt;jlong&gt;(client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaå±‚çš„SurfaceSessionå¯¹è±¡ä¸C++å±‚çš„SurfaceComposerClientå¯¹è±¡ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€å…³ç³»ã€‚ æ˜¯å¦ä¼¼æ›¾ç›¸è¯†ï¼Œå°±æ˜¯å‰é¢æœ€å¼€å§‹SurfaceFlinger_Testç¨‹åºç¬¬ä¸€æ­¥ï¼šnew SurfaceComposerClientçš„è¿‡ç¨‹ã€‚ [SurfaceComposerClient.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SurfaceComposerClient::SurfaceComposerClient()</span><br><span class="line">: mStatus(NO_INIT), mComposer(Composer::getInstance())&#123;&#125;</span><br><span class="line"><span class="keyword">void</span> SurfaceComposerClient::onFirstRef() &#123;</span><br><span class="line"><span class="comment">//å¾—åˆ°SurfaceFlingerçš„ä»£ç†å¯¹è±¡BpSurfaceComposer  </span></span><br><span class="line"><span class="function">sp&lt;ISurfaceComposer&gt; <span class="title">sm</span><span class="params">(ComposerService::getComposerService()</span>)</span>;</span><br><span class="line"><span class="keyword">if</span> (sm != <span class="number">0</span>) &#123;</span><br><span class="line">    sp&lt;ISurfaceComposerClient&gt; conn = sm-&gt;createConnection();</span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="number">0</span>) &#123;</span><br><span class="line">        mClient = conn;</span><br><span class="line">        mStatus = NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceComposerClientç»§æ‰¿äºRefBaseç±»ï¼Œå½“ç¬¬ä¸€æ¬¡è¢«å¼ºå¼•ç”¨æ—¶ï¼ŒonFirstRefå‡½æ•°è¢«å›è°ƒï¼Œåœ¨è¯¥å‡½æ•°ä¸­SurfaceComposerClientä¼šè¯·æ±‚SurfaceFlingerä¸ºå½“å‰åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªClientå¯¹è±¡ï¼Œä¸“é—¨æ¥æ”¶è¯¥åº”ç”¨ç¨‹åºçš„è¯·æ±‚ï¼Œåœ¨SurfaceFlingerç«¯åˆ›å»ºå¥½Clientæœ¬åœ°Binderå¯¹è±¡åï¼Œå°†è¯¥Binderä»£ç†å¯¹è±¡è¿”å›ç»™åº”ç”¨ç¨‹åºç«¯ï¼Œå¹¶ä¿å­˜åœ¨SurfaceComposerClientçš„æˆå‘˜å˜é‡mClientä¸­ã€‚</p><p>æœåŠ¡ç«¯å¤„ç† åœ¨SurfaceFlingeræœåŠ¡ç«¯ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºäº¤äº’çš„Clientå¯¹è±¡ [SurfaceFlinger.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ISurfaceComposerClient&gt; SurfaceFlinger::createConnection()</span><br><span class="line">&#123;</span><br><span class="line">sp&lt;ISurfaceComposerClient&gt; bclient;</span><br><span class="line"><span class="function">sp&lt;Client&gt; <span class="title">client</span><span class="params">(new Client(<span class="keyword">this</span>)</span>)</span>;</span><br><span class="line">status_t err = client-&gt;initCheck();</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    bclient = client;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> bclient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-3ã€Appï¼ˆC-å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯-client-çš„è¿‡ç¨‹"><a href="#4-2-3ã€Appï¼ˆC-å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯-client-çš„è¿‡ç¨‹" class="headerlink" title="4.2.3ã€Appï¼ˆC++å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯(client)çš„è¿‡ç¨‹"></a>4.2.3ã€Appï¼ˆC++å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯(client)çš„è¿‡ç¨‹</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/11-Android-Graphics-App-Ask-SurfaceFlinger-Create-Client.png.png" alt="Markdown"></p><p>ç»§ç»­è¯¦ç»†åˆ†æAppAppï¼ˆC++å±‚ï¼‰è¯·æ±‚åˆ›å»ºSurfaceFlingerå®¢æˆ·ç«¯(client)çš„è¿‡ç¨‹</p><p>SurfaceComposerClientç¬¬ä¸€æ¬¡å¼ºå¼•ç”¨æ—¶ï¼Œä¼šæ‰§è¡ŒonFirstRef() [SurfaceComposerClient.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SurfaceComposerClient::SurfaceComposerClient()</span><br><span class="line">: mStatus(NO_INIT), mComposer(Composer::getInstance())&#123;&#125;</span><br><span class="line"><span class="keyword">void</span> SurfaceComposerClient::onFirstRef() &#123;</span><br><span class="line"><span class="comment">//å¾—åˆ°SurfaceFlingerçš„ä»£ç†å¯¹è±¡BpSurfaceComposer  </span></span><br><span class="line">sp&lt;ISurfaceComposer&gt; sm(ComposerService::getComposerService());</span><br><span class="line"><span class="keyword">if</span> (sm != <span class="number">0</span>) &#123;</span><br><span class="line">    sp&lt;ISurfaceComposerClient&gt; conn = sm-&gt;createConnection();</span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="number">0</span>) &#123;</span><br><span class="line">        mClient = conn;</span><br><span class="line">        mStatus = NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ­¥ï¼šè·å–â€SurfaceFlingerâ€æœåŠ¡ ComposerService::getComposerService()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*static*/</span> sp&lt;ISurfaceComposer&gt; ComposerService::getComposerService() &#123;</span><br><span class="line">    ComposerService&amp; instance = ComposerService::getInstance();</span><br><span class="line">    Mutex::Autolock _l(instance.mLock);</span><br><span class="line">    <span class="keyword">if</span> (instance.mComposerService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ComposerService::getInstance().connectLocked();</span><br><span class="line">        assert(instance.mComposerService != <span class="literal">NULL</span>);</span><br><span class="line">        ALOGD(<span class="string">"ComposerService reconnected"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance.mComposerService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ComposerService::getInstance()ä¼šè°ƒç”¨connectLocked()è·å–â€SurfaceFlingerâ€æœåŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ComposerService::ComposerService()</span><br><span class="line">: Singleton&lt;ComposerService&gt;() &#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    connectLocked();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void ComposerService::connectLocked() &#123;</span><br><span class="line">    const String16 name(&quot;SurfaceFlinger&quot;);</span><br><span class="line">    while (getService(name, &amp;mComposerService) != NO_ERROR) &#123;</span><br><span class="line">        usleep(250000);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å‰é¢instance.mComposerServiceå…¶å®è¿”å›çš„æ˜¯â€SurfaceFlingerâ€æœåŠ¡ã€‚ ç¬¬äºŒæ­¥ï¼šcreateConnection() æ¥ä¸‹æ¥å°±ä¼šè°ƒç”¨â€SurfaceFlingerâ€æœåŠ¡çš„createConnection()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ISurfaceComposerClient&gt; SurfaceFlinger::createConnection()</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;ISurfaceComposerClient&gt; bclient;</span><br><span class="line">    sp&lt;Client&gt; client(<span class="keyword">new</span> Client(<span class="keyword">this</span>));</span><br><span class="line">    <span class="keyword">status_t</span> err = client-&gt;initCheck();</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        bclient = client;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bclient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹"><a href="#4-2-4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹" class="headerlink" title="4.2.4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹"></a>4.2.4ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹</h3><p>å‰é¢è®²ViewRootImpl.setViewæ—¶ï¼ŒrequestLayout()éœ€è¦Vsync triggerï¼ŒåŠ å…¥ç°åœ¨Vsyncä¿¡å·æ¥åˆ°ï¼Œäºæ˜¯ä¼šç»§ç»­æ‰§è¡Œã€‚Appç”³è¯·åˆ›å»ºSurfaceçš„è¿‡ç¨‹å°±åœ¨å…¶ä¸­ã€‚</p><p>å½“Vsyncäº‹ä»¶åˆ°æ¥æ—¶ï¼Œå°±ä¼šé€šè¿‡Choreographerçš„postCallback()ï¼Œæ¥ç€æ‰§è¡ŒmTraversalRunnableå¯¹è±¡çš„run()æ–¹æ³•ã€‚ mTraversalRunnableå¯¹è±¡çš„ç±»å‹ä¸ºTraversalRunnableï¼Œè¯¥ç±»å®ç°äº†Runnableæ¥å£ï¼Œåœ¨å…¶run()å‡½æ•°ä¸­è°ƒç”¨äº†doTraversal()å‡½æ•°æ¥å®Œæˆçª—å£å¸ƒå±€ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> TraversalRunnable mTraversalRunnable = <span class="keyword">new</span> TraversalRunnable();</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line">        ......</span><br><span class="line">        performTraversals();</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>performTraversalså‡½æ•°ç›¸å½“å¤æ‚ï¼Œå…¶ä¸»è¦å®ç°ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š</p><p>1.æ‰§è¡Œçª—å£æµ‹é‡ï¼›</p><p>2.æ‰§è¡Œçª—å£æ³¨å†Œï¼›</p><p>3.æ‰§è¡Œçª—å£å¸ƒå±€ï¼›</p><p>4.æ‰§è¡Œçª—å£ç»˜å›¾ï¼›</p><p>[-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£æµ‹é‡******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">        windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************å‘WMSæœåŠ¡æ·»åŠ çª—å£******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">            viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£å¸ƒå±€******************/</span></span><br><span class="line">    <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">        performLayout(lp, mWidth, mHeight);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£ç»˜åˆ¶******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">        ......</span><br><span class="line">        performDraw();</span><br><span class="line">    &#125; ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ã€æ‰§è¡Œçª—å£æµ‹é‡performMeasure() [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    &#125; ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-Javaå±‚"><a href="#4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-Javaå±‚" class="headerlink" title="4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(Javaå±‚)"></a>4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(Javaå±‚)</h4><p>2ã€æ‰§è¡Œçª—å£æ³¨å†ŒrelayoutWindowï¼› [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(WindowManager.LayoutParams params, <span class="keyword">int</span> viewVisibility,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> insetsPending)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">int</span> relayoutResult = mWindowSession.relayout(</span><br><span class="line">            mWindow, mSeq, params,</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredWidth() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredHeight() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            viewVisibility, insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="number">0</span>,</span><br><span class="line">            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</span><br><span class="line">            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingConfiguration,</span><br><span class="line">            mSurface);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> relayoutResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡å‰é¢è·å–çš„IWindowSessionä»£ç†å¯¹è±¡è¯·æ±‚WMSæœåŠ¡æ‰§è¡Œçª—å£å¸ƒå±€ï¼ŒmSurfaceæ˜¯ViewRootImplçš„æˆå‘˜å˜é‡ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Surface mSurface = <span class="keyword">new</span> Surface();</span><br></pre></td></tr></table></figure><p>[-&gt;Surface.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create an empty surface, which will later be filled in by readFromParcel().</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Surface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥Surfaceæ„é€ å‡½æ•°ä»…ä»…åˆ›å»ºäº†ä¸€ä¸ªç©ºSurfaceå¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å¯¹è¯¥Surfaceè¿›ç¨‹nativeå±‚çš„åˆå§‹åŒ–ï¼Œåˆ°æ­¤æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸ºæ¯ä¸ªçª—å£å¯¹è±¡éƒ½åˆ›å»ºäº†ä¸€ä¸ªSurfaceå¯¹è±¡ã€‚å¹¶ä¸”å°†è¯¥Surfaceé€šè¿‡è·¨è¿›ç¨‹æ–¹å¼ä¼ è¾“ç»™WMSæœåŠ¡è¿›ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Androidç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡éœ€è¦åœ¨ä¸åŒè¿›ç¨‹é—´ä¼ è¾“ï¼Œå¿…é¡»å®ç°Parcelableæ¥å£ï¼ŒSurfaceç±»æ­£å¥½å®ç°äº†Parcelableæ¥å£ã€‚ViewRootImplé€šè¿‡IWindowSessionæ¥å£è¯·æ±‚WMSçš„å®Œæ•´è¿‡ç¨‹å¦‚ä¸‹ï¼š [-&gt;IWindowSession.java$ Proxy]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* This file is auto-generated.  DO NOT MODIFY</span></span><br><span class="line"><span class="comment">*  * Original file: frameworks/base/core/java/android/view/IWindowSession.aidl</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(android.view.IWindow window, <span class="keyword">int</span> seq, android.view.WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags, android.graphics.Rect outFrame, android.graphics.Rect outOverscanInsets, android.graphics.Rect outContentInsets, android.graphics.Rect outVisibleInsets, android.graphics.Rect outStableInsets, android.graphics.Rect outOutsets, android.graphics.Rect outBackdropFrame, android.content.res.Configuration outConfig, android.view.Surface outSurface)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line"><span class="keyword">int</span> _result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    mRemote.transact(Stub.TRANSACTION_relayout, _data, _reply, <span class="number">0</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ((<span class="number">0</span> != _reply.readInt())) &#123;</span><br><span class="line">        outSurface.readFromParcel(_reply);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¯¥å‡½æ•°çš„å®ç°å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­åˆ›å»ºçš„Surfaceå¯¹è±¡å¹¶æ²¡æœ‰ä¼ é€’åˆ°WMSæœåŠ¡è¿›ç¨‹ï¼Œåªæ˜¯è¯»å–WMSæœåŠ¡è¿›ç¨‹è¿”å›æ¥çš„Surfaceã€‚é‚£ä¹ˆWMSæœåŠ¡è¿›ç¨‹æ˜¯å¦‚ä½•å“åº”åº”ç”¨ç¨‹åºè¿›ç¨‹å¸ƒå±€è¯·æ±‚çš„å‘¢ï¼Ÿ</p><p>[-&gt;IWindowSession.java$ Stub]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">switch</span> (code)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> TRANSACTION_relayout:</span><br><span class="line">  &#123;</span><br><span class="line">    ......</span><br><span class="line">    android.view.Surface _arg15;</span><br><span class="line">    _arg15 = <span class="keyword">new</span> android.view.Surface();</span><br><span class="line">    <span class="keyword">int</span> _result = <span class="keyword">this</span>.relayout(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7, _arg8, _arg9, _arg10, _arg11, _arg12, _arg13, _arg14, _arg15);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(_result);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ((_arg15!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">    reply.writeInt(<span class="number">1</span>);</span><br><span class="line">    _arg15.writeToParcel(reply, android.os.Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å¯ä»¥çœ‹å‡ºï¼ŒWMSæœåŠ¡åœ¨å“åº”åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚æ·»åŠ çª—å£æ—¶ï¼Œé¦–å…ˆåœ¨å½“å‰è¿›ç¨‹ç©ºé—´åˆ›å»ºä¸€ä¸ªSurfaceå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android.view.Surface _arg15;</span><br><span class="line">_arg15 = <span class="keyword">new</span> android.view.Surface();</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨Sessionçš„relayout()å‡½æ•°è¿›ä¸€æ­¥å®Œæˆçª—å£æ·»åŠ è¿‡ç¨‹ï¼Œæœ€åå°†WMSæœåŠ¡ä¸­åˆ›å»ºçš„Surfaceè¿”å›ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹å’ŒWMSæœåŠ¡è¿›ç¨‹åˆ†åˆ«åˆ›å»ºäº†ä¸€ä¸ªSurfaceå¯¹è±¡ï¼Œä½†æ˜¯ä»–ä»¬è°ƒç”¨çš„éƒ½æ˜¯Surfaceçš„æ— å‚æ„é€ å‡½æ•°ï¼Œåœ¨è¯¥æ„é€ å‡½æ•°ä¸­å¹¶æœªçœŸæ­£åˆå§‹åŒ–nativeå±‚çš„Surfaceï¼Œé‚£nativeå±‚çš„Surfaceæ˜¯åœ¨é‚£é‡Œåˆ›å»ºçš„å‘¢ï¼Ÿ [-&gt;Session.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = mService.relayoutWindow(<span class="keyword">this</span>, window, seq, attrs,</span><br><span class="line">            requestedWidth, requestedHeight, viewFlags, flags,</span><br><span class="line">            outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</span><br><span class="line">            outStableInsets, outsets, outBackdropFrame, outConfig, outSurface);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (viewVisibility == View.VISIBLE &amp;&amp;</span><br><span class="line">                (win.mAppToken == <span class="keyword">null</span> || !win.mAppToken.clientHidden)) &#123;</span><br><span class="line">            result = relayoutVisibleWindow(outConfig, result, win, winAnimator, attrChanges,</span><br><span class="line">                    oldVisibility);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = createSurfaceControl(outSurface, result, win, winAnimator);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               ......</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createSurfaceControl</span><span class="params">(Surface outSurface, <span class="keyword">int</span> result, WindowState win,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowStateAnimator winAnimator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!win.mHasSurface) &#123;</span><br><span class="line">        result |= RELAYOUT_RES_SURFACE_CHANGED;</span><br><span class="line">    &#125;</span><br><span class="line">    WindowSurfaceController surfaceController = winAnimator.createSurfaceLocked();</span><br><span class="line">    <span class="keyword">if</span> (surfaceController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        surfaceController.getSurface(outSurface);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        outSurface.release();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowSurfaceController.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getSurface</span><span class="params">(Surface outSurface)</span> </span>&#123;</span><br><span class="line">    outSurface.copyFrom(mSurfaceControl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowStateAnimator.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function">WindowSurfaceController <span class="title">createSurfaceLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        mSurfaceController = <span class="keyword">new</span> WindowSurfaceController(mSession.mSurfaceSession,</span><br><span class="line">                attrs.getTitle().toString(),</span><br><span class="line">                width, height, format, flags, <span class="keyword">this</span>);</span><br><span class="line">        w.setHasSurface(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> mSurfaceController;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowSurfaceController.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WindowSurfaceController</span><span class="params">(SurfaceSession s,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> flags, WindowStateAnimator animator)</span> </span>&#123;</span><br><span class="line">    mAnimator = animator;</span><br><span class="line">    mSurfaceW = w;</span><br><span class="line">    mSurfaceH = h;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (animator.mWin.isChildWindow() &amp;&amp;</span><br><span class="line">            animator.mWin.mSubLayer &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            animator.mWin.mAppToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mSurfaceControl = <span class="keyword">new</span> SurfaceControl(</span><br><span class="line">                s, name, w, h, format, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-C-å±‚"><a href="#4-2-4-1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹-C-å±‚" class="headerlink" title="4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(C++å±‚)"></a>4.2.4.1ã€APPç”³è¯·åˆ›å»ºSurfaceè¿‡ç¨‹(C++å±‚)</h4><p>SurfaceControlåˆ›å»ºè¿‡ç¨‹ [-&gt;SurfaceControl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SurfaceControl</span><span class="params">(SurfaceSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> OutOfResourcesException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mNativeObject = nativeCreate(session, name, w, h, format, flags);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_SurfaceControl.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz, jobject sessionObj,</span></span></span><br><span class="line"><span class="function"><span class="params">    jstring nameStr, jint w, jint h, jint format, jint flags)</span> </span>&#123;</span><br><span class="line"><span class="function">ScopedUtfChars <span class="title">name</span><span class="params">(env, nameStr)</span></span>;</span><br><span class="line">sp&lt;SurfaceComposerClient&gt; client(android_view_SurfaceSession_getClient(env, sessionObj));</span><br><span class="line">sp&lt;SurfaceControl&gt; surface = client-&gt;createSurface(</span><br><span class="line">        String8(name.c_str()), w, h, format, flags);</span><br><span class="line"><span class="keyword">if</span> (surface == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    jniThrowException(env, OutOfResourcesException, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">surface-&gt;incStrong((<span class="keyword">void</span> *)nativeCreate);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°é¦–å…ˆå¾—åˆ°å‰é¢åˆ›å»ºå¥½çš„SurfaceComposerClientå¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡å‘SurfaceFlingerç«¯çš„Clientå¯¹è±¡å‘é€åˆ›å»ºSurfaceçš„è¯·æ±‚ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ªSurfaceControlå¯¹è±¡ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/12-Android-Graphics-App-Ask-SurfaceFlinger-CreateSurface.png" alt="Markdown"></p><p>[-&gt;SurfaceComposerClient.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceControl&gt; SurfaceComposerClient::createSurface(</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">    <span class="keyword">uint32_t</span> w,</span><br><span class="line">    <span class="keyword">uint32_t</span> h,</span><br><span class="line">    PixelFormat format,</span><br><span class="line">    <span class="keyword">uint32_t</span> flags)</span><br><span class="line">    &#123;</span><br><span class="line">sp&lt;SurfaceControl&gt; sur;</span><br><span class="line"><span class="keyword">if</span> (mStatus == NO_ERROR) &#123;</span><br><span class="line">    sp&lt;IBinder&gt; handle;</span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; gbp;</span><br><span class="line">    <span class="keyword">status_t</span> err = mClient-&gt;createSurface(name, w, h, format, flags,</span><br><span class="line">            &amp;handle, &amp;gbp);</span><br><span class="line">    ALOGE_IF(err, <span class="string">"SurfaceComposerClient::createSurface error %s"</span>, strerror(-err));</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        sur = <span class="keyword">new</span> SurfaceControl(<span class="keyword">this</span>, handle, gbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceComposerClientå°†Surfaceåˆ›å»ºè¯·æ±‚è½¬äº¤ç»™ä¿å­˜åœ¨å…¶æˆå‘˜å˜é‡ä¸­çš„Bp SurfaceComposerClientå¯¹è±¡æ¥å®Œæˆï¼Œåœ¨SurfaceFlingerç«¯çš„Clientæœ¬åœ°å¯¹è±¡ä¼šè¿”å›ä¸€ä¸ªISurfaceä»£ç†å¯¹è±¡ç»™åº”ç”¨ç¨‹åºï¼Œé€šè¿‡è¯¥ä»£ç†å¯¹è±¡ä¸ºåº”ç”¨ç¨‹åºå½“å‰åˆ›å»ºçš„Surfaceåˆ›å»ºä¸€ä¸ªSurfaceControlå¯¹è±¡ã€‚ [ISurfaceComposerClient.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">createSurface</span><span class="params">(<span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> height, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IBinder&gt;* handle,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IGraphicBufferProducer&gt;* gbp)</span> </span>&#123;</span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    ......</span><br><span class="line">    remote()-&gt;transact(CREATE_SURFACE, data, &amp;reply);</span><br><span class="line">    *handle = reply.readStrongBinder();</span><br><span class="line">    *gbp = interface_cast&lt;IGraphicBufferProducer&gt;(reply.readStrongBinder());</span><br><span class="line">    <span class="keyword">return</span> reply.readInt32();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Client.cpp] MessageCreateSurfaceæ¶ˆæ¯æ˜¯ä¸“é—¨ä¸ºåº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceè€Œå®šä¹‰çš„ä¸€ç§æ¶ˆæ¯ç±»å‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">status_t</span> Client::createSurface(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">        sp&lt;IBinder&gt;* handle,</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp)&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * createSurface must be called from the GL thread so that it can</span></span><br><span class="line"><span class="comment">     * have access to the GL context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MessageCreateLayer</span> :</span> <span class="keyword">public</span> MessageBase &#123;</span><br><span class="line">        SurfaceFlinger* flinger;</span><br><span class="line">        Client* client;</span><br><span class="line">        sp&lt;IBinder&gt;* handle;</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp;</span><br><span class="line">        <span class="keyword">status_t</span> result;</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name;</span><br><span class="line">        <span class="keyword">uint32_t</span> w, h;</span><br><span class="line">        PixelFormat format;</span><br><span class="line">        <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        MessageCreateLayer(SurfaceFlinger* flinger,</span><br><span class="line">                <span class="keyword">const</span> String8&amp; name, Client* client,</span><br><span class="line">                <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">                sp&lt;IBinder&gt;* handle,</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt;* gbp)</span><br><span class="line">            : flinger(flinger), client(client),</span><br><span class="line">              handle(handle), gbp(gbp), result(NO_ERROR),</span><br><span class="line">              name(name), w(w), h(h), format(format), flags(flags) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">status_t</span> getResult() <span class="keyword">const</span> &#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">handler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            result = flinger-&gt;createLayer(name, client, w, h, format, flags,</span><br><span class="line">                    handle, gbp);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sp&lt;MessageBase&gt; msg = <span class="keyword">new</span> MessageCreateLayer(mFlinger.get(),</span><br><span class="line">            name, <span class="keyword">this</span>, w, h, format, flags, handle, gbp);</span><br><span class="line">    mFlinger-&gt;postMessageSync(msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;MessageCreateLayer*&gt;( msg.get() )-&gt;getResult();</span><br><span class="line">    &#125;</span><br><span class="line">Clientå°†åº”ç”¨ç¨‹åºåˆ›å»ºSurfaceçš„è¯·æ±‚è½¬æ¢ä¸ºå¼‚æ­¥æ¶ˆæ¯æŠ•é€’åˆ°SurfaceFlingerçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå°†åˆ›å»ºSurfaceçš„ä»»åŠ¡è½¬äº¤ç»™SurfaceFlingerã€‚</span><br><span class="line">[-&gt;SurfaceFlinger.cpp]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> SurfaceFlinger::createLayer(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">        <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">        sp&lt;IBinder&gt;* handle, sp&lt;IGraphicBufferProducer&gt;* gbp)&#123;</span><br><span class="line">    <span class="comment">//ALOGD("createLayer for (%d x %d), name=%s", w, h, name.string());</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    sp&lt;Layer&gt; layer;</span><br><span class="line">    <span class="comment">////æ ¹æ®flagsåˆ›å»ºä¸åŒç±»å‹çš„layer</span></span><br><span class="line">    <span class="keyword">switch</span> (flags &amp; ISurfaceComposerClient::eFXSurfaceMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceNormal:</span><br><span class="line">            result = createNormalLayer(client,</span><br><span class="line">                    name, w, h, flags, format,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceDim:</span><br><span class="line">            result = createDimLayer(client,</span><br><span class="line">                    name, w, h, flags,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            result = BAD_VALUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†åˆ›å»ºå¥½çš„Layerå¯¹è±¡ä¿å­˜åœ¨Clientä¸­  </span></span><br><span class="line">    result = addClientLayer(client, *handle, *gbp, layer);</span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setTransactionFlags(eTransactionNeeded);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>SurfaceFlingeræ ¹æ®æ ‡å¿—ä½åˆ›å»ºå¯¹åº”ç±»å‹çš„Surfaceï¼Œå½“å‰ç³»ç»Ÿå®šä¹‰äº†3ç§ç±»å‹çš„Layer: [-&gt;ISurfaceComposerClient.h]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eFXSurfaceNormal    = <span class="number">0x00000000</span>,</span><br><span class="line">eFXSurfaceDim       = <span class="number">0x00020000</span>,</span><br><span class="line">eFXSurfaceMask      = <span class="number">0x000F0000</span></span><br></pre></td></tr></table></figure><p>[-&gt;SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> SurfaceFlinger::createNormalLayer(<span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, <span class="keyword">uint32_t</span> flags, PixelFormat&amp; format,</span><br><span class="line">    sp&lt;IBinder&gt;* handle, sp&lt;IGraphicBufferProducer&gt;* gbp, sp&lt;Layer&gt;* outLayer)&#123;</span><br><span class="line"><span class="comment">// initialize the surfaces</span></span><br><span class="line"><span class="keyword">switch</span> (format) &#123;</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_TRANSPARENT:</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_TRANSLUCENT:</span><br><span class="line">    format = PIXEL_FORMAT_RGBA_8888;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_OPAQUE:</span><br><span class="line">    format = PIXEL_FORMAT_RGBX_8888;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åœ¨SurfaceFlingerç«¯ä¸ºåº”ç”¨ç¨‹åºçš„Surfaceåˆ›å»ºå¯¹åº”çš„Layerå¯¹è±¡  </span></span><br><span class="line">*outLayer = <span class="keyword">new</span> Layer(<span class="keyword">this</span>, client, name, w, h, flags);</span><br><span class="line"><span class="keyword">status_t</span> err = (*outLayer)-&gt;setBuffers(w, h, format, flags);</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    *handle = (*outLayer)-&gt;getHandle();</span><br><span class="line">    *gbp = (*outLayer)-&gt;getProducer();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALOGE_IF(err, <span class="string">"createNormalLayer() failed (%s)"</span>, strerror(-err));</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨SurfaceFlingeræœåŠ¡ç«¯ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºçš„Surfaceåˆ›å»ºå¯¹åº”çš„Layerå¯¹è±¡ã€‚åº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/13-Android-Graphics-App-Ask-SurfaceFlinger-Create-Layer.png.png.png" alt="Markdown"><br>ç¬¬ä¸€æ¬¡å¼ºå¼•ç”¨Layerå¯¹è±¡æ—¶ï¼ŒonFirstRef()å‡½æ•°è¢«å›è°ƒ [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::onFirstRef() &#123;</span><br><span class="line"><span class="comment">// Creates a custom BufferQueue for SurfaceFlingerConsumer to use</span></span><br><span class="line">sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer;</span><br><span class="line"><span class="comment">//åˆ›å»ºBufferQueueå¯¹è±¡</span></span><br><span class="line">BufferQueue::createBufferQueue(&amp;producer, &amp;consumer);</span><br><span class="line">mProducer = <span class="keyword">new</span> MonitoredProducer(producer, mFlinger);</span><br><span class="line">mSurfaceFlingerConsumer = <span class="keyword">new</span> SurfaceFlingerConsumer(consumer, mTextureName,</span><br><span class="line">        <span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(<span class="number">0</span>));</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setContentsChangedListener(<span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setName(mName);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TARGET_DISABLE_TRIPLE_BUFFERING</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">warning</span> <span class="meta-string">"disabling triple buffering"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">mProducer-&gt;setMaxDequeuedBufferCount(<span class="number">2</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mFlinger-&gt;getDefaultDisplayDevice());</span><br><span class="line">updateTransformHint(hw);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®bufferå¯ç”¨ç›‘å¬å™¨çš„æ³¨å†Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå½“ç”Ÿäº§è€…ä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºå¡«å……å¥½å›¾å½¢bufferæ•°æ®åï¼Œé€šè¿‡å›è°ƒæ–¹å¼é€šçŸ¥æ¶ˆè´¹è€…çš„</p><h4 id="4-2-4-2ã€BufferQueueæ„é€ è¿‡ç¨‹"><a href="#4-2-4-2ã€BufferQueueæ„é€ è¿‡ç¨‹" class="headerlink" title="4.2.4.2ã€BufferQueueæ„é€ è¿‡ç¨‹"></a>4.2.4.2ã€BufferQueueæ„é€ è¿‡ç¨‹</h4><p>[-&gt;BufferQueue.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> BufferQueue::createBufferQueue(sp&lt;IGraphicBufferProducer&gt;* outProducer,</span><br><span class="line">    sp&lt;IGraphicBufferConsumer&gt;* outConsumer,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferAlloc&gt;&amp; allocator) &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">sp&lt;BufferQueueCore&gt; core(<span class="keyword">new</span> BufferQueueCore(allocator));</span><br><span class="line">sp&lt;IGraphicBufferProducer&gt; producer(<span class="keyword">new</span> BufferQueueProducer(core));</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer(<span class="keyword">new</span> BufferQueueConsumer(core));</span><br><span class="line">*outProducer = producer;</span><br><span class="line">*outConsumer = consumer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;BufferQueueCore.cpp] æ‰€ä»¥æ ¸å¿ƒéƒ½æ˜¯è¿™ä¸ªBufferQueueCoreï¼Œä»–æ˜¯ç®¡ç†å›¾å½¢ç¼“å†²åŒºçš„ä¸­æ¢ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BufferQueueCore::BufferQueueCore(<span class="keyword">const</span> sp&lt;IGraphicBufferAlloc&gt;&amp; allocator) :</span><br><span class="line">mAllocator(allocator),</span><br><span class="line">......</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (allocator == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    sp&lt;ISurfaceComposer&gt; composer(ComposerService::getComposerService());</span><br><span class="line">    mAllocator = composer-&gt;createGraphicBufferAlloc();</span><br><span class="line">    <span class="keyword">if</span> (mAllocator == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        BQ_LOGE(<span class="string">"createGraphicBufferAlloc failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> numStartingBuffers = getMaxBufferCountLocked();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> s = <span class="number">0</span>; s &lt; numStartingBuffers; s++) &#123;</span><br><span class="line">    mFreeSlots.insert(s);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> s = numStartingBuffers; s &lt; BufferQueueDefs::NUM_BUFFER_SLOTS;</span><br><span class="line">        s++) &#123;</span><br><span class="line">    mUnusedSlots.push_front(s);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BufferQueueCoreç±»ä¸­å®šä¹‰äº†ä¸€ä¸ª64é¡¹çš„æ•°æ®mSlotsï¼Œæ˜¯ä¸€ä¸ªå®¹é‡å¤§å°ä¸º64çš„æ•°ç»„ï¼Œå› æ­¤BufferQueueCoreå¯ä»¥ç®¡ç†æœ€å¤š64å—çš„GraphicBufferã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/14-Android-Graphics-App-SurfaceFlinger-BufferSlot.png.png" alt="Markdown"></p><p>[-&gt;ISurfaceComposer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">virtual</span> sp&lt;IGraphicBufferAlloc&gt; createGraphicBufferAlloc()</span><br><span class="line">&#123;</span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    data.writeInterfaceToken(ISurfaceComposer::getInterfaceDescriptor());</span><br><span class="line">    remote()-&gt;transact(BnSurfaceComposer::CREATE_GRAPHIC_BUFFER_ALLOC, data, &amp;reply);</span><br><span class="line">    <span class="keyword">return</span> interface_cast&lt;IGraphicBufferAlloc&gt;(reply.readStrongBinder());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IGraphicBufferAlloc&gt; SurfaceFlinger::createGraphicBufferAlloc()</span><br><span class="line">&#123;</span><br><span class="line">sp&lt;GraphicBufferAlloc&gt; gba(<span class="keyword">new</span> GraphicBufferAlloc());</span><br><span class="line"><span class="keyword">return</span> gba;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>GraphicBufferAllocæ„é€ è¿‡ç¨‹</strong></p><p>[-&gt;GraphicBufferAlloc.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;GraphicBuffer&gt; GraphicBufferAlloc::createGraphicBuffer(<span class="keyword">uint32_t</span> width,</span><br><span class="line">    <span class="keyword">uint32_t</span> height, PixelFormat format, <span class="keyword">uint32_t</span> usage,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> requestorName, <span class="keyword">status_t</span>* error) &#123;</span><br><span class="line">sp&lt;GraphicBuffer&gt; graphicBuffer(<span class="keyword">new</span> GraphicBuffer(</span><br><span class="line">        width, height, format, usage, <span class="built_in">std</span>::move(requestorName)));</span><br><span class="line"><span class="keyword">status_t</span> err = graphicBuffer-&gt;initCheck();</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> graphicBuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹</strong> [-&gt;GraphicBuffer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GraphicBuffer::GraphicBuffer(<span class="keyword">uint32_t</span> inWidth, <span class="keyword">uint32_t</span> inHeight,</span><br><span class="line">    PixelFormat inFormat, <span class="keyword">uint32_t</span> inUsage, <span class="built_in">std</span>::<span class="built_in">string</span> requestorName)</span><br><span class="line">: BASE(), mOwner(ownData), mBufferMapper(GraphicBufferMapper::get()),</span><br><span class="line">  mInitCheck(NO_ERROR), mId(getUniqueId()), mGenerationNumber(<span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">width  =</span><br><span class="line">height =</span><br><span class="line">stride =</span><br><span class="line">format =</span><br><span class="line">usage  = <span class="number">0</span>;</span><br><span class="line">handle = <span class="literal">NULL</span>;</span><br><span class="line">mInitCheck = initSize(inWidth, inHeight, inFormat, inUsage,</span><br><span class="line">        <span class="built_in">std</span>::move(requestorName));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å›¾å½¢bufferçš„å®½é«˜ã€æ ¼å¼ç­‰ä¿¡æ¯ä¸ºå›¾å½¢ç¼“å†²åŒºåˆ†é…å­˜å‚¨ç©ºé—´ã€‚</p><p>ä½¿ç”¨GraphicBufferAllocatorå¯¹è±¡æ¥ä¸ºå›¾å½¢ç¼“å†²åŒºåˆ†é…å†…å­˜ç©ºé—´ï¼ŒGraphicBufferAllocatoræ˜¯å¯¹Grallocæ¨¡å—ä¸­çš„gpuè®¾å¤‡çš„å°è£…ç±»ã€‚å…³äºGraphicBufferAllocatorå†…å­˜åˆ†é…è¿‡ç¨‹è¯·ä»¥åä½œåˆ†æï¼Œå›¾å½¢ç¼“å†²åŒºåˆ†é…å®Œæˆåï¼Œè¿˜ä¼šæ˜ å°„åˆ°SurfaceFlingeræœåŠ¡è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p><p><strong>Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ</strong></p><p>[-&gt;Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Layer::Layer(SurfaceFlinger* flinger, <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">:   contentDirty(<span class="literal">false</span>),</span><br><span class="line">    sequence(<span class="keyword">uint32_t</span>(android_atomic_inc(&amp;sSequence))),</span><br><span class="line">    mFlinger(flinger),</span><br><span class="line">    mTextureName(<span class="number">-1U</span>),</span><br><span class="line">    mPremultipliedAlpha(<span class="literal">true</span>),</span><br><span class="line">    mName(<span class="string">"unnamed"</span>),</span><br><span class="line">    mFormat(PIXEL_FORMAT_NONE),</span><br><span class="line">    ......&#123;</span><br><span class="line">mCurrentCrop.makeInvalid();</span><br><span class="line">mFlinger-&gt;getRenderEngine().genTextures(<span class="number">1</span>, &amp;mTextureName);</span><br><span class="line">mTexture.init(Texture::TEXTURE_EXTERNAL, mTextureName);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤æ‰ç®—çœŸæ­£åˆ›å»ºäº†ä¸€ä¸ªå¯ç”¨äºç»˜å›¾çš„Surface (Layer)ï¼Œä»ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨WMSæœåŠ¡è¿›ç¨‹ç«¯ï¼Œå…¶å®åˆ›å»ºäº†ä¸¤ä¸ªJavaå±‚çš„Surfaceå¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªSurfaceä½¿ç”¨äº†æ— å‚æ„é€ å‡½æ•°ï¼Œä»…ä»…æ„é€ ä¸€ä¸ªSurfaceå¯¹è±¡è€Œå·²ï¼Œè€Œç¬¬äºŒä¸ªSurfaceå´ä½¿ç”¨äº†æœ‰å‚æ„é€ å‡½æ•°ï¼Œå‚æ•°æŒ‡å®šäº†å›¾è±¡å®½é«˜ç­‰ä¿¡æ¯ï¼Œè¿™ä¸ªJavaå±‚Surfaceå¯¹è±¡è¿˜ä¼šåœ¨nativeå±‚è¯·æ±‚SurfaceFlingeråˆ›å»ºä¸€ä¸ªçœŸæ­£èƒ½ç”¨äºç»˜åˆ¶å›¾è±¡çš„nativeå±‚Surfaceã€‚æœ€åé€šè¿‡æµ…æ‹·è´çš„æ–¹å¼å°†ç¬¬äºŒä¸ªSurfaceå¤åˆ¶åˆ°ç¬¬ä¸€ä¸ªSurfaceä¸­ï¼Œæœ€åé€šè¿‡writeToParcelæ–¹å¼å†™å›åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/15-Android-Graphics-App-WMS-SurfaceFlinger-Surface-SurfaceControl.png" alt="Markdown"></p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåº”ç”¨ç¨‹åºå’ŒWMSä¸€å…±åˆ›å»ºäº†3ä¸ªJavaå±‚Surfaceï¼ˆSurfaceControlï¼‰å¯¹è±¡ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè€ŒçœŸæ­£èƒ½ç”¨äºç»˜å›¾çš„Surfaceåªæœ‰3å·ï¼Œé‚£ä¹ˆ3å·Surfaceä¸2å·Surfaceä¹‹é—´æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼ŸoutSurface.copyFrom(surface)</p><p>[Surface.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyFrom</span><span class="params">(SurfaceControl other)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">long</span> surfaceControlPtr = other.mNativeObject;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">long</span> newNativeObject = nativeCreateFromSurfaceControl(surfaceControlPtr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNativeObject != <span class="number">0</span>) &#123;</span><br><span class="line">            nativeRelease(mNativeObject);</span><br><span class="line">        &#125;</span><br><span class="line">        setNativeObjectLocked(newNativeObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreateFromSurfaceControl</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong surfaceControlNativeObj)</span> </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is used by the WindowManagerService just after constructing</span></span><br><span class="line"><span class="comment"> * a Surface and is necessary for returning the Surface reference to</span></span><br><span class="line"><span class="comment"> * the caller. At this point, we should only have a SurfaceControl.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">sp&lt;SurfaceControl&gt; ctrl(<span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(surfaceControlNativeObj));</span><br><span class="line">sp&lt;Surface&gt; surface(ctrl-&gt;getSurface());</span><br><span class="line"><span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    surface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2å·Surfaceå¼•ç”¨åˆ°äº†3å·Surfaceçš„SurfaceControlå¯¹è±¡åï¼Œé€šè¿‡writeToParcel()å‡½æ•°å†™ä¼šåˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚ [Surface.java]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">        @Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dest == null) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"dest must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This must be kept synchronized with the native parceling code</span></span><br><span class="line">        <span class="comment">// in frameworks/native/libs/Surface.cpp</span></span><br><span class="line">        dest.writeString(mName);</span><br><span class="line">        dest.writeInt(mIsSingleBuffered ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        nativeWriteToParcel(mNativeObject, dest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; Parcelable.PARCELABLE_WRITE_RETURN_VALUE) != <span class="number">0</span>) &#123;</span><br><span class="line">        release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeWriteToParcel</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject parcelObj)</span> </span>&#123;</span><br><span class="line">Parcel* parcel = parcelForJavaObject(env, parcelObj);</span><br><span class="line"><span class="keyword">if</span> (parcel == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    doThrowNPE(env);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">sp&lt;Surface&gt; self(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line">android::view::Surface surfaceShim;</span><br><span class="line"><span class="keyword">if</span> (self != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    surfaceShim.graphicBufferProducer = self-&gt;getIGraphicBufferProducer();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Calling code in Surface.java has already written the name of the Surface</span></span><br><span class="line"><span class="comment">// to the Parcel</span></span><br><span class="line">surfaceShim.writeToParcel(parcel, <span class="comment">/*nameAlreadyWritten*/</span><span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„1å·SurfaceæŒ‰ç›¸åé¡ºåºè¯»å–WMSæœåŠ¡ç«¯è¿”å›è¿‡æ¥çš„Binderå¯¹è±¡ç­‰æ•°æ®ï¼Œå¹¶æ„é€ ä¸€ä¸ªnativeå±‚çš„Surfaceå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span><span class="params">(Parcel source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (source == null) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"source must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        <span class="comment">// nativeReadFromParcel() will either return mNativeObject, or</span></span><br><span class="line">        <span class="comment">// create a new native Surface and return it after reducing</span></span><br><span class="line">        <span class="comment">// the reference count on mNativeObject.  Either way, it is</span></span><br><span class="line">        <span class="comment">// not necessary to call nativeRelease() here.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This must be kept synchronized with the native parceling code</span></span><br><span class="line">        <span class="comment">// in frameworks/native/libs/Surface.cpp</span></span><br><span class="line">        mName = source.readString();</span><br><span class="line">        mIsSingleBuffered = source.readInt() != <span class="number">0</span>;</span><br><span class="line">        setNativeObjectLocked(nativeReadFromParcel(mNativeObject, source));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„1å·SurfaceæŒ‰ç›¸åé¡ºåºè¯»å–WMSæœåŠ¡ç«¯è¿”å›è¿‡æ¥çš„Binderå¯¹è±¡ç­‰æ•°æ®ï¼Œå¹¶æ„é€ ä¸€ä¸ªnativeå±‚çš„Surfaceå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreateFromSurfaceControl</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong surfaceControlNativeObj)</span> </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is used by the WindowManagerService just after constructing</span></span><br><span class="line"><span class="comment"> * a Surface and is necessary for returning the Surface reference to</span></span><br><span class="line"><span class="comment"> * the caller. At this point, we should only have a SurfaceControl.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">sp&lt;SurfaceControl&gt; ctrl(<span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(surfaceControlNativeObj));</span><br><span class="line">sp&lt;Surface&gt; surface(ctrl-&gt;getSurface());</span><br><span class="line"><span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    surface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªActivityå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªSurfaceï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªActivityåªæœ‰ä¸€ä¸ªSurfaceï¼Œå½“Activityä¸­ä½¿ç”¨SurfaceViewæ—¶ï¼Œå°±å­˜åœ¨å¤šä¸ªSurfaceã€‚Activityé»˜è®¤surfaceæ˜¯åœ¨relayoutWindowè¿‡ç¨‹ä¸­ç”±WMSæœåŠ¡åˆ›å»ºçš„ï¼Œç„¶åå›ä¼ ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªSurfaceå…¶å®å°±æ˜¯åº”ç”¨ç¨‹åºç«¯çš„æœ¬åœ°çª—å£ï¼Œå…³äºSurfaceçš„åˆå§‹åŒ–è¿‡ç¨‹è¿™é‡Œå°±ä¸åœ¨ä»‹ç»ã€‚</p><h4 id="4-2-4-2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹"><a href="#4-2-4-2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹" class="headerlink" title="4.2.4.2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹"></a>4.2.4.2ã€ç”Ÿäº§è€…Produceræ„é€ è¿‡ç¨‹</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IGraphicBufferProducer&gt; producer(<span class="keyword">new</span> BufferQueueProducer(core));</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer(<span class="keyword">new</span> BufferQueueConsumer(core));</span><br></pre></td></tr></table></figure><p>å®ä¾‹åŒ–BufferQueueProducerï¼Œè¿™é‡Œåˆå§‹åŒ–äº†mCore(core) å’Œ mSlots(core-&gt;mSlots)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">BufferQueueProducer::BufferQueueProducer(<span class="keyword">const</span> sp&lt;BufferQueueCore&gt;&amp; core) :</span><br><span class="line">    mCore(core),</span><br><span class="line">    mSlots(core-&gt;mSlots),</span><br><span class="line">    mConsumerName(),</span><br><span class="line">    mStickyTransform(<span class="number">0</span>),</span><br><span class="line">    mLastQueueBufferFence(Fence::NO_FENCE),</span><br><span class="line">    mCallbackMutex(),</span><br><span class="line">    mNextCallbackTicket(<span class="number">0</span>),</span><br><span class="line">    mCurrentCallbackTicket(<span class="number">0</span>),</span><br><span class="line">    mCallbackCondition(),</span><br><span class="line">    mDequeueTimeout(<span class="number">-1</span>) &#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹"><a href="#4-2-4-3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹" class="headerlink" title="4.2.4.3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹"></a>4.2.4.3ã€æ¶ˆè´¹è€…Consumeræ„é€ è¿‡ç¨‹</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IGraphicBufferProducer&gt; producer(<span class="keyword">new</span> BufferQueueProducer(core));</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer(<span class="keyword">new</span> BufferQueueConsumer(core));</span><br></pre></td></tr></table></figure><p>å®ä¾‹åŒ–BufferQueueConsumerï¼Œè¿™é‡Œåˆå§‹åŒ–äº†mCore(core) å’Œ mSlots(core-&gt;mSlots)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BufferQueueConsumer::BufferQueueConsumer(<span class="keyword">const</span> sp&lt;BufferQueueCore&gt;&amp; core) :</span><br><span class="line">    mCore(core),</span><br><span class="line">    mSlots(core-&gt;mSlots),</span><br><span class="line">    mConsumerName() &#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-4ã€SurfaceFlingerè®¾ç½®ç›‘å¬"><a href="#4-2-4-4ã€SurfaceFlingerè®¾ç½®ç›‘å¬" class="headerlink" title="4.2.4.4ã€SurfaceFlingerè®¾ç½®ç›‘å¬"></a>4.2.4.4ã€SurfaceFlingerè®¾ç½®ç›‘å¬</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mSurfaceFlingerConsumer = <span class="keyword">new</span> SurfaceFlingerConsumer(consumer, mTextureName,</span><br><span class="line">        <span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(<span class="number">0</span>));</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setContentsChangedListener(<span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setName(mName);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/16-Android-Graphics-App-Ask-SurfaceFlinger-ConsumeLisener-onFrameAvailable.png" alt="Markdown"></p><h4 id="4-2-4-5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹"><a href="#4-2-4-5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹" class="headerlink" title="4.2.4.5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹"></a>4.2.4.5ã€åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹</h4><p>ä»å‰é¢åˆ†æå¯çŸ¥ï¼ŒSurfaceFlingeråœ¨å¤„ç†åº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceä¸­ï¼Œåœ¨SurfaceFlingeræœåŠ¡ç«¯ä»…ä»…åˆ›å»ºäº†Layerå¯¹è±¡ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåœ¨ä»€ä¹ˆæ—¶å€™ã€ä»€ä¹ˆåœ°æ–¹åˆ›å»ºå‘¢ï¼Ÿ</p><p>ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºå¥½äº†Layerå¯¹è±¡å¹¶è¿”å›ISurfaceçš„ä»£ç†å¯¹è±¡ç»™åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºé€šè¿‡è¯¥ä»£ç†å¯¹è±¡åˆ›å»ºäº†ä¸€ä¸ªSurfaceControlå¯¹è±¡ï¼ŒJavaå±‚Surfaceéœ€è¦é€šè¿‡android_view_Surface.cppä¸­çš„JNIå‡½æ•°æ¥æ“ä½œnativeå±‚çš„Surfaceï¼Œåœ¨æ“ä½œnativeå±‚Surfaceå‰ï¼Œé¦–å…ˆéœ€è¦è·å–åˆ°nativeçš„Surfaceï¼Œåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceå°±æ˜¯åœ¨è¿™ä¸ªæ—¶å€™åˆ›å»ºçš„ã€‚ [-&gt;SurfaceControl.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;Surface&gt; SurfaceControl::getSurface() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">Mutex::Autolock _l(mLock);</span><br><span class="line"><span class="keyword">if</span> (mSurfaceData == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// This surface is always consumed by SurfaceFlinger, so the</span></span><br><span class="line">    <span class="comment">// producerControlledByApp value doesn't matter; using false.</span></span><br><span class="line">    mSurfaceData = <span class="keyword">new</span> Surface(mGraphicBufferProducer, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> mSurfaceData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Surface::Surface(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; bufferProducer,</span><br><span class="line">    <span class="keyword">bool</span> controlledByApp)</span><br><span class="line">: mGraphicBufferProducer(bufferProducer),</span><br><span class="line">  mCrop(Rect::EMPTY_RECT),</span><br><span class="line">  mGenerationNumber(<span class="number">0</span>),</span><br><span class="line">  mSharedBufferMode(<span class="literal">false</span>),</span><br><span class="line">  mAutoRefresh(<span class="literal">false</span>),</span><br><span class="line">  mSharedBufferSlot(BufferItem::INVALID_BUFFER_SLOT),</span><br><span class="line">  mSharedBufferHasBeenQueued(<span class="literal">false</span>),</span><br><span class="line">  mNextFrameNumber(<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line"><span class="comment">// Initialize the ANativeWindow function pointers.</span></span><br><span class="line">ANativeWindow::setSwapInterval  = hook_setSwapInterval;</span><br><span class="line">ANativeWindow::dequeueBuffer    = hook_dequeueBuffer;</span><br><span class="line">ANativeWindow::cancelBuffer     = hook_cancelBuffer;</span><br><span class="line">ANativeWindow::queueBuffer      = hook_queueBuffer;</span><br><span class="line">ANativeWindow::query            = hook_query;</span><br><span class="line">ANativeWindow::perform          = hook_perform;</span><br><span class="line"></span><br><span class="line">ANativeWindow::dequeueBuffer_DEPRECATED = hook_dequeueBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::cancelBuffer_DEPRECATED  = hook_cancelBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::lockBuffer_DEPRECATED    = hook_lockBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::queueBuffer_DEPRECATED   = hook_queueBuffer_DEPRECATED;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(ANativeWindow::minSwapInterval) = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(ANativeWindow::maxSwapInterval) = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">mReqWidth = <span class="number">0</span>;</span><br><span class="line">mReqHeight = <span class="number">0</span>;</span><br><span class="line">mReqFormat = <span class="number">0</span>;</span><br><span class="line">mReqUsage = <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line">mSwapIntervalZero = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºå®Œåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåï¼Œæƒ³è¦åœ¨è¯¥Surfaceä¸Šç»˜å›¾ï¼Œé¦–å…ˆéœ€è¦ä¸ºè¯¥Surfaceåˆ†é…å›¾å½¢bufferã€‚æˆ‘ä»¬å‰é¢ä»‹ç»äº†Androidåº”ç”¨ç¨‹åºå›¾å½¢ç¼“å†²åŒºçš„åˆ†é…éƒ½æ˜¯ç”±SurfaceFlingeræœåŠ¡è¿›ç¨‹æ¥å®Œæˆï¼Œåœ¨è¯·æ±‚åˆ›å»ºSurfaceæ—¶ï¼Œåœ¨æœåŠ¡ç«¯åˆ›å»ºäº†ä¸€ä¸ªBufferQueueæœ¬åœ°Binderå¯¹è±¡ï¼Œè¯¥å¯¹è±¡è´Ÿè´£ç®¡ç†åº”ç”¨ç¨‹åºä¸€ä¸ªæœ¬åœ°çª—å£Surfaceçš„å›¾å½¢ç¼“å†²åŒºã€‚</p><h4 id="4-2-4-5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout"><a href="#4-2-4-5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout" class="headerlink" title="4.2.4.5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout()"></a>4.2.4.5ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout()</h4><p>[-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">    mLayoutRequested = <span class="keyword">false</span>;</span><br><span class="line">    mScrollMayChange = <span class="keyword">true</span>;</span><br><span class="line">    mInLayout = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> View host = mView;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">        mInLayout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> numViewsRequestingLayout = mLayoutRequesters.size();</span><br><span class="line">        <span class="keyword">if</span> (numViewsRequestingLayout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ......</span><br><span class="line">                measureHierarchy(host, lp, mView.getContext().getResources(),</span><br><span class="line">                        desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">                mInLayout = <span class="keyword">true</span>;</span><br><span class="line">                host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">                ......</span><br><span class="line">    &#125;</span><br><span class="line">    mInLayout = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw"><a href="#4-2-4-7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw" class="headerlink" title="4.2.4.7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw()"></a>4.2.4.7ã€æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            draw(fullRedrawNeeded);</span><br><span class="line">        &#125;  ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Androidæ˜¯æ€æ ·å°†Viewç”»å‡ºæ¥çš„ï¼Ÿç”±äºä¹‹å‰æˆ‘ä»¬å·²ç»å…³é—­äº†HWCã€GPUã€HWUIï¼Œè¿™é‡Œåªå…³æ³¨è½¯ä»¶ç»˜åˆ¶ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</span><br><span class="line">    Surface surface = mSurface;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºæ¸²æŸ“è¿™ä¸ªæµç¨‹å¾ˆå¤æ‚ï¼Œæˆ‘ä»¬åç»­ç« èŠ‚å†åˆ†æã€‚</p><h2 id="4-3ã€APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹"><a href="#4-3ã€APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹" class="headerlink" title="4.3ã€APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹"></a>4.3ã€APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹</h2><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/17-Android-Graphics-App-SurfaceFlinger-lock-unlockpost.png" alt="Markdown"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> scalingRequired, Rect dirty)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw with software renderer.</span></span><br><span class="line">    <span class="keyword">final</span> Canvas canvas;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        canvas = mSurface.lockCanvas(dirty);</span><br><span class="line">        ......</span><br><span class="line">    &#125; ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            canvas.translate(-xoff, -yoff);</span><br><span class="line">            <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mTranslator.translateCanvas(canvas);</span><br><span class="line">            &#125;</span><br><span class="line">            canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</span><br><span class="line">            attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            mView.draw(canvas);</span><br><span class="line"></span><br><span class="line">            drawAccessibilityFocusedDrawableIfNeeded(canvas);</span><br><span class="line">        &#125;......</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            surface.unlockCanvasAndPost(canvas);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">           ......</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹çœ‹Surfaceçš„lockCanvasæ–¹æ³•ï¼š [-&gt;Surface.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mCanvas å˜é‡ç›´æ¥èµ‹å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Canvas mCanvas = <span class="keyword">new</span> CompatibleCanvas();</span><br><span class="line"><span class="function"><span class="keyword">public</span> Canvas <span class="title">lockCanvas</span><span class="params">(Rect inOutDirty)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Surface.OutOfResourcesException, IllegalArgumentException </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">    checkNotReleasedLocked();</span><br><span class="line">    ......</span><br><span class="line">    mLockedObject = nativeLockCanvas(mNativeObject, mCanvas, inOutDirty);</span><br><span class="line">    <span class="keyword">return</span> mCanvas;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeLockCanvas</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject canvasObj, jobject dirtyRectObj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–javaå±‚çš„Surfaceä¿å­˜çš„longå‹å¥æŸ„</span></span><br><span class="line">sp&lt;Surface&gt; surface(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isSurfaceValid(surface)) &#123;</span><br><span class="line">    doThrowIAE(env);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Rect <span class="title">dirtyRect</span><span class="params">(Rect::EMPTY_RECT)</span></span>;</span><br><span class="line">Rect* dirtyRectPtr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//è·å–javaå±‚dirty Rectçš„ä½ç½®å¤§å°ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">if</span> (dirtyRectObj) &#123;</span><br><span class="line">    dirtyRect.left   = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.left);</span><br><span class="line">    dirtyRect.top    = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.top);</span><br><span class="line">    dirtyRect.right  = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.right);</span><br><span class="line">    dirtyRect.bottom = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.bottom);</span><br><span class="line">    dirtyRectPtr = &amp;dirtyRect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ANativeWindow_Buffer outBuffer;</span><br><span class="line"> <span class="comment">//è°ƒç”¨Surfaceçš„lockæ–¹æ³•,å°†ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºèµ‹ç»™outBuffer</span></span><br><span class="line"><span class="keyword">status_t</span> err = surface-&gt;lock(&amp;outBuffer, dirtyRectPtr);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">SkImageInfo info = SkImageInfo::Make(outBuffer.width, outBuffer.height,</span><br><span class="line">                                     convertPixelFormat(outBuffer.format),</span><br><span class="line">                                     outBuffer.format == PIXEL_FORMAT_RGBX_8888 ?</span><br><span class="line">                                     kOpaque_SkAlphaType : kPremul_SkAlphaType);</span><br><span class="line"></span><br><span class="line">SkBitmap bitmap;</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªSkBitmap</span></span><br><span class="line"><span class="comment">//å›¾å½¢ç¼“å†²åŒºæ¯ä¸€è¡Œåƒç´ å¤§å°</span></span><br><span class="line"><span class="keyword">ssize_t</span> bpr = outBuffer.stride * bytesPerPixel(outBuffer.format);</span><br><span class="line">bitmap.setInfo(info, bpr);</span><br><span class="line"><span class="keyword">if</span> (outBuffer.width &gt; <span class="number">0</span> &amp;&amp; outBuffer.height &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    bitmap.setPixels(outBuffer.bits);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// be safe with an empty bitmap.</span></span><br><span class="line">    bitmap.setPixels(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Canvas* nativeCanvas = GraphicsJNI::getNativeCanvas(env, canvasObj);</span><br><span class="line">nativeCanvas-&gt;setBitmap(bitmap);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dirtyRectPtr) &#123;</span><br><span class="line">    nativeCanvas-&gt;clipRect(dirtyRect.left, dirtyRect.top,</span><br><span class="line">            dirtyRect.right, dirtyRect.bottom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dirtyRectObj) &#123;</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.left,   dirtyRect.left);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.top,    dirtyRect.top);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.right,  dirtyRect.right);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.bottom, dirtyRect.bottom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">sp&lt;Surface&gt; lockedSurface(surface);</span><br><span class="line">lockedSurface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line"><span class="keyword">return</span> (jlong) lockedSurface.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç é€»è¾‘ä¸»è¦å¦‚ä¸‹ï¼š 1ï¼‰è·å–javaå±‚dirty çš„Rectå¤§å°å’Œä½ç½®ä¿¡æ¯ï¼› 2ï¼‰è°ƒç”¨Surfaceçš„lockæ–¹æ³•,å°†ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºèµ‹ç»™outBufferï¼› 3ï¼‰åˆ›å»ºä¸€ä¸ªSkbitmapï¼Œå¡«å……å®ƒç”¨æ¥ä¿å­˜ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºï¼Œå¹¶èµ‹å€¼ç»™Javaå±‚çš„Canvaså¯¹è±¡ï¼› 4ï¼‰å°†å‰ªè£ä½ç½®å¤§å°ä¿¡æ¯èµ‹ç»™javaå±‚Canvaså¯¹è±¡ã€‚</p><h3 id="4-3-1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹"><a href="#4-3-1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·-lock-Bufferçš„è¿‡ç¨‹" class="headerlink" title="4.3.1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹"></a>4.3.1ã€Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº-APPç”³è¯·(lock)Bufferçš„è¿‡ç¨‹</h3><p>æˆ‘ä»¬ä¸Šè¾¹åˆ†æåˆ°äº†ç”³è¯·å›¾å½¢ç¼“å†²åŒºï¼Œç”¨åˆ°äº†Surfaceçš„lockå‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­æŸ¥çœ‹ã€‚ [-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Surface::lock(</span><br><span class="line">    ANativeWindow_Buffer* outBuffer, ARect* inOutDirtyBounds)</span><br><span class="line">    &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">ANativeWindowBuffer* out;</span><br><span class="line"><span class="keyword">int</span> fenceFd = <span class="number">-1</span>;</span><br><span class="line"><span class="comment">//è°ƒç”¨dequeueBufferå‡½æ•°ï¼Œç”³è¯·å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">status_t</span> err = dequeueBuffer(&amp;out, &amp;fenceFd);</span><br><span class="line">ALOGE_IF(err, <span class="string">"dequeueBuffer failed (%s)"</span>, strerror(-err));</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    <span class="comment">//è·å–å›¾å½¢ç¼“å†²åŒºåŒºåŸŸå¤§å°,èµ‹ç»™åå¤‡ç¼“å†²åŒºå˜é‡backBuffer</span></span><br><span class="line">    sp&lt;GraphicBuffer&gt; backBuffer(GraphicBuffer::getSelf(out));</span><br><span class="line">    <span class="function"><span class="keyword">const</span> Rect <span class="title">bounds</span><span class="params">(backBuffer-&gt;width, backBuffer-&gt;height)</span></span>;</span><br><span class="line">    Region newDirtyRegion;</span><br><span class="line">    <span class="keyword">if</span> (inOutDirtyBounds) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸Šå±‚æŒ‡å®šä¹åˆ·æ–°è„çŸ©å½¢åŒºåŸŸï¼Œåˆ™ç”¨è¿™ä¸ªåŒºåŸŸå’Œç¼“å†²åŒºåŒºåŸŸæ±‚äº¤é›†ï¼Œ</span></span><br><span class="line">        <span class="comment">//ç„¶åå°†äº¤é›†çš„ç»“æœè®¾ç»™éœ€è¦å»åˆ·æ–°çš„æ–°åŒºåŸŸ</span></span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(<span class="keyword">static_cast</span>&lt;Rect <span class="keyword">const</span>&amp;&gt;(*inOutDirtyBounds));</span><br><span class="line">        newDirtyRegion.andSelf(bounds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        /å¦‚æœä¸Šå±‚æ²¡æœ‰æŒ‡å®šè„çŸ©å½¢åŒºåŸŸï¼Œæ‰€ä»¥åˆ·æ–°æ•´ä¸ªå›¾å½¢ç¼“å†²åŒº</span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// figure out if we can copy the frontbuffer back</span></span><br><span class="line">    <span class="comment">//ä¸Šä¸€æ¬¡ç»˜åˆ¶çš„ä¿¡æ¯ä¿å­˜åœ¨mPostedBufferä¸­ï¼Œè€Œè¿™ä¸ªmPostedBufferåˆ™è¦åœ¨unLockAndPostå‡½æ•°ä¸­è®¾ç½®</span></span><br><span class="line">    int backBufferSlot(getSlotFromBufferLocked(backBuffer.get()));</span><br><span class="line">    <span class="keyword">const</span> sp&lt;GraphicBuffer&gt;&amp; frontBuffer(mPostedBuffer);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> canCopyBack = (frontBuffer != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            backBuffer-&gt;width  == frontBuffer-&gt;width &amp;&amp;</span><br><span class="line">            backBuffer-&gt;height == frontBuffer-&gt;height &amp;&amp;</span><br><span class="line">            backBuffer-&gt;format == frontBuffer-&gt;format);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (canCopyBack) &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        Region oldDirtyRegion;</span><br><span class="line">        <span class="keyword">if</span>(mSlots[backBufferSlot].dirtyRegion.isEmpty()) &#123;</span><br><span class="line">            oldDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; NUM_BUFFER_SLOTS; i++ ) &#123;</span><br><span class="line">                <span class="keyword">if</span>(i != backBufferSlot &amp;&amp; !mSlots[i].dirtyRegion.isEmpty())</span><br><span class="line">                    oldDirtyRegion.orSelf(mSlots[i].dirtyRegion);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        const Region copyback(oldDirtyRegion.subtract(newDirtyRegion));</span><br><span class="line">        <span class="keyword">if</span> (!copyback.isEmpty())</span><br><span class="line">        <span class="comment">//è¿™é‡ŒæŠŠmPostedBufferä¸­çš„æ—§æ•°æ®æ‹·è´åˆ°BackBufferä¸­ã€‚</span></span><br><span class="line">            <span class="comment">//åç»­çš„ç»˜ç”»åªè¦æ›´æ–°è„åŒºåŸŸå°±å¯ä»¥äº†ï¼Œè¿™ä¼šèŠ‚çº¦ä¸å°‘èµ„æº</span></span><br><span class="line">            copyBlt(backBuffer, frontBuffer, copyback);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// if we can't copy-back anything, modify the user's dirty</span></span><br><span class="line">        <span class="comment">// region to make sure they redraw the whole buffer</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸¤æ¬¡å›¾å½¢ç¼“å†²åŒºå¤§å°ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬å°±è¦ä¿®æ”¹ç”¨æˆ·æŒ‡å®šçš„dirtyåŒºåŸŸå¤§å°ä¸ºæ•´ä¸ªç¼“å†²åŒºå¤§å°ï¼Œ</span></span><br><span class="line">        <span class="comment">//ç„¶åå»æ›´æ–°æ•´ä¸ªç¼“å†²åŒº</span></span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;NUM_BUFFER_SLOTS ; i++) &#123;</span><br><span class="line">            mSlots[i].dirtyRegion.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// scope for the lock</span></span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="comment">//å°†æ–°çš„dirtyèµ‹ç»™è¿™ä¸ªbufferslot</span></span><br><span class="line">        mSlots[backBufferSlot].dirtyRegion = newDirtyRegion;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inOutDirtyBounds) &#123;</span><br><span class="line">        *inOutDirtyBounds = newDirtyRegion.getBounds();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* vaddr;</span><br><span class="line">     <span class="comment">//lockå’Œunlockåˆ†åˆ«ç”¨æ¥é”å®šå’Œè§£é”ä¸€ä¸ªæŒ‡å®šçš„å›¾å½¢ç¼“å†²åŒºï¼Œåœ¨è®¿é—®ä¸€å—å›¾å½¢ç¼“å†²åŒºçš„æ—¶å€™ï¼Œ</span></span><br><span class="line">    <span class="comment">//ä¾‹å¦‚ï¼Œå‘ä¸€å—å›¾å½¢ç¼“å†²å†™å…¥å†…å®¹çš„æ—¶å€™ï¼Œéœ€è¦å°†è¯¥å›¾å½¢ç¼“å†²åŒºé”å®šï¼Œç”¨æ¥é¿å…è®¿é—®å†²çª,</span></span><br><span class="line">    <span class="comment">//é”å®šä¹‹åï¼Œå°±å¯ä»¥è·å¾—ç”±å‚æ•°å‚æ•°lã€tã€wå’Œhæ‰€åœˆå®šçš„ä¸€å—ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼Œä¿å­˜åœ¨è¾“å‡ºå‚æ•°vaddrä¸­</span></span><br><span class="line">    <span class="keyword">status_t</span> res = backBuffer-&gt;lockAsync(</span><br><span class="line">            GRALLOC_USAGE_SW_READ_OFTEN | GRALLOC_USAGE_SW_WRITE_OFTEN,</span><br><span class="line">            newDirtyRegion.bounds(), &amp;vaddr, fenceFd);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Surfaceçš„lockå‡½æ•°ç”¨æ¥ç”³è¯·å›¾å½¢ç¼“å†²åŒºå’Œä¸€äº›æ“ä½œï¼Œæ–¹æ³•ä¸é•¿ï¼Œå¤§æ¦‚å·¥ä½œæœ‰ï¼š 1ï¼‰è°ƒç”¨connectå‡½æ•°å®Œæˆä¸€äº›åˆå§‹åŒ–ï¼› 2ï¼‰è°ƒç”¨dequeueBufferå‡½æ•°ï¼Œç”³è¯·å›¾å½¢ç¼“å†²åŒºï¼› 3ï¼‰è®¡ç®—éœ€è¦ç»˜åˆ¶çš„æ–°çš„dirtyåŒºåŸŸï¼Œæ—§çš„åŒºåŸŸåŸæ ·copyæ•°æ®ã€‚ [-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Surface::dequeueBuffer(<span class="keyword">android_native_buffer_t</span>** buffer, <span class="keyword">int</span>* fenceFd) &#123;</span><br><span class="line"><span class="keyword">uint32_t</span> reqWidth;</span><br><span class="line"><span class="keyword">uint32_t</span> reqHeight;</span><br><span class="line">PixelFormat reqFormat;</span><br><span class="line"><span class="keyword">uint32_t</span> reqUsage;</span><br><span class="line">&#123;</span><br><span class="line"> ......</span><br><span class="line"><span class="comment">//ç”³è¯·å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">status_t</span> result = mGraphicBufferProducer-&gt;dequeueBuffer(&amp;buf, &amp;fence,</span><br><span class="line">        reqWidth, reqHeight, reqFormat, reqUsage);</span><br><span class="line">......</span><br><span class="line"><span class="comment">//æ ¹æ®indexè·å–ç¼“å†²åŒº</span></span><br><span class="line">sp&lt;GraphicBuffer&gt;&amp; gbuf(mSlots[buf].buffer);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> ((result &amp; IGraphicBufferProducer::BUFFER_NEEDS_REALLOCATION) || gbuf == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//ç”±äºç”³è¯·çš„å†…å­˜æ˜¯åœ¨surfaceflingerè¿›ç¨‹ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">//BufferQueueä¸­çš„å›¾å½¢ç¼“å†²åŒºä¹Ÿæ˜¯é€šè¿‡åŒ¿åå…±äº«å†…å­˜å’Œbinderä¼ é€’æè¿°ç¬¦æ˜ å°„è¿‡å»çš„ï¼Œ</span></span><br><span class="line">    <span class="comment">//Surfaceé€šè¿‡è°ƒç”¨requestBufferå°†å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°Surfaceæ‰€åœ¨è¿›ç¨‹</span></span><br><span class="line">    result = mGraphicBufferProducer-&gt;requestBuffer(buf, &amp;gbuf);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="comment">//è·å–è¿™ä¸ªè¿™ä¸ªbufferå¯¹è±¡çš„æŒ‡é’ˆå†…å®¹</span></span><br><span class="line">*buffer = gbuf.get();</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> BufferQueueProducer::requestBuffer(<span class="keyword">int</span> slot, sp&lt;GraphicBuffer&gt;* buf) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line">Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mCore-&gt;mMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">mSlots[slot].mRequestBufferCalled = <span class="literal">true</span>;</span><br><span class="line">*buf = mSlots[slot].mGraphicBuffer;</span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„é¢ï¼Œå°±æ˜¯æ ¹æ®æŒ‡å®šindexå–å‡ºmSlotsä¸­çš„slotä¸­çš„bufferã€‚</p><h2 id="4-4ã€APPæäº¤-unlockAndPost-Bufferçš„è¿‡ç¨‹"><a href="#4-4ã€APPæäº¤-unlockAndPost-Bufferçš„è¿‡ç¨‹" class="headerlink" title="4.4ã€APPæäº¤(unlockAndPost)Bufferçš„è¿‡ç¨‹"></a>4.4ã€APPæäº¤(unlockAndPost)Bufferçš„è¿‡ç¨‹</h2><p>Surfaceç»˜åˆ¶å®Œæ¯•åï¼ŒunlockCanvasAndPostæ“ä½œã€‚ [-&gt;android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeUnlockCanvasAndPost</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject canvasObj)</span> </span>&#123;</span><br><span class="line">sp&lt;Surface&gt; surface(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line"><span class="keyword">if</span> (!isSurfaceValid(surface)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// detach the canvas from the surface</span></span><br><span class="line">Canvas* nativeCanvas = GraphicsJNI::getNativeCanvas(env, canvasObj);</span><br><span class="line">nativeCanvas-&gt;setBitmap(SkBitmap());</span><br><span class="line"></span><br><span class="line"><span class="comment">// unlock surface</span></span><br><span class="line"><span class="keyword">status_t</span> err = surface-&gt;unlockAndPost();</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    doThrowIAE(env);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Surface::unlockAndPost()</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"><span class="comment">//è§£é”å›¾å½¢ç¼“å†²åŒºï¼Œå’Œå‰é¢çš„lockAsyncæˆå¯¹å‡ºç°</span></span><br><span class="line"><span class="keyword">status_t</span> err = mLockedBuffer-&gt;unlockAsync(&amp;fd);</span><br><span class="line"><span class="comment">//queueBufferå»å½’è¿˜å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line">err = queueBuffer(mLockedBuffer.get(), fd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mPostedBuffer = mLockedBuffer;</span><br><span class="line">mLockedBuffer = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ ¸å¿ƒä¹Ÿæ˜¯åˆ†ä¸¤æ­¥ï¼š 1ï¼‰è§£é”å›¾å½¢ç¼“å†²åŒºï¼Œå’Œå‰é¢çš„lockAsyncæˆå¯¹å‡ºç°ï¼› 2ï¼‰queueBufferå»å½’è¿˜å›¾å½¢ç¼“å†²åŒºï¼› æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯é‡ç‚¹åˆ†æç¬¬äºŒæ­¥ï¼ŒæŸ¥çœ‹queueBufferçš„å®ç°ï¼š [-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Surface::queueBuffer(<span class="keyword">android_native_buffer_t</span>* buffer, <span class="keyword">int</span> fenceFd) &#123;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">status_t</span> err = mGraphicBufferProducer-&gt;queueBuffer(i, input, &amp;output);</span><br><span class="line">mLastQueueDuration = systemTime() - now;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨BufferQueueProducerçš„queueBufferå½’è¿˜ç¼“å†²åŒºï¼Œå°†ç»˜åˆ¶åçš„å›¾å½¢ç¼“å†²åŒºqueueå›å»ã€‚ [-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> BufferQueueProducer::queueBuffer(<span class="keyword">int</span> slot,</span><br><span class="line">    <span class="keyword">const</span> QueueBufferInput &amp;input, QueueBufferOutput *output) &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&#123; <span class="comment">// scope for the lock</span></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mCallbackMutex)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (callbackTicket != mCurrentCallbackTicket) &#123;</span><br><span class="line">        mCallbackCondition.wait(mCallbackMutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (frameAvailableListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        frameAvailableListener-&gt;onFrameAvailable(item);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frameReplacedListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        frameReplacedListener-&gt;onFrameReplaced(item);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š 1ï¼‰ä»ä¼ å…¥çš„QueueBufferInput ï¼Œè§£æå¡«å……ä¸€äº›å˜é‡ï¼› 2ï¼‰æ”¹å˜å…¥é˜ŸSlotçš„çŠ¶æ€ä¸ºQUEUEDï¼Œæ¯æ¬¡æ¨è¿›æ¥ï¼ŒmFrameCounteréƒ½åŠ 1ã€‚è¿™é‡Œçš„slotï¼Œä¸Šä¸€ç¯‡è®²åˆ†é…ç¼“å†²åŒºè¿”å›æœ€è€çš„FREEçŠ¶æ€bufferï¼Œå°±æ˜¯ç”¨è¿™ä¸ªmFrameCounteræœ€å°å€¼åˆ¤æ–­ï¼Œå°±æ˜¯ä¸Šä¸€ç¯‡LRUç®—æ³•çš„åˆ¤æ–­ï¼› 3ï¼‰åˆ›å»ºä¸€ä¸ªBufferItemæ¥æè¿°GraphicBufferï¼Œç”¨mSlots[slot]ä¸­çš„slotå¡«å……BufferItemï¼› 4ï¼‰å°†BufferItemå¡è¿›mCoreçš„mQueueé˜Ÿåˆ—ï¼Œä¾ç…§æŒ‡å®šè§„åˆ™ï¼› 5ï¼‰ç„¶åé€šçŸ¥SurfaceFlingerå»æ¶ˆè´¹ã€‚ Folwï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/18-Android-Graphics-App-WMS-SurfaceFlinger-All-Flow.png" alt="Markdown"></p><h2 id="ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ"><a href="#ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ" class="headerlink" title="ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ"></a>ï¼ˆäº”ï¼‰ã€é€šçŸ¥SFæ¶ˆè´¹åˆæˆ</h2><p>å½“ç»˜åˆ¶å®Œæ¯•çš„GraphicBufferå…¥é˜Ÿä¹‹åï¼Œä¼šé€šçŸ¥SurfaceFlingerå»æ¶ˆè´¹ï¼Œå°±æ˜¯BufferQueueProducerçš„queueBufferå‡½æ•°çš„æœ€åå‡ è¡Œï¼Œlistener-&gt;onFrameAvailable()ã€‚ listeneræœ€ç»ˆé€šè¿‡å›è°ƒï¼Œä¼šå›åˆ°Layerå½“ä¸­ï¼Œæ‰€ä»¥æœ€ç»ˆè°ƒç”¨Layerçš„onFrameAvailableæ¥å£ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®ç°ï¼š [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::onFrameAvailable(<span class="keyword">const</span> BufferItem&amp; item) &#123;</span><br><span class="line"><span class="comment">// Add this buffer from our internal queue tracker</span></span><br><span class="line">&#123; <span class="comment">// Autolock scope</span></span><br><span class="line">    ......</span><br><span class="line">    mQueueItems.push_back(item);</span><br><span class="line">    android_atomic_inc(&amp;mQueuedFrames);</span><br><span class="line">    <span class="comment">// Wake up any pending callbacks</span></span><br><span class="line">    mLastFrameNumberReceived = item.mFrameNumber;</span><br><span class="line">    mQueueItemCondition.broadcast();</span><br><span class="line">&#125;</span><br><span class="line">mFlinger-&gt;signalLayerUpdate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆè°ƒç”¨SurfaceFlingerçš„signalLayerUpdateå‡½æ•°ï¼Œç»§ç»­æŸ¥çœ‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::signalLayerUpdate() &#123;</span><br><span class="line">mEventQueue.invalidate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆè°ƒç”¨MessageQueueçš„invalidateå‡½æ•°ï¼š [MessageQueue.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MessageQueue::invalidate() &#123;</span><br><span class="line">mEvents-&gt;requestNextVsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è´´ä¸€ä¸‹SurfaceFlingerçš„åˆå§‹åŒ–è¯·æ±‚vsyncä¿¡å·æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/19-Android-Graphics-vsync-surfaceflinger.png" alt="Markdown"></p><p>æœ€ç»ˆç»“æœä¼šèµ°åˆ°SurfaceFlingerçš„vsyncä¿¡å·æ¥æ”¶é€»è¾‘ï¼Œå³SurfaceFlingerçš„onMessageReceivedå‡½æ•°ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::onMessageReceived(<span class="keyword">int32_t</span> what) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"><span class="keyword">switch</span> (what) &#123;</span><br><span class="line">    <span class="keyword">case</span> MessageQueue::INVALIDATE: &#123;</span><br><span class="line">        <span class="keyword">bool</span> frameMissed = !mHadClientComposition &amp;&amp;</span><br><span class="line">                mPreviousPresentFence != Fence::NO_FENCE &amp;&amp;</span><br><span class="line">                mPreviousPresentFence-&gt;getSignalTime() == INT64_MAX;</span><br><span class="line">        ATRACE_INT(<span class="string">"FrameMissed"</span>, <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(frameMissed));</span><br><span class="line">        <span class="keyword">if</span> (mPropagateBackpressure &amp;&amp; frameMissed) &#123;</span><br><span class="line">            signalLayerUpdate();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> refreshNeeded = handleMessageTransaction();</span><br><span class="line">        refreshNeeded |= handleMessageInvalidate();</span><br><span class="line">        refreshNeeded |= mRepaintEverything;</span><br><span class="line">        <span class="keyword">if</span> (refreshNeeded) &#123;</span><br><span class="line">            <span class="comment">// Signal a refresh if a transaction modified the window state,</span></span><br><span class="line">            <span class="comment">// a new buffer was latched, or if HWC has requested a full</span></span><br><span class="line">            <span class="comment">// repaint</span></span><br><span class="line">            signalRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> MessageQueue::REFRESH: &#123;</span><br><span class="line">        handleMessageRefresh();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceFlingeræ”¶åˆ°äº†VSyncä¿¡å·åï¼Œè°ƒç”¨äº†handleMessageRefreshå‡½æ•° [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleMessageRefresh() &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line"><span class="keyword">nsecs_t</span> refreshStartTime = systemTime(SYSTEM_TIME_MONOTONIC);</span><br><span class="line"></span><br><span class="line">preComposition();</span><br><span class="line">rebuildLayerStacks();</span><br><span class="line">setUpHWComposer();</span><br><span class="line">doDebugFlashRegions();</span><br><span class="line">doComposition();</span><br><span class="line">postComposition(refreshStartTime);</span><br><span class="line"></span><br><span class="line">mPreviousPresentFence = mHwc-&gt;getRetireFence(HWC_DISPLAY_PRIMARY);</span><br><span class="line"></span><br><span class="line">mHadClientComposition = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> displayId = <span class="number">0</span>; displayId &lt; mDisplays.size(); ++displayId) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; displayDevice = mDisplays[displayId];</span><br><span class="line">    mHadClientComposition = mHadClientComposition ||</span><br><span class="line">            mHwc-&gt;hasClientComposition(displayDevice-&gt;getHwcDisplayId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Release any buffers which were replaced this frame</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; layer : mLayersWithQueuedFrames) &#123;</span><br><span class="line">    layer-&gt;releasePendingBuffer();</span><br><span class="line">&#125;</span><br><span class="line">mLayersWithQueuedFrames.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦çœ‹ä¸‹ä¸‹é¢å‡ ä¸ªå‡½æ•°ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">preComposition();</span><br><span class="line">rebuildLayerStacks();</span><br><span class="line">setUpHWComposer();</span><br><span class="line">doDebugFlashRegions();</span><br><span class="line">doComposition();</span><br><span class="line">postComposition(refreshStartTime);</span><br></pre></td></tr></table></figure><h3 id="ä¸€ã€preComposition-å‡½æ•°"><a href="#ä¸€ã€preComposition-å‡½æ•°" class="headerlink" title="ä¸€ã€preComposition()å‡½æ•°"></a>ä¸€ã€preComposition()å‡½æ•°</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªå‡½æ•°preComposition() [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::preComposition()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">bool</span> needExtraInvalidate = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (layers[i]-&gt;onPreComposition()) &#123;</span><br><span class="line">        needExtraInvalidate = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (needExtraInvalidate) &#123;</span><br><span class="line">    signalLayerUpdate();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‡½æ•°å…ˆæ˜¯è°ƒç”¨äº†mDrawingStateçš„layersSortedByZæ¥å¾—åˆ°ä¸Šæ¬¡ç»˜å›¾çš„Layerå±‚åˆ—è¡¨ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„Layeréƒ½ä¼šå‚ä¸å±å¹•å›¾åƒçš„ç»˜åˆ¶ï¼Œå› æ­¤SurfaceFlingerç”¨stateå¯¹è±¡æ¥è®°å½•å‚ä¸ç»˜åˆ¶çš„Layerå¯¹è±¡ã€‚ è®°å¾—æˆ‘ä»¬ä¹‹å‰åˆ†æè¿‡createLayerå‡½æ•°æ¥åˆ›å»ºLayerï¼Œåˆ›å»ºä¹‹åä¼šè°ƒç”¨addClientLayerå‡½æ•°ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> SurfaceFlinger::addClientLayer(<span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; handle,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; gbc,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;Layer&gt;&amp; lbc)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">// add this layer to the current state list</span></span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mStateLock);</span><br><span class="line">    <span class="keyword">if</span> (mCurrentState.layersSortedByZ.size() &gt;= MAX_LAYERS) &#123;</span><br><span class="line">        <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line">    mCurrentState.layersSortedByZ.add(lbc);</span><br><span class="line">    mGraphicBufferProducerList.add(IInterface::asBinder(gbc));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// attach this layer to the client</span></span><br><span class="line">client-&gt;attachLayer(handle, lbc);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹ä¸‹addClientLayerå‡½æ•°ï¼Œè¿™é‡Œä¼šæŠŠLayerå¯¹è±¡æ”¾åœ¨mCurrentStateçš„layersSortedByZå¯¹è±¡ä¸­ã€‚è€ŒmDrawingStateå’ŒmCurrentStateä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿåœ¨åé¢æˆ‘ä»¬ä¼šä»‹ç»ï¼ŒmDrawingStateä»£è¡¨ä¸Šä¸€æ¬¡ç»˜å›¾æ—¶çš„çŠ¶æ€ï¼Œå¤„ç†å®Œä¹‹åä¼šæŠŠmCurrentStateèµ‹ç»™mDrawingStateã€‚ å›åˆ°preCompositionå‡½æ•°ï¼Œéå†æ‰€æœ‰çš„Layerå¯¹è±¡ï¼Œè°ƒç”¨å…¶onPreCompositionå‡½æ•°æ¥æ£€æµ‹Layerå±‚ä¸­çš„å›¾åƒæ˜¯å¦æœ‰å˜åŒ–ã€‚</p><h2 id="1-1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°"><a href="#1-1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°" class="headerlink" title="1.1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°"></a>1.1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°</h2><p>onPreCompositionå‡½æ•°æ¥æ ¹æ®mQueuedFramesæ¥åˆ¤æ–­å›¾åƒæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œæˆ–è€…æ˜¯mSidebandStreamChangedã€mAutoRefreshã€‚ [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Layer::onPreComposition() &#123;</span><br><span class="line">mRefreshPending = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">return</span> mQueuedFrames &gt; <span class="number">0</span> || mSidebandStreamChanged || mAutoRefresh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“Layeræ‰€å¯¹åº”çš„Surfaceæ›´æ–°å›¾åƒåï¼Œå®ƒæ‰€å¯¹åº”çš„Layerå¯¹è±¡çš„onFrameAvailableå‡½æ•°ä¼šè¢«è°ƒç”¨æ¥é€šçŸ¥è¿™ç§å˜åŒ–ã€‚ åœ¨SurfaceFlingerçš„preCompositionå‡½æ•°ä¸­å½“æœ‰Layerçš„å›¾åƒæ”¹å˜äº†ï¼Œæœ€åä¹Ÿä¼šè°ƒç”¨SurfaceFlingerçš„signalLayerUpdateå‡½æ•°ã€‚ SurfaceFlinger::signalLayerUpdateæ˜¯è°ƒç”¨äº†MessageQueueçš„invalidateå‡½æ•° æœ€åå¤„ç†è¿˜æ˜¯è°ƒç”¨äº†SurfaceFlingerçš„onMessageReceivedå‡½æ•°ã€‚çœ‹çœ‹SurfaceFlingerçš„onMessageReceivedå‡½æ•°å¯¹NVALIDATEçš„å¤„ç† handleMessageInvalidateå‡½æ•°ä¸­è°ƒç”¨äº†handlePageFlipå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†ä¼šå¤„ç†Layerä¸­çš„ç¼“å†²åŒºï¼ŒæŠŠæ›´æ–°è¿‡çš„å›¾åƒç¼“å†²åŒºåˆ‡æ¢åˆ°å‰å°ï¼Œç­‰å¾…VSyncä¿¡å·æ›´æ–°åˆ°FrameBufferã€‚</p><h2 id="1-2ã€ç»˜åˆ¶æµç¨‹"><a href="#1-2ã€ç»˜åˆ¶æµç¨‹" class="headerlink" title="1.2ã€ç»˜åˆ¶æµç¨‹"></a>1.2ã€ç»˜åˆ¶æµç¨‹</h2><p>ç”¨æˆ·è¿›ç¨‹æ›´æ–°Surfaceå›¾åƒï¼Œå°†å¯¼è‡´SurfaceFlingerä¸­çš„Layerå‘é€invalidateæ¶ˆæ¯ï¼Œå¤„ç†è¯¥æ¶ˆæ¯ä¼šè°ƒç”¨handleTransactionå‡½æ•°å’ŒhandlePageFilpå‡½æ•°æ¥æ›´æ–°Layerå¯¹è±¡ã€‚ä¸€æ—¦VSyncä¿¡å·åˆ°æ¥ï¼Œå†è°ƒç”¨rebuildlayerStacks setUpHWComposer doComposition postCompositionå‡½æ•°å°†æ‰€æœ‰Layerçš„å›¾åƒæ··åˆåæ›´æ–°åˆ°æ˜¾ç¤ºè®¾å¤‡ä¸Šå»ã€‚</p><h3 id="äºŒã€handleTransaction-handPageFlipæ›´æ–°Layerå¯¹è±¡"><a href="#äºŒã€handleTransaction-handPageFlipæ›´æ–°Layerå¯¹è±¡" class="headerlink" title="äºŒã€handleTransaction handPageFlipæ›´æ–°Layerå¯¹è±¡"></a>äºŒã€handleTransaction handPageFlipæ›´æ–°Layerå¯¹è±¡</h3><p>åœ¨ä¸Šä¸€èŠ‚ä¸­çš„ç»˜å›¾çš„æµç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†handleTransactionå’ŒhandPageFlipè¿™ä¸¤ä¸ªå‡½æ•°é€šå¸¸æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹æ›´æ–°Surfaceå›¾åƒæ—¶ä¼šè°ƒç”¨ï¼Œæ¥æ›´æ–°Layerå¯¹è±¡ã€‚è¿™èŠ‚å°±ä¸»è¦è®²è§£è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p><h2 id="2-1ã€handleTransactionå‡½æ•°"><a href="#2-1ã€handleTransactionå‡½æ•°" class="headerlink" title="2.1ã€handleTransactionå‡½æ•°"></a>2.1ã€handleTransactionå‡½æ•°</h2><p>handleTransactionå‡½æ•°çš„å‚æ•°æ˜¯transactionFlagsï¼Œä¸è¿‡å‡½æ•°ä¸­æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œè€Œæ˜¯é€šè¿‡getTransactionFlags(eTransactionMask)æ¥é‡æ–°å¯¹transactionFlagsèµ‹å€¼ï¼Œç„¶åä½¿ç”¨å®ƒä½œä¸ºå‚æ•°æ¥è°ƒç”¨å‡½æ•° handleTransactionLockedã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleTransaction(<span class="keyword">uint32_t</span> transactionFlags)</span><br><span class="line">&#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line">Mutex::Autolock _l(mStateLock);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">nsecs_t</span> now = systemTime();</span><br><span class="line">mDebugInTransaction = now;</span><br><span class="line"></span><br><span class="line">transactionFlags = getTransactionFlags(eTransactionMask);</span><br><span class="line">handleTransactionLocked(transactionFlags);</span><br><span class="line"></span><br><span class="line">mLastTransactionTime = systemTime() - now;</span><br><span class="line">mDebugInTransaction = <span class="number">0</span>;</span><br><span class="line">invalidateHwcGeometry();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getTransactionFlagså‡½æ•°çš„å‚æ•°æ˜¯eTransactionMaskåªæ˜¯å±è”½å…¶ä»–ä½ã€‚ handleTransactionLockedå‡½æ•°ä¼šè°ƒç”¨æ¯ä¸ªLayerç±»çš„doTransactionå‡½æ•°ï¼Œåœ¨åˆ†æhandleTransactionLockedå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹Layerç±» çš„doTransactionå‡½æ•°ã€‚</p><h2 id="2-2ã€Layerçš„doTransactionå‡½æ•°"><a href="#2-2ã€Layerçš„doTransactionå‡½æ•°" class="headerlink" title="2.2ã€Layerçš„doTransactionå‡½æ•°"></a>2.2ã€Layerçš„doTransactionå‡½æ•°</h2><p>ä¸‹é¢æ˜¯Layerçš„doTransactionå‡½æ•°ä»£ç  [Layer.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">uint32_t Layer::doTransaction(uint32_t flags) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line">pushPendingState();<span class="comment">//ä¸Šæ¬¡ç»˜åˆ¶çš„Stateå¯¹è±¡  </span></span><br><span class="line">Layer::State c = getCurrentState();<span class="comment">//å½“å‰ä½¿ç”¨çš„Stateå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Layer::State&amp; s(getDrawingState());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bool sizeChanged = (c.requested.w != s.requested.w) ||</span><br><span class="line">                         (c.requested.h != s.requested.h);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sizeChanged) &#123;</span><br><span class="line">    <span class="comment">// the size changed, we need to ask our client to request a new buffer</span></span><br><span class="line">    <span class="comment">//å¦‚æœLayerçš„å°ºå¯¸å‘ç”Ÿå˜åŒ–ï¼Œå°±è¦æ”¹å˜Surfaceçš„ç¼“å†²åŒºçš„å°ºå¯¸</span></span><br><span class="line">    <span class="comment">// record the new size, form this point on, when the client request</span></span><br><span class="line">    <span class="comment">// a buffer, it'll get the new size.</span></span><br><span class="line">    mSurfaceFlingerConsumer-&gt;setDefaultBufferSize(</span><br><span class="line">            c.requested.w, c.requested.h);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bool resizePending = (c.requested.w != c.active.w) ||</span><br><span class="line">        (c.requested.h != c.active.h);</span><br><span class="line"><span class="keyword">if</span> (!isFixedSize()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (resizePending &amp;&amp; mSidebandStream == NULL) &#123;</span><br><span class="line">    <span class="comment">//å¦‚æœLayerä¸æ˜¯å›ºå®šå°ºå¯¸çš„ç±»å‹ï¼Œæ¯”è¾ƒå®ƒçš„å®é™…å¤§å°å’Œè¦æ±‚çš„æ”¹å˜å¤§å°  </span></span><br><span class="line">        flags |= eDontUpdateGeometryState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰eDontUpdateGeometryStateæ ‡å¿—ï¼Œæ›´æ–°activeçš„å€¼ä¸ºrequest  </span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; eDontUpdateGeometryState)  &#123;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Layer::State&amp; editCurrentState(getCurrentState());</span><br><span class="line">    <span class="keyword">if</span> (mFreezePositionUpdates) &#123;</span><br><span class="line">        <span class="keyword">float</span> tx = c.active.transform.tx();</span><br><span class="line">        <span class="keyword">float</span> ty = c.active.transform.ty();</span><br><span class="line">        c.active = c.requested;</span><br><span class="line">        c.active.transform.set(tx, ty);</span><br><span class="line">        editCurrentState.active = c.active;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        editCurrentState.active = editCurrentState.requested;</span><br><span class="line">        c.active = c.requested;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰stateçš„activeå’Œä»¥å‰çš„Stateçš„activeä¸ç­‰ï¼Œè®¾ç½®æ›´æ–°æ ‡å¿—  </span></span><br><span class="line"><span class="keyword">if</span> (s.active != c.active) &#123;</span><br><span class="line">    <span class="comment">// invalidate and recompute the visible regions if needed</span></span><br><span class="line">    flags |= Layer::eVisibleRegion;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœå½“å‰stateçš„sequenceå’Œä»¥å‰stateçš„sequenceä¸ç­‰ï¼Œè®¾ç½®æ›´æ–°æ ‡å¿—</span></span><br><span class="line"><span class="keyword">if</span> (c.sequence != s.sequence) &#123;</span><br><span class="line">    <span class="comment">// invalidate and recompute the visible regions if needed</span></span><br><span class="line">    flags |= eVisibleRegion;</span><br><span class="line">    <span class="keyword">this</span>-&gt;contentDirty = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we may use linear filtering, if the matrix scales us</span></span><br><span class="line">    <span class="keyword">const</span> uint8_t type = c.active.transform.getType();</span><br><span class="line">    mNeedsFiltering = (!c.active.transform.preserveRects() ||</span><br><span class="line">            (type &gt;= Transform::SCALE));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the layer is hidden, signal and clear out all local sync points so</span></span><br><span class="line"><span class="comment">// that transactions for layers depending on this layer's frames becoming</span></span><br><span class="line"><span class="comment">// visible are not blocked</span></span><br><span class="line"><span class="keyword">if</span> (c.flags &amp; layer_state_t::eLayerHidden) &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mLocalSyncPointMutex)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (auto&amp; point : mLocalSyncPoints) &#123;</span><br><span class="line">        point-&gt;setFrameAvailable();</span><br><span class="line">    &#125;</span><br><span class="line">    mLocalSyncPoints.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Commit the transaction</span></span><br><span class="line">commitTransaction(c);</span><br><span class="line"><span class="keyword">return</span> flags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Layerç±»ä¸­çš„ä¸¤ä¸ªç±»å‹ä¸ºLayer::Stateçš„æˆå‘˜å˜é‡mDrawingStateã€mCurrentStateï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªå¯¹è±¡å‘¢ï¼ŸLayerå¯¹è±¡åœ¨ç»˜åˆ¶å›¾å½¢æ—¶ï¼Œä½¿ç”¨çš„æ˜¯mDrawingStateå˜é‡ï¼Œç”¨æˆ·è°ƒç”¨æ¥å£è®¾ç½®Layerå¯¹è±¡å±æ€§æ˜¯ï¼Œè®¾ç½®çš„å€¼ä¿å­˜åœ¨mCurrentStateå¯¹è±¡ä¸­ï¼Œè¿™æ ·å°±ä¸ä¼šå› ä¸ºç”¨æˆ·çš„æ“ä½œè€Œå¹²æ‰°Layerå¯¹è±¡çš„ç»˜åˆ¶äº†ã€‚ Layerçš„doTransactionå‡½æ•°æ®ä½ æ˜¯æ¯”è¾ƒè¿™ä¸¤ä¸ªå˜é‡ï¼Œå¦‚æœæœ‰ä¸åŒçš„åœ°æ–¹ï¼Œè¯´æ˜åœ¨ä¸Šæ¬¡ç»˜åˆ¶ä»¥åï¼Œç”¨æˆ·æ”¹å˜çš„Layerçš„è®¾ç½®ï¼Œè¦æŠŠè¿™ç§å˜åŒ–é€šè¿‡flagsè¿”å›ã€‚ Stateçš„ç»“æ„ä¸­æœ‰ä¸¤ä¸ªGeometryå­—æ®µï¼Œactiveå’Œrequestedã€‚ä»–ä»¬è¡¨ç¤ºlayerçš„å°ºå¯¸ï¼Œå…¶ä¸­requestedä¿å­˜æ˜¯ç”¨æˆ·è®¾ç½®çš„å°ºå¯¸ï¼Œè€Œactiveä¿å­˜çš„å€¼é€šè¿‡è®¡ç®—åçš„å®é™…å°ºå¯¸ã€‚ Stateä¸­çš„zå­—æ®µçš„å€¼å°±æ˜¯Layeråœ¨æ˜¾ç¤ºè½´çš„ä½ç½®ï¼Œå€¼è¶Šå°ä½ç½®è¶Šé ä¸‹ã€‚ layerStackå­—æ®µæ˜¯ç”¨æˆ·æŒ‡å®šçš„ä¸€ä¸ªå€¼ï¼Œç”¨æˆ·å¯ä»¥ç»™DisplayDeviceä¹ŸæŒ‡å®šä¸€ä¸ªlayerStackå€¼ï¼Œåªæœ‰Layerå¯¹è±¡å’ŒDisplayDeviceå¯¹è±¡çš„layerStackç›¸ç­‰ï¼Œè¿™ä¸ªLayeræ‰èƒ½åœ¨è¿™ä¸ªæ˜¾ç¤ºè®¾å¤‡ä¸Šè¾“å‡ºï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥è®©æ˜¾ç¤ºè®¾å¤‡åªæ˜¾ç¤ºæŸä¸ªSurfaceçš„å†…å®¹ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥è®©HDMIæ˜¾ç¤ºè®¾å¤‡åªæ˜¾ç¤ºæ‰‹æœºä¸Šæ’­æ”¾è§†é¢‘çš„Surfaceçª—å£ï¼Œä½†ä¸æ˜¾ç¤ºActivityçª—å£ã€‚ sequenceå­—æ®µæ˜¯ä¸ªåºåˆ—å€¼ï¼Œæ¯å½“ç”¨æˆ·è°ƒç”¨äº†Layerçš„æ¥å£ï¼Œä¾‹å¦‚setAlphaã€setSizeæˆ–è€…setLayerç­‰æ”¹å˜Layerå¯¹è±¡å±æ€§çš„å“ˆæ•°ï¼Œè¿™ä¸ªå€¼éƒ½ä¼šåŠ 1ã€‚å› æ­¤åœ¨doTransactionå‡½æ•°ä¸­èƒ½é€šè¿‡æ¯”è¾ƒsequenceå€¼æ¥åˆ¤æ–­Layerçš„å±æ€§å€¼æœ‰æ²¡æœ‰å˜åŒ–ã€‚ doTransactionå‡½æ•°æœ€åä¼šè°ƒç”¨commitTransactionå‡½æ•°ï¼Œå°±æ˜¯æŠŠmCurrentStateèµ‹å€¼ç»™mDrawingState [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::commitTransaction(<span class="keyword">const</span> State&amp; stateToCommit) &#123;</span><br><span class="line">mDrawingState = stateToCommit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3ã€handleTransactionLockedå‡½æ•°"><a href="#2-3ã€handleTransactionLockedå‡½æ•°" class="headerlink" title="2.3ã€handleTransactionLockedå‡½æ•°"></a>2.3ã€handleTransactionLockedå‡½æ•°</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æhandleTransactionLockedå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬åˆ†æ®µåˆ†æ</p><p>2.3.1 å¤„ç†Layerçš„äº‹åŠ¡ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleTransactionLocked(<span class="keyword">uint32_t</span> transactionFlags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">currentLayers</span><span class="params">(mCurrentState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notify all layers of available frames</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">    currentLayers[i]-&gt;notifyAvailableFrames();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (transactionFlags &amp; eTraversalNeeded) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">        <span class="keyword">uint32_t</span> trFlags = layer-&gt;getTransactionFlags(eTransactionNeeded);</span><br><span class="line">        <span class="keyword">if</span> (!trFlags) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint32_t</span> flags = layer-&gt;doTransaction(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; Layer::eVisibleRegion)</span><br><span class="line">            mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨SurfaceFlingerä¸­ä¹Ÿæœ‰ä¸¤ä¸ªç±»å‹ä¸ºStateçš„å˜é‡mCurrentStateå’ŒmDrawingStateï¼Œä½†æ˜¯å’ŒLayerä¸­çš„ä¸è¦æ··èµ·æ¥ã€‚å®ƒçš„åå­—ç›¸åŒè€Œå·²</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">State</span> &#123;</span></span><br><span class="line">    LayerVector layersSortedByZ;</span><br><span class="line">    DefaultKeyedVector&lt; wp&lt;IBinder&gt;, DisplayDeviceState&gt; displays;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“æ„layersSortedByZå­—æ®µä¿å­˜æ‰€æœ‰å‚ä¸ç»˜åˆ¶çš„Layerå¯¹è±¡ï¼Œè€Œå­—æ®µdisplaysä¿å­˜çš„æ˜¯æ‰€æœ‰è¾“å‡ºè®¾å¤‡çš„DisplayDeviceStateå¯¹è±¡ è¿™é‡Œç”¨ä¸¤ä¸ªå˜é‡çš„ç›®çš„æ˜¯å’ŒLayerä¸­ä½¿ç”¨ä¸¤ä¸ªå˜é‡æ˜¯ä¸€æ ·çš„ã€‚ ä¸Šé¢ä»£ç æ ¹æ®eTraversalNeededæ ‡å¿—æ¥å†³å®šæ˜¯å¦è¦æ£€æŸ¥æ‰€æœ‰çš„Layerå¯¹è±¡ã€‚å¦‚æœæŸä¸ªLayerå¯¹è±¡ä¸­æœ‰eTransactionNeededæ ‡å¿—ï¼Œå°†è°ƒç”¨å®ƒçš„doTransactionå‡½æ•°ã€‚Layerçš„doTransactionå‡½æ•°è¿”å›çš„flagså¦‚æœæœ‰eVisibleRegionï¼Œè¯´æ˜è¿™ä¸ªLayeréœ€è¦æ›´æ–°ï¼Œå°±æŠŠmVisibleRegionsDirtyè®¾ç½®ä¸ºtrue</p><h3 id="2-3-2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–"><a href="#2-3-2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–" class="headerlink" title="2.3.2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–"></a>2.3.2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (transactionFlags &amp; eDisplayTransactionNeeded) &#123;</span><br><span class="line">    <span class="comment">// here we take advantage of Vector's copy-on-write semantics to</span></span><br><span class="line">    <span class="comment">// improve performance by skipping the transaction entirely when</span></span><br><span class="line">    <span class="comment">// know that the lists are identical</span></span><br><span class="line">    <span class="keyword">const</span> KeyedVector&lt;  wp&lt;IBinder&gt;, DisplayDeviceState&gt;&amp; curr(mCurrentState.displays);</span><br><span class="line">    <span class="keyword">const</span> KeyedVector&lt;  wp&lt;IBinder&gt;, DisplayDeviceState&gt;&amp; draw(mDrawingState.displays);</span><br><span class="line">    <span class="keyword">if</span> (!curr.isIdenticalTo(draw)) &#123;</span><br><span class="line">        mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> cc = curr.size();</span><br><span class="line">              <span class="keyword">size_t</span> dc = draw.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// find the displays that were removed</span></span><br><span class="line">        <span class="comment">// (ie: in drawing state but not in current state)</span></span><br><span class="line">        <span class="comment">// also handle displays that changed</span></span><br><span class="line">        <span class="comment">// (ie: displays that are in both lists)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;dc ; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">ssize_t</span> j = curr.indexOfKey(draw.keyAt(i));</span><br><span class="line">            <span class="keyword">if</span> (j &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// in drawing state but not in current state</span></span><br><span class="line">                <span class="keyword">if</span> (!draw[i].isMainDisplay()) &#123;</span><br><span class="line">                    <span class="comment">// Call makeCurrent() on the primary display so we can</span></span><br><span class="line">                    <span class="comment">// be sure that nothing associated with this display</span></span><br><span class="line">                    <span class="comment">// is current.</span></span><br><span class="line">                    <span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt; defaultDisplay(getDefaultDisplayDevice());</span><br><span class="line">                    defaultDisplay-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw(getDisplayDevice(draw.keyAt(i)));</span><br><span class="line">                    <span class="keyword">if</span> (hw != <span class="literal">NULL</span>)</span><br><span class="line">                        hw-&gt;disconnect(getHwComposer());</span><br><span class="line">                    <span class="keyword">if</span> (draw[i].type &lt; DisplayDevice::NUM_BUILTIN_DISPLAY_TYPES)</span><br><span class="line">                        mEventThread-&gt;onHotplugReceived(draw[i].type, <span class="literal">false</span>);</span><br><span class="line">                    mDisplays.removeItem(draw.keyAt(i));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGW(<span class="string">"trying to remove the main display"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// this display is in both lists. see if something changed.</span></span><br><span class="line">                <span class="keyword">const</span> DisplayDeviceState&amp; state(curr[j]);</span><br><span class="line">                <span class="keyword">const</span> wp&lt;IBinder&gt;&amp; display(curr.keyAt(j));</span><br><span class="line">                <span class="keyword">const</span> sp&lt;IBinder&gt; state_binder = IInterface::asBinder(state.surface);</span><br><span class="line">                <span class="keyword">const</span> sp&lt;IBinder&gt; draw_binder = IInterface::asBinder(draw[i].surface);</span><br><span class="line">                <span class="keyword">if</span> (state_binder != draw_binder) &#123;</span><br><span class="line">                    <span class="comment">// changing the surface is like destroying and</span></span><br><span class="line">                    <span class="comment">// recreating the DisplayDevice, so we just remove it</span></span><br><span class="line">                    <span class="comment">// from the drawing state, so that it get re-added</span></span><br><span class="line">                    <span class="comment">// below.</span></span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw(getDisplayDevice(display));</span><br><span class="line">                    <span class="keyword">if</span> (hw != <span class="literal">NULL</span>)</span><br><span class="line">                        hw-&gt;disconnect(getHwComposer());</span><br><span class="line">                    mDisplays.removeItem(display);</span><br><span class="line">                    mDrawingState.displays.removeItemsAt(i);</span><br><span class="line">                    dc--; i--;</span><br><span class="line">                    <span class="comment">// at this point we must loop to the next item</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> sp&lt;DisplayDevice&gt; disp(getDisplayDevice(display));</span><br><span class="line">                <span class="keyword">if</span> (disp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (state.layerStack != draw[i].layerStack) &#123;</span><br><span class="line">                        disp-&gt;setLayerStack(state.layerStack);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((state.orientation != draw[i].orientation)</span><br><span class="line">                            || (state.viewport != draw[i].viewport)</span><br><span class="line">                            || (state.frame != draw[i].frame))</span><br><span class="line">                    &#123;</span><br><span class="line">                        disp-&gt;setProjection(state.orientation,</span><br><span class="line">                                state.viewport, state.frame);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (state.width != draw[i].width || state.height != draw[i].height) &#123;</span><br><span class="line">                        disp-&gt;setDisplaySize(state.width, state.height);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// find displays that were added</span></span><br><span class="line">        <span class="comment">// (ie: in current state but not in drawing state)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;cc ; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (draw.indexOfKey(curr.keyAt(i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="function"><span class="keyword">const</span> DisplayDeviceState&amp; <span class="title">state</span><span class="params">(curr[i])</span></span>;</span><br><span class="line"></span><br><span class="line">                sp&lt;DisplaySurface&gt; dispSurface;</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt; bqProducer;</span><br><span class="line">                sp&lt;IGraphicBufferConsumer&gt; bqConsumer;</span><br><span class="line">                BufferQueue::createBufferQueue(&amp;bqProducer, &amp;bqConsumer,</span><br><span class="line">                        <span class="keyword">new</span> GraphicBufferAlloc());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int32_t</span> hwcDisplayId = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">if</span> (state.isVirtualDisplay()) &#123;</span><br><span class="line">                    <span class="comment">// Virtual displays without a surface are dormant:</span></span><br><span class="line">                    <span class="comment">// they have external state (layer stack, projection,</span></span><br><span class="line">                    <span class="comment">// etc.) but no internal state (i.e. a DisplayDevice).</span></span><br><span class="line">                    <span class="keyword">if</span> (state.surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">int</span> width = <span class="number">0</span>;</span><br><span class="line">                        DisplayUtils* displayUtils = DisplayUtils::getInstance();</span><br><span class="line">                        <span class="keyword">int</span> status = state.surface-&gt;query(</span><br><span class="line">                                NATIVE_WINDOW_WIDTH, &amp;width);</span><br><span class="line">                        ALOGE_IF(status != NO_ERROR,</span><br><span class="line">                                <span class="string">"Unable to query width (%d)"</span>, status);</span><br><span class="line">                        <span class="keyword">int</span> height = <span class="number">0</span>;</span><br><span class="line">                        status = state.surface-&gt;query(</span><br><span class="line">                            NATIVE_WINDOW_HEIGHT, &amp;height);</span><br><span class="line">                        ALOGE_IF(status != NO_ERROR,</span><br><span class="line">                            <span class="string">"Unable to query height (%d)"</span>, status);</span><br><span class="line">                        <span class="keyword">if</span> (MAX_VIRTUAL_DISPLAY_DIMENSION == <span class="number">0</span> ||</span><br><span class="line">                            (width &lt;= MAX_VIRTUAL_DISPLAY_DIMENSION &amp;&amp;</span><br><span class="line">                             height &lt;= MAX_VIRTUAL_DISPLAY_DIMENSION)) &#123;</span><br><span class="line">                            <span class="keyword">int</span> usage = <span class="number">0</span>;</span><br><span class="line">                            status = state.surface-&gt;query(</span><br><span class="line">                                NATIVE_WINDOW_CONSUMER_USAGE_BITS, &amp;usage);</span><br><span class="line">                            ALOGW_IF(status != NO_ERROR,</span><br><span class="line">                                <span class="string">"Unable to query usage (%d)"</span>, status);</span><br><span class="line">                            <span class="keyword">if</span> ( (status == NO_ERROR) &amp;&amp;</span><br><span class="line">                                  displayUtils-&gt;canAllocateHwcDisplayIdForVDS(usage)) &#123;</span><br><span class="line">                                hwcDisplayId = allocateHwcDisplayId(state.type);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        displayUtils-&gt;initVDSInstance(mHwc, hwcDisplayId, state.surface,</span><br><span class="line">                                dispSurface, producer, bqProducer, bqConsumer,</span><br><span class="line">                                state.displayName, state.isSecure, state.type);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGE_IF(state.surface!=<span class="literal">NULL</span>,</span><br><span class="line">                            <span class="string">"adding a supported display, but rendering "</span></span><br><span class="line">                            <span class="string">"surface is provided (%p), ignoring it"</span>,</span><br><span class="line">                            state.surface.get());</span><br><span class="line">                    hwcDisplayId = allocateHwcDisplayId(state.type);</span><br><span class="line">                    <span class="comment">// for supported (by hwc) displays we provide our</span></span><br><span class="line">                    <span class="comment">// own rendering surface</span></span><br><span class="line">                    dispSurface = <span class="keyword">new</span> FramebufferSurface(*mHwc, state.type,</span><br><span class="line">                            bqConsumer);</span><br><span class="line">                    producer = bqProducer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> wp&lt;IBinder&gt;&amp; display(curr.keyAt(i));</span><br><span class="line">                <span class="keyword">if</span> (dispSurface != <span class="literal">NULL</span> &amp;&amp; producer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw = <span class="keyword">new</span> DisplayDevice(<span class="keyword">this</span>,</span><br><span class="line">                            state.type, hwcDisplayId,</span><br><span class="line">                            mHwc-&gt;getFormat(hwcDisplayId), state.isSecure,</span><br><span class="line">                            display, dispSurface, producer,</span><br><span class="line">                            mRenderEngine-&gt;getEGLConfig());</span><br><span class="line">                    hw-&gt;setLayerStack(state.layerStack);</span><br><span class="line">                    hw-&gt;setProjection(state.orientation,</span><br><span class="line">                            state.viewport, state.frame);</span><br><span class="line">                    hw-&gt;setDisplayName(state.displayName);</span><br><span class="line">                    <span class="comment">// When a new display device is added update the active</span></span><br><span class="line">                    <span class="comment">// config by querying HWC otherwise the default config</span></span><br><span class="line">                    <span class="comment">// (config 0) will be used.</span></span><br><span class="line">                    <span class="keyword">if</span> (hwcDisplayId &gt;= DisplayDevice::DISPLAY_PRIMARY &amp;&amp;</span><br><span class="line">                            hwcDisplayId &lt; DisplayDevice::NUM_BUILTIN_DISPLAY_TYPES) &#123;</span><br><span class="line">                        <span class="keyword">int</span> activeConfig = mHwc-&gt;getActiveConfig(hwcDisplayId);</span><br><span class="line">                        <span class="keyword">if</span> (activeConfig &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            hw-&gt;setActiveConfig(activeConfig);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mDisplays.add(display, hw);</span><br><span class="line">                    <span class="keyword">if</span> (state.isVirtualDisplay()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (hwcDisplayId &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            mHwc-&gt;setVirtualDisplayProperties(hwcDisplayId,</span><br><span class="line">                                    hw-&gt;getWidth(), hw-&gt;getHeight(),</span><br><span class="line">                                    hw-&gt;getFormat());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mEventThread-&gt;onHotplugReceived(state.type, <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–ï¼Œåˆ†æˆ3ç§æƒ…å†µï¼š 1.æ˜¾ç¤ºè®¾å¤‡å‡å°‘äº†ï¼Œéœ€è¦æŠŠæ˜¾ç¤ºè®¾å¤‡å¯¹åº”çš„DisplayDeviceç§»é™¤ 2.æ˜¾ç¤ºè®¾å¤‡å‘ç”Ÿäº†å˜åŒ–ï¼Œä¾‹å¦‚ç”¨æˆ·è®¾ç½®äº†Surfaceã€é‡æ–°è®¾ç½®äº†layerStackã€æ—‹è½¬äº†å±å¹•ç­‰ï¼Œè¿™å°±éœ€è¦é‡æ–°è®¾ç½®æ˜¾ç¤ºå¯¹è±¡çš„å±æ€§ 3.æ˜¾ç¤ºè®¾å¤‡å¢åŠ äº†ï¼Œåˆ›å»ºæ–°çš„DisplayDeviceåŠ å…¥ç³»ç»Ÿä¸­ã€‚</p><h3 id="2-3-3ã€è®¾ç½®TransfromHit"><a href="#2-3-3ã€è®¾ç½®TransfromHit" class="headerlink" title="2.3.3ã€è®¾ç½®TransfromHit"></a>2.3.3ã€è®¾ç½®TransfromHit</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (transactionFlags &amp; (eTraversalNeeded|eDisplayTransactionNeeded)) &#123;</span><br><span class="line">    ......</span><br><span class="line">    sp&lt;<span class="keyword">const</span> DisplayDevice&gt; disp;</span><br><span class="line">    <span class="keyword">uint32_t</span> currentlayerStack = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> we rely on the fact that layers are sorted by</span></span><br><span class="line">        <span class="comment">// layerStack first (so we don't have to traverse the list</span></span><br><span class="line">        <span class="comment">// of displays for every layer).</span></span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">        <span class="keyword">uint32_t</span> layerStack = layer-&gt;getDrawingState().layerStack;</span><br><span class="line">        <span class="keyword">if</span> (i==<span class="number">0</span> || currentlayerStack != layerStack) &#123;</span><br><span class="line">            currentlayerStack = layerStack;</span><br><span class="line">            <span class="comment">// figure out if this layerstack is mirrored</span></span><br><span class="line">            <span class="comment">// (more than one display) if so, pick the default display,</span></span><br><span class="line">            <span class="comment">// if not, pick the only display it's on.</span></span><br><span class="line">            disp.clear();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">                sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">                <span class="keyword">if</span> (hw-&gt;getLayerStack() == currentlayerStack) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (disp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        disp = hw;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        disp = <span class="literal">NULL</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (disp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> TEMPORARY FIX ONLY. Real fix should cause layers to</span></span><br><span class="line">            <span class="comment">// redraw after transform hint changes. See bug 8508397.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// could be null when this layer is using a layerStack</span></span><br><span class="line">            <span class="comment">// that is not visible on any display. Also can occur at</span></span><br><span class="line">            <span class="comment">// screen off/on times.</span></span><br><span class="line">            disp = getDefaultDisplayDevice();</span><br><span class="line">        &#125;</span><br><span class="line">        layer-&gt;updateTransformHint(disp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯æ ¹æ®æ¯ç§æ˜¾ç¤ºè®¾å¤‡çš„ä¸åŒï¼Œè®¾ç½®å’Œæ˜¾ç¤ºè®¾å¤‡å…³è”åœ¨ä¸€èµ·çš„Layerï¼ˆä¸»è¦çœ‹Layerçš„layerStackæ˜¯å¦å’ŒDisplayDeviceçš„layerStackï¼‰çš„TransformHintï¼ˆä¸»è¦æŒ‡è®¾å¤‡çš„æ˜¾ç¤ºæ–¹å‘orientationï¼‰ã€‚</p><h3 id="2-3-4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ"><a href="#2-3-4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ" class="headerlink" title="2.3.4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ"></a>2.3.4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Perform our own transaction if needed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">if</span> (currentLayers.size() &gt; layers.size()) &#123;</span><br><span class="line">    <span class="comment">// layers have been added</span></span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// some layers might have been removed, so</span></span><br><span class="line"><span class="comment">// we need to update the regions they're exposing.</span></span><br><span class="line"><span class="keyword">if</span> (mLayersRemoved) &#123;</span><br><span class="line">    mLayersRemoved = <span class="literal">false</span>;</span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">        <span class="keyword">if</span> (currentLayers.indexOf(layer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// this layer is not visible anymore</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> we could traverse the tree from front to back and</span></span><br><span class="line">            <span class="comment">//       compute the actual visible region</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> we could cache the transformed region</span></span><br><span class="line">            const Layer::State&amp; s(layer-&gt;getDrawingState());</span><br><span class="line">            Region visibleReg = s.active.transform.transform(</span><br><span class="line">                    Region(Rect(s.active.w, s.active.h)));</span><br><span class="line">            invalidateLayerStack(s.layerStack, visibleReg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¤„ç†Layerçš„å¢åŠ æƒ…å†µï¼Œå¦‚æœLayerå¢åŠ äº†ï¼Œéœ€è¦é‡æ–°è®¡ç®—è®¾å¤‡çš„æ›´æ–°åŒºåŸŸï¼Œå› æ­¤æŠŠmVisibleRegionsDirtyè®¾ä¸ºtrueï¼Œå¦‚æœLayeråˆ é™¤äº†ï¼Œéœ€è¦æŠŠLayerçš„å¯è§åŒºåŸŸåŠ å…¥åˆ°ç³»ç»Ÿéœ€è¦æ›´æ–°çš„åŒºåŸŸä¸­ã€‚</p><h3 id="2-3-5ã€è®¾ç½®mDrawingState"><a href="#2-3-5ã€è®¾ç½®mDrawingState" class="headerlink" title="2.3.5ã€è®¾ç½®mDrawingState"></a>2.3.5ã€è®¾ç½®mDrawingState</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">commitTransaction();</span><br><span class="line">updateCursorAsync();</span><br></pre></td></tr></table></figure><p>è°ƒç”¨commitTransactionå’ŒupdateCursorAsyncå‡½æ•° commitTransactionå‡½æ•°ä½œç”¨æ˜¯æŠŠmDrawingStateçš„å€¼è®¾ç½®æˆmCurrentStateçš„å€¼ã€‚è€ŒupdateCursorAsyncå‡½æ•°ä¼šæ›´æ–°æ‰€æœ‰æ˜¾ç¤ºè®¾å¤‡ä¸­å…‰æ ‡çš„ä½ç½®ã€‚</p><p>2.3.6 å°ç»“ handleTransactionå‡½æ•°çš„ä½œç”¨çš„å°±æ˜¯å¤„ç†ç³»ç»Ÿåœ¨ä¸¤æ¬¡åˆ·æ–°æœŸé—´çš„å„ç§å˜åŒ–ã€‚SurfaceFlingeræ¨¡å—ä¸­ä¸ç®¡æ˜¯SurfaceFlingerç±»è¿˜æ˜¯Layerç±»ï¼Œéƒ½é‡‡ç”¨äº†åŒç¼“å†²çš„æ–¹å¼æ¥ä¿å­˜ä»–ä»¬çš„å±æ€§ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯åˆšæ”¹å˜SurfaceFlingerå¯¹è±¡æˆ–è€…Layerç±»å¯¹è±¡çš„å±æ€§æ˜¯ï¼Œä¸éœ€è¦ä¸Šé”ï¼Œå¤§å¤§çš„æé«˜äº†ç³»ç»Ÿæ•ˆç‡ã€‚åªæœ‰åœ¨æœ€åçš„å›¾åƒè¾“å‡ºæ˜¯ï¼Œæ‰è¿›è¡Œä¸€æ¬¡ä¸Šé”ï¼Œå¹¶è¿›è¡Œå†…å­˜çš„å±æ€§å˜åŒ–å¤„ç†ã€‚æ­£å› æ­¤ï¼Œåº”ç”¨è¿›ç¨‹å¿…é¡»æ”¶åˆ°VSyncä¿¡å·æ‰å¼€å§‹æ”¹å˜Surfaceçš„å†…å®¹ã€‚</p><h2 id="2-4ã€handlePageFlipå‡½æ•°"><a href="#2-4ã€handlePageFlipå‡½æ•°" class="headerlink" title="2.4ã€handlePageFlipå‡½æ•°"></a>2.4ã€handlePageFlipå‡½æ•°</h2><p>handlePageFlipå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> SurfaceFlinger::handlePageFlip()</span><br><span class="line">&#123;</span><br><span class="line">Region dirtyRegion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> visibleRegions = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">bool</span> frameQueued = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store the set of layers that need updates. This set must not change as</span></span><br><span class="line"><span class="comment">// buffers are being latched, as this could result in a deadlock.</span></span><br><span class="line"><span class="comment">// Example: Two producers share the same command stream and:</span></span><br><span class="line"><span class="comment">// 1.) Layer 0 is latched</span></span><br><span class="line"><span class="comment">// 2.) Layer 0 gets a new frame</span></span><br><span class="line"><span class="comment">// 2.) Layer 1 gets a new frame</span></span><br><span class="line"><span class="comment">// 3.) Layer 1 is latched.</span></span><br><span class="line"><span class="comment">// Display is now waiting on Layer 1's frame, which is behind layer 0's</span></span><br><span class="line"><span class="comment">// second frame. But layer 0's second frame could be waiting on display.</span></span><br><span class="line">Vector&lt;Layer*&gt; layersWithQueuedFrames;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, count = layers.size(); i&lt;count ; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">    <span class="keyword">if</span> (layer-&gt;hasQueuedFrame()) &#123;</span><br><span class="line">        frameQueued = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (layer-&gt;shouldPresentNow(mPrimaryDispSync)) &#123;</span><br><span class="line">            layersWithQueuedFrames.push_back(layer.get());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            layer-&gt;useEmptyDamage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        layer-&gt;useEmptyDamage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, count = layersWithQueuedFrames.size() ; i&lt;count ; i++) &#123;</span><br><span class="line">    Layer* layer = layersWithQueuedFrames[i];</span><br><span class="line">    const Region dirty(layer-&gt;latchBuffer(visibleRegions));</span><br><span class="line">    layer-&gt;useSurfaceDamage();</span><br><span class="line">    const Layer::State&amp; s(layer-&gt;getDrawingState());</span><br><span class="line">    invalidateLayerStack(s.layerStack, dirty);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mVisibleRegionsDirty |= visibleRegions;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we will need to wake up at some time in the future to deal with a</span></span><br><span class="line"><span class="comment">// queued frame that shouldn't be displayed during this vsync period, wake</span></span><br><span class="line"><span class="comment">// up during the next vsync period to check again.</span></span><br><span class="line"><span class="keyword">if</span> (frameQueued &amp;&amp; layersWithQueuedFrames.empty()) &#123;</span><br><span class="line">    signalLayerUpdate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only continue with the refresh if there is actually new work to do</span></span><br><span class="line"><span class="keyword">return</span> !layersWithQueuedFrames.empty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handlePageFlipå‡½æ•°å…ˆè°ƒç”¨æ¯ä¸ªLayerå¯¹è±¡çš„hasQueuedFrameå‡½æ•°ï¼Œç¡®å®šè¿™ä¸ªLayerå¯¹è±¡æ˜¯å¦æœ‰éœ€è¦æ›´æ–°çš„å›¾å±‚ï¼Œç„¶åæŠŠéœ€è¦æ›´æ–°çš„Layerå¯¹è±¡æ”¾åˆ°layersWithQueuedFramesä¸­ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹Layerçš„hasQueuedFrameæ–¹æ³•å°±æ˜¯çœ‹å…¶mQueuedFramesæ˜¯å¦å¤§äº0 å’ŒmSidebandStreamChangedã€‚å‰é¢å°èŠ‚åˆ†æåªè¦Surfaceæœ‰æ•°æ®å†™å…¥ï¼Œå°±ä¼šè°ƒç”¨Layerçš„onFrameAvailableå‡½æ•°ï¼Œç„¶åmQueuedFrameså€¼åŠ 1. ç»§ç»­çœ‹handlePageFlipå‡½æ•°ï¼Œæ¥ç€è°ƒç”¨éœ€è¦æ›´æ–°çš„Layerå¯¹è±¡çš„latchBufferå‡½æ•°ï¼Œç„¶åæ ¹æ®è¿”å›çš„æ›´æ–°åŒºåŸŸè°ƒç”¨invalidateLayerStackå‡½æ•°æ¥è®¾ç½®æ›´æ–°è®¾å¤‡å¯¹è±¡çš„æ›´æ–°åŒºåŸŸã€‚ ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹latchBufferå‡½æ•°</p><p>LatchBufferå‡½æ•°è°ƒç”¨updateTextImageæ¥å¾—åˆ°éœ€è¦çš„å›¾åƒã€‚è¿™é‡Œå‚æ•°ræ˜¯Rejectå¯¹è±¡ï¼Œå…¶ä½œç”¨æ˜¯åˆ¤æ–­åœ¨ç¼“å†²åŒºçš„å°ºå¯¸æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚è°ƒç”¨updateTextImageå‡½æ•°å¦‚æœå¾—åˆ°çš„ç»“æœæ˜¯PRESENT_LATER,è¡¨ç¤ºæ¨è¿Ÿå¤„ç†ï¼Œç„¶åè°ƒç”¨signalLayerUpdateå‡½æ•°æ¥å‘é€invalidateæ¶ˆæ¯ï¼Œè¿™æ¬¡ç»˜åˆ¶è¿‡ç¨‹å°±ä¸å¤„ç†è¿™ä¸ªSurfaceçš„å›¾åƒäº†ã€‚ å¦‚æœä¸éœ€è¦æ¨è¿Ÿå¤„ç†ï¼ŒæŠŠmQueuedFramesçš„å€¼å‡1. æœ€åLatchBufferå‡½æ•°è°ƒç”¨mSurfaceFlingerConsumerçš„getCurrentBufferæ¥å–å›å½“å‰çš„å›¾åƒç¼“å†²åŒºæŒ‡é’ˆï¼Œä¿å­˜åœ¨mActiveBufferä¸­ã€‚</p><h3 id="2-5-å°ç»“"><a href="#2-5-å°ç»“" class="headerlink" title="2.5 å°ç»“"></a>2.5 å°ç»“</h3><p>è¿™æ ·ç»è¿‡handleTransaction handlePageFlipä¸¤ä¸ªå‡½æ•°å¤„ç†ï¼ŒSurfaceFlingerä¸­æ— è®ºæ˜¯Layerå±æ€§çš„å˜åŒ–è¿˜æ˜¯å›¾åƒçš„å˜åŒ–éƒ½å¤„ç†å¥½äº†ï¼Œåªç­‰VSyncä¿¡å·åˆ°æ¥å°±å¯ä»¥è¾“å‡ºäº†ã€‚</p><h2 id="ä¸‰ã€rebuildLayerStackså‡½æ•°"><a href="#ä¸‰ã€rebuildLayerStackså‡½æ•°" class="headerlink" title="ä¸‰ã€rebuildLayerStackså‡½æ•°"></a>ä¸‰ã€rebuildLayerStackså‡½æ•°</h2><p>å‰é¢ä»‹ç»ï¼ŒVSyncä¿¡å·åˆ°æ¥åï¼Œå…ˆæ˜¯è°ƒç”¨äº†rebuildLayerStackså‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::rebuildLayerStacks() &#123;</span><br><span class="line">updateExtendedMode();</span><br><span class="line"><span class="comment">// rebuild the visible layer list per screen</span></span><br><span class="line"><span class="keyword">if</span> (CC_UNLIKELY(mVisibleRegionsDirty)) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">false</span>;</span><br><span class="line">    invalidateHwcGeometry();</span><br><span class="line">    <span class="comment">//è®¡ç®—æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡ä¸Šå¯è§çš„Layer  </span></span><br><span class="line">    <span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        Region opaqueRegion;</span><br><span class="line">        Region dirtyRegion;</span><br><span class="line">        Vector&lt; sp&lt;Layer&gt; &gt; layersSortedByZ;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; hw(mDisplays[dpy]);</span><br><span class="line">        const Transform&amp; tr(hw-&gt;getTransform());</span><br><span class="line">        const Rect bounds(hw-&gt;getBounds());</span><br><span class="line">        <span class="keyword">if</span> (hw-&gt;isDisplayOn()) &#123;</span><br><span class="line">            <span class="comment">//è®¡ç®—æ¯ä¸ªlayerçš„å¯è§åŒºåŸŸï¼Œç¡®å®šè®¾å¤‡éœ€è¦é‡æ–°ç»˜åˆ¶çš„åŒºåŸŸ  </span></span><br><span class="line">            computeVisibleRegions(hw-&gt;getHwcDisplayId(), layers,</span><br><span class="line">                    hw-&gt;getLayerStack(), dirtyRegion, opaqueRegion);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//åªéœ€è¦å’Œæ˜¾ç¤ºè®¾å¤‡çš„LayerStackç›¸åŒçš„layer  </span></span><br><span class="line">                    <span class="function">Region <span class="title">drawRegion</span><span class="params">(tr.transform(</span></span></span><br><span class="line">                            layer-&gt;visibleNonTransparentRegion));</span><br><span class="line">                    drawRegion.andSelf(bounds);</span><br><span class="line">                    <span class="keyword">if</span> (!drawRegion.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœLayerçš„æ˜¾ç¤ºåŒºåŸŸå’Œæ˜¾ç¤ºè®¾å¤‡çš„çª—å£æœ‰äº¤é›†  </span></span><br><span class="line">                        <span class="comment">//æŠŠLayeråŠ å…¥åˆ—è¡¨ä¸­</span></span><br><span class="line">                        layersSortedByZ.add(layer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è®¾ç½®æ˜¾ç¤ºè®¾å¤‡çš„å¯è§Layeråˆ—è¡¨  </span></span><br><span class="line">        hw-&gt;setVisibleLayersSortedByZ(layersSortedByZ);</span><br><span class="line">        hw-&gt;undefinedRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        hw-&gt;undefinedRegion.subtractSelf(tr.transform(opaqueRegion));</span><br><span class="line">        hw-&gt;dirtyRegion.orSelf(dirtyRegion);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>rebuildLayerStackså‡½æ•°çš„ä½œç”¨æ˜¯é‡å»ºæ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„å¯è§layerå¯¹è±¡åˆ—è¡¨ã€‚å¯¹äºæŒ‰æ˜¾ç¤ºè½´ï¼ˆZè½´ï¼‰æ’åˆ—çš„Layerå¯¹è±¡ï¼Œæ’åœ¨æœ€å‰é¢çš„å½“ç„¶ä¼šä¼˜å…ˆæ˜¾ç¤ºï¼Œä½†æ˜¯Layerå›¾åƒå¯èƒ½æœ‰é€æ˜åŸŸï¼Œä¹Ÿå¯èƒ½æœ‰å°ºå¯¸æ²¡æœ‰è¦†ç›–æ•´ä¸ªå±å¹•ï¼Œå› æ­¤ä¸‹é¢çš„layerä¹Ÿæœ‰æ˜¾ç¤ºçš„æœºä¼šã€‚rebuildLayerStackså‡½æ•°å¯¹æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡ï¼Œå…ˆè®¡ç®—å’Œæ˜¾ç¤ºè®¾å¤‡å…·æœ‰ç›¸åŒlayerStackå€¼çš„Layerå¯¹è±¡åœ¨è¯¥æ˜¾ç¤ºè®¾å¤‡ä¸Šçš„å¯è§åŒºåŸŸã€‚ç„¶åå°†å¯è§åŒºåŸŸå’Œæ˜¾ç¤ºè®¾å¤‡çš„çª—å£åŒºåŸŸæœ‰äº¤é›†çš„layerç»„æˆä¸€ä¸ªæ–°çš„åˆ—è¡¨ï¼Œæœ€åæŠŠè¿™ä¸ªåˆ—è¡¨è®¾ç½®åˆ°æ˜¾ç¤ºè®¾å¤‡å¯¹è±¡ä¸­ã€‚ computeVisibleRegionså‡½æ•°é¦–å…ˆè®¡ç®—æ¯ä¸ªLayeråœ¨è®¾å¤‡ä¸Šçš„å¯è§åŒºåŸŸvisibleRegionã€‚è®¡ç®—æ–¹æ³•å°±æ˜¯ç”¨æ•´ä¸ªLayerçš„åŒºåŸŸå‡å»ä¸Šå±‚æ‰€æœ‰ä¸é€æ˜åŒºåŸŸaboveOpaqueLayersã€‚è€Œä¸Šå±‚æ‰€æœ‰ä¸é€æ˜åŒºåŸŸå€¼æ˜¯ä¸€ä¸ªé€å±‚ç´¯è®¡çš„è¿‡ç¨‹ï¼Œæ¯å±‚éƒ½éœ€è¦æŠŠè‡ªå·±çš„ä¸é€æ˜åŒºåŸŸç´¯åŠ åˆ°aboveOpaqueLayersä¸­ã€‚ è€Œæ¯å±‚çš„ä¸é€æ˜åŒºåŸŸçš„è®¡ç®—æ–¹æ³•ï¼šå¦‚æœLayerçš„alphaçš„å€¼ä¸º255ï¼Œå¹¶ä¸”layerçš„isOpaqueå‡½æ•°ä¸ºtrueï¼Œåˆ™æœ¬å±‚çš„ä¸é€æ˜åŒºåŸŸç­‰äºLayeræ‰€åœ¨åŒºåŸŸï¼Œå¦åˆ™ä¸º0.è¿™æ ·ä¸€å±‚å±‚ç®—ä¸‹æ¥ï¼Œå°±å¾ˆå®¹æ˜“å¾—åˆ°æ¯å±‚çš„å¯è§åŒºåŸŸå¤§å°äº†ã€‚ å…¶æ¬¡ï¼Œè®¡ç®—æ•´ä¸ªæ˜¾ç¤ºè®¾å¤‡éœ€è¦æ›´æ–°çš„åŒºåŸŸoutDirtyRegionã€‚outDirtyRegionçš„å€¼ä¹Ÿæ˜¯ç´¯è®¡æ‰€æœ‰å±‚çš„éœ€è¦é‡å›çš„åŒºåŸŸå¾—åˆ°çš„ã€‚å¦‚æœLayerä¸­çš„æ˜¾ç¤ºå†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™æ•´ä¸ªå¯è§åŒºåŸŸvisibleRegionéƒ½éœ€è¦æ›´æ–°ï¼ŒåŒæ—¶è¿˜è¦åŒ…æ‹¬ä¸Šä¸€æ¬¡çš„å¯è§åŒºåŸŸï¼Œç„¶ååœ¨å»æ‰è¢«ä¸Šå±‚è¦†ç›–åçš„åŒºåŸŸå¾—åˆ°çš„å°±æ˜¯Layeréœ€è¦æ›´æ–°çš„åŒºåŸŸã€‚å¦‚æœLayeræ˜¾ç¤ºçš„å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯è€ƒè™‘åˆ°çª—å£å¤§å°çš„å˜åŒ–æˆ–è€…ä¸Šå±‚çª—å£çš„å˜åŒ–ï¼Œå› æ­¤Layerä¸­è¿˜æ˜¯æœ‰åŒºåŸŸå¯ä»¥éœ€è¦é‡ç»˜çš„åœ°æ–¹ã€‚è¿™ç§æƒ…å†µä¸‹æœ€ç®€å•çš„ç®—æ³•æ˜¯ç”¨Layerè®¡ç®—å‡ºå¯è§åŒºåŸŸå‡å»ä»¥å‰çš„å¯è§åŒºåŸŸå°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨computeVisibleRegionså‡½æ•°è¿˜å¼•å…¥äº†è¢«è¦†ç›–åŒºåŸŸï¼Œé€šå¸¸è¢«è¦†ç›–åŒºåŸŸå’Œå¯è§åŒºåŸŸå¹¶ä¸é‡å¤ï¼Œå› æ­¤å‡½æ•°ä¸­è®¡ç®—æš´éœ²åŒºåŸŸæ˜¯ç”¨å¯è§åŒºåŸŸå‡å»è¢«è¦†ç›–åŒºåŸŸçš„ã€‚</p><h3 id="å››ã€setUpHWComposerå‡½æ•°"><a href="#å››ã€setUpHWComposerå‡½æ•°" class="headerlink" title="å››ã€setUpHWComposerå‡½æ•°"></a>å››ã€setUpHWComposerå‡½æ•°</h3><p>setUpHWComposerå‡½æ•°çš„ä½œç”¨æ˜¯æ›´æ–°HWComposerå¯¹è±¡ä¸­å›¾å±‚å¯¹è±¡åˆ—è¡¨ä»¥åŠå›¾å±‚å±æ€§ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::setUpHWComposer() &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    <span class="keyword">bool</span> dirty = !mDisplays[dpy]-&gt;getDirtyRegion(<span class="literal">false</span>).isEmpty();</span><br><span class="line">    <span class="keyword">bool</span> empty = mDisplays[dpy]-&gt;getVisibleLayersSortedByZ().size() == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> wasEmpty = !mDisplays[dpy]-&gt;lastCompositionHadVisibleLayers;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">bool</span> mustRecompose = dirty &amp;&amp; !(empty &amp;&amp; wasEmpty);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    mDisplays[dpy]-&gt;beginFrame(mustRecompose);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mustRecompose) &#123;</span><br><span class="line">        mDisplays[dpy]-&gt;lastCompositionHadVisibleLayers = !empty;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¾—åˆ°ç³»ç»ŸHWComposerå¯¹è±¡  </span></span><br><span class="line">HWComposer&amp; hwc(getHwComposer());</span><br><span class="line"><span class="keyword">if</span> (hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">    <span class="comment">// build the h/w work list</span></span><br><span class="line">    <span class="keyword">if</span> (CC_UNLIKELY(mHwWorkListDirty)) &#123;</span><br><span class="line">        mHwWorkListDirty = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">            sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">            <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                    hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">                <span class="comment">//æ ¹æ®Layeræ•°é‡åœ¨HWComposerä¸­åˆ›å»ºhwc_layer_list_tåˆ—è¡¨  </span></span><br><span class="line">                <span class="keyword">if</span> (hwc.createWorkList(id, count) == NO_ERROR) &#123;</span><br><span class="line">                    HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">                    <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                        layer-&gt;setGeometry(hw, *cur);</span><br><span class="line">                        <span class="keyword">if</span> (mDebugDisableHWC || mDebugRegion || mDaltonize || mHasColorMatrix) &#123;</span><br><span class="line">                            cur-&gt;setSkip(<span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the per-frame data</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">        <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">bool</span> freezeSurfacePresent = <span class="literal">false</span>;</span><br><span class="line">            isfreezeSurfacePresent(freezeSurfacePresent, hw, id);</span><br><span class="line">            <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">            HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">            <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * update the per-frame h/w composer data for each layer</span></span><br><span class="line"><span class="comment">                 * and build the transparent region of the FB</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                <span class="comment">//å°†Layerçš„mActiveBufferè®¾ç½®åˆ°HWComposerä¸­</span></span><br><span class="line">                layer-&gt;setPerFrameData(hw, *cur);</span><br><span class="line">                setOrientationEventControl(freezeSurfacePresent,id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If possible, attempt to use the cursor overlay on each display.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">        <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">            HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">            <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                <span class="keyword">if</span> (layer-&gt;isPotentialCursor()) &#123;</span><br><span class="line">                    cur-&gt;setIsCursorLayerHint();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dumpDrawCycle(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = hwc.prepare();</span><br><span class="line">    ALOGE_IF(err, <span class="string">"HWComposer::prepare failed (%s)"</span>, strerror(-err));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        hw-&gt;prepareFrame(hwc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HWComposerä¸­æœ‰ä¸€ä¸ªç±»å‹ä¸ºDisplayDataç»“æ„çš„æ•°ç»„mDisplayDataï¼Œå®ƒç»´æŠ¤ç€æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„ä¿¡æ¯ã€‚DisplayDataç»“æ„ä¸­æœ‰ä¸€ä¸ªç±»å‹ä¸ºhwc_display_contents_lå­—æ®µlistï¼Œè¿™ä¸ªå­—æ®µåˆæœ‰ä¸€ä¸ªhwc_layer_lç±»å‹çš„æ•°ç»„hwLayersï¼Œè®°å½•è¯¥æ˜¾ç¤ºè®¾å¤‡æ‰€æœ‰éœ€è¦è¾“å‡ºçš„Layerä¿¡æ¯ã€‚ setUpHWComposerå‡½æ•°è°ƒç”¨HWComposerçš„createWorkListå‡½æ•°å°±æ˜¯æ ¹æ®æ¯ç§æ˜¾ç¤ºè®¾å¤‡çš„Layeræ•°é‡ï¼Œåˆ›å»ºå’Œåˆå§‹åŒ–hwc_display_contents_lå¯¹è±¡å’Œhwc_layer_læ•°ç»„ åˆ›å»ºå®ŒHWComposerä¸­çš„åˆ—è¡¨åï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹æ¯ä¸ªLayerå¯¹è±¡è°ƒç”¨å®ƒçš„setPerFrameDataå‡½æ•°ï¼Œå‚æ•°æ˜¯HWComposerå’ŒHWCLayerInterfaceã€‚setPerFrameDataå‡½æ•°å°†Layerå¯¹è±¡çš„å½“å‰å›¾åƒç¼“å†²åŒºmActiveBufferè®¾ç½®åˆ°HWCLayerInterfaceå¯¹è±¡å¯¹åº”çš„hwc_layer_lå¯¹è±¡ä¸­ã€‚ HWComposerç±»ä¸­é™¤äº†å‰é¢ä»‹ç»çš„Grallocè¿˜ç®¡ç†ç€Composeræ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—å®ç°äº†ç¡¬ä»¶çš„å›¾åƒåˆæˆåŠŸèƒ½ã€‚setUpHWComposerå‡½æ•°æ¥ä¸‹æ¥è°ƒç”¨HWComposerç±»çš„prepareå‡½æ•°ï¼Œè€Œprepareå‡½æ•°ä¼šè°ƒç”¨Composeræ¨¡å—çš„prepareæ¥å£ã€‚æœ€ååˆ°å„ä¸ªå‚å®¶çš„å®ç°hwc_prepareå‡½æ•°å°†æ¯ç§HWComposerä¸­çš„æ‰€æœ‰å›¾å±‚çš„ç±»å‹éƒ½è®¾ç½®ä¸ºHWC_FRAMEBUFFERå°±ç»“æŸäº†ã€‚</p><h3 id="äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ-ï¼ˆdoComposition-å‡½æ•°ï¼‰"><a href="#äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ-ï¼ˆdoComposition-å‡½æ•°ï¼‰" class="headerlink" title="äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ ï¼ˆdoComposition()å‡½æ•°ï¼‰"></a>äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ ï¼ˆdoComposition()å‡½æ•°ï¼‰</h3><p>doCompositionå‡½æ•°æ˜¯åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒï¼Œä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::doComposition() &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> repaintEverything = android_atomic_and(<span class="number">0</span>, &amp;mRepaintEverything);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; hw(mDisplays[dpy]);</span><br><span class="line">    <span class="keyword">if</span> (hw-&gt;isDisplayOn()) &#123;</span><br><span class="line">        <span class="comment">// transform the dirty region into this screen's coordinate space</span></span><br><span class="line">        const Region dirtyRegion(hw-&gt;getDirtyRegion(repaintEverything));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// repaint the framebuffer (if needed)</span></span><br><span class="line">        doDisplayComposition(hw, dirtyRegion);</span><br><span class="line"></span><br><span class="line">        hw-&gt;dirtyRegion.clear();</span><br><span class="line">        hw-&gt;flip(hw-&gt;swapRegion);</span><br><span class="line">        hw-&gt;swapRegion.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// inform the h/w that we're done compositing</span></span><br><span class="line">    hw-&gt;compositionComplete();</span><br><span class="line">&#125;</span><br><span class="line">postFramebuffer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doCompositionå‡½æ•°é’ˆå¯¹æ¯ç§æ˜¾ç¤ºè®¾å¤‡è°ƒç”¨doDisplayCompositionå‡½æ•°æ¥åˆæˆï¼Œåˆæˆåè°ƒç”¨postFramebufferå‡½æ•°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹doDisplayCompositionå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::doDisplayComposition(<span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt;&amp; hw,</span><br><span class="line">    <span class="keyword">const</span> Region&amp; inDirtyRegion)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">// We only need to actually compose the display if:</span></span><br><span class="line"><span class="comment">// 1) It is being handled by hardware composer, which may need this to</span></span><br><span class="line"><span class="comment">//    keep its virtual display state machine in sync, or</span></span><br><span class="line"><span class="comment">// 2) There is work to be done (the dirty region isn't empty)</span></span><br><span class="line"><span class="keyword">bool</span> isHwcDisplay = hw-&gt;getHwcDisplayId() &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!isHwcDisplay &amp;&amp; inDirtyRegion.isEmpty()) &#123;</span><br><span class="line">    ALOGV(<span class="string">"Skipping display composition"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALOGV(<span class="string">"doDisplayComposition"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function">Region <span class="title">dirtyRegion</span><span class="params">(inDirtyRegion)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compute the invalid region</span></span><br><span class="line"><span class="comment">//swapRegionè®¾ç½®ä¸ºéœ€è¦æ›´æ–°çš„åŒºåŸŸ  </span></span><br><span class="line">hw-&gt;swapRegion.orSelf(dirtyRegion);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> flags = hw-&gt;getFlags();<span class="comment">//è·å¾—æ˜¾ç¤ºè®¾å¤‡æ”¯æŒçš„æ›´æ–°æ–¹å¼æ ‡å¿—  </span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; DisplayDevice::SWAP_RECTANGLE) &#123;</span><br><span class="line">    <span class="comment">// we can redraw only what's dirty, but since SWAP_RECTANGLE only</span></span><br><span class="line">    <span class="comment">// takes a rectangle, we must make sure to update that whole</span></span><br><span class="line">    <span class="comment">// rectangle in that case</span></span><br><span class="line">    dirtyRegion.<span class="built_in">set</span>(hw-&gt;swapRegion.bounds());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; DisplayDevice::PARTIAL_UPDATES) &#123;<span class="comment">//æ”¯æŒéƒ¨åˆ†æ›´æ–°  </span></span><br><span class="line">        <span class="comment">// We need to redraw the rectangle that will be updated</span></span><br><span class="line">        <span class="comment">// (pushed to the framebuffer).</span></span><br><span class="line">        <span class="comment">// This is needed because PARTIAL_UPDATES only takes one</span></span><br><span class="line">        <span class="comment">// rectangle instead of a region (see DisplayDevice::flip())</span></span><br><span class="line">        <span class="comment">//å°†æ›´æ–°åŒºåŸŸè°ƒæ•´ä¸ºæ•´ä¸ªçª—å£å¤§å°  </span></span><br><span class="line">        dirtyRegion.<span class="built_in">set</span>(hw-&gt;swapRegion.bounds());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// we need to redraw everything (the whole screen)</span></span><br><span class="line">        dirtyRegion.<span class="built_in">set</span>(hw-&gt;bounds());</span><br><span class="line">        hw-&gt;swapRegion = dirtyRegion;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆæˆ  </span></span><br><span class="line"><span class="keyword">if</span> (!doComposeSurfaces(hw, dirtyRegion)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update the swap region and clear the dirty region</span></span><br><span class="line">hw-&gt;swapRegion.orSelf(dirtyRegion);</span><br><span class="line"><span class="comment">//æ²¡æœ‰ç¡¬ä»¶composerçš„æƒ…å†µï¼Œè¾“å‡ºå›¾åƒ</span></span><br><span class="line"><span class="comment">// swap buffers (presentation)</span></span><br><span class="line">hw-&gt;swapBuffers(getHwComposer());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doDisplayCompositionå‡½æ•°æ ¹æ®æ˜¾ç¤ºè®¾å¤‡æ”¯æŒçš„æ›´æ–°æ–¹å¼ï¼Œé‡æ–°è®¾ç½®éœ€è¦æ›´æ–°åŒºåŸŸçš„å¤§å°ã€‚ çœŸæ­£çš„åˆæˆå·¥ä½œæ˜¯åœ¨doComposerSurfaceså‡½æ•°ä¸­å®Œæˆï¼Œè¿™ä¸ªå‡½æ•°åœ¨layerçš„ç±»å‹ä¸ºHWC_FRAMEBUFFER,æˆ–è€…ä¸æ”¯æŒç¡¬ä»¶çš„composerçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨layerçš„drawå‡½æ•°æ¥ä¸€å±‚ä¸€å±‚ä½åˆæˆæœ€åçš„å›¾åƒã€‚ åˆæˆå®Œåï¼ŒdoDisplayCompositionå‡½æ•°è°ƒç”¨äº†hwçš„swapBufferså‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å‰é¢ä»‹ç»è¿‡äº†ï¼Œå®ƒå°†åœ¨ç³»ç»Ÿä¸æ”¯æŒç¡¬ä»¶çš„composeræƒ…å†µä¸‹è°ƒç”¨eglSwapBuffersæ¥è¾“å‡ºå›¾åƒåˆ°æ˜¾ç¤ºè®¾å¤‡ã€‚</p><h3 id="å…­ã€postFramebuffer-å‡½æ•°"><a href="#å…­ã€postFramebuffer-å‡½æ•°" class="headerlink" title="å…­ã€postFramebuffer()å‡½æ•°"></a>å…­ã€postFramebuffer()å‡½æ•°</h3><p>ä¸Šä¸€èŠ‚çš„doCompositionå‡½æ•°æœ€åè°ƒç”¨äº†postFramebufferå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::postFramebuffer()</span><br><span class="line">&#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">nsecs_t</span> now = systemTime();</span><br><span class="line">mDebugInSwapBuffers = now;</span><br><span class="line"></span><br><span class="line">HWComposer&amp; hwc(getHwComposer());</span><br><span class="line"><span class="keyword">if</span> (hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hwc.supportsFramebufferTarget()) &#123;</span><br><span class="line">        <span class="comment">// EGL spec says:</span></span><br><span class="line">        <span class="comment">//   "surface must be bound to the calling thread's current context,</span></span><br><span class="line">        <span class="comment">//    for the current rendering API."</span></span><br><span class="line">        getDefaultDisplayDevice()-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line">    &#125;</span><br><span class="line">    hwc.commit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// make the default display current because the VirtualDisplayDevice code cannot</span></span><br><span class="line"><span class="comment">// deal with dequeueBuffer() being called outside of the composition loop; however</span></span><br><span class="line"><span class="comment">// the code below can call glFlush() which is allowed (and does in some case) call</span></span><br><span class="line"><span class="comment">// dequeueBuffer().</span></span><br><span class="line">getDefaultDisplayDevice()-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">    <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">    hw-&gt;onSwapBuffersCompleted(hwc);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">    <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">    <span class="keyword">if</span> (id &gt;=<span class="number">0</span> &amp;&amp; hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">        HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">        <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; cur != end &amp;&amp; i &lt; count; ++i, ++cur) &#123;</span><br><span class="line">            currentLayers[i]-&gt;onLayerDisplayed(hw, &amp;*cur);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            currentLayers[i]-&gt;onLayerDisplayed(hw, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mLastSwapBufferTime = systemTime() - now;</span><br><span class="line">mDebugInSwapBuffers = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> flipCount = getDefaultDisplayDevice()-&gt;getPageFlipCount();</span><br><span class="line"><span class="keyword">if</span> (flipCount % LOG_FRAME_STATS_PERIOD == <span class="number">0</span>) &#123;</span><br><span class="line">    logFrameStats();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>postFramebufferå…ˆåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦æ”¯æŒcomposerï¼Œå¦‚æœä¸æ”¯æŒï¼Œæˆ‘ä»¬çŸ¥é“å›¾åƒå·²ç»åœ¨doCompositionå‡½æ•°æ—¶è°ƒç”¨hw-&gt;swapBuffersè¾“å‡ºäº†ï¼Œå°±è¿”å›äº†ã€‚å¦‚æœæ”¯æŒç¡¬ä»¶composerï¼ŒpostFramebufferå‡½æ•°å°†è°ƒç”¨HWComposerçš„commitå‡½æ•°ç»§ç»­æ‰§è¡Œã€‚ [HWComposer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> HWComposer::commit() &#123;</span><br><span class="line"><span class="keyword">int</span> err = NO_ERROR;</span><br><span class="line"><span class="keyword">if</span> (mHwc) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1)) &#123;</span><br><span class="line">        <span class="comment">// On version 1.0, the OpenGL ES target surface is communicated</span></span><br><span class="line">        <span class="comment">// by the (dpy, sur) fields and we are guaranteed to have only</span></span><br><span class="line">        <span class="comment">// a single display.</span></span><br><span class="line">        mLists[<span class="number">0</span>]-&gt;dpy = eglGetCurrentDisplay();</span><br><span class="line">        mLists[<span class="number">0</span>]-&gt;sur = eglGetCurrentSurface(EGL_DRAW);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=VIRTUAL_DISPLAY_ID_BASE; i&lt;mNumDisplays; i++) &#123;</span><br><span class="line">        <span class="function">DisplayData&amp; <span class="title">disp</span><span class="params">(mDisplayData[i])</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (disp.outbufHandle) &#123;</span><br><span class="line">            mLists[i]-&gt;outbuf = disp.outbufHandle;</span><br><span class="line">            mLists[i]-&gt;outbufAcquireFenceFd =</span><br><span class="line">                    disp.outbufAcquireFence-&gt;dup();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = mHwc-&gt;<span class="built_in">set</span>(mHwc, mNumDisplays, mLists);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;mNumDisplays ; i++) &#123;</span><br><span class="line">        <span class="function">DisplayData&amp; <span class="title">disp</span><span class="params">(mDisplayData[i])</span></span>;</span><br><span class="line">        disp.lastDisplayFence = disp.lastRetireFence;</span><br><span class="line">        disp.lastRetireFence = Fence::NO_FENCE;</span><br><span class="line">        <span class="keyword">if</span> (disp.<span class="built_in">list</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (disp.<span class="built_in">list</span>-&gt;retireFenceFd != <span class="number">-1</span>) &#123;</span><br><span class="line">                disp.lastRetireFence = <span class="keyword">new</span> Fence(disp.<span class="built_in">list</span>-&gt;retireFenceFd);</span><br><span class="line">                disp.<span class="built_in">list</span>-&gt;retireFenceFd = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            disp.<span class="built_in">list</span>-&gt;flags &amp;= ~HWC_GEOMETRY_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">status_t</span>)err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆæˆæ•ˆæœå›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/20-Android-Graphics-SurfaceFlinger-composition.png" alt="Markdown"></p><h2 id="ï¼ˆå…­ï¼‰ã€Android-SurfaceFlinger-VSyncå·¥ä½œåŸç†"><a href="#ï¼ˆå…­ï¼‰ã€Android-SurfaceFlinger-VSyncå·¥ä½œåŸç†" class="headerlink" title="ï¼ˆå…­ï¼‰ã€Android SurfaceFlinger - VSyncå·¥ä½œåŸç†"></a>ï¼ˆå…­ï¼‰ã€Android SurfaceFlinger - VSyncå·¥ä½œåŸç†</h2><h3 id="ä¸€ã€VSYNC-æ€»ä½“æ¦‚å¿µ"><a href="#ä¸€ã€VSYNC-æ€»ä½“æ¦‚å¿µ" class="headerlink" title="ä¸€ã€VSYNC æ€»ä½“æ¦‚å¿µ"></a>ä¸€ã€VSYNC æ€»ä½“æ¦‚å¿µ</h3><h3 id="6-1-1ã€VSYNC-æ¦‚å¿µ"><a href="#6-1-1ã€VSYNC-æ¦‚å¿µ" class="headerlink" title="6.1.1ã€VSYNC æ¦‚å¿µ"></a>6.1.1ã€VSYNC æ¦‚å¿µ</h3><p>VSYNCï¼ˆVertical Synchronizationï¼‰æ˜¯ä¸€ä¸ªç›¸å½“å¤è€çš„æ¦‚å¿µï¼Œå¯¹äºæ¸¸æˆç©å®¶ï¼Œå®ƒæœ‰ä¸€ä¸ªæ›´åŠ å¤§åé¼é¼çš„ä¸­æ–‡åå­—â€”å‚ç›´åŒæ­¥ã€‚ â€œå‚ç›´åŒæ­¥(vsync)â€æŒ‡çš„æ˜¯æ˜¾å¡çš„è¾“å‡ºå¸§æ•°å’Œå±å¹•çš„å‚ç›´åˆ·æ–°ç‡ç›¸åŒï¼Œè¿™å®Œå…¨æ˜¯ä¸€ä¸ªCRTæ˜¾ç¤ºå™¨ä¸Šçš„æ¦‚å¿µã€‚å…¶å®æ— è®ºæ˜¯VSYNCè¿˜æ˜¯å‚ç›´åŒæ­¥è¿™ä¸ªåå­—ï¼Œå› ä¸ºLCDæ ¹æœ¬å°±æ²¡æœ‰å‚ç›´æ‰«æçš„è¿™ç§ä¸œè¥¿ï¼Œå› æ­¤è¿™ä¸ªåå­—æœ¬èº«å·²ç»æ²¡æœ‰æ„ä¹‰ã€‚ä½†æ˜¯åŸºäºå†å²çš„åŸå› ï¼Œè¿™ä¸ªåç§°åœ¨å›¾å½¢å›¾åƒé¢†åŸŸè¢«æ²¿è¢­ä¸‹æ¥ã€‚ åœ¨å½“ä¸‹ï¼Œå‚ç›´åŒæ­¥çš„å«ä¹‰æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºï¼Œä½¿å¾—æ˜¾å¡ç”Ÿæˆå¸§çš„é€Ÿåº¦å’Œå±å¹•åˆ·æ–°çš„é€Ÿåº¦çš„ä¿æŒä¸€è‡´ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœå±å¹•çš„åˆ·æ–°ç‡ä¸º60Hzï¼Œé‚£ä¹ˆç”Ÿæˆå¸§çš„é€Ÿåº¦å°±åº”è¯¥è¢«å›ºå®šåœ¨1/60 sã€‚</p><h3 id="6-1-2ã€Android-VSYNC-â€“-é»„æ²¹è®¡åˆ’"><a href="#6-1-2ã€Android-VSYNC-â€“-é»„æ²¹è®¡åˆ’" class="headerlink" title="6.1.2ã€Android VSYNC â€“ é»„æ²¹è®¡åˆ’"></a>6.1.2ã€Android VSYNC â€“ é»„æ²¹è®¡åˆ’</h3><p>è°·æ­Œä¸ºè§£å†³Androidç³»ç»Ÿæµç•…æ€§é—®é¢˜ã€‚åœ¨4.1ç‰ˆæœ¬å¼•å…¥äº†ä¸€ä¸ªé‡å¤§çš„æ”¹è¿›â€“Project Butteré»„æ²¹è®¡åˆ’ã€‚ Project Butterå¯¹Android Displayç³»ç»Ÿè¿›è¡Œäº†é‡æ„ï¼Œå¼•å…¥äº†ä¸‰ä¸ªæ ¸å¿ƒå…ƒç´ ï¼Œå³VSYNCã€Triple Bufferå’ŒChoreographerã€‚ VSYNCæœ€é‡è¦çš„ä½œç”¨æ˜¯é˜²æ­¢å‡ºç°ç”»é¢æ’•è£‚ï¼ˆscreentearingï¼‰ã€‚æ‰€è°“ç”»é¢æ’•è£‚ï¼Œå°±æ˜¯æŒ‡ä¸€ä¸ªç”»é¢ä¸Šå‡ºç°äº†ä¸¤å¸§ç”»é¢çš„å†…å®¹ï¼Œå¦‚ä¸‹å›¾ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/21-Android-graphics-view-teaning.png" alt="Markdown"></p><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿè¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯å› ä¸ºæ˜¾å¡è¾“å‡ºå¸§çš„é€Ÿåº¦é«˜äºæ˜¾ç¤ºå™¨çš„åˆ·æ–°é€Ÿåº¦ï¼Œå¯¼è‡´æ˜¾ç¤ºå™¨å¹¶ä¸èƒ½åŠæ—¶å¤„ç†è¾“å‡ºçš„å¸§ï¼Œè€Œæœ€ç»ˆå‡ºç°äº†å¤šä¸ªå¸§çš„ç”»é¢éƒ½ç•™åœ¨äº†æ˜¾ç¤ºå™¨ä¸Šçš„é—®é¢˜ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç”»é¢æ’•è£‚ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/22-Android-Graphics-Draw-whithout-vsync.png" alt="Markdown"></p><p>è¿™ä¸ªå›¾ä¸­æœ‰ä¸‰ä¸ªå…ƒç´ ï¼ŒDisplayæ˜¯æ˜¾ç¤ºå±å¹•ï¼ŒGPUå’ŒCPUè´Ÿè´£æ¸²æŸ“å¸§æ•°æ®ï¼Œæ¯ä¸ªå¸§ä»¥æ–¹æ¡†è¡¨ç¤ºï¼Œå¹¶ä»¥æ•°å­—è¿›è¡Œç¼–å·ï¼Œå¦‚0ã€1ã€2ç­‰ç­‰ã€‚VSyncç”¨äºæŒ‡å¯¼åŒç¼“å†²åŒºçš„äº¤æ¢ã€‚ ä»¥æ—¶é—´çš„é¡ºåºæ¥çœ‹ä¸‹å°†ä¼šå‘ç”Ÿçš„å¼‚å¸¸ï¼š Step1. Displayæ˜¾ç¤ºç¬¬0å¸§æ•°æ®ï¼Œæ­¤æ—¶CPUå’ŒGPUæ¸²æŸ“ç¬¬1å¸§ç”»é¢ï¼Œè€Œä¸”èµ¶åœ¨Displayæ˜¾ç¤ºä¸‹ä¸€å¸§å‰å®Œæˆ Step2. å› ä¸ºæ¸²æŸ“åŠæ—¶ï¼ŒDisplayåœ¨ç¬¬0å¸§æ˜¾ç¤ºå®Œæˆåï¼Œä¹Ÿå°±æ˜¯ç¬¬1ä¸ªVSyncåï¼Œæ­£å¸¸æ˜¾ç¤ºç¬¬1å¸§ Step3. ç”±äºæŸäº›åŸå› ï¼Œæ¯”å¦‚CPUèµ„æºè¢«å ç”¨ï¼Œç³»ç»Ÿæ²¡æœ‰åŠæ—¶åœ°å¼€å§‹å¤„ç†ç¬¬2å¸§ï¼Œç›´åˆ°ç¬¬2ä¸ªVSyncå¿«æ¥å‰æ‰å¼€å§‹å¤„ç† Step4. ç¬¬2ä¸ªVSyncæ¥æ—¶ï¼Œç”±äºç¬¬2å¸§æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å°±ç»ªï¼Œæ˜¾ç¤ºçš„è¿˜æ˜¯ç¬¬1å¸§ã€‚è¿™ç§æƒ…å†µè¢«Androidå¼€å‘ç»„å‘½åä¸ºâ€Jankâ€ã€‚ Step5. å½“ç¬¬2å¸§æ•°æ®å‡†å¤‡å®Œæˆåï¼Œå®ƒå¹¶ä¸ä¼šé©¬ä¸Šè¢«æ˜¾ç¤ºï¼Œè€Œæ˜¯è¦ç­‰å¾…ä¸‹ä¸€ä¸ªVSyncã€‚ æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯å±å¹•å¹³ç™½æ— æ•…åœ°å¤šæ˜¾ç¤ºäº†ä¸€æ¬¡ç¬¬1å¸§ã€‚åŸå› å¤§å®¶åº”è¯¥éƒ½çœ‹åˆ°äº†ï¼Œå°±æ˜¯CPUæ²¡æœ‰åŠæ—¶åœ°å¼€å§‹ç€æ‰‹å¤„ç†ç¬¬2å¸§çš„æ¸²æŸ“å·¥ä½œï¼Œä»¥è‡´â€å»¶è¯¯å†›æœºâ€ã€‚</p><p>å…¶å®æ€»ç»“ä¸Šé¢çš„è¿™ä¸ªæƒ…å†µä¹‹æ‰€ä»¥å‘ç”Ÿï¼Œé¦–å…ˆçš„åŸå› å°±åœ¨äºç¬¬äºŒå¸§æ²¡æœ‰åŠæ—¶çš„ç»˜åˆ¶ï¼ˆå½“ç„¶å³ä½¿ç¬¬äºŒå¸§åŠæ—¶ç»˜åˆ¶ï¼Œä¹Ÿä¾ç„¶å¯èƒ½å‡ºç°Jankï¼Œè¿™å°±æ˜¯åŒæ—¶å¼•å…¥ä¸‰é‡ç¼“å†²çš„ä½œç”¨ã€‚æˆ‘ä»¬å°†åœ¨ä¸‰é‡ç¼“å†²ä¸€èŠ‚ä¸­å†è®²è§£è¿™ç§æƒ…å†µï¼‰ã€‚é‚£ä¹ˆå¦‚ä½•ä½¿å¾—ç¬¬äºŒå¸§å³ä½¿è¢«ç»˜åˆ¶å‘¢ï¼Ÿ è¿™å°±æ˜¯æˆ‘ä»¬åœ¨Graphicç³»ç»Ÿä¸­å¼•å…¥VSYNCçš„åŸå› ï¼Œè€ƒè™‘ä¸‹é¢è¿™å¼ å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/23-Android-Graphics-Draw-whit-vsync.png" alt="Markdown"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€æ—¦VSyncå‡ºç°åï¼Œç«‹åˆ»å°±å¼€å§‹æ‰§è¡Œä¸‹ä¸€å¸§çš„ç»˜åˆ¶å·¥ä½œã€‚è¿™æ ·å°±å¯ä»¥å¤§å¤§é™ä½Jankå‡ºç°çš„æ¦‚ç‡ã€‚å¦å¤–ï¼ŒVSYNCå¼•å…¥åï¼Œè¦æ±‚ç»˜åˆ¶ä¹Ÿåªèƒ½åœ¨æ”¶åˆ°VSYNCæ¶ˆæ¯ä¹‹åæ‰èƒ½è¿›è¡Œï¼Œå› æ­¤ï¼Œä¹Ÿå°±æœç»äº†å¦å¤–ä¸€ç§æç«¯æƒ…å†µçš„å‡ºç°â€”CPUï¼ˆGPUï¼‰ä¸€ç›´ä¸åœçš„è¿›è¡Œç»˜åˆ¶ï¼Œå¸§çš„ç”Ÿæˆé€Ÿåº¦é«˜äºå±å¹•çš„åˆ·æ–°é€Ÿåº¦ï¼Œå¯¼è‡´ç”Ÿæˆçš„å¸§ä¸èƒ½è¢«æ˜¾ç¤ºï¼Œåªèƒ½ä¸¢å¼ƒï¼Œè¿™æ ·å°±å‡ºç°äº†ä¸¢å¸§çš„æƒ…å†µâ€”å¼•å…¥VSYNCåï¼Œç»˜åˆ¶çš„é€Ÿåº¦å°±å’Œå±å¹•åˆ·æ–°çš„é€Ÿåº¦ä¿æŒä¸€è‡´äº†ã€‚</p><h3 id="äºŒã€VSyncä¿¡å·äº§ç”Ÿ"><a href="#äºŒã€VSyncä¿¡å·äº§ç”Ÿ" class="headerlink" title="äºŒã€VSyncä¿¡å·äº§ç”Ÿ"></a>äºŒã€VSyncä¿¡å·äº§ç”Ÿ</h3><p>é‚£ä¹ˆVSYNCä¿¡å·æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿ Androidç³»ç»Ÿä¸­VSYNCä¿¡å·åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ç¡¬ä»¶ç”Ÿæˆçš„ä¿¡å·ï¼Œä¸€ç§æ˜¯è½¯ä»¶æ¨¡æ‹Ÿçš„ä¿¡å·ã€‚ ç¡¬ä»¶ä¿¡å·æ˜¯ç”±HardwareComposeræä¾›çš„ï¼ŒHWCå°è£…äº†ç›¸å…³çš„HALå±‚ï¼Œå¦‚æœç¡¬ä»¶å‚å•†æä¾›çš„HALå±‚å®ç°èƒ½å®šæ—¶äº§ç”ŸVSYNCä¸­æ–­ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ç¡¬ä»¶çš„VSYNCä¸­æ–­ï¼Œå¦åˆ™HardwareComposerå†…éƒ¨ä¼šé€šè¿‡VSyncThreadæ¥æ¨¡æ‹Ÿäº§ç”ŸVSYNCä¸­æ–­ï¼ˆå…¶å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯sleepå›ºå®šæ—¶é—´ï¼Œç„¶åå”¤é†’ï¼‰ã€‚</p><p>SurfaceFlingerçš„å¯åŠ¨è¿‡ç¨‹ä¸­inti()ä¼šåˆ›å»ºä¸€ä¸ªHWComposerå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">HWComposer::HWComposer(  </span><br><span class="line">        <span class="keyword">const</span> sp&lt;SurfaceFlinger&gt;&amp; flinger,  </span><br><span class="line">        EventHandler&amp; handler)  </span><br><span class="line">    : mFlinger(flinger),  </span><br><span class="line">      mFbDev(<span class="number">0</span>), mHwc(<span class="number">0</span>), mNumDisplays(<span class="number">1</span>),  </span><br><span class="line">      mCBContext(<span class="keyword">new</span> cb_context),  </span><br><span class="line">      mEventHandler(handler),  </span><br><span class="line">      mDebugForceFakeVSync(<span class="literal">false</span>)  </span><br><span class="line">&#123;  </span><br><span class="line">...  </span><br><span class="line">    <span class="comment">//é¦–å…ˆæ˜¯ä¸€äº›å’ŒVSYNCæœ‰å…³çš„ä¿¡æ¯çš„åˆå§‹åŒ–  </span></span><br><span class="line">    <span class="comment">//å› ä¸ºåœ¨ç¡¬ä»¶æ”¯æŒçš„æƒ…å†µä¸‹ï¼ŒVSYNCçš„åŠŸèƒ½å°±æ˜¯ç”±HWCæä¾›çš„  </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;HWC_NUM_PHYSICAL_DISPLAY_TYPES ; i++) &#123;  </span><br><span class="line">        mLastHwVSync[i] = <span class="number">0</span>;  </span><br><span class="line">        mVSyncCounts[i] = <span class="number">0</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//æ ¹æ®é…ç½®æ¥çœ‹æ˜¯å¦éœ€è¦æ¨¡æ‹ŸVSYNCæ¶ˆæ¯  </span></span><br><span class="line">    <span class="keyword">char</span> value[PROPERTY_VALUE_MAX];  </span><br><span class="line">    property_get(<span class="string">"debug.sf.no_hw_vsync"</span>, value, <span class="string">"0"</span>);  </span><br><span class="line">    mDebugForceFakeVSync = atoi(value);  </span><br><span class="line">    ...  </span><br><span class="line">    <span class="comment">// don't need a vsync thread if we have a hardware composer  </span></span><br><span class="line">    needVSyncThread = <span class="literal">false</span>;  </span><br><span class="line">    <span class="comment">// always turn vsync off when we start,åªæ˜¯æš‚æ—¶å…³é—­ä¿¡å·ï¼Œåé¢ä¼šå†å¼€å¯  </span></span><br><span class="line">    eventControl(HWC_DISPLAY_PRIMARY, HWC_EVENT_VSYNC, <span class="number">0</span>);      </span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ˜¾ç„¶ï¼Œå¦‚æœéœ€è¦æ¨¡æ‹ŸVSyncä¿¡å·çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦çº¿ç¨‹æ¥åšè¿™ä¸ªå·¥ä½œ  </span></span><br><span class="line">    <span class="keyword">if</span> (needVSyncThread) &#123;  </span><br><span class="line">        <span class="comment">// we don't have VSYNC support, we need to fake it  </span></span><br><span class="line">        <span class="comment">//VSyncThreadç±»çš„å®ç°å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯ä¸€ä¸ªè®¡æ—¶å™¨è€Œå·²ï¼Œå®šæ—¶å‘é€æ¶ˆæ¯è€Œå·²  </span></span><br><span class="line">        <span class="comment">//TODO VSYNCä¸“é¢˜  </span></span><br><span class="line">        mVSyncThread = <span class="keyword">new</span> VSyncThread(*<span class="keyword">this</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">...  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">HWComposer::HWComposer(  </span><br><span class="line">        <span class="keyword">const</span> sp&lt;SurfaceFlinger&gt;&amp; flinger,  </span><br><span class="line">        EventHandler&amp; handler)  </span><br><span class="line">    : mFlinger(flinger),  </span><br><span class="line">      mFbDev(<span class="number">0</span>), mHwc(<span class="number">0</span>), mNumDisplays(<span class="number">1</span>),  </span><br><span class="line">      mCBContext(<span class="keyword">new</span> cb_context),  </span><br><span class="line">      mEventHandler(handler),  </span><br><span class="line">      mDebugForceFakeVSync(<span class="literal">false</span>)  </span><br><span class="line">&#123;  </span><br><span class="line">...  </span><br><span class="line">    <span class="comment">//é¦–å…ˆæ˜¯ä¸€äº›å’ŒVSYNCæœ‰å…³çš„ä¿¡æ¯çš„åˆå§‹åŒ–  </span></span><br><span class="line">    <span class="comment">//å› ä¸ºåœ¨ç¡¬ä»¶æ”¯æŒçš„æƒ…å†µä¸‹ï¼ŒVSYNCçš„åŠŸèƒ½å°±æ˜¯ç”±HWCæä¾›çš„  </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;HWC_NUM_PHYSICAL_DISPLAY_TYPES ; i++) &#123;  </span><br><span class="line">        mLastHwVSync[i] = <span class="number">0</span>;  </span><br><span class="line">        mVSyncCounts[i] = <span class="number">0</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//æ ¹æ®é…ç½®æ¥çœ‹æ˜¯å¦éœ€è¦æ¨¡æ‹ŸVSYNCæ¶ˆæ¯  </span></span><br><span class="line">    <span class="keyword">char</span> value[PROPERTY_VALUE_MAX];  </span><br><span class="line">    property_get(<span class="string">"debug.sf.no_hw_vsync"</span>, value, <span class="string">"0"</span>);  </span><br><span class="line">    mDebugForceFakeVSync = atoi(value);  </span><br><span class="line">    ...  </span><br><span class="line">    <span class="comment">// don't need a vsync thread if we have a hardware composer  </span></span><br><span class="line">    needVSyncThread = <span class="literal">false</span>;  </span><br><span class="line">    <span class="comment">// always turn vsync off when we start,åªæ˜¯æš‚æ—¶å…³é—­ä¿¡å·ï¼Œåé¢ä¼šå†å¼€å¯  </span></span><br><span class="line">    eventControl(HWC_DISPLAY_PRIMARY, HWC_EVENT_VSYNC, <span class="number">0</span>);      </span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ˜¾ç„¶ï¼Œå¦‚æœéœ€è¦æ¨¡æ‹ŸVSyncä¿¡å·çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦çº¿ç¨‹æ¥åšè¿™ä¸ªå·¥ä½œ  </span></span><br><span class="line">    <span class="keyword">if</span> (needVSyncThread) &#123;  </span><br><span class="line">        <span class="comment">// we don't have VSYNC support, we need to fake it  </span></span><br><span class="line">        <span class="comment">//VSyncThreadç±»çš„å®ç°å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯ä¸€ä¸ªè®¡æ—¶å™¨è€Œå·²ï¼Œå®šæ—¶å‘é€æ¶ˆæ¯è€Œå·²  </span></span><br><span class="line">        <span class="comment">//TODO VSYNCä¸“é¢˜  </span></span><br><span class="line">        mVSyncThread = <span class="keyword">new</span> VSyncThread(*<span class="keyword">this</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸Šé¢è¿™æ®µä»£ç ã€‚ é¦–å…ˆmDebugForceFakeVSyncæ˜¯ä¸ºäº†è°ƒåˆ¶ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå˜é‡è®¾ç½®å¼ºåˆ¶ä½¿ç”¨è½¯ä»¶VSYNCæ¨¡æ‹Ÿã€‚ ç„¶åé’ˆå¯¹ä¸åŒçš„å±å¹•ï¼Œåˆå§‹åŒ–äº†ä»–ä»¬çš„mLastHwVSyncå’ŒmVSyncCountså€¼ã€‚ å¦‚æœç¡¬ä»¶æ”¯æŒï¼Œé‚£ä¹ˆå°±æŠŠneedVSyncThreadè®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºä¸éœ€è¦è½¯ä»¶æ¨¡æ‹Ÿã€‚ æ¥ç€é€šè¿‡eventControlæ¥æš‚æ—¶çš„å…³é—­äº†VSYNCä¿¡å·ï¼Œè¿™ä¸€ç‚¹å°†åœ¨ä¸‹é¢è®²è§£eventControlæ—¶ä¸€å¹¶è®²è§£ã€‚ æœ€åï¼Œå¦‚æœéœ€è¦è½¯ä»¶æ¨¡æ‹ŸVsyncä¿¡å·çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„VSyncThreadçº¿ç¨‹æ¥åšè¿™ä¸ªå·¥ä½œ(fake VSYNCæ˜¯è¿™ä¸ªçº¿ç¨‹å”¯ä¸€çš„ä½œç”¨)ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªçº¿ç¨‹ã€‚</p><p><strong>è½¯ä»¶æ¨¡æ‹Ÿ</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> HWComposer::VSyncThread::threadLoop() &#123;  </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">nsecs_t</span> period = mRefreshPeriod;  </span><br><span class="line">    <span class="comment">//å½“å‰çš„æ—¶é—´  </span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">nsecs_t</span> now = systemTime(CLOCK_MONOTONIC);  </span><br><span class="line">    <span class="comment">//ä¸‹ä¸€æ¬¡VSYNCåˆ°æ¥çš„æ—¶é—´  </span></span><br><span class="line">    <span class="keyword">nsecs_t</span> next_vsync = mNextFakeVSync;  </span><br><span class="line">    <span class="comment">//ä¸ºäº†ç­‰å¾…ä¸‹ä¸ªæ—¶é—´åˆ°æ¥åº”è¯¥ä¼‘çœ çš„æ—¶é—´  </span></span><br><span class="line">    <span class="keyword">nsecs_t</span> sleep = next_vsync - now;  </span><br><span class="line">    <span class="comment">//é”™è¿‡äº†VSYNCçš„æ—¶é—´  </span></span><br><span class="line">    <span class="keyword">if</span> (sleep &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="comment">// we missed, find where the next vsync should be  </span></span><br><span class="line">        <span class="comment">//é‡æ–°è®¡ç®—ä¸‹åº”è¯¥ä¼‘æ¯çš„æ—¶é—´  </span></span><br><span class="line">        sleep = (period - ((now - next_vsync) % period));  </span><br><span class="line">        <span class="comment">//æ›´æ–°ä¸‹æ¬¡VSYNCçš„æ—¶é—´  </span></span><br><span class="line">        next_vsync = now + sleep;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//æ›´æ–°ä¸‹ä¸‹æ¬¡VSYNCçš„æ—¶é—´  </span></span><br><span class="line">    mNextFakeVSync = next_vsync + period;  </span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">spec</span>;</span>  </span><br><span class="line">    spec.tv_sec  = next_vsync / <span class="number">1000000000</span>;  </span><br><span class="line">    spec.tv_nsec = next_vsync % <span class="number">1000000000</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> err;  </span><br><span class="line">    <span class="keyword">do</span> &#123;  </span><br><span class="line">        <span class="comment">//çº³ç§’ç²¾åº¦çº§çš„ä¼‘çœ   </span></span><br><span class="line">        err = clock_nanosleep(CLOCK_MONOTONIC, TIMER_ABSTIME, &amp;spec, <span class="literal">NULL</span>);  </span><br><span class="line">    &#125; <span class="keyword">while</span> (err&lt;<span class="number">0</span> &amp;&amp; errno == EINTR);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="comment">//ä¼‘çœ ä¹‹åï¼Œåˆ°äº†è¯¥å‘ç”ŸVSYNCçš„æ—¶é—´äº†  </span></span><br><span class="line">        mHwc.mEventHandler.onVSyncReceived(<span class="number">0</span>, next_vsync);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å…¶å®å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯ä¸€ä¸ªç®€å•çš„æ—¶é—´è®¡ç®—ï¼Œè®¡ç®—è¿‡ç¨‹æˆ‘å·²ç»å†™åœ¨äº†ç¨‹åºæ³¨é‡Šé‡Œé¢ã€‚æ€»ä¹‹åˆ°äº†åº”è¯¥å‘ç”ŸVSYNCä¿¡å·çš„æ—¶å€™ï¼Œå°±è°ƒç”¨äº†mHwc.mEventHandler.onVSyncReceived(0, next_vsync)å‡½æ•°æ¥é€šçŸ¥VSYNCçš„åˆ°æ¥ã€‚</p><p>æˆ‘ä»¬æ³¨æ„åˆ°mEventHandlerå®é™…ä¸Šæ˜¯åœ¨HWCåˆ›å»ºæ—¶è¢«ä¼ å…¥çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹HWCåˆ›å»ºæ—¶çš„ä»£ç .</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mHwc = new HWComposer(this,  </span><br><span class="line">        *static_cast&lt;HWComposer::EventHandler *&gt;(this));  </span><br><span class="line"></span><br><span class="line">class SurfaceFlinger : public BnSurfaceComposer,  </span><br><span class="line">                   private IBinder::DeathRecipient,  </span><br><span class="line">                   private HWComposer::EventHandler</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªmEventHandlerå®é™…ä¸Šå°±æ˜¯SurfaceFlingerã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒVSYNCä¿¡å·åˆ°æ¥æ—¶ï¼ŒSurfaceFlingerçš„onVSyncReceivedå‡½æ•°å¤„ç†äº†è¿™ä¸ªæ¶ˆæ¯ã€‚ è¿™é‡Œæˆ‘ä»¬æš‚æ—¶å…ˆä¸å±•å¼€SurfaceFlingerå†…çš„é€»è¾‘å¤„ç†ï¼Œç­‰æˆ‘ä»¬ä¸‹é¢åˆ†æå®Œç¡¬ä»¶å®ç°åï¼Œä¸€å¹¶è¿›è¡Œåˆ†æ</p><p><strong>ç¡¬ä»¶å®ç°</strong> ä¸Šé¢æˆ‘ä»¬è®²äº†è½¯ä»¶å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªVSYNCä¿¡å·å¹¶é€šçŸ¥SurfaceFlinger,é‚£ä¹ˆç¡¬ä»¶åˆæ˜¯å¦‚ä½•å®ç°è¿™ä¸€ç‚¹çš„å‘¢ï¼Ÿ æˆ‘ä»¬å†ä¸€æ¬¡å›åˆ°HWCçš„åˆ›å»ºè¿‡ç¨‹ä¸­æ¥ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mHwc) &#123;  </span><br><span class="line">       ALOGE(<span class="string">"Lee Using %s version %u.%u"</span>, HWC_HARDWARE_COMPOSER,  </span><br><span class="line">             (hwcApiVersion(mHwc) &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>,  </span><br><span class="line">             (hwcApiVersion(mHwc) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);  </span><br><span class="line">       <span class="keyword">if</span> (mHwc-&gt;registerProcs) &#123;  </span><br><span class="line">           mCBContext-&gt;hwc = <span class="keyword">this</span>;  </span><br><span class="line">           mCBContext-&gt;procs.invalidate = &amp;hook_invalidate;  </span><br><span class="line">           mCBContext-&gt;procs.vsync = &amp;hook_vsync;  </span><br><span class="line">           <span class="keyword">if</span> (hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1))  </span><br><span class="line">               mCBContext-&gt;procs.hotplug = &amp;hook_hotplug;  </span><br><span class="line">           <span class="keyword">else</span>  </span><br><span class="line">               mCBContext-&gt;procs.hotplug = <span class="literal">NULL</span>;  </span><br><span class="line">           <span class="built_in">memset</span>(mCBContext-&gt;procs.zero, <span class="number">0</span>, <span class="keyword">sizeof</span>(mCBContext-&gt;procs.zero));  </span><br><span class="line">           mHwc-&gt;registerProcs(mHwc, &amp;mCBContext-&gt;procs);  </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹ä¸‹ä¸Šé¢è¿™æ®µå®ç°ã€‚ å½“HWCæœ‰vsyncä¿¡å·ç”Ÿæˆæ—¶ï¼Œç¡¬ä»¶æ¨¡å—ä¼šé€šè¿‡procs.vsyncæ¥é€šçŸ¥è½¯ä»¶éƒ¨åˆ†ï¼Œå› æ­¤ä¹Ÿå°±æ˜¯è°ƒç”¨äº†hook_vsyncå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> HWComposer::hook_vsync(<span class="keyword">const</span> struct hwc_procs* procs, <span class="keyword">int</span> disp,  </span><br><span class="line">        <span class="keyword">int64_t</span> timestamp) &#123;  </span><br><span class="line">    cb_context* ctx = <span class="keyword">reinterpret_cast</span>&lt;cb_context*&gt;(  </span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">hwc_procs_t</span>*&gt;(procs));  </span><br><span class="line">    ctx-&gt;hwc-&gt;vsync(disp, timestamp);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> HWComposer::vsync(<span class="keyword">int</span> disp, <span class="keyword">int64_t</span> timestamp) &#123;  </span><br><span class="line">    <span class="comment">//åªæœ‰çœŸå®çš„ç¡¬ä»¶è®¾å¤‡æ‰ä¼šäº§ç”ŸVSYNC  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">uint32_t</span>(disp) &lt; HWC_NUM_PHYSICAL_DISPLAY_TYPES) &#123;  </span><br><span class="line">        &#123;  </span><br><span class="line">            mLastHwVSync[disp] = timestamp;  </span><br><span class="line">        &#125;  </span><br><span class="line">        mEventHandler.onVSyncReceived(disp, timestamp);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°æœ€åæ®Šé€”åŒå½’ï¼Œç¡¬ä»¶ä¿¡å·æœ€ç»ˆä¹Ÿé€šè¿‡onVSyncReceivedå‡½æ•°é€šçŸ¥åˆ°äº†SurfaceFlingeräº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸‹SurfaceFlingerçš„å¤„ç†è¿‡ç¨‹ã€‚</p><h3 id="ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†"><a href="#ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†" class="headerlink" title="ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†"></a>ä¸‰ã€Surfaceflingerå¯¹VSYNCæ¶ˆæ¯çš„å¤„ç†</h3><p>å…ˆæ¥ç›´æ¥çœ‹ä¸‹Surfaceflingerçš„onVSyncReceivedå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::onVSyncReceived(<span class="keyword">int32_t</span> type, <span class="keyword">nsecs_t</span> timestamp) &#123;</span><br><span class="line">    <span class="keyword">bool</span> needsHwVsync = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// Scope for the lock</span></span><br><span class="line">        Mutex::Autolock _l(mHWVsyncLock);</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="number">0</span> &amp;&amp; mPrimaryHWVsyncEnabled) &#123;</span><br><span class="line">            needsHwVsync = mPrimaryDispSync.addResyncSample(timestamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needsHwVsync) &#123;</span><br><span class="line">        enableHardwareVsync();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        disableHardwareVsync(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mPrimaryDispSyncæ˜¯ä»€ä¹ˆï¼ŸaddResyncSampleæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ è¦å›ç­”è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè¿˜æ˜¯å¾—å›åˆ°SurfaceFlingerçš„initå‡½æ•°ä¸­æ¥ã€‚</p><h3 id="6-3-1ã€Surfaceflinger-init"><a href="#6-3-1ã€Surfaceflinger-init" class="headerlink" title="6.3.1ã€Surfaceflinger.init()"></a>6.3.1ã€Surfaceflinger.init()</h3><p>å…ˆçœ‹ä¸€ä¸‹æ€»ä½“flowï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/24-Android-Graphics-Vsync-surfaceflinger.init.png" alt="Markdown"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void SurfaceFlinger::init() &#123;</span><br><span class="line">    ALOGI(  &quot;SurfaceFlinger&apos;s main thread ready to run. &quot;</span><br><span class="line">            &quot;Initializing graphics H/W...&quot;);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">        // start the EventThread</span><br><span class="line">        sp&lt;VSyncSource&gt; vsyncSrc = new DispSyncSource(&amp;mPrimaryDispSync,</span><br><span class="line">                vsyncPhaseOffsetNs, true, &quot;app&quot;);</span><br><span class="line">        mEventThread = new EventThread(vsyncSrc, *this);</span><br><span class="line">        sp&lt;VSyncSource&gt; sfVsyncSrc = new DispSyncSource(&amp;mPrimaryDispSync,</span><br><span class="line">                sfVsyncPhaseOffsetNs, true, &quot;sf&quot;);</span><br><span class="line">        mSFEventThread = new EventThread(sfVsyncSrc, *this);</span><br><span class="line">        mEventQueue.setEventThread(mSFEventThread);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    mEventControlThread = new EventControlThread(this);</span><br><span class="line">    mEventControlThread-&gt;run(&quot;EventControl&quot;, PRIORITY_URGENT_DISPLAY);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ä¸ªEventThreadå¯¹è±¡åˆ†åˆ«æ˜¯mEventThreadï¼Œç»™appç”¨ï¼ŒmSFEventThreadï¼Œç»™surfaceflingerè‡ªå·±ç”¨ã€‚ ä¸‹é¢ç»™å‡ºè¿™4ä¸ªThreadå…³ç³»å›¾ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/25-Android-Graphics-SurfaceFlinger.init.DispSyncThread.png.png" alt="Markdown"></p><p>è¿™ä¸¤ä¸ªDispSyncSourceå°±æ˜¯KKå¼•å…¥çš„é‡å¤§å˜åŒ–ã€‚Android 4.4(KitKat)å¼•å…¥äº†VSyncçš„è™šæ‹ŸåŒ–ï¼Œå³æŠŠç¡¬ä»¶çš„VSyncä¿¡å·å…ˆåŒæ­¥åˆ°ä¸€ä¸ªæœ¬åœ°VSyncæ¨¡å‹ä¸­ï¼Œå†ä»ä¸­ä¸€åˆ†ä¸ºäºŒï¼Œå¼•å‡ºä¸¤æ¡VSyncæ—¶é—´ä¸ä¹‹æœ‰å›ºå®šåç§»çš„çº¿ç¨‹ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/26-Android-Graphics-SurfaceFlinger-App-Vsync-offset.png.png" alt="Markdown"></p><p>Googleè¿™æ ·ä¿®æ”¹çš„ç›®çš„åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ =åœ¨å½“å‰ä¸‰é‡ç¼“å†²åŒºçš„æ¶æ„ä¸‹ï¼Œå³å¯¹äºä¸€å¸§å†…å®¹ï¼Œå…ˆç­‰App UIç”»å®Œäº†ï¼ŒSurfaceFlingerå†å‡ºåœºå¯¹å…¶è¿›è¡Œåˆå¹¶æ¸²æŸ“åæ”¾å…¥framebufferï¼Œæœ€åæ•´åˆ°å±å¹•ä¸Šã€‚è€Œç°æœ‰çš„VSyncæ¨¡å‹æ˜¯è®©å¤§å®¶ä¸€èµ·å¼€å§‹å¹²æ´»ã€‚ è¿™ä¸ªæ¶æ„å…¶å®ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºAppå’ŒSurfaceFlingerè¢«åŒæ—¶å”¤é†’ï¼Œå¯¼è‡´ä»–ä»¬äºŒè€…æ€»æ˜¯ä¸€èµ·å·¥ä½œï¼Œå¿…ç„¶å¯¼è‡´VSyncæ¥ä¸´çš„æ—¶åˆ»ï¼Œè¿™äºŒè€…ä¹‹é—´äº§ç”Ÿäº†CPUèµ„æºçš„æŠ¢å ã€‚å› æ­¤ï¼Œè°·æ­Œç»™è¿™ä¸¤ä¸ªå·¥ä½œéƒ½åŠ ä¸Šä¸€ä¸ªå°å°çš„å»¶è¿Ÿï¼Œè®©è¿™ä¸¤ä¸ªå·¥ä½œå¹¶ä¸æ˜¯åŒæ—¶è¢«å”¤é†’ï¼Œè¿™æ ·å¤§å®¶å°±å¯ä»¥é”™å¼€ä½¿ç”¨èµ„æºçš„é«˜å³°æœŸï¼Œæé«˜å·¥ä½œçš„æ•ˆç‡ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/27-Android-graphics-SurfaceFlinger-Vsync-app-sf.png" alt="Markdown"></p><p>è¿™ä¸¤ä¸ªå»¶è¿Ÿï¼Œå…¶å®å°±åˆ†åˆ«å¯¹åº”ä¸Šé¢ä»£ç ä¸­çš„vsyncSrcï¼ˆç»˜åˆ¶å»¶è¿Ÿï¼‰å’ŒsfVsyncSrcï¼ˆåˆæˆå»¶è¿Ÿï¼‰ã€‚ åœ¨åˆ›å»ºäº†ä¸¤ä¸ªDispSyncSourceå˜é‡åï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒä»¬æ¥åˆå§‹åŒ–äº†ä¸¤ä¸ªEventThreadã€‚ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹EventThreadçš„åˆ›å»ºæµç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">EventThread::EventThread(<span class="keyword">const</span> sp&lt;VSyncSource&gt;&amp; src, SurfaceFlinger&amp; flinger)</span><br><span class="line">    : mVSyncSource(src),</span><br><span class="line">      mFlinger(flinger),</span><br><span class="line">      mUseSoftwareVSync(<span class="literal">false</span>),</span><br><span class="line">      mVsyncEnabled(<span class="literal">false</span>),</span><br><span class="line">      mDebugVsyncEnabled(<span class="literal">false</span>),</span><br><span class="line">      mVsyncHintSent(<span class="literal">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int32_t</span> i=<span class="number">0</span> ; i&lt;DisplayDevice::NUM_BUILTIN_DISPLAY_TYPES ; i++) &#123;</span><br><span class="line">        mVSyncEvent[i].header.type = DisplayEventReceiver::DISPLAY_EVENT_VSYNC;</span><br><span class="line">        mVSyncEvent[i].header.id = <span class="number">0</span>;</span><br><span class="line">        mVSyncEvent[i].header.timestamp = <span class="number">0</span>;</span><br><span class="line">        mVSyncEvent[i].vsync.count =  <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigevent</span> <span class="title">se</span>;</span></span><br><span class="line">    se.sigev_notify = SIGEV_THREAD;</span><br><span class="line">    se.sigev_value.sival_ptr = <span class="keyword">this</span>;</span><br><span class="line">    se.sigev_notify_function = vsyncOffCallback;</span><br><span class="line">    se.sigev_notify_attributes = <span class="literal">NULL</span>;</span><br><span class="line">    timer_create(CLOCK_MONOTONIC, &amp;se, &amp;mTimerId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> EventThread::onFirstRef() &#123;</span><br><span class="line">    run(<span class="string">"EventThread"</span>, PRIORITY_URGENT_DISPLAY + PRIORITY_MORE_FAVORABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EventThreadçš„æ„é€ å‡½æ•°å¾ˆç®€å•ã€‚é‡ç‚¹æ˜¯å®ƒçš„onFirstRefå‡½æ•°å¯åŠ¨äº†ä¸€ä¸ªEventThreadçº¿ç¨‹ï¼Œäºæ˜¯ä¸‹é¢çš„ä»£ç æ‰æ˜¯é‡ç‚¹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> EventThread::threadLoop() &#123;</span><br><span class="line">    DisplayEventReceiver::Event event;</span><br><span class="line">    Vector&lt; sp&lt;EventThread::Connection&gt; &gt; signalConnections;</span><br><span class="line">    signalConnections = waitForEvent(&amp;event);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dispatch events to listeners...</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> count = signalConnections.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Connection&gt;&amp; conn(signalConnections[i]);</span><br><span class="line">        <span class="comment">// now see if we still need to report this event</span></span><br><span class="line">        <span class="keyword">status_t</span> err = conn-&gt;postEvent(event);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‡½æ•°æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œå…¶ä¸­è°ƒç”¨äº†ä¸€ä¸ªwaitForEventçš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ç›¸å½“ä¹‹é•¿ï¼Œä¸ºäº†é˜²æ­¢ä»£ç å±•å¼€å¤ªå¤šï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶ä¸å†è¯¦ç»†åˆ†æè¿™ä¸ªå‡½æ•°ã€‚æˆ‘ä»¬ç›®å‰åªéœ€è¦çŸ¥é“è¿™ä¸ªå‡½æ•°çš„æœ€é‡è¦çš„ä½œç”¨æ˜¯ç­‰å¾…Eventçš„åˆ°æ¥ï¼Œå¹¶ä¸”æŸ¥æ‰¾å¯¹eventæ„Ÿå…´è¶£çš„ç›‘å¬è€…ï¼Œè€Œåœ¨æ²¡æœ‰eventåˆ°æ¥æ—¶ï¼Œçº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…eventçš„å”¤é†’ï¼ˆæˆ‘ä»¬å°†ä¸‹ä¸€ç¯‡VSYNCçš„æ¥æ”¶å’Œå¤„ç†ä¸­å±•å¼€åˆ†æè¿™ä¸ªå‡½æ•°ï¼‰ã€‚ è¿™æ ·ï¼ŒEventThreadçº¿ç¨‹å°±è¿è¡Œèµ·æ¥ï¼Œå¤„åœ¨ç­‰å¾…è¢«eventå”¤é†’çš„çŠ¶æ€ä¸‹ã€‚ <strong>MessageQueueå’ŒEventThreadå»ºç«‹è¿æ¥</strong> ç®€å•è¯´æ˜å®ŒEventThreadä¹‹åï¼Œæˆ‘ä»¬å†æ¬¡å›åˆ°SurfaceFlingerçš„initè¿‡ç¨‹ä¸­æ¥ã€‚å›åˆ°init()å‡½æ•°ä»£ç ä¸­æ¥ï¼š å°†SurfaceFlingerçš„MessageQueueçœŸæ­£å’Œæˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„EventThreadå»ºç«‹èµ·äº†è¿æ¥ï¼Œè¿™æ ·SurfaceFlingeræ‰èƒ½çœŸæ­£æ¥æ”¶åˆ°æ¥è‡ªHWCçš„VSYNCä¿¡å·ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™æ®µä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MessageQueue::setEventThread(<span class="keyword">const</span> sp&lt;EventThread&gt;&amp; eventThread)  </span><br><span class="line">&#123;  </span><br><span class="line">    mEventThread = eventThread;  </span><br><span class="line">    mEvents = eventThread-&gt;createEventConnection();  </span><br><span class="line">    mEventTube = mEvents-&gt;getDataChannel();  </span><br><span class="line">    mLooper-&gt;addFd(mEventTube-&gt;getFd(), <span class="number">0</span>, ALOOPER_EVENT_INPUT,  </span><br><span class="line">            MessageQueue::cb_eventReceiver, <span class="keyword">this</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»£ç é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªåˆ°EventThreadçš„è¿æ¥ï¼Œå¾—åˆ°äº†å‘é€VSYNCäº‹ä»¶é€šçŸ¥çš„BitTubeï¼Œç„¶åç›‘æ§è¿™ä¸ªBitTubeä¸­çš„å¥—æ¥å­—ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ”¶åˆ°é€šçŸ¥åçš„å›è°ƒå‡½æ•°ï¼ŒMessageQueue::cb_eventReceiverã€‚è¿™æ ·ä¸€æ—¦VSyncä¿¡å·ä¼ æ¥ï¼Œå‡½æ•°cb_eventReceiverå°†è¢«è°ƒç”¨ã€‚ <strong>å‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€”-createEventConnection</strong> åœ¨SurfaceFlingerçš„initå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†mEventQueue.setEventThread(mSFEventThread)å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨å‰é¢ä¸€ç« ä¸­å·²ç»æåˆ°è¿‡ï¼Œè¿™ä¸ªå‡½æ•°å°†SurfaceFlingerçš„MessageQueueçœŸæ­£å’Œæˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„EventThreadå»ºç«‹èµ·äº†è¿æ¥ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™æ®µä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;EventThread::Connection&gt; EventThread::createEventConnection() <span class="keyword">const</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Connection(<span class="keyword">const_cast</span>&lt;EventThread*&gt;(<span class="keyword">this</span>));  </span><br><span class="line">&#125;  </span><br><span class="line">EventThread::Connection::Connection(  </span><br><span class="line">        <span class="keyword">const</span> sp&lt;EventThread&gt;&amp; eventThread)  </span><br><span class="line">    : count(<span class="number">-1</span>), mEventThread(eventThread), mChannel(<span class="keyword">new</span> BitTube())  </span><br><span class="line">&#123;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">void</span> EventThread::Connection::onFirstRef() &#123;  </span><br><span class="line">    mEventThread-&gt;registerDisplayEventConnection(<span class="keyword">this</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">status_t</span> EventThread::registerDisplayEventConnection(  </span><br><span class="line">        <span class="keyword">const</span> sp&lt;EventThread::Connection&gt;&amp; connection) &#123;  </span><br><span class="line">    mDisplayEventConnections.add(connection);  </span><br><span class="line">    mCondition.broadcast();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼šå¯¼è‡´ä¸€ä¸ªConnectionç±»çš„åˆ›å»ºï¼Œè€Œè¿™ä¸ªconnectionç±»ä¼šè¢«ä¿å­˜åœ¨EventThreadä¸‹çš„ä¸€ä¸ªå®¹å™¨å†…ã€‚ é€šè¿‡createEventConnectionè¿™æ ·ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å…¶å®å°±æ³¨å†Œäº†ä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…ï¼Œå¾—åˆ°äº†å‘é€VSYNCäº‹ä»¶é€šçŸ¥çš„BitTubeï¼Œç„¶åç›‘æ§è¿™ä¸ªBitTubeä¸­çš„å¥—æ¥å­—ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ”¶åˆ°é€šçŸ¥åçš„å›è°ƒå‡½æ•°ï¼ŒMessageQueue::cb_eventReceiverã€‚è¿™æ ·ä¸€æ—¦VSyncä¿¡å·ä¼ æ¥ï¼Œå‡½æ•°cb_eventReceiverå°†è¢«è°ƒç”¨ã€‚</p><h3 id="6-3-2ã€VSyncä¿¡å·çš„å¤„ç†"><a href="#6-3-2ã€VSyncä¿¡å·çš„å¤„ç†" class="headerlink" title="6.3.2ã€VSyncä¿¡å·çš„å¤„ç†"></a>6.3.2ã€VSyncä¿¡å·çš„å¤„ç†</h3><p>æˆ‘ä»¬åœ¨å‰é¢ä¸€ç« ä¹Ÿæåˆ°äº†æ— è®ºæ˜¯è½¯ä»¶æ–¹å¼è¿˜æ˜¯ç¡¬ä»¶æ–¹å¼ï¼ŒSurfaceFlingeræ”¶åˆ°VSyncä¿¡å·åï¼Œå¤„ç†å‡½æ•°éƒ½æ˜¯onVSyncReceivedå‡½æ•°ï¼š</p><p><strong>VSyncæ¶ˆæ¯å¤„ç†â€”-addResyncSample</strong><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/28-Android-Graphics-SF-Vsync-addResyncSample.png.png" alt="Markdown"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> DispSync::addResyncSample(<span class="keyword">nsecs_t</span> timestamp) &#123;  </span><br><span class="line">    <span class="keyword">size_t</span> idx = (mFirstResyncSample + mNumResyncSamples) % MAX_RESYNC_SAMPLES;  </span><br><span class="line">    mResyncSamples[idx] = timestamp;  </span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    updateModelLocked();  </span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç²—ç•¥æµè§ˆä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°å‰åŠéƒ¨åˆ†å…¶å®åœ¨åšä¸€äº›ç®€å•çš„è®¡æ•°ç»Ÿè®¡ï¼Œé‡ç‚¹å®ç°æ˜¾ç„¶æ˜¯updateModelLockedå‡½æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">void DispSync::updateModelLocked() &#123;  </span><br><span class="line">    if (mNumResyncSamples &gt;= MIN_RESYNC_SAMPLES_FOR_UPDATE) &#123;  </span><br><span class="line">        nsecs_t durationSum = 0;  </span><br><span class="line">        for (size_t i = 1; i &lt; mNumResyncSamples; i++) &#123;  </span><br><span class="line">            size_t idx = (mFirstResyncSample + i) % MAX_RESYNC_SAMPLES;  </span><br><span class="line">            size_t prev = (idx + MAX_RESYNC_SAMPLES - 1) % MAX_RESYNC_SAMPLES;  </span><br><span class="line">            durationSum += mResyncSamples[idx] - mResyncSamples[prev];  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        mPeriod = durationSum / (mNumResyncSamples - 1);  </span><br><span class="line"></span><br><span class="line">        double sampleAvgX = 0;  </span><br><span class="line">        double sampleAvgY = 0;  </span><br><span class="line">        double scale = 2.0 * M_PI / double(mPeriod);  </span><br><span class="line">        for (size_t i = 0; i &lt; mNumResyncSamples; i++) &#123;  </span><br><span class="line">            size_t idx = (mFirstResyncSample + i) % MAX_RESYNC_SAMPLES;  </span><br><span class="line">            nsecs_t sample = mResyncSamples[idx];  </span><br><span class="line">            double samplePhase = double(sample % mPeriod) * scale;  </span><br><span class="line">            sampleAvgX += cos(samplePhase);  </span><br><span class="line">            sampleAvgY += sin(samplePhase);  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        sampleAvgX /= double(mNumResyncSamples);  </span><br><span class="line">        sampleAvgY /= double(mNumResyncSamples);  </span><br><span class="line"></span><br><span class="line">        mPhase = nsecs_t(atan2(sampleAvgY, sampleAvgX) / scale);  </span><br><span class="line">        ......</span><br><span class="line">        mThread-&gt;updateModel(mPeriod, mPhase);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸å¾—ä¸è¯´ï¼Œå‰é¢å¤§æ®µçš„æ•°å­¦è®¡ç®—è®©äººæœ‰äº›å›°æƒ‘ï¼Œæˆ‘ä»¬æš‚ä¸”è·³è¿‡ï¼Œå…ˆåˆ†æä¸‹ä¸»çº¿æµç¨‹ï¼Œä¹Ÿå°±æ˜¯mThread-&gt;updateModel(mPeriod, mPhase)è¿™ä¸ªè°ƒç”¨ï¼š</p><p><strong>DispSyncThread.updateModelçš„ç”¨é€”</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateModel</span><span class="params">(<span class="keyword">nsecs_t</span> period, <span class="keyword">nsecs_t</span> phase)</span> </span>&#123;  </span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;  </span><br><span class="line">    mPeriod = period;  </span><br><span class="line">    mPhase = phase;  </span><br><span class="line">    mCond.signal();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>updateModelæ˜¯DispSyncThreadç±»çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ¬èº«ä»£ç å¾ˆçŸ­ï¼Œå…¶å®å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯mCond.signalå‘é€ä¸€ä¸ªä¿¡å·ç»™ç­‰å¾…ä¸­çš„çº¿ç¨‹ã€‚é‚£ä¹ˆç©¶ç«Ÿæ˜¯è°åœ¨ç­‰å¾…è¿™ä¸ªæ¡ä»¶å‘¢ï¼Ÿ å…¶å®ç­‰å¾…è¿™ä¸ªæ¡ä»¶çš„æ­£æ˜¯DispSyncThreadçš„å¾ªç¯å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">threadLoop</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">      <span class="keyword">status_t</span> err;  </span><br><span class="line">      <span class="keyword">nsecs_t</span> now = systemTime(SYSTEM_TIME_MONOTONIC);  </span><br><span class="line">      <span class="keyword">nsecs_t</span> nextEventTime = <span class="number">0</span>;  </span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">          Vector&lt;CallbackInvocation&gt; callbackInvocations;  </span><br><span class="line">          <span class="keyword">nsecs_t</span> targetTime = <span class="number">0</span>;  </span><br><span class="line">          &#123; <span class="comment">// Scope for lock  </span></span><br><span class="line">              Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;  </span><br><span class="line">              ......</span><br><span class="line">              <span class="keyword">if</span> (mPeriod == <span class="number">0</span>) &#123;  </span><br><span class="line">                  err = mCond.wait(mMutex);  </span><br><span class="line">                  ......</span><br><span class="line">              &#125;  </span><br><span class="line">              nextEventTime = computeNextEventTimeLocked(now);  </span><br><span class="line">              targetTime = nextEventTime;  </span><br><span class="line">              ......</span><br><span class="line">              &#125;  </span><br><span class="line">              now = systemTime(SYSTEM_TIME_MONOTONIC);  </span><br><span class="line">              ......</span><br><span class="line">              callbackInvocations = gatherCallbackInvocationsLocked(now);  </span><br><span class="line">          &#125;  </span><br><span class="line">          <span class="keyword">if</span> (callbackInvocations.size() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">              fireCallbackInvocations(callbackInvocations);  </span><br><span class="line">          &#125;  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¤§é‡çš„æ—¶é—´ç›¸å…³çš„è®¡ç®—å’ŒçŠ¶æ€çš„è½¬å˜æˆ‘ä»¬ä¸å†æ·±å…¥ç ”ç©¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªçº¿ç¨‹è¢«é€šçŸ¥å”¤é†’ä¹‹ååšçš„ä¸¤ä¸ªä¸»è¦çš„å‡½æ•°çš„å¤„ç†ï¼ŒgatherCallbackInvocationsLocked()å’ŒfireCallbackInvocations()ã€‚</p><p>gatherCallbackInvocationsLocked()çš„ä»£ç å…¶å®å¾ˆç®€å•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Vector&lt;CallbackInvocation&gt; gatherCallbackInvocationsLocked(<span class="keyword">nsecs_t</span> now) &#123;  </span><br><span class="line">    Vector&lt;CallbackInvocation&gt; callbackInvocations;  </span><br><span class="line">    <span class="keyword">nsecs_t</span> ref = now - mPeriod;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mEventListeners.size(); i++) &#123;  </span><br><span class="line">        <span class="keyword">nsecs_t</span> t = computeListenerNextEventTimeLocked(mEventListeners[i],  </span><br><span class="line">                ref);  </span><br><span class="line">        <span class="keyword">if</span> (t &lt; now) &#123;  </span><br><span class="line">            CallbackInvocation ci;  </span><br><span class="line">            ci.mCallback = mEventListeners[i].mCallback;  </span><br><span class="line">            ci.mEventTime = t;  </span><br><span class="line">            callbackInvocations.push(ci);  </span><br><span class="line">            mEventListeners.editItemAt(i).mLastEventTime = t;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> callbackInvocations;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ä»mEventListenerså–å‡ºä¹‹å‰æ³¨å†Œçš„äº‹ä»¶ç›‘å¬è€…ï¼Œæ”¾å…¥callbackInvocationsä¸­ï¼Œç­‰å¾…åé¢çš„è°ƒç”¨ã€‚è‡³äºç›‘å¬è€…ä»ä½•å¤„è€Œæ¥ï¼Ÿåœ¨waitforeventæ—¶é€šè¿‡enableVSyncLockedæ³¨å†Œçš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹fireCallbackInvocations()å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fireCallbackInvocations</span><span class="params">(<span class="keyword">const</span> Vector&lt;CallbackInvocation&gt;&amp; callbacks)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; callbacks.size(); i++) &#123;  </span><br><span class="line">        callbacks[i].mCallback-&gt;onDispSyncEvent(callbacks[i].mEventTime);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;`</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç›®å‰åªåˆ†æä¸»çº¿çš„èµ°å‘,æ¥ä¸‹æ¥è°ƒç”¨äº†DispSyncSourceçš„onDispSyncEventåœ¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onDispSyncEvent</span><span class="params">(<span class="keyword">nsecs_t</span> when)</span> </span>&#123;  </span><br><span class="line">        sp&lt;VSyncSource::Callback&gt; callback;  </span><br><span class="line">        &#123;  </span><br><span class="line">            callback = mCallback;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">NULL</span>) &#123;  </span><br><span class="line">            callback-&gt;onVSyncEvent(when);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="keyword">void</span> EventThread::onVSyncEvent(<span class="keyword">nsecs_t</span> timestamp) &#123;  </span><br><span class="line">    Mutex::Autolock _l(mLock);  </span><br><span class="line">    mVSyncEvent[<span class="number">0</span>].header.type = DisplayEventReceiver::DISPLAY_EVENT_VSYNC;  </span><br><span class="line">    mVSyncEvent[<span class="number">0</span>].header.id = <span class="number">0</span>;  </span><br><span class="line">    mVSyncEvent[<span class="number">0</span>].header.timestamp = timestamp;  </span><br><span class="line">    mVSyncEvent[<span class="number">0</span>].vsync.count++;  </span><br><span class="line">    mCondition.broadcast();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°è¿™é‡ŒmCondition.broadcaså‘å‡ºäº†å‘½ä»¤ï¼Œé‚£ä¹ˆEventThreadä¸­waitforEventçš„ç­‰å¾…å°±ä¼šè¢«å”¤é†’ã€‚è€Œä¸€æ—¦å”¤é†’ï¼Œæˆ‘ä»¬å°±å›åˆ°äº†EventThreadçš„loopä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bool EventThread::threadLoop() &#123;  </span><br><span class="line">    DisplayEventReceiver::Event event;  </span><br><span class="line">    Vector&lt; sp&lt;EventThread::Connection&gt; &gt; signalConnections;  </span><br><span class="line">    signalConnections = waitForEvent(&amp;event);  </span><br><span class="line"></span><br><span class="line">    // dispatch events to listeners...  </span><br><span class="line">    const size_t count = signalConnections.size();  </span><br><span class="line">    for (size_t i=0 ; i&lt;count ; i++) &#123;  </span><br><span class="line">        const sp&lt;Connection&gt;&amp; conn(signalConnections[i]);  </span><br><span class="line">        // now see if we still need to report this event  </span><br><span class="line">        status_t err = conn-&gt;postEvent(event);  </span><br><span class="line">        ......</span><br><span class="line">    &#125;  </span><br><span class="line">    return true;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦å°±æ˜¯é€šè¿‡conn-&gt;postEventæ¥åˆ†å‘äº‹ä»¶ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> EventThread::Connection::postEvent(  </span><br><span class="line">        <span class="keyword">const</span> DisplayEventReceiver::Event&amp; event) &#123;  </span><br><span class="line">    <span class="keyword">ssize_t</span> size = DisplayEventReceiver::sendEvents(mChannel, &amp;event, <span class="number">1</span>);  </span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? <span class="keyword">status_t</span>(size) : <span class="keyword">status_t</span>(NO_ERROR);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">ssize_t</span> DisplayEventReceiver::sendEvents(<span class="keyword">const</span> sp&lt;BitTube&gt;&amp; dataChannel,  </span><br><span class="line">        Event <span class="keyword">const</span>* events, <span class="keyword">size_t</span> count)  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">return</span> BitTube::sendObjects(dataChannel, events, count);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/29-Android-Graphics-App-SurfaceFlinger-Vsync-postEvent.png.png" alt="Markdown"></p><p>å…¶å®çœ‹åˆ°è¿™é‡Œçš„BitTubeæˆ‘ä»¬å°±æ˜ç™½äº†ï¼Œåœ¨æœ¬æ–‡å¼€å§‹æ—¶å€™æˆ‘ä»¬æåˆ°ï¼š</p><p>é€šè¿‡createEventConnectionè¿™æ ·ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å…¶å®å°±æ³¨å†Œäº†ä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…ï¼Œå¾—åˆ°äº†å‘é€VSYNCäº‹ä»¶é€šçŸ¥çš„BitTubeï¼Œç„¶åç›‘æ§è¿™ä¸ªBitTubeä¸­çš„å¥—æ¥å­—ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ”¶åˆ°é€šçŸ¥åçš„å›è°ƒå‡½æ•°ï¼ŒMessageQueue::cb_eventReceiverã€‚è¿™æ ·ä¸€æ—¦VSyncä¿¡å·ä¼ æ¥ï¼Œå‡½æ•°cb_eventReceiverå°†è¢«è°ƒç”¨ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¯ä»¥æ¥çœ‹çœ‹MessageQueue::cb_eventReceiverå‡½æ•°äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> MessageQueue::cb_eventReceiver(<span class="keyword">int</span> fd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data) &#123;  </span><br><span class="line">    MessageQueue* <span class="built_in">queue</span> = <span class="keyword">reinterpret_cast</span>&lt;MessageQueue *&gt;(data);  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">queue</span>-&gt;eventReceiver(fd, events);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> MessageQueue::eventReceiver(<span class="keyword">int</span> fd, <span class="keyword">int</span> events) &#123;  </span><br><span class="line">    <span class="keyword">ssize_t</span> n;  </span><br><span class="line">    DisplayEventReceiver::Event buffer[<span class="number">8</span>];  </span><br><span class="line">    <span class="keyword">while</span> ((n = DisplayEventReceiver::getEvents(mEventTube, buffer, <span class="number">8</span>)) &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ; i&lt;n ; i++) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (buffer[i].header.type == DisplayEventReceiver::DISPLAY_EVENT_VSYNC) &#123;  </span><br><span class="line">                mHandler-&gt;dispatchInvalidate();  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°æ”¶åˆ°æ¶ˆæ¯ä¹‹åMessageQueueå¯¹æ¶ˆæ¯è¿›è¡Œäº†åˆ†å‘ï¼Œæˆ‘ä»¬ç›®å‰èµ°çš„æ˜¯dispatchInvalidate()ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MessageQueue::Handler::dispatchInvalidate() &#123;  </span><br><span class="line">    <span class="keyword">if</span> ((android_atomic_or(eventMaskInvalidate, &amp;mEventMask) &amp; eventMaskInvalidate) == <span class="number">0</span>) &#123;  </span><br><span class="line">        mQueue.mLooper-&gt;sendMessage(<span class="keyword">this</span>, Message(MessageQueue::INVALIDATE));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> MessageQueue::Handler::handleMessage(<span class="keyword">const</span> Message&amp; message) &#123;  </span><br><span class="line">    <span class="keyword">switch</span> (message.what) &#123;  </span><br><span class="line">        <span class="keyword">case</span> INVALIDATE:  </span><br><span class="line">            android_atomic_and(~eventMaskInvalidate, &amp;mEventMask);  </span><br><span class="line">            mQueue.mFlinger-&gt;onMessageReceived(message.what);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> REFRESH:  </span><br><span class="line">            android_atomic_and(~eventMaskRefresh, &amp;mEventMask);  </span><br><span class="line">            mQueue.mFlinger-&gt;onMessageReceived(message.what);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> TRANSACTION:  </span><br><span class="line">            android_atomic_and(~eventMaskTransaction, &amp;mEventMask);  </span><br><span class="line">            mQueue.mFlinger-&gt;onMessageReceived(message.what);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> SurfaceFlinger::onMessageReceived(<span class="keyword">int32_t</span> what) &#123;  </span><br><span class="line">    ATRACE_CALL();  </span><br><span class="line">    <span class="keyword">switch</span> (what) &#123;  </span><br><span class="line">    <span class="keyword">case</span> MessageQueue::TRANSACTION:  </span><br><span class="line">        handleMessageTransaction();  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">case</span> MessageQueue::INVALIDATE:  </span><br><span class="line">        handleMessageTransaction();  </span><br><span class="line">        handleMessageInvalidate();  </span><br><span class="line">        signalRefresh();  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">case</span> MessageQueue::REFRESH:  </span><br><span class="line">        handleMessageRefresh();  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°äº†è¿™é‡Œï¼Œå°±è¿›å…¥äº†SurfaceFlingerçš„å¤„ç†æµç¨‹ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯¹äºINVALIDATEçš„æ¶ˆæ¯ï¼Œå®é™…ä¸Šç³»ç»Ÿåœ¨å¤„ç†è¿‡ç¨‹ä¸­å®é™…è¿˜æ˜¯ä¼šå‘é€ä¸€ä¸ªRefreshæ¶ˆæ¯ã€‚</p><h3 id="6-4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection"><a href="#6-4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection" class="headerlink" title="6.4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection()"></a>6.4ã€Appå‘Eventhreadæ³¨å†Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬è€…â€“createEventConnection()</h3><p>åœ¨ViewRootImplçš„æ„é€ å‡½æ•°ä¸­ä¼šå®ä¾‹åŒ–Choreographerå¯¹è±¡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">                . . . . .</span><br><span class="line">        mChoreographer = Choreographer.getInstance();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨mChoreographer çš„æ„é€ å‡½æ•°ä¸­å®ä¾‹åŒ–FrameDisplayEventReceiverå¯¹è±¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private Choreographer(Looper looper) &#123;</span><br><span class="line">               . . . . . .</span><br><span class="line">               mDisplayEventReceiver = USE_VSYNC ? new FrameDisplayEventReceiver(looper) : null;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨FrameDisplayEventReceiverçš„çˆ¶ç±»æ„é€ å‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°ï¼Œandroid_view_DisplayEventReceiver.cppä¸­çš„nativeInitæ–¹æ³•,åœ¨nativeInitæ–¹æ³•ä¸­æœ‰å¦‚ä¸‹è¿‡ç¨‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeInit</span><span class="params">(JNIEnv* env, jclass clazz, jobject receiverWeak,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobject messageQueueObj)</span> </span>&#123;</span><br><span class="line">        . . . . . .</span><br><span class="line">    sp&lt;NativeDisplayEventReceiver&gt; receiver = <span class="keyword">new</span> NativeDisplayEventReceiver(env,</span><br><span class="line">            receiverWeak, messageQueue);</span><br><span class="line">    <span class="keyword">status_t</span> status = receiver-&gt;initialize();</span><br><span class="line">    . . . . . .</span><br></pre></td></tr></table></figure><p>åˆ›å»ºNativeDisplayEventReceiverç±» ç±»å‹æŒ‡é’ˆ åœ¨NativeDisplayEventReceiverçš„æ„é€ å‡½æ•°ä¸­ä¼šè°ƒç”¨DisplayEventReceiverç±»çš„æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–æˆå‘˜mReceiverï¼›</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DisplayEventReceiver::DisplayEventReceiver() &#123;</span><br><span class="line">    sp&lt;ISurfaceComposer&gt; sf(ComposerService::getComposerService());</span><br><span class="line">    <span class="keyword">if</span> (sf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mEventConnection = sf-&gt;createDisplayEventConnection();</span><br><span class="line">        <span class="keyword">if</span> (mEventConnection != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mDataChannel = mEventConnection-&gt;getDataChannel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­è·å–SurfaceflingeræœåŠ¡çš„ä»£ç†å¯¹è±¡ï¼Œç„¶åé€šè¿‡Binder IPCåˆ›å»ºBpDisplayEventConnectionå¯¹è±¡ è¯¥å‡½æ•°ç»ç”±BnSurfaceComposer.onTransactå‡½æ•°è¾—è½¬è°ƒç”¨åˆ°SurfaceFlinger.createDisplayEventConnectionå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IDisplayEventConnection&gt; SurfaceFlinger::createDisplayEventConnection() &#123;</span><br><span class="line">    <span class="keyword">return</span> mEventThread-&gt;createEventConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡ºç°äº†ç†Ÿæ‚‰çš„é¢å­”mEventThreadï¼Œè¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªEventThreadå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åœ¨SurfaceFlinger.initå‡½æ•°é‡Œé¢åˆ›å»ºï¼Œä½†æ˜¯åˆ›å»ºè¿è¡Œä»¥åï¼Œè²Œä¼¼è¿˜æ²¡æœ‰è¿›è¡Œä»»ä½•çš„åŠ¨ä½œï¼Œè¿™é‡Œè°ƒç”¨createEventConnectionå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;EventThread::Connection&gt; EventThread::createEventConnection() <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Connection(<span class="keyword">const_cast</span>&lt;EventThread*&gt;(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åmEventConnection-&gt;getDataChannel()æ–¹æ³•å†æ¬¡é€šè¿‡Binder IPCåˆ›å»º BitTubeå¯¹è±¡mDataChannel ï¼Œåœ¨Binder IPCåˆ›å»ºmDataChannel è¿‡ç¨‹ä¸­ä¼šä»æœåŠ¡ç«¯EventThread::Connection::Connectionä¸­ï¼ˆåœ¨EventThreadç±»ä¸­å®šä¹‰ï¼‰æ¥æ”¶ä¸€ä¸ªsocketpairåˆ›å»ºçš„FIFOæ–‡ä»¶æè¿°ç¬¦ï¼›</p><p>EventThread::Connection::Connectionåˆ›å»ºæè¿°ç¬¦çš„ä»£ç ï¼š Connectionæ„é€ å‡½æ•°è°ƒç”¨BitTubeçš„æ— å‚æ„é€ å‡½æ•°ï¼Œåœ¨BitTubeçš„æ„é€ å‡½æ•°ä¸­è°ƒç”¨initå‡½æ•°ï¼›</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> BitTube::init(<span class="keyword">size_t</span> rcvbuf, <span class="keyword">size_t</span> sndbuf) &#123;</span><br><span class="line">    <span class="keyword">int</span> sockets[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_SEQPACKET, <span class="number">0</span>, sockets) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> size = DEFAULT_SOCKET_BUFFER_SIZE;</span><br><span class="line">        setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_RCVBUF, &amp;rcvbuf, <span class="keyword">sizeof</span>(rcvbuf));</span><br><span class="line">        setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUF, &amp;sndbuf, <span class="keyword">sizeof</span>(sndbuf));</span><br><span class="line">        <span class="comment">// sine we don't use the "return channel", we keep it small...</span></span><br><span class="line">        setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_SNDBUF, &amp;size, <span class="keyword">sizeof</span>(size));</span><br><span class="line">        setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_RCVBUF, &amp;size, <span class="keyword">sizeof</span>(size));</span><br><span class="line">        fcntl(sockets[<span class="number">0</span>], F_SETFL, O_NONBLOCK);</span><br><span class="line">        fcntl(sockets[<span class="number">1</span>], F_SETFL, O_NONBLOCK);</span><br><span class="line">        mReceiveFd = sockets[<span class="number">0</span>];</span><br><span class="line">        mSendFd = sockets[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mReceiveFd = -errno;</span><br><span class="line">        ALOGE(<span class="string">"BitTube: pipe creation failed (%s)"</span>, strerror(-mReceiveFd));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨åˆ°NativeDisplayEventReceiverç±»çš„çˆ¶ç±»DisplayEventDispatcherä¸­çš„initialize()æ–¹æ³•ï¼Œ å°†BpDisplayEventConnectionå¯¹è±¡è·å–åˆ°çš„mDataChannel ï¼ˆBitTubeç±»å‹ï¼‰ä¸­çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°UIä¸»çº¿ç¨‹Looperçš„epollä¸­ï¼Œ å½“æ–‡ä»¶æè¿°ç¬¦ä¸­è¢«å†™å…¥æ•°æ®æ—¶ï¼Œè¯¥epoll_waitä¼šè¢«å”¤é†’ï¼› ç›´æ¥çœ‹ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> NativeDisplayEventReceiver::initialize() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> result = mReceiver.initCheck();</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        ALOGW(<span class="string">"Failed to initialize display event receiver, status=%d"</span>, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> rc = mMessageQueue-&gt;getLooper()-&gt;addFd(mReceiver.getFd(), <span class="number">0</span>, Looper::EVENT_INPUT, <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä¸»è¦ä»£ç æ˜¯mMessageQueue-&gt;getLooper()-&gt;addFd()è¿™ä¸€è¡Œï¼Œå…¶ä¸­çš„å‚æ•°mReceiver.getFd()è¿”å›çš„æ˜¯åœ¨åˆ›å»ºNativeDisplayEventReceiveræ—¶ä»SurfaceFlingeræœåŠ¡ç«¯æ¥æ”¶å›æ¥çš„socketæ¥æ”¶ç«¯æè¿°ç¬¦ï¼Œå‰é¢åˆ†æåˆ° mMessageQueueæ˜¯ä¸å½“å‰åº”ç”¨çº¿ç¨‹å…³è”çš„javaå±‚çš„MessageQueueå¯¹åº”çš„nativeå±‚çš„MessageQueueå¯¹è±¡ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹Looper.addFdè¿™ä¸ªå‡½æ•°ï¼Œä¸Šé¢è°ƒç”¨æ—¶ä¼ è¿›æ¥çš„thisæŒ‡é’ˆå¯¹åº”çš„æ˜¯ä¸€ä¸ªNativeDisplayEventReceiverå¯¹è±¡ï¼Œè¯¥ç±»ç»§æ‰¿äº†LooperCallbackï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Looper::addFd(<span class="keyword">int</span> fd, <span class="keyword">int</span> ident, <span class="keyword">int</span> events, Looper_callbackFunc callback, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">return</span> addFd(fd, ident, events, callback ? <span class="keyword">new</span> SimpleLooperCallback(callback) : <span class="literal">NULL</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> Looper::addFd(<span class="keyword">int</span> fd, <span class="keyword">int</span> ident, <span class="keyword">int</span> events, <span class="keyword">const</span> sp&lt;LooperCallback&gt;&amp; callback, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">int</span> epollEvents = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; EVENT_INPUT) epollEvents |= EPOLLIN;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; EVENT_OUTPUT) epollEvents |= EPOLLOUT;</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">        Request request;</span><br><span class="line">        request.fd = fd;</span><br><span class="line">        request.ident = ident;</span><br><span class="line">        request.callback = callback;</span><br><span class="line">        request.data = data;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">eventItem</span>;</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp; eventItem, <span class="number">0</span>, <span class="keyword">sizeof</span>(epoll_event)); <span class="comment">// zero out unused members of data field union</span></span><br><span class="line">        eventItem.events = epollEvents;</span><br><span class="line">        eventItem.data.fd = fd;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">ssize_t</span> requestIndex = mRequests.indexOfKey(fd);</span><br><span class="line">        <span class="keyword">if</span> (requestIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp; eventItem);</span><br><span class="line">            <span class="keyword">if</span> (epollResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            mRequests.add(fd, request);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_MOD, fd, &amp; eventItem);</span><br><span class="line">            <span class="keyword">if</span> (epollResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mRequests.replaceValueAt(requestIndex, request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå°†ä¸Šé¢ä¼ è¿›æ¥çš„NativeDisplayEventReceiverå¯¹è±¡å°è£…æˆä¸€ä¸ªSimpleLooperCallbackå¯¹è±¡ï¼Œè°ƒç”¨ä¸‹é¢çš„addFdå‡½æ•°çš„æ—¶å€™ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ªstruct epoll_eventç»“æ„ä½“å¯¹è±¡ï¼Œå°†å¯¹åº”çš„å†…å­˜å…¨éƒ¨ç”¨æ¸…0ï¼Œå¹¶ä½œå¯¹åº”çš„åˆå§‹åŒ–ï¼› ï¼ˆ2ï¼‰æŸ¥è¯¢é€šè¿‡addFdæ–¹æ³•å·²ç»æ·»åŠ åˆ°epollä¸­ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼› ï¼ˆ3ï¼‰æŸ¥è¯¢ä¸åˆ°çš„è¯ï¼Œåˆ™è°ƒç”¨epoll_ctlæ–¹æ³•è®¾ç½®EPOLL_CTL_ADDå±æ€§å°†å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°epollç›‘å¬çš„æè¿°ç¬¦ä¸­ï¼› ï¼ˆ4ï¼‰æ ¹æ®å‰é¢addFdä¼ å…¥çš„å‚æ•°EVENT_INPUTï¼Œè¯´æ˜å½“å‰åº”ç”¨çº¿ç¨‹çš„nativeå±‚çš„Looperå¯¹è±¡ä¸­çš„epollæœºåˆ¶å·²ç»å¼€å§‹ç›‘å¬æ¥è‡ªäºSurfaceFlingeræœåŠ¡ç«¯socketç«¯çš„å†™å…¥äº‹ä»¶ã€‚</p><h3 id="6-5ã€Appè¯·æ±‚Vsyncä¿¡å·"><a href="#6-5ã€Appè¯·æ±‚Vsyncä¿¡å·" class="headerlink" title="6.5ã€Appè¯·æ±‚Vsyncä¿¡å·"></a>6.5ã€Appè¯·æ±‚Vsyncä¿¡å·</h3><p>å‰é¢è®²è§£ViewRootImpl.setView()çš„æ—¶å€™ï¼Œå› æ¶‰åŠåˆ°Vsyncä¿¡å·çŸ¥è¯†ï¼ŒrequestLayout()æ²¡æœ‰å…·ä½“è®²è§£ï¼Œç°åœ¨ç»§ç»­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;Choreographer.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallback</span><span class="params">(<span class="keyword">int</span> callbackType, Runnable action, Object token)</span> </span>&#123;</span><br><span class="line">    postCallbackDelayed(callbackType, action, token, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallbackDelayed</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">        Runnable action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    postCallbackDelayedInternal(callbackType, action, token, delayMillis);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postCallbackDelayedInternal</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> dueTime = now + delayMillis;</span><br><span class="line">        <span class="comment">//å°†è¦æ‰§è¡Œçš„å›è°ƒå°è£…æˆCallbackRecordå¯¹è±¡ï¼Œä¿å­˜åˆ°mCallbackQueuesæ•°ç»„ä¸­</span></span><br><span class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">            scheduleFrameLocked(now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">            msg.arg1 = callbackType;</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleFrameLocked</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mFrameScheduled) &#123;</span><br><span class="line">        mFrameScheduled = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (USE_VSYNC) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isRunningOnLooperThreadLocked()) &#123;</span><br><span class="line">                scheduleVsyncLocked();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_VSYNC);</span><br><span class="line">                msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">                mHandler.sendMessageAtFrontOfQueue(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> nextFrameTime = Math.max(</span><br><span class="line">                    mLastFrameTimeNanos / TimeUtils.NANOS_PER_MS + sFrameDelay, now);</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_FRAME);</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, nextFrameTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆæ¯å¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FrameHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FrameHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_DO_SCHEDULE_VSYNC:</span><br><span class="line">                doScheduleVsync();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doScheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFrameScheduled) &#123;</span><br><span class="line">            scheduleVsyncLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleVsyncLocked</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="comment">//ç”³è¯·Vsyncä¿¡å·  </span></span><br><span class="line">mDisplayEventReceiver.scheduleVsync();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°ä¸­è€ƒè™‘äº†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ç³»ç»Ÿæ²¡æœ‰ä½¿ç”¨Vsyncæœºåˆ¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆæ ¹æ®å±å¹•åˆ·æ–°é¢‘ç‡è®¡ç®—ä¸‹ä¸€æ¬¡åˆ·æ–°æ—¶é—´ï¼Œé€šè¿‡å¼‚æ­¥æ¶ˆæ¯æ–¹å¼å»¶æ—¶æ‰§è¡ŒdoFrame()å‡½æ•°å®ç°å±å¹•åˆ·æ–°ã€‚å¦‚æœç³»ç»Ÿä½¿ç”¨äº†Vsyncæœºåˆ¶ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹å…·å¤‡æ¶ˆæ¯å¾ªç¯ï¼Œåˆ™ç›´æ¥è¯·æ±‚Vsyncä¿¡å·ï¼Œå¦åˆ™å°±é€šè¿‡ä¸»çº¿ç¨‹æ¥è¯·æ±‚Vsyncä¿¡å·ã€‚</p><h3 id="6-5-1ã€Vsyncè¯·æ±‚è¿‡ç¨‹"><a href="#6-5-1ã€Vsyncè¯·æ±‚è¿‡ç¨‹" class="headerlink" title="6.5.1ã€Vsyncè¯·æ±‚è¿‡ç¨‹"></a>6.5.1ã€Vsyncè¯·æ±‚è¿‡ç¨‹</h3><p>æˆ‘ä»¬çŸ¥é“åœ¨Choreographeræ„é€ å‡½æ•°ä¸­ï¼Œæ„é€ äº†ä¸€ä¸ªFrameDisplayEventReceiverå¯¹è±¡ï¼Œç”¨äºè¯·æ±‚å¹¶æ¥æ”¶Vsyncä¿¡å·ï¼ŒVsyncä¿¡å·è¯·æ±‚è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleVsyncLocked</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="comment">//ç”³è¯·Vsyncä¿¡å·  </span></span><br><span class="line">mDisplayEventReceiver.scheduleVsync();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;DisplayEventReceiver.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mReceiverPtr == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Attempted to schedule a vertical sync pulse but the display event "</span></span><br><span class="line">                + <span class="string">"receiver has already been disposed."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeScheduleVsync(mReceiverPtr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_DisplayEventReceiver.cpp ]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeScheduleVsync</span><span class="params">(JNIEnv* env, jclass clazz, jlong receiverPtr)</span> </span>&#123;</span><br><span class="line">sp&lt;NativeDisplayEventReceiver&gt; receiver =</span><br><span class="line">        reinterpret_cast&lt;NativeDisplayEventReceiver*&gt;(receiverPtr);</span><br><span class="line">status_t status = receiver-&gt;scheduleVsync();</span><br><span class="line"><span class="keyword">if</span> (status) &#123;</span><br><span class="line">    String8 message;</span><br><span class="line">    message.appendFormat(<span class="string">"Failed to schedule next vertical sync pulse.  status=%d"</span>, status);</span><br><span class="line">    jniThrowRuntimeException(env, message.string());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VSyncè¯·æ±‚è¿‡ç¨‹åˆè½¬äº¤ç»™äº†DisplayEventReceiverï¼š [-&gt;DisplayEventReceiver.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">status_t DisplayEventReceiver::requestNextVsync() &#123;</span><br><span class="line"><span class="keyword">if</span> (mEventConnection != NULL) &#123;</span><br><span class="line">    mEventConnection-&gt;requestNextVsync();</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> NO_INIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„mEventConnectionä¹Ÿæ˜¯å‰é¢åˆ›å»ºnativeå±‚å¯¹è±¡NativeDisplayEventReceiveræ—¶åˆ›å»ºçš„ï¼Œå®é™…å¯¹è±¡æ˜¯ä¸€ä¸ªBpDisplayEventConnectionå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªBinderå®¢æˆ·ç«¯ï¼Œå¯¹åº”çš„BinderæœåŠ¡ç«¯BnDisplayEventConnectionæ˜¯ä¸€ä¸ªEventThread::Connectionå¯¹è±¡ï¼Œå¯¹åº”çš„BpDisplayEventConnection.requestNextVsyncå‡½æ•°å’ŒBnDisplayEventConnection.onTransact(REQUEST_NEXT_VSYNC)å‡½æ•°æ²¡æœ‰è¿›è¡Œç‰¹åˆ«çš„å¤„ç†ï¼Œä¸‹é¢å°±è°ƒç”¨åˆ°EventThread::Connection.requestNextVsyncå‡½æ•°ï¼Œä»BnDisplayEventConnection.onTransact(REQUEST_NEXT_VSYNC)å¼€å§‹å·²ç»ä»ç”¨æˆ·è¿›ç¨‹å°†éœ€è¦å‚ç›´åŒæ­¥ä¿¡å·çš„è¯·æ±‚å‘é€åˆ°äº†SurfaceFlingerè¿›ç¨‹ï¼Œä¸‹é¢çš„å‡½æ•°è°ƒç”¨å¼€å§‹è¿›å…¥SFè¿›ç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> EventThread::Connection::requestNextVsync() &#123;</span><br><span class="line">    mEventThread-&gt;requestNextVsync(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¾—è½¬è°ƒç”¨åˆ°EventThread.requestNextVsyncå‡½æ•°ï¼Œæ³¨æ„é‡Œé¢ä¼ äº†å‚æ•°thisï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„EventThread::Connectionå¯¹è±¡ï¼Œéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œè¿™é‡Œçš„mEventThreadå¯¹è±¡æ˜¯åˆ›å»ºEventThread::Connectionå¯¹è±¡çš„æ—¶å€™ä¿å­˜çš„ï¼Œå¯¹åº”çš„æ˜¯SurfaceFlingerå¯¹è±¡çš„é‡Œé¢çš„mEventThreadæˆå‘˜ï¼Œè¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªåœ¨SurfaceFlinger.inité‡Œé¢åˆ›å»ºå¹¶å¯åŠ¨çš„çº¿ç¨‹å¯¹è±¡ï¼Œå¯è§è®¾è®¡çš„æ—¶å€™å°±ä¸“é—¨ç”¨è¿™ä¸ªSurfaceFlinger.mEventThreadçº¿ç¨‹æ¥æ¥æ”¶æ¥è‡ªåº”ç”¨è¿›ç¨‹çš„åŒæ­¥ä¿¡å·è¯·æ±‚ï¼Œæ¯æ¥ä¸€ä¸ªåº”ç”¨è¿›ç¨‹åŒæ­¥ä¿¡å·è¯·æ±‚ï¼Œå°±é€šè¿‡SurfaceFlinger.mEventThreadåˆ›å»ºä¸€ä¸ªEventThread::Connectionå¯¹è±¡ï¼Œå¹¶é€šè¿‡EventThread.registerDisplayEventConnectionå‡½æ•°å°†åˆ›å»ºçš„EventThread::Connectionå¯¹è±¡ä¿å­˜åˆ°EventThread.mDisplayEventConnectionsé‡Œé¢ï¼Œä¸Šé¢æœ‰è°ƒç”¨åˆ°äº†EventThread.requestNextVsyncå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> EventThread::requestNextVsync(<span class="keyword">const</span> sp&lt;EventThread::Connection&gt;&amp; connection) &#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="keyword">if</span> (connection-&gt;count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        connection-&gt;count = <span class="number">0</span>;</span><br><span class="line">        mCondition.broadcast();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼ è¿›æ¥çš„æ˜¯ä¸€ä¸ªå‰é¢åˆ›å»ºçš„EventThread::Connectionå¯¹è±¡ï¼Œé‡Œé¢åˆ¤æ–­åˆ°äº†EventThread::Connection.countæˆå‘˜å˜é‡ï¼Œçœ‹ä¸€ä¸‹EventThread::Connectionæ„é€ å‡½æ•°ä¸­åˆå§‹å˜é‡çš„å€¼ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EventThread::Connection::Connection(<span class="keyword">const</span> sp&lt;EventThread&gt;&amp; eventThread)</span><br><span class="line">    : count(<span class="number">-1</span>), mEventThread(eventThread), mChannel(<span class="keyword">new</span> BitTube())&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆå§‹å€¼æ˜¯-1ï¼Œè¿™ä¸ªå€¼å°±æ˜¯å‰é¢é‚£ä¸ªé—®é¢˜çš„å…³é”®ï¼ŒEventThread::Connection.countæ ‡ç¤ºäº†è¿™æ¬¡åº”ç”¨è¿›ç¨‹çš„å‚ç›´åŒæ­¥ä¿¡å·çš„è¯·æ±‚æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè¿˜æ˜¯å¤šæ¬¡é‡å¤çš„ï¼Œçœ‹ä¸€ä¸‹æ³¨é‡Šé‡Œé¢å¯¹äºè¿™ä¸ªå˜é‡çš„è¯´æ˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// count &gt;= 1 : continuous event. count is the vsync rate</span></span><br><span class="line"><span class="comment">// count == 0 : one-shot event that has not fired</span></span><br><span class="line"><span class="comment">// count ==-1 : one-shot event that fired this round / disabled</span></span><br><span class="line"><span class="keyword">int32_t</span> count;</span><br></pre></td></tr></table></figure><p>å¾ˆæ¸…æ¥šçš„è¯´æ˜äº†ï¼Œcount = 0è¯´æ˜å½“å‰çš„å‚ç›´åŒæ­¥ä¿¡å·è¯·æ±‚æ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§çš„è¯·æ±‚ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰è¢«å¤„ç†ã€‚ä¸Šé¢EventThread::requestNextVsyncé‡Œé¢å°†countè®¾ç½®æˆ0ï¼ŒåŒæ—¶è°ƒç”¨äº†mCondition.broadcast()å”¤é†’æ‰€æœ‰æ­£åœ¨ç­‰å¾…mConditionçš„çº¿ç¨‹ï¼Œè¿™ä¸ªä¼šè§¦å‘EventThread.waitForEventå‡½æ•°ä»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mCondition.wait(mLock);</span><br></pre></td></tr></table></figure><p>ä¸­é†’æ¥ï¼Œé†’æ¥ä¹‹åç»è¿‡ä¸€è½®doâ€¦whileå¾ªç¯å°±ä¼šè¿”å›ï¼Œè¿”å›ä»¥åè°ƒç”¨åºåˆ—å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰EventThread::Connection.postEvent(event) ï¼ˆ2ï¼‰DisplayEventReceiver::sendEvents(mChannel, &amp;event, 1)ï¼ŒmChannelå‚æ•°å°±æ˜¯å‰é¢åˆ›å»ºDisplayEventReceiveræ˜¯åˆ›å»ºçš„BitTubeå¯¹è±¡ ï¼ˆ3ï¼‰BitTube::sendObjects(dataChannel, events, count)ï¼Œstaticå‡½æ•°ï¼Œé€šè¿‡dataChannelæŒ‡å‘BitTubeå¯¹è±¡ æœ€ç»ˆè°ƒç”¨åˆ°BitTube::sendObjectså‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> BitTube::sendObjects(<span class="keyword">const</span> sp&lt;BitTube&gt;&amp; tube, <span class="keyword">void</span> <span class="keyword">const</span>* events, <span class="keyword">size_t</span> count, <span class="keyword">size_t</span> objSize)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* vaddr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(events);</span><br><span class="line">    <span class="keyword">ssize_t</span> size = tube-&gt;write(vaddr, count*objSize);</span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? size : size / <span class="keyword">static_cast</span>&lt;<span class="keyword">ssize_t</span>&gt;(objSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è°ƒç”¨åˆ°BitTube::writeå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> BitTube::write(<span class="keyword">void</span> <span class="keyword">const</span>* vaddr, <span class="keyword">size_t</span> size)&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> err, len;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        len = ::send(mSendFd, vaddr, size, MSG_DONTWAIT | MSG_NOSIGNAL);</span><br><span class="line">        <span class="comment">// cannot return less than size, since we're using SOCK_SEQPACKET</span></span><br><span class="line">        err = len &lt; <span class="number">0</span> ? errno : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (err == EINTR);</span><br><span class="line">    <span class="keyword">return</span> err == <span class="number">0</span> ? len : -err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨åˆ°äº†::sendå‡½æ•°ï¼Œ::æ˜¯ä½œç”¨åŸŸæè¿°ç¬¦ï¼Œå¦‚æœå‰é¢æ²¡æœ‰ç±»åä¹‹ç±»çš„ï¼Œä»£è¡¨çš„å°±æ˜¯å…¨å±€çš„ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨å…¨å±€å‡½æ•°sendï¼Œè¿™é‡Œå¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°è¿™æ˜¯ä¸€ä¸ªsocketçš„å†™å…¥å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å°†eventäº‹ä»¶æ•°æ®å†™å…¥åˆ°BitTubeä¸­äº’è”çš„socketä¸­ï¼Œè¿™æ ·åœ¨å¦ä¸€ç«¯é©¬ä¸Šå°±èƒ½æ”¶åˆ°å†™å…¥çš„æ•°æ®ï¼Œå‰é¢åˆ†æåˆ°è¿™ä¸ªBitTubeçš„socketçš„ä¸¤ç«¯è¿æ¥ç€SurfaceFlingerè¿›ç¨‹å’Œåº”ç”¨è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡è°ƒç”¨BitTube::writeå‡½æ•°ï¼Œå°†æœ€åˆç”±SurfaceFlingeræ•è·åˆ°çš„å‚ç›´ä¿¡å·äº‹ä»¶ç»ç”±BitTubeä¸­äº’è”çš„socketä»SurfaceFlingerè¿›ç¨‹å‘é€åˆ°äº†åº”ç”¨è¿›ç¨‹ä¸­BitTubeçš„socketæ¥æ”¶ç«¯ã€‚ ä¸‹é¢å°±è¦åˆ†æåº”ç”¨è¿›ç¨‹æ˜¯å¦‚ä½•æ¥æ”¶å¹¶ä½¿ç”¨è¿™ä¸ªå‚ç›´åŒæ­¥ä¿¡å·äº‹ä»¶çš„ã€‚</p><h3 id="6-5-2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync"><a href="#6-5-2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync" class="headerlink" title="6.5.2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync"></a>6.5.2ã€åº”ç”¨è¿›ç¨‹æ¥æ”¶VSync</h3><h4 id="6-5-2-1ã€è§£æVSyncäº‹ä»¶"><a href="#6-5-2-1ã€è§£æVSyncäº‹ä»¶" class="headerlink" title="6.5.2.1ã€è§£æVSyncäº‹ä»¶"></a>6.5.2.1ã€è§£æVSyncäº‹ä»¶</h4><p>VSyncåŒæ­¥ä¿¡å·äº‹ä»¶å·²ç»å‘é€åˆ°ç”¨æˆ·è¿›ç¨‹ä¸­çš„socketæ¥æ”¶ç«¯ï¼Œåœ¨å‰é¢NativeDisplayEventReceiver.initializeä¸­åˆ†æåˆ°åº”ç”¨è¿›ç¨‹ç«¯çš„socketæ¥æ”¶æè¿°ç¬¦å·²ç»è¢«æ·»åŠ åˆ°Choreographeræ‰€åœ¨çº¿ç¨‹çš„nativeå±‚çš„Looperæœºåˆ¶ä¸­ï¼Œåœ¨epollä¸­ç›‘å¬EPOLLINäº‹ä»¶ï¼Œå½“socketæ”¶åˆ°æ•°æ®åï¼Œepollä¼šé©¬ä¸Šè¿”å›ï¼Œä¸‹é¢åˆ†æ­¥éª¤çœ‹ä¸€ä¸‹Looper.pollInner()æ•°ï¼š ï¼ˆ1ï¼‰epoll_wait</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">eventItems</span>[<span class="title">EPOLL_MAX_EVENTS</span>];</span></span><br><span class="line"><span class="keyword">int</span> eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</span><br></pre></td></tr></table></figure><p>åœ¨ç›‘å¬åˆ°æè¿°ç¬¦å¯¹åº”çš„äº‹ä»¶åï¼Œepoll_waitä¼šé©¬ä¸Šè¿”å›ï¼Œå¹¶å°†äº§ç”Ÿçš„å…·ä½“äº‹ä»¶ç±»å‹å†™å…¥åˆ°å‚æ•°eventItemsé‡Œé¢ï¼Œæœ€ç»ˆè¿”å›çš„eventCountæ˜¯ç›‘å¬åˆ°çš„äº‹ä»¶çš„ä¸ªæ•° ï¼ˆ2ï¼‰äº‹ä»¶åˆ†æ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; eventCount; i++) &#123;</span><br><span class="line">     <span class="keyword">int</span> fd = eventItems[i].data.fd;</span><br><span class="line">     <span class="keyword">uint32_t</span> epollEvents = eventItems[i].events;</span><br><span class="line">     <span class="keyword">if</span> (fd == mWakeReadPipeFd) &#123;   <span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯pipeè¯»ç®¡é“çš„äº‹ä»¶   è¿™é‡Œå¦‚æœæ˜¯EventThread,è¿™é‡Œå°±æ˜¯ä¸€ä¸ªsocketçš„æè¿°ç¬¦,è€Œä¸æ˜¯mWakeReadPipeFd</span></span><br><span class="line">         <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) &#123;</span><br><span class="line">             awoken(); <span class="comment">// æ¸…ç©ºè¯»ç®¡é“ä¸­çš„æ•°æ®</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ALOGW(<span class="string">"Ignoring unexpected epoll events 0x%x on wake read pipe."</span>, epollEvents);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//EventThreadæ¥æ”¶åˆ°åŒæ­¥ä¿¡å·èµ°çš„è¿™é‡Œ</span></span><br><span class="line">         <span class="keyword">ssize_t</span> requestIndex = mRequests.indexOfKey(fd);</span><br><span class="line">         <span class="keyword">if</span> (requestIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">int</span> events = <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT;</span><br><span class="line">             <span class="keyword">if</span> (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT;</span><br><span class="line">             <span class="keyword">if</span> (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR;</span><br><span class="line">             <span class="keyword">if</span> (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP;</span><br><span class="line">             pushResponse(events, mRequests.valueAt(requestIndex));</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ALOGW(<span class="string">"Ignoring unexpected epoll events 0x%x on fd %d that is "</span></span><br><span class="line">                     <span class="string">"no longer registered."</span>, epollEvents, fd);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>Looperç›®å‰äº†è§£åˆ°çš„ä¸»è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ç§ç±»æœ‰ä¸¤ç§ï¼š 1ï¼‰æ¶ˆæ¯äº‹ä»¶ï¼Œepoll_waitç›‘å¬pipeç®¡é“çš„æ¥æ”¶ç«¯æè¿°ç¬¦mWakeReadPipeFd 2ï¼‰ä¸VSyncä¿¡å·ï¼Œepoll_waitç›‘å¬socketæ¥æ”¶ç«¯æè¿°ç¬¦ï¼Œå¹¶åœ¨addFdçš„è¿‡ç¨‹ä¸­å°†ç›¸å…³çš„ä¿¡æ¯å°è£…åœ¨ä¸€ä¸ªRequestç»“æ„ä¸­ï¼Œå¹¶ä»¥fdä¸ºkeyå­˜å‚¨åˆ°äº†mRequestsä¸­ï¼Œå…·ä½“å¯ä»¥å›è¿‡å¤´çœ‹3.1.2å…³äºaddFdçš„åˆ†æï¼› å› æ­¤ï¼Œä¸Šé¢èµ°çš„æ˜¯elseçš„åˆ†æ”¯ï¼Œè¾¨åˆ«å‡ºå½“å‰çš„äº‹ä»¶ç±»å‹åï¼Œè°ƒç”¨pushResponseï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Looper::pushResponse(<span class="keyword">int</span> events, <span class="keyword">const</span> Request&amp; request) &#123;</span><br><span class="line">    Response response;</span><br><span class="line">    response.events = events;</span><br><span class="line">    response.request = request;  <span class="comment">//å¤åˆ¶ä¸æ˜¯å¼•ç”¨ï¼Œè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">    mResponses.push(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å°†Requestå’Œeventså°è£…åœ¨ä¸€ä¸ªResponseå¯¹è±¡é‡Œé¢ï¼Œå­˜å‚¨åˆ°äº†mResponsesé‡Œé¢ï¼Œä¹Ÿå°±æ˜¯mResponsesé‡Œé¢æ”¾çš„æ˜¯â€æŸæŸfdä¸Šæ¥æ”¶åˆ°äº†ç±»åˆ«ä¸ºeventsçš„æ—¶é—´â€è®°å½•ï¼Œç»§ç»­å‘ä¸‹çœ‹Looper.pollInnerå‡½æ•° ï¼ˆ3ï¼‰äº‹ä»¶åˆ†å‘å¤„ç†</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invoke all response callbacks.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mResponses.size(); i++) &#123;</span><br><span class="line">    Response&amp; response = mResponses.editItemAt(i);</span><br><span class="line">    <span class="keyword">if</span> (response.request.ident == POLL_CALLBACK) &#123;</span><br><span class="line">        <span class="keyword">int</span> fd = response.request.fd;</span><br><span class="line">        <span class="keyword">int</span> events = response.events;</span><br><span class="line">        <span class="keyword">void</span>* data = response.request.data;</span><br><span class="line">        <span class="keyword">int</span> callbackResult = response.request.callback-&gt;handleEvent(fd, events, data);</span><br><span class="line">        <span class="keyword">if</span> (callbackResult == <span class="number">0</span>) &#123;</span><br><span class="line">            removeFd(fd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Clear the callback reference in the response structure promptly because we</span></span><br><span class="line">        <span class="comment">// will not clear the response vector itself until the next poll.</span></span><br><span class="line">        response.request.callback.clear();</span><br><span class="line">        result = POLL_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„response.requestæ˜¯ä»pushResponseé‡Œé¢å¤åˆ¶è¿‡æ¥çš„ï¼Œé‡Œé¢çš„requestå¯¹åº”çš„Requestå¯¹è±¡æ˜¯åœ¨addFdçš„æ—¶å€™åˆ›å»ºçš„ï¼Œidentæˆå‘˜å°±æ˜¯POLL_CALLBACKï¼Œæ‰€ä»¥ç»§ç»­èµ°åˆ°response.request.callback-&gt;handleEventè¿™ä¸ªå‡½æ•°ï¼Œå›å¿†ä¸€ä¸‹3.1.2é‡Œé¢çš„addFdå‡½æ•°ï¼Œè¿™é‡Œçš„callbackå®é™…ä¸Šæ˜¯ä¸€ä¸ªSimpleLooperCallbackï¼ˆå®šä¹‰åœ¨Looper.cppä¸­ï¼‰å¯¹è±¡ï¼Œçœ‹ä¸€ä¸‹é‡Œé¢çš„handleEventå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> SimpleLooperCallback::handleEvent(<span class="keyword">int</span> fd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">return</span> mCallback(fd, events, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„mCallbackå°±æ˜¯å½“æ—¶åœ¨addFdçš„æ—¶å€™ä¼ è¿›æ¥çš„callBackå‚æ•°ï¼Œå®é™…ä¸Šå¯¹åº”çš„å°±æ˜¯NativeDisplayEventReceiverå¯¹è±¡æœ¬èº«ï¼Œå› æ­¤æœ€ç»ˆå°±å°†å‚ç›´åŒæ­¥ä¿¡å·äº‹ä»¶åˆ†å‘åˆ°äº†NativeDisplayEventReceiver.handleEventå‡½æ•°ä¸­ã€‚</p><h3 id="6-5-3ã€VSyncäº‹ä»¶åˆ†å‘"><a href="#6-5-3ã€VSyncäº‹ä»¶åˆ†å‘" class="headerlink" title="6.5.3ã€VSyncäº‹ä»¶åˆ†å‘"></a>6.5.3ã€<strong>VSyncäº‹ä»¶åˆ†å‘</strong></h3><p>è°ƒç”¨åˆ°NativeDisplayEventReceiver.handleEventå‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰åœ¨android_view_DisplayEventReceiver.cppä¸­ï¼Œç›´æ¥åˆ—å‡ºè¯¥å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> NativeDisplayEventReceiver::handleEvent(<span class="keyword">int</span> receiveFd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; (Looper::EVENT_ERROR | Looper::EVENT_HANGUP)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Display event receiver pipe was closed or an error occurred.  "</span></span><br><span class="line">                <span class="string">"events=0x%x"</span>, events);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// remove the callback</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(events &amp; Looper::EVENT_INPUT)) &#123;</span><br><span class="line">        ALOGW(<span class="string">"Received spurious callback for unhandled poll event.  "</span></span><br><span class="line">                <span class="string">"events=0x%x"</span>, events);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// keep the callback</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Drain all pending events, keep the last vsync.</span></span><br><span class="line">    <span class="keyword">nsecs_t</span> vsyncTimestamp;</span><br><span class="line">    <span class="keyword">int32_t</span> vsyncDisplayId;</span><br><span class="line">    <span class="keyword">uint32_t</span> vsyncCount;</span><br><span class="line">    <span class="keyword">if</span> (processPendingEvents(&amp;vsyncTimestamp, &amp;vsyncDisplayId, &amp;vsyncCount)) &#123;</span><br><span class="line">        ALOGV(<span class="string">"receiver %p ~ Vsync pulse: timestamp=%"</span> PRId64 <span class="string">", id=%d, count=%d"</span>,</span><br><span class="line">                <span class="keyword">this</span>, vsyncTimestamp, vsyncDisplayId, vsyncCount);</span><br><span class="line">        mWaitingForVsync = <span class="literal">false</span>;</span><br><span class="line">        dispatchVsync(vsyncTimestamp, vsyncDisplayId, vsyncCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// keep the callback</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­äº‹ä»¶æ˜¯ä¸æ˜¯æ­£ç¡®çš„Looper::EVENT_INPUTäº‹ä»¶ï¼Œç„¶åè°ƒç”¨åˆ°NativeDisplayEventReceiver.processPendingEventså‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> NativeDisplayEventReceiver::processPendingEvents(<span class="keyword">nsecs_t</span>* outTimestamp, <span class="keyword">int32_t</span>* outId, <span class="keyword">uint32_t</span>* outCount) &#123;</span><br><span class="line">    <span class="keyword">bool</span> gotVsync = <span class="literal">false</span>;</span><br><span class="line">    DisplayEventReceiver::Event buf[EVENT_BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">ssize_t</span> n;</span><br><span class="line">    <span class="keyword">while</span> ((n = mReceiver.getEvents(buf, EVENT_BUFFER_SIZE)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">ssize_t</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> DisplayEventReceiver::Event&amp; ev = buf[i];</span><br><span class="line">            <span class="keyword">switch</span> (ev.header.type) &#123;</span><br><span class="line">            <span class="keyword">case</span> DisplayEventReceiver::DISPLAY_EVENT_VSYNC:</span><br><span class="line">                <span class="comment">// Later vsync events will just overwrite the info from earlier</span></span><br><span class="line">                <span class="comment">// ones. That's fine, we only care about the most recent.</span></span><br><span class="line">                gotVsync = <span class="literal">true</span>;</span><br><span class="line">                *outTimestamp = ev.header.timestamp;</span><br><span class="line">                *outId = ev.header.id;</span><br><span class="line">                *outCount = ev.vsync.count;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DisplayEventReceiver::DISPLAY_EVENT_HOTPLUG:</span><br><span class="line">                dispatchHotplug(ev.header.timestamp, ev.header.id, ev.hotplug.connected);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                ALOGW(<span class="string">"receiver %p ~ ignoring unknown event type %#x"</span>, <span class="keyword">this</span>, ev.header.type);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"Failed to get events from display event receiver, status=%d"</span>, <span class="keyword">status_t</span>(n));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> gotVsync;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„mReceiverä¹Ÿå°±æ˜¯å‰é¢åˆ›å»ºNativeDisplayEventReceiverå¯¹è±¡æ˜¯åˆ›å»ºçš„æˆå‘˜å˜é‡å¯¹è±¡DisplayEventReceiverï¼Œä¸‹é¢è°ƒç”¨åˆ°DisplayEventReceiver.getEventså‡½æ•°ï¼Œåº”è¯¥æ˜¯è¦ä»å‡ºç°åŒæ­¥ä¿¡å·äº‹ä»¶çš„socketä¸­è¯»å–æ•°æ®ï¼Œä¸Šé¢Looperæœºåˆ¶ä¸­epollä¸­ç›‘å¬åˆ°socketä»¥åï¼Œè¿”å›åˆ°NativeDisplayEventReceiver.handleEventé‡Œé¢ï¼Œä½†æ˜¯socketé‡Œé¢çš„æ•°æ®è¿˜æ²¡æœ‰è¯»å–ï¼Œä¸‹é¢çš„è°ƒç”¨æµç¨‹ä¸ºï¼š ï¼ˆ1ï¼‰mReceiver.getEvents(buf, EVENT_BUFFER_SIZE) â€”&gt; DisplayEventReceiver::getEvents(DisplayEventReceiver::Event _events, size<em>t count) ï¼ˆ2ï¼‰BitTube::recvObjects(dataChannel, events, count) â€”&gt; BitTube::recvObjects(const sp&amp; tube, void</em> events, size_t count, size_t objSize) çœ‹ä¸€ä¸‹è¿™ä¸ªrecvObjectså‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> BitTube::recvObjects(<span class="keyword">const</span> sp&lt;BitTube&gt;&amp; tube, <span class="keyword">void</span>* events, <span class="keyword">size_t</span> count, <span class="keyword">size_t</span> objSize)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span>* vaddr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(events);</span><br><span class="line">    <span class="keyword">ssize_t</span> size = tube-&gt;read(vaddr, count*objSize);</span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? size : size / <span class="keyword">static_cast</span>&lt;<span class="keyword">ssize_t</span>&gt;(objSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨NativeDisplayEventReceiverä¸­åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶åœ¨recvObjectsä¸­å°†socketä¸­çš„Eventæ•°æ®è¯»åˆ°è¿™ä¸ªç¼“å†²åŒºä¸­ï¼Œè¿™ä¸ªEvent.header.typeä¸€èˆ¬éƒ½æ˜¯DISPLAY_EVENT_VSYNCï¼Œå› æ­¤åœ¨ä¸Šé¢çš„processPendingEventså‡½æ•°ä¸­ä¼šå°†Eventæ•°æ®ä¿å­˜åœ¨outCountæ‰€æŒ‡å‘çš„å†…å­˜ä¸­ï¼Œå¹¶è¿”å›trueã€‚ æ¥ä¸‹æ¥è¿”å›åˆ°NativeDisplayEventReceiver.handleEventåä¼šè°ƒç”¨åˆ°dispatchVsyncå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NativeDisplayEventReceiver::dispatchVsync(<span class="keyword">nsecs_t</span> timestamp, <span class="keyword">int32_t</span> id, <span class="keyword">uint32_t</span> count) &#123;</span><br><span class="line">    JNIEnv* env = AndroidRuntime::getJNIEnv();</span><br><span class="line">    env-&gt;CallVoidMethod(mReceiverObjGlobal, gDisplayEventReceiverClassInfo.dispatchVsync, timestamp, id, count);</span><br><span class="line">    mMessageQueue-&gt;raiseAndClearException(env, <span class="string">"dispatchVsync"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å¤„ç†å¾ˆç›´æ¥ï¼Œç›´æ¥è°ƒç”¨mReceiverObjGlobalå¯¹è±¡åœ¨gDisplayEventReceiverClassInfo.dispatchVsyncä¸­æŒ‡å®šçš„å‡½æ•°ï¼Œå°†åé¢çš„timestampï¼ˆæ—¶é—´æˆ³ï¼‰ idï¼ˆè®¾å¤‡IDï¼‰ countï¼ˆç»è¿‡çš„åŒæ­¥ä¿¡å·çš„æ•°é‡ï¼Œä¸€èˆ¬æ²¡æœ‰è®¾ç½®é‡‡æ ·é¢‘ç‡åº”è¯¥éƒ½æ˜¯1ï¼‰ï¼Œä¸‹é¢åˆ†åˆ«çœ‹ä¸€ä¸‹mReceiverObjGlobalä»¥åŠgDisplayEventReceiverClassInfo.dispatchVsyncä»£è¡¨çš„æ˜¯ä»€ä¹ˆï¼Ÿ ï¼ˆ1ï¼‰mReceiverObjGlobal</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NativeDisplayEventReceiver::NativeDisplayEventReceiver(JNIEnv* env, jobject receiverObj, <span class="keyword">const</span> sp&lt;MessageQueue&gt;&amp; messageQueue) :</span><br><span class="line">        mReceiverObjGlobal(env-&gt;NewGlobalRef(receiverObj)), mMessageQueue(messageQueue), mWaitingForVsync(<span class="literal">false</span>) &#123;</span><br><span class="line">    ALOGV(<span class="string">"receiver %p ~ Initializing input event receiver."</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°mReceiverObjGlobalæ˜¯åˆ›å»ºNativeDisplayEventReceiverå¯¹è±¡æ—¶ä¼ è¿›æ¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¯¥å¯¹è±¡æ˜¯åœ¨nativeInitå‡½æ•°ä¸­åˆ›å»ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp receiver = <span class="keyword">new</span> NativeDisplayEventReceiver(env, receiverObj, messageQueue);</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥çš„ï¼ŒreceiverObjæ˜¯è°ƒç”¨nativeInitå‡½æ•°æ—¶ä¼ è¿›æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°envæ˜¯ç³»ç»Ÿç”¨äºè¿æ¥è™šæ‹Ÿæœºæ—¶è‡ªåŠ¨åŠ ä¸Šçš„ï¼‰ï¼ŒnativeInitå‡½æ•°åˆæ˜¯åœ¨Choreographerä¸­åˆ›å»ºFrameDisplayEventReceiverå¯¹è±¡æ—¶ï¼Œåœ¨åŸºç±»DisplayEventReceiveræ„é€ å™¨ä¸­è°ƒç”¨çš„ï¼Œå› æ­¤è¿™é‡Œçš„mReceiverObjGlobalå¯¹åº”çš„å°±æ˜¯Choreographerä¸­çš„FrameDisplayEventReceiveræˆå‘˜mDisplayEventReceiverã€‚ ï¼ˆ2ï¼‰gDisplayEventReceiverClassInfo.dispatchVsync åœ¨JNIä¸­æœ‰å¾ˆå¤šè¿™æ ·çš„ç±»ä¼¼çš„ç»“æ„ä½“å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡éƒ½æ˜¯å…¨å±€ç»“æ„ä½“å¯¹è±¡ï¼Œè¿™é‡Œçš„gDisplayEventReceiverClassInfoå°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æè¿°äº†ä¸€äº›åœ¨æ•´ä¸ªæ–‡ä»¶å†…å¯èƒ½ä¼šè°ƒç”¨åˆ°çš„javaå±‚çš„ç›¸å…³ç±»ä»¥åŠæˆå‘˜å‡½æ•°çš„ç›¸å…³ä¿¡æ¯ï¼Œçœ‹ä¸€ä¸‹gDisplayEventReceiverClassInfoï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    jclass clazz;</span><br><span class="line">    jmethodID dispatchVsync;</span><br><span class="line">    jmethodID dispatchHotplug;</span><br><span class="line">&#125; gDisplayEventReceiverClassInfo;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹é‡Œé¢çš„å˜é‡åç§°å°±èƒ½çŸ¥é“å¤§è‡´çš„å«ä¹‰ï¼Œclazzæˆå‘˜ä»£è¡¨çš„æ˜¯æŸä¸ªjavaå±‚çš„ç±»çš„classä¿¡æ¯ï¼ŒdispatchVsyncå’ŒdispatchHotplugä»£è¡¨çš„æ˜¯javaå±‚ç±»çš„æ–¹æ³•çš„æ–¹æ³•ä¿¡æ¯ï¼Œçœ‹ä¸€ä¸‹è¯¥æ–‡ä»¶ä¸­æ³¨å†ŒJNIå‡½æ•°çš„æ–¹æ³•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_view_DisplayEventReceiver</span><span class="params">(JNIEnv* env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = RegisterMethodsOrDie(env, <span class="string">"android/view/DisplayEventReceiver"</span>, gMethods, NELEM(gMethods));</span><br><span class="line">    jclass clazz = FindClassOrDie(env, <span class="string">"android/view/DisplayEventReceiver"</span>);</span><br><span class="line">    gDisplayEventReceiverClassInfo.clazz = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    gDisplayEventReceiverClassInfo.dispatchVsync = GetMethodIDOrDie(env, gDisplayEventReceiverClassInfo.clazz, <span class="string">"dispatchVsync"</span>, <span class="string">"(JII)V"</span>);</span><br><span class="line">    gDisplayEventReceiverClassInfo.dispatchHotplug = GetMethodIDOrDie(env, gDisplayEventReceiverClassInfo.clazz, <span class="string">"dispatchHotplug"</span>, <span class="string">"(JIZ)V"</span>);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RegisterMethodsOrDieè°ƒç”¨æ³¨å†Œäº†javaå±‚è°ƒç”¨nativeæ–¹æ³•æ—¶é“¾æ¥åˆ°çš„å‡½æ•°çš„å…¥å£ï¼Œä¸‹é¢clazzå¯¹åº”çš„å°±æ˜¯javaå±‚çš„â€android/view/DisplayEventReceiver.javaâ€ç±»ï¼ŒgDisplayEventReceiverClassInfo.dispatchVsyncé‡Œé¢ä¿å­˜çš„å°±æ˜¯clazzç±»ä¿¡æ¯ä¸­ä¸dispatchVsyncæ–¹æ³•ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒæ ·dispatchHotplugä¹Ÿæ˜¯ã€‚ åˆ†æåˆ°è¿™é‡Œï¼Œå°±çŸ¥é“åº”ç”¨è¿›ç¨‹nativeæ¥æ”¶åˆ°åŒæ­¥ä¿¡å·äº‹ä»¶åï¼Œä¼šè°ƒç”¨Choreographerä¸­çš„FrameDisplayEventReceiveræˆå‘˜mDisplayEventReceiverçš„dispatchVsyncæ–¹æ³•ã€‚</p><h3 id="6-5-4ã€åº”ç”¨æ¥æ”¶Vsync"><a href="#6-5-4ã€åº”ç”¨æ¥æ”¶Vsync" class="headerlink" title="6.5.4ã€åº”ç”¨æ¥æ”¶Vsync"></a>6.5.4ã€åº”ç”¨æ¥æ”¶Vsync</h3><p>çœ‹ä¸€ä¸‹FrameDisplayEventReceiver.dispatchVsyncæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯DisplayEventReceiver.dispatchVsyncæ–¹æ³•(Choreographer.java)ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// Called from native code.   </span><br><span class="line"> @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line"> private void dispatchVsync(long timestampNanos, int builtInDisplayId, int frame) &#123;</span><br><span class="line">     onVsync(timestampNanos, builtInDisplayId, frame);</span><br><span class="line"> &#125;</span><br><span class="line"> æ³¨é‡Šè¡¨æ˜è¿™ä¸ªæ–¹æ³•æ˜¯ä»nativeä»£ç è°ƒç”¨çš„ï¼Œè¯¥å‡½æ•°ç„¶åä¼šè°ƒç”¨FrameDisplayEventReceiver.onVsyncæ–¹æ³•ï¼š</span><br><span class="line">     @Override</span><br><span class="line">     public void onVsync(long timestampNanos, int builtInDisplayId, int frame) &#123;</span><br><span class="line">         // Ignore vsync from secondary display.</span><br><span class="line">         // This can be problematic because the call to scheduleVsync() is a one-shot.</span><br><span class="line">         // We need to ensure that we will still receive the vsync from the primary</span><br><span class="line">         // display which is the one we really care about.  Ideally we should schedule</span><br><span class="line">         // vsync for a particular display.</span><br><span class="line">         // At this time Surface Flinger won&apos;t send us vsyncs for secondary displays</span><br><span class="line">         // but that could change in the future so let&apos;s log a message to help us remember</span><br><span class="line">         // that we need to fix this.</span><br><span class="line">         //æ³¨é‡Šï¼šå¿½ç•¥æ¥è‡ªéä¸»æ˜¾ç¤ºå™¨çš„Vsyncä¿¡å·ï¼Œä½†æ˜¯æˆ‘ä»¬å‰é¢è°ƒç”¨çš„scheduleVsyncå‡½æ•°åªèƒ½è¯·æ±‚åˆ°ä¸€æ¬¡Vsyncä¿¡å·ï¼Œå› æ­¤éœ€è¦é‡æ–°è°ƒç”¨scheduleVsyncå‡½æ•°</span><br><span class="line">         //è¯·æ±‚æ¥è‡ªä¸»æ˜¾ç¤ºè®¾å¤‡çš„Vsyncä¿¡å·</span><br><span class="line">         if (builtInDisplayId != SurfaceControl.BUILT_IN_DISPLAY_ID_MAIN) &#123;</span><br><span class="line">             Log.d(TAG, &quot;Received vsync from secondary display, but we don&apos;t support &quot;</span><br><span class="line">                     + &quot;this case yet.  Choreographer needs a way to explicitly request &quot;</span><br><span class="line">                     + &quot;vsync for a specific display to ensure it doesn&apos;t lose track &quot;</span><br><span class="line">                     + &quot;of its scheduled vsync.&quot;);</span><br><span class="line">             scheduleVsync();</span><br><span class="line">             return;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         // Post the vsync event to the Handler.</span><br><span class="line">         // The idea is to prevent incoming vsync events from completely starving</span><br><span class="line">         // the message queue.  If there are no messages in the queue with timestamps</span><br><span class="line">         // earlier than the frame time, then the vsync event will be processed immediately.</span><br><span class="line">         // Otherwise, messages that predate the vsync event will be handled first.</span><br><span class="line">         long now = System.nanoTime();</span><br><span class="line">         if (timestampNanos &gt; now) &#123;</span><br><span class="line">             Log.w(TAG, &quot;Frame time is &quot; + ((timestampNanos - now) * 0.000001f)</span><br><span class="line">                     + &quot; ms in the future!  Check that graphics HAL is generating vsync &quot;</span><br><span class="line">                     + &quot;timestamps using the correct timebase.&quot;);</span><br><span class="line">             timestampNanos = now;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (mHavePendingVsync) &#123;</span><br><span class="line">             Log.w(TAG, &quot;Already have a pending vsync event.  There should only be &quot;</span><br><span class="line">                     + &quot;one at a time.&quot;);</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             mHavePendingVsync = true;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         mTimestampNanos = timestampNanos;  //åŒæ­¥ä¿¡å·æ—¶é—´æˆ³</span><br><span class="line">         mFrame = frame;                //åŒæ­¥ä¿¡å·çš„ä¸ªæ•°ï¼Œç†è§£å°±æ˜¯ä»è°ƒç”¨scheduleVsyncåˆ°onVsyncæ¥æ”¶åˆ°ä¿¡å·ä¹‹é—´ç»å†çš„åŒæ­¥ä¿¡å·çš„ä¸ªæ•°ï¼Œä¸€èˆ¬éƒ½æ˜¯1</span><br><span class="line">         Message msg = Message.obtain(mHandler, this);</span><br><span class="line">         msg.setAsynchronous(true);</span><br><span class="line">         mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>è²Œä¼¼è¿™é‡Œçš„å¤„ç†åªæ˜¯å¾€Choreographerå¯¹è±¡ä¸­çš„mHandlerå¯¹åº”çš„çº¿ç¨‹Looperä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œæ¶ˆæ¯çš„å†…å®¹æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š ï¼ˆ1ï¼‰å°†thisï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„FrameDisplayEventReceiverå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œåé¢ä¼šå›è°ƒåˆ°FrameDisplayEventReceiver.runæ–¹æ³•ï¼› ï¼ˆ2ï¼‰ä¸ºMessageè®¾ç½®FLAG_ASYNCHRONOUSå±æ€§ï¼› å‘é€è¿™ä¸ªFLAG_ASYNCHRONOUSæ¶ˆæ¯åï¼Œåé¢ä¼šå›è°ƒåˆ°FrameDisplayEventReceiver.runæ–¹æ³•ï¼Œè‡³äºä¸ºä»€ä¹ˆï¼Œåé¢å†å†™æ–‡ç« ç»“åˆView.invalidateæ–¹æ³•çš„è¿‡ç¨‹åˆ†æï¼Œçœ‹ä¸€ä¸‹FrameDisplayEventReceiver.runæ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    mHavePendingVsync = false;</span><br><span class="line">    doFrame(mTimestampNanos, mFrame);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨Choreographer.doFrameæ–¹æ³•ï¼Œå¦‚æœæ˜¯é‡ç»˜äº‹ä»¶doFrameæ–¹æ³•ä¼šæœ€ç»ˆè°ƒç”¨åˆ°ViewRootImpl.performTraversalsæ–¹æ³•è¿›å…¥å®é™…çš„ç»˜åˆ¶æµç¨‹ã€‚ç»è¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œè°ƒç”¨ä¸€æ¬¡Choreographer.scheduleVsyncLockedåªä¼šè¯·æ±‚ä¸€æ¬¡åŒæ­¥ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯å›è°ƒä¸€æ¬¡FrameDisplayEventReceiver.onVsyncæ–¹æ³•ï¼Œåœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªåº”ç”¨è¿›ç¨‹éœ€è¦å¤šæ¬¡è¯·æ±‚VsyncåŒæ­¥ä¿¡å·ä¼šä¸ä¼šä½¿ç”¨åŒæ ·çš„ä¸€ä¸²å¯¹è±¡ï¼Ÿå¤šä¸ªçº¿ç¨‹åˆæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ ç­”ï¼šä¸€èˆ¬ç»˜åˆ¶æ“ä½œåªèƒ½åœ¨ä¸»çº¿ç¨‹é‡Œé¢è¿›è¡Œï¼Œå› æ­¤ä¸€èˆ¬æ¥è¯´åªä¼šåœ¨ä¸»çº¿ç¨‹é‡Œé¢å»è¯·æ±‚åŒæ­¥ä¿¡å·ï¼Œå¯ä»¥è®¤ä¸ºä¸ä¼šå­˜åœ¨åŒä¸€ä¸ªåº”ç”¨çš„å¤šä¸ªçº¿ç¨‹è¯·æ±‚SFçš„Vsyncä¿¡å·ï¼ŒChoreographeræ˜¯ä¸€ä¸ªçº¿ç¨‹å†…çš„å•ä¾‹æ¨¡å¼ï¼Œå­˜å‚¨åœ¨äº† ThreadLocal sThreadInstanceå¯¹è±¡é‡Œé¢ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹å¤šæ¬¡è¯·æ±‚ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªChoreographerå¯¹è±¡ï¼Œæ‰€ä»¥åé¢çš„ä¸€ä¸²å¯¹è±¡åº”è¯¥éƒ½æ˜¯å¯ä»¥å¤ç”¨çš„ã€‚</p><p>æ€»ä½“æ¶æ„ï¼š ä¼æœ¨ç´¯:::ç»ˆäºå®Œäº†ï¼Œç”±äºAndroid Graphicsç³»ç»Ÿæ¶‰åŠæ¨¡å—ä»£ç çºµæ¨ªäº¤å‰å¤æ‚ï¼Œå…¶ä¸­ä»£ç å›¾ç¤ºæœ‰è¯¯çš„åœ°æ–¹è¯·è§è°…ï¼Œä¹Ÿæ²¡æœ‰ç²¾åŠ›ä¸€ä¸€æ ¸å¯¹äº†ï¼Œè¿˜è¯·æµ·æ¶µ~~~ä¸»è¦æ˜¯åˆ†æAndroid Graphicsæ€»ä½“çš„ä¸€ä¸ªæµç¨‹æ€æƒ³ï¼Œæœ‰éœ€è¦å†ä¸€ç‚¹ç‚¹æ·±æŒ–ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.graphics/30-Android-Graphics-Arc-flow.png" alt="Markdown"></p><h2 id="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆä¸ƒï¼‰ã€å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h2><p><a href="http://www.10tiao.com/html/431/201601/401709603/1.html" target="_blank" rel="noopener">Android Vsync åŸç†</a><br><a href="http://blog.csdn.net/uiop78uiop78/article/category/1390680" target="_blank" rel="noopener">æ—å­¦æ£®çš„Androidä¸“æ </a><br><a href="http://coderprof.com/android_tutorials_pdf_examples_PDF.php?q=android+graphics+pdf" target="_blank" rel="noopener">Android Graphics</a><br><a href="https://source.android.com/devices/tech/debug/systrace" target="_blank" rel="noopener">äº†è§£ Systrace</a><br><a href="http://www.cnblogs.com/samchen2009/category/524173.html" target="_blank" rel="noopener">å›¾è§£Android - Android GUI ç³»ç»Ÿ</a><br><a href="http://windrunnerlihuan.com/" target="_blank" rel="noopener">Android SurfaceFlinger å­¦ä¹ ä¹‹è·¯&amp;Androidå¤šåª’ä½“å¼€å‘</a><br><a href="http://blog.csdn.net/Gaugamela/article/category/6383486" target="_blank" rel="noopener">Android7.0 åŸºç¡€ä¸šåŠ¡AMSã€æ•°æ®ä¸šåŠ¡ã€ç”µæºç®¡ç†ä¸šåŠ¡ æºç åˆ†æ</a><br><a href="http://blog.csdn.net/yangwen123/article/category/1647761" target="_blank" rel="noopener">ã€Android æ˜¾ç¤ºæ¨¡å—ã€‘ - æ·±å…¥å‰–æAndroidç³»ç»Ÿ - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/innost/article/details/47208337" target="_blank" rel="noopener">æ·±å…¥ç†è§£Androidå·ä¸€å…¨æ–‡-ç¬¬å…«ç« (æ·±å…¥ç†è§£Surfaceç³»ç»Ÿ)</a><br><a href="http://blog.csdn.net/armwind/article/category/6282972" target="_blank" rel="noopener">androidç³»ç»Ÿ - armwindçš„ä¸“æ  - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/kc58236582/article/category/6436488" target="_blank" rel="noopener">androidæ˜¾ç¤ºç³»ç»Ÿ - kc58236582çš„åšå®¢ - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/wytiger/p/5693569.html" target="_blank" rel="noopener">SurfaceView, TextureView, SurfaceTextureç­‰çš„åŒºåˆ«</a><br><a href="http://blog.csdn.net/armwind/article/details/73436532" target="_blank" rel="noopener">ã€Demoã€‘Android graphics å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»</a><br><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0421/2765.html" target="_blank" rel="noopener">æ·±å…¥Android Graphics Pipelineï¼šä»æŒ‰é’®åˆ°å¸§ç¼“å†²ï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼‰</a><br><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0421/2766.html" target="_blank" rel="noopener">æ·±å…¥Android Graphics Pipelineï¼šä»æŒ‰é’®åˆ°å¸§ç¼“å†²ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰</a><br><a href="https://software.intel.com/en-us/node/713326" target="_blank" rel="noopener">çª—å£ï¼šProfiling è§†å›¾ï¼ˆOpenGL/OpenGL ES* å·¥ä½œè´Ÿè½½ï¼‰</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/54234354" target="_blank" rel="noopener">Android Nä¸­UIç¡¬ä»¶æ¸²æŸ“ï¼ˆhwuiï¼‰çš„HWUI_NEW_OPS(åŸºäºAndroid 7.1)</a><br><a href="https://netaz.blogspot.jp/search/label/gralloc" target="_blank" rel="noopener">Androidâ€™s Graphics Buffer Management System (Part I: gralloc)</a><br><a href="https://netaz.blogspot.jp/search/label/Graphics" target="_blank" rel="noopener">Androidâ€™s Graphics Buffer Management System (Part II: BufferQueue)</a><br><a href="https://www.kancloud.cn/digest/androidcore/149097" target="_blank" rel="noopener">Android GDIä¹‹SurfaceFlinger</a><br><a href="http://windrunnerlihuan.com/" target="_blank" rel="noopener">Android SurfaceFlinger å­¦ä¹ ä¹‹è·¯(äº”)â€”-VSync å·¥ä½œåŸç†</a><br><a href="http://blog.csdn.net/michaelcao1980/article/details/43233765" target="_blank" rel="noopener">Android 5.1 SurfaceFlinger VSYNCè¯¦è§£</a><br><a href="http://blog.csdn.net/newchenxf/article/details/49131167" target="_blank" rel="noopener">Android 5.1 SurfaceFlinger VSYNCè¯¦è§£</a><br><a href="http://blog.csdn.net/houliang120/article/details/50958212" target="_blank" rel="noopener">Androidæ¶ˆæ¯æœºåˆ¶Looperä¸VSyncçš„ä¼ æ’­</a><br><a href="http://blog.csdn.net/houliang120/article/details/50908098" target="_blank" rel="noopener">Androidå‚ç›´åŒæ­¥ä¿¡å·VSyncçš„äº§ç”ŸåŠä¼ æ’­ç»“æ„è¯¦è§£</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/17293325" target="_blank" rel="noopener">Android 4.4(KitKat)ä¸­VSyncä¿¡å·çš„è™šæ‹ŸåŒ–</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/37737439" target="_blank" rel="noopener">Android 4.4(KitKat)çª—å£ç®¡ç†å­ç³»ç»Ÿ - ä½“ç³»æ¡†æ¶</a><br><a href="http://blog.csdn.net/ariesjzj/article/category/1087829/2" target="_blank" rel="noopener">Androidä¸­ç”¨OpenGL ES Traceråˆ†æç»˜åˆ¶è¿‡ç¨‹</a><br><a href="https://www.zhihu.com/question/30372696?sort=created" target="_blank" rel="noopener">android viewçš„ç»˜åˆ¶ä¸­ï¼ŒViewç»˜åˆ¶çš„æ—¶é—´å¦‚ä½•å’Œvsyncå±å¹•åˆ·æ–°é¢‘ç‡ä¿æŒåŒæ­¥çš„ï¼Ÿ</a><br><a href="http://blog.csdn.net/innost/article/details/47208337" target="_blank" rel="noopener">ã€æ·±å…¥ç†è§£Androidå·ä¸€å…¨æ–‡-ç¬¬å…«ç« ã€‘å…¥ç†è§£Surfaceç³»ç»Ÿ</a><br><a href="http://blog.csdn.net/april_12345/article/details/52933316" target="_blank" rel="noopener">Android çª—å£ç®¡ç†ï¼šZ-Orderç®¡ç†</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-ç³»ç»Ÿåˆ†æ/">http://zhoujinjian.cc/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-ç³»ç»Ÿåˆ†æ/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2018/01/01/Android-7-1-2-Android-N-Android-Binderç³»ç»Ÿåˆ†æ/" title="Android 7.1.2 (Android N) Android Binder ç³»ç»Ÿ åˆ†æ"><i class="iconfont icon-prev"></i>Android 7.1.2 (Android N) Android Binder ç³»ç»Ÿ åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-çª—å£ç®¡ç†æœåŠ¡åˆ†æ-i-wonder/" title="Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]">Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">9</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/04/03/ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif)/" title="ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.10.jpg" alt="ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]"></div><div class="item__info"><h3 class="item__title">ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]</h3><span class="item__text">2018-04-03</span></div></a></li><li class="latest-post-item"><a href="/2018/04/01/Linuxå†…æ ¸ï¼ˆKernel-3-18ï¼‰-Input-å­ç³»ç»Ÿåˆ†æ-i-wonder/" title="Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.09.jpg" alt="Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]"></div><div class="item__info"><h3 class="item__title">Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]</h3><span class="item__text">2018-04-01</span></div></a></li><li class="latest-post-item"><a href="/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-çª—å£ç®¡ç†æœåŠ¡åˆ†æ-i-wonder/" title="Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.08.jpg" alt="Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]"></div><div class="item__info"><h3 class="item__title">Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]</h3><span class="item__text">2018-03-01</span></div></a></li><li class="latest-post-item"><a href="/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-ç³»ç»Ÿåˆ†æ/" title="Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.07.jpg" alt="Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]"></div><div class="item__info"><h3 class="item__title">Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]</h3><span class="item__text">2018-02-01</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">41058</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">105833</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>