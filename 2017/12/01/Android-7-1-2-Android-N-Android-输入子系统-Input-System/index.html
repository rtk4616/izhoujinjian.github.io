<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ - Input System åˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2017/12/01/Android-7-1-2-Android-N-Android-è¾“å…¥å­ç³»ç»Ÿ-Input-System/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.05.jpg" alt="Android 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ - Input System åˆ†æ"></div><header class="post__info"><h1 class="post__title">Android 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ - Input System åˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="http://zhoujinjian.cc/">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘.</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2017-12-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#åšå®¢åŸå›¾é“¾æ¥"><span class="toc-text">åšå®¢åŸå›¾é“¾æ¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸€ã€Inputç³»ç»Ÿå¿…å¤‡LinuxçŸ¥è¯†"><span class="toc-text">ä¸€ã€Inputç³»ç»Ÿå¿…å¤‡LinuxçŸ¥è¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€å¿…å¤‡çš„LinuxçŸ¥è¯†-inotifyå’Œepoll"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€å¿…å¤‡çš„LinuxçŸ¥è¯† inotifyå’Œepoll</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1ã€INotifyä»‹ç»ä¸ä½¿ç”¨"><span class="toc-text">1ã€INotifyä»‹ç»ä¸ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2ã€Epollä»‹ç»ä¸ä½¿ç”¨"><span class="toc-text">2ã€Epollä»‹ç»ä¸ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3ã€INotifyä¸Epollçš„å°ç»“"><span class="toc-text">3ã€INotifyä¸Epollçš„å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†-åŒå‘é€šä¿¡-scoketpair"><span class="toc-text">ï¼ˆäºŒï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†_åŒå‘é€šä¿¡(scoketpair)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1ã€è¿›ç¨‹å’ŒAPPé€šä¿¡"><span class="toc-text">1ã€è¿›ç¨‹å’ŒAPPé€šä¿¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2ã€å›é¡¾Binderç³»ç»Ÿ"><span class="toc-text">2ã€å›é¡¾Binderç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3ã€å¼•å…¥Socketpair"><span class="toc-text">3ã€å¼•å…¥Socketpair</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4ã€socketpairå…·ä½“ä½¿ç”¨"><span class="toc-text">4ã€socketpairå…·ä½“ä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†-å®ç°ä»»æ„è¿›ç¨‹é—´åŒå‘é€šä¿¡-scoketpair-binder"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†_å®ç°ä»»æ„è¿›ç¨‹é—´åŒå‘é€šä¿¡(scoketpair+binder)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#äºŒã€è¾“å…¥ç³»ç»Ÿçš„æ€»ä½“æ¶æ„"><span class="toc-text">äºŒã€è¾“å…¥ç³»ç»Ÿçš„æ€»ä½“æ¶æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ"><span class="toc-text">1ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2ã€geteventä¸sendeventå·¥å…·"><span class="toc-text">2ã€geteventä¸sendeventå·¥å…·</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3ã€Input-driveræ¨¡æ‹Ÿé©±åŠ¨"><span class="toc-text">3ã€Input driveræ¨¡æ‹Ÿé©±åŠ¨</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¸‰ã€Android-Inputç³»ç»Ÿ"><span class="toc-text">ä¸‰ã€Android Inputç³»ç»Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€Android-Input-ç³»ç»Ÿå…³é”®ç±»ä»‹ç»"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€Android Input ç³»ç»Ÿå…³é”®ç±»ä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€IMSçš„åˆ›å»ºä¸å¯åŠ¨"><span class="toc-text">ï¼ˆäºŒï¼‰ã€IMSçš„åˆ›å»ºä¸å¯åŠ¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1ã€-SystemServer-startOtherServices"><span class="toc-text">Step 1ã€ SystemServer.startOtherServices()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2ã€-InputManagerService"><span class="toc-text">Step 2ã€ InputManagerService()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3ã€-InputManagerService-nativeInit"><span class="toc-text">Step 3ã€ InputManagerService.nativeInit()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4ã€NativeInputManager"><span class="toc-text">Step 4ã€NativeInputManager()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5ã€InputManager"><span class="toc-text">Step 5ã€InputManager()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6ã€InputManager-initialize"><span class="toc-text">Step 6ã€InputManager.initialize()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å›¾3-1ï¼š"><span class="toc-text">å›¾3-1ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IMSçš„æˆå‘˜å…³ç³»"><span class="toc-text">IMSçš„æˆå‘˜å…³ç³»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€IMSå¯åŠ¨"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€IMSå¯åŠ¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1ã€InputManagerService-start"><span class="toc-text">Step 1ã€InputManagerService.start()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2-InputManagerService-nativeStart"><span class="toc-text">Step 2. InputManagerService.nativeStart()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3ã€InputManager-start"><span class="toc-text">Step 3ã€InputManager.start()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4ã€InputReaderThread-threadLoop"><span class="toc-text">Step 4ã€InputReaderThread.threadLoop()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step5ã€InputReaderThread-loopOnce"><span class="toc-text">Step5ã€InputReaderThread.loopOnce()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6ã€InputDispatcherThread-threadLoop"><span class="toc-text">Step 6ã€InputDispatcherThread.threadLoop()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7ã€InputDispatcher-dispatchOnce"><span class="toc-text">Step 7ã€InputDispatcher.dispatchOnce()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å°ç»“ï¼š"><span class="toc-text">å°ç»“ï¼š</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å››ã€æ·±å…¥ç†è§£EventHub"><span class="toc-text">å››ã€æ·±å…¥ç†è§£EventHub</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆ1ï¼‰ã€æ·±å…¥ç†è§£EventHub"><span class="toc-text">ï¼ˆ1ï¼‰ã€æ·±å…¥ç†è§£EventHub</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1ã€è®¾å¤‡èŠ‚ç‚¹ç›‘å¬çš„å»ºç«‹"><span class="toc-text">1ã€è®¾å¤‡èŠ‚ç‚¹ç›‘å¬çš„å»ºç«‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2ã€getEvents-å‡½æ•°çš„å·¥ä½œæ–¹å¼"><span class="toc-text">2ã€getEvents()å‡½æ•°çš„å·¥ä½œæ–¹å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3ã€è¾“å…¥è®¾å¤‡ç®¡ç†"><span class="toc-text">3ã€è¾“å…¥è®¾å¤‡ç®¡ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ1ï¼‰ã€è¾“å…¥è®¾å¤‡çš„åŠ è½½"><span class="toc-text">ï¼ˆ1ï¼‰ã€è¾“å…¥è®¾å¤‡çš„åŠ è½½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ2ï¼‰ã€è¾“å…¥è®¾å¤‡çš„å¸è½½"><span class="toc-text">ï¼ˆ2ï¼‰ã€è¾“å…¥è®¾å¤‡çš„å¸è½½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ3ï¼‰ã€è®¾å¤‡å¢åˆ äº‹ä»¶"><span class="toc-text">ï¼ˆ3ï¼‰ã€è®¾å¤‡å¢åˆ äº‹ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ4ï¼‰ã€é€šè¿‡INotifyåŠ¨æ€åœ°åŠ è½½ä¸å¸è½½è®¾å¤‡"><span class="toc-text">ï¼ˆ4ï¼‰ã€é€šè¿‡INotifyåŠ¨æ€åœ°åŠ è½½ä¸å¸è½½è®¾å¤‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ5ï¼‰ã€EventHubè®¾å¤‡ç®¡ç†æ€»ç»“"><span class="toc-text">ï¼ˆ5ï¼‰ã€EventHubè®¾å¤‡ç®¡ç†æ€»ç»“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5ã€EventHubæ€»ç»“"><span class="toc-text">5ã€EventHubæ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#äº”ã€Input-Reader"><span class="toc-text">äº”ã€Input Reader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1ã€-InputReader-loopOnce"><span class="toc-text">Step 1ã€ InputReader::loopOnce()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2ã€InputReader-processEventsLocked"><span class="toc-text">Step 2ã€InputReader.processEventsLocked()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3ã€InputReader-processEventsForDeviceLocked"><span class="toc-text">Step 3ã€InputReader.processEventsForDeviceLocked()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4ã€InputDevice-process"><span class="toc-text">Step 4ã€InputDevice.process()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5ã€KeyboardInputMapper-process"><span class="toc-text">Step 5ã€KeyboardInputMapper.process()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6ã€KeyboardInputMapper-processKey"><span class="toc-text">Step 6ã€KeyboardInputMapper.processKey()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7ã€-InputDispatcher-notifyKey"><span class="toc-text">Step 7ã€ InputDispatcher.notifyKey()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-8ã€InputDispatcher-enqueueInboundEventLocked"><span class="toc-text">Step 8ã€InputDispatcher.enqueueInboundEventLocked()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“ï¼š"><span class="toc-text">æ€»ç»“ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å…­ã€Input-Dispatcher"><span class="toc-text">å…­ã€Input Dispatcher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1ã€InputDispatcher-dispatchOnce"><span class="toc-text">Step 1ã€InputDispatcher.dispatchOnce()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2ã€InputDispatcher-dispatchOnceInnerLocked"><span class="toc-text">Step 2ã€InputDispatcher.dispatchOnceInnerLocked()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3ã€InputDispatcher-dispatchKeyLocked"><span class="toc-text">Step 3ã€InputDispatcher.dispatchKeyLocked()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5ã€InputDispatcher-prepareDispatchCycleLocked"><span class="toc-text">Step 5ã€InputDispatcher.prepareDispatchCycleLocked()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6-InputDispatcher-enqueueDispatchEntriesLocked"><span class="toc-text">Step 6. InputDispatcher::enqueueDispatchEntriesLocked()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7ã€InputDispatcher-startDispatchCycleLocked"><span class="toc-text">Step 7ã€InputDispatcher.startDispatchCycleLocked()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-8ã€InputPublisher-publishKeyEvent"><span class="toc-text">Step 8ã€InputPublisher.publishKeyEvent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-9ã€InputChannel-sendMessage"><span class="toc-text">Step 9ã€InputChannel.sendMessage()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸ƒã€Appæ³¨å†Œæ¶ˆæ¯ç›‘å¬è¿‡ç¨‹åˆ†æ"><span class="toc-text">ä¸ƒã€Appæ³¨å†Œæ¶ˆæ¯ç›‘å¬è¿‡ç¨‹åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1ã€ViewRootImpl-setView"><span class="toc-text">Step 1ã€ViewRootImpl.setView()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2ã€ViewRootImpl-requestLayout"><span class="toc-text">Step 2ã€ViewRootImpl.requestLayout()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3ã€ViewRootImpl-doTraversal"><span class="toc-text">Step 3ã€ViewRootImpl.doTraversal()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4ã€InputMonitor-updateInputWindowsLw"><span class="toc-text">Step 4ã€InputMonitor.updateInputWindowsLw()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5ã€InputManagerService-setInputWindows"><span class="toc-text">Step 5ã€InputManagerService.setInputWindows()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6ã€NativeInputManager-setInputWindows"><span class="toc-text">Step 6ã€NativeInputManager.setInputWindows()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7ã€InputDispatcher-setInputWindows"><span class="toc-text">Step 7ã€InputDispatcher.setInputWindows()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-8ã€mWindowSession-addToDisplay"><span class="toc-text">Step 8ã€mWindowSession.addToDisplay()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-10ã€InputChannel-openInputChannelPair"><span class="toc-text">Step 10ã€InputChannel.openInputChannelPair()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-11ã€InputChannel-nativeOpenInputChannelPair"><span class="toc-text">Step 11ã€InputChannel.nativeOpenInputChannelPair()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-12ã€InputChannel-openInputChannelPair"><span class="toc-text">Step 12ã€InputChannel.openInputChannelPair()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-13ã€InputManagerService-registerInputChannel"><span class="toc-text">Step 13ã€InputManagerService.registerInputChannel()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-14ã€InputManagerService-nativeRegisterInputChannel"><span class="toc-text">Step 14ã€InputManagerService.nativeRegisterInputChannel()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-15ã€InputDispatcher-registerInputChannel"><span class="toc-text">Step 15ã€InputDispatcher.registerInputChannel()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-16ã€InputEventReceiver"><span class="toc-text">Step 16ã€InputEventReceiver()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-17-ã€InputEventReceiver-nativeInit"><span class="toc-text">Step 17.ã€InputEventReceiver.nativeInit()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-18-ã€NativeInputEventReceiver-initialize"><span class="toc-text">Step 18.ã€NativeInputEventReceiver.initialize()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-19ã€NativeInputEventReceiver-setFdEvents"><span class="toc-text">Step 19ã€NativeInputEventReceiver.setFdEvents()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-20ã€NativeInputEventReceiver-handleEvent"><span class="toc-text">Step 20ã€NativeInputEventReceiver.handleEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-21ã€NativeInputEventReceiver-consumeEvents"><span class="toc-text">Step 21ã€NativeInputEventReceiver.consumeEvents()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-22ã€InputConsumer-consume"><span class="toc-text">Step 22ã€InputConsumer.consume()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-23ã€InputEventReceiver-dispatchInputEvent"><span class="toc-text">Step 23ã€InputEventReceiver.dispatchInputEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8ã€Android-Inputå­ç³»ç»Ÿä¹‹javaå±‚æŒ‰é”®ä¼ é€’"><span class="toc-text">8ã€Android Inputå­ç³»ç»Ÿä¹‹javaå±‚æŒ‰é”®ä¼ é€’</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1ã€WindowInputEventReceiver-onInputEvent"><span class="toc-text">Step 1ã€WindowInputEventReceiver.onInputEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2ã€ViewRootImpl-enqueueInputEvent"><span class="toc-text">Step 2ã€ViewRootImpl.enqueueInputEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3ã€ViewRootImpl-doProcessInputEvents"><span class="toc-text">Step 3ã€ViewRootImpl.doProcessInputEvents()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4ã€ViewRootImpl-deliverInputEvent"><span class="toc-text">Step 4ã€ViewRootImpl.deliverInputEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5ã€ViewPostImeInputStage-processKeyEvent"><span class="toc-text">Step 5ã€ViewPostImeInputStage.processKeyEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6ã€mView-dispatchKeyEvent"><span class="toc-text">Step 6ã€mView.dispatchKeyEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7ã€Activity-dispatchKeyEvent"><span class="toc-text">Step 7ã€Activity.dispatchKeyEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-8ã€PhoneWindow-superDispatchKeyEvent"><span class="toc-text">Step 8ã€PhoneWindow.superDispatchKeyEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-9ã€ViewGroup-dispatchKeyEvent"><span class="toc-text">Step 9ã€ViewGroup.dispatchKeyEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-10ã€View-dispatchKeyEvent"><span class="toc-text">Step 10ã€View.dispatchKeyEvent()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-11ã€View-onKeyDown-View-onKeyUp"><span class="toc-text">Step 11ã€View.onKeyDown/View.onKeyUp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-12ã€Activity-onKeyDown-onKeyUp"><span class="toc-text">Step 12ã€Activity.onKeyDown/onKeyUp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¹ã€æ€»ç»“ï¼š"><span class="toc-text">ä¹ã€æ€»ç»“ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸€ï¼‰ã€IMSåˆå§‹åŒ–-amp-amp-IMSä¸Appå»ºç«‹é€šä¿¡ï¼š"><span class="toc-text">ï¼ˆä¸€ï¼‰ã€IMSåˆå§‹åŒ–&amp;&amp; IMSä¸Appå»ºç«‹é€šä¿¡ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆäºŒï¼‰ã€Eventhub-å’Œ-Input-Reader"><span class="toc-text">ï¼ˆäºŒï¼‰ã€Eventhub å’Œ Input Reader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆä¸‰ï¼‰ã€Input-Dispatcher"><span class="toc-text">ï¼ˆä¸‰ï¼‰ã€Input Dispatcher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ï¼ˆå››ï¼‰ã€Key-Processing"><span class="toc-text">ï¼ˆå››ï¼‰ã€Key Processing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢-ï¼š"><span class="toc-text">å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢)ï¼š</span></a></li></ol></li></div><p>Android è¾“å…¥å­ç³»ç»Ÿæ¦‚è¿°:<br>â— å½“æ—¶è¾“å…¥è®¾å¤‡ï¼ˆå¦‚è§¦æ‘¸å±ï¼Œé”®ç›˜ç­‰ï¼‰å¯ç”¨æ—¶ï¼ŒLinux Kernelä¼šåœ¨/dev/input/ä¸‹åˆ›å»ºåä¸ºevent0~eventNçš„è®¾å¤‡èŠ‚ç‚¹; å½“è¾“å…¥è®¾å¤‡ä¸å¯ç”¨æ—¶ï¼Œä¼šå°†ç›¸åº”çš„è®¾å¤‡èŠ‚ç‚¹åˆ é™¤ã€‚<br>â— å½“ç”¨æˆ·æ“ä½œè¾“å…¥è®¾å¤‡æ—¶ï¼ŒLinux Kernelä¼šæ”¶åˆ°ç›¸åº”çš„ç¡¬ä»¶ä¸­æ–­ï¼Œç„¶åä¼šå°†ä¸­æ–­åŠ å·¥æˆåŸå§‹è¾“å…¥äº‹ä»¶ï¼ˆraw input eventï¼‰ï¼Œå¹¶å†™å…¥åˆ°è®¾å¤‡èŠ‚ç‚¹ä¸­ã€‚è€Œååœ¨ç”¨æˆ·ç©ºé—´å°±å¯ä»¥é€šè¿‡read()å‡½æ•°è¯»å–äº‹ä»¶æ•°æ®äº†ã€‚<br>â— Androidè¾“å…¥ç³»ç»Ÿä¼šç›‘æ§/dev/input/ä¸‹çš„æ‰€æœ‰è®¾å¤‡èŠ‚ç‚¹ï¼Œå½“æŸä¸ªç»“ç‚¹æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œå°†æ•°æ®è¯»å‡ºå¹¶è¿›è¡Œä¸€ç³»åˆ—å¤„ç†ï¼Œç„¶ååœ¨å½“å‰ç³»ç»Ÿä¸­çš„æ‰€æœ‰çª—å£ï¼ˆWindowï¼‰ä¸­å¯»æ‰¾åˆé€‚çš„æ¥æ”¶è€…ï¼Œå¹¶æŠŠäº‹ä»¶æ´¾å‘ç»™å®ƒã€‚<br>â— å…·ä½“æ¥è¯´ï¼ŒLinux Kernelå°†raw input eventå†™å…¥åˆ°è®¾å¤‡èŠ‚ç‚¹åï¼ŒInputReaderä¼šé€šè¿‡EventHubå°†åŸå§‹äº‹ä»¶è¯»å–å‡ºæ¥å¹¶ç¿»è¯‘åŠ å·¥ä¸ºAndroidè¾“å…¥äº‹ä»¶ï¼Œè€ŒåæŠŠå®ƒäº¤ç»™InputDispatcherã€‚InputDispatcheræ ¹æ®WMSï¼ˆWindowManagerServiceï¼‰æä¾›çš„çª—å£ä¿¡æ¯å°†äº‹ä»¶ä¼ é€’ç»™åˆé€‚çš„çª—å£ï¼Œè‹¥çª—å£ä¸ºå£çº¸/SurfaceViewç­‰ï¼Œåˆ™åˆ°äº†ç»ˆç‚¹ï¼›å¦åˆ™ä¼šç”±è¯¥Windowçš„ViewRootç»§ç»­åˆ†å‘åˆ°åˆé€‚çš„Viewã€‚<br><a id="more"></a></p><p>æœ¬ç« æ¶‰åŠçš„æºä»£ç æ–‡ä»¶ååŠä½ç½®ï¼š</p><p><strong>frameworks/base/services/java/com/android/server/</strong><br>â— SystemServer.java</p><p><strong>frameworks/base/services/java/com/android/server/input/</strong><br>â— InputManagerService.java</p><p><strong>frameworks/base/services/java/com/android/server/wm/</strong><br>â— WindowManagerService.java<br>â— WindowState.java<br>â— InputMonitor.java</p><p><strong>frameworks/base/core/java/android/view/</strong><br>â— View.java<br>â— ViewGroup.java<br>â— InputEventReceiver.java<br>â— ViewRootImpl.java<br>â— IWindowSession.aidl<br>â— InputChannel.java</p><p><strong>frameworks/base/core/java/android/app/</strong><br>â— Activity.java</p><p><strong>frameworks/base/services/jni/</strong><br>â— android_view_InputChannel.cpp<br>â— android_view_InputEventReceiver.cpp<br>â— com_android_server_input_InputManagerService.cpp</p><p><strong>frameworks/native/services/inputflinger/</strong><br>â— InputManager.cpp<br>â— EventHub.h<br>â— EventHub.cpp<br>â— InputReader.h<br>â— InputReader.cpp<br>â— InputListener.h<br>â— InputListener.cpp<br>â— InputDispatcher.h<br>â— InputDispatcher.cpp</p><p><strong>frameworks/native/libs/input/</strong><br>â— InputTransport.cpp</p><p><strong>/frameworks/native/include/input/</strong><br>â— InputTransport.h</p><h2 id="åšå®¢åŸå›¾é“¾æ¥"><a href="#åšå®¢åŸå›¾é“¾æ¥" class="headerlink" title="åšå®¢åŸå›¾é“¾æ¥"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.input" target="_blank" rel="noopener">åšå®¢åŸå›¾é“¾æ¥</a></h2><h2 id="ä¸€ã€Inputç³»ç»Ÿå¿…å¤‡LinuxçŸ¥è¯†"><a href="#ä¸€ã€Inputç³»ç»Ÿå¿…å¤‡LinuxçŸ¥è¯†" class="headerlink" title="ä¸€ã€Inputç³»ç»Ÿå¿…å¤‡LinuxçŸ¥è¯†"></a>ä¸€ã€Inputç³»ç»Ÿå¿…å¤‡LinuxçŸ¥è¯†</h2><p>æ³¨ï¼šå¿…å¤‡çŸ¥è¯†å¯ç¨åé‡åˆ°å®é™…ä½¿ç”¨çš„åœ°æ–¹å†åšè¯¦ç»†äº†è§£ã€‚</p><h2 id="ï¼ˆä¸€ï¼‰ã€å¿…å¤‡çš„LinuxçŸ¥è¯†-inotifyå’Œepoll"><a href="#ï¼ˆä¸€ï¼‰ã€å¿…å¤‡çš„LinuxçŸ¥è¯†-inotifyå’Œepoll" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€å¿…å¤‡çš„LinuxçŸ¥è¯† inotifyå’Œepoll"></a>ï¼ˆä¸€ï¼‰ã€å¿…å¤‡çš„LinuxçŸ¥è¯† inotifyå’Œepoll</h2><h3 id="1ã€INotifyä»‹ç»ä¸ä½¿ç”¨"><a href="#1ã€INotifyä»‹ç»ä¸ä½¿ç”¨" class="headerlink" title="1ã€INotifyä»‹ç»ä¸ä½¿ç”¨"></a>1ã€INotifyä»‹ç»ä¸ä½¿ç”¨</h3><p>INotifyæ˜¯ä¸€ä¸ªLinuxå†…æ ¸æ‰€æä¾›çš„ä¸€ç§æ–‡ä»¶ç³»ç»Ÿå˜åŒ–é€šçŸ¥æœºåˆ¶ã€‚å®ƒå¯ä»¥ä¸ºåº”ç”¨ç¨‹åºç›‘æ§æ–‡ä»¶ç³»ç»Ÿçš„å˜åŒ–ï¼Œå¦‚æ–‡ä»¶çš„æ–°å»ºã€åˆ é™¤ã€è¯»å†™ç­‰ã€‚INotifyæœºåˆ¶æœ‰ä¸¤ä¸ªåŸºæœ¬å¯¹è±¡ï¼Œåˆ†åˆ«ä¸ºinotifyå¯¹è±¡ä¸watchå¯¹è±¡ï¼Œéƒ½ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦è¡¨ç¤ºã€‚ inotifyå¯¹è±¡å¯¹åº”äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥å‘inotifyå¯¹è±¡æ·»åŠ å¤šä¸ªç›‘å¬ã€‚å½“è¢«ç›‘å¬çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¯ä»¥é€šè¿‡read()å‡½æ•°ä»inotifyå¯¹è±¡ä¸­å°†äº‹ä»¶ä¿¡æ¯è¯»å–å‡ºæ¥ã€‚Inotifyå¯¹è±¡å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ›å»ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> inotifyFd = inotify_init();</span><br></pre></td></tr></table></figure><p>è€Œwatchå¯¹è±¡åˆ™ç”¨æ¥æè¿°æ–‡ä»¶ç³»ç»Ÿçš„å˜åŒ–äº‹ä»¶çš„ç›‘å¬ã€‚å®ƒæ˜¯ä¸€ä¸ªäºŒå…ƒç»„ï¼ŒåŒ…æ‹¬ç›‘å¬ç›®æ ‡å’Œäº‹ä»¶æ©ç ä¸¤ä¸ªå…ƒç´ ã€‚ç›‘å¬ç›®æ ‡æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªè·¯å¾„ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶ä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶å¤¹ã€‚è€Œäº‹ä»¶æ©ç åˆ™è¡¨ç¤ºäº†éœ€è¦éœ€è¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼Œæ©ç ä¸­çš„æ¯ä¸€ä½ä»£è¡¨ä¸€ç§äº‹ä»¶ã€‚å¯ä»¥ç›‘å¬çš„äº‹ä»¶ç§ç±»å¾ˆå¤šï¼Œå…¶ä¸­å°±åŒ…æ‹¬æ–‡ä»¶çš„åˆ›å»º(IN_CREATE)ä¸åˆ é™¤(IN_DELETE)ã€‚è¯»è€…å¯ä»¥å‚é˜…ç›¸å…³èµ„æ–™ä»¥äº†è§£å…¶ä»–å¯ç›‘å¬çš„äº‹ä»¶ç§ç±»ã€‚ä»¥ä¸‹ä»£ç å³å¯å°†ä¸€ä¸ªç”¨äºç›‘å¬è¾“å…¥è®¾å¤‡èŠ‚ç‚¹çš„åˆ›å»ºä¸åˆ é™¤çš„watchå¯¹è±¡æ·»åŠ åˆ°inotifyå¯¹è±¡ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> wd = inotify_add_watch (inotifyFd, â€œ/dev/inputâ€,IN_CREATE | IN_DELETE);</span><br></pre></td></tr></table></figure><p>å®Œæˆä¸Šè¿°watchå¯¹è±¡çš„æ·»åŠ åï¼Œå½“/dev/input/ä¸‹çš„è®¾å¤‡èŠ‚ç‚¹å‘ç”Ÿåˆ›å»ºä¸åˆ é™¤æ“ä½œæ—¶ï¼Œéƒ½ä¼šå°†ç›¸åº”çš„äº‹ä»¶ä¿¡æ¯å†™å…¥åˆ°inotifyFdæ‰€æè¿°çš„inotifyå¯¹è±¡ä¸­ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡read()å‡½æ•°ä»inotifyFdæè¿°ç¬¦ä¸­å°†äº‹ä»¶ä¿¡æ¯è¯»å–å‡ºæ¥ã€‚ äº‹ä»¶ä¿¡æ¯ä½¿ç”¨ç»“æ„ä½“inotify_eventè¿›è¡Œæè¿°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inotify_event</span> &#123;</span></span><br><span class="line">   __s32           wd;             <span class="comment">/* äº‹ä»¶å¯¹åº”çš„Watchå¯¹è±¡çš„æè¿°ç¬¦ */</span></span><br><span class="line">   __u32           mask;           <span class="comment">/* äº‹ä»¶ç±»å‹ï¼Œä¾‹å¦‚æ–‡ä»¶è¢«åˆ é™¤ï¼Œæ­¤å¤„å€¼ä¸ºIN_DELETE */</span></span><br><span class="line">   __u32           cookie;</span><br><span class="line">   __u32           len;            <span class="comment">/* nameå­—æ®µçš„é•¿åº¦ */</span></span><br><span class="line">   <span class="keyword">char</span>            name[<span class="number">0</span>];        <span class="comment">/* å¯å˜é•¿çš„å­—æ®µï¼Œç”¨äºå­˜å‚¨äº§ç”Ÿæ­¤äº‹ä»¶çš„æ–‡ä»¶è·¯å¾„*/</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure><p>å½“æ²¡æœ‰ç›‘å¬äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å°†ä¸€ä¸ªæˆ–å¤šä¸ªæœªè¯»å–çš„äº‹ä»¶ä¿¡æ¯è¯»å–å‡ºæ¥ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> len = read (inotifyFd, events_buf,BUF_LEN);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­events_bufæ˜¯inotify_eventçš„æ•°ç»„æŒ‡é’ˆï¼Œèƒ½å¤Ÿè¯»å–çš„äº‹ä»¶æ•°é‡ç”±å–å†³äºæ•°ç»„çš„é•¿åº¦ã€‚æˆåŠŸè¯»å–äº‹ä»¶ä¿¡æ¯åï¼Œä¾¿å¯æ ¹æ®inotify_eventç»“æ„ä½“çš„å­—æ®µåˆ¤æ–­äº‹ä»¶ç±»å‹ä»¥åŠäº§ç”Ÿäº‹ä»¶çš„æ–‡ä»¶è·¯å¾„äº†ã€‚</p><p>æ€»ç»“ä¸€ä¸‹INotifyæœºåˆ¶çš„ä½¿ç”¨è¿‡ç¨‹ï¼š</p><p>Â· é€šè¿‡inotify_init()åˆ›å»ºä¸€ä¸ªinotifyå¯¹è±¡ã€‚</p><p>Â· é€šè¿‡inotify_add_watchå°†ä¸€ä¸ªæˆ–å¤šä¸ªç›‘å¬æ·»åŠ åˆ°inotifyå¯¹è±¡ä¸­ã€‚</p><p>Â· é€šè¿‡read()å‡½æ•°ä»inotifyå¯¹è±¡ä¸­è¯»å–ç›‘å¬äº‹ä»¶ã€‚å½“æ²¡æœ‰æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œinotifyå¯¹è±¡ä¸­æ— ä»»ä½•å¯è¯»æ•°æ®ã€‚</p><p>é€šè¿‡INotifyæœºåˆ¶é¿å…äº†è½®è¯¢æ–‡ä»¶ç³»ç»Ÿçš„éº»çƒ¦ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒINotifyæœºåˆ¶å¹¶ä¸æ˜¯é€šè¿‡å›è°ƒçš„æ–¹å¼é€šçŸ¥äº‹ä»¶ï¼Œè€Œéœ€è¦ä½¿ç”¨è€…ä¸»åŠ¨ä»inotifyå¯¹è±¡ä¸­è¿›è¡Œäº‹ä»¶è¯»å–ã€‚é‚£ä¹ˆä½•æ—¶æ‰æ˜¯è¯»å–çš„æœ€ä½³æ—¶æœºå‘¢ï¼Ÿè¿™å°±éœ€è¦å€ŸåŠ©Linuxçš„å¦ä¸€ä¸ªä¼˜ç§€çš„æœºåˆ¶Epolläº†ã€‚</p><p>ä½¿ç”¨inotifyç›‘å¬ç›®å½•å®ä¾‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/inotify.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="comment">//å‚è€ƒ: frameworks\native\services\inputflinger\EventHub.cpp</span></span><br><span class="line"><span class="comment">//Usage: inotify &lt;dir&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_process_inotify_fd</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> res;</span><br><span class="line"><span class="keyword">char</span> event_buf[<span class="number">512</span>];</span><br><span class="line"><span class="keyword">int</span> event_size;</span><br><span class="line"><span class="keyword">int</span> event_pos = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inotify_event</span> *<span class="title">event</span>;</span></span><br><span class="line"><span class="comment">/* read */</span>    </span><br><span class="line">res = read(fd, event_buf, <span class="keyword">sizeof</span>(event_buf));</span><br><span class="line"><span class="keyword">if</span>(res &lt; (<span class="keyword">int</span>)<span class="keyword">sizeof</span>(*event)) &#123;</span><br><span class="line">    <span class="keyword">if</span>(errno == EINTR) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"could not get event, %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¯»åˆ°çš„æ•°æ®æ˜¯1ä¸ªæˆ–å¤šä¸ªinotify_event,å®ƒä»¬çš„é•¿åº¦ä¸ä¸€æ ·,é€ä¸ªå¤„ç†</span></span><br><span class="line"><span class="keyword">while</span>(res &gt;= (<span class="keyword">int</span>)<span class="keyword">sizeof</span>(*event)) &#123;</span><br><span class="line">    event = (struct inotify_event *)(event_buf + event_pos);</span><br><span class="line">    <span class="comment">//printf("%d: %08x \"%s\"\n", event-&gt;wd, event-&gt;mask, event-&gt;len ? event-&gt;name : "");</span></span><br><span class="line">    <span class="keyword">if</span>(event-&gt;len) &#123;</span><br><span class="line">        <span class="keyword">if</span>(event-&gt;mask &amp; IN_CREATE) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"create file: %s\n"</span>, event-&gt;name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"delete file: %s\n"</span>, event-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    event_size = <span class="keyword">sizeof</span>(*event) + event-&gt;len;</span><br><span class="line">    res -= event_size;</span><br><span class="line">    event_pos += event_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> mINotifyFd;</span><br><span class="line"><span class="keyword">int</span> result;</span><br><span class="line"><span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: %s &lt;dir&gt;\n"</span>, argv[<span class="number">0</span>]); <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* inotify_init */</span></span><br><span class="line">mINotifyFd = inotify_init();</span><br><span class="line"><span class="comment">/* add watch */</span></span><br><span class="line">result = inotify_add_watch(mINotifyFd, argv[<span class="number">1</span>], IN_DELETE | IN_CREATE);</span><br><span class="line"><span class="comment">/* read */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    read_process_inotify_fd(mINotifyFd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ä¸éªŒè¯ï¼š</strong> gcc -o inotify inotify.c //GCCç¼–è¯‘ mkdir tmp //åˆ›å»ºtmpæ–‡ä»¶å¤¹ ./inotify tmp &amp; //åå°ç›‘æµ‹tmpæ–‡ä»¶å¤¹</p><p>echo &gt; tmp/1 //tmpæ–‡ä»¶å¤¹æ–°å»ºæ–‡ä»¶1 echo &gt; tmp/2 //tmpæ–‡ä»¶å¤¹æ–°å»ºæ–‡ä»¶2 rm tmp/1 tmp/2 //ç§»é™¤tmpæ–‡ä»¶1/2</p><p>æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œinotify æˆåŠŸçš„ç›‘æµ‹äº†tmpæ–‡ä»¶å¤¹ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N1-Android-Input-System-Inotify-Test.jpg" alt="Markdown"></p><h3 id="2ã€Epollä»‹ç»ä¸ä½¿ç”¨"><a href="#2ã€Epollä»‹ç»ä¸ä½¿ç”¨" class="headerlink" title="2ã€Epollä»‹ç»ä¸ä½¿ç”¨"></a>2ã€Epollä»‹ç»ä¸ä½¿ç”¨</h3><p>æ— è®ºæ˜¯ä»è®¾å¤‡èŠ‚ç‚¹ä¸­è·å–åŸå§‹è¾“å…¥äº‹ä»¶è¿˜æ˜¯ä»inotifyå¯¹è±¡ä¸­è¯»å–æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ï¼Œéƒ½é¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™äº›äº‹ä»¶éƒ½æ˜¯å¶å‘çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è®¾å¤‡èŠ‚ç‚¹ã€inotifyå¯¹è±¡è¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸­éƒ½æ˜¯æ— æ•°æ®å¯è¯»çš„ï¼ŒåŒæ—¶åˆå¸Œæœ›æœ‰äº‹ä»¶åˆ°æ¥æ—¶å¯ä»¥å°½å¿«åœ°å¯¹äº‹ä»¶ä½œå‡ºååº”ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›ä¸æ–­åœ°è½®è¯¢è¿™äº›æè¿°ç¬¦ï¼Œä¹Ÿä¸å¸Œæœ›ä¸ºæ¯ä¸ªæè¿°ç¬¦åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹è¿›è¡Œé˜»å¡æ—¶çš„è¯»å–ï¼Œå› ä¸ºè¿™éƒ½å°†ä¼šå¯¼è‡´èµ„æºçš„æå¤§æµªè´¹ã€‚</p><p>æ­¤æ—¶æœ€ä½³çš„åŠæ³•æ˜¯ä½¿ç”¨Epollæœºåˆ¶ã€‚Epollå¯ä»¥ä½¿ç”¨ä¸€æ¬¡ç­‰å¾…ç›‘å¬å¤šä¸ªæè¿°ç¬¦çš„å¯è¯»/å¯å†™çŠ¶æ€ã€‚ç­‰å¾…è¿”å›æ—¶æºå¸¦äº†å¯è¯»çš„æè¿°ç¬¦æˆ–è‡ªå®šä¹‰çš„æ•°æ®ï¼Œä½¿ç”¨è€…å¯ä»¥æ®æ­¤è¯»å–æ‰€éœ€çš„æ•°æ®åå¯ä»¥å†æ¬¡è¿›å…¥ç­‰å¾…ã€‚å› æ­¤ä¸éœ€è¦ä¸ºæ¯ä¸ªæè¿°ç¬¦åˆ›å»ºç‹¬ç«‹çš„çº¿ç¨‹è¿›è¡Œé˜»å¡è¯»å–ï¼Œé¿å…äº†èµ„æºæµªè´¹çš„åŒæ—¶åˆå¯ä»¥è·å¾—è¾ƒå¿«çš„å“åº”é€Ÿåº¦ã€‚</p><p>Epollæœºåˆ¶çš„æ¥å£åªæœ‰ä¸‰ä¸ªå‡½æ•°ï¼Œååˆ†ç®€å•ã€‚</p><p>Â· epoll_create(int max_fds)ï¼šåˆ›å»ºä¸€ä¸ªepollå¯¹è±¡çš„æè¿°ç¬¦ï¼Œä¹‹åå¯¹epollçš„æ“ä½œå‡ä½¿ç”¨è¿™ä¸ªæè¿°ç¬¦å®Œæˆã€‚max_fdså‚æ•°è¡¨ç¤ºäº†æ­¤epollå¯¹è±¡å¯ä»¥ç›‘å¬çš„æè¿°ç¬¦çš„æœ€å¤§æ•°é‡ã€‚</p><p>Â· epoll_ctl (int epfd, int op,int fd, struct epoll_event *event)ï¼šç”¨äºç®¡ç†æ³¨å†Œäº‹ä»¶çš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥å¢åŠ /åˆ é™¤/ä¿®æ”¹äº‹ä»¶çš„æ³¨å†Œã€‚</p><p>Â· int epoll_wait(int epfd, structepoll_event * events, int maxevents, int timeout)ï¼šç”¨äºç­‰å¾…äº‹ä»¶çš„åˆ°æ¥ã€‚å½“æ­¤å‡½æ•°è¿”å›æ—¶ï¼Œeventsæ•°ç»„å‚æ•°ä¸­å°†ä¼šåŒ…å«äº§ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>æ¥ä¸‹æ¥ä»¥ç›‘æ§è‹¥å¹²æè¿°ç¬¦å¯è¯»äº‹ä»¶ä¸ºä¾‹ä»‹ç»ä¸€ä¸‹epollçš„ç”¨æ³•ã€‚</p><p>ï¼ˆ1ï¼‰ åˆ›å»ºepollå¯¹è±¡</p><p>é¦–å…ˆé€šè¿‡epoll_create()å‡½æ•°åˆ›å»ºä¸€ä¸ªepollå¯¹è±¡ï¼š</p><p>Int epfd = epoll_create(MAX_FDS)</p><p>ï¼ˆ2ï¼‰ å¡«å……epoll_eventç»“æ„ä½“</p><p>æ¥ç€ä¸ºæ¯ä¸€ä¸ªéœ€ç›‘æ§çš„æè¿°ç¬¦å¡«å……epoll_eventç»“æ„ä½“ï¼Œä»¥æè¿°ç›‘æ§äº‹ä»¶ï¼Œå¹¶é€šè¿‡epoll_ctl()å‡½æ•°å°†æ­¤æè¿°ç¬¦ä¸epoll_eventç»“æ„ä½“æ³¨å†Œè¿›epollå¯¹è±¡ã€‚epoll_eventç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line"></span><br><span class="line">__uint32_tevents; <span class="comment">/* äº‹ä»¶æ©ç ï¼ŒæŒ‡æ˜äº†éœ€è¦ç›‘å¬çš„äº‹ä»¶ç§ç±»*/</span></span><br><span class="line"> <span class="keyword">epoll_data_t</span> data; <span class="comment">/* ä½¿ç”¨è€…è‡ªå®šä¹‰çš„æ•°æ®ï¼Œå½“æ­¤äº‹ä»¶å‘ç”Ÿæ—¶è¯¥æ•°æ®å°†åŸå°ä¸åŠ¨åœ°è¿”å›ç»™ä½¿ç”¨è€… */</span></span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><p>epoll_data_tè”åˆä½“çš„å®šä¹‰å¦‚ä¸‹ï¼Œå½“ç„¶ï¼ŒåŒä¸€æ—¶é—´ä½¿ç”¨è€…åªèƒ½ä½¿ç”¨ä¸€ä¸ªå­—æ®µï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> epoll_data &#123;</span><br><span class="line"><span class="keyword">void</span>*ptr;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">__uint32_t</span> u32;</span><br><span class="line"><span class="keyword">__uint64_t</span> u64;</span><br><span class="line">&#125; <span class="keyword">epoll_data_t</span>;</span><br></pre></td></tr></table></figure><p>epoll_eventç»“æ„ä¸­çš„eventså­—æ®µæ˜¯ä¸€ä¸ªäº‹ä»¶æ©ç ï¼Œç”¨ä»¥æŒ‡æ˜éœ€è¦ç›‘å¬çš„äº‹ä»¶ç§ç±»ï¼ŒåŒINotifyä¸€æ ·ï¼Œæ©ç çš„æ¯ä¸€ä½ä»£è¡¨äº†ä¸€ç§äº‹ä»¶ã€‚å¸¸ç”¨çš„äº‹ä»¶æœ‰EPOLLINï¼ˆå¯è¯»ï¼‰ï¼ŒEPOLLOUTï¼ˆå¯å†™ï¼‰ï¼ŒEPOLLERRï¼ˆæè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼‰ï¼ŒEPOLLHUPï¼ˆæè¿°ç¬¦è¢«æŒ‚èµ·ï¼‰ç­‰ã€‚æ›´å¤šæ”¯æŒçš„äº‹ä»¶è¯»è€…å¯å‚è€ƒç›¸å…³èµ„æ–™ã€‚</p><p>dataå­—æ®µæ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œå®ƒè®©ä½¿ç”¨è€…å¯ä»¥å°†ä¸€äº›è‡ªå®šä¹‰æ•°æ®åŠ å…¥åˆ°äº‹ä»¶é€šçŸ¥ä¸­ï¼Œå½“æ­¤äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç”¨æˆ·è®¾ç½®çš„dataå­—æ®µå°†ä¼šè¿”å›ç»™ä½¿ç”¨è€…ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­å¸¸è®¾ç½®epoll_event.data.fdä¸ºéœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œäº‹ä»¶å‘ç”Ÿæ—¶ä¾¿å¯ä»¥æ ¹æ®epoll_event.data.fdå¾—çŸ¥å¼•å‘äº‹ä»¶çš„æè¿°ç¬¦ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è®¾ç½®epoll_event.data.fdä¸ºå…¶ä»–ä¾¿äºè¯†åˆ«çš„æ•°æ®ã€‚</p><p>å¡«å……epoll_eventçš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">structepoll_event eventItem;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;eventItem, <span class="number">0</span>, <span class="keyword">sizeof</span>(eventItem));</span><br><span class="line"></span><br><span class="line">eventItem.events = EPOLLIN | EPOLLERR | EPOLLHUP; <span class="comment">// ç›‘å¬æè¿°ç¬¦å¯è¯»ä»¥åŠå‡ºé”™çš„äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">eventItem.data.fd= listeningFd; <span class="comment">// å¡«å†™è‡ªå®šä¹‰æ•°æ®ä¸ºéœ€è¦ç›‘å¬çš„æè¿°ç¬¦</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±å¯ä»¥ä½¿ç”¨epoll_ctl()å°†äº‹ä»¶æ³¨å†Œè¿›epollå¯¹è±¡äº†ã€‚epoll_ctl()çš„å‚æ•°æœ‰å››ä¸ªï¼š</p><p>Â· epfdæ˜¯ç”±epoll_create()å‡½æ•°æ‰€åˆ›å»ºçš„epollå¯¹è±¡çš„æè¿°ç¬¦ã€‚</p><p>Â· opè¡¨ç¤ºäº†ä½•ç§æ“ä½œï¼ŒåŒ…æ‹¬EPOLL_CTL_ADD/DEL/MODä¸‰ç§ï¼Œåˆ†åˆ«è¡¨ç¤ºå¢åŠ /åˆ é™¤/ä¿®æ”¹æ³¨å†Œäº‹ä»¶ã€‚</p><p>Â· fdè¡¨ç¤ºäº†éœ€è¦ç›‘å¬çš„æè¿°ç¬¦ã€‚</p><p>Â· eventå‚æ•°æ˜¯æè¿°äº†ç›‘å¬äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯çš„epoll_eventç»“æ„ä½“ã€‚</p><p>æ³¨å†Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†äº‹ä»¶ç›‘å¬æ·»åŠ åˆ°epollå¯¹è±¡ä¸­å»</span></span><br><span class="line"></span><br><span class="line">result =epoll_ctl(epfd, EPOLL_CTL_ADD, listeningFd, &amp;eventItem);</span><br></pre></td></tr></table></figure><p>é‡å¤è¿™ä¸ªæ­¥éª¤å¯ä»¥å°†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å¤šç§äº‹ä»¶ç›‘å¬æ³¨å†Œåˆ°epollå¯¹è±¡ä¸­ã€‚å®Œæˆäº†ç›‘å¬çš„æ³¨å†Œä¹‹åï¼Œä¾¿å¯ä»¥é€šè¿‡epoll_wait()å‡½æ•°ç­‰å¾…äº‹ä»¶çš„åˆ°æ¥äº†ã€‚</p><p>ï¼ˆ3ï¼‰ ä½¿ç”¨epoll_wait()å‡½æ•°ç­‰å¾…äº‹ä»¶</p><p>epoll_wait()å‡½æ•°å°†ä¼šä½¿è°ƒç”¨è€…é™·å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°å…¶æ³¨å†Œçš„äº‹ä»¶ä¹‹ä¸€å‘ç”Ÿä¹‹åæ‰ä¼šè¿”å›ï¼Œå¹¶ä¸”æºå¸¦äº†åˆšåˆšå‘ç”Ÿçš„äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯ã€‚å…¶ç­¾åå¦‚ä¸‹ï¼š</p><p>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);</p><p>Â· epfdæ˜¯ç”±epoll_create()å‡½æ•°æ‰€åˆ›å»ºçš„epollå¯¹è±¡æè¿°ç¬¦ã€‚</p><p>Â· eventsæ˜¯ä¸€ä¸ªepoll_eventçš„æ•°ç»„ï¼Œæ­¤å‡½æ•°è¿”å›æ—¶ï¼Œäº‹ä»¶çš„ä¿¡æ¯å°†è¢«å¡«å……è‡³æ­¤ã€‚</p><p>Â· maxeventsè¡¨ç¤ºæ­¤æ¬¡è°ƒç”¨æœ€å¤šå¯ä»¥è·å–å¤šå°‘ä¸ªäº‹ä»¶ï¼Œå½“ç„¶ï¼Œeventså‚æ•°å¿…é¡»èƒ½å¤Ÿè¶³å¤Ÿå®¹çº³è¿™ä¹ˆå¤šäº‹ä»¶ã€‚</p><p>Â· timeoutè¡¨ç¤ºç­‰å¾…è¶…æ—¶çš„äº‹ä»¶ã€‚</p><p>epoll_wait()å‡½æ•°è¿”å›å€¼è¡¨ç¤ºè·å–äº†å¤šå°‘ä¸ªäº‹ä»¶ã€‚</p><p>ï¼ˆ4ï¼‰ å¤„ç†äº‹ä»¶</p><p>epoll_waitè¿”å›åï¼Œä¾¿å¯ä»¥æ ¹æ®eventsæ•°ç»„ä¸­æ‰€ä¿å­˜çš„æ‰€æœ‰epoll_eventç»“æ„ä½“çš„eventså­—æ®µä¸dataå­—æ®µè¯†åˆ«äº‹ä»¶çš„ç±»å‹ä¸æ¥æºã€‚</p><p>Epollçš„ä½¿ç”¨æ­¥éª¤æ€»ç»“å¦‚ä¸‹ï¼š</p><p>Â· é€šè¿‡epoll_create()åˆ›å»ºä¸€ä¸ªepollå¯¹è±¡ã€‚</p><p>Â· ä¸ºéœ€è¦ç›‘å¬çš„æè¿°ç¬¦å¡«å……epoll_eventsç»“æ„ä½“ï¼Œå¹¶ä½¿ç”¨epoll_ctl()æ³¨å†Œåˆ°epollå¯¹è±¡ä¸­ã€‚</p><p>Â· ä½¿ç”¨epoll_wait()ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚</p><p>Â· æ ¹æ®epoll_wait()è¿”å›çš„epoll_eventsç»“æ„ä½“æ•°ç»„åˆ¤æ–­äº‹ä»¶çš„ç±»å‹ä¸æ¥æºå¹¶è¿›è¡Œå¤„ç†ã€‚</p><p>Â· ç»§ç»­ä½¿ç”¨epoll_wait()ç­‰å¾…æ–°äº‹ä»¶çš„å‘ç”Ÿã€‚</p><p>ä½¿ç”¨inotifyç›‘å¬ç›®å½•å®ä¾‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> epoll_data &#123;</span><br><span class="line"><span class="keyword">void</span>        *ptr;</span><br><span class="line"> <span class="keyword">int</span>          fd;</span><br><span class="line">  <span class="keyword">uint32_t</span>     u32;</span><br><span class="line">   <span class="keyword">uint64_t</span>     u64;</span><br><span class="line">   &#125; <span class="keyword">epoll_data_t</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATA_MAX_LEN 500</span></span><br><span class="line"><span class="comment">/* usage: epoll &lt;file1&gt; [file2] [file3] ... */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_to_epoll</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> epollFd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> result;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">eventItem</span>;</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;eventItem, <span class="number">0</span>, <span class="keyword">sizeof</span>(eventItem));</span><br><span class="line">eventItem.events = EPOLLIN;</span><br><span class="line">eventItem.data.fd = fd;</span><br><span class="line">result = epoll_ctl(epollFd, EPOLL_CTL_ADD, fd, &amp;eventItem);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rm_from_epoll</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> epollFd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">epoll_ctl(epollFd, EPOLL_CTL_DEL, fd, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> mEpollFd;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">char</span> buf[DATA_MAX_LEN];</span><br><span class="line"><span class="comment">// Maximum number of signalled FDs to handle at a time.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EPOLL_MAX_EVENTS = <span class="number">16</span>;</span><br><span class="line"><span class="comment">// The array of pending epoll events and the index of the next event to be handled.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">mPendingEventItems</span>[<span class="title">EPOLL_MAX_EVENTS</span>];</span></span><br><span class="line"><span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: %s &lt;file1&gt; [file2] [file3] ...\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* epoll_create */</span></span><br><span class="line">mEpollFd = epoll_create(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// for each file:* open it</span></span><br><span class="line"><span class="comment">// add it to epoll: epoll_ctl(...EPOLL_CTL_ADD...)</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++)     </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//int tmpFd = open(argv[i], O_RDONLY|O_NONBLOCK);</span></span><br><span class="line">    <span class="keyword">int</span> tmpFd = open(argv[i], O_RDWR);</span><br><span class="line">    add_to_epoll(tmpFd, mEpollFd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* epoll_wait */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> pollResult = epoll_wait(mEpollFd, mPendingEventItems, EPOLL_MAX_EVENTS, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pollResult; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Reason: 0x%x\n"</span>, mPendingEventItems[i].events);</span><br><span class="line">        <span class="keyword">int</span> len = read(mPendingEventItems[i].data.fd, buf, DATA_MAX_LEN);</span><br><span class="line">        buf[len] = <span class="string">'\0'</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"get data: %s\n"</span>, buf);</span><br><span class="line">        <span class="comment">//sleep(3);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>epoll , fifo : <a href="http://stackoverflow.com/questions/15055065/o-rdwr-on-named-pipes-with-poll" target="_blank" rel="noopener">o-rdwr-on-named-pipes-with-poll</a></p><p>ä½¿ç”¨fifoæ˜¯, æˆ‘ä»¬çš„epollç¨‹åºæ˜¯reader echo aa &gt; tmp/1 æ˜¯writer a. å¦‚æœreaderä»¥ O_RDONLY|O_NONBLOCKæ‰“å¼€FIFOæ–‡ä»¶, å½“writerå†™å…¥æ•°æ®æ—¶, epoll_waitä¼šç«‹åˆ»è¿”å›; å½“writerå…³é—­FIFOä¹‹å, readerå†æ¬¡è°ƒç”¨epoll_wait, å®ƒä¹Ÿä¼šç«‹åˆ»è¿”å›(åŸå› æ˜¯EPPLLHUP, æè¿°ç¬¦è¢«æŒ‚æ–­) b. å¦‚æœreaderä»¥ O_RDWRæ‰“å¼€FIFOæ–‡ä»¶ å½“writerå†™å…¥æ•°æ®æ—¶, epoll_waitä¼šç«‹åˆ»è¿”å›; å½“writerå…³é—­FIFOä¹‹å, readerå†æ¬¡è°ƒç”¨epoll_wait, å®ƒå¹¶ä¸ä¼šç«‹åˆ»è¿”å›, è€Œæ˜¯ç»§ç»­ç­‰å¾…æœ‰æ•°æ®</p><p><strong>ç¼–è¯‘ä¸éªŒè¯ï¼š</strong> gcc -o epoll epoll.c //GCCç¼–è¯‘ mkdir tmp //åˆ›å»ºtmpæ–‡ä»¶å¤¹ mkfifo tmp/1 tmp/2 tmp/3 //åˆ›å»ºæ–‡ä»¶1ã€2ã€3 ./epoll tmp/1 tmp/2 tmp/3 &amp; //epollåå°ç›‘æµ‹æ–‡ä»¶1ã€2ã€3 echo aaa &gt; tmp/1 //å†™äººaaaåˆ°1 echo bbb &gt; tmp/2 //å†™å…¥bbbåˆ°2</p><p>æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼ŒepollæˆåŠŸçš„ç›‘æµ‹äº†æ–‡ä»¶å†…å®¹çš„æ”¹å˜ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N2-Android-Input-System-epoll-test.jpg" alt="Markdown"></p><h3 id="3ã€INotifyä¸Epollçš„å°ç»“"><a href="#3ã€INotifyä¸Epollçš„å°ç»“" class="headerlink" title="3ã€INotifyä¸Epollçš„å°ç»“"></a>3ã€INotifyä¸Epollçš„å°ç»“</h3><p>INotifyä¸Epollè¿™ä¸¤å¥—ç”±Linuxæä¾›çš„äº‹ä»¶ç›‘å¬æœºåˆ¶ä»¥æœ€å°çš„å¼€é”€è§£å†³äº†æ–‡ä»¶ç³»ç»Ÿå˜åŒ–ä»¥åŠæ–‡ä»¶æè¿°ç¬¦å¯è¯»å¯å†™çŠ¶æ€å˜åŒ–çš„ç›‘å¬é—®é¢˜ã€‚å®ƒä»¬æ˜¯Readerå­ç³»ç»Ÿè¿è¡Œçš„åŸºçŸ³ï¼Œäº†è§£äº†è¿™ä¸¤ä¸ªæœºåˆ¶çš„ä½¿ç”¨æ–¹æ³•ä¹‹åä¾¿ä¸ºå¯¹Readerå­ç³»ç»Ÿçš„åˆ†æå­¦ä¹ é“ºå¹³äº†é“è·¯ã€‚ å‚è€ƒï¼š<a href="https://github.com/weidongshan/APP_0006_inotify_epoll" target="_blank" rel="noopener">https://github.com/weidongshan/APP_0006_inotify_epoll</a> inotify_epoll.c, ç”¨å®ƒæ¥ç›‘æµ‹tmp/ç›®å½•: æœ‰æ–‡ä»¶è¢«åˆ›å»º/åˆ é™¤, æœ‰æ–‡ä»¶å¯è¯»å‡ºæ•°æ® a. å½“åœ¨tmp/ä¸‹åˆ›å»ºæ–‡ä»¶æ—¶, ä¼šç«‹åˆ»ç›‘æµ‹åˆ°ï¼Œå¹¶ä¸”ä½¿ç”¨epollç›‘æµ‹è¯¥æ–‡ä»¶ b. å½“æ–‡ä»¶æœ‰æ•°æ®æ—¶ï¼Œè¯»å‡ºæ•°æ® c. å½“tmp/ä¸‹æ–‡ä»¶è¢«åˆ é™¤æ—¶ï¼Œä¼šç«‹åˆ»ç›‘æµ‹åˆ°ï¼Œå¹¶ä¸”æŠŠå®ƒä»epollä¸­ç§»é™¤ä¸å†ç›‘æµ‹</p><p>inotify_epoll.c <strong>ç¼–è¯‘ä¸éªŒè¯ï¼š</strong></p><p>gcc -o inotify_epoll inotify_epoll.c mkdir tmp ./inotify_epoll tmp/ &amp; mkfifo tmp/1 tmp/2 tmp/3 echo aaa &gt; tmp/1 echo bbb &gt; tmp/2 rm tmp/3</p><p>ç”±å®ä¾‹å¯çŸ¥ï¼Œä½¿ç”¨inotify å’Œ epoll ç»“åˆå°±å¯ä»¥ç›‘æµ‹æ–‡ä»¶å¢åŠ å’Œç§»é™¤ ï¼Œè¿˜èƒ½ç›‘æµ‹æ–‡ä»¶å†…å®¹çš„æ”¹å˜ã€‚</p><p>ç”¨é€”ç®€ä»‹[ç¨åè¿›è¡Œinput systemè¯¦ç»†åˆ†æ]ï¼š /dev/input ä¸‹æœ‰å¤šä¸ªeventæ–‡ä»¶,å¯¹åº”å¤šä¸ªè¾“å…¥è®¾å¤‡ï¼Œå¦‚:/dev/input/event0, /dev/input/mouse0, /dev/input/misc ä½¿ç”¨inotify å’Œ epoll å°±å¯ä»¥ç›‘å¬è¾“å…¥è®¾å¤‡çš„å˜åŒ–ã€å¦‚Androidæ–°è¿æ¥ä¸€ä¸ªé¼ æ ‡å¯æ£€æµ‹åˆ°æ”¹å˜ã€‚åŒæ—¶å¯ç›‘å¬æ˜¯å¦æœ‰è¾“å…¥äº‹ä»¶ã€‚</p><p><a href="https://segmentfault.com/a/1190000003063859" target="_blank" rel="noopener">Lnux IOæ¨¡å¼åŠ selectã€pollã€epollè¯¦è§£</a></p><h2 id="ï¼ˆäºŒï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†-åŒå‘é€šä¿¡-scoketpair"><a href="#ï¼ˆäºŒï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†-åŒå‘é€šä¿¡-scoketpair" class="headerlink" title="ï¼ˆäºŒï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†_åŒå‘é€šä¿¡(scoketpair)"></a>ï¼ˆäºŒï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†_åŒå‘é€šä¿¡(scoketpair)</h2><h3 id="1ã€è¿›ç¨‹å’ŒAPPé€šä¿¡"><a href="#1ã€è¿›ç¨‹å’ŒAPPé€šä¿¡" class="headerlink" title="1ã€è¿›ç¨‹å’ŒAPPé€šä¿¡"></a>1ã€è¿›ç¨‹å’ŒAPPé€šä¿¡</h3><p>Â· åˆ›å»ºè¿›ç¨‹ Â· è¯»å–ã€åˆ†å‘ Â· è¿›ç¨‹å‘é€è¾“å…¥äº‹ä»¶ç»™APP Â· è¿›ç¨‹è¯»å–APPå›åº”çš„äº‹ä»¶ Â· è¾“å…¥ç³»ç»Ÿæ¶‰åŠåŒå‘çš„è¿›ç¨‹é—´é€šä¿¡</p><h3 id="2ã€å›é¡¾Binderç³»ç»Ÿ"><a href="#2ã€å›é¡¾Binderç³»ç»Ÿ" class="headerlink" title="2ã€å›é¡¾Binderç³»ç»Ÿ"></a>2ã€å›é¡¾Binderç³»ç»Ÿ</h3><p>Â· Serverâ€“ å•å‘å‘å‡ºè¯·æ±‚ Â· Client â€“ å•å‘å›å¤è¯·æ±‚ Â· æ¯æ¬¡è¯·æ±‚åªå¯ä»¥å•æ–¹å‘å‡º</p><h3 id="3ã€å¼•å…¥Socketpair"><a href="#3ã€å¼•å…¥Socketpair" class="headerlink" title="3ã€å¼•å…¥Socketpair"></a>3ã€å¼•å…¥Socketpair</h3><p>åŸå› ï¼šå¦‚æœåˆ›å»ºä¸¤ç»„è¿›ç¨‹ï¼ˆClientï¼ŒServerï¼‰è¿›è¡ŒåŒå‘é€šä¿¡ï¼Œå®ç°ååˆ†å¤æ‚ å¼•å…¥Socketpairï¼š Socketpair();ä¸¤æ¬¡ï¼Œè·å¾—ä¸¤ä¸ªfdï¼Œåœ¨å†…æ ¸è·å¾—ç¼“å†²åŒºï¼Œä¸€ä¸ªä½œä¸ºsendbufåŒºä¸€ä¸ªä½œä¸ºreceivebufåŒº APPé€šè¿‡fd1å°†æ•°æ®å†™å…¥fd1çš„sendbufåŒºä¸­ï¼Œé€šè¿‡å†…æ ¸å½“ä¸­çš„socketæœºåˆ¶å°±ä¼šå†™åˆ°fd2ä¸­receivebufåŒºï¼ŒåŒç†fd2ä¹Ÿæ˜¯å¦‚æ­¤ socketpairç¼ºç‚¹ï¼šåªé€‚ç”¨äºçº¿ç¨‹é—´ã€çˆ¶å­è¿›ç¨‹é€šä¿¡ è§£å†³æ–¹æ³•ï¼šé€šè¿‡Binderæœºåˆ¶é€šä¿¡å¯ä»¥è®¿é—®ä»»æ„è¿›ç¨‹ï¼Œå°±è§£å†³äº†sockpairç¼ºç‚¹</p><h3 id="4ã€socketpairå…·ä½“ä½¿ç”¨"><a href="#4ã€socketpairå…·ä½“ä½¿ç”¨" class="headerlink" title="4ã€socketpairå…·ä½“ä½¿ç”¨"></a>4ã€socketpairå…·ä½“ä½¿ç”¨</h3><p>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹â€“pthread_create(); åˆ›å»ºsocketpairâ€“socketpair(AF_UNIX, SOCK_SEQPACKET, 0, sockets); çº¿ç¨‹å¤„ç†å‡½æ•°â€“å¾€socket[1]å†™å…¥æ•°æ®ï¼Œè¯»å–socket[0]è¯»å–æ•°æ® ä¸»å‡½æ•°â€“ä»socket[1]è¯»å–æ•°æ®ï¼Œå¾€socket[0]å†™å…¥æ•°æ®</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;          /* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_BUFFER_SIZE      (32768U)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX 512</span></span><br><span class="line"><span class="comment">/* å‚è€ƒ:frameworks/native/libs/input/InputTransport.cpp</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="comment">/* çº¿ç¨‹æ‰§è¡Œå‡½æ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> *<span class="title">function_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> thread1_fd = (<span class="keyword">int</span>)arg;<span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> len;</span><br><span class="line"><span class="keyword">char</span> buf[MAX];</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">/* å‘ mainçº¿ç¨‹å‘å‡º: Hello, main thread   */</span></span><br><span class="line">    len = <span class="built_in">sprintf</span>(buf,<span class="string">"Hello , main thread , cnt = %d"</span>,cnt++);</span><br><span class="line">    write(thread1_fd,buf,len);</span><br><span class="line">    <span class="comment">/* è¯»å–æ•°æ®(mainçº¿ç¨‹å‘å›çš„æ•°æ®) */</span></span><br><span class="line">    len = read(thread1_fd,buf,MAX);</span><br><span class="line">    buf[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread1 read : %s\n"</span>,buf);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line">close(thread1_fd);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pthread_t</span> threadID;</span><br><span class="line"><span class="keyword">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> bufferSize = SOCKET_BUFFER_SIZE;</span><br><span class="line">socketpair(AF_UNIX,SOCK_SEQPACKET,<span class="number">0</span>,sockets);  <span class="comment">//åˆ›å»ºsocketpair</span></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</span><br><span class="line">setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</span><br><span class="line">setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</span><br><span class="line">setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</span><br><span class="line">pthread_create(threadID,<span class="literal">NULL</span>,function_thread,(<span class="keyword">void</span> *)sockets[<span class="number">1</span>]);  <span class="comment">//åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">int</span> mainThread_fd = sockets[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> len;</span><br><span class="line"><span class="keyword">char</span> buf[MAX];</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">/* è¯»æ•°æ®: çº¿ç¨‹1å‘å‡ºçš„æ•°æ® */</span></span><br><span class="line">    len = read(mainThread_fd,buf,MAX);</span><br><span class="line">    buf[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"main thread read : %s\n"</span>,buf);</span><br><span class="line">    <span class="comment">/* main threadå‘thread1 å‘å‡º: Hello, thread1 */</span></span><br><span class="line">    len = <span class="built_in">sprintf</span>(buf,<span class="string">"Hello , thread1 , cnt = %d"</span>,cnt++);</span><br><span class="line">    write(mainThread_fd,buf,len);       </span><br><span class="line">&#125;</span><br><span class="line">close(mainThread_fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹æ³•ï¼š gcc socketpair.c -o socketpair -pthread æ³¨ï¼šå‡ºç°å°‘é‡è­¦å‘Šï¼Œå¯ä»¥å¿½ç•¥ ./socketpair å¯ä»¥çœ‹åˆ°mainçº¿ç¨‹ å’Œ thread1åŒå‘é€šä¿¡ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N3-Android-Input-System-socketpair.jpg" alt="Markdown"></p><p>main å’Œ thread1å±äºä¸¤ä¸ªçº¿ç¨‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N4-Android-Input-System-socketpair-thread.jpg" alt="Markdown"></p><p>çˆ¶å­è¿›ç¨‹é€šä¿¡ï¼š åˆ©ç”¨socketpairåˆ›å»ºä¸€å¯¹æ— åç®¡é“ï¼Œç„¶åé€šè¿‡sendmsgç”±æœåŠ¡å™¨è¿›ç¨‹å‘é€æ–‡ä»¶çš„fdç»™å®¢æˆ·ç«¯è¿›ç¨‹ï¼Œå®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡recvmsgæ¥æ”¶æœåŠ¡å™¨è¿›ç¨‹å‘æ¥çš„fd <a href="http://blog.csdn.net/yankai0219/article/details/8453377" target="_blank" rel="noopener">socketpairå®ç°çˆ¶å­è¿›ç¨‹é€šä¿¡</a> <strong>å›¾ç¤ºï¼š</strong><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N5-Android-Input-System-socketpair-father-son.jpg" alt="Markdown"></p><h2 id="ï¼ˆä¸‰ï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†-å®ç°ä»»æ„è¿›ç¨‹é—´åŒå‘é€šä¿¡-scoketpair-binder"><a href="#ï¼ˆä¸‰ï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†-å®ç°ä»»æ„è¿›ç¨‹é—´åŒå‘é€šä¿¡-scoketpair-binder" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†_å®ç°ä»»æ„è¿›ç¨‹é—´åŒå‘é€šä¿¡(scoketpair+binder)"></a>ï¼ˆä¸‰ï¼‰ã€å¿…å¤‡LinuxçŸ¥è¯†_å®ç°ä»»æ„è¿›ç¨‹é—´åŒå‘é€šä¿¡(scoketpair+binder)</h2><p>ä»£ç å®ä¾‹ï¼Œç”±äºä»£ç è¾ƒå¤šï¼Œè¯·å¾€GitHubä¸ŠæŸ¥çœ‹ã€‚ <a href="https://github.com/weidongshan/APP_0004_Binder_CPP_App" target="_blank" rel="noopener">å®ç°ä»»æ„è¿›ç¨‹é—´åŒå‘é€šä¿¡(scoketpair+binder)</a></p><p>ç”±ç¬¬äºŒèŠ‚æœ€åå¯çŸ¥socketpairå¯å®ç°çˆ¶å­è¿›ç¨‹é€šä¿¡ï¼Œå›¾ä¸­çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å¯åŒå‘é€šä¿¡ï¼Œå‡å¦‚æ­¤æ—¶é€šè¿‡binderé€šä¿¡å°†æ–‡ä»¶å¥æŸ„Fd[1]ä¼ ç»™å¦å¤–ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“Linuxä¸€åˆ‡çš†æ–‡ä»¶ï¼Œé‚£ä¸ªç‹¬ç«‹è¿›ç¨‹å°±å¯ä»¥å¯¹Fd[1]è¯»å†™äº†ï¼Œä¹Ÿå°±æ˜¯è¯´çˆ¶è¿›ç¨‹ å°±å¯ä»¥å’Œ é‚£ä¸ªç‹¬ç«‹è¿›ç¨‹åŒå‘é€šä¿¡äº†ï¼Œå…·ä½“å®ç°è¯·ç ”ç©¶ä¸Šé¢çš„ä»£ç ã€‚</p><p>æµ‹è¯•ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N6-Android-Input-System-socketpair-binder.jpg" alt="Markdown"></p><p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ²¡æœ‰ä»»ä½•å…³ç³»çš„è¿›ç¨‹ä½¿ç”¨socketpairå®ç°äº†åŒå‘é€šä¿¡ã€‚</p><p>ç”¨é€”ç®€ä»‹[ç¨åè¿›è¡Œinput systemè¯¦ç»†åˆ†æ]ï¼š InputManagerServiceè·å–äº‹ä»¶åéœ€è¦å‘é€ç»™Appï¼Œå‡å¦‚Appè¿›ç¨‹å…³æ‰äº†ï¼Œéœ€è¦å‘ŠçŸ¥IMSï¼Œå°±ä¸éœ€è¦æ¥å—äº‹ä»¶äº†ã€‚å¯ä»¥çœ‹åˆ°éœ€è¦è¿›ç¨‹é—´ç›¸äº’é€šä¿¡ï¼Œè¿™å°±æ˜¯scoketpair+binderå®é™…ä½œç”¨ã€‚</p><hr><h2 id="äºŒã€è¾“å…¥ç³»ç»Ÿçš„æ€»ä½“æ¶æ„"><a href="#äºŒã€è¾“å…¥ç³»ç»Ÿçš„æ€»ä½“æ¶æ„" class="headerlink" title="äºŒã€è¾“å…¥ç³»ç»Ÿçš„æ€»ä½“æ¶æ„"></a>äºŒã€è¾“å…¥ç³»ç»Ÿçš„æ€»ä½“æ¶æ„</h2><h3 id="ï¼ˆä¸€ï¼‰ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ"><a href="#ï¼ˆä¸€ï¼‰ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ"></a>ï¼ˆä¸€ï¼‰ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ</h3><p>è¾“å…¥å­ç³»ç»Ÿçš„ç³»ç»Ÿæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N7-Android-Input-System--all-arc.png" alt="Markdown"></p><p>Androidè¾“å…¥ç³»ç»Ÿç³»ç»Ÿç»¼è¿°ï¼š Linuxå†…æ ¸ä¼šåœ¨/dev/input/ä¸‹åˆ›å»ºå¯¹åº”çš„åä¸ºevent0~næˆ–å…¶ä»–åç§°çš„è®¾å¤‡èŠ‚ç‚¹ã€‚è€Œå½“è¾“å…¥è®¾å¤‡ä¸å¯ç”¨æ—¶ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„èŠ‚ç‚¹åˆ é™¤ã€‚åœ¨ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡ioctlçš„æ–¹å¼ä»è¿™äº›è®¾å¤‡èŠ‚ç‚¹ä¸­è·å–å…¶å¯¹åº”çš„è¾“å…¥è®¾å¤‡çš„ç±»å‹ã€å‚å•†ã€æè¿°ç­‰ä¿¡æ¯ã€‚</p><p>å½“ç”¨æˆ·æ“ä½œè¾“å…¥è®¾å¤‡æ—¶ï¼ŒLinuxå†…æ ¸æ¥æ”¶åˆ°ç›¸åº”çš„ç¡¬ä»¶ä¸­æ–­ï¼Œç„¶åå°†ä¸­æ–­åŠ å·¥æˆåŸå§‹çš„è¾“å…¥äº‹ä»¶æ•°æ®å¹¶å†™å…¥å…¶å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ä¸­ï¼Œåœ¨ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡read()å‡½æ•°å°†äº‹ä»¶æ•°æ®è¯»å‡ºã€‚</p><p>Androidè¾“å…¥ç³»ç»Ÿçš„å·¥ä½œåŸç†æ¦‚æ‹¬æ¥è¯´ï¼Œå°±æ˜¯ç›‘æ§/dev/input/ä¸‹çš„æ‰€æœ‰è®¾å¤‡èŠ‚ç‚¹ï¼Œå½“æŸä¸ªèŠ‚ç‚¹æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œå°†æ•°æ®è¯»å‡ºå¹¶è¿›è¡Œä¸€ç³»åˆ—çš„ç¿»è¯‘åŠ å·¥ï¼Œç„¶ååœ¨æ‰€æœ‰çš„çª—å£ä¸­å¯»æ‰¾åˆé€‚çš„äº‹ä»¶æ¥æ”¶è€…ï¼Œå¹¶æ´¾å‘ç»™å®ƒã€‚</p><h4 id="1ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ"><a href="#1ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ" class="headerlink" title="1ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ"></a>1ã€è¾“å…¥å­ç³»ç»Ÿåˆ†å±‚è§£æ</h4><p>â— Hardwareå±‚ ç¡¬ä»¶å±‚ä¸»è¦å°±æ˜¯æŒ‰é”®ã€è§¦æ‘¸å±ã€Sensorç­‰å„ç§è¾“å…¥è®¾å¤‡ã€‚</p><p>â— Kernelå±‚</p><p>Kernel å±‚å¯¹Inputç›¸å…³å¤„ç†åªåšç®€å•çš„ä»‹ç»ã€‚ Kernel å±‚ä¸»è¦åˆ†ä¸ºä¸‰å±‚ï¼Œå¦‚ä¸‹ï¼š</p><p>Input è®¾å¤‡é©±åŠ¨å±‚: é‡‡é›†è¾“å…¥è®¾å¤‡çš„æ•°æ®ä¿¡æ¯ï¼Œé€šè¿‡ Input Core çš„ API ä¸ŠæŠ¥æ•°æ®ã€‚</p><p>Input Coreï¼ˆæ ¸å¿ƒå±‚ï¼‰ï¼šä¸ºäº‹ä»¶å¤„ç†å±‚å’Œè®¾å¤‡é©±åŠ¨å±‚æä¾›æ¥å£APIã€‚ Event Handlerï¼ˆäº‹ä»¶å¤„ç†å±‚ï¼‰ï¼šé€šè¿‡æ ¸å¿ƒå±‚çš„APIè·å–è¾“å…¥äº‹ä»¶ä¸ŠæŠ¥çš„æ•°æ®ï¼Œå®šä¹‰APIä¸åº”ç”¨å±‚äº¤äº’ã€‚</p><p>Event Handlerï¼š Event Handler å±‚ä»¥é€šç”¨çš„ evdev.c ä¸ºä¾‹æ¥è§£æï¼Œä¸Šå±‚å’Œ Kernel å±‚çš„äº¤äº’åœ¨æ­¤æ–‡ä»¶å®Œæˆã€‚</p><p>â— Framework å±‚ Androidç³»ç»Ÿä¸­Framework å±‚è´Ÿè´£ç®¡ç†è¾“å…¥äº‹ä»¶çš„ä¸»è¦æ˜¯InputManagerServiceï¼ˆIMSï¼‰ã€‚å®ƒä¸»è¦çš„ä»»åŠ¡å°±æ˜¯ä»è®¾å¤‡ä¸­è¯»äº‹ä»¶æ•°æ®ï¼Œç„¶åå°†è¾“å…¥äº‹ä»¶å‘é€åˆ°ç„¦ç‚¹çª—å£ä¸­å»ï¼Œå¦å¤–è¿˜éœ€è¦è®©ç³»ç»Ÿæœ‰æœºä¼šæ¥å¤„ç†ä¸€äº›ç³»ç»ŸæŒ‰é”®ã€‚æ˜¾ç„¶ï¼Œè¦å®Œæˆè¿™ä¸ªå·¥ä½œï¼ŒIMSéœ€è¦ä¸å…¶å®ƒæ¨¡å—æ‰“äº¤é“ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å°±æ˜¯WMSå’ŒViewRootImplã€‚ä¸»è¦çš„å‡ ä¸ªæ¨¡å—ç¤ºæ„å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N8-Android-Input-System-framwork-arc.png" alt="Markdown"></p><p>â— Appå±‚</p><hr><p>WindowManagerService(WMS)æ˜¯çª—å£ç®¡ç†æœåŠ¡ï¼Œæ ¸å¿ƒç»´æŠ¤äº†ä¸€ä¸ªæœ‰åºçš„çª—å£å †æ ˆã€‚PhoneWindowManager(PWM)é‡Œæœ‰å…³äºæ‰‹æœºç­–ç•¥çš„å®ç°ï¼Œå’Œè¾“å…¥ç›¸å…³çš„ä¸»è¦æ˜¯å¯¹ç³»ç»ŸæŒ‰é”®çš„å¤„ç†ã€‚InputManagerServiceæ˜¯è¾“å…¥ç®¡ç†æœåŠ¡ï¼Œä¸»è¦å¹²æ´»çš„æ˜¯Nativeå±‚çš„InputManagerã€‚InputManagerä¸­çš„InputReaderè´Ÿè´£ä½¿ç”¨EventHubä»Input driverä¸­æ‹¿äº‹ä»¶ï¼Œç„¶åè®©InputMapperè§£æã€‚æ¥ç€ä¼ ç»™InputDispatcherï¼ŒInputDispatcherè´Ÿè´£ä¸€æ–¹é¢å°†äº‹ä»¶é€šè¿‡InputManagerï¼ŒInputMonitorä¸€è·¯ä¼ ç»™PhoneWindowManageræ¥åšç³»ç»Ÿè¾“å…¥äº‹ä»¶çš„å¤„ç†ï¼Œå¦ä¸€æ–¹é¢å°†è¿™äº›äº‹ä»¶ä¼ ç»™ç„¦ç‚¹åŠç›‘è§†çª—å£ã€‚NativeInputManagerå®ç°InputReaderPolicyInterfaceå’ŒInputDispatcherPolicyInterfaceæ¥å£ï¼Œåœ¨Nativeå±‚çš„InputManagerå’ŒJavaå±‚çš„IMSé—´èµ·åˆ°ä¸€ä¸ªèƒ¶æ°´å±‚çš„ä½œç”¨ã€‚InputMonitorå®ç°äº†WindowManagerCallbacksæ¥å£ï¼Œèµ·åˆ°äº†IMSåˆ°WMSçš„è¿æ¥ä½œç”¨ã€‚Appè¿™è¾¹ï¼ŒViewRootImplç›¸å½“äºAppç«¯ä¸€ä¸ªé¡¶å±‚Viewçš„Controllerã€‚è¿™ä¸ªé¡¶å±‚Viewåœ¨WMSä¸­å¯¹åº”ä¸€ä¸ªçª—å£ï¼Œç”¨WindowStateæè¿°ã€‚WindowStateä¸­æœ‰InputWindowHandleä»£è¡¨ä¸€ä¸ªæ¥æ”¶è¾“å…¥äº‹ä»¶çš„çª—å£å¥æŸ„ã€‚InputDispatcherä¸­çš„mFocusedWindowHandleæŒ‡ç¤ºäº†ç„¦ç‚¹çª—å£çš„å¥æŸ„ã€‚InputDispatcherç®¡ç†äº†ä¸€å¨è¿æ¥ï¼ˆä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªæ³¨å†Œåˆ°WMSçš„çª—å£ï¼‰ï¼Œé€šè¿‡è¿™äº›ä¸ªè¿æ¥InputDispatcherå¯ä»¥ç›´æ¥å°†è¾“å…¥äº‹ä»¶å‘å¾€Appç«¯çš„ç„¦ç‚¹çª—å£ã€‚è¾“å…¥äº‹ä»¶ä»Driverå¼€å§‹çš„å¤„ç†è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N9-Android-Input-System-app-arc.png" alt="Markdown"></p><p>äº‹ä»¶å‘å¾€Appç«¯åï¼Œå°±è¿›å…¥äº‹ä»¶åˆ†å‘é˜¶æ®µï¼Œè¿™é‡Œç®€å•æä¸‹ï¼Œä¸åšè¯¦ç»†åˆ†æã€‚</p><p>é™„ï¼š Kernel å±‚ç”Ÿæˆä¸‰ä¸ªè·¯å¾„åŠç›¸å…³è®¾å¤‡æ–‡ä»¶ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># /sys/<span class="class"><span class="keyword">class</span>/<span class="title">input</span>/</span></span><br><span class="line"><span class="class"><span class="title">event0</span>  <span class="title">event11</span> <span class="title">event4</span> <span class="title">event7</span> <span class="title">input0</span>  <span class="title">input11</span> <span class="title">input4</span> <span class="title">input7</span></span></span><br><span class="line"><span class="class"><span class="title">event1</span>  <span class="title">event2</span>  <span class="title">event5</span> <span class="title">event8</span> <span class="title">input1</span>  <span class="title">input2</span>  <span class="title">input5</span> <span class="title">input8</span></span></span><br><span class="line"><span class="class"><span class="title">event10</span> <span class="title">event3</span>  <span class="title">event6</span> <span class="title">event9</span> <span class="title">input10</span> <span class="title">input3</span>  <span class="title">input6</span> <span class="title">input9</span></span></span><br><span class="line"><span class="class"># /<span class="title">dev</span>/<span class="title">input</span></span></span><br><span class="line"><span class="class"><span class="title">event0</span> <span class="title">event10</span> <span class="title">event2</span> <span class="title">event4</span> <span class="title">event6</span> <span class="title">event8</span></span></span><br><span class="line"><span class="class"><span class="title">event1</span> <span class="title">event11</span> <span class="title">event3</span> <span class="title">event5</span> <span class="title">event7</span> <span class="title">event9</span></span></span><br><span class="line"><span class="class"># /<span class="title">proc</span>/<span class="title">bus</span>/<span class="title">input</span>  </span></span><br><span class="line"><span class="class"><span class="title">devices</span> <span class="title">handlers</span></span></span><br><span class="line"><span class="class"># <span class="title">cat</span> <span class="title">devices</span>  æŸ¥çœ‹æ€»çº¿ä¸Šçš„å·²ç»æ³¨å†Œä¸Šçš„è¾“å…¥è®¾å¤‡</span></span><br><span class="line"><span class="class"><span class="title">I</span>:</span> Bus=<span class="number">0019</span> Vendor=<span class="number">0000</span> Product=<span class="number">0000</span> Version=<span class="number">0000</span></span><br><span class="line">N: Name=<span class="string">"ACCDET"</span></span><br><span class="line">P: Phys=</span><br><span class="line">S: Sysfs=/devices/<span class="keyword">virtual</span>/input/input0</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event0</span><br><span class="line">B: PROP=<span class="number">0</span></span><br><span class="line">B: EV=<span class="number">3</span></span><br><span class="line">B: KEY=<span class="number">40</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1000000000</span> c000001800000 <span class="number">0</span></span><br><span class="line">...</span><br><span class="line">I: Bus=<span class="number">0019</span> Vendor=<span class="number">0000</span> Product=<span class="number">0000</span> Version=<span class="number">0001</span></span><br><span class="line">N: Name=<span class="string">"fingerprint_key"</span></span><br><span class="line">P: Phys=</span><br><span class="line">S: Sysfs=/devices/<span class="keyword">virtual</span>/input/input2</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event2</span><br><span class="line">B: PROP=<span class="number">0</span></span><br><span class="line">B: EV=<span class="number">3</span></span><br><span class="line">B: KEY=<span class="number">2000100000000000</span> <span class="number">180001f</span> <span class="number">8000000000000000</span></span><br><span class="line">...</span><br><span class="line">cat handlers <span class="comment">// æŸ¥çœ‹æ³¨å†Œçš„handler</span></span><br><span class="line">N: Number=<span class="number">0</span> Name=gpufreq_ib</span><br><span class="line">N: Number=<span class="number">1</span> Name=evdev Minor=<span class="number">64</span></span><br></pre></td></tr></table></figure><h4 id="2ã€geteventä¸sendeventå·¥å…·"><a href="#2ã€geteventä¸sendeventå·¥å…·" class="headerlink" title="2ã€geteventä¸sendeventå·¥å…·"></a>2ã€geteventä¸sendeventå·¥å…·</h4><p>Androidç³»ç»Ÿæä¾›äº†geteventä¸sendeventä¸¤ä¸ªå·¥å…·ä¾›å¼€å‘è€…ä»è®¾å¤‡èŠ‚ç‚¹ä¸­ç›´æ¥è¯»å–è¾“å…¥äº‹ä»¶æˆ–å†™å…¥è¾“å…¥äº‹ä»¶ã€‚</p><p>geteventç›‘å¬è¾“å…¥è®¾å¤‡èŠ‚ç‚¹çš„å†…å®¹ï¼Œå½“è¾“å…¥äº‹ä»¶è¢«å†™å…¥åˆ°èŠ‚ç‚¹ä¸­æ—¶ï¼Œgeteventä¼šå°†å…¶è¯»å‡ºå¹¶æ‰“å°åœ¨å±å¹•ä¸Šã€‚ç”±äºgeteventä¸ä¼šå¯¹äº‹ä»¶æ•°æ®åšä»»ä½•åŠ å·¥ï¼Œå› æ­¤å…¶è¾“å‡ºçš„å†…å®¹æ˜¯ç”±å†…æ ¸æä¾›çš„æœ€åŸå§‹çš„äº‹ä»¶ã€‚å…¶ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getevent [-é€‰é¡¹] [device_path]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­device_pathæ˜¯å¯é€‰å‚æ•°ï¼Œç”¨ä»¥æŒ‡æ˜éœ€è¦ç›‘å¬çš„è®¾å¤‡èŠ‚ç‚¹è·¯å¾„ã€‚å¦‚æœçœç•¥æ­¤å‚æ•°ï¼Œåˆ™ç›‘å¬æ‰€æœ‰è®¾å¤‡èŠ‚ç‚¹çš„äº‹ä»¶ã€‚</p><p>æ‰“å¼€æ¨¡æ‹Ÿå™¨ï¼Œæ‰§è¡Œadb shell getevent â€“tï¼ˆ-tå‚æ•°è¡¨ç¤ºæ‰“å°äº‹ä»¶çš„æ—¶é—´æˆ³ï¼‰ï¼Œå¹¶æŒ‰ä¸€ä¸‹ç”µæºé”®ï¼ˆä¸è¦æ¾æ‰‹ï¼‰ï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸‹ä¸€æ¡è¾“å‡ºï¼Œè¾“å‡ºçš„éƒ¨åˆ†æ•°å€¼ä¼šå› æœºå‹çš„ä¸åŒè€Œæœ‰æ‰€å·®å¼‚ï¼Œä½†æ ¼å¼ä¸€è‡´ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1262.443489</span>] /dev/input/event0: <span class="number">0001</span> <span class="number">0074</span> <span class="number">00000001</span></span><br></pre></td></tr></table></figure><p>æ¾å¼€ç”µæºé”®æ—¶ï¼Œåˆä¼šäº§ç”Ÿä»¥ä¸‹ä¸€æ¡è¾“å‡ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1262.557130</span>] /dev/input/event0: <span class="number">0001</span> <span class="number">0074</span> <span class="number">00000000</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸¤æ¡è¾“å‡ºä¾¿æ˜¯æŒ‰ä¸‹å’ŒæŠ¬èµ·ç”µæºé”®æ—¶ç”±å†…æ ¸ç”Ÿæˆçš„åŸå§‹äº‹ä»¶ã€‚æ³¨æ„å…¶è¾“å‡ºæ˜¯åå…­è¿›åˆ¶çš„ã€‚æ¯æ¡æ•°æ®æœ‰äº”é¡¹ä¿¡æ¯ï¼šäº§ç”Ÿäº‹ä»¶æ—¶çš„æ—¶é—´æˆ³ï¼ˆ[ 1262.443489]ï¼‰ï¼Œäº§ç”Ÿäº‹ä»¶çš„è®¾å¤‡èŠ‚ç‚¹ï¼ˆ/dev/input/event0ï¼‰ï¼Œäº‹ä»¶ç±»å‹ï¼ˆ0001ï¼‰ï¼Œäº‹ä»¶ä»£ç ï¼ˆ0074ï¼‰ä»¥åŠäº‹ä»¶çš„å€¼ï¼ˆ00000001ï¼‰ã€‚å…¶ä¸­æ—¶é—´æˆ³ã€ç±»å‹ã€ä»£ç ã€å€¼ä¾¿æ˜¯åŸå§‹äº‹ä»¶çš„å››é¡¹åŸºæœ¬å…ƒç´ ã€‚é™¤æ—¶é—´æˆ³å¤–ï¼Œå…¶ä»–ä¸‰é¡¹å…ƒç´ çš„å®é™…æ„ä¹‰ä¾ç…§è®¾å¤‡ç±»å‹åŠå‚å•†çš„ä¸åŒè€Œæœ‰æ‰€åŒºåˆ«ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œç±»å‹0x01è¡¨ç¤ºæ­¤äº‹ä»¶ä¸ºä¸€æ¡æŒ‰é”®äº‹ä»¶ï¼Œä»£ç 0x74è¡¨ç¤ºç”µæºé”®çš„æ‰«æç ï¼Œå€¼0x01è¡¨ç¤ºæŒ‰ä¸‹ï¼Œ0x00åˆ™è¡¨ç¤ºæŠ¬èµ·ã€‚è¿™ä¸¤æ¡åŸå§‹æ•°æ®è¢«è¾“å…¥ç³»ç»ŸåŒ…è£…æˆä¸¤ä¸ªKeyEventå¯¹è±¡ï¼Œä½œä¸ºä¸¤ä¸ªæŒ‰é”®äº‹ä»¶æ´¾å‘ç»™Frameworkä¸­æ„Ÿå…´è¶£çš„æ¨¡å—æˆ–åº”ç”¨ç¨‹åºã€‚</p><p>æ³¨æ„ä¸€æ¡åŸå§‹äº‹ä»¶æ‰€åŒ…å«çš„ä¿¡æ¯é‡æ˜¯æ¯”è¾ƒæœ‰é™çš„ã€‚è€Œåœ¨Android APIä¸­æ‰€ä½¿ç”¨çš„æŸäº›è¾“å…¥äº‹ä»¶ï¼Œå¦‚è§¦æ‘¸å±ç‚¹å‡»/æ»‘åŠ¨ï¼ŒåŒ…å«äº†å¾ˆå¤šçš„ä¿¡æ¯ï¼Œå¦‚XYåæ ‡ï¼Œè§¦æ‘¸ç‚¹ç´¢å¼•ç­‰ï¼Œå…¶å®æ˜¯è¾“å…¥ç³»ç»Ÿæ•´åˆäº†å¤šä¸ªåŸå§‹äº‹ä»¶åçš„ç»“æœã€‚è¿™ä¸ªè¿‡ç¨‹å°†åœ¨5.2.4èŠ‚ä¸­è¯¦ç»†æ¢è®¨ã€‚</p><p>ä¸ºäº†å¯¹åŸå§‹äº‹ä»¶æœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†ï¼Œè¯»è€…å¯ä»¥åœ¨è¿è¡Œgeteventçš„è¿‡ç¨‹ä¸­å°è¯•ä¸€ä¸‹å…¶ä»–çš„è¾“å…¥æ“ä½œï¼Œè§‚å¯Ÿä¸€ä¸‹æ¯ç§è¾“å…¥æ‰€å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹åŠå››é¡¹å…ƒç´ çš„å–å€¼ã€‚</p><p>è¾“å…¥è®¾å¤‡çš„èŠ‚ç‚¹ä¸ä»…åœ¨ç”¨æˆ·ç©ºé—´å¯è¯»ï¼Œè€Œä¸”æ˜¯å¯å†™çš„ï¼Œå› æ­¤å¯ä»¥å°†å°†åŸå§‹äº‹ä»¶å†™å…¥åˆ°èŠ‚ç‚¹ä¸­ï¼Œä»è€Œå®ç°æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥çš„åŠŸèƒ½ã€‚sendeventå·¥å…·çš„ä½œç”¨æ­£æ˜¯å¦‚æ­¤ã€‚å…¶ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sendevent &lt;èŠ‚ç‚¹è·¯å¾„&gt; &lt;ç±»å‹&gt;&lt;ä»£ç &gt; &lt;å€¼&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œsendeventçš„è¾“å…¥å‚æ•°ä¸geteventçš„è¾“å‡ºæ˜¯å¯¹åº”çš„ï¼Œåªä¸è¿‡sendeventçš„å‚æ•°ä¸ºåè¿›åˆ¶ã€‚ç”µæºé”®çš„ä»£ç 0x74çš„åè¿›åˆ¶ä¸º116ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å¿«é€Ÿæ‰§è¡Œå¦‚ä¸‹ä¸¤æ¡å‘½ä»¤å®ç°ç‚¹å‡»ç”µæºé”®çš„æ•ˆæœï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb shell sendevent /dev/input/event0 <span class="number">1</span> <span class="number">116</span> <span class="number">1</span> #æŒ‰ä¸‹ç”µæºé”®</span><br><span class="line"></span><br><span class="line">adb shell sendevent /dev/input/event0 <span class="number">1</span> <span class="number">116</span> <span class="number">0</span> #æŠ¬èµ·ç”µæºé”®</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œè¿™ä¸¤æ¡å‘½ä»¤åï¼Œå¯ä»¥çœ‹åˆ°è®¾å¤‡è¿›å…¥äº†ä¼‘çœ æˆ–è¢«å”¤é†’ï¼Œä¸æŒ‰ä¸‹å®é™…çš„ç”µæºé”®çš„æ•ˆæœä¸€æ¨¡ä¸€æ ·ã€‚å¦å¤–ï¼Œæ‰§è¡Œè¿™ä¸¤æ¡å‘½ä»¤çš„æ—¶é—´é—´éš”ä¾¿æ˜¯ç”¨æˆ·æŒ‰ä½ç”µæºé”®æ‰€ä¿æŒçš„æ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœæ‰§è¡Œç¬¬ä¸€æ¡å‘½ä»¤åè¿Ÿè¿Ÿä¸æ‰§è¡Œç¬¬äºŒæ¡ï¼Œåˆ™ä¼šäº§ç”Ÿé•¿æŒ‰ç”µæºé”®çš„æ•ˆæœâ€”-å…³æœºå¯¹è¯æ¡†å‡ºç°äº†ã€‚å¾ˆæœ‰è¶£ä¸æ˜¯ä¹ˆï¼Ÿè¾“å…¥è®¾å¤‡èŠ‚ç‚¹åœ¨ç”¨æˆ·ç©ºé—´å¯è¯»å¯å†™çš„ç‰¹æ€§ä¸ºè‡ªåŠ¨åŒ–æµ‹è¯•æä¾›äº†ä¸€æ¡é«˜æ•ˆçš„é€”å¾„ã€‚[1]</p><p>ç°åœ¨ï¼Œè¯»è€…å¯¹è¾“å…¥è®¾å¤‡èŠ‚ç‚¹ä»¥åŠåŸå§‹äº‹ä»¶æœ‰äº†ç›´è§‚çš„è®¤è¯†ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹Androidè¾“å…¥ç³»ç»Ÿçš„åŸºæœ¬åŸç†ã€‚</p><h4 id="3ã€Input-driveræ¨¡æ‹Ÿé©±åŠ¨"><a href="#3ã€Input-driveræ¨¡æ‹Ÿé©±åŠ¨" class="headerlink" title="3ã€Input driveræ¨¡æ‹Ÿé©±åŠ¨"></a>3ã€Input driveræ¨¡æ‹Ÿé©±åŠ¨</h4><p>ä»£ç å®ä¾‹ï¼š <a href="https://github.com/weidongshan/DRV_0004_InputEmulator/" target="_blank" rel="noopener">Input driveræ¨¡æ‹Ÿé©±åŠ¨-ä½œè€…éŸ¦ä¸œå±±</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å‚è€ƒdrivers\input\keyboard\gpio_keys.c */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/input.h&gt;</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">input_emulator_dev</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">input_emulator_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1\. åˆ†é…ä¸€ä¸ªinput_devç»“æ„ä½“ */</span></span><br><span class="line">input_emulator_dev = input_allocate_device();;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2\. è®¾ç½® */</span></span><br><span class="line"><span class="comment">/* 2.1 èƒ½äº§ç”Ÿå“ªç±»äº‹ä»¶ */</span></span><br><span class="line">set_bit(EV_KEY, input_emulator_dev-&gt;evbit);</span><br><span class="line">set_bit(EV_REP, input_emulator_dev-&gt;evbit);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2.2 èƒ½äº§ç”Ÿæ‰€æœ‰çš„æŒ‰é”® */</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; BITS_TO_LONGS(KEY_CNT); i++)</span><br><span class="line">    input_emulator_dev-&gt;keybit[i] = ~<span class="number">0U</span>L;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2.3 ä¸ºandroidæ„é€ ä¸€äº›è®¾å¤‡ä¿¡æ¯ */</span></span><br><span class="line">input_emulator_dev-&gt;name = <span class="string">"InputEmulatorFrom100ask.net"</span>;</span><br><span class="line">input_emulator_dev-&gt;id.bustype = <span class="number">1</span>;</span><br><span class="line">input_emulator_dev-&gt;id.vendor  = <span class="number">0x1234</span>;</span><br><span class="line">input_emulator_dev-&gt;id.product = <span class="number">0x5678</span>;</span><br><span class="line">input_emulator_dev-&gt;id.version = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3\. æ³¨å†Œ */</span></span><br><span class="line">input_register_device(input_emulator_dev);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">input_emulator_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">input_unregister_device(input_emulator_dev);</span><br><span class="line">input_free_device(input_emulator_dev);</span><br><span class="line">&#125;</span><br><span class="line">module_init(input_emulator_init);</span><br><span class="line">module_exit(input_emulator_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br></pre></td></tr></table></figure><p>æµ‹è¯•: insmod InputEmulator.ko</p><p>sendevent /dev/input/event5 1 2 1 // 1 2 1 : EV_KEY, KEY_1, down sendevent /dev/input/event5 1 2 0 // 1 2 0 : EV_KEY, KEY_1, up sendevent /dev/input/event5 0 0 0 // sync</p><p>sendevent /dev/input/event5 1 3 1 // 1 3 1 : EV_KEY, KEY_2, down sendevent /dev/input/event5 1 3 0 // 1 3 0 : EV_KEY, KEY_1, up sendevent /dev/input/event5 0 0 0 // sync é€šè¿‡sendevent æœ€åä¼šæˆåŠŸè¾“å…¥å­—ç¬¦1ã€2ã€‚</p><hr><h1 id="ä¸‰ã€Android-Inputç³»ç»Ÿ"><a href="#ä¸‰ã€Android-Inputç³»ç»Ÿ" class="headerlink" title="ä¸‰ã€Android Inputç³»ç»Ÿ"></a>ä¸‰ã€Android Inputç³»ç»Ÿ</h1><h2 id="ï¼ˆä¸€ï¼‰ã€Android-Input-ç³»ç»Ÿå…³é”®ç±»ä»‹ç»"><a href="#ï¼ˆä¸€ï¼‰ã€Android-Input-ç³»ç»Ÿå…³é”®ç±»ä»‹ç»" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Android Input ç³»ç»Ÿå…³é”®ç±»ä»‹ç»"></a>ï¼ˆä¸€ï¼‰ã€Android Input ç³»ç»Ÿå…³é”®ç±»ä»‹ç»</h2><p>ä¸Šä¸€èŠ‚è®²è¿°äº†è¾“å…¥äº‹ä»¶çš„æºå¤´æ˜¯ä½äº/dev/input/ä¸‹çš„è®¾å¤‡èŠ‚ç‚¹ï¼Œè€Œè¾“å…¥ç³»ç»Ÿçš„ç»ˆç‚¹æ˜¯ç”±WMSç®¡ç†çš„æŸä¸ªçª—å£ã€‚æœ€åˆçš„è¾“å…¥äº‹ä»¶ä¸ºå†…æ ¸ç”Ÿæˆçš„åŸå§‹äº‹ä»¶ï¼Œè€Œæœ€ç»ˆäº¤ä»˜ç»™çª—å£çš„åˆ™æ˜¯KeyEventæˆ–MotionEventå¯¹è±¡ã€‚å› æ­¤Androidè¾“å…¥ç³»ç»Ÿçš„ä¸»è¦å·¥ä½œæ˜¯è¯»å–è®¾å¤‡èŠ‚ç‚¹ä¸­çš„åŸå§‹äº‹ä»¶ï¼Œå°†å…¶åŠ å·¥å°è£…ï¼Œç„¶åæ´¾å‘ç»™ä¸€ä¸ªç‰¹å®šçš„çª—å£ä»¥åŠçª—å£ä¸­çš„æ§ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹ç”±InputManagerServiceï¼ˆä»¥ä¸‹ç®€ç§°IMSï¼‰ç³»ç»ŸæœåŠ¡ä¸ºæ ¸å¿ƒçš„å¤šä¸ªå‚ä¸è€…å…±åŒå®Œæˆã€‚</p><p>è¾“å…¥ç³»ç»Ÿçš„æ€»ä½“æµç¨‹å’Œå‚ä¸è€…å¦‚å›¾3-1æ‰€ç¤ºã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N10-Android-Input-System-framwork-arc.png" alt="Markdown"></p><p>ä¸Šå›¾æè¿°äº†è¾“å…¥äº‹ä»¶çš„å¤„ç†æµç¨‹ä»¥åŠè¾“å…¥ç³»ç»Ÿä¸­æœ€åŸºæœ¬çš„å‚ä¸è€…ã€‚å®ƒä»¬æ˜¯ï¼š</p><p>Â· <strong>Linuxå†…æ ¸</strong>ï¼Œæ¥å—è¾“å…¥è®¾å¤‡çš„ä¸­æ–­ï¼Œå¹¶å°†åŸå§‹äº‹ä»¶çš„æ•°æ®å†™å…¥åˆ°è®¾å¤‡èŠ‚ç‚¹ä¸­ã€‚</p><p>Â· <strong>è®¾å¤‡èŠ‚ç‚¹</strong>ï¼Œä½œä¸ºå†…æ ¸ä¸IMSçš„æ¡¥æ¢ï¼Œå®ƒå°†åŸå§‹äº‹ä»¶çš„æ•°æ®æš´éœ²ç»™ç”¨æˆ·ç©ºé—´ï¼Œä»¥ä¾¿IMSå¯ä»¥ä»ä¸­è¯»å–äº‹ä»¶ã€‚</p><p>Â· <strong>InputManagerService</strong>ï¼Œä¸€ä¸ªAndroidç³»ç»ŸæœåŠ¡ï¼Œå®ƒåˆ†ä¸ºJavaå±‚å’ŒNativeå±‚ä¸¤éƒ¨åˆ†ã€‚Javaå±‚è´Ÿè´£ä¸WMSçš„é€šä¿¡ã€‚è€ŒNativeå±‚åˆ™æ˜¯InputReaderå’ŒInputDispatcherä¸¤ä¸ªè¾“å…¥ç³»ç»Ÿå…³é”®ç»„ä»¶çš„è¿è¡Œå®¹å™¨ã€‚</p><p>Â· <strong>EventHub</strong>ï¼Œç›´æ¥è®¿é—®æ‰€æœ‰çš„è®¾å¤‡èŠ‚ç‚¹ã€‚å¹¶ä¸”æ­£å¦‚å…¶åå­—æ‰€æè¿°çš„ï¼Œå®ƒé€šè¿‡ä¸€ä¸ªåä¸ºgetEvents()çš„å‡½æ•°å°†æ‰€æœ‰è¾“å…¥ç³»ç»Ÿç›¸å…³çš„å¾…å¤„ç†çš„åº•å±‚äº‹ä»¶è¿”å›ç»™ä½¿ç”¨è€…ã€‚è¿™äº›äº‹ä»¶åŒ…æ‹¬åŸå§‹è¾“å…¥äº‹ä»¶ã€è®¾å¤‡èŠ‚ç‚¹çš„å¢åˆ ç­‰ã€‚</p><p>Â· <strong>InputReader</strong>ï¼ŒIæ˜¯IMSä¸­çš„å…³é”®ç»„ä»¶ä¹‹ä¸€ã€‚å®ƒè¿è¡Œäºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œè´Ÿè´£ç®¡ç†è¾“å…¥è®¾å¤‡çš„åˆ—è¡¨ä¸é…ç½®ï¼Œä»¥åŠè¿›è¡Œè¾“å…¥äº‹ä»¶çš„åŠ å·¥å¤„ç†ã€‚å®ƒé€šè¿‡å…¶çº¿ç¨‹å¾ªç¯ä¸æ–­åœ°é€šè¿‡getEvents()å‡½æ•°ä»EventHubä¸­å°†äº‹ä»¶å–å‡ºå¹¶è¿›è¡Œå¤„ç†ã€‚å¯¹äºè®¾å¤‡èŠ‚ç‚¹çš„å¢åˆ äº‹ä»¶ï¼Œå®ƒä¼šæ›´æ–°è¾“å…¥è®¾å¤‡åˆ—è¡¨äºé…ç½®ã€‚å¯¹äºåŸå§‹è¾“å…¥äº‹ä»¶ï¼ŒInputReaderå¯¹å…¶è¿›è¡Œç¿»è¯‘ã€ç»„è£…ã€å°è£…ä¸ºåŒ…å«äº†æ›´å¤šä¿¡æ¯ã€æ›´å…·å¯è¯»æ€§çš„è¾“å…¥äº‹ä»¶ï¼Œç„¶åäº¤ç»™InputDispatcherè¿›è¡Œæ´¾å‘ã€‚</p><p>Â· <strong>InputReaderPolicy</strong>ï¼Œå®ƒä¸ºInputReaderçš„äº‹ä»¶åŠ å·¥å¤„ç†æä¾›ä¸€äº›ç­–ç•¥é…ç½®ï¼Œä¾‹å¦‚é”®ç›˜å¸ƒå±€ä¿¡æ¯ç­‰ã€‚</p><p>Â· <strong>InputDispatcher</strong>ï¼Œæ˜¯IMSä¸­çš„å¦ä¸€ä¸ªå…³é”®ç»„ä»¶ã€‚å®ƒä¹Ÿè¿è¡Œäºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­ã€‚InputDispatcherä¸­ä¿ç®¡äº†æ¥è‡ªWMSçš„æ‰€æœ‰çª—å£çš„ä¿¡æ¯ï¼Œå…¶æ”¶åˆ°æ¥è‡ªInputReaderçš„è¾“å…¥äº‹ä»¶åï¼Œä¼šåœ¨å…¶ä¿ç®¡çš„çª—å£ä¸­å¯»æ‰¾åˆé€‚çš„çª—å£ï¼Œå¹¶å°†äº‹ä»¶æ´¾å‘ç»™æ­¤çª—å£ã€‚</p><p>Â· <strong>InputDispatcherPolicy</strong>ï¼Œå®ƒä¸ºInputDispatcherçš„æ´¾å‘è¿‡ç¨‹æä¾›ç­–ç•¥æ§åˆ¶ã€‚ä¾‹å¦‚æˆªå–æŸäº›ç‰¹å®šçš„è¾“å…¥äº‹ä»¶ç”¨ä½œç‰¹æ®Šç”¨é€”ï¼Œæˆ–è€…é˜»æ­¢å°†æŸäº›äº‹ä»¶æ´¾å‘ç»™ç›®æ ‡çª—å£ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯HOMEé”®è¢«InputDispatcherPolicyæˆªå–åˆ°PhoneWindowManagerä¸­è¿›è¡Œå¤„ç†ï¼Œå¹¶é˜»æ­¢çª—å£æ”¶åˆ°HOMEé”®æŒ‰ä¸‹çš„äº‹ä»¶ã€‚</p><p>Â· <strong>WMS</strong>ï¼Œè™½è¯´ä¸æ˜¯è¾“å…¥ç³»ç»Ÿä¸­çš„ä¸€å‘˜ï¼Œä½†æ˜¯å®ƒå´å¯¹InputDispatcherçš„æ­£å¸¸å·¥ä½œèµ·åˆ°äº†è‡³å…³é‡è¦çš„ä½œç”¨ã€‚å½“æ–°å»ºçª—å£æ—¶ï¼ŒWMSä¸ºæ–°çª—å£å’ŒIMSåˆ›å»ºäº†äº‹ä»¶ä¼ é€’æ‰€ç”¨çš„é€šé“ã€‚å¦å¤–ï¼ŒWMSè¿˜å°†æ‰€æœ‰çª—å£çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬çª—å£çš„å¯ç‚¹å‡»åŒºåŸŸï¼Œç„¦ç‚¹çª—å£ç­‰ä¿¡æ¯ï¼Œå®æ—¶åœ°æ›´æ–°åˆ°IMSçš„InputDispatcherä¸­ï¼Œä½¿å¾—InputDispatcherå¯ä»¥æ­£ç¡®åœ°å°†äº‹ä»¶æ´¾å‘åˆ°æŒ‡å®šçš„çª—å£ã€‚</p><p>Â· <strong>ViewRootImpl</strong>ï¼Œå¯¹äºæŸäº›çª—å£ï¼Œå¦‚å£çº¸çª—å£ã€SurfaceViewçš„çª—å£æ¥è¯´ï¼Œçª—å£å³æ˜¯è¾“å…¥äº‹ä»¶æ´¾å‘çš„ç»ˆç‚¹ã€‚è€Œå¯¹äºå…¶ä»–çš„å¦‚Activityã€å¯¹è¯æ¡†ç­‰ä½¿ç”¨äº†Androidæ§ä»¶ç³»ç»Ÿçš„çª—å£æ¥è¯´ï¼Œè¾“å…¥äº‹ä»¶çš„ç»ˆç‚¹æ˜¯æ§ä»¶ï¼ˆViewï¼‰ã€‚ViewRootImplå°†çª—å£æ‰€æ¥æ”¶åˆ°çš„è¾“å…¥äº‹ä»¶æ²¿ç€æ§ä»¶æ ‘å°†äº‹ä»¶æ´¾å‘ç»™æ„Ÿå…´è¶£çš„æ§ä»¶ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå†…æ ¸å°†åŸå§‹äº‹ä»¶å†™å…¥åˆ°è®¾å¤‡èŠ‚ç‚¹ä¸­ï¼ŒInputReaderä¸æ–­åœ°é€šè¿‡EventHubå°†åŸå§‹äº‹ä»¶å–å‡ºæ¥å¹¶ç¿»è¯‘åŠ å·¥æˆAndroidè¾“å…¥äº‹ä»¶ï¼Œç„¶åäº¤ç»™InputDispatcherã€‚InputDispatcheræ ¹æ®WMSæä¾›çš„çª—å£ä¿¡æ¯å°†äº‹ä»¶äº¤ç»™åˆé€‚çš„çª—å£ã€‚çª—å£çš„ViewRootImplå¯¹è±¡å†æ²¿ç€æ§ä»¶æ ‘å°†äº‹ä»¶æ´¾å‘ç»™æ„Ÿå…´è¶£çš„æ§ä»¶ã€‚æ§ä»¶å¯¹å…¶æ”¶åˆ°çš„äº‹ä»¶ä½œå‡ºå“åº”ï¼Œæ›´æ–°è‡ªå·±çš„ç”»é¢ã€æ‰§è¡Œç‰¹å®šçš„åŠ¨ä½œã€‚æ‰€æœ‰è¿™äº›å‚ä¸è€…ä»¥IMSä¸ºæ ¸å¿ƒï¼Œæ„å»ºäº†Androidåºå¤§è€Œå¤æ‚çš„è¾“å…¥ä½“ç³»ã€‚</p><p>æ¥ä¸‹æ¥è¯¦ç»†è®¨è®ºé™¤Linuxå†…æ ¸ä»¥å¤–çš„å…¶ä»–å‚ä¸è€…çš„å·¥ä½œåŸç†ã€‚</p><h2 id="ï¼ˆäºŒï¼‰ã€IMSçš„åˆ›å»ºä¸å¯åŠ¨"><a href="#ï¼ˆäºŒï¼‰ã€IMSçš„åˆ›å»ºä¸å¯åŠ¨" class="headerlink" title="ï¼ˆäºŒï¼‰ã€IMSçš„åˆ›å»ºä¸å¯åŠ¨"></a>ï¼ˆäºŒï¼‰ã€IMSçš„åˆ›å»ºä¸å¯åŠ¨</h2><p>IMSåˆ†ä¸ºJavaå±‚ä¸Nativeå±‚ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå…¶å¯åŠ¨è¿‡ç¨‹æ˜¯ä»Javaéƒ¨åˆ†çš„åˆå§‹åŒ–å¼€å§‹ï¼Œè¿›è€Œå®ŒæˆNativeéƒ¨åˆ†çš„åˆå§‹åŒ–ã€‚ IMSåœ¨SystemServer.startOtherServices()æ–¹æ³•ä¸­å¯åŠ¨çš„ã€‚IMSçš„è¯ç”Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><p>Â· åˆ›å»ºæ–°çš„IMSå¯¹è±¡ã€‚</p><p>Â· è°ƒç”¨IMSå¯¹è±¡çš„start()å‡½æ•°å®Œæˆå¯åŠ¨ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹çš„åºåˆ—å›¾ï¼Œç„¶åæ ¹æ®åºåˆ—å›¾æ¥ä¸€æ­¥æ­¥åˆ†æã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N11-Android-Input-System-input-create-thread.png" alt="Markdown"></p><h2 id="Step-1ã€-SystemServer-startOtherServices"><a href="#Step-1ã€-SystemServer-startOtherServices" class="headerlink" title="Step 1ã€ SystemServer.startOtherServices()"></a>Step 1ã€ SystemServer.startOtherServices()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> [-&gt;frameworks/base/services/java/com/android/server/SystemServer.java]</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> ......</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     ......</span><br><span class="line">       <span class="comment">// â‘  æ–°å»ºIMSå¯¹è±¡ã€‚</span></span><br><span class="line">     traceBeginAndSlog(<span class="string">"StartInputManagerService"</span>);</span><br><span class="line">     inputManager = <span class="keyword">new</span> InputManagerService(context);</span><br><span class="line">     Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">     traceBeginAndSlog(<span class="string">"StartWindowManagerService"</span>);</span><br><span class="line">     wm = WindowManagerService.main(context, inputManager,</span><br><span class="line">             mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL,</span><br><span class="line">             !mFirstBoot, mOnlyCore);</span><br><span class="line">      <span class="comment">//å°†WindowManagerServiceåŠ å…¥åˆ°ServiceManagerä¸­</span></span><br><span class="line">     ServiceManager.addService(Context.WINDOW_SERVICE, wm);</span><br><span class="line">     <span class="comment">//å°†InputManagerServiceåŠ å…¥åˆ°ServiceManagerä¸­</span></span><br><span class="line">     ServiceManager.addService(Context.INPUT_SERVICE, inputManager);</span><br><span class="line">     Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">     mActivityManagerService.setWindowManager(wm);</span><br><span class="line">      <span class="comment">// è®¾ç½®å‘WMSå‘èµ·å›è°ƒçš„callbackå¯¹è±¡</span></span><br><span class="line">     inputManager.setWindowManagerCallbacks(wm.getInputMonitor());</span><br><span class="line">     <span class="comment">// â‘¡ æ­£å¼å¯åŠ¨IMS</span></span><br><span class="line">     inputManager.start();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨SystemServerä¸­å…ˆæ„é€ äº†ä¸€ä¸ªInputManagerServiceå¯¹è±¡å’Œä¸€ä¸ªWindowManagerServiceå¯¹è±¡ï¼Œç„¶åå°†InputManagerServiceå¯¹è±¡ä¼ ç»™WindowManagerServiceå¯¹è±¡ï¼ŒWindowManagerServiceä¸­åˆå§‹åŒ–äº†ä¸€ä¸ªInputMonitorå¯¹è±¡ï¼Œè°ƒç”¨InputManagerService.setWindowManagerCallbackså‡½æ•°å°†InputMonitorä¼ è¿›å»ï¼Œåé¢nativeå±‚å›è°ƒæ—¶ä¼šè°ƒç”¨åˆ°è¯¥InputMonitorå¯¹è±¡ã€‚</p><h2 id="Step-2ã€-InputManagerService"><a href="#Step-2ã€-InputManagerService" class="headerlink" title="Step 2ã€ InputManagerService()"></a>Step 2ã€ InputManagerService()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;frameworks/base/services/core/java/com/android/server/input/InputManagerService.java]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InputManagerService</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mContext = context;</span><br><span class="line">    <span class="comment">//æ³¨æ„è¿™é‡Œæ‹¿äº†DisplayThreadçš„Handlerï¼Œæ„å‘³ç€IMSä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†éƒ½æ˜¯åœ¨å•ç‹¬çš„DisplayThreadä¸­è¿›è¡Œçš„ã€‚</span></span><br><span class="line">    <span class="comment">//å®ƒæ˜¯ç³»ç»Ÿä¸­å…±äº«çš„å•ä¾‹å‰å°çº¿ç¨‹ï¼Œä¸»è¦ç”¨ä½œè¾“å…¥è¾“å‡ºçš„å¤„ç†ç”¨ã€‚è¿™æ ·å¯ä»¥ä½¿ç”¨æˆ·ä½“éªŒæ•æ„Ÿçš„å¤„ç†å°‘å—å…¶å®ƒå·¥ä½œçš„å½±å“ï¼Œå‡å°‘å»¶æ—¶ã€‚</span></span><br><span class="line">    <span class="keyword">this</span>.mHandler = <span class="keyword">new</span> InputManagerHandler(DisplayThread.get().getLooper());</span><br><span class="line">    <span class="comment">//è°ƒç”¨nativeInitæ¥æ‰§è¡ŒC++å±‚çš„åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">    mPtr = nativeInit(<span class="keyword">this</span>, mContext, mHandler.getLooper().getQueue());</span><br><span class="line">    LocalServices.addService(InputManagerInternal.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Step-3ã€-InputManagerService-nativeInit"><a href="#Step-3ã€-InputManagerService-nativeInit" class="headerlink" title="Step 3ã€ InputManagerService.nativeInit()"></a>Step 3ã€ InputManagerService.nativeInit()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeInit</span><span class="params">(JNIEnv* env, jclass <span class="comment">/* clazz */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    jobject serviceObj, jobject contextObj, jobject messageQueueObj)</span> </span>&#123;</span><br><span class="line">sp&lt;MessageQueue&gt; messageQueue = android_os_MessageQueue_getMessageQueue(env, messageQueueObj);</span><br><span class="line">......</span><br><span class="line">    <span class="comment">// æ–°å»ºäº†ä¸€ä¸ªNativeInputManagerå¯¹è±¡ï¼ŒNativeInputManagerï¼Œæ­¤å¯¹è±¡å°†æ˜¯Nativeå±‚ç»„ä»¶ä¸</span></span><br><span class="line">    <span class="comment">//Javaå±‚IMSè¿›è¡Œé€šä¿¡çš„æ¡¥æ¢</span></span><br><span class="line">NativeInputManager* im = <span class="keyword">new</span> NativeInputManager(contextObj, serviceObj,</span><br><span class="line">        messageQueue-&gt;getLooper());</span><br><span class="line">im-&gt;incStrong(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// è¿”å›äº†NativeInputManagerå¯¹è±¡çš„æŒ‡é’ˆç»™Javaå±‚çš„IMSï¼ŒIMSå°†å…¶ä¿å­˜åœ¨mPtræˆå‘˜å˜é‡ä¸­</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(im);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªNativeInputManagerå®ä¾‹ï¼Œå¹¶å°†å…¶ä½œä¸ºè¿”å›å€¼ä¿å­˜åœ¨InputManagerService.javaä¸­çš„mPtrå­—æ®µä¸­ã€‚</p><h2 id="Step-4ã€NativeInputManager"><a href="#Step-4ã€NativeInputManager" class="headerlink" title="Step 4ã€NativeInputManager()"></a>Step 4ã€NativeInputManager()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp]</span><br><span class="line"></span><br><span class="line">NativeInputManager::NativeInputManager(jobject contextObj,</span><br><span class="line">    jobject serviceObj, <span class="keyword">const</span> sp&lt;Looper&gt;&amp; looper) :</span><br><span class="line">    mLooper(looper), mInteractive(<span class="literal">true</span>) &#123;</span><br><span class="line"><span class="comment">// å‡ºç°é‡ç‚¹äº†ï¼Œ NativeInputManageråˆ›å»ºäº†EventHub</span></span><br><span class="line"><span class="comment">//æ„é€ ä¸€ä¸ªEventHubå¯¹è±¡,æœ€åŸå§‹çš„è¾“å…¥äº‹ä»¶éƒ½æ˜¯é€šè¿‡å®ƒæ”¶é›†å¹¶ä¸”ç²—åŠ å·¥ç„¶åç»™åˆ°InputReaderå¯¹è±¡</span></span><br><span class="line">sp&lt;EventHub&gt; eventHub = <span class="keyword">new</span> EventHub();</span><br><span class="line"><span class="comment">// æ¥ç€åˆ›å»ºäº†Nativeå±‚çš„InputManager</span></span><br><span class="line">mInputManager = <span class="keyword">new</span> InputManager(eventHub, <span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NativeInputManageræ„é€ å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªEventHubå®ä¾‹ï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰ï¼Œå¹¶ä¸”å°†è¿™ä¸ªå®ä¾‹ä½œä¸ºå‚æ•°æ¥åˆ›å»ºä¸€ä¸ªInputManagerå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šåšä¸€äº›åˆå§‹åŒ–çš„æ“ä½œã€‚</p><h2 id="Step-5ã€InputManager"><a href="#Step-5ã€InputManager" class="headerlink" title="Step 5ã€InputManager()"></a>Step 5ã€InputManager()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputManager.cpp]</span><br><span class="line"></span><br><span class="line">InputManager::InputManager(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;EventHubInterface&gt;&amp; eventHub,   </span><br><span class="line">    <span class="keyword">const</span> sp&lt;InputReaderPolicyInterface&gt;&amp; readerPolicy,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;InputDispatcherPolicyInterface&gt;&amp; dispatcherPolicy) &#123;</span><br><span class="line">mDispatcher = <span class="keyword">new</span> InputDispatcher(dispatcherPolicy);</span><br><span class="line">mReader = <span class="keyword">new</span> InputReader(eventHub, readerPolicy, mDispatcher);</span><br><span class="line">initialize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºäº†InputDispatcherå¯¹è±¡ç”¨äºåˆ†å‘æŒ‰é”®ç»™å½“å‰focusçš„çª—å£çš„ï¼ŒåŒæ—¶åˆ›å»ºäº†ä¸€ä¸ªInputReaderç”¨äºä»EventHubä¸­è¯»å–äº‹ä»¶ã€‚</p><h2 id="Step-6ã€InputManager-initialize"><a href="#Step-6ã€InputManager-initialize" class="headerlink" title="Step 6ã€InputManager.initialize()"></a>Step 6ã€InputManager.initialize()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputManager.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputManager::initialize() &#123;</span><br><span class="line"> <span class="comment">// åˆ›å»ºä¾›InputReaderè¿è¡Œçš„çº¿ç¨‹InputReaderThread</span></span><br><span class="line">mReaderThread = <span class="keyword">new</span> InputReaderThread(mReader);</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¾›InputDispatcherè¿è¡Œçš„çº¿ç¨‹InputDispatcherThread</span></span><br><span class="line">mDispatcherThread = <span class="keyword">new</span> InputDispatcherThread(mDispatcher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªInputReaderThreadå’ŒInputDispatcherThreadå¯¹è±¡ï¼Œå‰é¢æ„é€ å‡½æ•°ä¸­åˆ›å»ºçš„InputReaderå®é™…ä¸Šæ˜¯é€šè¿‡InputReaderThreadæ¥è¯»å–äº‹ä»¶ï¼Œè€ŒInputDispatcherå®é™…é€šè¿‡InputDispatcherThreadæ¥åˆ†å‘äº‹ä»¶</p><h3 id="å›¾3-1ï¼š"><a href="#å›¾3-1ï¼š" class="headerlink" title="å›¾3-1ï¼š"></a>å›¾3-1ï¼š</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N12-Android-Input-System-IMS-system.png" alt="Markdown"></p><p>InputManagerçš„æ„é€ å‡½æ•°ä¹Ÿæ¯”è¾ƒç®€æ´ï¼Œå®ƒåˆ›å»ºäº†å››ä¸ªå¯¹è±¡ï¼Œåˆ†åˆ«ä¸ºIMSçš„æ ¸å¿ƒå‚ä¸è€…InputReaderä¸InputDispatcherï¼Œä»¥åŠå®ƒä»¬æ‰€åœ¨çš„çº¿ç¨‹InputReaderThreadä¸InputDispatcherThreadã€‚æ³¨æ„InputManagerçš„æ„é€ å‡½æ•°çš„å‚æ•°readerPolicyä¸dispatcherPolicyï¼Œå®ƒä»¬éƒ½æ˜¯NativeInputManagerã€‚</p><p>è‡³æ­¤ï¼ŒIMSçš„åˆ›å»ºå®Œæˆäº†ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¾“å…¥ç³»ç»Ÿçš„é‡è¦å‚ä¸è€…å‡å®Œæˆåˆ›å»ºï¼Œå¹¶å¾—åˆ°äº†å¦‚å›¾3-1æ‰€æè¿°çš„ä¸€å¥—ä½“ç³»ã€‚</p><p>ä¾æ¬¡åˆå§‹åŒ–NativeInputManagerï¼ŒEventHubï¼ŒInputManager, InputDispatcherï¼ŒInputReaderï¼ŒInputReaderThread, InputDispatcherThreadã€‚NativeInputManagerå¯çœ‹ä½œIMSå’ŒInputManagerçš„ä¸­é—´å±‚ï¼Œå°†IMSçš„è¯·æ±‚è½¬åŒ–ä¸ºå¯¹InputManageråŠå…¶å†…éƒ¨å¯¹è±¡çš„æ“ä½œï¼ŒåŒæ—¶å°†InputManagerä¸­æ¨¡å—çš„è¯·æ±‚é€šè¿‡JNIè°ƒå›IMSã€‚InputManageræ˜¯è¾“å…¥æ§åˆ¶ä¸­å¿ƒï¼Œå®ƒæœ‰ä¸¤ä¸ªå…³é”®çº¿ç¨‹InputReaderThreadå’ŒInputDispatcherThreadï¼Œå®ƒä»¬çš„ä¸»è¦åŠŸèƒ½éƒ¨åˆ†åˆ†åˆ«åœ¨InputReaderå’ŒInputDispacherã€‚å‰è€…ç”¨äºä»è®¾å¤‡ä¸­è¯»å–äº‹ä»¶ï¼Œåè€…å°†äº‹ä»¶åˆ†å‘ç»™ç›®æ ‡çª—å£ã€‚EventHubæ˜¯è¾“å…¥è®¾å¤‡çš„æ§åˆ¶ä¸­å¿ƒï¼Œå®ƒç›´æ¥ä¸input driveræ‰“äº¤é“ã€‚è´Ÿè´£å¤„ç†è¾“å…¥è®¾å¤‡çš„å¢å‡ï¼ŒæŸ¥è¯¢ï¼Œè¾“å…¥äº‹ä»¶çš„å¤„ç†å¹¶å‘ä¸Šå±‚æä¾›getEvents()æ¥å£æ¥æ”¶äº‹ä»¶ã€‚åœ¨å®ƒçš„æ„é€ å‡½æ•°ä¸­ï¼Œä¸»è¦åšä¸‰ä»¶äº‹ï¼ˆç»“åˆä¹‹å‰Linuxå¿…å¤‡çŸ¥è¯†ï¼‰ï¼š</p><ol><li>åˆ›å»ºepollå¯¹è±¡ï¼Œä¹‹åå°±å¯ä»¥æŠŠå„è¾“å…¥è®¾å¤‡çš„fdæŒ‚åœ¨ä¸Šé¢å¤šè·¯ç­‰å¾…è¾“å…¥äº‹ä»¶ã€‚</li><li>å»ºç«‹ç”¨äºå”¤é†’çš„pipeï¼ŒæŠŠè¯»ç«¯æŒ‚åˆ°epollä¸Šï¼Œä»¥åå¦‚æœæœ‰è®¾å¤‡å‚æ•°çš„å˜åŒ–éœ€è¦å¤„ç†ï¼Œè€ŒgetEvents()åˆé˜»å¡åœ¨è®¾å¤‡ä¸Šï¼Œå°±å¯ä»¥è°ƒç”¨wake()åœ¨pipeçš„å†™ç«¯å†™å…¥ï¼Œå°±å¯ä»¥è®©çº¿ç¨‹ä»ç­‰å¾…ä¸­è¿”å›ã€‚</li><li>åˆ©ç”¨inotifyæœºåˆ¶ç›‘å¬/dev/inputç›®å½•ä¸‹çš„å˜æ›´ï¼Œå¦‚æœ‰åˆ™æ„å‘³ç€è®¾å¤‡çš„å˜åŒ–ï¼Œéœ€è¦å¤„ç†ã€‚ å› ä¸ºäº‹ä»¶çš„å¤„ç†æ˜¯æµæ°´çº¿ï¼Œéœ€è¦InputReaderå…ˆè¯»äº‹ä»¶ï¼Œç„¶åInputDispatcheræ‰èƒ½è¿›ä¸€æ­¥å¤„ç†å’Œåˆ†å‘ã€‚å› æ­¤InputDispatcheréœ€è¦ç›‘å¬InputReaderã€‚è¿™é‡Œä½¿ç”¨äº†Listeneræ¨¡å¼ï¼ŒInputDispacherä½œä¸ºInputReaderæ„é€ å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå®ƒå®ç°InputListenerInterfaceæ¥å£ã€‚åˆ°äº†InputReaderçš„æ„é€ å‡½æ•°ä¸­ï¼Œå°†ä¹‹åŒ…è£…æˆQueuedInputListenerã€‚QueuedInputListenerä¸­çš„æˆå‘˜å˜é‡mArgsQueueæ˜¯ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—ï¼Œåªæœ‰åœ¨flush()æ—¶ï¼Œæ‰ä¼šä¸€æ¬¡æ€§é€šçŸ¥InputDispatcherã€‚QueuedInputListeneråº”ç”¨äº†Commandæ¨¡å¼ï¼Œå®ƒé€šè¿‡åŒ…è£…InputDispatcher(å®ç°InputListenerInterfaceæ¥å£)ï¼Œå°†äº‹ä»¶çš„å¤„ç†è¯·æ±‚å°è£…æˆNotifyArgsï¼Œä½¿å…¶æœ‰äº†ç¼“å†²æ‰§è¡Œçš„åŠŸèƒ½ã€‚</li></ol><h2 id="IMSçš„æˆå‘˜å…³ç³»"><a href="#IMSçš„æˆå‘˜å…³ç³»" class="headerlink" title="IMSçš„æˆå‘˜å…³ç³»"></a>IMSçš„æˆå‘˜å…³ç³»</h2><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N13-Android-Input-System-IMS-membership.png" alt="Markdown"></p><h2 id="ï¼ˆä¸‰ï¼‰ã€IMSå¯åŠ¨"><a href="#ï¼ˆä¸‰ï¼‰ã€IMSå¯åŠ¨" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€IMSå¯åŠ¨"></a>ï¼ˆä¸‰ï¼‰ã€IMSå¯åŠ¨</h2><p>IMSå¯åŠ¨ä¸»è¦æ˜¯å°†å‰é¢åˆ›å»ºçš„InputReaderThreadå’ŒInputDispatcherThreadå¯åŠ¨èµ·æ¥</p><h2 id="Step-1ã€InputManagerService-start"><a href="#Step-1ã€InputManagerService-start" class="headerlink" title="Step 1ã€InputManagerService.start()"></a>Step 1ã€InputManagerService.start()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/java/com/android/server/input/InputManagerService.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">"Starting input manager"</span>);</span><br><span class="line">    nativeStart(mPtr);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦è°ƒç”¨äº†nativeStartè¿›å…¥nativeå±‚å¯åŠ¨</p><h2 id="Step-2-InputManagerService-nativeStart"><a href="#Step-2-InputManagerService-nativeStart" class="headerlink" title="Step 2. InputManagerService.nativeStart()"></a>Step 2. InputManagerService.nativeStart()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeStart</span><span class="params">(JNIEnv* env, jclass <span class="comment">/* clazz */</span>, jlong ptr)</span> </span>&#123;</span><br><span class="line">NativeInputManager* im = <span class="keyword">reinterpret_cast</span>&lt;NativeInputManager*&gt;(ptr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> result = im-&gt;getInputManager()-&gt;start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥nativeå±‚InputManagerçš„startå‡½æ•°</p><h2 id="Step-3ã€InputManager-start"><a href="#Step-3ã€InputManager-start" class="headerlink" title="Step 3ã€InputManager.start()"></a>Step 3ã€InputManager.start()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputManager.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> InputManager::start() &#123;</span><br><span class="line"><span class="keyword">status_t</span> result = mDispatcherThread-&gt;run(<span class="string">"InputDispatcher"</span>, PRIORITY_URGENT_DISPLAY);</span><br><span class="line">result = mReaderThread-&gt;run(<span class="string">"InputReader"</span>, PRIORITY_URGENT_DISPLAY);</span><br><span class="line"><span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å®é™…å¯åŠ¨äº†ä¸€ä¸ªInputReaderThreadå’ŒInputDispatcherThreadæ¥ä»è¯»å–å’Œåˆ†å‘é”®ç›˜æ¶ˆæ¯ï¼Œè°ƒç”¨å®ƒä»¬çš„runæ–¹æ³•åï¼Œå°±ä¼šè¿›å…¥threadLoopå‡½æ•°ä¸­ï¼Œåªè¦threadLoopå‡½æ•°è¿”å›trueï¼Œè¯¥å‡½æ•°å°±ä¼šå¾ªç¯æ‰§è¡Œã€‚</p><p>InputReaderThreadä¸æ–­è°ƒç”¨InputReaderçš„pollOnce()-&gt;getEvents()å‡½æ•°æ¥å¾—åˆ°äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯ä»¥æ˜¯è¾“å…¥äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”±inotifyç›‘æµ‹åˆ°è®¾å¤‡å¢å‡å˜æ›´æ‰€è§¦å‘çš„äº‹ä»¶ï¼Œç¨åä¼šè¯¦ç»†ä»‹ç»ã€‚</p><h2 id="Step-4ã€InputReaderThread-threadLoop"><a href="#Step-4ã€InputReaderThread-threadLoop" class="headerlink" title="Step 4ã€InputReaderThread.threadLoop()"></a>Step 4ã€InputReaderThread.threadLoop()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> InputReaderThread::threadLoop() &#123;</span><br><span class="line">mReader-&gt;loopOnce();</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨å‰é¢åˆ›å»ºçš„InputReaderThreadå¯¹è±¡çš„loopOnceè¿›è¡Œä¸€æ¬¡çº¿ç¨‹å¾ªç¯</p><h2 id="Step5ã€InputReaderThread-loopOnce"><a href="#Step5ã€InputReaderThread-loopOnce" class="headerlink" title="Step5ã€InputReaderThread.loopOnce()"></a>Step5ã€InputReaderThread.loopOnce()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"> <span class="keyword">void</span> InputReader::loopOnce() &#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* â‘  é€šè¿‡EventHubæŠ½å–äº‹ä»¶åˆ—è¡¨ã€‚è¯»å–çš„ç»“æœå­˜å‚¨åœ¨å‚æ•°mEventBufferä¸­ï¼Œè¿”å›å€¼è¡¨ç¤ºäº‹ä»¶çš„ä¸ªæ•°</span></span><br><span class="line"><span class="comment">   å½“EventHubä¸­æ— äº‹ä»¶å¯ä»¥æŠ½å–æ—¶ï¼Œæ­¤å‡½æ•°çš„è°ƒç”¨å°†ä¼šé˜»å¡ç›´åˆ°äº‹ä»¶åˆ°æ¥æˆ–è€…è¶…æ—¶ */</span></span><br><span class="line">size_tcount = mEventHub-&gt;getEvents(timeoutMillis,mEventBuffer, EVENT_BUFFER_SIZE);</span><br><span class="line">&#123;</span><br><span class="line">   AutoMutex _l(mLock);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span>(count) &#123;</span><br><span class="line">       <span class="comment">// â‘¡ å¦‚æœæœ‰æŠ½å¾—äº‹ä»¶ï¼Œåˆ™è°ƒç”¨processEventsLocked()å‡½æ•°å¯¹äº‹ä»¶è¿›è¡ŒåŠ å·¥å¤„ç†</span></span><br><span class="line">       processEventsLocked(mEventBuffer, count);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* â‘¢ å‘å¸ƒäº‹ä»¶ã€‚ processEventsLocked()å‡½æ•°åœ¨å¯¹äº‹ä»¶è¿›è¡ŒåŠ å·¥å¤„ç†ä¹‹åï¼Œä¾¿å°†å¤„ç†åçš„äº‹ä»¶å­˜å‚¨åœ¨</span></span><br><span class="line"><span class="comment">  mQueuedListenerä¸­ã€‚åœ¨å¾ªç¯çš„æœ€åï¼Œé€šè¿‡è°ƒç”¨flush()å‡½æ•°å°†æ‰€æœ‰äº‹ä»¶äº¤ä»˜ç»™InputDispatcher */</span></span><br><span class="line">  mQueuedListener-&gt;flush();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>InputReaderçš„ä¸€æ¬¡çº¿ç¨‹å¾ªç¯çš„å·¥ä½œæ€è·¯æ¯”è¾ƒæ¸…æ™°ï¼Œä¸€å…±ä¸‰æ­¥ï¼š</p><p>Â· é¦–å…ˆä»EventHubä¸­æŠ½å–æœªå¤„ç†çš„äº‹ä»¶åˆ—è¡¨ã€‚è¿™äº›äº‹ä»¶åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ä»è®¾å¤‡èŠ‚ç‚¹ä¸­è¯»å–çš„åŸå§‹è¾“å…¥äº‹ä»¶ï¼Œå¦ä¸€ç±»åˆ™æ˜¯è¾“å…¥è®¾å¤‡å¯ç”¨æ€§å˜åŒ–äº‹ä»¶ï¼Œç®€ç§°ä¸ºè®¾å¤‡äº‹ä»¶ã€‚</p><p>Â· é€šè¿‡processEventsLocked()å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚å¯¹äºè®¾å¤‡äº‹ä»¶ï¼Œæ­¤å‡½æ•°å¯¹æ ¹æ®è®¾å¤‡çš„å¯ç”¨æ€§åŠ è½½æˆ–ç§»é™¤è®¾å¤‡å¯¹åº”çš„é…ç½®ä¿¡æ¯ã€‚å¯¹äºåŸå§‹è¾“å…¥äº‹ä»¶ï¼Œåˆ™åœ¨è¿›è¡Œè½¬è¯‘ã€å°è£…ä¸åŠ å·¥åå°†ç»“æœæš‚å­˜åˆ°mQueuedListenerä¸­ã€‚</p><p>Â· æ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæ¯•åï¼Œè°ƒç”¨mQueuedListener.flush()å°†æ‰€æœ‰æš‚å­˜çš„è¾“å…¥äº‹ä»¶ä¸€æ¬¡æ€§åœ°äº¤ä»˜ç»™InputDispatcherã€‚</p><p>è¿™ä¾¿æ˜¯InputReaderçš„æ€»ä½“å·¥ä½œæµç¨‹ã€‚è€Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†è¯¦ç»†è®¨è®ºè¿™ä¸‰æ­¥çš„å®ç°ã€‚</p><h2 id="Step-6ã€InputDispatcherThread-threadLoop"><a href="#Step-6ã€InputDispatcherThread-threadLoop" class="headerlink" title="Step 6ã€InputDispatcherThread.threadLoop()"></a>Step 6ã€InputDispatcherThread.threadLoop()</h2><p>InputDisptacherçš„ä¸»è¦ä»»åŠ¡æ˜¯æŠŠæ”¶åˆ°çš„è¾“å…¥äº‹ä»¶å‘é€åˆ°PhoneWIndowManageræˆ–Appç«¯çš„ç„¦ç‚¹çª—å£ä¸Šï¼Œç¨åè¯¦ç»†ä»‹ç»ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> InputDispatcherThread::threadLoop() &#123;</span><br><span class="line">mDispatcher-&gt;dispatchOnce();</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨å‰é¢åˆ›å»ºçš„InputDispatcherå¯¹è±¡çš„dispatchOnceå‡½æ•°è¿›è¡Œä¸€æ¬¡æŒ‰é”®åˆ†å‘</p><h2 id="Step-7ã€InputDispatcher-dispatchOnce"><a href="#Step-7ã€InputDispatcher-dispatchOnce" class="headerlink" title="Step 7ã€InputDispatcher.dispatchOnce()"></a>Step 7ã€InputDispatcher.dispatchOnce()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::dispatchOnce() &#123;</span><br><span class="line"><span class="keyword">nsecs_t</span> nextWakeupTime = LONG_LONG_MAX;</span><br><span class="line">&#123; <span class="comment">// acquire lock</span></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line">    mDispatcherIsAliveCondition.broadcast();</span><br><span class="line">    <span class="keyword">if</span> (!haveCommandsLocked()) &#123;</span><br><span class="line">        dispatchOnceInnerLocked(&amp;nextWakeupTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (runCommandsLockedInterruptible()) &#123;</span><br><span class="line">        nextWakeupTime = LONG_LONG_MIN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">// release lock</span></span><br><span class="line"><span class="comment">// Wait for callback or timeout or wake.  (make sure we round up, not down)</span></span><br><span class="line"><span class="keyword">nsecs_t</span> currentTime = now();</span><br><span class="line"><span class="keyword">int</span> timeoutMillis = toMillisecondTimeoutDelay(currentTime, nextWakeupTime);</span><br><span class="line">mLooper-&gt;pollOnce(timeoutMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å‡½æ•°ä¸»è¦æ˜¯è°ƒç”¨dispatchOnceInnerLockedæ¥è¿›è¡Œä¸€æ¬¡æŒ‰é”®åˆ†å‘ï¼Œå½“æ²¡æœ‰æŒ‰é”®æ¶ˆæ¯æ—¶ä¼šèµ°åˆ°mLooper-&gt;pollOnce(timeoutMillis)ï¼›è¿™ä¸ªå‡½æ•°ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå½“æœ‰æŒ‰é”®æ¶ˆæ¯å‘ç”Ÿæ—¶è¯¥å‡½æ•°ä¼šè¿”å›ï¼Œç„¶åèµ°åˆ°dispatchOnceInnerLockedå‡½æ•°ã€‚è¿™é‡ŒmLooper-&gt;pollOnceä¸ºä½•ä¼šç¡çœ æ¶‰åŠåˆ°Androidçš„Handleræœºåˆ¶[â˜ºå†æ€»ç»“â˜º]ã€‚</p><h2 id="å°ç»“ï¼š"><a href="#å°ç»“ï¼š" class="headerlink" title="å°ç»“ï¼š"></a>å°ç»“ï¼š</h2><p>å®ŒæˆIMSçš„åˆ›å»ºä¹‹åï¼ŒInputManagerService.start()å‡½æ•°ä»¥å¯åŠ¨IMSã€‚InputManagerçš„åˆ›å»ºè¿‡ç¨‹åˆ†åˆ«ä¸ºInputReaderä¸InputDispatcheråˆ›å»ºäº†æ‰¿è½½å®ƒä»¬è¿è¡Œçš„çº¿ç¨‹ï¼Œç„¶è€Œå¹¶æœªå°†è¿™ä¸¤ä¸ªçº¿ç¨‹å¯åŠ¨ï¼Œå› æ­¤IMSçš„å„å‘˜å¤§å°†ä»å¤„äºå¾…å‘½çŠ¶æ€ã€‚æ­¤æ—¶start()å‡½æ•°çš„åŠŸèƒ½å°±æ˜¯å¯åŠ¨è¿™ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½¿å¾—InputReaderäºInputDispatcherå¼€å§‹å·¥ä½œã€‚</p><p>å½“ä¸¤ä¸ªçº¿ç¨‹å¯åŠ¨åï¼ŒInputReaderåœ¨å…¶çº¿ç¨‹å¾ªç¯ä¸­ä¸æ–­åœ°ä»EventHubä¸­æŠ½å–åŸå§‹è¾“å…¥äº‹ä»¶ï¼Œè¿›è¡ŒåŠ å·¥å¤„ç†åå°†åŠ å·¥æ‰€å¾—çš„äº‹ä»¶æ”¾å…¥InputDispatcherçš„æ´¾å‘å‘é˜Ÿåˆ—ä¸­ã€‚InputDispatcheråˆ™åœ¨å…¶çº¿ç¨‹å¾ªç¯ä¸­å°†æ´¾å‘é˜Ÿåˆ—ä¸­çš„äº‹ä»¶å–å‡ºï¼ŒæŸ¥æ‰¾åˆé€‚çš„çª—å£ï¼Œå°†äº‹ä»¶å†™å…¥åˆ°çª—å£çš„äº‹ä»¶æ¥æ”¶ç®¡é“ä¸­ã€‚çª—å£äº‹ä»¶æ¥æ”¶çº¿ç¨‹çš„Looperä»ç®¡é“ä¸­å°†äº‹ä»¶å–å‡ºï¼Œäº¤ç”±äº‹ä»¶å¤„ç†å‡½æ•°è¿›è¡Œäº‹ä»¶å“åº”ã€‚æ•´ä¸ªè¿‡ç¨‹å…±æœ‰ä¸‰ä¸ªçº¿ç¨‹é¦–å°¾ç›¸æ¥ï¼Œåƒä¸‰å°æ°´æ³µä¼¼çš„ä¸€å±‚å±‚åœ°å°†äº‹ä»¶äº¤ä»˜ç»™äº‹ä»¶å¤„ç†å‡½æ•°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N14-Android-Input-System-input-event-pop.png" alt="Markdown"></p><p>InputManagerService.start()å‡½æ•°çš„ä½œç”¨ï¼Œå°±åƒä¸ºReaderçº¿ç¨‹ã€Dispatcherçº¿ç¨‹è¿™ä¸¤å°æ°´æ³µæŒ‰ä¸‹å¼€å…³ï¼Œè€ŒLooperè¿™å°æ°´æ³µåœ¨çª—å£åˆ›å»ºæ—¶ä¾¿å·²ç»å¤„äºè¿è¡ŒçŠ¶æ€äº†ã€‚è‡ªæ­¤ï¼Œè¾“å…¥ç³»ç»ŸåŠ¨åŠ›åè¶³åœ°å¼€å§‹è¿è½¬ï¼Œè®¾å¤‡èŠ‚ç‚¹ä¸­çš„è¾“å…¥äº‹ä»¶å°†è¢«æºæºä¸æ–­åœ°æŠ½å–ç»™äº‹ä»¶å¤„ç†è€…ã€‚</p><hr><h1 id="å››ã€æ·±å…¥ç†è§£EventHub"><a href="#å››ã€æ·±å…¥ç†è§£EventHub" class="headerlink" title="å››ã€æ·±å…¥ç†è§£EventHub"></a>å››ã€æ·±å…¥ç†è§£EventHub</h1><p>InputReaderThreadç»§æ‰¿è‡ªC++çš„Threadç±»ï¼ŒThreadç±»å°è£…äº†pthreadçº¿ç¨‹å·¥å…·ï¼Œæä¾›äº†ä¸Javaå±‚Threadç±»ç›¸ä¼¼çš„APIã€‚C++çš„Threadç±»æä¾›äº†ä¸€ä¸ªåä¸ºthreadLoop()çš„çº¯è™šå‡½æ•°ï¼Œå½“çº¿ç¨‹å¼€å§‹è¿è¡Œåï¼Œå°†ä¼šåœ¨å†…å»ºçš„çº¿ç¨‹å¾ªç¯ä¸­ä¸æ–­åœ°è°ƒç”¨threadLoop()ï¼Œç›´åˆ°æ­¤å‡½æ•°è¿”å›falseï¼Œåˆ™é€€å‡ºçº¿ç¨‹å¾ªç¯ï¼Œä»è€Œç»“æŸçº¿ç¨‹ã€‚ InputReaderThreadå¯åŠ¨åï¼Œå…¶çº¿ç¨‹å¾ªç¯å°†ä¸æ–­åœ°æ‰§è¡ŒInputReader.loopOnce()å‡½æ•°ã€‚å› æ­¤è¿™ä¸ªloopOnce()å‡½æ•°ä½œä¸ºçº¿ç¨‹å¾ªç¯çš„å¾ªç¯ä½“åŒ…å«äº†InputReaderçš„æ‰€æœ‰å·¥ä½œã€‚å‰é¢ä¸€å°èŠ‚ Step5. InputReaderThread.loopOnce() å·²ç»è¯´åˆ°InputReaderThreadä¸€æ¬¡çº¿ç¨‹å¾ªç¯ã€‚æ¥ä¸‹æ¥è¯¦ç»†è¯´æ˜EventHubã€‚</p><p>Â· é¦–å…ˆä»EventHubä¸­æŠ½å–æœªå¤„ç†çš„äº‹ä»¶åˆ—è¡¨ã€‚è¿™äº›äº‹ä»¶åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ä»è®¾å¤‡èŠ‚ç‚¹ä¸­è¯»å–çš„åŸå§‹è¾“å…¥äº‹ä»¶ï¼Œå¦ä¸€ç±»åˆ™æ˜¯è¾“å…¥è®¾å¤‡å¯ç”¨æ€§å˜åŒ–äº‹ä»¶ï¼Œç®€ç§°ä¸ºè®¾å¤‡äº‹ä»¶ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> [-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"> <span class="keyword">void</span> InputReader::loopOnce() &#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* â‘  é€šè¿‡EventHubæŠ½å–äº‹ä»¶åˆ—è¡¨ã€‚è¯»å–çš„ç»“æœå­˜å‚¨åœ¨å‚æ•°mEventBufferä¸­ï¼Œè¿”å›å€¼è¡¨ç¤ºäº‹ä»¶çš„ä¸ªæ•°</span></span><br><span class="line"><span class="comment">   å½“EventHubä¸­æ— äº‹ä»¶å¯ä»¥æŠ½å–æ—¶ï¼Œæ­¤å‡½æ•°çš„è°ƒç”¨å°†ä¼šé˜»å¡ç›´åˆ°äº‹ä»¶åˆ°æ¥æˆ–è€…è¶…æ—¶ */</span></span><br><span class="line">size_tcount = mEventHub-&gt;getEvents(timeoutMillis,mEventBuffer, EVENT_BUFFER_SIZE);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè´´ä¸€å¼ EventHub-&gt;getEvents()å·¥ä½œæ—¶åºå›¾ï¼Œè·Ÿç€æ—¶åºå›¾ä¸€æ­¥æ­¥ä»‹ç»ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N15-Android-Input-System-input-reader-thread.png" alt="Markdown"></p><h2 id="ï¼ˆ1ï¼‰ã€æ·±å…¥ç†è§£EventHub"><a href="#ï¼ˆ1ï¼‰ã€æ·±å…¥ç†è§£EventHub" class="headerlink" title="ï¼ˆ1ï¼‰ã€æ·±å…¥ç†è§£EventHub"></a>ï¼ˆ1ï¼‰ã€æ·±å…¥ç†è§£EventHub</h2><h3 id="1ã€è®¾å¤‡èŠ‚ç‚¹ç›‘å¬çš„å»ºç«‹"><a href="#1ã€è®¾å¤‡èŠ‚ç‚¹ç›‘å¬çš„å»ºç«‹" class="headerlink" title="1ã€è®¾å¤‡èŠ‚ç‚¹ç›‘å¬çš„å»ºç«‹"></a>1ã€è®¾å¤‡èŠ‚ç‚¹ç›‘å¬çš„å»ºç«‹</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">frameworks/native/services/inputflinger/EventHub.cpp</span><br><span class="line">EventHub::EventHub(<span class="keyword">void</span>) :</span><br><span class="line">    mBuiltInKeyboardId(NO_BUILT_IN_KEYBOARD), mNextDeviceId(<span class="number">1</span>), mControllerNumbers(),</span><br><span class="line">    mOpeningDevices(<span class="number">0</span>), mClosingDevices(<span class="number">0</span>),</span><br><span class="line">    mNeedToSendFinishedDeviceScan(<span class="literal">false</span>),</span><br><span class="line">    mNeedToReopenDevices(<span class="literal">false</span>), mNeedToScanDevices(<span class="literal">true</span>),</span><br><span class="line">    mPendingEventCount(<span class="number">0</span>), mPendingEventIndex(<span class="number">0</span>), mPendingINotify(<span class="literal">false</span>) &#123;</span><br><span class="line">acquire_wake_lock(PARTIAL_WAKE_LOCK, WAKE_LOCK_ID);</span><br><span class="line"></span><br><span class="line"><span class="comment">// â‘  é¦–å…ˆä½¿ç”¨epoll_create()å‡½æ•°åˆ›å»ºä¸€ä¸ªepollå¯¹è±¡ã€‚EPOLL_SIZE_HINTæŒ‡å®šæœ€å¤§ç›‘å¬ä¸ªæ•°ä¸º8</span></span><br><span class="line"><span class="comment">//è¿™ä¸ªepollå¯¹è±¡å°†ç”¨æ¥ç›‘å¬è®¾å¤‡èŠ‚ç‚¹æ˜¯å¦æœ‰æ•°æ®å¯è¯»ï¼ˆæœ‰æ— äº‹ä»¶ï¼‰</span></span><br><span class="line">mEpollFd = epoll_create(EPOLL_SIZE_HINT);</span><br><span class="line">LOG_ALWAYS_FATAL_IF(mEpollFd &lt; <span class="number">0</span>, <span class="string">"Could not create epoll instance.  errno=%d"</span>, errno);</span><br><span class="line"></span><br><span class="line"><span class="comment">// â‘¡ åˆ›å»ºä¸€ä¸ªinotifyå¯¹è±¡ã€‚è¿™ä¸ªinotifyå¯¹è±¡å°†è¢«ç”¨æ¥ç›‘å¬è®¾å¤‡èŠ‚ç‚¹çš„å¢åˆ äº‹ä»¶</span></span><br><span class="line">mINotifyFd = inotify_init();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//å°†å­˜å‚¨è®¾å¤‡èŠ‚ç‚¹çš„è·¯å¾„/dev/inputä½œä¸ºç›‘å¬å¯¹è±¡æ·»åŠ åˆ°inotifyå¯¹è±¡ä¸­ã€‚å½“æ­¤æ–‡ä»¶å¤¹ä¸‹çš„è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line"> <span class="comment">//å‘ç”Ÿåˆ›å»ºä¸åˆ é™¤äº‹ä»¶æ—¶ï¼Œéƒ½å¯ä»¥é€šè¿‡mINotifyFdè¯»å–äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"> <span class="comment">//static const char *DEVICE_PATH = "/dev/input";</span></span><br><span class="line"><span class="keyword">int</span> result = inotify_add_watch(mINotifyFd, DEVICE_PATH, IN_DELETE | IN_CREATE);</span><br><span class="line">LOG_ALWAYS_FATAL_IF(result &lt; <span class="number">0</span>, <span class="string">"Could not register INotify for %s.  errno=%d"</span>,</span><br><span class="line">        DEVICE_PATH, errno);</span><br><span class="line"></span><br><span class="line"><span class="comment">//â‘¢ æ¥ä¸‹æ¥å°†mINotifyFdä½œä¸ºepollçš„ä¸€ä¸ªç›‘æ§å¯¹è±¡ã€‚å½“inotifyäº‹ä»¶åˆ°æ¥æ—¶ï¼Œepoll_wait()å°†</span></span><br><span class="line"><span class="comment">//ç«‹åˆ»è¿”å›ï¼ŒEventHubä¾¿å¯ä»mINotifyFdä¸­è¯»å–è®¾å¤‡èŠ‚ç‚¹çš„å¢åˆ ä¿¡æ¯ï¼Œå¹¶ä½œç›¸åº”å¤„ç†</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">eventItem</span>;</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;eventItem, <span class="number">0</span>, <span class="keyword">sizeof</span>(eventItem));</span><br><span class="line">eventItem.events = EPOLLIN;<span class="comment">// ç›‘å¬mINotifyFdå¯è¯»</span></span><br><span class="line">eventItem.data.u32 = EPOLL_ID_INOTIFY; <span class="comment">// æ³¨æ„è¿™é‡Œå¹¶æ²¡æœ‰ä½¿ç”¨fdå­—æ®µï¼Œè€Œä½¿ç”¨äº†è‡ªå®šä¹‰çš„å€¼EPOLL_ID_INOTIFY</span></span><br><span class="line">result = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mINotifyFd, &amp;eventItem);<span class="comment">// å°†å¯¹mINotifyFdçš„ç›‘å¬æ³¨å†Œåˆ°epollå¯¹è±¡ä¸­</span></span><br><span class="line">LOG_ALWAYS_FATAL_IF(result != <span class="number">0</span>, <span class="string">"Could not add INotify to epoll instance.  errno=%d"</span>, errno);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨æ„é€ å‡½æ•°å‰©ä½™çš„ä»£ç ä¸­ï¼ŒEventHubåˆ›å»ºäº†ä¸€ä¸ªåä¸ºwakeFdsçš„åŒ¿åç®¡é“ï¼Œå¹¶å°†ç®¡é“è¯»å–ç«¯çš„æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">//çš„å¯è¯»äº‹ä»¶æ³¨å†Œåˆ°epollå¯¹è±¡ä¸­ã€‚å› ä¸ºInputReaderåœ¨æ‰§è¡ŒgetEvents()æ—¶ä¼šå› æ— äº‹ä»¶è€Œå¯¼è‡´å…¶çº¿ç¨‹</span></span><br><span class="line"><span class="comment">//é˜»å¡åœ¨epoll_wait()çš„è°ƒç”¨é‡Œï¼Œç„¶è€Œæœ‰æ—¶å¸Œæœ›èƒ½å¤Ÿç«‹åˆ»å”¤é†’InputReaderçº¿ç¨‹ä½¿å…¶å¤„ç†ä¸€äº›è¯·æ±‚ã€‚æ­¤</span></span><br><span class="line"><span class="comment">//æ—¶åªéœ€å‘wakeFdsç®¡é“çš„å†™å…¥ç«¯å†™å…¥ä»»æ„æ•°æ®ï¼Œæ­¤æ—¶è¯»å–ç«¯æœ‰æ•°æ®å¯è¯»ï¼Œä½¿å¾—epoll_wait()å¾—ä»¥è¿”å›</span></span><br><span class="line"><span class="comment">//ä»è€Œè¾¾åˆ°å”¤é†’InputReaderçº¿ç¨‹çš„ç›®çš„</span></span><br><span class="line"><span class="keyword">int</span> wakeFds[<span class="number">2</span>];</span><br><span class="line">result = pipe(wakeFds);</span><br><span class="line">LOG_ALWAYS_FATAL_IF(result != <span class="number">0</span>, <span class="string">"Could not create wake pipe.  errno=%d"</span>, errno);</span><br><span class="line"></span><br><span class="line">mWakeReadPipeFd = wakeFds[<span class="number">0</span>];</span><br><span class="line">mWakeWritePipeFd = wakeFds[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">result = fcntl(mWakeReadPipeFd, F_SETFL, O_NONBLOCK);</span><br><span class="line">LOG_ALWAYS_FATAL_IF(result != <span class="number">0</span>, <span class="string">"Could not make wake read pipe non-blocking.  errno=%d"</span>,</span><br><span class="line">        errno);</span><br><span class="line"></span><br><span class="line">result = fcntl(mWakeWritePipeFd, F_SETFL, O_NONBLOCK);</span><br><span class="line">LOG_ALWAYS_FATAL_IF(result != <span class="number">0</span>, <span class="string">"Could not make wake write pipe non-blocking.  errno=%d"</span>,</span><br><span class="line">        errno);</span><br><span class="line"></span><br><span class="line">eventItem.data.u32 = EPOLL_ID_WAKE;</span><br><span class="line">result = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mWakeReadPipeFd, &amp;eventItem);</span><br><span class="line">LOG_ALWAYS_FATAL_IF(result != <span class="number">0</span>, <span class="string">"Could not add wake read pipe to epoll instance.  errno=%d"</span>,</span><br><span class="line">        errno);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> major, minor;</span><br><span class="line">getLinuxRelease(&amp;major, &amp;minor);</span><br><span class="line"><span class="comment">// EPOLLWAKEUP was introduced in kernel 3.5</span></span><br><span class="line">mUsingEpollWakeup = major &gt; <span class="number">3</span> || (major == <span class="number">3</span> &amp;&amp; minor &gt;= <span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EventHubçš„æ„é€ å‡½æ•°åˆè¯†åŒ–äº†Epollå¯¹è±¡å’ŒINotifyå¯¹è±¡ï¼Œåˆ†åˆ«ç›‘å¬åŸå§‹è¾“å…¥äº‹ä»¶ä¸è®¾å¤‡èŠ‚ç‚¹å¢åˆ äº‹ä»¶ã€‚åŒæ—¶å°†INotifyå¯¹è±¡çš„å¯è¯»æ€§äº‹ä»¶ä¹Ÿæ³¨å†Œåˆ°Epollä¸­ï¼Œå› æ­¤EventHubå¯ä»¥åƒå¤„ç†åŸå§‹è¾“å…¥äº‹ä»¶ä¸€æ ·ç›‘å¬è®¾å¤‡èŠ‚ç‚¹å¢åˆ äº‹ä»¶äº†ã€‚</p><p>æ„é€ å‡½æ•°åŒæ—¶ä¹Ÿæ­ç¤ºäº†EventHubçš„ç›‘å¬å·¥ä½œåˆ†ä¸ºè®¾å¤‡èŠ‚ç‚¹å’ŒåŸå§‹è¾“å…¥äº‹ä»¶ä¸¤ä¸ªæ–¹é¢ï¼Œæ¥ä¸‹æ¥å°†æ·±å…¥æ¢è®¨è¿™ä¸¤æ–¹é¢çš„å†…å®¹ã€‚</p><h3 id="2ã€getEvents-å‡½æ•°çš„å·¥ä½œæ–¹å¼"><a href="#2ã€getEvents-å‡½æ•°çš„å·¥ä½œæ–¹å¼" class="headerlink" title="2ã€getEvents()å‡½æ•°çš„å·¥ä½œæ–¹å¼"></a>2ã€getEvents()å‡½æ•°çš„å·¥ä½œæ–¹å¼</h3><p>æ­£å¦‚å‰æ–‡æ‰€è¿°ï¼ŒInputReaderThreadçš„çº¿ç¨‹å¾ªç¯ä¸ºReaderå­ç³»ç»Ÿæä¾›äº†è¿è½¬çš„åŠ¨åŠ›ï¼ŒEventHubçš„å·¥ä½œä¹Ÿæ˜¯ç”±å®ƒé©±åŠ¨çš„ã€‚InputReader::loopOnce()å‡½æ•°è°ƒç”¨EventHub::getEvents()å‡½æ•°è·å–äº‹ä»¶åˆ—è¡¨ï¼Œæ‰€ä»¥è¿™ä¸ªgetEvents()æ˜¯EventHubè¿è¡Œçš„åŠ¨åŠ›æ‰€åœ¨ï¼Œå‡ ä¹åŒ…å«äº†EventHubçš„æ‰€æœ‰å·¥ä½œå†…å®¹ï¼Œå› æ­¤é¦–å…ˆè¦å°†getEvents()å‡½æ•°çš„å·¥ä½œæ–¹å¼ææ¸…æ¥šã€‚ getEvents()å‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> EventHub::getEvents(<span class="keyword">int</span> timeoutMillis,RawEvent* buffer, <span class="keyword">size_t</span> bufferSize)</span><br></pre></td></tr></table></figure><p>æ­¤å‡½æ•°å°†å°½å¯èƒ½å¤šåœ°è¯»å–è®¾å¤‡å¢åˆ äº‹ä»¶ä¸åŸå§‹è¾“å…¥äº‹ä»¶ï¼Œå°†å®ƒä»¬å°è£…ä¸ºRawEventç»“æ„ä½“ï¼Œå¹¶æ”¾å…¥bufferä¸­ä¾›InputReaderè¿›è¡Œå¤„ç†ã€‚RawEventç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š [EventHub.hâ€“&gt;RawEvent]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RawEvent</span> &#123;</span></span><br><span class="line">    <span class="keyword">nsecs_t</span> when;             <span class="comment">/* å‘ç”Ÿäº‹ä»¶æ—¶çš„æ—¶é—´æˆ³ */</span></span><br><span class="line">    <span class="keyword">int32_t</span> deviceId;        <span class="comment">//äº§ç”Ÿäº‹ä»¶çš„è®¾å¤‡Idï¼Œå®ƒæ˜¯ç”±EventHubè‡ªè¡Œåˆ†é…çš„ï¼ŒInputReader</span></span><br><span class="line">                            <span class="comment">//ä»¥æ ¹æ®å®ƒä»EventHubä¸­è·å–æ­¤è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">int32_t</span> type;             <span class="comment">/* äº‹ä»¶çš„ç±»å‹ */</span></span><br><span class="line">    <span class="keyword">int32_t</span> code;             <span class="comment">/* äº‹ä»¶ä»£ç  */</span></span><br><span class="line">    <span class="keyword">int32_t</span> value;            <span class="comment">/* äº‹ä»¶å€¼ */</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼ŒRawEventç»“æ„ä½“ä¸geteventå·¥å…·çš„è¾“å‡ºååˆ†ä¸€è‡´ï¼ŒåŒ…å«äº†åŸå§‹è¾“å…¥äº‹ä»¶çš„å››ä¸ªåŸºæœ¬å…ƒç´ ï¼Œå› æ­¤ç”¨RawEventç»“æ„ä½“è¡¨ç¤ºåŸå§‹è¾“å…¥äº‹ä»¶æ˜¯éå¸¸ç›´è§‚çš„ã€‚RawEventåŒæ—¶ä¹Ÿç”¨æ¥è¡¨ç¤ºè®¾å¤‡å¢åˆ äº‹ä»¶ï¼Œä¸ºæ­¤ï¼ŒEventHubå®šä¹‰äº†ä¸‰ä¸ªç‰¹æ®Šçš„äº‹ä»¶ç±»å‹DEVICE_ADDã€DEVICE_REMOVEDä»¥åŠFINISHED_DEVICE_SCANï¼Œç”¨ä»¥ä¸åŸå§‹è¾“å…¥äº‹ä»¶è¿›è¡ŒåŒºåˆ«ã€‚</p><p>ç”±äºgetEvents()å‡½æ•°è¾ƒä¸ºå¤æ‚ï¼Œä¸ºäº†ç»™åç»­åˆ†æé“ºå¹³é“è·¯ï¼Œæœ¬èŠ‚ä¸è®¨è®ºå…¶ç»†èŠ‚ï¼Œå…ˆé€šè¿‡ä¼ªä»£ç ç†è§£æ­¤å‡½æ•°çš„ç»“æ„ä¸å·¥ä½œæ–¹å¼ï¼Œåœ¨åç»­æ·±å…¥åˆ†ææ—¶æ€è·¯æ‰ä¼šæ¯”è¾ƒæ¸…æ™°ã€‚</p><p><strong>getEvents()å‡½æ•°çš„æœ¬è´¨å°±æ˜¯è¯»å–å¹¶å¤„ç†Epolläº‹ä»¶ä¸INotifyäº‹ä»¶</strong></p><p>å‚è€ƒä»¥ä¸‹ä»£ç ï¼š</p><p>[EventHub.cppâ€“&gt;EventHub::getEvents()]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> EventHub::getEvents(<span class="keyword">int</span> timeoutMillis,RawEvent* buffer, <span class="keyword">size_t</span> bufferSize) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// eventæŒ‡é’ˆæŒ‡å‘äº†åœ¨bufferä¸‹ä¸€ä¸ªå¯ç”¨äºå­˜å‚¨äº‹ä»¶çš„RawEventç»“æ„ä½“ã€‚æ¯å­˜å‚¨ä¸€ä¸ªäº‹ä»¶ï¼Œ</span></span><br><span class="line"><span class="comment">// eventæŒ‡é’ˆéƒ½å›å‘ååç§»ä¸€ä¸ªå…ƒç´  */</span></span><br><span class="line">RawEvent* event = buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// capacityè®°å½•äº†bufferä¸­å‰©ä½™çš„å…ƒç´ æ•°é‡ã€‚å½“capacityä¸º0æ—¶ï¼Œè¡¨ç¤ºbufferå·²æ»¡ï¼Œæ­¤æ—¶éœ€è¦åœ</span></span><br><span class="line"><span class="comment">// ç»§ç»­å¤„ç†æ–°äº‹ä»¶ï¼Œå¹¶å°†å·²å¤„ç†çš„äº‹ä»¶è¿”å›ç»™è°ƒç”¨è€…</span></span><br><span class="line">size_tcapacity = bufferSize;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥ä¸‹æ¥çš„å¾ªç¯æ˜¯getEvents()å‡½æ•°çš„ä¸»ä½“ã€‚åœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼Œä¼šå…ˆå°†å¯ç”¨äº‹ä»¶æ”¾å…¥åˆ°bufferä¸­å¹¶è¿”å›ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰å¯ç”¨äº‹ä»¶ï¼Œåˆ™è¿›å…¥epoll_wait()ç­‰å¾…äº‹ä»¶çš„åˆ°æ¥ï¼Œepoll_wait()è¿”å›åä¼šé‡æ–°å¾ªç¯å°†å¯ç”¨</span></span><br><span class="line"><span class="comment">// å°†æ–°äº‹ä»¶æ”¾å…¥buffer</span></span><br><span class="line"><span class="keyword">for</span> (;;)&#123;</span><br><span class="line">   <span class="keyword">nsecs_t</span> now = systemTime(SYSTEM_TIME_MONOTONIC);</span><br><span class="line">    <span class="comment">/* â‘  é¦–å…ˆè¿›è¡Œä¸è®¾å¤‡ç›¸å…³çš„å·¥ä½œã€‚æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚EventHubåˆ›å»ºåç¬¬ä¸€æ¬¡æ‰§è¡ŒgetEvents()å‡½æ•°  */</span></span><br><span class="line">    <span class="comment">/* æ—¶ï¼Œéœ€è¦æ‰«æ/dev/inputæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰è®¾å¤‡èŠ‚ç‚¹å¹¶å°†è¿™äº›è®¾å¤‡æ‰“å¼€ã€‚å¦å¤–ï¼Œå½“è®¾å¤‡èŠ‚ç‚¹çš„å‘ç”Ÿå¢  */</span></span><br><span class="line">    <span class="comment">/*  åŠ¨ä½œç”Ÿæ—¶ï¼Œä¼šå°†è®¾å¤‡äº‹ä»¶å­˜å…¥åˆ°bufferä¸­ */</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* â‘¡ å¤„ç†æœªè¢«InputReaderå–èµ°çš„è¾“å…¥äº‹ä»¶ä¸è®¾å¤‡äº‹ä»¶ã€‚epoll_wait()æ‰€å–å‡ºçš„epoll_event */</span></span><br><span class="line">    <span class="comment">/* å­˜å‚¨åœ¨mPendingEventItemsä¸­ï¼ŒmPendingEventCountæŒ‡å®šäº†mPendingEventItemsæ•°ç»„ */</span></span><br><span class="line">    <span class="comment">/* æ‰€å­˜å‚¨çš„äº‹ä»¶ä¸ªæ•°ã€‚è€ŒmPendingEventIndexæŒ‡å®šå°šæœªå¤„ç†çš„epoll_eventçš„ç´¢å¼• */</span></span><br><span class="line">   <span class="keyword">while</span> (mPendingEventIndex &lt; mPendingEventCount) &#123;</span><br><span class="line">       <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>&amp; <span class="title">eventItem</span> =</span></span><br><span class="line"><span class="class">                             <span class="title">mPendingEventItems</span>[<span class="title">mPendingEventIndex</span>++];</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">/* åœ¨è¿™é‡Œåˆ†ææ¯ä¸€ä¸ªepoll_eventï¼Œå¦‚æœæ˜¯è¡¨ç¤ºè®¾å¤‡èŠ‚ç‚¹å¯è¯»ï¼Œåˆ™è¯»å–åŸå§‹äº‹ä»¶å¹¶æ”¾ç½®åˆ°buffer */</span></span><br><span class="line">       <span class="comment">/* ä¸­ã€‚å¦‚æœæ˜¯è¡¨ç¤ºmINotifyFdå¯è¯»ï¼Œåˆ™è®¾ç½®mPendingINotifyä¸ºtrueï¼Œå½“InputReader */</span></span><br><span class="line">       <span class="comment">/* å°†ç°æœ‰çš„è¾“å…¥äº‹ä»¶éƒ½å–å‡ºåè¯»å–mINotifyFdä¸­çš„äº‹ä»¶ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„è®¾å¤‡åŠ è½½ä¸å¸è½½æ“ä½œã€‚ */</span></span><br><span class="line">       <span class="comment">/* å¦å¤–ï¼Œå¦‚æœæ­¤epoll_eventè¡¨ç¤ºwakeFdsçš„è¯»å–ç«¯æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™è®¾ç½®awakeæ ‡å¿—ä¸ºtrueï¼Œ */</span></span><br><span class="line">       <span class="comment">/* æ— è®ºæ­¤æ¬¡getEvents()è°ƒç”¨æœ‰æ— å–åˆ°äº‹ä»¶ï¼Œéƒ½ä¸ä¼šå†æ¬¡è¿›è¡Œepoll_wait()è¿›è¡Œäº‹ä»¶ç­‰å¾… */</span></span><br><span class="line">       ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘¢ å¦‚æœmINotifyFdæœ‰æ•°æ®å¯è¯»ï¼Œè¯´æ˜è®¾å¤‡èŠ‚ç‚¹å‘ç”Ÿäº†å¢åˆ æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span>(mPendingINotify &amp;&amp; mPendingEventIndex &gt;= mPendingEventCount) &#123;</span><br><span class="line">       <span class="comment">/* è¯»å–mINotifyFdä¸­çš„äº‹ä»¶ï¼ŒåŒæ—¶å¯¹è¾“å…¥è®¾å¤‡è¿›è¡Œç›¸åº”çš„åŠ è½½ä¸å¸è½½æ“ä½œã€‚è¿™ä¸ªæ“ä½œå¿…é¡»å½“ */</span></span><br><span class="line">       <span class="comment">/* InputReaderå°†ç°æœ‰è¾“å…¥äº‹ä»¶è¯»å–å¹¶å¤„ç†å®Œæ¯•åæ‰èƒ½è¿›è¡Œï¼Œå› ä¸ºç°æœ‰çš„è¾“å…¥äº‹ä»¶å¯èƒ½æ¥è‡ªéœ€è¦ */</span></span><br><span class="line">       <span class="comment">/* è¢«å¸è½½çš„è¾“å…¥è®¾å¤‡ï¼ŒInputReaderå¤„ç†è¿™äº›äº‹ä»¶ä¾èµ–äºå¯¹åº”çš„è®¾å¤‡ä¿¡æ¯ */</span></span><br><span class="line">        ......</span><br><span class="line">        deviceChanged= <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾å¤‡èŠ‚ç‚¹å¢åˆ æ“ä½œå‘ç”Ÿæ—¶ï¼Œåˆ™é‡æ–°æ‰§è¡Œå¾ªç¯ä½“ï¼Œä»¥ä¾¿å°†è®¾å¤‡å˜åŒ–çš„äº‹ä»¶æ”¾å…¥bufferä¸­</span></span><br><span class="line">    <span class="keyword">if</span>(deviceChanged) &#123;</span><br><span class="line">       <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ­¤æ¬¡getEvents()è°ƒç”¨æˆåŠŸè·å–äº†ä¸€äº›äº‹ä»¶ï¼Œæˆ–è€…è¦æ±‚å”¤é†’InputReaderï¼Œåˆ™é€€å‡ºå¾ªç¯å¹¶</span></span><br><span class="line">    <span class="comment">// ç»“æŸgetEvents()çš„è°ƒç”¨ï¼Œä½¿InputReaderå¯ä»¥ç«‹åˆ»å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span>(event != buffer || awoken) &#123;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* â‘£ å¦‚æœæ­¤æ¬¡getEvents()è°ƒç”¨æ²¡èƒ½è·å–äº‹ä»¶ï¼Œè¯´æ˜mPendingEventItemsä¸­æ²¡æœ‰äº‹ä»¶å¯ç”¨ï¼Œ */</span></span><br><span class="line">    <span class="comment">/* äºæ˜¯æ‰§è¡Œepoll_wait()å‡½æ•°ç­‰å¾…æ–°çš„äº‹ä»¶åˆ°æ¥ï¼Œå°†ç»“æœå­˜å‚¨åˆ°mPendingEventItemsé‡Œï¼Œå¹¶é‡ */</span></span><br><span class="line">    <span class="comment">/* ç½®mPendingEventIndexä¸º0 */</span></span><br><span class="line">   mPendingEventIndex = <span class="number">0</span>;</span><br><span class="line">   ......</span><br><span class="line">   intpollResult = epoll_wait(mEpollFd, mPendingEventItems, EPOLL_MAX_EVENTS,timeoutMillis);</span><br><span class="line">   ......</span><br><span class="line">    mPendingEventCount= <span class="keyword">size_t</span>(pollResult);</span><br><span class="line">    <span class="comment">// ä»epoll_wait()ä¸­å¾—åˆ°æ–°çš„äº‹ä»¶åï¼Œé‡æ–°å¾ªç¯ï¼Œå¯¹æ–°äº‹ä»¶è¿›è¡Œå¤„ç†</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿”å›æœ¬æ¬¡getEvents()è°ƒç”¨æ‰€è¯»å–çš„äº‹ä»¶æ•°é‡</span></span><br><span class="line">returnevent - buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>getEvents()å‡½æ•°ä½¿ç”¨Epollçš„æ ¸å¿ƒæ˜¯mPendingEventItemsæ•°ç»„ï¼Œå®ƒæ˜¯ä¸€ä¸ªäº‹ä»¶æ± ã€‚getEvents()å‡½æ•°ä¼šä¼˜å…ˆä»è¿™ä¸ªäº‹ä»¶æ± è·å–epolläº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†è¯»å–ç›¸åº”çš„åŸå§‹è¾“å…¥äº‹ä»¶è¿”å›ç»™è°ƒç”¨è€…ã€‚å½“å› ä¸ºäº‹ä»¶æ± æ¯ç«­è€Œå¯¼è‡´è°ƒç”¨è€…æ— æ³•è·å¾—ä»»ä½•äº‹ä»¶æ—¶ï¼Œä¼šè°ƒç”¨epoll_wait()å‡½æ•°ç­‰å¾…æ–°äº‹ä»¶çš„åˆ°æ¥ï¼Œå°†äº‹ä»¶æ± é‡æ–°æ³¨æ»¡ï¼Œç„¶åå†é‡æ–°å¤„ç†äº‹ä»¶æ± ä¸­çš„Epolläº‹ä»¶ã€‚ä»è¿™ä¸ªæ„ä¹‰æ¥è¯´ï¼ŒgetEvents()å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå°±æ˜¯æ¶ˆè´¹epoll_wait()æ‰€äº§ç”Ÿçš„Epolläº‹ä»¶çš„è¿‡ç¨‹ã€‚å› æ­¤å¯ä»¥å°†ä»epoll_wait()çš„è°ƒç”¨å¼€å§‹ï¼Œåˆ°å°†Epolläº‹ä»¶æ¶ˆè´¹å®Œæ¯•çš„è¿‡ç¨‹ç§°ä¸ºEventHubçš„ä¸€ä¸ªç›‘å¬å‘¨æœŸã€‚ä¾æ®æ¯æ¬¡epoll_wait()äº§ç”Ÿçš„Epolläº‹ä»¶çš„æ•°é‡ä»¥åŠè®¾å¤‡èŠ‚ç‚¹ä¸­åŸå§‹è¾“å…¥äº‹ä»¶çš„æ•°é‡ï¼Œä¸€ä¸ªç›‘å¬å‘¨æœŸåŒ…å«ä¸€æ¬¡æˆ–å¤šæ¬¡getEvents()è°ƒç”¨ã€‚å‘¨æœŸä¸­çš„ç¬¬ä¸€æ¬¡è°ƒç”¨ä¼šå› ä¸ºäº‹ä»¶æ± æ¯ç«­è€Œç›´æ¥è¿›å…¥epoll_wait()ï¼Œè€Œå‘¨æœŸä¸­çš„æœ€åä¸€æ¬¡è°ƒç”¨ä¸€å®šä¼šå°†æœ€åçš„äº‹ä»¶å–èµ°ã€‚</p><p>æ³¨æ„getEvents()é‡‡ç”¨äº‹ä»¶æ± æœºåˆ¶çš„æ ¹æœ¬åŸå› æ˜¯bufferçš„å®¹é‡é™åˆ¶ã€‚ç”±äºä¸€æ¬¡epoll_wait()å¯èƒ½è¿”å›å¤šä¸ªè®¾å¤‡èŠ‚ç‚¹çš„å¯è¯»äº‹ä»¶ï¼Œæ¯ä¸ªè®¾å¤‡èŠ‚ç‚¹åˆæœ‰å¯èƒ½è¯»å–å¤šæ¡åŸå§‹è¾“å…¥äº‹ä»¶ï¼Œä¸€æ®µæ—¶é—´å†…åŸå§‹è¾“å…¥äº‹ä»¶çš„æ•°é‡å¯èƒ½å¤§äºbufferçš„å®¹é‡ã€‚å› æ­¤éœ€è¦ä¸€ä¸ªäº‹ä»¶æ± ä»¥ç¼“å­˜å› bufferå®¹é‡ä¸å¤Ÿè€Œæ— æ³•å¤„ç†çš„epolläº‹ä»¶ï¼Œä»¥ä¾¿åœ¨ä¸‹æ¬¡è°ƒç”¨æ—¶å¯ä»¥å°†è¿™äº›äº‹ä»¶ä¼˜å…ˆå¤„ç†ã€‚è¿™æ˜¯ç¼“å†²åŒºæ“ä½œçš„ä¸€ä¸ªå¸¸ç”¨æŠ€å·§ã€‚</p><p>å½“æœ‰INotifyäº‹ä»¶å¯ä»¥ä»mINotifyFdä¸­è¯»å–æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªepolläº‹ä»¶ï¼ŒEventHubä¾¿å¾—çŸ¥è®¾å¤‡èŠ‚ç‚¹å‘ç”Ÿäº†å¢åˆ æ“ä½œã€‚åœ¨getEvents()å°†äº‹ä»¶æ± ä¸­çš„æ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæ¯•åï¼Œä¾¿ä¼šä»mINotifyFdä¸­è¯»å–INotifyäº‹ä»¶ï¼Œè¿›è¡Œè¾“å…¥è®¾å¤‡çš„åŠ è½½/å¸è½½æ“ä½œï¼Œç„¶åç”Ÿæˆå¯¹åº”çš„RawEventç»“æ„ä½“å¹¶è¿”å›ç»™è°ƒç”¨è€…ã€‚</p><p>é€šè¿‡ä¸Šè¿°åˆ†æå¯ä»¥çœ‹åˆ°ï¼ŒgetEvents()åŒ…å«äº†åŸå§‹è¾“å…¥äº‹ä»¶è¯»å–ã€è¾“å…¥è®¾å¤‡åŠ è½½/å¸è½½ç­‰æ“ä½œã€‚è¿™å‡ ä¹æ˜¯EventHubçš„å…¨éƒ¨å·¥ä½œäº†ã€‚å¦‚æœæ²¡æœ‰geEvents()çš„è°ƒç”¨ï¼ŒEventHubå°†å¯¹è¾“å…¥äº‹ä»¶ã€è®¾å¤‡èŠ‚ç‚¹å¢åˆ äº‹ä»¶ç½®è‹¥ç½”é—»ï¼Œå› æ­¤å¯ä»¥å°†ä¸€æ¬¡getEvents()è°ƒç”¨ç†è§£ä¸ºä¸€æ¬¡å¿ƒè·³ï¼ŒEventHubçš„æ ¸å¿ƒåŠŸèƒ½éƒ½ä¼šåœ¨è¿™æ¬¡å¿ƒè·³ä¸­å®Œæˆã€‚</p><p>getEvents()çš„ä»£ç è¿˜æ­ç¤ºäº†å¦å¤–ä¸€ä¸ªä¿¡æ¯ï¼šåœ¨ä¸€ä¸ªç›‘å¬å‘¨æœŸå†…çš„è®¾å¤‡å¢åˆ äº‹ä»¶ä¸Epolläº‹ä»¶çš„ä¼˜å…ˆçº§ã€‚è®¾å¤‡äº‹ä»¶çš„ç”Ÿæˆé€»è¾‘ä½äºEpolläº‹ä»¶çš„å¤„ç†ä¹‹å‰ï¼Œå› æ­¤getEvents()å°†ä¼˜å…ˆç”Ÿæˆè®¾å¤‡å¢åˆ äº‹ä»¶ï¼Œå®Œæˆæ‰€æœ‰è®¾å¤‡å¢åˆ äº‹ä»¶çš„ç”Ÿæˆä¹‹å‰ä¸ä¼šå¤„ç†Epolläº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šç”ŸæˆåŸå§‹è¾“å…¥äº‹ä»¶ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»è®¾å¤‡ç®¡ç†ä¸åŸå§‹è¾“å…¥äº‹ä»¶å¤„ç†ä¸¤ä¸ªæ–¹é¢æ·±å…¥æ¢è®¨EventHubã€‚</p><h3 id="3ã€è¾“å…¥è®¾å¤‡ç®¡ç†"><a href="#3ã€è¾“å…¥è®¾å¤‡ç®¡ç†" class="headerlink" title="3ã€è¾“å…¥è®¾å¤‡ç®¡ç†"></a>3ã€è¾“å…¥è®¾å¤‡ç®¡ç†</h3><p>å› ä¸ºè¾“å…¥è®¾å¤‡æ˜¯è¾“å…¥äº‹ä»¶çš„æ¥æºï¼Œå¹¶ä¸”å†³å®šäº†è¾“å…¥äº‹ä»¶çš„å«ä¹‰ï¼Œå› æ­¤é¦–å…ˆè®¨è®ºEventHubçš„è¾“å…¥è®¾å¤‡ç®¡ç†æœºåˆ¶ã€‚</p><p>è¾“å…¥è®¾å¤‡æ˜¯ä¸€ä¸ªå¯ä»¥ä¸ºæ¥æ”¶ç”¨æˆ·æ“ä½œçš„ç¡¬ä»¶ï¼Œå†…æ ¸ä¼šä¸ºæ¯ä¸€ä¸ªè¾“å…¥è®¾å¤‡åœ¨/dev/input/ä¸‹åˆ›å»ºä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹ï¼Œè€Œå½“è¾“å…¥è®¾å¤‡ä¸å¯ç”¨æ—¶ï¼ˆä¾‹å¦‚è¢«æ‹”å‡ºï¼‰ï¼Œå°†å…¶è®¾å¤‡èŠ‚ç‚¹åˆ é™¤ã€‚è¿™ä¸ªè®¾å¤‡èŠ‚ç‚¹åŒ…å«äº†è¾“å…¥è®¾å¤‡çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€å‚å•†ã€è®¾å¤‡ç±»å‹ï¼Œè®¾å¤‡çš„åŠŸèƒ½ç­‰ã€‚é™¤äº†è®¾å¤‡èŠ‚ç‚¹ï¼ŒæŸäº›è¾“å…¥è®¾å¤‡è¿˜åŒ…å«ä¸€äº›è‡ªå®šä¹‰é…ç½®ï¼Œè¿™äº›é…ç½®ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åœ¨æŸä¸ªæ–‡ä»¶ä¸­ã€‚è¿™äº›ä¿¡æ¯å†³å®šäº†Readerå­ç³»ç»Ÿå¦‚ä½•åŠ å·¥åŸå§‹è¾“å…¥äº‹ä»¶ã€‚EventHubè´Ÿè´£åœ¨è®¾å¤‡èŠ‚ç‚¹å¯ç”¨æ—¶åŠ è½½å¹¶ç»´æŠ¤è¿™äº›ä¿¡æ¯ï¼Œå¹¶åœ¨è®¾å¤‡èŠ‚ç‚¹è¢«åˆ é™¤æ—¶å°†å…¶ç§»é™¤ã€‚</p><p>EventHubé€šè¿‡ä¸€ä¸ªå®šä¹‰åœ¨å…¶å†…éƒ¨çš„åä¸ºDeviceçš„ç§æœ‰ç»“æ„ä½“æ¥æè¿°ä¸€ä¸ªè¾“å…¥è®¾å¤‡ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><p>[EventHub.hâ€“&gt;EventHub::Device]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Device</span> &#123;</span></span><br><span class="line">Device* next;  <span class="comment">/* Deviceç»“æ„ä½“å®é™…ä¸Šæ˜¯ä¸€ä¸ªå•é“¾è¡¨ */</span></span><br><span class="line"><span class="keyword">int</span> fd;         <span class="comment">/* fdè¡¨ç¤ºæ­¤è®¾å¤‡çš„è®¾å¤‡èŠ‚ç‚¹çš„æè¿°ç¬¦ï¼Œå¯ä»¥ä»æ­¤æè¿°ç¬¦ä¸­è¯»å–åŸå§‹è¾“å…¥äº‹ä»¶ */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int32_t</span> id;     <span class="comment">/* idåœ¨è¾“å…¥ç³»ç»Ÿä¸­å”¯ä¸€æ ‡è¯†è¿™ä¸ªè®¾å¤‡ï¼Œç”±EventHubåœ¨åŠ è½½è®¾å¤‡æ—¶è¿›è¡Œåˆ†é… */</span></span><br><span class="line"><span class="keyword">const</span> String8 path; <span class="comment">/* pathå­˜å‚¨äº†è®¾å¤‡èŠ‚ç‚¹åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ */</span></span><br><span class="line"><span class="keyword">const</span> InputDeviceIdentifier identifier; <span class="comment">/* å‚å•†ä¿¡æ¯ï¼Œå­˜å‚¨äº†è®¾å¤‡çš„ä¾›åº”å•†ã€å‹å·ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="comment">                                                   è¿™äº›ä¿¡æ¯ä»è®¾å¤‡èŠ‚ç‚¹ä¸­è·å¾— */</span></span><br><span class="line"><span class="keyword">uint32_t</span> classes;  <span class="comment">/* classesè¡¨ç¤ºäº†è®¾å¤‡çš„ç±»åˆ«ï¼Œé”®ç›˜è®¾å¤‡ï¼Œè§¦æ§è®¾å¤‡ç­‰ã€‚ä¸€ä¸ªè®¾å¤‡å¯ä»¥åŒæ—¶å±äº</span></span><br><span class="line"><span class="comment">                          å¤šä¸ªè®¾å¤‡ç±»åˆ«ã€‚ç±»åˆ«å†³å®šäº†InputReaderå¦‚ä½•åŠ å·¥å…¶åŸå§‹è¾“å…¥äº‹ä»¶ */</span></span><br><span class="line"><span class="comment">/* æ¥ä¸‹æ¥æ˜¯ä¸€ç³»åˆ—çš„äº‹ä»¶ä½æ©ç ï¼Œå®ƒä»¬è¯¦ç»†åœ°æè¿°äº†è®¾å¤‡èƒ½å¤Ÿäº§ç”Ÿçš„äº‹ä»¶ç±»å‹ã€‚è®¾å¤‡èƒ½å¤Ÿäº§ç”Ÿçš„äº‹ä»¶ç±»å‹</span></span><br><span class="line"><span class="comment">   å†³å®šäº†æ­¤è®¾å¤‡æ‰€å±çš„ç±»å‹*/</span></span><br><span class="line"><span class="keyword">uint8_t</span> keyBitmask[(KEY_MAX + <span class="number">1</span>) / <span class="number">8</span>];</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* é…ç½®ä¿¡æ¯ã€‚ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå…¶è·¯å¾„å–å†³äºidentfierå­—æ®µä¸­çš„å‚å•†ä¿¡æ¯ï¼Œè¿™äº›</span></span><br><span class="line"><span class="comment">   é…ç½®ä¿¡æ¯å°†ä¼šå½±å“InputReaderå¯¹æ­¤è®¾å¤‡çš„äº‹ä»¶çš„åŠ å·¥è¡Œä¸º */</span></span><br><span class="line">String8 configurationFile;</span><br><span class="line">PropertyMap* configuration;</span><br><span class="line"><span class="comment">/* é”®ç›˜æ˜ å°„è¡¨ã€‚å¯¹äºé”®ç›˜ç±»å‹çš„è®¾å¤‡ï¼Œè¿™äº›é”®ç›˜æ˜ å°„è¡¨å°†åŸå§‹äº‹ä»¶ä¸­çš„é”®ç›˜æ‰«æç è½¬æ¢ä¸ºAndroidå®šä¹‰çš„</span></span><br><span class="line"><span class="comment">  çš„æŒ‰é”®å€¼ã€‚è¿™ä¸ªæ˜ å°„è¡¨ä¹Ÿæ˜¯ä»ä¸€ä¸ªæ–‡ä»¶ä¸­åŠ è½½çš„ï¼Œæ–‡ä»¶è·¯å¾„å–å†³äºdentifierå­—æ®µä¸­çš„å‚å•†ä¿¡æ¯ */</span></span><br><span class="line">   VirtualKeyMap* virtualKeyMap;</span><br><span class="line">KeyMap keyMap;</span><br><span class="line"> sp&lt;KeyCharacterMap&gt; overlayKeyMap;</span><br><span class="line"> sp&lt;KeyCharacterMap&gt; combinedKeyMap;</span><br><span class="line"><span class="comment">// åŠ›åé¦ˆç›¸å…³çš„ä¿¡æ¯ã€‚æœ‰äº›è®¾å¤‡å¦‚é«˜çº§çš„æ¸¸æˆæ‰‹æŸ„æ”¯æŒåŠ›åé¦ˆåŠŸèƒ½ï¼Œç›®å‰æš‚ä¸è€ƒè™‘</span></span><br><span class="line"><span class="keyword">bool</span> ffEffectPlaying;</span><br><span class="line"><span class="keyword">int16_t</span> ffEffectId;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Deviceç»“æ„ä½“æ‰€å­˜å‚¨çš„ä¿¡æ¯ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><p>Â· è®¾å¤‡èŠ‚ç‚¹ä¿¡æ¯ï¼šä¿å­˜äº†è¾“å…¥è®¾å¤‡èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦ã€æ–‡ä»¶è·¯å¾„ç­‰ã€‚</p><p>Â· å‚å•†ä¿¡æ¯ï¼šåŒ…æ‹¬ä¾›åº”å•†ã€è®¾å¤‡å‹å·ã€åç§°ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å†³å®šäº†åŠ è½½é…ç½®æ–‡ä»¶ä¸é”®ç›˜æ˜ å°„è¡¨çš„è·¯å¾„ã€‚</p><p>Â· è®¾å¤‡ç‰¹æ€§ä¿¡æ¯ï¼šåŒ…æ‹¬è®¾å¤‡çš„ç±»åˆ«ï¼Œå¯ä»¥ä¸ŠæŠ¥çš„äº‹ä»¶ç§ç±»ç­‰ã€‚è¿™äº›ç‰¹æ€§ä¿¡æ¯ç›´æ¥å½±å“äº†InputReaderå¯¹å…¶æ‰€äº§ç”Ÿçš„äº‹ä»¶çš„åŠ å·¥å¤„ç†æ–¹å¼ã€‚</p><p>Â· è®¾å¤‡çš„é…ç½®ä¿¡æ¯ï¼šåŒ…æ‹¬é”®ç›˜æ˜ å°„è¡¨åŠå…¶ä»–è‡ªå®šä¹‰çš„ä¿¡æ¯ï¼Œä»ç‰¹å®šä½ç½®çš„é…ç½®æ–‡ä»¶ä¸­è¯»å–ã€‚</p><p>å¦å¤–ï¼ŒDeviceç»“æ„ä½“è¿˜å­˜å‚¨äº†åŠ›åé¦ˆæ‰€éœ€çš„ä¸€äº›æ•°æ®ã€‚åœ¨æœ¬èŠ‚ä¸­æš‚ä¸è®¨è®ºã€‚</p><p>EventHubç”¨ä¸€ä¸ªåä¸ºmDevicesçš„å­—å…¸ä¿å­˜å½“å‰å¤„äºæ‰“å¼€çŠ¶æ€çš„è®¾å¤‡èŠ‚ç‚¹çš„Deviceç»“æ„ä½“ã€‚å­—å…¸çš„é”®ä¸ºè®¾å¤‡Idã€‚</p><h3 id="ï¼ˆ1ï¼‰ã€è¾“å…¥è®¾å¤‡çš„åŠ è½½"><a href="#ï¼ˆ1ï¼‰ã€è¾“å…¥è®¾å¤‡çš„åŠ è½½" class="headerlink" title="ï¼ˆ1ï¼‰ã€è¾“å…¥è®¾å¤‡çš„åŠ è½½"></a>ï¼ˆ1ï¼‰ã€è¾“å…¥è®¾å¤‡çš„åŠ è½½</h3><p>EventHubåœ¨åˆ›å»ºååœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨getEvents()å‡½æ•°æ—¶å®Œæˆå¯¹ç³»ç»Ÿä¸­ç°æœ‰è¾“å…¥è®¾å¤‡çš„åŠ è½½ã€‚</p><p>å†çœ‹ä¸€ä¸‹getEvents()å‡½æ•°ä¸­ç›¸å…³å†…å®¹çš„å®ç°ï¼š</p><p>[EventHub.cppâ€“&gt;EventHub::getEvents()]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> EventHub::getEvents(<span class="keyword">int</span> timeoutMillis,RawEvent* buffer, <span class="keyword">size_t</span> bufferSize) &#123;</span><br><span class="line"><span class="keyword">for</span> (;;)&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†è¾“å…¥è®¾å¤‡å¸è½½æ“ä½œ</span></span><br><span class="line">   ......</span><br><span class="line">    <span class="comment">/* åœ¨EventHubçš„æ„é€ å‡½æ•°ä¸­ï¼ŒmNeedToScanDevicesè¢«è®¾ç½®ä¸ºtrueï¼Œå› æ­¤åˆ›å»ºåç¬¬ä¸€æ¬¡è°ƒç”¨</span></span><br><span class="line"><span class="comment">      getEvents()å‡½æ•°ä¼šæ‰§è¡ŒscanDevicesLocked()ï¼ŒåŠ è½½æ‰€æœ‰è¾“å…¥è®¾å¤‡ */</span></span><br><span class="line">    <span class="keyword">if</span>(mNeedToScanDevices) &#123;</span><br><span class="line">       mNeedToScanDevices = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">/*scanDevicesLocked()å°†ä¼šæŠŠ/dev/inputä¸‹æ‰€æœ‰å¯ç”¨çš„è¾“å…¥è®¾å¤‡æ‰“å¼€å¹¶å­˜å‚¨åˆ°Device</span></span><br><span class="line"><span class="comment">           ç»“æ„ä½“ä¸­ */</span></span><br><span class="line">       scanDevicesLocked();</span><br><span class="line">       mNeedToSendFinishedDeviceScan = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br><span class="line">returnevent â€“ buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ è½½æ‰€æœ‰è¾“å…¥è®¾å¤‡ç”±scanDevicesLocked()å‡½æ•°å®Œæˆã€‚çœ‹ä¸€ä¸‹å…¶å®ç°ï¼š</p><p>[EventHub.cppâ€“&gt;EventHub::scanDevicesLocked()]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> EventHub::scanDevicesLocked() &#123;</span><br><span class="line"><span class="comment">// è°ƒç”¨scanDirLocked()å‡½æ•°éå†/dev/inputæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰è®¾å¤‡èŠ‚ç‚¹å¹¶æ‰“å¼€</span></span><br><span class="line">status_tres = scanDirLocked(DEVICE_PATH);</span><br><span class="line">......<span class="comment">// é”™è¯¯å¤„ç†</span></span><br><span class="line"><span class="comment">// æ‰“å¼€ä¸€ä¸ªåä¸ºVIRTUAL_KEYBOARDçš„è¾“å…¥è®¾å¤‡ã€‚è¿™ä¸ªè®¾å¤‡æ—¶åˆ»æ˜¯æ‰“å¼€ç€çš„ã€‚å®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„è¾“å…¥è®¾</span></span><br><span class="line">   å¤‡ï¼Œæ²¡æœ‰å¯¹åº”çš„è¾“å…¥èŠ‚ç‚¹ã€‚è¯»è€…å…ˆè®°ä½æœ‰è¿™ä¹ˆä¸€ä¸ªè¾“å…¥è®¾å¤‡å­˜åœ¨äºè¾“å…¥ç³»ç»Ÿä¸­ */</span><br><span class="line"><span class="keyword">if</span>(mDevices.indexOfKey(VIRTUAL_KEYBOARD_ID) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">   createVirtualKeyboardLocked();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>scanDirLocked()éå†æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰è®¾å¤‡èŠ‚ç‚¹ï¼Œåˆ†åˆ«å¯¹å…¶æ‰§è¡ŒopenDeviceLocked()å®Œæˆè®¾å¤‡çš„æ‰“å¼€æ“ä½œã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­å°†ä¸ºè®¾å¤‡èŠ‚ç‚¹åˆ›å»ºå¹¶åŠ è½½Deviceç»“æ„ä½“ã€‚å‚è€ƒå…¶ä»£ç ï¼š</p><p>[EventHub.cppâ€“&gt;EventHub::openDeviceLocked()]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> EventHub::openDeviceLocked(<span class="keyword">const</span> <span class="keyword">char</span>*devicePath) &#123;</span><br><span class="line"><span class="comment">// æ‰“å¼€è®¾å¤‡èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºè·å–è®¾å¤‡ä¿¡æ¯ä»¥åŠè¯»å–åŸå§‹è¾“å…¥äº‹ä»¶</span></span><br><span class="line"><span class="keyword">int</span> fd =open(devicePath, O_RDWR | O_CLOEXEC);</span><br><span class="line"><span class="comment">// æ¥ä¸‹æ¥çš„ä»£ç é€šè¿‡ioctl()å‡½æ•°ä»è®¾å¤‡èŠ‚ç‚¹ä¸­è·å–è¾“å…¥è®¾å¤‡çš„å‚å•†ä¿¡æ¯</span></span><br><span class="line">InputDeviceIdentifier identifier;</span><br><span class="line">......</span><br><span class="line"><span class="comment">// åˆ†é…ä¸€ä¸ªè®¾å¤‡Idå¹¶åˆ›å»ºDeviceç»“æ„ä½“</span></span><br><span class="line">int32_tdeviceId = mNextDeviceId++;</span><br><span class="line">Device*device = <span class="keyword">new</span> Device(fd, deviceId, String8(devicePath), identifier);</span><br><span class="line"><span class="comment">// ä¸ºæ­¤è®¾å¤‡åŠ è½½é…ç½®ä¿¡æ¯ã€‚</span></span><br><span class="line"> loadConfigurationLocked(device);</span><br><span class="line"> <span class="comment">// â‘  é€šè¿‡ioctlå‡½æ•°è·å–è®¾å¤‡çš„äº‹ä»¶ä½æ©ç ã€‚äº‹ä»¶ä½æ©ç æŒ‡å®šäº†è¾“å…¥è®¾å¤‡å¯ä»¥äº§ç”Ÿä½•ç§ç±»å‹çš„è¾“å…¥äº‹ä»¶</span></span><br><span class="line">  ioctl(fd, EVIOCGBIT(EV_KEY, <span class="keyword">sizeof</span>(device-&gt;keyBitmask)),device-&gt;keyBitmask);</span><br><span class="line">......</span><br><span class="line"> ioctl(fd, EVIOCGPROP(<span class="keyword">sizeof</span>(device-&gt;propBitmask)),device-&gt;propBitmask);</span><br><span class="line">  <span class="comment">// æ¥ä¸‹æ¥çš„ä¸€å¤§æ®µå†…å®¹æ˜¯æ ¹æ®äº‹ä»¶ä½æ©ç ä¸ºè®¾å¤‡åˆ†é…ç±»åˆ«ï¼Œå³è®¾ç½®classeså­—æ®µã€‚ã€</span></span><br><span class="line">......</span><br><span class="line"> <span class="comment">/* â‘¡ å°†è®¾å¤‡èŠ‚ç‚¹çš„æè¿°ç¬¦çš„å¯è¯»äº‹ä»¶æ³¨å†Œåˆ°Epollä¸­ã€‚å½“æ­¤è®¾å¤‡çš„è¾“å…¥äº‹ä»¶åˆ°æ¥æ—¶ï¼ŒEpollä¼šåœ¨</span></span><br><span class="line"><span class="comment">  getEvents()å‡½æ•°çš„è°ƒç”¨ä¸­äº§ç”Ÿä¸€æ¡epolläº‹ä»¶ */</span></span><br><span class="line">   structepoll_event eventItem;</span><br><span class="line">   <span class="built_in">memset</span>(&amp;eventItem, <span class="number">0</span>, <span class="keyword">sizeof</span>(eventItem));</span><br><span class="line">   eventItem.events = EPOLLIN;</span><br><span class="line">   eventItem.data.u32 = deviceId; <span class="comment">/* æ³¨æ„ï¼Œepoll_eventçš„è‡ªå®šä¹‰ä¿¡æ¯æ˜¯è®¾å¤‡çš„Id</span></span><br><span class="line"><span class="comment">   if(epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp;eventItem)) &#123;</span></span><br><span class="line"><span class="comment">    ......</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">     ......</span></span><br><span class="line"><span class="comment">     // â‘¢ è°ƒç”¨addDeviceLocked()å°†Deviceæ·»åŠ åˆ°mDeviceså­—å…¸ä¸­</span></span><br><span class="line"><span class="comment">     addDeviceLocked(device);</span></span><br><span class="line"><span class="comment">     return0;</span></span><br><span class="line"><span class="comment">     &#125;</span></span><br></pre></td></tr></table></figure><p>openDeviceLocked()å‡½æ•°æ‰“å¼€æŒ‡å®šè·¯å¾„çš„è®¾å¤‡èŠ‚ç‚¹ï¼Œä¸ºå…¶åˆ›å»ºå¹¶å¡«å……Deviceç»“æ„ä½“ï¼Œç„¶åå°†è®¾å¤‡èŠ‚ç‚¹çš„å¯è¯»äº‹ä»¶æ³¨å†Œåˆ°Epollä¸­ï¼Œæœ€åå°†æ–°å»ºçš„Deviceç»“æ„ä½“æ·»åŠ åˆ°mDeviceså­—å…¸ä¸­ä»¥ä¾›æ£€ç´¢ä¹‹éœ€ã€‚æ•´ä¸ªè¿‡ç¨‹æ¯”è¾ƒæ¸…æ™°ï¼Œä½†ä»æœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><p>Â· openDeviceLocked()å‡½æ•°ä»è®¾å¤‡èŠ‚ç‚¹ä¸­è·å–äº†è®¾å¤‡å¯èƒ½ä¸ŠæŠ¥çš„äº‹ä»¶ç±»å‹ï¼Œå¹¶æ®æ­¤ä¸ºè®¾å¤‡åˆ†é…äº†ç±»åˆ«ã€‚æ•´ä¸ªåˆ†é…è¿‡ç¨‹éå¸¸ç¹çï¼Œç”±äºå®ƒå’ŒInputReaderçš„äº‹ä»¶åŠ å·¥è¿‡ç¨‹å…³ç³»ç´§å¯†ï¼Œå› æ­¤è¿™éƒ¨åˆ†å†…å®¹å°†åœ¨5.2.4èŠ‚å†åšè¯¦ç»†è®¨è®ºã€‚</p><p>Â· å‘Epollæ³¨å†Œè®¾å¤‡èŠ‚ç‚¹çš„å¯è¯»äº‹ä»¶æ—¶ï¼Œepoll_eventçš„è‡ªå®šä¹‰æ•°æ®è¢«è®¾ç½®ä¸ºè®¾å¤‡çš„Idè€Œä¸æ˜¯fdã€‚</p><p>Â· addDeviceLocked()å°†æ–°å»ºçš„Deviceå¯¹è±¡æ·»åŠ åˆ°mDeviceså­—å…¸ä¸­çš„åŒæ—¶ä¹Ÿä¼šå°†å…¶æ·»åŠ åˆ°ä¸€ä¸ªåä¸ºmOpeningDevicesçš„é“¾è¡¨ä¸­ã€‚è¿™ä¸ªé“¾è¡¨ä¿å­˜äº†åˆšåˆšè¢«åŠ è½½ï¼Œä½†å°šæœªé€šè¿‡getEvents()å‡½æ•°å‘InputReaderå‘é€DEVICE_ADDäº‹ä»¶çš„è®¾å¤‡ã€‚</p><p>å®Œæˆè¾“å…¥è®¾å¤‡çš„åŠ è½½ä¹‹åï¼Œé€šè¿‡getEvents()å‡½æ•°ä¾¿å¯ä»¥è¯»å–åˆ°æ­¤è®¾å¤‡æ‰€äº§ç”Ÿçš„è¾“å…¥äº‹ä»¶äº†ã€‚é™¤äº†åœ¨getEvents()å‡½æ•°ä¸­ä½¿ç”¨scanDevicesLockd()ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰è¾“å…¥è®¾å¤‡ï¼Œå½“INotifyäº‹ä»¶å‘ŠçŸ¥æœ‰æ–°çš„è¾“å…¥è®¾å¤‡èŠ‚ç‚¹è¢«åˆ›å»ºæ—¶ï¼Œä¹Ÿä¼šé€šè¿‡opendDeviceLocked()å°†è®¾å¤‡åŠ è½½ï¼Œç¨åå†åšè®¨è®ºã€‚</p><h3 id="ï¼ˆ2ï¼‰ã€è¾“å…¥è®¾å¤‡çš„å¸è½½"><a href="#ï¼ˆ2ï¼‰ã€è¾“å…¥è®¾å¤‡çš„å¸è½½" class="headerlink" title="ï¼ˆ2ï¼‰ã€è¾“å…¥è®¾å¤‡çš„å¸è½½"></a>ï¼ˆ2ï¼‰ã€è¾“å…¥è®¾å¤‡çš„å¸è½½</h3><p>è¾“å…¥è®¾å¤‡çš„å¸è½½ç”±closeDeviceLocked()å‡½æ•°å®Œæˆã€‚ç”±äºæ­¤å‡½æ•°çš„å·¥ä½œå†…å®¹ä¸openDeviceLocked()å‡½æ•°æ­£å¥½ç›¸åï¼Œå°±ä¸åˆ—å‡ºå…¶ä»£ç äº†ã€‚è®¾å¤‡çš„å¸è½½è¿‡ç¨‹ä¸ºï¼š</p><p>Â· ä»Epollä¸­æ³¨é”€å¯¹æè¿°ç¬¦çš„ç›‘å¬ã€‚</p><p>Â· å…³é—­è®¾å¤‡èŠ‚ç‚¹çš„æè¿°ç¬¦ã€‚</p><p>Â· ä»mDeviceså­—å…¸ä¸­åˆ é™¤å¯¹åº”çš„Deviceå¯¹è±¡ã€‚</p><p>Â· å°†Deviceå¯¹è±¡æ·»åŠ åˆ°mClosingDevicesé“¾è¡¨ä¸­ï¼Œä¸mOpeningDevicesç±»ä¼¼ï¼Œè¿™ä¸ªé“¾è¡¨ä¿å­˜äº†åˆšåˆšè¢«å¸è½½ï¼Œä½†å°šæœªé€šè¿‡getEvents()å‡½æ•°å‘InputReaderå‘é€DEVICE_REMOVEDäº‹ä»¶çš„è®¾å¤‡ã€‚</p><p>åŒåŠ è½½è®¾å¤‡ä¸€æ ·ï¼Œåœ¨getEvents()å‡½æ•°ä¸­æœ‰æ ¹æ®éœ€è¦å¸è½½æ‰€æœ‰è¾“å…¥è®¾å¤‡çš„æ“ä½œï¼ˆæ¯”å¦‚å½“EventHubè¦æ±‚é‡æ–°åŠ è½½æ‰€æœ‰è®¾å¤‡æ—¶ï¼Œä¼šå…ˆå°†æ‰€æœ‰è®¾å¤‡å¸è½½ï¼‰ã€‚å¹¶ä¸”å½“INotifyäº‹ä»¶å‘ŠçŸ¥æœ‰è®¾å¤‡èŠ‚ç‚¹åˆ é™¤æ—¶ä¹Ÿä¼šè°ƒç”¨closeDeviceLocked()å°†è®¾å¤‡å¸è½½ã€‚</p><h3 id="ï¼ˆ3ï¼‰ã€è®¾å¤‡å¢åˆ äº‹ä»¶"><a href="#ï¼ˆ3ï¼‰ã€è®¾å¤‡å¢åˆ äº‹ä»¶" class="headerlink" title="ï¼ˆ3ï¼‰ã€è®¾å¤‡å¢åˆ äº‹ä»¶"></a>ï¼ˆ3ï¼‰ã€è®¾å¤‡å¢åˆ äº‹ä»¶</h3><p>åœ¨åˆ†æè®¾å¤‡çš„åŠ è½½ä¸å¸è½½æ—¶å‘ç°ï¼Œæ–°åŠ è½½çš„è®¾å¤‡ä¸æ–°å¸è½½çš„è®¾å¤‡ä¼šè¢«åˆ†åˆ«æ”¾å…¥mOpeningDevicesä¸mClosingDevicesé“¾è¡¨ä¹‹ä¸­ã€‚è¿™ä¸¤ä¸ªé“¾è¡¨å°†æ˜¯åœ¨getEvents()å‡½æ•°ä¸­å‘InputReaderå‘é€è®¾å¤‡å¢åˆ äº‹ä»¶çš„ä¾æ®ã€‚</p><p>å‚è€ƒgetEvents()å‡½æ•°çš„ç›¸å…³ä»£ç ï¼Œä»¥è®¾å¤‡å¸è½½äº‹ä»¶ä¸ºä¾‹çœ‹ä¸€ä¸‹è®¾å¤‡å¢åˆ äº‹ä»¶æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼š</p><p>[EventHub.cppâ€“&gt;EventHub::getEvents()]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> EventHub::getEvents(<span class="keyword">int</span> timeoutMillis,RawEvent* buffer, <span class="keyword">size_t</span> bufferSize) &#123;</span><br><span class="line"><span class="keyword">for</span> (;;)&#123;</span><br><span class="line">    <span class="comment">// éå†mClosingDevicesé“¾è¡¨ï¼Œä¸ºæ¯ä¸€ä¸ªå·²å¸è½½çš„è®¾å¤‡ç”ŸæˆDEVICE_REMOVEDäº‹ä»¶</span></span><br><span class="line">   <span class="keyword">while</span> (mClosingDevices) &#123;</span><br><span class="line">       Device* device = mClosingDevices;</span><br><span class="line">       mClosingDevices = device-&gt;next;</span><br><span class="line">       <span class="comment">/* åˆ†ægetEvents()å‡½æ•°çš„å·¥ä½œæ–¹å¼æ—¶ä»‹ç»è¿‡ï¼ŒeventæŒ‡é’ˆæŒ‡å‘bufferä¸­ä¸‹ä¸€ä¸ªå¯ç”¨äºå¡«å……</span></span><br><span class="line"><span class="comment">          äº‹ä»¶çš„RawEventå¯¹è±¡ */</span></span><br><span class="line">       event-&gt;when = now; <span class="comment">// è®¾ç½®äº§ç”Ÿäº‹ä»¶çš„äº‹ä»¶æˆ³</span></span><br><span class="line">       event-&gt;deviceId =</span><br><span class="line">               device-&gt;id ==mBuiltInKeyboardId ? BUILT_IN_KEYBOARD_ID : device-&gt;id;</span><br><span class="line">       event-&gt;type = DEVICE_REMOVED; <span class="comment">// è®¾ç½®äº‹ä»¶çš„ç±»å‹ä¸ºDEVICE_REMOVED</span></span><br><span class="line">       event += <span class="number">1</span>; <span class="comment">// å°†eventæŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨äºå¡«å……äº‹ä»¶çš„RawEventå¯¹è±¡</span></span><br><span class="line">       <span class="keyword">delete</span> device; <span class="comment">// ç”ŸæˆDEVICE_REMOVEDäº‹ä»¶ä¹‹åï¼Œè¢«å¸è½½çš„Deviceå¯¹è±¡å°±ä¸å†éœ€è¦äº†</span></span><br><span class="line">       mNeedToSendFinishedDeviceScan = <span class="literal">true</span>; <span class="comment">// éšåå‘é€FINISHED_DEVICE_SCANäº‹ä»¶</span></span><br><span class="line">        <span class="comment">/* å½“bufferå·²æ»¡åˆ™åœæ­¢ç»§ç»­ç”Ÿæˆäº‹ä»¶ï¼Œå°†å·²ç”Ÿæˆçš„äº‹ä»¶è¿”å›ç»™è°ƒç”¨è€…ã€‚å°šæœªç”Ÿæˆçš„äº‹ä»¶</span></span><br><span class="line"><span class="comment">          å°†åœ¨ä¸‹æ¬¡getEvents()è°ƒç”¨æ—¶ç”Ÿæˆå¹¶è¿”å›ç»™è°ƒç”¨è€… */</span></span><br><span class="line">       <span class="keyword">if</span> (--capacity == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥è¿›è¡ŒDEVICE_ADDEDäº‹ä»¶çš„ç”Ÿæˆï¼Œæ­¤è¿‡ç¨‹ä¸ DEVICE_REMOVEDäº‹ä»¶çš„ç”Ÿæˆä¸€è‡´</span></span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br><span class="line">returnevent â€“ buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸€æ¬¡getEvents()è°ƒç”¨ä¸­ä¼šå°è¯•ä¸ºæ‰€æœ‰å°šæœªå‘é€å¢åˆ äº‹ä»¶çš„è¾“å…¥è®¾å¤‡ç”Ÿæˆå¯¹åº”çš„äº‹ä»¶è¿”å›ç»™è°ƒç”¨è€…ã€‚è¡¨ç¤ºè®¾å¤‡å¢åˆ äº‹ä»¶çš„RawEventå¯¹è±¡åŒ…å«ä¸‰ä¸ªä¿¡æ¯ï¼šäº§ç”Ÿäº‹ä»¶çš„äº‹ä»¶æˆ³ã€äº§ç”Ÿäº‹ä»¶çš„è®¾å¤‡Idï¼Œä»¥åŠäº‹ä»¶ç±»å‹ï¼ˆDEVICE_ADDEDæˆ–DEVICE_REMOVEDï¼‰ã€‚</p><p>å½“ç”Ÿæˆè®¾å¤‡å¢åˆ äº‹ä»¶æ—¶ï¼Œä¼šè®¾ç½®mNeedToSendFinishedDeviceSanä¸ºtrueï¼Œè¿™ä¸ªåŠ¨ä½œçš„æ„æ€æ˜¯å®Œæˆæ‰€æœ‰DEVICE_ADDED/REMOVEDäº‹ä»¶çš„ç”Ÿæˆä¹‹åï¼Œéœ€è¦å‘getEvents()çš„è°ƒç”¨è€…å‘é€ä¸€ä¸ªFINISHED_DEVICE_SCANäº‹ä»¶ï¼Œè¡¨ç¤ºè®¾å¤‡å¢åˆ äº‹ä»¶çš„ä¸ŠæŠ¥ç»“æŸã€‚è¿™ä¸ªäº‹ä»¶ä»…åŒ…æ‹¬æ—¶é—´æˆ³ä¸äº‹ä»¶ç±»å‹ä¸¤ä¸ªä¿¡æ¯ã€‚</p><p>ç»è¿‡ä»¥ä¸Šåˆ†æå¯çŸ¥ï¼ŒEventHubå¯ä»¥äº§ç”Ÿçš„è®¾å¤‡å¢åˆ äº‹ä»¶ä¸€å…±æœ‰ä¸‰ç§ï¼Œè€Œä¸”è¿™ä¸‰ç§äº‹ä»¶æ‹¥æœ‰å›ºå®šçš„ä¼˜å…ˆçº§ï¼ŒDEVICE_REMOVEDäº‹ä»¶çš„ä¼˜å…ˆçº§æœ€é«˜ï¼ŒDEVICE_ADDEDäº‹ä»¶æ¬¡ä¹‹ï¼ŒFINISHED_DEVICE_SCANäº‹ä»¶æœ€ä½ã€‚è€Œä¸”ï¼ŒgetEvents()å®Œæˆå½“å‰é«˜ä¼˜å…ˆçº§äº‹ä»¶çš„ç”Ÿæˆä¹‹å‰ï¼Œä¸ä¼šè¿›è¡Œä½ä¼˜å…ˆçº§äº‹ä»¶çš„ç”Ÿæˆã€‚å› æ­¤ï¼Œå½“å‘ç”Ÿè®¾å¤‡çš„åŠ è½½ä¸å¸è½½æ—¶ï¼ŒEventHubæ‰€ç”Ÿæˆçš„å®Œæ•´çš„è®¾å¤‡å¢åˆ äº‹ä»¶åºåˆ—å¦‚å›¾5-5æ‰€ç¤ºï¼Œå…¶ä¸­Rè¡¨ç¤ºDEVICE_REMOVEDï¼ŒAè¡¨ç¤ºDEVICE_ADDEDï¼ŒFè¡¨ç¤ºFINISHED_DEVICE_SCANã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N16-Android-Input-System-input-device-add-del.png" alt="Markdown"></p><p>å›¾ï¼šè®¾å¤‡å¢åˆ äº‹ä»¶çš„å®Œæ•´åºåˆ—</p><p>ç”±äºå‚æ•°bufferçš„å®¹é‡é™åˆ¶ï¼Œè¿™ä¸ªäº‹ä»¶åºåˆ—å¯èƒ½éœ€è¦é€šè¿‡å¤šæ¬¡getEvents()è°ƒç”¨æ‰èƒ½å®Œæ•´åœ°è¿”å›ç»™è°ƒç”¨è€…ã€‚å¦å¤–ï¼Œæ ¹æ®5.2.2èŠ‚çš„è®¨è®ºï¼Œè®¾å¤‡å¢åˆ äº‹ä»¶ç›¸å¯¹äºEpolläº‹ä»¶æ‹¥æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œå› æ­¤ä»R1äº‹ä»¶å¼€å§‹ç”Ÿæˆåˆ°Fäº‹ä»¶ç”Ÿæˆä¹‹å‰ï¼ŒgetEvents()ä¸ä¼šå¤„ç†Epolläº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šç”ŸæˆåŸå§‹è¾“å…¥äº‹ä»¶ã€‚</p><p>æ€»ç»“ä¸€ä¸‹è®¾å¤‡å¢åˆ äº‹ä»¶çš„ç”ŸæˆåŸç†ï¼š</p><p>Â· å½“å‘ç”Ÿè®¾å¤‡å¢åˆ æ—¶ï¼ŒaddDeviceLocked()å‡½æ•°ä¸closeDeviceLocked()å‡½æ•°ä¼šå°†ç›¸åº”çš„è®¾å¤‡æ”¾å…¥mOpeningDeviceså’ŒmClosingDevicesé“¾è¡¨ä¸­ã€‚</p><p>Â· getEvents()å‡½æ•°ä¼šæ ¹æ®mOpeningDeviceså’ŒmClosingDevicesä¸¤ä¸ªé“¾è¡¨ç”Ÿæˆå¯¹åº”DEVICE_ADDEDå’ŒDEVICE_REMOVEDäº‹ä»¶ï¼Œå…¶ä¸­åè€…çš„ç”Ÿæˆæ‹¥æœ‰é«˜ä¼˜å…ˆçº§ã€‚</p><p>Â· DEVICE_ADDEDå’ŒDEVICE_REMOVEDäº‹ä»¶éƒ½ç”Ÿæˆå®Œæ¯•åï¼ŒgetEvents()ä¼šç”ŸæˆFINISHED_DEVICE_SCANäº‹ä»¶ï¼Œæ ‡å¿—è®¾å¤‡å¢åˆ äº‹ä»¶åºåˆ—çš„ç»“æŸã€‚</p><h3 id="ï¼ˆ4ï¼‰ã€é€šè¿‡INotifyåŠ¨æ€åœ°åŠ è½½ä¸å¸è½½è®¾å¤‡"><a href="#ï¼ˆ4ï¼‰ã€é€šè¿‡INotifyåŠ¨æ€åœ°åŠ è½½ä¸å¸è½½è®¾å¤‡" class="headerlink" title="ï¼ˆ4ï¼‰ã€é€šè¿‡INotifyåŠ¨æ€åœ°åŠ è½½ä¸å¸è½½è®¾å¤‡"></a>ï¼ˆ4ï¼‰ã€é€šè¿‡INotifyåŠ¨æ€åœ°åŠ è½½ä¸å¸è½½è®¾å¤‡</h3><p>é€šè¿‡å‰æ–‡çš„ä»‹ç»çŸ¥é“äº†openDeviceLocked()å’ŒcloseDeviceLocked()å¯ä»¥åŠ è½½ä¸å¸è½½è¾“å…¥è®¾å¤‡ã€‚æ¥ä¸‹æ¥åˆ†æEventHubå¦‚ä½•é€šè¿‡INotifyè¿›è¡Œè®¾å¤‡çš„åŠ¨æ€åŠ è½½ä¸å¸è½½ã€‚åœ¨EventHubçš„æ„é€ å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªåä¸ºmINotifyFdçš„INotifyå¯¹è±¡çš„æè¿°ç¬¦ï¼Œç”¨ä»¥ç›‘æ§/dev/inputä¸‹è®¾å¤‡èŠ‚ç‚¹çš„å¢åˆ ã€‚ä¹‹åå°†mINotifyFdçš„å¯è¯»äº‹ä»¶åŠ å…¥åˆ°Epollä¸­ã€‚äºæ˜¯å¯ä»¥ç¡®å®šåŠ¨æ€åŠ è½½ä¸å¸è½½è®¾å¤‡çš„å·¥ä½œæ–¹å¼ä¸ºï¼šé¦–å…ˆç­›é€‰epoll_wait()å‡½æ•°æ‰€å–å¾—çš„Epolläº‹ä»¶ï¼Œå¦‚æœEpolläº‹ä»¶è¡¨ç¤ºäº†mINotifyFdå¯è¯»ï¼Œä¾¿ä»mINotifyFdä¸­è¯»å–è®¾å¤‡èŠ‚ç‚¹çš„å¢åˆ äº‹ä»¶ï¼Œç„¶åé€šè¿‡æ‰§è¡ŒopenDeviceLocked()æˆ–closeDeviceLocked()è¿›è¡Œè®¾å¤‡çš„åŠ è½½ä¸å¸è½½ã€‚</p><p>çœ‹ä¸€ä¸‹getEvents()ä¸­ä¸INotifyç›¸å…³çš„ä»£ç ï¼š</p><p>[EventHub.cppâ€“&gt;EventHub::getEvents()]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> EventHub::getEvents(<span class="keyword">int</span> timeoutMillis,RawEvent* buffer, <span class="keyword">size_t</span> bufferSize) &#123;</span><br><span class="line"><span class="keyword">for</span> (;;)&#123;</span><br><span class="line">   ...... <span class="comment">// è®¾å¤‡å¢åˆ äº‹ä»¶å¤„ç†</span></span><br><span class="line">    <span class="keyword">while</span>(mPendingEventIndex &lt; mPendingEventCount) &#123;</span><br><span class="line">       <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>&amp; <span class="title">eventItem</span> =</span></span><br><span class="line"><span class="class">                             <span class="title">mPendingEventItems</span>[<span class="title">mPendingEventIndex</span>++];</span></span><br><span class="line">       <span class="comment">/* â‘  é€šè¿‡Epolläº‹ä»¶çš„dataå­—æ®µç¡®å®šæ­¤äº‹ä»¶è¡¨ç¤ºäº†mINotifyFdå¯è¯»</span></span><br><span class="line"><span class="comment">          æ³¨æ„EPOLL_ID_INOTIFYåœ¨EventHubçš„æ„é€ å‡½æ•°ä¸­ä½œä¸ºdataå­—æ®µå‘</span></span><br><span class="line"><span class="comment">          Epollæ³¨å†ŒmINotifyFdçš„å¯è¯»äº‹ä»¶ */</span></span><br><span class="line">       <span class="keyword">if</span> (eventItem.data.u32 == EPOLL_ID_INOTIFY) &#123;</span><br><span class="line">           <span class="keyword">if</span> (eventItem.events &amp; EPOLLIN) &#123;</span><br><span class="line">               mPendingINotify = <span class="literal">true</span>; <span class="comment">// æ ‡è®°INotifyäº‹ä»¶å¾…å¤„ç†</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123; ...... &#125;</span><br><span class="line">           <span class="keyword">continue</span>; <span class="comment">// ç»§ç»­å¤„ç†ä¸‹ä¸€æ¡Epolläº‹ä»¶</span></span><br><span class="line">       &#125;</span><br><span class="line">       ...... <span class="comment">// å…¶ä»–Epolläº‹ä»¶çš„å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœINotifyäº‹ä»¶å¾…å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span>(mPendingINotify &amp;&amp; mPendingEventIndex &gt;= mPendingEventCount) &#123;</span><br><span class="line">       mPendingINotify = <span class="literal">false</span>;</span><br><span class="line">       <span class="comment">/* â‘¡ è°ƒç”¨readNotifyLocked()å‡½æ•°è¯»å–å¹¶å¤„ç†å­˜å‚¨åœ¨mINotifyFdä¸­çš„INotifyäº‹ä»¶</span></span><br><span class="line"><span class="comment">          è¿™ä¸ªå‡½æ•°å°†å®Œæˆè®¾å¤‡çš„åŠ è½½ä¸å¸è½½ */</span></span><br><span class="line">       readNotifyLocked();</span><br><span class="line">       deviceChanged = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//â‘¢ å¦‚æœå¤„ç†äº†INotifyäº‹ä»¶ï¼Œåˆ™è¿”å›åˆ°å¾ªç¯å¼€å§‹å¤„ï¼Œç”Ÿæˆè®¾å¤‡å¢åˆ äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span>(deviceChanged) &#123;</span><br><span class="line">       <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getEvents()å‡½æ•°ä¸­ä¸INotifyç›¸å…³çš„ä»£ç å…±æœ‰ä¸‰å¤„ï¼š</p><p>Â· è¯†åˆ«è¡¨ç¤ºmINotifyFdå¯è¯»çš„Epolläº‹ä»¶ï¼Œå¹¶é€šè¿‡è®¾ç½®mPendingINotifyä¸ºtrueä»¥æ ‡è®°æœ‰INotifyäº‹ä»¶å¾…å¤„ç†ã€‚getEvents()å¹¶æ²¡æœ‰ç«‹åˆ»å¤„ç†INotifyäº‹ä»¶ï¼Œå› ä¸ºæ­¤æ—¶è¿›è¡Œè®¾å¤‡çš„åŠ è½½ä¸å¸è½½æ˜¯ä¸å®‰å…¨çš„ã€‚å…¶ä»–Epolläº‹ä»¶å¯èƒ½åŒ…å«äº†æ¥è‡ªå³å°†è¢«å¸è½½çš„è®¾å¤‡çš„è¾“å…¥äº‹ä»¶ï¼Œå› æ­¤éœ€è¦å°†æ‰€æœ‰Epolläº‹ä»¶éƒ½å¤„ç†å®Œæ¯•åå†è¿›è¡ŒåŠ è½½ä¸å¸è½½æ“ä½œã€‚</p><p>Â· å½“epoll_wait()æ‰€è¿”å›çš„Epolläº‹ä»¶éƒ½å¤„ç†å®Œæ¯•åï¼Œè°ƒç”¨readNotifyLocked()å‡½æ•°è¯»å–mINotifyFdä¸­çš„äº‹ä»¶ï¼Œå¹¶è¿›è¡Œè®¾å¤‡çš„åŠ è½½ä¸å¸è½½æ“ä½œã€‚</p><p>Â· å®Œæˆè®¾å¤‡çš„åŠ¨æ€åŠ è½½ä¸å¸è½½åï¼Œéœ€è¦è¿”å›åˆ°å¾ªç¯æœ€å¼€å§‹å¤„ï¼Œä»¥ä¾¿è®¾å¤‡å¢åˆ äº‹ä»¶å¤„ç†ä»£ç ç”Ÿæˆè®¾å¤‡çš„å¢åˆ äº‹ä»¶ã€‚</p><p>å…¶ä¸­ç¬¬ä¸€éƒ¨åˆ†ä¸ç¬¬ä¸‰éƒ¨åˆ†æ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹readNotifyLocked()æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p>[EventHub.cppâ€“&gt;EventHub::readNotifyLocked()]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> EventHub::readNotifyLocked() &#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// ä»mINotifyFdä¸­è¯»å–INotifyäº‹ä»¶åˆ—è¡¨</span></span><br><span class="line">    res =read(mINotifyFd, event_buf, <span class="keyword">sizeof</span>(event_buf));</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// é€ä¸ªå¤„ç†åˆ—è¡¨ä¸­çš„äº‹ä»¶</span></span><br><span class="line">       <span class="keyword">while</span>(res &gt;= (<span class="keyword">int</span>)<span class="keyword">sizeof</span>(*event)) &#123;</span><br><span class="line">       <span class="built_in">strcpy</span>(filename, event-&gt;name); <span class="comment">// ä»äº‹ä»¶ä¸­è·å–è®¾å¤‡èŠ‚ç‚¹è·¯å¾„</span></span><br><span class="line">       <span class="keyword">if</span>(event-&gt;mask &amp; IN_CREATE) &#123;</span><br><span class="line">           openDeviceLocked(devname); <span class="comment">// å¦‚æœäº‹ä»¶ç±»å‹ä¸ºIN_CREATEï¼Œåˆ™åŠ è½½å¯¹åº”è®¾å¤‡</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           closeDeviceByPathLocked(devname); <span class="comment">// å¦åˆ™å¸è½½å¯¹åº”è®¾å¤‡</span></span><br><span class="line">        &#125;</span><br><span class="line">        ......<span class="comment">// ç§»åŠ¨åˆ°åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªäº‹ä»¶</span></span><br><span class="line">    &#125;</span><br><span class="line">    return0;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ï¼ˆ5ï¼‰ã€EventHubè®¾å¤‡ç®¡ç†æ€»ç»“"><a href="#ï¼ˆ5ï¼‰ã€EventHubè®¾å¤‡ç®¡ç†æ€»ç»“" class="headerlink" title="ï¼ˆ5ï¼‰ã€EventHubè®¾å¤‡ç®¡ç†æ€»ç»“"></a>ï¼ˆ5ï¼‰ã€EventHubè®¾å¤‡ç®¡ç†æ€»ç»“</h3><p>è‡³æ­¤ï¼ŒEventHubçš„è®¾å¤‡ç®¡ç†ç›¸å…³çš„çŸ¥è¯†ä¾¿è®¨è®ºå®Œæ¯•äº†ã€‚åœ¨è¿™é‡Œè¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼š</p><p>Â· EventHubé€šè¿‡Deviceç»“æ„ä½“æè¿°è¾“å…¥è®¾å¤‡çš„å„ç§ä¿¡æ¯ã€‚</p><p>Â· EventHubåœ¨getEvents()å‡½æ•°ä¸­è¿›è¡Œè®¾å¤‡çš„åŠ è½½ä¸å¸è½½æ“ä½œã€‚è®¾å¤‡çš„åŠ è½½ä¸å¸è½½åˆ†ä¸ºæŒ‰éœ€åŠ è½½æˆ–å¸è½½ä»¥åŠé€šè¿‡INotifyåŠ¨æ€åŠ è½½æˆ–å¸è½½ç‰¹å®šè®¾å¤‡ä¸¤ç§æ–¹å¼ã€‚</p><p>Â· getEvents()å‡½æ•°è¿›è¡Œäº†è®¾å¤‡çš„åŠ è½½ä¸å¸è½½æ“ä½œåï¼Œä¼šç”ŸæˆDEVICE_ADDEDã€DEVICE_REMOVEDä»¥åŠFINISHED_DEVICE_SCANä¸‰ç§è®¾å¤‡å¢åˆ äº‹ä»¶ï¼Œå¹¶ä¸”è®¾å¤‡å¢åˆ äº‹ä»¶æ‹¥æœ‰é«˜äºEpolläº‹ä»¶çš„ä¼˜å…ˆçº§ã€‚ 4ï¼åŸå§‹è¾“å…¥äº‹ä»¶çš„ç›‘å¬ä¸è¯»å– æœ¬èŠ‚å°†è®¨è®ºEventHubå¦ä¸€ä¸ªæ ¸å¿ƒçš„åŠŸèƒ½ï¼Œç›‘å¬ä¸è¯»å–åŸå§‹è¾“å…¥äº‹ä»¶ã€‚</p><p>å›å¿†ä¸€ä¸‹è¾“å…¥è®¾å¤‡çš„åŠ è½½è¿‡ç¨‹ï¼Œå½“è®¾å¤‡åŠ è½½æ—¶ï¼ŒopenDeviceLocked()ä¼šæ‰“å¼€è®¾å¤‡èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶å°†å…¶å¯è¯»äº‹ä»¶æ³¨å†Œè¿›Epollä¸­ã€‚äºæ˜¯å½“è®¾å¤‡çš„åŸå§‹è¾“å…¥äº‹ä»¶åˆ°æ¥æ—¶ï¼ŒgetEvents()å‡½æ•°å°†ä¼šè·å¾—ä¸€æ¡Epolläº‹ä»¶ï¼Œç„¶åæ ¹æ®æ­¤Epolläº‹ä»¶è¯»å–æ–‡ä»¶æè¿°ç¬¦ä¸­çš„åŸå§‹è¾“å…¥äº‹ä»¶ï¼Œå°†å…¶å¡«å……åˆ°RawEventsç»“æ„ä½“å¹¶æ”¾å…¥bufferä¸­è¢«è°ƒç”¨è€…å–èµ°ã€‚openDeviceLocked()æ³¨å†Œäº†è®¾å¤‡èŠ‚ç‚¹çš„EPOLLINå’ŒEPOLLHUPä¸¤ä¸ªäº‹ä»¶ï¼Œåˆ†åˆ«è¡¨ç¤ºå¯è¯»ä¸è¢«æŒ‚èµ·ï¼ˆä¸å¯ç”¨ï¼‰ï¼Œå› æ­¤getEvents()éœ€è¦åˆ†åˆ«å¤„ç†è¿™ä¸¤ç§äº‹ä»¶ã€‚</p><p>çœ‹ä¸€ä¸‹getEvents()å‡½æ•°ä¸­çš„ç›¸å…³ä»£ç ï¼š</p><p>[EventHub.cppâ€“&gt;EventHub::getEvents()]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> EventHub::getEvents(<span class="keyword">int</span> timeoutMillis,RawEvent* buffer, <span class="keyword">size_t</span> bufferSize) &#123;</span><br><span class="line"><span class="keyword">for</span> (;;)&#123;</span><br><span class="line">   ...... <span class="comment">// è®¾å¤‡å¢åˆ äº‹ä»¶å¤„ç†</span></span><br><span class="line">    <span class="keyword">while</span>(mPendingEventIndex &lt; mPendingEventCount) &#123;</span><br><span class="line">       <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>&amp; <span class="title">eventItem</span> =</span></span><br><span class="line"><span class="class">                             <span class="title">mPendingEventItems</span>[<span class="title">mPendingEventIndex</span>++];</span></span><br><span class="line">       ...... <span class="comment">// INotifyä¸wakeFdçš„Epolläº‹ä»¶å¤„ç†</span></span><br><span class="line">       <span class="comment">/* â‘  é€šè¿‡Epollçš„data.u32å­—æ®µè·å–è®¾å¤‡Idï¼Œè¿›è€Œè·å–å¯¹åº”çš„Deviceå¯¹è±¡ã€‚å¦‚æœæ— æ³•æ‰¾åˆ°</span></span><br><span class="line"><span class="comment">          å¯¹åº”çš„Deviceå¯¹è±¡ï¼Œè¯´æ˜æ­¤Epolläº‹ä»¶å¹¶ä¸è¡¨ç¤ºåŸå§‹è¾“å…¥äº‹ä»¶çš„åˆ°æ¥ï¼Œå¿½ç•¥ä¹‹ */</span></span><br><span class="line">       <span class="keyword">ssize_t</span> deviceIndex = mDevices.indexOfKey(eventItem.data.u32);</span><br><span class="line">       Device* device = mDevices.valueAt(deviceIndex);</span><br><span class="line">       ......</span><br><span class="line">       <span class="keyword">if</span> (eventItem.events &amp; EPOLLIN) &#123;</span><br><span class="line">           <span class="comment">/* â‘¡ å¦‚æœEpolläº‹ä»¶ä¸ºEPOLLINï¼Œè¡¨ç¤ºè®¾å¤‡èŠ‚ç‚¹æœ‰åŸå§‹è¾“å…¥äº‹ä»¶å¯è¯»ã€‚æ­¤æ—¶å¯ä»¥ä»æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">              ä¸­è¯»å–ã€‚è¯»å–ç»“æœä½œä¸ºinput_eventç»“æ„ä½“å¹¶å­˜å‚¨åœ¨readBufferä¸­ï¼Œæ³¨æ„äº‹ä»¶çš„ä¸ªæ•°</span></span><br><span class="line"><span class="comment">               å—åˆ°capacityçš„é™åˆ¶*/</span></span><br><span class="line">           <span class="keyword">int32_t</span> readSize = read(device-&gt;fd, readBuffer,</span><br><span class="line">                    <span class="keyword">sizeof</span>(structinput_event) * capacity);</span><br><span class="line">           <span class="keyword">if</span> (......) &#123;                    ......<span class="comment">// ä¸€äº›é”™è¯¯å¤„ç† &#125;</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">size_t</span> count = <span class="keyword">size_t</span>(readSize) / <span class="keyword">sizeof</span>(struct input_event);</span><br><span class="line">               <span class="comment">/* â‘¡ å°†è¯»å–åˆ°çš„æ¯ä¸€ä¸ªinput_eventç»“æ„ä½“ä¸­çš„æ•°æ®è½¬æ¢ä¸ºä¸€ä¸ªRawEventå¯¹è±¡ï¼Œ</span></span><br><span class="line"><span class="comment">                   å¹¶å­˜å‚¨åœ¨bufferå‚æ•°ä¸­ä»¥è¿”å›ç»™è°ƒç”¨è€… */</span></span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                    <span class="keyword">const</span> structinput_event&amp; iev = readBuffer[i];</span><br><span class="line">                    ......</span><br><span class="line">                    event-&gt;when = now;</span><br><span class="line">                    event-&gt;deviceId =deviceId;</span><br><span class="line">                    event-&gt;type =iev.type;</span><br><span class="line">                    event-&gt;code =iev.code;</span><br><span class="line">                    event-&gt;value =iev.value;</span><br><span class="line">                   event += <span class="number">1</span>; <span class="comment">// ç§»åŠ¨åˆ°bufferçš„ä¸‹ä¸€ä¸ªå¯ç”¨å…ƒç´ </span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">/* æ¥ä¸‹æ¥çš„ä¸€ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œå› ä¸ºbufferçš„å®¹é‡é™åˆ¶ï¼Œå¯èƒ½æ— æ³•å®Œå…¨è¯»å–è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                   ä¸­å­˜å‚¨çš„åŸå§‹äº‹ä»¶ã€‚ä¸€æ—¦bufferæ»¡äº†åˆ™éœ€è¦ç«‹åˆ»è¿”å›ç»™è°ƒç”¨è€…ã€‚è®¾å¤‡èŠ‚ç‚¹ä¸­å‰©ä½™çš„</span></span><br><span class="line"><span class="comment">                   è¾“å…¥äº‹ä»¶å°†åœ¨ä¸‹æ¬¡getEvents()è°ƒç”¨æ—¶ç»§ç»­è¯»å–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰çš„Epolläº‹ä»¶</span></span><br><span class="line"><span class="comment">                   å¹¶æœªå¤„ç†å®Œæ¯•ã€‚mPendingEventIndex -= 1çš„ç›®çš„å°±æ˜¯ä½¿ä¸‹æ¬¡getEvents()è°ƒç”¨</span></span><br><span class="line"><span class="comment">                   èƒ½å¤Ÿç»§ç»­å¤„ç†è¿™ä¸ªEpolläº‹ä»¶ */</span></span><br><span class="line">               capacity -= count;</span><br><span class="line">               <span class="keyword">if</span> (capacity == <span class="number">0</span>) &#123;</span><br><span class="line">                    mPendingEventIndex -=<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventItem.events &amp; EPOLLHUP) &#123;</span><br><span class="line">           deviceChanged = <span class="literal">true</span>; <span class="comment">// å¦‚æœè®¾å¤‡èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚èµ·åˆ™å¸è½½æ­¤è®¾å¤‡</span></span><br><span class="line">           closeDeviceLocked(device);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123; ...... &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   ...... <span class="comment">// è¯»å–å¹¶å¤„ç†INotifyäº‹ä»¶</span></span><br><span class="line">    ......<span class="comment">// ç­‰å¾…æ–°çš„Epolläº‹ä»¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> event â€“ bufferï¼›&#125;</span><br></pre></td></tr></table></figure><p>getEvents()é€šè¿‡Epolläº‹ä»¶çš„data.u32å­—æ®µåœ¨mDevicesåˆ—è¡¨ä¸­æŸ¥æ‰¾å·²åŠ è½½çš„è®¾å¤‡ï¼Œå¹¶ä»è®¾å¤‡çš„æ–‡ä»¶æè¿°ç¬¦ä¸­è¯»å–åŸå§‹è¾“å…¥äº‹ä»¶åˆ—è¡¨ã€‚ä»æ–‡ä»¶æè¿°ç¬¦ä¸­è¯»å–çš„åŸå§‹è¾“å…¥äº‹ä»¶å­˜å‚¨åœ¨input_eventç»“æ„ä½“ä¸­ï¼Œè¿™ä¸ªç»“æ„ä½“çš„å››ä¸ªå­—æ®µå­˜å‚¨äº†äº‹ä»¶çš„äº‹ä»¶æˆ³ã€ç±»å‹ã€ä»£ç ä¸å€¼å››ä¸ªå…ƒç´ ã€‚ç„¶åé€ä¸€å°†input_eventçš„æ•°æ®è½¬å­˜åˆ°RawEventä¸­å¹¶ä¿å­˜è‡³bufferä»¥è¿”å›ç»™è°ƒç”¨è€…ã€‚</p><p>æ³¨æ„ä¸ºäº†å™è¿°ç®€å•ï¼Œä¸Šè¿°ä»£ç ä½¿ç”¨äº†è°ƒç”¨getEvents()çš„æ—¶é—´ä½œä¸ºè¾“å…¥äº‹ä»¶çš„æ—¶é—´æˆ³ã€‚ç”±äºè°ƒç”¨getEvents()å‡½æ•°çš„æ—¶æœºä¸ç”¨æˆ·æ“ä½œçš„æ—¶é—´å·®çš„å­˜åœ¨ï¼Œä¼šä½¿å¾—æ­¤æ—¶é—´æˆ³ä¸äº‹ä»¶çš„çœŸå®æ—¶é—´æœ‰æ‰€åå·®ã€‚ä»è®¾å¤‡èŠ‚ç‚¹ä¸­è¯»å–çš„input_eventä¸­ä¹ŸåŒ…å«äº†ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³æ¶ˆé™¤äº†getEvents()è°ƒç”¨æ‰€å¸¦æ¥çš„æ—¶é—´å·®ï¼Œå› æ­¤å¯ä»¥è·å¾—æ›´ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶ã€‚å¯ä»¥é€šè¿‡æ‰“å¼€HAVE_POSIX_CLOCKSå®ä»¥ä½¿ç”¨input_eventä¸­çš„æ—¶é—´è€Œä¸æ˜¯å°†getEvents()è°ƒç”¨çš„æ—¶é—´ä½œä¸ºè¾“å…¥äº‹ä»¶çš„æ—¶é—´æˆ³ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºEpolläº‹ä»¶çš„å¤„ç†ä¼˜å…ˆçº§ä½äºè®¾å¤‡å¢åˆ äº‹ä»¶ï¼Œå› æ­¤å½“å‘ç”Ÿè®¾å¤‡åŠ è½½ä¸å¸è½½åŠ¨ä½œæ—¶ï¼Œä¸ä¼šäº§ç”Ÿè®¾å¤‡è¾“å…¥äº‹ä»¶ã€‚å¦å¤–è¿˜éœ€æ³¨æ„ï¼Œåœ¨ä¸€ä¸ªç›‘å¬å‘¨æœŸä¸­ï¼ŒgetEvents()åœ¨å°†ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰åŸå§‹è¾“å…¥äº‹ä»¶è¯»å–å®Œæ¯•ä¹‹å‰ï¼Œä¸ä¼šè¯»å–å…¶ä»–è®¾å¤‡èŠ‚ç‚¹ä¸­çš„äº‹ä»¶ã€‚</p><h3 id="5ã€EventHubæ€»ç»“"><a href="#5ã€EventHubæ€»ç»“" class="headerlink" title="5ã€EventHubæ€»ç»“"></a>5ã€EventHubæ€»ç»“</h3><p>æœ¬èŠ‚é’ˆå¯¹EventHubçš„è®¾å¤‡ç®¡ç†ä¸åŸå§‹è¾“å…¥äº‹ä»¶çš„ç›‘å¬è¯»å–ä¸¤ä¸ªæ ¸å¿ƒå†…å®¹ä»‹ç»äº†EventHubçš„å·¥ä½œåŸç†ã€‚EventHubä½œä¸ºç›´æ¥æ“ä½œè®¾å¤‡èŠ‚ç‚¹çš„è¾“å…¥ç³»ç»Ÿç»„ä»¶ï¼Œéšè—äº†INotifyä¸Epollä»¥åŠè®¾å¤‡èŠ‚ç‚¹è¯»å–ç­‰åº•å±‚æ“ä½œï¼Œé€šè¿‡ä¸€ä¸ªç®€å•çš„æ¥å£getEvents()å‘ä½¿ç”¨è€…æä¾›æŠ½å–è®¾å¤‡äº‹ä»¶ä¸åŸå§‹è¾“å…¥äº‹ä»¶çš„åŠŸèƒ½ã€‚EventHubçš„æ ¸å¿ƒåŠŸèƒ½éƒ½åœ¨getEvents()å‡½æ•°ä¸­å®Œæˆï¼Œå› æ­¤æ·±å…¥ç†è§£getEvents()çš„å·¥ä½œåŸç†å¯¹äºæ·±å…¥ç†è§£EventHubè‡³å…³é‡è¦ã€‚</p><p>getEvents()å‡½æ•°çš„æœ¬è´¨æ˜¯é€šè¿‡epoll_wait()è·å–Epolläº‹ä»¶åˆ°äº‹ä»¶æ± ï¼Œå¹¶å¯¹äº‹ä»¶æ± ä¸­çš„äº‹ä»¶è¿›è¡Œæ¶ˆè´¹çš„è¿‡ç¨‹ã€‚ä»epoll_wait()çš„è°ƒç”¨å¼€å§‹åˆ°äº‹ä»¶æ± ä¸­æœ€åä¸€ä¸ªäº‹ä»¶è¢«æ¶ˆè´¹å®Œæ¯•çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºEventHubçš„ä¸€ä¸ªç›‘å¬å‘¨æœŸã€‚ç”±äºbufferå‚æ•°çš„å°ºå¯¸é™åˆ¶ï¼Œä¸€ä¸ªç›‘å¬å‘¨æœŸå¯èƒ½åŒ…å«å¤šä¸ªgetEvents()è°ƒç”¨ã€‚å‘¨æœŸä¸­çš„ç¬¬ä¸€ä¸ªgetEvents()è°ƒç”¨ä¸€å®šä¼šå› äº‹ä»¶æ± çš„æ¯ç«­è€Œç›´æ¥è¿›è¡Œepoll_wait()ï¼Œè€Œå‘¨æœŸä¸­çš„æœ€åä¸€ä¸ªgetEvents()ä¸€å®šä¼šå°†äº‹ä»¶æ± ä¸­çš„æœ€åä¸€æ¡äº‹ä»¶æ¶ˆè´¹å®Œæ¯•å¹¶å°†äº‹ä»¶è¿”å›ç»™è°ƒç”¨è€…ã€‚å‰æ–‡æ‰€è®¨è®ºçš„äº‹ä»¶ä¼˜å…ˆçº§éƒ½æ˜¯åœ¨åŒä¸€ä¸ªç›‘å¬å‘¨æœŸå†…è€Œè¨€çš„ã€‚</p><p>åœ¨æœ¬èŠ‚ä¸­å‡ºç°äº†å¾ˆå¤šç§äº‹ä»¶ï¼Œæœ‰åŸå§‹è¾“å…¥äº‹ä»¶ã€è®¾å¤‡å¢åˆ äº‹ä»¶ã€Epolläº‹ä»¶ã€INotifyäº‹ä»¶ç­‰ï¼Œå­˜å‚¨äº‹ä»¶çš„ç»“æ„ä½“æœ‰RawEventã€epoll_eventã€inotify_eventã€input_eventç­‰ã€‚å›¾5-6å¯ä»¥å¸®åŠ©è¯»è€…ç†æ¸…è¿™äº›äº‹ä»¶ä¹‹é—´çš„å…³ç³»ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N17-Android-Input-System-epoll.png" alt="Markdown"></p><p>å›¾ 5-6 EventHubçš„äº‹ä»¶å…³è”</p><p>å¦å¤–ï¼ŒgetEvents()å‡½æ•°è¿”å›çš„äº‹ä»¶åˆ—è¡¨ä¾ç…§äº‹ä»¶çš„ä¼˜å…ˆçº§æ‹¥æœ‰ç‰¹å®šçš„é¡ºåºã€‚å¹¶ä¸”åœ¨ä¸€ä¸ªç›‘å¬å‘¨æœŸä¸­ï¼ŒåŒä¸€è¾“å…¥è®¾å¤‡çš„è¾“å…¥äº‹ä»¶åœ¨åˆ—è¡¨ä¸­æ˜¯ç›¸é‚»çš„ã€‚</p><p>è‡³æ­¤ï¼Œç›¸ä¿¡è¯»è€…å¯¹EventHubçš„å·¥ä½œåŸç†ï¼Œä»¥åŠEventHubçš„äº‹ä»¶ç›‘å¬ä¸è¯»å–æœºåˆ¶æœ‰äº†æ·±å…¥çš„äº†è§£ã€‚æ¥ä¸‹æ¥çš„å†…å®¹å°†è®¨è®ºEventHubæ‰€æä¾›çš„åŸå§‹è¾“å…¥äº‹ä»¶å¦‚ä½•è¢«åŠ å·¥ä¸ºAndroidè¾“å…¥äº‹ä»¶ï¼Œè¿™ä¸ªåŠ å·¥è€…å°±æ˜¯Readerå­ç³»ç»Ÿä¸­çš„å¦ä¸€å‘˜å¤§å°†ï¼šInputReaderã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N18-Android-Input-System-EventHub-Kernel.png" alt="Markdown"></p><hr><h2 id="äº”ã€Input-Reader"><a href="#äº”ã€Input-Reader" class="headerlink" title="äº”ã€Input Reader"></a>äº”ã€Input Reader</h2><p>æ ¹æ®ç¬¬å››èŠ‚çš„åˆ†æã€‚è¾“å…¥è®¾å¤‡æ‰«æå®Œæˆï¼Œå¹¶åŠ å…¥epollä¸­ï¼Œç›‘å¬äº‹ä»¶ã€‚ä»å‰é¢çš„getEventså‡½æ•°åˆ†æå¾—çŸ¥ï¼Œå½“æŒ‰é”®äº‹ä»¶å‘ç”Ÿåï¼ŒgetEventså‡½æ•°è¿”å›ã€‚ è¿™é‡Œå†è´´ä¸€ä¸‹Input å¤„ç†æ—¶é—´æµç¨‹å›¾ï¼Œç„¶åæŒ‰æ­¥éª¤è¯¦ç»†åˆ†æã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N15-Android-Input-System-input-reader-thread.png" alt="Markdown"></p><p>ä»¥ä¸€æ¬¡é”®ç›˜æŒ‰é”®ä¸ºä¾‹ï¼Œå¾—åˆ°ä¸‹é¢çš„6ä¸ªäº‹ä»¶</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EventHub: /dev/input/event2 got: time=<span class="number">4383.680195</span>, type=<span class="number">4</span>, code=<span class="number">4</span>, value=<span class="number">458792</span></span><br><span class="line">EventHub: /dev/input/event2 got: time=<span class="number">4383.680195</span>, type=<span class="number">1</span>, code=<span class="number">28</span>, value=<span class="number">1</span></span><br><span class="line">EventHub: /dev/input/event2 got: time=<span class="number">4383.680195</span>, type=<span class="number">0</span>, code=<span class="number">0</span>, value=<span class="number">0</span></span><br><span class="line">EventHub: /dev/input/event2 got: time=<span class="number">4383.760186</span>, type=<span class="number">4</span>, code=<span class="number">4</span>, value=<span class="number">458792</span></span><br><span class="line">EventHub: /dev/input/event2 got: time=<span class="number">4383.760186</span>, type=<span class="number">1</span>, code=<span class="number">28</span>, value=<span class="number">0</span></span><br><span class="line">EventHub: /dev/input/event2 got: time=<span class="number">4383.760186</span>, type=<span class="number">0</span>, code=<span class="number">0</span>, value=<span class="number">0</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„typeæ˜¯linuxçš„è¾“å…¥ç³»ç»Ÿé‡Œçš„äº‹ä»¶ï¼Œå…·ä½“çš„å€¼å¯ä»¥æŸ¥çœ‹ æŸ¥çœ‹input.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* WARNING: DO NOT EDIT, AUTO-GENERATED CODE - SEE TOP FOR INSTRUCTIONS */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_SYN 0x00   åŒæ­¥äº‹ä»¶</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_KEY 0x01   æŒ‰é”®äº‹ä»¶</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_REL 0x02   ç›¸å¯¹åæ ‡</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_ABS 0x03   ç»å¯¹åæ ‡</span></span><br><span class="line"><span class="comment">/* WARNING: DO NOT EDIT, AUTO-GENERATED CODE - SEE TOP FOR INSTRUCTIONS */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_MSC 0x04   å…¶å®ƒ</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_SW  0x05   </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_LED 0x11   LED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_SND 0x12   å£°éŸ³</span></span><br><span class="line"><span class="comment">/* WARNING: DO NOT EDIT, AUTO-GENERATED CODE - SEE TOP FOR INSTRUCTIONS */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_REP 0x14   Repeat</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_FF  0x15   åŠ›åé¦ˆ</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_PWR 0x16   ç”µæº</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EV_FF_STATUS 0x17 çŠ¶æ€</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢6ä¸ªäº‹ä»¶ï¼Œåªæœ‰ä¸¤ä¸ªtypeä¸º1çš„äº‹ä»¶ï¼Œæ˜¯æˆ‘ä»¬éœ€è¦å¤„ç†çš„æŒ‰é”®äº‹ä»¶ï¼Œä¸€ä¸ªdownï¼Œä¸€ä¸ªup</p><h2 id="Step-1ã€-InputReader-loopOnce"><a href="#Step-1ã€-InputReader-loopOnce" class="headerlink" title="Step 1ã€ InputReader::loopOnce()"></a>Step 1ã€ InputReader::loopOnce()</h2><p>è¿”å›åˆ°InputReaderçš„loopOnceå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputReader::loopOnce() &#123;</span><br><span class="line">  <span class="keyword">size_t</span> count = mEventHub-&gt;getEvents(timeoutMillis, mEventBuffer, EVENT_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">  &#123; <span class="comment">// acquire lock</span></span><br><span class="line">      AutoMutex _l(mLock);</span><br><span class="line">      mReaderIsAliveCondition.broadcast();</span><br><span class="line">      <span class="comment">//å½“æœ‰æŒ‰é”®äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œcountå°†ä¸ä¸º0ï¼Œä»¥ä¸€æ¬¡æŒ‰é”®ä¸ºä¾‹ï¼Œè¿™é‡Œåº”è¯¥æ˜¯6ä¸ªäº‹ä»¶</span></span><br><span class="line">      <span class="keyword">if</span> (count) &#123;</span><br><span class="line">          processEventsLocked(mEventBuffer, count);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="comment">// release lock</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å½“æœ‰æŒ‰é”®äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œcountå°†ä¸ä¸º0ï¼Œä¹‹åä¼šè°ƒç”¨processEventsLockedæ¥å¤„ç†RawEventã€‚</p><h2 id="Step-2ã€InputReader-processEventsLocked"><a href="#Step-2ã€InputReader-processEventsLocked" class="headerlink" title="Step 2ã€InputReader.processEventsLocked()"></a>Step 2ã€InputReader.processEventsLocked()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputReader::processEventsLocked(<span class="keyword">const</span> RawEvent* rawEvents, <span class="keyword">size_t</span> count) &#123;</span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">const</span> RawEvent* rawEvent = rawEvents; count;) &#123;</span><br><span class="line">  <span class="keyword">int32_t</span> type = rawEvent-&gt;type;</span><br><span class="line">  <span class="keyword">size_t</span> batchSize = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (type &lt; EventHubInterface::FIRST_SYNTHETIC_EVENT) &#123;</span><br><span class="line">      <span class="keyword">int32_t</span> deviceId = rawEvent-&gt;deviceId;</span><br><span class="line">      <span class="comment">//ä¾æ¬¡å¤„ç†rawEvent</span></span><br><span class="line">      processEventsForDeviceLocked(deviceId, rawEvent, batchSize);</span><br><span class="line">  &#125;</span><br><span class="line">  count -= batchSize;</span><br><span class="line">  rawEvent += batchSize;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°è°ƒç”¨processEventsForDeviceLockedä¾æ¬¡å¤„ç†rawEvent</p><h2 id="Step-3ã€InputReader-processEventsForDeviceLocked"><a href="#Step-3ã€InputReader-processEventsForDeviceLocked" class="headerlink" title="Step 3ã€InputReader.processEventsForDeviceLocked()"></a>Step 3ã€InputReader.processEventsForDeviceLocked()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputReader::processEventsForDeviceLocked(<span class="keyword">int32_t</span> deviceId,</span><br><span class="line">      <span class="keyword">const</span> RawEvent* rawEvents, <span class="keyword">size_t</span> count) &#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> deviceIndex = mDevices.indexOfKey(deviceId);</span><br><span class="line">  InputDevice* device = mDevices.valueAt(deviceIndex);</span><br><span class="line">  <span class="comment">//è°ƒç”¨InputDeviceçš„processå‡½æ•°</span></span><br><span class="line">  device-&gt;process(rawEvents, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ ¹æ®deviceIdè·å–åˆ°InputDeviceï¼Œç„¶åè°ƒç”¨InputDeviceçš„processå‡½æ•°</p><h2 id="Step-4ã€InputDevice-process"><a href="#Step-4ã€InputDevice-process" class="headerlink" title="Step 4ã€InputDevice.process()"></a>Step 4ã€InputDevice.process()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDevice::process(<span class="keyword">const</span> RawEvent* rawEvents, <span class="keyword">size_t</span> count) &#123;</span><br><span class="line"><span class="keyword">size_t</span> numMappers = mMappers.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> RawEvent* rawEvent = rawEvents; count--; rawEvent++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mDropUntilNextSync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rawEvent-&gt;type == EV_SYN &amp;&amp; rawEvent-&gt;code == SYN_REPORT) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawEvent-&gt;type == EV_SYN &amp;&amp; rawEvent-&gt;code == SYN_DROPPED) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; numMappers; i++) &#123;    </span><br><span class="line">            InputMapper* mapper = mMappers[i];  </span><br><span class="line">            <span class="comment">// InputMapperæ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Œå®ƒæ˜¯ç”¨äºè§£æåŸå§‹è¾“å…¥äº‹ä»¶çš„ã€‚æ¯”å¦‚back, homeç­‰VirtualKeyï¼Œ</span></span><br><span class="line">            <span class="comment">// ä¼ ä¸Šæ¥æ—¶æ˜¯ä¸ªTouchäº‹ä»¶ï¼Œè¿™é‡Œè¦æ ¹æ®åæ ‡è½¬åŒ–ä¸ºç›¸åº”çš„æŒ‰é”®äº‹ä»¶ã€‚å†æ¯”å¦‚å¤šç‚¹è§¦æ‘¸æ—¶ï¼Œéœ€è¦è®¡ç®—</span></span><br><span class="line">            <span class="comment">// æ¯ä¸ªè§¦æ‘¸ç‚¹åˆ†åˆ«å±äºå“ªæ¡è½¨è¿¹ï¼Œå®‰å“ç³»ç»Ÿä¸­æ¯ç§è¾“å…¥è®¾å¤‡éƒ½å¯¹åº”äº†ä¸€ç§Mapper,æ¯”å¦‚</span></span><br><span class="line">            <span class="comment">// SwitchInputMapper, VibratorInputMapper,KeyBoardInputMapper</span></span><br><span class="line">            mapper-&gt;process(rawEvent);           </span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„mMappersæˆå‘˜å˜é‡ä¿å­˜äº†ä¸€ç³»åˆ—è¾“å…¥è®¾å¤‡äº‹ä»¶å¤„ç†å¯¹è±¡ï¼Œä¾‹å¦‚è´Ÿè´£å¤„ç†é”®ç›˜äº‹ä»¶çš„KeyboardKeyMapperå¯¹è±¡ä»¥åŠè´Ÿè´£å¤„ç†è§¦æ‘¸å±äº‹ä»¶çš„TouchInputMapperå¯¹è±¡ï¼Œ å®ƒä»¬æ˜¯åœ¨InputReaderç±»çš„æˆå‘˜å‡½æ•°createDeviceLockedä¸­åˆ›å»ºçš„ã€‚è¿™é‡ŒæŸ¥è¯¢æ¯ä¸€ä¸ªInputMapperå¯¹è±¡æ˜¯å¦è¦å¯¹å½“å‰å‘ç”Ÿçš„äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚ç”±äºå‘ç”Ÿçš„æ˜¯é”®ç›˜äº‹ä»¶ï¼ŒçœŸæ­£ä¼šå¯¹è¯¥äº‹ä»¶è¿›è¡Œå¤„ç†çš„åªæœ‰KeyboardKeyMapperå¯¹è±¡ã€‚</p><h2 id="Step-5ã€KeyboardInputMapper-process"><a href="#Step-5ã€KeyboardInputMapper-process" class="headerlink" title="Step 5ã€KeyboardInputMapper.process()"></a>Step 5ã€KeyboardInputMapper.process()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> KeyboardInputMapper::process(<span class="keyword">const</span> RawEvent* rawEvent) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (rawEvent-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">case</span> EV_KEY: &#123;</span><br><span class="line">        <span class="keyword">int32_t</span> scanCode = rawEvent-&gt;code;</span><br><span class="line">        <span class="keyword">int32_t</span> usageCode = mCurrentHidUsage;</span><br><span class="line">        mCurrentHidUsage = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isKeyboardOrGamepadKey(scanCode)) &#123;</span><br><span class="line">            <span class="keyword">int32_t</span> keyCode;</span><br><span class="line">            <span class="keyword">uint32_t</span> flags;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è°ƒç”¨EventHubä¸­çš„mapKeyå‡½æ•°è¿›è¡Œè½¬åŒ–</span></span><br><span class="line">            <span class="comment">// ä¼ å…¥å‚æ•°</span></span><br><span class="line">            <span class="comment">// scanCodeï¼šé©±åŠ¨ç¨‹åºä¸ŠæŠ¥çš„æ‰«æç ï¼›keyCodeï¼šè½¬åŒ–ä¹‹åçš„Androidä½¿ç”¨çš„æŒ‰é”®å€¼</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getEventHub()-&gt;mapKey(getDeviceId(), scanCode, usageCode, &amp;keyCode, &amp;flags)) &#123;</span><br><span class="line">                keyCode = AKEYCODE_UNKNOWN;</span><br><span class="line">                flags = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ˜ å°„æˆåŠŸä¹‹åï¼Œå¤„ç†è¯¥æŒ‰é”®</span></span><br><span class="line">            processKey(rawEvent-&gt;when, rawEvent-&gt;value != <span class="number">0</span>, keyCode, scanCode, flags);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> EV_MSC: &#123;</span><br><span class="line">        <span class="keyword">if</span> (rawEvent-&gt;code == MSC_SCAN) &#123;</span><br><span class="line">            mCurrentHidUsage = rawEvent-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> EV_SYN: &#123;</span><br><span class="line">        <span class="keyword">if</span> (rawEvent-&gt;code == SYN_REPORT) &#123;</span><br><span class="line">            mCurrentHidUsage = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°é¦–å…ˆè°ƒç”¨isKeyboardOrGamepadKeyæ¥åˆ¤æ–­é”®ç›˜æ‰«æç æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœæ­£ç¡®åˆ™è°ƒç”¨processKeyæ¥è¿›ä¸€æ­¥å¤„ç†</p><h2 id="Step-6ã€KeyboardInputMapper-processKey"><a href="#Step-6ã€KeyboardInputMapper-processKey" class="headerlink" title="Step 6ã€KeyboardInputMapper.processKey()"></a>Step 6ã€KeyboardInputMapper.processKey()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputReader.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> KeyboardInputMapper::processKey(<span class="keyword">nsecs_t</span> when, <span class="keyword">bool</span> down, <span class="keyword">int32_t</span> keyCode,</span><br><span class="line">        <span class="keyword">int32_t</span> scanCode, <span class="keyword">uint32_t</span> policyFlags) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®æ‰«æç scanCodeã€æŒ‰é”®ç keyCodeã€newMetaStateã€downTimeæŒ‰ä¸‹çš„æ—¶é—´è¿›è¡Œå¤„ç†    </span></span><br><span class="line">    <span class="comment">// NotifyKeyArgs args(when, getDeviceId(), mSource, policyFlags,</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    NotifyKeyArgs args(when, getDeviceId(), mSource, policyFlags,</span><br><span class="line">            down ? AKEY_EVENT_ACTION_DOWN : AKEY_EVENT_ACTION_UP,</span><br><span class="line">            AKEY_EVENT_FLAG_FROM_SYSTEM, keyCode, scanCode, newMetaState, downTime);</span><br><span class="line">     <span class="comment">// é€šçŸ¥Listenerå¤„ç†ï¼ŒDispatchçº¿ç¨‹ä¼šç›‘å¬è¯¥äº‹ä»¶ï¼Œå¹¶å¤„ç†ï¼Œä¸‹æ¬¡åšæ–‡ä¼šå…·ä½“åˆ†æ</span></span><br><span class="line">    getListener()-&gt;notifyKey(&amp;args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°é¦–å…ˆå¯¹æŒ‰é”®ä½œä¸€äº›å¤„ç†ï¼Œæ ¹æ®æ‰«æç scanCodeã€æŒ‰é”®ç keyCodeã€newMetaStateã€downTimeæŒ‰ä¸‹çš„æ—¶é—´è¿›è¡Œå¤„ç†</p><p>æœ€åå‡½æ•°ä¼šè°ƒç”¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NotifyKeyArgs args(when, getDeviceId(), mSource, policyFlags,</span><br><span class="line">            down ? AKEY_EVENT_ACTION_DOWN : AKEY_EVENT_ACTION_UP,</span><br><span class="line">            AKEY_EVENT_FLAG_FROM_SYSTEM, keyCode, scanCode, newMetaState, downTime);</span><br><span class="line"></span><br><span class="line">getListener()-&gt;notifyKey(&amp;args);</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒgetListeneræ˜¯InputReaderåˆå§‹åŒ–æ—¶ä¼ å…¥çš„å¯¹è±¡ï¼Œå³QueuedInputListenerï¼Œåˆ™ä¼šè°ƒç”¨QueuedInputListenerçš„notifyKeyå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QueuedInputListener::notifyKey(<span class="keyword">const</span> NotifyKeyArgs* args) &#123;</span><br><span class="line">mArgsQueue.push(<span class="keyword">new</span> NotifyKeyArgs(*args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>InputReaderçš„loopOnce()çš„ç»“å°¾ä¼šè°ƒç”¨QueuedInputListener::flush()ç»Ÿä¸€å›è°ƒç¼“å†²é˜Ÿåˆ—ä¸­å„å…ƒç´ çš„notify()æ¥å£ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QueuedInputListener::flush() &#123;</span><br><span class="line"><span class="keyword">size_t</span> count = mArgsQueue.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    NotifyArgs* args = mArgsQueue[i];</span><br><span class="line">    args-&gt;notify(mInnerListener);</span><br><span class="line">    <span class="keyword">delete</span> args;</span><br><span class="line">&#125;</span><br><span class="line">mArgsQueue.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥è°ƒç”¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NotifyConfigurationChangedArgs::notify(<span class="keyword">const</span> sp&lt;InputListenerInterface&gt;&amp; listener) <span class="keyword">const</span> &#123;</span><br><span class="line">listener-&gt;notifyConfigurationChanged(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥æŒ‰é”®äº‹ä»¶ä¸ºä¾‹ï¼Œç”±äºInputDispatcher å®ç°äº†InputListenerInterfaceæ¥å£çš„notifyConfigurationChanged()å‡½æ•°ï¼Œæ‰€ä»¥æœ€åä¼šè°ƒç”¨åˆ°InputDispatcherçš„notifyKey()å‡½æ•°ä¸­ã€‚</p><h2 id="Step-7ã€-InputDispatcher-notifyKey"><a href="#Step-7ã€-InputDispatcher-notifyKey" class="headerlink" title="Step 7ã€ InputDispatcher.notifyKey()"></a>Step 7ã€ InputDispatcher.notifyKey()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::notifyKey(<span class="keyword">const</span> NotifyKeyArgs* args) &#123;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="comment">// æ„é€ ä¸€ä¸ªKeyEventå¯¹è±¡</span></span><br><span class="line">KeyEvent event;</span><br><span class="line">event.initialize(args-&gt;deviceId, args-&gt;source, args-&gt;action,</span><br><span class="line">        flags, keyCode, args-&gt;scanCode, metaState, <span class="number">0</span>,</span><br><span class="line">        args-&gt;downTime, args-&gt;eventTime);</span><br><span class="line"><span class="comment">// è°ƒç”¨mPolicyçš„interceptKeyBeforeQueueingå‡½æ•°ï¼Œè¯¥å‡½æ•°æœ€åä¼šè°ƒç”¨åˆ°javaå±‚çš„PhoneWindowManagerServiceå‡½æ•°</span></span><br><span class="line">mPolicy-&gt;interceptKeyBeforeQueueing(&amp;event, <span class="comment">/*byref*/</span> policyFlags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> needWake;</span><br><span class="line">&#123; <span class="comment">// acquire lock</span></span><br><span class="line">    mLock.lock();</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//æ„é€ ä¸€ä¸ªKeyEntryå¯¹è±¡ï¼Œè°ƒç”¨enqueueInboundEventLockedå‡½æ•°å°†æŒ‰é”®äº‹ä»¶åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">    KeyEntry* newEntry = <span class="keyword">new</span> KeyEntry(args-&gt;eventTime,</span><br><span class="line">            args-&gt;deviceId, args-&gt;source, policyFlags,</span><br><span class="line">            args-&gt;action, flags, keyCode, args-&gt;scanCode,</span><br><span class="line">            metaState, repeatCount, args-&gt;downTime);</span><br><span class="line"></span><br><span class="line">    needWake = enqueueInboundEventLocked(newEntry);</span><br><span class="line">    mLock.unlock();</span><br><span class="line">&#125; <span class="comment">// release lock</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">    mLooper-&gt;wake();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°é¦–å…ˆè°ƒç”¨validateKeyEventæ¥åˆ¤æ–­æ˜¯å¦æ˜¯æœ‰æ•ˆæŒ‰é”®äº‹ä»¶ï¼Œå®é™…åˆ¤æ–­æ˜¯å¦æ˜¯UP/DOWNäº‹ä»¶</p><p>ç„¶åæ„é€ ä¸€ä¸ªKeyEventå¯¹è±¡ï¼Œè°ƒç”¨mPolicyçš„interceptKeyBeforeQueueingå‡½æ•°ï¼Œè¯¥å‡½æ•°æœ€åä¼šè°ƒç”¨åˆ°javaå±‚çš„PhoneWindowManagerServiceå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KeyEvent event;</span><br><span class="line">    event.initialize(args-&gt;deviceId, args-&gt;source, args-&gt;action,</span><br><span class="line">            flags, keyCode, args-&gt;scanCode, metaState, <span class="number">0</span>,</span><br><span class="line">            args-&gt;downTime, args-&gt;eventTime);</span><br><span class="line"></span><br><span class="line">    mPolicy-&gt;interceptKeyBeforeQueueing(&amp;event, <span class="comment">/*byref*/</span> policyFlags);</span><br></pre></td></tr></table></figure><p>ä¹‹åä¼šè°ƒç”¨æ„é€ ä¸€ä¸ªKeyEntryå¯¹è±¡ï¼Œè°ƒç”¨enqueueInboundEventLockedå‡½æ•°å°†æŒ‰é”®äº‹ä»¶åŠ å…¥é˜Ÿåˆ—ï¼Œå¦‚æœè¿”å›trueï¼Œåˆ™è°ƒç”¨mLooper.wakeå‡½æ•°å”¤é†’ç­‰å¾…çš„InputDispatcherï¼Œè¿›è¡ŒæŒ‰é”®åˆ†å‘ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KeyEntry* newEntry = <span class="keyword">new</span> KeyEntry(args-&gt;eventTime,</span><br><span class="line">                args-&gt;deviceId, args-&gt;source, policyFlags,</span><br><span class="line">                args-&gt;action, flags, keyCode, args-&gt;scanCode,</span><br><span class="line">                metaState, repeatCount, args-&gt;downTime);</span><br><span class="line"></span><br><span class="line">needWake = enqueueInboundEventLocked(newEntry);</span><br></pre></td></tr></table></figure><h2 id="Step-8ã€InputDispatcher-enqueueInboundEventLocked"><a href="#Step-8ã€InputDispatcher-enqueueInboundEventLocked" class="headerlink" title="Step 8ã€InputDispatcher.enqueueInboundEventLocked()"></a>Step 8ã€InputDispatcher.enqueueInboundEventLocked()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> InputDispatcher::enqueueInboundEventLocked(EventEntry* entry) &#123;</span><br><span class="line">    <span class="keyword">bool</span> needWake = mInboundQueue.isEmpty();</span><br><span class="line">    mInboundQueue.enqueueAtTail(entry);</span><br><span class="line">    traceInboundQueueLengthLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (entry-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">case</span> EventEntry::TYPE_KEY: &#123;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        KeyEntry* keyEntry = <span class="keyword">static_cast</span>&lt;KeyEntry*&gt;(entry);</span><br><span class="line">        <span class="keyword">if</span> (isAppSwitchKeyEventLocked(keyEntry)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (keyEntry-&gt;action == AKEY_EVENT_ACTION_DOWN) &#123;</span><br><span class="line">                mAppSwitchSawKeyDown = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyEntry-&gt;action == AKEY_EVENT_ACTION_UP) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mAppSwitchSawKeyDown) &#123;</span><br><span class="line">                    mAppSwitchDueTime = keyEntry-&gt;eventTime + APP_SWITCH_TIMEOUT;</span><br><span class="line">                    mAppSwitchSawKeyDown = <span class="literal">false</span>;</span><br><span class="line">                    needWake = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> needWake;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†EventEntryåŠ å…¥åˆ°mInboundQueueä¸­ï¼Œè¯¥å‡½æ•°ä¸¤ç§æƒ…å†µä¸‹ä¼šè¿”å›true,ä¸€æ˜¯å½“åŠ å…¥è¯¥é”®ç›˜äº‹ä»¶åˆ°mInboundQueueä¹‹å‰ï¼ŒmInboundQueueä¸ºç©ºï¼Œè¿™è¡¨ç¤ºInputDispatc herThreadçº¿ç¨‹æ­£åœ¨ç¡çœ ç­‰å¾…InputReaderThreadçº¿ç¨‹çš„å”¤é†’ï¼Œå› æ­¤ï¼Œå®ƒè¿”å›trueè¡¨ç¤ºè¦å”¤é†’InputDispatccherThreadçº¿ç¨‹ï¼›äºŒæ˜¯åŠ å…¥è¯¥é”®ç›˜äº‹ä»¶åˆ°mInboundQueueä¹‹å‰ï¼ŒmInboundQueueä¸ä¸ºç©ºï¼Œä½†æ˜¯æ­¤æ—¶ç”¨æˆ·æŒ‰ä¸‹çš„æ˜¯Homeé”®ç­‰éœ€è¦åˆ‡æ¢APPçš„æŒ‰é”®ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åˆ‡æ¢Appæ—¶ï¼Œæ–°çš„Appä¼šæŠŠå®ƒçš„é”®ç›˜æ¶ˆæ¯æ¥æ”¶é€šé“æ³¨å†Œåˆ°InputDispatcherä¸­å»ï¼Œå¹¶ä¸”ä¼šç­‰å¾…InputReaderçš„å”¤é†’ï¼Œå› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¹Ÿéœ€è¦è¿”å›trueï¼Œè¡¨ç¤ºè¦å”¤é†’InputDispatccherThreadçº¿ç¨‹ã€‚å¦‚æœä¸æ˜¯è¿™ä¸¤ç§æƒ…å†µï¼Œé‚£ä¹ˆå°±è¯´æ˜InputDispatccherThreadçº¿ç¨‹ç°åœ¨æ­£åœ¨å¤„ç†å‰é¢çš„é”®ç›˜äº‹ä»¶ï¼Œä¸éœ€è¦å”¤é†’å®ƒã€‚</p><p>è‡³æ­¤ï¼ŒInputDispatcherThreadè¢«å”¤é†’ï¼Œå¼€å§‹è¿›è¡ŒæŒ‰é”®åˆ†å‘ã€‚</p><h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>InputReaderThreadä¸æ–­è°ƒç”¨InputReaderçš„pollOnce()-&gt;getEvents()å‡½æ•°æ¥å¾—åˆ°äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯ä»¥æ˜¯è¾“å…¥äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”±inotifyç›‘æµ‹åˆ°è®¾å¤‡å¢å‡å˜æ›´æ‰€è§¦å‘çš„äº‹ä»¶ã€‚ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶ä¼šæ‰«æ/dev/inputç›®å½•å»ºç«‹è®¾å¤‡åˆ—è¡¨ï¼Œå­˜åœ¨mDeviceæˆå‘˜å˜é‡ä¸­(EventHubä¸­æœ‰è®¾å¤‡åˆ—è¡¨KeyedVector</p><p><int32_t , device*="">mDevicesï¼›å¯¹åº”çš„ï¼ŒInputReaderä¸­ä¹Ÿæœ‰è®¾å¤‡åˆ—è¡¨KeyedVector<int32_t , inputdevice*="">mDevicesã€‚è¿™é‡Œå…ˆæ·»åŠ åˆ°å‰è€…ï¼Œç„¶åä¼šåœ¨InputReader::addDeviceLocked()ä¸­æ·»åŠ åˆ°åè€…ã€‚)ï¼ŒåŒæ—¶å°†å¢åŠ çš„fdåŠ åˆ°epollçš„ç­‰å¾…é›†åˆä¸­ã€‚åœ¨æ¥ä¸‹æ¥çš„epoll_wait()ç­‰å¾…æ—¶ï¼Œå¦‚æœæœ‰äº‹ä»¶å°±ä¼šè¿”å›ï¼ŒåŒæ—¶è¿”å›å¯è¯»äº‹ä»¶æ•°é‡ã€‚åœ¨è¿™é‡Œï¼Œä»Input driverè¯»å‡ºçš„äº‹ä»¶ä»åŸå§‹çš„input_eventç»“æ„è½¬ä¸ºRawEventç»“æ„ï¼Œæ”¾åˆ°getEvents()çš„è¾“å‡ºå‚æ•°bufferä¸­ã€‚getEvents()è¿”å›åï¼ŒInputReaderè°ƒç”¨processEventsLocked()å¤„ç†äº‹ä»¶ï¼Œå¯¹äºè®¾å¤‡æ”¹å˜ï¼Œä¼šæ ¹æ®å®é™…æƒ…å†µè°ƒç”¨addDeviceLocked(), removeDeviceLocked()å’ŒhandleConfigurationChangedLocked()ã€‚å¯¹äºå…¶å®ƒè®¾å¤‡ä¸­æ¥çš„è¾“å…¥äº‹ä»¶ï¼Œä¼šè°ƒç”¨processEventsForDeviceLocked()è¿›ä¸€æ­¥å¤„ç†ã€‚å…¶ä¸­ä¼šæ ¹æ®å½“æ—¶æ³¨å†Œçš„InputMapperå¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œç„¶åå°†äº‹ä»¶å¤„ç†è¯·æ±‚æ”¾å…¥ç¼“å†²é˜Ÿåˆ—ï¼ˆQueuedInputListenerä¸­çš„mArgsQueueï¼‰ã€‚</int32_t></int32_t></p><p>InputMapperæ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Œå®ƒæ˜¯ç”¨äºè§£æåŸå§‹è¾“å…¥äº‹ä»¶çš„ã€‚æ¯”å¦‚back, homeç­‰VirtualKeyï¼Œä¼ ä¸Šæ¥æ—¶æ˜¯ä¸ªTouchäº‹ä»¶ï¼Œè¿™é‡Œè¦æ ¹æ®åæ ‡è½¬åŒ–ä¸ºç›¸åº”çš„æŒ‰é”®äº‹ä»¶ã€‚å†æ¯”å¦‚å¤šç‚¹è§¦æ‘¸æ—¶ï¼Œéœ€è¦è®¡ç®—æ¯ä¸ªè§¦æ‘¸ç‚¹åˆ†åˆ«å±äºå“ªæ¡è½¨è¿¹ï¼Œè¿™æœ¬è´¨ä¸Šæ˜¯ä¸ªäºŒåˆ†å›¾åŒ¹é…é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯åœ¨InputMapperä¸­å®Œæˆçš„ã€‚å›åˆ°æµç¨‹ä¸»çº¿ä¸Šï¼Œåœ¨InputReaderçš„loopOnce()çš„ç»“å°¾ä¼šè°ƒç”¨QueuedInputListener::flush()ç»Ÿä¸€å›è°ƒç¼“å†²é˜Ÿåˆ—ä¸­å„å…ƒç´ çš„notify()æ¥å£ã€‚</p><p>ä»¥æŒ‰é”®äº‹ä»¶ä¸ºä¾‹ï¼Œæœ€åä¼šè°ƒç”¨åˆ°InputDispatcherçš„notifyKey()å‡½æ•°ä¸­ã€‚è¿™é‡Œå…ˆå°†å‚æ•°å°è£…æˆKeyEventï¼š ç„¶åæŠŠå®ƒä½œä¸ºå‚æ•°è°ƒç”¨NativeInputManagerçš„interceptKeyBeforeQueueing()å‡½æ•°ã€‚é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨æ”¾åˆ°å¾…å¤„ç†é˜Ÿåˆ—å‰çœ‹çœ‹æ˜¯ä¸æ˜¯éœ€è¦ç³»ç»Ÿå¤„ç†çš„ç³»ç»ŸæŒ‰é”®ï¼Œå®ƒä¼šé€šè¿‡JNIè°ƒå›Javaä¸–ç•Œï¼Œæœ€ç»ˆè°ƒåˆ°PhoneWindowManagerçš„interceptKeyBeforeQueueing()ã€‚ç„¶åï¼ŒåŸºäºè¾“å…¥äº‹ä»¶ä¿¡æ¯åˆ›å»ºKeyEntryå¯¹è±¡ï¼Œè°ƒç”¨enqueueInboundEventLocked()å°†ä¹‹æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…InputDiaptcherThreadçº¿ç¨‹æ‹¿å‡ºå¤„ç†ã€‚</p><h2 id="å…­ã€Input-Dispatcher"><a href="#å…­ã€Input-Dispatcher" class="headerlink" title="å…­ã€Input Dispatcher"></a>å…­ã€Input Dispatcher</h2><p>InputDisptacherçš„ä¸»è¦ä»»åŠ¡æ˜¯æŠŠå‰é¢æ”¶åˆ°çš„è¾“å…¥äº‹ä»¶å‘é€åˆ°PWMåŠAppç«¯çš„ç„¦ç‚¹çª—å£ã€‚å‰é¢æåˆ°InputReaderThreadä¸­æ”¶åˆ°äº‹ä»¶åä¼šè°ƒç”¨notifyKey()æ¥é€šçŸ¥InputDispatcherï¼Œä¹Ÿå°±æ˜¯æ”¾åœ¨mInboundQueueä¸­ï¼Œåœ¨InputDispatcherçš„dispatchOnce()å‡½æ•°ä¸­ï¼Œä¼šä»è¿™ä¸ªé˜Ÿåˆ—æ‹¿å‡ºå¤„ç†ã€‚</p><p>å…¶ä¸­dispatchOnceInnerLocked()ä¼šæ ¹æ®æ‹¿å‡ºçš„EventEntryç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œä»¥Keyäº‹ä»¶ä¸ºä¾‹ä¼šè°ƒç”¨dispatchKeyLocked()</p><p>å®ƒä¼šæ‰¾åˆ°ç›®æ ‡çª—å£ï¼Œç„¶åé€šè¿‡ä¹‹å‰å’ŒAppé—´å»ºç«‹çš„è¿æ¥å‘é€äº‹ä»¶ã€‚å¦‚æœæ˜¯ä¸ªéœ€è¦ç³»ç»Ÿå¤„ç†çš„Keyäº‹ä»¶ï¼Œè¿™é‡Œä¼šå°è£…æˆCommandEntryæ’å…¥åˆ°mCommandQueueé˜Ÿåˆ—ä¸­ï¼Œåé¢çš„runCommandLockedInterruptible()å‡½æ•°ä¸­ä¼šè°ƒç”¨doInterceptKeyBeforeDispatchingLockedInterruptible()æ¥è®©PWMæœ‰æœºä¼šè¿›è¡Œå¤„ç†ã€‚æœ€ådispatchOnce()è°ƒç”¨pollOnce()ä»å’ŒAppçš„è¿æ¥ä¸Šæ¥æ”¶å¤„ç†å®Œæˆæ¶ˆæ¯ã€‚é‚£ä¹ˆï¼ŒInputDispatcheræ˜¯æ€ä¹ˆç¡®å®šè¦å¾€å“ªä¸ªçª—å£ä¸­å‘äº‹ä»¶å‘¢ï¼Ÿè¿™é‡Œçš„æˆå‘˜å˜é‡mFocusedWindowHandleæŒ‡ç¤ºäº†ç„¦ç‚¹çª—å£ï¼Œç„¶åfindFocusedWindowTargetsLocked()ä¼šè°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°ï¼ˆhandleTargetsNotReadyLocked(), checkInjectionPermission(), checkWindowReadyForMoreInputLocked()ç­‰ï¼‰æ£€æŸ¥mFocusedWindowHandleæ˜¯å¦èƒ½æ¥æ”¶è¾“å…¥äº‹ä»¶ã€‚å¦‚æœå¯ä»¥ï¼Œå°†ä¹‹ä»¥InputTargetçš„å½¢å¼åŠ åˆ°ç›®æ ‡çª—å£æ•°ç»„ä¸­ã€‚ç„¶åå°±ä¼šè°ƒç”¨dispatchEventLocked()è¿›è¡Œå‘é€ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªmFocusedWindowHandleæ˜¯å¦‚ä½•ç»´æŠ¤çš„å‘¢ï¼Ÿä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œè¿™é‡Œå›å¤´åˆ†æä¸‹çª—å£è¿æ¥çš„ç®¡ç†åŠç„¦ç‚¹çª—å£çš„ç®¡ç†ã€‚ æ€»ä½“æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N19-Android-Input-System-InputDispatcher-structure.png" alt="Markdown"></p><p>å†è´´ä¸€å¼ è¯¦ç»†çš„æ€»ä½“æµç¨‹å›¾ï¼Œç„¶åæ ¹æ®æ­¥éª¤è¯¦ç»†åˆ†æï¼›</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N20-Android-Input-System-input-dispatcher-thread.png" alt="Markdown"></p><h2 id="Step-1ã€InputDispatcher-dispatchOnce"><a href="#Step-1ã€InputDispatcher-dispatchOnce" class="headerlink" title="Step 1ã€InputDispatcher.dispatchOnce()"></a>Step 1ã€InputDispatcher.dispatchOnce()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::dispatchOnce() &#123;</span><br><span class="line"><span class="keyword">nsecs_t</span> nextWakeupTime = LONG_LONG_MAX;</span><br><span class="line">&#123; <span class="comment">// acquire lock</span></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line">    mDispatcherIsAliveCondition.broadcast();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run a dispatch loop if there are no pending commands.</span></span><br><span class="line">    <span class="comment">// The dispatch loop might enqueue commands to run afterwards.</span></span><br><span class="line">    <span class="keyword">if</span> (!haveCommandsLocked()) &#123;</span><br><span class="line">        dispatchOnceInnerLocked(&amp;nextWakeupTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run all pending commands if there are any.</span></span><br><span class="line">    <span class="comment">// If any commands were run then force the next poll to wake up immediately.</span></span><br><span class="line">    <span class="keyword">if</span> (runCommandsLockedInterruptible()) &#123;</span><br><span class="line">        nextWakeupTime = LONG_LONG_MIN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">// release lock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait for callback or timeout or wake.  (make sure we round up, not down)</span></span><br><span class="line"><span class="keyword">nsecs_t</span> currentTime = now();</span><br><span class="line"><span class="keyword">int</span> timeoutMillis = toMillisecondTimeoutDelay(currentTime, nextWakeupTime);</span><br><span class="line">mLooper-&gt;pollOnce(timeoutMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å‡½æ•°ä¸»è¦æ˜¯è°ƒç”¨dispatchOnceInnerLockedæ¥è¿›è¡Œä¸€æ¬¡æŒ‰é”®åˆ†å‘ï¼Œå½“æ²¡æœ‰æŒ‰é”®æ¶ˆæ¯æ—¶ä¼šèµ°åˆ°mLooper-&gt;pollOnce(timeoutMillis);è¿™ä¸ªå‡½æ•°ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå½“æœ‰æŒ‰é”®æ¶ˆæ¯å‘ç”Ÿæ—¶è¯¥å‡½æ•°ä¼šè¿”å›ï¼Œç„¶åèµ°åˆ°dispatchOnceInnerLockedå‡½æ•°ã€‚</p><h2 id="Step-2ã€InputDispatcher-dispatchOnceInnerLocked"><a href="#Step-2ã€InputDispatcher-dispatchOnceInnerLocked" class="headerlink" title="Step 2ã€InputDispatcher.dispatchOnceInnerLocked()"></a>Step 2ã€InputDispatcher.dispatchOnceInnerLocked()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::dispatchOnceInnerLocked(<span class="keyword">nsecs_t</span>* nextWakeupTime) &#123;</span><br><span class="line">    <span class="keyword">nsecs_t</span> currentTime = now();</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Ready to start a new event.</span></span><br><span class="line">    <span class="comment">// If we don't already have a pending event, go grab one.</span></span><br><span class="line">    <span class="keyword">if</span> (! mPendingEvent) &#123;</span><br><span class="line">        <span class="comment">//å½“InputReaderå¾€é˜Ÿåˆ—ä¸­æ’å…¥äº†ä¸€ä¸ªè¯»å–çš„é”®ç›˜æ¶ˆæ¯åï¼Œæ­¤å¤„çš„mInboundQueueå°±ä¸ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (mInboundQueue.isEmpty()) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Inbound queue has at least one entry.</span></span><br><span class="line">            mPendingEvent = mInboundQueue.dequeueAtHead();</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (mPendingEvent-&gt;type) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">case</span> EventEntry::TYPE_KEY: &#123;</span><br><span class="line"></span><br><span class="line">        KeyEntry* typedEntry = <span class="keyword">static_cast</span>&lt;KeyEntry*&gt;(mPendingEvent);</span><br><span class="line">        ...</span><br><span class="line">        done = dispatchKeyLocked(currentTime, typedEntry, &amp;dropReason, nextWakeupTime);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (done) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dropReason != DROP_REASON_NOT_DROPPED) &#123;</span><br><span class="line">            dropInboundEventLocked(mPendingEvent, dropReason);</span><br><span class="line">        &#125;</span><br><span class="line">        mLastDropReason = dropReason;</span><br><span class="line"></span><br><span class="line">        releasePendingEventLocked();</span><br><span class="line">        *nextWakeupTime = LONG_LONG_MIN;  <span class="comment">// force next poll to wake up immediately</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»å‰æ–‡InputReaderè¯»å–é”®ç›˜æ¶ˆæ¯è¿‡ç¨‹åˆ†æ InputReaderè¯»å–åˆ°ä¸€ä¸ªæ¶ˆæ¯åä¼šè°ƒç”¨KeyboardInputMapperçš„processKeyï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨InputDispatcherçš„notifyKeyå‡½æ•°ï¼Œç„¶åInputDispatcherä¼šè°ƒç”¨enqueueInboundEventLockedå‡½æ•°ï¼Œå°†EventEntryåŠ å…¥åˆ°mInboundQueueä¸­ï¼Œç„¶åè°ƒç”¨mLooper-&gt;wakeå‡½æ•°ä¼šå”¤é†’InputDispatcherThreadçº¿ç¨‹ï¼ŒInputDispatcherä¸­æŠŠé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªäº‹ä»¶å–å‡ºæ¥ï¼Œå› ä¸ºè¿™é‡Œæ˜¯é”®ç›˜äº‹ä»¶ï¼Œæ‰€ä»¥mPendingEvent-&gt;typeæ˜¯EventEntry::TYPE_KEYï¼Œç„¶åè°ƒç”¨dispatchKeyLockedå‡½æ•°</p><p>æƒ¯ä¾‹å…ˆè´´å‡ºåºåˆ—å›¾ï¼ŒæŒ‰æ­¥éª¤ä¸€æ­¥æ­¥ä»‹ç»ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N21-Android-Input-System-dispatch-input-event.png" alt="Markdown"></p><h2 id="Step-3ã€InputDispatcher-dispatchKeyLocked"><a href="#Step-3ã€InputDispatcher-dispatchKeyLocked" class="headerlink" title="Step 3ã€InputDispatcher.dispatchKeyLocked()"></a>Step 3ã€InputDispatcher.dispatchKeyLocked()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> InputDispatcher::dispatchKeyLocked(<span class="keyword">nsecs_t</span> currentTime, KeyEntry* entry,</span><br><span class="line">        DropReason* dropReason, <span class="keyword">nsecs_t</span>* nextWakeupTime) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Give the policy a chance to intercept the key.</span></span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;interceptKeyResult == KeyEntry::INTERCEPT_KEY_RESULT_UNKNOWN) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry-&gt;policyFlags &amp; POLICY_FLAG_PASS_TO_USER) &#123;</span><br><span class="line">            CommandEntry* commandEntry = postCommandLocked(</span><br><span class="line">                    &amp; InputDispatcher::doInterceptKeyBeforeDispatchingLockedInterruptible);</span><br><span class="line">            <span class="keyword">if</span> (mFocusedWindowHandle != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                commandEntry-&gt;inputWindowHandle = mFocusedWindowHandle;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            entry-&gt;interceptKeyResult = KeyEntry::INTERCEPT_KEY_RESULT_CONTINUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; ......</span><br><span class="line">    <span class="comment">// Identify targets.</span></span><br><span class="line">    Vector&lt;InputTarget&gt; inputTargets;</span><br><span class="line">    <span class="keyword">int32_t</span> injectionResult = findFocusedWindowTargetsLocked(currentTime,</span><br><span class="line">            entry, inputTargets, nextWakeupTime);</span><br><span class="line">    ......</span><br><span class="line">    setInjectionResultLocked(entry, injectionResult);</span><br><span class="line">    ......</span><br><span class="line">    addMonitoringTargetsLocked(inputTargets);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dispatch the key.</span></span><br><span class="line">    dispatchEventLocked(currentTime, entry, inputTargets);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸»è¦åšäº†ä¸‹é¢ä¸‰ä»¶äº‹ A. å¦‚æœæŒ‰é”®æ˜¯ç¬¬ä¸€æ¬¡åˆ†å‘ï¼Œåˆ™å°†å‘½ä»¤å°è£…ä¸ºCommandEntryåŠ å…¥é˜Ÿåˆ—ï¼Œåç»­æ‰§è¡ŒdoInterceptKeyBeforeDispatchingLockedInterruptibleï¼Œä»¥ç»™javaå±‚æ‹¦æˆªæŒ‰é”®çš„æœºä¼š B. æ‰¾åˆ°å½“å‰æ¿€æ´»çš„Windowçª—å£ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°Vectorä¸­ï¼ŒAndroid ANRå°±æ˜¯åœ¨findFocusedWindowTargetsLocked()æ£€æµ‹çš„ C. æ‰¾åˆ°éœ€è¦ä¸»åŠ¨ç›‘å¬æŒ‰é”®çš„InputChannel,å°è£…æˆInputTargetï¼ŒåŠ å…¥åˆ°Vectorä¸­ D. å°†æŒ‰é”®åˆ†å‘åˆ°ä¸Šé¢çš„Vectorä¸­çš„InputChannelä¸­ï¼Œè¿™é‡Œå­˜åœ¨å¤šä¸ª</p><p>ä¸‹é¢å…ˆåˆ†æå¦‚æœå°†æŒ‰é”®åˆ†å‘ç»™InputChannel</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::dispatchEventLocked(<span class="keyword">nsecs_t</span> currentTime,</span><br><span class="line">    EventEntry* eventEntry, <span class="keyword">const</span> Vector&lt;InputTarget&gt;&amp; inputTargets) &#123;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; inputTargets.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> InputTarget&amp; inputTarget = inputTargets.itemAt(i);</span><br><span class="line">    <span class="keyword">ssize_t</span> connectionIndex = getConnectionIndexLocked(inputTarget.inputChannel);</span><br><span class="line">    <span class="keyword">if</span> (connectionIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        sp&lt;Connection&gt; connection = mConnectionsByFd.valueAt(connectionIndex);</span><br><span class="line">        prepareDispatchCycleLocked(currentTime, connection, eventEntry, &amp;inputTarget);</span><br><span class="line">      &#125; ......</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Step-5ã€InputDispatcher-prepareDispatchCycleLocked"><a href="#Step-5ã€InputDispatcher-prepareDispatchCycleLocked" class="headerlink" title="Step 5ã€InputDispatcher.prepareDispatchCycleLocked()"></a>Step 5ã€InputDispatcher.prepareDispatchCycleLocked()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::prepareDispatchCycleLocked(<span class="keyword">nsecs_t</span> currentTime,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Connection&gt;&amp; connection, EventEntry* eventEntry, <span class="keyword">const</span> InputTarget* inputTarget) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Not splitting.  Enqueue dispatch entries for the event as is.</span></span><br><span class="line">    enqueueDispatchEntriesLocked(currentTime, connection, eventEntry, inputTarget);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‰é¢è¿˜æœ‰ä¸€äº›çŠ¶æ€æ£€æŸ¥ï¼Œè¿™é‡Œé»˜è®¤éƒ½æ˜¯é€šè¿‡çš„ã€‚æœ€åenqueueDispatchEntriesLockedå‡½æ•°è¿›è¡Œå°†connectionåˆ†è£…æˆDispatchEntryï¼ŒåŠ å…¥åˆ°connection-&gt;outboundQueueçš„é˜Ÿåˆ—ä¸­</p><h2 id="Step-6-InputDispatcher-enqueueDispatchEntriesLocked"><a href="#Step-6-InputDispatcher-enqueueDispatchEntriesLocked" class="headerlink" title="Step 6. InputDispatcher::enqueueDispatchEntriesLocked()"></a>Step 6. InputDispatcher::enqueueDispatchEntriesLocked()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::enqueueDispatchEntriesLocked(<span class="keyword">nsecs_t</span> currentTime,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Connection&gt;&amp; connection, EventEntry* eventEntry, <span class="keyword">const</span> InputTarget* inputTarget) &#123;</span><br><span class="line">    <span class="keyword">bool</span> wasEmpty = connection-&gt;outboundQueue.isEmpty();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enqueue dispatch entries for the requested modes.</span></span><br><span class="line">    enqueueDispatchEntryLocked(connection, eventEntry, inputTarget,</span><br><span class="line">            InputTarget::FLAG_DISPATCH_AS_HOVER_EXIT);</span><br><span class="line">    ......</span><br><span class="line">    enqueueDispatchEntryLocked(connection, eventEntry, inputTarget,</span><br><span class="line">            InputTarget::FLAG_DISPATCH_AS_SLIPPERY_ENTER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the outbound queue was previously empty, start the dispatch cycle going.</span></span><br><span class="line">    <span class="keyword">if</span> (wasEmpty &amp;&amp; !connection-&gt;outboundQueue.isEmpty()) &#123;</span><br><span class="line">        startDispatchCycleLocked(currentTime, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°é¦–å…ˆè·å–ä»¥å‰çš„connectionçš„outboundQueueæ˜¯å¦ä¸ºç©ºï¼Œç„¶åå°†è¯¥äº‹ä»¶è°ƒç”¨enqueueDispatchEntryLockedå°†äº‹ä»¶åŠ å…¥åˆ°outboundQueueä¸­ï¼Œå¦‚æœä»¥å‰ä¸ºç©ºï¼Œç°åœ¨ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨startDispatchCycleLockedå¼€å§‹åˆ†å‘ï¼Œå¦‚æœä»¥å‰çš„outboundQueueä¸ä¸ºç©ºï¼Œè¯´æ˜å½“å‰çš„Activityæ­£åœ¨å¤„ç†å‰é¢çš„æŒ‰é”®ï¼Œåˆ™ä¸éœ€è¦å†è°ƒç”¨startDispatchCycleLockedï¼Œå› ä¸ºåªè¦å¼€å§‹å¤„ç†ï¼Œä¼šç­‰åˆ°é˜Ÿåˆ—ä¸ºç©ºæ‰ä¼šåœæ­¢ã€‚</p><h2 id="Step-7ã€InputDispatcher-startDispatchCycleLocked"><a href="#Step-7ã€InputDispatcher-startDispatchCycleLocked" class="headerlink" title="Step 7ã€InputDispatcher.startDispatchCycleLocked()"></a>Step 7ã€InputDispatcher.startDispatchCycleLocked()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::startDispatchCycleLocked(<span class="keyword">nsecs_t</span> currentTime,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Connection&gt;&amp; connection) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (connection-&gt;status == Connection::STATUS_NORMAL</span><br><span class="line">            &amp;&amp; !connection-&gt;outboundQueue.isEmpty()) &#123;</span><br><span class="line">        DispatchEntry* dispatchEntry = connection-&gt;outboundQueue.head;</span><br><span class="line">        dispatchEntry-&gt;deliveryTime = currentTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Publish the event.</span></span><br><span class="line">        <span class="keyword">status_t</span> status;</span><br><span class="line">        EventEntry* eventEntry = dispatchEntry-&gt;eventEntry;</span><br><span class="line">        <span class="keyword">switch</span> (eventEntry-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> EventEntry::TYPE_KEY: &#123;</span><br><span class="line">            KeyEntry* keyEntry = <span class="keyword">static_cast</span>&lt;KeyEntry*&gt;(eventEntry);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Publish the key event.</span></span><br><span class="line">            status = connection-&gt;inputPublisher.publishKeyEvent(dispatchEntry-&gt;seq,</span><br><span class="line">                    keyEntry-&gt;deviceId, keyEntry-&gt;source,</span><br><span class="line">                    dispatchEntry-&gt;resolvedAction, dispatchEntry-&gt;resolvedFlags,</span><br><span class="line">                    keyEntry-&gt;keyCode, keyEntry-&gt;scanCode,</span><br><span class="line">                    keyEntry-&gt;metaState, keyEntry-&gt;repeatCount, keyEntry-&gt;downTime,</span><br><span class="line">                    keyEntry-&gt;eventTime);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Re-enqueue the event on the wait queue.</span></span><br><span class="line">        connection-&gt;outboundQueue.dequeue(dispatchEntry);</span><br><span class="line">        traceOutboundQueueLengthLocked(connection);</span><br><span class="line">        connection-&gt;waitQueue.enqueueAtTail(dispatchEntry);</span><br><span class="line">        traceWaitQueueLengthLocked(connection);</span><br><span class="line">        &#125;<span class="comment">//end of while</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä»outboundQueueä¸­å–å‡ºéœ€è¦å¤„ç†çš„é”®ç›˜äº‹ä»¶ï¼Œäº¤ç»™connectionçš„inputPublisherå»åˆ†å‘ï¼Œä¹‹åå°†äº‹ä»¶åŠ å…¥åˆ°connectionçš„waitQueueä¸­ã€‚åˆ†å‘äº‹ä»¶æ˜¯é€šè¿‡InputPublisherçš„publishKeyEventæ¥å®Œæˆçš„ã€‚</p><h2 id="Step-8ã€InputPublisher-publishKeyEvent"><a href="#Step-8ã€InputPublisher-publishKeyEvent" class="headerlink" title="Step 8ã€InputPublisher.publishKeyEvent"></a>Step 8ã€InputPublisher.publishKeyEvent</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/libs/input/InputTransport.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> InputPublisher::publishKeyEvent(</span><br><span class="line">        <span class="keyword">uint32_t</span> seq,<span class="keyword">int32_t</span> deviceId,<span class="keyword">int32_t</span> source,</span><br><span class="line">        <span class="keyword">int32_t</span> action,<span class="keyword">int32_t</span> flags,<span class="keyword">int32_t</span> keyCode,</span><br><span class="line">        <span class="keyword">int32_t</span> scanCode,<span class="keyword">int32_t</span> metaState,<span class="keyword">int32_t</span> repeatCount,</span><br><span class="line">        <span class="keyword">nsecs_t</span> downTime,<span class="keyword">nsecs_t</span> eventTime) &#123;</span><br><span class="line"></span><br><span class="line">    InputMessage msg;</span><br><span class="line">    msg.header.type = InputMessage::TYPE_KEY;</span><br><span class="line">    ......</span><br><span class="line">    msg.body.key.eventTime = eventTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mChannel-&gt;sendMessage(&amp;msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æ˜¯å°†å„ä¸ªå‚æ•°å°è£…åˆ°InputMessageä¸­ï¼Œç„¶åäº¤ç»™mChannelå¯¹è±¡å»åˆ†å‘ mChannelå…¶å®æ˜¯socketpairçš„serverç«¯ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºçš„æœåŠ¡å™¨InputChannelï¼Œå…¶åˆ›å»ºè¿‡ç¨‹ç¨åè¯¦ç»†åˆ†æã€‚</p><h2 id="Step-9ã€InputChannel-sendMessage"><a href="#Step-9ã€InputChannel-sendMessage" class="headerlink" title="Step 9ã€InputChannel.sendMessage()"></a>Step 9ã€InputChannel.sendMessage()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/libs/input/InputTransport.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> InputChannel::sendMessage(<span class="keyword">const</span> InputMessage* msg) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> msgLength = msg-&gt;size();</span><br><span class="line">    <span class="keyword">ssize_t</span> nWrite;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        nWrite = ::send(mFd, msg, msgLength, MSG_DONTWAIT | MSG_NOSIGNAL);</span><br><span class="line">    &#125; <span class="keyword">while</span> (nWrite == <span class="number">-1</span> &amp;&amp; errno == EINTR);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æ˜¯é€šè¿‡sendå‡½æ•°å¾€socketpairçš„serverç«¯å†™å…¥InputMessageå¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºè¿™ä¸€ä¾§æ­£ç¡çœ åœ¨clientç«¯çš„fdä¸Šï¼Œæ­¤æ—¶clientç«¯å°±ä¼šæ”¶åˆ°è¯¥InputMessageï¼Œclientä¼šè¿›è¡ŒæŒ‰é”®æŒ‰é”®åˆ†å‘ï¼Œåº”ç”¨ç¨‹åºè¿™ä¸€ä¾§çš„æŒ‰é”®åˆ†å‘è¯·çœ‹ä¸‹ä¸€èŠ‚ã€‚</p><h2 id="ä¸ƒã€Appæ³¨å†Œæ¶ˆæ¯ç›‘å¬è¿‡ç¨‹åˆ†æ"><a href="#ä¸ƒã€Appæ³¨å†Œæ¶ˆæ¯ç›‘å¬è¿‡ç¨‹åˆ†æ" class="headerlink" title="ä¸ƒã€Appæ³¨å†Œæ¶ˆæ¯ç›‘å¬è¿‡ç¨‹åˆ†æ"></a>ä¸ƒã€Appæ³¨å†Œæ¶ˆæ¯ç›‘å¬è¿‡ç¨‹åˆ†æ</h2><p>æ€»ä½“æµç¨‹å›¾ InputDispatcherä¼šæ‰¾åˆ°ç›®æ ‡çª—å£ï¼Œç„¶åé€šè¿‡ä¹‹å‰å’ŒAppé—´å»ºç«‹çš„è¿æ¥å‘é€äº‹ä»¶ã€‚å¦‚æœæ˜¯ä¸ªéœ€è¦ç³»ç»Ÿå¤„ç†çš„Keyäº‹ä»¶ï¼Œè¿™é‡Œä¼šå°è£…æˆCommandEntryæ’å…¥åˆ°mCommandQueueé˜Ÿåˆ—ä¸­ï¼Œåé¢çš„runCommandLockedInterruptible()å‡½æ•°ä¸­ä¼šè°ƒç”¨doInterceptKeyBeforeDispatchingLockedInterruptible()æ¥è®©PWMæœ‰æœºä¼šè¿›è¡Œå¤„ç†ã€‚æœ€ådispatchOnce()è°ƒç”¨pollOnce()ä»å’ŒAppçš„è¿æ¥ä¸Šæ¥æ”¶å¤„ç†å®Œæˆæ¶ˆæ¯ã€‚é‚£ä¹ˆï¼ŒInputDispatcheræ˜¯æ€ä¹ˆç¡®å®šè¦å¾€å“ªä¸ªçª—å£ä¸­å‘äº‹ä»¶å‘¢ï¼Ÿè¿™é‡Œçš„æˆå‘˜å˜é‡mFocusedWindowHandleæŒ‡ç¤ºäº†ç„¦ç‚¹çª—å£ï¼Œç„¶åfindFocusedWindowTargetsLocked()ä¼šè°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°ï¼ˆhandleTargetsNotReadyLocked(), checkInjectionPermission(), checkWindowReadyForMoreInputLocked()ç­‰ï¼‰æ£€æŸ¥mFocusedWindowHandleæ˜¯å¦èƒ½æ¥æ”¶è¾“å…¥äº‹ä»¶ã€‚å¦‚æœå¯ä»¥ï¼Œå°†ä¹‹ä»¥InputTargetçš„å½¢å¼åŠ åˆ°ç›®æ ‡çª—å£æ•°ç»„ä¸­ã€‚ç„¶åå°±ä¼šè°ƒç”¨dispatchEventLocked()è¿›è¡Œå‘é€ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªmFocusedWindowHandleæ˜¯å¦‚ä½•ç»´æŠ¤çš„å‘¢ï¼Ÿä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œè¿™é‡Œå›å¤´åˆ†æä¸‹çª—å£è¿æ¥çš„ç®¡ç†åŠç„¦ç‚¹çª—å£çš„ç®¡ç†ã€‚ åœ¨Appç«¯ï¼Œæ–°çš„é¡¶å±‚çª—å£éœ€è¦è¢«æ³¨å†Œåˆ°WMSä¸­ï¼Œè¿™æ˜¯åœ¨ViewRootImpl::setView()ä¸­åšçš„ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N22-Android-Input-System-inputchannel.png" alt="Markdown"></p><h2 id="Step-1ã€ViewRootImpl-setView"><a href="#Step-1ã€ViewRootImpl-setView" class="headerlink" title="Step 1ã€ViewRootImpl.setView()"></a>Step 1ã€ViewRootImpl.setView()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨requestLayoutæ¥é€šçŸ¥InputManagerServiceå½“å‰çš„çª—å£æ˜¯æ¿€æ´»çš„çª—å£</span></span><br><span class="line">    requestLayout();</span><br><span class="line">    <span class="keyword">if</span> ((mWindowAttributes.inputFeatures</span><br><span class="line">            &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥çª—å£æ²¡æœ‰æŒ‡å®šINPUT_FEATURE_NO_INPUT_CHANNELå±æ€§ï¼Œåˆ™åˆ›å»ºæ¶ˆæ¯æ¥æ”¶é€šé“InputChannel</span></span><br><span class="line">        mInputChannel = <span class="keyword">new</span> InputChannel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡binderè°ƒç”¨ï¼Œè°ƒç”¨serverç«¯çš„Sessionå¯¹è±¡æ¥è·ŸWindowManagerServiceé€šä¿¡ï¼Œè¯¥å‡½æ•°æœ€åä¼šè°ƒ      </span></span><br><span class="line">        <span class="comment">// ç”¨åˆ°WindowManagerServiceçš„addWindowå‡½æ•°ï¼Œå‡½æ•°ä¸­ä¼šåˆ›å»ºä¸€å¯¹InputChannel(server/client)ï¼Œ</span></span><br><span class="line">        <span class="comment">// è¿™æ ·åœ¨å‡½æ•°è°ƒç”¨ç»“æŸåï¼ŒmInputChannelå°±å˜æˆäº†clientç«¯çš„å¯¹è±¡ã€‚åœ¨</span></span><br><span class="line">        <span class="comment">// frameworks/base/core/java/android/view/IWindowSession.aidlçš„</span></span><br><span class="line">        <span class="comment">// addToDisplayå‡½æ•°çš„å£°æ˜ä¸­ï¼ŒInputChannelæŒ‡å®šçš„æ•°æ®æµçš„æµå‘æ˜¯outï¼Œå› æ­¤</span></span><br><span class="line">        <span class="comment">// WindowManagerServiceä¿®æ”¹äº†mInputChannel,å®¢æˆ·ç«¯å°±èƒ½æ‹¿åˆ°è¿™ä¸ªå¯¹è±¡çš„æ•°æ®äº†ã€‚</span></span><br><span class="line">        res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">             getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">             mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">             mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mInputChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mInputQueueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInputQueue = <span class="keyword">new</span> InputQueue();</span><br><span class="line">            mInputQueueCallback.onInputQueueCreated(mInputQueue);</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–WindowInputEventReceiverï¼ŒæŒ‰é”®æ¶ˆæ¯ä¼šä»nativeå±‚ä¼ åˆ°è¯¥å¯¹è±¡çš„onInputEventå‡½æ•°</span></span><br><span class="line">            <span class="comment">// ä¸­ï¼ŒonInputEventå‡½æ•°æ˜¯æŒ‰é”®åœ¨åº”ç”¨ç«¯javaå±‚åˆ†å‘çš„èµ·å§‹ç«¯ã€‚</span></span><br><span class="line">            mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</span><br><span class="line">                    Looper.myLooper());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸æ³¨å†Œé”®ç›˜æ¶ˆæ¯é€šé“çš„ç›¸å…³ä¸»è¦æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼š ä¸€æ˜¯è°ƒç”¨requestLayoutå‡½æ•°æ¥é€šçŸ¥InputManagerServiceï¼Œè¿™ä¸ªActivityçª—å£æ˜¯å½“å‰è¢«æ¿€æ´»çš„çª—å£,åŒæ—¶å°†æ‰€æœ‰çš„çª—å£æ³¨å†Œåˆ°InputDispatcherä¸­ äºŒæ˜¯è°ƒç”¨mWindowSessionçš„addæˆå‘˜å‡½æ•°æ¥æŠŠé”®ç›˜æ¶ˆæ¯æ¥æ”¶é€šé“çš„serverç«¯æ³¨å†Œç«¯æ³¨å†Œåˆ°CPPå±‚çš„InputManagerServiceä¸­ï¼Œclientç«¯æ³¨å†Œåˆ°æœ¬åº”ç”¨ç¨‹åºçš„æ¶ˆæ¯å¾ªç¯Looperä¸­ï¼Œè¿™æ ·å½“InputManagerServiceç›‘æ§åˆ°æœ‰é”®ç›˜æ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±ä¼šæ‰¾åˆ°å½“å‰è¢«æ¿€æ´»çš„çª—å£ï¼Œç„¶åæ‰¾åˆ°å…¶åœ¨InputManagerServiceä¸­å¯¹åº”çš„é”®ç›˜æ¶ˆæ¯æ¥æ”¶é€šé“(InputChannel)ï¼Œé€šè¿‡è¿™ä¸ªé€šé“åœ¨InputManagerServiceçš„serverç«¯æ¥é€šçŸ¥åº”ç”¨ç¨‹åºæ¶ˆæ¯å¾ªç¯çš„clientç«¯ï¼Œè¿™æ ·å°±æŠŠé”®ç›˜æ¶ˆæ¯åˆ†å‘ç»™å½“å‰æ¿€æ´»çš„Activityçª—å£äº† ä¸‰æ˜¯åº”ç”¨ç¨‹åºè¿™ä¸€ä¾§æ³¨å†Œæ¶ˆæ¯æ¥æ”¶é€šé“</p><h2 id="Step-2ã€ViewRootImpl-requestLayout"><a href="#Step-2ã€ViewRootImpl-requestLayout" class="headerlink" title="Step 2ã€ViewRootImpl.requestLayout()"></a>Step 2ã€ViewRootImpl.requestLayout()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">        checkThread();</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº†scheduleTraversalså‡½æ•°æ¥åšè¿›ä¸€æ­¥çš„æ“ä½œï¼Œè¯¥å‡½æ•°è°ƒç”¨mChoreographeræ¥postä¸€ä¸ªRunnableåˆ°Looperä¸­ï¼Œä¹‹åVsycnä¿¡å·åˆ°æ¥ä¼šæ‰§è¡ŒmTraversalRunnableä¸­çš„runæ–¹æ³•ï¼Œå³è°ƒç”¨doTraversalå‡½æ•°</p><p>å‚è€ƒæ–‡æ¡£ï¼š<strong>ã€Android 7.1.2(Android N) Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹ã€‘</strong></p><h2 id="Step-3ã€ViewRootImpl-doTraversal"><a href="#Step-3ã€ViewRootImpl-doTraversal" class="headerlink" title="Step 3ã€ViewRootImpl.doTraversal()"></a>Step 3ã€ViewRootImpl.doTraversal()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line">        performTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æ˜¯æ‰§è¡ŒperformTraversals()å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨relayoutWindowå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­åˆä¼šè°ƒç”¨mWindowSessionçš„relayoutè¿›å…¥åˆ°javaå±‚çš„WindowManagerServiceçš„relayoutWindowå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨mInputMonitor.updateInputWindowsLw(true /force/);mInputMonitoræ˜¯InputMonitorå¯¹è±¡ã€‚</p><h2 id="Step-4ã€InputMonitor-updateInputWindowsLw"><a href="#Step-4ã€InputMonitor-updateInputWindowsLw" class="headerlink" title="Step 4ã€InputMonitor.updateInputWindowsLw()"></a>Step 4ã€InputMonitor.updateInputWindowsLw()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/java/com/android/server/wm/InputMonitor.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateInputWindowsLw</span><span class="params">(<span class="keyword">boolean</span> force)</span> </span>&#123;</span><br><span class="line"><span class="keyword">boolean</span> addInputConsumerHandle = mService.mInputConsumer != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add all windows on the default display.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mService.mDisplayContents.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = <span class="number">0</span>; displayNdx &lt; numDisplays; ++displayNdx) &#123;</span><br><span class="line">    WindowList windows = mService.mDisplayContents.valueAt(displayNdx).getWindowList();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> winNdx = windows.size() - <span class="number">1</span>; winNdx &gt;= <span class="number">0</span>; --winNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState child = windows.get(winNdx);</span><br><span class="line">        <span class="keyword">final</span> InputChannel inputChannel = child.mInputChannel;</span><br><span class="line">        <span class="keyword">final</span> InputWindowHandle inputWindowHandle = child.mInputWindowHandle;</span><br><span class="line">        ......</span><br><span class="line">        addInputWindowHandleLw(inputWindowHandle, child, flags, type, isVisible, hasFocus,</span><br><span class="line">                hasWallpaper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Send windows to native code.</span></span><br><span class="line">mService.mInputManager.setInputWindows(mInputWindowHandles);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å°†å½“å‰ç³»ç»Ÿä¸­å¸¦æœ‰InputChannelçš„Activityçª—å£éƒ½è®¾ç½®ä¸ºInputManagerServiceçš„è¾“å…¥çª—å£ï¼Œä½†æ˜¯åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œåªæœ‰å½“å‰æ¿€æ´»çš„çª—å£æ‰ä¼šå“åº”é”®ç›˜æ¶ˆæ¯ã€‚</p><h2 id="Step-5ã€InputManagerService-setInputWindows"><a href="#Step-5ã€InputManagerService-setInputWindows" class="headerlink" title="Step 5ã€InputManagerService.setInputWindows()"></a>Step 5ã€InputManagerService.setInputWindows()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/java/com/android/server/input/InputManagerService.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInputWindows</span><span class="params">(InputWindowHandle[] windowHandles)</span> </span>&#123;</span><br><span class="line">    nativeSetInputWindows(mPtr, windowHandles);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è°ƒç”¨äº†æœ¬åœ°æ–¹æ³•nativeSetInputWindowsæ¥è¿›ä¸€æ­¥æ‰§è¡Œæ“ä½œ,mPtræ˜¯nativeå±‚NativeInputManagerå®ä¾‹ï¼Œåœ¨è°ƒç”¨InputManagerService.nativeInitå‡½æ•°æ—¶ä¼šåœ¨nativeå±‚æ„é€ NativeInputManagerå¯¹è±¡å¹¶å°†å…¶ä¿å­˜åœ¨mPträ¸­ã€‚nativeSetInputWindowsä¼šè°ƒç”¨NativeInputManagerçš„setInputWindowså‡½æ•°</p><h2 id="Step-6ã€NativeInputManager-setInputWindows"><a href="#Step-6ã€NativeInputManager-setInputWindows" class="headerlink" title="Step 6ã€NativeInputManager.setInputWindows()"></a>Step 6ã€NativeInputManager.setInputWindows()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NativeInputManager::setInputWindows(JNIEnv* env, jobjectArray windowHandleObjArray) &#123;</span><br><span class="line">    Vector&lt;sp&lt;InputWindowHandle&gt; &gt; windowHandles;</span><br><span class="line">    <span class="keyword">if</span> (windowHandleObjArray) &#123;</span><br><span class="line">        jsize length = env-&gt;GetArrayLength(windowHandleObjArray);</span><br><span class="line">        <span class="keyword">for</span> (jsize i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            jobject windowHandleObj = env-&gt;GetObjectArrayElement(windowHandleObjArray, i);</span><br><span class="line">            ......</span><br><span class="line">            sp&lt;InputWindowHandle&gt; windowHandle =</span><br><span class="line">                    android_server_InputWindowHandle_getHandle(env, windowHandleObj);</span><br><span class="line">            <span class="keyword">if</span> (windowHandle != NULL) &#123;</span><br><span class="line">                windowHandles.push(windowHandle);</span><br><span class="line">            &#125;</span><br><span class="line">            env-&gt;DeleteLocalRef(windowHandleObj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mInputManager-&gt;getDispatcher()-&gt;setInputWindows(windowHandles);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do this after the dispatcher has updated the window handle state.</span></span><br><span class="line">    bool newPointerGesturesEnabled = <span class="keyword">true</span>;</span><br><span class="line">    size_t numWindows = windowHandles.size();</span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; numWindows; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;InputWindowHandle&gt;&amp; windowHandle = windowHandles.itemAt(i);</span><br><span class="line">        <span class="keyword">const</span> InputWindowInfo* windowInfo = windowHandle-&gt;getInfo();</span><br><span class="line">        <span class="keyword">if</span> (windowInfo &amp;&amp; windowInfo-&gt;hasFocus &amp;&amp; (windowInfo-&gt;inputFeatures</span><br><span class="line">                &amp; InputWindowInfo::INPUT_FEATURE_DISABLE_TOUCH_PAD_GESTURES)) &#123;</span><br><span class="line">            newPointerGesturesEnabled = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°é¦–å…ˆå°†Javaå±‚çš„InputWindowHandleè½¬æ¢æˆC++å±‚çš„NativeInputWindowHandleï¼Œç„¶åæ”¾åœ¨windowHandleså‘é‡ä¸­ï¼Œæœ€åå°†è¿™äº›è¾“å…¥çª—å£è®¾ç½®åˆ°InputDispatcherä¸­å»ã€‚</p><h2 id="Step-7ã€InputDispatcher-setInputWindows"><a href="#Step-7ã€InputDispatcher-setInputWindows" class="headerlink" title="Step 7ã€InputDispatcher.setInputWindows()"></a>Step 7ã€InputDispatcher.setInputWindows()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::setInputWindows(<span class="keyword">const</span> Vector&lt;sp&lt;InputWindowHandle&gt; &gt;&amp; inputWindowHandles) &#123;</span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">        Vector&lt;sp&lt;InputWindowHandle&gt; &gt; oldWindowHandles = mWindowHandles;</span><br><span class="line">        mWindowHandles = inputWindowHandles;</span><br><span class="line"></span><br><span class="line">        sp&lt;InputWindowHandle&gt; newFocusedWindowHandle;</span><br><span class="line">        <span class="keyword">bool</span> foundHoveredWindow = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mWindowHandles.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> sp&lt;InputWindowHandle&gt;&amp; windowHandle = mWindowHandles.itemAt(i);</span><br><span class="line">            <span class="keyword">if</span> (!windowHandle-&gt;updateInfo() || windowHandle-&gt;getInputChannel() == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                mWindowHandles.removeAt(i--);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (windowHandle-&gt;getInfo()-&gt;hasFocus) &#123;</span><br><span class="line">                newFocusedWindowHandle = windowHandle;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFocusedWindowHandle != newFocusedWindowHandle) &#123;</span><br><span class="line">            mFocusedWindowHandle = newFocusedWindowHandle;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wake up poll loop since it may need to make new input dispatching choices.</span></span><br><span class="line">    mLooper-&gt;wake();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒInputDispatcherçš„æˆå‘˜å˜é‡mFocusedWindowHandle å°±ä»£è¡¨å½“å‰æ¿€æ´»çš„çª—å£çš„ã€‚è¿™ä¸ªå‡½æ•°éå†inputWindowHandlesï¼Œè·å–è·å¾—ç„¦ç‚¹çš„çª—å£ï¼Œå¹¶èµ‹å€¼ç»™mFocusedWindowHandle è¿™æ ·ï¼ŒInputManagerServiceå°±æŠŠå½“å‰æ¿€æ´»çš„çª—å£ä¿å­˜åœ¨InputDispatcherä¸­äº†ï¼Œåé¢å°±å¯ä»¥æŠŠé”®ç›˜æ¶ˆæ¯åˆ†å‘ç»™å®ƒæ¥å¤„ç†ã€‚</p><h2 id="Step-8ã€mWindowSession-addToDisplay"><a href="#Step-8ã€mWindowSession-addToDisplay" class="headerlink" title="Step 8ã€mWindowSession.addToDisplay()"></a>Step 8ã€mWindowSession.addToDisplay()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((mWindowAttributes.inputFeatures</span><br><span class="line">            &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</span><br><span class="line">        mInputChannel = <span class="keyword">new</span> InputChannel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">             getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">             mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">             mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè°ƒç”¨åˆ°WindowManagerServiceçš„addWindowæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> openInputChannels = (outInputChannel != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (attrs.inputFeatures &amp; INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>  (openInputChannels) &#123;</span><br><span class="line">            win.openInputChannel(outInputChannel);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ä¼šè°ƒç”¨WindowStateçš„ openInputChannel()æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/WindowState.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">openInputChannel</span><span class="params">(InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String name = makeInputChannelName();</span><br><span class="line">    InputChannel[] inputChannels = InputChannel.openInputChannelPair(name);</span><br><span class="line">    mInputChannel = inputChannels[<span class="number">0</span>];</span><br><span class="line">    mClientChannel = inputChannels[<span class="number">1</span>];</span><br><span class="line">    mInputWindowHandle.inputChannel = inputChannels[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (outInputChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mClientChannel.transferTo(outInputChannel);</span><br><span class="line">        mClientChannel.dispose();</span><br><span class="line">        mClientChannel = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If the window died visible, we setup a dummy input channel, so that taps</span></span><br><span class="line">        <span class="comment">// can still detected by input monitor channel, and we can relaunch the app.</span></span><br><span class="line">        <span class="comment">// Create dummy event receiver that simply reports all events as handled.</span></span><br><span class="line">        mDeadWindowEventReceiver = <span class="keyword">new</span> DeadWindowEventReceiver(mClientChannel);</span><br><span class="line">    &#125;</span><br><span class="line">    mService.mInputManager.registerInputChannel(mInputChannel, mInputWindowHandle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„outInputChannelå³ä¸ºå‰é¢åˆ›å»ºçš„InputChannelï¼Œå®ƒä¸ä¸ºNULLï¼Œå› æ­¤ï¼Œè¿™é‡Œä¼šé€šè¿‡InputChannel.openInputChannelPairå‡½æ•°æ¥åˆ›å»ºä¸€å¯¹è¾“å…¥é€šé“ï¼Œå…¶ä¸­ä¸€ä¸ªä½äºWindowManagerServiceä¸­ï¼Œå¦å¤–ä¸€ä¸ªé€šè¿‡outInputChannelå‚æ•°è¿”å›åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚</p><p>WindowManagerServiceä¼šä¸ºæ¯ä¸ªçª—å£åˆ›å»ºä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œç„¶åå°†è¯¥InputChannelå¯¹çš„serviceç«¯ä¿å­˜åˆ°WindowStateä¸­</p><h2 id="Step-10ã€InputChannel-openInputChannelPair"><a href="#Step-10ã€InputChannel-openInputChannelPair" class="headerlink" title="Step 10ã€InputChannel.openInputChannelPair()"></a>Step 10ã€InputChannel.openInputChannelPair()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/InputChannel.java]</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> InputChannel[] openInputChannelPair(String name) &#123;</span><br><span class="line">    <span class="keyword">return</span> nativeOpenInputChannelPair(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†nativeOpenInputChannelPairå‡½æ•°ï¼Œåœ¨nativeåˆ›å»ºä¸€ä¸ªInputChannelå¯¹</p><h2 id="Step-11ã€InputChannel-nativeOpenInputChannelPair"><a href="#Step-11ã€InputChannel-nativeOpenInputChannelPair" class="headerlink" title="Step 11ã€InputChannel.nativeOpenInputChannelPair()"></a>Step 11ã€InputChannel.nativeOpenInputChannelPair()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/jni/android_view_InputChannel.cpp]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jobjectArray <span class="title">android_view_InputChannel_nativeOpenInputChannelPair</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="function"><span class="params">        jclass clazz, jstring nameObj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* nameChars = env-&gt;GetStringUTFChars(nameObj, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="function">String8 <span class="title">name</span><span class="params">(nameChars)</span></span>;</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(nameObj, nameChars);</span><br><span class="line"></span><br><span class="line">    sp&lt;InputChannel&gt; serverChannel;</span><br><span class="line">    sp&lt;InputChannel&gt; clientChannel;</span><br><span class="line">    <span class="keyword">status_t</span> result = InputChannel::openInputChannelPair(name, serverChannel, clientChannel);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> channelPair;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nativeOpenInputChannelPairå‡½æ•°è°ƒç”¨InputChannelçš„openInputChannelPairå‡½æ•°åˆ›å»ºä¸€å¯¹InputChannel,è¯¥å¯¹è±¡æ˜¯Nativeå±‚çš„InputChannel,è·Ÿjavaå±‚æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚</p><h2 id="Step-12ã€InputChannel-openInputChannelPair"><a href="#Step-12ã€InputChannel-openInputChannelPair" class="headerlink" title="Step 12ã€InputChannel.openInputChannelPair()"></a>Step 12ã€InputChannel.openInputChannelPair()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/libs/input/InputTransport.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> InputChannel::openInputChannelPair(<span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        sp&lt;InputChannel&gt;&amp; outServerChannel, sp&lt;InputChannel&gt;&amp; outClientChannel) &#123;</span><br><span class="line">    <span class="keyword">int</span> sockets[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_SEQPACKET, <span class="number">0</span>, sockets)) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> result = -errno;</span><br><span class="line">        ALOGE(<span class="string">"channel '%s' ~ Could not create socket pair.  errno=%d"</span>,</span><br><span class="line">                name.<span class="built_in">string</span>(), errno);</span><br><span class="line">        outServerChannel.clear();</span><br><span class="line">        outClientChannel.clear();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> bufferSize = SOCKET_BUFFER_SIZE;</span><br><span class="line">    <span class="comment">//è®¾ç½®serverç«¯å’Œclientç«¯çš„æ¥æ”¶ç¼“å†²åŒºå’Œå‘é€ç¼“å†²åŒº</span></span><br><span class="line">    setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</span><br><span class="line">    setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</span><br><span class="line">    setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</span><br><span class="line">    setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</span><br><span class="line"></span><br><span class="line">    String8 serverChannelName = name;</span><br><span class="line">    serverChannelName.append(<span class="string">" (server)"</span>);</span><br><span class="line">    outServerChannel = <span class="keyword">new</span> InputChannel(serverChannelName, sockets[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    String8 clientChannelName = name;</span><br><span class="line">    clientChannelName.append(<span class="string">" (client)"</span>);</span><br><span class="line">    outClientChannel = <span class="keyword">new</span> InputChannel(clientChannelName, sockets[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº†socketpairç³»ç»Ÿè°ƒç”¨åˆ›å»ºäº†ä¸€å¯¹å·²ç»è¿æ¥çš„UNIXç§Ÿsocket,è¿™é‡Œå¯ä»¥æŠŠè¿™ä¸€å¯¹socketå½“æˆpipeè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ä¸€æ ·ä½¿ç”¨ï¼Œpipeè¿”å›çš„ç®¡é“æ˜¯å•å‘ç®¡é“ï¼Œå³åªèƒ½ä»ä¸€ç«¯å†™å…¥ï¼Œä¸€ç«¯è¯»å‡ºï¼Œä½†æ˜¯socketpairæ˜¯åˆ›å»ºçš„ç®¡é“æ˜¯å…¨åŒå·¥çš„ï¼Œå¯è¯»å¯å†™ã€‚</p><p>åˆ›å»ºå¥½äº†serverç«¯å’Œclientç«¯socketpairé€šé“åï¼Œåœ¨WindowState.openInputChannel()æ–¹æ³•ä¸­ï¼Œä¸€æ–¹é¢å®ƒæŠŠåˆšæ‰åˆ›å»ºçš„Clientç«¯çš„è¾“å…¥é€šé“é€šè¿‡outInputChannelå‚æ•°è¿”å›åˆ°åº”ç”¨ç¨‹åºä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inputChannels[<span class="number">1</span>].transferTo(outInputChannel);</span><br></pre></td></tr></table></figure><p>WindowSession.addToDisplay()é€šè¿‡Binderé€šä¿¡ä¸WMSé€šä¿¡ã€‚IWindowSession.javaä¸ºç¼–è¯‘Android 7.1.2æºç å¾—åˆ°ã€‚ åœ¨æ­¤çœ‹ä¸€ä¸‹é€šä¿¡è¯¦ç»†è¿‡ç¨‹,å¯ä»¥çœ‹åˆ°outInputChannelé€šè¿‡_arg8.writeToParcel()å†™å…¥ï¼Œç„¶åé€šè¿‡è·¨è¿›ç¨‹æ–¹å¼ä¼ è¾“ï¼ŒAppç«¯å°±å¯ä»¥å¾—åˆ°Clientç«¯çš„InputChannel äº†ã€‚ [-&gt;IWindowSession.java$ Stub]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> TRANSACTION_addToDisplay:</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">android.view.InputChannel _arg8;</span><br><span class="line">_arg8 = <span class="keyword">new</span> android.view.InputChannel();</span><br><span class="line"><span class="keyword">int</span> _result = <span class="keyword">this</span>.addToDisplay(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7, _arg8);</span><br><span class="line">reply.writeNoException();</span><br><span class="line">reply.writeInt(_result);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> ((_arg8!=null)) &#123;</span><br><span class="line">reply.writeInt(<span class="number">1</span>);</span><br><span class="line">_arg8.writeToParcel(reply, android.os.Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;IWindowSession.java$ Proxy]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//android/out/target/common/obj/JAVA_LIBRARIES/framework_intermediates/src/core/java/android/view/IWindowSession.java</span></span><br><span class="line"></span><br><span class="line">@Override public int addToDisplay(android.view.IWindow window, int seq, android.view.WindowManager.LayoutParams attrs, int viewVisibility, int layerStackId, android.graphics.Rect outContentInsets, android.graphics.Rect outStableInsets, android.graphics.Rect outOutsets, android.view.InputChannel outInputChannel) throws android.os.RemoteException</span><br><span class="line">&#123;</span><br><span class="line">android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">......</span><br><span class="line">mRemote.transact(Stub.TRANSACTION_addToDisplay, _data, _reply, <span class="number">0</span>);</span><br><span class="line">_result = _reply.readInt();</span><br><span class="line">....</span><br><span class="line"><span class="keyword">if</span> ((<span class="number">0</span>!=_reply.readInt())) &#123;</span><br><span class="line">outInputChannel.readFromParcel(_reply);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–è¿˜éœ€è¦æŠŠserverç«¯çš„InputChannelæ³¨å†Œåˆ°InputManagerServiceä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mInputManager.registerInputChannel(win.mInputChannel, win.mInputWindowHandle);</span><br></pre></td></tr></table></figure><h2 id="Step-13ã€InputManagerService-registerInputChannel"><a href="#Step-13ã€InputManagerService-registerInputChannel" class="headerlink" title="Step 13ã€InputManagerService.registerInputChannel()"></a>Step 13ã€InputManagerService.registerInputChannel()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/java/com/android/server/input/InputManagerService.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerInputChannel</span><span class="params">(InputChannel inputChannel,</span></span></span><br><span class="line"><span class="function"><span class="params">        InputWindowHandle inputWindowHandle)</span> </span>&#123;</span><br><span class="line">    nativeRegisterInputChannel(mPtr, inputChannel, inputWindowHandle, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨nativeRegisterInputChannelæ¥å°†InputChannelæ³¨å†Œåˆ°nativeå±‚</p><h2 id="Step-14ã€InputManagerService-nativeRegisterInputChannel"><a href="#Step-14ã€InputManagerService-nativeRegisterInputChannel" class="headerlink" title="Step 14ã€InputManagerService.nativeRegisterInputChannel()"></a>Step 14ã€InputManagerService.nativeRegisterInputChannel()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeRegisterInputChannel</span><span class="params">(JNIEnv* env, jclass <span class="comment">/* clazz */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong ptr, jobject inputChannelObj, jobject inputWindowHandleObj, jboolean monitor)</span> </span>&#123;</span><br><span class="line">    NativeInputManager* im = <span class="keyword">reinterpret_cast</span>&lt;NativeInputManager*&gt;(ptr);</span><br><span class="line"></span><br><span class="line">    sp&lt;InputChannel&gt; inputChannel = android_view_InputChannel_getInputChannel(env,</span><br><span class="line">            inputChannelObj);</span><br><span class="line"></span><br><span class="line">    sp&lt;InputWindowHandle&gt; inputWindowHandle =</span><br><span class="line">            android_server_InputWindowHandle_getHandle(env, inputWindowHandleObj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> status = im-&gt;registerInputChannel(</span><br><span class="line">            env, inputChannel, inputWindowHandle, monitor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®javaå±‚çš„InputWindowHandleè·å¾—nativeå±‚çš„InputWindowHandleå¯¹è±¡ï¼Œæ ¹æ®javaå±‚çš„InputChannelè·å¾—nativeå±‚çš„InputChannelå¯¹è±¡ï¼Œç„¶åè°ƒç”¨NativeInputManagerçš„resgiterInputChannelï¼Œè¯¥å‡½æ•°åˆè°ƒç”¨äº†InputDispatcherçš„registerInputChannel</p><h2 id="Step-15ã€InputDispatcher-registerInputChannel"><a href="#Step-15ã€InputDispatcher-registerInputChannel" class="headerlink" title="Step 15ã€InputDispatcher.registerInputChannel()"></a>Step 15ã€InputDispatcher.registerInputChannel()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> InputDispatcher::registerInputChannel(<span class="keyword">const</span> sp&lt;InputChannel&gt;&amp; inputChannel,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;InputWindowHandle&gt;&amp; inputWindowHandle, <span class="keyword">bool</span> monitor) &#123;</span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">        sp&lt;Connection&gt; connection = <span class="keyword">new</span> Connection(inputChannel, inputWindowHandle, monitor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = inputChannel-&gt;getFd();</span><br><span class="line">        mConnectionsByFd.add(fd, connection);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (monitor) &#123;</span><br><span class="line">            mMonitoringChannels.push(inputChannel);</span><br><span class="line">        &#125;    </span><br><span class="line"></span><br><span class="line">        mLooper-&gt;addFd(fd, <span class="number">0</span>, ALOOPER_EVENT_INPUT, handleReceiveCallback, <span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wake the looper because some connections have changed.</span></span><br><span class="line">    mLooper-&gt;wake();</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºConnectionï¼Œå¯ä»¥çœ‹åˆ°ç”¨inputChannelåˆå§‹åŒ–äº†inputPublisher(inputChannel)ï¼Œè¿™å°±æ˜¯ä¹‹å‰Input dispatcherå°èŠ‚ Step 8. InputPublisher.publishKeyEvent()æ–¹æ³•ä¸­çš„é‚£ä¸ªmChannelã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --- InputDispatcher::Connection ---</span></span><br><span class="line">InputDispatcher::Connection::Connection(<span class="keyword">const</span> sp&lt;InputChannel&gt;&amp; inputChannel,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;InputWindowHandle&gt;&amp; inputWindowHandle, <span class="keyword">bool</span> monitor) :</span><br><span class="line">    status(STATUS_NORMAL), inputChannel(inputChannel), inputWindowHandle(inputWindowHandle),</span><br><span class="line">    monitor(monitor),</span><br><span class="line">    inputPublisher(inputChannel), inputPublisherBlocked(<span class="literal">false</span>) &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å°†InputWindowHandle, InputChanelå°è£…æˆConnectionå¯¹è±¡ï¼Œç„¶åfdä½œä¸ºkeyï¼ŒConnectionä½œä¸ºValueï¼Œä¿å­˜åœ¨mConnectionsByFdä¸­ï¼Œå¦‚æœä¼ å…¥çš„monitoræ˜¯trueï¼Œåˆ™éœ€è¦å°†InputChannelæ”¾åˆ°mMonitoringChannelsä¸­,ä»ä¸Šé¢çš„InputManagerServiceçš„registerInputChannelå‡½æ•°é‡Œä¼ å…¥çš„monitoræ˜¯falseï¼Œæ‰€ä»¥è¿™é‡Œä¸åŠ å…¥åˆ°mMonitoringChannelsã€‚åŒæ—¶æŠŠfdåŠ å…¥åˆ°mLooperçš„ç›‘å¬ä¸­ï¼Œå¹¶æŒ‡å®šå½“è¯¥fdæœ‰å†…å®¹å¯è¯»æ—¶ï¼ŒLooperå°±ä¼šè°ƒç”¨handleReceiveCallbackå‡½æ•°ã€‚è‡³æ­¤serverç«¯çš„InputChannelæ³¨å†Œå®Œæˆï¼ŒInputDispatcherç¡çœ åœ¨ç›‘å¬çš„fdsä¸Šï¼Œå½“æœ‰æŒ‰é”®äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒInputDispatcherå°±ä¼šå¾€è¿™äº›fdå†™å…¥InputMessageå¯¹è±¡ï¼Œè¿›è€Œå›è°ƒhandleReceiveCallbackå‡½æ•°ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N23-Android-Input-System-InputDispatcher-viewrootimpl.png" alt="Markdown"></p><p>è‡³æ­¤ï¼Œserverç«¯çš„InputChannelå°±æ³¨å†Œå®Œæˆäº†ï¼Œå†å›åˆ°å‰é¢çš„WindowManagerService.addWindowä¸Šçš„ç¬¬äºŒæ­¥inputChannels[1].transferTo(outInputChannel);ï¼Œè¿™ä¸ªæ˜¯å°†åˆ›å»ºçš„ä¸€å¯¹InputChannelçš„clientç«¯å¤åˆ¶åˆ°ä¼ å…¥çš„å‚æ•°InputChannelä¸Šï¼Œå½“addWindowè¿”å›æ—¶ï¼Œå°±å›åˆ°ViewRootImpl.setView()æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œåº”ç”¨ç¨‹åºè¿™ä¸€ä¾§çš„é”®ç›˜æ¶ˆæ¯æ¥æ”¶é€šé“ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mInputChannel != null) &#123;</span><br><span class="line">    mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</span><br><span class="line">        Looper.myLooper());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WindowInputEventReceiverç»§æ‰¿è‡ªInputEventReceiverç±»ã€‚</p><h2 id="Step-16ã€InputEventReceiver"><a href="#Step-16ã€InputEventReceiver" class="headerlink" title="Step 16ã€InputEventReceiver()"></a>Step 16ã€InputEventReceiver()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/InputEventReceiver.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InputEventReceiver</span><span class="params">(InputChannel inputChannel, Looper looper)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    mInputChannel = inputChannel;</span><br><span class="line">    mMessageQueue = looper.getQueue();</span><br><span class="line">    mReceiverPtr = nativeInit(<span class="keyword">new</span> WeakReference&lt;InputEventReceiver&gt;(<span class="keyword">this</span>),</span><br><span class="line">            inputChannel, mMessageQueue);</span><br><span class="line"></span><br><span class="line">    mCloseGuard.open(<span class="string">"dispose"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†nativeInitæ‰§è¡Œnativeå±‚çš„åˆå§‹åŒ–</p><h2 id="Step-17-ã€InputEventReceiver-nativeInit"><a href="#Step-17-ã€InputEventReceiver-nativeInit" class="headerlink" title="Step 17.ã€InputEventReceiver.nativeInit()"></a>Step 17.ã€InputEventReceiver.nativeInit()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/jni/android_view_InputEventReceiver.cpp]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeInit</span><span class="params">(JNIEnv* env, jclass clazz, jobject receiverWeak,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobject inputChannelObj, jobject messageQueueObj)</span> </span>&#123;</span><br><span class="line">    sp&lt;InputChannel&gt; inputChannel = android_view_InputChannel_getInputChannel(env,</span><br><span class="line">            inputChannelObj);</span><br><span class="line"></span><br><span class="line">    sp&lt;MessageQueue&gt; messageQueue = android_os_MessageQueue_getMessageQueue(env, messageQueueObj);</span><br><span class="line"></span><br><span class="line">    sp&lt;NativeInputEventReceiver&gt; receiver = <span class="keyword">new</span> NativeInputEventReceiver(env,</span><br><span class="line">            receiverWeak, inputChannel, messageQueue);</span><br><span class="line">    <span class="keyword">status_t</span> status = receiver-&gt;initialize();</span><br><span class="line"></span><br><span class="line">    receiver-&gt;incStrong(gInputEventReceiverClassInfo.clazz); <span class="comment">// retain a reference for the object</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(receiver.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªNativeInputEventReceiverå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶initializeå‡½æ•°</p><h2 id="Step-18-ã€NativeInputEventReceiver-initialize"><a href="#Step-18-ã€NativeInputEventReceiver-initialize" class="headerlink" title="Step 18.ã€NativeInputEventReceiver.initialize()"></a>Step 18.ã€NativeInputEventReceiver.initialize()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/jni/android_view_InputEventReceiver.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> NativeInputEventReceiver::initialize() &#123;</span><br><span class="line">    setFdEvents(ALOOPER_EVENT_INPUT);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨setFdEventså‡½æ•°</p><h2 id="Step-19ã€NativeInputEventReceiver-setFdEvents"><a href="#Step-19ã€NativeInputEventReceiver-setFdEvents" class="headerlink" title="Step 19ã€NativeInputEventReceiver.setFdEvents()"></a>Step 19ã€NativeInputEventReceiver.setFdEvents()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/jni/android_view_InputEventReceiver.cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NativeInputEventReceiver::setFdEvents(<span class="keyword">int</span> events) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mFdEvents != events) &#123;</span><br><span class="line">        mFdEvents = events;</span><br><span class="line">        <span class="keyword">int</span> fd = mInputConsumer.getChannel()-&gt;getFd();</span><br><span class="line">        <span class="keyword">if</span> (events) &#123;</span><br><span class="line">            mMessageQueue-&gt;getLooper()-&gt;addFd(fd, <span class="number">0</span>, events, <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mMessageQueue-&gt;getLooper()-&gt;removeFd(fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨ä¼ å…¥çš„MessageQueueè·å–Looperå¯¹è±¡ï¼Œå¦‚æœeventsæ˜¯0ï¼Œåˆ™è¡¨ç¤ºè¦ç§»é™¤ç›‘å¬fdï¼Œå¦‚æœeventsä¸ä¸º0ï¼Œè¡¨ç¤ºè¦ç›‘å¬fdï¼Œè¿™ä¸ªfdæ˜¯å‰é¢WindowManagerServiceåˆ›å»ºçš„ä¸€å¯¹InputChannelçš„clientç«¯ï¼Œè¿™æ ·å½“Serverç«¯å†™å…¥äº‹ä»¶æ—¶ï¼Œclientç«¯çš„looperå°±èƒ½è¢«å”¤é†’ï¼Œå¹¶è°ƒç”¨handleEventå‡½æ•°ï¼ˆLooper::addFdå‡½æ•°å¯ä»¥æŒ‡å®šLooperCallbackå¯¹è±¡ï¼Œå½“fdå¯è¯»æ—¶ï¼Œä¼šè°ƒç”¨LooperCallbackçš„handleEventï¼Œè€ŒNativeInputEventReceiverç»§æ‰¿è‡ªLooperCallbackï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨NativeInputEventReceiverçš„handleEventå‡½æ•°ï¼‰ è´´ä¸Šäº‹ä»¶å¤„ç†åºåˆ—å›¾ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N24-Android-Input-System-Process-input-event.png" alt="Markdown"></p><h2 id="Step-20ã€NativeInputEventReceiver-handleEvent"><a href="#Step-20ã€NativeInputEventReceiver-handleEvent" class="headerlink" title="Step 20ã€NativeInputEventReceiver.handleEvent()"></a>Step 20ã€NativeInputEventReceiver.handleEvent()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/jni/android_view_InputEventReceiver.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> NativeInputEventReceiver::handleEvent(<span class="keyword">int</span> receiveFd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; ALOOPER_EVENT_INPUT) &#123;</span><br><span class="line">        JNIEnv* env = AndroidRuntime::getJNIEnv();</span><br><span class="line">        <span class="keyword">status_t</span> status = consumeEvents(env, <span class="literal">false</span> <span class="comment">/*consumeBatches*/</span>, <span class="number">-1</span>, <span class="literal">NULL</span>);</span><br><span class="line">        mMessageQueue-&gt;raiseAndClearException(env, <span class="string">"handleReceiveCallback"</span>);</span><br><span class="line">        <span class="keyword">return</span> status == OK || status == NO_MEMORY ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°è°ƒç”¨consumeEventså‡½æ•°æ¥å¤„ç†æ¥æ”¶ä¸€ä¸ªæŒ‰é”®äº‹ä»¶</p><h2 id="Step-21ã€NativeInputEventReceiver-consumeEvents"><a href="#Step-21ã€NativeInputEventReceiver-consumeEvents" class="headerlink" title="Step 21ã€NativeInputEventReceiver.consumeEvents()"></a>Step 21ã€NativeInputEventReceiver.consumeEvents()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/jni/android_view_InputEventReceiver.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> NativeInputEventReceiver::consumeEvents(JNIEnv* env,</span><br><span class="line">        <span class="keyword">bool</span> consumeBatches, <span class="keyword">nsecs_t</span> frameTime, <span class="keyword">bool</span>* outConsumedBatch) &#123;</span><br><span class="line">    ......</span><br><span class="line">    ScopedLocalRef&lt;jobject&gt; receiverObj(env, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">bool</span> skipCallbacks = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> seq;</span><br><span class="line">        InputEvent* inputEvent;</span><br><span class="line">        <span class="comment">// å¤„ç†æ¥æ”¶ä¸€ä¸ªæŒ‰é”®äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">status_t</span> status = mInputConsumer.consume(&amp;mInputEventFactory,</span><br><span class="line">                consumeBatches, frameTime, &amp;seq, &amp;inputEvent);</span><br><span class="line">        <span class="keyword">if</span> (!skipCallbacks) &#123;</span><br><span class="line">            jobject inputEventObj;</span><br><span class="line">            <span class="keyword">switch</span> (inputEvent-&gt;getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> AINPUT_EVENT_TYPE_KEY:</span><br><span class="line">                inputEventObj = android_view_KeyEvent_fromNative(env,</span><br><span class="line">                        <span class="keyword">static_cast</span>&lt;KeyEvent*&gt;(inputEvent));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (inputEventObj) &#123;</span><br><span class="line">                env-&gt;CallVoidMethod(receiverObj.get(),</span><br><span class="line">                        gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj);</span><br><span class="line">                env-&gt;DeleteLocalRef(inputEventObj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (skipCallbacks) &#123;</span><br><span class="line">            mInputConsumer.sendFinishedSignal(seq, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°é¦–å…ˆè°ƒç”¨mInputConsumer.consumeæ¥æ”¶ä¸€ä¸ªInputEventå¯¹è±¡,mInputConsumeråœ¨NativeInputEventReceiveræ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–</p><h2 id="Step-22ã€InputConsumer-consume"><a href="#Step-22ã€InputConsumer-consume" class="headerlink" title="Step 22ã€InputConsumer.consume()"></a>Step 22ã€InputConsumer.consume()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/native/libs/input/InputTransport.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> InputConsumer::consume(InputEventFactoryInterface* factory,</span><br><span class="line">        <span class="keyword">bool</span> consumeBatches, <span class="keyword">nsecs_t</span> frameTime, <span class="keyword">uint32_t</span>* outSeq, InputEvent** outEvent) &#123;</span><br><span class="line"></span><br><span class="line">    *outSeq = <span class="number">0</span>;</span><br><span class="line">    *outEvent = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetch the next input message.</span></span><br><span class="line">    <span class="comment">// Loop until an event can be returned or no additional events are received.</span></span><br><span class="line">    <span class="keyword">while</span> (!*outEvent) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mMsgDeferred) &#123;</span><br><span class="line">            <span class="comment">// mMsg contains a valid input message from the previous call to consume</span></span><br><span class="line">            <span class="comment">// that has not yet been processed.</span></span><br><span class="line">            mMsgDeferred = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Receive a fresh message.</span></span><br><span class="line">            <span class="keyword">status_t</span> result = mChannel-&gt;receiveMessage(&amp;mMsg);</span><br><span class="line">            <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                <span class="comment">// Consume the next batched event unless batches are being held for later.</span></span><br><span class="line">                <span class="keyword">if</span> (consumeBatches || result != WOULD_BLOCK) &#123;</span><br><span class="line">                    result = consumeBatch(factory, frameTime, outSeq, outEvent);</span><br><span class="line">                    <span class="keyword">if</span> (*outEvent) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;   </span><br><span class="line">                &#125;   </span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;   </span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (mMsg.header.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> InputMessage::TYPE_KEY: &#123;</span><br><span class="line">            KeyEvent* keyEvent = factory-&gt;createKeyEvent();</span><br><span class="line">            <span class="keyword">if</span> (!keyEvent) <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line"></span><br><span class="line">            initializeKeyEvent(keyEvent, &amp;mMsg);</span><br><span class="line">            *outSeq = mMsg.body.key.seq;</span><br><span class="line">            *outEvent = keyEvent;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;   </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°é¦–å…ˆè°ƒç”¨InputChannelçš„receiveMessageå‡½æ•°æ¥æ”¶InputMessageå¯¹è±¡ï¼Œç„¶åæ ¹æ®InputMessageå¯¹è±¡è°ƒç”¨initializeKeyEventæ¥æ„é€ KeyEventå¯¹è±¡ã€‚æ‹¿åˆ°å¯KeyEventå¯¹è±¡åï¼Œå†å¯¹åˆ°consumeEventsä¸­è°ƒç”¨javaå±‚çš„InputEventReceiver.javaçš„dispatchInputEventå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;CallVoidMethod(receiverObj.get(),</span><br><span class="line">                        gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj);</span><br></pre></td></tr></table></figure><h2 id="Step-23ã€InputEventReceiver-dispatchInputEvent"><a href="#Step-23ã€InputEventReceiver-dispatchInputEvent" class="headerlink" title="Step 23ã€InputEventReceiver.dispatchInputEvent()"></a>Step 23ã€InputEventReceiver.dispatchInputEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/InputEventReceiver.java]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called from native code.</span></span><br><span class="line">SuppressWarnings(<span class="string">"unused"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchInputEvent</span><span class="params">(<span class="keyword">int</span> seq, InputEvent event)</span> </span>&#123;</span><br><span class="line">    mSeqMap.put(event.getSequenceNumber(), seq);</span><br><span class="line">    onInputEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›è€Œè°ƒç”¨onInputEventå‡½æ•°ã€‚è‡³æ­¤æŒ‰é”®å°±å¼€å§‹äº†javaå±‚çš„åˆ†å‘(ä¸‹ä¸€èŠ‚è¯¦ç»†ä»‹ç»)ã€‚</p><p>å›åˆ°ä¸»çº¿ï¼Œæ•…äº‹æ¥æ²¡è®²å®Œã€‚å½“Appè¿™ç«¯å¤„ç†å®Œè¾“å…¥äº‹ä»¶è°ƒç”¨ViewRootImpl.finishInputEvent()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;/frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishInputEvent</span><span class="params">(QueuedInputEvent q)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (q.mReceiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> handled = (q.mFlags &amp; QueuedInputEvent.FLAG_FINISHED_HANDLED) != <span class="number">0</span>;</span><br><span class="line">        q.mReceiver.finishInputEvent(q.mEvent, handled);</span><br><span class="line">    &#125;......</span><br><span class="line">    recycleQueuedInputEvent(q);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaå±‚InputEventReceiver.nativeFinishInputEvent() é€šè¿‡JNI è°ƒç”¨android_view_InputEventReceiver.finishInputEvent()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/jni/android_view_InputEventReceiver.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> NativeInputEventReceiver::finishInputEvent(<span class="keyword">uint32_t</span> seq, <span class="keyword">bool</span> handled) &#123;</span><br><span class="line">           <span class="keyword">if</span> (kDebugDispatchCycle) &#123;</span><br><span class="line">              ALOGD(<span class="string">"channel '%s' ~ Finished input event."</span>, getInputChannelName());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">status_t</span> status = mInputConsumer.sendFinishedSignal(seq, handled);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å±‚å±‚è·³è½¬æœ€åä¼šè°ƒç”¨åˆ°InputConsumer.sendUnchainedFinishedSignal()å‘é€ä¸€ä¸ªInputMessage::TYPE_FINISHEDæ¶ˆæ¯ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/native/libs/input/InputTransport.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> InputConsumer::sendUnchainedFinishedSignal(<span class="keyword">uint32_t</span> seq, <span class="keyword">bool</span> handled) &#123;</span><br><span class="line">InputMessage msg;</span><br><span class="line">msg.header.type = InputMessage::TYPE_FINISHED;</span><br><span class="line">msg.body.finished.seq = seq;</span><br><span class="line">msg.body.finished.handled = handled;</span><br><span class="line"><span class="keyword">return</span> mChannel-&gt;sendMessage(&amp;msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨InputDispatcher.registerInputChannel()ä¸­æ·»åŠ äº†ä¸€ä¸ª handleReceiveCallbackå›è°ƒã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mLooper-&gt;addFd(fd, <span class="number">0</span>, ALOOPER_EVENT_INPUT, handleReceiveCallback, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡å’ŒIMSä¸­InputDispacherçš„é€šä¿¡ç®¡é“InputChannelå‘äº†å¤„ç†å®Œæˆé€šçŸ¥ã€‚é‚£InputDispatcherè¿™è¾¹æ”¶åˆ°åå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N25-Android-Input-System-InputDispatcher-handleReceiveCallback.jpg" alt="Markdown"></p><p>ç”±å‰é¢åˆ†æ InputDispatcherä¼šè°ƒç”¨handleReceiveCallback()æ¥å¤„ç†TYPE_FINISHEDä¿¡å·ã€‚è¿™é‡Œå…ˆæ˜¯å¾€Commandé˜Ÿåˆ—é‡Œæ”¾ä¸€ä¸ªå¤„ç†äº‹åŠ¡æ‰§è¡ŒdoDispatchCycleFinishedLockedInterruptible()ï¼Œåé¢åœ¨runCommandsLockedInterruptible()ä¸­ä¼šå–å‡ºæ‰§è¡Œã€‚åœ¨doDispatchCycleFinishedLockedInterruptible()å‡½æ•°ä¸­ï¼Œä¼šå…ˆè°ƒç”¨afterKeyEventLockedInterruptible()ã€‚Androidä¸­å¯ä»¥å®šä¹‰ä¸€äº›Fallbacké”®ï¼Œå³å¦‚æœä¸€ä¸ªKeyäº‹ä»¶Appæ²¡æœ‰å¤„ç†ï¼Œå¯ä»¥Fallbackæˆå¦å¤–é»˜è®¤çš„Keyäº‹ä»¶ï¼Œè¿™æ˜¯åœ¨è¿™é‡Œçš„dispatchUnhandledKey()å‡½æ•°ä¸­è¿›è¡Œå¤„ç†çš„ã€‚æ¥ç€InputDispatcherä¼šå°†è¯¥æ”¶åˆ°å®Œæˆä¿¡å·çš„äº‹ä»¶é¡¹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚åŒæ—¶ç”±äºä¸Šä¸€ä¸ªäº‹ä»¶å·²è¢«Appå¤„ç†å®Œï¼Œå°±å¯ä»¥è°ƒç”¨startDispatchCycleLocked()æ¥è¿›è¡Œä¸‹ä¸€è½®äº‹ä»¶çš„å¤„ç†äº†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/native/services/inputflinger/InputDispatcher.cpp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dispatchEntry == connection-&gt;findWaitQueueEntry(seq)) &#123;  </span><br><span class="line">    connection-&gt;waitQueue.dequeue(dispatchEntry);  </span><br><span class="line">    ...  </span><br><span class="line">&#125;  </span><br><span class="line"> <span class="comment">// Start the next dispatch cycle for this connection.  </span></span><br><span class="line">  startDispatchCycleLocked(now(), connection);</span><br></pre></td></tr></table></figure><p>startDispatchCycleLockedå‡½æ•°ä¼šæ£€æŸ¥ç›¸åº”è¿æ¥çš„è¾“å‡ºç¼“å†²ä¸­(connection-&gt;outboundQueue)æ˜¯å¦æœ‰äº‹ä»¶è¦å‘é€çš„ï¼Œæœ‰çš„è¯ä¼šé€šè¿‡InputChannelå‘é€å‡ºå»ã€‚</p><p>æ€»ç»“ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N26-Android-Input-System-Input-kernel-driver-framwork-app.png" alt="Markdown"></p><h2 id="8ã€Android-Inputå­ç³»ç»Ÿä¹‹javaå±‚æŒ‰é”®ä¼ é€’"><a href="#8ã€Android-Inputå­ç³»ç»Ÿä¹‹javaå±‚æŒ‰é”®ä¼ é€’" class="headerlink" title="8ã€Android Inputå­ç³»ç»Ÿä¹‹javaå±‚æŒ‰é”®ä¼ é€’"></a>8ã€Android Inputå­ç³»ç»Ÿä¹‹javaå±‚æŒ‰é”®ä¼ é€’</h2><p>Androidå¼€å‘ä¸­åœ¨è‡ªå®šä¹‰Activityä»¥åŠViewæ—¶ç»å¸¸ä¼šé‡å†™onKeyDown,onKeyUp,dispatchKeyEventï¼ŒåŒæ—¶Viewè¿˜æœ‰setOnKeyListenerç­‰ï¼Œå½“ä¸€ä¸ªæŒ‰é”®äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¿™äº›æ–¹æ³•å°†ä¼šè¢«å›è°ƒï¼Œä½†æ˜¯åˆ°åº•å“ªä¸ªå…ˆå›è°ƒï¼Œå“ªä¸ªåå›è°ƒå‘¢ï¼Œä¸€ç›´ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼ŒåªçŸ¥é“ä¸ªå¤§æ¦‚ï¼Œä¸‹é¢å°†è¯¦ç»†è®²è¿°æŒ‰é”®åœ¨javaå±‚çš„åˆ†å‘è¿‡ç¨‹ï¼Œå…¶ä¸­é‡ç‚¹å…³æ³¨æŒ‰é”®äº‹ä»¶åœ¨Viewå±‚æ¬¡ä¸­çš„åˆ†å‘</p><p>javaå±‚çš„æŒ‰é”®åˆ†å‘ä»ViewRootImpl.javaçš„WindowInputEventReceiverä¸­çš„onInputEventå¼€å§‹ï¼Œä»å‰é¢çš„åº”ç”¨ç¨‹åºæ³¨å†Œæ¶ˆæ¯ç›‘å¬è¿‡ç¨‹åˆ†æå’ŒInput Dispatcheråˆ†æï¼ŒInputDispatcheråœ¨å¤„ç†æŒ‰é”®äº‹ä»¶æ—¶ï¼Œä¼šé€šè¿‡InputChannel::sendMessageå‡½æ•°å°†æŒ‰é”®æ¶ˆæ¯ä»serverç«¯å†™å…¥ï¼Œè¿™é‡Œçš„InputChannelæ˜¯å½“å‰è·å–ç„¦ç‚¹çš„çª—å£çš„InputChannelå¯¹çš„serverç«¯ï¼Œè¿™æ ·åº”ç”¨ç¨‹åºç«¯å°±å¯ä»¥æ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨NativeInputEventReceiverçš„handleEvent,æœ€åè°ƒç”¨åˆ°InputEventReceiverçš„onInputEventå‡½æ•°ï¼ˆå…·ä½“çš„å¯ä»¥çœ‹åº”ç”¨ç¨‹åºæ³¨å†Œæ¶ˆæ¯ç›‘å¬è¿‡ç¨‹åˆ†æ çš„Step20-Step23ï¼‰</p><p>åºåˆ—å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N27-Android-Input-System-input-stage.png" alt="Markdown"></p><h2 id="Step-1ã€WindowInputEventReceiver-onInputEvent"><a href="#Step-1ã€WindowInputEventReceiver-onInputEvent" class="headerlink" title="Step 1ã€WindowInputEventReceiver.onInputEvent()"></a>Step 1ã€WindowInputEventReceiver.onInputEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowInputEventReceiver</span> <span class="keyword">extends</span> <span class="title">InputEventReceiver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WindowInputEventReceiver</span><span class="params">(InputChannel inputChannel, Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(inputChannel, looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInputEvent</span><span class="params">(InputEvent event)</span> </span>&#123;</span><br><span class="line">        enqueueInputEvent(event, <span class="keyword">this</span>, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªåˆ—å‡ºéƒ¨åˆ†ä»£ç ï¼Œå½“ä¸€ä¸ªæŒ‰é”®æŒ‰ä¸‹æ—¶onInputEventæ–¹æ³•å°±ä¼šè¢«å›è°ƒï¼Œå…¶ä¸­è°ƒç”¨äº†ViewRootImpl::enqueueInputEvent(event, this, 0, true);</p><h2 id="Step-2ã€ViewRootImpl-enqueueInputEvent"><a href="#Step-2ã€ViewRootImpl-enqueueInputEvent" class="headerlink" title="Step 2ã€ViewRootImpl.enqueueInputEvent()"></a>Step 2ã€ViewRootImpl.enqueueInputEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueInputEvent</span><span class="params">(InputEvent event,</span></span></span><br><span class="line"><span class="function"><span class="params">        InputEventReceiver receiver, <span class="keyword">int</span> flags, <span class="keyword">boolean</span> processImmediately)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªQueuedInputEventï¼Œè¿™é‡Œçš„flagsä¼ å…¥çš„æ˜¯0</span></span><br><span class="line">    QueuedInputEvent q = obtainQueuedInputEvent(event, receiver, flags);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (processImmediately) &#123;</span><br><span class="line">        doProcessInputEvents();<span class="comment">//è¿™é‡Œä¼ å…¥çš„processImmediatelyæ˜¯trueï¼Œæ‰€ä»¥è°ƒç”¨doProcessInputEvents</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        scheduleProcessInputEvents();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»å‰é¢çš„å‚æ•°å¯çŸ¥ï¼Œè¿™é‡Œè¡¨ç¤ºè¦ç«‹å³å¤„ç†ï¼Œæ‰€ä»¥è°ƒç”¨doProcessInputEventså‡½æ•°.</p><h2 id="Step-3ã€ViewRootImpl-doProcessInputEvents"><a href="#Step-3ã€ViewRootImpl-doProcessInputEvents" class="headerlink" title="Step 3ã€ViewRootImpl.doProcessInputEvents()"></a>Step 3ã€ViewRootImpl.doProcessInputEvents()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/view/ViewRootImpl.java</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doProcessInputEvents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Deliver all pending input events in the queue.</span></span><br><span class="line">    <span class="keyword">while</span> (mPendingInputEventHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        QueuedInputEvent q = mPendingInputEventHead;</span><br><span class="line">        mPendingInputEventHead = q.mNext;</span><br><span class="line">        <span class="keyword">if</span> (mPendingInputEventHead == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPendingInputEventTail = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        q.mNext = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        mPendingInputEventCount -= <span class="number">1</span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// åˆ†å‘æŒ‰é”®äº‹ä»¶</span></span><br><span class="line">        deliverInputEvent(q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨deliverInputEventå‡½æ•°ä¸­å®é™…åšæŒ‰é”®çš„åˆ†å‘</p><h2 id="Step-4ã€ViewRootImpl-deliverInputEvent"><a href="#Step-4ã€ViewRootImpl-deliverInputEvent" class="headerlink" title="Step 4ã€ViewRootImpl.deliverInputEvent()"></a>Step 4ã€ViewRootImpl.deliverInputEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverInputEvent</span><span class="params">(QueuedInputEvent q)</span> </span>&#123;</span><br><span class="line">    Trace.asyncTraceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"deliverInputEvent"</span>,</span><br><span class="line">            q.mEvent.getSequenceNumber());</span><br><span class="line">    <span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mInputEventConsistencyVerifier.onInputEvent(q.mEvent, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    InputStage stage;</span><br><span class="line">    <span class="keyword">if</span> (q.shouldSendToSynthesizer()) &#123;</span><br><span class="line">        stage = mSyntheticInputStage;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//é€‰æ‹©è´£ä»»é“¾çš„æ¨¡å¼çš„å…¥å£ï¼Œå¦‚æœInputEventéœ€è¦è·³è¿‡IMEå¤„ç†ï¼Œåˆ™ä»mFirstPostImeInputStageï¼ˆEarlyPostImeInputStageï¼‰å¼€å§‹,å¦åˆ™ä»mFirstInputStage(NativePreImeInputStage)å¼€å§‹åˆ†å‘</span></span><br><span class="line">        stage = q.shouldSkipIme() ? mFirstPostImeInputStage : mFirstInputStage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stage != <span class="keyword">null</span>) &#123;</span><br><span class="line">        stage.deliver(q);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        finishInputEvent(q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº†InputStageçš„deliveræ–¹æ³•åˆ†å‘ï¼Œè¿™é‡Œçš„InputStageä»£è¡¨äº†è¾“å…¥äº‹ä»¶çš„å¤„ç†é˜¶æ®µï¼Œæ˜¯ä¸€ç§è´£ä»»é“¾æ¨¡å¼ InputStageå°†è¾“å…¥äº‹ä»¶çš„å¤„ç†åˆ†æˆè‹¥å¹²ä¸ªé˜¶æ®µï¼ˆStageï¼‰, å¦‚æœå½“å‰æœ‰è¾“å…¥æ³•çª—å£ï¼Œåˆ™äº‹ä»¶å¤„ç†ä» NativePreIme å¼€å§‹ï¼Œå¦åˆ™çš„è¯ï¼Œä»EarlyPostIme å¼€å§‹ã€‚äº‹ä»¶ä¼šä¾æ¬¡ç»è¿‡æ¯ä¸ªStageï¼Œå¦‚æœè¯¥äº‹ä»¶æ²¡æœ‰è¢«æ ‡è¯†ä¸º â€œFinishedâ€ï¼Œ è¯¥Stageå°±ä¼šå¤„ç†å®ƒï¼Œç„¶åè¿”å›å¤„ç†ç»“æœï¼ŒForward æˆ– Finishï¼Œ Forward è¿è¡Œä¸‹ä¸€Stageç»§ç»­å¤„ç†ï¼Œè€ŒFinishedäº‹ä»¶å°†ä¼šç®€å•çš„Forwardåˆ°ä¸‹ä¸€çº§ï¼Œç›´åˆ°æœ€åä¸€çº§ Synthetic InputStageã€‚æµç¨‹å›¾å’Œæ¯ä¸ªé˜¶æ®µå®Œæˆçš„äº‹æƒ…å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N28-Android-Input-System-input-stage-GUI.png" alt="Markdown"></p><p>è´£ä»»é“¾æ¨¡å¼ï¼š è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibilityï¼‰çš„ç›®æ ‡æ˜¯ä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œé¿å…è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»ã€‚å°†è¿™äº›å¯¹è±¡è¿æˆä¸€æ¡é“¾ï¼Œå¹¶æ²¿ç€è¿™æ¡é“¾ä¼ é€’è¯·æ±‚ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªå¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢ã€‚</p><p>æŒ‰é”®åˆ†å‘ï¼š åœ¨ViewRootImplçš„setViewå‡½æ•°ä¸­ä¼šæ„é€ ä¸€ä¸ªå¦‚å›¾æ‰€ç¤ºçš„InputStageçš„é“¾ï¼ŒæŒ‰é”®ä¼šä»å…¥å£é˜¶æ®µï¼Œè¿›å…¥è´£ä»»é“¾ï¼Œé¡ºåºå¤„ç†ï¼Œå…¥å£é˜¶æ®µæ ¹æ®QueuedInputEventçš„çŠ¶æ€æ¥å†³å®šã€‚q.shouldSendToSynthesizer() è¿™é‡Œä¸€èˆ¬æ˜¯falseï¼Œå› æ­¤ä¸»è¦çœ‹stage = q.shouldSkipIme() ? mFirstPostImeInputStage : mFirstInputStage; è¿™é‡Œçš„shouldSkipImeå…¶å®æ˜¯ä¸€ä¸ªflagåœ¨æ„é€ QueuedInputEventæ—¶ä¼ å…¥çš„ï¼Œä»å‰é¢çš„onInputEventè°ƒç”¨çš„enqueueInputEvent(event, this, 0, true);å¯çŸ¥ï¼Œè¿™é‡Œä¼ å…¥çš„flagsæ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°0ï¼Œé‚£è¿™é‡Œçš„shouldSkipImeå°±æ˜¯falseï¼Œé‚£ä¹ˆæŒ‰é”®ä¼šä»mFirstPostImeInputStage å¼€å§‹åˆ†å‘ï¼Œå°±æ˜¯å›¾ä¸­çš„NativePreImeInputStageåˆ†å‘ã€‚</p><p>ä¸‹é¢åªä»è·Ÿæœ¬æ–‡å‰é¢æåˆ°çš„Activityï¼ŒViewçš„æŒ‰é”®åˆ†å‘æµç¨‹ç›¸å…³çš„InputStageï¼ˆViewPostImeInputStageï¼‰å¼€å§‹åˆ†æ</p><h2 id="Step-5ã€ViewPostImeInputStage-processKeyEvent"><a href="#Step-5ã€ViewPostImeInputStage-processKeyEvent" class="headerlink" title="Step 5ã€ViewPostImeInputStage.processKeyEvent()"></a>Step 5ã€ViewPostImeInputStage.processKeyEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">processKeyEvent</span><span class="params">(QueuedInputEvent q)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> KeyEvent event = (KeyEvent)q.mEvent;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Deliver the key to the view hierarchy.</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨æˆå‘˜å˜é‡mViewçš„dispatchKeyEventå‡½æ•°ï¼Œè¿™é‡ŒmViewæ˜¯PhoneWindow.DecorViewå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (mView.dispatchKeyEvent(event)) &#123;</span><br><span class="line">        <span class="keyword">return</span> FINISH_HANDLED;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// å¦‚æœæŒ‰é”®æ˜¯å››å‘é”®æˆ–è€…æ˜¯TABé”®ï¼Œåˆ™ç§»åŠ¨ç„¦ç‚¹</span></span><br><span class="line">    <span class="comment">// Handle automatic focus changes.</span></span><br><span class="line">    <span class="keyword">if</span> (event.getAction() == KeyEvent.ACTION_DOWN) &#123;</span><br><span class="line">        <span class="keyword">int</span> direction = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span> (event.getKeyCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> KeyEvent.KEYCODE_DPAD_LEFT:</span><br><span class="line">                <span class="keyword">if</span> (event.hasNoModifiers()) &#123;</span><br><span class="line">                    direction = View.FOCUS_LEFT;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">case</span> KeyEvent.KEYCODE_TAB:</span><br><span class="line">                <span class="keyword">if</span> (event.hasNoModifiers()) &#123;</span><br><span class="line">                    direction = View.FOCUS_FORWARD;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.hasModifiers(KeyEvent.META_SHIFT_ON)) &#123;</span><br><span class="line">                    direction = View.FOCUS_BACKWARD;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (direction != <span class="number">0</span>) &#123;</span><br><span class="line">            View focused = mView.findFocus();</span><br><span class="line">            <span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</span><br><span class="line">                View v = focused.focusSearch(direction);</span><br><span class="line">                <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; v != focused) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                    focused.getFocusedRect(mTempRect);</span><br><span class="line">                    <span class="keyword">if</span> (mView <span class="keyword">instanceof</span> ViewGroup) &#123;</span><br><span class="line">                        ((ViewGroup) mView).offsetDescendantRectToMyCoords(</span><br><span class="line">                                focused, mTempRect);</span><br><span class="line">                        ((ViewGroup) mView).offsetRectIntoDescendantCoords(</span><br><span class="line">                                v, mTempRect);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (v.requestFocus(direction, mTempRect)) &#123;</span><br><span class="line">                        playSoundEffect(SoundEffectConstants</span><br><span class="line">                                .getContantForFocusDirection(direction));</span><br><span class="line">                        <span class="keyword">return</span> FINISH_HANDLED;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Give the focused view a last chance to handle the dpad key.</span></span><br><span class="line">                <span class="keyword">if</span> (mView.dispatchUnhandledMove(focused, direction)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> FINISH_HANDLED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// find the best view to give focus to in this non-touch-mode with no-focus</span></span><br><span class="line">                View v = focusSearch(<span class="keyword">null</span>, direction);</span><br><span class="line">                <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; v.requestFocus(direction)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> FINISH_HANDLED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FORWARD;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸»è¦åˆ†ä¸¤æ­¥ï¼š ç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨PhoneWindow.DecorViewçš„dispatchKeyEventå‡½æ•°ï¼ŒDecorViewæ˜¯Viewå±‚æ¬¡ç»“æ„çš„æ ¹èŠ‚ç‚¹ï¼ŒæŒ‰é”®ä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ¹æ®Focuse viewçš„pathè‡ªä¸Šè€Œä¸‹çš„åˆ†å‘ã€‚ ç¬¬äºŒæ­¥æ˜¯åˆ¤æ–­æŒ‰é”®æ˜¯å¦æ˜¯å››å‘é”®ï¼Œæˆ–è€…æ˜¯TABé”®ï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦ç§»åŠ¨ç„¦ç‚¹</p><h2 id="Step-6ã€mView-dispatchKeyEvent"><a href="#Step-6ã€mView-dispatchKeyEvent" class="headerlink" title="Step 6ã€mView.dispatchKeyEvent()"></a>Step 6ã€mView.dispatchKeyEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;  </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!isDestroyed()) &#123;</span><br><span class="line">        <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> handled = cb != <span class="keyword">null</span> &amp;&amp; mFeatureId &lt; <span class="number">0</span> ? cb.dispatchKeyEvent(event)</span><br><span class="line">                : <span class="keyword">super</span>.dispatchKeyEvent(event);</span><br><span class="line">        <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isDown ? PhoneWindow.<span class="keyword">this</span>.onKeyDown(mFeatureId, event.getKeyCode(), event)</span><br><span class="line">            : PhoneWindow.<span class="keyword">this</span>.onKeyUp(mFeatureId, event.getKeyCode(), event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„åˆ†å‘åœ¨ä¸‹é¢å¼€å§‹ï¼Œå¦‚æœcbä¸ä¸ºç©ºå¹¶ä¸”mFeatureIdå°äº0ï¼Œåˆ™è°ƒç”¨cb.dispatchKeyEventå¼€å§‹åˆ†å‘ï¼Œå¦åˆ™ä¼šè°ƒç”¨DecorViewçš„çˆ¶ç±»ï¼ˆViewï¼‰çš„dispatchKeyEventå‡½æ•°ã€‚cbæ˜¯Window.Callbackç±»å‹ï¼ŒActivityå®ç°äº†Window.Callbackæ¥å£ï¼Œåœ¨attachå‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨Window.setCallbackå‡½æ•°å°†è‡ªå·±æ³¨å†Œè¿›PhoneWindowä¸­ï¼Œæ‰€ä»¥cbä¸ä¸ºç©ºã€‚åœ¨PhoneWindowåˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨installDecorå‡½æ•°ç”ŸæˆDecorViewå¯¹è±¡ï¼Œè¯¥å‡½æ•°ä¸­ä¼ å…¥çš„mFeatureIdæ˜¯-1ï¼Œæ‰€ä»¥mFeatureIdä¹Ÿå°äº0ã€‚å› æ­¤æ­¤å¤„ä¼šè°ƒç”¨Activityçš„dispatchKeyEventå‡½æ•°ï¼Œå¼€å§‹åœ¨Viewä¸­åˆ†å‘æŒ‰é”®ã€‚</p><p>ä¸‹é¢æ¥åˆ†ææŒ‰é”®åœ¨Viewçš„å±‚æ¬¡ç»“æ„ä¸­æ˜¯å¦‚ä½•åˆ†å‘çš„ DecorViewçš„æŒ‰é”®åˆ†å‘</p><p>æ¥ä¸‹æ¥æ¥çœ‹è¿™é‡Œå…ˆçœ‹çœ‹Activity(Callback)çš„dispatchKeyEventå®ç°ï¼š</p><h2 id="Step-7ã€Activity-dispatchKeyEvent"><a href="#Step-7ã€Activity-dispatchKeyEvent" class="headerlink" title="Step 7ã€Activity.dispatchKeyEvent()"></a>Step 7ã€Activity.dispatchKeyEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[frameworks/base/core/java/android/app/Activity.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è°ƒç”¨è‡ªå®šä¹‰çš„onUserInteraction</span></span><br><span class="line">    onUserInteraction();</span><br><span class="line"></span><br><span class="line">    Window win = getWindow();</span><br><span class="line">    <span class="comment">//è°ƒç”¨PhoneWindowçš„superDispatchKeyEvent,å®é™…è°ƒç”¨DecorViewçš„superDispatchKeyEventï¼Œä»DecorViewå¼€å§‹ä»é¡¶å±‚Viewå¾€å­è§†å›¾ä¼ é€’</span></span><br><span class="line">    <span class="keyword">if</span> (win.superDispatchKeyEvent(event)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    View decor = mDecor;</span><br><span class="line">    <span class="keyword">if</span> (decor == <span class="keyword">null</span>) decor = win.getDecorView();</span><br><span class="line">    <span class="comment">//åˆ°è¿™é‡Œå¦‚æœviewå±‚æ¬¡ç»“æ„æ²¡æœ‰è¿”å›trueåˆ™äº¤ç»™KeyEventæœ¬èº«çš„dispatchæ–¹æ³•ï¼ŒActivityçš„onKeyDown/onKeyUp/onKeyMultipleå°±ä¼šè¢«è§¦å‘</span></span><br><span class="line">    <span class="keyword">return</span> event.dispatch(<span class="keyword">this</span>, decor != <span class="keyword">null</span></span><br><span class="line">            ? decor.getKeyDispatcherState() : <span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹ä¸‹PhoneWindowçš„superDispatchKeyEvent</p><h2 id="Step-8ã€PhoneWindow-superDispatchKeyEvent"><a href="#Step-8ã€PhoneWindow-superDispatchKeyEvent" class="headerlink" title="Step 8ã€PhoneWindow.superDispatchKeyEvent()"></a>Step 8ã€PhoneWindow.superDispatchKeyEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- PhoneWindow.java --&gt;</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mDecor.superDispatchKeyEvent(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- PhoneWindow.DecorView --&gt;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Give priority to closing action modes if applicable.</span></span><br><span class="line">    <span class="keyword">if</span> (event.getKeyCode() == KeyEvent.KEYCODE_BACK) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> action = event.getAction();</span><br><span class="line">        <span class="comment">// Back cancels action modes first.</span></span><br><span class="line">        <span class="keyword">if</span> (mPrimaryActionMode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (action == KeyEvent.ACTION_UP) &#123;</span><br><span class="line">                mPrimaryActionMode.finish();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿›å…¥Viewçš„å±‚æ¬¡ç»“æ„ï¼Œè°ƒç”¨ViewGroup.dispatchKeyEvent</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.dispatchKeyEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹ViewGroupçš„dispatchKeyEventå‡½æ•°</p><h2 id="Step-9ã€ViewGroup-dispatchKeyEvent"><a href="#Step-9ã€ViewGroup-dispatchKeyEvent" class="headerlink" title="Step 9ã€ViewGroup.dispatchKeyEvent()"></a>Step 9ã€ViewGroup.dispatchKeyEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/ViewGroup.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; (PFLAG_FOCUSED | PFLAG_HAS_BOUNDS))</span><br><span class="line">            == (PFLAG_FOCUSED | PFLAG_HAS_BOUNDS)) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ­¤ViewGroupæ˜¯focusedå¹¶ä¸”å…·ä½“çš„å¤§å°è¢«è®¾ç½®äº†ï¼ˆæœ‰è¾¹ç•Œï¼‰ï¼Œåˆ™äº¤ç»™å®ƒå¤„ç†ï¼Œå³è°ƒç”¨Viewçš„å®ç°</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">super</span>.dispatchKeyEvent(event)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFocused != <span class="keyword">null</span> &amp;&amp; (mFocused.mPrivateFlags &amp; PFLAG_HAS_BOUNDS)</span><br><span class="line">            == PFLAG_HAS_BOUNDS) &#123;</span><br><span class="line">        <span class="comment">//å¦åˆ™ï¼Œå¦‚æœæ­¤ViewGroupä¸­æœ‰focusedçš„childï¼Œä¸”childæœ‰å…·ä½“çš„å¤§å°ï¼Œåˆ™äº¤ç»™mFocusedå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (mFocused.dispatchKeyEvent(event)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;    </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹å‡ºå¦‚æœViewGroupæ»¡è¶³æ¡ä»¶ï¼Œåˆ™ä¼˜å…ˆå¤„ç†äº‹ä»¶è€Œä¸å‘ç»™å­è§†å›¾å»å¤„ç†ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹Viewçš„dispatchKeyEventå®ç°</p><h2 id="Step-10ã€View-dispatchKeyEvent"><a href="#Step-10ã€View-dispatchKeyEvent" class="headerlink" title="Step 10ã€View.dispatchKeyEvent()"></a>Step 10ã€View.dispatchKeyEvent()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/view/View.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Give any attached key listener a first crack at the event.</span></span><br><span class="line">    <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">    ListenerInfo li = mListenerInfo;</span><br><span class="line">    <span class="comment">//è°ƒç”¨onKeyListenerï¼Œå¦‚æœæ³¨å†Œäº†OnKeyListener,å¹¶ä¸”Viewå±äºEnableçŠ¶æ€ï¼Œåˆ™è§¦å‘</span></span><br><span class="line">    <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnKeyListener != <span class="keyword">null</span> &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">            &amp;&amp; li.mOnKeyListener.onKey(<span class="keyword">this</span>, event.getKeyCode(), event)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="comment">//è°ƒç”¨KeyEvent.dispatchæ–¹æ³•ï¼Œå¹¶å°†viewä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ï¼Œå®é™…ä¼šå›è°ƒViewçš„onKeyUp/onKeyDownç­‰æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (event.dispatch(<span class="keyword">this</span>, mAttachInfo != <span class="keyword">null</span></span><br><span class="line">            ? mAttachInfo.mKeyDispatchState : <span class="keyword">null</span>, <span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;     </span><br><span class="line">    ...  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Step-11ã€View-onKeyDown-View-onKeyUp"><a href="#Step-11ã€View-onKeyDown-View-onKeyUp" class="headerlink" title="Step 11ã€View.onKeyDown/View.onKeyUp"></a>Step 11ã€View.onKeyDown/View.onKeyUp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[-&gt;frameworks/base/core/java/android/view/View.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyDown</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¤„ç†KEYCODE_DPAD_CENTERã€KEYCODE_ENTERæŒ‰é”®</span></span><br><span class="line">    <span class="keyword">if</span> (KeyEvent.isConfirmKey(keyCode)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">            <span class="comment">//disabledçš„viewç›´æ¥è¿”å›trueï¼Œä¸å†ç»§ç»­åˆ†å‘,å³Activityçš„onKeyDownå’ŒonKeyUpæ— æ³•æ”¶åˆ°KEYCODE_DPAD_CENTERã€KEYCODE_ENTERäº‹ä»¶</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Long clickable items don't necessarily have to be clickable</span></span><br><span class="line">        <span class="keyword">if</span> (((mViewFlags &amp; CLICKABLE) == CLICKABLE ||</span><br><span class="line">                (mViewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) &amp;&amp;</span><br><span class="line">                (event.getRepeatCount() == <span class="number">0</span>)) &#123;<span class="comment">// clickableæˆ–è€…long_clickableä¸”æ˜¯ç¬¬ä¸€æ¬¡downäº‹ä»¶</span></span><br><span class="line">            setPressed(<span class="keyword">true</span>);<span class="comment">// æ ‡è®°pressedï¼Œä½ å¯èƒ½è®¾ç½®äº†Viewä¸åŒçš„backgroundï¼Œè¿™æ—¶å€™å°±ä¼šæœ‰æ‰€ä½“ç°ï¼ˆæ¯”å¦‚é«˜äº®æ•ˆæœï¼‰</span></span><br><span class="line">            checkForLongClick(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyUp</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¤„ç†KEYCODE_DPAD_CENTERã€KEYCODE_ENTERæŒ‰é”®</span></span><br><span class="line">    <span class="keyword">if</span> (KeyEvent.isConfirmKey(keyCode)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">            <span class="comment">//disabledçš„viewç›´æ¥è¿”å›trueï¼Œä¸å†ç»§ç»­åˆ†å‘,å³Activityçš„onKeyDownå’ŒonKeyUpæ— æ³•æ”¶åˆ°KEYCODE_DPAD_CENTERã€KEYCODE_ENTERäº‹ä»¶</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((mViewFlags &amp; CLICKABLE) == CLICKABLE &amp;&amp; isPressed()) &#123;</span><br><span class="line">            setPressed(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mHasPerformedLongPress) &#123;</span><br><span class="line">                <span class="comment">// This is a tap, so remove the longpress check</span></span><br><span class="line">                removeLongPressCallback();</span><br><span class="line">                <span class="keyword">return</span> performClick();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Step-12ã€Activity-onKeyDown-onKeyUp"><a href="#Step-12ã€Activity-onKeyDown-onKeyUp" class="headerlink" title="Step 12ã€Activity.onKeyDown/onKeyUp"></a>Step 12ã€Activity.onKeyDown/onKeyUp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;frameworks/base/core/java/android/app/Activity.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyDown</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span>  </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯backé”®åˆ™å¯åŠ¨è¿½è¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getApplicationInfo().targetSdkVersion</span><br><span class="line">                &gt;= Build.VERSION_CODES.ECLAIR) &#123;</span><br><span class="line">            event.startTracking();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            onBackPressed();</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyUp</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getApplicationInfo().targetSdkVersion</span><br><span class="line">            &gt;= Build.VERSION_CODES.ECLAIR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK &amp;&amp; event.isTracking()</span><br><span class="line">                &amp;&amp; !event.isCanceled()) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ˜¯backé”®å¹¶ä¸”æ­£åœ¨è¿½è¸ªè¯¥Eventï¼Œåˆ™è°ƒç”¨onBackPressed</span></span><br><span class="line">            onBackPressed();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ŒAndroidå¸¸è§Touchäº‹ä»¶æ˜¯é€šè¿‡dispatchPointerEvent(MotionEvent event)åˆ†å‘çš„ï¼Œä¸»è¦è·Ÿåº•å±‚ä¼ ä¸Šæ¥çš„ è¾“å…¥äº‹ä»¶ç›¸å…³ï¼Œä¸åŒç±»å‹äº‹ä»¶åˆ†åˆ«å¤„ç†ã€‚ å…·ä½“Touchäº‹ä»¶åˆ†å‘æœºåˆ¶å¯å‚è€ƒåšå®¢ï¼š <a href="http://blog.csdn.net/guolin_blog/article/details/9097463/" target="_blank" rel="noopener">Androidäº‹ä»¶åˆ†å‘æœºåˆ¶å®Œå…¨è§£æï¼Œå¸¦ä½ ä»æºç çš„è§’åº¦å½»åº•ç†è§£(ä¸Š)</a> <a href="http://blog.csdn.net/guolin_blog/article/details/9153747/" target="_blank" rel="noopener">Androidäº‹ä»¶åˆ†å‘æœºåˆ¶å®Œå…¨è§£æï¼Œå¸¦ä½ ä»æºç çš„è§’åº¦å½»åº•ç†è§£(ä¸‹)</a> <a href="http://blog.csdn.net/yanbober/article/details/45887547" target="_blank" rel="noopener">Androidè§¦æ‘¸å±äº‹ä»¶æ´¾å‘æœºåˆ¶è¯¦è§£ä¸æºç åˆ†æä¸€(Viewç¯‡)</a> <a href="http://blog.csdn.net/yanbober/article/details/45912661" target="_blank" rel="noopener">Androidè§¦æ‘¸å±äº‹ä»¶æ´¾å‘æœºåˆ¶è¯¦è§£ä¸æºç åˆ†æäºŒ(ViewGroupç¯‡)</a> <a href="http://blog.csdn.net/yanbober/article/details/45932123" target="_blank" rel="noopener">Androidè§¦æ‘¸å±äº‹ä»¶æ´¾å‘æœºåˆ¶è¯¦è§£ä¸æºç åˆ†æä¸‰(Activityç¯‡)</a> <a href="http://hukai.me/android-deeper-touch-event-dispatch-process/" target="_blank" rel="noopener">Android Deeper(00) - Touchäº‹ä»¶åˆ†å‘å“åº”æœºåˆ¶</a><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N29-Android-Input-System-touch-event.png" alt="Markdown"></p><h2 id="ä¹ã€æ€»ç»“ï¼š"><a href="#ä¹ã€æ€»ç»“ï¼š" class="headerlink" title="ä¹ã€æ€»ç»“ï¼š"></a>ä¹ã€æ€»ç»“ï¼š</h2><p>å†è´´ä¸€ä¸‹Input systemæ€»ä½“æ¡†æ¶å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N30-Android-Input-System-input-system-framwork.png" alt="Markdown"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.input/N31-Android-Input-System-Input-kernel-driver-framwork-app.png" alt="Markdown"></p><h2 id="ï¼ˆä¸€ï¼‰ã€IMSåˆå§‹åŒ–-amp-amp-IMSä¸Appå»ºç«‹é€šä¿¡ï¼š"><a href="#ï¼ˆä¸€ï¼‰ã€IMSåˆå§‹åŒ–-amp-amp-IMSä¸Appå»ºç«‹é€šä¿¡ï¼š" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€IMSåˆå§‹åŒ–&amp;&amp; IMSä¸Appå»ºç«‹é€šä¿¡ï¼š"></a>ï¼ˆä¸€ï¼‰ã€IMSåˆå§‹åŒ–&amp;&amp; IMSä¸Appå»ºç«‹é€šä¿¡ï¼š</h2><ol><li><p>SystemServeråˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºInputManagerServiceï¼ŒIMSç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯åˆå§‹åŒ–Nativeå±‚ï¼ŒåŒ…æ‹¬EventHub, InputReader å’Œ InputDispatcher</p></li><li><p>IMSä»¥åŠå…¶ä»–çš„System Service åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œåº”ç”¨ç¨‹åºå°±å¼€å§‹å¯åŠ¨ã€‚å¦‚æœä¸€ä¸ªåº”ç”¨ç¨‹åºæœ‰Activityï¼ˆåªæœ‰Activitèƒ½å¤Ÿæ¥å—ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œå®ƒè¦å°†è‡ªå·±çš„Window(ViewRootImpl)é€šè¿‡setView()æ³¨å†Œåˆ°WindowManagerService ä¸­</p></li><li><p>ç”¨æˆ·è¾“å…¥çš„æ•æ‰å’Œå¤„ç†å‘ç”Ÿåœ¨ä¸åŒçš„è¿›ç¨‹é‡Œï¼ˆç”Ÿäº§è€…ï¼šInput Reader å’Œ Input Dispatcher åœ¨System Server è¿›ç¨‹é‡Œï¼Œè€Œæ¶ˆè´¹è€…ï¼Œåº”ç”¨ç¨‹åºè¿è¡Œåœ¨è‡ªå·±çš„è¿›ç¨‹é‡Œï¼‰ï¼Œå› æ­¤ç”¨æˆ·è¾“å…¥äº‹ä»¶ï¼ˆEvent)çš„ä¼ é€’éœ€è¦è·¨è¿›ç¨‹ã€‚åœ¨è¿™é‡Œï¼ŒAndroidä½¿ç”¨äº†Socket + Binderæ¥å®Œæˆã€‚OpenInputChannelPair ç”Ÿæˆäº†ä¸¤ä¸ªSocketçš„FDï¼Œ ä»£è¡¨ä¸€ä¸ªåŒå‘é€šé“çš„ä¸¤ç«¯ï¼Œå‘ä¸€ç«¯å†™å…¥æ•°æ®ï¼Œå¦å¤–ä¸€ç«¯ä¾¿å¯ä»¥è¯»å‡ºï¼Œåä¹‹ä¾ç„¶ï¼Œå¦‚æœä¸€ç«¯æ²¡æœ‰å†™å…¥æ•°æ®ï¼Œå¦å¤–ä¸€ç«¯å»è¯»ï¼Œåˆ™é™·å…¥é˜»å¡ç­‰å¾…ã€‚OpenInputChannelPair() å‘ç”Ÿåœ¨WindowManager Service.addWindow()ä¸­</p></li><li><p>é€šè¿‡RegisterInputChannel, WindowManagerService å°†åˆšåˆšåˆ›å»ºçš„ä¸€ä¸ªSocket FDï¼Œå°è£…åœ¨InputWindowHandle(ä»£è¡¨ä¸€ä¸ªWindowState) é‡Œä¼ ç»™InputManagerService</p></li><li><p>InputManagerService é€šè¿‡JNIï¼ˆNativeInputManagerï¼‰æœ€ç»ˆè°ƒç”¨åˆ°äº†InputDispatcher çš„ RegisterInputChannel()æ–¹æ³•ï¼Œè¿™é‡Œï¼Œä¸€ä¸ªConnection å¯¹è±¡è¢«åˆ›å»ºå‡ºæ¥ï¼Œä»£è¡¨ä¸è¿œç«¯æŸä¸ªçª—å£(InputWindowHandle)çš„ä¸€æ¡ç”¨æˆ·è¾“å…¥æ•°æ®é€šé“ã€‚ä¸€ä¸ªDispatcherå¯èƒ½æœ‰å¤šä¸ªConnectionï¼ˆå¤šä¸ªWindowï¼‰åŒæ—¶å­˜åœ¨ã€‚ä¸ºäº†ç›‘å¬æ¥è‡ªäºWindowçš„æ¶ˆæ¯ï¼ŒInputDispatcher é€šè¿‡AddFd å°†è¿™äº›ä¸ªFD åŠ å…¥åˆ°Looperä¸­ï¼Œè¿™æ ·ï¼Œåªè¦æŸä¸ªWindowåœ¨Socketçš„å¦ä¸€ç«¯å†™å…¥æ•°æ®ï¼ŒLooperå°±ä¼šé©¬ä¸Šä»ç¡çœ ä¸­é†’æ¥ï¼Œè¿›è¡Œå¤„ç†ã€‚</p></li><li><p>åˆ°è¿™é‡Œï¼ŒViewRootImpl mWindowSession.addToDisplayè¿”å›ï¼ŒWMS å°†SocketPairçš„å¦å¤–ä¸€ä¸ªFD æ”¾åœ¨è¿”å›å‚æ•° OutputChannel é‡Œï¼Œå³è¿”å›ç»™APPè¿›ç¨‹ã€‚</p></li><li><p>æ¥ç€ViewRootImpl åˆ›å»ºäº†WindowInputEventReceiver ç”¨äºæ¥å—InputDispatchor ä¼ è¿‡æ¥çš„äº‹ä»¶ï¼ŒAppè¿›ç¨‹åŒæ ·é€šè¿‡AddFd() å°†è¯»ç«¯çš„Socket FD åŠ å…¥åˆ°Looperä¸­ï¼Œè¿™æ ·ä¸€æ—¦InputDispatchorå‘é€Eventï¼ŒLooperå°±ä¼šç«‹å³é†’æ¥å¤„ç†ã€‚</p></li></ol><h2 id="ï¼ˆäºŒï¼‰ã€Eventhub-å’Œ-Input-Reader"><a href="#ï¼ˆäºŒï¼‰ã€Eventhub-å’Œ-Input-Reader" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Eventhub å’Œ Input Reader"></a>ï¼ˆäºŒï¼‰ã€Eventhub å’Œ Input Reader</h2><ol><li><p>NativeInputManagerçš„æ„é€ å‡½æ•°é‡Œç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯åˆ›å»ºä¸€ä¸ªEventHubå¯¹è±¡ï¼ŒEventHubæ„é€ å‡½æ•°é‡Œä¸»è¦ç”Ÿæˆå¹¶åˆå§‹åŒ–å‡ ä¸ªæ§åˆ¶çš„FD</p></li><li><p>mINotifyFd: ç”¨æ¥ç›‘æ§â€â€/dev/inputâ€ç›®å½•ä¸‹æ˜¯å¦æœ‰æ–‡ä»¶ç”Ÿæˆï¼Œæœ‰çš„è¯è¯´æ˜æœ‰æ–°çš„è¾“å…¥è®¾å¤‡æ¥å…¥ï¼ŒEventHubå°†ä»epool_waitä¸­å”¤é†’ï¼Œæ¥æ‰“å¼€æ–°åŠ å…¥çš„è®¾å¤‡ mWakeReaderFDï¼Œ mWakeWriterFDï¼š ä¸€ä¸ªPipeçš„ä¸¤ç«¯ï¼Œå½“å¾€mWakeWriteFD å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œç­‰å¾…åœ¨mWakeReaderFDçš„çº¿ç¨‹è¢«å”¤é†’ï¼Œè¿™é‡Œç”¨æ¥ç»™ä¸Šå±‚åº”ç”¨æä¾›å”¤é†’ç­‰å¾…çº¿ç¨‹ï¼Œæ¯”å¦‚è¯´ï¼Œå½“ä¸Šå±‚åº”ç”¨æ”¹å˜è¾“å…¥å±æ€§éœ€è¦EventHubè¿›è¡Œç›¸åº”æ›´æ–°æ—¶</p></li><li><p>mEpollFDï¼Œç”¨äºepoll_wait()çš„é˜»å¡ç­‰å¾…ï¼Œè¿™é‡Œé€šè¿‡epoll_ctrl(EPOLL_ADD_FD, fd) å¯ä»¥ç­‰å¾…å¤šä¸ªfdçš„äº‹ä»¶ï¼ŒåŒ…æ‹¬ä¸Šé¢æåˆ°çš„mINotifyFD, mWakeReaderFD, ä»¥åŠè¾“å…¥è®¾å¤‡çš„FDã€‚</p></li><li><p>InputManagerServiceå¯åŠ¨InputReader çº¿ç¨‹ï¼Œè¿›å…¥æ— é™çš„å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯è°ƒç”¨loopOnce(). ç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œä¼šä¸»åŠ¨æ‰«æ â€œ/dev/input/â€œ ç›®å½•ï¼Œå¹¶æ‰“å¼€ä¸‹é¢çš„æ‰€æœ‰æ–‡ä»¶ï¼Œé€šè¿‡ioctl()ä»åº•å±‚é©±åŠ¨è·å–è®¾å¤‡ä¿¡æ¯ï¼Œå¹¶åˆ¤æ–­å®ƒçš„è®¾å¤‡ç±»å‹ã€‚è¿™é‡Œå¤„ç†çš„è®¾å¤‡ç±»å‹æœ‰ï¼šINPUT_DEVICE_CLASS_KEYBOARDï¼Œ INPUT_DEVICE_CLASS_TOUCHï¼Œ INPUT_DEVICE_CLASS_DPADï¼ŒINPUT_DEVICE_CLASS_JOYSTICK ç­‰ã€‚</p></li><li><p>æ‰¾åˆ°æ¯ä¸ªè®¾å¤‡å¯¹åº”çš„é”®å€¼æ˜ å°„æ–‡ä»¶ï¼Œè¯»å–å¹¶ç”Ÿäº§ä¸€ä¸ªKeyMap å¯¹è±¡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè®¾å¤‡å¯¹åº”çš„é”®å€¼æ˜ å°„æ–‡ä»¶æ˜¯ â€œ/system/usr/keylayout/Generic.klâ€.</p></li><li><p>å°†åˆšæ‰æ‰«æåˆ°çš„/dev/input ä¸‹æ‰€æœ‰æ–‡ä»¶çš„FD åŠ åˆ°epoolç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œè°ƒç”¨epool_wait() å¼€å§‹ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚</p></li><li><p>æŸä¸ªæ—¶é—´å‘ç”Ÿï¼Œå¯èƒ½æ˜¯ç”¨æˆ·æŒ‰é”®è¾“å…¥ï¼Œä¹Ÿå¯èƒ½æ˜¯æŸä¸ªè®¾å¤‡æ’å…¥ï¼Œäº¦æˆ–ç”¨æˆ·è°ƒæ•´äº†è®¾å¤‡å±æ€§ï¼Œepoll_wait() è¿”å›ï¼Œå°†å‘ç”Ÿçš„Event å­˜æ”¾åœ¨mPendingEventItems é‡Œã€‚å¦‚æœè¿™æ˜¯ä¸€ä¸ªç”¨æˆ·è¾“å…¥ï¼Œç³»ç»Ÿè°ƒç”¨Read() ä»é©±åŠ¨è¯»åˆ°è¿™ä¸ªæŒ‰é”®çš„ä¿¡æ¯ï¼Œå­˜æ”¾åœ¨rawEventsé‡Œã€‚</p></li><li><p>EventHub-&gt;getEvents() è¿”å›,ä»£è¡¨æœ‰æ–°çš„inputäº‹ä»¶åˆ°æ¥ï¼Œè¿›å…¥InputReaderçš„processEventLockedå‡½æ•°ã€‚</p></li><li><p>é€šè¿‡rawEvent æ‰¾åˆ°äº§ç”Ÿæ—¶é—´çš„Deviceï¼Œå†æ‰¾åˆ°è¿™ä¸ªDeviceå¯¹åº”çš„InputMapperå¯¹è±¡ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªNotifyArgså¯¹è±¡ï¼Œå°†å…¶æ”¾åˆ°NotifyArgsçš„é˜Ÿåˆ—ä¸­ã€‚</p></li><li><p>è°ƒç”¨NotifyArgsé‡Œé¢çš„Notify()æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°InputDispatchor å¯¹åº”çš„Notifyæ¥å£ï¼ˆæ¯”å¦‚NotifyKey) å°†æ¥ä¸‹æ¥çš„å¤„ç†äº¤ç»™InputDispatchorï¼ŒEventHub å’Œ InputReader å·¥ä½œç»“æŸï¼Œä½†é©¬ä¸Šåˆå¼€å§‹æ–°çš„ä¸€è½®ç­‰å¾…ï¼Œé‡å¤6ï½9çš„å¾ªç¯ã€‚</p></li></ol><h2 id="ï¼ˆä¸‰ï¼‰ã€Input-Dispatcher"><a href="#ï¼ˆä¸‰ï¼‰ã€Input-Dispatcher" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Input Dispatcher"></a>ï¼ˆä¸‰ï¼‰ã€Input Dispatcher</h2><ol><li><p>æ¥ä¸ŠèŠ‚çš„æœ€åä¸€æ­¥ï¼ŒNotifyKey() çš„å®ç°åœ¨Input Dispatcher å†…éƒ¨ï¼Œä»–é¦–å…ˆåšç®€å•çš„æ ¡éªŒï¼Œå¯¹äºæŒ‰é”®äº‹ä»¶ï¼Œåªæœ‰Action æ˜¯ AKEY_EVENT_ACTION_DOWN å’Œ AKEY_EVENT_ACTION_UPï¼Œå³æŒ‰ä¸‹å’Œå¼¹èµ·è¿™ä¸¤ä¸ªEventåˆ«æ¥å—ã€‚</p></li><li><p>Input Reader ä¼ ç»™Input Dispatherçš„æ•°æ®ç±»å‹æ˜¯ NotifyKeyArgsï¼Œ åè€…åœ¨è¿™é‡Œå°†å…¶è½¬æ¢ä¸º KeyEvent, ç„¶åäº¤ç”± Policy æ¥è¿›è¡Œç¬¬ä¸€æ­¥çš„è§£æå’Œè¿‡æ»¤ï¼ŒinterceptKeyBeforeDispatching(), å¯¹äºæ‰‹æœºäº§å“ï¼Œè¿™ä¸ªå·¥ä½œæ˜¯åœ¨PhoneWindowManager é‡Œå®Œæˆï¼Œï¼ˆä¸åŒç±»å‹çš„äº§å“å¯ä»¥å®šä¹‰ä¸åŒçš„WindowManager, æ¯”å¦‚GoogleTV é‡Œç”¨åˆ°çš„æ˜¯TVWindowManager)ã€‚KeyEvent åœ¨è¿™é‡Œå°†ä¼šè¢«åˆ†ä¸ºä¸‰ç±»ï¼š</p><ol><li>System Key: æ¯”å¦‚è¯´ éŸ³é‡é”®ï¼ŒPoweré”®ï¼Œä»¥åŠä¸€äº›ç‰¹æ®Šçš„ç»„åˆé”®ï¼Œå¦‚ç”¨äºæˆªå±çš„éŸ³é‡+Powerï¼Œç­‰ç­‰ã€‚éƒ¨åˆ†System Key ä¼šåœ¨è¿™é‡Œç«‹å³å¤„ç†ï¼Œæ¯”å¦‚è¯´ç”µè¯é”®ï¼Œä½†æœ‰ä¸€äº›ä¼šæ”¾åˆ°åé¢å»åšå¤„ç†ï¼Œæ¯”å¦‚è¯´éŸ³é‡é”®ï¼Œä½†ä¸ç®¡æ€æ ·ï¼Œè¿™äº›é”®ä¸ä¼šä¼ ç»™åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥ç§°ä¸ºç³»ç»Ÿé”®ã€‚</li><li>Global Keyï¼šæœ€ç»ˆäº§å“ä¸­å¯èƒ½ä¼šæœ‰ä¸€äº›ç‰¹æ®Šçš„æŒ‰é”®ï¼Œå®ƒä¸å±äºæŸä¸ªç‰¹å®šçš„åº”ç”¨ï¼Œåœ¨æ‰€æœ‰åº”ç”¨ä¸­çš„è¡Œä¸ºéƒ½æ˜¯ä¸€æ ·ï¼Œä½†ä¹Ÿä¸åŒ…å«åœ¨Andrioidçš„ç³»ç»Ÿé”®ä¸­ï¼Œæ¯”å¦‚è¯´GoogleTV é‡Œä¼šæœ‰ä¸€ä¸ªâ€TVâ€ æŒ‰é”®ï¼ŒæŒ‰å®ƒä¼šç›´æ¥å‘¼èµ·â€TVâ€åº”ç”¨ç„¶åæ”¶çœ‹ç”µè§†ç›´æ’­ï¼Œè¿™ç±»æŒ‰é”®åœ¨Androidå®šä¹‰ä¸ºGlobal Key.</li><li>User Keyï¼šé™¤æ­¤ä¹‹å¤–çš„æŒ‰é”®å°±æ˜¯User Key, å®ƒæœ€ç»ˆä¼šä¼ é€’åˆ°å½“å‰çš„åº”ç”¨çª—å£ã€‚</li></ol></li><li><p>æ­¤æ—¶ï¼ŒInputDispather è¿˜åœ¨Looperä¸­ç¡çœ ç­‰å¾…ï¼ŒmLooper-&gt;wake();å°†å…¶å”¤é†’ï¼Œç„¶åè¿›å…¥Input Dispatcher çº¿ç¨‹ã€‚</p></li><li><p>InputDispatcher å¤§éƒ¨åˆ†çš„å·¥ä½œåœ¨ dispatcherOnce é‡Œå®Œæˆã€‚é¦–å…ˆä»mInBoundQueue ä¸­è¯»å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„äº‹ä»¶ mPendingEvent, ç„¶åè°ƒç”¨ pokeUserActivityLocked()ã€‚ pokeçš„è‹±æ–‡æ„æ€æ˜¯â€æ“ä¸€ä¸‹, æ…ä¸€ä¸‹â€ï¼Œ è¿™ä¸ªå‡½æ•°çš„ç›®çš„ä¹Ÿå°±æ˜¯â€æ…ä¸€ä¸‹â€PowerManagerService æé†’å®ƒâ€åˆ«ç¡çœ å•Šï¼Œæˆ‘è¿˜æ´»ç€å‘¢â€ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°PowerManagerService çš„ updatePowerStateLocked()ï¼Œé˜²æ­¢æ‰‹æœºè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°åŠ¨ä½œä¸ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯å­˜å‚¨åœ¨å‘½ä»¤é˜Ÿåˆ—ï¼ŒmCommandQueueé‡Œï¼Œè¿™é‡Œé¢çš„å‘½ä»¤ä¼šåœ¨åé¢ä¾æ¬¡è¢«æ‰§è¡Œã€‚</p></li><li><p>æ¥ä¸‹æ¥æ˜¯dispatchOnceInnerLocked()-&gt;dispatchKeyLocked() ç¬¬ä¸€æ¬¡è¿›å»è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå…ˆæ£€æŸ¥Eventæ˜¯å¦å·²ç»è¿‡å¤„ç†ï¼ˆdoInterceptKeyBeforeDispatchingLockedInterruptible), å¦‚æœæ²¡æœ‰ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªå‘½ä»¤ï¼ŒåŒæ ·æ”¾å…¥mCommandQueueé‡Œã€‚</p></li><li><p>runCommandsLockedInterruptible() ä¾æ¬¡æ‰§è¡ŒmCommandQueue é‡Œçš„å‘½ä»¤ï¼Œå‰é¢è¯´è¿‡ï¼ŒpokeUserActivity ä¼šè°ƒç”¨PowerManagerService çš„ updatePowerStateLocked(), è€Œ interceptKeyBeforeDispatching() åˆ™æœ€ç»ˆè°ƒç”¨åˆ°PhoneWindowManagerçš„åŒåå‡½æ•°ã€‚æˆ‘ä»¬åœ¨interceptBeforeQueuing é‡Œé¢æåˆ°çš„ä¸€äº›ç³»ç»ŸæŒ‰é”®åœ¨è¿™ä¸ªè¢«æ‰§è¡Œï¼Œæ¯”å¦‚ HOME/MENU/SEARCH ç­‰ã€‚</p></li><li><p>å‘½ä»¤è¿è¡Œå®Œä¹‹åï¼Œé€€å‡º dispatchOnceï¼Œ ç„¶åè°ƒç”¨pollOnce è¿›å…¥ä¸‹ä¸€è½®ç­‰å¾…ã€‚ä½†è¿™é‡Œä¸ä¼šè¢«é˜»å¡ï¼Œå› ä¸ºtimeoutå€¼è¢«è®¾æˆäº†0.</p></li><li><p>ç¬¬äºŒæ¬¡è¿›å…¥dispatchKeyLocked(), è¿™æ˜¯Eventçš„çŠ¶æ€å·²ç»è®¾ä¸ºâ€å·²å¤„ç†â€ï¼Œè¿™æ—¶å€™æ‰çœŸæ­£è¿›å…¥äº†å‘å°„é˜¶æ®µã€‚</p></li><li><p>æ¥ä¸‹æ¥è°ƒç”¨ findFocusedWindowTargetLocked() è·å–å½“å‰çš„ç„¦ç‚¹çª—å£ï¼Œè¿™é‡Œé¢ä¼šåšä¸€ä»¶éå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå°±æ˜¯æ£€æµ‹ç›®æ ‡åº”ç”¨æ˜¯å¦æœ‰ANRå‘ç”Ÿï¼Œå¦‚æœä¸‹è¯‰æ¡ä»¶æ»¡è¶³ï¼Œåˆ™è¯´æ˜å¯èƒ½å‘ç”Ÿäº†ANRï¼š</p><ol><li>ç›®æ ‡åº”ç”¨ä¸ä¼šç©ºï¼Œè€Œç›®æ ‡çª—å£ä¸ºç©ºã€‚è¯´æ˜åº”ç”¨ç¨‹åºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜ã€‚</li><li>ç›®æ ‡ Activity çš„çŠ¶æ€æ˜¯Pauseï¼Œå³ä¸å†æ˜¯Focusedçš„åº”ç”¨ã€‚</li><li>ç›®æ ‡çª—å£è¿˜åœ¨å¤„ç†ä¸Šä¸€ä¸ªäº‹ä»¶ã€‚è¿™ä¸ªæˆ‘ä»¬ä¸‹é¢ä¼šè¯´åˆ°ã€‚</li></ol></li><li><p>å¦‚æœç›®æ ‡çª—å£å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œè°ƒç”¨dispatchEventLocked() è¿›å…¥çœŸæ­£çš„å‘é€ç¨‹åºã€‚</p></li><li><p>ç„¶åè°ƒç”¨prepareDispatchCycleLocked() ,è¿™é‡Œäº‹ä»¶æ¢äº†ä¸€ä»¶é©¬ç”²ï¼Œä»EventEntry å˜æˆ DispatchEntry, å¹¶é€äººmOutBoundQueueã€‚ç„¶åè°ƒç”¨startDispatchCycleLocked() å¼€å§‹å‘é€ã€‚</p></li><li><p>æœ€ç»ˆçš„å‘é€å‘ç”Ÿåœ¨InputChannelçš„sendMessage()ã€‚è¿™é‡Œå°±ç”¨åˆ°äº†æˆ‘ä»¬å‰é¢æåˆ°çš„SocketPair, ä¸€æ—¦sendMessage() æ‰§è¡Œï¼Œç›®æ ‡çª—å£æ‰€åœ¨è¿›ç¨‹çš„Looperçº¿ç¨‹å°±ä¼šè¢«å”¤é†’ï¼Œç„¶åè¯»å–é”®å€¼å¹¶è¿›è¡Œå¤„ç†ã€‚</p></li><li><p>ä¹–ä¹–ï¼Œè¿˜æ²¡èµ°å®Œå•Šï¼Ÿæ˜¯çš„ï¼Œå·¥ä½œè¿˜å·®æœ€åä¸€æ­¥ï¼ŒInput Dispatcherç»™è¿™ä¸ªçª—å£å‘é€ä¸‹ä¸€ä¸ªå‘½ä»¤ä¹‹å‰ï¼Œå¿…é¡»ç­‰å¾…è¯¥çª—å£çš„å›å¤ï¼Œå¦‚æœè¶…è¿‡5sæ²¡æœ‰æ”¶åˆ°ï¼Œå°±ä¼šé€šè¿‡Input Manager Service å‘Activity Manager æ±‡æŠ¥ï¼Œåè€…ä¼šå¼¹å‡ºæˆ‘ä»¬ç†ŸçŸ¥çš„ â€œApplication No Responseâ€ çª—å£ã€‚æ‰€ä»¥ï¼Œäº‹ä»¶ä¼šæ”¾å…¥mWaitQueueè¿›è¡Œæš‚å­˜ã€‚å¦‚æœçª—å£ä¸€åˆ‡æ­£å¸¸ï¼Œå®ŒæˆæŒ‰é”®å¤„ç†åå®ƒä¼šè°ƒç”¨InputConsumerçš„sendFinishedSignal() å¾€SocketPair é‡Œå†™å…¥å®Œæˆä¿¡å·ï¼ŒInput Dispatcher ä» Loopä¸­é†’æ¥ï¼Œå¹¶ä»Socketä¸­è¯»å–è¯¥ä¿¡å·ï¼Œç„¶åä»mWaitQueue é‡Œæ¸…é™¤è¯¥äº‹ä»¶æ ‡å¿—å…¶å¤„ç†å®Œæ¯•ã€‚</p></li></ol><h2 id="ï¼ˆå››ï¼‰ã€Key-Processing"><a href="#ï¼ˆå››ï¼‰ã€Key-Processing" class="headerlink" title="ï¼ˆå››ï¼‰ã€Key Processing"></a>ï¼ˆå››ï¼‰ã€Key Processing</h2><p>ç•¥ã€è¯·å‚è€ƒï¼š <a href="https://www.cnblogs.com/samchen2009/p/3368158.html" target="_blank" rel="noopener">å›¾è§£Android - Android GUI ç³»ç»Ÿ (5) - Androidçš„Event Input System - æ¼«å¤©å°˜æ²™ - åšå®¢å›­</a></p><h2 id="å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢-ï¼š"><a href="#å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢-ï¼š" class="headerlink" title="å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢)ï¼š"></a>å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢)ï¼š</h2><p><a href="https://github.com/weidongshan" target="_blank" rel="noopener">éŸ¦ä¸œå±±ç¬¬4æœŸAndroidé©±åŠ¨æ·±åº¦å¼€å‘è§†é¢‘æºç -GitHub</a><br><a href="http://www.100ask.org/index.html" target="_blank" rel="noopener">éŸ¦ä¸œå±±ç¬¬4æœŸAndroidé©±åŠ¨æ·±åº¦å¼€å‘è§†é¢‘-è¾“å…¥ç³»ç»Ÿ-100ask.org</a><br><a href="http://blog.csdn.net/chenweiaiyanyan/article/category/6948320" target="_blank" rel="noopener">Androidè¾“å…¥å­ç³»ç»Ÿ-ChenWeiaiYanYan</a><br><a href="http://blog.csdn.net/innost/article/details/47660387" target="_blank" rel="noopener">ã€Šæ·±å…¥ç†è§£Android å·IIIã€‹ç¬¬äº”ç«  æ·±å…¥ç†è§£Androidè¾“å…¥ç³»ç»Ÿ - CSDNåšå®¢</a><br><a href="https://www.cnblogs.com/samchen2009/p/3368158.html" target="_blank" rel="noopener">å›¾è§£Android - Android GUI ç³»ç»Ÿ (5) - Androidçš„Event Input System - æ¼«å¤©å°˜æ²™ - åšå®¢å›­</a><br><a href="http://blog.csdn.net/jinzhuojun/article/details/41909159" target="_blank" rel="noopener">Android 5.0(Lollipop)äº‹ä»¶è¾“å…¥ç³»ç»Ÿ(Input System) - ä¸–äº‹éš¾æ–™ï¼Œä¿æŒä½è°ƒ - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/lcw/p/3506110.html" target="_blank" rel="noopener">ã€Androidã€‘Androidè¾“å…¥å­ç³»ç»Ÿ - Leo.cheng - åšå®¢å›­</a><br><a href="http://huaqianlee.github.io/2017/11/23/Android/Android-Linux-input-system-analysis/" target="_blank" rel="noopener">Android(Linux) è¾“å…¥å­ç³»ç»Ÿè§£æ | Andy.Leeâ€™s Blog</a><br><a href="http://www.cheelok.com/aosp/59" target="_blank" rel="noopener">INPUTäº‹ä»¶çš„è¯»å–å’Œåˆ†å‘ï¼šINPUTREADERã€INPUTDISPATCHER</a><br><a href="http://www.hustmeituan.club/tag/android.html" target="_blank" rel="noopener">Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶</a><br><a href="https://www.jianshu.com/p/84b2e0038080" target="_blank" rel="noopener">æ·±å…¥ç†è§£Androidä¹‹Touchäº‹ä»¶çš„åˆ†å‘</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2017/12/01/Android-7-1-2-Android-N-Android-è¾“å…¥å­ç³»ç»Ÿ-Input-System/">http://zhoujinjian.cc/2017/12/01/Android-7-1-2-Android-N-Android-è¾“å…¥å­ç³»ç»Ÿ-Input-System/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2017/11/01/Android-7-1-2-Android-N-Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹/" title="Android 7.1.2 (Android N) Activity - Window åŠ è½½æ˜¾ç¤ºæµç¨‹ï¼ˆAMS && WMSï¼‰åˆ†æ"><i class="iconfont icon-prev"></i>Android 7.1.2 (Android N) Activity - Window åŠ è½½æ˜¾ç¤ºæµç¨‹ï¼ˆAMS && WMSï¼‰åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2018/01/01/Android-7-1-2-Android-N-Android-Binderç³»ç»Ÿåˆ†æ/" title="Android 7.1.2 (Android N) Android Binder ç³»ç»Ÿ åˆ†æ">Android 7.1.2 (Android N) Android Binder ç³»ç»Ÿ åˆ†æ<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">21</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/" title="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" alt="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</h3><span class="item__text">2018-08-30</span></div></a></li><li class="latest-post-item"><a href="/2018/08/16/Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ/" title="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.22.jpg" alt="Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ4ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Gralloc && HWComposeræ¨¡å—åˆ†æ</h3><span class="item__text">2018-08-16</span></div></a></li><li class="latest-post-item"><a href="/2018/08/01/Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ/" title="Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æ ä¹‹  HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.21.jpg" alt="Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æ ä¹‹  HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ3ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æ ä¹‹ HardwareRenderer.draw()ç»˜åˆ¶æµç¨‹åˆ†æ</h3><span class="item__text">2018-08-01</span></div></a></li><li class="latest-post-item"><a href="/2018/07/20/Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL && OpenGL/" title="Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL && OpenGL"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.20.jpg" alt="Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL && OpenGL"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ2ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Android EGL && OpenGL</h3><span class="item__text">2018-07-20</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">327.5k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>