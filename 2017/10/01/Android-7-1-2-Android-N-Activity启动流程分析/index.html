<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android 7.1.2 (Android N) Activity å¯åŠ¨æµç¨‹ ï¼ˆAMSï¼‰åˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://zhoujinjian.cc/2017/10/01/Android-7-1-2-Android-N-Activityå¯åŠ¨æµç¨‹åˆ†æ/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.03.jpg" alt="Android 7.1.2 (Android N) Activity å¯åŠ¨æµç¨‹ ï¼ˆAMSï¼‰åˆ†æ"></div><header class="post__info"><h1 class="post__title">Android 7.1.2 (Android N) Activity å¯åŠ¨æµç¨‹ ï¼ˆAMSï¼‰åˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="http://zhoujinjian.cc/">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘.</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2017-10-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸€ã€æ¦‚è¿°"><span class="toc-text">ä¸€ã€æ¦‚è¿°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åšå®¢åŸå›¾é“¾æ¥"><span class="toc-text">åšå®¢åŸå›¾é“¾æ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1ã€Taskå’ŒStack"><span class="toc-text">1.1ã€Taskå’ŒStack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2ã€å°ç»“ï¼š"><span class="toc-text">1.2ã€å°ç»“ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ€»ä½“å¯åŠ¨æµç¨‹å›¾ï¼š"><span class="toc-text">æ€»ä½“å¯åŠ¨æµç¨‹å›¾ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#äºŒã€-å¼€å§‹è¯·æ±‚æ‰§è¡Œå¯åŠ¨Activity"><span class="toc-text">äºŒã€ å¼€å§‹è¯·æ±‚æ‰§è¡Œå¯åŠ¨Activity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1ã€Activity-startActivity"><span class="toc-text">2.1ã€Activity.startActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2ã€Activity-startActivityForResult"><span class="toc-text">2.2ã€Activity.startActivityForResult()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3ã€Instrumentation-execStartActivity"><span class="toc-text">2.3ã€Instrumentation.execStartActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4ã€ActivityManagerProxy-startActivity"><span class="toc-text">2.4ã€ActivityManagerProxy.startActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5ã€ActivityManagerNative-onTransact"><span class="toc-text">2.5ã€ActivityManagerNative.onTransact()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸‰ã€-ActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚"><span class="toc-text">ä¸‰ã€ ActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1ã€ActivityManagerService-startActivity"><span class="toc-text">3.1ã€ActivityManagerService.startActivity()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2ã€ActivityStarter-startActivityMayWait"><span class="toc-text">3.2ã€ActivityStarter.startActivityMayWait()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1ã€ActivityStackSupervisor-resolveActivity"><span class="toc-text">3.2.1ã€ActivityStackSupervisor.resolveActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2ã€PackageManagerService-resolveIntent"><span class="toc-text">3.2.2ã€PackageManagerService.resolveIntent()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3ã€ActivityStarter-startActivityLocked"><span class="toc-text">3.3ã€ActivityStarter.startActivityLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4ã€ActivityStarter-startActivityUnchecked"><span class="toc-text">3.4ã€ActivityStarter.startActivityUnchecked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1ã€ActivityStack-startActivityLocked"><span class="toc-text">3.4.1ã€ActivityStack.startActivityLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5ã€ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><span class="toc-text">3.5ã€ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6ã€ActivityStack-resumeTopActivityUncheckedLocked"><span class="toc-text">3.6ã€ActivityStack.resumeTopActivityUncheckedLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7ã€ActivityStack-resumeTopActivityInnerLocked"><span class="toc-text">3.7ã€ActivityStack.resumeTopActivityInnerLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-8ã€ActivityStackSupervisor-pauseBackStacks"><span class="toc-text">3.8ã€ActivityStackSupervisor.pauseBackStacks()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å››ã€æ‰§è¡Œæ ˆé¡¶Activityçš„onPauseæ–¹æ³•"><span class="toc-text">å››ã€æ‰§è¡Œæ ˆé¡¶Activityçš„onPauseæ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1ã€ActivityStack-startPausingLocked"><span class="toc-text">4.1ã€ActivityStack.startPausingLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2ã€ActivityThread-schedulePauseActivity"><span class="toc-text">4.2ã€ActivityThread.schedulePauseActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3ã€ActivityThread-sendMessage"><span class="toc-text">4.3ã€ActivityThread.sendMessage()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4ã€-ActivityThread-handleMessage-mH"><span class="toc-text">4.4ã€[ActivityThread.handleMessage() : mH]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5ã€ActivityThread-handlePauseActivity"><span class="toc-text">4.5ã€ActivityThread.handlePauseActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6ã€ActivityThread-performPauseActivity"><span class="toc-text">4.6ã€ActivityThread.performPauseActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7ã€Instrumentation-callActivityOnPuase"><span class="toc-text">4.7ã€Instrumentation.callActivityOnPuase()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7ã€Activity-performPause"><span class="toc-text">4.7ã€Activity.performPause()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#äº”ã€åˆ›å»ºActivityæ‰€å±çš„åº”ç”¨è¿›ç¨‹"><span class="toc-text">äº”ã€åˆ›å»ºActivityæ‰€å±çš„åº”ç”¨è¿›ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1ã€ActivityManagerService-startProcessLocked"><span class="toc-text">5.1ã€ActivityManagerService.startProcessLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2ã€Process-start"><span class="toc-text">5.2ã€Process.start()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3ã€Process-startViaZygote"><span class="toc-text">5.3ã€Process.startViaZygote()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4ã€Process-zygoteSendArgsAndGetResult"><span class="toc-text">5.4ã€Process.zygoteSendArgsAndGetResult()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5ã€Process-openZygoteSocketIfNeeded"><span class="toc-text">5.5ã€Process.openZygoteSocketIfNeeded()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6ã€ActivityThread-main"><span class="toc-text">5.6ã€ActivityThread.main()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7ã€ActivityThread-attach"><span class="toc-text">5.7ã€ActivityThread.attach()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8ã€ActivityManagerProxy-attachApplication"><span class="toc-text">5.8ã€ActivityManagerProxy .attachApplication()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-9ã€ActivityManagerNative-onTransact"><span class="toc-text">5.9ã€ActivityManagerNative.onTransact()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-10ã€ActivityManagerService-attachApplication"><span class="toc-text">5.10ã€ActivityManagerService.attachApplication()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-11ã€ApplicationThreadProxy-bindApplication"><span class="toc-text">5.11ã€ApplicationThreadProxy.bindApplication()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-12ã€ApplicationThreadNative-onTransact"><span class="toc-text">5.12ã€ApplicationThreadNative.onTransact()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-13ã€ApplicationThread-bindApplication"><span class="toc-text">5.13ã€ApplicationThread.bindApplication()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-14ã€ActivityThread-handleBindApplication"><span class="toc-text">5.14ã€ActivityThread.handleBindApplication()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å…­ã€æ‰§è¡Œå¯åŠ¨Acitivity"><span class="toc-text">å…­ã€æ‰§è¡Œå¯åŠ¨Acitivity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1ã€ActivityStackSupervisor-attachApplicationLocked"><span class="toc-text">6.1ã€ActivityStackSupervisor.attachApplicationLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2ã€ActivityStackSupervisor-realStartActivityLocked"><span class="toc-text">6.2ã€ActivityStackSupervisor.realStartActivityLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3ã€ApplicationThread-scheduleLaunchActivity"><span class="toc-text">6.3ã€ApplicationThread.scheduleLaunchActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4ã€H-handleMessage"><span class="toc-text">6.4ã€H.handleMessage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5ã€ActivityThread-handleLaunchActivity"><span class="toc-text">6.5ã€ActivityThread.handleLaunchActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6ã€ActivityThread-performLaunchActivity"><span class="toc-text">6.6ã€ActivityThread.performLaunchActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-7ã€Instrumentation-callActivityOnCreate"><span class="toc-text">6.7ã€Instrumentation.callActivityOnCreate()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-8ã€Activity-performCreate"><span class="toc-text">6.8ã€Activity.performCreate()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸ƒã€æ ˆé¡¶Activityæ‰§è¡ŒonStopæ–¹æ³•"><span class="toc-text">ä¸ƒã€æ ˆé¡¶Activityæ‰§è¡ŒonStopæ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å¯åŠ¨æµç¨‹ï¼š"><span class="toc-text">å¯åŠ¨æµç¨‹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢-ï¼š"><span class="toc-text">å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢)ï¼š</span></a></li></ol></div><p>Activityå¯åŠ¨æµç¨‹æ¦‚è¿°ï¼š<br>â— ç‚¹å‡»æ¡Œé¢Appå›¾æ ‡ï¼ŒLauncherè¿›ç¨‹é‡‡ç”¨Binder IPCå‘system_serverè¿›ç¨‹å‘èµ·startActivityè¯·æ±‚ï¼›<br>â— system_serverè¿›ç¨‹æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå‘zygoteè¿›ç¨‹å‘é€åˆ›å»ºè¿›ç¨‹çš„è¯·æ±‚ï¼›<br>â— Zygoteè¿›ç¨‹forkå‡ºæ–°çš„å­è¿›ç¨‹ï¼Œå³Appè¿›ç¨‹ï¼›<br>â— Appè¿›ç¨‹ï¼Œé€šè¿‡Binder IPCå‘sytem_serverè¿›ç¨‹å‘èµ·attachApplicationè¯·æ±‚ï¼›<br>â— system_serverè¿›ç¨‹åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œè¿›è¡Œä¸€ç³»åˆ—å‡†å¤‡å·¥ä½œåï¼Œå†é€šè¿‡binder IPCå‘Appè¿›ç¨‹å‘é€scheduleLaunchActivityè¯·æ±‚ï¼›<br>â— Appè¿›ç¨‹çš„binderçº¿ç¨‹ï¼ˆApplicationThreadï¼‰åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡handlerå‘ä¸»çº¿ç¨‹å‘é€LAUNCH_ACTIVITYæ¶ˆæ¯ï¼›<br>â— ä¸»çº¿ç¨‹åœ¨æ”¶åˆ°Messageåï¼Œé€šè¿‡å‘å°„æœºåˆ¶åˆ›å»ºç›®æ ‡Activityï¼Œå¹¶å›è°ƒActivity.onCreate()ç­‰æ–¹æ³•ã€‚ <a id="more"></a></p><h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><p>åŸºäºAndroid 7.1.2çš„æºç å‰–æï¼Œ åˆ†æAndroid Activityå¯åŠ¨æµç¨‹ï¼Œç›¸å…³æºç ï¼š</p><hr><p><strong>frameworks/base/services/core/java/com/android/server/am/</strong><br>â— ActivityManagerService.java<br>â— ActivityStackSupervisor.java<br>â— ActivityStack.java<br>â— ActivityRecord.java<br>â— ProcessRecord.java<br>â— TaskRecord.java</p><p><strong>frameworks/base/services/core/java/com/android/server/pm/</strong><br>â— PackageManagerService.java</p><p><strong>frameworks/base/core/java/android/os/</strong><br>â— Process.java</p><p><strong>frameworks/base/core/java/android/app/</strong><br>â— IActivityManager.java<br>â— ActivityManagerNative.java (å†…å«AMP)<br>â— ActivityManager.java<br>â— Activity.java<br>â— ActivityThread.java<br>â— Instrumentation.java<br>â— IApplicationThread.java<br>â— ApplicationThreadNative.java (å†…å«ATP)<br>â— ActivityThread.java (å†…å«ApplicationThread)<br>â— ContextImpl.java</p><h2 id="åšå®¢åŸå›¾é“¾æ¥"><a href="#åšå®¢åŸå›¾é“¾æ¥" class="headerlink" title="åšå®¢åŸå›¾é“¾æ¥"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.startactivity" target="_blank" rel="noopener">åšå®¢åŸå›¾é“¾æ¥</a></h2><blockquote><p><strong>ä¸»è¦å¯¹è±¡åŠŸèƒ½ä»‹ç»ï¼š</strong><br>â— ActivityManagerServiceï¼Œç®€ç§°AMSï¼ŒæœåŠ¡ç«¯å¯¹è±¡ï¼Œè´Ÿè´£ç³»ç»Ÿä¸­æ‰€æœ‰Activityçš„ç”Ÿå‘½å‘¨æœŸã€‚<br>â— ActivityManagerNativeç»§æ‰¿Javaçš„Binderç±»ï¼ŒåŒæ—¶å®ç°äº†IActivityManageræ¥å£ï¼Œå³ActivityManagerNativeå°†ä½œä¸ºBinderé€šä¿¡çš„æœåŠ¡ç«¯ä¸ºç”¨æˆ·æä¾›æ”¯æŒã€‚<br>â— ActivityManagerProxyï¼šåœ¨ActivityManagerNativeç±»ä¸­å®šä¹‰äº†å†…éƒ¨ç±»ActivityManagerProxyï¼Œè¯¥ç±»åŒæ ·å®ç°äº†IActivityManageræ¥å£ï¼Œå°†ä½œä¸ºå®¢æˆ·ç«¯ä½¿ç”¨çš„æœåŠ¡ç«¯ä»£ç†ã€‚<br>â— ActivityThreadï¼ŒAppçš„çœŸæ­£å…¥å£ã€‚å½“å¼€å¯Appä¹‹åï¼Œä¼šè°ƒç”¨main()å¼€å§‹è¿è¡Œï¼Œå¼€å¯æ¶ˆæ¯å¾ªç¯é˜Ÿåˆ—ï¼Œè¿™å°±æ˜¯ä¼ è¯´ä¸­çš„UIçº¿ç¨‹æˆ–è€…å«ä¸»çº¿ç¨‹ã€‚ä¸ActivityManagerServicesé…åˆï¼Œä¸€èµ·å®ŒæˆActivityçš„ç®¡ç†å·¥ä½œ<br>â— ApplicationThreadï¼Œç”¨æ¥å®ç°ActivityManagerServiceä¸ActivityThreadä¹‹é—´çš„äº¤äº’ã€‚åœ¨ActivityManagerServiceéœ€è¦ç®¡ç†ç›¸å…³Applicationä¸­çš„Activityçš„ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œé€šè¿‡ApplicationThreadçš„ä»£ç†å¯¹è±¡ä¸ActivityThreadé€šè®¯ã€‚<br>â— ApplicationThreadProxyï¼Œæ˜¯ApplicationThreadåœ¨æœåŠ¡å™¨ç«¯çš„ä»£ç†ï¼Œè´Ÿè´£å’Œå®¢æˆ·ç«¯çš„ApplicationThreadé€šè®¯ã€‚AMSå°±æ˜¯é€šè¿‡è¯¥ä»£ç†ä¸ActivityThreadè¿›è¡Œé€šä¿¡çš„ã€‚<br>â— Instrumentationï¼Œæ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºåªæœ‰ä¸€ä¸ªInstrumentationå¯¹è±¡ï¼Œæ¯ä¸ªActivityå†…éƒ½æœ‰ä¸€ä¸ªå¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚Instrumentationå¯ä»¥ç†è§£ä¸ºåº”ç”¨è¿›ç¨‹çš„ç®¡å®¶ï¼ŒActivityThreadè¦åˆ›å»ºæˆ–æš‚åœæŸä¸ªActivityæ—¶ï¼Œéƒ½éœ€è¦é€šè¿‡Instrumentationæ¥è¿›è¡Œå…·ä½“çš„æ“ä½œã€‚<br>â— ActivityStackï¼ŒActivityåœ¨AMSçš„æ ˆç®¡ç†ï¼Œç”¨æ¥è®°å½•å·²ç»å¯åŠ¨çš„Activityçš„å…ˆåå…³ç³»ï¼ŒçŠ¶æ€ä¿¡æ¯ç­‰ã€‚é€šè¿‡ActivityStackå†³å®šæ˜¯å¦éœ€è¦å¯åŠ¨æ–°çš„è¿›ç¨‹ã€‚<br>â— ActivityRecordï¼ŒActivityStackçš„ç®¡ç†å¯¹è±¡ï¼Œæ¯ä¸ªActivityåœ¨AMSå¯¹åº”ä¸€ä¸ªActivityRecordï¼Œæ¥è®°å½•Activityçš„çŠ¶æ€ä»¥åŠå…¶ä»–çš„ç®¡ç†ä¿¡æ¯ã€‚å…¶å®å°±æ˜¯æœåŠ¡å™¨ç«¯çš„Activityå¯¹è±¡çš„æ˜ åƒã€‚<br>â— TaskRecordï¼ŒAMSæŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ªâ€ä»»åŠ¡â€çš„æ¦‚å¿µï¼Œæ˜¯è®°å½•ActivityRecordçš„æ ˆï¼Œä¸€ä¸ªâ€Taskâ€åŒ…å«è‹¥å¹²ä¸ªActivityRecordã€‚AMSç”¨TaskRecordç¡®ä¿Activityå¯åŠ¨å’Œé€€å‡ºçš„é¡ºåºã€‚å¦‚æœä½ æ¸…æ¥šActivityçš„4ç§launchModeï¼Œé‚£ä¹ˆå¯¹è¿™ä¸ªæ¦‚å¿µåº”è¯¥ä¸é™Œç”Ÿã€‚</p></blockquote><hr><p><strong>ç›¸å…³ç±»çš„ç±»å›¾ï¼š</strong><br>ï¼ˆ1ï¼‰IActivityManagerç›¸å…³ç±»<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/N1-Android-startActivity-IAM-class.png" alt="Markdown"><br>ï¼ˆ2ï¼‰IApplicationThreadç›¸å…³ç±»<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/N2-Android-startActivity-AMS-class.png" alt="Markdown"><br>ï¼ˆ3ï¼‰ActivityManagerServiceç›¸å…³ç±»<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/N3-Android-startActivity-IAP-class.png" alt="Markdown"></p><h3 id="1-1ã€Taskå’ŒStack"><a href="#1-1ã€Taskå’ŒStack" class="headerlink" title="1.1ã€Taskå’ŒStack"></a>1.1ã€Taskå’ŒStack</h3><p>Androidç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªActivityéƒ½ä½äºä¸€ä¸ªTaskä¸­ã€‚ä¸€ä¸ªTaskå¯ä»¥åŒ…å«å¤šä¸ªActivityï¼ŒåŒä¸€ä¸ªActivityä¹Ÿå¯èƒ½æœ‰å¤šä¸ªå®ä¾‹ã€‚ åœ¨AndroidManifest.xmlä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡android:launchModeæ¥æ§åˆ¶Activityåœ¨Taskä¸­çš„å®ä¾‹ã€‚</p><p>å¦å¤–ï¼Œåœ¨startActivityçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡setFlag æ¥æ§åˆ¶å¯åŠ¨çš„Activityåœ¨Taskä¸­çš„å®ä¾‹ã€‚</p><p>Taskç®¡ç†çš„æ„ä¹‰è¿˜åœ¨äºè¿‘æœŸä»»åŠ¡åˆ—è¡¨ä»¥åŠBackæ ˆã€‚ å½“ä½ é€šè¿‡å¤šä»»åŠ¡é”®ï¼ˆæœ‰äº›è®¾å¤‡ä¸Šæ˜¯é•¿æŒ‰Homeé”®ï¼Œæœ‰äº›è®¾å¤‡ä¸Šæ˜¯ä¸“é—¨æä¾›çš„å¤šä»»åŠ¡é”®ï¼‰è°ƒå‡ºå¤šä»»åŠ¡æ—¶ï¼Œå…¶å®å°±æ˜¯ä»ActivityManagerServiceè·å–äº†æœ€è¿‘å¯åŠ¨çš„Taskåˆ—è¡¨ã€‚</p><p>Backæ ˆç®¡ç†äº†å½“ä½ åœ¨Activityä¸Šç‚¹å‡»Backé”®ï¼Œå½“å‰Activityé”€æ¯ååº”è¯¥è·³è½¬åˆ°å“ªä¸€ä¸ªActivityçš„é€»è¾‘ã€‚å…³äºTaskå’ŒBackæ ˆï¼Œè¯·å‚è§è¿™é‡Œï¼š<a href="https://developer.android.com/guide/components/tasks-and-back-stack.html" target="_blank" rel="noopener">Tasks and Back Stack</a>ã€‚</p><p>å…¶å®åœ¨ActivityManagerServiceä¸WindowManagerServiceå†…éƒ¨ç®¡ç†ä¸­ï¼Œåœ¨Taskä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€å±‚å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨åº”ç”¨å¼€å‘è€…å’Œç”¨æˆ·å¯èƒ½éƒ½ä¸ä¼šæ„Ÿè§‰åˆ°æˆ–è€…ç”¨åˆ°ï¼Œä½†å®ƒå´éå¸¸é‡è¦ï¼Œé‚£å°±æ˜¯Stackã€‚ ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ï¼ŒAndroidç³»ç»Ÿä¸­çš„å¤šçª—å£ç®¡ç†ï¼Œå°±æ˜¯å»ºç«‹åœ¨Stackçš„æ•°æ®ç»“æ„ä¸Šçš„ã€‚ ä¸€ä¸ªStackä¸­åŒ…å«äº†å¤šä¸ªTaskï¼Œä¸€ä¸ªTaskä¸­åŒ…å«äº†å¤šä¸ªActivityï¼ˆWindowï¼‰ï¼Œä¸‹å›¾æè¿°äº†å®ƒä»¬çš„å…³ç³»ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/Android-_Activity-task_stack.png" alt="Markdown"><br>å¦å¤–è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒActivityManagerServiceå’ŒWindowManagerServiceä¸­çš„Taskå’ŒStackç»“æ„æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå¯¹åº”å…³ç³»å¯¹äºå¦‚ä¸‹ï¼š</p><p>ActivityStack &lt;â€“&gt; TaskStack TaskRecord &lt;â€“&gt; Task å³ï¼ŒActivityManagerServiceä¸­çš„æ¯ä¸€ä¸ªActivityStackæˆ–è€…TaskRecordåœ¨WindowManagerServiceä¸­éƒ½æœ‰å¯¹åº”çš„TaskStackå’ŒTaskï¼Œè¿™ä¸¤ç±»å¯¹è±¡éƒ½æœ‰å”¯ä¸€çš„idï¼ˆidæ˜¯intç±»å‹ï¼‰ï¼Œå®ƒä»¬é€šè¿‡idè¿›è¡Œå…³è”ã€‚</p><h4 id="1-2ã€å°ç»“ï¼š"><a href="#1-2ã€å°ç»“ï¼š" class="headerlink" title="1.2ã€å°ç»“ï¼š"></a>1.2ã€å°ç»“ï¼š</h4><blockquote><p>ç”¨æˆ·ä»Launcherç¨‹åºç‚¹å‡»åº”ç”¨å›¾æ ‡å¯å¯åŠ¨åº”ç”¨çš„å…¥å£Activityï¼ŒActivityå¯åŠ¨æ—¶éœ€è¦å¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„äº¤äº’ï¼ŒAndroidç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªzygoteè¿›ç¨‹ä¸“ç”¨äºå­µåŒ–Androidæ¡†æ¶å±‚å’Œåº”ç”¨å±‚ç¨‹åºçš„è¿›ç¨‹ã€‚è¿˜æœ‰ä¸€ä¸ªsystem_serverè¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹é‡Œè¿è¡Œäº†å¾ˆå¤šbinder serviceï¼Œä¾‹å¦‚ActivityManagerServiceï¼ŒPackageManagerServiceï¼ŒWindowManagerServiceï¼Œè¿™äº›binder serviceåˆ†åˆ«è¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼Œå…¶ä¸­ActivityManagerServiceè´Ÿè´£ç®¡ç†Activityæ ˆï¼Œåº”ç”¨è¿›ç¨‹ï¼Œtaskã€‚ ç”¨æˆ·åœ¨Launcherç¨‹åºé‡Œç‚¹å‡»åº”ç”¨å›¾æ ‡æ—¶ï¼Œä¼šé€šçŸ¥ActivityManagerServiceå¯åŠ¨åº”ç”¨çš„å…¥å£Activityï¼ŒActivityManagerServiceå‘ç°è¿™ä¸ªåº”ç”¨è¿˜æœªå¯åŠ¨ï¼Œåˆ™ä¼šé€šçŸ¥Zygoteè¿›ç¨‹å­µåŒ–å‡ºåº”ç”¨è¿›ç¨‹ï¼Œç„¶ååœ¨è¿™ä¸ªåº”ç”¨è¿›ç¨‹é‡Œæ‰§è¡ŒActivityThreadçš„mainæ–¹æ³•ã€‚åº”ç”¨è¿›ç¨‹æ¥ä¸‹æ¥é€šçŸ¥ActivityManagerServiceåº”ç”¨è¿›ç¨‹å·²å¯åŠ¨ï¼ŒActivityManagerServiceä¿å­˜åº”ç”¨è¿›ç¨‹çš„ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™æ ·ActivityManagerServiceå¯ä»¥é€šè¿‡è¿™ä¸ªä»£ç†å¯¹è±¡æ§åˆ¶åº”ç”¨è¿›ç¨‹ï¼Œç„¶åActivityManagerServiceé€šçŸ¥åº”ç”¨è¿›ç¨‹åˆ›å»ºå…¥å£Activityçš„å®ä¾‹ï¼Œå¹¶æ‰§è¡Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚</p></blockquote><h4 id="æ€»ä½“å¯åŠ¨æµç¨‹å›¾ï¼š"><a href="#æ€»ä½“å¯åŠ¨æµç¨‹å›¾ï¼š" class="headerlink" title="æ€»ä½“å¯åŠ¨æµç¨‹å›¾ï¼š"></a><strong>æ€»ä½“å¯åŠ¨æµç¨‹å›¾ï¼š</strong></h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/N4-Android-startActivity-flow.png" alt="Markdown"></p><h3 id="äºŒã€-å¼€å§‹è¯·æ±‚æ‰§è¡Œå¯åŠ¨Activity"><a href="#äºŒã€-å¼€å§‹è¯·æ±‚æ‰§è¡Œå¯åŠ¨Activity" class="headerlink" title="äºŒã€ å¼€å§‹è¯·æ±‚æ‰§è¡Œå¯åŠ¨Activity"></a>äºŒã€ å¼€å§‹è¯·æ±‚æ‰§è¡Œå¯åŠ¨Activity</h3><blockquote><p>Activity.startActivity()<br>Activity.startActivityForResult()<br>Instrumentation.execStartActivity()<br>ActivityManagerProxy.startActivity()<br>ActivityManagerNative.onTransact()<br>ActivityManagerService.startActivity()</p></blockquote><h4 id="2-1ã€Activity-startActivity"><a href="#2-1ã€Activity-startActivity" class="headerlink" title="2.1ã€Activity.startActivity()"></a>2.1ã€Activity.startActivity()</h4><p>ä»Launcherå¯åŠ¨åº”ç”¨çš„æ—¶å€™ï¼Œç»è¿‡è°ƒç”¨ä¼šæ‰§è¡ŒActivityä¸­çš„startActivityã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; Activity.java]</span><br><span class="line">......</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2ã€Activity-startActivityForResult"><a href="#2-2ã€Activity-startActivityForResult" class="headerlink" title="2.2ã€Activity.startActivityForResult()"></a>2.2ã€Activity.startActivityForResult()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; Activity.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        String who, Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    Instrumentation.ActivityResult ar =</span><br><span class="line">        mInstrumentation.execStartActivity(</span><br><span class="line">            <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, who,</span><br><span class="line">            intent, requestCode, options);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°execStartActivityæ–¹æ³•ä¼ é€’çš„å‡ ä¸ªå‚æ•°ï¼š thisï¼Œä¸ºå¯åŠ¨Activityçš„å¯¹è±¡ï¼› contextThreadï¼Œä¸ºBinderå¯¹è±¡ï¼Œæ˜¯ä¸»è¿›ç¨‹çš„contextå¯¹è±¡ï¼› tokenï¼Œä¹Ÿæ˜¯ä¸€ä¸ªBinderå¯¹è±¡ï¼ŒæŒ‡å‘äº†æœåŠ¡ç«¯ä¸€ä¸ªActivityRecordå¯¹è±¡ï¼› targetï¼Œä¸ºå¯åŠ¨çš„Activityï¼› intentï¼Œå¯åŠ¨çš„Intentå¯¹è±¡ï¼› requestCodeï¼Œè¯·æ±‚ç ï¼› optionsï¼Œå‚æ•°ï¼›</p><h4 id="2-3ã€Instrumentation-execStartActivity"><a href="#2-3ã€Instrumentation-execStartActivity" class="headerlink" title="2.3ã€Instrumentation.execStartActivity()"></a>2.3ã€Instrumentation.execStartActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; Instrumentation.java]</span><br><span class="line">    ......</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Context who, IBinder contextThread, IBinder token, String target,</span></span></span><br><span class="line"><span class="function"><span class="params">    Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess(who);</span><br><span class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, target, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äº ActivityManagerNative.getDefault()è¿”å›çš„æ˜¯?</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> [-&gt;ActivityManagerNative.java]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve the system's default/global activity manager.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è¿”å›çš„æ˜¯gDefault.get()ï¼Œé‚£ä¹ˆgDefaultåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityManagerNative.java]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">        &#125;</span><br><span class="line">        IActivityManager am = asInterface(b);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> am;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å¯åŠ¨è¿‡asInterface()æ–¹æ³•åˆ›å»ºï¼Œç„¶åæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹asInterfaceæ–¹æ³•çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IActivityManager in =</span><br><span class="line">        (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œ æ­¤å¤„startActivity()çš„å…±æœ‰10ä¸ªå‚æ•°, ä¸‹é¢è¯´è¯´æ¯ä¸ªå‚æ•°ä¼ é€’AMP.startActivity()æ¯ä¸€é¡¹çš„å¯¹åº”å€¼:</p><p>caller: å½“å‰åº”ç”¨çš„ApplicationThreadå¯¹è±¡mAppThread; callingPackage: è°ƒç”¨å½“å‰ContextImpl.getBasePackageName(),è·å–å½“å‰Activityæ‰€åœ¨åŒ…å; intent: è¿™ä¾¿æ˜¯å¯åŠ¨Activityæ—¶,ä¼ é€’è¿‡æ¥çš„å‚æ•°; resolvedType: è°ƒç”¨intent.resolveTypeIfNeededè€Œè·å–; resultTo: æ¥è‡ªäºå½“å‰Activity.mToken resultWho: æ¥è‡ªäºå½“å‰Activity.mEmbeddedID requestCode = -1; startFlags = 0; profilerInfo = null; options = null;</p><p>å¥½å§ï¼Œæœ€åç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œç»§æ‰¿ä¸IActivityManagerï¼Œåˆ°äº†è¿™é‡Œå°±å¼•å‡ºäº†æˆ‘ä»¬androidç³»ç»Ÿä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼šBinderæœºåˆ¶ã€‚æˆ‘ä»¬çŸ¥é“åº”ç”¨è¿›ç¨‹ä¸SystemServerè¿›ç¨‹å±äºä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´éœ€è¦é€šè®¯ï¼Œandroidç³»ç»Ÿé‡‡å–äº†è‡ªèº«è®¾è®¡çš„Binderæœºåˆ¶ï¼Œè¿™é‡Œçš„å’ŒActivityManagerNativeéƒ½æ˜¯ç»§æ‰¿ä¸IActivityManagerçš„è€ŒSystemServerè¿›ç¨‹ä¸­çš„ActivityManagerServiceå¯¹è±¡åˆ™ç»§æ‰¿ä¸ActivityManagerNativeã€‚ç®€å•çš„è¡¨ç¤ºï¼š Binderæ¥å£ â€“&gt; ActivityManagerNative/ â€“&gt; ActivityManagerServiceï¼›</p><p>è¿™æ ·ï¼ŒActivityManagerNativeä¸ç›¸å½“äºä¸€ä¸ªBinderçš„å®¢æˆ·ç«¯è€ŒActivityManagerServiceç›¸å½“äºBinderçš„æœåŠ¡ç«¯ï¼Œè¿™æ ·å½“ActivityManagerNativeè°ƒç”¨æ¥å£æ–¹æ³•çš„æ—¶å€™åº•å±‚é€šè¿‡Binder driverå°±ä¼šå°†è¯·æ±‚æ•°æ®ä¸è¯·æ±‚ä¼ é€’ç»™serverç«¯ï¼Œå¹¶åœ¨serverç«¯æ‰§è¡Œå…·ä½“çš„æ¥å£é€»è¾‘ã€‚éœ€è¦æ³¨æ„çš„æ˜¯Binderæœºåˆ¶æ˜¯å•å‘çš„ï¼Œæ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½é€šè¿‡clientç«¯å‘serverç«¯ä¼ é€’æ•°æ®ä¸è¯·æ±‚è€Œä¸ç”¨ç­‰å¾…æœåŠ¡ç«¯çš„è¿”å›ï¼Œä¹Ÿæ— æ³•è¿”å›ï¼Œé‚£å¦‚æœSystemServerè¿›ç¨‹æƒ³å‘åº”ç”¨è¿›ç¨‹ä¼ é€’æ•°æ®æ€ä¹ˆåŠï¼Ÿè¿™æ—¶å€™å°±éœ€è¦é‡æ–°å®šä¹‰ä¸€ä¸ªBinderè¯·æ±‚ä»¥SystemServerä¸ºclientç«¯ï¼Œä»¥åº”ç”¨è¿›ç¨‹ä¸ºserverç«¯ï¼Œè¿™æ ·å°±æ˜¯å®ç°äº†ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„åŒå‘é€šè®¯ã€‚</p><p>å¥½äº†ï¼Œè¯´äº†è¿™ä¹ˆå¤šæˆ‘ä»¬çŸ¥é“è¿™é‡Œçš„ActivityManagerNativeæ˜¯ActivityManagerServiceåœ¨åº”ç”¨è¿›ç¨‹çš„ä¸€ä¸ªclientå°±å¥½äº†ï¼Œé€šè¿‡å®ƒå°±å¯ä»¥æ»´å•Šç”¨ActivityManagerServiceçš„æ–¹æ³•äº†ã€‚</p><h4 id="2-4ã€ActivityManagerProxy-startActivity"><a href="#2-4ã€ActivityManagerProxy-startActivity" class="headerlink" title="2.4ã€ActivityManagerProxy.startActivity()"></a>2.4ã€ActivityManagerProxy.startActivity()</h4><p>ActivityManagerNative.getDefault()æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹å¯¹è±¡çš„startActivityæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityManagerNative.java :: ActivityManagerProxy]</span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5ã€ActivityManagerNative-onTransact"><a href="#2-5ã€ActivityManagerNative-onTransact" class="headerlink" title="2.5ã€ActivityManagerNative.onTransact()"></a>2.5ã€ActivityManagerNative.onTransact()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityManagerNative.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType,</span><br><span class="line">                resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ¶‰åŠåˆ°äº†å…·ä½“çš„Binderæ•°æ®ä¼ è¾“æœºåˆ¶äº†ï¼Œæˆ‘ä»¬ä¸åšè¿‡å¤šçš„åˆ†æï¼ŒçŸ¥é“é€šè¿‡æ•°æ®ä¼ è¾“ä¹‹åå°±ä¼šè°ƒç”¨SystemServerè¿›ç¨‹çš„ActivityManagerServiceçš„startActivityå°±å¥½äº†ã€‚</p><p>ä»¥ä¸Šå…¶å®éƒ½æ˜¯å‘ç”Ÿåœ¨åº”ç”¨è¿›ç¨‹ä¸­ï¼Œä¸‹é¢å¼€å§‹è°ƒç”¨çš„ActivityManagerServiceçš„æ‰§è¡Œæ—¶å‘ç”Ÿåœ¨SystemServerè¿›ç¨‹ã€‚</p><h3 id="ä¸‰ã€-ActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚"><a href="#ä¸‰ã€-ActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚" class="headerlink" title="ä¸‰ã€ ActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚"></a>ä¸‰ã€ ActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚</h3><blockquote><p>ActivityManagerService.startActivity()<br>ActivityStarter.startActivityMayWait()<br>ActivityStarter.startActivityLocked()<br>ActivityStarter.startActivityUnchecked()<br>ActivityStackSupervisor.resumeFocusedStackTopActivityLocked() ActivityStack.resumeTopActivityUncheckedLocked()<br>ActivityStack.resumeTopActivityInnerLocked()<br>â€“&gt;ActivityStackSupervisor.pauseBackStacks() [if (mResumedActivity != null)] â€“&gt;ActivityStackSupervisor.startSpecificActivityLocked() [if (mResumedActivity == null)]</p><h5 id="3-1ã€ActivityManagerService-startActivity"><a href="#3-1ã€ActivityManagerService-startActivity" class="headerlink" title="3.1ã€ActivityManagerService.startActivity()"></a>3.1ã€ActivityManagerService.startActivity()</h5></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityManagerService.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">            resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">            UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsCaller</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ret = mActivityStarter.startActivityMayWait(<span class="keyword">null</span>, targetUid, targetPackage, intent,</span><br><span class="line">                resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags, <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, ignoreTargetSecurity, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(Intent intent, ActivityStackSupervisor.ActivityContainer container)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"ActivityContainer.startActivity"</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = mUserController.handleIncomingUser(Binder.getCallingPid(),</span><br><span class="line">            Binder.getCallingUid(), mStackSupervisor.mCurrentUser, <span class="keyword">false</span>,</span><br><span class="line">            ActivityManagerService.ALLOW_FULL_ONLY, <span class="string">"ActivityContainer"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> mActivityStarter.startActivityMayWait(<span class="keyword">null</span>, -<span class="number">1</span>, <span class="keyword">null</span>, intent, mimeType, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, userId, container, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåªæ˜¯è¿›è¡Œäº†ä¸€äº›å…³äºuseridçš„é€»è¾‘åˆ¤æ–­ï¼Œç„¶åå°±è°ƒç”¨mStackSupervisor.startActivityMayWaitæ–¹æ³•ï¼Œæ­¤å¤„mStackSupervisorçš„æ•°æ®ç±»å‹ä¸ºActivityStackSupervisorã€‚ å½“ç¨‹åºè¿è¡Œåˆ°è¿™é‡Œæ—¶, ASS.startActivityMayWaitçš„å„ä¸ªå‚æ•°å–å€¼å¦‚ä¸‹:</p><p>caller = ApplicationThreadProxy, ç”¨äºè·Ÿè°ƒç”¨è€…è¿›ç¨‹ApplicationThreadè¿›è¡Œé€šä¿¡çš„binderä»£ç†ç±». callingUid = -1; callingPackage = ContextImpl.getBasePackageName(),è·å–è°ƒç”¨è€…Activityæ‰€åœ¨åŒ…å intent: è¿™æ˜¯å¯åŠ¨Activityæ—¶ä¼ é€’è¿‡æ¥çš„å‚æ•°; resolvedType = intent.resolveTypeIfNeeded voiceSession = null; voiceInteractor = null; resultTo = Activity.mToken, å…¶ä¸­Activityæ˜¯æŒ‡è°ƒç”¨è€…æ‰€åœ¨Activity, mTokenå¯¹è±¡ä¿å­˜è‡ªå·±æ‰€å¤„çš„ActivityRecordä¿¡æ¯ resultWho = Activity.mEmbeddedID, å…¶ä¸­Activityæ˜¯æŒ‡è°ƒç”¨è€…æ‰€åœ¨Activity requestCode = -1; startFlags = 0; profilerInfo = null; outResult = null; config = null; options = null; ignoreTargetSecurity = false; userId = AMS.handleIncomingUser, å½“è°ƒç”¨è€…userIdè·Ÿå½“å‰å¤„äºåŒä¸€ä¸ªuserId,åˆ™ç›´æ¥è¿”å›è¯¥userId;å½“ä¸ç›¸ç­‰æ—¶åˆ™æ ¹æ®è°ƒç”¨è€…userIdæ¥å†³å®šæ˜¯å¦éœ€è¦å°†callingUserIdè½¬æ¢ä¸ºmCurrentUserId. iContainer = null; inTask = null;</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p><h4 id="3-2ã€ActivityStarter-startActivityMayWait"><a href="#3-2ã€ActivityStarter-startActivityMayWait" class="headerlink" title="3.2ã€ActivityStarter.startActivityMayWait()"></a>3.2ã€ActivityStarter.startActivityMayWait()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProfilerInfo profilerInfo, IActivityManager.WaitResult outResult, Configuration config,</span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Save a copy in case ephemeral needs it</span></span><br><span class="line">    <span class="keyword">final</span> Intent ephemeralIntent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">    <span class="comment">// Don't modify the client's object!</span></span><br><span class="line">    intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line"></span><br><span class="line">    ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Collect information about the target of the Intent.</span></span><br><span class="line">    ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line"></span><br><span class="line">    ActivityOptions options = ActivityOptions.fromBundle(bOptions);</span><br><span class="line">    ActivityStackSupervisor.ActivityContainer container =</span><br><span class="line">            (ActivityStackSupervisor.ActivityContainer)iContainer;</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line">                inTask);</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥è¿‡ç¨‹ä¸»è¦åŠŸèƒ½ï¼šé€šè¿‡resolveActivityæ¥è·å–ActivityInfoä¿¡æ¯, ç„¶åå†è¿›å…¥ASS.startActivityLocked().å…ˆæ¥çœ‹çœ‹</p><h4 id="3-2-1ã€ActivityStackSupervisor-resolveActivity"><a href="#3-2-1ã€ActivityStackSupervisor-resolveActivity" class="headerlink" title="3.2.1ã€ActivityStackSupervisor.resolveActivity()"></a>3.2.1ã€ActivityStackSupervisor.resolveActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStackSupervisor.java]</span><br><span class="line">        <span class="function">ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> resolveIntent(intent, resolvedType, userId, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AppGlobals.getPackageManager().resolveIntent(intent, resolvedType,</span><br><span class="line">                PackageManager.MATCH_DEFAULT_ONLY | flags</span><br><span class="line">                | ActivityManagerService.STOCK_PM_FLAGS, userId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ActivityInfo <span class="title">resolveActivity</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProfilerInfo profilerInfo, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ResolveInfo rInfo = resolveIntent(intent, resolvedType, userId);</span><br><span class="line">    <span class="keyword">return</span> resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-2ã€PackageManagerService-resolveIntent"><a href="#3-2-2ã€PackageManagerService-resolveIntent" class="headerlink" title="3.2.2ã€PackageManagerService.resolveIntent()"></a>3.2.2ã€PackageManagerService.resolveIntent()</h4><p>AppGlobals.getPackageManager()ç»è¿‡å‡½æ•°å±‚å±‚è°ƒç”¨ï¼Œè·å–çš„æ˜¯ApplicationPackageManagerå¯¹è±¡ã€‚ç»è¿‡binder IPCè°ƒç”¨ï¼Œæœ€ç»ˆä¼šè°ƒç”¨PackageManagerServiceå¯¹è±¡ã€‚æ•…æ­¤æ—¶è°ƒç”¨æ–¹æ³•ä¸ºPMS.resolveIntent().</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; PackageManagerService.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> List&lt;ResolveInfo&gt; query = queryIntentActivitiesInternal(intent, resolvedType,</span><br><span class="line">                flags, userId);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ResolveInfo bestChoice =</span><br><span class="line">                chooseBestActivity(intent, resolvedType, flags, query, userId);</span><br><span class="line">        <span class="keyword">return</span> bestChoice;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">List&lt;ResolveInfo&gt; <span class="title">queryIntentActivitiesInternal</span><span class="params">(Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ComponentName comp = intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (comp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (intent.getSelector() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent = intent.getSelector();</span><br><span class="line">            comp = intent.getComponent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;ResolveInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;ResolveInfo&gt;(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">final</span> ActivityInfo ai = getActivityInfo(comp, flags, userId);</span><br><span class="line">        <span class="keyword">if</span> (ai != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ResolveInfo ri = <span class="keyword">new</span> ResolveInfo();</span><br><span class="line">            ri.activityInfo = ai;</span><br><span class="line">            list.add(ri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ActivityStackSupervisor.resolveActivity()æ–¹æ³•çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æ‰¾åˆ°ç›¸åº”çš„Activityç»„ä»¶ï¼Œå¹¶ä¿å­˜åˆ°intentå¯¹è±¡ã€‚</p><h4 id="3-3ã€ActivityStarter-startActivityLocked"><a href="#3-3ã€ActivityStarter-startActivityLocked" class="headerlink" title="3.3ã€ActivityStarter.startActivityLocked()"></a>3.3ã€ActivityStarter.startActivityLocked()</h4><p>ç»§ç»­ActivityStarter.startActivityMayWait()ä¸ªæ–¹æ³•ä¸­æ‰§è¡Œäº†å¯åŠ¨Activityçš„ä¸€äº›å…¶ä»–é€»è¾‘åˆ¤æ–­ï¼Œåœ¨ç»è¿‡åˆ¤æ–­é€»è¾‘ä¹‹åè°ƒç”¨startActivityLockedæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params">        TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    ActivityRecord sourceRecord = <span class="keyword">null</span>;</span><br><span class="line">    ActivityRecord resultRecord = <span class="keyword">null</span>;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">            intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">            requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, mSupervisor, container,</span><br><span class="line">            options, sourceRecord);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line">        err = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                <span class="keyword">true</span>, options, inTask);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸­ä¸»è¦æ„é€ äº†ActivityManagerServiceç«¯çš„Activityå¯¹è±¡â€“&gt;ActivityRecordï¼Œå¹¶æ ¹æ®Activityçš„å¯åŠ¨æ¨¡å¼æ‰§è¡Œäº†ç›¸å…³é€»è¾‘ã€‚ç„¶åè°ƒç”¨äº†startActivityUncheckedLockedæ–¹æ³•ï¼š</p><h4 id="3-4ã€ActivityStarter-startActivityUnchecked"><a href="#3-4ã€ActivityStarter-startActivityUnchecked" class="headerlink" title="3.4ã€ActivityStarter.startActivityUnchecked()"></a>3.4ã€ActivityStarter.startActivityUnchecked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</span><br><span class="line">    ......</span><br><span class="line">    mTargetStack.startActivityLocked(mStartActivity, newTask, mKeepCurTransition, mOptions);</span><br><span class="line">    <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mLaunchTaskBehind) &#123;</span><br><span class="line">            <span class="comment">// ......</span></span><br><span class="line">            mService.setFocusedActivityLocked(mStartActivity, <span class="string">"startedActivity"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord topTaskActivity = mStartActivity.task.topRunningActivityLocked();</span><br><span class="line">        <span class="keyword">if</span> (!mTargetStack.isFocusable()</span><br><span class="line">                || (topTaskActivity != <span class="keyword">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class="line">                &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">            <span class="comment">// ......</span></span><br><span class="line">            mTargetStack.ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">            <span class="comment">// .......</span></span><br><span class="line">            mWindowManager.executeAppTransition();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//3.6 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()</span></span><br><span class="line">            mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</span><br><span class="line">                    mOptions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mTargetStack.addRecentActivityLocked(mStartActivity);</span><br><span class="line">    &#125;</span><br><span class="line">    mSupervisor.updateUserStackLocked(mStartActivity.userId, mTargetStack);</span><br><span class="line"></span><br><span class="line">    mSupervisor.handleNonResizableTaskIfNeeded(</span><br><span class="line">            mStartActivity.task, preferredLaunchStackId, mTargetStack.mStackId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°æˆ–åˆ›å»ºæ–°çš„Activitæ‰€å±äºçš„Taskå¯¹è±¡ï¼Œä¹‹åè°ƒç”¨ActivityStack.startActivityLocked()</p><h4 id="3-4-1ã€ActivityStack-startActivityLocked"><a href="#3-4-1ã€ActivityStack-startActivityLocked" class="headerlink" title="3.4.1ã€ActivityStack.startActivityLocked()"></a>3.4.1ã€ActivityStack.startActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityStack.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> keepCurTransition,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If this is the first activity, don't do any fancy animations,</span></span><br><span class="line">        <span class="comment">// because there is nothing for it to animate on top of.</span></span><br><span class="line">        addConfigOverride(r, task);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addConfigOverride</span><span class="params">(ActivityRecord r, TaskRecord task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Rect bounds = task.updateOverrideConfigurationFromLaunchBounds();</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> VI deal with activity</span></span><br><span class="line">    mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</span><br><span class="line">            r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</span><br><span class="line">            (r.info.flags &amp; FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId, r.info.configChanges,</span><br><span class="line">            task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind, bounds, task.mOverrideConfig,</span><br><span class="line">            task.mResizeMode, r.isAlwaysFocusable(), task.isHomeTask(),</span><br><span class="line">            r.appInfo.targetSdkVersion, r.mRotationAnimationHint);</span><br><span class="line">    r.taskConfigOverride = task.mOverrideConfig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-5ã€ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><a href="#3-5ã€ActivityStackSupervisor-resumeFocusedStackTopActivityLocked" class="headerlink" title="3.5ã€ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()"></a>3.5ã€ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStackSupervisor.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">        <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">        mFocusedStack.resumeTopActivityUncheckedLocked(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-6ã€ActivityStack-resumeTopActivityUncheckedLocked"><a href="#3-6ã€ActivityStack-resumeTopActivityUncheckedLocked" class="headerlink" title="3.6ã€ActivityStack.resumeTopActivityUncheckedLocked()"></a>3.6ã€ActivityStack.resumeTopActivityUncheckedLocked()</h4><p>inResumeTopActivityç”¨äºä¿è¯æ¯æ¬¡åªæœ‰ä¸€ä¸ªActivityæ‰§è¡ŒresumeTopActivityLocked()æ“ä½œ.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStack.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class="line">        <span class="comment">// Don't even start recursing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Protect against recursion.</span></span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</span><br><span class="line">            mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</span><br><span class="line">            mService.updateSleepIfNeededLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        result = resumeTopActivityInnerLocked(prev, options);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-7ã€ActivityStack-resumeTopActivityInnerLocked"><a href="#3-7ã€ActivityStack-resumeTopActivityInnerLocked" class="headerlink" title="3.7ã€ActivityStack.resumeTopActivityInnerLocked()"></a>3.7ã€ActivityStack.resumeTopActivityInnerLocked()</h4><p>è¯´æ˜ï¼šå¯åŠ¨ä¸€ä¸ªæ–°Activityæ—¶ï¼Œå¦‚æœç•Œé¢è¿˜å­˜åœ¨å…¶å®ƒçš„Activityï¼Œé‚£ä¹ˆå¿…é¡»å…ˆä¸­æ–­å…¶å®ƒçš„Activityã€‚ å› æ­¤ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªå¯åŠ¨çš„Homeç•Œé¢å¯¹åº”çš„Activityå¤–ï¼Œå…¶å®ƒçš„Activityå‡éœ€è¦è¿›è¡Œæ­¤æ“ä½œï¼Œå½“ç³»ç»Ÿå¯åŠ¨ç¬¬ä¸€ä¸ªActivityï¼Œå³Homeæ—¶ï¼ŒmResumedActivityçš„å€¼æ‰ä¼šä¸ºnullã€‚ ç»è¿‡ä¸€ç³»åˆ—å¤„ç†é€»è¾‘ä¹‹åæœ€ç»ˆè°ƒç”¨äº†startPausingLockedæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä½œç”¨å°±æ˜¯è®©ç³»ç»Ÿä¸­æ ˆä¸­çš„Activityæ‰§è¡ŒonPauseæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStack.java]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span>       </span>&#123;</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need to start pausing the current activity so the top one can be resumed...</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> dontWaitForPause = (next.info.flags &amp; FLAG_RESUME_WHILE_PAUSING) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, next, dontWaitForPause);</span><br><span class="line">    <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, next, dontWaitForPause);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">     <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-8ã€ActivityStackSupervisor-pauseBackStacks"><a href="#3-8ã€ActivityStackSupervisor-pauseBackStacks" class="headerlink" title="3.8ã€ActivityStackSupervisor.pauseBackStacks()"></a>3.8ã€ActivityStackSupervisor.pauseBackStacks()</h4><p>æš‚åœæ‰€æœ‰å¤„äºåå°æ ˆçš„æ‰€æœ‰Activityã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStackSupervisor.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">pauseBackStacks</span><span class="params">(<span class="keyword">boolean</span> userLeaving, ActivityRecord resuming, <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> someActivityPaused = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">            <span class="keyword">if</span> (!isFocusedStack(stack) &amp;&amp; stack.mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ......</span><br><span class="line">                someActivityPaused |= stack.startPausingLocked(userLeaving, <span class="keyword">false</span>, resuming,</span><br><span class="line">                        dontWait);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> someActivityPaused;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å››ã€æ‰§è¡Œæ ˆé¡¶Activityçš„onPauseæ–¹æ³•"><a href="#å››ã€æ‰§è¡Œæ ˆé¡¶Activityçš„onPauseæ–¹æ³•" class="headerlink" title="å››ã€æ‰§è¡Œæ ˆé¡¶Activityçš„onPauseæ–¹æ³•"></a>å››ã€æ‰§è¡Œæ ˆé¡¶Activityçš„onPauseæ–¹æ³•</h3><blockquote><p>ActivityStack.startPausingLocked()<br>ActivityThread.schedulePauseActivity()<br>ActivityThread.sendMessage()<br>ActivityThread.H.sendMessage()<br>ActivityThread.H.handleMessage()<br>â€“&gt; -&gt;ActivityThread.handlePauseActivity()<br>â€“&gt;ActivityThread.performPauseActivity()<br>â€”-&gt;ActivityThread.performPauseActivityIfNeeded()<br>â€”-&gt; Instrumentation.callActivityOnPause()<br>â€”-&gt; Activity.performPause()<br>â€”-&gt; Activity.onPause()<br>â€“&gt;ActivityManagerService.activityPaused()<br>â€”-&gt;ActivityStack.activityPausedLocked()<br>â€”-&gt;ActivityStack.completePauseLocked()<br>â€”-&gt;ActivityStackSupervisor.resumeFocusedStackTopActivityLocked() â€”-&gt;ActivityStack.resumeTopActivityUncheckedLocked()<br>â€”-&gt;ActivityStack.resumeTopActivityInnerLocked()<br>â€”-&gt;ActivityStackSupervisor.startSpecificActivityLocked()</p></blockquote><h4 id="4-1ã€ActivityStack-startPausingLocked"><a href="#4-1ã€ActivityStack-startPausingLocked" class="headerlink" title="4.1ã€ActivityStack.startPausingLocked()"></a>4.1ã€ActivityStack.startPausingLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStack.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord resuming, <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            mService.updateUsageStats(prev, <span class="keyword">false</span>);</span><br><span class="line">            prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                    userLeaving, prev.configChangeFlags, dontWait);</span><br><span class="line">        &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ‰§è¡Œäº†pre.app.thread.schedulePauseActivityæ–¹æ³•ï¼Œé€šè¿‡åˆ†æä¸éš¾å‘ç°è¿™é‡Œçš„threadæ˜¯ä¸€ä¸ªIApplicationThreadç±»å‹çš„å¯¹è±¡ï¼Œè€Œåœ¨ActivityThreadä¸­ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªApplicationThreadçš„ç±»ï¼Œå…¶ç»§æ‰¿äº†IApplicationThreadï¼Œå¹¶ä¸”éƒ½æ˜¯Binderå¯¹è±¡ï¼Œä¸éš¾çœ‹å‡ºè¿™é‡Œçš„IAppcationæ˜¯ä¸€ä¸ªBinderçš„clientç«¯è€ŒActivityThreadä¸­çš„ApplicationThreadæ˜¯ä¸€ä¸ªBinderå¯¹è±¡çš„serverç«¯ï¼Œæ‰€ä»¥é€šè¿‡è¿™é‡Œçš„thread.schedulePauseActivityå®é™…ä¸Šè°ƒç”¨çš„å°±æ˜¯ApplicationThreadçš„schedulePauseActivityæ–¹æ³•ã€‚</p><p><code>è¿™é‡Œçš„ApplicationThreadå¯ä»¥å’ŒActivityManagerNativeå¯¹äºä¸€ä¸‹ï¼š é€šè¿‡ActivityManagerNative â€“&gt; ActivityManagerServiceå®ç°äº†åº”ç”¨è¿›ç¨‹ä¸SystemServerè¿›ç¨‹çš„é€šè®¯ é€šè¿‡AppicationThread &lt;â€“ IApplicationThreadå®ç°äº†SystemServerè¿›ç¨‹ä¸åº”ç”¨è¿›ç¨‹çš„é€šè®¯</code></p><p>ç„¶åæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ActivityThreadä¸­schedulePauseActivityçš„å…·ä½“å®ç°ï¼š</p><h4 id="4-2ã€ActivityThread-schedulePauseActivity"><a href="#4-2ã€ActivityThread-schedulePauseActivity" class="headerlink" title="4.2ã€ActivityThread.schedulePauseActivity()"></a>4.2ã€ActivityThread.schedulePauseActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> seq = getLifecycleSeq();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ORDER) Slog.d(TAG, <span class="string">"pauseActivity "</span> + ActivityThread.<span class="keyword">this</span></span><br><span class="line">            + <span class="string">" operation received seq: "</span> + seq);</span><br><span class="line">    sendMessage(</span><br><span class="line">            finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</span><br><span class="line">            token,</span><br><span class="line">            (userLeaving ? USER_LEAVING : <span class="number">0</span>) | (dontReport ? DONT_REPORT : <span class="number">0</span>),</span><br><span class="line">            configChanges,</span><br><span class="line">            seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3ã€ActivityThread-sendMessage"><a href="#4-3ã€ActivityThread-sendMessage" class="headerlink" title="4.3ã€ActivityThread.sendMessage()"></a>4.3ã€ActivityThread.sendMessage()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">int</span> seq)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mH.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨äº†mHçš„sendMessageæ–¹æ³•ï¼ŒmHæ˜¯åœ¨ActivityThreadä¸­å®šä¹‰çš„ä¸€ä¸ªHandlerå¯¹è±¡ï¼Œä¸»è¦å¤„ç†SystemServerè¿›ç¨‹çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶handleMessgeæ–¹æ³•çš„å®ç°ï¼š</p><h4 id="4-4ã€-ActivityThread-handleMessage-mH"><a href="#4-4ã€-ActivityThread-handleMessage-mH" class="headerlink" title="4.4ã€[ActivityThread.handleMessage() : mH]"></a>4.4ã€[ActivityThread.handleMessage() : mH]</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityThread.java : mH]</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">     ......</span><br><span class="line">     <span class="keyword">case</span> PAUSE_ACTIVITY: &#123;</span><br><span class="line">         Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityPause"</span>);</span><br><span class="line">         SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">         handlePauseActivity((IBinder) args.arg1, <span class="keyword">false</span>,</span><br><span class="line">                 (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>, args.argi2,</span><br><span class="line">                 (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</span><br><span class="line">         maybeSnapshot();</span><br><span class="line">         Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">     &#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å…¶è°ƒç”¨äº†handlePauseActivityæ–¹æ³•ï¼š</p><h4 id="4-5ã€ActivityThread-handlePauseActivity"><a href="#4-5ã€ActivityThread-handlePauseActivity" class="headerlink" title="4.5ã€ActivityThread.handlePauseActivity()"></a>4.5ã€ActivityThread.handlePauseActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityThread.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport, <span class="keyword">int</span> seq)</span> </span>&#123;</span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    ......</span><br><span class="line">        performPauseActivity(token, finished, r.isPreHoneycomb(), <span class="string">"handlePauseActivity"</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Tell the activity manager we have paused.</span></span><br><span class="line">        <span class="keyword">if</span> (!dontReport) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManagerNative.getDefault().activityPaused(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æ–¹æ³•ä½“å†…éƒ¨é€šè¿‡è°ƒç”¨performPauseActivityæ–¹æ³•æ¥å®ç°å¯¹æ ˆé¡¶Activityçš„onPauseç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„å›è°ƒï¼Œå¯ä»¥å…·ä½“çœ‹ä¸€ä¸‹ä»–çš„å®ç°ï¼š</p><h4 id="4-6ã€ActivityThread-performPauseActivity"><a href="#4-6ã€ActivityThread-performPauseActivity" class="headerlink" title="4.6ã€ActivityThread.performPauseActivity()"></a>4.6ã€ActivityThread.performPauseActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   [-&gt;ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> Bundle <span class="title">performPauseActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> saveState, String reason)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    performPauseActivityIfNeeded(r, reason);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performPauseActivityIfNeeded</span><span class="params">(ActivityClientRecord r, String reason)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        r.activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">        mInstrumentation.callActivityOnPause(r.activity);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å›åˆ°äº†mInstrumentationçš„callActivityOnPuaseæ–¹æ³•ï¼š</p><h4 id="4-7ã€Instrumentation-callActivityOnPuase"><a href="#4-7ã€Instrumentation-callActivityOnPuase" class="headerlink" title="4.7ã€Instrumentation.callActivityOnPuase()"></a>4.7ã€Instrumentation.callActivityOnPuase()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;Instrumentation.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnPause</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.performPause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸæ¥æœ€ç»ˆå›è°ƒåˆ°äº†Activityçš„performPauseæ–¹æ³•ï¼š</p><h4 id="4-7ã€Activity-performPause"><a href="#4-7ã€Activity-performPause" class="headerlink" title="4.7ã€Activity.performPause()"></a>4.7ã€Activity.performPause()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Activity.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mDoReportFullyDrawn = <span class="keyword">false</span>;</span><br><span class="line">    mFragments.dispatchPause();</span><br><span class="line">    mCalled = <span class="keyword">false</span>;</span><br><span class="line">    onPause();</span><br><span class="line">    mResumed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mCalled &amp;&amp; getApplicationInfo().targetSdkVersion</span><br><span class="line">            &gt;= android.os.Build.VERSION_CODES.GINGERBREAD) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                <span class="string">"Activity "</span> + mComponent.toShortString() +</span><br><span class="line">                <span class="string">" did not call through to super.onPause()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mResumed = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»ˆäºï¼Œå¤ªä¸å®¹æ˜“äº†ï¼Œå›è°ƒåˆ°äº†Activityçš„onPauseæ–¹æ³•ï¼Œå“ˆå“ˆï¼ŒActivityç”Ÿå‘½å‘¨æœŸä¸­çš„ç¬¬ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ç»ˆäºè¢«æˆ‘ä»¬æ‰¾åˆ°äº†ã€‚ã€‚ã€‚ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨å¯åŠ¨ä¸€ä¸ªActivityçš„æ—¶å€™æœ€å…ˆè¢«æ‰§è¡Œçš„æ˜¯æ ˆé¡¶çš„Activityçš„onPauseæ–¹æ³•ã€‚è®°ä½è¿™ç‚¹å§ï¼Œé¢è¯•çš„æ—¶å€™ç»å¸¸ä¼šé—®åˆ°ç±»ä¼¼çš„é—®é¢˜ã€‚</p><p>ç„¶åå›åˆ°æˆ‘ä»¬çš„handlePauseActivityæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•çš„æœ€åé¢æ‰§è¡Œäº†ActivityManagerNative.getDefault().activityPaused(token);æ–¹æ³•ï¼Œè¿™æ˜¯åº”ç”¨è¿›ç¨‹å‘Šè¯‰æœåŠ¡è¿›ç¨‹ï¼Œæ ˆé¡¶Activityå·²ç»æ‰§è¡Œå®ŒæˆonPauseæ–¹æ³•äº†ï¼Œé€šè¿‡å‰é¢æˆ‘ä»¬çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“è¿™å¥è¯æœ€ç»ˆä¼šè¢«ActivityManagerServiceçš„activityPausedæ–¹æ³•æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  [-&gt;ActivityManagerService.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPaused</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        ActivityStack stack = ActivityRecord.getStackLocked(token);</span><br><span class="line">        <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            stack.activityPausedLocked(token, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Binder.restoreCallingIdentity(origId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥å‘ç°ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ActivityStackçš„activityPausedLockedæ–¹æ³•ï¼Œå¥½å§ï¼Œçœ‹ä¸€ä¸‹activityPausedLockedæ–¹æ³•çš„å®ç°ï¼Œç„¶åæ‰§è¡Œäº†completePauseLockedæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">completePauseLocked</span><span class="params">(<span class="keyword">boolean</span> resumeNext, ActivityRecord resuming)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (resumeNext) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityStack topStack = mStackSupervisor.getFocusedStack();</span><br><span class="line">        <span class="keyword">if</span> (!mService.isSleepingOrShuttingDownLocked()) &#123;</span><br><span class="line">            mStackSupervisor.resumeFocusedStackTopActivityLocked(topStack, prev, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mStackSupervisor.checkReadyForSleepLocked();</span><br><span class="line">            ActivityRecord top = topStack.topRunningActivityLocked();</span><br><span class="line">            <span class="keyword">if</span> (top == <span class="keyword">null</span> || (prev != <span class="keyword">null</span> &amp;&amp; top != prev)) &#123;</span><br><span class="line">                <span class="comment">// If there are no more activities available to run, do resume anyway to start</span></span><br><span class="line">                <span class="comment">// something. Also if the top activity on the stack is not the just paused</span></span><br><span class="line">                <span class="comment">// activity, we need to go ahead and resume it to ensure we complete an</span></span><br><span class="line">                <span class="comment">// in-flight app switch.</span></span><br><span class="line">                mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡äº†ä¸€ç³»åˆ—çš„é€»è¾‘ä¹‹åï¼Œåˆè°ƒç”¨äº†resumeTopActivitiesLockedæ–¹æ³•ï¼Œåˆå›åˆ°äº†ç¬¬ä¸‰æ­¥ä¸­è§£æçš„æ–¹æ³•ä¸­äº†ï¼Œè¿™æ ·ç»è¿‡</p><blockquote><p>ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()<br>â€“&gt; ActivityStack.resumeTopActivityUncheckedLocked()<br>â€“&gt; ActivityStack.resumeTopActivityInnerLocked()<br>â€“&gt; ActivityStackSupervisor.startSpecificActivityLocked()</p></blockquote><p>å¥½å§ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹startSpecificActivityLockedçš„å…·ä½“å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStack.java]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Is this activity's application already running?</span></span><br><span class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    r.task.stack.setLaunchTime(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception when starting activity "</span></span><br><span class="line">                    + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">        <span class="comment">// restart the application.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­ä¸€ä¸‹éœ€è¦å¯åŠ¨çš„Activityæ‰€éœ€è¦çš„åº”ç”¨è¿›ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œè‹¥å¯åŠ¨çš„è¯ï¼Œåˆ™ç›´æ¥è°ƒç”¨realStartAtivityLockedæ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨startProcessLockedæ–¹æ³•ï¼Œç”¨äºå¯åŠ¨åº”ç”¨è¿›ç¨‹ã€‚ è¿™æ ·å…³äºå¯åŠ¨Activityæ—¶çš„ç¬¬ä¸‰æ­¥éª¤å°±å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯å®ç°äº†å¯¹æ ˆé¡¶Activityæ‰§è¡ŒonPause æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•é¦–å…ˆåˆ¤æ–­éœ€è¦å¯åŠ¨çš„Activityæ‰€å±çš„è¿›ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œè‹¥å·²ç»å¯åŠ¨åˆ™ç›´æ¥è°ƒç”¨å¯åŠ¨Activityçš„æ–¹æ³•ï¼Œå¦åˆ™å°†å…ˆå¯åŠ¨Activityçš„åº”ç”¨è¿›ç¨‹ï¼Œç„¶ååœ¨å¯åŠ¨è¯¥Activityã€‚</p><h3 id="äº”ã€åˆ›å»ºActivityæ‰€å±çš„åº”ç”¨è¿›ç¨‹"><a href="#äº”ã€åˆ›å»ºActivityæ‰€å±çš„åº”ç”¨è¿›ç¨‹" class="headerlink" title="äº”ã€åˆ›å»ºActivityæ‰€å±çš„åº”ç”¨è¿›ç¨‹"></a>äº”ã€åˆ›å»ºActivityæ‰€å±çš„åº”ç”¨è¿›ç¨‹</h3><blockquote><p>ActivityManagerService.startProcessLocked()<br>-&gt; Process.start()<br>-&gt; åˆ›å»ºè¿›ç¨‹ Process.startViaZygote()<br>-&gt; åˆ›å»ºè¿›ç¨‹ Process.zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote)<br>-&gt; åˆ›å»ºè¿›ç¨‹ ActivityThread.main()<br>ActivityThread.attach()<br>ActivityManagerProxy.attachApplication()<br>ActivityManagerNative.onTransact()<br>ActivityManagerService.attachApplication()<br>ActivityManagerService.attachApplicationLocked() ApplicationThreadNative.ApplicationThreadProxy.bindApplication()<br>ApplicationThreadNative.onTransact()<br>ActivityThread.ApplicationThread.bindApplication()<br>ActivityThread.sendMessage()<br>ActivityThread.H.sendMessage()<br>ActivityThread.H.handleMessage()<br>ActivityThread.handleBindApplication()</p></blockquote><h4 id="5-1ã€ActivityManagerService-startProcessLocked"><a href="#5-1ã€ActivityManagerService-startProcessLocked" class="headerlink" title="5.1ã€ActivityManagerService.startProcessLocked()"></a>5.1ã€ActivityManagerService.startProcessLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityManagerService.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        String hostingType, String hostingNameStr)</span> </span>&#123;</span><br><span class="line">    startProcessLocked(app, hostingType, hostingNameStr, <span class="keyword">null</span> <span class="comment">/* abiOverride */</span>,</span><br><span class="line">            <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>, <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span></span></span><br><span class="line"><span class="function"><span class="params">        String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">                    <span class="comment">// Start the process.  It will either succeed and return a result containing</span></span><br><span class="line">        <span class="comment">// the PID of the new process, or else throw a RuntimeException.</span></span><br><span class="line">        <span class="keyword">boolean</span> isActivityProcess = (entryPoint == <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"Start proc: "</span> +</span><br><span class="line">                app.processName);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: asking zygote to start proc"</span>);</span><br><span class="line">        Process.ProcessStartResult startResult = Process.start(entryPoint,</span><br><span class="line">                app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</span><br><span class="line">                app.info.dataDir, entryPointArgs);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: returned from zygote!"</span>);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å…¶ç»è¿‡ä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œä¹‹åè°ƒç”¨äº†Process.startæ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥äº†å¯åŠ¨çš„ç±»åâ€android.app.ActivityThreadâ€:</p><h4 id="5-2ã€Process-start"><a href="#5-2ã€Process-start" class="headerlink" title="5.2ã€Process.start()"></a>5.2ã€Process.start()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;Process.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> debugFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line">                debugFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                abi, instructionSet, appDataDir, zygoteArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">        Log.e(LOG_TAG,</span><br><span class="line">                <span class="string">"Starting VM process through Zygote failed"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Starting VM process through Zygote failed"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨äº†startViaZygoteæ–¹æ³•ï¼š</p><h4 id="5-3ã€Process-startViaZygote"><a href="#5-3ã€Process-startViaZygote" class="headerlink" title="5.3ã€Process.startViaZygote()"></a>5.3ã€Process.startViaZygote()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;Process.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">startViaZygote</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">final</span> <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> gid,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">final</span> <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> debugFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String[] extraArgs)</span></span></span><br><span class="line"><span class="function">                              <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(Process.class) &#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­æŸ¥çœ‹ä¸€ä¸‹zygoteSendArgsAndGetResultæ–¹æ³•çš„å®ç°ï¼š</p><h4 id="5-4ã€Process-zygoteSendArgsAndGetResult"><a href="#5-4ã€Process-zygoteSendArgsAndGetResult" class="headerlink" title="5.4ã€Process.zygoteSendArgsAndGetResult()"></a>5.4ã€Process.zygoteSendArgsAndGetResult()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;Process.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">zygoteSendArgsAndGetResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ZygoteState zygoteState, ArrayList&lt;String&gt; args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Should there be a timeout on this?</span></span><br><span class="line">        ProcessStartResult result = <span class="keyword">new</span> ProcessStartResult();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Always read the entire result from the input stream to avoid leaving</span></span><br><span class="line">        <span class="comment">// bytes in the stream for future process starts to accidentally stumble</span></span><br><span class="line">        <span class="comment">// upon.</span></span><br><span class="line">        <span class="comment">//ç­‰å¾…socketæœåŠ¡ç«¯ï¼ˆå³zygoteï¼‰è¿”å›æ–°åˆ›å»ºçš„è¿›ç¨‹pid;</span></span><br><span class="line">        result.pid = inputStream.readInt();</span><br><span class="line">        result.usingWrapper = inputStream.readBoolean();</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯é€šè¿‡socketé€šé“å‘Zygoteè¿›ç¨‹å‘é€ä¸€ä¸ªå‚æ•°åˆ—è¡¨ï¼Œç„¶åè¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¿œç«¯çš„socketæœåŠ¡ç«¯å‘é€å›æ¥æ–°åˆ›å»ºçš„è¿›ç¨‹pidæ‰è¿”å›ã€‚</p><h4 id="5-5ã€Process-openZygoteSocketIfNeeded"><a href="#5-5ã€Process-openZygoteSocketIfNeeded" class="headerlink" title="5.5ã€Process.openZygoteSocketIfNeeded()"></a>5.5ã€Process.openZygoteSocketIfNeeded()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">   [-&gt;Process.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ZygoteState <span class="title">openZygoteSocketIfNeeded</span><span class="params">(String abi)</span> <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (primaryZygoteState == <span class="keyword">null</span> || primaryZygoteState.isClosed()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å‘ä¸»zygoteå‘èµ·connect()æ“ä½œ</span></span><br><span class="line">            primaryZygoteState = ZygoteState.connect(ZYGOTE_SOCKET);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"Error connecting to primary zygote"</span>, ioe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (primaryZygoteState.matches(abi)) &#123;</span><br><span class="line">        <span class="keyword">return</span> primaryZygoteState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The primary zygote didn't match. Try the secondary.</span></span><br><span class="line">    <span class="keyword">if</span> (secondaryZygoteState == <span class="keyword">null</span> || secondaryZygoteState.isClosed()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å½“ä¸»zygoteæ²¡èƒ½åŒ¹é…æˆåŠŸï¼Œåˆ™é‡‡ç”¨ç¬¬äºŒä¸ªzygoteï¼Œå‘èµ·connect()æ“ä½œ</span></span><br><span class="line">        secondaryZygoteState = ZygoteState.connect(SECONDARY_ZYGOTE_SOCKET);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"Error connecting to secondary zygote"</span>, ioe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (secondaryZygoteState.matches(abi)) &#123;</span><br><span class="line">        <span class="keyword">return</span> secondaryZygoteState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"Unsupported zygote ABI: "</span> + abi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>openZygoteSocketIfNeeded(abi)æ–¹æ³•æ˜¯æ ¹æ®å½“å‰çš„abiæ¥é€‰æ‹©ä¸zygoteè¿˜æ˜¯zygote64æ¥è¿›è¡Œé€šä¿¡ã€‚ æ—¢ç„¶system_serverè¿›ç¨‹çš„zygoteSendArgsAndGetResult()æ–¹æ³•é€šè¿‡socketå‘Zygoteè¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œè¿™æ˜¯ä¾¿ä¼šå”¤é†’Zygoteè¿›ç¨‹ï¼Œæ¥å“åº”socketå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ˆå³system_serverç«¯) å…·ä½“è¯¦ç»†è¿‡ç¨‹å¯å‚è€ƒå¤§ç¥åšå®¢<a href="http://gityuan.com/2016/03/26/app-process-create/" target="_blank" rel="noopener">ç†è§£Androidè¿›ç¨‹åˆ›å»ºæµç¨‹</a> å’Œ <a href="http://gityuan.com/2016/10/09/app-process-create-2/" target="_blank" rel="noopener">Androidå››å¤§ç»„ä»¶ä¸è¿›ç¨‹å¯åŠ¨çš„å…³ç³»</a> å¤§ç¥æ˜¯åŸºäºAndroid Mï¼Œä¹‹åæˆ‘ä¼šè·Ÿç€å¤§ç¥çš„è„šæ­¥ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œå®ŒæˆAndroid Nè¿›ç¨‹åˆ›å»ºæµç¨‹ï¼Œä¼°è®¡å˜åŒ–ä¸å¤§åŠ æ·±è‡ªå·±ç†è§£ã€‚ è¿›ç¨‹åˆ›å»ºæµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/Android-_Start_Activity-process-create.jpg" alt="Markdown"></p><p>æ€»ç»“ï¼š å¯ä»¥å‘ç°å…¶æœ€ç»ˆè°ƒç”¨äº†Zygoteå¹¶é€šè¿‡socketé€šä¿¡çš„æ–¹å¼è®©Zygoteè¿›ç¨‹forké™¤äº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶æ ¹æ®æˆ‘ä»¬åˆšåˆšä¼ é€’çš„â€android.app.ActivityThreadâ€å­—ç¬¦ä¸²ï¼Œåå°„å‡ºè¯¥å¯¹è±¡å¹¶æ‰§è¡ŒActivityThreadçš„mainæ–¹æ³•ã€‚è¿™æ ·æˆ‘ä»¬æ‰€è¦å¯åŠ¨çš„åº”ç”¨è¿›ç¨‹è¿™æ—¶å€™å…¶å®å·²ç»å¯åŠ¨äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ‰§è¡Œç›¸åº”çš„åˆå§‹åŒ–æ“ä½œã€‚</p><p>æˆ‘ä»¬å¹³æ—¶App-Crashå¸¸è§çš„logå°±æ˜¯ä»ActivityThread.main()æŠ›å‡ºå¼‚å¸¸çš„,å¯å‚è€ƒæ–‡æ¡£ï¼šAndroid 7.1.2(Android N) Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ã€‚</p><blockquote><p>java.lang.RuntimeException: Unable to start activity ComponentInfo{â€¦â€¦} at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2665) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2726) at android.app.ActivityThread.-wrap12(ActivityThread.java) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1477)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; at android.os.Handler.dispatchMessage(Handler.java:102)</span><br><span class="line">&gt; at android.os.Looper.loop(Looper.java:154)</span><br><span class="line">&gt; at android.app.ActivityThread.main(ActivityThread.java:6119)</span><br><span class="line">&gt; at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">&gt; at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:892)</span><br><span class="line">&gt; at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:782)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬å¹³æ—¶éƒ½å°†ActivityThreadç§°ä¹‹ä¸ºuiçº¿ç¨‹æˆ–è€…æ˜¯ä¸»çº¿ç¨‹ï¼Œè¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨è¿›ç¨‹è¢«åˆ›å»ºä¹‹åé¦–å…ˆæ‰§è¡Œçš„æ˜¯ActivityThreadçš„mainæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ActivityThreadæˆä¸ºä¸»çº¿ç¨‹ã€‚</p><p>å¥½äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityThreadçš„mainæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚</p><h4 id="5-6ã€ActivityThread-main"><a href="#5-6ã€ActivityThread-main" class="headerlink" title="5.6ã€ActivityThread.main()"></a>5.6ã€ActivityThread.main()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</span><br><span class="line">    ......</span><br><span class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨mainæ–¹æ³•ä¸­ä¸»è¦æ‰§è¡Œäº†ä¸€äº›åˆå§‹åŒ–çš„é€»è¾‘ï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ªUIçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­éšæ„çš„åˆ›å»ºHandlerè€Œä¸ä¼šæŠ¥é”™çš„åŸå› ï¼Œè¿™é‡Œæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¤§å®¶å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼šå­çº¿ç¨‹å¯ä»¥åˆ›å»ºHandlerä¹ˆï¼Ÿå¯ä»¥çš„è¯åº”è¯¥æ€ä¹ˆåšï¼Ÿ ç„¶åæ‰§è¡Œäº†ActivityThreadçš„attachæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹attachæ–¹æ³•æ‰§è¡Œäº†é‚£äº›é€»è¾‘æ“ä½œã€‚</p><h4 id="5-7ã€ActivityThread-attach"><a href="#5-7ã€ActivityThread-attach" class="headerlink" title="5.7ã€ActivityThread.attach()"></a>5.7ã€ActivityThread.attach()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//æ­¤æ—¶è¿›ç¨‹åè¿˜æ˜¯"&lt;pre-initialized&gt;"</span></span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</span><br><span class="line">                                                UserHandle.myUserId());</span><br><span class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">        <span class="comment">//åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è°ƒç”¨åŸºäºIActivityManageræ¥å£çš„Binderé€šé“</span></span><br><span class="line">            mgr.attachApplication(mAppThread);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-8ã€ActivityManagerProxy-attachApplication"><a href="#5-8ã€ActivityManagerProxy-attachApplication" class="headerlink" title="5.8ã€ActivityManagerProxy .attachApplication()"></a>5.8ã€ActivityManagerProxy .attachApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityManagerNative.java::ActivityManagerProxy]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread app)</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">Parcel data = Parcel.obtain();</span><br><span class="line">Parcel reply = Parcel.obtain();</span><br><span class="line">data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">data.writeStrongBinder(app.asBinder());</span><br><span class="line">mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">reply.readException();</span><br><span class="line">data.recycle();</span><br><span class="line">reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-9ã€ActivityManagerNative-onTransact"><a href="#5-9ã€ActivityManagerNative-onTransact" class="headerlink" title="5.9ã€ActivityManagerNative.onTransact()"></a>5.9ã€ActivityManagerNative.onTransact()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityManagerNative.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"><span class="keyword">switch</span> (code) &#123;</span><br><span class="line">...</span><br><span class="line"> <span class="keyword">case</span> ATTACH_APPLICATION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    <span class="comment">//è·å–ApplicationThreadçš„binderä»£ç†ç±» ApplicationThreadProxy</span></span><br><span class="line">    IApplicationThread app = ApplicationThreadNative.asInterface(</span><br><span class="line">            data.readStrongBinder());</span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">        attachApplication(app); <span class="comment">//æ­¤å¤„æ˜¯ActivityManagerServiceç±»ä¸­çš„æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆšåˆšæˆ‘ä»¬å·²ç»åˆ†æè¿‡å¯¹è±¡æ˜¯ActivityManagerServiceçš„Binder clientï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨äº†attachApplicationå®é™…ä¸Šå°±æ˜¯é€šè¿‡Binderæœºåˆ¶è°ƒç”¨äº†ActivityManagerServiceçš„attachApplicationï¼Œå…·ä½“è°ƒç”¨çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityManagerServiceæ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><h4 id="5-10ã€ActivityManagerService-attachApplication"><a href="#5-10ã€ActivityManagerService-attachApplication" class="headerlink" title="5.10ã€ActivityManagerService.attachApplication()"></a>5.10ã€ActivityManagerService.attachApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityManagerService.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="comment">//æ­¤å¤„çš„threadä¾¿æ˜¯ApplicationThreadProxyå¯¹è±¡,ç”¨äºè·Ÿå‰é¢é€šè¿‡Process.start()æ‰€åˆ›å»ºçš„è¿›ç¨‹ä¸­ApplicationThreadå¯¹è±¡è¿›è¡Œé€šä¿¡.</span></span><br><span class="line">        attachApplicationLocked(thread, callingPid);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®pidè·å–ProcessRecord</span></span><br><span class="line">    ProcessRecord app;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            app = mPidsSelfLocked.get(pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//è·å–åº”ç”¨appInfo</span></span><br><span class="line">        ApplicationInfo appInfo = app.instrumentationInfo != <span class="keyword">null</span></span><br><span class="line">                ? app.instrumentationInfo : app.info;</span><br><span class="line">        app.compat = compatibilityInfoForPackageLocked(appInfo);</span><br><span class="line">        <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            profileFd = profileFd.dup();</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//ç»‘å®šåº”ç”¨</span></span><br><span class="line">        thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</span><br><span class="line">                profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">                app.instrumentationUiAutomationConnection, testMode,</span><br><span class="line">                mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                <span class="keyword">new</span> Configuration(mConfiguration), app.compat,</span><br><span class="line">                getCommonServicesLocked(app.isolated),</span><br><span class="line">                               mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line"></span><br><span class="line">        updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    &#125; ......</span><br><span class="line">    <span class="comment">// See if the top visible activity is waiting to run in this process...</span></span><br><span class="line">    <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                didSomething = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Exception thrown launching activities in "</span> + app, e);</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢,å†æ¥è¯´è¯´thread.bindApplicationçš„è¿‡ç¨‹.</p><h4 id="5-11ã€ApplicationThreadProxy-bindApplication"><a href="#5-11ã€ApplicationThreadProxy-bindApplication" class="headerlink" title="5.11ã€ApplicationThreadProxy.bindApplication()"></a>5.11ã€ApplicationThreadProxy.bindApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ApplicationThreadNative.java ::ApplicationThreadProxy]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationThreadProxy</span> <span class="keyword">implements</span> <span class="title">IApplicationThread</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String packageName, ApplicationInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ProviderInfo&gt; providers, ComponentName testName, ProfilerInfo profilerInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle testArgs, IInstrumentationWatcher testWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">        IUiAutomationConnection uiAutomationConnection, <span class="keyword">int</span> debugMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> enableBinderTracking, <span class="keyword">boolean</span> trackAllocation, <span class="keyword">boolean</span> restrictedBackupMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> persistent, Configuration config, CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        Map&lt;String, IBinder&gt; services, Bundle coreSettings)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mRemote.transact(BIND_APPLICATION_TRANSACTION, data, <span class="keyword">null</span>,</span><br><span class="line">            IBinder.FLAG_ONEWAY);</span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-12ã€ApplicationThreadNative-onTransact"><a href="#5-12ã€ApplicationThreadNative-onTransact" class="headerlink" title="5.12ã€ApplicationThreadNative.onTransact()"></a>5.12ã€ApplicationThreadNative.onTransact()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ApplicationThreadNative.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"><span class="keyword">switch</span> (code) &#123;</span><br><span class="line">...</span><br><span class="line">       <span class="keyword">case</span> BIND_APPLICATION_TRANSACTION:</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">        bindApplication(packageName, info, providers, testName, profilerInfo, testArgs,</span><br><span class="line">                testWatcher, uiAutomationConnection, testMode, enableBinderTracking,</span><br><span class="line">                trackAllocation, restrictedBackupMode, persistent, config, compatInfo, services,</span><br><span class="line">                coreSettings);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-13ã€ApplicationThread-bindApplication"><a href="#5-13ã€ApplicationThread-bindApplication" class="headerlink" title="5.13ã€ApplicationThread.bindApplication()"></a>5.13ã€ApplicationThread.bindApplication()</h4><p>[-&gt; ActivityThread.java ::ApplicationThread]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String processName, ApplicationInfo appInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span></span></span><br><span class="line"><span class="function"><span class="params">        IInstrumentationWatcher instrumentationWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">        IUiAutomationConnection instrumentationUiConnection, <span class="keyword">int</span> debugMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> enableBinderTracking, <span class="keyword">boolean</span> trackAllocation,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isRestrictedBackupMode, <span class="keyword">boolean</span> persistent, Configuration config,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services, Bundle coreSettings)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (services != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Setup the service cache in the ServiceManager</span></span><br><span class="line">        ServiceManager.initServiceCache(services);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setCoreSettings(coreSettings);</span><br><span class="line"></span><br><span class="line">    AppBindData data = <span class="keyword">new</span> AppBindData();</span><br><span class="line">    ......</span><br><span class="line">    sendMessage(H.BIND_APPLICATION, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-14ã€ActivityThread-handleBindApplication"><a href="#5-14ã€ActivityThread-handleBindApplication" class="headerlink" title="5.14ã€ActivityThread.handleBindApplication()"></a>5.14ã€ActivityThread.handleBindApplication()</h4><p>å½“ä¸»çº¿ç¨‹æ”¶åˆ°H.BIND_APPLICATION,åˆ™è°ƒç”¨handleBindApplication</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt; ActivityThread.java ::H]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mBoundApplication = data;</span><br><span class="line">    mConfiguration = <span class="keyword">new</span> Configuration(data.config);</span><br><span class="line">    mCompatConfiguration = <span class="keyword">new</span> Configuration(data.config);</span><br><span class="line">    <span class="comment">//è®¾ç½®è¿›ç¨‹å, ä¹Ÿå°±æ˜¯è¯´è¿›ç¨‹åæ˜¯åœ¨è¿›ç¨‹çœŸæ­£åˆ›å»ºä»¥åçš„BIND_APPLICATIONè¿‡ç¨‹ä¸­æ‰å–å</span></span><br><span class="line">    <span class="comment">// send up app name; do this *before* waiting for debugger</span></span><br><span class="line">    Process.setArgV0(data.processName);</span><br><span class="line">    android.ddm.DdmHandleAppName.setAppName(data.processName,</span><br><span class="line">                                            UserHandle.myUserId());</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    è·å–LoadedApkå¯¹è±¡</span><br><span class="line">    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">    <span class="comment">//åˆ›å»ºContextImplä¸Šä¸‹æ–‡</span></span><br><span class="line">    <span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</span><br><span class="line">    updateLocaleListFromAppContext(appContext,</span><br><span class="line">            mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// If the app is being launched for full backup or restore, bring it up in</span></span><br><span class="line">        <span class="comment">// a restricted environment with the base application class.</span></span><br><span class="line">        <span class="comment">// æ­¤å¤„data.infoæ˜¯æŒ‡LoadedApk, é€šè¿‡åå°„åˆ›å»ºç›®æ ‡åº”ç”¨Applicationå¯¹è±¡</span></span><br><span class="line">        Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line">        mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Do this after providers, since instrumentation tests generally start their</span></span><br><span class="line">        <span class="comment">// test thread at this point, and we don't want that racing.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨handleBindApplication()çš„è¿‡ç¨‹ä¸­,ä¼šåŒæ—¶è®¾ç½®ä»¥ä¸‹ä¸¤ä¸ªå€¼:</p><p>LoadedApk.mApplication AT.mInitialApplication</p><p>å›¾ç¤ºæ€»ç»“ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/N5-Android-startActivity-AMS-AT.png" alt="Markdown"></p><h3 id="å…­ã€æ‰§è¡Œå¯åŠ¨Acitivity"><a href="#å…­ã€æ‰§è¡Œå¯åŠ¨Acitivity" class="headerlink" title="å…­ã€æ‰§è¡Œå¯åŠ¨Acitivity"></a>å…­ã€æ‰§è¡Œå¯åŠ¨Acitivity</h3><blockquote><p>ActivityStackSupervisor.attachApplicationLocked()<br>ActivityStackSupervisor.realStartActivityLocked()<br>IApplicationThread.scheduleLaunchActivity()<br>ActivityThread.ApplicationThread.scheduleLaunchActivity()<br>ActivityThread.sendMessage()<br>ActivityThread.H.handleMessage()<br>ActivityThread.handleLauncherActivity()<br>ActivityThread.performLauncherActivity()<br>Instrumentation.callActivityOnCreate()<br>-&gt; Activity.performCreate() Activity.onCreate()</p></blockquote><p>åœ¨ç¬¬äº”èŠ‚AMS.startProcessLocked()æ•´ä¸ªè¿‡ç¨‹ï¼Œåˆ›å»ºå®Œæ–°è¿›ç¨‹åä¼šåœ¨æ–°è¿›ç¨‹ä¸­è°ƒç”¨AMP.attachApplication ï¼Œè¯¥æ–¹æ³•ç»è¿‡binder ipcåè°ƒç”¨åˆ°AMS.attachApplicationLockedã€‚è¯¥æ–¹æ³•æ‰§è¡Œäº†ä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œï¼Œåœ¨æ‰§è¡Œå®ŒbindApplication()ä¹‹åè¿›å…¥ActivityStackSupervisor.attachApplicationLocked()ï¼Œè¿™æ ·æˆ‘ä»¬æ•´ä¸ªåº”ç”¨è¿›ç¨‹å·²ç»å¯åŠ¨èµ·æ¥äº†ã€‚ç»ˆäºå¯ä»¥å¼€å§‹activityçš„å¯åŠ¨é€»è¾‘äº†ã€‚ å…³ç³»å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/N6-Android-startActivity-arc.jpg" alt="Markdown"><br><a href="http://blog.csdn.net/myarrow/article/details/14223493" target="_blank" rel="noopener">ActivityThreadç®€ä»‹</a> é¦–å…ˆçœ‹ä¸€ä¸‹attachApplicationLockedæ–¹æ³•çš„å®ç°ï¼š</p><h4 id="6-1ã€ActivityStackSupervisor-attachApplicationLocked"><a href="#6-1ã€ActivityStackSupervisor-attachApplicationLocked" class="headerlink" title="6.1ã€ActivityStackSupervisor.attachApplicationLocked()"></a>6.1ã€ActivityStackSupervisor.attachApplicationLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStackSupervisor.java]</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">            <span class="keyword">if</span> (!isFocusedStack(stack)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ActivityRecord hr = stack.topRunningActivityLocked();</span><br><span class="line">            <span class="keyword">if</span> (hr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (hr.app == <span class="keyword">null</span> &amp;&amp; app.uid == hr.info.applicationInfo.uid</span><br><span class="line">                        &amp;&amp; processName.equals(hr.processName)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                            didSomething = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; ......</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å…¶å†…éƒ¨è°ƒç”¨äº†realStartActivityLockedæ–¹æ³•ï¼Œé€šè¿‡åå­—å¯ä»¥çŸ¥é“è¿™ä¸ªæ–¹æ³•åº”è¯¥å°±æ˜¯ç”¨æ¥å¯åŠ¨Activityçš„ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š</p><h4 id="6-2ã€ActivityStackSupervisor-realStartActivityLocked"><a href="#6-2ã€ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="6.2ã€ActivityStackSupervisor.realStartActivityLocked()"></a>6.2ã€ActivityStackSupervisor.realStartActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStackSupervisor.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">      ......</span><br><span class="line">        app.forceProcessStateUpTo(mService.mTopProcessState);</span><br><span class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ä¸ç¬¬å››èŠ‚æ‰§è¡Œæ ˆé¡¶Activity onPauseæ—¶ç±»ä¼¼ï¼Œè¿™é‡Œä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨IApplicationThreadçš„æ–¹æ³•å®ç°çš„ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯scheduleLaunchActivityæ–¹æ³•ï¼Œæ‰€ä»¥çœŸæ­£æ‰§è¡Œçš„æ˜¯ActivityThreadä¸­çš„scheduleLaunchActivityã€‚</p><h4 id="6-3ã€ApplicationThread-scheduleLaunchActivity"><a href="#6-3ã€ApplicationThread-scheduleLaunchActivity" class="headerlink" title="6.3ã€ApplicationThread.scheduleLaunchActivity()"></a>6.3ã€ApplicationThread.scheduleLaunchActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java :ApplicationThread]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">            CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">        sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="6-4ã€H-handleMessage"><a href="#6-4ã€H-handleMessage" class="headerlink" title="6.4ã€H.handleMessage"></a>6.4ã€H.handleMessage</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java ::H]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">                r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                        r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">                handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            ......</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><h4 id="6-5ã€ActivityThread-handleLaunchActivity"><a href="#6-5ã€ActivityThread-handleLaunchActivity" class="headerlink" title="6.5ã€ActivityThread.handleLaunchActivity()"></a>6.5ã€ActivityThread.handleLaunchActivity()</h4><p>ActivityThreadæ¥æ”¶åˆ°SystemServerè¿›ç¨‹çš„æ¶ˆæ¯ä¹‹åä¼šé€šè¿‡å…¶å†…éƒ¨çš„Handlerå¯¹è±¡åˆ†å‘æ¶ˆæ¯ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„åˆ†å‘ä¹‹åè°ƒç”¨äº†ActivityThreadçš„handleLaunchActivityæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Initialize before creating the activity</span></span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line"></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">        reportSizeConfigurations(r);</span><br><span class="line">        Bundle oldState = r.state;</span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line">      &#125;</span><br><span class="line">      ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™é‡Œè°ƒç”¨äº†performLauncherActivityï¼Œçœ‹åå­—åº”è¯¥å°±æ˜¯æ‰§è¡ŒActivityçš„å¯åŠ¨æ“ä½œäº†â€¦â€¦</p><h4 id="6-6ã€ActivityThread-performLaunchActivity"><a href="#6-6ã€ActivityThread-performLaunchActivity" class="headerlink" title="6.6ã€ActivityThread.performLaunchActivity()"></a>6.6ã€ActivityThread.performLaunchActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = r.intent.resolveActivity(</span><br><span class="line">            mInitialApplication.getPackageManager());</span><br><span class="line">        r.intent.setComponent(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                r.activityInfo.targetActivity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">            ......</span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor, window);</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">//ç”Ÿå‘½å‘¨æœŸonStartã€onresume</span></span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„Activityå¯¹è±¡ç»ˆäºæ˜¯åˆ›å»ºå‡ºæ¥äº†ï¼Œç„¶ååœ¨ä»£ç ä¸­å…¶è°ƒç”¨Instrumentationçš„callActivityOnCreateæ–¹æ³•ã€‚</p><h4 id="6-7ã€Instrumentation-callActivityOnCreate"><a href="#6-7ã€Instrumentation-callActivityOnCreate" class="headerlink" title="6.7ã€Instrumentation.callActivityOnCreate()"></a>6.7ã€Instrumentation.callActivityOnCreate()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;Instrumentation.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle,</span></span></span><br><span class="line"><span class="function"><span class="params">        PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    prePerformCreate(activity);</span><br><span class="line">    activity.performCreate(icicle, persistentState);</span><br><span class="line">    postPerformCreate(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œactivityçš„performCreateæ–¹æ³•â€¦â€¦</p><h4 id="6-8ã€Activity-performCreate"><a href="#6-8ã€Activity-performCreate" class="headerlink" title="6.8ã€Activity.performCreate()"></a>6.8ã€Activity.performCreate()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle, PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    restoreHasCurrentPermissionRequest(icicle);</span><br><span class="line">    onCreate(icicle, persistentState);</span><br><span class="line">    mActivityTransitionState.readState(icicle);</span><br><span class="line">    performCreateCommon();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€è¦è¯´æ˜å‰©ä½™ç”Ÿå‘½å‘¨æœŸï¼š å›åˆ°æˆ‘ä»¬çš„performLaunchActivityæ–¹æ³•ï¼Œå…¶åœ¨è°ƒç”¨äº†mInstrumentation.callActivityOnCreateæ–¹æ³•ä¹‹ååˆè°ƒç”¨äº†activity.performStart()æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹ä»–çš„å®ç°æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Activity.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mActivityTransitionState.setEnterActivityOptions(<span class="keyword">this</span>, getActivityOptions());</span><br><span class="line">    mFragments.noteStateNotSaved();</span><br><span class="line">    mCalled = <span class="keyword">false</span>;</span><br><span class="line">    mFragments.execPendingActions();</span><br><span class="line">    mInstrumentation.callActivityOnStart(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">            <span class="string">"Activity "</span> + mComponent.toShortString() +</span><br><span class="line">            <span class="string">" did not call through to super.onStart()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mFragments.dispatchStart();</span><br><span class="line">    mFragments.reportLoaderStart();</span><br><span class="line">    ......</span><br><span class="line">    mActivityTransitionState.enterReady(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯é€šè¿‡Instrumentationè°ƒç”¨callActivityOnStartæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Instrumentation.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.onStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯ç›´æ¥è°ƒç”¨activityçš„onStartæ–¹æ³•ï¼Œç¬¬ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å‡ºç°äº†ï¼ŒO(âˆ©_âˆ©)O</p><p>è¿˜æ˜¯å›åˆ°æˆ‘ä»¬åˆšåˆšçš„handleLaunchActivityæ–¹æ³•ï¼Œåœ¨è°ƒç”¨å®ŒperformLaunchActivityæ–¹æ³•ä¹‹åï¼Œå…¶æœ‰åŠç”¨äº†handleResumeActivityæ–¹æ³•ï¼Œå¥½å§ï¼Œçœ‹åå­—åº”è¯¥æ˜¯å›è°ƒActivityçš„onResumeæ–¹æ³•çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">        ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// TODO Push resumeArgs into the activity for consideration</span></span><br><span class="line">        r = performResumeActivity(token, clearHide, reason);</span><br><span class="line">        .....</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">                r.window = r.activity.getWindow();</span><br><span class="line">                View decor = r.window.getDecorView();</span><br><span class="line">                decor.setVisibility(View.INVISIBLE);</span><br><span class="line">                ViewManager wm = a.getWindowManager();</span><br><span class="line">                WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">                a.mDecor = decor;</span><br><span class="line">                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">                l.softInputMode |= forwardBit;</span><br><span class="line">                <span class="keyword">if</span> (r.mPreserveWindow) &#123;</span><br><span class="line">                    a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                    r.mPreserveWindow = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="comment">// Normally the ViewRoot sets up callbacks with the Activity</span></span><br><span class="line">                    <span class="comment">// in addView-&gt;ViewRootImpl#setView. If we are instead reusing</span></span><br><span class="line">                    <span class="comment">// the decor view we have to notify the view root that the</span></span><br><span class="line">                    <span class="comment">// callbacks may have changed.</span></span><br><span class="line">                    ViewRootImpl impl = decor.getViewRootImpl();</span><br><span class="line">                    <span class="keyword">if</span> (impl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        impl.notifyChildRebuilt();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">                    a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                    wm.addView(decor, l);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the window has already been added, but during resume</span></span><br><span class="line">            <span class="comment">// we started another activity, then don't yet make the</span></span><br><span class="line">            <span class="comment">// window visible.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">                <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                    TAG, <span class="string">"Launch "</span> + r + <span class="string">" mStartedActivity set"</span>);</span><br><span class="line">                r.hideForNow = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span> (!r.onlyLocalRequest) &#123;</span><br><span class="line">                r.nextIdle = mNewActivities;</span><br><span class="line">                mNewActivities = r;</span><br><span class="line">                <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                    TAG, <span class="string">"Scheduling idle handler for "</span> + r);</span><br><span class="line">                    <span class="comment">//çº¿ç¨‹ç©ºé—²ï¼Œä¹Ÿå°±æ˜¯activityåˆ›å»ºå®Œæ¯•ä¹‹åï¼Œå®ƒä¼šæ‰§è¡ŒqueueIdleé‡Œé¢çš„ä»£ç ã€‚</span></span><br><span class="line">                Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å…¶resumeActivityçš„é€»è¾‘è°ƒç”¨åˆ°äº†performResumeActivityæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹performResumeActivityæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ActivityClientRecord <span class="title">performResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> clearHide, String reason)</span> </span>&#123;</span><br><span class="line">        ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Performing resume of "</span> + r</span><br><span class="line">                + <span class="string">" finished="</span> + r.activity.mFinished);</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; !r.activity.mFinished) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ......</span><br><span class="line">                r.activity.performResume();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = mRelaunchingActivities.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ActivityClientRecord relaunching = mRelaunchingActivities.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (relaunching.token == r.token</span><br><span class="line">                            &amp;&amp; relaunching.onlyLocalRequest &amp;&amp; relaunching.startsNotResumed) &#123;</span><br><span class="line">                        relaunching.startsNotResumed = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                EventLog.writeEvent(LOG_AM_ON_RESUME_CALLED, UserHandle.myUserId(),</span><br><span class="line">                        r.activity.getComponentName().getClassName(), reason);</span><br><span class="line">                r.paused = <span class="keyword">false</span>;</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">                r.state = <span class="keyword">null</span>;</span><br><span class="line">                r.persistentState = <span class="keyword">null</span>;</span><br><span class="line">            &#125; ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ–¹æ³•ä½“ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨äº†r.activity.performResume()æ–¹æ³•ï¼Œå¥½å§ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯Activityä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Activityä¸­æŸ¥çœ‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; Activity.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        performRestart();</span><br><span class="line">        ...</span><br><span class="line">        mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªåˆ†æ”¯èµ°äº†performRestart()ï¼Œè¿™ä¸ªæ–¹æ³•å³æ—¶onRestart()ç”Ÿå‘½å‘¨æœŸã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performRestart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mInstrumentation.callActivityOnRestart(<span class="keyword">this</span>);</span><br><span class="line">    performStart();</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performRestart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mFragments.noteStateNotSaved();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mToken != <span class="keyword">null</span> &amp;&amp; mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No need to check mStopped, the roots will check if they were actually stopped.</span></span><br><span class="line">            WindowManagerGlobal.getInstance().setStoppedState(mToken, <span class="keyword">false</span> <span class="comment">/* stopped */</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mStopped) &#123;</span><br><span class="line">            mStopped = <span class="keyword">false</span>;</span><br><span class="line">            ......</span><br><span class="line">            mCalled = <span class="keyword">false</span>;</span><br><span class="line">            mInstrumentation.callActivityOnRestart(<span class="keyword">this</span>);</span><br><span class="line">            ......</span><br><span class="line">            performStart();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é¦–å…ˆåˆ¤æ–­å½“å‰activityæ˜¯å¦ä¸ºStoppedçŠ¶æ€ï¼Œæ˜¯æ‰ä¼šèµ°OnRestart()-&gt;Onstart()ç”Ÿå‘½å‘¨æœŸã€‚</p><p>ç»§ç»­çœ‹ä¸‹performResume()ç¬¬äºŒä¸ªåˆ†æ”¯ï¼Œåˆæ˜¯ç†Ÿæ‚‰çš„å‘³é“ï¼Œé€šè¿‡Instrumentationæ¥è°ƒç”¨äº†callActivityOnResumeæ–¹æ³•ã€‚ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Instrumentation.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.mResumed = <span class="keyword">true</span>;</span><br><span class="line">        activity.onResume();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">                    am.match(activity, activity, activity.getIntent());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>O(âˆ©_âˆ©)Oï¼Œç¬¬å››ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å‡ºç°äº†ï¼ŒonResumeæ–¹æ³•ã€‚ã€‚ã€‚</p><p>ç»ˆäºå›è°ƒonResumeæ–¹æ³•äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬çš„ç•Œé¢åº”è¯¥å·²ç»å±•ç¤ºå‡ºæ¥äº†ï¼Œç…§ç†æ¥è¯´æˆ‘ä»¬çš„Activityåº”è¯¥å·²ç»å¯åŠ¨å®Œæˆäº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰ã€‚</p><p>æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒActivity a å¯åŠ¨ Activity b ä¼šè§¦å‘é‚£äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Ÿ ä½ å¯èƒ½ä¼šå›ç­”ï¼Ÿbçš„onCreate onStartæ–¹æ³•ï¼ŒonResumeæ–¹æ³• açš„onPauseæ–¹æ³•å’ŒonStopæ–¹æ³•ï¼ŒonStopæ–¹æ³•è¿˜æ²¡å›è°ƒï¼ŒO(âˆ©_âˆ©)Oï¼Œå¯¹äº†ç¼ºå°‘çš„å°±æ˜¯å¯¹onStopæ–¹æ³•çš„å›è°ƒã€‚</p><h3 id="ä¸ƒã€æ ˆé¡¶Activityæ‰§è¡ŒonStopæ–¹æ³•"><a href="#ä¸ƒã€æ ˆé¡¶Activityæ‰§è¡ŒonStopæ–¹æ³•" class="headerlink" title="ä¸ƒã€æ ˆé¡¶Activityæ‰§è¡ŒonStopæ–¹æ³•"></a>ä¸ƒã€æ ˆé¡¶Activityæ‰§è¡ŒonStopæ–¹æ³•</h3><blockquote><p>Looper.myQueue().addIdleHandler(new Idler())<br>-&gt; Idler.queueIdle()<br>ActivityManagerNative.getDefault().activityIdle()<br>ActivityManagerService.activityIdle()<br>ActivityStackSupervisor.activityIdleInternalLocked()<br>ActivityStack.stopActivityLocked()<br>IApplicationThread.scheduleStopActivity()<br>ActivityThread.scheduleStopActivity()<br>-&gt; ActivityThread.sendMessage()<br>ActivityThread.H.sendMessage()<br>-&gt; ActivityThread.H.handleMessage()<br>ActivityThread.handleStopActivity()<br>ActivityThread.performStopActivityInner()<br>ActivityThread.callCallActivityOnSaveInstanceState()<br>Instrumentation.callActivityOnSaveInstanceState()<br>Activity.performSaveInstanceState()<br>-&gt; Activity.onSaveInstanceState()<br>Activity.performStop()<br>-&gt; Instrumentation.callActivityOnStop()<br>Activity.onStop()</p></blockquote><p>å›åˆ°æˆ‘ä»¬çš„handleResumeActivityæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä½“æœ€åæœ‰è¿™æ ·çš„ä¸€ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ˜¯å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ç›¸å…³çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹Idlerå¯¹è±¡çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private class Idler implements MessageQueue.IdleHandler &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public final boolean queueIdle() &#123;</span><br><span class="line">            ActivityClientRecord a = mNewActivities;</span><br><span class="line">            .....</span><br><span class="line">            if (a != null) &#123;</span><br><span class="line">                mNewActivities = null;</span><br><span class="line">                IActivityManager am = ActivityManagerNative.getDefault();</span><br><span class="line">                ActivityClientRecord prev;</span><br><span class="line">                do &#123;</span><br><span class="line">                    ......</span><br><span class="line">                    if (a.activity != null &amp;&amp; !a.activity.mFinished) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            am.activityIdle(a.token, a.createdConfig, stopProfiling);</span><br><span class="line">                            a.createdConfig = null;</span><br><span class="line">                        &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                            // Ignore</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    prev = a;</span><br><span class="line">                    a = a.nextIdle;</span><br><span class="line">                    prev.nextIdle = null;</span><br><span class="line">                &#125; while (a != null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å½“Messagequeueæ‰§è¡Œaddæ–¹æ³•ä¹‹åå°±ä¼šå›è°ƒå…¶queueIdle()æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•ä½“ä¸­å…¶è°ƒç”¨äº†ActivityManagerNative.getDefault().activityIdle()ï¼Œå¥½å§ï¼Œç†Ÿæ‚‰äº†Binderæœºåˆ¶ä»¥åæˆ‘ä»¬çŸ¥é“è¿™æ®µä»£ç ä¼šæ‰§è¡Œåˆ°ActivityManagerServiceçš„activityIdleæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityIdle</span><span class="params">(IBinder token, Configuration config, <span class="keyword">boolean</span> stopProfiling)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ActivityStack stack = ActivityRecord.getStackLocked(token);</span><br><span class="line">        <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ActivityRecord r =</span><br><span class="line">                    mStackSupervisor.activityIdleInternalLocked(token, <span class="keyword">false</span>, config);</span><br><span class="line">            <span class="keyword">if</span> (stopProfiling) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((mProfileProc == r.app) &amp;&amp; (mProfileFd != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mProfileFd.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    clearProfilerLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Binder.restoreCallingIdentity(origId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨activityIdleæ–¹æ³•ä¸­åˆè°ƒç”¨äº†ActivityStackSupervisor.activityIdleInternalLockedæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStackSupervisor.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> ActivityRecord <span class="title">activityIdleInternalLocked</span><span class="params">(<span class="keyword">final</span> IBinder token, <span class="keyword">boolean</span> fromTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NS; i++) &#123;</span><br><span class="line">            r = stops.get(i);</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = r.task.stack;</span><br><span class="line">            <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.finishing) &#123;</span><br><span class="line">                    stack.finishCurrentActivityLocked(r, ActivityStack.FINISH_IMMEDIATELY, <span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    stack.stopActivityLocked(r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨å…¶ä¸­åˆè°ƒç”¨äº†ActivityStack.stopActivityLockedæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">stopActivityLocked</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((r.intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NO_HISTORY) != <span class="number">0</span></span><br><span class="line">                || (r.info.flags&amp;ActivityInfo.FLAG_NO_HISTORY) != <span class="number">0</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">                r.app.thread.scheduleStopActivity(r.appToken, r.visible, r.configChangeFlags);</span><br><span class="line">             ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¥½å§ï¼Œåˆæ˜¯ç›¸åŒçš„é€»è¾‘é€šè¿‡IApplicationThread.scheduleStopActivity,æœ€ç»ˆè°ƒç”¨äº†ActivityThread.scheduleStopActivity()æ–¹æ³•ã€‚ã€‚ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleStopActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> showWindow,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> configChanges)</span> </span>&#123;</span><br><span class="line">           sendMessage(</span><br><span class="line">                showWindow ? H.STOP_ACTIVITY_SHOW : H.STOP_ACTIVITY_HIDE,</span><br><span class="line">                token, <span class="number">0</span>, configChanges);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡ŒsendMessageæ–¹æ³•ï¼Œæœ€ç»ˆæ‰§è¡ŒHï¼ˆHandlerï¼‰çš„sendMessageæ–¹æ³•ï¼Œå¹¶è¢«Hçš„handleMessgeæ–¹æ³•æ¥æ”¶æ‰§è¡ŒhandleStopActivityæ–¹æ³•ã€‚ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleStopActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> show, <span class="keyword">int</span> configChanges)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        performStopActivityInner(r, info, show, <span class="keyword">true</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹performStopActivityInnerçš„å®ç°é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityThread.java]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performStopActivityInner</span><span class="params">(ActivityClientRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            StopInfo info, <span class="keyword">boolean</span> keepShown, <span class="keyword">boolean</span> saveState)</span> </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (!keepShown) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    r.activity.performStop();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">                r.stopped = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹performStopActivityInnerä¸­è°ƒç”¨åˆ°çš„Activityæ–¹æ³•çš„performStopæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mStopped) &#123;</span><br><span class="line">            ......</span><br><span class="line">            mFragments.dispatchStop();</span><br><span class="line">            mCalled = <span class="keyword">false</span>;</span><br><span class="line">            mInstrumentation.callActivityOnStop(<span class="keyword">this</span>);</span><br><span class="line">            ......</span><br><span class="line">            mStopped = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mResumed = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯é€šè¿‡Instrumentationæ¥å®ç°çš„ï¼Œè°ƒç”¨äº†å®ƒçš„callActivityOnStopæ–¹æ³•ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStop</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.onStop();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿå‘½å‘¨æœŸæ–¹æ³•onStop()å‡ºæ¥äº†ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Activity çš„ç”Ÿå‘½å‘¨æœŸï¼š</p><blockquote><p><strong>protected void onCreate();</strong><br><strong>protected void onRestart();</strong><br><strong>protected void onStart();</strong><br><strong>protected void onResume();</strong><br><strong>protected void onPause();</strong><br><strong>protected void onStop();</strong><br><strong>protected void onDestory();</strong></p></blockquote><p>å‰é¢æˆ‘ä»¬åˆ†æäº†onCreate()ã€onStart()ã€onRestart() ã€onResume()ã€onPause()ã€onStop()ã€‚ Activity é”€æ¯æ—¶çš„ onDestroy() å›è°ƒéƒ½ä¸å‰é¢çš„è¿‡ç¨‹å¤§åŒå°å¼‚ï¼Œè¿™é‡Œå°±åªåˆ—ä¸¾ç›¸åº”çš„æ–¹æ³•æ ˆï¼Œä¸å†ç»§ç»­æè¿°ã€‚</p><blockquote><p>Activity.finish()<br>ActivityManagerNative.getDefault().finishActivity()<br>ActivityManagerService.finishActivity()<br>ActivityStack.requestFinishActivityLocked()<br>ActivityStack.finishActivityLocked()<br>ActivityStack.startPausingLocked()<br>å‚è€ƒï¼š<a href="http://blog.csdn.net/qq_23547831/article/details/51232309" target="_blank" rel="noopener">Androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹</a></p></blockquote><h4 id="å¯åŠ¨æµç¨‹ï¼š"><a href="#å¯åŠ¨æµç¨‹ï¼š" class="headerlink" title="å¯åŠ¨æµç¨‹ï¼š"></a>å¯åŠ¨æµç¨‹ï¼š</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.startactivity/Android-start_activity_process.jpg" alt="Markdown"></p><p>1ã€ç‚¹å‡»æ¡Œé¢Appå›¾æ ‡ï¼ŒLauncherè¿›ç¨‹é‡‡ç”¨Binder IPCå‘system_serverè¿›ç¨‹å‘èµ·startActivityè¯·æ±‚ï¼›<br>2ã€system_serverè¿›ç¨‹æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå‘zygoteè¿›ç¨‹å‘é€åˆ›å»ºè¿›ç¨‹çš„è¯·æ±‚ï¼›<br>3ã€Zygoteè¿›ç¨‹forkå‡ºæ–°çš„å­è¿›ç¨‹ï¼Œå³Appè¿›ç¨‹ï¼›<br>4ã€Appè¿›ç¨‹ï¼Œé€šè¿‡Binder IPCå‘sytem_serverè¿›ç¨‹å‘èµ·attachApplicationè¯·æ±‚ï¼›<br>5ã€system_serverè¿›ç¨‹åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œè¿›è¡Œä¸€ç³»åˆ—å‡†å¤‡å·¥ä½œåï¼Œå†é€šè¿‡binder IPCå‘Appè¿›ç¨‹å‘é€scheduleLaunchActivityè¯·æ±‚ï¼›<br>6ã€Appè¿›ç¨‹çš„binderçº¿ç¨‹ï¼ˆApplicationThreadï¼‰åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡handlerå‘ä¸»çº¿ç¨‹å‘é€LAUNCH_ACTIVITYæ¶ˆæ¯ï¼›<br>7ã€ä¸»çº¿ç¨‹åœ¨æ”¶åˆ°Messageåï¼Œé€šè¿‡å‘å°„æœºåˆ¶åˆ›å»ºç›®æ ‡Activityï¼Œå¹¶å›è°ƒActivity.onCreate()ç­‰æ–¹æ³•ã€‚</p><p>åˆ°æ­¤ï¼ŒAppä¾¿æ­£å¼å¯åŠ¨ï¼Œå¼€å§‹è¿›å…¥Activityç”Ÿå‘½å‘¨æœŸï¼Œæ‰§è¡Œå®ŒonCreate/onStart/onResumeæ–¹æ³•ï¼ŒUIæ¸²æŸ“ç»“æŸåä¾¿å¯ä»¥çœ‹åˆ°Appçš„ä¸»ç•Œé¢ã€‚ å¯åŠ¨Activityè¾ƒä¸ºå¤æ‚ï¼Œåç»­ä»‹ç»çª—å£åŠ è½½æ¸²æŸ“è¿‡ç¨‹ï¼Œå¯å‚è€ƒæ–‡æ¡£ï¼šã€Android 7.1.2 (Android N) Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹åˆ†æã€‘</p><h3 id="å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢-ï¼š"><a href="#å‚è€ƒæ–‡æ¡£-ç‰¹åˆ«æ„Ÿè°¢-ï¼š" class="headerlink" title="å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢)ï¼š"></a>å‚è€ƒæ–‡æ¡£(ç‰¹åˆ«æ„Ÿè°¢)ï¼š</h3><p><a href="http://blog.csdn.net/qq_23547831/article/details/51224992" target="_blank" rel="noopener">Androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹</a><br><a href="http://gityuan.com/2016/03/12/start-activity/" target="_blank" rel="noopener">Android Activityå¯åŠ¨è¿‡ç¨‹åˆ†æ</a><br><a href="http://blog.csdn.net/qq_23547831/article/details/51232309" target="_blank" rel="noopener">Androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹</a><br><a href="http://blog.csdn.net/zhaokaiqiang1992/article/details/49428287" target="_blank" rel="noopener">å‡¯å­å“¥å¸¦ä½ å­¦Frameworkâ€“Activityå¯åŠ¨è¿‡ç¨‹å…¨è§£æ</a><br><a href="http://www.cloudchou.com/android/post-788.html" target="_blank" rel="noopener">æ·±å…¥ç†è§£Activityå¯åŠ¨æµç¨‹(ä¸€)â€“Activityå¯åŠ¨çš„æ¦‚è¦æµç¨‹</a><br><a href="http://blog.csdn.net/Gaugamela/article/category/6383486" target="_blank" rel="noopener">Android 7.0 ActivityManagerService å¯åŠ¨Activityçš„è¿‡ç¨‹ ç³»åˆ—</a><br><a href="http://blog.csdn.net/yalinfendou/article/details/46909173" target="_blank" rel="noopener">Activityç”Ÿå‘½å‘¨æœŸçš„å›è°ƒï¼Œä½ åº”è¯¥çŸ¥é“å¾—æ›´å¤šï¼â€“Androidæºç å‰–æï¼ˆä¸Šï¼‰</a><br><a href="http://blog.csdn.net/yalinfendou/article/details/46910811" target="_blank" rel="noopener">Activityç”Ÿå‘½å‘¨æœŸçš„å›è°ƒï¼Œä½ åº”è¯¥çŸ¥é“å¾—æ›´å¤šï¼â€“Androidæºç å‰–æï¼ˆä¸‹ï¼‰</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2017/10/01/Android-7-1-2-Android-N-Activityå¯åŠ¨æµç¨‹åˆ†æ/">http://zhoujinjian.cc/2017/10/01/Android-7-1-2-Android-N-Activityå¯åŠ¨æµç¨‹åˆ†æ/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2017/09/01/Android-7-1-2-Android-N-Androidç³»ç»Ÿå¯åŠ¨æµç¨‹/" title="Android 7.1.2 (Android N) Android ç³»ç»Ÿå¯åŠ¨æµç¨‹ åˆ†æ"><i class="iconfont icon-prev"></i>Android 7.1.2 (Android N) Android ç³»ç»Ÿå¯åŠ¨æµç¨‹ åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2017/11/01/Android-7-1-2-Android-N-Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹/" title="Android 7.1.2 (Android N) Activity - Window åŠ è½½æ˜¾ç¤ºæµç¨‹ï¼ˆAMS && WMSï¼‰åˆ†æ">Android 7.1.2 (Android N) Activity - Window åŠ è½½æ˜¾ç¤ºæµç¨‹ï¼ˆAMS && WMSï¼‰åˆ†æ<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">9</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/04/03/ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif)/" title="ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.10.jpg" alt="ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]"></div><div class="item__info"><h3 class="item__title">ä¸ªäººç½‘ç«™(åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„çš„Loading gif) [i.wonder~]</h3><span class="item__text">2018-04-03</span></div></a></li><li class="latest-post-item"><a href="/2018/04/01/Linuxå†…æ ¸ï¼ˆKernel-3-18ï¼‰-Input-å­ç³»ç»Ÿåˆ†æ-i-wonder/" title="Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.09.jpg" alt="Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]"></div><div class="item__info"><h3 class="item__title">Linuxå†…æ ¸ï¼ˆKernel-3.18ï¼‰ - Linux Input å­ç³»ç»Ÿåˆ†æ [i.wonder~]</h3><span class="item__text">2018-04-01</span></div></a></li><li class="latest-post-item"><a href="/2018/03/01/Android-7-1-2-Android-N-Android-WindowManagerService-çª—å£ç®¡ç†æœåŠ¡åˆ†æ-i-wonder/" title="Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.08.jpg" alt="Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]"></div><div class="item__info"><h3 class="item__title">Android 7.1.2 (Android N) Android WindowManagerService çª—å£ç®¡ç†æœåŠ¡ åˆ†æ [i.wonder~]</h3><span class="item__text">2018-03-01</span></div></a></li><li class="latest-post-item"><a href="/2018/02/01/Android-7-1-2-Android-N-Android-Graphics-ç³»ç»Ÿåˆ†æ/" title="Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.07.jpg" alt="Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]"></div><div class="item__info"><h3 class="item__title">Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿ åˆ†æ [i.wonder~]</h3><span class="item__text">2018-02-01</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Room 103, Building 5, No. 5 Jiangtai Road, Shouxin Building, Chaoyang District, Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>zhou.jinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:zhou.jinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">41058</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">105833</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>