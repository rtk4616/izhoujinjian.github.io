<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android 7.1.2 (Android N) Android ç³»ç»Ÿå¯åŠ¨æµç¨‹ åˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2017/09/01/Android-7-1-2-Android-N-Androidç³»ç»Ÿå¯åŠ¨æµç¨‹/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.02.jpg" alt="Android 7.1.2 (Android N) Android ç³»ç»Ÿå¯åŠ¨æµç¨‹ åˆ†æ"></div><header class="post__info"><h1 class="post__title">Android 7.1.2 (Android N) Android ç³»ç»Ÿå¯åŠ¨æµç¨‹ åˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="http://zhoujinjian.cc/">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘.</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2017-09-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#æºç ï¼š"><span class="toc-text">æºç ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åšå®¢åŸå›¾é“¾æ¥"><span class="toc-text">åšå®¢åŸå›¾é“¾æ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸€ã€Androidæ¦‚è¿°"><span class="toc-text">ä¸€ã€Androidæ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#äºŒã€ç³»ç»Ÿå¯åŠ¨"><span class="toc-text">äºŒã€ç³»ç»Ÿå¯åŠ¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸‰ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹"><span class="toc-text">ä¸‰ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1ã€Bootloaderå¼•å¯¼"><span class="toc-text">3.1ã€Bootloaderå¼•å¯¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2ã€è£…è½½å’Œå¯åŠ¨Linuxå†…æ ¸"><span class="toc-text">3.2ã€è£…è½½å’Œå¯åŠ¨Linuxå†…æ ¸</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3ã€å¯åŠ¨Initè¿›ç¨‹"><span class="toc-text">3.3ã€å¯åŠ¨Initè¿›ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4ã€å¯åŠ¨Zygoteè¿›ç¨‹"><span class="toc-text">3.4ã€å¯åŠ¨Zygoteè¿›ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5ã€å¯åŠ¨SystemServer"><span class="toc-text">3.5ã€å¯åŠ¨SystemServer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6ã€å¯åŠ¨ActivityManagerService"><span class="toc-text">3.6ã€å¯åŠ¨ActivityManagerService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7ã€å¯åŠ¨Launcher-Activity"><span class="toc-text">3.7ã€å¯åŠ¨Launcher(Activity)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å››ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹è¯¦ç»†åˆ†æ"><span class="toc-text">å››ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹è¯¦ç»†åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ1ï¼‰ã€å¯åŠ¨Initè¿›ç¨‹"><span class="toc-text">ï¼ˆ1ï¼‰ã€å¯åŠ¨Initè¿›ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1ã€main"><span class="toc-text">4.1.1ã€main()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2ã€åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ"><span class="toc-text">4.1.2ã€åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-4ã€å±è”½æ ‡å‡†çš„è¾“å…¥è¾“å‡º"><span class="toc-text">4.1.4ã€å±è”½æ ‡å‡†çš„è¾“å…¥è¾“å‡º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5ã€åˆå§‹åŒ–å†…æ ¸logç³»ç»Ÿ"><span class="toc-text">4.1.5ã€åˆå§‹åŒ–å†…æ ¸logç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-6ã€åˆå§‹åŒ–å±æ€§åŸŸ"><span class="toc-text">4.1.6ã€åˆå§‹åŒ–å±æ€§åŸŸ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-7ã€å®ŒæˆSELinuxç›¸å…³å·¥ä½œ"><span class="toc-text">4.1.7ã€å®ŒæˆSELinuxç›¸å…³å·¥ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-8ã€é‡æ–°è®¾ç½®å±æ€§"><span class="toc-text">4.1.8ã€é‡æ–°è®¾ç½®å±æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-9ã€åˆ›å»ºepollå¥æŸ„"><span class="toc-text">4.1.9ã€åˆ›å»ºepollå¥æŸ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-10ã€è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨"><span class="toc-text">4.1.10ã€è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-11ã€è®¾ç½®é»˜è®¤ç³»ç»Ÿå±æ€§"><span class="toc-text">4.1.11ã€è®¾ç½®é»˜è®¤ç³»ç»Ÿå±æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-12ã€é…ç½®å±æ€§çš„æœåŠ¡ç«¯"><span class="toc-text">4.1.12ã€é…ç½®å±æ€§çš„æœåŠ¡ç«¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-12ã€è§£æinit-rcæ–‡ä»¶"><span class="toc-text">4.1.12ã€è§£æinit.rcæ–‡ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-12-1-ServiceParser"><span class="toc-text">4.1.12..1 ServiceParser</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-12-2-ActionParser"><span class="toc-text">4.1.12.2 ActionParser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-13ã€å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶å®ƒaction"><span class="toc-text">4.1.13ã€å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶å®ƒaction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-14ã€å¤„ç†æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—çš„äº‹ä»¶"><span class="toc-text">4.1.14ã€å¤„ç†æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—çš„äº‹ä»¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ2ï¼‰ã€å¯åŠ¨Zygoteè¿›ç¨‹"><span class="toc-text">ï¼ˆ2ï¼‰ã€å¯åŠ¨Zygoteè¿›ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1ã€æ¦‚è¿°"><span class="toc-text">4.2.1ã€æ¦‚è¿°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2ã€Zygoteå¯åŠ¨è¿‡ç¨‹"><span class="toc-text">4.2.2ã€Zygoteå¯åŠ¨è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-1ã€App-main-main"><span class="toc-text">4.2.2.1ã€App_main.main()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-2ã€AndroidRuntime-start"><span class="toc-text">4.2.2.2ã€AndroidRuntime.start()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-3ã€AndroidRuntime-startVm"><span class="toc-text">4.2.2.3ã€AndroidRuntime.startVm()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-4ã€AndroidRuntime-startReg"><span class="toc-text">4.2.2.4ã€AndroidRuntime.startReg()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-4-1ã€Threads-androidSetCreateThreadFunc"><span class="toc-text">4.2.2.4.1ã€Threads.androidSetCreateThreadFunc()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-4-2ã€register-jni-procs"><span class="toc-text">4.2.2.4.2ã€register_jni_procs()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-4-3ã€gRegJNI-mProc"><span class="toc-text">4.2.2.4.3ã€gRegJNI.mProc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-5ã€è¿›å…¥Javaå±‚"><span class="toc-text">4.2.2.5ã€è¿›å…¥Javaå±‚</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-5-1ã€ZygoteInit-main"><span class="toc-text">4.2.2.5.1ã€ZygoteInit.main()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-5-2ã€ZygoteInit-registerZygoteSocket"><span class="toc-text">4.2.2.5.2ã€ZygoteInit.registerZygoteSocket()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-5-2ã€ZygoteInit-preload"><span class="toc-text">4.2.2.5.2ã€ZygoteInit.preload()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-5-3ã€ZygoteInit-startSystemServer"><span class="toc-text">4.2.2.5.3ã€ZygoteInit.startSystemServer()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-5-4ã€ZygoteInit-runSelectLoop"><span class="toc-text">4.2.2.5.4ã€ZygoteInit.runSelectLoop()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-5-4ã€ZygoteConnection-runOnce"><span class="toc-text">4.2.2.5.4ã€ZygoteConnection.runOnce()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-6ã€æ€»ç»“"><span class="toc-text">4.2.2.6ã€æ€»ç»“</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ3ï¼‰ã€å¯åŠ¨SystemServerä¸Šç¯‡"><span class="toc-text">ï¼ˆ3ï¼‰ã€å¯åŠ¨SystemServerä¸Šç¯‡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1ã€å¯åŠ¨æµç¨‹"><span class="toc-text">4.3.1ã€å¯åŠ¨æµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2ã€ZygoteInit-startSystemServer"><span class="toc-text">4.3.2ã€ZygoteInit.startSystemServer()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3ã€Zygote-forkSystemServer"><span class="toc-text">4.3.3ã€Zygote. forkSystemServer()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-4ã€com-android-internal-os-Zygote-nativeForkSystemServer"><span class="toc-text">4.3.4ã€com_android_internal_os_Zygote.nativeForkSystemServer()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-5ã€com-android-internal-os-Zygote-ForkAndSpecializeCommon"><span class="toc-text">4.3.5ã€com_android_internal_os_Zygote.ForkAndSpecializeCommon()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-5ã€ZygoteInit-handleSystemServerProcess"><span class="toc-text">4.3.5ã€ZygoteInit.handleSystemServerProcess()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-6ã€ZygoteInit-performSystemServerDexOpt"><span class="toc-text">4.3.6ã€ZygoteInit.performSystemServerDexOpt()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-7ã€RuntimeInit-zygoteInit"><span class="toc-text">4.3.7ã€RuntimeInit.zygoteInit()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-8ã€RuntimeInit-commonInit"><span class="toc-text">4.3.8ã€RuntimeInit.commonInit()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-9ã€AndroidRuntime-nativeZygoteInit"><span class="toc-text">4.3.9ã€AndroidRuntime.nativeZygoteInit()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-10ã€RuntimeInit-applicationInit"><span class="toc-text">4.3.10ã€RuntimeInit.applicationInit()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-11ã€RuntimeInit-invokeStaticMain"><span class="toc-text">4.3.11ã€RuntimeInit.invokeStaticMain()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-12ã€MethodAndArgsCaller-run"><span class="toc-text">4.3.12ã€MethodAndArgsCaller.run()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ4ï¼‰ã€å¯åŠ¨SystemServerä¸‹ç¯‡"><span class="toc-text">ï¼ˆ4ï¼‰ã€å¯åŠ¨SystemServerä¸‹ç¯‡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1ã€SystemServer-main"><span class="toc-text">4.4.1ã€SystemServer.main()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2ã€SystemServer-run"><span class="toc-text">4.4.2ã€SystemServer.run()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-3ã€SystemServer-performPendingShutdown"><span class="toc-text">4.4.3ã€SystemServer.performPendingShutdown()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-4ã€SystemServer-createSystemContext"><span class="toc-text">4.4.4ã€SystemServer.createSystemContext()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-5ã€SystemServer-startBootstrapServices"><span class="toc-text">4.4.5ã€SystemServer.startBootstrapServices()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-5ã€SystemServer-startCoreServices"><span class="toc-text">4.4.5ã€SystemServer.startCoreServices()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-6-SystemServer-startOtherServices"><span class="toc-text">4.4.6 SystemServer.startOtherServices()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-7ã€æœåŠ¡å¯åŠ¨é˜¶æ®µ"><span class="toc-text">4.4.7ã€æœåŠ¡å¯åŠ¨é˜¶æ®µ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-7-1ã€Phase0"><span class="toc-text">4.4.7.1ã€Phase0</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-7-1-2ã€Phase100"><span class="toc-text">4.4.7.1.2ã€Phase100</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-7-1-3ã€Phase480"><span class="toc-text">4.4.7.1.3ã€Phase480</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-7-1-4ã€Phase500"><span class="toc-text">4.4.7.1.4ã€Phase500</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-7-1-5ã€Phase550"><span class="toc-text">4.4.7.1.5ã€Phase550</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-7-1-6ã€Phase600"><span class="toc-text">4.4.7.1.6ã€Phase600</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-7-1-7ã€Phase1000"><span class="toc-text">4.4.7.1.7ã€Phase1000</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-8ã€æœåŠ¡ç±»åˆ«"><span class="toc-text">4.4.8ã€æœåŠ¡ç±»åˆ«</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ï¼ˆ5ï¼‰ã€å¯åŠ¨ActivityManagerService"><span class="toc-text">ï¼ˆ5ï¼‰ã€å¯åŠ¨ActivityManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-1ã€æ¦‚è¿°"><span class="toc-text">4.5.1ã€æ¦‚è¿°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-2ã€SystemServer-startBootstrapServices"><span class="toc-text">4.5.2ã€SystemServer.startBootstrapServices()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-3ã€å¯åŠ¨AMSæœåŠ¡"><span class="toc-text">4.5.3ã€å¯åŠ¨AMSæœåŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-4ã€å¯åŠ¨AMSæœåŠ¡"><span class="toc-text">4.5.4ã€å¯åŠ¨AMSæœåŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-7ã€AMS-systemReady"><span class="toc-text">4.5.7ã€AMS.systemReady()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-7-1ã€é˜¶æ®µä¸€"><span class="toc-text">4.5.7.1ã€é˜¶æ®µä¸€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-7-2ã€é˜¶æ®µäºŒ"><span class="toc-text">4.5.7.2ã€é˜¶æ®µäºŒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1ã€è°ƒç”¨å›è°ƒæ¥å£"><span class="toc-text">2.1ã€è°ƒç”¨å›è°ƒæ¥å£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2ã€å¯åŠ¨persistentæ ‡å¿—çš„è¿›ç¨‹"><span class="toc-text">2.2ã€å¯åŠ¨persistentæ ‡å¿—çš„è¿›ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ€»ç»“"><span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ï¼ˆ6ï¼‰ã€å¯åŠ¨Launcher-Activity"><span class="toc-text">ï¼ˆ6ï¼‰ã€å¯åŠ¨Launcher(Activity)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å‚è€ƒæ–‡æ¡£ï¼š"><span class="toc-text">å‚è€ƒæ–‡æ¡£ï¼š</span></a></li></ol></li></ol></div><h2 id="æºç ï¼š"><a href="#æºç ï¼š" class="headerlink" title="æºç ï¼š"></a>æºç ï¼š</h2><p><strong>system/core/rootdir/</strong></p><ul><li>init.rc</li><li>init.zygote64.rc</li></ul><p><strong>system/core/init/</strong></p><ul><li>init.cpp</li><li>init_parser.cpp</li><li>signal_handler.cpp</li></ul><p><strong>frameworks/base/cmds/app_process/</strong></p><ul><li>App_main.cpp</li></ul><p><strong>frameworks/base/core/jni/</strong></p><ul><li>AndroidRuntime.cpp</li></ul><p><strong>frameworks/base/core/java/com/android/internal/os/</strong></p><ul><li>ZygoteInit.java</li><li>Zygote.java</li><li>ZygoteConnection.java</li></ul><p><strong>frameworks/base/core/java/com/android/internal/os/</strong></p><ul><li>ZygoteInit.java</li><li>RuntimeInit.java</li><li>Zygote.java</li></ul><p><strong>frameworks/base/core/services/java/com/android/server/</strong></p><ul><li>SystemServer.java</li></ul><p><strong>frameworks/base/core/jni/</strong></p><ul><li>com_android_internal_os_Zygote.cpp</li><li>AndroidRuntime.cpp</li></ul><p><strong>frameworks/base/services/java/com/android/server/</strong></p><ul><li>SystemServer.java</li></ul><p><strong>frameworks/base/services/core/java/com/android/server/</strong></p><ul><li>SystemServiceManager.java</li><li>ServiceThread.java</li><li>am/ActivityManagerService.java</li></ul><p><strong>frameworks/base/core/java/android/app/</strong></p><ul><li>ActivityThread.java</li><li>LoadedApk.java</li><li>ContextImpl.java</li></ul><p><strong>frameworks/base/core/java/android/app/</strong></p><ul><li>ActivityThread.java</li><li>LoadedApk.java</li><li>ContextImpl.java</li></ul><p><strong>frameworks/base/services/java/com/android/server/</strong></p><ul><li>SystemServer.java</li></ul><p><strong>frameworks/base/services/core/java/com/android/server/</strong></p><ul><li>SystemServiceManager.java</li><li>ServiceThread.java</li><li>pm/Installer.java</li><li>am/ActivityManagerService.java</li></ul><h2 id="åšå®¢åŸå›¾é“¾æ¥"><a href="#åšå®¢åŸå›¾é“¾æ¥" class="headerlink" title="åšå®¢åŸå›¾é“¾æ¥"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.boot" target="_blank" rel="noopener">åšå®¢åŸå›¾é“¾æ¥</a></h2><h3 id="ä¸€ã€Androidæ¦‚è¿°"><a href="#ä¸€ã€Androidæ¦‚è¿°" class="headerlink" title="ä¸€ã€Androidæ¦‚è¿°"></a>ä¸€ã€Androidæ¦‚è¿°</h3><p>Androidç³»ç»Ÿéå¸¸åºå¤§ï¼Œåº•å±‚æ˜¯é‡‡ç”¨Linuxä½œä¸ºåŸºåº•ï¼Œä¸Šå±‚é‡‡ç”¨å¸¦æœ‰è™šæ‹Ÿæœºçš„Javaå±‚ï¼Œé€šè¿‡é€šè¿‡JNIæŠ€æœ¯ï¼Œå°†ä¸Šä¸‹æ‰“é€šï¼Œèä¸ºä¸€ä½“ã€‚ä¸‹å›¾æ˜¯Googleæä¾›çš„ä¸€å¼ ç»å…¸çš„4å±‚æ¶æ„å›¾ï¼Œä»ä¸‹å¾€ä¸Šï¼Œä¾æ¬¡åˆ†ä¸ºLinuxå†…æ ¸ï¼Œç³»ç»Ÿåº“å’ŒAndroid Runtimeï¼Œåº”ç”¨æ¡†æ¶å±‚ï¼Œåº”ç”¨ç¨‹åºå±‚è¿™4å±‚æ¶æ„ï¼Œæ¯ä¸€å±‚éƒ½åŒ…å«å¤§é‡çš„å­æ¨¡å—æˆ–å­ç³»ç»Ÿã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N01-android-system-start-arch.png" alt="Markdown"></p><h3 id="äºŒã€ç³»ç»Ÿå¯åŠ¨"><a href="#äºŒã€ç³»ç»Ÿå¯åŠ¨" class="headerlink" title="äºŒã€ç³»ç»Ÿå¯åŠ¨"></a>äºŒã€ç³»ç»Ÿå¯åŠ¨</h3><p>Googleæä¾›çš„4å±‚æ¶æ„å›¾ï¼Œæ˜¯éå¸¸ç»å…¸ï¼Œä½†åªæ˜¯å¦‚å’ç –èˆ¬çš„æ–¹å¼ï¼Œç®€å•åœ°åˆ†å±‚ï¼Œè€Œä¸è¶³è¡¨è¾¾Androidæ•´ä¸ªç³»ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹ï¼Œç¯ç¯ç›¸æ‰£çš„è¿æ¥å…³ç³»ï¼Œæœ¬æ–‡æ›´å¤šçš„æ˜¯ä»¥è¿›ç¨‹çš„è§†è§’ï¼Œä»¥åˆ†å±‚çš„æ¶æ„æ¥è¯ é‡ŠAndroidç³»ç»Ÿçš„å…¨è²Œã€‚ ç³»ç»Ÿå¯åŠ¨æ¶æ„å›¾<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N02-android-system-start-arch.png" alt="Markdown"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N03-android-system-start-arch.png" alt="Markdown"><br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N04-android-system-start-arch.png" alt="Markdown"></p><h3 id="ä¸‰ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹"><a href="#ä¸‰ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="ä¸‰ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹"></a>ä¸‰ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹</h3><h4 id="3-1ã€Bootloaderå¼•å¯¼"><a href="#3-1ã€Bootloaderå¼•å¯¼" class="headerlink" title="3.1ã€Bootloaderå¼•å¯¼"></a>3.1ã€Bootloaderå¼•å¯¼</h4><p>Boot ROM: å½“æ‰‹æœºå¤„äºå…³æœºçŠ¶æ€æ—¶ï¼Œé•¿æŒ‰Poweré”®å¼€æœºï¼Œå¼•å¯¼èŠ¯ç‰‡å¼€å§‹ä»å›ºåŒ–åœ¨ROMé‡Œçš„é¢„è®¾å‡ºä»£ç å¼€å§‹æ‰§è¡Œï¼Œç„¶ååŠ è½½å¼•å¯¼ç¨‹åºåˆ°RAMï¼›</p><p>Boot Loaderï¼šè¿™æ˜¯å¯åŠ¨Androidç³»ç»Ÿä¹‹å‰çš„å¼•å¯¼ç¨‹åºï¼Œä¸»è¦æ˜¯æ£€æŸ¥RAMï¼Œåˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚CPUã€å†…å­˜ã€Flashç­‰ï¼‰å¹¶ä¸”é€šè¿‡å»ºç«‹å†…å­˜ç©ºé—´æ˜ å°„ï¼Œä¸ºè£…è½½Linuxå†…æ ¸å‡†å¤‡åˆé€‚çš„ç¯å¢ƒã€‚ä¸€æ—¦Linuxå†…æ ¸è£…è½½å®Œæ¯•ï¼ŒBootloaderå°†ä¼šä»å†…å­˜ä¸­æ¸…é™¤æ‰ã€‚ å¦‚æœç”¨æˆ·åœ¨Bootloaderè¿è¡ŒæœŸé—´ï¼ŒæŒ‰ä¸‹é¢„å®šä¹‰çš„ç»„åˆå¥ï¼Œå¯ä»¥è¿›å…¥ç³»ç»Ÿçš„æ›´æ–°æ¨¡å—ã€‚Androidçš„ä¸‹è½½æ›´æ–°å¯ä»¥é€‰æ‹©è¿›å…¥Fastbootæ¨¡å¼æˆ–è€…Recoveryæ¨¡å¼ã€‚</p><p>Fastbootæ˜¯Androidè®¾è®¡çš„ä¸€å¥—é€šè¿‡USBæ¥æ›´æ–°æ‰‹æœºåˆ†åŒºæ˜ åƒçš„åè®®ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜èƒ½å¿«é€Ÿæ›´æ–°æŒ‡å®šçš„æ‰‹æœºåˆ†åŒºã€‚ä½†æ˜¯ä¸€èˆ¬çš„é›¶å”®æœºä¸Šå¾€å¾€å»æ‰äº†Fastbootï¼ŒGoogleé”€å”®çš„å¼€å‘æœºåˆ™å¸¦æœ‰Fastbootæ¨¡å—ã€‚ Recoveryæ¨¡å¼æ˜¯Androidç‰¹æœ‰çš„å‡çº§ç³»ç»Ÿã€‚åˆ©ç”¨Recoveryæ¨¡å¼ï¼Œæ‰‹æœºå¯ä»¥è¿›è¡Œæ¢å¤å‡ºå‚è®¾ç½®æˆ–è¿›è¡ŒOTAã€è¡¥ä¸å’Œå›ºä»¶å‡çº§ã€‚è¿›å…¥Recoveryæ¨¡å¼å®é™…ä¸Šæ˜¯å¯åŠ¨äº†ä¸€ä¸ªæ–‡æœ¬æ¨¡å¼çš„Linuxã€‚</p><h4 id="3-2ã€è£…è½½å’Œå¯åŠ¨Linuxå†…æ ¸"><a href="#3-2ã€è£…è½½å’Œå¯åŠ¨Linuxå†…æ ¸" class="headerlink" title="3.2ã€è£…è½½å’Œå¯åŠ¨Linuxå†…æ ¸"></a>3.2ã€è£…è½½å’Œå¯åŠ¨Linuxå†…æ ¸</h4><p>åˆ°è¿™é‡Œæ‰åˆšåˆšå¼€å§‹è¿›å…¥Androidç³»ç»Ÿ.</p><p>å¯åŠ¨Kernelçš„0å·è¿›ç¨‹ï¼šåˆå§‹åŒ–è¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ï¼ŒåŠ è½½Display,Camera Driverï¼ŒBinder Driverç­‰ç›¸å…³å·¥ä½œï¼› å¯åŠ¨kthreaddè¿›ç¨‹ï¼ˆpid=2ï¼‰ï¼šæ˜¯Linuxç³»ç»Ÿçš„å†…æ ¸è¿›ç¨‹ï¼Œä¼šåˆ›å»ºå†…æ ¸å·¥ä½œçº¿ç¨‹kworkderï¼Œè½¯ä¸­æ–­çº¿ç¨‹ksoftirqdï¼Œthermalç­‰å†…æ ¸å®ˆæŠ¤è¿›ç¨‹ã€‚kthreaddè¿›ç¨‹æ˜¯æ‰€æœ‰å†…æ ¸è¿›ç¨‹çš„é¼»ç¥–ã€‚</p><p>Androidçš„boot.imgå­˜æ”¾çš„å°±æ˜¯Linuxå†…æ ¸å’Œä¸€ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿã€‚Bootloaderä¼šæŠŠboot.imgæ˜ åƒè£…è½½è¿›å†…å­˜ã€‚ç„¶åLinuxå†…æ ¸ä¼šæ‰§è¡Œæ•´ä¸ªç³»ç»Ÿçš„åˆå§‹åŒ–ï¼Œå®Œæˆåè£…è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€åå¯åŠ¨Initè¿›ç¨‹ã€‚</p><h4 id="3-3ã€å¯åŠ¨Initè¿›ç¨‹"><a href="#3-3ã€å¯åŠ¨Initè¿›ç¨‹" class="headerlink" title="3.3ã€å¯åŠ¨Initè¿›ç¨‹"></a>3.3ã€å¯åŠ¨Initè¿›ç¨‹</h4><p>Linuxå†…æ ¸åŠ è½½å®Œæ¯•åï¼Œä¼šé¦–å…ˆå¯åŠ¨Initè¿›ç¨‹ï¼ŒInitè¿›ç¨‹æ˜¯ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚åœ¨Initè¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šè§£æLinuxçš„é…ç½®è„šæœ¬init.rcæ–‡ä»¶ï¼Œæ ¹æ®init.rcæ–‡ä»¶çš„å†…å®¹ï¼ŒInitè¿›ç¨‹ä¼šè£…è½½Androidçš„æ–‡ä»¶ç³»ç»Ÿã€åˆ›å»ºç³»ç»Ÿç›®å½•ã€‚åˆå§‹ åŒ–å±æ€§ç³»ç»Ÿã€å¯åŠ¨Androidç³»ç»Ÿé‡è¦çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œè¿™äº›è¿›ç¨‹åŒ…æ‹¬USBå®ˆæŠ¤è¿›ç¨‹ã€adbå®ˆæŠ¤è¿›ç¨‹ã€voldå®ˆæŠ¤è¿›ç¨‹ã€rildå®ˆæŠ¤è¿›ç¨‹ã€‚</p><p>å¯åŠ¨initè¿›ç¨‹(pid=1),æ˜¯Linuxç³»ç»Ÿçš„ç”¨æˆ·è¿›ç¨‹ï¼Œinitè¿›ç¨‹æ˜¯æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹çš„é¼»ç¥–ã€‚</p><p>initè¿›ç¨‹å¯åŠ¨Media Server(å¤šåª’ä½“æœåŠ¡)ã€servicemanager(binderæœåŠ¡ç®¡å®¶)ã€bootanim(å¼€æœºåŠ¨ç”»)ç­‰é‡è¦æœåŠ¡ initè¿›ç¨‹è¿˜ä¼šå­µåŒ–å‡ºinstalldã€ueventdã€adbdã€ç­‰ç”¨æˆ·å®ˆæŠ¤è¿›ç¨‹ï¼› initè¿›ç¨‹å­µåŒ–å‡ºZygoteè¿›ç¨‹ï¼ŒZygoteè¿›ç¨‹æ˜¯Androidç³»ç»Ÿçš„é¦–ä¸ªJavaè¿›ç¨‹ï¼ŒZygoteæ˜¯æ‰€æœ‰Javaè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼ŒZygoteè¿›ç¨‹æœ¬èº«æ˜¯ç”±initè¿›ç¨‹å­µåŒ–è€Œæ¥çš„ã€‚ <a href="http://blog.csdn.net/sunao2002002/article/details/52454878" target="_blank" rel="noopener">Android 7.0 init.rcçš„ä¸€ç‚¹æ”¹å˜ - å“ˆå“ˆçš„ä¸ªäººä¸“æ  - CSDNåšå®¢</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/system/core/rootdir/init.rc</span><br><span class="line">.....</span><br><span class="line">service ueventd /sbin/ueventd</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">core</span></span></span><br><span class="line"><span class="class"><span class="title">critical</span></span></span><br><span class="line">seclabel u:r:ueventd:s0</span><br><span class="line"></span><br><span class="line">service healthd /sbin/healthd</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">core</span></span></span><br><span class="line"><span class="class"><span class="title">critical</span></span></span><br><span class="line">seclabel u:r:healthd:s0</span><br><span class="line">group root system wakelock</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h4 id="3-4ã€å¯åŠ¨Zygoteè¿›ç¨‹"><a href="#3-4ã€å¯åŠ¨Zygoteè¿›ç¨‹" class="headerlink" title="3.4ã€å¯åŠ¨Zygoteè¿›ç¨‹"></a>3.4ã€å¯åŠ¨Zygoteè¿›ç¨‹</h4><p>initè¿›ç¨‹åˆå§‹åŒ–ç»“æŸæ—¶ï¼Œä¼šå¯åŠ¨Zygoteè¿›ç¨‹ã€‚Zygoteè¿›ç¨‹è´Ÿè´£forkå‡ºåº”ç”¨è¿›ç¨‹ï¼Œæ˜¯æ‰€æœ‰åº”ç”¨è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ã€‚Zygoteè¿›ç¨‹åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºDalivikè™šæ‹Ÿæœºã€é¢„è£…ç³»ç»Ÿçš„èµ„æºæ–‡ä»¶å’ŒJavaç±»ã€‚æ‰€æœ‰ä»Zygoteè¿›ç¨‹forkå‡ºçš„ç”¨æˆ·è¿›ç¨‹å°†ç»§æ‰¿å’Œå…±äº«è¿™äº›é¢„åŠ è½½çš„èµ„æºï¼Œä¸ç”¨æµªè´¹æ—¶é—´é‡æ–°åŠ è½½ï¼ŒåŠ å¿«äº†åº”ç”¨ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹ã€‚å¯åŠ¨ç»“æŸåï¼ŒZygoteè¿›ç¨‹ä¹Ÿå°†å˜æˆå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£å“åº”å’Œå¯åŠ¨APKåº”ç”¨ç¨‹åºçš„è¯·æ±‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/system/core/rootdir/init.zygote64.rc</span><br><span class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">main</span></span></span><br><span class="line"><span class="class"><span class="title">socket</span> <span class="title">zygote</span> <span class="title">stream</span> 660 <span class="title">root</span> <span class="title">system</span></span></span><br><span class="line"><span class="class"><span class="title">onrestart</span> <span class="title">write</span> /<span class="title">sys</span>/<span class="title">android_power</span>/<span class="title">request_state</span> <span class="title">wake</span></span></span><br><span class="line"><span class="class"><span class="title">onrestart</span> <span class="title">write</span> /<span class="title">sys</span>/<span class="title">power</span>/<span class="title">state</span> <span class="title">on</span></span></span><br><span class="line"><span class="class"><span class="title">onrestart</span> <span class="title">restart</span> <span class="title">audioserver</span></span></span><br><span class="line"><span class="class"><span class="title">onrestart</span> <span class="title">restart</span> <span class="title">cameraserver</span></span></span><br><span class="line"><span class="class"><span class="title">onrestart</span> <span class="title">restart</span> <span class="title">media</span></span></span><br><span class="line"><span class="class"><span class="title">onrestart</span> <span class="title">restart</span> <span class="title">netd</span></span></span><br><span class="line"><span class="class"><span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">foreground</span>/<span class="title">tasks</span></span></span><br></pre></td></tr></table></figure><h4 id="3-5ã€å¯åŠ¨SystemServer"><a href="#3-5ã€å¯åŠ¨SystemServer" class="headerlink" title="3.5ã€å¯åŠ¨SystemServer"></a>3.5ã€å¯åŠ¨SystemServer</h4><p>SystemServeræ˜¯Zygoteè¿›ç¨‹forkå‡ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œä¹Ÿæ˜¯æ•´ä¸ªAndroidç³»ç»Ÿçš„æ ¸å¿ƒè¿›ç¨‹ã€‚åœ¨SystemServerä¸­è¿è¡Œç€ç³»ç»Ÿå¤§éƒ¨åˆ†çš„BinderæœåŠ¡ï¼ŒSystemServeré¦–å…ˆå¯åŠ¨æœ¬åœ°æœåŠ¡SensorServiceï¼›æ¥ç€å¯åŠ¨ActivityManagerServiceã€WindowManagerServiceã€PackageManagerServiceåœ¨å†…çš„æ‰€æœ‰JavaæœåŠ¡ã€‚</p><p>Zygoteè¿›ç¨‹forkå‡ºSystem Serverè¿›ç¨‹ï¼ŒSystem Serveræ˜¯Zygoteå­µåŒ–çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œåœ°ä½éå¸¸é‡è¦ï¼› System Serverè¿›ç¨‹ï¼šè´Ÿè´£å¯åŠ¨å’Œç®¡ç†æ•´ä¸ªJava frameworkï¼ŒåŒ…å«ActivityManagerï¼ŒPowerManagerç­‰æœåŠ¡ã€‚ Media Serverè¿›ç¨‹ï¼šè´Ÿè´£å¯åŠ¨å’Œç®¡ç†æ•´ä¸ªC++ frameworkï¼ŒåŒ…å«AudioFlingerï¼ŒCamera Serviceç­‰æœåŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/java/com/android/server/SystemServer.java</span><br><span class="line">SystemServer().run()</span><br></pre></td></tr></table></figure><h4 id="3-6ã€å¯åŠ¨ActivityManagerService"><a href="#3-6ã€å¯åŠ¨ActivityManagerService" class="headerlink" title="3.6ã€å¯åŠ¨ActivityManagerService"></a>3.6ã€å¯åŠ¨ActivityManagerService</h4><h4 id="3-7ã€å¯åŠ¨Launcher-Activity"><a href="#3-7ã€å¯åŠ¨Launcher-Activity" class="headerlink" title="3.7ã€å¯åŠ¨Launcher(Activity)"></a>3.7ã€å¯åŠ¨Launcher(Activity)</h4><p>SystemServeråŠ è½½å®Œæ‰€æœ‰çš„JavaæœåŠ¡åï¼Œæœ€åä¼šè°ƒç”¨ActivityManagerServiceçš„SystemReady()æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œä¸­ï¼Œä¼šå‘å‡ºIntentâ€android.intent.category.HOMEâ€ã€‚å‡¡æ˜¯å“åº”è¿™ä¸ªIntentçš„APKéƒ½ä¼šè¿è¡Œèµ·æ¥ï¼ŒLauncheråº”ç”¨å°±æ˜¯Androidç³»ç»Ÿé»˜è®¤çš„æ¡Œé¢åº”ç”¨ï¼Œä¸€èˆ¬åªæœ‰å®ƒä¼šå“åº”è¿™ä¸ªIntentï¼Œå› æ­¤ï¼Œç³»ç»Ÿå¼€æœºåï¼Œç¬¬ä¸€ä¸ªè¿è¡Œçš„åº”ç”¨å°±æ˜¯Launcherã€‚ Zygoteè¿›ç¨‹å­µåŒ–å‡ºçš„ç¬¬ä¸€ä¸ªAppè¿›ç¨‹æ˜¯Launcherï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line">startHomeActivityLocked(mCurrentUserId, <span class="string">"systemReady"</span>);</span><br></pre></td></tr></table></figure><h3 id="å››ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹è¯¦ç»†åˆ†æ"><a href="#å››ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹è¯¦ç»†åˆ†æ" class="headerlink" title="å››ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹è¯¦ç»†åˆ†æ"></a>å››ã€è®¾å¤‡å¯åŠ¨è¿‡ç¨‹è¯¦ç»†åˆ†æ</h3><h3 id="ï¼ˆ1ï¼‰ã€å¯åŠ¨Initè¿›ç¨‹"><a href="#ï¼ˆ1ï¼‰ã€å¯åŠ¨Initè¿›ç¨‹" class="headerlink" title="ï¼ˆ1ï¼‰ã€å¯åŠ¨Initè¿›ç¨‹"></a>ï¼ˆ1ï¼‰ã€å¯åŠ¨Initè¿›ç¨‹</h3><p>æ¦‚è¿°ï¼š initæ˜¯Linuxç³»ç»Ÿä¸­ç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹å·ä¸º1ã€‚Kernelå¯åŠ¨åï¼Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œå¯åŠ¨initè¿›ç¨‹ï¼Œå¹¶è°ƒç”¨initä¸­çš„main()æ–¹æ³•æ‰§è¡Œinitè¿›ç¨‹çš„èŒè´£ã€‚å¯¹äºinitè¿›ç¨‹çš„åŠŸèƒ½åˆ†ä¸º4éƒ¨åˆ†ï¼š</p><p>åˆ†æå’Œè¿è¡Œæ‰€æœ‰çš„init.rcæ–‡ä»¶; ç”Ÿæˆè®¾å¤‡é©±åŠ¨èŠ‚ç‚¹; ï¼ˆé€šè¿‡rcæ–‡ä»¶åˆ›å»ºï¼‰ å¤„ç†å­è¿›ç¨‹çš„ç»ˆæ­¢(signalæ–¹å¼); æä¾›å±æ€§æœåŠ¡ã€‚ æ¥ä¸‹æ¥ä»main()æ–¹æ³•è¯´èµ·ã€‚</p><h4 id="4-1-1ã€main"><a href="#4-1-1ã€main" class="headerlink" title="4.1.1ã€main()"></a>4.1.1ã€main()</h4><p>[-&gt; init.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"ueventd"</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> ueventd_main(argc, argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"watchdogd"</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> watchdogd_main(argc, argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clear the umask.</span></span><br><span class="line"><span class="comment">//è®¾ç½®æ–‡ä»¶å±æ€§0777</span></span><br><span class="line">umask(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">add_environment(<span class="string">"PATH"</span>, _PATH_DEFPATH);</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> is_first_stage = (argc == <span class="number">1</span>) || (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--second-stage"</span>) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class="line"><span class="comment">// on / and then we'll let the rc file figure out the rest.</span></span><br><span class="line"><span class="comment">//åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">    mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>);</span><br><span class="line">    mkdir(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>);</span><br><span class="line">    mkdir(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>);</span><br><span class="line">    mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class="line">    mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="string">"hidepid=2,gid="</span> MAKE_STR(AID_READPROC));</span><br><span class="line">    mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We must have some place other than / to create the device nodes for</span></span><br><span class="line"><span class="comment">// kmsg and null, otherwise we won't be able to remount / read-only</span></span><br><span class="line"><span class="comment">// later on. Now that tmpfs is mounted on /dev, we can actually talk</span></span><br><span class="line"><span class="comment">// to the outside world.</span></span><br><span class="line"><span class="comment">//å±è”½æ ‡å‡†çš„è¾“å…¥è¾“å‡º</span></span><br><span class="line">open_devnull_stdio();</span><br><span class="line"> <span class="comment">//åˆå§‹åŒ–kernel logï¼Œä½äºè®¾å¤‡èŠ‚ç‚¹/dev/kmsg</span></span><br><span class="line">klog_init();</span><br><span class="line"> <span class="comment">//è®¾ç½®è¾“å‡ºçš„logçº§åˆ«</span></span><br><span class="line">klog_set_level(KLOG_NOTICE_LEVEL);</span><br><span class="line"> <span class="comment">// è¾“å‡ºinitå¯åŠ¨é˜¶æ®µçš„log</span></span><br><span class="line">NOTICE(<span class="string">"init %s started!\n"</span>, is_first_stage ? <span class="string">"first stage"</span> : <span class="string">"second stage"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_first_stage) &#123;</span><br><span class="line">    <span class="comment">// Indicate that booting is in progress to background fw loaders, etc.</span></span><br><span class="line">    close(open(<span class="string">"/dev/.booting"</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="number">0000</span>));</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€å—å…±äº«çš„å†…å­˜ç©ºé—´ï¼Œç”¨äºå±æ€§æœåŠ¡</span></span><br><span class="line">    property_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If arguments are passed both on the command line and in DT,</span></span><br><span class="line">    <span class="comment">// properties set in DT always have priority over the command-line ones.</span></span><br><span class="line">    process_kernel_dt();</span><br><span class="line">    process_kernel_cmdline();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Propagate the kernel variables to internal variables</span></span><br><span class="line">    <span class="comment">// used by init as well as the current required properties.</span></span><br><span class="line">    export_kernel_boot_props();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up SELinux, including loading the SELinux policy if we're in the kernel domain.</span></span><br><span class="line">selinux_initialize(is_first_stage);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we're in the kernel domain, re-exec init to transition to the init domain now</span></span><br><span class="line"><span class="comment">// that the SELinux policy has been loaded.</span></span><br><span class="line"><span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">    <span class="keyword">if</span> (restorecon(<span class="string">"/init"</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"restorecon failed: %s\n"</span>, strerror(errno));</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span>* path = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">char</span>* args[] = &#123; path, <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">"--second-stage"</span>), <span class="literal">nullptr</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (execv(path, args) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"execv(\"%s\") failed: %s\n"</span>, path, strerror(errno));</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These directories were necessarily created before initial policy load</span></span><br><span class="line"><span class="comment">// and therefore need their security context restored to the proper value.</span></span><br><span class="line"><span class="comment">// This must happen before /dev is populated by ueventd.</span></span><br><span class="line">NOTICE(<span class="string">"Running restorecon...\n"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev/socket"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev/__properties__"</span>);</span><br><span class="line">restorecon(<span class="string">"/property_contexts"</span>);</span><br><span class="line">restorecon_recursive(<span class="string">"/sys"</span>);</span><br><span class="line"></span><br><span class="line">epoll_fd = epoll_create1(EPOLL_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (epoll_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    ERROR(<span class="string">"epoll_create1 failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆå§‹åŒ–å­è¿›ç¨‹é€€å‡ºçš„ä¿¡å·å¤„ç†è¿‡ç¨‹</span></span><br><span class="line">signal_handler_init();</span><br><span class="line"></span><br><span class="line">property_load_boot_defaults();</span><br><span class="line">export_oem_lock_status();</span><br><span class="line">start_property_service();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> BuiltinFunctionMap function_map;</span><br><span class="line">Action::set_function_map(&amp;function_map);</span><br><span class="line"></span><br><span class="line">Parser&amp; parser = Parser::GetInstance();</span><br><span class="line">parser.AddSectionParser(<span class="string">"service"</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</span><br><span class="line">parser.AddSectionParser(<span class="string">"on"</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</span><br><span class="line">parser.AddSectionParser(<span class="string">"import"</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</span><br><span class="line">parser.ParseConfig(<span class="string">"/init.rc"</span>);</span><br><span class="line"></span><br><span class="line">ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class="line"></span><br><span class="line">am.QueueEventTrigger(<span class="string">"early-init"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class="line">am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class="string">"wait_for_coldboot_done"</span>);</span><br><span class="line"><span class="comment">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class="line">am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</span><br><span class="line">am.QueueBuiltinAction(set_mmap_rnd_bits_action, <span class="string">"set_mmap_rnd_bits"</span>);</span><br><span class="line">am.QueueBuiltinAction(keychord_init_action, <span class="string">"keychord_init"</span>);</span><br><span class="line">am.QueueBuiltinAction(console_init_action, <span class="string">"console_init"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trigger all the boot actions to get us started.</span></span><br><span class="line">am.QueueEventTrigger(<span class="string">"init"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class="line"><span class="comment">// wasn't ready immediately after wait_for_coldboot_done</span></span><br><span class="line">am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Don't mount filesystems or start core system services in charger mode.</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> bootmode = property_get(<span class="string">"ro.bootmode"</span>);</span><br><span class="line"><span class="keyword">if</span> (bootmode == <span class="string">"charger"</span>) &#123;</span><br><span class="line">    am.QueueEventTrigger(<span class="string">"charger"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    am.QueueEventTrigger(<span class="string">"late-init"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run all property triggers based on current state of the properties.</span></span><br><span class="line">am.QueueBuiltinAction(queue_property_triggers_action, <span class="string">"queue_property_triggers"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!waiting_for_exec) &#123;</span><br><span class="line">        am.ExecuteOneCommand();</span><br><span class="line">        restart_processes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> timeout = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (process_needs_restart) &#123;</span><br><span class="line">        timeout = (process_needs_restart - gettime()) * <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">            timeout = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (am.HasMoreCommands()) &#123;</span><br><span class="line">        timeout = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bootchart_sample(&amp;timeout);</span><br><span class="line"></span><br><span class="line">    epoll_event ev;</span><br><span class="line">    <span class="keyword">int</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;ev, <span class="number">1</span>, timeout));</span><br><span class="line">    <span class="keyword">if</span> (nr == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"epoll_wait failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr == <span class="number">1</span>) &#123;</span><br><span class="line">        ((<span class="keyword">void</span> (*)()) ev.data.ptr)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-2ã€åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#4-1-2ã€åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="4.1.2ã€åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ"></a>4.1.2ã€åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ</h4><p>æ­¤æ—¶androidçš„logç³»ç»Ÿè¿˜æ²¡æœ‰å¯åŠ¨ï¼Œé‡‡ç”¨kernelçš„logç³»ç»Ÿï¼Œæ‰“å¼€çš„è®¾å¤‡èŠ‚ç‚¹/dev/kmsgï¼Œ é‚£ä¹ˆå¯é€šè¿‡cat /dev/kmsgæ¥è·å–å†…æ ¸logã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè®¾ç½®logçš„è¾“å‡ºçº§åˆ«ä¸ºKLOG_NOTICE_LEVEL(5)ï¼Œå½“logçº§åˆ«å°äº5æ—¶åˆ™ä¼šè¾“å‡ºåˆ°kernel logï¼Œ é»˜è®¤å€¼ä¸º3.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">add_environment(<span class="string">"PATH"</span>, _PATH_DEFPATH);</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> is_first_stage = (argc == <span class="number">1</span>) || (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--second-stage"</span>) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class="line"><span class="comment">// on / and then we'll let the rc file figure out the rest.</span></span><br><span class="line"><span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">    mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>);</span><br><span class="line">    mkdir(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>);</span><br><span class="line">    mkdir(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>);</span><br><span class="line">    mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class="line">    mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="string">"hidepid=2,gid="</span> MAKE_STR(AID_READPROC));</span><br><span class="line">    mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥éƒ¨åˆ†ä¸»è¦ç”¨äºåˆ›å»ºå’ŒæŒ‚è½½å¯åŠ¨æ‰€éœ€çš„æ–‡ä»¶ç›®å½•ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ç¼–è¯‘Androidç³»ç»Ÿæºç æ—¶ï¼Œåœ¨ç”Ÿæˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¹¶ä¸å­˜åœ¨è¿™äº›ç›®å½•ï¼Œå®ƒä»¬æ˜¯ç³»ç»Ÿè¿è¡Œæ—¶çš„ç›®å½•ï¼Œå³å½“ç³»ç»Ÿç»ˆæ­¢æ—¶ï¼Œå°±ä¼šæ¶ˆå¤±ã€‚</p><p>åœ¨initåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼ŒAndroidåˆ†åˆ«æŒ‚è½½äº†tmpfsï¼Œdevptsï¼Œprocï¼Œsysfsè¿™4ç±»æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>tmpfsæ˜¯ä¸€ç§è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä¼šå°†æ‰€æœ‰çš„æ–‡ä»¶å­˜å‚¨åœ¨è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå¦‚æœä½ å°†tmpfsæ–‡ä»¶ç³»ç»Ÿå¸è½½åï¼Œé‚£ä¹ˆå…¶ä¸‹çš„æ‰€æœ‰çš„å†…å®¹å°†ä¸å¤å­˜åœ¨ã€‚ tmpfsæ—¢å¯ä»¥ä½¿ç”¨RAMï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äº¤æ¢åˆ†åŒºï¼Œä¼šæ ¹æ®ä½ çš„å®é™…éœ€è¦è€Œæ”¹å˜å¤§å°ã€‚tmpfsçš„é€Ÿåº¦éå¸¸æƒŠäººï¼Œæ¯•ç«Ÿå®ƒæ˜¯é©»ç•™åœ¨RAMä¸­çš„ï¼Œå³ä½¿ç”¨äº†äº¤æ¢åˆ†åŒºï¼Œæ€§èƒ½ä»ç„¶éå¸¸å“è¶Šã€‚ ç”±äºtmpfsæ˜¯é©»ç•™åœ¨RAMçš„ï¼Œå› æ­¤å®ƒçš„å†…å®¹æ˜¯ä¸æŒä¹…çš„ã€‚æ–­ç”µåï¼Œtmpfsçš„å†…å®¹å°±æ¶ˆå¤±äº†ï¼Œè¿™ä¹Ÿæ˜¯è¢«ç§°ä½œtmpfsçš„æ ¹æœ¬åŸå› ã€‚</p><p>devptsæ–‡ä»¶ç³»ç»Ÿä¸ºä¼ªç»ˆç«¯æä¾›äº†ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œå®ƒçš„æ ‡å‡†æŒ‚æ¥ç‚¹æ˜¯/dev/ ptsã€‚åªè¦ptyçš„ä¸»å¤åˆè®¾å¤‡/dev/ptmxè¢«æ‰“å¼€ï¼Œå°±ä¼šåœ¨/dev/ptsä¸‹åŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªæ–°çš„ptyè®¾å¤‡æ–‡ä»¶ã€‚</p><p>procæ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå¯ä»¥çœ‹ä½œæ˜¯å†…æ ¸å†…éƒ¨æ•°æ®ç»“æ„çš„æ¥å£ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥è·å¾—ç³»ç»Ÿçš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶ä¿®æ”¹ç‰¹å®šçš„å†…æ ¸å‚æ•°ã€‚</p><p>ä¸procæ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œsysfsæ–‡ä»¶ç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªä¸å æœ‰ä»»ä½•ç£ç›˜ç©ºé—´çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚å®ƒé€šå¸¸è¢«æŒ‚æ¥åœ¨/sysç›®å½•ä¸‹ã€‚sysfsæ–‡ä»¶ç³»ç»Ÿæ˜¯Linux2.6å†…æ ¸å¼•å…¥çš„ï¼Œå®ƒæŠŠè¿æ¥åœ¨ç³»ç»Ÿä¸Šçš„è®¾å¤‡å’Œæ€»çº¿ç»„ç»‡æˆä¸ºä¸€ä¸ªåˆ†çº§çš„æ–‡ä»¶ï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´å­˜å–ã€‚</p><h4 id="4-1-4ã€å±è”½æ ‡å‡†çš„è¾“å…¥è¾“å‡º"><a href="#4-1-4ã€å±è”½æ ‡å‡†çš„è¾“å…¥è¾“å‡º" class="headerlink" title="4.1.4ã€å±è”½æ ‡å‡†çš„è¾“å…¥è¾“å‡º"></a>4.1.4ã€å±è”½æ ‡å‡†çš„è¾“å…¥è¾“å‡º</h4><p>[-&gt; init.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">open_devnull_stdio</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// Try to avoid the mknod() call if we can. Since SELinux makes</span></span><br><span class="line"><span class="comment">// a /dev/null replacement available for free, let's use it.</span></span><br><span class="line"><span class="keyword">int</span> fd = open(<span class="string">"/sys/fs/selinux/null"</span>, O_RDWR);</span><br><span class="line"><span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">// OOPS, /sys/fs/selinux/null isn't available, likely because</span></span><br><span class="line">    <span class="comment">// /sys/fs/selinux isn't mounted. Fall back to mknod.</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *name = <span class="string">"/dev/__null__"</span>;</span><br><span class="line">    <span class="keyword">if</span> (mknod(name, S_IFCHR | <span class="number">0600</span>, (<span class="number">1</span> &lt;&lt; <span class="number">8</span>) | <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        fd = open(name, O_RDWR);</span><br><span class="line">        unlink(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dup2(fd, <span class="number">0</span>);</span><br><span class="line">dup2(fd, <span class="number">1</span>);</span><br><span class="line">dup2(fd, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">if</span> (fd &gt; <span class="number">2</span>) &#123;</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰æ–‡ç”Ÿæˆ/devç›®å½•åï¼Œinitè¿›ç¨‹å°†è°ƒç”¨open_devnull_stdioå‡½æ•°ï¼Œå±è”½æ ‡å‡†çš„è¾“å…¥è¾“å‡ºã€‚ open_devnull_stdioå‡½æ•°ä¼šåœ¨/devç›®å½•ä¸‹ç”Ÿæˆ<strong>null</strong>è®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶ï¼Œå¹¶å°†æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯è¾“å‡ºå…¨éƒ¨é‡å®šå‘åˆ°<strong>null</strong>è®¾å¤‡ä¸­ã€‚ open_devnull_stdioå‡½æ•°å®šä¹‰äºsystem/core/init/util.cppä¸­ã€‚</p><p>è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œdup2å‡½æ•°çš„ä½œç”¨æ˜¯ç”¨æ¥å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶çš„æè¿°ç¬¦ï¼Œé€šå¸¸ç”¨æ¥é‡å®šå‘è¿›ç¨‹çš„stdinã€stdoutå’Œstderrã€‚å®ƒçš„å‡½æ•°åŸå½¢æ˜¯ï¼š</p><p>int dup2(int oldfd, int targetfd)</p><p>è¯¥å‡½æ•°æ‰§è¡Œåï¼Œtargetfdå°†å˜æˆoldfdçš„å¤åˆ¶å“ã€‚</p><p>å› æ­¤ä¸Šè¿°è¿‡ç¨‹å…¶å®å°±æ˜¯ï¼šåˆ›å»ºå‡º<strong>null</strong>è®¾å¤‡åï¼Œå°†0ã€1ã€2ç»‘å®šåˆ°<strong>null</strong>è®¾å¤‡ä¸Šã€‚å› æ­¤initè¿›ç¨‹è°ƒç”¨open_devnull_stdioå‡½æ•°åï¼Œé€šè¿‡æ ‡å‡†çš„è¾“å…¥è¾“å‡ºæ— æ³•è¾“å‡ºä¿¡æ¯ã€‚</p><h4 id="4-1-5ã€åˆå§‹åŒ–å†…æ ¸logç³»ç»Ÿ"><a href="#4-1-5ã€åˆå§‹åŒ–å†…æ ¸logç³»ç»Ÿ" class="headerlink" title="4.1.5ã€åˆå§‹åŒ–å†…æ ¸logç³»ç»Ÿ"></a>4.1.5ã€åˆå§‹åŒ–å†…æ ¸logç³»ç»Ÿ</h4><p>æˆ‘ä»¬ç»§ç»­å›åˆ°initè¿›ç¨‹çš„mainå‡½æ•°ï¼Œinitè¿›ç¨‹é€šè¿‡klog_initå‡½æ•°ï¼Œæä¾›è¾“å‡ºlogä¿¡æ¯çš„è®¾å¤‡ã€‚ [-&gt; init.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">klog_init();</span><br><span class="line">klog_set_level(KLOG_NOTICE_LEVEL);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">klog_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (klog_fd &gt;= <span class="number">0</span>) <span class="keyword">return</span>; <span class="comment">/* Already initialized */</span></span><br><span class="line"></span><br><span class="line">klog_fd = open(<span class="string">"/dev/kmsg"</span>, O_WRONLY | O_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (klog_fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* name = <span class="string">"/dev/__kmsg__"</span>;</span><br><span class="line"><span class="keyword">if</span> (mknod(name, S_IFCHR | <span class="number">0600</span>, (<span class="number">1</span> &lt;&lt; <span class="number">8</span>) | <span class="number">11</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    klog_fd = open(name, O_WRONLY | O_CLOEXEC);</span><br><span class="line">    unlink(name);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>klog_initå‡½æ•°å®šä¹‰äºsystem/core/libcutils/klog.cä¸­ã€‚é€šè¿‡klog_initå‡½æ•°ï¼Œinitè¿›ç¨‹ç”Ÿæˆkmsgè®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶ã€‚è¯¥è®¾å¤‡å¯ä»¥è°ƒç”¨å†…æ ¸ä¿¡æ¯è¾“å‡ºå‡½æ•°printkï¼Œä»¥è¾“å‡ºlogä¿¡æ¯ã€‚</p><h4 id="4-1-6ã€åˆå§‹åŒ–å±æ€§åŸŸ"><a href="#4-1-6ã€åˆå§‹åŒ–å±æ€§åŸŸ" class="headerlink" title="4.1.6ã€åˆå§‹åŒ–å±æ€§åŸŸ"></a>4.1.6ã€åˆå§‹åŒ–å±æ€§åŸŸ</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!is_first_stage) &#123;</span><br><span class="line">.......</span><br><span class="line">property_init();</span><br><span class="line">.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨property_initåˆå§‹åŒ–å±æ€§åŸŸã€‚åœ¨Androidå¹³å°ä¸­ï¼Œä¸ºäº†è®©è¿è¡Œä¸­çš„æ‰€æœ‰è¿›ç¨‹å…±äº«ç³»ç»Ÿè¿è¡Œæ—¶æ‰€éœ€è¦çš„å„ç§è®¾ç½®å€¼ï¼Œç³»ç»Ÿå¼€è¾Ÿäº†å±æ€§å­˜å‚¨åŒºåŸŸï¼Œå¹¶æä¾›äº†è®¿é—®è¯¥åŒºåŸŸçš„APIã€‚</p><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨initè¿›ç¨‹ä¸­æœ‰éƒ¨åˆ†ä»£ç å—ä»¥is_first_stageæ ‡å¿—è¿›è¡ŒåŒºåˆ†ï¼Œå†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œåˆå§‹åŒ–ã€‚ is_first_stageçš„å€¼ï¼Œç”±initè¿›ç¨‹mainå‡½æ•°çš„å…¥å£å‚æ•°å†³å®šï¼Œä¹‹å‰ä¸å¤ªæ˜ç™½å…·ä½“çš„å«ä¹‰ã€‚ åæ¥å†™åšå®¢åï¼Œæœ‰æœ‹å‹ç•™è¨€ï¼Œåœ¨å¼•å…¥selinuxæœºåˆ¶åï¼Œæœ‰äº›æ“ä½œå¿…é¡»è¦åœ¨å†…æ ¸æ€æ‰èƒ½å®Œæˆï¼› ä½†initè¿›ç¨‹ä½œä¸ºandroidçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œåˆæ˜¯è¿è¡Œåœ¨ç”¨æˆ·æ€çš„ã€‚ äºæ˜¯ï¼Œæœ€ç»ˆè®¾è®¡ä¸ºç”¨is_first_stageè¿›è¡ŒåŒºåˆ†initè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚initè¿›ç¨‹åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šå®Œæˆä»å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„åˆ‡æ¢ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">property_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (__system_property_area_init()) &#123;</span><br><span class="line">    ERROR(<span class="string">"Failed to initialize property area\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>property_initå‡½æ•°å®šä¹‰äºsystem/core/init/property_service.cppä¸­ï¼Œå¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œæœ€ç»ˆè°ƒç”¨_system_property_area_initå‡½æ•°åˆå§‹åŒ–å±æ€§åŸŸã€‚</p><h4 id="4-1-7ã€å®ŒæˆSELinuxç›¸å…³å·¥ä½œ"><a href="#4-1-7ã€å®ŒæˆSELinuxç›¸å…³å·¥ä½œ" class="headerlink" title="4.1.7ã€å®ŒæˆSELinuxç›¸å…³å·¥ä½œ"></a>4.1.7ã€å®ŒæˆSELinuxç›¸å…³å·¥ä½œ</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set up SELinux, including loading the SELinux policy if we're in the kernel domain.</span></span><br><span class="line">selinux_initialize(is_first_stage);</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">selinux_initialize</span><span class="params">(<span class="keyword">bool</span> in_kernel_domain)</span> </span>&#123;</span><br><span class="line">Timer t;</span><br><span class="line"></span><br><span class="line">selinux_callback cb;</span><br><span class="line"><span class="comment">//ç”¨äºæ‰“å°logçš„å›è°ƒå‡½æ•°</span></span><br><span class="line">cb.func_log = selinux_klog_callback;</span><br><span class="line">selinux_set_callback(SELINUX_CB_LOG, cb);</span><br><span class="line"><span class="comment">//ç”¨äºæ£€æŸ¥æƒé™çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">cb.func_audit = audit_callback;</span><br><span class="line">selinux_set_callback(SELINUX_CB_AUDIT, cb);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (in_kernel_domain) &#123;</span><br><span class="line">   <span class="comment">//å†…æ ¸æ€å¤„ç†æµç¨‹</span></span><br><span class="line">    INFO(<span class="string">"Loading SELinux policy...\n"</span>);</span><br><span class="line">    <span class="comment">//ç”¨äºåŠ è½½sepolicyæ–‡ä»¶ã€‚è¯¥å‡½æ•°æœ€ç»ˆå°†sepolicyæ–‡ä»¶ä¼ é€’ç»™kernelï¼Œè¿™æ ·kernelå°±æœ‰äº†å®‰å…¨ç­–ç•¥é…ç½®æ–‡ä»¶ï¼Œåç»­çš„MACæ‰èƒ½å¼€å±•èµ·æ¥ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (selinux_android_load_policy() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"failed to load policy: %s\n"</span>, strerror(errno));</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å†…æ ¸ä¸­è¯»å–çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">bool</span> kernel_enforcing = (security_getenforce() == <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//å‘½ä»¤è¡Œä¸­å¾—åˆ°çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">bool</span> is_enforcing = selinux_is_enforcing();</span><br><span class="line">    <span class="keyword">if</span> (kernel_enforcing != is_enforcing) &#123;</span><br><span class="line">        <span class="comment">//ç”¨äºè®¾ç½®selinuxçš„å·¥ä½œæ¨¡å¼ã€‚selinuxæœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š</span></span><br><span class="line">        <span class="comment">//1ã€â€permissiveâ€ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½è¢«å…è®¸ï¼ˆå³æ²¡æœ‰MACï¼‰ï¼Œä½†æ˜¯å¦‚æœè¿åæƒé™çš„è¯ï¼Œä¼šè®°å½•æ—¥å¿—</span></span><br><span class="line">        <span class="comment">//2ã€â€enforcingâ€ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¼šè¿›è¡Œæƒé™æ£€æŸ¥ã€‚åœ¨ä¸€èˆ¬çš„ç»ˆç«¯ä¸­ï¼Œåº”è¯¥å·¥ä½œäºenforingæ¨¡å¼</span></span><br><span class="line">        <span class="keyword">if</span> (security_setenforce(is_enforcing)) &#123;</span><br><span class="line">            ERROR(<span class="string">"security_setenforce(%s) failed: %s\n"</span>,</span><br><span class="line">                  is_enforcing ? <span class="string">"true"</span> : <span class="string">"false"</span>, strerror(errno));</span><br><span class="line">            <span class="comment">//å°†é‡å¯è¿›å…¥recovery mode</span></span><br><span class="line">            security_failure();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (write_file(<span class="string">"/sys/fs/selinux/checkreqprot"</span>, <span class="string">"0"</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NOTICE(<span class="string">"(Initializing SELinux %s took %.2fs.)\n"</span>,</span><br><span class="line">           is_enforcing ? <span class="string">"enforcing"</span> : <span class="string">"non-enforcing"</span>, t.duration());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    selinux_init_all_handles();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initè¿›ç¨‹è¿›ç¨‹è°ƒç”¨selinux_initializeå¯åŠ¨SELinuxã€‚ä»æ³¨é‡Šæ¥çœ‹ï¼Œinitè¿›ç¨‹çš„è¿è¡Œç¡®å®æ˜¯åŒºåˆ†ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ã€‚</p><h4 id="4-1-8ã€é‡æ–°è®¾ç½®å±æ€§"><a href="#4-1-8ã€é‡æ–°è®¾ç½®å±æ€§" class="headerlink" title="4.1.8ã€é‡æ–°è®¾ç½®å±æ€§"></a>4.1.8ã€é‡æ–°è®¾ç½®å±æ€§</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If we're in the kernel domain, re-exec init to transition to the init domain now</span></span><br><span class="line"><span class="comment">// that the SELinux policy has been loaded.</span></span><br><span class="line"><span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line"><span class="comment">//æŒ‰selinux policyè¦æ±‚ï¼Œé‡æ–°è®¾ç½®initæ–‡ä»¶å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (restorecon(<span class="string">"/init"</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"restorecon failed: %s\n"</span>, strerror(errno));</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span>* path = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">char</span>* args[] = &#123; path, <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">"--second-stage"</span>), <span class="literal">nullptr</span> &#125;;</span><br><span class="line">    <span class="comment">//è¿™é‡Œå°±æ˜¯å‰é¢æ‰€è¯´çš„ï¼Œå¯åŠ¨ç”¨æˆ·æ€çš„initè¿›ç¨‹ï¼Œå³second-stage</span></span><br><span class="line">    <span class="keyword">if</span> (execv(path, args) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"execv(\"%s\") failed: %s\n"</span>, path, strerror(errno));</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These directories were necessarily created before initial policy load</span></span><br><span class="line"><span class="comment">// and therefore need their security context restored to the proper value.</span></span><br><span class="line"><span class="comment">// This must happen before /dev is populated by ueventd.</span></span><br><span class="line">NOTICE(<span class="string">"Running restorecon...\n"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev/socket"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev/__properties__"</span>);</span><br><span class="line">restorecon(<span class="string">"/property_contexts"</span>);</span><br><span class="line">restorecon_recursive(<span class="string">"/sys"</span>);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ–‡ä»¶èŠ‚ç‚¹åœ¨åŠ è½½Sepolicyä¹‹å‰å·²ç»è¢«åˆ›å»ºäº†ï¼Œå› æ­¤åœ¨åŠ è½½å®ŒSepolicyåï¼Œéœ€è¦é‡æ–°è®¾ç½®ç›¸å…³çš„å±æ€§ã€‚</p><h4 id="4-1-9ã€åˆ›å»ºepollå¥æŸ„"><a href="#4-1-9ã€åˆ›å»ºepollå¥æŸ„" class="headerlink" title="4.1.9ã€åˆ›å»ºepollå¥æŸ„"></a>4.1.9ã€åˆ›å»ºepollå¥æŸ„</h4><p>å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼Œinitè¿›ç¨‹è°ƒç”¨epoll_create1åˆ›å»ºepollå¥æŸ„ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">epoll_fd = epoll_create1(EPOLL_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (epoll_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    ERROR(<span class="string">"epoll_create1 failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨linuxçš„ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå¾ˆé•¿çš„æ—¶é—´éƒ½åœ¨ä½¿ç”¨selectæ¥åšäº‹ä»¶è§¦å‘ã€‚åœ¨linuxæ–°çš„å†…æ ¸ä¸­ï¼Œæœ‰äº†ä¸€ç§æ›¿æ¢å®ƒçš„æœºåˆ¶ï¼Œå°±æ˜¯epollã€‚ç›¸æ¯”äºselectï¼Œepollæœ€å¤§çš„å¥½å¤„åœ¨äºå®ƒä¸ä¼šéšç€ç›‘å¬fdæ•°ç›®çš„å¢é•¿è€Œé™ä½æ•ˆç‡ã€‚å› ä¸ºåœ¨å†…æ ¸ä¸­çš„selectå®ç°ä¸­ï¼Œå®ƒæ˜¯é‡‡ç”¨è½®è¯¢æ¥å¤„ç†çš„ï¼Œè½®è¯¢çš„fdæ•°ç›®è¶Šå¤šï¼Œè‡ªç„¶è€—æ—¶è¶Šå¤šã€‚</p><p>epollæœºåˆ¶ä¸€èˆ¬ä½¿ç”¨epoll_create(int size)å‡½æ•°åˆ›å»ºepollå¥æŸ„ï¼Œsizeç”¨æ¥å‘Šè¯‰å†…æ ¸è¿™ä¸ªå¥æŸ„å¯ç›‘å¬çš„fdçš„æ•°ç›®ã€‚æ³¨æ„è¿™ä¸ªå‚æ•°ä¸åŒäºselect()ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œåœ¨selectä¸­éœ€ç»™å‡ºæœ€å¤§ç›‘å¬æ•°åŠ 1çš„å€¼ã€‚ æ­¤å¤–ï¼Œå½“åˆ›å»ºå¥½epollå¥æŸ„åï¼Œå®ƒå°±ä¼šå ç”¨ä¸€ä¸ªfdå€¼ï¼Œåœ¨linuxä¸‹å¦‚æœæŸ¥çœ‹/proc/è¿›ç¨‹id/fd/ï¼Œèƒ½å¤Ÿçœ‹åˆ°åˆ›å»ºå‡ºçš„fdï¼Œå› æ­¤åœ¨ä½¿ç”¨å®Œepollåï¼Œå¿…é¡»è°ƒç”¨close()å…³é—­ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´fdè¢«è€—å°½ã€‚ ä¸Šè¿°ä»£ç ä½¿ç”¨çš„epoll_create1(EPOLLCLOEXEC)æ¥åˆ›å»ºepollå¥æŸ„ï¼Œè¯¥æ ‡å¿—ä½è¡¨ç¤ºç”Ÿæˆçš„epoll fdå…·æœ‰â€æ‰§è¡Œåå…³é—­â€ç‰¹æ€§ã€‚</p><h4 id="4-1-10ã€è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨"><a href="#4-1-10ã€è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨" class="headerlink" title="4.1.10ã€è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨"></a>4.1.10ã€è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signal_handler_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// Create a signalling mechanism for SIGCHLD.</span></span><br><span class="line"><span class="keyword">int</span> s[<span class="number">2</span>];</span><br><span class="line"><span class="comment">//åˆ©ç”¨socketpairåˆ›å»ºå‡ºå·²ç»è¿æ¥çš„ä¸¤ä¸ªsocketï¼Œåˆ†åˆ«ä½œä¸ºä¿¡å·çš„è¯»ã€å†™ç«¯</span></span><br><span class="line"><span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, <span class="number">0</span>, s) == <span class="number">-1</span>) &#123;</span><br><span class="line">    ERROR(<span class="string">"socketpair failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signal_write_fd = s[<span class="number">0</span>];</span><br><span class="line">signal_read_fd = s[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write to signal_write_fd if we catch SIGCHLD.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;act, <span class="number">0</span>, <span class="keyword">sizeof</span>(act));</span><br><span class="line"><span class="comment">//ä¿¡å·å¤„ç†å™¨ä¸ºSIGCHLD_handlerï¼Œå…¶è¢«å­˜åœ¨sigactionç»“æ„ä½“ä¸­ï¼Œè´Ÿè´£å¤„ç†SIGCHLDæ¶ˆæ¯</span></span><br><span class="line">act.sa_handler = SIGCHLD_handler;</span><br><span class="line">act.sa_flags = SA_NOCLDSTOP;</span><br><span class="line"><span class="comment">//è°ƒç”¨ä¿¡å·å®‰è£…å‡½æ•°sigactionï¼Œå°†ç›‘å¬çš„ä¿¡å·åŠå¯¹åº”çš„ä¿¡å·å¤„ç†å™¨æ³¨å†Œåˆ°å†…æ ¸ä¸­</span></span><br><span class="line">sigaction(SIGCHLD, &amp;act, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//ç›¸å¯¹äº6.0çš„ä»£ç ï¼Œè¿›ä¸€æ­¥ä½œäº†å°è£…ï¼Œç”¨äºç»ˆæ­¢å‡ºç°é—®é¢˜çš„å­è¿›ç¨‹ï¼Œè¯¦ç»†ä»£ç äºåæ–‡åˆ†æã€‚</span></span><br><span class="line">ServiceManager::GetInstance().ReapAnyOutstandingChildren();</span><br><span class="line"></span><br><span class="line">register_epoll_handler(signal_read_fd, handle_signal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Linuxè¿›ç¨‹é€šè¿‡äº’ç›¸å‘é€æ¥æ”¶æ¶ˆæ¯æ¥å®ç°è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œè¿™äº›æ¶ˆæ¯è¢«ç§°ä¸ºâ€ä¿¡å·â€ã€‚æ¯ä¸ªè¿›ç¨‹åœ¨å¤„ç†å…¶å®ƒè¿›ç¨‹å‘é€çš„ä¿¡å·æ—¶éƒ½è¦æ³¨å†Œå¤„ç†è€…ï¼Œå¤„ç†è€…è¢«ç§°ä¸ºä¿¡å·å¤„ç†å™¨ã€‚</p><p>æ³¨æ„åˆ°sigactionç»“æ„ä½“çš„sa_flagsä¸ºSA_NOCLDSTOPã€‚ç”±äºç³»ç»Ÿé»˜è®¤åœ¨å­è¿›ç¨‹æš‚åœæ—¶ä¹Ÿä¼šå‘é€ä¿¡å·SIGCHLDï¼Œinitéœ€è¦å¿½ç•¥å­è¿›ç¨‹åœ¨æš‚åœæ—¶å‘å‡ºçš„SIGCHLDä¿¡å·ï¼Œå› æ­¤å°†act.sa_flags ç½®ä¸ºSA_NOCLDSTOPï¼Œè¯¥æ ‡å¿—ä½è¡¨ç¤ºä»…å½“è¿›ç¨‹ç»ˆæ­¢æ—¶æ‰æ¥å—SIGCHLDä¿¡å·ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹SIGCHLD_handlerçš„å…·ä½“å·¥ä½œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SIGCHLD_handler</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (TEMP_FAILURE_RETRY(write(signal_write_fd, <span class="string">"1"</span>, <span class="number">1</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">    ERROR(<span class="string">"write(signal_write_fd) failed: %s\n"</span>, strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢ä»£ç æˆ‘ä»¬çŸ¥é“ï¼Œinitè¿›ç¨‹æ˜¯æ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œå½“å…¶å­è¿›ç¨‹ç»ˆæ­¢äº§ç”ŸSIGCHLDä¿¡å·æ—¶ï¼ŒSIGCHLD_handlerå¯¹signal_write_fdæ‰§è¡Œå†™æ“ä½œã€‚ç”±äºsocketpairçš„ç»‘å®šå…³ç³»ï¼Œè¿™å°†è§¦å‘ä¿¡å·å¯¹åº”çš„signal_read_fdæ”¶åˆ°æ•°æ®ã€‚</p><p>åœ¨è£…è½½ä¿¡å·ç›‘å¬å™¨çš„æœ€åï¼Œsignal_handler_initè°ƒç”¨register_epoll_handlerï¼Œå…¶ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œä¼ å…¥å‚æ•°åˆ†åˆ«ä¸ºsignal_read_fdå’Œhandle_signalã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void register_epoll_handler(int fd, void (*fn)()) &#123;</span><br><span class="line">epoll_event ev;</span><br><span class="line">ev.events = EPOLLIN;</span><br><span class="line">ev.data.ptr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(fn);</span><br><span class="line"><span class="comment">//epoll_fdå¢åŠ ä¸€ä¸ªç›‘å¬å¯¹è±¡fd,fdä¸Šæœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œè°ƒç”¨fnå¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> (epoll_ctl(epoll_fd, EPOLL_CTL_ADD, fd, &amp;ev) == <span class="number">-1</span>) &#123;</span><br><span class="line">    ERROR(<span class="string">"epoll_ctl failed: %s\n"</span>, strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“ï¼šå½“epollå¥æŸ„ç›‘å¬åˆ°signal_read_fdä¸­æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œå°†è°ƒç”¨handle_signalè¿›è¡Œå¤„ç†ã€‚</p><p>è‡³æ­¤ï¼Œç»“åˆä¸Šæ–‡æˆ‘ä»¬çŸ¥é“ï¼šå½“initè¿›ç¨‹è°ƒç”¨signal_handler_initåï¼Œä¸€æ—¦æ”¶åˆ°å­è¿›ç¨‹ç»ˆæ­¢å¸¦æ¥çš„SIGCHLDæ¶ˆæ¯åï¼Œå°†åˆ©ç”¨ä¿¡å·å¤„ç†è€…SIGCHLD_handlerå‘signal_write_fdå†™å…¥ä¿¡æ¯ï¼› epollå¥æŸ„ç›‘å¬åˆ°signal_read_fdæ”¶æ¶ˆæ¯åï¼Œå°†è°ƒç”¨handle_signalè¿›è¡Œå¤„ç†ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N05-android-system-start-signal_handler.jpg" alt="Markdown"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// Clear outstanding requests.</span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">read(signal_read_fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">ServiceManager::GetInstance().ReapAnyOutstandingChildren();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œhandle_signalåªæ˜¯æ¸…ç©ºsignal_read_fdä¸­çš„æ•°æ®ï¼Œç„¶åè°ƒç”¨ServiceManager::GetInstance().ReapAnyOutstandingChildren()ã€‚</p><p>ServiceManagerå®šä¹‰äºsystem/core/init/service.cppä¸­ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">............</span><br><span class="line"><span class="comment">//C++ä¸­é»˜è®¤æ˜¯privateå±æ€§</span></span><br><span class="line">ServiceManager::ServiceManager() &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ServiceManager&amp; ServiceManager::GetInstance() &#123;</span><br><span class="line"><span class="keyword">static</span> ServiceManager instance;</span><br><span class="line"><span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> ServiceManager::ReapAnyOutstandingChildren() &#123;</span><br><span class="line"><span class="keyword">while</span> (ReapOneProcess()) &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">............</span><br></pre></td></tr></table></figure><p>ReapAnyOutstandingChildrenå‡½æ•°å®é™…ä¸Šè°ƒç”¨äº†ReapOneProcessã€‚ æˆ‘ä»¬ç»“åˆä»£ç ï¼Œçœ‹çœ‹ReapOneProcessçš„å…·ä½“å·¥ä½œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ServiceManager::ReapOneProcess() &#123;</span><br><span class="line"><span class="keyword">int</span> status;</span><br><span class="line"><span class="comment">//ç”¨waitpidå‡½æ•°è·å–çŠ¶æ€å‘ç”Ÿå˜åŒ–çš„å­è¿›ç¨‹pid</span></span><br><span class="line"><span class="comment">//waitpidçš„æ ‡è®°ä¸ºWNOHANGï¼Œå³éé˜»å¡ï¼Œè¿”å›ä¸ºæ­£å€¼å°±è¯´æ˜æœ‰è¿›ç¨‹æŒ‚æ‰äº†</span></span><br><span class="line"><span class="keyword">pid_t</span> pid = TEMP_FAILURE_RETRY(waitpid(<span class="number">-1</span>, &amp;status, WNOHANG));</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">    ERROR(<span class="string">"waitpid failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ©ç”¨FindServiceByPidå‡½æ•°ï¼Œæ‰¾åˆ°pidå¯¹åº”çš„æœåŠ¡ã€‚</span></span><br><span class="line"><span class="comment">//FindServiceByPidä¸»è¦é€šè¿‡è½®è¯¢è§£æinit.rcç”Ÿæˆçš„service_listï¼Œæ‰¾åˆ°pidä¸å‚æ•°ä¸€è‡´çš„srvcã€‚</span></span><br><span class="line">Service* svc = FindServiceByPid(pid);</span><br><span class="line"><span class="comment">//è¾“å‡ºæœåŠ¡ç»“æŸçš„åŸå› </span></span><br><span class="line">.........</span><br><span class="line"><span class="keyword">if</span> (!svc) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»“æŸæœåŠ¡ï¼Œç›¸å¯¹äº6.0ä½œäº†è¿›ä¸€æ­¥çš„å°è£…</span></span><br><span class="line"><span class="keyword">if</span> (svc-&gt;Reap()) &#123;</span><br><span class="line">    waiting_for_exec = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//ç§»é™¤æœåŠ¡å¯¹åº”çš„ä¿¡æ¯</span></span><br><span class="line">    RemoveService(*svc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">bool</span> Service::Reap() &#123;</span><br><span class="line"><span class="comment">//æ¸…ç†æœªæºå¸¦SVC_ONESHOT æˆ– æºå¸¦äº†SVC_RESTARTæ ‡å¿—çš„srvcçš„å­è¿›ç¨‹</span></span><br><span class="line"><span class="keyword">if</span> (!(flags_ &amp; SVC_ONESHOT) || (flags_ &amp; SVC_RESTART)) &#123;</span><br><span class="line">    NOTICE(<span class="string">"Service '%s' (pid %d) killing any children in process group\n"</span>, name_.c_str(), pid_);</span><br><span class="line">    kill(-pid_, SIGKILL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ¸…é™¤srvcä¸­åˆ›å»ºå‡ºçš„socket</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; si : sockets_) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> tmp = StringPrintf(ANDROID_SOCKET_DIR <span class="string">"/%s"</span>, si.name.c_str());</span><br><span class="line">    unlink(tmp.c_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags_ &amp; SVC_EXEC) &#123;</span><br><span class="line">    INFO(<span class="string">"SVC_EXEC pid %d finished...\n"</span>, pid_);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pid_ = <span class="number">0</span>;</span><br><span class="line">flags_ &amp;= (~SVC_RUNNING);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹äºæºå¸¦äº†SVC_ONESHOTå¹¶ä¸”æœªæºå¸¦SVC_RESTARTçš„srvcï¼Œå°†è¿™ç±»æœåŠ¡çš„æ ‡å¿—ç½®ä¸ºSVC_DISABLEDï¼Œä¸å†å¯åŠ¨</span></span><br><span class="line"><span class="keyword">if</span> ((flags_ &amp; SVC_ONESHOT) &amp;&amp; !(flags_ &amp; SVC_RESTART)) &#123;</span><br><span class="line">    flags_ |= SVC_DISABLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Disabled and reset processes do not get restarted automatically.</span></span><br><span class="line"><span class="keyword">if</span> (flags_ &amp; (SVC_DISABLED | SVC_RESET))  &#123;</span><br><span class="line">    svc-&gt;NotifyStateChange(<span class="string">"stopped"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">time_t</span> now = gettime();</span><br><span class="line"><span class="comment">//æœªæºå¸¦SVC_RESTARTçš„å…³é”®æœåŠ¡ï¼Œåœ¨è§„å®šçš„é—´éš”å†…ï¼Œcrashå­—æ•°è¿‡å¤šæ—¶ï¼Œä¼šå¯¼è‡´æ•´æœºé‡å¯ï¼›</span></span><br><span class="line"><span class="keyword">if</span> ((flags_ &amp; SVC_CRITICAL) &amp;&amp; !(flags_ &amp; SVC_RESTART)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (time_crashed_ + CRITICAL_CRASH_WINDOW &gt;= now) &#123;</span><br><span class="line">        <span class="keyword">if</span> (++nr_crashed_ &gt; CRITICAL_CRASH_THRESHOLD) &#123;</span><br><span class="line">            ..........</span><br><span class="line">            android_reboot(ANDROID_RB_RESTART2, <span class="number">0</span>, <span class="string">"recovery"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        time_crashed_ = now;</span><br><span class="line">        nr_crashed_ = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å°†å¾…é‡å¯srvcçš„æ ‡å¿—ä½ç½®ä¸ºSVC_RESTARTINGï¼ˆinitè¿›ç¨‹å°†æ ¹æ®è¯¥æ ‡å¿—ä½ï¼Œé‡å¯æœåŠ¡ï¼‰</span></span><br><span class="line">flags_ &amp;= (~SVC_RESTART);</span><br><span class="line">flags_ |= SVC_RESTARTING;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute all onrestart commands for this service.</span></span><br><span class="line"><span class="comment">//é‡å¯åœ¨init.rcæ–‡ä»¶ä¸­å¸¦æœ‰onrestarté€‰é¡¹çš„æœåŠ¡ï¼Œç›¸å¯¹äº6.0ï¼Œæ­¤å¤„ä¹Ÿå¢åŠ äº†å°è£…æ€§</span></span><br><span class="line">onrestart_.ExecuteAllCommands();</span><br><span class="line"></span><br><span class="line">svc-&gt;NotifyStateChange(<span class="string">"restarting"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> Action::ExecuteAllCommands() <span class="keyword">const</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; c : commands_) &#123;</span><br><span class="line">    ExecuteCommand(c);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> Action::ExecuteCommand(<span class="keyword">const</span> Command&amp; command) <span class="keyword">const</span> &#123;</span><br><span class="line">Timer t;</span><br><span class="line"><span class="comment">//æœåŠ¡é‡å¯æ—¶ï¼Œå°†æ‰§è¡Œå¯¹åº”çš„é€‰é¡¹</span></span><br><span class="line"><span class="keyword">int</span> result = command.InvokeFunc();</span><br><span class="line"><span class="comment">//æ‰“å°log</span></span><br><span class="line">........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>waitpidçš„å‡½æ•°åŸå‹ä¸º:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pid_t</span> waitpid(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> *status, <span class="keyword">int</span> options)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°pidä¸ºé¢„ç­‰å¾…çš„å­è¿›ç¨‹çš„è¯†åˆ«ç ï¼Œpid=-1è¡¨ç¤ºç­‰å¾…ä»»ä½•å­è¿›ç¨‹æ˜¯å¦å‘å‡ºSIGCHLDã€‚ç¬¬äºŒä¸ªå‚æ•°statusï¼Œç”¨äºè¿”å›å­è¿›ç¨‹çš„ç»“æŸçŠ¶æ€ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°å†³å®šwaitpidå‡½æ•°æ˜¯å¦å¤„äºé˜»å¡å¤„ç†æ–¹å¼ï¼ŒWNOHANGè¡¨ç¤ºè‹¥pidæŒ‡å®šçš„å­è¿›ç¨‹æ²¡æœ‰ç»“æŸï¼Œåˆ™waitpid()å‡½æ•°è¿”å›0ï¼Œä¸äºˆç­‰å¾…ï¼›è‹¥å­è¿›ç¨‹ç»“æŸï¼Œåˆ™è¿”å›å­è¿›ç¨‹çš„pidã€‚waitpidå¦‚æœå‡ºé”™ï¼Œåˆ™è¿”å›-1ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼šæ•´ä¸ªsignal_handler_initå…¶å®å°±æ˜¯ä¸ºäº†é‡å¯å­è¿›ç¨‹ç”¨çš„ï¼Œä¸Šè¿°è¿‡ç¨‹å…¶å®æœ€ç»ˆå¯ä»¥ç®€åŒ–ä¸ºä¸‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N06-android-system-start-signal.jpg" alt="Markdown"></p><h4 id="4-1-11ã€è®¾ç½®é»˜è®¤ç³»ç»Ÿå±æ€§"><a href="#4-1-11ã€è®¾ç½®é»˜è®¤ç³»ç»Ÿå±æ€§" class="headerlink" title="4.1.11ã€è®¾ç½®é»˜è®¤ç³»ç»Ÿå±æ€§"></a>4.1.11ã€è®¾ç½®é»˜è®¤ç³»ç»Ÿå±æ€§</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">property_load_boot_defaults();</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œè¿›ç¨‹è°ƒç”¨property_load_boot_defaultsè¿›è¡Œé»˜è®¤å±æ€§é…ç½®ç›¸å…³çš„å·¥ä½œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">property_load_boot_defaults</span><span class="params">()</span> </span>&#123;</span><br><span class="line">load_properties_from_file(PROP_PATH_RAMDISK_DEFAULT, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>å¦‚ä»£ç æ‰€ç¤ºï¼Œproperty_load_boot_defaultså®é™…ä¸Šå°±æ˜¯è°ƒç”¨load_properties_from_fileè§£æé…ç½®æ–‡ä»¶ï¼›ç„¶åæ ¹æ®è§£æçš„ç»“æœï¼Œè®¾ç½®ç³»ç»Ÿå±æ€§ã€‚è¯¥éƒ¨åˆ†åŠŸèƒ½è¾ƒä¸ºå•ä¸€ï¼Œä¸å†æ·±å…¥åˆ†æã€‚</p><h4 id="4-1-12ã€é…ç½®å±æ€§çš„æœåŠ¡ç«¯"><a href="#4-1-12ã€é…ç½®å±æ€§çš„æœåŠ¡ç«¯" class="headerlink" title="4.1.12ã€é…ç½®å±æ€§çš„æœåŠ¡ç«¯"></a>4.1.12ã€é…ç½®å±æ€§çš„æœåŠ¡ç«¯</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">start_property_service();</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start_property_service</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªéé˜»å¡socket</span></span><br><span class="line">property_set_fd = create_socket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK, <span class="number">0666</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (property_set_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    ERROR(<span class="string">"start_property_service socket creation failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è°ƒç”¨listenå‡½æ•°ç›‘å¬property_set_fdï¼Œ äºæ˜¯è¯¥socketå˜æˆä¸€ä¸ªserver</span></span><br><span class="line">listen(property_set_fd, <span class="number">8</span>);</span><br><span class="line"><span class="comment">//ç›‘å¬server socketä¸Šæ˜¯å¦æœ‰æ•°æ®åˆ°æ¥</span></span><br><span class="line">register_epoll_handler(property_set_fd,  handle_property_set_fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨create_socketå‡½æ•°è¿”å›å¥—æ¥å­—property_set_fdæ—¶ï¼Œproperty_set_fdæ˜¯ä¸€ä¸ªä¸»åŠ¨è¿æ¥çš„å¥—æ¥å­—ã€‚æ­¤æ—¶ï¼Œç³»ç»Ÿå‡è®¾ç”¨æˆ·ä¼šå¯¹è¿™ä¸ªå¥—æ¥å­—è°ƒç”¨connectå‡½æ•°ï¼ŒæœŸå¾…å®ƒä¸»åŠ¨ä¸å…¶å®ƒè¿›ç¨‹è¿æ¥ã€‚</p><p>ç”±äºåœ¨æœåŠ¡å™¨ç¼–ç¨‹ä¸­ï¼Œç”¨æˆ·å¸Œæœ›è¿™ä¸ªå¥—æ¥å­—å¯ä»¥æ¥å—å¤–æ¥çš„è¿æ¥è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯è¢«åŠ¨ç­‰å¾…ç”¨æˆ·æ¥è¿æ¥ï¼Œäºæ˜¯éœ€è¦è°ƒç”¨listenå‡½æ•°ä½¿ç”¨ä¸»åŠ¨è¿æ¥å¥—æ¥å­—å˜ä¸ºè¢«è¿æ¥å¥—æ¥å­—ï¼Œä½¿å¾—ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ¥å—å…¶å®ƒè¿›ç¨‹çš„è¯·æ±‚ï¼Œä»è€Œæˆä¸ºä¸€ä¸ªæœåŠ¡å™¨è¿›ç¨‹ã€‚</p><p>å› æ­¤ï¼Œè°ƒç”¨listenåï¼Œinitè¿›ç¨‹æˆä¸ºä¸€ä¸ªæœåŠ¡è¿›ç¨‹ï¼Œå…¶å®ƒè¿›ç¨‹å¯ä»¥é€šè¿‡property_set_fdè¿æ¥initè¿›ç¨‹ï¼Œæäº¤è®¾ç½®ç³»ç»Ÿå±æ€§çš„ç”³è¯·ã€‚</p><p>listenå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ¶‰åŠåˆ°ä¸€äº›ç½‘ç»œçš„ç»†èŠ‚ã€‚</p><p>åœ¨è¿›ç¨‹å¤„ç†ä¸€ä¸ªè¿æ¥è¯·æ±‚çš„æ—¶å€™ï¼Œå¯èƒ½è¿˜å­˜åœ¨å…¶å®ƒçš„è¿æ¥è¯·æ±‚ã€‚å› ä¸ºTCPè¿æ¥æ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œæ‰€ä»¥å¯èƒ½å­˜åœ¨ä¸€ç§åŠè¿æ¥çš„çŠ¶æ€ã€‚æœ‰æ—¶ç”±äºåŒæ—¶å°è¯•è¿æ¥çš„ç”¨æˆ·è¿‡å¤šï¼Œä½¿å¾—æœåŠ¡å™¨è¿›ç¨‹æ— æ³•å¿«é€Ÿåœ°å®Œæˆè¿æ¥è¯·æ±‚ã€‚</p><p>å› æ­¤ï¼Œå†…æ ¸ä¼šåœ¨è‡ªå·±çš„è¿›ç¨‹ç©ºé—´é‡Œç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»¥è·Ÿè¸ªé‚£äº›å·²å®Œæˆè¿æ¥ä½†æœåŠ¡å™¨è¿›ç¨‹è¿˜æ²¡æœ‰æ¥æ‰‹å¤„ç†çš„ç”¨æˆ·ï¼Œæˆ–æ­£åœ¨è¿›è¡Œçš„è¿æ¥çš„ç”¨æˆ·ã€‚è¿™æ ·çš„ä¸€ä¸ªé˜Ÿåˆ—ä¸å¯èƒ½ä»»æ„å¤§ï¼Œæ‰€ä»¥å¿…é¡»æœ‰ä¸€ä¸ªä¸Šé™ã€‚listençš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å‘Šè¯‰å†…æ ¸ä½¿ç”¨è¿™ä¸ªæ•°å€¼ä½œä¸ºä¸Šé™ã€‚å› æ­¤ï¼Œinitè¿›ç¨‹ä½œä¸ºç³»ç»Ÿå±æ€§è®¾ç½®çš„æœåŠ¡å™¨ï¼Œæœ€å¤šå¯ä»¥åŒæ—¶ä¸º8ä¸ªè¯•å›¾è®¾ç½®å±æ€§çš„ç”¨æˆ·æä¾›æœåŠ¡ã€‚</p><p>åœ¨å¯åŠ¨é…ç½®å±æ€§æœåŠ¡çš„æœ€åï¼Œè°ƒç”¨å‡½æ•°register_epoll_handlerã€‚æ ¹æ®ä¸Šæ–‡æ‰€è¿°ï¼Œæˆ‘ä»¬çŸ¥é“è¯¥å‡½æ•°å°†åˆ©ç”¨ä¹‹å‰åˆ›å»ºå‡ºçš„epollå¥æŸ„ç›‘å¬property_set_fdã€‚å½“property_set_fdä¸­æœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œinitè¿›ç¨‹å°†åˆ©ç”¨handle_property_set_fdå‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_property_set_fd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ..........</span><br><span class="line">    <span class="keyword">if</span> ((s = accept(property_set_fd, (struct sockaddr *) &amp;addr, &amp;addr_size)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ........</span><br><span class="line">    r = TEMP_FAILURE_RETRY(recv(s, &amp;msg, <span class="keyword">sizeof</span>(msg), MSG_DONTWAIT));</span><br><span class="line">    .........</span><br><span class="line">    <span class="keyword">switch</span>(msg.cmd) &#123;</span><br><span class="line">    .........</span><br><span class="line">    &#125;</span><br><span class="line">    .........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handle_propery_set_fdå‡½æ•°å®é™…ä¸Šæ˜¯è°ƒç”¨acceptå‡½æ•°ç›‘å¬è¿æ¥è¯·æ±‚ï¼Œæ¥æ”¶property_set_fdä¸­åˆ°æ¥çš„æ•°æ®ï¼Œç„¶ååˆ©ç”¨recvå‡½æ•°æ¥å—åˆ°æ¥çš„æ•°æ®ï¼Œæœ€åæ ¹æ®åˆ°æ¥æ•°æ®çš„ç±»å‹ï¼Œè¿›è¡Œè®¾ç½®ç³»ç»Ÿå±æ€§ç­‰ç›¸å…³æ“ä½œï¼Œåœ¨æ­¤ä¸åšæ·±å…¥åˆ†æã€‚</p><p>åœ¨è¿™ä¸€éƒ¨åˆ†çš„æœ€åï¼Œæˆ‘ä»¬ç®€å•ä¸¾ä¾‹ä»‹ç»ä¸€ä¸‹ï¼Œç³»ç»Ÿå±æ€§æ”¹å˜çš„ä¸€äº›ç”¨é€”ã€‚ åœ¨init.rcä¸­å®šä¹‰äº†ä¸€äº›ä¸å±æ€§ç›¸å…³çš„è§¦å‘å™¨ã€‚å½“æŸä¸ªæ¡ä»¶ç›¸å…³çš„å±æ€§è¢«æ”¹å˜æ—¶ï¼Œä¸è¯¥æ¡ä»¶ç›¸å…³çš„è§¦å‘å™¨å°±ä¼šè¢«è§¦å‘ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼Œdebuggableå±æ€§å˜ä¸º1æ—¶ï¼Œå°†æ‰§è¡Œå¯åŠ¨consoleè¿›ç¨‹ç­‰æ“ä½œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">on property:ro.debuggable=<span class="number">1</span></span><br><span class="line"># Give writes to anyone <span class="keyword">for</span> the trace folder on debug builds.</span><br><span class="line"># The folder is used to store method traces.</span><br><span class="line">chmod <span class="number">0773</span> /data/misc/trace</span><br><span class="line">start console</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼Œå…¶å®ƒè¿›ç¨‹ä¿®æ”¹ç³»ç»Ÿå±æ€§æ—¶ï¼Œå¤§è‡´çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šå…¶å®ƒçš„è¿›ç¨‹åƒinitè¿›ç¨‹å‘é€è¯·æ±‚åï¼Œç”±initè¿›ç¨‹æ£€æŸ¥æƒé™åï¼Œä¿®æ”¹å…±äº«å†…å­˜åŒºã€‚</p><h4 id="4-1-12ã€è§£æinit-rcæ–‡ä»¶"><a href="#4-1-12ã€è§£æinit-rcæ–‡ä»¶" class="headerlink" title="4.1.12ã€è§£æinit.rcæ–‡ä»¶"></a>4.1.12ã€è§£æinit.rcæ–‡ä»¶</h4><p>å…³äºè§£æinit.rcçš„ä»£ç ï¼ŒAndroid 7.0ç›¸å¯¹äº6.0ï¼Œä½œäº†å·¨å¤§çš„ä¿®æ”¹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™é‡Œå°†Actionçš„function_map_æ›¿æ¢ä¸ºBuiltinFunctionMap</span></span><br><span class="line"><span class="comment">//ä¸‹æ–‡å°†é€šè¿‡BuiltinFuntionMapçš„mapæ–¹æ³•ï¼Œè·å–keywordå¯¹åº”çš„å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> BuiltinFunctionMap function_map;</span><br><span class="line">Action::set_function_map(&amp;function_map);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ å‡ºè§£ææ–‡ä»¶ç”¨çš„parserå¯¹è±¡</span></span><br><span class="line">Parser&amp; parser = Parser::GetInstance();</span><br><span class="line"><span class="comment">//ä¸ºä¸€äº›ç±»å‹çš„å…³é”®å­—ï¼Œåˆ›å»ºç‰¹å®šçš„parser</span></span><br><span class="line">parser.AddSectionParser(<span class="string">"service"</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</span><br><span class="line">parser.AddSectionParser(<span class="string">"on"</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</span><br><span class="line">parser.AddSectionParser(<span class="string">"import"</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</span><br><span class="line"><span class="comment">//å¼€å§‹å®é™…çš„è§£æè¿‡ç¨‹</span></span><br><span class="line">parser.ParseConfig(<span class="string">"/init.rc"</span>);</span><br><span class="line">........</span><br></pre></td></tr></table></figure><p>åœ¨è§£æinit.rcæ–‡ä»¶çš„è¿‡ç¨‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•ä»‹ç»ä¸€ä¸‹init.rcæ–‡ä»¶ã€‚ init.rcæ–‡ä»¶æ˜¯åœ¨initè¿›ç¨‹å¯åŠ¨åæ‰§è¡Œçš„å¯åŠ¨è„šæœ¬ï¼Œæ–‡ä»¶ä¸­è®°å½•ç€initè¿›ç¨‹éœ€æ‰§è¡Œçš„æ“ä½œã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼Œä½¿ç”¨init.rcå’Œinit.{ hardware }.rcä¸¤ä¸ªæ–‡ä»¶ã€‚</p><p>å…¶ä¸­init.rcæ–‡ä»¶åœ¨Androidç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ç”¨äºé€šç”¨çš„ç¯å¢ƒè®¾ç½®ä¸è¿›ç¨‹ç›¸å…³çš„å®šä¹‰ï¼Œinit.{hardware}.rcï¼ˆä¾‹å¦‚ï¼Œé«˜é€šæœ‰init.qcom.rcï¼ŒMTKæœ‰init.mediatek.rcï¼‰ç”¨äºå®šä¹‰Androidåœ¨ä¸åŒå¹³å°ä¸‹çš„ç‰¹å®šè¿›ç¨‹å’Œç¯å¢ƒè®¾ç½®ç­‰ã€‚</p><p>æ­¤å¤„è§£æå‡½æ•°ä¼ å…¥çš„å‚æ•°ä¸ºâ€/init.rcâ€ï¼Œè§£æçš„æ˜¯è¿è¡Œæ—¶ä¸initè¿›ç¨‹åŒåœ¨æ ¹ç›®å½•ä¸‹çš„init.rcæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åœ¨ç¼–è¯‘å‰ï¼Œå®šä¹‰äºsystem/core/rootdir/init.rcä¸­ï¼ˆä¸å¹³å°ç›¸å…³çš„rcæ–‡ä»¶ä¸åœ¨è¿™é‡ŒåŠ è½½ï¼‰ã€‚</p><p>init.rcæ–‡ä»¶å¤§è‡´åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ä»¥â€onâ€å…³é”®å­—å¼€å¤´çš„åŠ¨ä½œåˆ—è¡¨ï¼ˆaction listï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">on early-init</span><br><span class="line">    # Set init <span class="keyword">and</span> its forked children's oom_adj.</span><br><span class="line">    write /proc/<span class="number">1</span>/oom_score_adj <span class="number">-1000</span></span><br><span class="line">    .........</span><br><span class="line">    start ueventd</span><br></pre></td></tr></table></figure><p>å¦ä¸€éƒ¨åˆ†æ˜¯ä»¥â€serviceâ€å…³é”®å­—å¼€å¤´çš„æœåŠ¡åˆ—è¡¨ï¼ˆservice listï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service ueventd /sbin/ueventd</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">core</span></span></span><br><span class="line"><span class="class">    <span class="title">critical</span></span></span><br><span class="line"><span class="class">    <span class="title">seclabel</span> <span class="title">u</span>:</span>r:ueventd:s0</span><br></pre></td></tr></table></figure><p>å€ŸåŠ©ç³»ç»Ÿç¯å¢ƒå˜é‡æˆ–Linuxå‘½ä»¤ï¼ŒåŠ¨ä½œåˆ—è¡¨ç”¨äºåˆ›å»ºæ‰€éœ€ç›®å½•ï¼Œä»¥åŠä¸ºæŸäº›ç‰¹å®šæ–‡ä»¶æŒ‡å®šæƒé™ï¼Œè€ŒæœåŠ¡åˆ—è¡¨ç”¨æ¥è®°å½•initè¿›ç¨‹éœ€è¦å¯åŠ¨çš„ä¸€äº›å­è¿›ç¨‹ã€‚å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œserviceå…³é”®å­—åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ç¤ºæœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰çš„åç§°ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸²è¡¨ç¤ºæœåŠ¡çš„æ‰§è¡Œè·¯å¾„ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»ParseConfigå‡½æ•°å…¥æ‰‹ï¼Œé€æ­¥åˆ†ææ•´ä¸ªè§£æè¿‡ç¨‹(å‡½æ•°å®šä¹‰äºsystem/core/init/ init_parser.cppä¸­)ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Parser::ParseConfig(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_dir(path.c_str())) &#123;</span><br><span class="line">        <span class="comment">//ä¼ å…¥å‚æ•°ä¸ºç›®å½•åœ°å€</span></span><br><span class="line">        <span class="keyword">return</span> ParseConfigDir(path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¼ å…¥å‚æ•°ä¸ºæ–‡ä»¶åœ°å€</span></span><br><span class="line">    <span class="keyword">return</span> ParseConfigFile(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Parser::ParseConfigDir(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</span><br><span class="line">    ...........</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;DIR, <span class="keyword">int</span>(*)(DIR*)&gt; config_dir(opendir(path.c_str()), closedir);</span><br><span class="line">    ..........</span><br><span class="line">    <span class="comment">//çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œå…¶å®å°±æ˜¯é€’å½’ç›®å½•</span></span><br><span class="line">    <span class="keyword">while</span> ((current_file = readdir(config_dir.get()))) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> current_path = android::base::StringPrintf(<span class="string">"%s/%s"</span>, path.c_str(), current_file-&gt;d_name);</span><br><span class="line">        <span class="keyword">if</span> (current_file-&gt;d_type == DT_REG) &#123;</span><br><span class="line">            <span class="comment">//æœ€ç»ˆè¿˜æ˜¯é ParseConfigFileæ¥è§£æå®é™…çš„æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (!ParseConfigFile(current_path)) &#123;</span><br><span class="line">                .............</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè§£æinit.rcæ–‡ä»¶çš„å‡½æ•°æ˜¯ParseConfigFileï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Parser::ParseConfigFile(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</span><br><span class="line">    ........</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> data;</span><br><span class="line">    <span class="comment">//è¯»å–è·¯å¾„æŒ‡å®šæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œä¿å­˜ä¸ºå­—ç¬¦ä¸²å½¢å¼</span></span><br><span class="line">    <span class="keyword">if</span> (!read_file(path.c_str(), &amp;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    .........</span><br><span class="line">    <span class="comment">//è§£æè·å–çš„å­—ç¬¦ä¸²</span></span><br><span class="line">    ParseData(path, data);</span><br><span class="line">    .........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ParseDataå‡½æ•°å®šä¹‰äºsystem/core/init/init_parser.cppä¸­ï¼Œæ ¹æ®å…³é”®å­—è§£æå‡ºæœåŠ¡å’ŒåŠ¨ä½œã€‚åŠ¨ä½œä¸æœåŠ¡ä¼šä»¥é“¾è¡¨èŠ‚ç‚¹çš„å½¢å¼æ³¨å†Œåˆ°service_listä¸action_listä¸­ï¼Œservice_listä¸action_listæ˜¯initè¿›ç¨‹ä¸­å£°æ˜çš„å…¨å±€ç»“æ„ä½“ï¼Œå…¶ä¸­çš„å…³é”®ä»£ç ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Parser::ParseData(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data) &#123;</span><br><span class="line">.......</span><br><span class="line">parse_state state;</span><br><span class="line">.......</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; args;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">//next_tokenä»¥è¡Œä¸ºå•ä½åˆ†å‰²å‚æ•°ä¼ é€’è¿‡æ¥çš„å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="comment">//æœ€å…ˆèµ°åˆ°T_TEXTåˆ†æ”¯</span></span><br><span class="line">    <span class="keyword">switch</span> (next_token(&amp;state)) &#123;</span><br><span class="line">    <span class="keyword">case</span> T_EOF:</span><br><span class="line">        <span class="keyword">if</span> (section_parser) &#123;</span><br><span class="line">            <span class="comment">//EOF,è§£æç»“æŸ</span></span><br><span class="line">            section_parser-&gt;EndSection();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> T_NEWLINE:</span><br><span class="line">        state.line++;</span><br><span class="line">        <span class="keyword">if</span> (args.empty()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åœ¨å‰æ–‡åˆ›å»ºparseræ—¶ï¼Œæˆ‘ä»¬ä¸ºserviceï¼Œonï¼Œimportå®šä¹‰äº†å¯¹åº”çš„parser</span></span><br><span class="line">        <span class="comment">//è¿™é‡Œå°±æ˜¯æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„parser</span></span><br><span class="line">        <span class="keyword">if</span> (section_parsers_.count(args[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (section_parser) &#123;</span><br><span class="line">                <span class="comment">//ç»“æŸä¸Šä¸€ä¸ªparserçš„å·¥ä½œï¼Œå°†æ„é€ å‡ºçš„å¯¹è±¡åŠ å…¥åˆ°å¯¹åº”çš„service_listä¸action_listä¸­</span></span><br><span class="line">                section_parser-&gt;EndSection();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è·å–å‚æ•°å¯¹åº”çš„parser</span></span><br><span class="line">            section_parser = section_parsers_[args[<span class="number">0</span>]].get();</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> ret_err;</span><br><span class="line">            <span class="comment">//è°ƒç”¨å®é™…parserçš„ParseSectionå‡½æ•°</span></span><br><span class="line">            <span class="keyword">if</span> (!section_parser-&gt;ParseSection(args, &amp;ret_err)) &#123;</span><br><span class="line">                parse_error(&amp;state, <span class="string">"%s\n"</span>, ret_err.c_str());</span><br><span class="line">                section_parser = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (section_parser) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> ret_err;</span><br><span class="line">            <span class="comment">//å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯serviceï¼Œonï¼Œimport</span></span><br><span class="line">            <span class="comment">//åˆ™è°ƒç”¨å‰ä¸€ä¸ªparserçš„ParseLineSectionå‡½æ•°</span></span><br><span class="line">            <span class="comment">//è¿™é‡Œç›¸å½“äºè§£æä¸€ä¸ªå‚æ•°å—çš„å­é¡¹</span></span><br><span class="line">            <span class="keyword">if</span> (!section_parser-&gt;ParseLineSection(args, state.filename, state.line, &amp;ret_err)) &#123;</span><br><span class="line">                parse_error(&amp;state, <span class="string">"%s\n"</span>, ret_err.c_str());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ¸…ç©ºæœ¬æ¬¡è§£æçš„æ•°æ®</span></span><br><span class="line">        args.clear();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> T_TEXT:</span><br><span class="line">        <span class="comment">//å°†æœ¬æ¬¡è§£æçš„å†…å®¹å†™å…¥åˆ°argsä¸­</span></span><br><span class="line">        args.emplace_back(state.text);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„è§£æçœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œåœ¨6.0ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ•´ä¸ªè§£ææ˜¯é¢å‘è¿‡ç¨‹çš„ã€‚initè¿›ç¨‹ç»Ÿä¸€è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥è¿›è¡Œè§£æï¼Œç„¶ååœ¨è¯¥å‡½æ•°ä¸­åˆ©ç”¨switch-caseçš„å½¢å¼ï¼Œæ ¹æ®è§£æçš„å†…å®¹è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ åœ¨Android 7.0ä¸­ï¼Œä¸ºäº†æ›´å¥½åœ°å°è£…åŠé¢å‘å¯¹è±¡ï¼Œå¯¹äºä¸åŒçš„å…³é”®å­—å®šä¹‰äº†ä¸åŒçš„parserå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡é€šè¿‡å¤šæ€å®ç°è‡ªå·±çš„è§£ææ“ä½œã€‚</p><p>æˆ‘ä»¬ç°åœ¨å›å¿†ä¸€ä¸‹initè¿›ç¨‹mainå‡½æ•°ä¸­ï¼Œåˆ›å»ºparserçš„ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...........</span><br><span class="line">Parser&amp; parser = Parser::GetInstance();</span><br><span class="line">parser.AddSectionParser(<span class="string">"service"</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</span><br><span class="line">parser.AddSectionParser(<span class="string">"on"</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</span><br><span class="line">parser.AddSectionParser(<span class="string">"import"</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</span><br><span class="line">...........</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹ä¸‰ä¸ªParserçš„å®šä¹‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceParser</span> :</span> <span class="keyword">public</span> SectionParser &#123;......&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActionParser</span> :</span> <span class="keyword">public</span> SectionParser &#123;......&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImportParser</span> :</span> <span class="keyword">public</span> SectionParser &#123;.......&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªParserå‡æ˜¯ç»§æ‰¿SectionParserï¼Œå…·ä½“çš„å®ç°å„æœ‰ä¸åŒï¼Œæˆ‘ä»¬ä»¥æ¯”è¾ƒå¸¸ç”¨çš„ServiceParserå’ŒActionParserä¸ºä¾‹ï¼Œçœ‹çœ‹è§£æçš„ç»“æœå¦‚ä½•å¤„ç†ã€‚</p><h5 id="4-1-12-1-ServiceParser"><a href="#4-1-12-1-ServiceParser" class="headerlink" title="4.1.12..1 ServiceParser"></a>4.1.12..1 ServiceParser</h5><p>ServiceParserå®šä¹‰äºsystem/core/init/service.cppä¸­ã€‚ä»å‰é¢çš„ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè§£æä¸€ä¸ªserviceå—ï¼Œé¦–å…ˆéœ€è¦è°ƒç”¨ParseSectionå‡½æ•°ï¼Œæ¥ç€åˆ©ç”¨ParseLineSectionå¤„ç†å­å—ï¼Œè§£æå®Œæ‰€æœ‰æ•°æ®åï¼Œè°ƒç”¨EndSectionã€‚ å› æ­¤ï¼Œæˆ‘ä»¬ç€é‡çœ‹çœ‹ServiceParserçš„è¿™ä¸‰ä¸ªå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">bool</span> ServiceParser::ParseSection(.....) &#123;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name = args[<span class="number">1</span>];</span><br><span class="line">    .......</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; str_args(args.begin() + <span class="number">2</span>, args.end());</span><br><span class="line">    <span class="comment">//ä¸»è¦æ ¹æ®å‚æ•°ï¼Œæ„é€ å‡ºä¸€ä¸ªserviceå¯¹è±¡</span></span><br><span class="line">    service_ = <span class="built_in">std</span>::make_unique&lt;Service&gt;(name, <span class="string">"default"</span>, str_args);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ³¨æ„è¿™é‡Œå·²ç»åœ¨è§£æå­é¡¹äº†</span></span><br><span class="line"><span class="keyword">bool</span> ServiceParser::ParseLineSection(......) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="comment">//è°ƒç”¨serviceå¯¹è±¡çš„HandleLine</span></span><br><span class="line">    <span class="keyword">return</span> service_ ? service_-&gt;HandleLine(args, err) : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Service::HandleLine(.....) &#123;</span><br><span class="line">    ........</span><br><span class="line">    <span class="comment">//OptionHandlerMapç»§æ‰¿è‡ªkeywordMap&lt;OptionHandler&gt;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> OptionHandlerMap handler_map;</span><br><span class="line">    <span class="comment">//æ ¹æ®å­é¡¹çš„å†…å®¹ï¼Œæ‰¾åˆ°å¯¹åº”çš„handlerå‡½æ•°</span></span><br><span class="line">    <span class="comment">//FindFunctionå®šä¹‰ä¸keywordæ¨¡å—ä¸­,FindFunctionæ–¹æ³•åˆ©ç”¨å­ç±»ç”Ÿæˆå¯¹åº”çš„mapä¸­ï¼Œç„¶åé€šè¿‡é€šç”¨çš„æŸ¥æ‰¾æ–¹æ³•ï¼Œå³æ¯”è¾ƒé”®å€¼æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">auto</span> handler = handler_map.FindFunction(args[<span class="number">0</span>], args.size() - <span class="number">1</span>, err);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è°ƒç”¨handlerå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>-&gt;*handler)(args, err);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span>:</span>:OptionHandlerMap : <span class="keyword">public</span> KeywordMap&lt;OptionHandler&gt; &#123;</span><br><span class="line">    ...........</span><br><span class="line">    Service::OptionHandlerMap::Map&amp; Service::OptionHandlerMap::<span class="built_in">map</span>() <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> kMax = <span class="built_in">std</span>::numeric_limits&lt;<span class="built_in">std</span>::<span class="keyword">size_t</span>&gt;::max();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> Map option_handlers = &#123;</span><br><span class="line">        &#123;<span class="string">"class"</span>,       &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleClass&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"console"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleConsole&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"critical"</span>,    &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleCritical&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"disabled"</span>,    &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleDisabled&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"group"</span>,       &#123;<span class="number">1</span>,     NR_SVC_SUPP_GIDS + <span class="number">1</span>, &amp;Service::HandleGroup&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"ioprio"</span>,      &#123;<span class="number">2</span>,     <span class="number">2</span>,    &amp;Service::HandleIoprio&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"keycodes"</span>,    &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleKeycodes&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"oneshot"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleOneshot&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"onrestart"</span>,   &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleOnrestart&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"seclabel"</span>,    &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleSeclabel&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"setenv"</span>,      &#123;<span class="number">2</span>,     <span class="number">2</span>,    &amp;Service::HandleSetenv&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"socket"</span>,      &#123;<span class="number">3</span>,     <span class="number">6</span>,    &amp;Service::HandleSocket&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"user"</span>,        &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleUser&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"writepid"</span>,    &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleWritepid&#125;&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> option_handlers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»¥classå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹å‡ºå…¶å®å°±æ˜¯å¡«å……serviceå¯¹è±¡å¯¹åº”çš„åŸŸ</span></span><br><span class="line"><span class="keyword">bool</span> Service::HandleClass(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args, <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</span><br><span class="line">    classname_ = args[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ³¨æ„æ­¤æ—¶serviceå¯¹è±¡å·²ç»å¤„ç†å®Œæ¯•</span></span><br><span class="line"><span class="keyword">void</span> ServiceParser::EndSection() &#123;</span><br><span class="line">    <span class="keyword">if</span> (service_) &#123;</span><br><span class="line">        ServiceManager::GetInstance().AddService(<span class="built_in">std</span>::move(service_));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ServiceManager::AddService(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Service&gt; service) &#123;</span><br><span class="line">    Service* old_service = FindServiceByName(service-&gt;name());</span><br><span class="line">    <span class="keyword">if</span> (old_service) &#123;</span><br><span class="line">        ERROR(<span class="string">"ignored duplicate definition of service '%s'"</span>,</span><br><span class="line">              service-&gt;name().c_str());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†serviceå¯¹è±¡åŠ å…¥åˆ°services_é‡Œ</span></span><br><span class="line">    <span class="comment">//7.0é‡Œï¼Œservices_å·²ç»æ˜¯ä¸ªvectoräº†</span></span><br><span class="line">    services_.emplace_back(<span class="built_in">std</span>::move(service));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä¸€ç³»åˆ—ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºServiceParserå…¶å®å°±æ˜¯ï¼šé¦–å…ˆæ ¹æ®ç¬¬ä¸€è¡Œçš„åå­—å’Œå‚æ•°åˆ›å»ºå‡ºserviceå¯¹è±¡ï¼Œç„¶åæ ¹æ®é€‰é¡¹åŸŸçš„å†…å®¹å¡«å……serviceå¯¹è±¡ï¼Œæœ€åå°†åˆ›å»ºå‡ºçš„serviceå¯¹è±¡åŠ å…¥åˆ°vectorç±»å‹çš„serviceé“¾è¡¨ä¸­ã€‚</p><h4 id="4-1-12-2-ActionParser"><a href="#4-1-12-2-ActionParser" class="headerlink" title="4.1.12.2 ActionParser"></a>4.1.12.2 ActionParser</h4><p>ActionParserå®šä¹‰äºsystem/core/init/action.cppä¸­ã€‚Actionçš„è§£æè¿‡ç¨‹ï¼Œå…¶å®ä¸Serviceä¸€æ ·ï¼Œä¹Ÿæ˜¯å…ˆåè°ƒç”¨ParseSectionï¼Œ ParseLineSectionå’ŒEndSectionã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ActionParser::ParseSection(....) &#123;</span><br><span class="line">    ........</span><br><span class="line">    <span class="comment">//åˆ›å»ºå‡ºæ–°çš„actionå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">auto</span> action = <span class="built_in">std</span>::make_unique&lt;Action&gt;(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//æ ¹æ®å‚æ•°ï¼Œå¡«å……actionçš„triggeråŸŸï¼Œä¸è¯¦ç»†åˆ†æäº†</span></span><br><span class="line">    <span class="keyword">if</span> (!action-&gt;InitTriggers(triggers, err)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    .........</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> ActionParser::ParseLineSection(.......) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="comment">//æ„é€ Actionå¯¹è±¡çš„commandåŸŸ</span></span><br><span class="line">    <span class="keyword">return</span> action_ ? action_-&gt;AddCommand(args, filename, line, err) : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Action::AddCommand(.....) &#123;</span><br><span class="line">    ........</span><br><span class="line">    <span class="comment">//æ‰¾å‡ºactionå¯¹åº”çš„æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">    <span class="keyword">auto</span> function = function_map_-&gt;FindFunction(args[<span class="number">0</span>], args.size() - <span class="number">1</span>, err);</span><br><span class="line">    ........</span><br><span class="line">    <span class="comment">//åˆ©ç”¨æ‰€æœ‰ä¿¡æ¯æ„é€ å‡ºcommandï¼ŒåŠ å…¥åˆ°actionå¯¹è±¡ä¸­</span></span><br><span class="line">    AddCommand(function, args, filename, line);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Action::AddCommand(......) &#123;</span><br><span class="line">    commands_.emplace_back(f, args, filename, line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ActionParser::EndSection() &#123;</span><br><span class="line">    <span class="keyword">if</span> (action_ &amp;&amp; action_-&gt;NumCommands() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ActionManager::GetInstance().AddAction(<span class="built_in">std</span>::move(action_));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ActionManager::AddAction(.....) &#123;</span><br><span class="line">    ........</span><br><span class="line">    <span class="keyword">auto</span> old_action_it = <span class="built_in">std</span>::find_if(actions_.begin(),</span><br><span class="line">                     actions_.end(),</span><br><span class="line">                     [&amp;action] (<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Action&gt;&amp; a) &#123;</span><br><span class="line">                         <span class="keyword">return</span> action-&gt;TriggersEqual(*a);</span><br><span class="line">                     &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_action_it != actions_.end()) &#123;</span><br><span class="line">        (*old_action_it)-&gt;CombineAction(*action);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//åŠ å…¥åˆ°actioné“¾è¡¨ä¸­ï¼Œç±»å‹ä¹Ÿæ˜¯vectorï¼Œå…¶ä¸­è£…çš„æ˜¯æŒ‡é’ˆ</span></span><br><span class="line">        actions_.emplace_back(<span class="built_in">std</span>::move(action));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒåŠ è½½actionå—çš„é€»è¾‘å’Œserviceä¸€æ ·ï¼Œä¸åŒçš„æ˜¯éœ€è¦å¡«å……triggerå’ŒcommandåŸŸã€‚å½“ç„¶ï¼Œæœ€åè§£æå‡ºçš„actionä¹Ÿéœ€è¦åŠ å…¥åˆ°actioné“¾è¡¨ä¸­ã€‚</p><p>è¿™é‡Œæœ€åè¿˜å‰©ä¸‹ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å“ªé‡Œå®šä¹‰äº†Actionä¸­commandå¯¹åº”å¤„ç†å‡½æ•°ï¼Ÿ å®é™…ä¸Šï¼Œå‰æ–‡å·²ç»å‡ºç°äº†è¿‡äº†ï¼Œåœ¨init.cppçš„mainå‡½æ•°ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.......</span><br><span class="line"><span class="keyword">const</span> BuiltinFunctionMap function_map;</span><br><span class="line">Action::set_function_map(&amp;function_map);</span><br><span class="line">.......</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼ŒActionä¸­è°ƒç”¨function<em>map</em>-&gt;FindFunctionæ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯BuiltinFunctionMapçš„FindFunctionå‡½æ•°ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“FindFunctionæ˜¯keywordå®šä¹‰çš„é€šç”¨å‡½æ•°ï¼Œé‡ç‚¹æ˜¯é‡æ„çš„mapå‡½æ•°ã€‚æˆ‘ä»¬çœ‹çœ‹system/core/init/builtins.cppï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">BuiltinFunctionMap::Map&amp; BuiltinFunctionMap::<span class="built_in">map</span>() <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> kMax = <span class="built_in">std</span>::numeric_limits&lt;<span class="built_in">std</span>::<span class="keyword">size_t</span>&gt;::max();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> Map builtin_functions = &#123;</span><br><span class="line">        &#123;<span class="string">"bootchart_init"</span>,          &#123;<span class="number">0</span>,     <span class="number">0</span>,    do_bootchart_init&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"chmod"</span>,                   &#123;<span class="number">2</span>,     <span class="number">2</span>,    do_chmod&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"chown"</span>,                   &#123;<span class="number">2</span>,     <span class="number">3</span>,    do_chown&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"class_reset"</span>,             &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_class_reset&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"class_start"</span>,             &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_class_start&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"class_stop"</span>,              &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_class_stop&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"copy"</span>,                    &#123;<span class="number">2</span>,     <span class="number">2</span>,    do_copy&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"domainname"</span>,              &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_domainname&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"enable"</span>,                  &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_enable&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"exec"</span>,                    &#123;<span class="number">1</span>,     kMax, do_exec&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"export"</span>,                  &#123;<span class="number">2</span>,     <span class="number">2</span>,    do_export&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"hostname"</span>,                &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_hostname&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"ifup"</span>,                    &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_ifup&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"init_user0"</span>,              &#123;<span class="number">0</span>,     <span class="number">0</span>,    do_init_user0&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"insmod"</span>,                  &#123;<span class="number">1</span>,     kMax, do_insmod&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"installkey"</span>,              &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_installkey&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"load_persist_props"</span>,      &#123;<span class="number">0</span>,     <span class="number">0</span>,    do_load_persist_props&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"load_system_props"</span>,       &#123;<span class="number">0</span>,     <span class="number">0</span>,    do_load_system_props&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"loglevel"</span>,                &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_loglevel&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"mkdir"</span>,                   &#123;<span class="number">1</span>,     <span class="number">4</span>,    do_mkdir&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"mount_all"</span>,               &#123;<span class="number">1</span>,     kMax, do_mount_all&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"mount"</span>,                   &#123;<span class="number">3</span>,     kMax, do_mount&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"powerctl"</span>,                &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_powerctl&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"restart"</span>,                 &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_restart&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"restorecon"</span>,              &#123;<span class="number">1</span>,     kMax, do_restorecon&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"restorecon_recursive"</span>,    &#123;<span class="number">1</span>,     kMax, do_restorecon_recursive&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"rm"</span>,                      &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_rm&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"rmdir"</span>,                   &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_rmdir&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"setprop"</span>,                 &#123;<span class="number">2</span>,     <span class="number">2</span>,    do_setprop&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"setrlimit"</span>,               &#123;<span class="number">3</span>,     <span class="number">3</span>,    do_setrlimit&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"start"</span>,                   &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_start&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"stop"</span>,                    &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_stop&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"swapon_all"</span>,              &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_swapon_all&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"symlink"</span>,                 &#123;<span class="number">2</span>,     <span class="number">2</span>,    do_symlink&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"sysclktz"</span>,                &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_sysclktz&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"trigger"</span>,                 &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_trigger&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"verity_load_state"</span>,       &#123;<span class="number">0</span>,     <span class="number">0</span>,    do_verity_load_state&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"verity_update_state"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    do_verity_update_state&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"wait"</span>,                    &#123;<span class="number">1</span>,     <span class="number">2</span>,    do_wait&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"write"</span>,                   &#123;<span class="number">2</span>,     <span class="number">2</span>,    do_write&#125;&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> builtin_functions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„ç¬¬å››é¡¹å°±æ˜¯Actionæ¯ä¸ªcommandå¯¹åº”çš„æ‰§è¡Œå‡½æ•°ã€‚</p><h4 id="4-1-13ã€å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶å®ƒaction"><a href="#4-1-13ã€å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶å®ƒaction" class="headerlink" title="4.1.13ã€å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶å®ƒaction"></a>4.1.13ã€å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶å®ƒaction</h4><p>ä»‹ç»å®Œinitè¿›ç¨‹è§£æinit.rcæ–‡ä»¶çš„è¿‡ç¨‹åï¼Œæˆ‘ä»¬ç»§ç»­å°†è§†è§’æ‹‰å›åˆ°initè¿›ç¨‹çš„mainå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class="line"></span><br><span class="line">am.QueueEventTrigger(<span class="string">"early-init"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class="line">m.QueueBuiltinAction(wait_for_coldboot_done_action, <span class="string">"wait_for_coldboot_done"</span>);</span><br><span class="line"><span class="comment">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class="line">am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</span><br><span class="line">am.QueueBuiltinAction(set_mmap_rnd_bits_action, <span class="string">"set_mmap_rnd_bits"</span>);</span><br><span class="line">am.QueueBuiltinAction(keychord_init_action, <span class="string">"keychord_init"</span>);</span><br><span class="line">am.QueueBuiltinAction(console_init_action, <span class="string">"console_init"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trigger all the boot actions to get us started.</span></span><br><span class="line">am.QueueEventTrigger(<span class="string">"init"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class="line"><span class="comment">// wasn't ready immediately after wait_for_coldboot_done</span></span><br><span class="line">am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Don't mount filesystems or start core system services in charger mode.</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> bootmode = property_get(<span class="string">"ro.bootmode"</span>);</span><br><span class="line"><span class="keyword">if</span> (bootmode == <span class="string">"charger"</span>) &#123;</span><br><span class="line">    am.QueueEventTrigger(<span class="string">"charger"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    am.QueueEventTrigger(<span class="string">"late-init"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run all property triggers based on current state of the properties.</span></span><br><span class="line">    am.QueueBuiltinAction(queue_property_triggers_action, <span class="string">"queue_property_triggers"</span>);</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ¥ä¸‹æ¥initè¿›ç¨‹ä¸­è°ƒç”¨äº†å¤§é‡çš„QueueEventTriggerå’ŒQueueBuiltinActionå‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ActionManager::QueueEventTrigger(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; trigger) &#123;</span><br><span class="line">    trigger_queue_.push(<span class="built_in">std</span>::make_unique&lt;EventTrigger&gt;(trigger));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„QueueEventTriggerå‡½æ•°å°±æ˜¯åˆ©ç”¨å‚æ•°æ„é€ EventTriggerï¼Œç„¶ååŠ å…¥åˆ°trigger<em>queue</em>ä¸­ã€‚åç»­initè¿›ç¨‹å¤„ç†triggeräº‹ä»¶æ—¶ï¼Œå°†ä¼šè§¦å‘ç›¸åº”çš„æ“ä½œã€‚æ ¹æ®å‰æ–‡çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“å®é™…ä¸Šå°±æ˜¯å°†action_listä¸­ï¼Œå¯¹åº”triggerä¸ç¬¬ä¸€ä¸ªå‚æ•°åŒ¹é…çš„actionï¼ŒåŠ å…¥åˆ°è¿è¡Œé˜Ÿåˆ—action_queueä¸­ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ActionManager::QueueBuiltinAction(BuiltinFunction func, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name) &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºaction</span></span><br><span class="line">    <span class="keyword">auto</span> action = <span class="built_in">std</span>::make_unique&lt;Action&gt;(<span class="literal">true</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; name_vector&#123;name&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¿è¯å”¯ä¸€æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (!action-&gt;InitSingleTrigger(name)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºactionçš„cmdï¼ŒæŒ‡å®šæ‰§è¡Œå‡½æ•°å’Œå‚æ•°</span></span><br><span class="line">    action-&gt;AddCommand(func, name_vector);</span><br><span class="line"></span><br><span class="line">    trigger_queue_.push(<span class="built_in">std</span>::make_unique&lt;BuiltinTrigger&gt;(action.get()));</span><br><span class="line">    actions_.emplace_back(<span class="built_in">std</span>::move(action));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>QueueBuiltinActionå‡½æ•°ä¸­æ„é€ æ–°çš„actionåŠ å…¥åˆ°actions_ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæ–°å»ºactionæºå¸¦cmdçš„æ‰§è¡Œå‡½æ•°ï¼›ç¬¬äºŒä¸ªå‚æ•°æ—¢ä½œä¸ºactionçš„trigger nameï¼Œä¹Ÿä½œä¸ºactionæºå¸¦cmdçš„å‚æ•°ã€‚</p><h4 id="4-1-14ã€å¤„ç†æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—çš„äº‹ä»¶"><a href="#4-1-14ã€å¤„ç†æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—çš„äº‹ä»¶" class="headerlink" title="4.1.14ã€å¤„ç†æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—çš„äº‹ä»¶"></a>4.1.14ã€å¤„ç†æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—çš„äº‹ä»¶</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶éœ€è¦å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (!waiting_for_exec) &#123;</span><br><span class="line">        <span class="comment">//ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªactionä¸­æºå¸¦commandå¯¹åº”çš„æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">        am.ExecuteOneCommand();</span><br><span class="line">        <span class="comment">//é‡å¯ä¸€äº›æŒ‚æ‰çš„è¿›ç¨‹</span></span><br><span class="line">        restart_processes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»¥ä¸‹å†³å®štimeoutçš„æ—¶é—´ï¼Œå°†å½±å“whileå¾ªç¯çš„é—´éš”</span></span><br><span class="line">    <span class="keyword">int</span> timeout = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//æœ‰è¿›ç¨‹éœ€è¦é‡å¯æ—¶ï¼Œç­‰å¾…è¯¥è¿›ç¨‹é‡å¯</span></span><br><span class="line">    <span class="keyword">if</span> (process_needs_restart) &#123;</span><br><span class="line">        timeout = (process_needs_restart - gettime()) * <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">            timeout = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æœ‰actionå¾…å¤„ç†ï¼Œä¸ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">if</span> (am.HasMoreCommands()) &#123;</span><br><span class="line">        timeout = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//bootchart_sampleåº”è¯¥æ˜¯è¿›è¡Œæ€§èƒ½æ•°æ®é‡‡æ ·</span></span><br><span class="line">    bootchart_sample(&amp;timeout);</span><br><span class="line"></span><br><span class="line">    epoll_event ev;</span><br><span class="line">    <span class="comment">//æ²¡æœ‰äº‹ä»¶åˆ°æ¥çš„è¯ï¼Œæœ€å¤šé˜»å¡timeoutæ—¶é—´</span></span><br><span class="line">    <span class="keyword">int</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;ev, <span class="number">1</span>, timeout));</span><br><span class="line">    <span class="keyword">if</span> (nr == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"epoll_wait failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//æœ‰äº‹ä»¶åˆ°æ¥ï¼Œæ‰§è¡Œå¯¹åº”å¤„ç†å‡½æ•°</span></span><br><span class="line">        <span class="comment">//æ ¹æ®ä¸Šæ–‡çŸ¥é“ï¼Œepollå¥æŸ„ï¼ˆå³epoll_fdï¼‰ä¸»è¦ç›‘å¬å­è¿›ç¨‹ç»“æŸï¼ŒåŠå…¶å®ƒè¿›ç¨‹è®¾ç½®ç³»ç»Ÿå±æ€§çš„è¯·æ±‚ã€‚</span></span><br><span class="line">        ((<span class="keyword">void</span> (*)()) ev.data.ptr)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œinitè¿›ç¨‹å°†æ‰€æœ‰éœ€è¦æ“ä½œçš„actionåŠ å…¥è¿è¡Œé˜Ÿåˆ—åï¼Œ è¿›å…¥æ— é™å¾ªç¯è¿‡ç¨‹ï¼Œä¸æ–­å¤„ç†è¿è¡Œé˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼ŒåŒæ—¶è¿›è¡Œé‡å¯serviceç­‰æ“ä½œã€‚</p><p>ExecuteOneCommandä¸­çš„ä¸»è¦éƒ¨åˆ†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ActionManager::ExecuteOneCommand() &#123;</span><br><span class="line">    <span class="comment">// Loop through the trigger queue until we have an action to execute</span></span><br><span class="line">    <span class="comment">//å½“æœ‰å¯æ‰§è¡Œactionæˆ–trigger queueä¸ºç©ºæ—¶ç»“æŸ</span></span><br><span class="line">    <span class="keyword">while</span> (current_executing_actions_.empty() &amp;&amp; !trigger_queue_.empty()) &#123;</span><br><span class="line">        <span class="comment">//è½®è¯¢actionsé“¾è¡¨</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; action : actions_) &#123;</span><br><span class="line">            <span class="comment">//ä¾æ¬¡æŸ¥æ‰¾triggerè¡¨</span></span><br><span class="line">            <span class="keyword">if</span> (trigger_queue_.front()-&gt;CheckTriggers(*action)) &#123;</span><br><span class="line">                <span class="comment">//å½“actionä¸triggerå¯¹åº”æ—¶ï¼Œå°±å¯ä»¥æ‰§è¡Œå½“å‰action</span></span><br><span class="line">                <span class="comment">//ä¸€ä¸ªtriggerå¯ä»¥å¯¹åº”å¤šä¸ªactionï¼Œå‡åŠ å…¥current_executing_actions_</span></span><br><span class="line">                current_executing_actions_.emplace(action.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//trigger eventå‡ºé˜Ÿ</span></span><br><span class="line">        trigger_queue_.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current_executing_actions_.empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¯æ¬¡åªæ‰§è¡Œä¸€ä¸ªactionï¼Œä¸‹æ¬¡initè¿›ç¨‹whileå¾ªç¯æ—¶ï¼Œè·³è¿‡ä¸Šé¢çš„whileå¾ªç¯ï¼Œæ¥ç€æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">auto</span> action = current_executing_actions_.front();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current_command_ == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> trigger_name = action-&gt;BuildTriggersString();</span><br><span class="line">        INFO(<span class="string">"processing action (%s)\n"</span>, trigger_name.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®é™…çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ­¤å¤„ä»…å¤„ç†å½“å‰actionä¸­çš„ä¸€ä¸ªcmd</span></span><br><span class="line">    action-&gt;ExecuteOneCommand(current_command_);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€‚å½“åœ°æ¸…ç†å·¥ä½œï¼Œæ³¨æ„åªæœ‰å½“å‰actionä¸­æ‰€æœ‰çš„commandå‡æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šå°†è¯¥actionä»current_executing_actions_ç§»é™¤</span></span><br><span class="line">    <span class="comment">// If this was the last command in the current action, then remove</span></span><br><span class="line">    <span class="comment">// the action from the executing list.</span></span><br><span class="line">    <span class="comment">// If this action was oneshot, then also remove it from actions_.</span></span><br><span class="line">    ++current_command_;</span><br><span class="line">    <span class="keyword">if</span> (current_command_ == action-&gt;NumCommands()) &#123;</span><br><span class="line">        current_executing_actions_.pop();</span><br><span class="line">        current_command_ = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (action-&gt;oneshot()) &#123;</span><br><span class="line">            <span class="keyword">auto</span> eraser = [&amp;action] (<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Action&gt;&amp; a) &#123;</span><br><span class="line">                <span class="keyword">return</span> a.get() == action;</span><br><span class="line">            &#125;;</span><br><span class="line">            actions_.erase(<span class="built_in">std</span>::remove_if(actions_.begin(), actions_.end(), eraser));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Action::ExecuteCommand(<span class="keyword">const</span> Command&amp; command) <span class="keyword">const</span> &#123;</span><br><span class="line">    Timer t;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œè¯¥commandå¯¹åº”çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">int</span> result = command.InvokeFunc();</span><br><span class="line">    ........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“whileå¾ªç¯ä¸æ–­è°ƒç”¨ExecuteOneCommandå‡½æ•°æ—¶ï¼Œå°†æŒ‰ç…§triggerè¡¨çš„é¡ºåºï¼Œä¾æ¬¡å–å‡ºactioné“¾è¡¨ä¸­ä¸triggeråŒ¹é…çš„actionã€‚ æ¯æ¬¡å‡æ‰§è¡Œä¸€ä¸ªactionä¸­çš„ä¸€ä¸ªcommandå¯¹åº”å‡½æ•°ï¼ˆä¸€ä¸ªactionå¯èƒ½æºå¸¦å¤šä¸ªcommandï¼‰ã€‚ å½“ä¸€ä¸ªactionæ‰€æœ‰çš„commandå‡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªactionã€‚ å½“ä¸€ä¸ªtriggerå¯¹åº”çš„actionå‡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªtriggerå¯¹åº”actionã€‚</p><p>restart_processeså‡½æ•°è´Ÿè´£æŒ‰éœ€é‡å¯serviceï¼Œä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restart_processes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    process_needs_restart = <span class="number">0</span>;</span><br><span class="line">    ServiceManager::GetInstance().ForEachServiceWithFlags(</span><br><span class="line">        SVC_RESTARTING,</span><br><span class="line">        [] (Service* s) &#123;</span><br><span class="line">            s-&gt;RestartIfNeeded(process_needs_restart);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œè¯¥å‡½æ•°è½®è¯¢serviceå¯¹åº”çš„é“¾è¡¨ï¼Œå¯¹äºæœ‰SVC_RESTARINGæ ‡å¿—çš„serviceæ‰§è¡ŒRestartIfNeededï¼ˆå¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œå½“å­è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œinitè¿›ç¨‹ä¼šå°†å¯è¢«é‡å¯è¿›ç¨‹çš„æœåŠ¡æ ‡å¿—ä½ç½®ä¸ºSVC_RESTARTINGï¼‰ã€‚</p><p>å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼Œrestart_service_if_neededå¯ä»¥é‡æ–°å¯åŠ¨æœåŠ¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Service::RestartIfNeeded(<span class="keyword">time_t</span>&amp; process_needs_restart)(struct service *svc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">time_t</span> next_start_time = svc-&gt;time_started + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸¤æ¬¡æœåŠ¡å¯åŠ¨æ—¶é—´çš„é—´éš”è¦å¤§äº5s</span></span><br><span class="line">    <span class="keyword">if</span> (next_start_time &lt;= gettime()) &#123;</span><br><span class="line">        svc-&gt;flags &amp;= (~SVC_RESTARTING);</span><br><span class="line">        <span class="comment">//æ»¡è¶³æ—¶é—´é—´éš”çš„è¦æ±‚åï¼Œé‡å¯æœåŠ¡</span></span><br><span class="line">        <span class="comment">//Startå°†ä¼šé‡æ–°forkæœåŠ¡è¿›ç¨‹ï¼Œå¹¶åšç›¸åº”çš„é…ç½®</span></span><br><span class="line">        Start(svc, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ›´æ–°mainå‡½æ•°ä¸­ï¼Œwhileå¾ªç¯éœ€è¦ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> ((next_start_time &lt; process_needs_restart) ||</span><br><span class="line">        (process_needs_restart == <span class="number">0</span>)) &#123;</span><br><span class="line">        process_needs_restart = next_start_time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥é˜…èµ„æ–™å‘ç°ï¼šBootchart æ˜¯ä¸€ä¸ªèƒ½å¯¹ GNU/Linux boot è¿‡ç¨‹è¿›è¡Œæ€§èƒ½åˆ†æå¹¶æŠŠç»“æœç›´è§‚åŒ–çš„å·¥å…·ã€‚å®ƒåœ¨ boot è¿‡ç¨‹ä¸­æœé›†èµ„æºåˆ©ç”¨æƒ…å†µåŠè¿›ç¨‹ä¿¡æ¯ç„¶åä»¥PNG, SVGæˆ–EPSæ ¼å¼æ¥æ˜¾ç¤ºç»“æœã€‚BootChart åŒ…å«æ•°æ®æ”¶é›†å·¥å…·å’Œå›¾åƒäº§ç”Ÿå·¥å…·ã€‚æ•°æ®æ”¶é›†å·¥å…·åœ¨åŸå§‹çš„BootChartä¸­æ˜¯ç‹¬ç«‹çš„shellç¨‹åºï¼Œä½†åœ¨Androidä¸­ï¼Œæ•°æ®æ”¶é›†å·¥å…·è¢«é›†æˆåˆ°äº†init ç¨‹åºä¸­ã€‚èµ„æ–™ä¸ä»£ç åŸºæœ¬å»åˆã€‚</p><h3 id="ï¼ˆ2ï¼‰ã€å¯åŠ¨Zygoteè¿›ç¨‹"><a href="#ï¼ˆ2ï¼‰ã€å¯åŠ¨Zygoteè¿›ç¨‹" class="headerlink" title="ï¼ˆ2ï¼‰ã€å¯åŠ¨Zygoteè¿›ç¨‹"></a>ï¼ˆ2ï¼‰ã€å¯åŠ¨Zygoteè¿›ç¨‹</h3><h4 id="4-2-1ã€æ¦‚è¿°"><a href="#4-2-1ã€æ¦‚è¿°" class="headerlink" title="4.2.1ã€æ¦‚è¿°"></a>4.2.1ã€æ¦‚è¿°</h4><p>Zygoteæ˜¯ç”±initè¿›ç¨‹é€šè¿‡è§£æinit.zygote.rcæ–‡ä»¶è€Œåˆ›å»ºçš„ï¼Œzygoteæ‰€å¯¹åº”çš„å¯æ‰§è¡Œç¨‹åºapp_processï¼Œæ‰€å¯¹åº”çš„æºæ–‡ä»¶æ˜¯App_main.cppï¼Œè¿›ç¨‹åä¸ºzygoteã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">service zygote /system/bin/app_process32 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</span><br><span class="line">    class main</span><br><span class="line">    socket zygote stream <span class="number">660</span> root system</span><br><span class="line">    onrestart write /sys/android_power/request_state wake</span><br><span class="line">    onrestart write /sys/power/state on</span><br><span class="line">    onrestart restart audioserver</span><br><span class="line">    onrestart restart cameraserver</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br><span class="line"></span><br><span class="line">service zygote_secondary /system/bin/app_process64 -Xzygote /system/bin --zygote --socket-name=zygote_secondary</span><br><span class="line">    class main</span><br><span class="line">    socket zygote_secondary stream <span class="number">660</span> root system</span><br><span class="line">    onrestart restart zygote</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure><p>Zygoteè¿›ç¨‹èƒ½å¤Ÿé‡å¯çš„åœ°æ–¹:</p><p>servicemanagerè¿›ç¨‹è¢«æ€; (onresart) surfaceflingerè¿›ç¨‹è¢«æ€; (onresart) Zygoteè¿›ç¨‹è‡ªå·±è¢«æ€; (oneshot=false) system_serverè¿›ç¨‹è¢«æ€; (waitpid) ä»App_main()å¼€å§‹ï¼ŒZygoteå¯åŠ¨è¿‡ç¨‹çš„å‡½æ•°è°ƒç”¨ç±»å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N07-android-system-start-zygote_process.jpg" alt="Markdown"></p><h4 id="4-2-2ã€Zygoteå¯åŠ¨è¿‡ç¨‹"><a href="#4-2-2ã€Zygoteå¯åŠ¨è¿‡ç¨‹" class="headerlink" title="4.2.2ã€Zygoteå¯åŠ¨è¿‡ç¨‹"></a>4.2.2ã€Zygoteå¯åŠ¨è¿‡ç¨‹</h4><h5 id="4-2-2-1ã€App-main-main"><a href="#4-2-2-1ã€App-main-main" class="headerlink" title="4.2.2.1ã€App_main.main()"></a>4.2.2.1ã€App_main.main()</h5><p>[-&gt; App_main.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Older kernels don't understand PR_SET_NO_NEW_PRIVS and return</span></span><br><span class="line">        <span class="comment">// EINVAL. Don't die on such kernels.</span></span><br><span class="line">        <span class="keyword">if</span> (errno != EINVAL) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">"PR_SET_NO_NEW_PRIVS failed: %s"</span>, strerror(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¼ åˆ°çš„å‚æ•°argvä¸ºâ€œ-Xzygote /system/bin --zygote --start-system-serverâ€</span></span><br><span class="line">    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</span><br><span class="line">    <span class="comment">// Process command line arguments</span></span><br><span class="line">    <span class="comment">// ignore argv[0] //å¿½ç•¥ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    argc--;</span><br><span class="line">    argv++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">0</span>] != <span class="string">'-'</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">1</span>] == <span class="string">'-'</span> &amp;&amp; argv[i][<span class="number">2</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            ++i; <span class="comment">// Skip --.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        runtime.addOption(strdup(argv[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse runtime arguments.  Stop at first unrecognized option.</span></span><br><span class="line">    <span class="comment">//å‚æ•°è§£æ</span></span><br><span class="line">    <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line"></span><br><span class="line">    ++i;  <span class="comment">// Skip unused "parent dir" argument.</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector&lt;String8&gt; args;</span><br><span class="line">    <span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// We're not in zygote mode, the only argument we need to pass</span></span><br><span class="line">        <span class="comment">// to RuntimeInit is the application argument.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// The Remainder of args get passed to startup class main(). Make</span></span><br><span class="line">        <span class="comment">// copies of them before we overwrite them with the process name.</span></span><br><span class="line">        <span class="comment">// è¿è¡Œapplicationæˆ–toolç¨‹åº</span></span><br><span class="line">        args.add(application ? String8(<span class="string">"application"</span>) : String8(<span class="string">"tool"</span>));</span><br><span class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We're in zygote mode.</span></span><br><span class="line">         <span class="comment">//è¿›å…¥zygoteæ¨¡å¼ï¼Œåˆ›å»º /data/dalvik-cacheè·¯å¾„</span></span><br><span class="line">        maybeCreateDalvikCache();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            args.add(String8(<span class="string">"start-system-server"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> prop[PROP_VALUE_MAX];</span><br><span class="line">        <span class="keyword">if</span> (property_get(ABI_LIST_PROPERTY, prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">"app_process: Unable to determine ABI list from property %s."</span>,</span><br><span class="line">                ABI_LIST_PROPERTY);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">String8 <span class="title">abiFlag</span><span class="params">(<span class="string">"--abi-list="</span>)</span></span>;</span><br><span class="line">        abiFlag.append(prop);</span><br><span class="line">        args.add(abiFlag);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In zygote mode, pass all remaining arguments to the zygote</span></span><br><span class="line">        <span class="comment">// main() method.</span></span><br><span class="line">        <span class="keyword">for</span> (; i &lt; argc; ++i) &#123;</span><br><span class="line">            args.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®¾ç½®è¿›ç¨‹å</span></span><br><span class="line">    <span class="keyword">if</span> (!niceName.isEmpty()) &#123;</span><br><span class="line">        runtime.setArgv0(niceName.<span class="built_in">string</span>());</span><br><span class="line">        set_process_name(niceName.<span class="built_in">string</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">       <span class="comment">// å¯åŠ¨AppRuntime</span></span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">//æ²¡æœ‰æŒ‡å®šç±»åæˆ–zygoteï¼Œå‚æ•°é”™è¯¯</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-2-2ã€AndroidRuntime-start"><a href="#4-2-2-2ã€AndroidRuntime-start" class="headerlink" title="4.2.2.2ã€AndroidRuntime.start()"></a>4.2.2.2ã€AndroidRuntime.start()</h4><p>[-&gt; AndroidRuntime.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span><br><span class="line">&#123;</span><br><span class="line">ALOGD(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n"</span>,</span><br><span class="line">        className != <span class="literal">NULL</span> ? className : <span class="string">"(unknown)"</span>, getuid());</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">"start-system-server"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 'startSystemServer == true' means runtime is obsolete and not run from</span></span><br><span class="line"><span class="comment"> * init.rc anymore, so we print out the boot start event here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</span><br><span class="line">       <span class="comment">/* track our progress through the boot sequence */</span></span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">       LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</span><br><span class="line"><span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    rootDir = <span class="string">"/system"</span>;</span><br><span class="line">    <span class="keyword">if</span> (!hasDir(<span class="string">"/system"</span>)) &#123;</span><br><span class="line">        LOG_FATAL(<span class="string">"No root directory specified, and /android does not exist."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setenv(<span class="string">"ANDROID_ROOT"</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//const char* kernelHack = getenv("LD_ASSUME_KERNEL");</span></span><br><span class="line"><span class="comment">//ALOGD("Found LD_ASSUME_KERNEL='%s'\n", kernelHack);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* start the virtual machine */</span></span><br><span class="line">JniInvocation jni_invocation;</span><br><span class="line">jni_invocation.Init(<span class="literal">NULL</span>);</span><br><span class="line">JNIEnv* env;</span><br><span class="line"><span class="comment">// è™šæ‹Ÿæœºåˆ›å»º</span></span><br><span class="line"><span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">onVmCreated(env);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Register android functions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// JNIæ–¹æ³•æ³¨å†Œ</span></span><br><span class="line"><span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We want to call main() with a String array with arguments in it.</span></span><br><span class="line"><span class="comment"> * At present we have two arguments, the class name and an option string.</span></span><br><span class="line"><span class="comment"> * Create an array to hold them.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">jclass stringClass;</span><br><span class="line">jobjectArray strArray;</span><br><span class="line">jstring classNameStr;</span><br><span class="line"><span class="comment">//ç­‰ä»· strArray= new String[options.size() + 1];</span></span><br><span class="line">stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">assert(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">assert(strArray != <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">//ç­‰ä»· strArray[0] = "com.android.internal.os.ZygoteInit"</span></span><br><span class="line">classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">assert(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"><span class="comment">//ç­‰ä»· strArray[1] = "start-system-server"ï¼›</span></span><br><span class="line"><span class="comment">//    strArray[2] = "--abi-list=xxx"ï¼›</span></span><br><span class="line"><span class="comment">//å…¶ä¸­xxxä¸ºç³»ç»Ÿå“åº”çš„cpuæ¶æ„ç±»å‹ï¼Œæ¯”å¦‚arm64-v8a.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">    jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</span><br><span class="line">    assert(optionsStr != <span class="literal">NULL</span>);</span><br><span class="line">    env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start VM.  This thread becomes the main thread of the VM, and will</span></span><br><span class="line"><span class="comment"> * not return until the VM exits.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">//å°†"com.android.internal.os.ZygoteInit"è½¬æ¢ä¸º"com/android/internal/os/ZygoteInit"</span></span><br><span class="line"><span class="keyword">char</span>* slashClassName = toSlashClassName(className);</span><br><span class="line">jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line"><span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</span><br><span class="line">    <span class="comment">/* keep going */</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</span><br><span class="line">        <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">    <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ZygoteInit.main()æ–¹æ³•</span></span><br><span class="line">        env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        <span class="keyword">if</span> (env-&gt;ExceptionCheck())</span><br><span class="line">            threadExitUncaughtException(env);</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">ALOGD(<span class="string">"Shutting down VM\n"</span>);</span><br><span class="line"><span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">    ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</span><br><span class="line"><span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">    ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="4-2-2-3ã€AndroidRuntime-startVm"><a href="#4-2-2-3ã€AndroidRuntime-startVm" class="headerlink" title="4.2.2.3ã€AndroidRuntime.startVm()"></a>4.2.2.3ã€AndroidRuntime.startVm()</h5><p>[â€“&gt; AndroidRuntime.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, <span class="keyword">bool</span> zygote)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// JNIæ£€æµ‹åŠŸèƒ½ï¼Œç”¨äºnativeå±‚è°ƒç”¨jniå‡½æ•°æ—¶è¿›è¡Œå¸¸è§„æ£€æµ‹ï¼Œæ¯”è¾ƒå¼±å­—ç¬¦ä¸²æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œèµ„æºæ˜¯å¦æ­£ç¡®é‡Šæ”¾ã€‚è¯¥åŠŸèƒ½ä¸€èˆ¬ç”¨äºæ—©æœŸç³»ç»Ÿè°ƒè¯•æˆ–æ‰‹æœºEngç‰ˆï¼Œå¯¹äºUserç‰ˆå¾€å¾€ä¸ä¼šå¼€å¯ï¼Œå¼•ç”¨è¯¥åŠŸèƒ½æ¯”è¾ƒæ¶ˆè€—ç³»ç»ŸCPUèµ„æºï¼Œé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚</span></span><br><span class="line">   <span class="keyword">bool</span> checkJni = <span class="literal">false</span>;</span><br><span class="line">property_get(<span class="string">"dalvik.vm.checkjni"</span>, propBuf, <span class="string">""</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">"true"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    checkJni = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">"false"</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/* property is neither true nor false; fall back on kernel parameter */</span></span><br><span class="line">    property_get(<span class="string">"ro.kernel.android.checkjni"</span>, propBuf, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">if</span> (propBuf[<span class="number">0</span>] == <span class="string">'1'</span>) &#123;</span><br><span class="line">        checkJni = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ALOGD(<span class="string">"CheckJNI is %s\n"</span>, checkJni ? <span class="string">"ON"</span> : <span class="string">"OFF"</span>);</span><br><span class="line"><span class="keyword">if</span> (checkJni) &#123;</span><br><span class="line">    addOption(<span class="string">"-Xcheck:jni"</span>)</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"> <span class="comment">//è™šæ‹Ÿæœºäº§ç”Ÿçš„traceæ–‡ä»¶ï¼Œä¸»è¦ç”¨äºåˆ†æç³»ç»Ÿé—®é¢˜ï¼Œè·¯å¾„é»˜è®¤ä¸º/data/anr/traces.txt</span></span><br><span class="line">parseRuntimeOption(<span class="string">"dalvik.vm.stack-trace-file"</span>, stackTraceFileBuf, <span class="string">"-Xstacktracefile:"</span>);</span><br><span class="line"><span class="comment">//å¯¹äºä¸åŒçš„è½¯ç¡¬ä»¶ç¯å¢ƒï¼Œè¿™äº›å‚æ•°å¾€å¾€éœ€è¦è°ƒæ•´ã€ä¼˜åŒ–ï¼Œä»è€Œä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ä½³æ€§èƒ½</span></span><br><span class="line">parseRuntimeOption(<span class="string">"dalvik.vm.heapstartsize"</span>, heapstartsizeOptsBuf, <span class="string">"-Xms"</span>, <span class="string">"4m"</span>);</span><br><span class="line">parseRuntimeOption(<span class="string">"dalvik.vm.heapsize"</span>, heapsizeOptsBuf, <span class="string">"-Xmx"</span>, <span class="string">"16m"</span>);</span><br><span class="line">parseRuntimeOption(<span class="string">"dalvik.vm.heapgrowthlimit"</span>, heapgrowthlimitOptsBuf, <span class="string">"-XX:HeapGrowthLimit="</span>);</span><br><span class="line">parseRuntimeOption(<span class="string">"dalvik.vm.heapminfree"</span>, heapminfreeOptsBuf, <span class="string">"-XX:HeapMinFree="</span>);</span><br><span class="line">parseRuntimeOption(<span class="string">"dalvik.vm.heapmaxfree"</span>, heapmaxfreeOptsBuf, <span class="string">"-XX:HeapMaxFree="</span>);</span><br><span class="line">parseRuntimeOption(<span class="string">"dalvik.vm.heaptargetutilization"</span>,</span><br><span class="line">                   heaptargetutilizationOptsBuf, <span class="string">"-XX:HeapTargetUtilization="</span>);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//preloaded-classesæ–‡ä»¶å†…å®¹æ˜¯ç”±WritePreloadedClassFile.javaç”Ÿæˆçš„ï¼Œ</span></span><br><span class="line"><span class="comment">//åœ¨ZygoteInitç±»ä¸­ä¼šé¢„åŠ è½½å·¥ä½œå°†å…¶ä¸­çš„classesæå‰åŠ è½½åˆ°å†…å­˜ï¼Œä»¥æé«˜ç³»ç»Ÿæ€§èƒ½</span></span><br><span class="line"><span class="keyword">if</span> (!hasFile(<span class="string">"/system/etc/preloaded-classes"</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–è™šæ‹Ÿæœº</span></span><br><span class="line"><span class="keyword">if</span> (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    ALOGE(<span class="string">"JNI_CreateJavaVM failed\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºJavaè™šæ‹Ÿæœºæ–¹æ³•çš„ä¸»è¦ç¯‡å¹…æ˜¯å…³äºè™šæ‹Ÿæœºå‚æ•°çš„è®¾ç½®ï¼Œä¸‹é¢åªåˆ—ä¸¾éƒ¨åˆ†åœ¨è°ƒè¯•ä¼˜åŒ–è¿‡ç¨‹ä¸­å¸¸ç”¨å‚æ•°ã€‚</p><h4 id="4-2-2-4ã€AndroidRuntime-startReg"><a href="#4-2-2-4ã€AndroidRuntime-startReg" class="headerlink" title="4.2.2.4ã€AndroidRuntime.startReg()"></a>4.2.2.4ã€AndroidRuntime.startReg()</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> AndroidRuntime::startReg(JNIEnv* env)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®çº¿ç¨‹åˆ›å»ºæ–¹æ³•ä¸ºjavaCreateThreadEtc</span></span><br><span class="line">    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);</span><br><span class="line"></span><br><span class="line">    env-&gt;PushLocalFrame(<span class="number">200</span>);</span><br><span class="line">    <span class="comment">//è¿›ç¨‹NIæ–¹æ³•çš„æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">if</span> (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        env-&gt;PopLocalFrame(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;PopLocalFrame(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-2-4-1ã€Threads-androidSetCreateThreadFunc"><a href="#4-2-2-4-1ã€Threads-androidSetCreateThreadFunc" class="headerlink" title="4.2.2.4.1ã€Threads.androidSetCreateThreadFunc()"></a>4.2.2.4.1ã€Threads.androidSetCreateThreadFunc()</h4><p>[-&gt; Threads.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">androidSetCreateThreadFunc</span><span class="params">(android_create_thread_fn func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gCreateThreadFn = func;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™šæ‹Ÿæœºå¯åŠ¨åstartReg()è¿‡ç¨‹ï¼Œä¼šè®¾ç½®çº¿ç¨‹åˆ›å»ºå‡½æ•°æŒ‡é’ˆgCreateThreadFnæŒ‡å‘javaCreateThreadEtc.</p><h4 id="4-2-2-4-2ã€register-jni-procs"><a href="#4-2-2-4-2ã€register-jni-procs" class="headerlink" title="4.2.2.4.2ã€register_jni_procs()"></a>4.2.2.4.2ã€register_jni_procs()</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">register_jni_procs</span><span class="params">(<span class="keyword">const</span> RegJNIRec <span class="built_in">array</span>[], <span class="keyword">size_t</span> count, JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">array</span>[i].mProc(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-2-4-3ã€gRegJNI-mProc"><a href="#4-2-2-4-3ã€gRegJNI-mProc" class="headerlink" title="4.2.2.4.3ã€gRegJNI.mProc"></a>4.2.2.4.3ã€gRegJNI.mProc</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> RegJNIRec gRegJNI[] = &#123;</span><br><span class="line">    REG_JNI(register_com_android_internal_os_RuntimeInit),</span><br><span class="line">    REG_JNI(register_android_os_Binder)ï¼Œ</span><br><span class="line">    ...</span><br><span class="line">&#125;ï¼›*</span><br></pre></td></tr></table></figure><p>array[i]æ˜¯æŒ‡gRegJNIæ•°ç»„, è¯¥æ•°ç»„æœ‰100å¤šä¸ªæˆå‘˜ã€‚å…¶ä¸­æ¯ä¸€é¡¹æˆå‘˜éƒ½æ˜¯é€šè¿‡REG_JNIå®å®šä¹‰çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REG_JNI(name)      &#123; name &#125;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RegJNIRec</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> (*mProc)(JNIEnv*);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œè°ƒç”¨mProcï¼Œå°±ç­‰ä»·äºè°ƒç”¨å…¶å‚æ•°åæ‰€æŒ‡å‘çš„å‡½æ•°ã€‚ ä¾‹å¦‚REG_JNI(register_com_android_internal_os_RuntimeInit).mProcä¹Ÿå°±æ˜¯æŒ‡è¿›å…¥register_com_android_internal_os_RuntimeInitæ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±ç»§ç»­ä»¥æ­¤ä¸ºä¾‹æ¥è¯´æ˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_com_android_internal_os_RuntimeInit</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jniRegisterNativeMethods(env, <span class="string">"com/android/internal/os/RuntimeInit"</span>,</span><br><span class="line">        gMethods, NELEM(gMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>//gMethodsï¼šjavaå±‚æ–¹æ³•åä¸jniå±‚çš„æ–¹æ³•çš„ä¸€ä¸€æ˜ å°„å…³ç³»</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    &#123; <span class="string">"nativeFinishInit"</span>, <span class="string">"()V"</span>,</span><br><span class="line">        (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeFinishInit &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeZygoteInit"</span>, <span class="string">"()V"</span>,</span><br><span class="line">        (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeZygoteInit &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeSetExitWithoutCleanup"</span>, <span class="string">"(Z)V"</span>,</span><br><span class="line">        (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeSetExitWithoutCleanup &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N08-android-system-start-ZygoteInit.main.png" alt="Markdown"></p><h4 id="4-2-2-5ã€è¿›å…¥Javaå±‚"><a href="#4-2-2-5ã€è¿›å…¥Javaå±‚" class="headerlink" title="4.2.2.5ã€è¿›å…¥Javaå±‚"></a>4.2.2.5ã€è¿›å…¥Javaå±‚</h4><p>AndroidRuntime.start()æ‰§è¡Œåˆ°æœ€åé€šè¿‡åå°„è°ƒç”¨åˆ°ZygoteInit.main(),è§ä¸‹æ–‡:</p><h5 id="4-2-2-5-1ã€ZygoteInit-main"><a href="#4-2-2-5-1ã€ZygoteInit-main" class="headerlink" title="4.2.2.5.1ã€ZygoteInit.main()"></a>4.2.2.5.1ã€ZygoteInit.main()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;Init<span class="string">");</span></span><br><span class="line"><span class="string">    //å¼€å¯DDMSåŠŸèƒ½</span></span><br><span class="line"><span class="string">    RuntimeInit.enableDdms();</span></span><br><span class="line"><span class="string">    SamplingProfilerIntegration.start();</span></span><br><span class="line"><span class="string">    boolean startSystemServer = false;</span></span><br><span class="line"><span class="string">    String socketName = "</span>zygote<span class="string">";</span></span><br><span class="line"><span class="string">    String abiList = null;</span></span><br><span class="line"><span class="string">    for (int i = 1; i &lt; argv.length; i++) &#123;</span></span><br><span class="line"><span class="string">        if ("</span>start-system-server<span class="string">".equals(argv[i])) &#123;</span></span><br><span class="line"><span class="string">            startSystemServer = true;</span></span><br><span class="line"><span class="string">        &#125; else if (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span></span><br><span class="line"><span class="string">            abiList = argv[i].substring(ABI_LIST_ARG.length());</span></span><br><span class="line"><span class="string">        &#125; else if (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span></span><br><span class="line"><span class="string">            socketName = argv[i].substring(SOCKET_NAME_ARG.length());</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            throw new RuntimeException("</span>Unknown command line argument: <span class="string">" + argv[i]);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    ......</span></span><br><span class="line"><span class="string">    //ä¸ºZygoteæ³¨å†Œsocket</span></span><br><span class="line"><span class="string">    registerZygoteSocket(socketName);</span></span><br><span class="line"><span class="string">    preload();// é¢„åŠ è½½ç±»å’Œèµ„æº</span></span><br><span class="line"><span class="string">    SamplingProfilerIntegration.writeZygoteSnapshot();</span></span><br><span class="line"><span class="string">    gcAndFinalize();//GCæ“ä½œ</span></span><br><span class="line"><span class="string">    Zygote.nativeUnmountStorageOnInit();</span></span><br><span class="line"><span class="string">    ZygoteHooks.stopZygoteNoThreadCreation();</span></span><br><span class="line"><span class="string">    if (startSystemServer) &#123;//å¯åŠ¨system_server</span></span><br><span class="line"><span class="string">        startSystemServer(abiList, socketName);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    runSelectLoop(abiList);//è¿›å…¥å¾ªç¯æ¨¡å¼</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    closeServerSocket();</span></span><br><span class="line"><span class="string">&#125; catch (MethodAndArgsCaller caller) &#123;</span></span><br><span class="line"><span class="string">    caller.run();</span></span><br><span class="line"><span class="string">&#125; catch (Throwable ex) &#123;</span></span><br><span class="line"><span class="string">    closeServerSocket();</span></span><br><span class="line"><span class="string">    throw ex;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>åœ¨å¼‚å¸¸æ•è·åè°ƒç”¨çš„æ–¹æ³•caller.run()ï¼Œä¼šåœ¨åç»­çš„system_serveræ–‡ç« ä¼šè®²åˆ°ã€‚</p><h5 id="4-2-2-5-2ã€ZygoteInit-registerZygoteSocket"><a href="#4-2-2-5-2ã€ZygoteInit-registerZygoteSocket" class="headerlink" title="4.2.2.5.2ã€ZygoteInit.registerZygoteSocket()"></a>4.2.2.5.2ã€ZygoteInit.registerZygoteSocket()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerZygoteSocket</span><span class="params">(String socketName)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (sServerSocket == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> fileDesc;</span><br><span class="line">    <span class="keyword">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String env = System.getenv(fullSocketName);</span><br><span class="line">        fileDesc = Integer.parseInt(env);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">        fd.setInt$(fileDesc); <span class="comment">//è®¾ç½®æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">        sServerSocket = <span class="keyword">new</span> LocalServerSocket(fd); <span class="comment">//åˆ›å»ºSocketçš„æœ¬åœ°æœåŠ¡ç«¯</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-2-2-5-2ã€ZygoteInit-preload"><a href="#4-2-2-5-2ã€ZygoteInit-preload" class="headerlink" title="4.2.2.5.2ã€ZygoteInit.preload()"></a>4.2.2.5.2ã€ZygoteInit.preload()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//é¢„åŠ è½½ä½äº/system/etc/preloaded-classesæ–‡ä»¶ä¸­çš„ç±»</span></span><br><span class="line">    preloadClasses();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é¢„åŠ è½½èµ„æºï¼ŒåŒ…å«drawableå’Œcolorèµ„æº</span></span><br><span class="line">    preloadResources();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é¢„åŠ è½½OpenGL</span></span><br><span class="line">    preloadOpenGL();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡System.loadLibrary()æ–¹æ³•ï¼Œ</span></span><br><span class="line">    <span class="comment">//é¢„åŠ è½½"android","compiler_rt","jnigraphics"è¿™3ä¸ªå…±äº«åº“</span></span><br><span class="line">    preloadSharedLibraries();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é¢„åŠ è½½  æ–‡æœ¬è¿æ¥ç¬¦èµ„æº</span></span><br><span class="line">    preloadTextResources();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»…ç”¨äºzygoteè¿›ç¨‹ï¼Œç”¨äºå†…å­˜å…±äº«çš„è¿›ç¨‹</span></span><br><span class="line">    WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒZygoteè¿›ç¨‹çš„åˆå§‹åŒ–,å¯¹äºç±»åŠ è½½ï¼Œé‡‡ç”¨åå°„æœºåˆ¶Class.forName()æ–¹æ³•æ¥åŠ è½½ã€‚å¯¹äºèµ„æºåŠ è½½ï¼Œä¸»è¦æ˜¯ com.android.internal.R.array.preloaded_drawableså’Œcom.android.internal.R.array.preloaded_color_state_listsï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­ä»¥com.android.internal.R.xxxå¼€å¤´çš„èµ„æºï¼Œä¾¿æ˜¯æ­¤æ—¶ç”±ZygoteåŠ è½½åˆ°å†…å­˜çš„ã€‚</p><p>zygoteè¿›ç¨‹å†…åŠ è½½äº†preload()æ–¹æ³•ä¸­çš„æ‰€æœ‰èµ„æºï¼Œå½“éœ€è¦forkæ–°è¿›ç¨‹æ—¶ï¼Œé‡‡ç”¨copy on writeæŠ€æœ¯ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N09-android-system-start-zygote_fork.jpg" alt="Markdown"></p><h5 id="4-2-2-5-3ã€ZygoteInit-startSystemServer"><a href="#4-2-2-5-3ã€ZygoteInit-startSystemServer" class="headerlink" title="4.2.2.5.3ã€ZygoteInit.startSystemServer()"></a>4.2.2.5.3ã€ZygoteInit.startSystemServer()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> capabilities = posixCapabilitiesAsBits(</span><br><span class="line">        OsConstants.CAP_BLOCK_SUSPEND,</span><br><span class="line">        OsConstants.CAP_KILL,</span><br><span class="line">        OsConstants.CAP_NET_ADMIN,</span><br><span class="line">        OsConstants.CAP_NET_BIND_SERVICE,</span><br><span class="line">        OsConstants.CAP_NET_BROADCAST,</span><br><span class="line">        OsConstants.CAP_NET_RAW,</span><br><span class="line">        OsConstants.CAP_SYS_MODULE,</span><br><span class="line">        OsConstants.CAP_SYS_NICE,</span><br><span class="line">        OsConstants.CAP_SYS_RESOURCE,</span><br><span class="line">        OsConstants.CAP_SYS_TIME,</span><br><span class="line">        OsConstants.CAP_SYS_TTY_CONFIG</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//å‚æ•°å‡†å¤‡</span></span><br><span class="line">    String args[] = &#123;</span><br><span class="line">        <span class="string">"--setuid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007"</span>,</span><br><span class="line">        <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">        <span class="string">"--nice-name=system_server"</span>,</span><br><span class="line">        <span class="string">"--runtime-args"</span>,</span><br><span class="line">        <span class="string">"com.android.server.SystemServer"</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//ç”¨äºè§£æå‚æ•°ï¼Œç”Ÿæˆç›®æ ‡æ ¼å¼</span></span><br><span class="line">        parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// forkå­è¿›ç¨‹ï¼Œç”¨äºè¿è¡Œsystem_server</span></span><br><span class="line">        pid = Zygote.forkSystemServer(</span><br><span class="line">                parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                parsedArgs.gids,</span><br><span class="line">                parsedArgs.debugFlags,</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                parsedArgs.permittedCapabilities,</span><br><span class="line">                parsedArgs.effectiveCapabilities);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿›å…¥å­è¿›ç¨‹system_server</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">            waitForSecondaryZygote(socketName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å®Œæˆsystem_serverè¿›ç¨‹å‰©ä½™çš„å·¥ä½œ</span></span><br><span class="line">        handleSystemServerProcess(parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡†å¤‡å‚æ•°å¹¶forkæ–°è¿›ç¨‹ï¼Œä»ä¸Šé¢å¯ä»¥çœ‹å‡ºsystem serverè¿›ç¨‹å‚æ•°ä¿¡æ¯ä¸ºuid=1000,gid=1000,è¿›ç¨‹åä¸ºsytem_serverï¼Œä»zygoteè¿›ç¨‹forkæ–°è¿›ç¨‹åï¼Œéœ€è¦å…³é—­zygoteåŸæœ‰çš„socketã€‚å¦å¤–ï¼Œå¯¹äºæœ‰ä¸¤ä¸ªzygoteè¿›ç¨‹æƒ…å†µï¼Œéœ€ç­‰å¾…ç¬¬2ä¸ªzygoteåˆ›å»ºå®Œæˆã€‚</p><h5 id="4-2-2-5-4ã€ZygoteInit-runSelectLoop"><a href="#4-2-2-5-4ã€ZygoteInit-runSelectLoop" class="headerlink" title="4.2.2.5.4ã€ZygoteInit.runSelectLoop()"></a>4.2.2.5.4ã€ZygoteInit.runSelectLoop()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">    ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line">    <span class="comment">//sServerSocketæ˜¯socketé€šä¿¡ä¸­çš„æœåŠ¡ç«¯ï¼Œå³zygoteè¿›ç¨‹ã€‚ä¿å­˜åˆ°fds[0]</span></span><br><span class="line">    fds.add(sServerSocket.getFileDescriptor());</span><br><span class="line">    peers.add(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">            pollFds[i] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">            pollFds[i].fd = fds.get(i);</span><br><span class="line">            pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">//å¤„ç†è½®è¯¢çŠ¶æ€ï¼Œå½“pollFdsæœ‰äº‹ä»¶åˆ°æ¥åˆ™å¾€ä¸‹æ‰§è¡Œï¼Œå¦åˆ™é˜»å¡åœ¨è¿™é‡Œ</span></span><br><span class="line">            Os.poll(pollFds, -<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="comment">//é‡‡ç”¨I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå½“æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘å‡ºè¿æ¥è¯·æ±‚ æˆ–è€…æ•°æ®å¤„ç†è¯·æ±‚åˆ°æ¥ï¼Œåˆ™å¾€ä¸‹æ‰§è¡Œï¼›</span></span><br><span class="line">            <span class="comment">// å¦åˆ™è¿›å…¥continueï¼Œè·³å‡ºæœ¬æ¬¡å¾ªç¯ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//å³fds[0]ï¼Œä»£è¡¨çš„æ˜¯sServerSocketï¼Œåˆ™æ„å‘³ç€æœ‰å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼›</span></span><br><span class="line">                <span class="comment">// åˆ™åˆ›å»ºZygoteConnectionå¯¹è±¡,å¹¶æ·»åŠ åˆ°fdsã€‚</span></span><br><span class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                peers.add(newPeer);</span><br><span class="line">                fds.add(newPeer.getFileDesciptor()); <span class="comment">//æ·»åŠ åˆ°fds.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//i&gt;0ï¼Œåˆ™ä»£è¡¨é€šè¿‡socketæ¥æ”¶æ¥è‡ªå¯¹ç«¯çš„æ•°æ®ï¼Œå¹¶æ‰§è¡Œç›¸åº”æ“ä½œ</span></span><br><span class="line">                <span class="keyword">boolean</span> done = peers.get(i).runOnce();</span><br><span class="line">                <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                    peers.remove(i);</span><br><span class="line">                    fds.remove(i); <span class="comment">//å¤„ç†å®Œåˆ™ä»fdsä¸­ç§»é™¤è¯¥æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Zygoteé‡‡ç”¨é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä¿è¯åœ¨æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æˆ–æ•°æ®å¤„ç†æ—¶ä¼‘çœ ï¼Œå¦åˆ™å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p><h5 id="4-2-2-5-4ã€ZygoteConnection-runOnce"><a href="#4-2-2-5-4ã€ZygoteConnection-runOnce" class="headerlink" title="4.2.2.5.4ã€ZygoteConnection.runOnce()"></a>4.2.2.5.4ã€ZygoteConnection.runOnce()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">String args[];</span><br><span class="line">Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">FileDescriptor[] descriptors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//è¯»å–socketå®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„å‚æ•°åˆ—è¡¨</span></span><br><span class="line">    args = readArgumentList();</span><br><span class="line">    descriptors = mSocket.getAncillaryFileDescriptors();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//å°†binderå®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œè§£ææˆArgumentså¯¹è±¡æ ¼å¼</span></span><br><span class="line">    parsedArgs = <span class="keyword">new</span> Arguments(args);</span><br><span class="line">    ...</span><br><span class="line">    pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</span><br><span class="line">            parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</span><br><span class="line">            parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</span><br><span class="line">            parsedArgs.appDataDir);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å­è¿›ç¨‹æ‰§è¡Œ</span></span><br><span class="line">        IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">        serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//è¿›å…¥å­è¿›ç¨‹æµç¨‹</span></span><br><span class="line">        handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//çˆ¶è¿›ç¨‹æ‰§è¡Œ</span></span><br><span class="line">        IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">        childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">    IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-2-2-6ã€æ€»ç»“"><a href="#4-2-2-6ã€æ€»ç»“" class="headerlink" title="4.2.2.6ã€æ€»ç»“"></a>4.2.2.6ã€æ€»ç»“</h5><p>Zygoteå¯åŠ¨è¿‡ç¨‹çš„è°ƒç”¨æµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N10-android-system-start-zygote_start.jpg" alt="Markdown"></p><blockquote><p>1ã€è§£æinit.zygote.rcä¸­çš„å‚æ•°ï¼Œåˆ›å»ºAppRuntimeå¹¶è°ƒç”¨AppRuntime.start()æ–¹æ³•ï¼›<br>2ã€ è°ƒç”¨AndroidRuntimeçš„startVM()æ–¹æ³•åˆ›å»ºè™šæ‹Ÿæœºï¼Œå†è°ƒç”¨startReg()æ³¨å†ŒJNIå‡½æ•°ï¼›<br>3ã€é€šè¿‡JNIæ–¹å¼è°ƒç”¨ZygoteInit.main()ï¼Œç¬¬ä¸€æ¬¡è¿›å…¥Javaä¸–ç•Œï¼›<br>4ã€registerZygoteSocket()å»ºç«‹socketé€šé“ï¼Œzygoteä½œä¸ºé€šä¿¡çš„æœåŠ¡ç«¯ï¼Œç”¨äºå“åº”å®¢æˆ·ç«¯è¯·æ±‚ï¼›<br>5ã€preload()é¢„åŠ è½½é€šç”¨ç±»ã€drawableå’Œcolorèµ„æºã€openGLä»¥åŠå…±äº«åº“ä»¥åŠWebViewï¼Œç”¨äºæé«˜appå¯åŠ¨æ•ˆç‡ï¼›<br>6ã€zygoteå®Œæ¯•å¤§éƒ¨åˆ†å·¥ä½œï¼Œæ¥ä¸‹æ¥å†é€šè¿‡startSystemServer()ï¼Œforkå¾—åŠ›å¸®æ‰‹system_serverè¿›ç¨‹ï¼Œä¹Ÿæ˜¯ä¸Šå±‚frameworkçš„è¿è¡Œè½½ä½“ã€‚<br>7ã€ zygoteåŠŸæˆèº«é€€ï¼Œè°ƒç”¨runSelectLoop()ï¼Œéšæ—¶å¾…å‘½ï¼Œå½“æ¥æ”¶åˆ°è¯·æ±‚åˆ›å»ºæ–°è¿›ç¨‹è¯·æ±‚æ—¶ç«‹å³å”¤é†’å¹¶æ‰§è¡Œç›¸åº”å·¥ä½œã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N11-android-system-start-System_Server.png" alt="Markdown"></p></blockquote><h3 id="ï¼ˆ3ï¼‰ã€å¯åŠ¨SystemServerä¸Šç¯‡"><a href="#ï¼ˆ3ï¼‰ã€å¯åŠ¨SystemServerä¸Šç¯‡" class="headerlink" title="ï¼ˆ3ï¼‰ã€å¯åŠ¨SystemServerä¸Šç¯‡"></a>ï¼ˆ3ï¼‰ã€å¯åŠ¨SystemServerä¸Šç¯‡</h3><h4 id="4-3-1ã€å¯åŠ¨æµç¨‹"><a href="#4-3-1ã€å¯åŠ¨æµç¨‹" class="headerlink" title="4.3.1ã€å¯åŠ¨æµç¨‹"></a>4.3.1ã€å¯åŠ¨æµç¨‹</h4><p>SystemServerçš„åœ¨Androidä½“ç³»ä¸­æ‰€å¤„çš„åœ°ä½ï¼ŒSystemServerç”±Zygote forkç”Ÿæˆçš„ï¼Œè¿›ç¨‹åä¸ºsystem_serverï¼Œè¯¥è¿›ç¨‹æ‰¿è½½ç€frameworkçš„æ ¸å¿ƒæœåŠ¡ã€‚ Androidç³»ç»Ÿå¯åŠ¨-zygoteç¯‡ä¸­è®²åˆ°Zygoteå¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨startSystemServer()ï¼Œå¯çŸ¥startSystemServer()å‡½æ•°æ˜¯system_serverå¯åŠ¨æµç¨‹çš„èµ·ç‚¹ï¼Œ å¯åŠ¨æµç¨‹å›¾å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N12-android-system-start-system_server_.jpg" alt="Markdown"></p><h4 id="4-3-2ã€ZygoteInit-startSystemServer"><a href="#4-3-2ã€ZygoteInit-startSystemServer" class="headerlink" title="4.3.2ã€ZygoteInit.startSystemServer()"></a>4.3.2ã€ZygoteInit.startSystemServer()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//å‚æ•°å‡†å¤‡</span></span><br><span class="line">    String args[] = &#123;</span><br><span class="line">        <span class="string">"--setuid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007"</span>,</span><br><span class="line">        <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">        <span class="string">"--nice-name=system_server"</span>,</span><br><span class="line">        <span class="string">"--runtime-args"</span>,</span><br><span class="line">        <span class="string">"com.android.server.SystemServer"</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//ç”¨äºè§£æå‚æ•°ï¼Œç”Ÿæˆç›®æ ‡æ ¼å¼</span></span><br><span class="line">        parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// forkå­è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹æ˜¯system_serverè¿›ç¨‹</span></span><br><span class="line">        pid = Zygote.forkSystemServer(</span><br><span class="line">                parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                parsedArgs.gids,</span><br><span class="line">                parsedArgs.debugFlags,</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                parsedArgs.permittedCapabilities,</span><br><span class="line">                parsedArgs.effectiveCapabilities);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿›å…¥å­è¿›ç¨‹system_server</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">            waitForSecondaryZygote(socketName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å®Œæˆsystem_serverè¿›ç¨‹å‰©ä½™çš„å·¥ä½œ</span></span><br><span class="line">        handleSystemServerProcess(parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡†å¤‡å‚æ•°å¹¶forkæ–°è¿›ç¨‹ï¼Œä»ä¸Šé¢å¯ä»¥çœ‹å‡ºsystem serverè¿›ç¨‹å‚æ•°ä¿¡æ¯ä¸ºuid=1000,gid=1000,è¿›ç¨‹åä¸ºsytem_serverï¼Œä»zygoteè¿›ç¨‹forkæ–°è¿›ç¨‹åï¼Œéœ€è¦å…³é—­zygoteåŸæœ‰çš„socketã€‚å¦å¤–ï¼Œå¯¹äºæœ‰ä¸¤ä¸ªzygoteè¿›ç¨‹æƒ…å†µï¼Œéœ€ç­‰å¾…ç¬¬2ä¸ªzygoteåˆ›å»ºå®Œæˆã€‚</p><h4 id="4-3-3ã€Zygote-forkSystemServer"><a href="#4-3-3ã€Zygote-forkSystemServer" class="headerlink" title="4.3.3ã€Zygote. forkSystemServer()"></a>4.3.3ã€Zygote. forkSystemServer()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">forkSystemServer</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> debugFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span>[][] rlimits, <span class="keyword">long</span> permittedCapabilities, <span class="keyword">long</span> effectiveCapabilities)</span> </span>&#123;</span><br><span class="line">    VM_HOOKS.preFork();</span><br><span class="line">    <span class="comment">// è°ƒç”¨nativeæ–¹æ³•fork system_serverè¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">int</span> pid = nativeForkSystemServer(</span><br><span class="line">            uid, gid, gids, debugFlags, rlimits, permittedCapabilities, effectiveCapabilities);</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        Trace.setTracingEnabled(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    VM_HOOKS.postForkCommon();</span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nativeForkSystemServer()æ–¹æ³•åœ¨AndroidRuntime.cppä¸­æ³¨å†Œçš„ï¼Œè°ƒç”¨com_android_internal_os_Zygote.cppä¸­çš„register_com_android_internal_os_Zygote()æ–¹æ³•å»ºç«‹nativeæ–¹æ³•çš„æ˜ å°„å…³ç³»ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è¿›å…¥å¦‚ä¸‹æ–¹æ³•ã€‚</p><h4 id="4-3-4ã€com-android-internal-os-Zygote-nativeForkSystemServer"><a href="#4-3-4ã€com-android-internal-os-Zygote-nativeForkSystemServer" class="headerlink" title="4.3.4ã€com_android_internal_os_Zygote.nativeForkSystemServer()"></a>4.3.4ã€com_android_internal_os_Zygote.nativeForkSystemServer()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        JNIEnv* env, jclass, uid_t uid, gid_t gid, jintArray gids,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint debug_flags, jobjectArray rlimits, jlong permittedCapabilities,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong effectiveCapabilities)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//forkå­è¿›ç¨‹ï¼Œ</span></span><br><span class="line">  pid_t pid = ForkAndSpecializeCommon(env, uid, gid, gids,</span><br><span class="line">                                      debug_flags, rlimits,</span><br><span class="line">                                      permittedCapabilities, effectiveCapabilities,</span><br><span class="line">                                      MOUNT_EXTERNAL_DEFAULT, NULL, NULL, <span class="keyword">true</span>, NULL,</span><br><span class="line">                                      NULL, NULL);</span><br><span class="line">  <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// zygoteè¿›ç¨‹ï¼Œæ£€æµ‹system_serverè¿›ç¨‹æ˜¯å¦åˆ›å»º</span></span><br><span class="line">      gSystemServerPid = pid;</span><br><span class="line">      <span class="keyword">int</span> status;</span><br><span class="line">      <span class="keyword">if</span> (waitpid(pid, &amp;status, WNOHANG) == pid) &#123;</span><br><span class="line">          <span class="comment">//å½“system_serverè¿›ç¨‹æ­»äº¡åï¼Œé‡å¯zygoteè¿›ç¨‹</span></span><br><span class="line">          RuntimeAbort(env);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“system_serverè¿›ç¨‹åˆ›å»ºå¤±è´¥æ—¶ï¼Œå°†ä¼šé‡å¯zygoteè¿›ç¨‹ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¯¹äºAndroid 5.0ä»¥ä¸Šç³»ç»Ÿï¼Œæœ‰ä¸¤ä¸ªzygoteè¿›ç¨‹ï¼Œåˆ†åˆ«æ˜¯zygoteã€zygote64ä¸¤ä¸ªè¿›ç¨‹ï¼Œsystem_serverçš„çˆ¶è¿›ç¨‹ï¼Œä¸€èˆ¬æ¥è¯´64ä½ç³»ç»Ÿå…¶çˆ¶è¿›ç¨‹æ˜¯zygote64è¿›ç¨‹</p><p>å½“kill system_serverè¿›ç¨‹åï¼Œåªé‡å¯zygote64å’Œsystem_serverï¼Œä¸é‡å¯zygote; å½“kill zygote64è¿›ç¨‹åï¼Œåªé‡å¯zygote64å’Œsystem_serverï¼Œä¹Ÿä¸é‡å¯zygoteï¼› å½“kill zygoteè¿›ç¨‹ï¼Œåˆ™é‡å¯zygoteã€zygote64ä»¥åŠsystem_serverã€‚</p><h4 id="4-3-5ã€com-android-internal-os-Zygote-ForkAndSpecializeCommon"><a href="#4-3-5ã€com-android-internal-os-Zygote-ForkAndSpecializeCommon" class="headerlink" title="4.3.5ã€com_android_internal_os_Zygote.ForkAndSpecializeCommon()"></a>4.3.5ã€com_android_internal_os_Zygote.ForkAndSpecializeCommon()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> pid_t <span class="title">ForkAndSpecializeCommon</span><span class="params">(JNIEnv* env, uid_t uid, gid_t gid, jintArray javaGids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jint debug_flags, jobjectArray javaRlimits,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jlong permittedCapabilities, jlong effectiveCapabilities,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jint mount_external,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jstring java_se_info, jstring java_se_name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     bool is_system_server, jintArray fdsToClose,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jstring instructionSet, jstring dataDir)</span> </span>&#123;</span><br><span class="line">  SetSigChldHandler(); <span class="comment">//è®¾ç½®å­è¿›ç¨‹çš„signalä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">  pid_t pid = fork(); <span class="comment">//forkå­è¿›ç¨‹</span></span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//è¿›å…¥å­è¿›ç¨‹</span></span><br><span class="line">    DetachDescriptors(env, fdsToClose); <span class="comment">//å…³é—­å¹¶æ¸…é™¤æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!is_system_server) &#123;</span><br><span class="line">        <span class="comment">//å¯¹äºésystem_serverå­è¿›ç¨‹ï¼Œåˆ™åˆ›å»ºè¿›ç¨‹ç»„</span></span><br><span class="line">        <span class="keyword">int</span> rc = createProcessGroup(uid, getpid());</span><br><span class="line">    &#125;</span><br><span class="line">    SetGids(env, javaGids); <span class="comment">//è®¾ç½®è®¾ç½®group</span></span><br><span class="line">    SetRLimits(env, javaRlimits); <span class="comment">//è®¾ç½®èµ„æºlimit</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rc = setresgid(gid, gid, gid);</span><br><span class="line">    rc = setresuid(uid, uid, uid);</span><br><span class="line"></span><br><span class="line">    SetCapabilities(env, permittedCapabilities, effectiveCapabilities);</span><br><span class="line">    SetSchedulerPolicy(env); <span class="comment">//è®¾ç½®è°ƒåº¦ç­–ç•¥</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">//selinuxä¸Šä¸‹æ–‡</span></span><br><span class="line">    rc = selinux_android_setcontext(uid, is_system_server, se_info_c_str, se_name_c_str);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (se_info_c_str == NULL &amp;&amp; is_system_server) &#123;</span><br><span class="line">      se_name_c_str = <span class="string">"system_server"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (se_info_c_str != NULL) &#123;</span><br><span class="line">      SetThreadName(se_name_c_str); <span class="comment">//è®¾ç½®çº¿ç¨‹åä¸ºsystem_serverï¼Œæ–¹ä¾¿è°ƒè¯•</span></span><br><span class="line">    &#125;</span><br><span class="line">    UnsetSigChldHandler(); <span class="comment">//è®¾ç½®å­è¿›ç¨‹çš„signalä¿¡å·å¤„ç†å‡½æ•°ä¸ºé»˜è®¤å‡½æ•°</span></span><br><span class="line">    <span class="comment">//ç­‰ä»·äºè°ƒç”¨zygote.callPostForkChildHooks()</span></span><br><span class="line">    env-&gt;CallStaticVoidMethod(gZygoteClass, gCallPostForkChildHooks, debug_flags,</span><br><span class="line">                              is_system_server ? NULL : instructionSet);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//è¿›å…¥çˆ¶è¿›ç¨‹ï¼Œå³zygoteè¿›ç¨‹</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fork()åˆ›å»ºæ–°è¿›ç¨‹ï¼Œé‡‡ç”¨copy on writeæ–¹å¼ï¼Œè¿™æ˜¯linuxåˆ›å»ºè¿›ç¨‹çš„æ ‡å‡†æ–¹æ³•ï¼Œä¼šæœ‰ä¸¤æ¬¡return,å¯¹äºpid==0ä¸ºå­è¿›ç¨‹çš„è¿”å›ï¼Œå¯¹äºpid&gt;0ä¸ºçˆ¶è¿›ç¨‹çš„è¿”å›ã€‚ åˆ°æ­¤system_serverè¿›ç¨‹å·²å®Œæˆäº†åˆ›å»ºçš„æ‰€æœ‰å·¥ä½œï¼Œæ¥ä¸‹æ¥å¼€å§‹äº†system_serverè¿›ç¨‹çš„çœŸæ­£å·¥ä½œã€‚åœ¨å‰é¢startSystemServer()æ–¹æ³•ä¸­ï¼Œzygoteè¿›ç¨‹æ‰§è¡Œå®ŒforkSystemServer()åï¼Œæ–°åˆ›å»ºå‡ºæ¥çš„system_serverè¿›ç¨‹ä¾¿è¿›å…¥handleSystemServerProcess()æ–¹æ³•ã€‚</p><h4 id="4-3-5ã€ZygoteInit-handleSystemServerProcess"><a href="#4-3-5ã€ZygoteInit-handleSystemServerProcess" class="headerlink" title="4.3.5ã€ZygoteInit.handleSystemServerProcess()"></a>4.3.5ã€ZygoteInit.handleSystemServerProcess()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleSystemServerProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ZygoteConnection.Arguments parsedArgs)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line"></span><br><span class="line">    closeServerSocket(); <span class="comment">//å…³é—­çˆ¶è¿›ç¨‹zygoteå¤åˆ¶è€Œæ¥çš„Socket</span></span><br><span class="line"></span><br><span class="line">    Os.umask(S_IRWXG | S_IRWXO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Process.setArgV0(parsedArgs.niceName); <span class="comment">//è®¾ç½®å½“å‰è¿›ç¨‹åä¸º"system_server"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String systemServerClasspath = Os.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line">    <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œdexä¼˜åŒ–æ“ä½œ</span></span><br><span class="line">        performSystemServerDexOpt(systemServerClasspath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String[] args = parsedArgs.remainingArgs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String[] amendedArgs = <span class="keyword">new</span> String[args.length + <span class="number">2</span>];</span><br><span class="line">            amendedArgs[<span class="number">0</span>] = <span class="string">"-cp"</span>;</span><br><span class="line">            amendedArgs[<span class="number">1</span>] = systemServerClasspath;</span><br><span class="line">            System.arraycopy(parsedArgs.remainingArgs, <span class="number">0</span>, amendedArgs, <span class="number">2</span>, parsedArgs.remainingArgs.length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¯åŠ¨åº”ç”¨è¿›ç¨‹</span></span><br><span class="line">        WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">                parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">                VMRuntime.getCurrentInstructionSet(), <span class="keyword">null</span>, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ClassLoader cl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            åˆ›å»ºç±»åŠ è½½å™¨ï¼Œå¹¶èµ‹äºˆå½“å‰çº¿ç¨‹</span><br><span class="line">            cl = <span class="keyword">new</span> PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader());</span><br><span class="line">            Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//system_serveræ•…è¿›å…¥æ­¤åˆ†æ”¯</span></span><br><span class="line">        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* should never reach here */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„systemServerClasspathç¯å¢ƒå˜é‡ä¸»è¦æœ‰/system/framework/ç›®å½•ä¸‹çš„services.jarï¼Œethernet-service.jar, wifi-service.jarè¿™3ä¸ªæ–‡ä»¶</p><h4 id="4-3-6ã€ZygoteInit-performSystemServerDexOpt"><a href="#4-3-6ã€ZygoteInit-performSystemServerDexOpt" class="headerlink" title="4.3.6ã€ZygoteInit.performSystemServerDexOpt()"></a>4.3.6ã€ZygoteInit.performSystemServerDexOpt()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performSystemServerDexOpt</span><span class="params">(String classPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String[] classPathElements = classPath.split(<span class="string">":"</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªä¸installdçš„å»ºç«‹socketè¿æ¥</span></span><br><span class="line">    <span class="keyword">final</span> InstallerConnection installer = <span class="keyword">new</span> InstallerConnection();</span><br><span class="line">    <span class="comment">//æ‰§è¡Œpingæ“ä½œï¼Œç›´åˆ°ä¸installdæœåŠ¡ç«¯è¿é€šä¸ºæ­¢</span></span><br><span class="line">    installer.waitForConnection();</span><br><span class="line">    <span class="keyword">final</span> String instructionSet = VMRuntime.getRuntime().vmInstructionSet();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String classPathElement : classPathElements) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(</span><br><span class="line">                    classPathElement, <span class="string">"*"</span>, instructionSet, <span class="keyword">false</span> <span class="comment">/* defer */</span>);</span><br><span class="line">            <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">                <span class="comment">//ä»¥systemæƒé™ï¼Œæ‰§è¡Œdexæ–‡ä»¶ä¼˜åŒ–</span></span><br><span class="line">                installer.dexopt(classPathElement, Process.SYSTEM_UID, <span class="keyword">false</span>,</span><br><span class="line">                        instructionSet, dexoptNeeded);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Error starting system_server"</span>, ioe);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        installer.disconnect(); <span class="comment">//æ–­å¼€ä¸installdçš„socketè¿æ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†classPathå­—ç¬¦ä¸²ä¸­çš„apkï¼Œåˆ†åˆ«è¿›è¡Œdexä¼˜åŒ–æ“ä½œã€‚çœŸæ­£æ‰§è¡Œä¼˜åŒ–å·¥ä½œé€šè¿‡socketé€šä¿¡å°†ç›¸åº”çš„å‘½ä»¤å‚æ•°ï¼Œå‘é€ç»™installdæ¥å®Œæˆã€‚</p><h4 id="4-3-7ã€RuntimeInit-zygoteInit"><a href="#4-3-7ã€RuntimeInit-zygoteInit" class="headerlink" title="4.3.7ã€RuntimeInit.zygoteInit()"></a>4.3.7ã€RuntimeInit.zygoteInit()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"RuntimeInit"</span>);</span><br><span class="line">    redirectLogStreams(); <span class="comment">//é‡å®šå‘logè¾“å‡º</span></span><br><span class="line"></span><br><span class="line">    commonInit(); <span class="comment">// é€šç”¨çš„ä¸€äº›åˆå§‹åŒ–</span></span><br><span class="line">    nativeZygoteInit(); <span class="comment">// zygoteåˆå§‹åŒ–</span></span><br><span class="line">    applicationInit(targetSdkVersion, argv, classLoader); <span class="comment">// åº”ç”¨åˆå§‹åŒ–</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-8ã€RuntimeInit-commonInit"><a href="#4-3-8ã€RuntimeInit-commonInit" class="headerlink" title="4.3.8ã€RuntimeInit.commonInit()"></a>4.3.8ã€RuntimeInit.commonInit()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commonInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®é»˜è®¤çš„æœªæ•æ‰å¼‚å¸¸å¤„ç†æ–¹æ³•</span></span><br><span class="line">    Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">new</span> UncaughtHandler());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å¸‚åŒºï¼Œä¸­å›½æ—¶åŒºä¸º"Asia/Shanghai"</span></span><br><span class="line">    TimezoneGetter.setInstance(<span class="keyword">new</span> TimezoneGetter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> SystemProperties.get(<span class="string">"persist.sys.timezone"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    TimeZone.setDefault(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡ç½®logé…ç½®</span></span><br><span class="line">    LogManager.getLogManager().reset();</span><br><span class="line">    <span class="keyword">new</span> AndroidConfig();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é»˜è®¤çš„HTTP User-agentæ ¼å¼,ç”¨äº HttpURLConnectionã€‚</span></span><br><span class="line">    String userAgent = getDefaultUserAgent();</span><br><span class="line">    System.setProperty(<span class="string">"http.agent"</span>, userAgent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®socketçš„tagï¼Œç”¨äºç½‘ç»œæµé‡ç»Ÿè®¡</span></span><br><span class="line">    NetworkManagementSocketTagger.install();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤çš„HTTP User-agentæ ¼å¼ï¼Œä¾‹å¦‚ï¼š</p><p>â€œDalvik/1.1.0 (Linux; U; Android 6.0.1ï¼›LenovoX3c70 Build/LMY47V)â€.</p><h4 id="4-3-9ã€AndroidRuntime-nativeZygoteInit"><a href="#4-3-9ã€AndroidRuntime-nativeZygoteInit" class="headerlink" title="4.3.9ã€AndroidRuntime.nativeZygoteInit()"></a>4.3.9ã€AndroidRuntime.nativeZygoteInit()</h4><p>nativeZygoteInit()æ–¹æ³•åœ¨AndroidRuntime.cppä¸­ï¼Œè¿›è¡Œäº†jniæ˜ å°„ï¼Œå¯¹åº”ä¸‹é¢çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">com_android_internal_os_RuntimeInit_nativeZygoteInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//æ­¤å¤„çš„gCurRuntimeä¸ºAppRuntimeï¼Œæ˜¯åœ¨AndroidRuntime.cppä¸­å®šä¹‰çš„</span></span><br><span class="line">    gCurRuntime-&gt;onZygoteInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[â€“&gt;app_main.cpp]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">    proc-&gt;startThreadPool(); <span class="comment">//å¯åŠ¨æ–°binderçº¿ç¨‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProcessState::self()æ˜¯å•ä¾‹æ¨¡å¼ï¼Œä¸»è¦å·¥ä½œæ˜¯è°ƒç”¨open()æ‰“å¼€/dev/binderé©±åŠ¨è®¾å¤‡ï¼Œå†åˆ©ç”¨mmap()æ˜ å°„å†…æ ¸çš„åœ°å€ç©ºé—´ï¼Œå°†Binderé©±åŠ¨çš„fdèµ‹å€¼ProcessStateå¯¹è±¡ä¸­çš„å˜é‡mDriverFDï¼Œç”¨äºäº¤äº’æ“ä½œã€‚startThreadPool()æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„binderçº¿ç¨‹ï¼Œä¸æ–­è¿›è¡ŒtalkWithDriver()ï¼Œåœ¨binderç³»åˆ—æ–‡ç« ä¸­çš„<a href="http://gityuan.com/2015/11/14/binder-add-service/" target="_blank" rel="noopener">æ³¨å†ŒæœåŠ¡(addService)</a>è¯¦ç»†è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ‰§è¡ŒåŸç†ã€‚</p><h4 id="4-3-10ã€RuntimeInit-applicationInit"><a href="#4-3-10ã€RuntimeInit-applicationInit" class="headerlink" title="4.3.10ã€RuntimeInit.applicationInit()"></a>4.3.10ã€RuntimeInit.applicationInit()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    <span class="comment">//trueä»£è¡¨åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ä¸è°ƒç”¨AppRuntime.onExit()ï¼Œå¦åˆ™ä¼šåœ¨é€€å‡ºå‰è°ƒç”¨</span></span><br><span class="line">    nativeSetExitWithoutCleanup(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®è™šæ‹Ÿæœºçš„å†…å­˜åˆ©ç”¨ç‡å‚æ•°å€¼ä¸º0.75</span></span><br><span class="line">    VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.75f</span>);</span><br><span class="line">    VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Arguments args;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        args = <span class="keyword">new</span> Arguments(argv); <span class="comment">//è§£æå‚æ•°</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨startClassçš„staticæ–¹æ³• main()</span></span><br><span class="line">    invokeStaticMain(args.startClass, args.startArgs, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨startSystemServer()æ–¹æ³•ä¸­é€šè¿‡ç¡¬ç¼–ç åˆå§‹åŒ–å‚æ•°ï¼Œå¯çŸ¥æ­¤å¤„args.startClassä¸ºâ€com.android.server.SystemServerâ€ã€‚</p><h4 id="4-3-11ã€RuntimeInit-invokeStaticMain"><a href="#4-3-11ã€RuntimeInit-invokeStaticMain" class="headerlink" title="4.3.11ã€RuntimeInit.invokeStaticMain()"></a>4.3.11ã€RuntimeInit.invokeStaticMain()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    Class&lt;?&gt; cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Method m;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> modifiers = m.getModifiers();</span><br><span class="line">    <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡æŠ›å‡ºå¼‚å¸¸ï¼Œå›åˆ°ZygoteInit.main()ã€‚è¿™æ ·åšå¥½å¤„æ˜¯èƒ½æ¸…ç©ºæ ˆå¸§ï¼Œæé«˜æ ˆå¸§åˆ©ç”¨ç‡ã€‚</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-12ã€MethodAndArgsCaller-run"><a href="#4-3-12ã€MethodAndArgsCaller-run" class="headerlink" title="4.3.12ã€MethodAndArgsCaller.run()"></a>4.3.12ã€MethodAndArgsCaller.run()</h4><p>åœ¨Zygoteä¸­é—ç•™äº†ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è®²è§£ï¼Œå¦‚ä¸‹ï¼š</p><p>[â€“&gt;ZygoteInit.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        startSystemServer(abiList, socketName);<span class="comment">//å¯åŠ¨system_server</span></span><br><span class="line">        ....</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">        caller.run();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        closeServerSocket();</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œæ˜¯invokeStaticMain()æ–¹æ³•ä¸­æŠ›å‡ºçš„å¼‚å¸¸MethodAndArgsCallerï¼Œä»è€Œè¿›å…¥caller.run()æ–¹æ³•ã€‚</p><p>[â€“&gt;ZygoteInit.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAndArgsCaller</span> <span class="keyword">extends</span> <span class="title">Exception</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//æ ¹æ®ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œå¯çŸ¥æ­¤å¤„é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨çš„æ˜¯SystemServer.main()æ–¹æ³•</span></span><br><span class="line">            mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            Throwable cause = ex.getCause();</span><br><span class="line">            <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ï¼Œæ€»ç®—æ˜¯è¿›å…¥åˆ°äº†SystemServerç±»çš„main()æ–¹æ³•ï¼Œ åœ¨æ–‡ç« Androidç³»ç»Ÿå¯åŠ¨-SystemServerä¸‹ç¯‡ä¸­ä¼šç´§æ¥ç€è¿™é‡Œå¼€å§‹è®²è¿°ã€‚</p><h3 id="ï¼ˆ4ï¼‰ã€å¯åŠ¨SystemServerä¸‹ç¯‡"><a href="#ï¼ˆ4ï¼‰ã€å¯åŠ¨SystemServerä¸‹ç¯‡" class="headerlink" title="ï¼ˆ4ï¼‰ã€å¯åŠ¨SystemServerä¸‹ç¯‡"></a>ï¼ˆ4ï¼‰ã€å¯åŠ¨SystemServerä¸‹ç¯‡</h3><p>ä¸Šç¯‡æ–‡ç« Androidç³»ç»Ÿå¯åŠ¨-systemServerä¸Šç¯‡ ä»Zygoteä¸€è·¯å¯åŠ¨åˆ°SystemServerçš„è¿‡ç¨‹ã€‚ ç®€å•å›é¡¾ä¸‹ï¼Œåœ¨RuntimeInit.javaä¸­invokeStaticMainæ–¹æ³•é€šè¿‡åˆ›å»ºå¹¶æŠ›å‡ºå¼‚å¸¸ZygoteInit.MethodAndArgsCallerï¼Œåœ¨ZygoteInit.javaä¸­çš„main()æ–¹æ³•ä¼šæ•æ‰è¯¥å¼‚å¸¸ï¼Œå¹¶è°ƒç”¨caller.run()ï¼Œå†é€šè¿‡åå°„ä¾¿ä¼šè°ƒç”¨åˆ°SystemServer.main()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦æ‰§è¡Œæµç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SystemServer.main</span><br><span class="line">    SystemServer.run</span><br><span class="line">        createSystemContext</span><br><span class="line">        startBootstrapServices();</span><br><span class="line">        startCoreServices();</span><br><span class="line">        startOtherServices();</span><br><span class="line">        Looper.loop();</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œä»å…¶mainæ–¹æ³•è¯´èµ·ã€‚</p><h4 id="4-4-1ã€SystemServer-main"><a href="#4-4-1ã€SystemServer-main" class="headerlink" title="4.4.1ã€SystemServer.main()"></a>4.4.1ã€SystemServer.main()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemServer</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å…ˆåˆå§‹åŒ–SystemServerå¯¹è±¡ï¼Œå†è°ƒç”¨å¯¹è±¡çš„run()æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">new</span> SystemServer().run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-4-2ã€SystemServer-run"><a href="#4-4-2ã€SystemServer-run" class="headerlink" title="4.4.2ã€SystemServer.run()"></a>4.4.2ã€SystemServer.run()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å½“ç³»ç»Ÿæ—¶é—´æ¯”1970å¹´æ›´æ—©ï¼Œå°±è®¾ç½®å½“å‰ç³»ç»Ÿæ—¶é—´ä¸º1970å¹´</span></span><br><span class="line">    <span class="keyword">if</span> (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">        SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å˜æ›´è™šæ‹Ÿæœºçš„åº“æ–‡ä»¶ï¼Œå¯¹äºAndroid 6.0é»˜è®¤é‡‡ç”¨çš„æ˜¯libart.so</span></span><br><span class="line">    SystemProperties.set(<span class="string">"persist.sys.dalvik.vm.lib.2"</span>, VMRuntime.getRuntime().vmLibrary());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SamplingProfilerIntegration.isEnabled()) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¸…é™¤vmå†…å­˜å¢é•¿ä¸Šé™ï¼Œç”±äºå¯åŠ¨è¿‡ç¨‹éœ€è¦è¾ƒå¤šçš„è™šæ‹Ÿæœºå†…å­˜ç©ºé—´</span></span><br><span class="line">    VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®å†…å­˜çš„å¯èƒ½æœ‰æ•ˆä½¿ç”¨ç‡ä¸º0.8</span></span><br><span class="line">    VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.8f</span>);</span><br><span class="line">    <span class="comment">// é’ˆå¯¹éƒ¨åˆ†è®¾å¤‡ä¾èµ–äºè¿è¡Œæ—¶å°±äº§ç”ŸæŒ‡çº¹ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦åœ¨å¼€æœºå®Œæˆå‰å·²ç»å®šä¹‰</span></span><br><span class="line">    Build.ensureFingerprintProperty();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¿é—®ç¯å¢ƒå˜é‡å‰ï¼Œéœ€è¦æ˜ç¡®åœ°æŒ‡å®šç”¨æˆ·</span></span><br><span class="line">    Environment.setUserRequired(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¡®ä¿å½“å‰ç³»ç»Ÿè¿›ç¨‹çš„binderè°ƒç”¨ï¼Œæ€»æ˜¯è¿è¡Œåœ¨å‰å°ä¼˜å…ˆçº§(foreground priority)</span></span><br><span class="line">    BinderInternal.disableBackgroundScheduling(<span class="keyword">true</span>);</span><br><span class="line">    android.os.Process.setThreadPriority(android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line">    android.os.Process.setCanSelfBackground(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸»çº¿ç¨‹looperå°±åœ¨å½“å‰çº¿ç¨‹è¿è¡Œ</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åŠ è½½android_servers.soåº“ï¼Œè¯¥åº“åŒ…å«çš„æºç åœ¨frameworks/base/services/ç›®å½•ä¸‹</span></span><br><span class="line">    System.loadLibrary(<span class="string">"android_servers"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ£€æµ‹ä¸Šæ¬¡å…³æœºè¿‡ç¨‹æ˜¯å¦å¤±è´¥ï¼Œè¯¥æ–¹æ³•å¯èƒ½ä¸ä¼šè¿”å›</span></span><br><span class="line">    performPendingShutdown();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ç³»ç»Ÿä¸Šä¸‹æ–‡</span></span><br><span class="line">    createSystemContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºç³»ç»ŸæœåŠ¡ç®¡ç†</span></span><br><span class="line">    mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">    <span class="comment">//å°†mSystemServiceManageræ·»åŠ åˆ°æœ¬åœ°æœåŠ¡çš„æˆå‘˜sLocalServiceObjects</span></span><br><span class="line">    LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨å„ç§ç³»ç»ŸæœåŠ¡</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        startBootstrapServices(); <span class="comment">// å¯åŠ¨å¼•å¯¼æœåŠ¡</span></span><br><span class="line">        startCoreServices();      <span class="comment">// å¯åŠ¨æ ¸å¿ƒæœåŠ¡</span></span><br><span class="line">        startOtherServices();     <span class="comment">// å¯åŠ¨å…¶ä»–æœåŠ¡</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting system services"</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨äºdebugç‰ˆæœ¬ï¼Œå°†logäº‹ä»¶ä¸æ–­å¾ªç¯åœ°è¾“å‡ºåˆ°dropboxï¼ˆç”¨äºåˆ†æï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (StrictMode.conditionallyEnableDebugLogging()) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Enabled StrictMode for system server main thread."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸€ç›´å¾ªç¯æ‰§è¡Œ</span></span><br><span class="line">    Looper.loop();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LocalServicesé€šè¿‡ç”¨é™æ€Mapå˜é‡sLocalServiceObjectsï¼Œæ¥ä¿å­˜ä»¥æœåŠ¡ç±»åä¸ºkeyï¼Œä»¥å…·ä½“æœåŠ¡å¯¹è±¡ä¸ºvalueçš„Mapç»“æ„ã€‚</p><h4 id="4-4-3ã€SystemServer-performPendingShutdown"><a href="#4-4-3ã€SystemServer-performPendingShutdown" class="headerlink" title="4.4.3ã€SystemServer.performPendingShutdown()"></a>4.4.3ã€SystemServer.performPendingShutdown()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performPendingShutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String shutdownAction = SystemProperties.get(</span><br><span class="line">            ShutdownThread.SHUTDOWN_ACTION_PROPERTY, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">if</span> (shutdownAction != <span class="keyword">null</span> &amp;&amp; shutdownAction.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> reboot = (shutdownAction.charAt(<span class="number">0</span>) == <span class="string">'1'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String reason;</span><br><span class="line">        <span class="keyword">if</span> (shutdownAction.length() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            reason = shutdownAction.substring(<span class="number">1</span>, shutdownAction.length());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reason = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“"sys.shutdown.requested"å€¼ä¸ä¸ºç©º,åˆ™ä¼šé‡å¯æˆ–è€…å…³æœº</span></span><br><span class="line">        ShutdownThread.rebootOrShutdown(<span class="keyword">null</span>, reboot, reason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-4-4ã€SystemServer-createSystemContext"><a href="#4-4-4ã€SystemServer-createSystemContext" class="headerlink" title="4.4.4ã€SystemServer.createSystemContext()"></a>4.4.4ã€SystemServer.createSystemContext()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createSystemContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºsystem_serverè¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line">    ActivityThread activityThread = ActivityThread.systemMain();</span><br><span class="line">    mSystemContext = activityThread.getSystemContext();</span><br><span class="line">    <span class="comment">//è®¾ç½®ä¸»é¢˜</span></span><br><span class="line">    mSystemContext.setTheme(android.R.style.Theme_DeviceDefault_Light_DarkActionBar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="http://gityuan.com/2017/04/02/android-application/" target="_blank" rel="noopener">ç†è§£Applicationåˆ›å»ºè¿‡ç¨‹</a>å·²ä»‹ç»è¿‡createSystemContext()è¿‡ç¨‹ï¼Œ è¯¥è¿‡ç¨‹ä¼šåˆ›å»ºå¯¹è±¡æœ‰ActivityThreadï¼ŒInstrumentation, ContextImplï¼ŒLoadedApkï¼ŒApplicationã€‚</p><h4 id="4-4-5ã€SystemServer-startBootstrapServices"><a href="#4-4-5ã€SystemServer-startBootstrapServices" class="headerlink" title="4.4.5ã€SystemServer.startBootstrapServices()"></a>4.4.5ã€SystemServer.startBootstrapServices()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//é˜»å¡ç­‰å¾…ä¸installdå»ºç«‹socketé€šé“</span></span><br><span class="line">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨æœåŠ¡ActivityManagerService</span></span><br><span class="line">    mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">            ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">    mActivityManagerService.setInstaller(installer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨æœåŠ¡PowerManagerService</span></span><br><span class="line">    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–power management</span></span><br><span class="line">    mActivityManagerService.initPowerManagement();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨æœåŠ¡LightsService</span></span><br><span class="line">    mSystemServiceManager.startService(LightsService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨æœåŠ¡DisplayManagerService</span></span><br><span class="line">    mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Phase100: åœ¨åˆå§‹åŒ–package managerä¹‹å‰ï¼Œéœ€è¦é»˜è®¤çš„æ˜¾ç¤º.</span></span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“è®¾å¤‡æ­£åœ¨åŠ å¯†æ—¶ï¼Œä»…è¿è¡Œæ ¸å¿ƒ</span></span><br><span class="line">    String cryptState = SystemProperties.get(<span class="string">"vold.decrypt"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨æœåŠ¡PackageManagerService</span></span><br><span class="line">    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">            mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">    mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">    mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨æœåŠ¡UserManagerServiceï¼Œæ–°å»ºç›®å½•/data/user/</span></span><br><span class="line">    ServiceManager.addService(Context.USER_SERVICE, UserManagerService.getInstance());</span><br><span class="line"></span><br><span class="line">    AttributeCache.init(mSystemContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®AMS</span></span><br><span class="line">    mActivityManagerService.setSystemProcess();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨ä¼ æ„Ÿå™¨æœåŠ¡</span></span><br><span class="line">    startSensorService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ‰€åˆ›å»ºçš„æœåŠ¡ï¼šActivityManagerService, PowerManagerService, LightsService, DisplayManagerServiceï¼Œ PackageManagerServiceï¼Œ UserManagerServiceï¼Œ sensoræœåŠ¡.</p><h4 id="4-4-5ã€SystemServer-startCoreServices"><a href="#4-4-5ã€SystemServer-startCoreServices" class="headerlink" title="4.4.5ã€SystemServer.startCoreServices()"></a>4.4.5ã€SystemServer.startCoreServices()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private void startCoreServices() &#123;</span><br><span class="line">    //å¯åŠ¨æœåŠ¡BatteryServiceï¼Œç”¨äºç»Ÿè®¡ç”µæ± ç”µé‡ï¼Œéœ€è¦LightService.</span><br><span class="line">    mSystemServiceManager.startService(BatteryService.class);</span><br><span class="line"></span><br><span class="line">    //å¯åŠ¨æœåŠ¡UsageStatsServiceï¼Œç”¨äºç»Ÿè®¡åº”ç”¨ä½¿ç”¨æƒ…å†µ</span><br><span class="line">    mSystemServiceManager.startService(UsageStatsService.class);</span><br><span class="line">    mActivityManagerService.setUsageStatsManager(</span><br><span class="line">            LocalServices.getService(UsageStatsManagerInternal.class));</span><br><span class="line"></span><br><span class="line">    mPackageManagerService.getUsageStatsIfNoPackageUsageInfo();</span><br><span class="line"></span><br><span class="line">    //å¯åŠ¨æœåŠ¡WebViewUpdateService</span><br><span class="line">    mSystemServiceManager.startService(WebViewUpdateService.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡BatteryServiceï¼ŒUsageStatsServiceï¼ŒWebViewUpdateServiceã€‚</p><h4 id="4-4-6-SystemServer-startOtherServices"><a href="#4-4-6-SystemServer-startOtherServices" class="headerlink" title="4.4.6 SystemServer.startOtherServices()"></a>4.4.6 SystemServer.startOtherServices()</h4><p>è¯¥æ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæœ‰è¿‘åƒè¡Œä»£ç ï¼Œé€»è¾‘å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯å¯åŠ¨ä¸€ç³»åˆ—çš„æœåŠ¡ï¼Œè¿™é‡Œå°±ä¸å…·ä½“åˆ—ä¸¾æºç äº†ï¼Œåœ¨ç¬¬å››èŠ‚ç›´æ¥å¯¹å…¶ä¸­çš„æœåŠ¡è¿›è¡Œä¸€ä¸ªç®€å•åˆ†ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">       SystemConfig.getInstance();</span><br><span class="line">       mContentResolver = context.getContentResolver(); <span class="comment">// resolver</span></span><br><span class="line">       ...</span><br><span class="line">       mActivityManagerService.installSystemProviders(); <span class="comment">//provider</span></span><br><span class="line">       mSystemServiceManager.startService(AlarmManagerService.class); <span class="comment">// alarm</span></span><br><span class="line">       <span class="comment">// watchdog</span></span><br><span class="line">       watchdog.init(context, mActivityManagerService);</span><br><span class="line">       inputManager = <span class="keyword">new</span> InputManagerService(context); <span class="comment">// input</span></span><br><span class="line">       wm = WindowManagerService.main(...); <span class="comment">// window</span></span><br><span class="line">       inputManager.start();  <span class="comment">//å¯åŠ¨input</span></span><br><span class="line">       mDisplayManagerService.windowManagerAndInputReady();</span><br><span class="line">       ...</span><br><span class="line">       mSystemServiceManager.startService(MOUNT_SERVICE_CLASS); <span class="comment">// mount</span></span><br><span class="line">       mPackageManagerService.performBootDexOpt();  <span class="comment">// dexoptæ“ä½œ</span></span><br><span class="line">       ActivityManagerNative.getDefault().showBootMessage(...); <span class="comment">//æ˜¾ç¤ºå¯åŠ¨ç•Œé¢</span></span><br><span class="line">       ...</span><br><span class="line">       statusBar = <span class="keyword">new</span> StatusBarManagerService(context, wm); <span class="comment">//statusBar</span></span><br><span class="line">       <span class="comment">//dropbox</span></span><br><span class="line">       ServiceManager.addService(Context.DROPBOX_SERVICE,</span><br><span class="line">                   <span class="keyword">new</span> DropBoxManagerService(context, <span class="keyword">new</span> File(<span class="string">"/data/system/dropbox"</span>)));</span><br><span class="line">        mSystemServiceManager.startService(JobSchedulerService.class); <span class="comment">//JobScheduler</span></span><br><span class="line">        lockSettings.systemReady(); <span class="comment">//lockSettings</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//phase480 å’Œphase500</span></span><br><span class="line">       mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class="line">       mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line">       ...</span><br><span class="line">       <span class="comment">// å‡†å¤‡å¥½window, power, package, displayæœåŠ¡</span></span><br><span class="line">       wm.systemReady();</span><br><span class="line">       mPowerManagerService.systemReady(...);</span><br><span class="line">       mPackageManagerService.systemReady();</span><br><span class="line">       mDisplayManagerService.systemReady(...);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//é‡å¤´æˆ</span></span><br><span class="line">       mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             ...</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="4-4-7ã€æœåŠ¡å¯åŠ¨é˜¶æ®µ"><a href="#4-4-7ã€æœåŠ¡å¯åŠ¨é˜¶æ®µ" class="headerlink" title="4.4.7ã€æœåŠ¡å¯åŠ¨é˜¶æ®µ"></a>4.4.7ã€æœåŠ¡å¯åŠ¨é˜¶æ®µ</h4><p>SystemServiceManagerçš„startBootPhase()è´¯ç©¿system_serverè¿›ç¨‹çš„æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N13-android-system-start-system_server_boot_process.jpg" alt="Markdown"></p><p>å…¶ä¸­PHASE_BOOT_COMPLETED=1000ï¼Œè¯¥é˜¶æ®µæ˜¯å‘ç”Ÿåœ¨Bootå®Œæˆå’Œhomeåº”ç”¨å¯åŠ¨å®Œæ¯•ã€‚ç³»ç»ŸæœåŠ¡æ›´å€¾å‘äºç›‘å¬è¯¥é˜¶æ®µï¼Œè€Œä¸æ˜¯æ³¨å†Œå¹¿æ’­ACTION_BOOT_COMPLETEDï¼Œä»è€Œé™ä½ç³»ç»Ÿå»¶è¿Ÿã€‚</p><p>å„ä¸ªå¯åŠ¨é˜¶æ®µæ‰€åœ¨æºç çš„å¤§è‡´ä½ç½®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//phase100</span></span><br><span class="line">  mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startCoreServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//phase480 &amp;&amp; 500</span></span><br><span class="line">  mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class="line">  mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="comment">//phase550</span></span><br><span class="line">         mSystemServiceManager.startBootPhase(</span><br><span class="line">                 SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line">         ...</span><br><span class="line">         <span class="comment">//phase600</span></span><br><span class="line">         mSystemServiceManager.startBootPhase(</span><br><span class="line">                 SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å†è¯´è¯´ç®€å•æ¯ä¸ªé˜¶æ®µçš„å¤§æ¦‚å®Œæˆçš„å·¥ä½œï¼š</p><h5 id="4-4-7-1ã€Phase0"><a href="#4-4-7-1ã€Phase0" class="headerlink" title="4.4.7.1ã€Phase0"></a>4.4.7.1ã€Phase0</h5><p>åˆ›å»ºå››å¤§å¼•å¯¼æœåŠ¡:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ActivityManagerService</span><br><span class="line">PowerManagerService</span><br><span class="line">LightsService</span><br><span class="line">DisplayManagerService</span><br></pre></td></tr></table></figure><h5 id="4-4-7-1-2ã€Phase100"><a href="#4-4-7-1-2ã€Phase100" class="headerlink" title="4.4.7.1.2ã€Phase100"></a>4.4.7.1.2ã€Phase100</h5><p>è¿›å…¥é˜¶æ®µPHASE_WAIT_FOR_DEFAULT_DISPLAY=100å›è°ƒæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onBootPhase(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">DisplayManagerService</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºå¤§é‡æœåŠ¡ä¸‹é¢åˆ—ä¸¾éƒ¨åˆ†:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PackageManagerService</span><br><span class="line">WindowManagerService</span><br><span class="line">InputManagerService</span><br><span class="line">NetworkManagerService</span><br><span class="line">DropBoxManagerService</span><br><span class="line">FingerprintService</span><br><span class="line">LauncherAppsService</span><br><span class="line">â€¦</span><br></pre></td></tr></table></figure><h5 id="4-4-7-1-3ã€Phase480"><a href="#4-4-7-1-3ã€Phase480" class="headerlink" title="4.4.7.1.3ã€Phase480"></a>4.4.7.1.3ã€Phase480</h5><p>è¿›å…¥é˜¶æ®µPHASE_LOCK_SETTINGS_READY=480å›è°ƒæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onBootPhase(<span class="number">480</span>)</span><br><span class="line"></span><br><span class="line">DevicePolicyManagerService</span><br></pre></td></tr></table></figure><p>é˜¶æ®µ480åé©¬ä¸Šå°±è¿›å…¥é˜¶æ®µ500.</p><h5 id="4-4-7-1-4ã€Phase500"><a href="#4-4-7-1-4ã€Phase500" class="headerlink" title="4.4.7.1.4ã€Phase500"></a>4.4.7.1.4ã€Phase500</h5><p>PHASE_SYSTEM_SERVICES_READY=500ï¼Œè¿›å…¥è¯¥é˜¶æ®µæœåŠ¡èƒ½å®‰å…¨åœ°è°ƒç”¨æ ¸å¿ƒç³»ç»ŸæœåŠ¡.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">onBootPhase(<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">AlarmManagerService</span><br><span class="line">JobSchedulerService</span><br><span class="line">NotificationManagerService</span><br><span class="line">BackupManagerService</span><br><span class="line">UsageStatsService</span><br><span class="line">DeviceIdleController</span><br><span class="line">TrustManagerService</span><br><span class="line">UiModeManagerService</span><br><span class="line">BluetoothService</span><br><span class="line">BluetoothManagerService</span><br><span class="line">EthernetService</span><br><span class="line">WifiP2pService</span><br><span class="line">WifiScanningService</span><br><span class="line">WifiService</span><br><span class="line">RttService</span><br></pre></td></tr></table></figure><p>å„å¤§æœåŠ¡æ‰§è¡ŒsystemReady():</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WindowManagerService.systemReady():</span><br><span class="line">PowerManagerService.systemReady():</span><br><span class="line">PackageManagerService.systemReady():</span><br><span class="line">DisplayManagerService.systemReady():</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±ç»ªAMS.systemReadyæ–¹æ³•.</p><h5 id="4-4-7-1-5ã€Phase550"><a href="#4-4-7-1-5ã€Phase550" class="headerlink" title="4.4.7.1.5ã€Phase550"></a>4.4.7.1.5ã€Phase550</h5><p>PHASE_ACTIVITY_MANAGER_READY=550ï¼Œ AMS.mSystemReady=true, å·²å‡†å¤‡å°±ç»ª,è¿›å…¥è¯¥é˜¶æ®µæœåŠ¡èƒ½å¹¿æ’­Intent;ä½†æ˜¯system_serverä¸»çº¿ç¨‹å¹¶æ²¡æœ‰å°±ç»ª.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">onBootPhase(<span class="number">550</span>)</span><br><span class="line"></span><br><span class="line">MountService</span><br><span class="line">TelecomLoaderService</span><br><span class="line">UsbService</span><br><span class="line">WebViewUpdateService</span><br><span class="line">DockObserver</span><br><span class="line">BatteryService</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ‰§è¡Œ: (AMSå¯åŠ¨native crashç›‘æ§, åŠ è½½WebViewï¼Œå¯åŠ¨SystemUIç­‰),å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mActivityManagerService.startObservingNativeCrashes();</span><br><span class="line">WebViewFactory.prepareWebViewInSystemServer();</span><br><span class="line">startSystemUi(context);</span><br><span class="line">networkScoreF.systemReady();</span><br><span class="line">networkManagementF.systemReady();</span><br><span class="line">networkStatsF.systemReady();</span><br><span class="line">networkPolicyF.systemReady();</span><br><span class="line">connectivityF.systemReady();</span><br><span class="line">audioServiceF.systemReady();</span><br><span class="line">Watchdog.getInstance().start();</span><br></pre></td></tr></table></figure><h5 id="4-4-7-1-6ã€Phase600"><a href="#4-4-7-1-6ã€Phase600" class="headerlink" title="4.4.7.1.6ã€Phase600"></a>4.4.7.1.6ã€Phase600</h5><p>PHASE_THIRD_PARTY_APPS_CAN_START=600</p><p>onBootPhase(600)</p><blockquote><p>JobSchedulerService<br>NotificationManagerService<br>BackupManagerService<br>AppWidgetService<br>GestureLauncherService<br>DreamManagerService<br>TrustManagerService<br>VoiceInteractionManagerService</p></blockquote><p>æ¥ä¸‹æ¥,å„ç§æœåŠ¡çš„systemRunningè¿‡ç¨‹:</p><p>WallpaperManagerServiceã€InputMethodManagerServiceã€LocationManagerServiceã€CountryDetectorServiceã€NetworkTimeUpdateServiceã€CommonTimeManagementServiceã€TextServicesManagerServiceã€AssetAtlasServiceã€InputManagerServiceã€TelephonyRegistryã€MediaRouterServiceã€MmsServiceBrokerè¿™äº›æœåŠ¡ä¾æ¬¡æ‰§è¡Œå…¶systemRunning()æ–¹æ³•ã€‚</p><h5 id="4-4-7-1-7ã€Phase1000"><a href="#4-4-7-1-7ã€Phase1000" class="headerlink" title="4.4.7.1.7ã€Phase1000"></a>4.4.7.1.7ã€Phase1000</h5><p>åœ¨ç»è¿‡ä¸€ç³»åˆ—æµç¨‹ï¼Œå†è°ƒç”¨AMS.finishBooting()æ—¶ï¼Œåˆ™è¿›å…¥é˜¶æ®µPhase1000ã€‚</p><p>åˆ°æ­¤ï¼Œç³»ç»ŸæœåŠ¡å¯åŠ¨é˜¶æ®µå®Œæˆå°±ç»ªï¼Œsystem_serverè¿›ç¨‹å¯åŠ¨å®Œæˆåˆ™è¿›å…¥Looper.loop()çŠ¶æ€ï¼Œéšæ—¶å¾…å‘½ï¼Œç­‰å¾…æ¶ˆæ¯é˜Ÿåˆ—MessageQueueä¸­çš„æ¶ˆæ¯åˆ°æ¥ï¼Œåˆ™é©¬ä¸Šè¿›å…¥æ‰§è¡ŒçŠ¶æ€ã€‚</p><h4 id="4-4-8ã€æœåŠ¡ç±»åˆ«"><a href="#4-4-8ã€æœåŠ¡ç±»åˆ«" class="headerlink" title="4.4.8ã€æœåŠ¡ç±»åˆ«"></a>4.4.8ã€æœåŠ¡ç±»åˆ«</h4><p>system_serverè¿›ç¨‹ï¼Œä»æºç è§’åº¦åˆ’åˆ†ä¸ºå¼•å¯¼æœåŠ¡ã€æ ¸å¿ƒæœåŠ¡ã€å…¶ä»–æœåŠ¡3ç±»ã€‚ ä»¥ä¸‹è¿™äº›ç³»ç»ŸæœåŠ¡çš„æ³¨å†Œè¿‡ç¨‹, è§Androidç³»ç»ŸæœåŠ¡çš„æ³¨å†Œæ–¹å¼</p><p>å¼•å¯¼æœåŠ¡(7ä¸ª)ï¼šActivityManagerServiceã€PowerManagerServiceã€LightsServiceã€DisplayManagerServiceã€PackageManagerServiceã€UserManagerServiceã€SensorServiceï¼› æ ¸å¿ƒæœåŠ¡(3ä¸ª)ï¼šBatteryServiceã€UsageStatsServiceã€WebViewUpdateServiceï¼› å…¶ä»–æœåŠ¡(70ä¸ª+)ï¼šAlarmManagerServiceã€VibratorServiceç­‰ã€‚ åˆè®¡æ€»å¤§çº¦80ä¸ªç³»ç»ŸæœåŠ¡ï¼š</p><blockquote><p>ActivityManagerService PackageManagerService WindowManagerService PowerManagerService BatteryService BatteryStatsService DreamManagerService DropBoxManagerService SamplingProfilerService UsageStatsService DiskStatsService DeviceStorageMonitorService SchedulingPolicyService AlarmManagerService DeviceIdleController ThermalObserver JobSchedulerService AccessibilityManagerService DisplayManagerService LightsService GraphicsStatsService StatusBarManagerService NotificationManagerService WallpaperManagerService UiModeManagerService AppWidgetService LauncherAppsService TextServicesManagerService ContentService LockSettingsService InputMethodManagerService InputManagerService MountService FingerprintService TvInputManagerService DockObserver NetworkManagementService NetworkScoreService NetworkStatsService NetworkPolicyManagerService ConnectivityService BluetoothService WifiP2pService WifiService WifiScanningService AudioService MediaRouterService VoiceInteractionManagerService MediaProjectionManagerService MediaSessionService<br><br>DevicePolicyManagerService PrintManagerService BackupManagerService UserManagerService AccountManagerService TrustManagerService SensorService LocationManagerService VibratorService CountryDetectorService GestureLauncherService PersistentDataBlockService EthernetService WebViewUpdateService ClipboardService TelephonyRegistry TelecomLoaderService NsdService UpdateLockService SerialService SearchManagerService CommonTimeManagementService AssetAtlasService ConsumerIrService MidiServiceCameraService TwilightService RestrictionsManagerService MmsServiceBroker RttService UsbService</p></blockquote><p>Serviceç±»åˆ«ä¼—å¤šï¼Œå…¶ä¸­è¡¨ä¸­åŠ ç²—é¡¹æ˜¯æŒ‡åšä¸»æŒ‘é€‰çš„è¾ƒé‡è¦æˆ–è€…è¾ƒå¸¸è§çš„Serviceï¼Œå¹¶ä¸”åœ¨æœ¬åšå®¢ä¸­å·²ç»å±•å¼€æˆ–è€…è®¡åˆ’å±•å¼€è®²è§£çš„Serviceï¼Œå½“ç„¶å¦‚æœæœ‰ç²¾åŠ›ä¼šè®²è§£æ›´å¤šserviceï¼Œåç»­å†æ›´æ–°ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N15-android-system-start-AMS.jpg" alt="Markdown"></p><h3 id="ï¼ˆ5ï¼‰ã€å¯åŠ¨ActivityManagerService"><a href="#ï¼ˆ5ï¼‰ã€å¯åŠ¨ActivityManagerService" class="headerlink" title="ï¼ˆ5ï¼‰ã€å¯åŠ¨ActivityManagerService"></a>ï¼ˆ5ï¼‰ã€å¯åŠ¨ActivityManagerService</h3><h4 id="4-5-1ã€æ¦‚è¿°"><a href="#4-5-1ã€æ¦‚è¿°" class="headerlink" title="4.5.1ã€æ¦‚è¿°"></a>4.5.1ã€æ¦‚è¿°</h4><p>ActivityManagerService(AMS)æ˜¯Androidä¸­æœ€æ ¸å¿ƒçš„æœåŠ¡ï¼Œä¸»è¦è´Ÿè´£ç³»ç»Ÿä¸­å››å¤§ç»„ä»¶çš„å¯åŠ¨ã€åˆ‡æ¢ã€è°ƒåº¦åŠåº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œè°ƒåº¦ç­‰å·¥ä½œã€‚</p><p>AMSé€šä¿¡ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N14-android-system-start-.png" alt="Markdown"></p><h4 id="4-5-2ã€SystemServer-startBootstrapServices"><a href="#4-5-2ã€SystemServer-startBootstrapServices" class="headerlink" title="4.5.2ã€SystemServer.startBootstrapServices()"></a>4.5.2ã€SystemServer.startBootstrapServices()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//å¯åŠ¨AMSæœåŠ¡</span></span><br><span class="line">mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">        ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®AMSçš„ç³»ç»ŸæœåŠ¡ç®¡ç†å™¨</span></span><br><span class="line">mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line"><span class="comment">//è®¾ç½®AMSçš„APPå®‰è£…å™¨</span></span><br><span class="line">mActivityManagerService.setInstaller(installer);</span><br><span class="line"><span class="comment">//åˆå§‹åŒ–AMSç›¸å…³çš„PMS</span></span><br><span class="line">mActivityManagerService.initPowerManagement();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®SystemServer</span></span><br><span class="line">mActivityManagerService.setSystemProcess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-5-3ã€å¯åŠ¨AMSæœåŠ¡"><a href="#4-5-3ã€å¯åŠ¨AMSæœåŠ¡" class="headerlink" title="4.5.3ã€å¯åŠ¨AMSæœåŠ¡"></a>4.5.3ã€å¯åŠ¨AMSæœåŠ¡</h4><p>SystemServiceManager.startService(ActivityManagerService.Lifecycle.class) åŠŸèƒ½ä¸»è¦ï¼š</p><p>åˆ›å»ºActivityManagerService.Lifecycleå¯¹è±¡ï¼› è°ƒç”¨Lifecycle.onStart()æ–¹æ³•ã€‚</p><h4 id="4-5-4ã€å¯åŠ¨AMSæœåŠ¡"><a href="#4-5-4ã€å¯åŠ¨AMSæœåŠ¡" class="headerlink" title="4.5.4ã€å¯åŠ¨AMSæœåŠ¡"></a>4.5.4ã€å¯åŠ¨AMSæœåŠ¡</h4><p><strong>4.5.4.1 AMS.Lifecycle</strong> [-&gt; ActivityManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> <span class="keyword">extends</span> <span class="title">SystemService</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Lifecycle</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    <span class="comment">//åˆ›å»ºActivityManagerService</span></span><br><span class="line">    mService = <span class="keyword">new</span> ActivityManagerService(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mService.start();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityManagerService <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mService;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥è¿‡ç¨‹ï¼šåˆ›å»ºAMSå†…éƒ¨ç±»çš„Lifecycleï¼Œå·²ç»åˆ›å»ºAMSå¯¹è±¡ï¼Œå¹¶è°ƒç”¨AMS.start();</p><p><strong>4.5.4.2 AMSåˆ›å»º</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">mContext = systemContext;</span><br><span class="line">mFactoryTest = FactoryTest.getMode();<span class="comment">//é»˜è®¤ä¸ºFACTORY_TEST_OFF</span></span><br><span class="line">mSystemThread = ActivityThread.currentActivityThread();</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºåä¸º"ActivityManager"çš„å‰å°çº¿ç¨‹ï¼Œå¹¶è·å–mHandler</span></span><br><span class="line">mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG, android.os.Process.THREAD_PRIORITY_FOREGROUND, <span class="keyword">false</span>);</span><br><span class="line">mHandlerThread.start();</span><br><span class="line"></span><br><span class="line">mHandler = <span class="keyword">new</span> MainHandler(mHandlerThread.getLooper());</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡UiThreadç±»ï¼Œåˆ›å»ºåä¸º"android.ui"çš„çº¿ç¨‹</span></span><br><span class="line">mUiHandler = <span class="keyword">new</span> UiHandler();</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‰å°å¹¿æ’­æ¥æ”¶å™¨ï¼Œåœ¨è¿è¡Œè¶…è¿‡10så°†æ”¾å¼ƒæ‰§è¡Œ</span></span><br><span class="line">mFgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">        <span class="string">"foreground"</span>, BROADCAST_FG_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line"><span class="comment">//åå°å¹¿æ’­æ¥æ”¶å™¨ï¼Œåœ¨è¿è¡Œè¶…è¿‡60så°†æ”¾å¼ƒæ‰§è¡Œ</span></span><br><span class="line">mBgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">        <span class="string">"background"</span>, BROADCAST_BG_TIMEOUT, <span class="keyword">true</span>);</span><br><span class="line">mBroadcastQueues[<span class="number">0</span>] = mFgBroadcastQueue;</span><br><span class="line">mBroadcastQueues[<span class="number">1</span>] = mBgBroadcastQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºActiveServicesï¼Œå…¶ä¸­éä½å†…å­˜æ‰‹æœºmMaxStartingBackgroundä¸º8</span></span><br><span class="line">mServices = <span class="keyword">new</span> ActiveServices(<span class="keyword">this</span>);</span><br><span class="line">mProviderMap = <span class="keyword">new</span> ProviderMap(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºç›®å½•/data/system</span></span><br><span class="line">File dataDir = Environment.getDataDirectory();</span><br><span class="line">File systemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">systemDir.mkdirs();</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºæœåŠ¡BatteryStatsService</span></span><br><span class="line">mBatteryStatsService = <span class="keyword">new</span> BatteryStatsService(systemDir, mHandler);</span><br><span class="line">mBatteryStatsService.getActiveStatistics().readLocked();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºè¿›ç¨‹ç»Ÿè®¡æœåŠ¡ï¼Œä¿¡æ¯ä¿å­˜åœ¨ç›®å½•/data/system/procstatsï¼Œ</span></span><br><span class="line">mProcessStats = <span class="keyword">new</span> ProcessStatsService(<span class="keyword">this</span>, <span class="keyword">new</span> File(systemDir, <span class="string">"procstats"</span>));</span><br><span class="line"></span><br><span class="line">mAppOpsService = <span class="keyword">new</span> AppOpsService(<span class="keyword">new</span> File(systemDir, <span class="string">"appops.xml"</span>), mHandler);</span><br><span class="line">mGrantFile = <span class="keyword">new</span> AtomicFile(<span class="keyword">new</span> File(systemDir, <span class="string">"urigrants.xml"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// User 0æ˜¯ç¬¬ä¸€ä¸ªï¼Œä¹Ÿæ˜¯å”¯ä¸€çš„ä¸€ä¸ªå¼€æœºè¿‡ç¨‹ä¸­è¿è¡Œçš„ç”¨æˆ·</span></span><br><span class="line">mStartedUsers.put(UserHandle.USER_OWNER, <span class="keyword">new</span> UserState(UserHandle.OWNER, <span class="keyword">true</span>));</span><br><span class="line">mUserLru.add(UserHandle.USER_OWNER);</span><br><span class="line">updateStartedUserArrayLocked();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//CPUä½¿ç”¨æƒ…å†µçš„è¿½è¸ªå™¨æ‰§è¡Œåˆå§‹åŒ–</span></span><br><span class="line">mProcessCpuTracker.init();</span><br><span class="line">...</span><br><span class="line">mRecentTasks = <span class="keyword">new</span> RecentTasks(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// åˆ›å»ºActivityStackSupervisorå¯¹è±¡</span></span><br><span class="line">mStackSupervisor = <span class="keyword">new</span> ActivityStackSupervisor(<span class="keyword">this</span>, mRecentTasks);</span><br><span class="line">mTaskPersister = <span class="keyword">new</span> TaskPersister(systemDir, mStackSupervisor, mRecentTasks);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºåä¸º"CpuTracker"çš„çº¿ç¨‹</span></span><br><span class="line">mProcessCpuThread = <span class="keyword">new</span> Thread(<span class="string">"CpuTracker"</span>) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">              <span class="keyword">long</span> nextCpuDelay = (mLastCpuTime.get()+MONITOR_CPU_MAX_TIME)-now;</span><br><span class="line">              <span class="keyword">long</span> nextWriteDelay = (mLastWriteTime+BATTERY_STATS_TIME)-now;</span><br><span class="line">              <span class="keyword">if</span> (nextWriteDelay &lt; nextCpuDelay) &#123;</span><br><span class="line">                  nextCpuDelay = nextWriteDelay;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (nextCpuDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                  mProcessCpuMutexFree.set(<span class="keyword">true</span>);</span><br><span class="line">                  <span class="keyword">this</span>.wait(nextCpuDelay);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">          updateCpuStatsNow(); <span class="comment">//æ›´æ–°CPUçŠ¶æ€</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4.5.4.3ã€AMSçš„startå‡½æ•°</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å®Œæˆç»Ÿè®¡å‰çš„å¤ä½å·¥ä½œ</span></span><br><span class="line">    Process.removeAllProcessGroups();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼€å§‹ç›‘æ§è¿›ç¨‹çš„CPUä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">    mProcessCpuThread.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ³¨å†ŒæœåŠ¡</span></span><br><span class="line">    mBatteryStatsService.publish(mContext);</span><br><span class="line">    mAppOpsService.publish(mContext);</span><br><span class="line">    Slog.d(<span class="string">"AppOps"</span>, <span class="string">"AppOpsService published"</span>);</span><br><span class="line">    LocalServices.addService(ActivityManagerInternal.class, <span class="keyword">new</span> LocalService());</span><br></pre></td></tr></table></figure><p>AMSçš„startå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯ï¼š 1ã€å¯åŠ¨CPUç›‘æ§çº¿ç¨‹ã€‚è¯¥çº¿ç¨‹å°†ä¼šå¼€å§‹ç»Ÿè®¡ä¸åŒè¿›ç¨‹ä½¿ç”¨CPUçš„æƒ…å†µã€‚ 2ã€å‘å¸ƒä¸€äº›æœåŠ¡ï¼Œå¦‚BatteryStatsServiceã€AppOpsService(æƒé™ç®¡ç†ç›¸å…³)å’Œæœ¬åœ°å®ç°çš„ç»§æ‰¿ActivityManagerInternalçš„æœåŠ¡ã€‚</p><p><strong>4.5.5 AMS.setSystemProcess()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSystemProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">        ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);</span><br><span class="line">        ServiceManager.addService(<span class="string">"meminfo"</span>, <span class="keyword">new</span> MemBinder(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"gfxinfo"</span>, <span class="keyword">new</span> GraphicsBinder(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"dbinfo"</span>, <span class="keyword">new</span> DbBinder(<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123;</span><br><span class="line">            ServiceManager.addService(<span class="string">"cpuinfo"</span>, <span class="keyword">new</span> CpuBinder(<span class="keyword">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ServiceManager.addService(<span class="string">"permission"</span>, <span class="keyword">new</span> PermissionController(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"processinfo"</span>, <span class="keyword">new</span> ProcessInfoService(<span class="keyword">this</span>));</span><br><span class="line">        ApplicationInfo info = mContext.getPackageManager().getApplicationInfo(</span><br><span class="line">                <span class="string">"android"</span>, STOCK_PM_FLAGS);</span><br><span class="line"></span><br><span class="line">        mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºProcessRecordå¯¹è±¡</span></span><br><span class="line">            ProcessRecord app = newProcessRecordLocked(info, info.processName, <span class="keyword">false</span>, <span class="number">0</span>);</span><br><span class="line">            app.persistent = <span class="keyword">true</span>; <span class="comment">//è®¾ç½®ä¸ºpersistentè¿›ç¨‹</span></span><br><span class="line">            app.pid = MY_PID;</span><br><span class="line">            app.maxAdj = ProcessList.SYSTEM_ADJ;</span><br><span class="line">            app.makeActive(mSystemThread.getApplicationThread(), mProcessStats);</span><br><span class="line">            <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">                mPidsSelfLocked.put(app.pid, app);</span><br><span class="line">            &#125;</span><br><span class="line">            updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);<span class="comment">//ç»´æŠ¤è¿›ç¨‹lru</span></span><br><span class="line">            updateOomAdjLocked(); <span class="comment">//æ›´æ–°adj</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">""</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸»è¦å·¥ä½œæ˜¯æ³¨å†Œå„ç§æœåŠ¡ã€‚</p><p><strong>4.5.5.1 AT.installSystemApplicationInfo()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installSystemApplicationInfo</span><span class="params">(ApplicationInfo info, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        getSystemContext().installSystemApplicationInfo(info, classLoader);</span><br><span class="line">        <span class="comment">//åˆ›å»ºç”¨äºæ€§èƒ½ç»Ÿè®¡çš„Profilerå¯¹è±¡</span></span><br><span class="line">        mProfiler = <span class="keyword">new</span> Profiler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•è°ƒç”¨ContextImplçš„nstallSystemApplicationInfo()æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨LoadedApkçš„installSystemApplicationInfoï¼ŒåŠ è½½åä¸ºâ€androidâ€çš„package</p><p><strong>4.5.5.2 installSystemApplicationInfo()</strong> [-&gt; LoadedApk.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installSystemApplicationInfo</span><span class="params">(ApplicationInfo info, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> info.packageName.equals(<span class="string">"android"</span>);</span><br><span class="line">    mApplicationInfo = info; <span class="comment">//å°†åŒ…åä¸º"android"çš„åº”ç”¨ä¿¡æ¯ä¿å­˜åˆ°mApplicationInfo</span></span><br><span class="line">    mClassLoader = classLoader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4.5.6 startOtherServices()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//å®‰è£…ç³»ç»ŸProvider</span></span><br><span class="line">  mActivityManagerService.installSystemProviders();</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">//phase480 &amp;&amp; 500</span></span><br><span class="line">  mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class="line">  mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="comment">//phase550</span></span><br><span class="line">         mSystemServiceManager.startBootPhase(</span><br><span class="line">                 SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line">         ...</span><br><span class="line">         <span class="comment">//phase600</span></span><br><span class="line">         mSystemServiceManager.startBootPhase(</span><br><span class="line">                 SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);</span><br><span class="line">         ...</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4.5.6.1 AMS.installSystemProviders()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installSystemProviders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;ProviderInfo&gt; providers;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ProcessRecord app = mProcessNames.get(<span class="string">"system"</span>, Process.SYSTEM_UID);</span><br><span class="line">        providers = generateApplicationProvidersLocked(app);</span><br><span class="line">        <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=providers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProviderInfo pi = (ProviderInfo)providers.get(i);</span><br><span class="line">                <span class="comment">//ç§»é™¤éç³»ç»Ÿçš„provider</span></span><br><span class="line">                <span class="keyword">if</span> ((pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                    providers.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å®‰è£…æ‰€æœ‰çš„ç³»ç»Ÿprovider</span></span><br><span class="line">        mSystemThread.installSystemProviders(providers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ ¸å¿ƒSettings Observerï¼Œç”¨äºç›‘æ§Settingsçš„æ”¹å˜ã€‚</span></span><br><span class="line">    mCoreSettingsObserver = <span class="keyword">new</span> CoreSettingsObserver(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-5-7ã€AMS-systemReady"><a href="#4-5-7ã€AMS-systemReady" class="headerlink" title="4.5.7ã€AMS.systemReady()"></a>4.5.7ã€AMS.systemReady()</h4><h4 id="4-5-7-1ã€é˜¶æ®µä¸€"><a href="#4-5-7-1ã€é˜¶æ®µä¸€" class="headerlink" title="4.5.7.1ã€é˜¶æ®µä¸€"></a>4.5.7.1ã€é˜¶æ®µä¸€</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        ..........</span><br><span class="line">        <span class="comment">//è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è°ƒç”¨ä¸€äº›å…³é”®æœåŠ¡SystemReadyç›¸å…³çš„å‡½æ•°ï¼Œ</span></span><br><span class="line">        <span class="comment">//è¿›è¡Œä¸€äº›ç­‰å¾…AMSåˆå§‹å®Œï¼Œæ‰èƒ½è¿›è¡Œçš„å·¥ä½œ</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure we have the current profile info, since it is needed for security checks.</span></span><br><span class="line">        mUserController.onSystemReady();</span><br><span class="line"></span><br><span class="line">        mRecentTasks.onSystemReadyLocked();</span><br><span class="line">        mAppOpsService.systemReady();</span><br><span class="line">        mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;ProcessRecord&gt; procsToKill = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(mPidsSelfLocked) &#123;</span><br><span class="line">        <span class="comment">//mPidsSelfLockedä¸­ä¿å­˜å½“å‰æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=mPidsSelfLocked.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">            ProcessRecord proc = mPidsSelfLocked.valueAt(i);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//åœ¨AMSå¯åŠ¨å®Œæˆå‰ï¼Œå¦‚æœæ²¡æœ‰FLAG_PERSISTENTæ ‡å¿—çš„è¿›ç¨‹å·²ç»å¯åŠ¨äº†ï¼Œ</span></span><br><span class="line">            <span class="comment">//å°±å°†è¿™ä¸ªè¿›ç¨‹åŠ å…¥åˆ°procsToKillä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (!isAllowedWhileBooting(proc.info))&#123;</span><br><span class="line">                <span class="keyword">if</span> (procsToKill == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    procsToKill = <span class="keyword">new</span> ArrayList&lt;ProcessRecord&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                procsToKill.add(proc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//åˆ©ç”¨removeProcessLockedå…³é—­procsToKillä¸­çš„è¿›ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (procsToKill != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=procsToKill.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProcessRecord proc = procsToKill.get(i);</span><br><span class="line">                Slog.i(TAG, <span class="string">"Removing system update proc: "</span> + proc);</span><br><span class="line">                removeProcessLocked(proc, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"system update done"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now that we have cleaned up any update processes, we</span></span><br><span class="line">        <span class="comment">// are ready to start launching real processes and know that</span></span><br><span class="line">        <span class="comment">// we won't trample on them any more.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//è‡³æ­¤ç³»ç»Ÿå‡†å¤‡å®Œæ¯•</span></span><br><span class="line">        mProcessesReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ............</span><br><span class="line">    <span class="comment">//æ ¹æ®æ•°æ®åº“å’Œèµ„æºæ–‡ä»¶ï¼Œè·å–ä¸€äº›é…ç½®å‚æ•°</span></span><br><span class="line">    retrieveSettings();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> currentUserId;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//å¾—åˆ°å½“å‰çš„ç”¨æˆ·ID</span></span><br><span class="line">        currentUserId = mUserController.getCurrentUserIdLocked();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¯»å–urigrants.xmlï¼Œä¸ºå…¶ä¸­å®šä¹‰çš„ContentProvideré…ç½®å¯¹æŒ‡å®šUriæ•°æ®çš„è®¿é—®/ä¿®æ”¹æƒé™</span></span><br><span class="line">        <span class="comment">//åŸç”Ÿä»£ç ä¸­ï¼Œä¼¼ä¹æ²¡æœ‰urigrants.xmlæ–‡ä»¶</span></span><br><span class="line">        <span class="comment">//å®é™…ä½¿ç”¨çš„grant-uri-permissionæ˜¯åˆ†å¸ƒå¼å®šä¹‰çš„</span></span><br><span class="line">        readGrantedUriPermissionsLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    ..........</span><br></pre></td></tr></table></figure><p>è¿™ä¸€éƒ¨åˆ†çš„å·¥ä½œä¸»è¦æ˜¯è°ƒç”¨ä¸€äº›å…³é”®æœåŠ¡çš„åˆå§‹åŒ–å‡½æ•°ï¼Œ ç„¶åæ€æ­»é‚£äº›æ²¡æœ‰FLAG_PERSISTENTå´åœ¨AMSå¯åŠ¨å®Œæˆå‰å·²ç»å­˜åœ¨çš„è¿›ç¨‹ï¼Œ åŒæ—¶è·å–ä¸€äº›é…ç½®å‚æ•°ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºåªæœ‰Javaè¿›ç¨‹æ‰ä¼šå‘AMSæ³¨å†Œï¼Œè€Œä¸€èˆ¬çš„Nativeè¿›ç¨‹ä¸ä¼šå‘AMSæ³¨å†Œï¼Œå› æ­¤æ­¤å¤„æ€æ­»çš„è¿›ç¨‹æ˜¯Javaè¿›ç¨‹ã€‚</p><h4 id="4-5-7-2ã€é˜¶æ®µäºŒ"><a href="#4-5-7-2ã€é˜¶æ®µäºŒ" class="headerlink" title="4.5.7.2ã€é˜¶æ®µäºŒ"></a>4.5.7.2ã€é˜¶æ®µäºŒ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1ã€è°ƒç”¨å‚æ•°ä¼ å…¥çš„runnableå¯¹è±¡ï¼ŒSystemServerä¸­æœ‰å…·ä½“çš„å®šä¹‰</span></span><br><span class="line"><span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) goingCallback.run();</span><br><span class="line">..............</span><br><span class="line"><span class="comment">//è°ƒç”¨æ‰€æœ‰ç³»ç»ŸæœåŠ¡çš„onStartUseræ¥å£</span></span><br><span class="line">mSystemServiceManager.startUser(currentUserId);</span><br><span class="line">.............</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="comment">// Only start up encryption-aware persistent apps; once user is</span></span><br><span class="line">    <span class="comment">// unlocked we'll come back around and start unaware apps</span></span><br><span class="line">    <span class="number">2</span>ã€å¯åŠ¨persistentä¸º<span class="number">1</span>çš„applicationæ‰€åœ¨çš„è¿›ç¨‹</span><br><span class="line">    startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start up initial activity.</span></span><br><span class="line">    mBooting = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable home activity for system user, so that the system can always boot</span></span><br><span class="line">    <span class="comment">//å½“isSplitSystemUserè¿”å›trueæ—¶ï¼Œæ„å‘³è€…system userå’Œprimary useræ˜¯åˆ†ç¦»çš„</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œåº”è¯¥æ˜¯è®©system userä¹Ÿæœ‰å¯åŠ¨home activityçš„æƒé™å§</span></span><br><span class="line">    <span class="keyword">if</span> (UserManager.isSplitSystemUser()) &#123;</span><br><span class="line">        ComponentName cName = <span class="keyword">new</span> ComponentName(mContext, SystemUserHomeActivity.class);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AppGlobals.getPackageManager().setComponentEnabledSetting(cName,</span><br><span class="line">                    PackageManager.COMPONENT_ENABLED_STATE_ENABLED, <span class="number">0</span>,</span><br><span class="line">                    UserHandle.USER_SYSTEM);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3ã€å¯åŠ¨Home</span></span><br><span class="line">    startHomeActivityLocked(currentUserId, <span class="string">"systemReady"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å‘é€æ¶ˆæ¯ï¼Œè§¦å‘å¤„ç†Uidé”™è¯¯çš„Application</span></span><br><span class="line">        <span class="keyword">if</span> (AppGlobals.getPackageManager().hasSystemUidErrors()) &#123;</span><br><span class="line">            ..........</span><br><span class="line">            mUiHandler.obtainMessage(SHOW_UID_ERROR_UI_MSG).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘é€ä¸€äº›å¹¿æ’­ä¿¡æ¯</span></span><br><span class="line">    ............</span><br><span class="line">    <span class="comment">//è¿™é‡Œæš‚æ—¶å…ˆä¸æ·±å…¥ï¼Œç­‰è¿›ä¸€æ­¥äº†è§£Activityçš„å¯åŠ¨è¿‡ç¨‹åï¼Œå†åšäº†è§£</span></span><br><span class="line">    mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">    ............</span><br><span class="line">&#125;</span><br><span class="line">.............</span><br></pre></td></tr></table></figure><p>ä»éƒ¨åˆ†ä»£ç æ¥çœ‹ï¼Œä¸»è¦çš„å·¥ä½œå°±æ˜¯é€šçŸ¥ä¸€äº›æœåŠ¡å¯ä»¥è¿›è¡ŒsystemReadyç›¸å…³çš„å·¥ä½œï¼Œå¹¶è¿›è¡Œå¯åŠ¨æœåŠ¡æˆ–åº”ç”¨è¿›ç¨‹çš„å·¥ä½œã€‚</p><h4 id="2-1ã€è°ƒç”¨å›è°ƒæ¥å£"><a href="#2-1ã€è°ƒç”¨å›è°ƒæ¥å£" class="headerlink" title="2.1ã€è°ƒç”¨å›è°ƒæ¥å£"></a>2.1ã€è°ƒç”¨å›è°ƒæ¥å£</h4><p>å›è°ƒæ¥å£çš„å…·ä½“å†…å®¹å®šä¹‰ä¸SystemServer.javaä¸­ï¼Œå…¶ä¸­ä¼šè°ƒç”¨å¤§é‡æœåŠ¡çš„onBootPhaseå‡½æ•°ã€ä¸€äº›å¯¹è±¡çš„systemReadyå‡½æ•°æˆ–systemRunningå‡½æ•°ã€‚ æ­¤å¤„ï¼Œæˆ‘ä»¬ä»…æˆªå–ä¸€äº›æ¯”è¾ƒç‰¹åˆ«çš„å†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ............</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¯åŠ¨NativeCrashListenerç›‘å¬"/data/system/ndebugsocket"ä¸­çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="comment">//å®é™…ä¸Šæ˜¯ç›‘å¬debuggerdä¼ å…¥çš„ä¿¡æ¯</span></span><br><span class="line">        mActivityManagerService.startObservingNativeCrashes();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        reportWtf(<span class="string">"observing native crashes"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    ............</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¯åŠ¨SystemUi</span></span><br><span class="line">        startSystemUi(context);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        reportWtf(<span class="string">"starting System UI"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    ............</span><br><span class="line">    <span class="comment">//è¿™ä¸ªä»¥å‰åˆ†æè¿‡ï¼Œå¯åŠ¨Watchdog</span></span><br><span class="line">    Watchdog.getInstance().start();</span><br><span class="line">    ....................</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›è°ƒæ¥å£ä¸­çš„å†…å®¹è¾ƒå¤šï¼Œä¸åšä¸€ä¸€åˆ†æã€‚</p><h4 id="2-2ã€å¯åŠ¨persistentæ ‡å¿—çš„è¿›ç¨‹"><a href="#2-2ã€å¯åŠ¨persistentæ ‡å¿—çš„è¿›ç¨‹" class="headerlink" title="2.2ã€å¯åŠ¨persistentæ ‡å¿—çš„è¿›ç¨‹"></a>2.2ã€å¯åŠ¨persistentæ ‡å¿—çš„è¿›ç¨‹</h4><p>æˆ‘ä»¬çœ‹çœ‹startPersistentAppså¯¹åº”çš„å†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startPersistentApps</span><span class="params">(<span class="keyword">int</span> matchFlags)</span> </span>&#123;</span><br><span class="line">    .............</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ä»PKMSä¸­å¾—åˆ°persistentä¸º1çš„ApplicationInfo</span></span><br><span class="line">            <span class="keyword">final</span> List&lt;ApplicationInfo&gt; apps = AppGlobals.getPackageManager()</span><br><span class="line">                    .getPersistentApplications(STOCK_PM_FLAGS | matchFlags).getList();</span><br><span class="line">            <span class="keyword">for</span> (ApplicationInfo app : apps) &#123;</span><br><span class="line">                <span class="comment">//ç”±äºframework-res.apkå·²ç»ç”±ç³»ç»Ÿå¯åŠ¨ï¼Œæ‰€ä»¥æ­¤å¤„ä¸å†å¯åŠ¨å®ƒ</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">"android"</span>.equals(app.packageName)) &#123;</span><br><span class="line">                    <span class="comment">//addAppLockedä¸­å°†å¯åŠ¨applicationæ‰€åœ¨è¿›ç¨‹</span></span><br><span class="line">                    addAppLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span> <span class="comment">/* ABI override */</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›ä¸€ä¸‹addAppLockedå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">addAppLocked</span><span class="params">(ApplicationInfo info, <span class="keyword">boolean</span> isolated,</span></span></span><br><span class="line"><span class="function"><span class="params">        String abiOverride)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ä»¥ä¸‹æ˜¯å–å‡ºæˆ–æ„é€ å‡ºApplicationInfoå¯¹åº”çš„ProcessRecord</span></span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">        app = getProcessRecordLocked(info.processName, info.uid, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">        app = newProcessRecordLocked(info, <span class="keyword">null</span>, isolated, <span class="number">0</span>);</span><br><span class="line">        updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        updateOomAdjLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    ...........</span><br><span class="line">    <span class="comment">// This package really, really can not be stopped.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡PKMSå°†packageå¯¹åº”æ•°æ®ç»“æ„çš„StoppedStateç½®ä¸ºfasle</span></span><br><span class="line">        AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">                info.packageName, <span class="keyword">false</span>, UserHandle.getUserId(app.uid));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed trying to unstop package "</span></span><br><span class="line">                + info.packageName + <span class="string">": "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">        app.persistent = <span class="keyword">true</span>;</span><br><span class="line">        app.maxAdj = ProcessList.PERSISTENT_PROC_ADJ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.thread == <span class="keyword">null</span> &amp;&amp; mPersistentStartingProcesses.indexOf(app) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        mPersistentStartingProcesses.add(app);</span><br><span class="line">        <span class="comment">//å¯åŠ¨åº”ç”¨æ‰€åœ¨è¿›ç¨‹ï¼Œå°†å‘é€æ¶ˆæ¯ç»™zygoteï¼Œåè€…forkå‡ºè¿›ç¨‹</span></span><br><span class="line">        startProcessLocked(app, <span class="string">"added application"</span>, app.processName, abiOverride,</span><br><span class="line">                <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>, <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€ç»ˆå°†é€šè¿‡startProcessLockedå‡½æ•°ï¼Œå¯åŠ¨å®é™…çš„åº”ç”¨è¿›ç¨‹ã€‚ æ­£å¦‚ä¹‹å‰åˆ†æzygoteè¿›ç¨‹æ—¶ï¼Œæè¿‡çš„ä¸€æ ·ï¼Œzygoteä¸­çš„server socketå°†æ¥æ”¶æ¶ˆæ¯ï¼Œç„¶åä¸ºåº”ç”¨forkå‡ºè¿›ç¨‹ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>å¯¹äºæ•´ä¸ªAMSå¯åŠ¨è¿‡ç¨‹è€Œè¨€ï¼Œåšå®¢ä¸­æ¶‰åŠçš„å†…å®¹å¯èƒ½åªæ˜¯æå°çš„ä¸€éƒ¨åˆ†ã€‚ ä½†å³ä½¿æˆ‘ä»¬å°½å¯èƒ½çš„ç®€åŒ–ï¼Œæ•´ä¸ªè¿‡ç¨‹çš„å†…å®¹è¿˜æ˜¯éå¸¸å¤šã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.boot/N16-android-system-start-flow.jpg" alt="Markdown"><br>ä¸è¿‡æˆ‘ä»¬å›å¤´çœ‹çœ‹æ•´ä¸ªè¿‡ç¨‹ï¼Œè¿˜æ˜¯èƒ½æ¯”è¾ƒæ¸…æ™°åœ°å°†AMSçš„å¯åŠ¨è¿‡ç¨‹åˆ†ä¸ºå››æ­¥ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼š 1ã€åˆ›å»ºå‡ºSystemServerè¿›ç¨‹çš„Androidè¿è¡Œç¯å¢ƒã€‚ åœ¨è¿™ä¸€éƒ¨åˆ†ï¼ŒSystemServerè¿›ç¨‹ä¸»è¦åˆ›å»ºå‡ºå¯¹åº”çš„ActivityThreadå’ŒContextImplï¼Œæ„æˆAndroidè¿è¡Œç¯å¢ƒã€‚ AMSçš„åç»­å·¥ä½œä¾èµ–äºSystemServeråœ¨æ­¤åˆ›å»ºå‡ºçš„è¿è¡Œç¯å¢ƒã€‚</p><p>2ã€å®ŒæˆAMSçš„åˆå§‹åŒ–å’Œå¯åŠ¨ã€‚ åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œå•çº¯åœ°è°ƒç”¨AMSçš„æ„é€ å‡½æ•°å’Œstartå‡½æ•°ï¼Œå®ŒæˆAMSçš„ä¸€äº›åˆå§‹åŒ–å·¥ä½œã€‚</p><p>3ã€å°†SystemServerè¿›ç¨‹çº³å…¥åˆ°AMSçš„ç®¡ç†ä½“ç³»ä¸­ã€‚ AMSä½œä¸ºJavaä¸–ç•Œçš„è¿›ç¨‹ç®¡ç†å’Œè°ƒåº¦ä¸­å¿ƒï¼Œè¦å¯¹æ‰€æœ‰Javaè¿›ç¨‹ä¸€è§†åŒä»ï¼Œå› æ­¤SystemServerè¿›ç¨‹ä¹Ÿå¿…é¡»è¢«AMSç®¡ç†ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒAMSåŠ è½½äº†SystemServerä¸­framework-res.apkçš„ä¿¡æ¯ï¼Œå¹¶å¯åŠ¨å’Œæ³¨å†Œäº†SettingsProvider.apkã€‚</p><p>4ã€å¼€å§‹æ‰§è¡ŒAMSå¯åŠ¨å®Œæ¯•åæ‰èƒ½è¿›è¡Œçš„å·¥ä½œã€‚ ç³»ç»Ÿä¸­çš„ä¸€äº›æœåŠ¡å’Œè¿›ç¨‹ï¼Œå¿…é¡»ç­‰å¾…AMSå®Œæˆå¯åŠ¨åï¼Œæ‰èƒ½å±•å¼€åç»­å·¥ä½œã€‚ åœ¨è¿™ä¸€éƒ¨åˆ†ï¼ŒAMSé€šè¿‡è°ƒç”¨systemReadyå‡½æ•°ï¼Œé€šçŸ¥ç³»ç»Ÿä¸­çš„å…¶å®ƒæœåŠ¡å’Œè¿›ç¨‹ï¼Œå¯ä»¥è¿›è¡Œå¯¹åº”å·¥ä½œäº†ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå€¼å¾—æˆ‘ä»¬å…³æ³¨çš„æ˜¯ï¼šHome Activityè¢«å¯åŠ¨äº†ã€‚å½“è¯¥Activityè¢«åŠ è½½å®Œæˆåï¼Œæœ€ç»ˆä¼šè§¦å‘ACTION_BOOT_COMPLETEDå¹¿æ’­ã€‚</p><h4 id="ï¼ˆ6ï¼‰ã€å¯åŠ¨Launcher-Activity"><a href="#ï¼ˆ6ï¼‰ã€å¯åŠ¨Launcher-Activity" class="headerlink" title="ï¼ˆ6ï¼‰ã€å¯åŠ¨Launcher(Activity)"></a>ï¼ˆ6ï¼‰ã€å¯åŠ¨Launcher(Activity)</h4><p>çœ‹çœ‹å¯åŠ¨Home Activityå¯¹åº”çš„startHomeActivityLockedå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeActivityLocked</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line">    ..............</span><br><span class="line">    Intent intent = getHomeIntent();</span><br><span class="line">    <span class="comment">//æ ¹æ®intentä¸­æºå¸¦çš„ComponentNameï¼Œåˆ©ç”¨PKMSå¾—åˆ°ActivityInfo</span></span><br><span class="line">    ActivityInfo aInfo = resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);</span><br><span class="line">    <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        intent.setComponent(<span class="keyword">new</span> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">        aInfo = <span class="keyword">new</span> ActivityInfo(aInfo);</span><br><span class="line">        aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ­¤æ—¶homeå¯¹åº”è¿›ç¨‹åº”è¯¥è¿˜æ²¡å¯åŠ¨ï¼Œappä¸ºnull</span></span><br><span class="line">        ProcessRecord app = getProcessRecordLocked(aInfo.processName,</span><br><span class="line">                aInfo.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span> || app.instrumentationClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">            <span class="comment">//å¯åŠ¨home</span></span><br><span class="line">            mActivityStarter.startHomeActivityLocked(intent, aInfo, reason);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ..........</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæš‚æ—¶å…ˆä¸æ·±ç©¶Home Activityå¯åŠ¨çš„å…·ä½“è¿‡ç¨‹ã€‚ ä»æ‰‹å¤´çš„èµ„æ–™æ¥çœ‹ï¼Œå½“Home Activityå¯åŠ¨åï¼Œ ActivityStackSupervisorä¸­çš„activityIdleInternalLockedå‡½æ•°å°†è¢«è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ActivityRecord <span class="title">activityIdleInternalLocked</span><span class="params">(<span class="keyword">final</span> IBinder token, <span class="keyword">boolean</span> fromTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config)</span> </span>&#123;</span><br><span class="line">    ...........</span><br><span class="line">    <span class="keyword">if</span> (isFocusedStack(r.task.stack) || fromTimeout) &#123;</span><br><span class="line">        booting = checkFinishBootingLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    ............</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨checkFinishBootingLockedå‡½æ•°ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkFinishBootingLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//mServiceä¸ºAMSï¼ŒmBootingå˜é‡åœ¨AMSå›è°ƒSystemServerä¸­å®šä¹‰çš„Runnableæ—¶ï¼Œç½®ä¸ºäº†true</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> booting = mService.mBooting;</span><br><span class="line">    <span class="keyword">boolean</span> enableScreen = <span class="keyword">false</span>;</span><br><span class="line">    mService.mBooting = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mService.mBooted) &#123;</span><br><span class="line">        mService.mBooted = <span class="keyword">true</span>;</span><br><span class="line">        enableScreen = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (booting || enableScreen) &#123;ã€</span><br><span class="line">        <span class="comment">//è°ƒç”¨AMSçš„æ¥å£ï¼Œå‘é€æ¶ˆæ¯</span></span><br><span class="line">        mService.postFinishBooting(booting, enableScreen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> booting;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆï¼ŒAMSçš„finishBootingå‡½æ•°å°†è¢«è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finishBooting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    .........</span><br><span class="line">    <span class="comment">//ä»¥ä¸‹æ˜¯æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ï¼Œç”¨äºå¤„ç†éœ€è¦é‡å¯çš„package</span></span><br><span class="line">    IntentFilter pkgFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">    pkgFilter.addAction(Intent.ACTION_QUERY_PACKAGE_RESTART);</span><br><span class="line">    pkgFilter.addDataScheme(<span class="string">"package"</span>);</span><br><span class="line">    mContext.registerReceiver(<span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            String[] pkgs = intent.getStringArrayExtra(Intent.EXTRA_PACKAGES);</span><br><span class="line">            <span class="keyword">if</span> (pkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String pkg : pkgs) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (forceStopPackageLocked(pkg, -<span class="number">1</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                                <span class="number">0</span>, <span class="string">"query restart"</span>)) &#123;</span><br><span class="line">                            setResultCode(Activity.RESULT_OK);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;, pkgFilter);</span><br><span class="line">    ...........</span><br><span class="line">    <span class="comment">// Let system services know.</span></span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_BOOT_COMPLETED);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»¥ä¸‹æ˜¯å¯åŠ¨é‚£äº›ç­‰å¾…å¯åŠ¨çš„è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// Ensure that any processes we had put on hold are now started</span></span><br><span class="line">        <span class="comment">// up.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> NP = mProcessesOnHold.size();</span><br><span class="line">            <span class="keyword">if</span> (NP &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ArrayList&lt;ProcessRecord&gt; procs =</span><br><span class="line">                        <span class="keyword">new</span> ArrayList&lt;ProcessRecord&gt;(mProcessesOnHold);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> ip=<span class="number">0</span>; ip&lt;NP; ip++) &#123;</span><br><span class="line">                    .................</span><br><span class="line">                    startProcessLocked(procs.get(ip), <span class="string">"on-hold"</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ..............</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">        <span class="comment">// Start looking for apps that are abusing wake locks.</span></span><br><span class="line">        <span class="comment">//æ¯15minæ£€æŸ¥ä¸€æ¬¡ç³»ç»Ÿå„åº”ç”¨è¿›ç¨‹ä½¿ç”¨ç”µé‡çš„æƒ…å†µï¼Œå¦‚æœæŸä¸ªè¿›ç¨‹ä½¿ç”¨WakeLockçš„æ—¶é—´è¿‡é•¿</span></span><br><span class="line">        <span class="comment">//AMSå°†å…³é—­è¯¥è¿›ç¨‹</span></span><br><span class="line">        Message nmsg = mHandler.obtainMessage(CHECK_EXCESSIVE_WAKE_LOCKS_MSG);</span><br><span class="line">        mHandler.sendMessageDelayed(nmsg, POWER_CHECK_DELAY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell anyone interested that we are done booting!</span></span><br><span class="line">        SystemProperties.set(<span class="string">"sys.boot_completed"</span>, <span class="string">"1"</span>);</span><br><span class="line">        .................</span><br><span class="line">        <span class="comment">//æ­¤å¤„ä»ä»£ç æ¥çœ‹å‘é€çš„æ˜¯ACTION_LOCKED_BOOT_COMPLETEDå¹¿æ’­</span></span><br><span class="line">        <span class="comment">//åœ¨è¿›è¡Œunlockç›¸å…³çš„å·¥ä½œåï¼ŒmUserControllerå°†è°ƒç”¨finishUserUnlockingï¼Œå‘é€SYSTEM_USER_UNLOCK_MSGæ¶ˆæ¯ç»™AMS</span></span><br><span class="line">        <span class="comment">//AMSæ”¶åˆ°æ¶ˆæ¯åï¼Œè°ƒç”¨mUserControllerçš„finishUserUnlockedå‡½æ•°ï¼Œç»è¿‡ç›¸åº”çš„å¤„ç†åï¼Œ</span></span><br><span class="line">        <span class="comment">//åœ¨mUserControllerçš„finishUserUnlockedCompletedä¸­ï¼Œæœ€ç»ˆå°†ä¼šå‘é€ACTION_BOOT_COMPLETEDå¹¿æ’­</span></span><br><span class="line">        mUserController.sendBootCompletedLocked(.........);</span><br><span class="line">        .................</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆï¼Œå½“AMSå¯åŠ¨Home Activityç»“æŸï¼Œå¹¶å‘é€ACTION_BOOT_COMPLETEDå¹¿æ’­æ—¶ï¼ŒAMSçš„å¯åŠ¨è¿‡ç¨‹å‘Šä¸€æ®µè½ã€‚</p><p>å…·ä½“å¯åŠ¨æµç¨‹è¯·å‚è€ƒï¼šã€Android 7.1.2 (Android N) Activityå¯åŠ¨æµç¨‹åˆ†æã€‘</p><h3 id="å‚è€ƒæ–‡æ¡£ï¼š"><a href="#å‚è€ƒæ–‡æ¡£ï¼š" class="headerlink" title="å‚è€ƒæ–‡æ¡£ï¼š"></a>å‚è€ƒæ–‡æ¡£ï¼š</h3><p><a href="http://blog.csdn.net/Gaugamela/article/category/6383486" target="_blank" rel="noopener">Android 7.0 ActivityManagerService 1 - 10</a><br><a href="http://blog.leanote.com/post/jay_richard/Android-Init%E8%BF%9B%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" target="_blank" rel="noopener">Android Initè¿›ç¨‹æºç åˆ†æ(1) - jay_richard</a><br><a href="http://blog.leanote.com/post/jay_richard/Android-Init%E8%BF%9B%E7%A8%8B%E4%B9%8B%E8%A7%A3%E6%9E%90init.rc" target="_blank" rel="noopener">Android Initè¿›ç¨‹æºç åˆ†æ(2) - jay_richard</a><br><a href="http://blog.leanote.com/post/jay_richard/Android-Zygote%E8%BF%9B%E7%A8%8B%E5%88%86%E6%9E%90" target="_blank" rel="noopener">Android Zygoteè¿›ç¨‹åˆ†æ - jay_richard</a><br><a href="http://www.cnblogs.com/samchen2009/p/3294713.html" target="_blank" rel="noopener">å›¾è§£Android - Zygote, System Server å¯åŠ¨åˆ†æ - æ¼«å¤©å°˜æ²™ - åšå®¢å›­</a><br><a href="http://blog.csdn.net/gaugamela/article/details/52133186" target="_blank" rel="noopener">Android7.0 initè¿›ç¨‹æºç åˆ†æ - ZhangJiançš„åšå®¢ - CSDNåšå®¢</a><br><a href="http://gityuan.com/2016/02/20/android-system-server/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨-SystemServerä¸Šç¯‡ - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢</a><br><a href="http://gityuan.com/2016/02/05/android-init/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨-Initç¯‡ - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢</a><br><a href="http://gityuan.com/2016/02/13/android-zygote/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨-zygoteç¯‡ - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢</a><br><a href="http://gityuan.com/2016/02/20/android-system-server-2/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨-SystemServerä¸‹ç¯‡ - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢</a><br><a href="http://gityuan.com/2016/02/21/activity-manager-service/" target="_blank" rel="noopener">ActivityManagerServiceå¯åŠ¨è¿‡ç¨‹ - Gityuanåšå®¢ | è¢è¾‰è¾‰åšå®¢</a><br><a href="http://blog.csdn.net/yangwen123/article/details/9029959" target="_blank" rel="noopener">Android Initè¿›ç¨‹æºç åˆ†æ - æ·±å…¥å‰–æAndroidç³»ç»Ÿ - CSDNåšå®¢</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2017/09/01/Android-7-1-2-Android-N-Androidç³»ç»Ÿå¯åŠ¨æµç¨‹/">http://zhoujinjian.cc/2017/09/01/Android-7-1-2-Android-N-Androidç³»ç»Ÿå¯åŠ¨æµç¨‹/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2017/08/01/Android-7-1-2-Android-N-Androidæ¶ˆæ¯æœºåˆ¶â€“Handlerã€Looperã€Message/" title="Android 7.1.2 (Android N) Androidæ¶ˆæ¯å¤„ç†æœºåˆ¶åˆ†æï¼ˆä»JAVAå±‚åˆ°NATIVEå±‚ï¼‰â€“ Handlerã€Looperã€Message"><i class="iconfont icon-prev"></i>Android 7.1.2 (Android N) Androidæ¶ˆæ¯å¤„ç†æœºåˆ¶åˆ†æï¼ˆä»JAVAå±‚åˆ°NATIVEå±‚ï¼‰â€“ Handlerã€Looperã€Message</a></div><div class="post__prev post__prev--right"><a href="/2017/10/01/Android-7-1-2-Android-N-Activityå¯åŠ¨æµç¨‹åˆ†æ/" title="Android 7.1.2 (Android N) Activity å¯åŠ¨æµç¨‹ ï¼ˆAMSï¼‰åˆ†æ">Android 7.1.2 (Android N) Activity å¯åŠ¨æµç¨‹ ï¼ˆAMSï¼‰åˆ†æ<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">25</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.08.jpg" alt="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/12/Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ/" title="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.26.jpg" alt="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</h3><span class="item__text">2018-09-12</span></div></a></li><li class="latest-post-item"><a href="/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/" title="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.25.jpg" alt="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</h3><span class="item__text">2018-09-06</span></div></a></li><li class="latest-post-item"><a href="/2018/08/30/Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture/" title="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" alt="Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture"></div><div class="item__info"><h3 class="item__title">Android Display Systemï¼ˆ5ï¼‰ï¼šAndroid Display System ç³»ç»Ÿåˆ†æä¹‹Display Driver Architecture</h3><span class="item__text">2018-08-30</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>izhoujinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:izhoujinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">353.8k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>