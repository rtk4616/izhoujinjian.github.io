<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Android 7.1.2 (Android N) Activity - Window åŠ è½½æ˜¾ç¤ºæµç¨‹ï¼ˆAMS && WMSï¼‰åˆ†æ | à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><meta name="designer" content="minfive"><meta name="keywords" content="zhoujinjian, zhoujinjian blog, Android, æºä»£ç , ActivityManagerService, AMS, WindowManagerService, WMS , zygote ï¼ŒInputManagerService , SurfaceFlinger, SystemServer , Binder , Graphics , Kernel , Linux"><meta name="description" content="å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><meta name="baidu-site-verification" content="7AVr5WpX72"><link rel="canonical" href="http://zhoujinjian.cc/2017/11/01/Android-7-1-2-Android-N-Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c54bda95ff8b34e8be2edd1d138812c1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117331438-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117331438-1")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading-small.gif)"></div><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"><img src="/img/Logo.png" alt="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><div id="page" class="page js-hidden"><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.04.jpg" alt="Android 7.1.2 (Android N) Activity - Window åŠ è½½æ˜¾ç¤ºæµç¨‹ï¼ˆAMS && WMSï¼‰åˆ†æ"></div><header class="post__info"><h1 class="post__title">Android 7.1.2 (Android N) Activity - Window åŠ è½½æ˜¾ç¤ºæµç¨‹ï¼ˆAMS && WMSï¼‰åˆ†æ</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="http://zhoujinjian.cc/">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘.</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2017-11-01</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li></ul></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></header><div class="post__content"><div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸€ã€Activityå¯åŠ¨æµç¨‹æ¦‚è¿°"><span class="toc-text">ä¸€ã€Activityå¯åŠ¨æµç¨‹æ¦‚è¿°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åšå®¢åŸå›¾é“¾æ¥"><span class="toc-text">åšå®¢åŸå›¾é“¾æ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#äºŒã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹"><span class="toc-text">äºŒã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1ã€ActivityThread-handleLaunchActivity"><span class="toc-text">2.1ã€ActivityThread.handleLaunchActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2ã€Activityå¯¹è±¡Attachè¿‡ç¨‹"><span class="toc-text">2.2ã€Activityå¯¹è±¡Attachè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3ã€Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹-Activity-setContentView"><span class="toc-text">2.3ã€Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹-Activity.setContentView()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4ã€ActivityThread-handleResumeActivity"><span class="toc-text">2.4ã€ActivityThread.handleResumeActivity()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5ã€ViewRootImpl-æ„é€ è¿‡ç¨‹ï¼š"><span class="toc-text">2.5ã€ViewRootImpl()æ„é€ è¿‡ç¨‹ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹"><span class="toc-text">2.6ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7ã€AttachInfoæ„é€ è¿‡ç¨‹"><span class="toc-text">2.7ã€AttachInfoæ„é€ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8ã€åˆ›å»ºChoreographerå¯¹è±¡"><span class="toc-text">2.8ã€åˆ›å»ºChoreographerå¯¹è±¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹"><span class="toc-text">2.9ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ã€requestLayout-åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›"><span class="toc-text">(1)ã€requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10ã€çª—å£UIå¸ƒå±€è¿‡ç¨‹"><span class="toc-text">2.10ã€çª—å£UIå¸ƒå±€è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10-1ã€æ·»åŠ å›è°ƒè¿‡ç¨‹"><span class="toc-text">2.10.1ã€æ·»åŠ å›è°ƒè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10-2ã€Vsyncè¯·æ±‚è¿‡ç¨‹"><span class="toc-text">2.10.2ã€Vsyncè¯·æ±‚è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ã€mWindowSession-addToDisplay-å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›"><span class="toc-text">(2) ã€mWindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SurfaceSessionå»ºç«‹è¿‡ç¨‹"><span class="toc-text">SurfaceSessionå»ºç«‹è¿‡ç¨‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vsyncä¿¡å·å¤„ç†"><span class="toc-text">Vsyncä¿¡å·å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-11ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹"><span class="toc-text">2.11ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1ã€æ‰§è¡Œçª—å£æµ‹é‡performMeasure"><span class="toc-text">1ã€æ‰§è¡Œçª—å£æµ‹é‡performMeasure()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2ã€æ‰§è¡Œçª—å£æ³¨å†ŒrelayoutWindowï¼›"><span class="toc-text">2ã€æ‰§è¡Œçª—å£æ³¨å†ŒrelayoutWindowï¼›</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-12ã€Surfaceåˆ›å»ºè¿‡ç¨‹"><span class="toc-text">2.12ã€Surfaceåˆ›å»ºè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BufferQueueæ„é€ è¿‡ç¨‹"><span class="toc-text">BufferQueueæ„é€ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GraphicBufferAllocæ„é€ è¿‡ç¨‹"><span class="toc-text">GraphicBufferAllocæ„é€ è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹"><span class="toc-text">å›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ"><span class="toc-text">Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹"><span class="toc-text">åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout"><span class="toc-text">3ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw"><span class="toc-text">4.æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unlockCanvasAndPost"><span class="toc-text">unlockCanvasAndPost()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº"><span class="toc-text">Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å›¾å½¢ç¼“å†²åŒºå…¥é˜Ÿ"><span class="toc-text">å›¾å½¢ç¼“å†²åŒºå…¥é˜Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#é€šçŸ¥SFæ¶ˆè´¹åˆæˆ"><span class="toc-text">é€šçŸ¥SFæ¶ˆè´¹åˆæˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¸€ã€preComposition-å‡½æ•°"><span class="toc-text">ä¸€ã€preComposition()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°"><span class="toc-text">1.1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2ã€ç»˜åˆ¶æµç¨‹"><span class="toc-text">1.2ã€ç»˜åˆ¶æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#äºŒã€handleTransaction-handPageFlipæ›´æ–°Layerå¯¹è±¡"><span class="toc-text">äºŒã€handleTransaction handPageFlipæ›´æ–°Layerå¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1ã€handleTransactionå‡½æ•°"><span class="toc-text">2.1ã€handleTransactionå‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2ã€Layerçš„doTransactionå‡½æ•°"><span class="toc-text">2.2ã€Layerçš„doTransactionå‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3ã€handleTransactionLockedå‡½æ•°"><span class="toc-text">2.3ã€handleTransactionLockedå‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–"><span class="toc-text">2.3.2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3ã€è®¾ç½®TransfromHit"><span class="toc-text">2.3.3ã€è®¾ç½®TransfromHit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ"><span class="toc-text">2.3.4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-5ã€è®¾ç½®mDrawingState"><span class="toc-text">2.3.5ã€è®¾ç½®mDrawingState</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4ã€handlePageFlipå‡½æ•°"><span class="toc-text">2.4ã€handlePageFlipå‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-å°ç»“"><span class="toc-text">2.5 å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¸‰ã€rebuildLayerStackså‡½æ•°"><span class="toc-text">ä¸‰ã€rebuildLayerStackså‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#å››ã€setUpHWComposerå‡½æ•°"><span class="toc-text">å››ã€setUpHWComposerå‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ-ï¼ˆdoComposition-å‡½æ•°ï¼‰"><span class="toc-text">äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ ï¼ˆdoComposition()å‡½æ•°ï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#å…­ã€postFramebufferå‡½æ•°"><span class="toc-text">å…­ã€postFramebufferå‡½æ•°</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒæ–‡æ¡£ï¼ˆç‰¹åˆ«æ„Ÿè°¢ï¼‰ï¼š"><span class="toc-text">å‚è€ƒæ–‡æ¡£ï¼ˆç‰¹åˆ«æ„Ÿè°¢ï¼‰ï¼š</span></a></li></ol></div><p>Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹æ¦‚è¿°ï¼š Androidç³»ç»Ÿä¸­å›¾å½¢ç³»ç»Ÿæ˜¯ç›¸å½“å¤æ‚çš„ï¼ŒåŒ…æ‹¬WindowManagerï¼ŒSurfaceFlinger,Open GL,GPUç­‰æ¨¡å—ã€‚ å…¶ä¸­SurfaceFlingerä½œä¸ºè´Ÿè´£ç»˜åˆ¶åº”ç”¨UIçš„æ ¸å¿ƒï¼Œä»åå­—å¯ä»¥çœ‹å‡ºå…¶åŠŸèƒ½æ˜¯å°†æ‰€æœ‰Surfaceåˆæˆå·¥ä½œã€‚ ä¸è®ºä½¿ç”¨ä»€ä¹ˆæ¸²æŸ“API, æ‰€æœ‰çš„ä¸œè¥¿æœ€ç»ˆéƒ½æ˜¯æ¸²æŸ“åˆ°â€surfaceâ€. surfaceä»£è¡¨BufferQueueçš„ç”Ÿäº§è€…ç«¯, å¹¶ä¸” ç”±SurfaceFlingeræ‰€æ¶ˆè´¹, è¿™ä¾¿æ˜¯åŸºæœ¬çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼. Androidå¹³å°æ‰€åˆ›å»ºçš„Windowéƒ½ç”±surfaceæ‰€æ”¯æŒ, æ‰€æœ‰å¯è§çš„surfaceæ¸²æŸ“åˆ°æ˜¾ç¤ºè®¾å¤‡éƒ½æ˜¯é€šè¿‡SurfaceFlingeræ¥å®Œæˆçš„. æœ¬æ–‡è¯¦ç»†åˆ†æAndroid WindowåŠ è½½æ˜¾ç¤ºæµç¨‹ï¼Œå¹¶é€šè¿‡SurfaceFlingeræ¸²æŸ“åˆæˆè¾“å‡ºåˆ°å±å¹•çš„è¿‡ç¨‹ã€‚ <a id="more"></a></p><h2 id="ä¸€ã€Activityå¯åŠ¨æµç¨‹æ¦‚è¿°"><a href="#ä¸€ã€Activityå¯åŠ¨æµç¨‹æ¦‚è¿°" class="headerlink" title="ä¸€ã€Activityå¯åŠ¨æµç¨‹æ¦‚è¿°"></a>ä¸€ã€Activityå¯åŠ¨æµç¨‹æ¦‚è¿°</h2><p>åŸºäºAndroid 7.1.2çš„æºç å‰–æï¼Œ åˆ†æActivity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹ï¼Œç›¸å…³æºç ï¼š</p><hr><p><strong>frameworks/base/core/java/android/app/</strong><br>â— Activity.java<br>â— ActivityThread.java<br>â— Instrumentation.java</p><p><strong>frameworks/base/core/jni/</strong><br>â— android_view_DisplayEventReceiver.cpp<br><br>â— android_view_SurfaceControl.cpp<br>â— android_view_Surface.cpp<br>â— android_view_SurfaceSession.cpp</p><p><strong>frameworks/native/include/gui/</strong><br>â— SurfaceComposerClient.cpp<br><br>â— SurfaceComposerClient.h</p><p><strong>frameworks/native/services/surfaceflinger/</strong><br>â— SurfaceFlinger.cpp<br>â— Client.cpp</p><p><strong>frameworks/base/core/java/android/view/</strong><br>â— WindowManagerImpl.java<br>â— ViewManager.java<br>â— WindowManagerGlobal.java<br>â— ViewRootImpl.java<br>â— Choreographer.java<br>â— IWindowSession.aidl<br>â— DisplayEventReceiver.java<br>â— SurfaceControl.java<br>â— Surface.java<br>â— SurfaceSession.java</p><p><strong>frameworks/base/core/java/com/android/internal/policy/</strong><br>â— PhoneWindow.java</p><p><strong>frameworks/base/services/core/java/com/android/server/wm/</strong><br>â— WindowManagerService.java<br>â— Session.java<br>â— WindowState.java<br>â— WindowStateAnimator.java<br>â— WindowSurfaceController.java</p><h2 id="åšå®¢åŸå›¾é“¾æ¥"><a href="#åšå®¢åŸå›¾é“¾æ¥" class="headerlink" title="åšå®¢åŸå›¾é“¾æ¥"></a><a href="https://github.com/izhoujinjian/zhoujinjian.cc/tree/master/android.addwindow" target="_blank" rel="noopener">åšå®¢åŸå›¾é“¾æ¥</a></h2><p>åœ¨å‰é¢æ–‡ç« ï¼ˆAndroid 7.1.2(Android N) Activityå¯åŠ¨æµç¨‹åˆ†æï¼‰ä¸­è¯¦ç»†åˆ†æäº†Activityå¯åŠ¨æµç¨‹ï¼Œè¿™é‡Œå›é¡¾ä¸€ä¸‹æ€»ä½“æµç¨‹ã€‚ Activityå¯åŠ¨æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N1-Android-addWindow-start_activity_process.jpg" alt="Markdown"></p><blockquote><p>å¯åŠ¨æµç¨‹ï¼š</p><p>â— ç‚¹å‡»æ¡Œé¢Appå›¾æ ‡ï¼ŒLauncherè¿›ç¨‹é‡‡ç”¨Binder IPCå‘system_serverè¿›ç¨‹å‘èµ·startActivityè¯·æ±‚ï¼›<br>â— system_serverè¿›ç¨‹æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå‘zygoteè¿›ç¨‹å‘é€åˆ›å»ºè¿›ç¨‹çš„è¯·æ±‚ï¼›<br>â— Zygoteè¿›ç¨‹forkå‡ºæ–°çš„å­è¿›ç¨‹ï¼Œå³Appè¿›ç¨‹ï¼›<br>â— Appè¿›ç¨‹ï¼Œé€šè¿‡Binder IPCå‘sytem_serverè¿›ç¨‹å‘èµ·attachApplicationè¯·æ±‚ï¼›<br>â— system_serverè¿›ç¨‹åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œè¿›è¡Œä¸€ç³»åˆ—å‡†å¤‡å·¥ä½œåï¼Œå†é€šè¿‡binder IPCå‘Appè¿›ç¨‹å‘é€scheduleLaunchActivityè¯·æ±‚ï¼›<br>â— Appè¿›ç¨‹çš„binderçº¿ç¨‹ï¼ˆApplicationThreadï¼‰åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡handlerå‘ä¸»çº¿ç¨‹å‘é€LAUNCH_ACTIVITYæ¶ˆæ¯ï¼›<br>â— ä¸»çº¿ç¨‹åœ¨æ”¶åˆ°Messageåï¼Œé€šè¿‡å‘å°„æœºåˆ¶åˆ›å»ºç›®æ ‡Activityï¼Œå¹¶å›è°ƒActivity.onCreate()ç­‰æ–¹æ³•ã€‚</p></blockquote><p>Appæ­£å¼å¯åŠ¨åï¼Œå¼€å§‹è¿›å…¥Activityç”Ÿå‘½å‘¨æœŸï¼Œæ‰§è¡Œå®ŒonCreate/onStart/onResumeæ–¹æ³•ï¼ŒUIæ¸²æŸ“ç»“æŸåä¾¿å¯ä»¥çœ‹åˆ°Appçš„ä¸»ç•Œé¢ï¼Œ æ¥ä¸‹æ¥åˆ†æUIæ¸²æŸ“æµç¨‹ã€‚</p><h3 id="äºŒã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹"><a href="#äºŒã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹" class="headerlink" title="äºŒã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹"></a>äºŒã€WindowåŠ è½½æ˜¾ç¤ºæµç¨‹</h3><h4 id="2-1ã€ActivityThread-handleLaunchActivity"><a href="#2-1ã€ActivityThread-handleLaunchActivity" class="headerlink" title="2.1ã€ActivityThread.handleLaunchActivity()"></a>2.1ã€ActivityThread.handleLaunchActivity()</h4><p>æ¥ç€ä»ActivityThreadçš„handleLaunchActivityæ–¹æ³•ï¼š [-&gt;ActivityThread.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Initialize before creating the activity</span></span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line">    <span class="comment">//åˆ›å»ºActivity  </span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//å¯åŠ¨Activity  </span></span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç¨‹åºè¿›ç¨‹é€šè¿‡performLaunchActivityå‡½æ•°å°†å³å°†è¦å¯åŠ¨çš„ActivityåŠ è½½åˆ°å½“å‰è¿›ç¨‹ç©ºé—´æ¥ï¼ŒåŒæ—¶ä¸ºå¯åŠ¨Activityåšå‡†å¤‡ã€‚ [ActivityThread.java #performLaunchActivity()]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡Activityæ‰€åœ¨çš„åº”ç”¨ç¨‹åºä¿¡æ¯åŠè¯¥Activityå¯¹åº”çš„CompatibilityInfoä¿¡æ¯ä»PMSæœåŠ¡ä¸­æŸ¥è¯¢å½“å‰Activityçš„åŒ…ä¿¡æ¯  </span></span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰Activityçš„ç»„ä»¶ä¿¡æ¯  </span></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = r.intent.resolveActivity(</span><br><span class="line">            mInitialApplication.getPackageManager());</span><br><span class="line">        r.intent.setComponent(component);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//packageNameä¸ºå¯åŠ¨Activityçš„åŒ…åï¼ŒtargetActivityä¸ºActivityçš„ç±»å  </span></span><br><span class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                r.activityInfo.targetActivity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é€šè¿‡ç±»åå°„æ–¹å¼åŠ è½½å³å°†å¯åŠ¨çš„Activity</span></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡å•ä¾‹æ¨¡å¼ä¸ºåº”ç”¨ç¨‹åºè¿›ç¨‹åˆ›å»ºApplicationå¯¹è±¡  </span></span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//ä¸ºå½“å‰Activityåˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ContextImpl  </span></span><br><span class="line">            Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">//å°†å½“å‰å¯åŠ¨çš„Activityå’Œä¸Šä¸‹æ–‡ContextImplã€Applicationç»‘å®š</span></span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor, window);</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">//å°†Activityä¿å­˜åˆ°ActivityClientRecordä¸­ï¼ŒActivityClientRecordä¸ºActivityåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„æè¿°ç¬¦  </span></span><br><span class="line">            r.activity = activity;</span><br><span class="line">            activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">//ç”Ÿå‘½å‘¨æœŸonStartã€onresume</span></span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ActivityThreadçš„æˆå‘˜å˜é‡mActivitiesä¿å­˜äº†å½“å‰åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„æ‰€æœ‰Activityçš„æè¿°ç¬¦</span></span><br><span class="line">            mActivities.put(r.token, r);</span><br><span class="line">            ......</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°ä¸­ï¼Œé¦–å…ˆé€šè¿‡PMSæœåŠ¡æŸ¥æ‰¾åˆ°å³å°†å¯åŠ¨çš„Activityçš„åŒ…åä¿¡æ¯ï¼Œç„¶åé€šè¿‡ç±»åå°„æ–¹å¼åˆ›å»ºä¸€ä¸ªè¯¥Activityå®ä¾‹ï¼ŒåŒæ—¶ä¸ºåº”ç”¨ç¨‹åºå¯åŠ¨çš„æ¯ä¸€ä¸ªActivityåˆ›å»ºä¸€ä¸ªLoadedApkå®ä¾‹å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­åˆ›å»ºçš„æ‰€æœ‰LoadedApkå¯¹è±¡ä¿å­˜åœ¨ActivityThreadçš„æˆå‘˜å˜é‡mPackagesä¸­ã€‚æ¥ç€é€šè¿‡LoadedApkå¯¹è±¡çš„makeApplicationå‡½æ•°ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼åˆ›å»ºApplicationå¯¹è±¡ï¼Œå› æ­¤åœ¨androidåº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªApplicationå®ä¾‹ã€‚ç„¶åä¸ºå½“å‰å¯åŠ¨çš„Activityåˆ›å»ºä¸€ä¸ªContextImplä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ–è¯¥ä¸Šä¸‹æ–‡ï¼Œåˆ°æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¯åŠ¨ä¸€ä¸ªActivityéœ€è¦ä»¥ä¸‹å¯¹è±¡ï¼š</p><p>1) Activityå¯¹è±¡ï¼Œéœ€è¦å¯åŠ¨çš„Activityï¼›</p><p>2) LoadedApkå¯¹è±¡ï¼Œæ¯ä¸ªå¯åŠ¨çš„Activityéƒ½æ‹¥æœ‰å±äºè‡ªèº«çš„LoadedApkå¯¹è±¡ï¼›</p><p>3) ContextImplå¯¹è±¡ï¼Œæ¯ä¸ªå¯åŠ¨çš„Activityéƒ½æ‹¥æœ‰å±äºè‡ªèº«çš„ContextImplå¯¹è±¡ï¼›</p><p>4) Applicationå¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå’ŒActivityæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼›</p><h4 id="2-2ã€Activityå¯¹è±¡Attachè¿‡ç¨‹"><a href="#2-2ã€Activityå¯¹è±¡Attachè¿‡ç¨‹" class="headerlink" title="2.2ã€Activityå¯¹è±¡Attachè¿‡ç¨‹"></a>2.2ã€Activityå¯¹è±¡Attachè¿‡ç¨‹</h4><p>Activityæ‰€éœ€è¦çš„å¯¹è±¡éƒ½åˆ›å»ºå¥½äº†ï¼Œå°±éœ€è¦å°†Activityå’ŒApplicationå¯¹è±¡ã€ContextImplå¯¹è±¡ç»‘å®šåœ¨ä¸€èµ·ã€‚</p><p>å‚æ•°ï¼š contextï¼šActivityçš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå°±æ˜¯å‰é¢åˆ›å»ºçš„ContextImplå¯¹è±¡ï¼›</p><p>aThreadï¼šActivityè¿è¡Œæ‰€åœ¨çš„ä¸»çº¿ç¨‹æè¿°ç¬¦ActivityThreadï¼›</p><p>instrï¼šç”¨äºç›‘æ§Activityè¿è¡ŒçŠ¶æ€çš„Instrumentationå¯¹è±¡ï¼›</p><p>tokenï¼šç”¨äºå’ŒAMSæœåŠ¡é€šä¿¡çš„IApplicationToken.Proxyä»£ç†å¯¹è±¡ï¼›</p><p>applicationï¼šActivityè¿è¡Œæ‰€åœ¨è¿›ç¨‹çš„Applicationå¯¹è±¡ï¼›</p><p>parentï¼šå¯åŠ¨å½“å‰Activityçš„Activityï¼›</p><p>[-&gt;Activity.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        Window window)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å°†ä¸Šä¸‹æ–‡å¯¹è±¡ContextImplä¿å­˜åˆ°Activityçš„æˆå‘˜å˜é‡ä¸­  </span></span><br><span class="line">    attachBaseContext(context);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//è®°å½•åº”ç”¨ç¨‹åºçš„UIçº¿ç¨‹  </span></span><br><span class="line">    mUiThread = Thread.currentThread();</span><br><span class="line">    <span class="comment">//è®°å½•åº”ç”¨ç¨‹åºçš„ActivityThreadå¯¹è±¡</span></span><br><span class="line">    mMainThread = aThread;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//ä¸ºActivityæ‰€åœ¨çš„çª—å£åˆ›å»ºçª—å£ç®¡ç†å™¨</span></span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line">    mWindowManager = mWindow.getWindowManager();</span><br><span class="line">    mCurrentConfig = config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥attachå‡½æ•°ä¸­ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><p>1) æ ¹æ®å‚æ•°åˆå§‹åŒ–Activityçš„æˆå‘˜å˜é‡ï¼›</p><p>2) ä¸ºActivityåˆ›å»ºçª—å£Windowå¯¹è±¡ï¼›</p><p>3) ä¸ºWindowåˆ›å»ºçª—å£ç®¡ç†å™¨ï¼›</p><h4 id="2-3ã€Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹-Activity-setContentView"><a href="#2-3ã€Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹-Activity-setContentView" class="headerlink" title="2.3ã€Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹-Activity.setContentView()"></a>2.3ã€Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹-Activity.setContentView()</h4><blockquote><p>ActivityThread.performLaunchActivity()<br>â€“&gt; Instrumentation.callActivityOnCreate()<br>â€”â€”&gt;Activity.performCreate()<br>â€”â€”&gt;Activity.onCreate()<br>â€“&gt;Activity.performStart()<br>â€”â€”&gt;Instrumentation.callActivityOnStart()<br>â€”â€”&gt;Activity.onStart()</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(@LayoutRes <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    getWindow().setContentView(layoutResID);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getWindow()å‡½æ•°å¾—åˆ°å‰é¢åˆ›å»ºçš„çª—å£å¯¹è±¡PhoneWindowï¼Œé€šè¿‡PhoneWindowæ¥è®¾ç½®Activityçš„è§†å›¾ã€‚ [-&gt;PhoneWindow.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//å¦‚æœçª—å£é¡¶çº§è§†å›¾å¯¹è±¡ä¸ºç©ºï¼Œåˆ™åˆ›å»ºçª—å£è§†å›¾å¯¹è±¡  </span></span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        installDecor();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">    ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//åŠ è½½å¸ƒå±€æ–‡ä»¶ï¼Œå¹¶å°†å¸ƒå±€æ–‡ä»¶ä¸­çš„æ‰€æœ‰è§†å›¾å¯¹è±¡æ·»åŠ åˆ°mContentParentå®¹å™¨ä¸­,PhoneWindowçš„æˆå‘˜å˜é‡mContentParentçš„ç±»å‹ä¸ºViewGroupï¼Œæ˜¯çª—å£å†…å®¹å­˜æ”¾çš„åœ°æ–¹</span></span><br><span class="line">        mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParent.requestApplyInsets();</span><br><span class="line">    <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParentExplicitlySet = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Activity.onCreate()ä¼šè°ƒç”¨setContentView(),æ•´ä¸ªè¿‡ç¨‹ä¸»è¦æ˜¯Activityçš„å¸ƒå±€æ–‡ä»¶æˆ–Viewæ·»åŠ è‡³çª—å£é‡Œï¼Œ è¯¦ç»†è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼Œè¯¦ç»†åŠ è½½è¿‡ç¨‹è¯·å‚è€ƒï¼š <a href="http://blog.csdn.net/yanbober/article/details/45970721" target="_blank" rel="noopener">Androidåº”ç”¨setContentViewä¸LayoutInflateråŠ è½½è§£ææœºåˆ¶æºç åˆ†æ</a> é‡ç‚¹æ¦‚æ‹¬ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â— åˆ›å»ºä¸€ä¸ªDecorViewçš„å¯¹è±¡mDecorï¼Œè¯¥mDecorå¯¹è±¡å°†ä½œä¸ºæ•´ä¸ªåº”ç”¨çª—å£çš„æ ¹è§†å›¾ã€‚</span><br><span class="line">â— ä¾æ®Featureç­‰style themeåˆ›å»ºä¸åŒçš„çª—å£ä¿®é¥°å¸ƒå±€æ–‡ä»¶ï¼Œå¹¶ä¸”é€šè¿‡findViewByIdè·å–Activityå¸ƒå±€æ–‡ä»¶è¯¥å­˜æ”¾çš„åœ°æ–¹ï¼ˆçª—å£ä¿®é¥°å¸ƒå±€æ–‡ä»¶ä¸­idä¸ºcontentçš„FrameLayoutï¼‰ã€‚</span><br><span class="line">â— å°†Activityçš„å¸ƒå±€æ–‡ä»¶æ·»åŠ è‡³idä¸ºcontentçš„FrameLayoutå†…ã€‚</span><br><span class="line">â— å½“setContentViewè®¾ç½®æ˜¾ç¤ºOKä»¥åä¼šå›è°ƒActivityçš„onContentChangedæ–¹æ³•ã€‚Activityçš„å„ç§Viewçš„findViewById()æ–¹æ³•ç­‰éƒ½å¯ä»¥æ”¾åˆ°è¯¥æ–¹æ³•ä¸­ï¼Œç³»ç»Ÿä¼šå¸®å¿™å›è°ƒã€‚</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N2-Android-addWindow-DecorView.jpg" alt="Markdown"></p><h4 id="2-4ã€ActivityThread-handleResumeActivity"><a href="#2-4ã€ActivityThread-handleResumeActivity" class="headerlink" title="2.4ã€ActivityThread.handleResumeActivity()"></a>2.4ã€ActivityThread.handleResumeActivity()</h4><p>å›åˆ°æˆ‘ä»¬åˆšåˆšçš„handleLaunchActivity()æ–¹æ³•ï¼Œåœ¨è°ƒç”¨å®ŒperformLaunchActivity()æ–¹æ³•ä¹‹åï¼Œå…¶æœ‰æ‰ç”¨äº†handleResumeActivity()æ³•ã€‚</p><p>performLaunchActivity()æ–¹æ³•å®Œæˆäº†ä¸¤ä»¶äº‹ï¼š</p><p>1) Activityçª—å£å¯¹è±¡çš„åˆ›å»ºï¼Œé€šè¿‡attachå‡½æ•°æ¥å®Œæˆï¼›</p><p>2) Activityè§†å›¾å¯¹è±¡çš„åˆ›å»ºï¼Œé€šè¿‡setContentViewå‡½æ•°æ¥å®Œæˆï¼›</p><p>è¿™äº›å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œå°±å¯ä»¥æ˜¾ç¤ºè¯¥Activityäº†ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹é€šè¿‡è°ƒç”¨handleResumeActivityå‡½æ•°æ¥å¯åŠ¨Activityçš„æ˜¾ç¤ºè¿‡ç¨‹ã€‚</p><p>[-&gt;ActivityThread.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    r = performResumeActivity(token, clearHide, reason);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            <span class="comment">//è·å¾—ä¸ºå½“å‰Activityåˆ›å»ºçš„çª—å£PhoneWindowå¯¹è±¡</span></span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            <span class="comment">//è·å–ä¸ºçª—å£åˆ›å»ºçš„è§†å›¾DecorViewå¯¹è±¡</span></span><br><span class="line">            View decor = r.window.getDecorView();</span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            <span class="comment">//åœ¨attachå‡½æ•°ä¸­å°±ä¸ºå½“å‰Activityåˆ›å»ºäº†WindowManagerå¯¹è±¡  </span></span><br><span class="line">            ViewManager wm = a.getWindowManager();</span><br><span class="line">            <span class="comment">//å¾—åˆ°è¯¥è§†å›¾å¯¹è±¡çš„å¸ƒå±€å‚æ•°  </span></span><br><span class="line">            WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">            <span class="comment">//å°†è§†å›¾å¯¹è±¡ä¿å­˜åˆ°Activityçš„æˆå‘˜å˜é‡mDecorä¸­  </span></span><br><span class="line">            a.mDecor = decor;</span><br><span class="line">            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">            l.softInputMode |= forwardBit;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//å°†åˆ›å»ºçš„è§†å›¾å¯¹è±¡DecorViewæ·»åŠ åˆ°Activityçš„çª—å£ç®¡ç†å™¨ä¸­  </span></span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125;</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                r.activity.makeVisible();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!r.onlyLocalRequest) &#123;</span><br><span class="line">            <span class="comment">//onStop()......</span></span><br><span class="line">            Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br><span class="line">        &#125;</span><br><span class="line">        r.onlyLocalRequest = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (reallyResume) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManagerNative.getDefault().activityResumed(token);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">         ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å‰é¢çš„performLaunchActivityå‡½æ•°ä¸­å®ŒæˆActivityçš„åˆ›å»ºåï¼Œä¼šå°†å½“å‰å½“å‰åˆ›å»ºçš„Activityåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ç«¯çš„æè¿°ç¬¦ActivityClientRecordä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åˆ°ActivityThreadçš„æˆå‘˜å˜é‡mActivitiesä¸­ï¼šmActivities.put(r.token, r)ï¼Œr.tokenå°±æ˜¯Activityçš„èº«ä»½è¯ï¼Œå³æ˜¯IApplicationToken.Proxyä»£ç†å¯¹è±¡ï¼Œä¹Ÿç”¨äºä¸AMSé€šä¿¡ã€‚ä¸Šé¢çš„å‡½æ•°é¦–å…ˆé€šè¿‡performResumeActivityä»mActivitieså˜é‡ä¸­å–å‡ºActivityçš„åº”ç”¨ç¨‹åºç«¯æè¿°ç¬¦ActivityClientRecordï¼Œç„¶åå–å‡ºå‰é¢ä¸ºActivityåˆ›å»ºçš„è§†å›¾å¯¹è±¡DecorViewå’Œçª—å£ç®¡ç†å™¨WindowManagerï¼Œæœ€åå°†è§†å›¾å¯¹è±¡æ·»åŠ åˆ°çª—å£ç®¡ç†å™¨ä¸­ã€‚</p><p>ViewManager.addView()çœŸæ­£å®ç°çš„çš„åœ°æ–¹åœ¨WindowManagerImpl.javaä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerGlobal.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">        Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        ......</span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">        mParams.add(wparams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        root.setView(view, wparams, panelParentView);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5ã€ViewRootImpl-æ„é€ è¿‡ç¨‹ï¼š"><a href="#2-5ã€ViewRootImpl-æ„é€ è¿‡ç¨‹ï¼š" class="headerlink" title="2.5ã€ViewRootImpl()æ„é€ è¿‡ç¨‹ï¼š"></a>2.5ã€ViewRootImpl()æ„é€ è¿‡ç¨‹ï¼š</h4><p>[ViewRootImpl.java # ViewRootImpl()]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">final</span> W mWindow;</span><br><span class="line">    <span class="keyword">final</span> Surface mSurface = <span class="keyword">new</span> Surface();</span><br><span class="line">    <span class="keyword">final</span> ViewRootHandler mHandler = <span class="keyword">new</span> ViewRootHandler();</span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mWindowSession = WindowManagerGlobal.getWindowSession();<span class="comment">//IWindowSessionçš„ä»£ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºå’ŒWMSé€šä¿¡ã€‚</span></span><br><span class="line">    mDisplay = display;</span><br><span class="line">    ......</span><br><span class="line">    mWindow = <span class="keyword">new</span> W(<span class="keyword">this</span>);<span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªWæœ¬åœ°Binderå¯¹è±¡ï¼Œç”¨äºWMSé€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹</span></span><br><span class="line">    ......</span><br><span class="line">    mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler, <span class="keyword">this</span>);</span><br><span class="line">    ......</span><br><span class="line">    mViewConfiguration = ViewConfiguration.get(context);</span><br><span class="line">    mDensity = context.getResources().getDisplayMetrics().densityDpi;</span><br><span class="line">    mNoncompatDensity = context.getResources().getDisplayMetrics().noncompatDensityDpi;</span><br><span class="line">    mFallbackEventHandler = <span class="keyword">new</span> PhoneFallbackEventHandler(context);</span><br><span class="line">    mChoreographer = Choreographer.getInstance();<span class="comment">//Choreographerå¯¹è±¡</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ViewRootImplçš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–äº†ä¸€äº›æˆå‘˜å˜é‡ï¼ŒViewRootImplåˆ›å»ºäº†ä»¥ä¸‹å‡ ä¸ªä¸»è¦å¯¹è±¡ï¼š</p><p>(1) é€šè¿‡WindowManagerGlobal.getWindowSession()å¾—åˆ°IWindowSessionçš„ä»£ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºå’ŒWMSé€šä¿¡ã€‚</p><p>(2) åˆ›å»ºäº†ä¸€ä¸ªWæœ¬åœ°Binderå¯¹è±¡ï¼Œç”¨äºWMSé€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</p><p>(3) é‡‡ç”¨å•ä¾‹æ¨¡å¼åˆ›å»ºäº†ä¸€ä¸ªChoreographerå¯¹è±¡ï¼Œç”¨äºç»Ÿä¸€è°ƒåº¦çª—å£ç»˜å›¾ã€‚</p><p>(4) åˆ›å»ºViewRootHandlerå¯¹è±¡ï¼Œç”¨äºå¤„ç†å½“å‰è§†å›¾æ¶ˆæ¯ã€‚</p><p>(5) æ„é€ ä¸€ä¸ªAttachInfoå¯¹è±¡ï¼›</p><p>(6) åˆ›å»ºSurfaceå¯¹è±¡ï¼Œç”¨äºç»˜åˆ¶å½“å‰è§†å›¾ï¼Œå½“ç„¶è¯¥Surfaceå¯¹è±¡çš„çœŸæ­£åˆ›å»ºæ˜¯ç”±WMSæ¥å®Œæˆçš„ï¼Œåªä¸è¿‡æ˜¯WMSä¼ é€’ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹çš„ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N3-Android-addWindow-ViewRootImpl.png" alt="Markdown"></p><h4 id="2-6ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹"><a href="#2-6ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹" class="headerlink" title="2.6ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹"></a>2.6ã€IWindowSessionä»£ç†è·å–è¿‡ç¨‹</h4><p>[-&gt;WindowManagerGlobal.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> IWindowSession sWindowSession;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title">getWindowSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWindowSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//è·å–è¾“å…¥æ³•ç®¡ç†å™¨</span></span><br><span class="line">                InputMethodManager imm = InputMethodManager.getInstance();</span><br><span class="line">                <span class="comment">//è·å–çª—å£ç®¡ç†å™¨  </span></span><br><span class="line">                IWindowManager windowManager = getWindowManagerService();</span><br><span class="line">                <span class="comment">//å¾—åˆ°IWindowSessionä»£ç†å¯¹è±¡</span></span><br><span class="line">                sWindowSession = windowManager.openSession(</span><br><span class="line">                        <span class="keyword">new</span> IWindowSessionCallback.Stub() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimatorScaleChanged</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">                                ValueAnimator.setDurationScale(scale);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        imm.getClient(), imm.getInputContext());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWindowSession;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå‡½æ•°é€šè¿‡WMSçš„openSessionå‡½æ•°åˆ›å»ºåº”ç”¨ç¨‹åºä¸WMSä¹‹é—´çš„è¿æ¥é€šé“ï¼Œå³è·å–IWindowSessionä»£ç†å¯¹è±¡ï¼Œå¹¶å°†è¯¥ä»£ç†å¯¹è±¡ä¿å­˜åˆ°ViewRootImplçš„é™æ€æˆå‘˜å˜é‡sWindowSessionä¸­,å› æ­¤åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªIWindowSessionä»£ç†å¯¹è±¡ã€‚ [-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IWindowSession <span class="title">openSession</span><span class="params">(IWindowSessionCallback callback, IInputMethodClient client,</span></span></span><br><span class="line"><span class="function"><span class="params">        IInputContext inputContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (client == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null client"</span>);</span><br><span class="line">    <span class="keyword">if</span> (inputContext == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null inputContext"</span>);</span><br><span class="line">    Session session = <span class="keyword">new</span> Session(<span class="keyword">this</span>, callback, client, inputContext);</span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨WMSæœåŠ¡ç«¯æ„é€ äº†ä¸€ä¸ªSessionå®ä¾‹å¯¹è±¡ã€‚ViewRootImpl æ˜¯ä¸€å¾ˆé‡è¦çš„ç±»ï¼Œç±»ä¼¼ ActivityThread è´Ÿè´£è·ŸAmSé€šä¿¡ä¸€æ ·ï¼ŒViewRootImpl çš„ä¸€ä¸ªé‡è¦èŒè´£å°±æ˜¯è·Ÿ WmS é€šä¿¡ï¼Œå®ƒé€šé™æ€å˜é‡ sWindowSessionï¼ˆIWindowSessionå®ä¾‹ï¼‰ä¸ WmS è¿›è¡Œé€šä¿¡ã€‚æ¯ä¸ªåº”ç”¨è¿›ç¨‹ï¼Œä»…æœ‰ä¸€ä¸ª sWindowSession å¯¹è±¡ï¼Œå®ƒå¯¹åº”äº† WmS ä¸­çš„ Session å­ç±»ï¼ŒWmS ä¸ºæ¯ä¸€ä¸ªåº”ç”¨è¿›ç¨‹åˆ†é…ä¸€ä¸ª Session å¯¹è±¡ã€‚WindowState ç±»æœ‰ä¸€ä¸ª IWindow mClient å‚æ•°ï¼Œæ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­èµ‹å€¼çš„ï¼Œæ˜¯ç”± Session è°ƒç”¨ addWindow ä¼ é€’è¿‡æ¥äº†ï¼Œå¯¹åº”äº† ViewRootImpl ä¸­çš„ W ç±»çš„å®ä¾‹ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N4-Android-addWindow-ViewRootImpl-WMS.png" alt="Markdown"></p><h4 id="2-7ã€AttachInfoæ„é€ è¿‡ç¨‹"><a href="#2-7ã€AttachInfoæ„é€ è¿‡ç¨‹" class="headerlink" title="2.7ã€AttachInfoæ„é€ è¿‡ç¨‹"></a>2.7ã€AttachInfoæ„é€ è¿‡ç¨‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    AttachInfo(IWindowSession session, IWindow window, Display display,</span><br><span class="line">        ViewRootImpl viewRootImpl, Handler handler, Callbacks effectPlayer) &#123;</span><br><span class="line">    mSession = session;<span class="comment">//IWindowSessionä»£ç†å¯¹è±¡ï¼Œç”¨äºä¸WMSé€šä¿¡</span></span><br><span class="line">    mWindow = window;<span class="comment">//Wå¯¹è±¡  </span></span><br><span class="line">    mWindowToken = window.asBinder();<span class="comment">//Wæœ¬åœ°Binderå¯¹è±¡</span></span><br><span class="line">    mDisplay = display;</span><br><span class="line">    mViewRootImpl = viewRootImpl;<span class="comment">//ViewRootImplå®ä¾‹  </span></span><br><span class="line">    mHandler = handler;<span class="comment">//ViewRootHandlerå¯¹è±¡  </span></span><br><span class="line">    mRootCallbacks = effectPlayer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-8ã€åˆ›å»ºChoreographerå¯¹è±¡"><a href="#2-8ã€åˆ›å»ºChoreographerå¯¹è±¡" class="headerlink" title="2.8ã€åˆ›å»ºChoreographerå¯¹è±¡"></a>2.8ã€åˆ›å»ºChoreographerå¯¹è±¡</h4><p>[-&gt;Choreographer.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Thread local storage for the choreographer.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Choreographer&gt; sThreadInstance =</span><br><span class="line">        <span class="keyword">new</span> ThreadLocal&lt;Choreographer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Choreographer <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Looper looper = Looper.myLooper();</span><br><span class="line">        <span class="keyword">if</span> (looper == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The current thread must have a looper!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Choreographer(looper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Choreographer <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sThreadInstance.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºè°ƒç”¨çº¿ç¨‹åˆ›å»ºä¸€ä¸ªChoreographerå®ä¾‹ï¼Œè°ƒç”¨çº¿ç¨‹å¿…é¡»å…·å¤‡æ¶ˆæ¯å¾ªç¯åŠŸèƒ½ï¼Œå› ä¸ºViewRootImplå¯¹è±¡çš„æ„é€ æ˜¯åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹çš„UIä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå› æ­¤åˆ›å»ºçš„Choreographerå¯¹è±¡å°†ä½¿ç”¨UIçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ã€‚ [-&gt;Choreographer.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Choreographer</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">    mLooper = looper;</span><br><span class="line">    <span class="comment">//åˆ›å»ºæ¶ˆæ¯å¤„ç†Handler</span></span><br><span class="line">    mHandler = <span class="keyword">new</span> FrameHandler(looper);</span><br><span class="line">    <span class="comment">//å¦‚æœç³»ç»Ÿä½¿ç”¨äº†Vsyncæœºåˆ¶ï¼Œåˆ™æ³¨å†Œä¸€ä¸ªFrameDisplayEventReceiveræ¥æ”¶å™¨</span></span><br><span class="line">    mDisplayEventReceiver = USE_VSYNC ? <span class="keyword">new</span> FrameDisplayEventReceiver(looper) : <span class="keyword">null</span>;</span><br><span class="line">    mLastFrameTimeNanos = Long.MIN_VALUE;</span><br><span class="line">    <span class="comment">//å±å¹•åˆ·æ–°å‘¨æœŸ</span></span><br><span class="line">    mFrameIntervalNanos = (<span class="keyword">long</span>)(<span class="number">1000000000</span> / getRefreshRate());</span><br><span class="line">    <span class="comment">//åˆ›å»ºå›è°ƒæ•°ç»„  </span></span><br><span class="line">    mCallbackQueues = <span class="keyword">new</span> CallbackQueue[CALLBACK_LAST + <span class="number">1</span>];</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–æ•°ç»„</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= CALLBACK_LAST; i++) &#123;</span><br><span class="line">        mCallbackQueues[i] = <span class="keyword">new</span> CallbackQueue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FrameDisplayEventReceiverè¯¦ç»†è¿‡ç¨‹ä»¥åå†Android 7.1.2(Android N) Choreographeræœºåˆ¶å®ç°è¿‡ç¨‹åˆ†æã€‚</p><h4 id="2-9ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹"><a href="#2-9ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹" class="headerlink" title="2.9ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹"></a>2.9ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹</h4><p>çª—å£ç®¡ç†å™¨WindowManagerImplä¸ºå½“å‰æ·»åŠ çš„çª—å£åˆ›å»ºå¥½å„ç§å¯¹è±¡åï¼Œè°ƒç”¨ViewRootImplçš„setViewå‡½æ•°å‘WMSæœåŠ¡æ·»åŠ ä¸€ä¸ªçª—å£å¯¹è±¡ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">////å°†DecorViewä¿å­˜åˆ°ViewRootImplçš„æˆå‘˜å˜é‡mViewä¸­</span></span><br><span class="line">            mView = view;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            mSoftInputMode = attrs.softInputMode;</span><br><span class="line">            mWindowAttributesChanged = <span class="keyword">true</span>;</span><br><span class="line">            mWindowAttributesChangesFlag = WindowManager.LayoutParams.EVERYTHING_CHANGED;</span><br><span class="line">            <span class="comment">//åŒæ—¶å°†DecorViewä¿å­˜åˆ°mAttachInfoä¸­  </span></span><br><span class="line">            mAttachInfo.mRootView = view;</span><br><span class="line">            mAttachInfo.mScalingRequired = mTranslator != <span class="keyword">null</span>;</span><br><span class="line">            mAttachInfo.mApplicationScale =</span><br><span class="line">                    mTranslator == <span class="keyword">null</span> ? <span class="number">1.0f</span> : mTranslator.applicationScale;</span><br><span class="line">            <span class="keyword">if</span> (panelParentView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mAttachInfo.mPanelParentWindowToken</span><br><span class="line">                        = panelParentView.getApplicationWindowToken();</span><br><span class="line">            &#125;</span><br><span class="line">            mAdded = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">int</span> res; <span class="comment">/* = WindowManagerImpl.ADD_OKAY; */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//1ï¼‰åœ¨æ·»åŠ çª—å£å‰è¿›è¡ŒUIå¸ƒå±€  </span></span><br><span class="line">            requestLayout();</span><br><span class="line">            <span class="keyword">if</span> ((mWindowAttributes.inputFeatures</span><br><span class="line">                    &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</span><br><span class="line">                mInputChannel = <span class="keyword">new</span> InputChannel();</span><br><span class="line">            &#125;</span><br><span class="line">            mForceDecorViewVisibility = (mWindowAttributes.privateFlags</span><br><span class="line">                    &amp; PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mOrigWindowType = mWindowAttributes.type;</span><br><span class="line">                mAttachInfo.mRecomputeGlobalAttributes = <span class="keyword">true</span>;</span><br><span class="line">                collectViewAttributes();</span><br><span class="line">                 <span class="comment">//2)å°†çª—å£æ·»åŠ åˆ°WMSæœåŠ¡ä¸­ï¼ŒmWindowä¸ºWæœ¬åœ°Binderå¯¹è±¡ï¼Œé€šè¿‡Binderä¼ è¾“åˆ°WMSæœåŠ¡ç«¯åï¼Œå˜ä¸ºIWindowä»£ç†å¯¹è±¡  </span></span><br><span class="line">                res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                        getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                        mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                        mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">            &#125; ......</span><br><span class="line">            <span class="comment">//3)å»ºç«‹çª—å£æ¶ˆæ¯é€šé“  </span></span><br><span class="line">            <span class="keyword">if</span> (mInputChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mInputQueueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mInputQueue = <span class="keyword">new</span> InputQueue();</span><br><span class="line">                    mInputQueueCallback.onInputQueueCreated(mInputQueue);</span><br><span class="line">                &#125;</span><br><span class="line">                mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</span><br><span class="line">                        Looper.myLooper());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„UIä½œä¸ºä¸€ä¸ªå­Viewè¢«æ·»åŠ åˆ°DecorViewä¸­ï¼Œç„¶åå°†é¡¶çº§è§†å›¾DecorViewæ·»åŠ åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹çš„çª—å£ç®¡ç†å™¨ä¸­ï¼Œçª—å£ç®¡ç†å™¨é¦–å…ˆä¸ºå½“å‰æ·»åŠ çš„Viewåˆ›å»ºä¸€ä¸ªViewRootImplå¯¹è±¡ã€ä¸€ä¸ªå¸ƒå±€å‚æ•°å¯¹è±¡ViewGroup.LayoutParamsï¼Œç„¶åå°†è¿™ä¸‰ä¸ªå¯¹è±¡åˆ†åˆ«ä¿å­˜åˆ°å½“å‰åº”ç”¨ç¨‹åºè¿›ç¨‹çš„çª—å£ç®¡ç†å™¨WindowManagerImplä¸­ï¼Œæœ€åé€šè¿‡ViewRootImplå¯¹è±¡å°†å½“å‰è§†å›¾å¯¹è±¡æ³¨å†Œåˆ°WMSæœåŠ¡ä¸­ã€‚</p><p>ViewRootImplçš„setViewå‡½æ•°å‘WMSæœåŠ¡æ·»åŠ ä¸€ä¸ªçª—å£å¯¹è±¡è¿‡ç¨‹ï¼š</p><p>(1) requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›</p><p>(2) WindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›</p><p>(3) æ³¨å†Œåº”ç”¨ç¨‹åºè¿›ç¨‹ç«¯çš„æ¶ˆæ¯æ¥æ”¶é€šé“ï¼›</p><h3 id="1-ã€requestLayout-åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›"><a href="#1-ã€requestLayout-åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›" class="headerlink" title="(1)ã€requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›"></a>(1)ã€requestLayout()åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿›è¡Œçª—å£UIå¸ƒå±€ï¼›</h3><h4 id="2-10ã€çª—å£UIå¸ƒå±€è¿‡ç¨‹"><a href="#2-10ã€çª—å£UIå¸ƒå±€è¿‡ç¨‹" class="headerlink" title="2.10ã€çª—å£UIå¸ƒå±€è¿‡ç¨‹"></a>2.10ã€çª—å£UIå¸ƒå±€è¿‡ç¨‹</h4><p>requestLayoutå‡½æ•°è°ƒç”¨é‡Œé¢ä½¿ç”¨äº†Hanlderçš„ä¸€ä¸ªå°æ‰‹æ®µï¼Œé‚£å°±æ˜¯åˆ©ç”¨postSyncBarrieræ·»åŠ äº†ä¸€ä¸ªBarrierï¼ˆæŒ¡æ¿ï¼‰ï¼Œè¿™ä¸ªæŒ¡æ¿çš„ä½œç”¨æ˜¯é˜»å¡æ™®é€šçš„åŒæ­¥æ¶ˆæ¯çš„æ‰§è¡Œï¼Œåœ¨æŒ¡æ¿è¢«æ’¤é”€ä¹‹å‰ï¼Œåªä¼šæ‰§è¡Œå¼‚æ­¥æ¶ˆæ¯ï¼Œè€ŒrequestLayoutå…ˆæ·»åŠ äº†ä¸€ä¸ªæŒ¡æ¿Barrierï¼Œä¹‹åè‡ªå·±æ’å…¥äº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡mTraversalRunnableï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯ä¿è¯mTraversalRunnableåœ¨æ‰€æœ‰åŒæ­¥Messageä¹‹å‰è¢«æ‰§è¡Œï¼Œä¿è¯Viewç»˜åˆ¶çš„æœ€é«˜ä¼˜å…ˆçº§ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">        checkThread();</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mUnbufferedInputDispatch) &#123;</span><br><span class="line">            scheduleConsumeBatchedInput();</span><br><span class="line">        &#125;</span><br><span class="line">        notifyRendererOfFramePending();</span><br><span class="line">        pokeDrawLockIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-10-1ã€æ·»åŠ å›è°ƒè¿‡ç¨‹"><a href="#2-10-1ã€æ·»åŠ å›è°ƒè¿‡ç¨‹" class="headerlink" title="2.10.1ã€æ·»åŠ å›è°ƒè¿‡ç¨‹"></a>2.10.1ã€æ·»åŠ å›è°ƒè¿‡ç¨‹</h4><p>[-&gt;Choreographer.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallback</span><span class="params">(<span class="keyword">int</span> callbackType, Runnable action, Object token)</span> </span>&#123;</span><br><span class="line">    postCallbackDelayed(callbackType, action, token, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallbackDelayed</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">        Runnable action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    postCallbackDelayedInternal(callbackType, action, token, delayMillis);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postCallbackDelayedInternal</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> dueTime = now + delayMillis;</span><br><span class="line">        <span class="comment">//å°†è¦æ‰§è¡Œçš„å›è°ƒå°è£…æˆCallbackRecordå¯¹è±¡ï¼Œä¿å­˜åˆ°mCallbackQueuesæ•°ç»„ä¸­</span></span><br><span class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">            scheduleFrameLocked(now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">            msg.arg1 = callbackType;</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleFrameLocked</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mFrameScheduled) &#123;</span><br><span class="line">        mFrameScheduled = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (USE_VSYNC) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isRunningOnLooperThreadLocked()) &#123;</span><br><span class="line">                scheduleVsyncLocked();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_VSYNC);</span><br><span class="line">                msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">                mHandler.sendMessageAtFrontOfQueue(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> nextFrameTime = Math.max(</span><br><span class="line">                    mLastFrameTimeNanos / TimeUtils.NANOS_PER_MS + sFrameDelay, now);</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_FRAME);</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, nextFrameTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆæ¯å¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FrameHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FrameHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_DO_SCHEDULE_VSYNC:</span><br><span class="line">                doScheduleVsync();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">doScheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFrameScheduled) &#123;</span><br><span class="line">            scheduleVsyncLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleVsyncLocked</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="comment">//ç”³è¯·Vsyncä¿¡å·  </span></span><br><span class="line">mDisplayEventReceiver.scheduleVsync();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°ä¸­è€ƒè™‘äº†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ç³»ç»Ÿæ²¡æœ‰ä½¿ç”¨Vsyncæœºåˆ¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆæ ¹æ®å±å¹•åˆ·æ–°é¢‘ç‡è®¡ç®—ä¸‹ä¸€æ¬¡åˆ·æ–°æ—¶é—´ï¼Œé€šè¿‡å¼‚æ­¥æ¶ˆæ¯æ–¹å¼å»¶æ—¶æ‰§è¡ŒdoFrame()å‡½æ•°å®ç°å±å¹•åˆ·æ–°ã€‚å¦‚æœç³»ç»Ÿä½¿ç”¨äº†Vsyncæœºåˆ¶ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹å…·å¤‡æ¶ˆæ¯å¾ªç¯ï¼Œåˆ™ç›´æ¥è¯·æ±‚Vsyncä¿¡å·ï¼Œå¦åˆ™å°±é€šè¿‡ä¸»çº¿ç¨‹æ¥è¯·æ±‚Vsyncä¿¡å·ã€‚</p><h4 id="2-10-2ã€Vsyncè¯·æ±‚è¿‡ç¨‹"><a href="#2-10-2ã€Vsyncè¯·æ±‚è¿‡ç¨‹" class="headerlink" title="2.10.2ã€Vsyncè¯·æ±‚è¿‡ç¨‹"></a>2.10.2ã€Vsyncè¯·æ±‚è¿‡ç¨‹</h4><p>æˆ‘ä»¬çŸ¥é“åœ¨Choreographeræ„é€ å‡½æ•°ä¸­ï¼Œæ„é€ äº†ä¸€ä¸ªFrameDisplayEventReceiverå¯¹è±¡ï¼Œç”¨äºè¯·æ±‚å¹¶æ¥æ”¶Vsyncä¿¡å·ï¼ŒVsyncä¿¡å·è¯·æ±‚è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleVsyncLocked</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="comment">//ç”³è¯·Vsyncä¿¡å·  </span></span><br><span class="line">mDisplayEventReceiver.scheduleVsync();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;DisplayEventReceiver.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mReceiverPtr == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Attempted to schedule a vertical sync pulse but the display event "</span></span><br><span class="line">                + <span class="string">"receiver has already been disposed."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeScheduleVsync(mReceiverPtr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_DisplayEventReceiver.cpp ]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeScheduleVsync</span><span class="params">(JNIEnv* env, jclass clazz, jlong receiverPtr)</span> </span>&#123;</span><br><span class="line">sp&lt;NativeDisplayEventReceiver&gt; receiver =</span><br><span class="line">        reinterpret_cast&lt;NativeDisplayEventReceiver*&gt;(receiverPtr);</span><br><span class="line">status_t status = receiver-&gt;scheduleVsync();</span><br><span class="line"><span class="keyword">if</span> (status) &#123;</span><br><span class="line">    String8 message;</span><br><span class="line">    message.appendFormat(<span class="string">"Failed to schedule next vertical sync pulse.  status=%d"</span>, status);</span><br><span class="line">    jniThrowRuntimeException(env, message.string());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VSyncè¯·æ±‚è¿‡ç¨‹åˆè½¬äº¤ç»™äº†DisplayEventReceiverï¼š [-&gt;DisplayEventReceiver.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">status_t DisplayEventReceiver::requestNextVsync() &#123;</span><br><span class="line"><span class="keyword">if</span> (mEventConnection != NULL) &#123;</span><br><span class="line">    mEventConnection-&gt;requestNextVsync();</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> NO_INIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆé€šè¿‡IDisplayEventConnectionæ¥å£æ¥è¯·æ±‚Vsyncä¿¡å·ï¼ŒIDisplayEventConnectionå®ç°äº†Binderé€šä¿¡æ¡†æ¶ï¼Œå¯ä»¥è·¨è¿›ç¨‹è°ƒç”¨ï¼Œå› ä¸ºVsyncä¿¡å·è¯·æ±‚è¿›ç¨‹å’ŒVsyncäº§ç”Ÿè¿›ç¨‹æœ‰å¯èƒ½ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ç©ºé—´ï¼Œå› æ­¤è¿™é‡Œå°±å€ŸåŠ©IDisplayEventConnectionæ¥å£æ¥å®ç°ã€‚ä¸‹é¢é€šè¿‡å›¾æ¥æ¢³ç†Vsyncè¯·æ±‚çš„è°ƒç”¨æµç¨‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N5-Android-addWindow-requestNextVsync.png" alt="Markdown"></p><p>éœ€è¦è¯´æ˜çš„æ˜¯/<em>Vsync</em>/ä¹‹é—´çš„ä»£ç æ­¤æ—¶å…¶å®è¿˜æœªæ‰§è¡Œï¼Œcall requestNextVsync()æ¥å‘Šè¯‰ç³»ç»Ÿæˆ‘è¦åœ¨ä¸‹ä¸€ä¸ªVSYNCéœ€è¦è¢«trigger.</p><p>ç»§ç»­ViewRootImplçš„setViewå‡½æ•°ä¸­çš„WindowSession.addToDisplay()ã€‚</p><h4 id="2-ã€mWindowSession-addToDisplay-å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›"><a href="#2-ã€mWindowSession-addToDisplay-å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›" class="headerlink" title="(2) ã€mWindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›"></a>(2) ã€mWindowSession.addToDisplay()å‘WMSæœåŠ¡æ³¨å†Œä¸€ä¸ªçª—å£å¯¹è±¡ï¼›</h4><p>[Session.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addToDisplay</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId, Rect outContentInsets, Rect outStableInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outOutsets, InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mService.addWindow(<span class="keyword">this</span>, window, seq, attrs, viewVisibility, displayId,</span><br><span class="line">            outContentInsets, outStableInsets, outOutsets, outInputChannel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">boolean</span> reportNewConfig = <span class="keyword">false</span>;</span><br><span class="line">    WindowState attachedWindow = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">long</span> origId;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> type = attrs.type;</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> DisplayContent displayContent = getDisplayContentLocked(displayId);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">boolean</span> addToken = <span class="keyword">false</span>;</span><br><span class="line">        WindowToken token = mTokenMap.get(attrs.token);</span><br><span class="line">        AppWindowToken atoken = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> addToastWindowRequiresToken = <span class="keyword">false</span>;</span><br><span class="line">        ......</span><br><span class="line">        WindowState win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,</span><br><span class="line">                attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> WindowManagerGlobal.ADD_APP_EXITING;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        mPolicy.adjustWindowParamsLw(win.mAttrs);</span><br><span class="line">        win.setShowToOwnerOnlyLocked(mPolicy.checkShowToOwnerOnly(attrs));</span><br><span class="line">        res = mPolicy.prepareAddWindowLw(win, attrs);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> openInputChannels = (outInputChannel != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (attrs.inputFeatures &amp; INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>  (openInputChannels) &#123;</span><br><span class="line">            win.openInputChannel(outInputChannel);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (addToken) &#123;</span><br><span class="line">            mTokenMap.put(attrs.token, token);</span><br><span class="line">        &#125;</span><br><span class="line">        win.attach();</span><br><span class="line">        mWindowMap.put(client.asBinder(), win);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> imMayMove = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (type == TYPE_INPUT_METHOD) &#123;</span><br><span class="line">            win.mGivenInsetsPending = <span class="keyword">true</span>;</span><br><span class="line">            mInputMethodWindow = win;</span><br><span class="line">            addInputMethodWindowToListLocked(win);</span><br><span class="line">            imMayMove = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TYPE_INPUT_METHOD_DIALOG) &#123;</span><br><span class="line">            mInputMethodDialogs.add(win);</span><br><span class="line">            addWindowToListInOrderLocked(win, <span class="keyword">true</span>);</span><br><span class="line">            moveInputMethodDialogsLocked(findDesiredInputMethodWindowIndexLocked(<span class="keyword">true</span>));</span><br><span class="line">            imMayMove = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addWindowToListInOrderLocked(win, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (type == TYPE_WALLPAPER) &#123;</span><br><span class="line">                mWallpaperControllerLocked.clearLastWallpaperTimeoutTime();</span><br><span class="line">                displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((attrs.flags&amp;FLAG_SHOW_WALLPAPER) != <span class="number">0</span>) &#123;</span><br><span class="line">                displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mWallpaperControllerLocked.isBelowWallpaperTarget(win)) &#123;</span><br><span class="line">                displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        mInputMonitor.setUpdateInputWindowsNeededLw();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> focusChanged = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (win.canReceiveKeys()) &#123;</span><br><span class="line">            focusChanged = updateFocusedWindowLocked(UPDATE_FOCUS_WILL_ASSIGN_LAYERS,</span><br><span class="line">                    <span class="keyword">false</span> <span class="comment">/*updateInputWindows*/</span>);</span><br><span class="line">            <span class="keyword">if</span> (focusChanged) &#123;</span><br><span class="line">                imMayMove = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        mLayersController.assignLayersLocked(displayContent.getWindowList());</span><br><span class="line">        <span class="comment">// Don't do layout here, the window must call</span></span><br><span class="line">        <span class="comment">// relayout to be displayed, so we'll do it there.</span></span><br><span class="line">        <span class="keyword">if</span> (focusChanged) &#123;</span><br><span class="line">            mInputMonitor.setInputFocusLw(mCurrentFocus, <span class="keyword">false</span> <span class="comment">/*updateInputWindows*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mInputMonitor.updateInputWindowsLw(<span class="keyword">false</span> <span class="comment">/*force*/</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (reportNewConfig) &#123;</span><br><span class="line">        sendNewConfiguration();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“å½“åº”ç”¨ç¨‹åºè¿›ç¨‹æ·»åŠ ä¸€ä¸ªDecorViewåˆ°çª—å£ç®¡ç†å™¨æ—¶ï¼Œä¼šä¸ºå½“å‰æ·»åŠ çš„çª—å£åˆ›å»ºViewRootImplå¯¹è±¡ï¼ŒåŒæ—¶æ„é€ äº†ä¸€ä¸ªWæœ¬åœ°Binderå¯¹è±¡ï¼Œæ— è®ºæ˜¯çª—å£è§†å›¾å¯¹è±¡DecorViewè¿˜æ˜¯ViewRootImplå¯¹è±¡ï¼Œéƒ½åªæ˜¯å­˜åœ¨äºåº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ï¼Œåœ¨æ·»åŠ çª—å£è¿‡ç¨‹ä¸­ä»…ä»…å°†è¯¥çª—å£çš„Wå¯¹è±¡ä¼ é€’ç»™WMSæœåŠ¡ï¼Œç»è¿‡Binderä¼ è¾“åï¼Œåˆ°è¾¾WMSæœåŠ¡ç«¯è¿›ç¨‹åå˜ä¸ºIWindow.Proxyä»£ç†å¯¹è±¡ï¼Œå› æ­¤è¯¥å‡½æ•°çš„å‚æ•°clientçš„ç±»å‹ä¸ºIWindow.Proxyã€‚å‚æ•°attrsçš„ç±»å‹ä¸ºWindowManager.LayoutParamsï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨Activityæ—¶ï¼ŒhandleResumeActivity()å‡½æ•°é€šè¿‡WindowManager.LayoutParams l = r.window.getAttributes();æ¥å¾—åˆ°åº”ç”¨ç¨‹åºçª—å£å¸ƒå±€å‚æ•°ï¼Œç”±äºWindowManager.LayoutParamså®ç°äº†Parcelableæ¥å£ï¼Œå› æ­¤WindowManager.LayoutParamså¯¹è±¡å¯ä»¥è·¨è¿›ç¨‹ä¼ è¾“ï¼ŒWMSæœåŠ¡çš„addWindowå‡½æ•°ä¸­çš„attrså‚æ•°å°±æ˜¯åº”ç”¨ç¨‹åºè¿›ç¨‹å‘é€è¿‡æ¥çš„çª—å£å¸ƒå±€å‚æ•°ã€‚åœ¨WindowManagerImplçš„addViewå‡½æ•°ä¸­ä¸ºçª—å£å¸ƒå±€å‚æ•°è®¾ç½®äº†ç›¸åº”çš„tokenï¼Œå¦‚æœæ˜¯åº”ç”¨ç¨‹åºçª—å£ï¼Œåˆ™å¸ƒå±€å‚æ•°çš„tokenè®¾ä¸ºWæœ¬åœ°Binderå¯¹è±¡ã€‚å¦‚æœä¸æ˜¯åº”ç”¨ç¨‹åºçª—å£ï¼ŒåŒæ—¶å½“å‰çª—å£æ²¡æœ‰çˆ¶çª—å£ï¼Œåˆ™è®¾ç½®tokenä¸ºå½“å‰çª—å£çš„IApplicationToken.Proxyä»£ç†å¯¹è±¡ï¼Œå¦åˆ™è®¾ç½®ä¸ºçˆ¶çª—å£çš„IApplicationToken.Proxyä»£ç†å¯¹è±¡ï¼Œç”±äºåº”ç”¨ç¨‹åºå’ŒWMSåˆ†å±äºä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ç©ºé—´ï¼Œå› æ­¤ç»è¿‡Binderä¼ è¾“åï¼Œå¸ƒå±€å‚æ•°çš„ä»¤ç‰Œattrs.tokenå°±è½¬å˜ä¸ºIWindow.Proxyæˆ–è€…Tokenã€‚ä»¥ä¸Šå‡½æ•°é¦–å…ˆæ ¹æ®å¸ƒå±€å‚æ•°çš„tokenç­‰ä¿¡æ¯æ„é€ ä¸€ä¸ªWindowTokenå¯¹è±¡ï¼Œç„¶ååœ¨æ„é€ ä¸€ä¸ªWindowStateå¯¹è±¡ï¼Œå¹¶å°†æ·»åŠ çš„çª—å£ä¿¡æ¯è®°å½•åˆ°mTokenMapå’ŒmWindowMapå“ˆå¸Œè¡¨ä¸­ã€‚</p><p>åœ¨WMSæœåŠ¡ç«¯åˆ›å»ºäº†æ‰€éœ€å¯¹è±¡åï¼Œæ¥ç€è°ƒç”¨äº†WindowStateçš„attach()æ¥è¿›ä¸€æ­¥å®Œæˆçª—å£æ·»åŠ ã€‚ [WindowState.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(</span><br><span class="line">        TAG, <span class="string">"Attaching "</span> + <span class="keyword">this</span> + <span class="string">" token="</span> + mToken</span><br><span class="line">        + <span class="string">", list="</span> + mToken.windows);</span><br><span class="line">    mSession.windowAddedLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Session.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">windowAddedLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mSurfaceSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(</span><br><span class="line">            TAG_WM, <span class="string">"First window added to "</span> + <span class="keyword">this</span> + <span class="string">", creating SurfaceSession"</span>);</span><br><span class="line">        mSurfaceSession = <span class="keyword">new</span> SurfaceSession();</span><br><span class="line">        <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">                TAG_WM, <span class="string">"  NEW SURFACE SESSION "</span> + mSurfaceSession);</span><br><span class="line">        mService.mSessions.add(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) &#123;</span><br><span class="line">            mService.dispatchNewAnimatorScaleLocked(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mNumWindow++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="SurfaceSessionå»ºç«‹è¿‡ç¨‹"><a href="#SurfaceSessionå»ºç«‹è¿‡ç¨‹" class="headerlink" title="SurfaceSessionå»ºç«‹è¿‡ç¨‹"></a>SurfaceSessionå»ºç«‹è¿‡ç¨‹</h5><p>SurfaceSessionå¯¹è±¡æ‰¿æ‹…äº†åº”ç”¨ç¨‹åºä¸SurfaceFlingerä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹ï¼Œæ¯ä¸€ä¸ªéœ€è¦ä¸SurfaceFlingerè¿›ç¨‹äº¤äº’çš„åº”ç”¨ç¨‹åºç«¯éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªSurfaceSessionå¯¹è±¡ã€‚</p><p>å®¢æˆ·ç«¯è¯·æ±‚ [SurfaceSession.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SurfaceSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mNativeClient = nativeCreate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaå±‚çš„SurfaceSessionå¯¹è±¡æ„é€ è¿‡ç¨‹ä¼šé€šè¿‡JNIåœ¨nativeå±‚åˆ›å»ºä¸€ä¸ªSurfaceComposerClientå¯¹è±¡ã€‚</p><p>[android_view_SurfaceSession.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz)</span> </span>&#123;</span><br><span class="line">SurfaceComposerClient* client = <span class="keyword">new</span> SurfaceComposerClient();</span><br><span class="line">client-&gt;incStrong((<span class="keyword">void</span>*)nativeCreate);</span><br><span class="line"><span class="keyword">return</span> reinterpret_cast&lt;jlong&gt;(client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaå±‚çš„SurfaceSessionå¯¹è±¡ä¸C++å±‚çš„SurfaceComposerClientå¯¹è±¡ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€å…³ç³»ã€‚ [SurfaceComposerClient.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SurfaceComposerClient::SurfaceComposerClient()</span><br><span class="line">: mStatus(NO_INIT), mComposer(Composer::getInstance())&#123;&#125;</span><br><span class="line"><span class="keyword">void</span> SurfaceComposerClient::onFirstRef() &#123;</span><br><span class="line"><span class="comment">//å¾—åˆ°SurfaceFlingerçš„ä»£ç†å¯¹è±¡BpSurfaceComposer  </span></span><br><span class="line"><span class="function">sp&lt;ISurfaceComposer&gt; <span class="title">sm</span><span class="params">(ComposerService::getComposerService()</span>)</span>;</span><br><span class="line"><span class="keyword">if</span> (sm != <span class="number">0</span>) &#123;</span><br><span class="line">    sp&lt;ISurfaceComposerClient&gt; conn = sm-&gt;createConnection();</span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="number">0</span>) &#123;</span><br><span class="line">        mClient = conn;</span><br><span class="line">        mStatus = NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceComposerClientç»§æ‰¿äºRefBaseç±»ï¼Œå½“ç¬¬ä¸€æ¬¡è¢«å¼ºå¼•ç”¨æ—¶ï¼ŒonFirstRefå‡½æ•°è¢«å›è°ƒï¼Œåœ¨è¯¥å‡½æ•°ä¸­SurfaceComposerClientä¼šè¯·æ±‚SurfaceFlingerä¸ºå½“å‰åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªClientå¯¹è±¡ï¼Œä¸“é—¨æ¥æ”¶è¯¥åº”ç”¨ç¨‹åºçš„è¯·æ±‚ï¼Œåœ¨SurfaceFlingerç«¯åˆ›å»ºå¥½Clientæœ¬åœ°Binderå¯¹è±¡åï¼Œå°†è¯¥Binderä»£ç†å¯¹è±¡è¿”å›ç»™åº”ç”¨ç¨‹åºç«¯ï¼Œå¹¶ä¿å­˜åœ¨SurfaceComposerClientçš„æˆå‘˜å˜é‡mClientä¸­ã€‚</p><p>æœåŠ¡ç«¯å¤„ç† åœ¨SurfaceFlingeræœåŠ¡ç«¯ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºäº¤äº’çš„Clientå¯¹è±¡ [SurfaceFlinger.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ISurfaceComposerClient&gt; SurfaceFlinger::createConnection()</span><br><span class="line">&#123;</span><br><span class="line">sp&lt;ISurfaceComposerClient&gt; bclient;</span><br><span class="line"><span class="function">sp&lt;Client&gt; <span class="title">client</span><span class="params">(new Client(<span class="keyword">this</span>)</span>)</span>;</span><br><span class="line">status_t err = client-&gt;initCheck();</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    bclient = client;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> bclient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N6-Android-addWindow-SF-Client.png" alt="Markdown"></p><p>/<strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong>Vsync<strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong>/</p><h3 id="Vsyncä¿¡å·å¤„ç†"><a href="#Vsyncä¿¡å·å¤„ç†" class="headerlink" title="Vsyncä¿¡å·å¤„ç†"></a>Vsyncä¿¡å·å¤„ç†</h3><p>ä»¥ä¸Šæ˜¯è¯·æ±‚è¿‡ç¨‹ï¼ŒFrameDisplayEventReceiverå¯¹è±¡ç”¨äºè¯·æ±‚å¹¶æ¥æ”¶Vsyncä¿¡å·ï¼Œå½“Vsyncä¿¡å·åˆ°æ¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨å…¶onVsync()å‡½æ•°ï¼Œåé¢ä¼šå›è°ƒåˆ°FrameDisplayEventReceiver.runæ–¹æ³•ï¼ˆWhy â€œåŒæ­¥åˆ†å‰²æ â€ï¼Ÿ<a href="http://xfenglin.com/a/12007076930.html" target="_blank" rel="noopener">å†åˆ†æ</a>ï¼‰ï¼Œå†å›è°ƒå‡½æ•°ä¸­æ‰§è¡ŒdoFrame()å®ç°å±å¹•åˆ·æ–°ã€‚ å½“VSYNCä¿¡å·åˆ°è¾¾æ—¶ï¼ŒChoreographer doFrame()å‡½æ•°è¢«è°ƒç”¨ [-&gt;Choreographer.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos, <span class="keyword">int</span> frame)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> startNanos;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> intendedFrameTimeNanos = frameTimeNanos;</span><br><span class="line">        <span class="comment">//ä¿å­˜èµ·å§‹æ—¶é—´</span></span><br><span class="line">        startNanos = System.nanoTime();</span><br><span class="line">        <span class="comment">//ç”±äºVsyncäº‹ä»¶å¤„ç†é‡‡ç”¨çš„æ˜¯å¼‚æ­¥æ–¹å¼ï¼Œå› æ­¤è¿™é‡Œè®¡ç®—æ¶ˆæ¯å‘é€ä¸å‡½æ•°è°ƒç”¨å¼€å§‹ä¹‹é—´æ‰€èŠ±è´¹çš„æ—¶é—´</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> jitterNanos = startNanos - frameTimeNanos;</span><br><span class="line">        <span class="comment">//è®¡ç®—å‡½æ•°è°ƒç”¨æœŸé—´æ‰€é”™è¿‡çš„å¸§æ•°  </span></span><br><span class="line">        <span class="keyword">if</span> (jitterNanos &gt;= mFrameIntervalNanos) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> skippedFrames = jitterNanos / mFrameIntervalNanos;</span><br><span class="line">            <span class="keyword">if</span> (skippedFrames &gt;= SKIPPED_FRAME_WARNING_LIMIT) &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">"Skipped "</span> + skippedFrames + <span class="string">" frames!  "</span></span><br><span class="line">                        + <span class="string">"The application may be doing too much work on its main thread."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> lastFrameOffset = jitterNanos % mFrameIntervalNanos;</span><br><span class="line">            frameTimeNanos = startNanos - lastFrameOffset;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœframeTimeNanoså°äºä¸€ä¸ªå±å¹•åˆ·æ–°å‘¨æœŸï¼Œåˆ™é‡æ–°è¯·æ±‚VSyncä¿¡å·</span></span><br><span class="line">        <span class="keyword">if</span> (frameTimeNanos &lt; mLastFrameTimeNanos) &#123;</span><br><span class="line">            scheduleVsyncLocked();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mFrameInfo.setVsync(intendedFrameTimeNanos, frameTimeNanos);</span><br><span class="line">        mFrameScheduled = <span class="keyword">false</span>;</span><br><span class="line">        mLastFrameTimeNanos = frameTimeNanos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//åˆ†åˆ«å›è°ƒCALLBACK_INPUTã€CALLBACK_ANIMATIONã€CALLBACK_TRAVERSALã€CALLBACK_COMMITäº‹ä»¶  </span></span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos);</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N7-Android-addWindow-Vsync-time.png" alt="Markdown"><br>Choreographerç±»ä¸­åˆ†åˆ«å®šä¹‰äº†CallbackRecordã€CallbackQueueå†…éƒ¨ç±»ï¼ŒCallbackQueueæ˜¯ä¸€ä¸ªæŒ‰æ—¶é—´å…ˆåé¡ºåºä¿å­˜CallbackRecordçš„å•å‘å¾ªç¯é“¾è¡¨ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N8-Android-addWindow-CallBackRecord.png" alt="Markdown"><br>åœ¨Choreographerä¸­å®šä¹‰äº†ä¸‰ä¸ªCallbackQueueé˜Ÿåˆ—ï¼Œç”¨æ•°ç»„mCallbackQueuesè¡¨ç¤ºï¼Œç”¨äºåˆ†åˆ«ä¿å­˜CALLBACK_INPUTã€CALLBACK_ANIMATIONã€CALLBACK_TRAVERSALè¿™ä¸‰ç§ç±»å‹çš„Callbackï¼Œå½“è°ƒç”¨Choreographerç±»çš„postCallback()å‡½æ•°æ—¶ï¼Œå°±æ˜¯å¾€æŒ‡å®šç±»å‹çš„CallbackQueueé˜Ÿåˆ—ä¸­é€šè¿‡addCallbackLocked()å‡½æ•°æ·»åŠ ä¸€ä¸ªCallbackRecordé¡¹ï¼šé¦–å…ˆæ„é€ ä¸€ä¸ªCallbackRecordå¯¹è±¡ï¼Œç„¶åæŒ‰æ—¶é—´å…ˆåé¡ºåºæ’å…¥åˆ°CallbackQueueé“¾è¡¨ä¸­ã€‚ä»ä»£ç æ³¨é‡Šä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“CALLBACK_INPUTæ˜¯æŒ‡è¾“å…¥å›è°ƒï¼Œè¯¥å›è°ƒä¼˜å…ˆçº§æœ€é«˜ï¼Œé¦–å…ˆå¾—åˆ°æ‰§è¡Œï¼Œè€ŒCALLBACK_TRAVERSALæ˜¯æŒ‡å¤„ç†å¸ƒå±€å’Œç»˜å›¾çš„å›è°ƒï¼Œåªæœ‰åœ¨æ‰€æœ‰å¼‚æ­¥æ¶ˆæ¯éƒ½æ‰§è¡Œå®Œåæ‰å¾—åˆ°æ‰§è¡Œï¼ŒCALLBACK_ANIMATIONæ˜¯æŒ‡åŠ¨ç”»å›è°ƒï¼Œæ¯”CALLBACK_TRAVERSALä¼˜å…ˆæ‰§è¡Œï¼Œä»doFrame()å‡½æ•°ä¸­çš„doCallbacksè°ƒç”¨å°±èƒ½å°è¯è¿™ç‚¹ã€‚ å½“Vsyncäº‹ä»¶åˆ°æ¥æ—¶ï¼Œé¡ºåºæ‰§è¡ŒCALLBACK_INPUTã€CALLBACK_ANIMATIONã€CALLBACK_TRAVERSAL å’ŒCALLBACK_COMMIT å¯¹åº”CallbackQueueé˜Ÿåˆ—ä¸­æ³¨å†Œçš„å›è°ƒã€‚ [-&gt;Choreographer.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doCallbacks</span><span class="params">(<span class="keyword">int</span> callbackType, <span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">    CallbackRecord callbacks;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.nanoTime();</span><br><span class="line">        <span class="comment">//ä»æŒ‡å®šç±»å‹çš„CallbackQueueé˜Ÿåˆ—ä¸­æŸ¥æ‰¾æ‰§è¡Œæ—¶é—´åˆ°çš„CallbackRecord</span></span><br><span class="line">        callbacks = mCallbackQueues[callbackType].extractDueCallbacksLocked(</span><br><span class="line">                now / TimeUtils.NANOS_PER_MS);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callbackType == Choreographer.CALLBACK_COMMIT) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> jitterNanos = now - frameTimeNanos;</span><br><span class="line">            <span class="keyword">if</span> (jitterNanos &gt;= <span class="number">2</span> * mFrameIntervalNanos) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> lastFrameOffset = jitterNanos % mFrameIntervalNanos</span><br><span class="line">                        + mFrameIntervalNanos;</span><br><span class="line">                    mDebugPrintNextFrameTimeDelta = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                frameTimeNanos = now - lastFrameOffset;</span><br><span class="line">                mLastFrameTimeNanos = frameTimeNanos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (CallbackRecord c = callbacks; c != <span class="keyword">null</span>; c = c.next) &#123;</span><br><span class="line">          <span class="comment">//ç”±äºCallbackQueuesæ˜¯æŒ‰æ—¶é—´å…ˆåé¡ºåºæ’åºçš„ï¼Œå› æ­¤éå†æ‰§è¡Œæ‰€æœ‰æ—¶é—´åˆ°çš„CallbackRecord  </span></span><br><span class="line">            c.run(frameTimeNanos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            mCallbacksRunning = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> CallbackRecord next = callbacks.next;</span><br><span class="line">                recycleCallbackLocked(callbacks);</span><br><span class="line">                callbacks = next;</span><br><span class="line">            &#125; <span class="keyword">while</span> (callbacks != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“Choreographerå¯¹å¤–æä¾›äº†ä¸¤ä¸ªæ¥å£å‡½æ•°ç”¨äºæ³¨å†ŒæŒ‡å®šçš„Callbackï¼ŒpostCallback()ç”¨äºæ³¨å†ŒRunnableå¯¹è±¡ï¼Œè€ŒpostFrameCallback()å‡½æ•°ç”¨äºæ³¨å†ŒFrameCallbackå¯¹è±¡ï¼Œæ— è®ºæ³¨å†Œçš„æ˜¯Runnableå¯¹è±¡è¿˜æ˜¯FrameCallbackå¯¹è±¡ï¼Œåœ¨CallbackRecordå¯¹è±¡ä¸­ç»Ÿä¸€è£…ç®±ä¸ºObjectç±»å‹ã€‚åœ¨æ‰§è¡Œå…¶å›è°ƒå‡½æ•°æ—¶ï¼Œå°±éœ€è¦åŒºåˆ«è¿™ä¸¤ç§å¯¹è±¡ç±»å‹ï¼Œå¦‚æœæ³¨å†Œçš„æ˜¯Runnableå¯¹è±¡ï¼Œåˆ™è°ƒç”¨å…¶run()å‡½æ•°ï¼Œå¦‚æœæ³¨å†Œçš„æ˜¯FrameCallbackå¯¹è±¡ï¼Œåˆ™è°ƒç”¨å®ƒçš„doFrame()å‡½æ•°ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N9-Android-addWindow-Choreographer.png" alt="Markdown"></p><h4 id="2-11ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹"><a href="#2-11ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹" class="headerlink" title="2.11ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹"></a>2.11ã€è§†å›¾Viewæ·»åŠ è¿‡ç¨‹</h4><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N10-Android-addWindow-AT-WMS.png" alt="Markdown"></p><p>å…³äºChoreographerçš„postCallback()ç”¨æ³•åœ¨å‰é¢è¿›è¡Œäº†è¯¦ç»†çš„ä»‹ç»ï¼Œå½“Vsyncäº‹ä»¶åˆ°æ¥æ—¶ï¼ŒmTraversalRunnableå¯¹è±¡çš„run()å‡½æ•°å°†è¢«è°ƒç”¨ã€‚</p><p>mTraversalRunnableå¯¹è±¡çš„ç±»å‹ä¸ºTraversalRunnableï¼Œè¯¥ç±»å®ç°äº†Runnableæ¥å£ï¼Œåœ¨å…¶run()å‡½æ•°ä¸­è°ƒç”¨äº†doTraversal()å‡½æ•°æ¥å®Œæˆçª—å£å¸ƒå±€ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> TraversalRunnable mTraversalRunnable = <span class="keyword">new</span> TraversalRunnable();</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">            Debug.startMethodTracing(<span class="string">"ViewAncestor"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        performTraversals();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">            Debug.stopMethodTracing();</span><br><span class="line">            mProfile = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>performTraversalså‡½æ•°ç›¸å½“å¤æ‚ï¼Œå…¶ä¸»è¦å®ç°ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š</p><p>1.æ‰§è¡Œçª—å£æµ‹é‡ï¼›</p><p>2.æ‰§è¡Œçª—å£æ³¨å†Œï¼›</p><p>3.æ‰§è¡Œçª—å£å¸ƒå±€ï¼›</p><p>4.æ‰§è¡Œçª—å£ç»˜å›¾ï¼›</p><p>[-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> View host = mView;</span><br><span class="line">    mIsInTraversal = <span class="keyword">true</span>;</span><br><span class="line">    mWillDrawSoon = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> windowSizeMayChange = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> newSurface = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> surfaceChanged = <span class="keyword">false</span>;</span><br><span class="line">    WindowManager.LayoutParams lp = mWindowAttributes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> desiredWindowWidth;</span><br><span class="line">    <span class="keyword">int</span> desiredWindowHeight;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewVisibility = getHostVisibility();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> viewVisibilityChanged = !mFirst</span><br><span class="line">            &amp;&amp; (mViewVisibility != viewVisibility || mNewSurfaceNeeded);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> viewUserVisibilityChanged = !mFirst &amp;&amp;</span><br><span class="line">            ((mViewVisibility == View.VISIBLE) != (viewVisibility == View.VISIBLE));</span><br><span class="line"></span><br><span class="line">    WindowManager.LayoutParams params = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mWindowAttributesChanged) &#123;</span><br><span class="line">        mWindowAttributesChanged = <span class="keyword">false</span>;</span><br><span class="line">        surfaceChanged = <span class="keyword">true</span>;</span><br><span class="line">        params = lp;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£æµ‹é‡******************/</span>  </span><br><span class="line">    <span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">    <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line"></span><br><span class="line">        windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/****************å‘WMSæœåŠ¡æ·»åŠ çª—å£******************/</span>  </span><br><span class="line">    <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">            viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (!mStopped || mReportNextDraw) &#123;</span><br><span class="line">            ......</span><br><span class="line">                 <span class="comment">// Ask host how big it wants to be</span></span><br><span class="line">                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£å¸ƒå±€******************/</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">    <span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</span><br><span class="line">            || mAttachInfo.mRecomputeGlobalAttributes;</span><br><span class="line">    <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">        performLayout(lp, mWidth, mHeight);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">/****************æŸ¥æ‰¾çª—å£ç„¦ç‚¹******************/</span></span><br><span class="line">    <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (mView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mView.hasFocus()) &#123;</span><br><span class="line">                mView.requestFocus(View.FOCUS_FORWARD);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> changedVisibility = (viewVisibilityChanged || mFirst) &amp;&amp; isViewVisible;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasWindowFocus = mAttachInfo.mHasWindowFocus &amp;&amp; isViewVisible;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> regainedFocus = hasWindowFocus &amp;&amp; mLostWindowFocus;</span><br><span class="line">    <span class="keyword">if</span> (regainedFocus) &#123;</span><br><span class="line">        mLostWindowFocus = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasWindowFocus &amp;&amp; mHadWindowFocus) &#123;</span><br><span class="line">        mLostWindowFocus = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (changedVisibility || regainedFocus) &#123;</span><br><span class="line">        <span class="comment">// Toasts are presented as notifications - don't present them as windows as well</span></span><br><span class="line">        <span class="keyword">boolean</span> isToast = (mWindowAttributes == <span class="keyword">null</span>) ? <span class="keyword">false</span></span><br><span class="line">                : (mWindowAttributes.type == WindowManager.LayoutParams.TYPE_TOAST);</span><br><span class="line">        <span class="keyword">if</span> (!isToast) &#123;</span><br><span class="line">            host.sendAccessibilityEvent(AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mFirst = <span class="keyword">false</span>;</span><br><span class="line">    mWillDrawSoon = <span class="keyword">false</span>;</span><br><span class="line">    mNewSurfaceNeeded = <span class="keyword">false</span>;</span><br><span class="line">    mActivityRelaunched = <span class="keyword">false</span>;</span><br><span class="line">    mViewVisibility = viewVisibility;</span><br><span class="line">    mHadWindowFocus = hasWindowFocus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasWindowFocus &amp;&amp; !isInLocalFocusMode()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> imTarget = WindowManager.LayoutParams</span><br><span class="line">                .mayUseInputMethod(mWindowAttributes.flags);</span><br><span class="line">        <span class="keyword">if</span> (imTarget != mLastWasImTarget) &#123;</span><br><span class="line">            mLastWasImTarget = imTarget;</span><br><span class="line">            InputMethodManager imm = InputMethodManager.peekInstance();</span><br><span class="line">            <span class="keyword">if</span> (imm != <span class="keyword">null</span> &amp;&amp; imTarget) &#123;</span><br><span class="line">                imm.onPreWindowFocus(mView, hasWindowFocus);</span><br><span class="line">                imm.onPostWindowFocus(mView, mView.findFocus(),</span><br><span class="line">                        mWindowAttributes.softInputMode,</span><br><span class="line">                        !mHasHadWindowFocus, mWindowAttributes.flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remember if we must report the next draw.</span></span><br><span class="line">    <span class="keyword">if</span> ((relayoutResult &amp; WindowManagerGlobal.RELAYOUT_RES_FIRST_TIME) != <span class="number">0</span>) &#123;</span><br><span class="line">        mReportNextDraw = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/****************æ‰§è¡Œçª—å£ç»˜åˆ¶******************/</span>  </span><br><span class="line">    <span class="keyword">boolean</span> cancelDraw = mAttachInfo.mTreeObserver.dispatchOnPreDraw() || !isViewVisible;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                mPendingTransitions.get(i).startChangingAnimations();</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingTransitions.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        performDraw();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isViewVisible) &#123;</span><br><span class="line">            <span class="comment">// Try again</span></span><br><span class="line">            scheduleTraversals();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                mPendingTransitions.get(i).endChangingAnimations();</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingTransitions.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mIsInTraversal = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1ã€æ‰§è¡Œçª—å£æµ‹é‡performMeasure"><a href="#1ã€æ‰§è¡Œçª—å£æµ‹é‡performMeasure" class="headerlink" title="1ã€æ‰§è¡Œçª—å£æµ‹é‡performMeasure()"></a>1ã€æ‰§è¡Œçª—å£æµ‹é‡performMeasure()</h4><p>[-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2ã€æ‰§è¡Œçª—å£æ³¨å†ŒrelayoutWindowï¼›"><a href="#2ã€æ‰§è¡Œçª—å£æ³¨å†ŒrelayoutWindowï¼›" class="headerlink" title="2ã€æ‰§è¡Œçª—å£æ³¨å†ŒrelayoutWindowï¼›"></a>2ã€æ‰§è¡Œçª—å£æ³¨å†ŒrelayoutWindowï¼›</h4><p>[-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(WindowManager.LayoutParams params, <span class="keyword">int</span> viewVisibility,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> insetsPending)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">int</span> relayoutResult = mWindowSession.relayout(</span><br><span class="line">            mWindow, mSeq, params,</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredWidth() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredHeight() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            viewVisibility, insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="number">0</span>,</span><br><span class="line">            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</span><br><span class="line">            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingConfiguration,</span><br><span class="line">            mSurface);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> relayoutResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡å‰é¢è·å–çš„IWindowSessionä»£ç†å¯¹è±¡è¯·æ±‚WMSæœåŠ¡æ‰§è¡Œçª—å£å¸ƒå±€ï¼ŒmSurfaceæ˜¯ViewRootImplçš„æˆå‘˜å˜é‡ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Surface mSurface = <span class="keyword">new</span> Surface();</span><br></pre></td></tr></table></figure><p>[-&gt;Surface.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create an empty surface, which will later be filled in by readFromParcel().</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Surface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥Surfaceæ„é€ å‡½æ•°ä»…ä»…åˆ›å»ºäº†ä¸€ä¸ªç©ºSurfaceå¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å¯¹è¯¥Surfaceè¿›ç¨‹nativeå±‚çš„åˆå§‹åŒ–ï¼Œåˆ°æ­¤æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸ºæ¯ä¸ªçª—å£å¯¹è±¡éƒ½åˆ›å»ºäº†ä¸€ä¸ªSurfaceå¯¹è±¡ã€‚å¹¶ä¸”å°†è¯¥Surfaceé€šè¿‡è·¨è¿›ç¨‹æ–¹å¼ä¼ è¾“ç»™WMSæœåŠ¡è¿›ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Androidç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡éœ€è¦åœ¨ä¸åŒè¿›ç¨‹é—´ä¼ è¾“ï¼Œå¿…é¡»å®ç°Parcelableæ¥å£ï¼ŒSurfaceç±»æ­£å¥½å®ç°äº†Parcelableæ¥å£ã€‚ViewRootImplé€šè¿‡IWindowSessionæ¥å£è¯·æ±‚WMSçš„å®Œæ•´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>[-&gt;IWindowSession.java$ Proxy]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* This file is auto-generated.  DO NOT MODIFY</span></span><br><span class="line"><span class="comment">*  * Original file: frameworks/base/core/java/android/view/IWindowSession.aidl</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(android.view.IWindow window, <span class="keyword">int</span> seq, android.view.WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags, android.graphics.Rect outFrame, android.graphics.Rect outOverscanInsets, android.graphics.Rect outContentInsets, android.graphics.Rect outVisibleInsets, android.graphics.Rect outStableInsets, android.graphics.Rect outOutsets, android.graphics.Rect outBackdropFrame, android.content.res.Configuration outConfig, android.view.Surface outSurface)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line"><span class="keyword">int</span> _result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    mRemote.transact(Stub.TRANSACTION_relayout, _data, _reply, <span class="number">0</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ((<span class="number">0</span> != _reply.readInt())) &#123;</span><br><span class="line">        outSurface.readFromParcel(_reply);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¯¥å‡½æ•°çš„å®ç°å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­åˆ›å»ºçš„Surfaceå¯¹è±¡å¹¶æ²¡æœ‰ä¼ é€’åˆ°WMSæœåŠ¡è¿›ç¨‹ï¼Œåªæ˜¯è¯»å–WMSæœåŠ¡è¿›ç¨‹è¿”å›æ¥çš„Surfaceã€‚é‚£ä¹ˆWMSæœåŠ¡è¿›ç¨‹æ˜¯å¦‚ä½•å“åº”åº”ç”¨ç¨‹åºè¿›ç¨‹å¸ƒå±€è¯·æ±‚çš„å‘¢ï¼Ÿ</p><p>[-&gt;IWindowSession.java$ Stub]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">switch</span> (code)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> TRANSACTION_relayout:</span><br><span class="line">  &#123;</span><br><span class="line">    ......</span><br><span class="line">    android.view.Surface _arg15;</span><br><span class="line">    _arg15 = <span class="keyword">new</span> android.view.Surface();</span><br><span class="line">    <span class="keyword">int</span> _result = <span class="keyword">this</span>.relayout(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7, _arg8, _arg9, _arg10, _arg11, _arg12, _arg13, _arg14, _arg15);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(_result);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ((_arg15!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">    reply.writeInt(<span class="number">1</span>);</span><br><span class="line">    _arg15.writeToParcel(reply, android.os.Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å¯ä»¥çœ‹å‡ºï¼ŒWMSæœåŠ¡åœ¨å“åº”åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚æ·»åŠ çª—å£æ—¶ï¼Œé¦–å…ˆåœ¨å½“å‰è¿›ç¨‹ç©ºé—´åˆ›å»ºä¸€ä¸ªSurfaceå¯¹è±¡ï¼Œç„¶åè°ƒç”¨Sessionçš„relayout()å‡½æ•°è¿›ä¸€æ­¥å®Œæˆçª—å£æ·»åŠ è¿‡ç¨‹ï¼Œæœ€åå°†WMSæœåŠ¡ä¸­åˆ›å»ºçš„Surfaceè¿”å›ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N11-Android-addWindow-App-WMS-Surface.png" alt="Markdown"></p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹å’ŒWMSæœåŠ¡è¿›ç¨‹åˆ†åˆ«åˆ›å»ºäº†ä¸€ä¸ªSurfaceå¯¹è±¡ï¼Œä½†æ˜¯ä»–ä»¬è°ƒç”¨çš„éƒ½æ˜¯Surfaceçš„æ— å‚æ„é€ å‡½æ•°ï¼Œåœ¨è¯¥æ„é€ å‡½æ•°ä¸­å¹¶æœªçœŸæ­£åˆå§‹åŒ–nativeå±‚çš„Surfaceï¼Œé‚£nativeå±‚çš„Surfaceæ˜¯åœ¨é‚£é‡Œåˆ›å»ºçš„å‘¢ï¼Ÿ</p><p>[-&gt;Session.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = mService.relayoutWindow(<span class="keyword">this</span>, window, seq, attrs,</span><br><span class="line">            requestedWidth, requestedHeight, viewFlags, flags,</span><br><span class="line">            outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</span><br><span class="line">            outStableInsets, outsets, outBackdropFrame, outConfig, outSurface);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">if</span> (viewVisibility == View.VISIBLE &amp;&amp;</span><br><span class="line">                (win.mAppToken == <span class="keyword">null</span> || !win.mAppToken.clientHidden)) &#123;</span><br><span class="line">            result = relayoutVisibleWindow(outConfig, result, win, winAnimator, attrChanges,</span><br><span class="line">                    oldVisibility);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = createSurfaceControl(outSurface, result, win, winAnimator);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               ......</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowManagerService.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createSurfaceControl</span><span class="params">(Surface outSurface, <span class="keyword">int</span> result, WindowState win,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowStateAnimator winAnimator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!win.mHasSurface) &#123;</span><br><span class="line">        result |= RELAYOUT_RES_SURFACE_CHANGED;</span><br><span class="line">    &#125;</span><br><span class="line">    WindowSurfaceController surfaceController = winAnimator.createSurfaceLocked();</span><br><span class="line">    <span class="keyword">if</span> (surfaceController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        surfaceController.getSurface(outSurface);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        outSurface.release();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowSurfaceController.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getSurface</span><span class="params">(Surface outSurface)</span> </span>&#123;</span><br><span class="line">    outSurface.copyFrom(mSurfaceControl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowStateAnimator.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function">WindowSurfaceController <span class="title">createSurfaceLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        mSurfaceController = <span class="keyword">new</span> WindowSurfaceController(mSession.mSurfaceSession,</span><br><span class="line">                attrs.getTitle().toString(),</span><br><span class="line">                width, height, format, flags, <span class="keyword">this</span>);</span><br><span class="line">        w.setHasSurface(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> mSurfaceController;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;WindowSurfaceController.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WindowSurfaceController</span><span class="params">(SurfaceSession s,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> flags, WindowStateAnimator animator)</span> </span>&#123;</span><br><span class="line">    mAnimator = animator;</span><br><span class="line">    mSurfaceW = w;</span><br><span class="line">    mSurfaceH = h;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (animator.mWin.isChildWindow() &amp;&amp;</span><br><span class="line">            animator.mWin.mSubLayer &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            animator.mWin.mAppToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mSurfaceControl = <span class="keyword">new</span> SurfaceControl(</span><br><span class="line">                s, name, w, h, format, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-12ã€Surfaceåˆ›å»ºè¿‡ç¨‹"><a href="#2-12ã€Surfaceåˆ›å»ºè¿‡ç¨‹" class="headerlink" title="2.12ã€Surfaceåˆ›å»ºè¿‡ç¨‹"></a>2.12ã€Surfaceåˆ›å»ºè¿‡ç¨‹</h4><p>[-&gt;SurfaceControl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SurfaceControl</span><span class="params">(SurfaceSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> OutOfResourcesException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mNativeObject = nativeCreate(session, name, w, h, format, flags);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_SurfaceControl.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz, jobject sessionObj,</span></span></span><br><span class="line"><span class="function"><span class="params">    jstring nameStr, jint w, jint h, jint format, jint flags)</span> </span>&#123;</span><br><span class="line"><span class="function">ScopedUtfChars <span class="title">name</span><span class="params">(env, nameStr)</span></span>;</span><br><span class="line">sp&lt;SurfaceComposerClient&gt; client(android_view_SurfaceSession_getClient(env, sessionObj));</span><br><span class="line">sp&lt;SurfaceControl&gt; surface = client-&gt;createSurface(</span><br><span class="line">        String8(name.c_str()), w, h, format, flags);</span><br><span class="line"><span class="keyword">if</span> (surface == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    jniThrowException(env, OutOfResourcesException, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">surface-&gt;incStrong((<span class="keyword">void</span> *)nativeCreate);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°é¦–å…ˆå¾—åˆ°å‰é¢åˆ›å»ºå¥½çš„SurfaceComposerClientå¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡å‘SurfaceFlingerç«¯çš„Clientå¯¹è±¡å‘é€åˆ›å»ºSurfaceçš„è¯·æ±‚ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ªSurfaceControlå¯¹è±¡ã€‚ [-&gt;SurfaceComposerClient.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceControl&gt; SurfaceComposerClient::createSurface(</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">    <span class="keyword">uint32_t</span> w,</span><br><span class="line">    <span class="keyword">uint32_t</span> h,</span><br><span class="line">    PixelFormat format,</span><br><span class="line">    <span class="keyword">uint32_t</span> flags)</span><br><span class="line">    &#123;</span><br><span class="line">sp&lt;SurfaceControl&gt; sur;</span><br><span class="line"><span class="keyword">if</span> (mStatus == NO_ERROR) &#123;</span><br><span class="line">    sp&lt;IBinder&gt; handle;</span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; gbp;</span><br><span class="line">    <span class="keyword">status_t</span> err = mClient-&gt;createSurface(name, w, h, format, flags,</span><br><span class="line">            &amp;handle, &amp;gbp);</span><br><span class="line">    ALOGE_IF(err, <span class="string">"SurfaceComposerClient::createSurface error %s"</span>, strerror(-err));</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        sur = <span class="keyword">new</span> SurfaceControl(<span class="keyword">this</span>, handle, gbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceComposerClientå°†Surfaceåˆ›å»ºè¯·æ±‚è½¬äº¤ç»™ä¿å­˜åœ¨å…¶æˆå‘˜å˜é‡ä¸­çš„Bp SurfaceComposerClientå¯¹è±¡æ¥å®Œæˆï¼Œåœ¨SurfaceFlingerç«¯çš„Clientæœ¬åœ°å¯¹è±¡ä¼šè¿”å›ä¸€ä¸ªISurfaceä»£ç†å¯¹è±¡ç»™åº”ç”¨ç¨‹åºï¼Œé€šè¿‡è¯¥ä»£ç†å¯¹è±¡ä¸ºåº”ç”¨ç¨‹åºå½“å‰åˆ›å»ºçš„Surfaceåˆ›å»ºä¸€ä¸ªSurfaceControlå¯¹è±¡ã€‚ [ISurfaceComposerClient.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">createSurface</span><span class="params">(<span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> height, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IBinder&gt;* handle,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IGraphicBufferProducer&gt;* gbp)</span> </span>&#123;</span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    ......</span><br><span class="line">    remote()-&gt;transact(CREATE_SURFACE, data, &amp;reply);</span><br><span class="line">    *handle = reply.readStrongBinder();</span><br><span class="line">    *gbp = interface_cast&lt;IGraphicBufferProducer&gt;(reply.readStrongBinder());</span><br><span class="line">    <span class="keyword">return</span> reply.readInt32();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Client.cpp] MessageCreateSurfaceæ¶ˆæ¯æ˜¯ä¸“é—¨ä¸ºåº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceè€Œå®šä¹‰çš„ä¸€ç§æ¶ˆæ¯ç±»å‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">status_t</span> Client::createSurface(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">        sp&lt;IBinder&gt;* handle,</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp)&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * createSurface must be called from the GL thread so that it can</span></span><br><span class="line"><span class="comment">     * have access to the GL context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MessageCreateLayer</span> :</span> <span class="keyword">public</span> MessageBase &#123;</span><br><span class="line">        SurfaceFlinger* flinger;</span><br><span class="line">        Client* client;</span><br><span class="line">        sp&lt;IBinder&gt;* handle;</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp;</span><br><span class="line">        <span class="keyword">status_t</span> result;</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name;</span><br><span class="line">        <span class="keyword">uint32_t</span> w, h;</span><br><span class="line">        PixelFormat format;</span><br><span class="line">        <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        MessageCreateLayer(SurfaceFlinger* flinger,</span><br><span class="line">                <span class="keyword">const</span> String8&amp; name, Client* client,</span><br><span class="line">                <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">                sp&lt;IBinder&gt;* handle,</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt;* gbp)</span><br><span class="line">            : flinger(flinger), client(client),</span><br><span class="line">              handle(handle), gbp(gbp), result(NO_ERROR),</span><br><span class="line">              name(name), w(w), h(h), format(format), flags(flags) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">status_t</span> getResult() <span class="keyword">const</span> &#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">handler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            result = flinger-&gt;createLayer(name, client, w, h, format, flags,</span><br><span class="line">                    handle, gbp);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sp&lt;MessageBase&gt; msg = <span class="keyword">new</span> MessageCreateLayer(mFlinger.get(),</span><br><span class="line">            name, <span class="keyword">this</span>, w, h, format, flags, handle, gbp);</span><br><span class="line">    mFlinger-&gt;postMessageSync(msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;MessageCreateLayer*&gt;( msg.get() )-&gt;getResult();</span><br><span class="line">    &#125;</span><br><span class="line">Clientå°†åº”ç”¨ç¨‹åºåˆ›å»ºSurfaceçš„è¯·æ±‚è½¬æ¢ä¸ºå¼‚æ­¥æ¶ˆæ¯æŠ•é€’åˆ°SurfaceFlingerçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå°†åˆ›å»ºSurfaceçš„ä»»åŠ¡è½¬äº¤ç»™SurfaceFlingerã€‚</span><br><span class="line">[-&gt;SurfaceFlinger.cpp]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> SurfaceFlinger::createLayer(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">        <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">        sp&lt;IBinder&gt;* handle, sp&lt;IGraphicBufferProducer&gt;* gbp)&#123;</span><br><span class="line">    <span class="comment">//ALOGD("createLayer for (%d x %d), name=%s", w, h, name.string());</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    sp&lt;Layer&gt; layer;</span><br><span class="line">    <span class="comment">////æ ¹æ®flagsåˆ›å»ºä¸åŒç±»å‹çš„layer</span></span><br><span class="line">    <span class="keyword">switch</span> (flags &amp; ISurfaceComposerClient::eFXSurfaceMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceNormal:</span><br><span class="line">            result = createNormalLayer(client,</span><br><span class="line">                    name, w, h, flags, format,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceDim:</span><br><span class="line">            result = createDimLayer(client,</span><br><span class="line">                    name, w, h, flags,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            result = BAD_VALUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†åˆ›å»ºå¥½çš„Layerå¯¹è±¡ä¿å­˜åœ¨Clientä¸­  </span></span><br><span class="line">    result = addClientLayer(client, *handle, *gbp, layer);</span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setTransactionFlags(eTransactionNeeded);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>SurfaceFlingeræ ¹æ®æ ‡å¿—ä½åˆ›å»ºå¯¹åº”ç±»å‹çš„Surfaceï¼Œå½“å‰ç³»ç»Ÿå®šä¹‰äº†2ç§ç±»å‹çš„Layer: [-&gt;ISurfaceComposerClient.h]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eFXSurfaceNormal    = 0x00000000,</span><br><span class="line">eFXSurfaceDim       = 0x00020000,</span><br></pre></td></tr></table></figure><p>[-&gt;SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> SurfaceFlinger::createNormalLayer(<span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, <span class="keyword">uint32_t</span> flags, PixelFormat&amp; format,</span><br><span class="line">    sp&lt;IBinder&gt;* handle, sp&lt;IGraphicBufferProducer&gt;* gbp, sp&lt;Layer&gt;* outLayer)&#123;</span><br><span class="line"><span class="comment">// initialize the surfaces</span></span><br><span class="line"><span class="keyword">switch</span> (format) &#123;</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_TRANSPARENT:</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_TRANSLUCENT:</span><br><span class="line">    format = PIXEL_FORMAT_RGBA_8888;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> PIXEL_FORMAT_OPAQUE:</span><br><span class="line">    format = PIXEL_FORMAT_RGBX_8888;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åœ¨SurfaceFlingerç«¯ä¸ºåº”ç”¨ç¨‹åºçš„Surfaceåˆ›å»ºå¯¹åº”çš„Layerå¯¹è±¡  </span></span><br><span class="line">*outLayer = <span class="keyword">new</span> Layer(<span class="keyword">this</span>, client, name, w, h, flags);</span><br><span class="line"><span class="keyword">status_t</span> err = (*outLayer)-&gt;setBuffers(w, h, format, flags);</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    *handle = (*outLayer)-&gt;getHandle();</span><br><span class="line">    *gbp = (*outLayer)-&gt;getProducer();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALOGE_IF(err, <span class="string">"createNormalLayer() failed (%s)"</span>, strerror(-err));</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨SurfaceFlingeræœåŠ¡ç«¯ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºçš„Surfaceåˆ›å»ºå¯¹åº”çš„Layerå¯¹è±¡ã€‚åº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceè¿‡ç¨‹å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N12-Android-addWindow-createSurface.png" alt="Markdown"></p><p>ç¬¬ä¸€æ¬¡å¼ºå¼•ç”¨Layerå¯¹è±¡æ—¶ï¼ŒonFirstRef()å‡½æ•°è¢«å›è°ƒ [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::onFirstRef() &#123;</span><br><span class="line"><span class="comment">// Creates a custom BufferQueue for SurfaceFlingerConsumer to use</span></span><br><span class="line">sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer;</span><br><span class="line"><span class="comment">//åˆ›å»ºBufferQueueå¯¹è±¡</span></span><br><span class="line">BufferQueue::createBufferQueue(&amp;producer, &amp;consumer);</span><br><span class="line">mProducer = <span class="keyword">new</span> MonitoredProducer(producer, mFlinger);</span><br><span class="line">mSurfaceFlingerConsumer = <span class="keyword">new</span> SurfaceFlingerConsumer(consumer, mTextureName,</span><br><span class="line">        <span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(<span class="number">0</span>));</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setContentsChangedListener(<span class="keyword">this</span>);</span><br><span class="line">mSurfaceFlingerConsumer-&gt;setName(mName);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TARGET_DISABLE_TRIPLE_BUFFERING</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">warning</span> <span class="meta-string">"disabling triple buffering"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">mProducer-&gt;setMaxDequeuedBufferCount(<span class="number">2</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mFlinger-&gt;getDefaultDisplayDevice());</span><br><span class="line">updateTransformHint(hw);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®bufferå¯ç”¨ç›‘å¬å™¨çš„æ³¨å†Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå½“ç”Ÿäº§è€…ä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºå¡«å……å¥½å›¾å½¢bufferæ•°æ®åï¼Œé€šè¿‡å›è°ƒæ–¹å¼é€šçŸ¥æ¶ˆè´¹è€…çš„</p><h4 id="BufferQueueæ„é€ è¿‡ç¨‹"><a href="#BufferQueueæ„é€ è¿‡ç¨‹" class="headerlink" title="BufferQueueæ„é€ è¿‡ç¨‹"></a>BufferQueueæ„é€ è¿‡ç¨‹</h4><p>[-&gt;BufferQueue.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> BufferQueue::createBufferQueue(sp&lt;IGraphicBufferProducer&gt;* outProducer,</span><br><span class="line">    sp&lt;IGraphicBufferConsumer&gt;* outConsumer,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferAlloc&gt;&amp; allocator) &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">sp&lt;BufferQueueCore&gt; core(<span class="keyword">new</span> BufferQueueCore(allocator));</span><br><span class="line">sp&lt;IGraphicBufferProducer&gt; producer(<span class="keyword">new</span> BufferQueueProducer(core));</span><br><span class="line">sp&lt;IGraphicBufferConsumer&gt; consumer(<span class="keyword">new</span> BufferQueueConsumer(core));</span><br><span class="line">*outProducer = producer;</span><br><span class="line">*outConsumer = consumer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;BufferQueueCore.cpp] æ‰€ä»¥æ ¸å¿ƒéƒ½æ˜¯è¿™ä¸ªBufferQueueCoreï¼Œä»–æ˜¯ç®¡ç†å›¾å½¢ç¼“å†²åŒºçš„ä¸­æ¢ã€‚è¿™é‡Œä¸¾ä¸€ä¸ªSurfaceTextureçš„ä¾‹å­ï¼Œæ¥çœ‹çœ‹ä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N13-Android-addWindow-BufferQueue.jpg" alt="Markdown"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BufferQueueCore::BufferQueueCore(<span class="keyword">const</span> sp&lt;IGraphicBufferAlloc&gt;&amp; allocator) :</span><br><span class="line">mAllocator(allocator),</span><br><span class="line">......</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (allocator == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    sp&lt;ISurfaceComposer&gt; composer(ComposerService::getComposerService());</span><br><span class="line">    mAllocator = composer-&gt;createGraphicBufferAlloc();</span><br><span class="line">    <span class="keyword">if</span> (mAllocator == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        BQ_LOGE(<span class="string">"createGraphicBufferAlloc failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> numStartingBuffers = getMaxBufferCountLocked();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> s = <span class="number">0</span>; s &lt; numStartingBuffers; s++) &#123;</span><br><span class="line">    mFreeSlots.insert(s);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> s = numStartingBuffers; s &lt; BufferQueueDefs::NUM_BUFFER_SLOTS;</span><br><span class="line">        s++) &#123;</span><br><span class="line">    mUnusedSlots.push_front(s);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BufferQueueCoreç±»ä¸­å®šä¹‰äº†ä¸€ä¸ª64é¡¹çš„æ•°æ®mSlotsï¼Œæ˜¯ä¸€ä¸ªå®¹é‡å¤§å°ä¸º64çš„æ•°ç»„ï¼Œå› æ­¤BufferQueueCoreå¯ä»¥ç®¡ç†æœ€å¤š64å—çš„GraphicBufferã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N14-Android-addWindow-slot.jpg" alt="Markdown"></p><p>[-&gt;ISurfaceComposer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">virtual</span> sp&lt;IGraphicBufferAlloc&gt; createGraphicBufferAlloc()</span><br><span class="line">&#123;</span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    data.writeInterfaceToken(ISurfaceComposer::getInterfaceDescriptor());</span><br><span class="line">    remote()-&gt;transact(BnSurfaceComposer::CREATE_GRAPHIC_BUFFER_ALLOC, data, &amp;reply);</span><br><span class="line">    <span class="keyword">return</span> interface_cast&lt;IGraphicBufferAlloc&gt;(reply.readStrongBinder());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IGraphicBufferAlloc&gt; SurfaceFlinger::createGraphicBufferAlloc()</span><br><span class="line">&#123;</span><br><span class="line">sp&lt;GraphicBufferAlloc&gt; gba(<span class="keyword">new</span> GraphicBufferAlloc());</span><br><span class="line"><span class="keyword">return</span> gba;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="GraphicBufferAllocæ„é€ è¿‡ç¨‹"><a href="#GraphicBufferAllocæ„é€ è¿‡ç¨‹" class="headerlink" title="GraphicBufferAllocæ„é€ è¿‡ç¨‹"></a>GraphicBufferAllocæ„é€ è¿‡ç¨‹</h4><p>[-&gt;GraphicBufferAlloc.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;GraphicBuffer&gt; GraphicBufferAlloc::createGraphicBuffer(<span class="keyword">uint32_t</span> width,</span><br><span class="line">    <span class="keyword">uint32_t</span> height, PixelFormat format, <span class="keyword">uint32_t</span> usage,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> requestorName, <span class="keyword">status_t</span>* error) &#123;</span><br><span class="line">sp&lt;GraphicBuffer&gt; graphicBuffer(<span class="keyword">new</span> GraphicBuffer(</span><br><span class="line">        width, height, format, usage, <span class="built_in">std</span>::move(requestorName)));</span><br><span class="line"><span class="keyword">status_t</span> err = graphicBuffer-&gt;initCheck();</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> graphicBuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹"><a href="#å›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹" class="headerlink" title="å›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹"></a>å›¾å½¢ç¼“å†²åŒºåˆ›å»ºè¿‡ç¨‹</h4><p>[-&gt;GraphicBuffer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GraphicBuffer::GraphicBuffer(<span class="keyword">uint32_t</span> inWidth, <span class="keyword">uint32_t</span> inHeight,</span><br><span class="line">    PixelFormat inFormat, <span class="keyword">uint32_t</span> inUsage, <span class="built_in">std</span>::<span class="built_in">string</span> requestorName)</span><br><span class="line">: BASE(), mOwner(ownData), mBufferMapper(GraphicBufferMapper::get()),</span><br><span class="line">  mInitCheck(NO_ERROR), mId(getUniqueId()), mGenerationNumber(<span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">width  =</span><br><span class="line">height =</span><br><span class="line">stride =</span><br><span class="line">format =</span><br><span class="line">usage  = <span class="number">0</span>;</span><br><span class="line">handle = <span class="literal">NULL</span>;</span><br><span class="line">mInitCheck = initSize(inWidth, inHeight, inFormat, inUsage,</span><br><span class="line">        <span class="built_in">std</span>::move(requestorName));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å›¾å½¢bufferçš„å®½é«˜ã€æ ¼å¼ç­‰ä¿¡æ¯ä¸ºå›¾å½¢ç¼“å†²åŒºåˆ†é…å­˜å‚¨ç©ºé—´ã€‚</p><p>ä½¿ç”¨GraphicBufferAllocatorå¯¹è±¡æ¥ä¸ºå›¾å½¢ç¼“å†²åŒºåˆ†é…å†…å­˜ç©ºé—´ï¼ŒGraphicBufferAllocatoræ˜¯å¯¹Grallocæ¨¡å—ä¸­çš„gpuè®¾å¤‡çš„å°è£…ç±»ã€‚å…³äºGraphicBufferAllocatorå†…å­˜åˆ†é…è¿‡ç¨‹è¯·æŸ¥çœ‹<a href="http://blog.csdn.net/yangwen123/article/details/12231687" target="_blank" rel="noopener">Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ</a>å›¾å½¢ç¼“å†²åŒºåˆ†é…å®Œæˆåï¼Œè¿˜ä¼šæ˜ å°„åˆ°SurfaceFlingeræœåŠ¡è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p><h4 id="Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ"><a href="#Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ" class="headerlink" title="Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ"></a>Androidå›¾å½¢ç¼“å†²åŒºåˆ†é…è¿‡ç¨‹æºç åˆ†æ</h4><p>[-&gt;Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Layer::Layer(SurfaceFlinger* flinger, <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">:   contentDirty(<span class="literal">false</span>),</span><br><span class="line">    sequence(<span class="keyword">uint32_t</span>(android_atomic_inc(&amp;sSequence))),</span><br><span class="line">    mFlinger(flinger),</span><br><span class="line">    mTextureName(<span class="number">-1U</span>),</span><br><span class="line">    mPremultipliedAlpha(<span class="literal">true</span>),</span><br><span class="line">    mName(<span class="string">"unnamed"</span>),</span><br><span class="line">    mFormat(PIXEL_FORMAT_NONE),</span><br><span class="line">    ......&#123;</span><br><span class="line">mCurrentCrop.makeInvalid();</span><br><span class="line">mFlinger-&gt;getRenderEngine().genTextures(<span class="number">1</span>, &amp;mTextureName);</span><br><span class="line">mTexture.init(Texture::TEXTURE_EXTERNAL, mTextureName);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤æ‰ç®—çœŸæ­£åˆ›å»ºäº†ä¸€ä¸ªå¯ç”¨äºç»˜å›¾çš„Surface (Layer)ï¼Œä»ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨WMSæœåŠ¡è¿›ç¨‹ç«¯ï¼Œå…¶å®åˆ›å»ºäº†ä¸¤ä¸ªJavaå±‚çš„Surfaceå¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªSurfaceä½¿ç”¨äº†æ— å‚æ„é€ å‡½æ•°ï¼Œä»…ä»…æ„é€ ä¸€ä¸ªSurfaceå¯¹è±¡è€Œå·²ï¼Œè€Œç¬¬äºŒä¸ªSurfaceå´ä½¿ç”¨äº†æœ‰å‚æ„é€ å‡½æ•°ï¼Œå‚æ•°æŒ‡å®šäº†å›¾è±¡å®½é«˜ç­‰ä¿¡æ¯ï¼Œè¿™ä¸ªJavaå±‚Surfaceå¯¹è±¡è¿˜ä¼šåœ¨nativeå±‚è¯·æ±‚SurfaceFlingeråˆ›å»ºä¸€ä¸ªçœŸæ­£èƒ½ç”¨äºç»˜åˆ¶å›¾è±¡çš„nativeå±‚Surfaceã€‚æœ€åé€šè¿‡æµ…æ‹·è´çš„æ–¹å¼å°†ç¬¬äºŒä¸ªSurfaceå¤åˆ¶åˆ°ç¬¬ä¸€ä¸ªSurfaceä¸­ï¼Œæœ€åé€šè¿‡writeToParcelæ–¹å¼å†™å›åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N15-Android-addWindow-createSurface-Layer.png" alt="Markdown"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyFrom</span><span class="params">(SurfaceControl other)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">long</span> surfaceControlPtr = other.mNativeObject;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">long</span> newNativeObject = nativeCreateFromSurfaceControl(surfaceControlPtr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNativeObject != <span class="number">0</span>) &#123;</span><br><span class="line">            nativeRelease(mNativeObject);</span><br><span class="line">        &#125;</span><br><span class="line">        setNativeObjectLocked(newNativeObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreateFromSurfaceControl</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong surfaceControlNativeObj)</span> </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is used by the WindowManagerService just after constructing</span></span><br><span class="line"><span class="comment"> * a Surface and is necessary for returning the Surface reference to</span></span><br><span class="line"><span class="comment"> * the caller. At this point, we should only have a SurfaceControl.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">sp&lt;SurfaceControl&gt; ctrl(<span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(surfaceControlNativeObj));</span><br><span class="line">sp&lt;Surface&gt; surface(ctrl-&gt;getSurface());</span><br><span class="line"><span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    surface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2å·Surfaceå¼•ç”¨åˆ°äº†3å·Surfaceçš„SurfaceControlå¯¹è±¡åï¼Œé€šè¿‡writeToParcel()å‡½æ•°å†™ä¼šåˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚ [Surface.java]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">        @Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dest == null) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"dest must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This must be kept synchronized with the native parceling code</span></span><br><span class="line">        <span class="comment">// in frameworks/native/libs/Surface.cpp</span></span><br><span class="line">        dest.writeString(mName);</span><br><span class="line">        dest.writeInt(mIsSingleBuffered ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        nativeWriteToParcel(mNativeObject, dest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; Parcelable.PARCELABLE_WRITE_RETURN_VALUE) != <span class="number">0</span>) &#123;</span><br><span class="line">        release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeWriteToParcel</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject parcelObj)</span> </span>&#123;</span><br><span class="line">Parcel* parcel = parcelForJavaObject(env, parcelObj);</span><br><span class="line"><span class="keyword">if</span> (parcel == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    doThrowNPE(env);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">sp&lt;Surface&gt; self(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line">android::view::Surface surfaceShim;</span><br><span class="line"><span class="keyword">if</span> (self != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    surfaceShim.graphicBufferProducer = self-&gt;getIGraphicBufferProducer();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Calling code in Surface.java has already written the name of the Surface</span></span><br><span class="line"><span class="comment">// to the Parcel</span></span><br><span class="line">surfaceShim.writeToParcel(parcel, <span class="comment">/*nameAlreadyWritten*/</span><span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„1å·SurfaceæŒ‰ç›¸åé¡ºåºè¯»å–WMSæœåŠ¡ç«¯è¿”å›è¿‡æ¥çš„Binderå¯¹è±¡ç­‰æ•°æ®ï¼Œå¹¶æ„é€ ä¸€ä¸ªnativeå±‚çš„Surfaceå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span><span class="params">(Parcel source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (source == null) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"source must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        <span class="comment">// nativeReadFromParcel() will either return mNativeObject, or</span></span><br><span class="line">        <span class="comment">// create a new native Surface and return it after reducing</span></span><br><span class="line">        <span class="comment">// the reference count on mNativeObject.  Either way, it is</span></span><br><span class="line">        <span class="comment">// not necessary to call nativeRelease() here.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This must be kept synchronized with the native parceling code</span></span><br><span class="line">        <span class="comment">// in frameworks/native/libs/Surface.cpp</span></span><br><span class="line">        mName = source.readString();</span><br><span class="line">        mIsSingleBuffered = source.readInt() != <span class="number">0</span>;</span><br><span class="line">        setNativeObjectLocked(nativeReadFromParcel(mNativeObject, source));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„1å·SurfaceæŒ‰ç›¸åé¡ºåºè¯»å–WMSæœåŠ¡ç«¯è¿”å›è¿‡æ¥çš„Binderå¯¹è±¡ç­‰æ•°æ®ï¼Œå¹¶æ„é€ ä¸€ä¸ªnativeå±‚çš„Surfaceå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreateFromSurfaceControl</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong surfaceControlNativeObj)</span> </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is used by the WindowManagerService just after constructing</span></span><br><span class="line"><span class="comment"> * a Surface and is necessary for returning the Surface reference to</span></span><br><span class="line"><span class="comment"> * the caller. At this point, we should only have a SurfaceControl.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">sp&lt;SurfaceControl&gt; ctrl(<span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(surfaceControlNativeObj));</span><br><span class="line">sp&lt;Surface&gt; surface(ctrl-&gt;getSurface());</span><br><span class="line"><span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    surface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªActivityå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªSurfaceï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªActivityåªæœ‰ä¸€ä¸ªSurfaceï¼Œå½“Activityä¸­ä½¿ç”¨SurfaceViewæ—¶ï¼Œå°±å­˜åœ¨å¤šä¸ªSurfaceã€‚Activityé»˜è®¤surfaceæ˜¯åœ¨relayoutWindowè¿‡ç¨‹ä¸­ç”±WMSæœåŠ¡åˆ›å»ºçš„ï¼Œç„¶åå›ä¼ ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªSurfaceå…¶å®å°±æ˜¯åº”ç”¨ç¨‹åºç«¯çš„æœ¬åœ°çª—å£ï¼Œå…³äºSurfaceçš„åˆå§‹åŒ–è¿‡ç¨‹è¿™é‡Œå°±ä¸åœ¨ä»‹ç»ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N16-Android-addWindow-surface-create-client.png" alt="Markdown"></p><h4 id="åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹"><a href="#åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹" class="headerlink" title="åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹"></a>åº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåˆ›å»ºè¿‡ç¨‹</h4><p>ä»å‰é¢åˆ†æå¯çŸ¥ï¼ŒSurfaceFlingeråœ¨å¤„ç†åº”ç”¨ç¨‹åºè¯·æ±‚åˆ›å»ºSurfaceä¸­ï¼Œåœ¨SurfaceFlingeræœåŠ¡ç«¯ä»…ä»…åˆ›å»ºäº†Layerå¯¹è±¡ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåœ¨ä»€ä¹ˆæ—¶å€™ã€ä»€ä¹ˆåœ°æ–¹åˆ›å»ºå‘¢ï¼Ÿ</p><p>ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºå¥½äº†Layerå¯¹è±¡å¹¶è¿”å›ISurfaceçš„ä»£ç†å¯¹è±¡ç»™åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºé€šè¿‡è¯¥ä»£ç†å¯¹è±¡åˆ›å»ºäº†ä¸€ä¸ªSurfaceControlå¯¹è±¡ï¼ŒJavaå±‚Surfaceéœ€è¦é€šè¿‡android_view_Surface.cppä¸­çš„JNIå‡½æ•°æ¥æ“ä½œnativeå±‚çš„Surfaceï¼Œåœ¨æ“ä½œnativeå±‚Surfaceå‰ï¼Œé¦–å…ˆéœ€è¦è·å–åˆ°nativeçš„Surfaceï¼Œåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceå°±æ˜¯åœ¨è¿™ä¸ªæ—¶å€™åˆ›å»ºçš„ã€‚ [-&gt;SurfaceControl.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;Surface&gt; SurfaceControl::getSurface() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">Mutex::Autolock _l(mLock);</span><br><span class="line"><span class="keyword">if</span> (mSurfaceData == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// This surface is always consumed by SurfaceFlinger, so the</span></span><br><span class="line">    <span class="comment">// producerControlledByApp value doesn't matter; using false.</span></span><br><span class="line">    mSurfaceData = <span class="keyword">new</span> Surface(mGraphicBufferProducer, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> mSurfaceData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Surface::Surface(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; bufferProducer,</span><br><span class="line">    <span class="keyword">bool</span> controlledByApp)</span><br><span class="line">: mGraphicBufferProducer(bufferProducer),</span><br><span class="line">  mCrop(Rect::EMPTY_RECT),</span><br><span class="line">  mGenerationNumber(<span class="number">0</span>),</span><br><span class="line">  mSharedBufferMode(<span class="literal">false</span>),</span><br><span class="line">  mAutoRefresh(<span class="literal">false</span>),</span><br><span class="line">  mSharedBufferSlot(BufferItem::INVALID_BUFFER_SLOT),</span><br><span class="line">  mSharedBufferHasBeenQueued(<span class="literal">false</span>),</span><br><span class="line">  mNextFrameNumber(<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line"><span class="comment">// Initialize the ANativeWindow function pointers.</span></span><br><span class="line">ANativeWindow::setSwapInterval  = hook_setSwapInterval;</span><br><span class="line">ANativeWindow::dequeueBuffer    = hook_dequeueBuffer;</span><br><span class="line">ANativeWindow::cancelBuffer     = hook_cancelBuffer;</span><br><span class="line">ANativeWindow::queueBuffer      = hook_queueBuffer;</span><br><span class="line">ANativeWindow::query            = hook_query;</span><br><span class="line">ANativeWindow::perform          = hook_perform;</span><br><span class="line"></span><br><span class="line">ANativeWindow::dequeueBuffer_DEPRECATED = hook_dequeueBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::cancelBuffer_DEPRECATED  = hook_cancelBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::lockBuffer_DEPRECATED    = hook_lockBuffer_DEPRECATED;</span><br><span class="line">ANativeWindow::queueBuffer_DEPRECATED   = hook_queueBuffer_DEPRECATED;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(ANativeWindow::minSwapInterval) = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(ANativeWindow::maxSwapInterval) = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">mReqWidth = <span class="number">0</span>;</span><br><span class="line">mReqHeight = <span class="number">0</span>;</span><br><span class="line">mReqFormat = <span class="number">0</span>;</span><br><span class="line">mReqUsage = <span class="number">0</span>;</span><br><span class="line">mTimestamp = NATIVE_WINDOW_TIMESTAMP_AUTO;</span><br><span class="line">mDataSpace = HAL_DATASPACE_UNKNOWN;</span><br><span class="line">mScalingMode = NATIVE_WINDOW_SCALING_MODE_FREEZE;</span><br><span class="line">mTransform = <span class="number">0</span>;</span><br><span class="line">mStickyTransform = <span class="number">0</span>;</span><br><span class="line">mDefaultWidth = <span class="number">0</span>;</span><br><span class="line">mDefaultHeight = <span class="number">0</span>;</span><br><span class="line">mUserWidth = <span class="number">0</span>;</span><br><span class="line">mUserHeight = <span class="number">0</span>;</span><br><span class="line">mTransformHint = <span class="number">0</span>;</span><br><span class="line">mConsumerRunningBehind = <span class="literal">false</span>;</span><br><span class="line">mConnectedToCpu = <span class="literal">false</span>;</span><br><span class="line">mProducerControlledByApp = controlledByApp;</span><br><span class="line">mSwapIntervalZero = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºå®Œåº”ç”¨ç¨‹åºæœ¬åœ°çª—å£Surfaceåï¼Œæƒ³è¦åœ¨è¯¥Surfaceä¸Šç»˜å›¾ï¼Œé¦–å…ˆéœ€è¦ä¸ºè¯¥Surfaceåˆ†é…å›¾å½¢bufferã€‚æˆ‘ä»¬å‰é¢ä»‹ç»äº†Androidåº”ç”¨ç¨‹åºå›¾å½¢ç¼“å†²åŒºçš„åˆ†é…éƒ½æ˜¯ç”±SurfaceFlingeræœåŠ¡è¿›ç¨‹æ¥å®Œæˆï¼Œåœ¨è¯·æ±‚åˆ›å»ºSurfaceæ—¶ï¼Œåœ¨æœåŠ¡ç«¯åˆ›å»ºäº†ä¸€ä¸ªBufferQueueæœ¬åœ°Binderå¯¹è±¡ï¼Œè¯¥å¯¹è±¡è´Ÿè´£ç®¡ç†åº”ç”¨ç¨‹åºä¸€ä¸ªæœ¬åœ°çª—å£Surfaceçš„å›¾å½¢ç¼“å†²åŒºã€‚</p><h5 id="3ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout"><a href="#3ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout" class="headerlink" title="3ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout()"></a>3ã€æ‰§è¡Œçª—å£å¸ƒå±€performLayout()</h5><p>[-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">    mLayoutRequested = <span class="keyword">false</span>;</span><br><span class="line">    mScrollMayChange = <span class="keyword">true</span>;</span><br><span class="line">    mInLayout = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> View host = mView;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">        mInLayout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> numViewsRequestingLayout = mLayoutRequesters.size();</span><br><span class="line">        <span class="keyword">if</span> (numViewsRequestingLayout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// requestLayout() was called during layout.</span></span><br><span class="line">            <span class="comment">// If no layout-request flags are set on the requesting views, there is no problem.</span></span><br><span class="line">            <span class="comment">// If some requests are still pending, then we need to clear those flags and do</span></span><br><span class="line">            <span class="comment">// a full request/measure/layout pass to handle this situation.</span></span><br><span class="line">            ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</span><br><span class="line">                    <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Set this flag to indicate that any further requests are happening during</span></span><br><span class="line">                <span class="comment">// the second pass, which may result in posting those requests to the next</span></span><br><span class="line">                <span class="comment">// frame instead</span></span><br><span class="line">                mHandlingLayoutInLayoutRequest = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Process fresh layout requests, then measure and layout</span></span><br><span class="line">                <span class="keyword">int</span> numValidRequests = validLayoutRequesters.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</span><br><span class="line">                    <span class="keyword">final</span> View view = validLayoutRequesters.get(i);</span><br><span class="line">                    Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</span><br><span class="line">                            <span class="string">" during layout: running second layout pass"</span>);</span><br><span class="line">                    view.requestLayout();</span><br><span class="line">                &#125;</span><br><span class="line">                measureHierarchy(host, lp, mView.getContext().getResources(),</span><br><span class="line">                        desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">                mInLayout = <span class="keyword">true</span>;</span><br><span class="line">                host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line"></span><br><span class="line">                mHandlingLayoutInLayoutRequest = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check the valid requests again, this time without checking/clearing the</span></span><br><span class="line">                <span class="comment">// layout flags, since requests happening during the second pass get noop'd</span></span><br><span class="line">                validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</span><br><span class="line">                    <span class="comment">// Post second-pass requests to the next frame</span></span><br><span class="line">                    getRunQueue().post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">int</span> numValidRequests = finalRequesters.size();</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</span><br><span class="line">                                <span class="keyword">final</span> View view = finalRequesters.get(i);</span><br><span class="line">                                view.requestLayout();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; &#125;);&#125; &#125; &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">    &#125;</span><br><span class="line">    mInLayout = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw"><a href="#4-æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw" class="headerlink" title="4.æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw()"></a>4.æ‰§è¡Œçª—å£ç»˜åˆ¶performDraw()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ViewRootImpl.java]</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ......</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          draw(fullRedrawNeeded);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          mIsDrawing = <span class="keyword">false</span>;</span><br><span class="line">          Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">      &#125;</span><br><span class="line">      ......</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>Androidæ˜¯æ€æ ·å°†Viewç”»å‡ºæ¥çš„ï¼Ÿ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</span><br><span class="line">    Surface surface = mSurface;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    mAttachInfo.mTreeObserver.dispatchOnDraw();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> xOffset = -mCanvasOffsetX;</span><br><span class="line">    <span class="keyword">int</span> yOffset = -mCanvasOffsetY + curScrollY;</span><br><span class="line">    <span class="keyword">final</span> WindowManager.LayoutParams params = mWindowAttributes;</span><br><span class="line">    <span class="keyword">final</span> Rect surfaceInsets = params != <span class="keyword">null</span> ? params.surfaceInsets : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (surfaceInsets != <span class="keyword">null</span>) &#123;</span><br><span class="line">        xOffset -= surfaceInsets.left;</span><br><span class="line">        yOffset -= surfaceInsets.top;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Offset dirty rect for surface insets.</span></span><br><span class="line">        dirty.offset(surfaceInsets.left, surfaceInsets.right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> accessibilityFocusDirty = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> Drawable drawable = mAttachInfo.mAccessibilityFocusDrawable;</span><br><span class="line">    <span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Rect bounds = mAttachInfo.mTmpInvalRect;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> hasFocus = getAccessibilityFocusedRect(bounds);</span><br><span class="line">        <span class="keyword">if</span> (!hasFocus) &#123;</span><br><span class="line">            bounds.setEmpty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!bounds.equals(drawable.getBounds())) &#123;</span><br><span class="line">            accessibilityFocusDirty = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mAttachInfo.mDrawingTime =</span><br><span class="line">            mChoreographer.getFrameTimeNanos() / TimeUtils.NANOS_PER_MS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</span><br><span class="line">            <span class="comment">// If accessibility focus moved, always invalidate the root.</span></span><br><span class="line">            <span class="keyword">boolean</span> invalidateRoot = accessibilityFocusDirty || mInvalidateRootRequested;</span><br><span class="line">            mInvalidateRootRequested = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Draw with hardware renderer.</span></span><br><span class="line">            mIsAnimating = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mHardwareYOffset != yOffset || mHardwareXOffset != xOffset) &#123;</span><br><span class="line">                mHardwareYOffset = yOffset;</span><br><span class="line">                mHardwareXOffset = xOffset;</span><br><span class="line">                invalidateRoot = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (invalidateRoot) &#123;</span><br><span class="line">                mAttachInfo.mHardwareRenderer.invalidateRoot();</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">                requestDrawWindow();</span><br><span class="line">            &#125;</span><br><span class="line">            mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    !mAttachInfo.mHardwareRenderer.isEnabled() &amp;&amp;</span><br><span class="line">                    mAttachInfo.mHardwareRenderer.isRequested()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mAttachInfo.mHardwareRenderer.initializeIfNeeded(</span><br><span class="line">                            mWidth, mHeight, mAttachInfo, mSurface, surfaceInsets);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (OutOfResourcesException e) &#123;</span><br><span class="line">                    handleOutOfResourcesException(e);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">                scheduleTraversals();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animating) &#123;</span><br><span class="line">        mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºç»˜åˆ¶è¿™ä¸ªæµç¨‹å¾ˆå¤æ‚ï¼Œæˆ‘ä»¬åç»­ç« èŠ‚å†åˆ†æã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N17-Android-addWindow-Render.JPG" alt="Markdown"></p><p>å‚è€ƒåšå®¢ï¼š<a href="http://blog.csdn.net/luoshengyang/article/details/45601143" target="_blank" rel="noopener">Androidåº”ç”¨ç¨‹åºUIç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“æŠ€æœ¯ç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’</a></p><p>è¿™é‡Œæˆ‘ä»¬å› ä¸ºè¦åˆ†æSurfaceæœºåˆ¶ï¼Œæ‰€ä»¥åªåˆ†æViewRootImplçš„drawæµç¨‹ã€‚ï¼ˆå¦‚æœå¼€å¯äº†ç¡¬ä»¶åŠ é€ŸåŠŸèƒ½ï¼Œåˆ™ä¼šä½¿ç”¨hwuiç¡¬ä»¶ç»˜åˆ¶åŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬å¿½ç•¥è¿™ä¸ªï¼Œä½¿ç”¨é»˜è®¤çš„è½¯ä»¶ç»˜åˆ¶æµç¨‹drawSoftwareï¼‰ã€‚ [-&gt;ViewRootImpl.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> scalingRequired, Rect dirty)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw with software renderer.</span></span><br><span class="line">    <span class="keyword">final</span> Canvas canvas;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        canvas = mSurface.lockCanvas(dirty);</span><br><span class="line">        ......</span><br><span class="line">    &#125; ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            canvas.translate(-xoff, -yoff);</span><br><span class="line">            <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mTranslator.translateCanvas(canvas);</span><br><span class="line">            &#125;</span><br><span class="line">            canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</span><br><span class="line">            attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            mView.draw(canvas);</span><br><span class="line"></span><br><span class="line">            drawAccessibilityFocusedDrawableIfNeeded(canvas);</span><br><span class="line">        &#125;......</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            surface.unlockCanvasAndPost(canvas);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">           ......</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹çœ‹Surfaceçš„lockCanvasæ–¹æ³•ï¼š [-&gt;Surface.java]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mCanvas å˜é‡ç›´æ¥èµ‹å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Canvas mCanvas = <span class="keyword">new</span> CompatibleCanvas();</span><br><span class="line"><span class="function"><span class="keyword">public</span> Canvas <span class="title">lockCanvas</span><span class="params">(Rect inOutDirty)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Surface.OutOfResourcesException, IllegalArgumentException </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">    checkNotReleasedLocked();</span><br><span class="line">    ......</span><br><span class="line">    mLockedObject = nativeLockCanvas(mNativeObject, mCanvas, inOutDirty);</span><br><span class="line">    <span class="keyword">return</span> mCanvas;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeLockCanvas</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject canvasObj, jobject dirtyRectObj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–javaå±‚çš„Surfaceä¿å­˜çš„longå‹å¥æŸ„</span></span><br><span class="line">sp&lt;Surface&gt; surface(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isSurfaceValid(surface)) &#123;</span><br><span class="line">    doThrowIAE(env);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Rect <span class="title">dirtyRect</span><span class="params">(Rect::EMPTY_RECT)</span></span>;</span><br><span class="line">Rect* dirtyRectPtr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//è·å–javaå±‚dirty Rectçš„ä½ç½®å¤§å°ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">if</span> (dirtyRectObj) &#123;</span><br><span class="line">    dirtyRect.left   = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.left);</span><br><span class="line">    dirtyRect.top    = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.top);</span><br><span class="line">    dirtyRect.right  = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.right);</span><br><span class="line">    dirtyRect.bottom = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.bottom);</span><br><span class="line">    dirtyRectPtr = &amp;dirtyRect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ANativeWindow_Buffer outBuffer;</span><br><span class="line"> <span class="comment">//è°ƒç”¨Surfaceçš„lockæ–¹æ³•,å°†ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºèµ‹ç»™outBuffer</span></span><br><span class="line"><span class="keyword">status_t</span> err = surface-&gt;lock(&amp;outBuffer, dirtyRectPtr);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">SkImageInfo info = SkImageInfo::Make(outBuffer.width, outBuffer.height,</span><br><span class="line">                                     convertPixelFormat(outBuffer.format),</span><br><span class="line">                                     outBuffer.format == PIXEL_FORMAT_RGBX_8888 ?</span><br><span class="line">                                     kOpaque_SkAlphaType : kPremul_SkAlphaType);</span><br><span class="line"></span><br><span class="line">SkBitmap bitmap;</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªSkBitmap</span></span><br><span class="line"><span class="comment">//å›¾å½¢ç¼“å†²åŒºæ¯ä¸€è¡Œåƒç´ å¤§å°</span></span><br><span class="line"><span class="keyword">ssize_t</span> bpr = outBuffer.stride * bytesPerPixel(outBuffer.format);</span><br><span class="line">bitmap.setInfo(info, bpr);</span><br><span class="line"><span class="keyword">if</span> (outBuffer.width &gt; <span class="number">0</span> &amp;&amp; outBuffer.height &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    bitmap.setPixels(outBuffer.bits);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// be safe with an empty bitmap.</span></span><br><span class="line">    bitmap.setPixels(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Canvas* nativeCanvas = GraphicsJNI::getNativeCanvas(env, canvasObj);</span><br><span class="line">nativeCanvas-&gt;setBitmap(bitmap);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dirtyRectPtr) &#123;</span><br><span class="line">    nativeCanvas-&gt;clipRect(dirtyRect.left, dirtyRect.top,</span><br><span class="line">            dirtyRect.right, dirtyRect.bottom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dirtyRectObj) &#123;</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.left,   dirtyRect.left);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.top,    dirtyRect.top);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.right,  dirtyRect.right);</span><br><span class="line">    env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.bottom, dirtyRect.bottom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">sp&lt;Surface&gt; lockedSurface(surface);</span><br><span class="line">lockedSurface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line"><span class="keyword">return</span> (jlong) lockedSurface.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¿™æ®µä»£ç é€»è¾‘ä¸»è¦å¦‚ä¸‹ï¼š</span><br><span class="line">   1ï¼‰è·å–javaå±‚dirty çš„Rectå¤§å°å’Œä½ç½®ä¿¡æ¯ï¼›</span><br><span class="line">   2ï¼‰è°ƒç”¨Surfaceçš„lockæ–¹æ³•,å°†ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºèµ‹ç»™outBufferï¼›</span><br><span class="line">   3ï¼‰åˆ›å»ºä¸€ä¸ªSkbitmapï¼Œå¡«å……å®ƒç”¨æ¥ä¿å­˜ç”³è¯·çš„å›¾å½¢ç¼“å†²åŒºï¼Œå¹¶èµ‹å€¼ç»™Javaå±‚çš„Canvaså¯¹è±¡ï¼›</span><br><span class="line">   4ï¼‰å°†å‰ªè£ä½ç½®å¤§å°ä¿¡æ¯èµ‹ç»™javaå±‚Canvaså¯¹è±¡ã€‚</span><br></pre></td></tr></table></figure><h4 id="unlockCanvasAndPost"><a href="#unlockCanvasAndPost" class="headerlink" title="unlockCanvasAndPost()"></a>unlockCanvasAndPost()</h4><p>Surfaceç»˜åˆ¶å®Œæ¯•åï¼ŒunlockCanvasAndPostæ“ä½œã€‚ [-&gt;android_view_Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeUnlockCanvasAndPost</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">    jlong nativeObject, jobject canvasObj)</span> </span>&#123;</span><br><span class="line">sp&lt;Surface&gt; surface(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line"><span class="keyword">if</span> (!isSurfaceValid(surface)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// detach the canvas from the surface</span></span><br><span class="line">Canvas* nativeCanvas = GraphicsJNI::getNativeCanvas(env, canvasObj);</span><br><span class="line">nativeCanvas-&gt;setBitmap(SkBitmap());</span><br><span class="line"></span><br><span class="line"><span class="comment">// unlock surface</span></span><br><span class="line"><span class="keyword">status_t</span> err = surface-&gt;unlockAndPost();</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    doThrowIAE(env);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N18-Android-addWindow-LockUnlock-Surfacecycle.jpg" alt="Markdown"></p><h4 id="Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº"><a href="#Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº" class="headerlink" title="Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº"></a>Surfaceç®¡ç†å›¾å½¢ç¼“å†²åŒº</h4><p>æˆ‘ä»¬ä¸Šè¾¹åˆ†æåˆ°äº†ç”³è¯·å›¾å½¢ç¼“å†²åŒºï¼Œç”¨åˆ°äº†Surfaceçš„lockå‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­æŸ¥çœ‹ã€‚ [-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Surface::lock(</span><br><span class="line">    ANativeWindow_Buffer* outBuffer, ARect* inOutDirtyBounds)</span><br><span class="line">    &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">ANativeWindowBuffer* out;</span><br><span class="line"><span class="keyword">int</span> fenceFd = <span class="number">-1</span>;</span><br><span class="line"><span class="comment">//è°ƒç”¨dequeueBufferå‡½æ•°ï¼Œç”³è¯·å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">status_t</span> err = dequeueBuffer(&amp;out, &amp;fenceFd);</span><br><span class="line">ALOGE_IF(err, <span class="string">"dequeueBuffer failed (%s)"</span>, strerror(-err));</span><br><span class="line"><span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    <span class="comment">//è·å–å›¾å½¢ç¼“å†²åŒºåŒºåŸŸå¤§å°,èµ‹ç»™åå¤‡ç¼“å†²åŒºå˜é‡backBuffer</span></span><br><span class="line">    sp&lt;GraphicBuffer&gt; backBuffer(GraphicBuffer::getSelf(out));</span><br><span class="line">    <span class="function"><span class="keyword">const</span> Rect <span class="title">bounds</span><span class="params">(backBuffer-&gt;width, backBuffer-&gt;height)</span></span>;</span><br><span class="line">    Region newDirtyRegion;</span><br><span class="line">    <span class="keyword">if</span> (inOutDirtyBounds) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸Šå±‚æŒ‡å®šä¹åˆ·æ–°è„çŸ©å½¢åŒºåŸŸï¼Œåˆ™ç”¨è¿™ä¸ªåŒºåŸŸå’Œç¼“å†²åŒºåŒºåŸŸæ±‚äº¤é›†ï¼Œ</span></span><br><span class="line">        <span class="comment">//ç„¶åå°†äº¤é›†çš„ç»“æœè®¾ç»™éœ€è¦å»åˆ·æ–°çš„æ–°åŒºåŸŸ</span></span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(<span class="keyword">static_cast</span>&lt;Rect <span class="keyword">const</span>&amp;&gt;(*inOutDirtyBounds));</span><br><span class="line">        newDirtyRegion.andSelf(bounds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        /å¦‚æœä¸Šå±‚æ²¡æœ‰æŒ‡å®šè„çŸ©å½¢åŒºåŸŸï¼Œæ‰€ä»¥åˆ·æ–°æ•´ä¸ªå›¾å½¢ç¼“å†²åŒº</span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// figure out if we can copy the frontbuffer back</span></span><br><span class="line">    <span class="comment">//ä¸Šä¸€æ¬¡ç»˜åˆ¶çš„ä¿¡æ¯ä¿å­˜åœ¨mPostedBufferä¸­ï¼Œè€Œè¿™ä¸ªmPostedBufferåˆ™è¦åœ¨unLockAndPostå‡½æ•°ä¸­è®¾ç½®</span></span><br><span class="line">    int backBufferSlot(getSlotFromBufferLocked(backBuffer.get()));</span><br><span class="line">    <span class="keyword">const</span> sp&lt;GraphicBuffer&gt;&amp; frontBuffer(mPostedBuffer);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> canCopyBack = (frontBuffer != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            backBuffer-&gt;width  == frontBuffer-&gt;width &amp;&amp;</span><br><span class="line">            backBuffer-&gt;height == frontBuffer-&gt;height &amp;&amp;</span><br><span class="line">            backBuffer-&gt;format == frontBuffer-&gt;format);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (canCopyBack) &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        Region oldDirtyRegion;</span><br><span class="line">        <span class="keyword">if</span>(mSlots[backBufferSlot].dirtyRegion.isEmpty()) &#123;</span><br><span class="line">            oldDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; NUM_BUFFER_SLOTS; i++ ) &#123;</span><br><span class="line">                <span class="keyword">if</span>(i != backBufferSlot &amp;&amp; !mSlots[i].dirtyRegion.isEmpty())</span><br><span class="line">                    oldDirtyRegion.orSelf(mSlots[i].dirtyRegion);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        const Region copyback(oldDirtyRegion.subtract(newDirtyRegion));</span><br><span class="line">        <span class="keyword">if</span> (!copyback.isEmpty())</span><br><span class="line">        <span class="comment">//è¿™é‡ŒæŠŠmPostedBufferä¸­çš„æ—§æ•°æ®æ‹·è´åˆ°BackBufferä¸­ã€‚</span></span><br><span class="line">            <span class="comment">//åç»­çš„ç»˜ç”»åªè¦æ›´æ–°è„åŒºåŸŸå°±å¯ä»¥äº†ï¼Œè¿™ä¼šèŠ‚çº¦ä¸å°‘èµ„æº</span></span><br><span class="line">            copyBlt(backBuffer, frontBuffer, copyback);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// if we can't copy-back anything, modify the user's dirty</span></span><br><span class="line">        <span class="comment">// region to make sure they redraw the whole buffer</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸¤æ¬¡å›¾å½¢ç¼“å†²åŒºå¤§å°ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬å°±è¦ä¿®æ”¹ç”¨æˆ·æŒ‡å®šçš„dirtyåŒºåŸŸå¤§å°ä¸ºæ•´ä¸ªç¼“å†²åŒºå¤§å°ï¼Œ</span></span><br><span class="line">        <span class="comment">//ç„¶åå»æ›´æ–°æ•´ä¸ªç¼“å†²åŒº</span></span><br><span class="line">        newDirtyRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;NUM_BUFFER_SLOTS ; i++) &#123;</span><br><span class="line">            mSlots[i].dirtyRegion.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// scope for the lock</span></span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">        <span class="comment">//å°†æ–°çš„dirtyèµ‹ç»™è¿™ä¸ªbufferslot</span></span><br><span class="line">        mSlots[backBufferSlot].dirtyRegion = newDirtyRegion;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inOutDirtyBounds) &#123;</span><br><span class="line">        *inOutDirtyBounds = newDirtyRegion.getBounds();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* vaddr;</span><br><span class="line">     <span class="comment">//lockå’Œunlockåˆ†åˆ«ç”¨æ¥é”å®šå’Œè§£é”ä¸€ä¸ªæŒ‡å®šçš„å›¾å½¢ç¼“å†²åŒºï¼Œåœ¨è®¿é—®ä¸€å—å›¾å½¢ç¼“å†²åŒºçš„æ—¶å€™ï¼Œ</span></span><br><span class="line">    <span class="comment">//ä¾‹å¦‚ï¼Œå‘ä¸€å—å›¾å½¢ç¼“å†²å†™å…¥å†…å®¹çš„æ—¶å€™ï¼Œéœ€è¦å°†è¯¥å›¾å½¢ç¼“å†²åŒºé”å®šï¼Œç”¨æ¥é¿å…è®¿é—®å†²çª,</span></span><br><span class="line">    <span class="comment">//é”å®šä¹‹åï¼Œå°±å¯ä»¥è·å¾—ç”±å‚æ•°å‚æ•°lã€tã€wå’Œhæ‰€åœˆå®šçš„ä¸€å—ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼Œä¿å­˜åœ¨è¾“å‡ºå‚æ•°vaddrä¸­</span></span><br><span class="line">    <span class="keyword">status_t</span> res = backBuffer-&gt;lockAsync(</span><br><span class="line">            GRALLOC_USAGE_SW_READ_OFTEN | GRALLOC_USAGE_SW_WRITE_OFTEN,</span><br><span class="line">            newDirtyRegion.bounds(), &amp;vaddr, fenceFd);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Surfaceçš„lockå‡½æ•°ç”¨æ¥ç”³è¯·å›¾å½¢ç¼“å†²åŒºå’Œä¸€äº›æ“ä½œï¼Œæ–¹æ³•ä¸é•¿ï¼Œå¤§æ¦‚å·¥ä½œæœ‰ï¼š 1ï¼‰è°ƒç”¨connectå‡½æ•°å®Œæˆä¸€äº›åˆå§‹åŒ–ï¼› 2ï¼‰è°ƒç”¨dequeueBufferå‡½æ•°ï¼Œç”³è¯·å›¾å½¢ç¼“å†²åŒºï¼› 3ï¼‰è®¡ç®—éœ€è¦ç»˜åˆ¶çš„æ–°çš„dirtyåŒºåŸŸï¼Œæ—§çš„åŒºåŸŸåŸæ ·copyæ•°æ®ã€‚ [-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Surface::dequeueBuffer(<span class="keyword">android_native_buffer_t</span>** buffer, <span class="keyword">int</span>* fenceFd) &#123;</span><br><span class="line"><span class="keyword">uint32_t</span> reqWidth;</span><br><span class="line"><span class="keyword">uint32_t</span> reqHeight;</span><br><span class="line">PixelFormat reqFormat;</span><br><span class="line"><span class="keyword">uint32_t</span> reqUsage;</span><br><span class="line">&#123;</span><br><span class="line"> ......</span><br><span class="line"><span class="comment">//ç”³è¯·å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">status_t</span> result = mGraphicBufferProducer-&gt;dequeueBuffer(&amp;buf, &amp;fence,</span><br><span class="line">        reqWidth, reqHeight, reqFormat, reqUsage);</span><br><span class="line">......</span><br><span class="line"><span class="comment">//æ ¹æ®indexè·å–ç¼“å†²åŒº</span></span><br><span class="line">sp&lt;GraphicBuffer&gt;&amp; gbuf(mSlots[buf].buffer);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> ((result &amp; IGraphicBufferProducer::BUFFER_NEEDS_REALLOCATION) || gbuf == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//ç”±äºç”³è¯·çš„å†…å­˜æ˜¯åœ¨surfaceflingerè¿›ç¨‹ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">//BufferQueueä¸­çš„å›¾å½¢ç¼“å†²åŒºä¹Ÿæ˜¯é€šè¿‡åŒ¿åå…±äº«å†…å­˜å’Œbinderä¼ é€’æè¿°ç¬¦æ˜ å°„è¿‡å»çš„ï¼Œ</span></span><br><span class="line">    <span class="comment">//Surfaceé€šè¿‡è°ƒç”¨requestBufferå°†å›¾å½¢ç¼“å†²åŒºæ˜ å°„åˆ°Surfaceæ‰€åœ¨è¿›ç¨‹</span></span><br><span class="line">    result = mGraphicBufferProducer-&gt;requestBuffer(buf, &amp;gbuf);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="comment">//è·å–è¿™ä¸ªè¿™ä¸ªbufferå¯¹è±¡çš„æŒ‡é’ˆå†…å®¹</span></span><br><span class="line">*buffer = gbuf.get();</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> BufferQueueProducer::requestBuffer(<span class="keyword">int</span> slot, sp&lt;GraphicBuffer&gt;* buf) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line">Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mCore-&gt;mMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">mSlots[slot].mRequestBufferCalled = <span class="literal">true</span>;</span><br><span class="line">*buf = mSlots[slot].mGraphicBuffer;</span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„é¢ï¼Œå°±æ˜¯æ ¹æ®æŒ‡å®šindexå–å‡ºmSlotsä¸­çš„slotä¸­çš„bufferã€‚</p><h4 id="å›¾å½¢ç¼“å†²åŒºå…¥é˜Ÿ"><a href="#å›¾å½¢ç¼“å†²åŒºå…¥é˜Ÿ" class="headerlink" title="å›¾å½¢ç¼“å†²åŒºå…¥é˜Ÿ"></a>å›¾å½¢ç¼“å†²åŒºå…¥é˜Ÿ</h4><p>æˆ‘ä»¬å‰é¢è®²äº†ï¼Œçœç•¥äº†ç¬¬äºŒæ­¥ç»˜åˆ¶æµç¨‹ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œåˆ†æç¬¬ä¸‰éƒ¨ï¼Œç»˜åˆ¶å®Œæ¯•åå†queueBufferã€‚ åŒæ ·ï¼Œè°ƒç”¨äº†Surfaceçš„unlockCanvasAndPostå‡½æ•°ï¼Œæˆ‘ä»¬æŸ¥çœ‹å®ƒçš„å®ç°ï¼š [-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Surface::unlockAndPost()</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"><span class="comment">//è§£é”å›¾å½¢ç¼“å†²åŒºï¼Œå’Œå‰é¢çš„lockAsyncæˆå¯¹å‡ºç°</span></span><br><span class="line"><span class="keyword">status_t</span> err = mLockedBuffer-&gt;unlockAsync(&amp;fd);</span><br><span class="line"><span class="comment">//queueBufferå»å½’è¿˜å›¾å½¢ç¼“å†²åŒº</span></span><br><span class="line">err = queueBuffer(mLockedBuffer.get(), fd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mPostedBuffer = mLockedBuffer;</span><br><span class="line">mLockedBuffer = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ ¸å¿ƒä¹Ÿæ˜¯åˆ†ä¸¤æ­¥ï¼š 1ï¼‰è§£é”å›¾å½¢ç¼“å†²åŒºï¼Œå’Œå‰é¢çš„lockAsyncæˆå¯¹å‡ºç°ï¼› 2ï¼‰queueBufferå»å½’è¿˜å›¾å½¢ç¼“å†²åŒºï¼› æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯é‡ç‚¹åˆ†æç¬¬äºŒæ­¥ï¼ŒæŸ¥çœ‹queueBufferçš„å®ç°ï¼š [-&gt;Surface.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Surface::queueBuffer(<span class="keyword">android_native_buffer_t</span>* buffer, <span class="keyword">int</span> fenceFd) &#123;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">status_t</span> err = mGraphicBufferProducer-&gt;queueBuffer(i, input, &amp;output);</span><br><span class="line">mLastQueueDuration = systemTime() - now;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨BufferQueueProducerçš„queueBufferå½’è¿˜ç¼“å†²åŒºï¼Œå°†ç»˜åˆ¶åçš„å›¾å½¢ç¼“å†²åŒºqueueå›å»ã€‚ [-&gt;BufferQueueProducer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> BufferQueueProducer::queueBuffer(<span class="keyword">int</span> slot,</span><br><span class="line">    <span class="keyword">const</span> QueueBufferInput &amp;input, QueueBufferOutput *output) &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&#123; <span class="comment">// scope for the lock</span></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mCallbackMutex)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (callbackTicket != mCurrentCallbackTicket) &#123;</span><br><span class="line">        mCallbackCondition.wait(mCallbackMutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (frameAvailableListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        frameAvailableListener-&gt;onFrameAvailable(item);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frameReplacedListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        frameReplacedListener-&gt;onFrameReplaced(item);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š 1ï¼‰ä»ä¼ å…¥çš„QueueBufferInput ï¼Œè§£æå¡«å……ä¸€äº›å˜é‡ï¼› 2ï¼‰æ”¹å˜å…¥é˜ŸSlotçš„çŠ¶æ€ä¸ºQUEUEDï¼Œæ¯æ¬¡æ¨è¿›æ¥ï¼ŒmFrameCounteréƒ½åŠ 1ã€‚è¿™é‡Œçš„slotï¼Œä¸Šä¸€ç¯‡è®²åˆ†é…ç¼“å†²åŒºè¿”å›æœ€è€çš„FREEçŠ¶æ€bufferï¼Œå°±æ˜¯ç”¨è¿™ä¸ªmFrameCounteræœ€å°å€¼åˆ¤æ–­ï¼Œå°±æ˜¯ä¸Šä¸€ç¯‡LRUç®—æ³•çš„åˆ¤æ–­ï¼› 3ï¼‰åˆ›å»ºä¸€ä¸ªBufferItemæ¥æè¿°GraphicBufferï¼Œç”¨mSlots[slot]ä¸­çš„slotå¡«å……BufferItemï¼› 4ï¼‰å°†BufferItemå¡è¿›mCoreçš„mQueueé˜Ÿåˆ—ï¼Œä¾ç…§æŒ‡å®šè§„åˆ™ï¼› 5ï¼‰ç„¶åé€šçŸ¥SurfaceFlingerå»æ¶ˆè´¹ã€‚</p><p>ä¸Šè¿°lockCanvaså’ŒunlockCanvasAndPostå¯ä»¥ç”¨ä¸‹å›¾æ¥æ€»ç»“ä¸€ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N19-Android-addWindow-LockUnlock.jpg" alt="Markdown"></p><h3 id="é€šçŸ¥SFæ¶ˆè´¹åˆæˆ"><a href="#é€šçŸ¥SFæ¶ˆè´¹åˆæˆ" class="headerlink" title="é€šçŸ¥SFæ¶ˆè´¹åˆæˆ"></a>é€šçŸ¥SFæ¶ˆè´¹åˆæˆ</h3><p><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N20-Android-addWindow-SF-Composition.png" alt="Markdown"></p><p>å½“ç»˜åˆ¶å®Œæ¯•çš„GraphicBufferå…¥é˜Ÿä¹‹åï¼Œä¼šé€šçŸ¥SurfaceFlingerå»æ¶ˆè´¹ï¼Œå°±æ˜¯BufferQueueProducerçš„queueBufferå‡½æ•°çš„æœ€åå‡ è¡Œï¼Œlistener-&gt;onFrameAvailable()ã€‚ listeneræœ€ç»ˆé€šè¿‡å›è°ƒï¼Œä¼šå›åˆ°Layerå½“ä¸­ï¼Œæ‰€ä»¥æœ€ç»ˆè°ƒç”¨Layerçš„onFrameAvailableæ¥å£ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®ç°ï¼š [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::onFrameAvailable(<span class="keyword">const</span> BufferItem&amp; item) &#123;</span><br><span class="line"><span class="comment">// Add this buffer from our internal queue tracker</span></span><br><span class="line">&#123; <span class="comment">// Autolock scope</span></span><br><span class="line">    ......</span><br><span class="line">    mQueueItems.push_back(item);</span><br><span class="line">    android_atomic_inc(&amp;mQueuedFrames);</span><br><span class="line">    <span class="comment">// Wake up any pending callbacks</span></span><br><span class="line">    mLastFrameNumberReceived = item.mFrameNumber;</span><br><span class="line">    mQueueItemCondition.broadcast();</span><br><span class="line">&#125;</span><br><span class="line">mFlinger-&gt;signalLayerUpdate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆè°ƒç”¨SurfaceFlingerçš„signalLayerUpdateå‡½æ•°ï¼Œç»§ç»­æŸ¥çœ‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::signalLayerUpdate() &#123;</span><br><span class="line">mEventQueue.invalidate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆè°ƒç”¨MessageQueueçš„invalidateå‡½æ•°ï¼š [MessageQueue.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MessageQueue::invalidate() &#123;</span><br><span class="line">mEvents-&gt;requestNextVsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è´´ä¸€ä¸‹SurfaceFlingerçš„åˆå§‹åŒ–è¯·æ±‚vsyncä¿¡å·æµç¨‹å›¾ï¼š<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N21-Android-addWindow-vsync-surfaceflinger.png" alt="Markdown"></p><p>æœ€ç»ˆç»“æœä¼šèµ°åˆ°SurfaceFlingerçš„vsyncä¿¡å·æ¥æ”¶é€»è¾‘ï¼Œå³SurfaceFlingerçš„onMessageReceivedå‡½æ•°ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::onMessageReceived(<span class="keyword">int32_t</span> what) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"><span class="keyword">switch</span> (what) &#123;</span><br><span class="line">    <span class="keyword">case</span> MessageQueue::INVALIDATE: &#123;</span><br><span class="line">        <span class="keyword">bool</span> frameMissed = !mHadClientComposition &amp;&amp;</span><br><span class="line">                mPreviousPresentFence != Fence::NO_FENCE &amp;&amp;</span><br><span class="line">                mPreviousPresentFence-&gt;getSignalTime() == INT64_MAX;</span><br><span class="line">        ATRACE_INT(<span class="string">"FrameMissed"</span>, <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(frameMissed));</span><br><span class="line">        <span class="keyword">if</span> (mPropagateBackpressure &amp;&amp; frameMissed) &#123;</span><br><span class="line">            signalLayerUpdate();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> refreshNeeded = handleMessageTransaction();</span><br><span class="line">        refreshNeeded |= handleMessageInvalidate();</span><br><span class="line">        refreshNeeded |= mRepaintEverything;</span><br><span class="line">        <span class="keyword">if</span> (refreshNeeded) &#123;</span><br><span class="line">            <span class="comment">// Signal a refresh if a transaction modified the window state,</span></span><br><span class="line">            <span class="comment">// a new buffer was latched, or if HWC has requested a full</span></span><br><span class="line">            <span class="comment">// repaint</span></span><br><span class="line">            signalRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> MessageQueue::REFRESH: &#123;</span><br><span class="line">        handleMessageRefresh();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SurfaceFlingeræ”¶åˆ°äº†VSyncä¿¡å·åï¼Œè°ƒç”¨äº†handleMessageRefreshå‡½æ•° [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleMessageRefresh() &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line"><span class="keyword">nsecs_t</span> refreshStartTime = systemTime(SYSTEM_TIME_MONOTONIC);</span><br><span class="line"></span><br><span class="line">preComposition();</span><br><span class="line">rebuildLayerStacks();</span><br><span class="line">setUpHWComposer();</span><br><span class="line">doDebugFlashRegions();</span><br><span class="line">doComposition();</span><br><span class="line">postComposition(refreshStartTime);</span><br><span class="line"></span><br><span class="line">mPreviousPresentFence = mHwc-&gt;getRetireFence(HWC_DISPLAY_PRIMARY);</span><br><span class="line"></span><br><span class="line">mHadClientComposition = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> displayId = <span class="number">0</span>; displayId &lt; mDisplays.size(); ++displayId) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; displayDevice = mDisplays[displayId];</span><br><span class="line">    mHadClientComposition = mHadClientComposition ||</span><br><span class="line">            mHwc-&gt;hasClientComposition(displayDevice-&gt;getHwcDisplayId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Release any buffers which were replaced this frame</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; layer : mLayersWithQueuedFrames) &#123;</span><br><span class="line">    layer-&gt;releasePendingBuffer();</span><br><span class="line">&#125;</span><br><span class="line">mLayersWithQueuedFrames.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦çœ‹ä¸‹ä¸‹é¢å‡ ä¸ªå‡½æ•°ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">preComposition();</span><br><span class="line">rebuildLayerStacks();</span><br><span class="line">setUpHWComposer();</span><br><span class="line">doDebugFlashRegions();</span><br><span class="line">doComposition();</span><br><span class="line">postComposition(refreshStartTime);</span><br></pre></td></tr></table></figure><h4 id="ä¸€ã€preComposition-å‡½æ•°"><a href="#ä¸€ã€preComposition-å‡½æ•°" class="headerlink" title="ä¸€ã€preComposition()å‡½æ•°"></a>ä¸€ã€preComposition()å‡½æ•°</h4><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªå‡½æ•°preComposition() [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::preComposition()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">bool</span> needExtraInvalidate = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (layers[i]-&gt;onPreComposition()) &#123;</span><br><span class="line">        needExtraInvalidate = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (needExtraInvalidate) &#123;</span><br><span class="line">    signalLayerUpdate();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‡½æ•°å…ˆæ˜¯è°ƒç”¨äº†mDrawingStateçš„layersSortedByZæ¥å¾—åˆ°ä¸Šæ¬¡ç»˜å›¾çš„Layerå±‚åˆ—è¡¨ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„Layeréƒ½ä¼šå‚ä¸å±å¹•å›¾åƒçš„ç»˜åˆ¶ï¼Œå› æ­¤SurfaceFlingerç”¨stateå¯¹è±¡æ¥è®°å½•å‚ä¸ç»˜åˆ¶çš„Layerå¯¹è±¡ã€‚ è®°å¾—æˆ‘ä»¬ä¹‹å‰åˆ†æè¿‡createLayerå‡½æ•°æ¥åˆ›å»ºLayerï¼Œåˆ›å»ºä¹‹åä¼šè°ƒç”¨addClientLayerå‡½æ•°ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> SurfaceFlinger::addClientLayer(<span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; handle,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; gbc,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;Layer&gt;&amp; lbc)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">// add this layer to the current state list</span></span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mStateLock);</span><br><span class="line">    <span class="keyword">if</span> (mCurrentState.layersSortedByZ.size() &gt;= MAX_LAYERS) &#123;</span><br><span class="line">        <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line">    mCurrentState.layersSortedByZ.add(lbc);</span><br><span class="line">    mGraphicBufferProducerList.add(IInterface::asBinder(gbc));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// attach this layer to the client</span></span><br><span class="line">client-&gt;attachLayer(handle, lbc);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹ä¸‹addClientLayerå‡½æ•°ï¼Œè¿™é‡Œä¼šæŠŠLayerå¯¹è±¡æ”¾åœ¨mCurrentStateçš„layersSortedByZå¯¹è±¡ä¸­ã€‚è€ŒmDrawingStateå’ŒmCurrentStateä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿåœ¨åé¢æˆ‘ä»¬ä¼šä»‹ç»ï¼ŒmDrawingStateä»£è¡¨ä¸Šä¸€æ¬¡ç»˜å›¾æ—¶çš„çŠ¶æ€ï¼Œå¤„ç†å®Œä¹‹åä¼šæŠŠmCurrentStateèµ‹ç»™mDrawingStateã€‚ å›åˆ°preCompositionå‡½æ•°ï¼Œéå†æ‰€æœ‰çš„Layerå¯¹è±¡ï¼Œè°ƒç”¨å…¶onPreCompositionå‡½æ•°æ¥æ£€æµ‹Layerå±‚ä¸­çš„å›¾åƒæ˜¯å¦æœ‰å˜åŒ–ã€‚</p><h4 id="1-1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°"><a href="#1-1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°" class="headerlink" title="1.1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°"></a>1.1ã€æ¯ä¸ªLayerçš„onFrameAvailableå‡½æ•°</h4><p>onPreCompositionå‡½æ•°æ¥æ ¹æ®mQueuedFramesæ¥åˆ¤æ–­å›¾åƒæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œæˆ–è€…æ˜¯mSidebandStreamChangedã€mAutoRefreshã€‚ [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Layer::onPreComposition() &#123;</span><br><span class="line">mRefreshPending = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">return</span> mQueuedFrames &gt; <span class="number">0</span> || mSidebandStreamChanged || mAutoRefresh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“Layeræ‰€å¯¹åº”çš„Surfaceæ›´æ–°å›¾åƒåï¼Œå®ƒæ‰€å¯¹åº”çš„Layerå¯¹è±¡çš„onFrameAvailableå‡½æ•°ä¼šè¢«è°ƒç”¨æ¥é€šçŸ¥è¿™ç§å˜åŒ–ã€‚ åœ¨SurfaceFlingerçš„preCompositionå‡½æ•°ä¸­å½“æœ‰Layerçš„å›¾åƒæ”¹å˜äº†ï¼Œæœ€åä¹Ÿä¼šè°ƒç”¨SurfaceFlingerçš„signalLayerUpdateå‡½æ•°ã€‚ SurfaceFlinger::signalLayerUpdateæ˜¯è°ƒç”¨äº†MessageQueueçš„invalidateå‡½æ•° æœ€åå¤„ç†è¿˜æ˜¯è°ƒç”¨äº†SurfaceFlingerçš„onMessageReceivedå‡½æ•°ã€‚çœ‹çœ‹SurfaceFlingerçš„onMessageReceivedå‡½æ•°å¯¹NVALIDATEçš„å¤„ç† handleMessageInvalidateå‡½æ•°ä¸­è°ƒç”¨äº†handlePageFlipå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†ä¼šå¤„ç†Layerä¸­çš„ç¼“å†²åŒºï¼ŒæŠŠæ›´æ–°è¿‡çš„å›¾åƒç¼“å†²åŒºåˆ‡æ¢åˆ°å‰å°ï¼Œç­‰å¾…VSyncä¿¡å·æ›´æ–°åˆ°FrameBufferã€‚</p><h4 id="1-2ã€ç»˜åˆ¶æµç¨‹"><a href="#1-2ã€ç»˜åˆ¶æµç¨‹" class="headerlink" title="1.2ã€ç»˜åˆ¶æµç¨‹"></a>1.2ã€ç»˜åˆ¶æµç¨‹</h4><p>å…·ä½“å®Œæ•´çš„ç»˜åˆ¶æµç¨‹å¦‚å›¾ã€‚<br><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/android.addwindow/N22-Android-addWindow-SF-Composition.jpg" alt="Markdown"></p><h5 id="äºŒã€handleTransaction-handPageFlipæ›´æ–°Layerå¯¹è±¡"><a href="#äºŒã€handleTransaction-handPageFlipæ›´æ–°Layerå¯¹è±¡" class="headerlink" title="äºŒã€handleTransaction handPageFlipæ›´æ–°Layerå¯¹è±¡"></a>äºŒã€handleTransaction handPageFlipæ›´æ–°Layerå¯¹è±¡</h5><p>åœ¨ä¸Šä¸€èŠ‚ä¸­çš„ç»˜å›¾çš„æµç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†handleTransactionå’ŒhandPageFlipè¿™ä¸¤ä¸ªå‡½æ•°é€šå¸¸æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹æ›´æ–°Surfaceå›¾åƒæ—¶ä¼šè°ƒç”¨ï¼Œæ¥æ›´æ–°Layerå¯¹è±¡ã€‚è¿™èŠ‚å°±ä¸»è¦è®²è§£è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p><h4 id="2-1ã€handleTransactionå‡½æ•°"><a href="#2-1ã€handleTransactionå‡½æ•°" class="headerlink" title="2.1ã€handleTransactionå‡½æ•°"></a>2.1ã€handleTransactionå‡½æ•°</h4><p>handleTransactionå‡½æ•°çš„å‚æ•°æ˜¯transactionFlagsï¼Œä¸è¿‡å‡½æ•°ä¸­æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼Œè€Œæ˜¯é€šè¿‡getTransactionFlags(eTransactionMask)æ¥é‡æ–°å¯¹transactionFlagsèµ‹å€¼ï¼Œç„¶åä½¿ç”¨å®ƒä½œä¸ºå‚æ•°æ¥è°ƒç”¨å‡½æ•° handleTransactionLockedã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleTransaction(<span class="keyword">uint32_t</span> transactionFlags)</span><br><span class="line">&#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line">Mutex::Autolock _l(mStateLock);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">nsecs_t</span> now = systemTime();</span><br><span class="line">mDebugInTransaction = now;</span><br><span class="line"></span><br><span class="line">transactionFlags = getTransactionFlags(eTransactionMask);</span><br><span class="line">handleTransactionLocked(transactionFlags);</span><br><span class="line"></span><br><span class="line">mLastTransactionTime = systemTime() - now;</span><br><span class="line">mDebugInTransaction = <span class="number">0</span>;</span><br><span class="line">invalidateHwcGeometry();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getTransactionFlagså‡½æ•°çš„å‚æ•°æ˜¯eTransactionMaskåªæ˜¯å±è”½å…¶ä»–ä½ã€‚ handleTransactionLockedå‡½æ•°ä¼šè°ƒç”¨æ¯ä¸ªLayerç±»çš„doTransactionå‡½æ•°ï¼Œåœ¨åˆ†æhandleTransactionLockedå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹Layerç±» çš„doTransactionå‡½æ•°ã€‚</p><h4 id="2-2ã€Layerçš„doTransactionå‡½æ•°"><a href="#2-2ã€Layerçš„doTransactionå‡½æ•°" class="headerlink" title="2.2ã€Layerçš„doTransactionå‡½æ•°"></a>2.2ã€Layerçš„doTransactionå‡½æ•°</h4><p>ä¸‹é¢æ˜¯Layerçš„doTransactionå‡½æ•°ä»£ç  [Layer.cpp]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">uint32_t Layer::doTransaction(uint32_t flags) &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line">pushPendingState();<span class="comment">//ä¸Šæ¬¡ç»˜åˆ¶çš„Stateå¯¹è±¡  </span></span><br><span class="line">Layer::State c = getCurrentState();<span class="comment">//å½“å‰ä½¿ç”¨çš„Stateå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Layer::State&amp; s(getDrawingState());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bool sizeChanged = (c.requested.w != s.requested.w) ||</span><br><span class="line">                         (c.requested.h != s.requested.h);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sizeChanged) &#123;</span><br><span class="line">    <span class="comment">// the size changed, we need to ask our client to request a new buffer</span></span><br><span class="line">    <span class="comment">//å¦‚æœLayerçš„å°ºå¯¸å‘ç”Ÿå˜åŒ–ï¼Œå°±è¦æ”¹å˜Surfaceçš„ç¼“å†²åŒºçš„å°ºå¯¸</span></span><br><span class="line">    <span class="comment">// record the new size, form this point on, when the client request</span></span><br><span class="line">    <span class="comment">// a buffer, it'll get the new size.</span></span><br><span class="line">    mSurfaceFlingerConsumer-&gt;setDefaultBufferSize(</span><br><span class="line">            c.requested.w, c.requested.h);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bool resizePending = (c.requested.w != c.active.w) ||</span><br><span class="line">        (c.requested.h != c.active.h);</span><br><span class="line"><span class="keyword">if</span> (!isFixedSize()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (resizePending &amp;&amp; mSidebandStream == NULL) &#123;</span><br><span class="line">    <span class="comment">//å¦‚æœLayerä¸æ˜¯å›ºå®šå°ºå¯¸çš„ç±»å‹ï¼Œæ¯”è¾ƒå®ƒçš„å®é™…å¤§å°å’Œè¦æ±‚çš„æ”¹å˜å¤§å°  </span></span><br><span class="line">        flags |= eDontUpdateGeometryState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰eDontUpdateGeometryStateæ ‡å¿—ï¼Œæ›´æ–°activeçš„å€¼ä¸ºrequest  </span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; eDontUpdateGeometryState)  &#123;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Layer::State&amp; editCurrentState(getCurrentState());</span><br><span class="line">    <span class="keyword">if</span> (mFreezePositionUpdates) &#123;</span><br><span class="line">        <span class="keyword">float</span> tx = c.active.transform.tx();</span><br><span class="line">        <span class="keyword">float</span> ty = c.active.transform.ty();</span><br><span class="line">        c.active = c.requested;</span><br><span class="line">        c.active.transform.set(tx, ty);</span><br><span class="line">        editCurrentState.active = c.active;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        editCurrentState.active = editCurrentState.requested;</span><br><span class="line">        c.active = c.requested;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰stateçš„activeå’Œä»¥å‰çš„Stateçš„activeä¸ç­‰ï¼Œè®¾ç½®æ›´æ–°æ ‡å¿—  </span></span><br><span class="line"><span class="keyword">if</span> (s.active != c.active) &#123;</span><br><span class="line">    <span class="comment">// invalidate and recompute the visible regions if needed</span></span><br><span class="line">    flags |= Layer::eVisibleRegion;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœå½“å‰stateçš„sequenceå’Œä»¥å‰stateçš„sequenceä¸ç­‰ï¼Œè®¾ç½®æ›´æ–°æ ‡å¿—</span></span><br><span class="line"><span class="keyword">if</span> (c.sequence != s.sequence) &#123;</span><br><span class="line">    <span class="comment">// invalidate and recompute the visible regions if needed</span></span><br><span class="line">    flags |= eVisibleRegion;</span><br><span class="line">    <span class="keyword">this</span>-&gt;contentDirty = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we may use linear filtering, if the matrix scales us</span></span><br><span class="line">    <span class="keyword">const</span> uint8_t type = c.active.transform.getType();</span><br><span class="line">    mNeedsFiltering = (!c.active.transform.preserveRects() ||</span><br><span class="line">            (type &gt;= Transform::SCALE));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the layer is hidden, signal and clear out all local sync points so</span></span><br><span class="line"><span class="comment">// that transactions for layers depending on this layer's frames becoming</span></span><br><span class="line"><span class="comment">// visible are not blocked</span></span><br><span class="line"><span class="keyword">if</span> (c.flags &amp; layer_state_t::eLayerHidden) &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mLocalSyncPointMutex)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (auto&amp; point : mLocalSyncPoints) &#123;</span><br><span class="line">        point-&gt;setFrameAvailable();</span><br><span class="line">    &#125;</span><br><span class="line">    mLocalSyncPoints.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Commit the transaction</span></span><br><span class="line">commitTransaction(c);</span><br><span class="line"><span class="keyword">return</span> flags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Layerç±»ä¸­çš„ä¸¤ä¸ªç±»å‹ä¸ºLayer::Stateçš„æˆå‘˜å˜é‡mDrawingStateã€mCurrentStateï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªå¯¹è±¡å‘¢ï¼ŸLayerå¯¹è±¡åœ¨ç»˜åˆ¶å›¾å½¢æ—¶ï¼Œä½¿ç”¨çš„æ˜¯mDrawingStateå˜é‡ï¼Œç”¨æˆ·è°ƒç”¨æ¥å£è®¾ç½®Layerå¯¹è±¡å±æ€§æ˜¯ï¼Œè®¾ç½®çš„å€¼ä¿å­˜åœ¨mCurrentStateå¯¹è±¡ä¸­ï¼Œè¿™æ ·å°±ä¸ä¼šå› ä¸ºç”¨æˆ·çš„æ“ä½œè€Œå¹²æ‰°Layerå¯¹è±¡çš„ç»˜åˆ¶äº†ã€‚ Layerçš„doTransactionå‡½æ•°æ®ä½ æ˜¯æ¯”è¾ƒè¿™ä¸¤ä¸ªå˜é‡ï¼Œå¦‚æœæœ‰ä¸åŒçš„åœ°æ–¹ï¼Œè¯´æ˜åœ¨ä¸Šæ¬¡ç»˜åˆ¶ä»¥åï¼Œç”¨æˆ·æ”¹å˜çš„Layerçš„è®¾ç½®ï¼Œè¦æŠŠè¿™ç§å˜åŒ–é€šè¿‡flagsè¿”å›ã€‚ Stateçš„ç»“æ„ä¸­æœ‰ä¸¤ä¸ªGeometryå­—æ®µï¼Œactiveå’Œrequestedã€‚ä»–ä»¬è¡¨ç¤ºlayerçš„å°ºå¯¸ï¼Œå…¶ä¸­requestedä¿å­˜æ˜¯ç”¨æˆ·è®¾ç½®çš„å°ºå¯¸ï¼Œè€Œactiveä¿å­˜çš„å€¼é€šè¿‡è®¡ç®—åçš„å®é™…å°ºå¯¸ã€‚ Stateä¸­çš„zå­—æ®µçš„å€¼å°±æ˜¯Layeråœ¨æ˜¾ç¤ºè½´çš„ä½ç½®ï¼Œå€¼è¶Šå°ä½ç½®è¶Šé ä¸‹ã€‚ layerStackå­—æ®µæ˜¯ç”¨æˆ·æŒ‡å®šçš„ä¸€ä¸ªå€¼ï¼Œç”¨æˆ·å¯ä»¥ç»™DisplayDeviceä¹ŸæŒ‡å®šä¸€ä¸ªlayerStackå€¼ï¼Œåªæœ‰Layerå¯¹è±¡å’ŒDisplayDeviceå¯¹è±¡çš„layerStackç›¸ç­‰ï¼Œè¿™ä¸ªLayeræ‰èƒ½åœ¨è¿™ä¸ªæ˜¾ç¤ºè®¾å¤‡ä¸Šè¾“å‡ºï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥è®©æ˜¾ç¤ºè®¾å¤‡åªæ˜¾ç¤ºæŸä¸ªSurfaceçš„å†…å®¹ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥è®©HDMIæ˜¾ç¤ºè®¾å¤‡åªæ˜¾ç¤ºæ‰‹æœºä¸Šæ’­æ”¾è§†é¢‘çš„Surfaceçª—å£ï¼Œä½†ä¸æ˜¾ç¤ºActivityçª—å£ã€‚ sequenceå­—æ®µæ˜¯ä¸ªåºåˆ—å€¼ï¼Œæ¯å½“ç”¨æˆ·è°ƒç”¨äº†Layerçš„æ¥å£ï¼Œä¾‹å¦‚setAlphaã€setSizeæˆ–è€…setLayerç­‰æ”¹å˜Layerå¯¹è±¡å±æ€§çš„å“ˆæ•°ï¼Œè¿™ä¸ªå€¼éƒ½ä¼šåŠ 1ã€‚å› æ­¤åœ¨doTransactionå‡½æ•°ä¸­èƒ½é€šè¿‡æ¯”è¾ƒsequenceå€¼æ¥åˆ¤æ–­Layerçš„å±æ€§å€¼æœ‰æ²¡æœ‰å˜åŒ–ã€‚ doTransactionå‡½æ•°æœ€åä¼šè°ƒç”¨commitTransactionå‡½æ•°ï¼Œå°±æ˜¯æŠŠmCurrentStateèµ‹å€¼ç»™mDrawingState [Layer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Layer::commitTransaction(<span class="keyword">const</span> State&amp; stateToCommit) &#123;</span><br><span class="line">mDrawingState = stateToCommit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3ã€handleTransactionLockedå‡½æ•°"><a href="#2-3ã€handleTransactionLockedå‡½æ•°" class="headerlink" title="2.3ã€handleTransactionLockedå‡½æ•°"></a>2.3ã€handleTransactionLockedå‡½æ•°</h5><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æhandleTransactionLockedå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬åˆ†æ®µåˆ†æ</p><p>2.3.1 å¤„ç†Layerçš„äº‹åŠ¡ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::handleTransactionLocked(<span class="keyword">uint32_t</span> transactionFlags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">currentLayers</span><span class="params">(mCurrentState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notify all layers of available frames</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">    currentLayers[i]-&gt;notifyAvailableFrames();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (transactionFlags &amp; eTraversalNeeded) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">        <span class="keyword">uint32_t</span> trFlags = layer-&gt;getTransactionFlags(eTransactionNeeded);</span><br><span class="line">        <span class="keyword">if</span> (!trFlags) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint32_t</span> flags = layer-&gt;doTransaction(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; Layer::eVisibleRegion)</span><br><span class="line">            mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨SurfaceFlingerä¸­ä¹Ÿæœ‰ä¸¤ä¸ªç±»å‹ä¸ºStateçš„å˜é‡mCurrentStateå’ŒmDrawingStateï¼Œä½†æ˜¯å’ŒLayerä¸­çš„ä¸è¦æ··èµ·æ¥ã€‚å®ƒçš„åå­—ç›¸åŒè€Œå·²</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">State</span> &#123;</span></span><br><span class="line">    LayerVector layersSortedByZ;</span><br><span class="line">    DefaultKeyedVector&lt; wp&lt;IBinder&gt;, DisplayDeviceState&gt; displays;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“æ„layersSortedByZå­—æ®µä¿å­˜æ‰€æœ‰å‚ä¸ç»˜åˆ¶çš„Layerå¯¹è±¡ï¼Œè€Œå­—æ®µdisplaysä¿å­˜çš„æ˜¯æ‰€æœ‰è¾“å‡ºè®¾å¤‡çš„DisplayDeviceStateå¯¹è±¡ è¿™é‡Œç”¨ä¸¤ä¸ªå˜é‡çš„ç›®çš„æ˜¯å’ŒLayerä¸­ä½¿ç”¨ä¸¤ä¸ªå˜é‡æ˜¯ä¸€æ ·çš„ã€‚ ä¸Šé¢ä»£ç æ ¹æ®eTraversalNeededæ ‡å¿—æ¥å†³å®šæ˜¯å¦è¦æ£€æŸ¥æ‰€æœ‰çš„Layerå¯¹è±¡ã€‚å¦‚æœæŸä¸ªLayerå¯¹è±¡ä¸­æœ‰eTransactionNeededæ ‡å¿—ï¼Œå°†è°ƒç”¨å®ƒçš„doTransactionå‡½æ•°ã€‚Layerçš„doTransactionå‡½æ•°è¿”å›çš„flagså¦‚æœæœ‰eVisibleRegionï¼Œè¯´æ˜è¿™ä¸ªLayeréœ€è¦æ›´æ–°ï¼Œå°±æŠŠmVisibleRegionsDirtyè®¾ç½®ä¸ºtrue</p><h5 id="2-3-2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–"><a href="#2-3-2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–" class="headerlink" title="2.3.2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–"></a>2.3.2ã€å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (transactionFlags &amp; eDisplayTransactionNeeded) &#123;</span><br><span class="line">    <span class="comment">// here we take advantage of Vector's copy-on-write semantics to</span></span><br><span class="line">    <span class="comment">// improve performance by skipping the transaction entirely when</span></span><br><span class="line">    <span class="comment">// know that the lists are identical</span></span><br><span class="line">    <span class="keyword">const</span> KeyedVector&lt;  wp&lt;IBinder&gt;, DisplayDeviceState&gt;&amp; curr(mCurrentState.displays);</span><br><span class="line">    <span class="keyword">const</span> KeyedVector&lt;  wp&lt;IBinder&gt;, DisplayDeviceState&gt;&amp; draw(mDrawingState.displays);</span><br><span class="line">    <span class="keyword">if</span> (!curr.isIdenticalTo(draw)) &#123;</span><br><span class="line">        mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> cc = curr.size();</span><br><span class="line">              <span class="keyword">size_t</span> dc = draw.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// find the displays that were removed</span></span><br><span class="line">        <span class="comment">// (ie: in drawing state but not in current state)</span></span><br><span class="line">        <span class="comment">// also handle displays that changed</span></span><br><span class="line">        <span class="comment">// (ie: displays that are in both lists)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;dc ; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">ssize_t</span> j = curr.indexOfKey(draw.keyAt(i));</span><br><span class="line">            <span class="keyword">if</span> (j &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// in drawing state but not in current state</span></span><br><span class="line">                <span class="keyword">if</span> (!draw[i].isMainDisplay()) &#123;</span><br><span class="line">                    <span class="comment">// Call makeCurrent() on the primary display so we can</span></span><br><span class="line">                    <span class="comment">// be sure that nothing associated with this display</span></span><br><span class="line">                    <span class="comment">// is current.</span></span><br><span class="line">                    <span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt; defaultDisplay(getDefaultDisplayDevice());</span><br><span class="line">                    defaultDisplay-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw(getDisplayDevice(draw.keyAt(i)));</span><br><span class="line">                    <span class="keyword">if</span> (hw != <span class="literal">NULL</span>)</span><br><span class="line">                        hw-&gt;disconnect(getHwComposer());</span><br><span class="line">                    <span class="keyword">if</span> (draw[i].type &lt; DisplayDevice::NUM_BUILTIN_DISPLAY_TYPES)</span><br><span class="line">                        mEventThread-&gt;onHotplugReceived(draw[i].type, <span class="literal">false</span>);</span><br><span class="line">                    mDisplays.removeItem(draw.keyAt(i));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGW(<span class="string">"trying to remove the main display"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// this display is in both lists. see if something changed.</span></span><br><span class="line">                <span class="keyword">const</span> DisplayDeviceState&amp; state(curr[j]);</span><br><span class="line">                <span class="keyword">const</span> wp&lt;IBinder&gt;&amp; display(curr.keyAt(j));</span><br><span class="line">                <span class="keyword">const</span> sp&lt;IBinder&gt; state_binder = IInterface::asBinder(state.surface);</span><br><span class="line">                <span class="keyword">const</span> sp&lt;IBinder&gt; draw_binder = IInterface::asBinder(draw[i].surface);</span><br><span class="line">                <span class="keyword">if</span> (state_binder != draw_binder) &#123;</span><br><span class="line">                    <span class="comment">// changing the surface is like destroying and</span></span><br><span class="line">                    <span class="comment">// recreating the DisplayDevice, so we just remove it</span></span><br><span class="line">                    <span class="comment">// from the drawing state, so that it get re-added</span></span><br><span class="line">                    <span class="comment">// below.</span></span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw(getDisplayDevice(display));</span><br><span class="line">                    <span class="keyword">if</span> (hw != <span class="literal">NULL</span>)</span><br><span class="line">                        hw-&gt;disconnect(getHwComposer());</span><br><span class="line">                    mDisplays.removeItem(display);</span><br><span class="line">                    mDrawingState.displays.removeItemsAt(i);</span><br><span class="line">                    dc--; i--;</span><br><span class="line">                    <span class="comment">// at this point we must loop to the next item</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> sp&lt;DisplayDevice&gt; disp(getDisplayDevice(display));</span><br><span class="line">                <span class="keyword">if</span> (disp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (state.layerStack != draw[i].layerStack) &#123;</span><br><span class="line">                        disp-&gt;setLayerStack(state.layerStack);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((state.orientation != draw[i].orientation)</span><br><span class="line">                            || (state.viewport != draw[i].viewport)</span><br><span class="line">                            || (state.frame != draw[i].frame))</span><br><span class="line">                    &#123;</span><br><span class="line">                        disp-&gt;setProjection(state.orientation,</span><br><span class="line">                                state.viewport, state.frame);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (state.width != draw[i].width || state.height != draw[i].height) &#123;</span><br><span class="line">                        disp-&gt;setDisplaySize(state.width, state.height);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// find displays that were added</span></span><br><span class="line">        <span class="comment">// (ie: in current state but not in drawing state)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;cc ; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (draw.indexOfKey(curr.keyAt(i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="function"><span class="keyword">const</span> DisplayDeviceState&amp; <span class="title">state</span><span class="params">(curr[i])</span></span>;</span><br><span class="line"></span><br><span class="line">                sp&lt;DisplaySurface&gt; dispSurface;</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt; bqProducer;</span><br><span class="line">                sp&lt;IGraphicBufferConsumer&gt; bqConsumer;</span><br><span class="line">                BufferQueue::createBufferQueue(&amp;bqProducer, &amp;bqConsumer,</span><br><span class="line">                        <span class="keyword">new</span> GraphicBufferAlloc());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int32_t</span> hwcDisplayId = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">if</span> (state.isVirtualDisplay()) &#123;</span><br><span class="line">                    <span class="comment">// Virtual displays without a surface are dormant:</span></span><br><span class="line">                    <span class="comment">// they have external state (layer stack, projection,</span></span><br><span class="line">                    <span class="comment">// etc.) but no internal state (i.e. a DisplayDevice).</span></span><br><span class="line">                    <span class="keyword">if</span> (state.surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">int</span> width = <span class="number">0</span>;</span><br><span class="line">                        DisplayUtils* displayUtils = DisplayUtils::getInstance();</span><br><span class="line">                        <span class="keyword">int</span> status = state.surface-&gt;query(</span><br><span class="line">                                NATIVE_WINDOW_WIDTH, &amp;width);</span><br><span class="line">                        ALOGE_IF(status != NO_ERROR,</span><br><span class="line">                                <span class="string">"Unable to query width (%d)"</span>, status);</span><br><span class="line">                        <span class="keyword">int</span> height = <span class="number">0</span>;</span><br><span class="line">                        status = state.surface-&gt;query(</span><br><span class="line">                            NATIVE_WINDOW_HEIGHT, &amp;height);</span><br><span class="line">                        ALOGE_IF(status != NO_ERROR,</span><br><span class="line">                            <span class="string">"Unable to query height (%d)"</span>, status);</span><br><span class="line">                        <span class="keyword">if</span> (MAX_VIRTUAL_DISPLAY_DIMENSION == <span class="number">0</span> ||</span><br><span class="line">                            (width &lt;= MAX_VIRTUAL_DISPLAY_DIMENSION &amp;&amp;</span><br><span class="line">                             height &lt;= MAX_VIRTUAL_DISPLAY_DIMENSION)) &#123;</span><br><span class="line">                            <span class="keyword">int</span> usage = <span class="number">0</span>;</span><br><span class="line">                            status = state.surface-&gt;query(</span><br><span class="line">                                NATIVE_WINDOW_CONSUMER_USAGE_BITS, &amp;usage);</span><br><span class="line">                            ALOGW_IF(status != NO_ERROR,</span><br><span class="line">                                <span class="string">"Unable to query usage (%d)"</span>, status);</span><br><span class="line">                            <span class="keyword">if</span> ( (status == NO_ERROR) &amp;&amp;</span><br><span class="line">                                  displayUtils-&gt;canAllocateHwcDisplayIdForVDS(usage)) &#123;</span><br><span class="line">                                hwcDisplayId = allocateHwcDisplayId(state.type);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        displayUtils-&gt;initVDSInstance(mHwc, hwcDisplayId, state.surface,</span><br><span class="line">                                dispSurface, producer, bqProducer, bqConsumer,</span><br><span class="line">                                state.displayName, state.isSecure, state.type);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGE_IF(state.surface!=<span class="literal">NULL</span>,</span><br><span class="line">                            <span class="string">"adding a supported display, but rendering "</span></span><br><span class="line">                            <span class="string">"surface is provided (%p), ignoring it"</span>,</span><br><span class="line">                            state.surface.get());</span><br><span class="line">                    hwcDisplayId = allocateHwcDisplayId(state.type);</span><br><span class="line">                    <span class="comment">// for supported (by hwc) displays we provide our</span></span><br><span class="line">                    <span class="comment">// own rendering surface</span></span><br><span class="line">                    dispSurface = <span class="keyword">new</span> FramebufferSurface(*mHwc, state.type,</span><br><span class="line">                            bqConsumer);</span><br><span class="line">                    producer = bqProducer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> wp&lt;IBinder&gt;&amp; display(curr.keyAt(i));</span><br><span class="line">                <span class="keyword">if</span> (dispSurface != <span class="literal">NULL</span> &amp;&amp; producer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    sp&lt;DisplayDevice&gt; hw = <span class="keyword">new</span> DisplayDevice(<span class="keyword">this</span>,</span><br><span class="line">                            state.type, hwcDisplayId,</span><br><span class="line">                            mHwc-&gt;getFormat(hwcDisplayId), state.isSecure,</span><br><span class="line">                            display, dispSurface, producer,</span><br><span class="line">                            mRenderEngine-&gt;getEGLConfig());</span><br><span class="line">                    hw-&gt;setLayerStack(state.layerStack);</span><br><span class="line">                    hw-&gt;setProjection(state.orientation,</span><br><span class="line">                            state.viewport, state.frame);</span><br><span class="line">                    hw-&gt;setDisplayName(state.displayName);</span><br><span class="line">                    <span class="comment">// When a new display device is added update the active</span></span><br><span class="line">                    <span class="comment">// config by querying HWC otherwise the default config</span></span><br><span class="line">                    <span class="comment">// (config 0) will be used.</span></span><br><span class="line">                    <span class="keyword">if</span> (hwcDisplayId &gt;= DisplayDevice::DISPLAY_PRIMARY &amp;&amp;</span><br><span class="line">                            hwcDisplayId &lt; DisplayDevice::NUM_BUILTIN_DISPLAY_TYPES) &#123;</span><br><span class="line">                        <span class="keyword">int</span> activeConfig = mHwc-&gt;getActiveConfig(hwcDisplayId);</span><br><span class="line">                        <span class="keyword">if</span> (activeConfig &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            hw-&gt;setActiveConfig(activeConfig);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mDisplays.add(display, hw);</span><br><span class="line">                    <span class="keyword">if</span> (state.isVirtualDisplay()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (hwcDisplayId &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            mHwc-&gt;setVirtualDisplayProperties(hwcDisplayId,</span><br><span class="line">                                    hw-&gt;getWidth(), hw-&gt;getHeight(),</span><br><span class="line">                                    hw-&gt;getFormat());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mEventThread-&gt;onHotplugReceived(state.type, <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯å¤„ç†æ˜¾ç¤ºè®¾å¤‡çš„å˜åŒ–ï¼Œåˆ†æˆ3ç§æƒ…å†µï¼š 1.æ˜¾ç¤ºè®¾å¤‡å‡å°‘äº†ï¼Œéœ€è¦æŠŠæ˜¾ç¤ºè®¾å¤‡å¯¹åº”çš„DisplayDeviceç§»é™¤ 2.æ˜¾ç¤ºè®¾å¤‡å‘ç”Ÿäº†å˜åŒ–ï¼Œä¾‹å¦‚ç”¨æˆ·è®¾ç½®äº†Surfaceã€é‡æ–°è®¾ç½®äº†layerStackã€æ—‹è½¬äº†å±å¹•ç­‰ï¼Œè¿™å°±éœ€è¦é‡æ–°è®¾ç½®æ˜¾ç¤ºå¯¹è±¡çš„å±æ€§ 3.æ˜¾ç¤ºè®¾å¤‡å¢åŠ äº†ï¼Œåˆ›å»ºæ–°çš„DisplayDeviceåŠ å…¥ç³»ç»Ÿä¸­ã€‚</p><h5 id="2-3-3ã€è®¾ç½®TransfromHit"><a href="#2-3-3ã€è®¾ç½®TransfromHit" class="headerlink" title="2.3.3ã€è®¾ç½®TransfromHit"></a>2.3.3ã€è®¾ç½®TransfromHit</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (transactionFlags &amp; (eTraversalNeeded|eDisplayTransactionNeeded)) &#123;</span><br><span class="line">    ......</span><br><span class="line">    sp&lt;<span class="keyword">const</span> DisplayDevice&gt; disp;</span><br><span class="line">    <span class="keyword">uint32_t</span> currentlayerStack = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> we rely on the fact that layers are sorted by</span></span><br><span class="line">        <span class="comment">// layerStack first (so we don't have to traverse the list</span></span><br><span class="line">        <span class="comment">// of displays for every layer).</span></span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">        <span class="keyword">uint32_t</span> layerStack = layer-&gt;getDrawingState().layerStack;</span><br><span class="line">        <span class="keyword">if</span> (i==<span class="number">0</span> || currentlayerStack != layerStack) &#123;</span><br><span class="line">            currentlayerStack = layerStack;</span><br><span class="line">            <span class="comment">// figure out if this layerstack is mirrored</span></span><br><span class="line">            <span class="comment">// (more than one display) if so, pick the default display,</span></span><br><span class="line">            <span class="comment">// if not, pick the only display it's on.</span></span><br><span class="line">            disp.clear();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">                sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">                <span class="keyword">if</span> (hw-&gt;getLayerStack() == currentlayerStack) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (disp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        disp = hw;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        disp = <span class="literal">NULL</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (disp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> TEMPORARY FIX ONLY. Real fix should cause layers to</span></span><br><span class="line">            <span class="comment">// redraw after transform hint changes. See bug 8508397.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// could be null when this layer is using a layerStack</span></span><br><span class="line">            <span class="comment">// that is not visible on any display. Also can occur at</span></span><br><span class="line">            <span class="comment">// screen off/on times.</span></span><br><span class="line">            disp = getDefaultDisplayDevice();</span><br><span class="line">        &#125;</span><br><span class="line">        layer-&gt;updateTransformHint(disp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯æ ¹æ®æ¯ç§æ˜¾ç¤ºè®¾å¤‡çš„ä¸åŒï¼Œè®¾ç½®å’Œæ˜¾ç¤ºè®¾å¤‡å…³è”åœ¨ä¸€èµ·çš„Layerï¼ˆä¸»è¦çœ‹Layerçš„layerStackæ˜¯å¦å’ŒDisplayDeviceçš„layerStackï¼‰çš„TransformHintï¼ˆä¸»è¦æŒ‡è®¾å¤‡çš„æ˜¾ç¤ºæ–¹å‘orientationï¼‰ã€‚</p><h5 id="2-3-4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ"><a href="#2-3-4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ" class="headerlink" title="2.3.4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ"></a>2.3.4ã€å¤„ç†Layerå¢åŠ æƒ…å†µ</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Perform our own transaction if needed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">if</span> (currentLayers.size() &gt; layers.size()) &#123;</span><br><span class="line">    <span class="comment">// layers have been added</span></span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// some layers might have been removed, so</span></span><br><span class="line"><span class="comment">// we need to update the regions they're exposing.</span></span><br><span class="line"><span class="keyword">if</span> (mLayersRemoved) &#123;</span><br><span class="line">    mLayersRemoved = <span class="literal">false</span>;</span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">        <span class="keyword">if</span> (currentLayers.indexOf(layer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// this layer is not visible anymore</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> we could traverse the tree from front to back and</span></span><br><span class="line">            <span class="comment">//       compute the actual visible region</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> we could cache the transformed region</span></span><br><span class="line">            const Layer::State&amp; s(layer-&gt;getDrawingState());</span><br><span class="line">            Region visibleReg = s.active.transform.transform(</span><br><span class="line">                    Region(Rect(s.active.w, s.active.h)));</span><br><span class="line">            invalidateLayerStack(s.layerStack, visibleReg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¤„ç†Layerçš„å¢åŠ æƒ…å†µï¼Œå¦‚æœLayerå¢åŠ äº†ï¼Œéœ€è¦é‡æ–°è®¡ç®—è®¾å¤‡çš„æ›´æ–°åŒºåŸŸï¼Œå› æ­¤æŠŠmVisibleRegionsDirtyè®¾ä¸ºtrueï¼Œå¦‚æœLayeråˆ é™¤äº†ï¼Œéœ€è¦æŠŠLayerçš„å¯è§åŒºåŸŸåŠ å…¥åˆ°ç³»ç»Ÿéœ€è¦æ›´æ–°çš„åŒºåŸŸä¸­ã€‚</p><h5 id="2-3-5ã€è®¾ç½®mDrawingState"><a href="#2-3-5ã€è®¾ç½®mDrawingState" class="headerlink" title="2.3.5ã€è®¾ç½®mDrawingState"></a>2.3.5ã€è®¾ç½®mDrawingState</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    commitTransaction();</span><br><span class="line">updateCursorAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨commitTransactionå’ŒupdateCursorAsyncå‡½æ•° commitTransactionå‡½æ•°ä½œç”¨æ˜¯æŠŠmDrawingStateçš„å€¼è®¾ç½®æˆmCurrentStateçš„å€¼ã€‚è€ŒupdateCursorAsyncå‡½æ•°ä¼šæ›´æ–°æ‰€æœ‰æ˜¾ç¤ºè®¾å¤‡ä¸­å…‰æ ‡çš„ä½ç½®ã€‚</p><p>2.3.6 å°ç»“ handleTransactionå‡½æ•°çš„ä½œç”¨çš„å°±æ˜¯å¤„ç†ç³»ç»Ÿåœ¨ä¸¤æ¬¡åˆ·æ–°æœŸé—´çš„å„ç§å˜åŒ–ã€‚SurfaceFlingeræ¨¡å—ä¸­ä¸ç®¡æ˜¯SurfaceFlingerç±»è¿˜æ˜¯Layerç±»ï¼Œéƒ½é‡‡ç”¨äº†åŒç¼“å†²çš„æ–¹å¼æ¥ä¿å­˜ä»–ä»¬çš„å±æ€§ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯åˆšæ”¹å˜SurfaceFlingerå¯¹è±¡æˆ–è€…Layerç±»å¯¹è±¡çš„å±æ€§æ˜¯ï¼Œä¸éœ€è¦ä¸Šé”ï¼Œå¤§å¤§çš„æé«˜äº†ç³»ç»Ÿæ•ˆç‡ã€‚åªæœ‰åœ¨æœ€åçš„å›¾åƒè¾“å‡ºæ˜¯ï¼Œæ‰è¿›è¡Œä¸€æ¬¡ä¸Šé”ï¼Œå¹¶è¿›è¡Œå†…å­˜çš„å±æ€§å˜åŒ–å¤„ç†ã€‚æ­£å› æ­¤ï¼Œåº”ç”¨è¿›ç¨‹å¿…é¡»æ”¶åˆ°VSyncä¿¡å·æ‰å¼€å§‹æ”¹å˜Surfaceçš„å†…å®¹ã€‚</p><h4 id="2-4ã€handlePageFlipå‡½æ•°"><a href="#2-4ã€handlePageFlipå‡½æ•°" class="headerlink" title="2.4ã€handlePageFlipå‡½æ•°"></a>2.4ã€handlePageFlipå‡½æ•°</h4><p>handlePageFlipå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> SurfaceFlinger::handlePageFlip()</span><br><span class="line">&#123;</span><br><span class="line">Region dirtyRegion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> visibleRegions = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line"><span class="keyword">bool</span> frameQueued = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store the set of layers that need updates. This set must not change as</span></span><br><span class="line"><span class="comment">// buffers are being latched, as this could result in a deadlock.</span></span><br><span class="line"><span class="comment">// Example: Two producers share the same command stream and:</span></span><br><span class="line"><span class="comment">// 1.) Layer 0 is latched</span></span><br><span class="line"><span class="comment">// 2.) Layer 0 gets a new frame</span></span><br><span class="line"><span class="comment">// 2.) Layer 1 gets a new frame</span></span><br><span class="line"><span class="comment">// 3.) Layer 1 is latched.</span></span><br><span class="line"><span class="comment">// Display is now waiting on Layer 1's frame, which is behind layer 0's</span></span><br><span class="line"><span class="comment">// second frame. But layer 0's second frame could be waiting on display.</span></span><br><span class="line">Vector&lt;Layer*&gt; layersWithQueuedFrames;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, count = layers.size(); i&lt;count ; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">    <span class="keyword">if</span> (layer-&gt;hasQueuedFrame()) &#123;</span><br><span class="line">        frameQueued = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (layer-&gt;shouldPresentNow(mPrimaryDispSync)) &#123;</span><br><span class="line">            layersWithQueuedFrames.push_back(layer.get());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            layer-&gt;useEmptyDamage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        layer-&gt;useEmptyDamage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, count = layersWithQueuedFrames.size() ; i&lt;count ; i++) &#123;</span><br><span class="line">    Layer* layer = layersWithQueuedFrames[i];</span><br><span class="line">    const Region dirty(layer-&gt;latchBuffer(visibleRegions));</span><br><span class="line">    layer-&gt;useSurfaceDamage();</span><br><span class="line">    const Layer::State&amp; s(layer-&gt;getDrawingState());</span><br><span class="line">    invalidateLayerStack(s.layerStack, dirty);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mVisibleRegionsDirty |= visibleRegions;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we will need to wake up at some time in the future to deal with a</span></span><br><span class="line"><span class="comment">// queued frame that shouldn't be displayed during this vsync period, wake</span></span><br><span class="line"><span class="comment">// up during the next vsync period to check again.</span></span><br><span class="line"><span class="keyword">if</span> (frameQueued &amp;&amp; layersWithQueuedFrames.empty()) &#123;</span><br><span class="line">    signalLayerUpdate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only continue with the refresh if there is actually new work to do</span></span><br><span class="line"><span class="keyword">return</span> !layersWithQueuedFrames.empty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handlePageFlipå‡½æ•°å…ˆè°ƒç”¨æ¯ä¸ªLayerå¯¹è±¡çš„hasQueuedFrameå‡½æ•°ï¼Œç¡®å®šè¿™ä¸ªLayerå¯¹è±¡æ˜¯å¦æœ‰éœ€è¦æ›´æ–°çš„å›¾å±‚ï¼Œç„¶åæŠŠéœ€è¦æ›´æ–°çš„Layerå¯¹è±¡æ”¾åˆ°layersWithQueuedFramesä¸­ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹Layerçš„hasQueuedFrameæ–¹æ³•å°±æ˜¯çœ‹å…¶mQueuedFramesæ˜¯å¦å¤§äº0 å’ŒmSidebandStreamChangedã€‚å‰é¢å°èŠ‚åˆ†æåªè¦Surfaceæœ‰æ•°æ®å†™å…¥ï¼Œå°±ä¼šè°ƒç”¨Layerçš„onFrameAvailableå‡½æ•°ï¼Œç„¶åmQueuedFrameså€¼åŠ 1. ç»§ç»­çœ‹handlePageFlipå‡½æ•°ï¼Œæ¥ç€è°ƒç”¨éœ€è¦æ›´æ–°çš„Layerå¯¹è±¡çš„latchBufferå‡½æ•°ï¼Œç„¶åæ ¹æ®è¿”å›çš„æ›´æ–°åŒºåŸŸè°ƒç”¨invalidateLayerStackå‡½æ•°æ¥è®¾ç½®æ›´æ–°è®¾å¤‡å¯¹è±¡çš„æ›´æ–°åŒºåŸŸã€‚ ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹latchBufferå‡½æ•°</p><p>LatchBufferå‡½æ•°è°ƒç”¨updateTextImageæ¥å¾—åˆ°éœ€è¦çš„å›¾åƒã€‚è¿™é‡Œå‚æ•°ræ˜¯Rejectå¯¹è±¡ï¼Œå…¶ä½œç”¨æ˜¯åˆ¤æ–­åœ¨ç¼“å†²åŒºçš„å°ºå¯¸æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚è°ƒç”¨updateTextImageå‡½æ•°å¦‚æœå¾—åˆ°çš„ç»“æœæ˜¯PRESENT_LATER,è¡¨ç¤ºæ¨è¿Ÿå¤„ç†ï¼Œç„¶åè°ƒç”¨signalLayerUpdateå‡½æ•°æ¥å‘é€invalidateæ¶ˆæ¯ï¼Œè¿™æ¬¡ç»˜åˆ¶è¿‡ç¨‹å°±ä¸å¤„ç†è¿™ä¸ªSurfaceçš„å›¾åƒäº†ã€‚ å¦‚æœä¸éœ€è¦æ¨è¿Ÿå¤„ç†ï¼ŒæŠŠmQueuedFramesçš„å€¼å‡1. æœ€åLatchBufferå‡½æ•°è°ƒç”¨mSurfaceFlingerConsumerçš„getCurrentBufferæ¥å–å›å½“å‰çš„å›¾åƒç¼“å†²åŒºæŒ‡é’ˆï¼Œä¿å­˜åœ¨mActiveBufferä¸­ã€‚</p><h5 id="2-5-å°ç»“"><a href="#2-5-å°ç»“" class="headerlink" title="2.5 å°ç»“"></a>2.5 å°ç»“</h5><p>è¿™æ ·ç»è¿‡handleTransaction handlePageFlipä¸¤ä¸ªå‡½æ•°å¤„ç†ï¼ŒSurfaceFlingerä¸­æ— è®ºæ˜¯Layerå±æ€§çš„å˜åŒ–è¿˜æ˜¯å›¾åƒçš„å˜åŒ–éƒ½å¤„ç†å¥½äº†ï¼Œåªç­‰VSyncä¿¡å·åˆ°æ¥å°±å¯ä»¥è¾“å‡ºäº†ã€‚</p><h4 id="ä¸‰ã€rebuildLayerStackså‡½æ•°"><a href="#ä¸‰ã€rebuildLayerStackså‡½æ•°" class="headerlink" title="ä¸‰ã€rebuildLayerStackså‡½æ•°"></a>ä¸‰ã€rebuildLayerStackså‡½æ•°</h4><p>å‰é¢ä»‹ç»ï¼ŒVSyncä¿¡å·åˆ°æ¥åï¼Œå…ˆæ˜¯è°ƒç”¨äº†rebuildLayerStackså‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::rebuildLayerStacks() &#123;</span><br><span class="line">updateExtendedMode();</span><br><span class="line"><span class="comment">// rebuild the visible layer list per screen</span></span><br><span class="line"><span class="keyword">if</span> (CC_UNLIKELY(mVisibleRegionsDirty)) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    mVisibleRegionsDirty = <span class="literal">false</span>;</span><br><span class="line">    invalidateHwcGeometry();</span><br><span class="line">    <span class="comment">//è®¡ç®—æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡ä¸Šå¯è§çš„Layer  </span></span><br><span class="line">    <span class="function"><span class="keyword">const</span> LayerVector&amp; <span class="title">layers</span><span class="params">(mDrawingState.layersSortedByZ)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        Region opaqueRegion;</span><br><span class="line">        Region dirtyRegion;</span><br><span class="line">        Vector&lt; sp&lt;Layer&gt; &gt; layersSortedByZ;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; hw(mDisplays[dpy]);</span><br><span class="line">        const Transform&amp; tr(hw-&gt;getTransform());</span><br><span class="line">        const Rect bounds(hw-&gt;getBounds());</span><br><span class="line">        <span class="keyword">if</span> (hw-&gt;isDisplayOn()) &#123;</span><br><span class="line">            <span class="comment">//è®¡ç®—æ¯ä¸ªlayerçš„å¯è§åŒºåŸŸï¼Œç¡®å®šè®¾å¤‡éœ€è¦é‡æ–°ç»˜åˆ¶çš„åŒºåŸŸ  </span></span><br><span class="line">            computeVisibleRegions(hw-&gt;getHwcDisplayId(), layers,</span><br><span class="line">                    hw-&gt;getLayerStack(), dirtyRegion, opaqueRegion);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = layers.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(layers[i]);</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//åªéœ€è¦å’Œæ˜¾ç¤ºè®¾å¤‡çš„LayerStackç›¸åŒçš„layer  </span></span><br><span class="line">                    <span class="function">Region <span class="title">drawRegion</span><span class="params">(tr.transform(</span></span></span><br><span class="line">                            layer-&gt;visibleNonTransparentRegion));</span><br><span class="line">                    drawRegion.andSelf(bounds);</span><br><span class="line">                    <span class="keyword">if</span> (!drawRegion.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœLayerçš„æ˜¾ç¤ºåŒºåŸŸå’Œæ˜¾ç¤ºè®¾å¤‡çš„çª—å£æœ‰äº¤é›†  </span></span><br><span class="line">                        <span class="comment">//æŠŠLayeråŠ å…¥åˆ—è¡¨ä¸­</span></span><br><span class="line">                        layersSortedByZ.add(layer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è®¾ç½®æ˜¾ç¤ºè®¾å¤‡çš„å¯è§Layeråˆ—è¡¨  </span></span><br><span class="line">        hw-&gt;setVisibleLayersSortedByZ(layersSortedByZ);</span><br><span class="line">        hw-&gt;undefinedRegion.<span class="built_in">set</span>(bounds);</span><br><span class="line">        hw-&gt;undefinedRegion.subtractSelf(tr.transform(opaqueRegion));</span><br><span class="line">        hw-&gt;dirtyRegion.orSelf(dirtyRegion);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>rebuildLayerStackså‡½æ•°çš„ä½œç”¨æ˜¯é‡å»ºæ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„å¯è§layerå¯¹è±¡åˆ—è¡¨ã€‚å¯¹äºæŒ‰æ˜¾ç¤ºè½´ï¼ˆZè½´ï¼‰æ’åˆ—çš„Layerå¯¹è±¡ï¼Œæ’åœ¨æœ€å‰é¢çš„å½“ç„¶ä¼šä¼˜å…ˆæ˜¾ç¤ºï¼Œä½†æ˜¯Layerå›¾åƒå¯èƒ½æœ‰é€æ˜åŸŸï¼Œä¹Ÿå¯èƒ½æœ‰å°ºå¯¸æ²¡æœ‰è¦†ç›–æ•´ä¸ªå±å¹•ï¼Œå› æ­¤ä¸‹é¢çš„layerä¹Ÿæœ‰æ˜¾ç¤ºçš„æœºä¼šã€‚rebuildLayerStackså‡½æ•°å¯¹æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡ï¼Œå…ˆè®¡ç®—å’Œæ˜¾ç¤ºè®¾å¤‡å…·æœ‰ç›¸åŒlayerStackå€¼çš„Layerå¯¹è±¡åœ¨è¯¥æ˜¾ç¤ºè®¾å¤‡ä¸Šçš„å¯è§åŒºåŸŸã€‚ç„¶åå°†å¯è§åŒºåŸŸå’Œæ˜¾ç¤ºè®¾å¤‡çš„çª—å£åŒºåŸŸæœ‰äº¤é›†çš„layerç»„æˆä¸€ä¸ªæ–°çš„åˆ—è¡¨ï¼Œæœ€åæŠŠè¿™ä¸ªåˆ—è¡¨è®¾ç½®åˆ°æ˜¾ç¤ºè®¾å¤‡å¯¹è±¡ä¸­ã€‚ computeVisibleRegionså‡½æ•°é¦–å…ˆè®¡ç®—æ¯ä¸ªLayeråœ¨è®¾å¤‡ä¸Šçš„å¯è§åŒºåŸŸvisibleRegionã€‚è®¡ç®—æ–¹æ³•å°±æ˜¯ç”¨æ•´ä¸ªLayerçš„åŒºåŸŸå‡å»ä¸Šå±‚æ‰€æœ‰ä¸é€æ˜åŒºåŸŸaboveOpaqueLayersã€‚è€Œä¸Šå±‚æ‰€æœ‰ä¸é€æ˜åŒºåŸŸå€¼æ˜¯ä¸€ä¸ªé€å±‚ç´¯è®¡çš„è¿‡ç¨‹ï¼Œæ¯å±‚éƒ½éœ€è¦æŠŠè‡ªå·±çš„ä¸é€æ˜åŒºåŸŸç´¯åŠ åˆ°aboveOpaqueLayersä¸­ã€‚ è€Œæ¯å±‚çš„ä¸é€æ˜åŒºåŸŸçš„è®¡ç®—æ–¹æ³•ï¼šå¦‚æœLayerçš„alphaçš„å€¼ä¸º255ï¼Œå¹¶ä¸”layerçš„isOpaqueå‡½æ•°ä¸ºtrueï¼Œåˆ™æœ¬å±‚çš„ä¸é€æ˜åŒºåŸŸç­‰äºLayeræ‰€åœ¨åŒºåŸŸï¼Œå¦åˆ™ä¸º0.è¿™æ ·ä¸€å±‚å±‚ç®—ä¸‹æ¥ï¼Œå°±å¾ˆå®¹æ˜“å¾—åˆ°æ¯å±‚çš„å¯è§åŒºåŸŸå¤§å°äº†ã€‚ å…¶æ¬¡ï¼Œè®¡ç®—æ•´ä¸ªæ˜¾ç¤ºè®¾å¤‡éœ€è¦æ›´æ–°çš„åŒºåŸŸoutDirtyRegionã€‚outDirtyRegionçš„å€¼ä¹Ÿæ˜¯ç´¯è®¡æ‰€æœ‰å±‚çš„éœ€è¦é‡å›çš„åŒºåŸŸå¾—åˆ°çš„ã€‚å¦‚æœLayerä¸­çš„æ˜¾ç¤ºå†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™æ•´ä¸ªå¯è§åŒºåŸŸvisibleRegionéƒ½éœ€è¦æ›´æ–°ï¼ŒåŒæ—¶è¿˜è¦åŒ…æ‹¬ä¸Šä¸€æ¬¡çš„å¯è§åŒºåŸŸï¼Œç„¶ååœ¨å»æ‰è¢«ä¸Šå±‚è¦†ç›–åçš„åŒºåŸŸå¾—åˆ°çš„å°±æ˜¯Layeréœ€è¦æ›´æ–°çš„åŒºåŸŸã€‚å¦‚æœLayeræ˜¾ç¤ºçš„å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯è€ƒè™‘åˆ°çª—å£å¤§å°çš„å˜åŒ–æˆ–è€…ä¸Šå±‚çª—å£çš„å˜åŒ–ï¼Œå› æ­¤Layerä¸­è¿˜æ˜¯æœ‰åŒºåŸŸå¯ä»¥éœ€è¦é‡ç»˜çš„åœ°æ–¹ã€‚è¿™ç§æƒ…å†µä¸‹æœ€ç®€å•çš„ç®—æ³•æ˜¯ç”¨Layerè®¡ç®—å‡ºå¯è§åŒºåŸŸå‡å»ä»¥å‰çš„å¯è§åŒºåŸŸå°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨computeVisibleRegionså‡½æ•°è¿˜å¼•å…¥äº†è¢«è¦†ç›–åŒºåŸŸï¼Œé€šå¸¸è¢«è¦†ç›–åŒºåŸŸå’Œå¯è§åŒºåŸŸå¹¶ä¸é‡å¤ï¼Œå› æ­¤å‡½æ•°ä¸­è®¡ç®—æš´éœ²åŒºåŸŸæ˜¯ç”¨å¯è§åŒºåŸŸå‡å»è¢«è¦†ç›–åŒºåŸŸçš„ã€‚</p><h5 id="å››ã€setUpHWComposerå‡½æ•°"><a href="#å››ã€setUpHWComposerå‡½æ•°" class="headerlink" title="å››ã€setUpHWComposerå‡½æ•°"></a>å››ã€setUpHWComposerå‡½æ•°</h5><p>setUpHWComposerå‡½æ•°çš„ä½œç”¨æ˜¯æ›´æ–°HWComposerå¯¹è±¡ä¸­å›¾å±‚å¯¹è±¡åˆ—è¡¨ä»¥åŠå›¾å±‚å±æ€§ã€‚ [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::setUpHWComposer() &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    <span class="keyword">bool</span> dirty = !mDisplays[dpy]-&gt;getDirtyRegion(<span class="literal">false</span>).isEmpty();</span><br><span class="line">    <span class="keyword">bool</span> empty = mDisplays[dpy]-&gt;getVisibleLayersSortedByZ().size() == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> wasEmpty = !mDisplays[dpy]-&gt;lastCompositionHadVisibleLayers;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">bool</span> mustRecompose = dirty &amp;&amp; !(empty &amp;&amp; wasEmpty);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    mDisplays[dpy]-&gt;beginFrame(mustRecompose);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mustRecompose) &#123;</span><br><span class="line">        mDisplays[dpy]-&gt;lastCompositionHadVisibleLayers = !empty;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¾—åˆ°ç³»ç»ŸHWComposerå¯¹è±¡  </span></span><br><span class="line">HWComposer&amp; hwc(getHwComposer());</span><br><span class="line"><span class="keyword">if</span> (hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">    <span class="comment">// build the h/w work list</span></span><br><span class="line">    <span class="keyword">if</span> (CC_UNLIKELY(mHwWorkListDirty)) &#123;</span><br><span class="line">        mHwWorkListDirty = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">            sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">            <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                    hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">                <span class="comment">//æ ¹æ®Layeræ•°é‡åœ¨HWComposerä¸­åˆ›å»ºhwc_layer_list_tåˆ—è¡¨  </span></span><br><span class="line">                <span class="keyword">if</span> (hwc.createWorkList(id, count) == NO_ERROR) &#123;</span><br><span class="line">                    HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">                    <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                        <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                        layer-&gt;setGeometry(hw, *cur);</span><br><span class="line">                        <span class="keyword">if</span> (mDebugDisableHWC || mDebugRegion || mDaltonize || mHasColorMatrix) &#123;</span><br><span class="line">                            cur-&gt;setSkip(<span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the per-frame data</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">        <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">bool</span> freezeSurfacePresent = <span class="literal">false</span>;</span><br><span class="line">            isfreezeSurfacePresent(freezeSurfacePresent, hw, id);</span><br><span class="line">            <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">            HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">            <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * update the per-frame h/w composer data for each layer</span></span><br><span class="line"><span class="comment">                 * and build the transparent region of the FB</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                <span class="comment">//å°†Layerçš„mActiveBufferè®¾ç½®åˆ°HWComposerä¸­</span></span><br><span class="line">                layer-&gt;setPerFrameData(hw, *cur);</span><br><span class="line">                setOrientationEventControl(freezeSurfacePresent,id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If possible, attempt to use the cursor overlay on each display.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">        <span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(</span><br><span class="line">                hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">            HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">            <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; cur!=end &amp;&amp; i&lt;count ; ++i, ++cur) &#123;</span><br><span class="line">                <span class="keyword">const</span> sp&lt;Layer&gt;&amp; layer(currentLayers[i]);</span><br><span class="line">                <span class="keyword">if</span> (layer-&gt;isPotentialCursor()) &#123;</span><br><span class="line">                    cur-&gt;setIsCursorLayerHint();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dumpDrawCycle(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = hwc.prepare();</span><br><span class="line">    ALOGE_IF(err, <span class="string">"HWComposer::prepare failed (%s)"</span>, strerror(-err));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">        sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">        hw-&gt;prepareFrame(hwc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HWComposerä¸­æœ‰ä¸€ä¸ªç±»å‹ä¸ºDisplayDataç»“æ„çš„æ•°ç»„mDisplayDataï¼Œå®ƒç»´æŠ¤ç€æ¯ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„ä¿¡æ¯ã€‚DisplayDataç»“æ„ä¸­æœ‰ä¸€ä¸ªç±»å‹ä¸ºhwc_display_contents_lå­—æ®µlistï¼Œè¿™ä¸ªå­—æ®µåˆæœ‰ä¸€ä¸ªhwc_layer_lç±»å‹çš„æ•°ç»„hwLayersï¼Œè®°å½•è¯¥æ˜¾ç¤ºè®¾å¤‡æ‰€æœ‰éœ€è¦è¾“å‡ºçš„Layerä¿¡æ¯ã€‚ setUpHWComposerå‡½æ•°è°ƒç”¨HWComposerçš„createWorkListå‡½æ•°å°±æ˜¯æ ¹æ®æ¯ç§æ˜¾ç¤ºè®¾å¤‡çš„Layeræ•°é‡ï¼Œåˆ›å»ºå’Œåˆå§‹åŒ–hwc_display_contents_lå¯¹è±¡å’Œhwc_layer_læ•°ç»„ åˆ›å»ºå®ŒHWComposerä¸­çš„åˆ—è¡¨åï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹æ¯ä¸ªLayerå¯¹è±¡è°ƒç”¨å®ƒçš„setPerFrameDataå‡½æ•°ï¼Œå‚æ•°æ˜¯HWComposerå’ŒHWCLayerInterfaceã€‚setPerFrameDataå‡½æ•°å°†Layerå¯¹è±¡çš„å½“å‰å›¾åƒç¼“å†²åŒºmActiveBufferè®¾ç½®åˆ°HWCLayerInterfaceå¯¹è±¡å¯¹åº”çš„hwc_layer_lå¯¹è±¡ä¸­ã€‚ HWComposerç±»ä¸­é™¤äº†å‰é¢ä»‹ç»çš„Grallocè¿˜ç®¡ç†ç€Composeræ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—å®ç°äº†ç¡¬ä»¶çš„å›¾åƒåˆæˆåŠŸèƒ½ã€‚setUpHWComposerå‡½æ•°æ¥ä¸‹æ¥è°ƒç”¨HWComposerç±»çš„prepareå‡½æ•°ï¼Œè€Œprepareå‡½æ•°ä¼šè°ƒç”¨Composeræ¨¡å—çš„prepareæ¥å£ã€‚æœ€ååˆ°å„ä¸ªå‚å®¶çš„å®ç°hwc_prepareå‡½æ•°å°†æ¯ç§HWComposerä¸­çš„æ‰€æœ‰å›¾å±‚çš„ç±»å‹éƒ½è®¾ç½®ä¸ºHWC_FRAMEBUFFERå°±ç»“æŸäº†ã€‚</p><h5 id="äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ-ï¼ˆdoComposition-å‡½æ•°ï¼‰"><a href="#äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ-ï¼ˆdoComposition-å‡½æ•°ï¼‰" class="headerlink" title="äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ ï¼ˆdoComposition()å‡½æ•°ï¼‰"></a>äº”ã€åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒ ï¼ˆdoComposition()å‡½æ•°ï¼‰</h5><p>doCompositionå‡½æ•°æ˜¯åˆæˆæ‰€æœ‰å±‚çš„å›¾åƒï¼Œä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::doComposition() &#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> repaintEverything = android_atomic_and(<span class="number">0</span>, &amp;mRepaintEverything);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;DisplayDevice&gt;&amp; hw(mDisplays[dpy]);</span><br><span class="line">    <span class="keyword">if</span> (hw-&gt;isDisplayOn()) &#123;</span><br><span class="line">        <span class="comment">// transform the dirty region into this screen's coordinate space</span></span><br><span class="line">        const Region dirtyRegion(hw-&gt;getDirtyRegion(repaintEverything));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// repaint the framebuffer (if needed)</span></span><br><span class="line">        doDisplayComposition(hw, dirtyRegion);</span><br><span class="line"></span><br><span class="line">        hw-&gt;dirtyRegion.clear();</span><br><span class="line">        hw-&gt;flip(hw-&gt;swapRegion);</span><br><span class="line">        hw-&gt;swapRegion.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// inform the h/w that we're done compositing</span></span><br><span class="line">    hw-&gt;compositionComplete();</span><br><span class="line">&#125;</span><br><span class="line">postFramebuffer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doCompositionå‡½æ•°é’ˆå¯¹æ¯ç§æ˜¾ç¤ºè®¾å¤‡è°ƒç”¨doDisplayCompositionå‡½æ•°æ¥åˆæˆï¼Œåˆæˆåè°ƒç”¨postFramebufferå‡½æ•°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹doDisplayCompositionå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::doDisplayComposition(<span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt;&amp; hw,</span><br><span class="line">    <span class="keyword">const</span> Region&amp; inDirtyRegion)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">// We only need to actually compose the display if:</span></span><br><span class="line"><span class="comment">// 1) It is being handled by hardware composer, which may need this to</span></span><br><span class="line"><span class="comment">//    keep its virtual display state machine in sync, or</span></span><br><span class="line"><span class="comment">// 2) There is work to be done (the dirty region isn't empty)</span></span><br><span class="line"><span class="keyword">bool</span> isHwcDisplay = hw-&gt;getHwcDisplayId() &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!isHwcDisplay &amp;&amp; inDirtyRegion.isEmpty()) &#123;</span><br><span class="line">    ALOGV(<span class="string">"Skipping display composition"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALOGV(<span class="string">"doDisplayComposition"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function">Region <span class="title">dirtyRegion</span><span class="params">(inDirtyRegion)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compute the invalid region</span></span><br><span class="line"><span class="comment">//swapRegionè®¾ç½®ä¸ºéœ€è¦æ›´æ–°çš„åŒºåŸŸ  </span></span><br><span class="line">hw-&gt;swapRegion.orSelf(dirtyRegion);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> flags = hw-&gt;getFlags();<span class="comment">//è·å¾—æ˜¾ç¤ºè®¾å¤‡æ”¯æŒçš„æ›´æ–°æ–¹å¼æ ‡å¿—  </span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; DisplayDevice::SWAP_RECTANGLE) &#123;</span><br><span class="line">    <span class="comment">// we can redraw only what's dirty, but since SWAP_RECTANGLE only</span></span><br><span class="line">    <span class="comment">// takes a rectangle, we must make sure to update that whole</span></span><br><span class="line">    <span class="comment">// rectangle in that case</span></span><br><span class="line">    dirtyRegion.<span class="built_in">set</span>(hw-&gt;swapRegion.bounds());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; DisplayDevice::PARTIAL_UPDATES) &#123;<span class="comment">//æ”¯æŒéƒ¨åˆ†æ›´æ–°  </span></span><br><span class="line">        <span class="comment">// We need to redraw the rectangle that will be updated</span></span><br><span class="line">        <span class="comment">// (pushed to the framebuffer).</span></span><br><span class="line">        <span class="comment">// This is needed because PARTIAL_UPDATES only takes one</span></span><br><span class="line">        <span class="comment">// rectangle instead of a region (see DisplayDevice::flip())</span></span><br><span class="line">        <span class="comment">//å°†æ›´æ–°åŒºåŸŸè°ƒæ•´ä¸ºæ•´ä¸ªçª—å£å¤§å°  </span></span><br><span class="line">        dirtyRegion.<span class="built_in">set</span>(hw-&gt;swapRegion.bounds());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// we need to redraw everything (the whole screen)</span></span><br><span class="line">        dirtyRegion.<span class="built_in">set</span>(hw-&gt;bounds());</span><br><span class="line">        hw-&gt;swapRegion = dirtyRegion;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆæˆ  </span></span><br><span class="line"><span class="keyword">if</span> (!doComposeSurfaces(hw, dirtyRegion)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update the swap region and clear the dirty region</span></span><br><span class="line">hw-&gt;swapRegion.orSelf(dirtyRegion);</span><br><span class="line"><span class="comment">//æ²¡æœ‰ç¡¬ä»¶composerçš„æƒ…å†µï¼Œè¾“å‡ºå›¾åƒ</span></span><br><span class="line"><span class="comment">// swap buffers (presentation)</span></span><br><span class="line">hw-&gt;swapBuffers(getHwComposer());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doDisplayCompositionå‡½æ•°æ ¹æ®æ˜¾ç¤ºè®¾å¤‡æ”¯æŒçš„æ›´æ–°æ–¹å¼ï¼Œé‡æ–°è®¾ç½®éœ€è¦æ›´æ–°åŒºåŸŸçš„å¤§å°ã€‚ çœŸæ­£çš„åˆæˆå·¥ä½œæ˜¯åœ¨doComposerSurfaceså‡½æ•°ä¸­å®Œæˆï¼Œè¿™ä¸ªå‡½æ•°åœ¨layerçš„ç±»å‹ä¸ºHWC_FRAMEBUFFER,æˆ–è€…ä¸æ”¯æŒç¡¬ä»¶çš„composerçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨layerçš„drawå‡½æ•°æ¥ä¸€å±‚ä¸€å±‚ä½åˆæˆæœ€åçš„å›¾åƒã€‚ åˆæˆå®Œåï¼ŒdoDisplayCompositionå‡½æ•°è°ƒç”¨äº†hwçš„swapBufferså‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å‰é¢ä»‹ç»è¿‡äº†ï¼Œå®ƒå°†åœ¨ç³»ç»Ÿä¸æ”¯æŒç¡¬ä»¶çš„composeræƒ…å†µä¸‹è°ƒç”¨eglSwapBuffersæ¥è¾“å‡ºå›¾åƒåˆ°æ˜¾ç¤ºè®¾å¤‡ã€‚</p><h5 id="å…­ã€postFramebufferå‡½æ•°"><a href="#å…­ã€postFramebufferå‡½æ•°" class="headerlink" title="å…­ã€postFramebufferå‡½æ•°"></a>å…­ã€postFramebufferå‡½æ•°</h5><p>ä¸Šä¸€èŠ‚çš„doCompositionå‡½æ•°æœ€åè°ƒç”¨äº†postFramebufferå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š [SurfaceFlinger.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SurfaceFlinger::postFramebuffer()</span><br><span class="line">&#123;</span><br><span class="line">ATRACE_CALL();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">nsecs_t</span> now = systemTime();</span><br><span class="line">mDebugInSwapBuffers = now;</span><br><span class="line"></span><br><span class="line">HWComposer&amp; hwc(getHwComposer());</span><br><span class="line"><span class="keyword">if</span> (hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hwc.supportsFramebufferTarget()) &#123;</span><br><span class="line">        <span class="comment">// EGL spec says:</span></span><br><span class="line">        <span class="comment">//   "surface must be bound to the calling thread's current context,</span></span><br><span class="line">        <span class="comment">//    for the current rendering API."</span></span><br><span class="line">        getDefaultDisplayDevice()-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line">    &#125;</span><br><span class="line">    hwc.commit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// make the default display current because the VirtualDisplayDevice code cannot</span></span><br><span class="line"><span class="comment">// deal with dequeueBuffer() being called outside of the composition loop; however</span></span><br><span class="line"><span class="comment">// the code below can call glFlush() which is allowed (and does in some case) call</span></span><br><span class="line"><span class="comment">// dequeueBuffer().</span></span><br><span class="line">getDefaultDisplayDevice()-&gt;makeCurrent(mEGLDisplay, mEGLContext);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> dpy=<span class="number">0</span> ; dpy&lt;mDisplays.size() ; dpy++) &#123;</span><br><span class="line">    sp&lt;<span class="keyword">const</span> DisplayDevice&gt; hw(mDisplays[dpy]);</span><br><span class="line">    <span class="keyword">const</span> Vector&lt; sp&lt;Layer&gt; &gt;&amp; currentLayers(hw-&gt;getVisibleLayersSortedByZ());</span><br><span class="line">    hw-&gt;onSwapBuffersCompleted(hwc);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> count = currentLayers.size();</span><br><span class="line">    <span class="keyword">int32_t</span> id = hw-&gt;getHwcDisplayId();</span><br><span class="line">    <span class="keyword">if</span> (id &gt;=<span class="number">0</span> &amp;&amp; hwc.initCheck() == NO_ERROR) &#123;</span><br><span class="line">        HWComposer::LayerListIterator cur = hwc.begin(id);</span><br><span class="line">        <span class="keyword">const</span> HWComposer::LayerListIterator end = hwc.end(id);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; cur != end &amp;&amp; i &lt; count; ++i, ++cur) &#123;</span><br><span class="line">            currentLayers[i]-&gt;onLayerDisplayed(hw, &amp;*cur);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            currentLayers[i]-&gt;onLayerDisplayed(hw, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mLastSwapBufferTime = systemTime() - now;</span><br><span class="line">mDebugInSwapBuffers = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> flipCount = getDefaultDisplayDevice()-&gt;getPageFlipCount();</span><br><span class="line"><span class="keyword">if</span> (flipCount % LOG_FRAME_STATS_PERIOD == <span class="number">0</span>) &#123;</span><br><span class="line">    logFrameStats();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>postFramebufferå…ˆåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦æ”¯æŒcomposerï¼Œå¦‚æœä¸æ”¯æŒï¼Œæˆ‘ä»¬çŸ¥é“å›¾åƒå·²ç»åœ¨doCompositionå‡½æ•°æ—¶è°ƒç”¨hw-&gt;swapBuffersè¾“å‡ºäº†ï¼Œå°±è¿”å›äº†ã€‚å¦‚æœæ”¯æŒç¡¬ä»¶composerï¼ŒpostFramebufferå‡½æ•°å°†è°ƒç”¨HWComposerçš„commitå‡½æ•°ç»§ç»­æ‰§è¡Œã€‚ [HWComposer.cpp]</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> HWComposer::commit() &#123;</span><br><span class="line"><span class="keyword">int</span> err = NO_ERROR;</span><br><span class="line"><span class="keyword">if</span> (mHwc) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1)) &#123;</span><br><span class="line">        <span class="comment">// On version 1.0, the OpenGL ES target surface is communicated</span></span><br><span class="line">        <span class="comment">// by the (dpy, sur) fields and we are guaranteed to have only</span></span><br><span class="line">        <span class="comment">// a single display.</span></span><br><span class="line">        mLists[<span class="number">0</span>]-&gt;dpy = eglGetCurrentDisplay();</span><br><span class="line">        mLists[<span class="number">0</span>]-&gt;sur = eglGetCurrentSurface(EGL_DRAW);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=VIRTUAL_DISPLAY_ID_BASE; i&lt;mNumDisplays; i++) &#123;</span><br><span class="line">        <span class="function">DisplayData&amp; <span class="title">disp</span><span class="params">(mDisplayData[i])</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (disp.outbufHandle) &#123;</span><br><span class="line">            mLists[i]-&gt;outbuf = disp.outbufHandle;</span><br><span class="line">            mLists[i]-&gt;outbufAcquireFenceFd =</span><br><span class="line">                    disp.outbufAcquireFence-&gt;dup();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = mHwc-&gt;<span class="built_in">set</span>(mHwc, mNumDisplays, mLists);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span> ; i&lt;mNumDisplays ; i++) &#123;</span><br><span class="line">        <span class="function">DisplayData&amp; <span class="title">disp</span><span class="params">(mDisplayData[i])</span></span>;</span><br><span class="line">        disp.lastDisplayFence = disp.lastRetireFence;</span><br><span class="line">        disp.lastRetireFence = Fence::NO_FENCE;</span><br><span class="line">        <span class="keyword">if</span> (disp.<span class="built_in">list</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (disp.<span class="built_in">list</span>-&gt;retireFenceFd != <span class="number">-1</span>) &#123;</span><br><span class="line">                disp.lastRetireFence = <span class="keyword">new</span> Fence(disp.<span class="built_in">list</span>-&gt;retireFenceFd);</span><br><span class="line">                disp.<span class="built_in">list</span>-&gt;retireFenceFd = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            disp.<span class="built_in">list</span>-&gt;flags &amp;= ~HWC_GEOMETRY_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">status_t</span>)err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>/<strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong>Vsync<strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong><em>**</em><strong><strong>**</strong></strong>/</p><h2 id="å‚è€ƒæ–‡æ¡£ï¼ˆç‰¹åˆ«æ„Ÿè°¢ï¼‰ï¼š"><a href="#å‚è€ƒæ–‡æ¡£ï¼ˆç‰¹åˆ«æ„Ÿè°¢ï¼‰ï¼š" class="headerlink" title="å‚è€ƒæ–‡æ¡£ï¼ˆç‰¹åˆ«æ„Ÿè°¢ï¼‰ï¼š"></a>å‚è€ƒæ–‡æ¡£ï¼ˆç‰¹åˆ«æ„Ÿè°¢ï¼‰ï¼š</h2><p><a href="http://blog.csdn.net/kc58236582/article/details/52778333" target="_blank" rel="noopener">Android6.0 æ˜¾ç¤ºç³»ç»Ÿï¼ˆå…­ï¼‰ å›¾åƒçš„è¾“å‡ºè¿‡ç¨‹ - kc58236582çš„åšå®¢ - CSDNåšå®¢</a><br><a href="http://gityuan.com/2016/03/12/start-activity/" target="_blank" rel="noopener">startActivityå¯åŠ¨è¿‡ç¨‹åˆ†æ</a><br><a href="https://dev.qq.com/topic/5923ef85bdc9739041a4a798" target="_blank" rel="noopener">æµ…æAndroidçš„çª—å£ - DEV CLUB</a><br><a href="http://blog.csdn.net/qq_23547831/article/details/51224992" target="_blank" rel="noopener">Androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹</a><br><a href="http://blog.csdn.net/yanbober/article/details/45970721" target="_blank" rel="noopener">Androidåº”ç”¨setContentViewä¸LayoutInflateråŠ è½½è§£ææœºåˆ¶æºç åˆ†æ</a><br><a href="http://blog.csdn.net/yangwen123/article/details/35987609" target="_blank" rel="noopener">Androidåº”ç”¨ç¨‹åºçª—å£è®¾è®¡æ¡†æ¶ä»‹ç» - æ·±å…¥å‰–æAndroidç³»ç»Ÿ - CSDNåšå®¢</a><br><a href="http://blog.csdn.net/yangwen123/article/details/22647255" target="_blank" rel="noopener">Androidæ˜¾ç¤ºç³»ç»Ÿè®¾è®¡æ¡†æ¶ä»‹ç» - æ·±å…¥å‰–æAndroidç³»ç»Ÿ - CSDNåšå®¢</a><br><a href="http://www.cnblogs.com/samchen2009/p/3367496.html" target="_blank" rel="noopener">å›¾è§£Android - Android GUI ç³»ç»Ÿ (2) - çª—å£ç®¡ç† (View, Canvas, Window Manager) - æ¼«å¤©å°˜æ²™ - åšå®¢å›­</a><br><a href="http://windrunnerlihuan.com/2017/05/25/Android-SurfaceFlinger-%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E4%BA%94-VSync-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">Android SurfaceFlinger å­¦ä¹ ä¹‹è·¯(äº”)â€”-VSync å·¥ä½œåŸç† | April is your lie</a><br><a href="http://blog.csdn.net/armwind/article/details/73436532" target="_blank" rel="noopener">Android graphics å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç» - armwindçš„ä¸“æ  - CSDNåšå®¢ Graphics DEMO Bingo</a><br><a href="https://toutiao.io/posts/n0wr4e/preview" target="_blank" rel="noopener">Android å›¾å½¢ç³»ç»Ÿæ¦‚è¿°</a></p></div><div class="post-announce">Thank you for reading, this article belongs to <a href="http://zhoujinjian.cc">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a> copyright, if reproduced, please indicate the sourceï¼šà¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘ï¼ˆ<a href="http://zhoujinjian.cc/2017/11/01/Android-7-1-2-Android-N-Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹/">http://zhoujinjian.cc/2017/11/01/Android-7-1-2-Android-N-Activity-WindowåŠ è½½æ˜¾ç¤ºæµç¨‹/</a>ï¼‰</div><div class="post__prevs"><div class="post__prev"><a href="/2017/10/01/Android-7-1-2-Android-N-Activityå¯åŠ¨æµç¨‹åˆ†æ/" title="Android 7.1.2 (Android N) Activity å¯åŠ¨æµç¨‹ ï¼ˆAMSï¼‰åˆ†æ"><i class="iconfont icon-prev"></i>Android 7.1.2 (Android N) Activity å¯åŠ¨æµç¨‹ ï¼ˆAMSï¼‰åˆ†æ</a></div><div class="post__prev post__prev--right"><a href="/2017/12/01/Android-7-1-2-Android-N-Android-è¾“å…¥å­ç³»ç»Ÿ-Input-System/" title="Android 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ - Input System åˆ†æ">Android 7.1.2 (Android N) Android è¾“å…¥å­ç³»ç»Ÿ - Input System åˆ†æ<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">å˜¿å˜¿(à¹‘ä¹›â—¡ä¹›à¹‘),ä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸–ä¸Šä¸å¯èƒ½æœ‰é‚£ä¹ˆå¤šåå…¨åç¾çš„å¥½äº‹ï¼Œåšäººåœ¨æŸäº›æ—¶å€™æ€»æ˜¯è¦æœ‰äº›å–èˆçš„ã€‚</p></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Android/">Android</a><span class="block-list-count">26</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2088/08/08/zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘/" title="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2088.08.08.jpg" alt="zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘"></div><div class="item__info"><h3 class="item__title">zhoujinjian.cc-Androidç³»åˆ—åˆ†ææ–‡æ¡£ã€ğŸŒ€ç½®é¡¶ğŸŒ€ã€‘</h3><span class="item__text">2088-08-08</span></div></a></li><li class="latest-post-item"><a href="/2018/09/17/Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®/" title="Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.27.jpg" alt="Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ6ï¼‰ï¼šAndroid Multimedia - NuPlayer HLSæµåª’ä½“åè®®ã€RTSPæµåª’ä½“åè®®</h3><span class="item__text">2018-09-17</span></div></a></li><li class="latest-post-item"><a href="/2018/09/12/Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ/" title="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.26.jpg" alt="Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ5ï¼‰ï¼šAndroid Multimedia - NuPlayeréŸ³è§†é¢‘åŒæ­¥å®ç°åˆ†æ</h3><span class="item__text">2018-09-12</span></div></a></li><li class="latest-post-item"><a href="/2018/09/06/Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ/" title="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"><div class="item__cover"><img src="https://raw.githubusercontent.com/izhoujinjian/zhoujinjian.cc/master/hexo.themes/bing-wallpaper-2018.04.25.jpg" alt="Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ"></div><div class="item__info"><h3 class="item__title">Android Video Systemï¼ˆ4ï¼‰ï¼šAndroid Multimedia - OpenMaxå®ç°åˆ†æ</h3><span class="item__text">2018-09-06</span></div></a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">å¼€å§‹çš„å¼€å§‹äº¦æ˜¯ç»“æŸâ€¢ç»“æŸçš„ç»“æŸäº¦æ˜¯å¼€å§‹</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>izhoujinjian@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/DreamWorks_2016_Stacked-MI-512x512.png" alt="logo" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘"></div><div class="footer-top__item"><h3 class="item__title">Friend Links</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://keyin.me/" title="World of Forks" target="_blank">World of Forks</a></li><li class="list-item"><a href="https://molunerfinn.com/" title="MARKSZã®Blog" target="_blank">MARKSZã®Blog</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Hexo-theme-skapp" target="_blank">Hexo-theme-skapp</a></li><li class="list-item"><a href="http://zhoujinjian.cc/" title="à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">Build Tools</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://dribbble.com/" title="Dribbble" target="_blank">Dribbble</a></li><li class="list-item"><a href="https://pages.github.com/" title="Blog Framework" target="_blank">Github-Pages</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Made by <a href="https://github.com/izhoujinjian" target="_blank">à¹‘Charlesâœ¦Ë‘Ì«âœ¦Vincentà¹‘</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/izhoujinjian" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:izhoujinjian@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span>ğŸ€<span class="post-count">368.9k</span> </span><span>| </span><span id="busuanzi_container_site_uv" style="display:inline">ğŸ‘½<span id="busuanzi_value_site_uv">1000000</span><span></span></span><span class="footer-separator"> | </span><span id="busuanzi_container_site_pv" style="display:inline">ğŸŒ€<span id="busuanzi_value_site_pv">1000000</span><span></span></span></div></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>